<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: plugins/sfPhpExcelPlugin/lib/PHPExcel/PHPExcel/Writer/Excel5/Workbook.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>plugins/sfPhpExcelPlugin/lib/PHPExcel/PHPExcel/Writer/Excel5/Workbook.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00028"></a>00028 <span class="comment">// Original file header of PEAR::Spreadsheet_Excel_Writer_Workbook (used as the base for this class):</span>
<a name="l00029"></a>00029 <span class="comment">// -----------------------------------------------------------------------------------------</span>
<a name="l00030"></a>00030 <span class="comment">// /*</span>
<a name="l00031"></a>00031 <span class="comment">// *  Module written/ported by Xavier Noguer &lt;xnoguer@rezebra.com&gt;</span>
<a name="l00032"></a>00032 <span class="comment">// *</span>
<a name="l00033"></a>00033 <span class="comment">// *  The majority of this is _NOT_ my code.  I simply ported it from the</span>
<a name="l00034"></a>00034 <span class="comment">// *  PERL Spreadsheet::WriteExcel module.</span>
<a name="l00035"></a>00035 <span class="comment">// *</span>
<a name="l00036"></a>00036 <span class="comment">// *  The author of the Spreadsheet::WriteExcel module is John McNamara</span>
<a name="l00037"></a>00037 <span class="comment">// *  &lt;jmcnamara@cpan.org&gt;</span>
<a name="l00038"></a>00038 <span class="comment">// *</span>
<a name="l00039"></a>00039 <span class="comment">// *  I _DO_ maintain this code, and John McNamara has nothing to do with the</span>
<a name="l00040"></a>00040 <span class="comment">// *  porting of this code to PHP.  Any questions directly related to this</span>
<a name="l00041"></a>00041 <span class="comment">// *  class library should be directed to me.</span>
<a name="l00042"></a>00042 <span class="comment">// *</span>
<a name="l00043"></a>00043 <span class="comment">// *  License Information:</span>
<a name="l00044"></a>00044 <span class="comment">// *</span>
<a name="l00045"></a>00045 <span class="comment">// *    Spreadsheet_Excel_Writer:  A library for generating Excel Spreadsheets</span>
<a name="l00046"></a>00046 <span class="comment">// *    Copyright (c) 2002-2003 Xavier Noguer xnoguer@rezebra.com</span>
<a name="l00047"></a>00047 <span class="comment">// *</span>
<a name="l00048"></a>00048 <span class="comment">// *    This library is free software; you can redistribute it and/or</span>
<a name="l00049"></a>00049 <span class="comment">// *    modify it under the terms of the GNU Lesser General Public</span>
<a name="l00050"></a>00050 <span class="comment">// *    License as published by the Free Software Foundation; either</span>
<a name="l00051"></a>00051 <span class="comment">// *    version 2.1 of the License, or (at your option) any later version.</span>
<a name="l00052"></a>00052 <span class="comment">// *</span>
<a name="l00053"></a>00053 <span class="comment">// *    This library is distributed in the hope that it will be useful,</span>
<a name="l00054"></a>00054 <span class="comment">// *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00055"></a>00055 <span class="comment">// *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00056"></a>00056 <span class="comment">// *    Lesser General Public License for more details.</span>
<a name="l00057"></a>00057 <span class="comment">// *</span>
<a name="l00058"></a>00058 <span class="comment">// *    You should have received a copy of the GNU Lesser General Public</span>
<a name="l00059"></a>00059 <span class="comment">// *    License along with this library; if not, write to the Free Software</span>
<a name="l00060"></a>00060 <span class="comment">// *    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<a name="l00061"></a>00061 <span class="comment">// */</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00071"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html">00071</a> <span class="keyword">class </span><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html">PHPExcel_Writer_Excel5_Workbook</a> <span class="keyword">extends</span> <a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html">PHPExcel_Writer_Excel5_BIFFwriter</a>
<a name="l00072"></a>00072 {
<a name="l00078"></a>00078   <span class="keyword">private</span> $_parser;
<a name="l00079"></a>00079 
<a name="l00085"></a>00085   <span class="keyword">public</span> $_biffsize;
<a name="l00086"></a>00086 
<a name="l00091"></a>00091   <span class="keyword">private</span> $_xfWriters = array();
<a name="l00092"></a>00092 
<a name="l00097"></a>00097   <span class="keyword">public</span> $_palette;
<a name="l00098"></a>00098 
<a name="l00103"></a>00103   <span class="keyword">public</span> $_codepage;
<a name="l00104"></a>00104 
<a name="l00109"></a>00109   <span class="keyword">public</span> $_country_code;
<a name="l00110"></a>00110 
<a name="l00115"></a>00115   <span class="keyword">private</span> $_phpExcel;
<a name="l00116"></a>00116 
<a name="l00122"></a>00122   <span class="keyword">private</span> $_fontWriters = array();
<a name="l00123"></a>00123 
<a name="l00129"></a>00129   <span class="keyword">private</span> $_addedFonts = array();
<a name="l00130"></a>00130 
<a name="l00136"></a>00136   <span class="keyword">private</span> $_numberFormats = array();
<a name="l00137"></a>00137 
<a name="l00143"></a>00143   <span class="keyword">private</span> $_addedNumberFormats = array();
<a name="l00144"></a>00144 
<a name="l00150"></a>00150   <span class="keyword">private</span> $_worksheetSizes = array();
<a name="l00151"></a>00151 
<a name="l00157"></a>00157   <span class="keyword">private</span> $_worksheetOffsets = array();
<a name="l00158"></a>00158 
<a name="l00164"></a>00164   <span class="keyword">private</span> $_str_total;
<a name="l00165"></a>00165 
<a name="l00171"></a>00171   <span class="keyword">private</span> $_str_unique;
<a name="l00172"></a>00172 
<a name="l00178"></a>00178   <span class="keyword">private</span> $_str_table;
<a name="l00179"></a>00179 
<a name="l00183"></a>00183   <span class="keyword">private</span> $_colors;
<a name="l00184"></a>00184 
<a name="l00190"></a>00190   <span class="keyword">private</span> $_escher;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 
<a name="l00203"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#add38e56138c8e388e8418d0aa120f77e">00203</a>   <span class="keyword">public</span> function <a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html#a5f32c9084a448ca63130111f6e9094ee" title="Constructor.">__construct</a>(<a class="code" href="classPHPExcel.html">PHPExcel</a> $phpExcel = null, $BIFF_version = 0x0600,
<a name="l00204"></a>00204                         &amp;$str_total,
<a name="l00205"></a>00205                         &amp;$str_unique, &amp;$str_table, &amp;$colors, $parser
<a name="l00206"></a>00206                 )
<a name="l00207"></a>00207   {
<a name="l00208"></a>00208     <span class="comment">// It needs to call its parent&#39;s constructor explicitly</span>
<a name="l00209"></a>00209     <a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html#a5f32c9084a448ca63130111f6e9094ee" title="Constructor.">parent::__construct</a>();
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     $this-&gt;_parser           = $parser;
<a name="l00212"></a>00212     $this-&gt;_biffsize         = 0;
<a name="l00213"></a>00213     $this-&gt;_palette          = array();
<a name="l00214"></a>00214     $this-&gt;_codepage         = 0x04E4; <span class="comment">// FIXME: should change for BIFF8</span>
<a name="l00215"></a>00215     $this-&gt;_country_code     = -1;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     $this-&gt;_str_total       = &amp;$str_total;
<a name="l00218"></a>00218     $this-&gt;_str_unique      = &amp;$str_unique;
<a name="l00219"></a>00219     $this-&gt;_str_table       = &amp;$str_table;
<a name="l00220"></a>00220     $this-&gt;_colors          = &amp;$colors;
<a name="l00221"></a>00221     $this-&gt;<a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#ad2d5346a2c27ece5aa6d8654457fa210" title="Sets the colour palette to the Excel 97+ default.">_setPaletteXl97</a>();
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     $this-&gt;_phpExcel = $phpExcel;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="keywordflow">if</span> ($BIFF_version == 0x0600) {
<a name="l00226"></a>00226       $this-&gt;_BIFF_version = 0x0600;
<a name="l00227"></a>00227       <span class="comment">// change BIFFwriter limit for CONTINUE records</span>
<a name="l00228"></a>00228       $this-&gt;_limit = 8224;
<a name="l00229"></a>00229       $this-&gt;_codepage = 0x04B0;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="comment">// Add empty sheets and Build color cache</span>
<a name="l00233"></a>00233     $countSheets = $phpExcel-&gt;getSheetCount();
<a name="l00234"></a>00234     <span class="keywordflow">for</span> ($i = 0; $i &lt; $countSheets; ++$i) {
<a name="l00235"></a>00235       $phpSheet = $phpExcel-&gt;getSheet($i);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237       $this-&gt;_parser-&gt;setExtSheet($phpSheet-&gt;getTitle(), $i);  <span class="comment">// Register worksheet name with parser</span>
<a name="l00238"></a>00238 
<a name="l00239"></a>00239       <span class="comment">// for BIFF8</span>
<a name="l00240"></a>00240       <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0600) {
<a name="l00241"></a>00241         $supbook_index = 0x00;
<a name="l00242"></a>00242         $ref = pack(<span class="stringliteral">&#39;vvv&#39;</span>, $supbook_index, $i, $i);
<a name="l00243"></a>00243         $this-&gt;_parser-&gt;_references[] = $ref;  <span class="comment">// Register reference with parser</span>
<a name="l00244"></a>00244       }
<a name="l00245"></a>00245       <span class="comment">// Sheet tab colors?</span>
<a name="l00246"></a>00246       <span class="keywordflow">if</span> ($phpSheet-&gt;isTabColorSet()) {
<a name="l00247"></a>00247         $this-&gt;_addColor($phpSheet-&gt;getTabColor()-&gt;getRGB());
<a name="l00248"></a>00248       }
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   }
<a name="l00252"></a>00252 
<a name="l00260"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a1b041b0d009eaa1a8873e7be980ba856">00260</a>   <span class="keyword">public</span> function <a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a1b041b0d009eaa1a8873e7be980ba856" title="Add a new XF writer.">addXfWriter</a>($style, $isStyleXf = <span class="keyword">false</span>)
<a name="l00261"></a>00261   {
<a name="l00262"></a>00262     $xfWriter = <span class="keyword">new</span> <a class="code" href="classPHPExcel__Writer__Excel5__Xf.html">PHPExcel_Writer_Excel5_Xf</a>($style);
<a name="l00263"></a>00263     $xfWriter-&gt;setBIFFVersion($this-&gt;_BIFF_version);
<a name="l00264"></a>00264     $xfWriter-&gt;setIsStyleXf($isStyleXf);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">// Add the font if not already added</span>
<a name="l00267"></a>00267     $fontHashCode = $style-&gt;getFont()-&gt;getHashCode();
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (isset($this-&gt;_addedFonts[$fontHashCode])) {
<a name="l00270"></a>00270       $fontIndex = $this-&gt;_addedFonts[$fontHashCode];
<a name="l00271"></a>00271     } <span class="keywordflow">else</span> {
<a name="l00272"></a>00272       $countFonts = count($this-&gt;_fontWriters);
<a name="l00273"></a>00273       $fontIndex = ($countFonts &lt; 4) ? $countFonts : $countFonts + 1;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275       $fontWriter = <span class="keyword">new</span> <a class="code" href="classPHPExcel__Writer__Excel5__Font.html">PHPExcel_Writer_Excel5_Font</a>($style-&gt;getFont());
<a name="l00276"></a>00276       $fontWriter-&gt;setBIFFVersion($this-&gt;_BIFF_version);
<a name="l00277"></a>00277       $fontWriter-&gt;setColorIndex($this-&gt;_addColor($style-&gt;getFont()-&gt;getColor()-&gt;getRGB()));
<a name="l00278"></a>00278       $this-&gt;_fontWriters[] = $fontWriter;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280       $this-&gt;_addedFonts[$fontHashCode] = $fontIndex;
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="comment">// Assign the font index to the xf record</span>
<a name="l00284"></a>00284     $xfWriter-&gt;setFontIndex($fontIndex);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// Background colors, best to treat these after the font so black will come after white in custom palette</span>
<a name="l00287"></a>00287     $xfWriter-&gt;setFgColor($this-&gt;_addColor($style-&gt;getFill()-&gt;getStartColor()-&gt;getRGB()));
<a name="l00288"></a>00288     $xfWriter-&gt;setBgColor($this-&gt;_addColor($style-&gt;getFill()-&gt;getEndColor()-&gt;getRGB()));
<a name="l00289"></a>00289     $xfWriter-&gt;setBottomColor($this-&gt;_addColor($style-&gt;getBorders()-&gt;getBottom()-&gt;getColor()-&gt;getRGB()));
<a name="l00290"></a>00290     $xfWriter-&gt;setTopColor($this-&gt;_addColor($style-&gt;getBorders()-&gt;getTop()-&gt;getColor()-&gt;getRGB()));
<a name="l00291"></a>00291     $xfWriter-&gt;setRightColor($this-&gt;_addColor($style-&gt;getBorders()-&gt;getRight()-&gt;getColor()-&gt;getRGB()));
<a name="l00292"></a>00292     $xfWriter-&gt;setLeftColor($this-&gt;_addColor($style-&gt;getBorders()-&gt;getLeft()-&gt;getColor()-&gt;getRGB()));
<a name="l00293"></a>00293     $xfWriter-&gt;setDiagColor($this-&gt;_addColor($style-&gt;getBorders()-&gt;getDiagonal()-&gt;getColor()-&gt;getRGB()));
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="comment">// Add the number format if it is not a built-in one and not already added</span>
<a name="l00296"></a>00296     <span class="keywordflow">if</span> ($style-&gt;getNumberFormat()-&gt;getBuiltInFormatCode() === <span class="keyword">false</span>) {
<a name="l00297"></a>00297       $numberFormatHashCode = $style-&gt;getNumberFormat()-&gt;getHashCode();
<a name="l00298"></a>00298 
<a name="l00299"></a>00299       <span class="keywordflow">if</span> (isset($this-&gt;_addedNumberFormats[$numberFormatHashCode])) {
<a name="l00300"></a>00300         $numberFormatIndex = $this-&gt;_addedNumberFormats[$numberFormatHashCode];
<a name="l00301"></a>00301       } <span class="keywordflow">else</span> {
<a name="l00302"></a>00302         $numberFormatIndex = 164 + count($this-&gt;_numberFormats);
<a name="l00303"></a>00303         $this-&gt;_numberFormats[$numberFormatIndex] = $style-&gt;getNumberFormat();
<a name="l00304"></a>00304         $this-&gt;_addedNumberFormats[$numberFormatHashCode] = $numberFormatIndex;
<a name="l00305"></a>00305       }
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     <span class="keywordflow">else</span> {
<a name="l00308"></a>00308       $numberFormatIndex = (int) $style-&gt;getNumberFormat()-&gt;getBuiltInFormatCode();
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="comment">// Assign the number format index to xf record</span>
<a name="l00312"></a>00312     $xfWriter-&gt;setNumberFormatIndex($numberFormatIndex);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     $this-&gt;_xfWriters[] = $xfWriter;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     $xfIndex = count($this-&gt;_xfWriters) - 1;
<a name="l00317"></a>00317     <span class="keywordflow">return</span> $xfIndex;
<a name="l00318"></a>00318   }
<a name="l00319"></a>00319 
<a name="l00326"></a>00326   <span class="keyword">private</span> function _addColor($rgb) {
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (!isset($this-&gt;_colors[$rgb])) {
<a name="l00328"></a>00328       <span class="keywordflow">if</span> (count($this-&gt;_colors) &lt; 57) {
<a name="l00329"></a>00329         <span class="comment">// then we add a custom color altering the palette</span>
<a name="l00330"></a>00330         $colorIndex = 8 + count($this-&gt;_colors);
<a name="l00331"></a>00331         $this-&gt;_palette[$colorIndex] =
<a name="l00332"></a>00332           array(
<a name="l00333"></a>00333             hexdec(substr($rgb, 0, 2)),
<a name="l00334"></a>00334             hexdec(substr($rgb, 2, 2)),
<a name="l00335"></a>00335             hexdec(substr($rgb, 4)),
<a name="l00336"></a>00336             0
<a name="l00337"></a>00337           );
<a name="l00338"></a>00338         $this-&gt;_colors[$rgb] = $colorIndex;
<a name="l00339"></a>00339       } <span class="keywordflow">else</span> {
<a name="l00340"></a>00340         <span class="comment">// no room for more custom colors, just map to black</span>
<a name="l00341"></a>00341         $colorIndex = 0;
<a name="l00342"></a>00342       }
<a name="l00343"></a>00343     } <span class="keywordflow">else</span> {
<a name="l00344"></a>00344       <span class="comment">// fetch already added custom color</span>
<a name="l00345"></a>00345       $colorIndex = $this-&gt;_colors[$rgb];
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="keywordflow">return</span> $colorIndex;
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350 
<a name="l00356"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#ad2d5346a2c27ece5aa6d8654457fa210">00356</a>   function <a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#ad2d5346a2c27ece5aa6d8654457fa210" title="Sets the colour palette to the Excel 97+ default.">_setPaletteXl97</a>()
<a name="l00357"></a>00357   {
<a name="l00358"></a>00358     $this-&gt;_palette = array(
<a name="l00359"></a>00359       0x08 =&gt; array(0x00, 0x00, 0x00, 0x00),
<a name="l00360"></a>00360       0x09 =&gt; array(0xff, 0xff, 0xff, 0x00),
<a name="l00361"></a>00361       0x0A =&gt; array(0xff, 0x00, 0x00, 0x00),
<a name="l00362"></a>00362       0x0B =&gt; array(0x00, 0xff, 0x00, 0x00),
<a name="l00363"></a>00363       0x0C =&gt; array(0x00, 0x00, 0xff, 0x00),
<a name="l00364"></a>00364       0x0D =&gt; array(0xff, 0xff, 0x00, 0x00),
<a name="l00365"></a>00365       0x0E =&gt; array(0xff, 0x00, 0xff, 0x00),
<a name="l00366"></a>00366       0x0F =&gt; array(0x00, 0xff, 0xff, 0x00),
<a name="l00367"></a>00367       0x10 =&gt; array(0x80, 0x00, 0x00, 0x00),
<a name="l00368"></a>00368       0x11 =&gt; array(0x00, 0x80, 0x00, 0x00),
<a name="l00369"></a>00369       0x12 =&gt; array(0x00, 0x00, 0x80, 0x00),
<a name="l00370"></a>00370       0x13 =&gt; array(0x80, 0x80, 0x00, 0x00),
<a name="l00371"></a>00371       0x14 =&gt; array(0x80, 0x00, 0x80, 0x00),
<a name="l00372"></a>00372       0x15 =&gt; array(0x00, 0x80, 0x80, 0x00),
<a name="l00373"></a>00373       0x16 =&gt; array(0xc0, 0xc0, 0xc0, 0x00),
<a name="l00374"></a>00374       0x17 =&gt; array(0x80, 0x80, 0x80, 0x00),
<a name="l00375"></a>00375       0x18 =&gt; array(0x99, 0x99, 0xff, 0x00),
<a name="l00376"></a>00376       0x19 =&gt; array(0x99, 0x33, 0x66, 0x00),
<a name="l00377"></a>00377       0x1A =&gt; array(0xff, 0xff, 0xcc, 0x00),
<a name="l00378"></a>00378       0x1B =&gt; array(0xcc, 0xff, 0xff, 0x00),
<a name="l00379"></a>00379       0x1C =&gt; array(0x66, 0x00, 0x66, 0x00),
<a name="l00380"></a>00380       0x1D =&gt; array(0xff, 0x80, 0x80, 0x00),
<a name="l00381"></a>00381       0x1E =&gt; array(0x00, 0x66, 0xcc, 0x00),
<a name="l00382"></a>00382       0x1F =&gt; array(0xcc, 0xcc, 0xff, 0x00),
<a name="l00383"></a>00383       0x20 =&gt; array(0x00, 0x00, 0x80, 0x00),
<a name="l00384"></a>00384       0x21 =&gt; array(0xff, 0x00, 0xff, 0x00),
<a name="l00385"></a>00385       0x22 =&gt; array(0xff, 0xff, 0x00, 0x00),
<a name="l00386"></a>00386       0x23 =&gt; array(0x00, 0xff, 0xff, 0x00),
<a name="l00387"></a>00387       0x24 =&gt; array(0x80, 0x00, 0x80, 0x00),
<a name="l00388"></a>00388       0x25 =&gt; array(0x80, 0x00, 0x00, 0x00),
<a name="l00389"></a>00389       0x26 =&gt; array(0x00, 0x80, 0x80, 0x00),
<a name="l00390"></a>00390       0x27 =&gt; array(0x00, 0x00, 0xff, 0x00),
<a name="l00391"></a>00391       0x28 =&gt; array(0x00, 0xcc, 0xff, 0x00),
<a name="l00392"></a>00392       0x29 =&gt; array(0xcc, 0xff, 0xff, 0x00),
<a name="l00393"></a>00393       0x2A =&gt; array(0xcc, 0xff, 0xcc, 0x00),
<a name="l00394"></a>00394       0x2B =&gt; array(0xff, 0xff, 0x99, 0x00),
<a name="l00395"></a>00395       0x2C =&gt; array(0x99, 0xcc, 0xff, 0x00),
<a name="l00396"></a>00396       0x2D =&gt; array(0xff, 0x99, 0xcc, 0x00),
<a name="l00397"></a>00397       0x2E =&gt; array(0xcc, 0x99, 0xff, 0x00),
<a name="l00398"></a>00398       0x2F =&gt; array(0xff, 0xcc, 0x99, 0x00),
<a name="l00399"></a>00399       0x30 =&gt; array(0x33, 0x66, 0xff, 0x00),
<a name="l00400"></a>00400       0x31 =&gt; array(0x33, 0xcc, 0xcc, 0x00),
<a name="l00401"></a>00401       0x32 =&gt; array(0x99, 0xcc, 0x00, 0x00),
<a name="l00402"></a>00402       0x33 =&gt; array(0xff, 0xcc, 0x00, 0x00),
<a name="l00403"></a>00403       0x34 =&gt; array(0xff, 0x99, 0x00, 0x00),
<a name="l00404"></a>00404       0x35 =&gt; array(0xff, 0x66, 0x00, 0x00),
<a name="l00405"></a>00405       0x36 =&gt; array(0x66, 0x66, 0x99, 0x00),
<a name="l00406"></a>00406       0x37 =&gt; array(0x96, 0x96, 0x96, 0x00),
<a name="l00407"></a>00407       0x38 =&gt; array(0x00, 0x33, 0x66, 0x00),
<a name="l00408"></a>00408       0x39 =&gt; array(0x33, 0x99, 0x66, 0x00),
<a name="l00409"></a>00409       0x3A =&gt; array(0x00, 0x33, 0x00, 0x00),
<a name="l00410"></a>00410       0x3B =&gt; array(0x33, 0x33, 0x00, 0x00),
<a name="l00411"></a>00411       0x3C =&gt; array(0x99, 0x33, 0x00, 0x00),
<a name="l00412"></a>00412       0x3D =&gt; array(0x99, 0x33, 0x66, 0x00),
<a name="l00413"></a>00413       0x3E =&gt; array(0x33, 0x33, 0x99, 0x00),
<a name="l00414"></a>00414       0x3F =&gt; array(0x33, 0x33, 0x33, 0x00),
<a name="l00415"></a>00415     );
<a name="l00416"></a>00416   }
<a name="l00417"></a>00417 
<a name="l00425"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a9ae5c072c3f923aace9e110fb1bc7ee3">00425</a>   <span class="keyword">public</span> function <a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a9ae5c072c3f923aace9e110fb1bc7ee3" title="Assemble worksheets into a workbook and send the BIFF data to an OLE storage.">writeWorkbook</a>($pWorksheetSizes = null)
<a name="l00426"></a>00426   {
<a name="l00427"></a>00427     $this-&gt;_worksheetSizes = $pWorksheetSizes;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="comment">// Calculate the number of selected worksheet tabs and call the finalization</span>
<a name="l00430"></a>00430     <span class="comment">// methods for each worksheet</span>
<a name="l00431"></a>00431     $total_worksheets = $this-&gt;_phpExcel-&gt;getSheetCount();
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="comment">// Add part 1 of the Workbook globals, what goes before the SHEET records</span>
<a name="l00434"></a>00434     $this-&gt;<a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html#a12400a0377a51eff3493ec7bade946e1" title="Writes Excel BOF record to indicate the beginning of a stream or sub-stream in the...">_storeBof</a>(0x0005);
<a name="l00435"></a>00435     $this-&gt;_writeCodepage();
<a name="l00436"></a>00436     <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0600) {
<a name="l00437"></a>00437       $this-&gt;_writeWindow1();
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0500) {
<a name="l00440"></a>00440       $this-&gt;_writeExterns();    <span class="comment">// For print area and repeat rows</span>
<a name="l00441"></a>00441       $this-&gt;_writeNames();      <span class="comment">// For print area and repeat rows</span>
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443     <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0500) {
<a name="l00444"></a>00444       $this-&gt;_writeWindow1();
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446     $this-&gt;_writeDatemode();
<a name="l00447"></a>00447     $this-&gt;_writeAllFonts();
<a name="l00448"></a>00448     $this-&gt;_writeAllNumFormats();
<a name="l00449"></a>00449     $this-&gt;_writeAllXfs();
<a name="l00450"></a>00450     $this-&gt;_writeAllStyles();
<a name="l00451"></a>00451     $this-&gt;_writePalette();
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <span class="comment">// Prepare part 3 of the workbook global stream, what goes after the SHEET records</span>
<a name="l00454"></a>00454     $part3 = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00455"></a>00455     <span class="keywordflow">if</span> ($this-&gt;_country_code != -1) {
<a name="l00456"></a>00456       $part3 .= $this-&gt;_writeCountry();
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458     $part3 .= $this-&gt;_writeRecalcId();
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0600) {
<a name="l00461"></a>00461       $part3 .= $this-&gt;_writeSupbookInternal();
<a name="l00462"></a>00462       <span class="comment">/* TODO: store external SUPBOOK records and XCT and CRN records</span>
<a name="l00463"></a>00463 <span class="comment">      in case of external references for BIFF8 */</span>
<a name="l00464"></a>00464       $part3 .= $this-&gt;_writeExternsheetBiff8();
<a name="l00465"></a>00465       $part3 .= $this-&gt;_writeAllDefinedNamesBiff8();
<a name="l00466"></a>00466       $part3 .= $this-&gt;_writeMsoDrawingGroup();
<a name="l00467"></a>00467       $part3 .= $this-&gt;_writeSharedStringsTable();
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     $part3 .= $this-&gt;<a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html#a2bf4f9e69f99bb0c0c7a1d47c06a1dad" title="Writes Excel EOF record to indicate the end of a BIFF stream.">writeEof</a>();
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="comment">// Add part 2 of the Workbook globals, the SHEET records</span>
<a name="l00473"></a>00473     $this-&gt;<a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a7008b1799ec63c7d8db6e46848542c0e" title="Calculate offsets for Worksheet BOF records.">_calcSheetOffsets</a>();
<a name="l00474"></a>00474     <span class="keywordflow">for</span> ($i = 0; $i &lt; $total_worksheets; ++$i) {
<a name="l00475"></a>00475       $this-&gt;_writeBoundsheet($this-&gt;_phpExcel-&gt;getSheet($i), $this-&gt;_worksheetOffsets[$i]);
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <span class="comment">// Add part 3 of the Workbook globals</span>
<a name="l00479"></a>00479     $this-&gt;_data .= $part3;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keywordflow">return</span> $this-&gt;_data;
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483 
<a name="l00489"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a7008b1799ec63c7d8db6e46848542c0e">00489</a>   function <a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a7008b1799ec63c7d8db6e46848542c0e" title="Calculate offsets for Worksheet BOF records.">_calcSheetOffsets</a>()
<a name="l00490"></a>00490   {
<a name="l00491"></a>00491     <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0600) {
<a name="l00492"></a>00492       $boundsheet_length = 10;  <span class="comment">// fixed length for a BOUNDSHEET record</span>
<a name="l00493"></a>00493     } <span class="keywordflow">else</span> {
<a name="l00494"></a>00494       $boundsheet_length = 11;
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="comment">// size of Workbook globals part 1 + 3</span>
<a name="l00498"></a>00498     $offset            = $this-&gt;_datasize;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="comment">// add size of Workbook globals part 2, the length of the SHEET records</span>
<a name="l00501"></a>00501     $total_worksheets = count($this-&gt;_phpExcel-&gt;getAllSheets());
<a name="l00502"></a>00502     <span class="keywordflow">foreach</span> ($this-&gt;_phpExcel-&gt;getWorksheetIterator() as $sheet) {
<a name="l00503"></a>00503       <span class="keywordflow">if</span> ($this-&gt;_BIFF_version == 0x0600) {
<a name="l00504"></a>00504         $offset += $boundsheet_length + strlen(<a class="code" href="classPHPExcel__Shared__String.html#aaa01053fb112630ec26f438f47e45d8d" title="Converts a UTF-8 string into BIFF8 Unicode string data (8-bit string length) Writes...">PHPExcel_Shared_String::UTF8toBIFF8UnicodeShort</a>($sheet-&gt;getTitle()));
<a name="l00505"></a>00505       } <span class="keywordflow">else</span> {
<a name="l00506"></a>00506         $offset += $boundsheet_length + strlen($sheet-&gt;getTitle());
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508     }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="comment">// add the sizes of each of the Sheet substreams, respectively</span>
<a name="l00511"></a>00511     <span class="keywordflow">for</span> ($i = 0; $i &lt; $total_worksheets; ++$i) {
<a name="l00512"></a>00512       $this-&gt;_worksheetOffsets[$i] = $offset;
<a name="l00513"></a>00513       $offset += $this-&gt;_worksheetSizes[$i];
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515     $this-&gt;_biffsize = $offset;
<a name="l00516"></a>00516   }
<a name="l00517"></a>00517 
<a name="l00521"></a>00521   <span class="keyword">private</span> function _writeAllFonts()
<a name="l00522"></a>00522   {
<a name="l00523"></a>00523     <span class="keywordflow">foreach</span> ($this-&gt;_fontWriters as $fontWriter) {
<a name="l00524"></a>00524       $this-&gt;<a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html#a38e6651b113081eb0b90da5e35b663ae" title="General storage function.">_append</a>($fontWriter-&gt;writeFont());
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526   }
<a name="l00527"></a>00527 
<a name="l00531"></a>00531   <span class="keyword">private</span> function _writeAllNumFormats()
<a name="l00532"></a>00532   {
<a name="l00533"></a>00533     <span class="keywordflow">foreach</span> ($this-&gt;_numberFormats as $numberFormatIndex =&gt; $numberFormat) {
<a name="l00534"></a>00534       $this-&gt;_writeNumFormat($numberFormat-&gt;getFormatCode(), $numberFormatIndex);
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536   }
<a name="l00537"></a>00537 
<a name="l00541"></a>00541   <span class="keyword">private</span> function _writeAllXfs()
<a name="l00542"></a>00542   {
<a name="l00543"></a>00543     <span class="keywordflow">foreach</span> ($this-&gt;_xfWriters as $xfWriter) {
<a name="l00544"></a>00544       $this-&gt;<a class="code" href="classPHPExcel__Writer__Excel5__BIFFwriter.html#a38e6651b113081eb0b90da5e35b663ae" title="General storage function.">_append</a>($xfWriter-&gt;writeXf());
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547 
<a name="l00551"></a>00551   <span class="keyword">private</span> function _writeAllStyles()
<a name="l00552"></a>00552   {
<a name="l00553"></a>00553     $this-&gt;_writeStyle();
<a name="l00554"></a>00554   }
<a name="l00555"></a>00555 
<a name="l00560"></a>00560   <span class="keyword">private</span> function _writeExterns()
<a name="l00561"></a>00561   {
<a name="l00562"></a>00562     $countSheets = $this-&gt;_phpExcel-&gt;getSheetCount();
<a name="l00563"></a>00563     <span class="comment">// Create EXTERNCOUNT with number of worksheets</span>
<a name="l00564"></a>00564     $this-&gt;_writeExterncount($countSheets);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="comment">// Create EXTERNSHEET for each worksheet</span>
<a name="l00567"></a>00567     <span class="keywordflow">for</span> ($i = 0; $i &lt; $countSheets; ++$i) {
<a name="l00568"></a>00568       $this-&gt;_writeExternsheet($phpExcel-&gt;getSheet($i)-&gt;getTitle());
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570   }
<a name="l00571"></a>00571 
<a name="l00575"></a>00575   <span class="keyword">private</span> function _writeNames()
<a name="l00576"></a>00576   {
<a name="l00577"></a>00577     <span class="comment">// total number of sheets</span>
<a name="l00578"></a>00578     $total_worksheets = $this-&gt;_phpExcel-&gt;getSheetCount();
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment">// Create the print area NAME records</span>
<a name="l00581"></a>00581     <span class="keywordflow">for</span> ($i = 0; $i &lt; $total_worksheets; ++$i) {
<a name="l00582"></a>00582       $sheetSetup = $this-&gt;_phpExcel-&gt;getSheet($i)-&gt;getPageSetup();
<a name="l00583"></a>00583       <span class="comment">// Write a Name record if the print area has been defined</span>
<a name="l00584"></a>00584       <span class="keywordflow">if</span> ($sheetSetup-&gt;isPrintAreaSet()) {
<a name="l00585"></a>00585         <span class="comment">// Print area</span>
<a name="l00586"></a>00586         $printArea = <a class="code" href="classPHPExcel__Cell.html#aa6692bb2d125c0682aa0ef82d519fe0b" title="Split range into coordinate strings.">PHPExcel_Cell::splitRange</a>($sheetSetup-&gt;getPrintArea());
<a name="l00587"></a>00587         $printArea = $printArea[0];
<a name="l00588"></a>00588         $printArea[0] = <a class="code" href="classPHPExcel__Cell.html#a73375d5a70e0b03d15df04c03dbb6c68" title="Coordinate from string.">PHPExcel_Cell::coordinateFromString</a>($printArea[0]);
<a name="l00589"></a>00589         $printArea[1] = <a class="code" href="classPHPExcel__Cell.html#a73375d5a70e0b03d15df04c03dbb6c68" title="Coordinate from string.">PHPExcel_Cell::coordinateFromString</a>($printArea[1]);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         $print_rowmin = $printArea[0][1] - 1;
<a name="l00592"></a>00592         $print_rowmax = $printArea[1][1] - 1;
<a name="l00593"></a>00593         $print_colmin = <a class="code" href="classPHPExcel__Cell.html#a00c53970381f72743472103476da3ec5" title="Column index from string.">PHPExcel_Cell::columnIndexFromString</a>($printArea[0][0]) - 1;
<a name="l00594"></a>00594         $print_colmax = <a class="code" href="classPHPExcel__Cell.html#a00c53970381f72743472103476da3ec5" title="Column index from string.">PHPExcel_Cell::columnIndexFromString</a>($printArea[1][0]) - 1;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596         $this-&gt;_writeNameShort(
<a name="l00597"></a>00597           $i, <span class="comment">// sheet index</span>
<a name="l00598"></a>00598           0x06, <span class="comment">// NAME type</span>
<a name="l00599"></a>00599           $print_rowmin,
<a name="l00600"></a>00600           $print_rowmax,
<a name="l00601"></a>00601           $print_colmin,
<a name="l00602"></a>00602           $print_colmax
<a name="l00603"></a>00603           );
<a name="l00604"></a>00604       }
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="comment">// Create the print title NAME records</span>
<a name="l00608"></a>00608     <span class="keywordflow">for</span> ($i = 0; $i &lt; $total_worksheets; ++$i) {
<a name="l00609"></a>00609       $sheetSetup = $this-&gt;_phpExcel-&gt;getSheet($i)-&gt;getPageSetup();
<a name="l00610"></a>00610 
<a name="l00611"></a>00611       <span class="comment">// simultaneous repeatColumns repeatRows</span>
<a name="l00612"></a>00612       <span class="keywordflow">if</span> ($sheetSetup-&gt;isColumnsToRepeatAtLeftSet() &amp;&amp; $sheetSetup-&gt;isRowsToRepeatAtTopSet()) {
<a name="l00613"></a>00613         $repeat = $sheetSetup-&gt;getColumnsToRepeatAtLeft();
<a name="l00614"></a>00614         $colmin = <a class="code" href="classPHPExcel__Cell.html#a00c53970381f72743472103476da3ec5" title="Column index from string.">PHPExcel_Cell::columnIndexFromString</a>($repeat[0]) - 1;
<a name="l00615"></a>00615         $colmax = <a class="code" href="classPHPExcel__Cell.html#a00c53970381f72743472103476da3ec5" title="Column index from string.">PHPExcel_Cell::columnIndexFromString</a>($repeat[1]) - 1;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         $repeat = $sheetSetup-&gt;getRowsToRepeatAtTop();
<a name="l00618"></a>00618         $rowmin = $repeat[0] - 1;
<a name="l00619"></a>00619         $rowmax = $repeat[1] - 1;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         $this-&gt;_writeNameLong(
<a name="l00622"></a>00622           $i, <span class="comment">// sheet index</span>
<a name="l00623"></a>00623           0x07, <span class="comment">// NAME type</span>
<a name="l00624"></a>00624           $rowmin,
<a name="l00625"></a>00625           $rowmax,
<a name="l00626"></a>00626           $colmin,
<a name="l00627"></a>00627           $colmax
<a name="l00628"></a>00628           );
<a name="l00629"></a>00629 
<a name="l00630"></a>00630       <span class="comment">// (exclusive) either repeatColumns or repeatRows</span>
<a name="l00631"></a>00631       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($sheetSetup-&gt;isColumnsToRepeatAtLeftSet() || $sheetSetup-&gt;isRowsToRepeatAtTopSet()) {
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">// Columns to repeat</span>
<a name="l00634"></a>00634         <span class="keywordflow">if</span> ($sheetSetup-&gt;isColumnsToRepeatAtLeftSet()) {
<a name="l00635"></a>00635           $repeat = $sheetSetup-&gt;getColumnsToRepeatAtLeft();
<a name="l00636"></a>00636           $colmin = <a class="code" href="classPHPExcel__Cell.html#a00c53970381f72743472103476da3ec5" title="Column index from string.">PHPExcel_Cell::columnIndexFromString</a>($repeat[0]) - 1;
<a name="l00637"></a>00637           $colmax = <a class="code" href="classPHPExcel__Cell.html#a00c53970381f72743472103476da3ec5" title="Column index from string.">PHPExcel_Cell::columnIndexFromString</a>($repeat[1]) - 1;
<a name="l00638"></a>00638         } <span class="keywordflow">else</span> {
<a name="l00639"></a>00639           $colmin = 0;
<a name="l00640"></a>00640           $colmax = 255;
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <span class="comment">// Rows to repeat</span>
<a name="l00644"></a>00644         <span class="keywordflow">if</span> ($sheetSetup-&gt;isRowsToRepeatAtTopSet()) {
<a name="l00645"></a>00645           $repeat = $sheetSetup-&gt;getRowsToRepeatAtTop();
<a name="l00646"></a>00646           $rowmin = $repeat[0] - 1;
<a name="l00647"></a>00647           $rowmax = $repeat[1] - 1;
<a name="l00648"></a>00648         } <span class="keywordflow">else</span> {
<a name="l00649"></a>00649           $rowmin = 0;
<a name="l00650"></a>00650           $rowmax = 16383;
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         $this-&gt;_writeNameShort(
<a name="l00654"></a>00654           $i, <span class="comment">// sheet index</span>
<a name="l00655"></a>00655           0x07, <span class="comment">// NAME type</span>
<a name="l00656"></a>00656           $rowmin,
<a name="l00657"></a>00657           $rowmax,
<a name="l00658"></a>00658           $colmin,
<a name="l00659"></a>00659           $colmax
<a name="l00660"></a>00660           );
<a name="l00661"></a>00661       }
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663   }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665 
<a name="l00670"></a>00670   <span class="keyword">private</span> function _writeAllDefinedNamesBiff8()
<a name="l00671"></a>00671   {
<a name="l00672"></a>00672     $chunk = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <span class="comment">// Named ranges</span>
<a name="l00675"></a>00675     <span class="keywordflow">if</span> (count($this-&gt;_phpExcel-&gt;getNamedRanges()) &gt; 0) {
<a name="l00676"></a>00676       <span class="comment">// Loop named ranges</span>
<a name="l00677"></a>00677       $namedRanges = $this-&gt;_phpExcel-&gt;getNamedRanges();
<a name="l00678"></a>00678       <span class="keywordflow">foreach</span> ($namedRanges as $namedRange) {
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <span class="comment">// Create absolute coordinate</span>
<a name="l00681"></a>00681         $range = <a class="code" href="classPHPExcel__Cell.html#aa6692bb2d125c0682aa0ef82d519fe0b" title="Split range into coordinate strings.">PHPExcel_Cell::splitRange</a>($namedRange-&gt;getRange());
<a name="l00682"></a>00682         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($range); $i++) {
<a name="l00683"></a>00683           $range[$i][0] = <span class="charliteral">&#39;\&#39;&#39;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $namedRange-&gt;getWorksheet()-&gt;getTitle()) . <span class="charliteral">&#39;\&#39;</span>!<span class="stringliteral">&#39; . PHPExcel_Cell::absoluteCoordinate($range[$i][0]);</span>
<a name="l00684"></a>00684 <span class="stringliteral">          if (isset($range[$i][1])) {</span>
<a name="l00685"></a>00685 <span class="stringliteral">            $range[$i][1] = PHPExcel_Cell::absoluteCoordinate($range[$i][1]);</span>
<a name="l00686"></a>00686 <span class="stringliteral">          }</span>
<a name="l00687"></a>00687 <span class="stringliteral">        }</span>
<a name="l00688"></a>00688 <span class="stringliteral">        $range = PHPExcel_Cell::buildRange($range); // e.g. Sheet1!$A$1:$B$2</span>
<a name="l00689"></a>00689 <span class="stringliteral"></span>
<a name="l00690"></a>00690 <span class="stringliteral">        // parse formula</span>
<a name="l00691"></a>00691 <span class="stringliteral">        try {</span>
<a name="l00692"></a>00692 <span class="stringliteral">          $error = $this-&gt;_parser-&gt;parse($range);</span>
<a name="l00693"></a>00693 <span class="stringliteral">          $formulaData = $this-&gt;_parser-&gt;toReversePolish();</span>
<a name="l00694"></a>00694 <span class="stringliteral"></span>
<a name="l00695"></a>00695 <span class="stringliteral">          // make sure tRef3d is of type tRef3dR (0x3A)</span>
<a name="l00696"></a>00696 <span class="stringliteral">          if (isset($formulaData{0}) and ($formulaData{0} == &quot;\x7A&quot; or $formulaData{0} == &quot;\x5A&quot;)) {</span>
<a name="l00697"></a>00697 <span class="stringliteral">            $formulaData = &quot;\x3A&quot; . substr($formulaData, 1);</span>
<a name="l00698"></a>00698 <span class="stringliteral">          }</span>
<a name="l00699"></a>00699 <span class="stringliteral"></span>
<a name="l00700"></a>00700 <span class="stringliteral">          if ($namedRange-&gt;getLocalOnly()) {</span>
<a name="l00701"></a>00701 <span class="stringliteral">            // local scope</span>
<a name="l00702"></a>00702 <span class="stringliteral">            $scope = $this-&gt;_phpExcel-&gt;getIndex($namedRange-&gt;getScope()) + 1;</span>
<a name="l00703"></a>00703 <span class="stringliteral">          } else {</span>
<a name="l00704"></a>00704 <span class="stringliteral">            // global scope</span>
<a name="l00705"></a>00705 <span class="stringliteral">            $scope = 0;</span>
<a name="l00706"></a>00706 <span class="stringliteral">          }</span>
<a name="l00707"></a>00707 <span class="stringliteral">          $chunk .= $this-&gt;writeData($this-&gt;_writeDefinedNameBiff8($namedRange-&gt;getName(), $formulaData, $scope, false));</span>
<a name="l00708"></a>00708 <span class="stringliteral"></span>
<a name="l00709"></a>00709 <span class="stringliteral">        } catch(Exception $e) {</span>
<a name="l00710"></a>00710 <span class="stringliteral">          // do nothing</span>
<a name="l00711"></a>00711 <span class="stringliteral">        }</span>
<a name="l00712"></a>00712 <span class="stringliteral">      }</span>
<a name="l00713"></a>00713 <span class="stringliteral">    }</span>
<a name="l00714"></a>00714 <span class="stringliteral"></span>
<a name="l00715"></a>00715 <span class="stringliteral">    // total number of sheets</span>
<a name="l00716"></a>00716 <span class="stringliteral">    $total_worksheets = $this-&gt;_phpExcel-&gt;getSheetCount();</span>
<a name="l00717"></a>00717 <span class="stringliteral"></span>
<a name="l00718"></a>00718 <span class="stringliteral">    // write the print titles (repeating rows, columns), if any</span>
<a name="l00719"></a>00719 <span class="stringliteral">    for ($i = 0; $i &lt; $total_worksheets; ++$i) {</span>
<a name="l00720"></a>00720 <span class="stringliteral">      $sheetSetup = $this-&gt;_phpExcel-&gt;getSheet($i)-&gt;getPageSetup();</span>
<a name="l00721"></a>00721 <span class="stringliteral">      // simultaneous repeatColumns repeatRows</span>
<a name="l00722"></a>00722 <span class="stringliteral">      if ($sheetSetup-&gt;isColumnsToRepeatAtLeftSet() &amp;&amp; $sheetSetup-&gt;isRowsToRepeatAtTopSet()) {</span>
<a name="l00723"></a>00723 <span class="stringliteral">        $repeat = $sheetSetup-&gt;getColumnsToRepeatAtLeft();</span>
<a name="l00724"></a>00724 <span class="stringliteral">        $colmin = PHPExcel_Cell::columnIndexFromString($repeat[0]) - 1;</span>
<a name="l00725"></a>00725 <span class="stringliteral">        $colmax = PHPExcel_Cell::columnIndexFromString($repeat[1]) - 1;</span>
<a name="l00726"></a>00726 <span class="stringliteral"></span>
<a name="l00727"></a>00727 <span class="stringliteral">        $repeat = $sheetSetup-&gt;getRowsToRepeatAtTop();</span>
<a name="l00728"></a>00728 <span class="stringliteral">        $rowmin = $repeat[0] - 1;</span>
<a name="l00729"></a>00729 <span class="stringliteral">        $rowmax = $repeat[1] - 1;</span>
<a name="l00730"></a>00730 <span class="stringliteral"></span>
<a name="l00731"></a>00731 <span class="stringliteral">        // construct formula data manually</span>
<a name="l00732"></a>00732 <span class="stringliteral">        $formulaData = pack(&#39;</span>Cv<span class="stringliteral">&#39;, 0x29, 0x17); // tMemFunc</span>
<a name="l00733"></a>00733 <span class="stringliteral">        $formulaData .= pack(&#39;</span>Cvvvvv<span class="stringliteral">&#39;, 0x3B, $i, 0, 65535, $colmin, $colmax); // tArea3d</span>
<a name="l00734"></a>00734 <span class="stringliteral">        $formulaData .= pack(&#39;</span>Cvvvvv<span class="stringliteral">&#39;, 0x3B, $i, $rowmin, $rowmax, 0, 255); // tArea3d</span>
<a name="l00735"></a>00735 <span class="stringliteral">        $formulaData .= pack(&#39;</span>C<span class="stringliteral">&#39;, 0x10); // tList</span>
<a name="l00736"></a>00736 <span class="stringliteral"></span>
<a name="l00737"></a>00737 <span class="stringliteral">        // store the DEFINEDNAME record</span>
<a name="l00738"></a>00738 <span class="stringliteral">        $chunk .= $this-&gt;writeData($this-&gt;_writeDefinedNameBiff8(pack(&#39;</span>C<span class="stringliteral">&#39;, 0x07), $formulaData, $i + 1, true));</span>
<a name="l00739"></a>00739 <span class="stringliteral"></span>
<a name="l00740"></a>00740 <span class="stringliteral">      // (exclusive) either repeatColumns or repeatRows</span>
<a name="l00741"></a>00741 <span class="stringliteral">      } else if ($sheetSetup-&gt;isColumnsToRepeatAtLeftSet() || $sheetSetup-&gt;isRowsToRepeatAtTopSet()) {</span>
<a name="l00742"></a>00742 <span class="stringliteral"></span>
<a name="l00743"></a>00743 <span class="stringliteral">        // Columns to repeat</span>
<a name="l00744"></a>00744 <span class="stringliteral">        if ($sheetSetup-&gt;isColumnsToRepeatAtLeftSet()) {</span>
<a name="l00745"></a>00745 <span class="stringliteral">          $repeat = $sheetSetup-&gt;getColumnsToRepeatAtLeft();</span>
<a name="l00746"></a>00746 <span class="stringliteral">          $colmin = PHPExcel_Cell::columnIndexFromString($repeat[0]) - 1;</span>
<a name="l00747"></a>00747 <span class="stringliteral">          $colmax = PHPExcel_Cell::columnIndexFromString($repeat[1]) - 1;</span>
<a name="l00748"></a>00748 <span class="stringliteral">        } else {</span>
<a name="l00749"></a>00749 <span class="stringliteral">          $colmin = 0;</span>
<a name="l00750"></a>00750 <span class="stringliteral">          $colmax = 255;</span>
<a name="l00751"></a>00751 <span class="stringliteral">        }</span>
<a name="l00752"></a>00752 <span class="stringliteral">        // Rows to repeat</span>
<a name="l00753"></a>00753 <span class="stringliteral">        if ($sheetSetup-&gt;isRowsToRepeatAtTopSet()) {</span>
<a name="l00754"></a>00754 <span class="stringliteral">          $repeat = $sheetSetup-&gt;getRowsToRepeatAtTop();</span>
<a name="l00755"></a>00755 <span class="stringliteral">          $rowmin = $repeat[0] - 1;</span>
<a name="l00756"></a>00756 <span class="stringliteral">          $rowmax = $repeat[1] - 1;</span>
<a name="l00757"></a>00757 <span class="stringliteral">        } else {</span>
<a name="l00758"></a>00758 <span class="stringliteral">          $rowmin = 0;</span>
<a name="l00759"></a>00759 <span class="stringliteral">          $rowmax = 65535;</span>
<a name="l00760"></a>00760 <span class="stringliteral">        }</span>
<a name="l00761"></a>00761 <span class="stringliteral"></span>
<a name="l00762"></a>00762 <span class="stringliteral">        // construct formula data manually because parser does not recognize absolute 3d cell references</span>
<a name="l00763"></a>00763 <span class="stringliteral">        $formulaData = pack(&#39;</span>Cvvvvv<span class="stringliteral">&#39;, 0x3B, $i, $rowmin, $rowmax, $colmin, $colmax);</span>
<a name="l00764"></a>00764 <span class="stringliteral"></span>
<a name="l00765"></a>00765 <span class="stringliteral">        // store the DEFINEDNAME record</span>
<a name="l00766"></a>00766 <span class="stringliteral">        $chunk .= $this-&gt;writeData($this-&gt;_writeDefinedNameBiff8(pack(&#39;</span>C<span class="stringliteral">&#39;, 0x07), $formulaData, $i + 1, true));</span>
<a name="l00767"></a>00767 <span class="stringliteral">      }</span>
<a name="l00768"></a>00768 <span class="stringliteral">    }</span>
<a name="l00769"></a>00769 <span class="stringliteral"></span>
<a name="l00770"></a>00770 <span class="stringliteral">    // write the print areas, if any</span>
<a name="l00771"></a>00771 <span class="stringliteral">    for ($i = 0; $i &lt; $total_worksheets; ++$i) {</span>
<a name="l00772"></a>00772 <span class="stringliteral">      $sheetSetup = $this-&gt;_phpExcel-&gt;getSheet($i)-&gt;getPageSetup();</span>
<a name="l00773"></a>00773 <span class="stringliteral">      if ($sheetSetup-&gt;isPrintAreaSet()) {</span>
<a name="l00774"></a>00774 <span class="stringliteral">        // Print area, e.g. A3:J6,H1:X20</span>
<a name="l00775"></a>00775 <span class="stringliteral">        $printArea = PHPExcel_Cell::splitRange($sheetSetup-&gt;getPrintArea());</span>
<a name="l00776"></a>00776 <span class="stringliteral">        $countPrintArea = count($printArea);</span>
<a name="l00777"></a>00777 <span class="stringliteral"></span>
<a name="l00778"></a>00778 <span class="stringliteral">        $formulaData = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00779"></a>00779 <span class="stringliteral">        for ($j = 0; $j &lt; $countPrintArea; ++$j) {</span>
<a name="l00780"></a>00780 <span class="stringliteral">          $printAreaRect = $printArea[$j]; // e.g. A3:J6</span>
<a name="l00781"></a>00781 <span class="stringliteral">          $printAreaRect[0] = PHPExcel_Cell::coordinateFromString($printAreaRect[0]);</span>
<a name="l00782"></a>00782 <span class="stringliteral">          $printAreaRect[1] = PHPExcel_Cell::coordinateFromString($printAreaRect[1]);</span>
<a name="l00783"></a>00783 <span class="stringliteral"></span>
<a name="l00784"></a>00784 <span class="stringliteral">          $print_rowmin = $printAreaRect[0][1] - 1;</span>
<a name="l00785"></a>00785 <span class="stringliteral">          $print_rowmax = $printAreaRect[1][1] - 1;</span>
<a name="l00786"></a>00786 <span class="stringliteral">          $print_colmin = PHPExcel_Cell::columnIndexFromString($printAreaRect[0][0]) - 1;</span>
<a name="l00787"></a>00787 <span class="stringliteral">          $print_colmax = PHPExcel_Cell::columnIndexFromString($printAreaRect[1][0]) - 1;</span>
<a name="l00788"></a>00788 <span class="stringliteral"></span>
<a name="l00789"></a>00789 <span class="stringliteral">          // construct formula data manually because parser does not recognize absolute 3d cell references</span>
<a name="l00790"></a>00790 <span class="stringliteral">          $formulaData .= pack(&#39;</span>Cvvvvv<span class="stringliteral">&#39;, 0x3B, $i, $print_rowmin, $print_rowmax, $print_colmin, $print_colmax);</span>
<a name="l00791"></a>00791 <span class="stringliteral"></span>
<a name="l00792"></a>00792 <span class="stringliteral">          if ($j &gt; 0) {</span>
<a name="l00793"></a>00793 <span class="stringliteral">            $formulaData .= pack(&#39;</span>C<span class="stringliteral">&#39;, 0x10); // list operator token &#39;</span>,<span class="stringliteral">&#39;</span>
<a name="l00794"></a>00794 <span class="stringliteral">          }</span>
<a name="l00795"></a>00795 <span class="stringliteral">        }</span>
<a name="l00796"></a>00796 <span class="stringliteral"></span>
<a name="l00797"></a>00797 <span class="stringliteral">        // store the DEFINEDNAME record</span>
<a name="l00798"></a>00798 <span class="stringliteral">        $chunk .= $this-&gt;writeData($this-&gt;_writeDefinedNameBiff8(pack(&#39;</span>C<span class="stringliteral">&#39;, 0x06), $formulaData, $i + 1, true));</span>
<a name="l00799"></a>00799 <span class="stringliteral">      }</span>
<a name="l00800"></a>00800 <span class="stringliteral">    }</span>
<a name="l00801"></a>00801 <span class="stringliteral"></span>
<a name="l00802"></a>00802 <span class="stringliteral">    return $chunk;</span>
<a name="l00803"></a>00803 <span class="stringliteral">  }</span>
<a name="l00804"></a>00804 <span class="stringliteral"></span>
<a name="l00814"></a>00814 <span class="stringliteral">  private function _writeDefinedNameBiff8($name, $formulaData, $sheetIndex = 0, $isBuiltIn = false)</span>
<a name="l00815"></a>00815 <span class="stringliteral">  {</span>
<a name="l00816"></a>00816 <span class="stringliteral">    $record = 0x0018;</span>
<a name="l00817"></a>00817 <span class="stringliteral"></span>
<a name="l00818"></a>00818 <span class="stringliteral">    // option flags</span>
<a name="l00819"></a>00819 <span class="stringliteral">    $options = $isBuiltIn ? 0x20 : 0x00;</span>
<a name="l00820"></a>00820 <span class="stringliteral"></span>
<a name="l00821"></a>00821 <span class="stringliteral">    // length of the name, character count</span>
<a name="l00822"></a>00822 <span class="stringliteral">    $nlen = PHPExcel_Shared_String::CountCharacters($name);</span>
<a name="l00823"></a>00823 <span class="stringliteral"></span>
<a name="l00824"></a>00824 <span class="stringliteral">    // name with stripped length field</span>
<a name="l00825"></a>00825 <span class="stringliteral">    $name = substr(PHPExcel_Shared_String::UTF8toBIFF8UnicodeLong($name), 2);</span>
<a name="l00826"></a>00826 <span class="stringliteral"></span>
<a name="l00827"></a>00827 <span class="stringliteral">    // size of the formula (in bytes)</span>
<a name="l00828"></a>00828 <span class="stringliteral">    $sz = strlen($formulaData);</span>
<a name="l00829"></a>00829 <span class="stringliteral"></span>
<a name="l00830"></a>00830 <span class="stringliteral">    // combine the parts</span>
<a name="l00831"></a>00831 <span class="stringliteral">    $data = pack(&#39;</span>vCCvvvCCCC<span class="stringliteral">&#39;, $options, 0, $nlen, $sz, 0, $sheetIndex, 0, 0, 0, 0)</span>
<a name="l00832"></a>00832 <span class="stringliteral">      . $name . $formulaData;</span>
<a name="l00833"></a>00833 <span class="stringliteral">    $length = strlen($data);</span>
<a name="l00834"></a>00834 <span class="stringliteral"></span>
<a name="l00835"></a>00835 <span class="stringliteral">    $header = pack(&#39;</span>vv<span class="stringliteral">&#39;, $record, $length);</span>
<a name="l00836"></a>00836 <span class="stringliteral"></span>
<a name="l00837"></a>00837 <span class="stringliteral">    return $header . $data;</span>
<a name="l00838"></a>00838 <span class="stringliteral">  }</span>
<a name="l00839"></a>00839 <span class="stringliteral"></span>
<a name="l00843"></a>00843 <span class="stringliteral">  private function _writeCodepage()</span>
<a name="l00844"></a>00844 <span class="stringliteral">  {</span>
<a name="l00845"></a>00845 <span class="stringliteral">    $record          = 0x0042;             // Record identifier</span>
<a name="l00846"></a>00846 <span class="stringliteral">    $length          = 0x0002;             // Number of bytes to follow</span>
<a name="l00847"></a>00847 <span class="stringliteral">    $cv              = $this-&gt;_codepage;   // The code page</span>
<a name="l00848"></a>00848 <span class="stringliteral"></span>
<a name="l00849"></a>00849 <span class="stringliteral">    $header          = pack(&#39;</span>vv<span class="stringliteral">&#39;, $record, $length);</span>
<a name="l00850"></a>00850 <span class="stringliteral">    $data            = pack(&#39;</span>v<span class="stringliteral">&#39;,  $cv);</span>
<a name="l00851"></a>00851 <span class="stringliteral"></span>
<a name="l00852"></a>00852 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l00853"></a>00853 <span class="stringliteral">  }</span>
<a name="l00854"></a>00854 <span class="stringliteral"></span>
<a name="l00858"></a>00858 <span class="stringliteral">  private function _writeWindow1()</span>
<a name="l00859"></a>00859 <span class="stringliteral">  {</span>
<a name="l00860"></a>00860 <span class="stringliteral">    $record    = 0x003D;                 // Record identifier</span>
<a name="l00861"></a>00861 <span class="stringliteral">    $length    = 0x0012;                 // Number of bytes to follow</span>
<a name="l00862"></a>00862 <span class="stringliteral"></span>
<a name="l00863"></a>00863 <span class="stringliteral">    $xWn       = 0x0000;                 // Horizontal position of window</span>
<a name="l00864"></a>00864 <span class="stringliteral">    $yWn       = 0x0000;                 // Vertical position of window</span>
<a name="l00865"></a>00865 <span class="stringliteral">    $dxWn      = 0x25BC;                 // Width of window</span>
<a name="l00866"></a>00866 <span class="stringliteral">    $dyWn      = 0x1572;                 // Height of window</span>
<a name="l00867"></a>00867 <span class="stringliteral"></span>
<a name="l00868"></a>00868 <span class="stringliteral">    $grbit     = 0x0038;                 // Option flags</span>
<a name="l00869"></a>00869 <span class="stringliteral"></span>
<a name="l00870"></a>00870 <span class="stringliteral">    // not supported by PHPExcel, so there is only one selected sheet, the active</span>
<a name="l00871"></a>00871 <span class="stringliteral">    $ctabsel   = 1;       // Number of workbook tabs selected</span>
<a name="l00872"></a>00872 <span class="stringliteral"></span>
<a name="l00873"></a>00873 <span class="stringliteral">    $wTabRatio = 0x0258;                 // Tab to scrollbar ratio</span>
<a name="l00874"></a>00874 <span class="stringliteral"></span>
<a name="l00875"></a>00875 <span class="stringliteral">    // not supported by PHPExcel, set to 0</span>
<a name="l00876"></a>00876 <span class="stringliteral">    $itabFirst = 0;     // 1st displayed worksheet</span>
<a name="l00877"></a>00877 <span class="stringliteral">    $itabCur   = $this-&gt;_phpExcel-&gt;getActiveSheetIndex();    // Active worksheet</span>
<a name="l00878"></a>00878 <span class="stringliteral"></span>
<a name="l00879"></a>00879 <span class="stringliteral">    $header    = pack(&quot;vv&quot;,        $record, $length);</span>
<a name="l00880"></a>00880 <span class="stringliteral">    $data      = pack(&quot;vvvvvvvvv&quot;, $xWn, $yWn, $dxWn, $dyWn,</span>
<a name="l00881"></a>00881 <span class="stringliteral">                     $grbit,</span>
<a name="l00882"></a>00882 <span class="stringliteral">                     $itabCur, $itabFirst,</span>
<a name="l00883"></a>00883 <span class="stringliteral">                     $ctabsel, $wTabRatio);</span>
<a name="l00884"></a>00884 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l00885"></a>00885 <span class="stringliteral">  }</span>
<a name="l00886"></a>00886 <span class="stringliteral"></span>
<a name="l00893"></a>00893 <span class="stringliteral">  private function _writeBoundsheet($sheet, $offset)</span>
<a name="l00894"></a>00894 <span class="stringliteral">  {</span>
<a name="l00895"></a>00895 <span class="stringliteral">    $sheetname = $sheet-&gt;getTitle();</span>
<a name="l00896"></a>00896 <span class="stringliteral">    $record    = 0x0085;                    // Record identifier</span>
<a name="l00897"></a>00897 <span class="stringliteral"></span>
<a name="l00898"></a>00898 <span class="stringliteral">    // sheet state</span>
<a name="l00899"></a>00899 <span class="stringliteral">    switch ($sheet-&gt;getSheetState()) {</span>
<a name="l00900"></a>00900 <span class="stringliteral">      case PHPExcel_Worksheet::SHEETSTATE_VISIBLE:  $ss = 0x00; break;</span>
<a name="l00901"></a>00901 <span class="stringliteral">      case PHPExcel_Worksheet::SHEETSTATE_HIDDEN:   $ss = 0x01; break;</span>
<a name="l00902"></a>00902 <span class="stringliteral">      case PHPExcel_Worksheet::SHEETSTATE_VERYHIDDEN: $ss = 0x02; break;</span>
<a name="l00903"></a>00903 <span class="stringliteral">      default: $ss = 0x00; break;</span>
<a name="l00904"></a>00904 <span class="stringliteral">    }</span>
<a name="l00905"></a>00905 <span class="stringliteral"></span>
<a name="l00906"></a>00906 <span class="stringliteral">    // sheet type</span>
<a name="l00907"></a>00907 <span class="stringliteral">    $st = 0x00;</span>
<a name="l00908"></a>00908 <span class="stringliteral"></span>
<a name="l00909"></a>00909 <span class="stringliteral">    $grbit     = 0x0000;                    // Visibility and sheet type</span>
<a name="l00910"></a>00910 <span class="stringliteral"></span>
<a name="l00911"></a>00911 <span class="stringliteral">    if ($this-&gt;_BIFF_version == 0x0600) {</span>
<a name="l00912"></a>00912 <span class="stringliteral">      $data      = pack(&quot;VCC&quot;, $offset, $ss, $st);</span>
<a name="l00913"></a>00913 <span class="stringliteral">      $data .= PHPExcel_Shared_String::UTF8toBIFF8UnicodeShort($sheetname);</span>
<a name="l00914"></a>00914 <span class="stringliteral">    } else {</span>
<a name="l00915"></a>00915 <span class="stringliteral">      $cch       = strlen($sheetname);        // Length of sheet name</span>
<a name="l00916"></a>00916 <span class="stringliteral">      $data      = pack(&quot;VCCC&quot;, $offset, $ss, $st, $cch);</span>
<a name="l00917"></a>00917 <span class="stringliteral">      $data .= $sheetname;</span>
<a name="l00918"></a>00918 <span class="stringliteral">    }</span>
<a name="l00919"></a>00919 <span class="stringliteral"></span>
<a name="l00920"></a>00920 <span class="stringliteral">    $length = strlen($data);</span>
<a name="l00921"></a>00921 <span class="stringliteral">    $header = pack(&quot;vv&quot;,  $record, $length);</span>
<a name="l00922"></a>00922 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l00923"></a>00923 <span class="stringliteral">  }</span>
<a name="l00924"></a>00924 <span class="stringliteral"></span>
<a name="l00928"></a>00928 <span class="stringliteral">  private function _writeSupbookInternal()</span>
<a name="l00929"></a>00929 <span class="stringliteral">  {</span>
<a name="l00930"></a>00930 <span class="stringliteral">    $record    = 0x01AE;   // Record identifier</span>
<a name="l00931"></a>00931 <span class="stringliteral">    $length    = 0x0004;   // Bytes to follow</span>
<a name="l00932"></a>00932 <span class="stringliteral"></span>
<a name="l00933"></a>00933 <span class="stringliteral">    $header    = pack(&quot;vv&quot;, $record, $length);</span>
<a name="l00934"></a>00934 <span class="stringliteral">    $data      = pack(&quot;vv&quot;, $this-&gt;_phpExcel-&gt;getSheetCount(), 0x0401);</span>
<a name="l00935"></a>00935 <span class="stringliteral">    return $this-&gt;writeData($header . $data);</span>
<a name="l00936"></a>00936 <span class="stringliteral">  }</span>
<a name="l00937"></a>00937 <span class="stringliteral"></span>
<a name="l00943"></a>00943 <span class="stringliteral">  private function _writeExternsheetBiff8()</span>
<a name="l00944"></a>00944 <span class="stringliteral">  {</span>
<a name="l00945"></a>00945 <span class="stringliteral">    $total_references = count($this-&gt;_parser-&gt;_references);</span>
<a name="l00946"></a>00946 <span class="stringliteral">    $record   = 0x0017;                     // Record identifier</span>
<a name="l00947"></a>00947 <span class="stringliteral">    $length   = 2 + 6 * $total_references;  // Number of bytes to follow</span>
<a name="l00948"></a>00948 <span class="stringliteral"></span>
<a name="l00949"></a>00949 <span class="stringliteral">    $supbook_index = 0;           // FIXME: only using internal SUPBOOK record</span>
<a name="l00950"></a>00950 <span class="stringliteral">    $header           = pack(&quot;vv&quot;,  $record, $length);</span>
<a name="l00951"></a>00951 <span class="stringliteral">    $data             = pack(&#39;</span>v<span class="stringliteral">&#39;, $total_references);</span>
<a name="l00952"></a>00952 <span class="stringliteral">    for ($i = 0; $i &lt; $total_references; ++$i) {</span>
<a name="l00953"></a>00953 <span class="stringliteral">      $data .= $this-&gt;_parser-&gt;_references[$i];</span>
<a name="l00954"></a>00954 <span class="stringliteral">    }</span>
<a name="l00955"></a>00955 <span class="stringliteral">    return $this-&gt;writeData($header . $data);</span>
<a name="l00956"></a>00956 <span class="stringliteral">  }</span>
<a name="l00957"></a>00957 <span class="stringliteral"></span>
<a name="l00961"></a>00961 <span class="stringliteral">  private function _writeStyle()</span>
<a name="l00962"></a>00962 <span class="stringliteral">  {</span>
<a name="l00963"></a>00963 <span class="stringliteral">    $record    = 0x0293;   // Record identifier</span>
<a name="l00964"></a>00964 <span class="stringliteral">    $length    = 0x0004;   // Bytes to follow</span>
<a name="l00965"></a>00965 <span class="stringliteral"></span>
<a name="l00966"></a>00966 <span class="stringliteral">    $ixfe      = 0x8000;  // Index to cell style XF</span>
<a name="l00967"></a>00967 <span class="stringliteral">    $BuiltIn   = 0x00;     // Built-in style</span>
<a name="l00968"></a>00968 <span class="stringliteral">    $iLevel    = 0xff;     // Outline style level</span>
<a name="l00969"></a>00969 <span class="stringliteral"></span>
<a name="l00970"></a>00970 <span class="stringliteral">    $header    = pack(&quot;vv&quot;,  $record, $length);</span>
<a name="l00971"></a>00971 <span class="stringliteral">    $data      = pack(&quot;vCC&quot;, $ixfe, $BuiltIn, $iLevel);</span>
<a name="l00972"></a>00972 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l00973"></a>00973 <span class="stringliteral">  }</span>
<a name="l00974"></a>00974 <span class="stringliteral"></span>
<a name="l00975"></a>00975 <span class="stringliteral"></span>
<a name="l00982"></a>00982 <span class="stringliteral">  private function _writeNumFormat($format, $ifmt)</span>
<a name="l00983"></a>00983 <span class="stringliteral">  {</span>
<a name="l00984"></a>00984 <span class="stringliteral">    $record    = 0x041E;                      // Record identifier</span>
<a name="l00985"></a>00985 <span class="stringliteral"></span>
<a name="l00986"></a>00986 <span class="stringliteral">    if ($this-&gt;_BIFF_version == 0x0600) {</span>
<a name="l00987"></a>00987 <span class="stringliteral">      $numberFormatString = PHPExcel_Shared_String::UTF8toBIFF8UnicodeLong($format);</span>
<a name="l00988"></a>00988 <span class="stringliteral">      $length    = 2 + strlen($numberFormatString);      // Number of bytes to follow</span>
<a name="l00989"></a>00989 <span class="stringliteral">    } elseif ($this-&gt;_BIFF_version == 0x0500) {</span>
<a name="l00990"></a>00990 <span class="stringliteral">      $length    = 3 + strlen($format);      // Number of bytes to follow</span>
<a name="l00991"></a>00991 <span class="stringliteral">    }</span>
<a name="l00992"></a>00992 <span class="stringliteral"></span>
<a name="l00993"></a>00993 <span class="stringliteral"></span>
<a name="l00994"></a>00994 <span class="stringliteral">    $header    = pack(&quot;vv&quot;, $record, $length);</span>
<a name="l00995"></a>00995 <span class="stringliteral">    if ($this-&gt;_BIFF_version == 0x0600) {</span>
<a name="l00996"></a>00996 <span class="stringliteral">      $data      = pack(&quot;v&quot;, $ifmt) .  $numberFormatString;</span>
<a name="l00997"></a>00997 <span class="stringliteral">      $this-&gt;_append($header . $data);</span>
<a name="l00998"></a>00998 <span class="stringliteral">    } elseif ($this-&gt;_BIFF_version == 0x0500) {</span>
<a name="l00999"></a>00999 <span class="stringliteral">      $cch       = strlen($format);             // Length of format string</span>
<a name="l01000"></a>01000 <span class="stringliteral">      $data      = pack(&quot;vC&quot;, $ifmt, $cch);</span>
<a name="l01001"></a>01001 <span class="stringliteral">      $this-&gt;_append($header . $data . $format);</span>
<a name="l01002"></a>01002 <span class="stringliteral">    }</span>
<a name="l01003"></a>01003 <span class="stringliteral">  }</span>
<a name="l01004"></a>01004 <span class="stringliteral"></span>
<a name="l01008"></a>01008 <span class="stringliteral">  private function _writeDatemode()</span>
<a name="l01009"></a>01009 <span class="stringliteral">  {</span>
<a name="l01010"></a>01010 <span class="stringliteral">    $record    = 0x0022;         // Record identifier</span>
<a name="l01011"></a>01011 <span class="stringliteral">    $length    = 0x0002;         // Bytes to follow</span>
<a name="l01012"></a>01012 <span class="stringliteral"></span>
<a name="l01013"></a>01013 <span class="stringliteral">    $f1904     = (PHPExcel_Shared_Date::getExcelCalendar() == PHPExcel_Shared_Date::CALENDAR_MAC_1904) ?</span>
<a name="l01014"></a>01014 <span class="stringliteral">      1 : 0;   // Flag for 1904 date system</span>
<a name="l01015"></a>01015 <span class="stringliteral"></span>
<a name="l01016"></a>01016 <span class="stringliteral">    $header    = pack(&quot;vv&quot;, $record, $length);</span>
<a name="l01017"></a>01017 <span class="stringliteral">    $data      = pack(&quot;v&quot;, $f1904);</span>
<a name="l01018"></a>01018 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l01019"></a>01019 <span class="stringliteral">  }</span>
<a name="l01020"></a>01020 <span class="stringliteral"></span>
<a name="l01021"></a>01021 <span class="stringliteral"></span>
<a name="l01034"></a>01034 <span class="stringliteral">  private function _writeExterncount($cxals)</span>
<a name="l01035"></a>01035 <span class="stringliteral">  {</span>
<a name="l01036"></a>01036 <span class="stringliteral">    $record   = 0x0016;          // Record identifier</span>
<a name="l01037"></a>01037 <span class="stringliteral">    $length   = 0x0002;          // Number of bytes to follow</span>
<a name="l01038"></a>01038 <span class="stringliteral"></span>
<a name="l01039"></a>01039 <span class="stringliteral">    $header   = pack(&quot;vv&quot;, $record, $length);</span>
<a name="l01040"></a>01040 <span class="stringliteral">    $data     = pack(&quot;v&quot;,  $cxals);</span>
<a name="l01041"></a>01041 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l01042"></a>01042 <span class="stringliteral">  }</span>
<a name="l01043"></a>01043 <span class="stringliteral"></span>
<a name="l01044"></a>01044 <span class="stringliteral"></span>
<a name="l01054"></a>01054 <span class="stringliteral">  private function _writeExternsheet($sheetname)</span>
<a name="l01055"></a>01055 <span class="stringliteral">  {</span>
<a name="l01056"></a>01056 <span class="stringliteral">    $record      = 0x0017;                     // Record identifier</span>
<a name="l01057"></a>01057 <span class="stringliteral">    $length      = 0x02 + strlen($sheetname);  // Number of bytes to follow</span>
<a name="l01058"></a>01058 <span class="stringliteral"></span>
<a name="l01059"></a>01059 <span class="stringliteral">    $cch         = strlen($sheetname);         // Length of sheet name</span>
<a name="l01060"></a>01060 <span class="stringliteral">    $rgch        = 0x03;                       // Filename encoding</span>
<a name="l01061"></a>01061 <span class="stringliteral"></span>
<a name="l01062"></a>01062 <span class="stringliteral">    $header      = pack(&quot;vv&quot;,  $record, $length);</span>
<a name="l01063"></a>01063 <span class="stringliteral">    $data        = pack(&quot;CC&quot;, $cch, $rgch);</span>
<a name="l01064"></a>01064 <span class="stringliteral">    $this-&gt;_append($header . $data . $sheetname);</span>
<a name="l01065"></a>01065 <span class="stringliteral">  }</span>
<a name="l01066"></a>01066 <span class="stringliteral"></span>
<a name="l01067"></a>01067 <span class="stringliteral"></span>
<a name="l01079"></a>01079 <span class="stringliteral">  private function _writeNameShort($index, $type, $rowmin, $rowmax, $colmin, $colmax)</span>
<a name="l01080"></a>01080 <span class="stringliteral">  {</span>
<a name="l01081"></a>01081 <span class="stringliteral">    $record          = 0x0018;       // Record identifier</span>
<a name="l01082"></a>01082 <span class="stringliteral">    $length          = 0x0024;       // Number of bytes to follow</span>
<a name="l01083"></a>01083 <span class="stringliteral"></span>
<a name="l01084"></a>01084 <span class="stringliteral">    $grbit           = 0x0020;       // Option flags</span>
<a name="l01085"></a>01085 <span class="stringliteral">    $chKey           = 0x00;         // Keyboard shortcut</span>
<a name="l01086"></a>01086 <span class="stringliteral">    $cch             = 0x01;         // Length of text name</span>
<a name="l01087"></a>01087 <span class="stringliteral">    $cce             = 0x0015;       // Length of text definition</span>
<a name="l01088"></a>01088 <span class="stringliteral">    $ixals           = $index + 1;   // Sheet index</span>
<a name="l01089"></a>01089 <span class="stringliteral">    $itab            = $ixals;       // Equal to ixals</span>
<a name="l01090"></a>01090 <span class="stringliteral">    $cchCustMenu     = 0x00;         // Length of cust menu text</span>
<a name="l01091"></a>01091 <span class="stringliteral">    $cchDescription  = 0x00;         // Length of description text</span>
<a name="l01092"></a>01092 <span class="stringliteral">    $cchHelptopic    = 0x00;         // Length of help topic text</span>
<a name="l01093"></a>01093 <span class="stringliteral">    $cchStatustext   = 0x00;         // Length of status bar text</span>
<a name="l01094"></a>01094 <span class="stringliteral">    $rgch            = $type;        // Built-in name type</span>
<a name="l01095"></a>01095 <span class="stringliteral"></span>
<a name="l01096"></a>01096 <span class="stringliteral">    $unknown03       = 0x3b;</span>
<a name="l01097"></a>01097 <span class="stringliteral">    $unknown04       = 0xffff-$index;</span>
<a name="l01098"></a>01098 <span class="stringliteral">    $unknown05       = 0x0000;</span>
<a name="l01099"></a>01099 <span class="stringliteral">    $unknown06       = 0x0000;</span>
<a name="l01100"></a>01100 <span class="stringliteral">    $unknown07       = 0x1087;</span>
<a name="l01101"></a>01101 <span class="stringliteral">    $unknown08       = 0x8005;</span>
<a name="l01102"></a>01102 <span class="stringliteral"></span>
<a name="l01103"></a>01103 <span class="stringliteral">    $header             = pack(&quot;vv&quot;, $record, $length);</span>
<a name="l01104"></a>01104 <span class="stringliteral">    $data               = pack(&quot;v&quot;, $grbit);</span>
<a name="l01105"></a>01105 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $chKey);</span>
<a name="l01106"></a>01106 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cch);</span>
<a name="l01107"></a>01107 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $cce);</span>
<a name="l01108"></a>01108 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $ixals);</span>
<a name="l01109"></a>01109 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $itab);</span>
<a name="l01110"></a>01110 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchCustMenu);</span>
<a name="l01111"></a>01111 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchDescription);</span>
<a name="l01112"></a>01112 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchHelptopic);</span>
<a name="l01113"></a>01113 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchStatustext);</span>
<a name="l01114"></a>01114 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $rgch);</span>
<a name="l01115"></a>01115 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $unknown03);</span>
<a name="l01116"></a>01116 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown04);</span>
<a name="l01117"></a>01117 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown05);</span>
<a name="l01118"></a>01118 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown06);</span>
<a name="l01119"></a>01119 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown07);</span>
<a name="l01120"></a>01120 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown08);</span>
<a name="l01121"></a>01121 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $index);</span>
<a name="l01122"></a>01122 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $index);</span>
<a name="l01123"></a>01123 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $rowmin);</span>
<a name="l01124"></a>01124 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $rowmax);</span>
<a name="l01125"></a>01125 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $colmin);</span>
<a name="l01126"></a>01126 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $colmax);</span>
<a name="l01127"></a>01127 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l01128"></a>01128 <span class="stringliteral">  }</span>
<a name="l01129"></a>01129 <span class="stringliteral"></span>
<a name="l01130"></a>01130 <span class="stringliteral"></span>
<a name="l01144"></a>01144 <span class="stringliteral">  private function _writeNameLong($index, $type, $rowmin, $rowmax, $colmin, $colmax)</span>
<a name="l01145"></a>01145 <span class="stringliteral">  {</span>
<a name="l01146"></a>01146 <span class="stringliteral">    $record          = 0x0018;       // Record identifier</span>
<a name="l01147"></a>01147 <span class="stringliteral">    $length          = 0x003d;       // Number of bytes to follow</span>
<a name="l01148"></a>01148 <span class="stringliteral">    $grbit           = 0x0020;       // Option flags</span>
<a name="l01149"></a>01149 <span class="stringliteral">    $chKey           = 0x00;         // Keyboard shortcut</span>
<a name="l01150"></a>01150 <span class="stringliteral">    $cch             = 0x01;         // Length of text name</span>
<a name="l01151"></a>01151 <span class="stringliteral">    $cce             = 0x002e;       // Length of text definition</span>
<a name="l01152"></a>01152 <span class="stringliteral">    $ixals           = $index + 1;   // Sheet index</span>
<a name="l01153"></a>01153 <span class="stringliteral">    $itab            = $ixals;       // Equal to ixals</span>
<a name="l01154"></a>01154 <span class="stringliteral">    $cchCustMenu     = 0x00;         // Length of cust menu text</span>
<a name="l01155"></a>01155 <span class="stringliteral">    $cchDescription  = 0x00;         // Length of description text</span>
<a name="l01156"></a>01156 <span class="stringliteral">    $cchHelptopic    = 0x00;         // Length of help topic text</span>
<a name="l01157"></a>01157 <span class="stringliteral">    $cchStatustext   = 0x00;         // Length of status bar text</span>
<a name="l01158"></a>01158 <span class="stringliteral">    $rgch            = $type;        // Built-in name type</span>
<a name="l01159"></a>01159 <span class="stringliteral"></span>
<a name="l01160"></a>01160 <span class="stringliteral">    $unknown01       = 0x29;</span>
<a name="l01161"></a>01161 <span class="stringliteral">    $unknown02       = 0x002b;</span>
<a name="l01162"></a>01162 <span class="stringliteral">    $unknown03       = 0x3b;</span>
<a name="l01163"></a>01163 <span class="stringliteral">    $unknown04       = 0xffff-$index;</span>
<a name="l01164"></a>01164 <span class="stringliteral">    $unknown05       = 0x0000;</span>
<a name="l01165"></a>01165 <span class="stringliteral">    $unknown06       = 0x0000;</span>
<a name="l01166"></a>01166 <span class="stringliteral">    $unknown07       = 0x1087;</span>
<a name="l01167"></a>01167 <span class="stringliteral">    $unknown08       = 0x8008;</span>
<a name="l01168"></a>01168 <span class="stringliteral"></span>
<a name="l01169"></a>01169 <span class="stringliteral">    $header             = pack(&quot;vv&quot;,  $record, $length);</span>
<a name="l01170"></a>01170 <span class="stringliteral">    $data               = pack(&quot;v&quot;, $grbit);</span>
<a name="l01171"></a>01171 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $chKey);</span>
<a name="l01172"></a>01172 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cch);</span>
<a name="l01173"></a>01173 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $cce);</span>
<a name="l01174"></a>01174 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $ixals);</span>
<a name="l01175"></a>01175 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $itab);</span>
<a name="l01176"></a>01176 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchCustMenu);</span>
<a name="l01177"></a>01177 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchDescription);</span>
<a name="l01178"></a>01178 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchHelptopic);</span>
<a name="l01179"></a>01179 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $cchStatustext);</span>
<a name="l01180"></a>01180 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $rgch);</span>
<a name="l01181"></a>01181 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $unknown01);</span>
<a name="l01182"></a>01182 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown02);</span>
<a name="l01183"></a>01183 <span class="stringliteral">    // Column definition</span>
<a name="l01184"></a>01184 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $unknown03);</span>
<a name="l01185"></a>01185 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown04);</span>
<a name="l01186"></a>01186 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown05);</span>
<a name="l01187"></a>01187 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown06);</span>
<a name="l01188"></a>01188 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown07);</span>
<a name="l01189"></a>01189 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown08);</span>
<a name="l01190"></a>01190 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $index);</span>
<a name="l01191"></a>01191 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $index);</span>
<a name="l01192"></a>01192 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, 0x0000);</span>
<a name="l01193"></a>01193 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, 0x3fff);</span>
<a name="l01194"></a>01194 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $colmin);</span>
<a name="l01195"></a>01195 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $colmax);</span>
<a name="l01196"></a>01196 <span class="stringliteral">    // Row definition</span>
<a name="l01197"></a>01197 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, $unknown03);</span>
<a name="l01198"></a>01198 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown04);</span>
<a name="l01199"></a>01199 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown05);</span>
<a name="l01200"></a>01200 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown06);</span>
<a name="l01201"></a>01201 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown07);</span>
<a name="l01202"></a>01202 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $unknown08);</span>
<a name="l01203"></a>01203 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $index);</span>
<a name="l01204"></a>01204 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $index);</span>
<a name="l01205"></a>01205 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $rowmin);</span>
<a name="l01206"></a>01206 <span class="stringliteral">    $data              .= pack(&quot;v&quot;, $rowmax);</span>
<a name="l01207"></a>01207 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, 0x00);</span>
<a name="l01208"></a>01208 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, 0xff);</span>
<a name="l01209"></a>01209 <span class="stringliteral">    // End of data</span>
<a name="l01210"></a>01210 <span class="stringliteral">    $data              .= pack(&quot;C&quot;, 0x10);</span>
<a name="l01211"></a>01211 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l01212"></a>01212 <span class="stringliteral">  }</span>
<a name="l01213"></a>01213 <span class="stringliteral"></span>
<a name="l01219"></a>01219 <span class="stringliteral">  private function _writeCountry()</span>
<a name="l01220"></a>01220 <span class="stringliteral">  {</span>
<a name="l01221"></a>01221 <span class="stringliteral">    $record          = 0x008C;    // Record identifier</span>
<a name="l01222"></a>01222 <span class="stringliteral">    $length          = 4;         // Number of bytes to follow</span>
<a name="l01223"></a>01223 <span class="stringliteral"></span>
<a name="l01224"></a>01224 <span class="stringliteral">    $header = pack(&#39;</span>vv<span class="stringliteral">&#39;,  $record, $length);</span>
<a name="l01225"></a>01225 <span class="stringliteral">    /* using the same country code always for simplicity */</span>
<a name="l01226"></a>01226 <span class="stringliteral">    $data = pack(&#39;</span>vv<span class="stringliteral">&#39;, $this-&gt;_country_code, $this-&gt;_country_code);</span>
<a name="l01227"></a>01227 <span class="stringliteral">    //$this-&gt;_append($header . $data);</span>
<a name="l01228"></a>01228 <span class="stringliteral">    return $this-&gt;writeData($header . $data);</span>
<a name="l01229"></a>01229 <span class="stringliteral">  }</span>
<a name="l01230"></a>01230 <span class="stringliteral"></span>
<a name="l01236"></a>01236 <span class="stringliteral">  private function _writeRecalcId()</span>
<a name="l01237"></a>01237 <span class="stringliteral">  {</span>
<a name="l01238"></a>01238 <span class="stringliteral">    $record = 0x01C1;    // Record identifier</span>
<a name="l01239"></a>01239 <span class="stringliteral">    $length = 8;         // Number of bytes to follow</span>
<a name="l01240"></a>01240 <span class="stringliteral"></span>
<a name="l01241"></a>01241 <span class="stringliteral">    $header = pack(&#39;</span>vv<span class="stringliteral">&#39;,  $record, $length);</span>
<a name="l01242"></a>01242 <span class="stringliteral"></span>
<a name="l01243"></a>01243 <span class="stringliteral">    // by inspection of real Excel files, MS Office Excel 2007 writes this</span>
<a name="l01244"></a>01244 <span class="stringliteral">    $data = pack(&#39;</span>VV<span class="stringliteral">&#39;, 0x000001C1, 0x00001E667);</span>
<a name="l01245"></a>01245 <span class="stringliteral"></span>
<a name="l01246"></a>01246 <span class="stringliteral">    return $this-&gt;writeData($header . $data);</span>
<a name="l01247"></a>01247 <span class="stringliteral">  }</span>
<a name="l01248"></a>01248 <span class="stringliteral"></span>
<a name="l01252"></a>01252 <span class="stringliteral">  private function _writePalette()</span>
<a name="l01253"></a>01253 <span class="stringliteral">  {</span>
<a name="l01254"></a>01254 <span class="stringliteral">    $aref            = $this-&gt;_palette;</span>
<a name="l01255"></a>01255 <span class="stringliteral"></span>
<a name="l01256"></a>01256 <span class="stringliteral">    $record          = 0x0092;                 // Record identifier</span>
<a name="l01257"></a>01257 <span class="stringliteral">    $length          = 2 + 4 * count($aref);   // Number of bytes to follow</span>
<a name="l01258"></a>01258 <span class="stringliteral">    $ccv             =         count($aref);   // Number of RGB values to follow</span>
<a name="l01259"></a>01259 <span class="stringliteral">    $data = &#39;</span><span class="stringliteral">&#39;;                                // The RGB data</span>
<a name="l01260"></a>01260 <span class="stringliteral"></span>
<a name="l01261"></a>01261 <span class="stringliteral">    // Pack the RGB data</span>
<a name="l01262"></a>01262 <span class="stringliteral">    foreach ($aref as $color) {</span>
<a name="l01263"></a>01263 <span class="stringliteral">      foreach ($color as $byte) {</span>
<a name="l01264"></a>01264 <span class="stringliteral">        $data .= pack(&quot;C&quot;,$byte);</span>
<a name="l01265"></a>01265 <span class="stringliteral">      }</span>
<a name="l01266"></a>01266 <span class="stringliteral">    }</span>
<a name="l01267"></a>01267 <span class="stringliteral"></span>
<a name="l01268"></a>01268 <span class="stringliteral">    $header = pack(&quot;vvv&quot;,  $record, $length, $ccv);</span>
<a name="l01269"></a>01269 <span class="stringliteral">    $this-&gt;_append($header . $data);</span>
<a name="l01270"></a>01270 <span class="stringliteral">  }</span>
<a name="l01271"></a>01271 <span class="stringliteral"></span>
<a name="l01286"></a>01286 <span class="stringliteral">  private function _writeSharedStringsTable()</span>
<a name="l01287"></a>01287 <span class="stringliteral">  {</span>
<a name="l01288"></a>01288 <span class="stringliteral">    // maximum size of record data (excluding record header)</span>
<a name="l01289"></a>01289 <span class="stringliteral">    $continue_limit = 8224;</span>
<a name="l01290"></a>01290 <span class="stringliteral"></span>
<a name="l01291"></a>01291 <span class="stringliteral">    // initialize array of record data blocks</span>
<a name="l01292"></a>01292 <span class="stringliteral">    $recordDatas = array();</span>
<a name="l01293"></a>01293 <span class="stringliteral"></span>
<a name="l01294"></a>01294 <span class="stringliteral">    // start SST record data block with total number of strings, total number of unique strings</span>
<a name="l01295"></a>01295 <span class="stringliteral">    $recordData = pack(&quot;VV&quot;, $this-&gt;_str_total, $this-&gt;_str_unique);</span>
<a name="l01296"></a>01296 <span class="stringliteral"></span>
<a name="l01297"></a>01297 <span class="stringliteral">    // loop through all (unique) strings in shared strings table</span>
<a name="l01298"></a>01298 <span class="stringliteral">    foreach (array_keys($this-&gt;_str_table) as $string) {</span>
<a name="l01299"></a>01299 <span class="stringliteral"></span>
<a name="l01300"></a>01300 <span class="stringliteral">      // here $string is a BIFF8 encoded string</span>
<a name="l01301"></a>01301 <span class="stringliteral"></span>
<a name="l01302"></a>01302 <span class="stringliteral">      // length = character count</span>
<a name="l01303"></a>01303 <span class="stringliteral">      $headerinfo = unpack(&quot;vlength/Cencoding&quot;, $string);</span>
<a name="l01304"></a>01304 <span class="stringliteral"></span>
<a name="l01305"></a>01305 <span class="stringliteral">      // currently, this is always 1 = uncompressed</span>
<a name="l01306"></a>01306 <span class="stringliteral">      $encoding = $headerinfo[&quot;encoding&quot;];</span>
<a name="l01307"></a>01307 <span class="stringliteral"></span>
<a name="l01308"></a>01308 <span class="stringliteral">      // initialize finished writing current $string</span>
<a name="l01309"></a>01309 <span class="stringliteral">      $finished = false;</span>
<a name="l01310"></a>01310 <span class="stringliteral"></span>
<a name="l01311"></a>01311 <span class="stringliteral">      while ($finished === false) {</span>
<a name="l01312"></a>01312 <span class="stringliteral"></span>
<a name="l01313"></a>01313 <span class="stringliteral">        // normally, there will be only one cycle, but if string cannot immediately be written as is</span>
<a name="l01314"></a>01314 <span class="stringliteral">        // there will be need for more than one cylcle, if string longer than one record data block, there</span>
<a name="l01315"></a>01315 <span class="stringliteral">        // may be need for even more cycles</span>
<a name="l01316"></a>01316 <span class="stringliteral"></span>
<a name="l01317"></a>01317 <span class="stringliteral">        if (strlen($recordData) + strlen($string) &lt; $continue_limit) {</span>
<a name="l01318"></a>01318 <span class="stringliteral">          // then we can write the string (or remainder of string) without any problems</span>
<a name="l01319"></a>01319 <span class="stringliteral">          $recordData .= $string;</span>
<a name="l01320"></a>01320 <span class="stringliteral"></span>
<a name="l01321"></a>01321 <span class="stringliteral">          // we are finished writing this string</span>
<a name="l01322"></a>01322 <span class="stringliteral">          $finished = true;</span>
<a name="l01323"></a>01323 <span class="stringliteral"></span>
<a name="l01324"></a>01324 <span class="stringliteral">        } else if (strlen($recordData) + strlen($string) == $continue_limit) {</span>
<a name="l01325"></a>01325 <span class="stringliteral">          // then we can also write the string (or remainder of string)</span>
<a name="l01326"></a>01326 <span class="stringliteral">          $recordData .= $string;</span>
<a name="l01327"></a>01327 <span class="stringliteral"></span>
<a name="l01328"></a>01328 <span class="stringliteral">          // but we close the record data block, and initialize a new one</span>
<a name="l01329"></a>01329 <span class="stringliteral">          $recordDatas[] = $recordData;</span>
<a name="l01330"></a>01330 <span class="stringliteral">          $recordData = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01331"></a>01331 <span class="stringliteral"></span>
<a name="l01332"></a>01332 <span class="stringliteral">          // we are finished writing this string</span>
<a name="l01333"></a>01333 <span class="stringliteral">          $finished = true;</span>
<a name="l01334"></a>01334 <span class="stringliteral"></span>
<a name="l01335"></a>01335 <span class="stringliteral">        } else {</span>
<a name="l01336"></a>01336 <span class="stringliteral">          // special treatment writing the string (or remainder of the string)</span>
<a name="l01337"></a>01337 <span class="stringliteral">          // If the string is very long it may need to be written in more than one CONTINUE record.</span>
<a name="l01338"></a>01338 <span class="stringliteral"></span>
<a name="l01339"></a>01339 <span class="stringliteral">          // check how many bytes more there is room for in the current record</span>
<a name="l01340"></a>01340 <span class="stringliteral">          $space_remaining = $continue_limit - strlen($recordData);</span>
<a name="l01341"></a>01341 <span class="stringliteral"></span>
<a name="l01342"></a>01342 <span class="stringliteral">          // minimum space needed</span>
<a name="l01343"></a>01343 <span class="stringliteral">          // uncompressed: 2 byte string length length field + 1 byte option flags + 2 byte character</span>
<a name="l01344"></a>01344 <span class="stringliteral">          // compressed:   2 byte string length length field + 1 byte option flags + 1 byte character</span>
<a name="l01345"></a>01345 <span class="stringliteral">          $min_space_needed = ($encoding == 1) ? 5 : 4;</span>
<a name="l01346"></a>01346 <span class="stringliteral"></span>
<a name="l01347"></a>01347 <span class="stringliteral">          // We have two cases</span>
<a name="l01348"></a>01348 <span class="stringliteral">          // 1. space remaining is less than minimum space needed</span>
<a name="l01349"></a>01349 <span class="stringliteral">          //    here we must waste the space remaining and move to next record data block</span>
<a name="l01350"></a>01350 <span class="stringliteral">          // 2. space remaining is greater than or equal to minimum space needed</span>
<a name="l01351"></a>01351 <span class="stringliteral">          //    here we write as much as we can in the current block, then move to next record data block</span>
<a name="l01352"></a>01352 <span class="stringliteral"></span>
<a name="l01353"></a>01353 <span class="stringliteral">          // 1. space remaining is less than minimum space needed</span>
<a name="l01354"></a>01354 <span class="stringliteral">          if ($space_remaining &lt; $min_space_needed) {</span>
<a name="l01355"></a>01355 <span class="stringliteral">            // we close the block, store the block data</span>
<a name="l01356"></a>01356 <span class="stringliteral">            $recordDatas[] = $recordData;</span>
<a name="l01357"></a>01357 <span class="stringliteral"></span>
<a name="l01358"></a>01358 <span class="stringliteral">            // and start new record data block where we start writing the string</span>
<a name="l01359"></a>01359 <span class="stringliteral">            $recordData = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01360"></a>01360 <span class="stringliteral"></span>
<a name="l01361"></a>01361 <span class="stringliteral">          // 2. space remaining is greater than or equal to minimum space needed</span>
<a name="l01362"></a>01362 <span class="stringliteral">          } else {</span>
<a name="l01363"></a>01363 <span class="stringliteral">            // initialize effective remaining space, for Unicode strings this may need to be reduced by 1, see below</span>
<a name="l01364"></a>01364 <span class="stringliteral">            $effective_space_remaining = $space_remaining;</span>
<a name="l01365"></a>01365 <span class="stringliteral"></span>
<a name="l01366"></a>01366 <span class="stringliteral">            // for uncompressed strings, sometimes effective space remaining is reduced by 1</span>
<a name="l01367"></a>01367 <span class="stringliteral">            if ( $encoding == 1 &amp;&amp; (strlen($string) - $space_remaining) % 2 == 1 ) {</span>
<a name="l01368"></a>01368 <span class="stringliteral">              --$effective_space_remaining;</span>
<a name="l01369"></a>01369 <span class="stringliteral">            }</span>
<a name="l01370"></a>01370 <span class="stringliteral"></span>
<a name="l01371"></a>01371 <span class="stringliteral">            // one block fininshed, store the block data</span>
<a name="l01372"></a>01372 <span class="stringliteral">            $recordData .= substr($string, 0, $effective_space_remaining);</span>
<a name="l01373"></a>01373 <span class="stringliteral"></span>
<a name="l01374"></a>01374 <span class="stringliteral">            $string = substr($string, $effective_space_remaining); // for next cycle in while loop</span>
<a name="l01375"></a>01375 <span class="stringliteral">            $recordDatas[] = $recordData;</span>
<a name="l01376"></a>01376 <span class="stringliteral"></span>
<a name="l01377"></a>01377 <span class="stringliteral">            // start new record data block with the repeated option flags</span>
<a name="l01378"></a>01378 <span class="stringliteral">            $recordData = pack(&#39;</span>C<span class="stringliteral">&#39;, $encoding);</span>
<a name="l01379"></a>01379 <span class="stringliteral">          }</span>
<a name="l01380"></a>01380 <span class="stringliteral">        }</span>
<a name="l01381"></a>01381 <span class="stringliteral">      }</span>
<a name="l01382"></a>01382 <span class="stringliteral">    }</span>
<a name="l01383"></a>01383 <span class="stringliteral"></span>
<a name="l01384"></a>01384 <span class="stringliteral">    // Store the last record data block unless it is empty</span>
<a name="l01385"></a>01385 <span class="stringliteral">    // if there was no need for any continue records, this will be the for SST record data block itself</span>
<a name="l01386"></a>01386 <span class="stringliteral">    if (strlen($recordData) &gt; 0) {</span>
<a name="l01387"></a>01387 <span class="stringliteral">      $recordDatas[] = $recordData;</span>
<a name="l01388"></a>01388 <span class="stringliteral">    }</span>
<a name="l01389"></a>01389 <span class="stringliteral"></span>
<a name="l01390"></a>01390 <span class="stringliteral">    // combine into one chunk with all the blocks SST, CONTINUE,...</span>
<a name="l01391"></a>01391 <span class="stringliteral">    $chunk = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01392"></a>01392 <span class="stringliteral">    foreach ($recordDatas as $i =&gt; $recordData) {</span>
<a name="l01393"></a>01393 <span class="stringliteral">      // first block should have the SST record header, remaing should have CONTINUE header</span>
<a name="l01394"></a>01394 <span class="stringliteral">      $record = ($i == 0) ? 0x00FC : 0x003C;</span>
<a name="l01395"></a>01395 <span class="stringliteral"></span>
<a name="l01396"></a>01396 <span class="stringliteral">      $header = pack(&quot;vv&quot;, $record, strlen($recordData));</span>
<a name="l01397"></a>01397 <span class="stringliteral">      $data = $header . $recordData;</span>
<a name="l01398"></a>01398 <span class="stringliteral"></span>
<a name="l01399"></a>01399 <span class="stringliteral">      $chunk .= $this-&gt;writeData($data);</span>
<a name="l01400"></a>01400 <span class="stringliteral">    }</span>
<a name="l01401"></a>01401 <span class="stringliteral"></span>
<a name="l01402"></a>01402 <span class="stringliteral">    return $chunk;</span>
<a name="l01403"></a>01403 <span class="stringliteral">  }</span>
<a name="l01404"></a>01404 <span class="stringliteral"></span>
<a name="l01408"></a>01408 <span class="stringliteral">  private function _writeMsoDrawingGroup()</span>
<a name="l01409"></a>01409 <span class="stringliteral">  {</span>
<a name="l01410"></a>01410 <span class="stringliteral">    // write the Escher stream if necessary</span>
<a name="l01411"></a>01411 <span class="stringliteral">    if (isset($this-&gt;_escher)) {</span>
<a name="l01412"></a>01412 <span class="stringliteral">      $writer = new PHPExcel_Writer_Excel5_Escher($this-&gt;_escher);</span>
<a name="l01413"></a>01413 <span class="stringliteral">      $data = $writer-&gt;close();</span>
<a name="l01414"></a>01414 <span class="stringliteral"></span>
<a name="l01415"></a>01415 <span class="stringliteral">      $record = 0x00EB;</span>
<a name="l01416"></a>01416 <span class="stringliteral">      $length = strlen($data);</span>
<a name="l01417"></a>01417 <span class="stringliteral">      $header = pack(&quot;vv&quot;,  $record, $length);</span>
<a name="l01418"></a>01418 <span class="stringliteral"></span>
<a name="l01419"></a>01419 <span class="stringliteral">      return $this-&gt;writeData($header . $data);</span>
<a name="l01420"></a>01420 <span class="stringliteral"></span>
<a name="l01421"></a>01421 <span class="stringliteral">    } else {</span>
<a name="l01422"></a>01422 <span class="stringliteral">      return &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01423"></a>01423 <span class="stringliteral">    }</span>
<a name="l01424"></a>01424 <span class="stringliteral">  }</span>
<a name="l01425"></a>01425 <span class="stringliteral"></span>
<a name="l01431"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a745b1f1e057ec827c11f73c66f67c50b">01431</a> <span class="stringliteral">  public function getEscher()</span>
<a name="l01432"></a>01432 <span class="stringliteral">  {</span>
<a name="l01433"></a>01433 <span class="stringliteral">    return $this-&gt;_escher;</span>
<a name="l01434"></a>01434 <span class="stringliteral">  }</span>
<a name="l01435"></a>01435 <span class="stringliteral"></span>
<a name="l01441"></a><a class="code" href="classPHPExcel__Writer__Excel5__Workbook.html#a0e955daa84fe69a04c5b79beba893487">01441</a> <span class="stringliteral">  public function setEscher(PHPExcel_Shared_Escher $pValue = null)</span>
<a name="l01442"></a>01442 <span class="stringliteral">  {</span>
<a name="l01443"></a>01443 <span class="stringliteral">    $this-&gt;_escher = $pValue;</span>
<a name="l01444"></a>01444 <span class="stringliteral">  }</span>
<a name="l01445"></a>01445 <span class="stringliteral"></span>
<a name="l01446"></a>01446 <span class="stringliteral">}</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
