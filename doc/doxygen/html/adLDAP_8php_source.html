<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: web/wiki/inc/adLDAP.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>web/wiki/inc/adLDAP.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00040"></a>00040 define (<span class="stringliteral">&#39;ADLDAP_NORMAL_ACCOUNT&#39;</span>, 805306368);
<a name="l00041"></a>00041 define (<span class="stringliteral">&#39;ADLDAP_WORKSTATION_TRUST&#39;</span>, 805306369);
<a name="l00042"></a>00042 define (<span class="stringliteral">&#39;ADLDAP_INTERDOMAIN_TRUST&#39;</span>, 805306370);
<a name="l00043"></a>00043 define (<span class="stringliteral">&#39;ADLDAP_SECURITY_GLOBAL_GROUP&#39;</span>, 268435456);
<a name="l00044"></a>00044 define (<span class="stringliteral">&#39;ADLDAP_DISTRIBUTION_GROUP&#39;</span>, 268435457);
<a name="l00045"></a>00045 define (<span class="stringliteral">&#39;ADLDAP_SECURITY_LOCAL_GROUP&#39;</span>, 536870912);
<a name="l00046"></a>00046 define (<span class="stringliteral">&#39;ADLDAP_DISTRIBUTION_LOCAL_GROUP&#39;</span>, 536870913);
<a name="l00047"></a>00047 define (<span class="stringliteral">&#39;ADLDAP_FOLDER&#39;</span>, <span class="stringliteral">&#39;OU&#39;</span>);
<a name="l00048"></a>00048 define (<span class="stringliteral">&#39;ADLDAP_CONTAINER&#39;</span>, <span class="stringliteral">&#39;CN&#39;</span>);
<a name="l00049"></a>00049 
<a name="l00062"></a><a class="code" href="classadLDAP.html">00062</a> <span class="keyword">class </span><a class="code" href="classadLDAP.html" title="Main adLDAP class.">adLDAP</a> {
<a name="l00068"></a>00068     <span class="keyword">protected</span> $_account_suffix = <span class="stringliteral">&quot;@mydomain.local&quot;</span>;
<a name="l00069"></a>00069 
<a name="l00075"></a>00075     <span class="keyword">protected</span> $_base_dn = <span class="stringliteral">&quot;DC=mydomain,DC=local&quot;</span>;
<a name="l00076"></a>00076 
<a name="l00083"></a>00083     <span class="keyword">protected</span> $_domain_controllers = array (<span class="stringliteral">&quot;dc01.mydomain.local&quot;</span>);
<a name="l00084"></a>00084 
<a name="l00092"></a>00092     <span class="keyword">protected</span> $_ad_username=NULL;
<a name="l00093"></a>00093     <span class="keyword">protected</span> $_ad_password=NULL;
<a name="l00094"></a>00094 
<a name="l00103"></a>00103     <span class="keyword">protected</span> $_real_primarygroup=<span class="keyword">true</span>;
<a name="l00104"></a>00104 
<a name="l00111"></a>00111     <span class="keyword">protected</span> $_use_ssl=<span class="keyword">false</span>;
<a name="l00112"></a>00112 
<a name="l00119"></a>00119     <span class="keyword">protected</span> $_use_tls=<span class="keyword">false</span>;
<a name="l00120"></a>00120 
<a name="l00128"></a>00128     <span class="keyword">protected</span> $_recursive_groups=<span class="keyword">true</span>;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">// You should not need to edit anything below this line</span>
<a name="l00131"></a>00131     <span class="comment">//******************************************************************************************</span>
<a name="l00132"></a>00132 
<a name="l00139"></a>00139     <span class="keyword">protected</span> $_conn;
<a name="l00140"></a>00140     <span class="keyword">protected</span> $_bind;
<a name="l00141"></a>00141 
<a name="l00152"></a><a class="code" href="classadLDAP.html#ab5fdf64b176a0df4c31d0930c06a96bd">00152</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ab5fdf64b176a0df4c31d0930c06a96bd" title="Getters and Setters.">set_account_suffix</a>($_account_suffix)
<a name="l00153"></a>00153     {
<a name="l00154"></a>00154           $this-&gt;_account_suffix = $_account_suffix;
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156 
<a name="l00162"></a><a class="code" href="classadLDAP.html#ac525da2561cacdaffcaaaa6b7f222fe9">00162</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ac525da2561cacdaffcaaaa6b7f222fe9" title="Get the account suffix.">get_account_suffix</a>()
<a name="l00163"></a>00163     {
<a name="l00164"></a>00164           <span class="keywordflow">return</span> $this-&gt;_account_suffix;
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166 
<a name="l00173"></a><a class="code" href="classadLDAP.html#aa9cba78975aef23304fac0877a391436">00173</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aa9cba78975aef23304fac0877a391436" title="Set the domain controllers array.">set_domain_controllers</a>(array $_domain_controllers)
<a name="l00174"></a>00174     {
<a name="l00175"></a>00175           $this-&gt;_domain_controllers = $_domain_controllers;
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 
<a name="l00183"></a><a class="code" href="classadLDAP.html#acfa5e71457fec0bdd802d92339ad08a6">00183</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#acfa5e71457fec0bdd802d92339ad08a6" title="Get the list of domain controllers.">get_domain_controllers</a>()
<a name="l00184"></a>00184     {
<a name="l00185"></a>00185           <span class="keywordflow">return</span> $this-&gt;_domain_controllers;
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187 
<a name="l00194"></a><a class="code" href="classadLDAP.html#a74b191e6314552eeaccc3bfb8ddce82a">00194</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a74b191e6314552eeaccc3bfb8ddce82a" title="Set the username of an account with higher priviledges.">set_ad_username</a>($_ad_username)
<a name="l00195"></a>00195     {
<a name="l00196"></a>00196           $this-&gt;_ad_username = $_ad_username;
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198 
<a name="l00204"></a><a class="code" href="classadLDAP.html#aa08f88ff2a42284ed04006bb2d4846a7">00204</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aa08f88ff2a42284ed04006bb2d4846a7" title="Get the username of the account with higher priviledges.">get_ad_username</a>()
<a name="l00205"></a>00205     {
<a name="l00206"></a>00206           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;For security reasons you cannot access the domain administrator account details&#39;</span>);
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00215"></a><a class="code" href="classadLDAP.html#a3e5d5ebceb7fd5f7fa094722e9434b75">00215</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a3e5d5ebceb7fd5f7fa094722e9434b75" title="Set the password of an account with higher priviledges.">set_ad_password</a>($_ad_password)
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217           $this-&gt;_ad_password = $_ad_password;
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 
<a name="l00225"></a><a class="code" href="classadLDAP.html#afbecb2c733ee66cad019d3c12b7b146d">00225</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#afbecb2c733ee66cad019d3c12b7b146d" title="Get the password of the account with higher priviledges.">get_ad_password</a>()
<a name="l00226"></a>00226     {
<a name="l00227"></a>00227           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;For security reasons you cannot access the domain administrator account details&#39;</span>);
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229 
<a name="l00236"></a><a class="code" href="classadLDAP.html#a4671c0b2b5ade504026387467e320693">00236</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a4671c0b2b5ade504026387467e320693" title="Set whether to detect the true primary group.">set_real_primarygroup</a>($_real_primarygroup)
<a name="l00237"></a>00237     {
<a name="l00238"></a>00238           $this-&gt;_real_primarygroup = $_real_primarygroup;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240 
<a name="l00246"></a><a class="code" href="classadLDAP.html#a935e33a457484a3065929ddcd4b904d0">00246</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a935e33a457484a3065929ddcd4b904d0" title="Get the real primary group setting.">get_real_primarygroup</a>()
<a name="l00247"></a>00247     {
<a name="l00248"></a>00248           <span class="keywordflow">return</span> $this-&gt;_real_primarygroup;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 
<a name="l00257"></a><a class="code" href="classadLDAP.html#ae2360ab49ba4a07c6f9d98869c3d96fe">00257</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ae2360ab49ba4a07c6f9d98869c3d96fe" title="Set whether to use SSL.">set_use_ssl</a>($_use_ssl)
<a name="l00258"></a>00258     {
<a name="l00259"></a>00259           $this-&gt;_use_ssl = $_use_ssl;
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261 
<a name="l00267"></a><a class="code" href="classadLDAP.html#a47953ff07f335273d6866f93caf71373">00267</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a47953ff07f335273d6866f93caf71373" title="Get the SSL setting.">get_use_ssl</a>()
<a name="l00268"></a>00268     {
<a name="l00269"></a>00269           <span class="keywordflow">return</span> $this-&gt;_use_ssl;
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00278"></a><a class="code" href="classadLDAP.html#a78254cd670f05e8dee61ea78bf0584f5">00278</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a78254cd670f05e8dee61ea78bf0584f5" title="Set whether to use TLS.">set_use_tls</a>($_use_tls)
<a name="l00279"></a>00279     {
<a name="l00280"></a>00280           $this-&gt;_use_tls = $_use_tls;
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282 
<a name="l00288"></a><a class="code" href="classadLDAP.html#a824e225d7985a88d91cf6ada18ebe02b">00288</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a824e225d7985a88d91cf6ada18ebe02b" title="Get the TLS setting.">get_use_tls</a>()
<a name="l00289"></a>00289     {
<a name="l00290"></a>00290           <span class="keywordflow">return</span> $this-&gt;_use_tls;
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292 
<a name="l00299"></a><a class="code" href="classadLDAP.html#a6eb1ac17cea4e4e20a42f2f28932d80b">00299</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a6eb1ac17cea4e4e20a42f2f28932d80b" title="Set whether to lookup recursive groups.">set_recursive_groups</a>($_recursive_groups)
<a name="l00300"></a>00300     {
<a name="l00301"></a>00301           $this-&gt;_recursive_groups = $_recursive_groups;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303 
<a name="l00309"></a><a class="code" href="classadLDAP.html#a001c80441bece64824434e96f8793c86">00309</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a001c80441bece64824434e96f8793c86" title="Get the recursive groups setting.">get_recursive_groups</a>()
<a name="l00310"></a>00310     {
<a name="l00311"></a>00311           <span class="keywordflow">return</span> $this-&gt;_recursive_groups;
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313 
<a name="l00323"></a><a class="code" href="classadLDAP.html#a244f805adbd82d08209f92cb91c14416">00323</a>     function <a class="code" href="classadLDAP.html#a244f805adbd82d08209f92cb91c14416" title="Default Constructor.">__construct</a>($options=array()){
<a name="l00324"></a>00324         <span class="comment">// You can specifically overide any of the default configuration options setup above</span>
<a name="l00325"></a>00325         <span class="keywordflow">if</span> (count($options)&gt;0){
<a name="l00326"></a>00326             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;account_suffix&quot;</span>,$options)){ $this-&gt;_account_suffix=$options[<span class="stringliteral">&quot;account_suffix&quot;</span>]; }
<a name="l00327"></a>00327             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;base_dn&quot;</span>,$options)){ $this-&gt;_base_dn=$options[<span class="stringliteral">&quot;base_dn&quot;</span>]; }
<a name="l00328"></a>00328             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;domain_controllers&quot;</span>,$options)){ $this-&gt;_domain_controllers=$options[<span class="stringliteral">&quot;domain_controllers&quot;</span>]; }
<a name="l00329"></a>00329             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;ad_username&quot;</span>,$options)){ $this-&gt;_ad_username=$options[<span class="stringliteral">&quot;ad_username&quot;</span>]; }
<a name="l00330"></a>00330             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;ad_password&quot;</span>,$options)){ $this-&gt;_ad_password=$options[<span class="stringliteral">&quot;ad_password&quot;</span>]; }
<a name="l00331"></a>00331             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;real_primarygroup&quot;</span>,$options)){ $this-&gt;_real_primarygroup=$options[<span class="stringliteral">&quot;real_primarygroup&quot;</span>]; }
<a name="l00332"></a>00332             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;use_ssl&quot;</span>,$options)){ $this-&gt;_use_ssl=$options[<span class="stringliteral">&quot;use_ssl&quot;</span>]; }
<a name="l00333"></a>00333             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;use_tls&quot;</span>,$options)){ $this-&gt;_use_tls=$options[<span class="stringliteral">&quot;use_tls&quot;</span>]; }
<a name="l00334"></a>00334             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;recursive_groups&quot;</span>,$options)){ $this-&gt;_recursive_groups=$options[<span class="stringliteral">&quot;recursive_groups&quot;</span>]; }
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classadLDAP.html#a95d5149b1ad5bc848445f1049a252d41" title="Detect LDAP support in php.">ldap_supported</a>() === <span class="keyword">false</span>) {
<a name="l00338"></a>00338             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;No LDAP support for PHP.  See: http://www.php.net/ldap&#39;</span>);
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classadLDAP.html#a1ffaefb817da085dd9493995467d16ca" title="Connects and Binds to the Domain Controller.">connect</a>();
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 
<a name="l00351"></a><a class="code" href="classadLDAP.html#ae41e39454a2de7bed7718b168b5f6b95">00351</a>     function <a class="code" href="classadLDAP.html#ae41e39454a2de7bed7718b168b5f6b95" title="Default Destructor.">__destruct</a>(){ $this-&gt;<a class="code" href="classadLDAP.html#aae73ebd892e78c631a1cecffda4c3b21" title="Closes the LDAP connection.">close</a>(); }
<a name="l00352"></a>00352 
<a name="l00358"></a><a class="code" href="classadLDAP.html#a1ffaefb817da085dd9493995467d16ca">00358</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a1ffaefb817da085dd9493995467d16ca" title="Connects and Binds to the Domain Controller.">connect</a>() {
<a name="l00359"></a>00359         <span class="comment">// Connect to the AD/LDAP server as the username/password</span>
<a name="l00360"></a>00360         $dc=$this-&gt;<a class="code" href="classadLDAP.html#a6a047c7553dc601d222ebd520d207449" title="Select a random domain controller from your domain controller array.">random_controller</a>();
<a name="l00361"></a>00361         <span class="keywordflow">if</span> ($this-&gt;_use_ssl){
<a name="l00362"></a>00362             $this-&gt;_conn = ldap_connect(<span class="stringliteral">&quot;ldaps://&quot;</span>.$dc, 636);
<a name="l00363"></a>00363         } <span class="keywordflow">else</span> {
<a name="l00364"></a>00364             $this-&gt;_conn = ldap_connect($dc);
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         <span class="comment">// Set some ldap options for talking to AD</span>
<a name="l00368"></a>00368         ldap_set_option($this-&gt;_conn, LDAP_OPT_PROTOCOL_VERSION, 3);
<a name="l00369"></a>00369         ldap_set_option($this-&gt;_conn, LDAP_OPT_REFERRALS, 0);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="keywordflow">if</span> ($this-&gt;_use_tls) {
<a name="l00372"></a>00372             ldap_start_tls($this-&gt;_conn);
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="comment">// Bind as a domain admin if they&#39;ve set it up</span>
<a name="l00376"></a>00376         <span class="keywordflow">if</span> ($this-&gt;_ad_username!=NULL &amp;&amp; $this-&gt;_ad_password!=NULL){
<a name="l00377"></a>00377             $this-&gt;_bind = @ldap_bind($this-&gt;_conn,$this-&gt;_ad_username.$this-&gt;_account_suffix,$this-&gt;_ad_password);
<a name="l00378"></a>00378             <span class="keywordflow">if</span> (!$this-&gt;_bind){
<a name="l00379"></a>00379                 <span class="keywordflow">if</span> ($this-&gt;_use_ssl &amp;&amp; !$this-&gt;_use_tls){
<a name="l00380"></a>00380                     <span class="comment">// If you have problems troubleshooting, remove the @ character from the ldap_bind command above to get the actual error message</span>
<a name="l00381"></a>00381                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;Bind to Active Directory failed. Either the LDAPs connection failed or the login credentials are incorrect. AD said: &#39;</span> . $this-&gt;<a class="code" href="classadLDAP.html#a6cc8d6aab2845757c448a0c8adb1298e" title="Get last error from Active Directory.">get_last_error</a>());
<a name="l00382"></a>00382                 } <span class="keywordflow">else</span> {
<a name="l00383"></a>00383                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;Bind to Active Directory failed. Check the login credentials and/or server details. AD said: &#39;</span> . $this-&gt;<a class="code" href="classadLDAP.html#a6cc8d6aab2845757c448a0c8adb1298e" title="Get last error from Active Directory.">get_last_error</a>());
<a name="l00384"></a>00384                 }
<a name="l00385"></a>00385             }
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="keywordflow">if</span> ($this-&gt;_base_dn == NULL) {
<a name="l00389"></a>00389             $this-&gt;_base_dn = $this-&gt;<a class="code" href="classadLDAP.html#a295472794438dc1e15f5b833dbece574" title="Find the Base DN of your domain controller.">find_base_dn</a>();
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 
<a name="l00400"></a><a class="code" href="classadLDAP.html#aae73ebd892e78c631a1cecffda4c3b21">00400</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aae73ebd892e78c631a1cecffda4c3b21" title="Closes the LDAP connection.">close</a>() {
<a name="l00401"></a>00401         ldap_close ($this-&gt;_conn);
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00412"></a><a class="code" href="classadLDAP.html#a4b0d1ac5cadeffc9b03277fc2ccf3e4e">00412</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a4b0d1ac5cadeffc9b03277fc2ccf3e4e" title="Validate a user&amp;#39;s login credentials.">authenticate</a>($username, $password, $prevent_rebind = <span class="keyword">false</span>) {
<a name="l00413"></a>00413         <span class="comment">// Prevent null binding</span>
<a name="l00414"></a>00414         <span class="keywordflow">if</span> ($username === NULL || $password === NULL) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00415"></a>00415         <span class="keywordflow">if</span> (empty($username) || empty($password)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <span class="comment">// Bind as the user</span>
<a name="l00418"></a>00418         $ret = <span class="keyword">true</span>;
<a name="l00419"></a>00419         $this-&gt;_bind = @ldap_bind($this-&gt;_conn, $username . $this-&gt;_account_suffix, $password);
<a name="l00420"></a>00420         <span class="keywordflow">if</span> (!$this-&gt;_bind){ $ret = <span class="keyword">false</span>; }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422         <span class="comment">// Cnce we&#39;ve checked their details, kick back into admin mode if we have it</span>
<a name="l00423"></a>00423         <span class="keywordflow">if</span> ($this-&gt;_ad_username !== NULL &amp;&amp; !$prevent_rebind) {
<a name="l00424"></a>00424             $this-&gt;_bind = @ldap_bind($this-&gt;_conn, $this-&gt;_ad_username . $this-&gt;_account_suffix , $this-&gt;_ad_password);
<a name="l00425"></a>00425             <span class="keywordflow">if</span> (!$this-&gt;_bind){
<a name="l00426"></a>00426                 <span class="comment">// This should never happen in theory</span>
<a name="l00427"></a>00427                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;Rebind to Active Directory failed. AD said: &#39;</span> . $this-&gt;<a class="code" href="classadLDAP.html#a6cc8d6aab2845757c448a0c8adb1298e" title="Get last error from Active Directory.">get_last_error</a>());
<a name="l00428"></a>00428             }
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         <span class="keywordflow">return</span> $ret;
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="comment">//*****************************************************************************************************************</span>
<a name="l00435"></a>00435     <span class="comment">// GROUP FUNCTIONS</span>
<a name="l00436"></a>00436 
<a name="l00444"></a><a class="code" href="classadLDAP.html#a4bf3a3f182cad0325b5d8dbecbbdaa17">00444</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a4bf3a3f182cad0325b5d8dbecbbdaa17" title="Add a group to a group.">group_add_group</a>($parent,$child){
<a name="l00445"></a>00445 
<a name="l00446"></a>00446         <span class="comment">// Find the parent group&#39;s dn</span>
<a name="l00447"></a>00447         $parent_group=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($parent,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00448"></a>00448         <span class="keywordflow">if</span> ($parent_group[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00449"></a>00449         $parent_dn=$parent_group[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00450"></a>00450 
<a name="l00451"></a>00451         <span class="comment">// Find the child group&#39;s dn</span>
<a name="l00452"></a>00452         $child_group=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($child,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00453"></a>00453         <span class="keywordflow">if</span> ($child_group[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00454"></a>00454         $child_dn=$child_group[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         $add=array();
<a name="l00457"></a>00457         $add[<span class="stringliteral">&quot;member&quot;</span>] = $child_dn;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         $result=@ldap_mod_add($this-&gt;_conn,$parent_dn,$add);
<a name="l00460"></a>00460         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00461"></a>00461         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00472"></a><a class="code" href="classadLDAP.html#af3af7a78dd3ba9e4ad899c36ab7c6296">00472</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#af3af7a78dd3ba9e4ad899c36ab7c6296" title="Add a user to a group.">group_add_user</a>($group,$user,$isGUID=<span class="keyword">false</span>){
<a name="l00473"></a>00473         <span class="comment">// Adding a user is a bit fiddly, we need to get the full DN of the user</span>
<a name="l00474"></a>00474         <span class="comment">// and add it using the full DN of the group</span>
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="comment">// Find the user&#39;s dn</span>
<a name="l00477"></a>00477         $user_dn=$this-&gt;<a class="code" href="classadLDAP.html#ab581027573b7b10cbc72fbff8a458196" title="Obtain the user&amp;#39;s distinguished name based on their userid.">user_dn</a>($user,$isGUID);
<a name="l00478"></a>00478         <span class="keywordflow">if</span> ($user_dn===<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480         <span class="comment">// Find the group&#39;s dn</span>
<a name="l00481"></a>00481         $group_info=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00482"></a>00482         <span class="keywordflow">if</span> ($group_info[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00483"></a>00483         $group_dn=$group_info[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         $add=array();
<a name="l00486"></a>00486         $add[<span class="stringliteral">&quot;member&quot;</span>] = $user_dn;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488         $result=@ldap_mod_add($this-&gt;_conn,$group_dn,$add);
<a name="l00489"></a>00489         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00490"></a>00490         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 
<a name="l00500"></a><a class="code" href="classadLDAP.html#af3b28c424c22ba397919beb9308036c6">00500</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#af3b28c424c22ba397919beb9308036c6" title="Add a contact to a group.">group_add_contact</a>($group,$contact_dn){
<a name="l00501"></a>00501         <span class="comment">// To add a contact we take the contact&#39;s DN</span>
<a name="l00502"></a>00502         <span class="comment">// and add it using the full DN of the group</span>
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         <span class="comment">// Find the group&#39;s dn</span>
<a name="l00505"></a>00505         $group_info=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00506"></a>00506         <span class="keywordflow">if</span> ($group_info[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00507"></a>00507         $group_dn=$group_info[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         $add=array();
<a name="l00510"></a>00510         $add[<span class="stringliteral">&quot;member&quot;</span>] = $contact_dn;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         $result=@ldap_mod_add($this-&gt;_conn,$group_dn,$add);
<a name="l00513"></a>00513         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00514"></a>00514         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516 
<a name="l00523"></a><a class="code" href="classadLDAP.html#ae2081bcec155db02a3698e1c993cb178">00523</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ae2081bcec155db02a3698e1c993cb178" title="Create a group.">group_create</a>($attributes){
<a name="l00524"></a>00524         <span class="keywordflow">if</span> (!is_array($attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Attributes must be an array&quot;</span>); }
<a name="l00525"></a>00525         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;group_name&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [group_name]&quot;</span>); }
<a name="l00526"></a>00526         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;container&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [container]&quot;</span>); }
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;description&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [description]&quot;</span>); }
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (!is_array($attributes[<span class="stringliteral">&quot;container&quot;</span>])){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Container attribute must be an array.&quot;</span>); }
<a name="l00529"></a>00529         $attributes[<span class="stringliteral">&quot;container&quot;</span>]=array_reverse($attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="comment">//$member_array = array();</span>
<a name="l00532"></a>00532         <span class="comment">//$member_array[0] = &quot;cn=user1,cn=Users,dc=yourdomain,dc=com&quot;;</span>
<a name="l00533"></a>00533         <span class="comment">//$member_array[1] = &quot;cn=administrator,cn=Users,dc=yourdomain,dc=com&quot;;</span>
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         $add=array();
<a name="l00536"></a>00536         $add[<span class="stringliteral">&quot;cn&quot;</span>] = $attributes[<span class="stringliteral">&quot;group_name&quot;</span>];
<a name="l00537"></a>00537         $add[<span class="stringliteral">&quot;samaccountname&quot;</span>] = $attributes[<span class="stringliteral">&quot;group_name&quot;</span>];
<a name="l00538"></a>00538         $add[<span class="stringliteral">&quot;objectClass&quot;</span>] = <span class="stringliteral">&quot;Group&quot;</span>;
<a name="l00539"></a>00539         $add[<span class="stringliteral">&quot;description&quot;</span>] = $attributes[<span class="stringliteral">&quot;description&quot;</span>];
<a name="l00540"></a>00540         <span class="comment">//$add[&quot;member&quot;] = $member_array; UNTESTED</span>
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         $container=<span class="stringliteral">&quot;OU=&quot;</span>.implode(<span class="stringliteral">&quot;,OU=&quot;</span>,$attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l00543"></a>00543         $result=ldap_add($this-&gt;_conn,<span class="stringliteral">&quot;CN=&quot;</span>.$add[<span class="stringliteral">&quot;cn&quot;</span>].<span class="stringliteral">&quot;, &quot;</span>.$container.<span class="stringliteral">&quot;,&quot;</span>.$this-&gt;_base_dn,$add);
<a name="l00544"></a>00544         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548 
<a name="l00556"></a><a class="code" href="classadLDAP.html#aad336cbcaf9d8ccdeca927c9f9030e3a">00556</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aad336cbcaf9d8ccdeca927c9f9030e3a" title="Remove a group from a group.">group_del_group</a>($parent,$child){
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         <span class="comment">// Find the parent dn</span>
<a name="l00559"></a>00559         $parent_group=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($parent,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00560"></a>00560         <span class="keywordflow">if</span> ($parent_group[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00561"></a>00561         $parent_dn=$parent_group[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         <span class="comment">// Find the child dn</span>
<a name="l00564"></a>00564         $child_group=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($child,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00565"></a>00565         <span class="keywordflow">if</span> ($child_group[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00566"></a>00566         $child_dn=$child_group[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         $del=array();
<a name="l00569"></a>00569         $del[<span class="stringliteral">&quot;member&quot;</span>] = $child_dn;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         $result=@ldap_mod_del($this-&gt;_conn,$parent_dn,$del);
<a name="l00572"></a>00572         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00573"></a>00573         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575 
<a name="l00584"></a><a class="code" href="classadLDAP.html#ad62052b1778fb5b9b3a7c008652502af">00584</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ad62052b1778fb5b9b3a7c008652502af" title="Remove a user from a group.">group_del_user</a>($group,$user,$isGUID=<span class="keyword">false</span>){
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="comment">// Find the parent dn</span>
<a name="l00587"></a>00587         $group_info=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00588"></a>00588         <span class="keywordflow">if</span> ($group_info[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00589"></a>00589         $group_dn=$group_info[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="comment">// Find the users dn</span>
<a name="l00592"></a>00592         $user_dn=$this-&gt;<a class="code" href="classadLDAP.html#ab581027573b7b10cbc72fbff8a458196" title="Obtain the user&amp;#39;s distinguished name based on their userid.">user_dn</a>($user,$isGUID);
<a name="l00593"></a>00593         <span class="keywordflow">if</span> ($user_dn===<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         $del=array();
<a name="l00596"></a>00596         $del[<span class="stringliteral">&quot;member&quot;</span>] = $user_dn;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         $result=@ldap_mod_del($this-&gt;_conn,$group_dn,$del);
<a name="l00599"></a>00599         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00600"></a>00600         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602 
<a name="l00610"></a><a class="code" href="classadLDAP.html#a99690500b50acc920017945a4f87d6cc">00610</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a99690500b50acc920017945a4f87d6cc" title="Remove a contact from a group.">group_del_contact</a>($group,$contact_dn){
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         <span class="comment">// Find the parent dn</span>
<a name="l00613"></a>00613         $group_info=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00614"></a>00614         <span class="keywordflow">if</span> ($group_info[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00615"></a>00615         $group_dn=$group_info[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         $del=array();
<a name="l00618"></a>00618         $del[<span class="stringliteral">&quot;member&quot;</span>] = $contact_dn;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         $result=@ldap_mod_del($this-&gt;_conn,$group_dn,$del);
<a name="l00621"></a>00621         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00622"></a>00622         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 
<a name="l00632"></a><a class="code" href="classadLDAP.html#ad6842df9e0a79c67c8a212067662f17b">00632</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ad6842df9e0a79c67c8a212067662f17b" title="Return a list of groups in a group.">groups_in_group</a>($group, $recursive = NULL){
<a name="l00633"></a>00633         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00634"></a>00634         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">// Use the default option if they haven&#39;t set it</span>
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <span class="comment">// Search the directory for the members of a group</span>
<a name="l00637"></a>00637         $info=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;member&quot;</span>,<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00638"></a>00638         $groups=$info[0][<span class="stringliteral">&quot;member&quot;</span>];
<a name="l00639"></a>00639         <span class="keywordflow">if</span> (!is_array($groups)) {
<a name="l00640"></a>00640             <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         $group_array=array();
<a name="l00644"></a>00644 
<a name="l00645"></a>00645         <span class="keywordflow">for</span> ($i=0; $i&lt;$groups[<span class="stringliteral">&quot;count&quot;</span>]; $i++){
<a name="l00646"></a>00646              $filter=<span class="stringliteral">&quot;(&amp;(objectCategory=group)(distinguishedName=&quot;</span>.$this-&gt;ldap_slashes($groups[$i]).<span class="stringliteral">&quot;))&quot;</span>;
<a name="l00647"></a>00647              $fields = array(<span class="stringliteral">&quot;samaccountname&quot;</span>, <span class="stringliteral">&quot;distinguishedname&quot;</span>, <span class="stringliteral">&quot;objectClass&quot;</span>);
<a name="l00648"></a>00648              $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00649"></a>00649              $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651              <span class="comment">// not a person, look for a group</span>
<a name="l00652"></a>00652              <span class="keywordflow">if</span> ($entries[<span class="stringliteral">&#39;count&#39;</span>] == 0 &amp;&amp; $recursive == <span class="keyword">true</span>) {
<a name="l00653"></a>00653                 $filter=<span class="stringliteral">&quot;(&amp;(objectCategory=group)(distinguishedName=&quot;</span>.$this-&gt;ldap_slashes($groups[$i]).<span class="stringliteral">&quot;))&quot;</span>;
<a name="l00654"></a>00654                 $fields = array(<span class="stringliteral">&quot;distinguishedname&quot;</span>);
<a name="l00655"></a>00655                 $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00656"></a>00656                 $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00657"></a>00657                 <span class="keywordflow">if</span> (!isset($entries[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0])) {
<a name="l00658"></a>00658                     <span class="keywordflow">continue</span>;
<a name="l00659"></a>00659                 }
<a name="l00660"></a>00660                 $sub_groups = $this-&gt;<a class="code" href="classadLDAP.html#ad6842df9e0a79c67c8a212067662f17b" title="Return a list of groups in a group.">groups_in_group</a>($entries[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0], $recursive);
<a name="l00661"></a>00661                 <span class="keywordflow">if</span> (is_array($sub_groups)) {
<a name="l00662"></a>00662                     $group_array = array_merge($group_array, $sub_groups);
<a name="l00663"></a>00663                     $group_array = array_unique($group_array);
<a name="l00664"></a>00664                 }
<a name="l00665"></a>00665                 <span class="keywordflow">continue</span>;
<a name="l00666"></a>00666              }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668              $group_array[] = $entries[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0];
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670         <span class="keywordflow">return</span> ($group_array);
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672 
<a name="l00680"></a><a class="code" href="classadLDAP.html#ac759ceab53c247bb40c9468b55bba7c4">00680</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ac759ceab53c247bb40c9468b55bba7c4" title="Return a list of members in a group.">group_members</a>($group, $recursive = NULL){
<a name="l00681"></a>00681         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00682"></a>00682         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">// Use the default option if they haven&#39;t set it</span>
<a name="l00683"></a>00683         <span class="comment">// Search the directory for the members of a group</span>
<a name="l00684"></a>00684         $info=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;member&quot;</span>,<span class="stringliteral">&quot;cn&quot;</span>));
<a name="l00685"></a>00685         $users=$info[0][<span class="stringliteral">&quot;member&quot;</span>];
<a name="l00686"></a>00686         <span class="keywordflow">if</span> (!is_array($users)) {
<a name="l00687"></a>00687             <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         $user_array=array();
<a name="l00691"></a>00691 
<a name="l00692"></a>00692         <span class="keywordflow">for</span> ($i=0; $i&lt;$users[<span class="stringliteral">&quot;count&quot;</span>]; $i++){
<a name="l00693"></a>00693              $filter=<span class="stringliteral">&quot;(&amp;(objectCategory=person)(distinguishedName=&quot;</span>.$this-&gt;ldap_slashes($users[$i]).<span class="stringliteral">&quot;))&quot;</span>;
<a name="l00694"></a>00694              $fields = array(<span class="stringliteral">&quot;samaccountname&quot;</span>, <span class="stringliteral">&quot;distinguishedname&quot;</span>, <span class="stringliteral">&quot;objectClass&quot;</span>);
<a name="l00695"></a>00695              $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00696"></a>00696              $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698              <span class="comment">// not a person, look for a group</span>
<a name="l00699"></a>00699              <span class="keywordflow">if</span> ($entries[<span class="stringliteral">&#39;count&#39;</span>] == 0 &amp;&amp; $recursive == <span class="keyword">true</span>) {
<a name="l00700"></a>00700                 $filter=<span class="stringliteral">&quot;(&amp;(objectCategory=group)(distinguishedName=&quot;</span>.$this-&gt;ldap_slashes($users[$i]).<span class="stringliteral">&quot;))&quot;</span>;
<a name="l00701"></a>00701                 $fields = array(<span class="stringliteral">&quot;samaccountname&quot;</span>);
<a name="l00702"></a>00702                 $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00703"></a>00703                 $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00704"></a>00704                 <span class="keywordflow">if</span> (!isset($entries[0][<span class="stringliteral">&#39;samaccountname&#39;</span>][0])) {
<a name="l00705"></a>00705                     <span class="keywordflow">continue</span>;
<a name="l00706"></a>00706                 }
<a name="l00707"></a>00707                 $sub_users = $this-&gt;<a class="code" href="classadLDAP.html#ac759ceab53c247bb40c9468b55bba7c4" title="Return a list of members in a group.">group_members</a>($entries[0][<span class="stringliteral">&#39;samaccountname&#39;</span>][0], $recursive);
<a name="l00708"></a>00708                 <span class="keywordflow">if</span> (is_array($sub_users)) {
<a name="l00709"></a>00709                     $user_array = array_merge($user_array, $sub_users);
<a name="l00710"></a>00710                     $user_array = array_unique($user_array);
<a name="l00711"></a>00711                 }
<a name="l00712"></a>00712                 <span class="keywordflow">continue</span>;
<a name="l00713"></a>00713              }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715              <span class="keywordflow">if</span> ($entries[0][<span class="stringliteral">&#39;samaccountname&#39;</span>][0] === NULL &amp;&amp; $entries[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0] !== NULL) {
<a name="l00716"></a>00716                  $user_array[] = $entries[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0];
<a name="l00717"></a>00717              }
<a name="l00718"></a>00718              elseif ($entries[0][<span class="stringliteral">&#39;samaccountname&#39;</span>][0] !== NULL) {
<a name="l00719"></a>00719                 $user_array[] = $entries[0][<span class="stringliteral">&#39;samaccountname&#39;</span>][0];
<a name="l00720"></a>00720              }
<a name="l00721"></a>00721         }
<a name="l00722"></a>00722         <span class="keywordflow">return</span> ($user_array);
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724 
<a name="l00733"></a><a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80">00733</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group_name,$fields=NULL){
<a name="l00734"></a>00734         <span class="keywordflow">if</span> ($group_name===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (stristr($group_name, <span class="charliteral">&#39;+&#39;</span>)) {
<a name="l00738"></a>00738             $group_name=stripslashes($group_name);
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         $filter=<span class="stringliteral">&quot;(&amp;(objectCategory=group)(name=&quot;</span>.$this-&gt;ldap_slashes($group_name).<span class="stringliteral">&quot;))&quot;</span>;
<a name="l00742"></a>00742         <span class="comment">//echo ($filter.&quot;!!!&lt;br&gt;&quot;);</span>
<a name="l00743"></a>00743         <span class="keywordflow">if</span> ($fields===NULL){ $fields=array(<span class="stringliteral">&quot;member&quot;</span>,<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;description&quot;</span>,<span class="stringliteral">&quot;distinguishedname&quot;</span>,<span class="stringliteral">&quot;objectcategory&quot;</span>,<span class="stringliteral">&quot;samaccountname&quot;</span>); }
<a name="l00744"></a>00744         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00745"></a>00745         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00746"></a>00746         <span class="comment">//print_r($entries);</span>
<a name="l00747"></a>00747         <span class="keywordflow">return</span> ($entries);
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00756"></a><a class="code" href="classadLDAP.html#a0b7f34f208a1774d3002d512b62450fc">00756</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a0b7f34f208a1774d3002d512b62450fc" title="Return a complete list of &amp;quot;groups in groups&amp;quot;.">recursive_groups</a>($group){
<a name="l00757"></a>00757         <span class="keywordflow">if</span> ($group===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         $ret_groups=array();
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         $groups=$this-&gt;<a class="code" href="classadLDAP.html#a92417f00ea8b3012b91a256342cc4e80" title="Group Information.">group_info</a>($group,array(<span class="stringliteral">&quot;memberof&quot;</span>));
<a name="l00762"></a>00762         <span class="keywordflow">if</span> (isset($groups[0][<span class="stringliteral">&quot;memberof&quot;</span>]) &amp;&amp; is_array($groups[0][<span class="stringliteral">&quot;memberof&quot;</span>])) {
<a name="l00763"></a>00763             $groups=$groups[0][<span class="stringliteral">&quot;memberof&quot;</span>];
<a name="l00764"></a>00764 
<a name="l00765"></a>00765             <span class="keywordflow">if</span> ($groups){
<a name="l00766"></a>00766                 $group_names=$this-&gt;<a class="code" href="classadLDAP.html#a131b2784f0f42c19a82bd8110bbcd52e" title="Take an LDAP query and return the nice names, without all the LDAP prefixes (eg.">nice_names</a>($groups);
<a name="l00767"></a>00767                 $ret_groups=array_merge($ret_groups,$group_names); <span class="comment">//final groups to return</span>
<a name="l00768"></a>00768 
<a name="l00769"></a>00769                 <span class="keywordflow">foreach</span> ($group_names as $id =&gt; $group_name){
<a name="l00770"></a>00770                     $child_groups=$this-&gt;<a class="code" href="classadLDAP.html#a0b7f34f208a1774d3002d512b62450fc" title="Return a complete list of &amp;quot;groups in groups&amp;quot;.">recursive_groups</a>($group_name);
<a name="l00771"></a>00771                     $ret_groups=array_merge($ret_groups,$child_groups);
<a name="l00772"></a>00772                 }
<a name="l00773"></a>00773             }
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776         <span class="keywordflow">return</span> ($ret_groups);
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778 
<a name="l00788"></a><a class="code" href="classadLDAP.html#a40dc7816ddf7b75c343930cb78c33aec">00788</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a40dc7816ddf7b75c343930cb78c33aec" title="Returns a complete list of the groups in AD based on a SAM Account Type.">search_groups</a>($samaccounttype = ADLDAP_SECURITY_GLOBAL_GROUP, $include_desc = <span class="keyword">false</span>, $search = <span class="stringliteral">&quot;*&quot;</span>, $sorted = <span class="keyword">true</span>) {
<a name="l00789"></a>00789         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         $filter = <span class="stringliteral">&#39;(&amp;(objectCategory=group)&#39;</span>;
<a name="l00792"></a>00792         <span class="keywordflow">if</span> ($samaccounttype !== null) {
<a name="l00793"></a>00793             $filter .= <span class="stringliteral">&#39;(samaccounttype=&#39;</span>. $samaccounttype .<span class="charliteral">&#39;)&#39;</span>;
<a name="l00794"></a>00794         }
<a name="l00795"></a>00795         $filter .= <span class="stringliteral">&#39;(cn=&#39;</span>.$search.<span class="stringliteral">&#39;))&#39;</span>;
<a name="l00796"></a>00796         <span class="comment">// Perform the search and grab all their details</span>
<a name="l00797"></a>00797         $fields=array(<span class="stringliteral">&quot;samaccountname&quot;</span>,<span class="stringliteral">&quot;description&quot;</span>);
<a name="l00798"></a>00798         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00799"></a>00799         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         $groups_array = array();
<a name="l00802"></a>00802         <span class="keywordflow">for</span> ($i=0; $i&lt;$entries[<span class="stringliteral">&quot;count&quot;</span>]; $i++){
<a name="l00803"></a>00803             <span class="keywordflow">if</span> ($include_desc &amp;&amp; strlen($entries[$i][<span class="stringliteral">&quot;description&quot;</span>][0]) &gt; 0 ){
<a name="l00804"></a>00804                 $groups_array[ $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0] ] = $entries[$i][<span class="stringliteral">&quot;description&quot;</span>][0];
<a name="l00805"></a>00805             } elseif ($include_desc){
<a name="l00806"></a>00806                 $groups_array[ $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0] ] = $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0];
<a name="l00807"></a>00807             } <span class="keywordflow">else</span> {
<a name="l00808"></a>00808                 array_push($groups_array, $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0]);
<a name="l00809"></a>00809             }
<a name="l00810"></a>00810         }
<a name="l00811"></a>00811         <span class="keywordflow">if</span>( $sorted ){ asort($groups_array); }
<a name="l00812"></a>00812         <span class="keywordflow">return</span> ($groups_array);
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814 
<a name="l00823"></a><a class="code" href="classadLDAP.html#aba0c39c5e430a064318edd7304be1750">00823</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aba0c39c5e430a064318edd7304be1750" title="Returns a complete list of all groups in AD.">all_groups</a>($include_desc = <span class="keyword">false</span>, $search = <span class="stringliteral">&quot;*&quot;</span>, $sorted = <span class="keyword">true</span>){
<a name="l00824"></a>00824         $groups_array = $this-&gt;<a class="code" href="classadLDAP.html#a40dc7816ddf7b75c343930cb78c33aec" title="Returns a complete list of the groups in AD based on a SAM Account Type.">search_groups</a>(null, $include_desc, $search, $sorted);
<a name="l00825"></a>00825         <span class="keywordflow">return</span> ($groups_array);
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827 
<a name="l00836"></a><a class="code" href="classadLDAP.html#a6fe38c5c13e11ff73091e932201cab7c">00836</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a6fe38c5c13e11ff73091e932201cab7c" title="Returns a complete list of security groups in AD.">all_security_groups</a>($include_desc = <span class="keyword">false</span>, $search = <span class="stringliteral">&quot;*&quot;</span>, $sorted = <span class="keyword">true</span>){
<a name="l00837"></a>00837         $groups_array = $this-&gt;<a class="code" href="classadLDAP.html#a40dc7816ddf7b75c343930cb78c33aec" title="Returns a complete list of the groups in AD based on a SAM Account Type.">search_groups</a>(ADLDAP_SECURITY_GLOBAL_GROUP, $include_desc, $search, $sorted);
<a name="l00838"></a>00838         <span class="keywordflow">return</span> ($groups_array);
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840 
<a name="l00849"></a><a class="code" href="classadLDAP.html#adf2de9a08dc455ceb3f0ead01ddb2bf7">00849</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#adf2de9a08dc455ceb3f0ead01ddb2bf7" title="Returns a complete list of distribution lists in AD.">all_distribution_groups</a>($include_desc = <span class="keyword">false</span>, $search = <span class="stringliteral">&quot;*&quot;</span>, $sorted = <span class="keyword">true</span>){
<a name="l00850"></a>00850         $groups_array = $this-&gt;<a class="code" href="classadLDAP.html#a40dc7816ddf7b75c343930cb78c33aec" title="Returns a complete list of the groups in AD based on a SAM Account Type.">search_groups</a>(ADLDAP_DISTRIBUTION_GROUP, $include_desc, $search, $sorted);
<a name="l00851"></a>00851         <span class="keywordflow">return</span> ($groups_array);
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854     <span class="comment">//*****************************************************************************************************************</span>
<a name="l00855"></a>00855     <span class="comment">// USER FUNCTIONS</span>
<a name="l00856"></a>00856 
<a name="l00865"></a><a class="code" href="classadLDAP.html#afe8959c2498985f43636d49cd4797dab">00865</a>         <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#afe8959c2498985f43636d49cd4797dab" title="Create a user.">user_create</a>($attributes){
<a name="l00866"></a>00866         <span class="comment">// Check for compulsory fields</span>
<a name="l00867"></a>00867         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;username&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l00868"></a>00868         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;firstname&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [firstname]&quot;</span>); }
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;surname&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [surname]&quot;</span>); }
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;email&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [email]&quot;</span>); }
<a name="l00871"></a>00871         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;container&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [container]&quot;</span>); }
<a name="l00872"></a>00872         <span class="keywordflow">if</span> (!is_array($attributes[<span class="stringliteral">&quot;container&quot;</span>])){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Container attribute must be an array.&quot;</span>); }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874         <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;password&quot;</span>,$attributes) &amp;&amp; (!$this-&gt;_use_ssl &amp;&amp; !$this-&gt;_use_tls)){
<a name="l00875"></a>00875             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;SSL must be configured on your webserver and enabled in the class to set passwords.&#39;</span>);
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;display_name&quot;</span>,$attributes)){ $attributes[<span class="stringliteral">&quot;display_name&quot;</span>]=$attributes[<span class="stringliteral">&quot;firstname&quot;</span>].<span class="stringliteral">&quot; &quot;</span>.$attributes[<span class="stringliteral">&quot;surname&quot;</span>]; }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         <span class="comment">// Translate the schema</span>
<a name="l00881"></a>00881         $add=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         <span class="comment">// Additional stuff only used for adding accounts</span>
<a name="l00884"></a>00884         $add[<span class="stringliteral">&quot;cn&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;display_name&quot;</span>];
<a name="l00885"></a>00885         $add[<span class="stringliteral">&quot;samaccountname&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;username&quot;</span>];
<a name="l00886"></a>00886         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][0]=<span class="stringliteral">&quot;top&quot;</span>;
<a name="l00887"></a>00887         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][1]=<span class="stringliteral">&quot;person&quot;</span>;
<a name="l00888"></a>00888         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][2]=<span class="stringliteral">&quot;organizationalPerson&quot;</span>;
<a name="l00889"></a>00889         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][3]=<span class="stringliteral">&quot;user&quot;</span>; <span class="comment">//person?</span>
<a name="l00890"></a>00890         <span class="comment">//$add[&quot;name&quot;][0]=$attributes[&quot;firstname&quot;].&quot; &quot;.$attributes[&quot;surname&quot;];</span>
<a name="l00891"></a>00891 
<a name="l00892"></a>00892         <span class="comment">// Set the account control attribute</span>
<a name="l00893"></a>00893         $control_options=array(<span class="stringliteral">&quot;NORMAL_ACCOUNT&quot;</span>);
<a name="l00894"></a>00894         <span class="keywordflow">if</span> (!$attributes[<span class="stringliteral">&quot;enabled&quot;</span>]){ $control_options[]=<span class="stringliteral">&quot;ACCOUNTDISABLE&quot;</span>; }
<a name="l00895"></a>00895         $add[<span class="stringliteral">&quot;userAccountControl&quot;</span>][0]=$this-&gt;<a class="code" href="classadLDAP.html#af8031d99c257e2a0563b8acf2761282b" title="Account control options.">account_control</a>($control_options);
<a name="l00896"></a>00896         <span class="comment">//echo (&quot;&lt;pre&gt;&quot;); print_r($add);</span>
<a name="l00897"></a>00897 
<a name="l00898"></a>00898         <span class="comment">// Determine the container</span>
<a name="l00899"></a>00899         $attributes[<span class="stringliteral">&quot;container&quot;</span>]=array_reverse($attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l00900"></a>00900         $container=<span class="stringliteral">&quot;OU=&quot;</span>.implode(<span class="stringliteral">&quot;,OU=&quot;</span>,$attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         <span class="comment">// Add the entry</span>
<a name="l00903"></a>00903         $result=@ldap_add($this-&gt;_conn, <span class="stringliteral">&quot;CN=&quot;</span>.$add[<span class="stringliteral">&quot;cn&quot;</span>][0].<span class="stringliteral">&quot;, &quot;</span>.$container.<span class="stringliteral">&quot;,&quot;</span>.$this-&gt;_base_dn, $add);
<a name="l00904"></a>00904         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908 
<a name="l00916"></a><a class="code" href="classadLDAP.html#a09615551045b1eaf91fcc8c43864579b">00916</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a09615551045b1eaf91fcc8c43864579b" title="Delete a user account.">user_delete</a>($username,$isGUID=<span class="keyword">false</span>) {
<a name="l00917"></a>00917         $userinfo = $this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username, array(<span class="stringliteral">&quot;*&quot;</span>),$isGUID);
<a name="l00918"></a>00918         $dn = $userinfo[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0];
<a name="l00919"></a>00919         $result=$this-&gt;<a class="code" href="classadLDAP.html#a3b937e0fc298242125f7743950bf7ecf" title="Delete a distinguished name from Active Directory You should never need to call this...">dn_delete</a>($dn);
<a name="l00920"></a>00920         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00921"></a>00921         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923 
<a name="l00932"></a><a class="code" href="classadLDAP.html#a4f9394d4e04a8881c5a501bab77bea51">00932</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a4f9394d4e04a8881c5a501bab77bea51" title="Groups the user is a member of.">user_groups</a>($username,$recursive=NULL,$isGUID=<span class="keyword">false</span>){
<a name="l00933"></a>00933         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00934"></a>00934         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">// Use the default option if they haven&#39;t set it</span>
<a name="l00935"></a>00935         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         <span class="comment">// Search the directory for their information</span>
<a name="l00938"></a>00938         $info=@$this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,array(<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;primarygroupid&quot;</span>),$isGUID);
<a name="l00939"></a>00939         $groups=$this-&gt;<a class="code" href="classadLDAP.html#a131b2784f0f42c19a82bd8110bbcd52e" title="Take an LDAP query and return the nice names, without all the LDAP prefixes (eg.">nice_names</a>($info[0][<span class="stringliteral">&quot;memberof&quot;</span>]); <span class="comment">// Presuming the entry returned is our guy (unique usernames)</span>
<a name="l00940"></a>00940 
<a name="l00941"></a>00941         <span class="keywordflow">if</span> ($recursive === <span class="keyword">true</span>){
<a name="l00942"></a>00942             <span class="keywordflow">foreach</span> ($groups as $id =&gt; $group_name){
<a name="l00943"></a>00943                 $extra_groups=$this-&gt;<a class="code" href="classadLDAP.html#a0b7f34f208a1774d3002d512b62450fc" title="Return a complete list of &amp;quot;groups in groups&amp;quot;.">recursive_groups</a>($group_name);
<a name="l00944"></a>00944                 $groups=array_merge($groups,$extra_groups);
<a name="l00945"></a>00945             }
<a name="l00946"></a>00946         }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948         <span class="keywordflow">return</span> ($groups);
<a name="l00949"></a>00949     }
<a name="l00950"></a>00950 
<a name="l00959"></a><a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c">00959</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,$fields=NULL,$isGUID=<span class="keyword">false</span>){
<a name="l00960"></a>00960         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963         <span class="keywordflow">if</span> ($isGUID === <span class="keyword">true</span>) {
<a name="l00964"></a>00964             $username = $this-&gt;<a class="code" href="classadLDAP.html#af47e9763c396a4724f7d01d5334d5c35" title="Converts a string GUID to a hexdecimal value so it can be queried.">strguid2hex</a>($username);
<a name="l00965"></a>00965             $filter=<span class="stringliteral">&quot;objectguid=&quot;</span>.$username;
<a name="l00966"></a>00966         }
<a name="l00967"></a>00967         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr($username, <span class="stringliteral">&quot;@&quot;</span>)) {
<a name="l00968"></a>00968              $filter=<span class="stringliteral">&quot;userPrincipalName=&quot;</span>.$username;
<a name="l00969"></a>00969         }
<a name="l00970"></a>00970         <span class="keywordflow">else</span> {
<a name="l00971"></a>00971              $filter=<span class="stringliteral">&quot;samaccountname=&quot;</span>.$username;
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973         $filter = <span class="stringliteral">&quot;(&amp;(objectCategory=person)({$filter}))&quot;</span>;
<a name="l00974"></a>00974         <span class="keywordflow">if</span> ($fields===NULL){ $fields=array(<span class="stringliteral">&quot;samaccountname&quot;</span>,<span class="stringliteral">&quot;mail&quot;</span>,<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;department&quot;</span>,<span class="stringliteral">&quot;displayname&quot;</span>,<span class="stringliteral">&quot;telephonenumber&quot;</span>,<span class="stringliteral">&quot;primarygroupid&quot;</span>,<span class="stringliteral">&quot;objectsid&quot;</span>); }
<a name="l00975"></a>00975         <span class="keywordflow">if</span> (!in_array(<span class="stringliteral">&quot;objectsid&quot;</span>,$fields)){
<a name="l00976"></a>00976             $fields[] = <span class="stringliteral">&quot;objectsid&quot;</span>;
<a name="l00977"></a>00977         }
<a name="l00978"></a>00978         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l00979"></a>00979         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <span class="keywordflow">if</span> (isset($entries[0])) {
<a name="l00982"></a>00982             <span class="keywordflow">if</span> ($entries[0][<span class="stringliteral">&#39;count&#39;</span>] &gt;= 1) {
<a name="l00983"></a>00983                 <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;memberof&quot;</span>, $fields)) {
<a name="l00984"></a>00984                     <span class="comment">// AD does not return the primary group in the ldap query, we may need to fudge it</span>
<a name="l00985"></a>00985                     <span class="keywordflow">if</span> ($this-&gt;_real_primarygroup &amp;&amp; isset($entries[0][<span class="stringliteral">&quot;primarygroupid&quot;</span>][0]) &amp;&amp; isset($entries[0][<span class="stringliteral">&quot;objectsid&quot;</span>][0])){
<a name="l00986"></a>00986                         <span class="comment">//$entries[0][&quot;memberof&quot;][]=$this-&gt;group_cn($entries[0][&quot;primarygroupid&quot;][0]);</span>
<a name="l00987"></a>00987                         $entries[0][<span class="stringliteral">&quot;memberof&quot;</span>][]=$this-&gt;<a class="code" href="classadLDAP.html#a463259d457310dc99dd2619098686643" title="Coping with AD not returning the primary group http://support.microsoft.com/?kbid=321360...">get_primary_group</a>($entries[0][<span class="stringliteral">&quot;primarygroupid&quot;</span>][0], $entries[0][<span class="stringliteral">&quot;objectsid&quot;</span>][0]);
<a name="l00988"></a>00988                     } <span class="keywordflow">else</span> {
<a name="l00989"></a>00989                         $entries[0][<span class="stringliteral">&quot;memberof&quot;</span>][]=<span class="stringliteral">&quot;CN=Domain Users,CN=Users,&quot;</span>.$this-&gt;_base_dn;
<a name="l00990"></a>00990                     }
<a name="l00991"></a>00991                     $entries[0][<span class="stringliteral">&quot;memberof&quot;</span>][<span class="stringliteral">&quot;count&quot;</span>]++;
<a name="l00992"></a>00992                 }
<a name="l00993"></a>00993             }
<a name="l00994"></a>00994             <span class="keywordflow">return</span> $entries;
<a name="l00995"></a>00995         }
<a name="l00996"></a>00996         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998 
<a name="l01008"></a><a class="code" href="classadLDAP.html#a82285772940062ea45678333f2d6057d">01008</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a82285772940062ea45678333f2d6057d" title="Determine if a user is in a specific group.">user_ingroup</a>($username,$group,$recursive=NULL,$isGUID=<span class="keyword">false</span>){
<a name="l01009"></a>01009         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01010"></a>01010         <span class="keywordflow">if</span> ($group===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01011"></a>01011         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01012"></a>01012         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">// Use the default option if they haven&#39;t set it</span>
<a name="l01013"></a>01013 
<a name="l01014"></a>01014         <span class="comment">// Get a list of the groups</span>
<a name="l01015"></a>01015         $groups=$this-&gt;<a class="code" href="classadLDAP.html#a4f9394d4e04a8881c5a501bab77bea51" title="Groups the user is a member of.">user_groups</a>($username,$recursive,$isGUID);
<a name="l01016"></a>01016 
<a name="l01017"></a>01017         <span class="comment">// Return true if the specified group is in the group list</span>
<a name="l01018"></a>01018         <span class="keywordflow">if</span> (in_array($group,$groups)){ <span class="keywordflow">return</span> (<span class="keyword">true</span>); }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020         <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l01021"></a>01021     }
<a name="l01022"></a>01022 
<a name="l01031"></a><a class="code" href="classadLDAP.html#a68b696223d38f408f5b71f60e731e960">01031</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a68b696223d38f408f5b71f60e731e960" title="Determine a user&amp;#39;s password expiry date.">user_password_expiry</a>($username,$isGUID=<span class="keyword">false</span>) {
<a name="l01032"></a>01032         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01033"></a>01033         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01034"></a>01034         <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;bcmod&#39;</span>)) { <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing function support [bcmod] http://www.php.net/manual/en/book.bc.php&quot;</span>); };
<a name="l01035"></a>01035 
<a name="l01036"></a>01036         $userinfo = $this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username, array(<span class="stringliteral">&quot;pwdlastset&quot;</span>, <span class="stringliteral">&quot;useraccountcontrol&quot;</span>), $isGUID);
<a name="l01037"></a>01037         $pwdlastset = $userinfo[0][<span class="stringliteral">&#39;pwdlastset&#39;</span>][0];
<a name="l01038"></a>01038         $status = array();
<a name="l01039"></a>01039 
<a name="l01040"></a>01040         <span class="keywordflow">if</span> ($userinfo[0][<span class="stringliteral">&#39;useraccountcontrol&#39;</span>][0] == <span class="stringliteral">&#39;66048&#39;</span>) {
<a name="l01041"></a>01041             <span class="comment">// Password does not expire</span>
<a name="l01042"></a>01042             <span class="keywordflow">return</span> <span class="stringliteral">&quot;Does not expire&quot;</span>;
<a name="l01043"></a>01043         }
<a name="l01044"></a>01044         <span class="keywordflow">if</span> ($pwdlastset === <span class="charliteral">&#39;0&#39;</span>) {
<a name="l01045"></a>01045             <span class="comment">// Password has already expired</span>
<a name="l01046"></a>01046             <span class="keywordflow">return</span> <span class="stringliteral">&quot;Password has expired&quot;</span>;
<a name="l01047"></a>01047         }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049          <span class="comment">// Password expiry in AD can be calculated from TWO values:</span>
<a name="l01050"></a>01050          <span class="comment">//   - User&#39;s own pwdLastSet attribute: stores the last time the password was changed</span>
<a name="l01051"></a>01051          <span class="comment">//   - Domain&#39;s maxPwdAge attribute: how long passwords last in the domain</span>
<a name="l01052"></a>01052          <span class="comment">//</span>
<a name="l01053"></a>01053          <span class="comment">// Although Microsoft chose to use a different base and unit for time measurements.</span>
<a name="l01054"></a>01054          <span class="comment">// This function will convert them to Unix timestamps</span>
<a name="l01055"></a>01055          $sr = ldap_read($this-&gt;_conn, $this-&gt;_base_dn, <span class="stringliteral">&#39;objectclass=*&#39;</span>, array(<span class="stringliteral">&#39;maxPwdAge&#39;</span>));
<a name="l01056"></a>01056          <span class="keywordflow">if</span> (!$sr) {
<a name="l01057"></a>01057              <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01058"></a>01058          }
<a name="l01059"></a>01059          $info = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01060"></a>01060          $maxpwdage = $info[0][<span class="stringliteral">&#39;maxpwdage&#39;</span>][0];
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 
<a name="l01063"></a>01063          <span class="comment">// See MSDN: http://msdn.microsoft.com/en-us/library/ms974598.aspx</span>
<a name="l01064"></a>01064          <span class="comment">//</span>
<a name="l01065"></a>01065          <span class="comment">// pwdLastSet contains the number of 100 nanosecond intervals since January 1, 1601 (UTC),</span>
<a name="l01066"></a>01066          <span class="comment">// stored in a 64 bit integer.</span>
<a name="l01067"></a>01067          <span class="comment">//</span>
<a name="l01068"></a>01068          <span class="comment">// The number of seconds between this date and Unix epoch is 11644473600.</span>
<a name="l01069"></a>01069          <span class="comment">//</span>
<a name="l01070"></a>01070          <span class="comment">// maxPwdAge is stored as a large integer that represents the number of 100 nanosecond</span>
<a name="l01071"></a>01071          <span class="comment">// intervals from the time the password was set before the password expires.</span>
<a name="l01072"></a>01072          <span class="comment">//</span>
<a name="l01073"></a>01073          <span class="comment">// We also need to scale this to seconds but also this value is a _negative_ quantity!</span>
<a name="l01074"></a>01074          <span class="comment">//</span>
<a name="l01075"></a>01075          <span class="comment">// If the low 32 bits of maxPwdAge are equal to 0 passwords do not expire</span>
<a name="l01076"></a>01076          <span class="comment">//</span>
<a name="l01077"></a>01077          <span class="comment">// Unfortunately the maths involved are too big for PHP integers, so I&#39;ve had to require</span>
<a name="l01078"></a>01078          <span class="comment">// BCMath functions to work with arbitrary precision numbers.</span>
<a name="l01079"></a>01079          <span class="keywordflow">if</span> (bcmod($maxpwdage, 4294967296) === <span class="charliteral">&#39;0&#39;</span>) {
<a name="l01080"></a>01080             <span class="keywordflow">return</span> <span class="stringliteral">&quot;Domain does not expire passwords&quot;</span>;
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083         <span class="comment">// Add maxpwdage and pwdlastset and we get password expiration time in Microsoft&#39;s</span>
<a name="l01084"></a>01084         <span class="comment">// time units.  Because maxpwd age is negative we need to subtract it.</span>
<a name="l01085"></a>01085         $pwdexpire = bcsub($pwdlastset, $maxpwdage);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087         <span class="comment">// Convert MS&#39;s time to Unix time</span>
<a name="l01088"></a>01088         $status[<span class="stringliteral">&#39;expiryts&#39;</span>] = bcsub(bcdiv($pwdexpire, <span class="stringliteral">&#39;10000000&#39;</span>), <span class="stringliteral">&#39;11644473600&#39;</span>);
<a name="l01089"></a>01089         $status[<span class="stringliteral">&#39;expiryformat&#39;</span>] = date(<span class="stringliteral">&#39;Y-m-d H:i:s&#39;</span>, bcsub(bcdiv($pwdexpire, <span class="stringliteral">&#39;10000000&#39;</span>), <span class="stringliteral">&#39;11644473600&#39;</span>));
<a name="l01090"></a>01090 
<a name="l01091"></a>01091         <span class="keywordflow">return</span> $status;
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093 
<a name="l01102"></a><a class="code" href="classadLDAP.html#ada629d8c7b16ece3a8444f9712cb94a6">01102</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ada629d8c7b16ece3a8444f9712cb94a6" title="Modify a user.">user_modify</a>($username,$attributes,$isGUID=<span class="keyword">false</span>){
<a name="l01103"></a>01103         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01104"></a>01104         <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;password&quot;</span>,$attributes) &amp;&amp; !$this-&gt;_use_ssl){
<a name="l01105"></a>01105             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;SSL must be configured on your webserver and enabled in the class to set passwords.&#39;</span>);
<a name="l01106"></a>01106         }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <span class="comment">// Find the dn of the user</span>
<a name="l01109"></a>01109         $user_dn=$this-&gt;<a class="code" href="classadLDAP.html#ab581027573b7b10cbc72fbff8a458196" title="Obtain the user&amp;#39;s distinguished name based on their userid.">user_dn</a>($username,$isGUID);
<a name="l01110"></a>01110         <span class="keywordflow">if</span> ($user_dn===<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         <span class="comment">// Translate the update to the LDAP schema</span>
<a name="l01113"></a>01113         $mod=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115         <span class="comment">// Check to see if this is an enabled status update</span>
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (!$mod &amp;&amp; !array_key_exists(<span class="stringliteral">&quot;enabled&quot;</span>, $attributes)){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118         <span class="comment">// Set the account control attribute (only if specified)</span>
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&quot;enabled&quot;</span>,$attributes)){
<a name="l01120"></a>01120             <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;enabled&quot;</span>]){ $control_options=array(<span class="stringliteral">&quot;NORMAL_ACCOUNT&quot;</span>); }
<a name="l01121"></a>01121             <span class="keywordflow">else</span> { $control_options=array(<span class="stringliteral">&quot;NORMAL_ACCOUNT&quot;</span>,<span class="stringliteral">&quot;ACCOUNTDISABLE&quot;</span>); }
<a name="l01122"></a>01122             $mod[<span class="stringliteral">&quot;userAccountControl&quot;</span>][0]=$this-&gt;<a class="code" href="classadLDAP.html#af8031d99c257e2a0563b8acf2761282b" title="Account control options.">account_control</a>($control_options);
<a name="l01123"></a>01123         }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125         <span class="comment">// Do the update</span>
<a name="l01126"></a>01126         $result=@ldap_modify($this-&gt;_conn,$user_dn,$mod);
<a name="l01127"></a>01127         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131 
<a name="l01139"></a><a class="code" href="classadLDAP.html#a28b2e92184634fc1adab142da8b9a80d">01139</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a28b2e92184634fc1adab142da8b9a80d" title="Disable a user account.">user_disable</a>($username,$isGUID=<span class="keyword">false</span>){
<a name="l01140"></a>01140         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01141"></a>01141         $attributes=array(<span class="stringliteral">&quot;enabled&quot;</span>=&gt;0);
<a name="l01142"></a>01142         $result = $this-&gt;<a class="code" href="classadLDAP.html#ada629d8c7b16ece3a8444f9712cb94a6" title="Modify a user.">user_modify</a>($username, $attributes, $isGUID);
<a name="l01143"></a>01143         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01146"></a>01146     }
<a name="l01147"></a>01147 
<a name="l01155"></a><a class="code" href="classadLDAP.html#af8785914c1cfed5132b03c3431535dfd">01155</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#af8785914c1cfed5132b03c3431535dfd" title="Enable a user account.">user_enable</a>($username,$isGUID=<span class="keyword">false</span>){
<a name="l01156"></a>01156         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01157"></a>01157         $attributes=array(<span class="stringliteral">&quot;enabled&quot;</span>=&gt;1);
<a name="l01158"></a>01158         $result = $this-&gt;<a class="code" href="classadLDAP.html#ada629d8c7b16ece3a8444f9712cb94a6" title="Modify a user.">user_modify</a>($username, $attributes, $isGUID);
<a name="l01159"></a>01159         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01162"></a>01162     }
<a name="l01163"></a>01163 
<a name="l01172"></a><a class="code" href="classadLDAP.html#ab69a0f0d27c0a9dab01a8366fa42bcc8">01172</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ab69a0f0d27c0a9dab01a8366fa42bcc8" title="Set the password of a user - This must be performed over SSL.">user_password</a>($username,$password,$isGUID=<span class="keyword">false</span>){
<a name="l01173"></a>01173         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01174"></a>01174         <span class="keywordflow">if</span> ($password===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01175"></a>01175         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01176"></a>01176         <span class="keywordflow">if</span> (!$this-&gt;_use_ssl &amp;&amp; !$this-&gt;_use_tls){
<a name="l01177"></a>01177             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>(<span class="stringliteral">&#39;SSL must be configured on your webserver and enabled in the class to set passwords.&#39;</span>);
<a name="l01178"></a>01178         }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180         $user_dn=$this-&gt;<a class="code" href="classadLDAP.html#ab581027573b7b10cbc72fbff8a458196" title="Obtain the user&amp;#39;s distinguished name based on their userid.">user_dn</a>($username,$isGUID);
<a name="l01181"></a>01181         <span class="keywordflow">if</span> ($user_dn===<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         $add=array();
<a name="l01184"></a>01184         $add[<span class="stringliteral">&quot;unicodePwd&quot;</span>][0]=$this-&gt;<a class="code" href="classadLDAP.html#ab440140cf001c324d94837a9d187dd02" title="Encode a password for transmission over LDAP.">encode_password</a>($password);
<a name="l01185"></a>01185 
<a name="l01186"></a>01186         $result=@ldap_mod_replace($this-&gt;_conn,$user_dn,$add);
<a name="l01187"></a>01187         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){
<a name="l01188"></a>01188             $err = ldap_errno($this-&gt;_conn);
<a name="l01189"></a>01189             <span class="keywordflow">if</span>($err){
<a name="l01190"></a>01190                 $msg = <span class="stringliteral">&#39;Error &#39;</span>.$err.<span class="stringliteral">&#39;: &#39;</span>.ldap_err2str($err).<span class="charliteral">&#39;.&#39;</span>;
<a name="l01191"></a>01191                 <span class="keywordflow">if</span>($err == 53) $msg .= <span class="stringliteral">&#39; Your password might not match the password policy.&#39;</span>;
<a name="l01192"></a>01192                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a>($msg);
<a name="l01193"></a>01193             }<span class="keywordflow">else</span>{
<a name="l01194"></a>01194                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01195"></a>01195             }
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200 
<a name="l01209"></a><a class="code" href="classadLDAP.html#ad23603e1e9c52ed3956134035fa0a197">01209</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ad23603e1e9c52ed3956134035fa0a197" title="Return a list of all users in AD.">all_users</a>($include_desc = <span class="keyword">false</span>, $search = <span class="stringliteral">&quot;*&quot;</span>, $sorted = <span class="keyword">true</span>){
<a name="l01210"></a>01210         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212         <span class="comment">// Perform the search and grab all their details</span>
<a name="l01213"></a>01213         $filter = <span class="stringliteral">&quot;(&amp;(objectClass=user)(samaccounttype=&quot;</span>. ADLDAP_NORMAL_ACCOUNT .<span class="stringliteral">&quot;)(objectCategory=person)(cn=&quot;</span>.$search.<span class="stringliteral">&quot;))&quot;</span>;
<a name="l01214"></a>01214         $fields=array(<span class="stringliteral">&quot;samaccountname&quot;</span>,<span class="stringliteral">&quot;displayname&quot;</span>);
<a name="l01215"></a>01215         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l01216"></a>01216         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01217"></a>01217 
<a name="l01218"></a>01218         $users_array = array();
<a name="l01219"></a>01219         <span class="keywordflow">for</span> ($i=0; $i&lt;$entries[<span class="stringliteral">&quot;count&quot;</span>]; $i++){
<a name="l01220"></a>01220             <span class="keywordflow">if</span> ($include_desc &amp;&amp; strlen($entries[$i][<span class="stringliteral">&quot;displayname&quot;</span>][0])&gt;0){
<a name="l01221"></a>01221                 $users_array[ $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0] ] = $entries[$i][<span class="stringliteral">&quot;displayname&quot;</span>][0];
<a name="l01222"></a>01222             } elseif ($include_desc){
<a name="l01223"></a>01223                 $users_array[ $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0] ] = $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0];
<a name="l01224"></a>01224             } <span class="keywordflow">else</span> {
<a name="l01225"></a>01225                 array_push($users_array, $entries[$i][<span class="stringliteral">&quot;samaccountname&quot;</span>][0]);
<a name="l01226"></a>01226             }
<a name="l01227"></a>01227         }
<a name="l01228"></a>01228         <span class="keywordflow">if</span> ($sorted){ asort($users_array); }
<a name="l01229"></a>01229         <span class="keywordflow">return</span> ($users_array);
<a name="l01230"></a>01230     }
<a name="l01231"></a>01231 
<a name="l01238"></a><a class="code" href="classadLDAP.html#ab06c9a08e2480a42b249f2d003525c60">01238</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ab06c9a08e2480a42b249f2d003525c60" title="Converts a username (samAccountName) to a GUID.">username2guid</a>($username) {
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01240"></a>01240         <span class="keywordflow">if</span> ($username === null){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242         $filter = <span class="stringliteral">&quot;samaccountname=&quot;</span> . $username;
<a name="l01243"></a>01243         $fields = array(<span class="stringliteral">&quot;objectGUID&quot;</span>);
<a name="l01244"></a>01244         $sr = @ldap_search($this-&gt;_conn, $this-&gt;_base_dn, $filter, $fields);
<a name="l01245"></a>01245         <span class="keywordflow">if</span> (ldap_count_entries($this-&gt;_conn, $sr) &gt; 0) {
<a name="l01246"></a>01246             $entry = @ldap_first_entry($this-&gt;_conn, $sr);
<a name="l01247"></a>01247             $guid = @ldap_get_values_len($this-&gt;_conn, $entry, <span class="stringliteral">&#39;objectGUID&#39;</span>);
<a name="l01248"></a>01248             $strGUID = $this-&gt;<a class="code" href="classadLDAP.html#ac31c9b3b782b23273c4b2cbdd2c2030f" title="Converts a binary attribute to a string.">binary2text</a>($guid[0]);
<a name="l01249"></a>01249             <span class="keywordflow">return</span> ($strGUID);
<a name="l01250"></a>01250         }
<a name="l01251"></a>01251         <span class="keywordflow">else</span> {
<a name="l01252"></a>01252             <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l01253"></a>01253         }
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255 
<a name="l01264"></a><a class="code" href="classadLDAP.html#a801e8e2f53e1fba79b97032037cff0bd">01264</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a801e8e2f53e1fba79b97032037cff0bd" title="Move a user account to a different OU.">user_move</a>($username, $container) {
<a name="l01265"></a>01265         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01266"></a>01266         <span class="keywordflow">if</span> ($username === null){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01267"></a>01267         <span class="keywordflow">if</span> ($container === null){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [container]&quot;</span>); }
<a name="l01268"></a>01268         <span class="keywordflow">if</span> (!is_array($container)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Container must be an array&quot;</span>); }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270         $userinfo = $this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username, array(<span class="stringliteral">&quot;*&quot;</span>));
<a name="l01271"></a>01271         $dn = $userinfo[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0];
<a name="l01272"></a>01272         $newrdn = <span class="stringliteral">&quot;cn=&quot;</span> . $username;
<a name="l01273"></a>01273         $container = array_reverse($container);
<a name="l01274"></a>01274         $newcontainer = <span class="stringliteral">&quot;ou=&quot;</span> . implode(<span class="stringliteral">&quot;,ou=&quot;</span>,$container);
<a name="l01275"></a>01275         $newbasedn = strtolower($newcontainer) . <span class="stringliteral">&quot;,&quot;</span> . $this-&gt;_base_dn;
<a name="l01276"></a>01276         $result=@ldap_rename($this-&gt;_conn,$dn,$newrdn,$newbasedn,<span class="keyword">true</span>);
<a name="l01277"></a>01277         <span class="keywordflow">if</span> ($result !== <span class="keyword">true</span>) {
<a name="l01278"></a>01278             <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l01279"></a>01279         }
<a name="l01280"></a>01280         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01281"></a>01281     }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="comment">//*****************************************************************************************************************</span>
<a name="l01284"></a>01284     <span class="comment">// CONTACT FUNCTIONS</span>
<a name="l01285"></a>01285     <span class="comment">// * Still work to do in this area, and new functions to write</span>
<a name="l01286"></a>01286 
<a name="l01293"></a><a class="code" href="classadLDAP.html#a2d3b117a5cd6143d58aad1f750c38253">01293</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a2d3b117a5cd6143d58aad1f750c38253" title="Create a contact.">contact_create</a>($attributes){
<a name="l01294"></a>01294         <span class="comment">// Check for compulsory fields</span>
<a name="l01295"></a>01295         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;display_name&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [display_name]&quot;</span>); }
<a name="l01296"></a>01296         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;email&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [email]&quot;</span>); }
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;container&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [container]&quot;</span>); }
<a name="l01298"></a>01298         <span class="keywordflow">if</span> (!is_array($attributes[<span class="stringliteral">&quot;container&quot;</span>])){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Container attribute must be an array.&quot;</span>); }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300         <span class="comment">// Translate the schema</span>
<a name="l01301"></a>01301         $add=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l01302"></a>01302 
<a name="l01303"></a>01303         <span class="comment">// Additional stuff only used for adding contacts</span>
<a name="l01304"></a>01304         $add[<span class="stringliteral">&quot;cn&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;display_name&quot;</span>];
<a name="l01305"></a>01305         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][0]=<span class="stringliteral">&quot;top&quot;</span>;
<a name="l01306"></a>01306         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][1]=<span class="stringliteral">&quot;person&quot;</span>;
<a name="l01307"></a>01307         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][2]=<span class="stringliteral">&quot;organizationalPerson&quot;</span>;
<a name="l01308"></a>01308         $add[<span class="stringliteral">&quot;objectclass&quot;</span>][3]=<span class="stringliteral">&quot;contact&quot;</span>;
<a name="l01309"></a>01309         <span class="keywordflow">if</span> (!isset($attributes[<span class="stringliteral">&#39;exchange_hidefromlists&#39;</span>])) {
<a name="l01310"></a>01310             $add[<span class="stringliteral">&quot;msExchHideFromAddressLists&quot;</span>][0]=<span class="stringliteral">&quot;TRUE&quot;</span>;
<a name="l01311"></a>01311         }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313         <span class="comment">// Determine the container</span>
<a name="l01314"></a>01314         $attributes[<span class="stringliteral">&quot;container&quot;</span>]=array_reverse($attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l01315"></a>01315         $container=<span class="stringliteral">&quot;OU=&quot;</span>.implode(<span class="stringliteral">&quot;,OU=&quot;</span>,$attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l01316"></a>01316 
<a name="l01317"></a>01317         <span class="comment">// Add the entry</span>
<a name="l01318"></a>01318         $result=@ldap_add($this-&gt;_conn, <span class="stringliteral">&quot;CN=&quot;</span>.$add[<span class="stringliteral">&quot;cn&quot;</span>][0].<span class="stringliteral">&quot;, &quot;</span>.$container.<span class="stringliteral">&quot;,&quot;</span>.$this-&gt;_base_dn, $add);
<a name="l01319"></a>01319         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323 
<a name="l01331"></a><a class="code" href="classadLDAP.html#ae70e060dba754a4d22967732260c310d">01331</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ae70e060dba754a4d22967732260c310d" title="Determine the list of groups a contact is a member of.">contact_groups</a>($distinguishedname,$recursive=NULL){
<a name="l01332"></a>01332         <span class="keywordflow">if</span> ($distinguishedname===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01333"></a>01333         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">//use the default option if they haven&#39;t set it</span>
<a name="l01334"></a>01334         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336         <span class="comment">// Search the directory for their information</span>
<a name="l01337"></a>01337         $info=@$this-&gt;<a class="code" href="classadLDAP.html#a30dbd0754ece0df04bae672a7712dfd9" title="Get contact information.">contact_info</a>($distinguishedname,array(<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;primarygroupid&quot;</span>));
<a name="l01338"></a>01338         $groups=$this-&gt;<a class="code" href="classadLDAP.html#a131b2784f0f42c19a82bd8110bbcd52e" title="Take an LDAP query and return the nice names, without all the LDAP prefixes (eg.">nice_names</a>($info[0][<span class="stringliteral">&quot;memberof&quot;</span>]); <span class="comment">//presuming the entry returned is our contact</span>
<a name="l01339"></a>01339 
<a name="l01340"></a>01340         <span class="keywordflow">if</span> ($recursive === <span class="keyword">true</span>){
<a name="l01341"></a>01341             <span class="keywordflow">foreach</span> ($groups as $id =&gt; $group_name){
<a name="l01342"></a>01342                 $extra_groups=$this-&gt;<a class="code" href="classadLDAP.html#a0b7f34f208a1774d3002d512b62450fc" title="Return a complete list of &amp;quot;groups in groups&amp;quot;.">recursive_groups</a>($group_name);
<a name="l01343"></a>01343                 $groups=array_merge($groups,$extra_groups);
<a name="l01344"></a>01344             }
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         <span class="keywordflow">return</span> ($groups);
<a name="l01348"></a>01348     }
<a name="l01349"></a>01349 
<a name="l01357"></a><a class="code" href="classadLDAP.html#a30dbd0754ece0df04bae672a7712dfd9">01357</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a30dbd0754ece0df04bae672a7712dfd9" title="Get contact information.">contact_info</a>($distinguishedname,$fields=NULL){
<a name="l01358"></a>01358         <span class="keywordflow">if</span> ($distinguishedname===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01359"></a>01359         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361         $filter=<span class="stringliteral">&quot;distinguishedName=&quot;</span>.$distinguishedname;
<a name="l01362"></a>01362         <span class="keywordflow">if</span> ($fields===NULL){ $fields=array(<span class="stringliteral">&quot;distinguishedname&quot;</span>,<span class="stringliteral">&quot;mail&quot;</span>,<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;department&quot;</span>,<span class="stringliteral">&quot;displayname&quot;</span>,<span class="stringliteral">&quot;telephonenumber&quot;</span>,<span class="stringliteral">&quot;primarygroupid&quot;</span>,<span class="stringliteral">&quot;objectsid&quot;</span>); }
<a name="l01363"></a>01363         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l01364"></a>01364         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01365"></a>01365 
<a name="l01366"></a>01366         <span class="keywordflow">if</span> ($entries[0][<span class="stringliteral">&#39;count&#39;</span>] &gt;= 1) {
<a name="l01367"></a>01367             <span class="comment">// AD does not return the primary group in the ldap query, we may need to fudge it</span>
<a name="l01368"></a>01368             <span class="keywordflow">if</span> ($this-&gt;_real_primarygroup &amp;&amp; isset($entries[0][<span class="stringliteral">&quot;primarygroupid&quot;</span>][0]) &amp;&amp; isset($entries[0][<span class="stringliteral">&quot;primarygroupid&quot;</span>][0])){
<a name="l01369"></a>01369                 <span class="comment">//$entries[0][&quot;memberof&quot;][]=$this-&gt;group_cn($entries[0][&quot;primarygroupid&quot;][0]);</span>
<a name="l01370"></a>01370                 $entries[0][<span class="stringliteral">&quot;memberof&quot;</span>][]=$this-&gt;<a class="code" href="classadLDAP.html#a463259d457310dc99dd2619098686643" title="Coping with AD not returning the primary group http://support.microsoft.com/?kbid=321360...">get_primary_group</a>($entries[0][<span class="stringliteral">&quot;primarygroupid&quot;</span>][0], $entries[0][<span class="stringliteral">&quot;objectsid&quot;</span>][0]);
<a name="l01371"></a>01371             } <span class="keywordflow">else</span> {
<a name="l01372"></a>01372                 $entries[0][<span class="stringliteral">&quot;memberof&quot;</span>][]=<span class="stringliteral">&quot;CN=Domain Users,CN=Users,&quot;</span>.$this-&gt;_base_dn;
<a name="l01373"></a>01373             }
<a name="l01374"></a>01374         }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         $entries[0][<span class="stringliteral">&quot;memberof&quot;</span>][<span class="stringliteral">&quot;count&quot;</span>]++;
<a name="l01377"></a>01377         <span class="keywordflow">return</span> ($entries);
<a name="l01378"></a>01378     }
<a name="l01379"></a>01379 
<a name="l01388"></a><a class="code" href="classadLDAP.html#aa12fe4c77f51464d4b92ce5fe2d1f08a">01388</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aa12fe4c77f51464d4b92ce5fe2d1f08a" title="Determine if a contact is a member of a group.">contact_ingroup</a>($distinguisedname,$group,$recursive=NULL){
<a name="l01389"></a>01389         <span class="keywordflow">if</span> ($distinguisedname===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01390"></a>01390         <span class="keywordflow">if</span> ($group===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01391"></a>01391         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01392"></a>01392         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">//use the default option if they haven&#39;t set it</span>
<a name="l01393"></a>01393 
<a name="l01394"></a>01394         <span class="comment">// Get a list of the groups</span>
<a name="l01395"></a>01395         $groups=$this-&gt;<a class="code" href="classadLDAP.html#ae70e060dba754a4d22967732260c310d" title="Determine the list of groups a contact is a member of.">contact_groups</a>($distinguisedname,array(<span class="stringliteral">&quot;memberof&quot;</span>),$recursive);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         <span class="comment">// Return true if the specified group is in the group list</span>
<a name="l01398"></a>01398         <span class="keywordflow">if</span> (in_array($group,$groups)){ <span class="keywordflow">return</span> (<span class="keyword">true</span>); }
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l01401"></a>01401     }
<a name="l01402"></a>01402 
<a name="l01410"></a><a class="code" href="classadLDAP.html#aaf5afe1fbcf37701421625ca90666a27">01410</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aaf5afe1fbcf37701421625ca90666a27" title="Modify a contact.">contact_modify</a>($distinguishedname,$attributes){
<a name="l01411"></a>01411         <span class="keywordflow">if</span> ($distinguishedname===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [distinguishedname]&quot;</span>); }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413         <span class="comment">// Translate the update to the LDAP schema</span>
<a name="l01414"></a>01414         $mod=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416         <span class="comment">// Check to see if this is an enabled status update</span>
<a name="l01417"></a>01417         <span class="keywordflow">if</span> (!$mod){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         <span class="comment">// Do the update</span>
<a name="l01420"></a>01420         $result=ldap_modify($this-&gt;_conn,$distinguishedname,$mod);
<a name="l01421"></a>01421         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01422"></a>01422 
<a name="l01423"></a>01423         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01424"></a>01424     }
<a name="l01425"></a>01425 
<a name="l01432"></a><a class="code" href="classadLDAP.html#abe3a724ff3b697fb89a128ba49682d91">01432</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#abe3a724ff3b697fb89a128ba49682d91" title="Delete a contact.">contact_delete</a>($distinguishedname) {
<a name="l01433"></a>01433         $result = $this-&gt;<a class="code" href="classadLDAP.html#a3b937e0fc298242125f7743950bf7ecf" title="Delete a distinguished name from Active Directory You should never need to call this...">dn_delete</a>($distinguishedname);
<a name="l01434"></a>01434         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01435"></a>01435         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01436"></a>01436     }
<a name="l01437"></a>01437 
<a name="l01446"></a><a class="code" href="classadLDAP.html#a255abc2a9a01d5b5eb74ff265c1eb7bc">01446</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a255abc2a9a01d5b5eb74ff265c1eb7bc" title="Return a list of all contacts.">all_contacts</a>($include_desc = <span class="keyword">false</span>, $search = <span class="stringliteral">&quot;*&quot;</span>, $sorted = <span class="keyword">true</span>){
<a name="l01447"></a>01447         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449         <span class="comment">// Perform the search and grab all their details</span>
<a name="l01450"></a>01450         $filter = <span class="stringliteral">&quot;(&amp;(objectClass=contact)(cn=&quot;</span>.$search.<span class="stringliteral">&quot;))&quot;</span>;
<a name="l01451"></a>01451         $fields=array(<span class="stringliteral">&quot;displayname&quot;</span>,<span class="stringliteral">&quot;distinguishedname&quot;</span>);
<a name="l01452"></a>01452         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l01453"></a>01453         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01454"></a>01454 
<a name="l01455"></a>01455         $users_array = array();
<a name="l01456"></a>01456         <span class="keywordflow">for</span> ($i=0; $i&lt;$entries[<span class="stringliteral">&quot;count&quot;</span>]; $i++){
<a name="l01457"></a>01457             <span class="keywordflow">if</span> ($include_desc &amp;&amp; strlen($entries[$i][<span class="stringliteral">&quot;displayname&quot;</span>][0])&gt;0){
<a name="l01458"></a>01458                 $users_array[ $entries[$i][<span class="stringliteral">&quot;distinguishedname&quot;</span>][0] ] = $entries[$i][<span class="stringliteral">&quot;displayname&quot;</span>][0];
<a name="l01459"></a>01459             } elseif ($include_desc){
<a name="l01460"></a>01460                 $users_array[ $entries[$i][<span class="stringliteral">&quot;distinguishedname&quot;</span>][0] ] = $entries[$i][<span class="stringliteral">&quot;distinguishedname&quot;</span>][0];
<a name="l01461"></a>01461             } <span class="keywordflow">else</span> {
<a name="l01462"></a>01462                 array_push($users_array, $entries[$i][<span class="stringliteral">&quot;distinguishedname&quot;</span>][0]);
<a name="l01463"></a>01463             }
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465         <span class="keywordflow">if</span> ($sorted){ asort($users_array); }
<a name="l01466"></a>01466         <span class="keywordflow">return</span> ($users_array);
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="comment">//*****************************************************************************************************************</span>
<a name="l01470"></a>01470     <span class="comment">// FOLDER FUNCTIONS</span>
<a name="l01471"></a>01471 
<a name="l01484"></a><a class="code" href="classadLDAP.html#a75b6bce01ae5d1c8557407046ecf2be7">01484</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a75b6bce01ae5d1c8557407046ecf2be7" title="Returns a folder listing for a specific OU See http://adldap.sourceforge.net/wiki/doku...">folder_list</a>($folder_name = NULL, $dn_type = ADLDAP_FOLDER, $recursive = NULL, $type = NULL) {
<a name="l01485"></a>01485         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">//use the default option if they haven&#39;t set it</span>
<a name="l01486"></a>01486         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488         $filter = <span class="stringliteral">&#39;(&amp;&#39;</span>;
<a name="l01489"></a>01489         <span class="keywordflow">if</span> ($type !== NULL) {
<a name="l01490"></a>01490             <span class="keywordflow">switch</span> ($type) {
<a name="l01491"></a>01491                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;contact&#39;</span>:
<a name="l01492"></a>01492                     $filter .= <span class="stringliteral">&#39;(objectClass=contact)&#39;</span>;
<a name="l01493"></a>01493                     <span class="keywordflow">break</span>;
<a name="l01494"></a>01494                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;computer&#39;</span>:
<a name="l01495"></a>01495                     $filter .= <span class="stringliteral">&#39;(objectClass=computer)&#39;</span>;
<a name="l01496"></a>01496                     <span class="keywordflow">break</span>;
<a name="l01497"></a>01497                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;group&#39;</span>:
<a name="l01498"></a>01498                     $filter .= <span class="stringliteral">&#39;(objectClass=group)&#39;</span>;
<a name="l01499"></a>01499                     <span class="keywordflow">break</span>;
<a name="l01500"></a>01500                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;folder&#39;</span>:
<a name="l01501"></a>01501                     $filter .= <span class="stringliteral">&#39;(objectClass=organizationalUnit)&#39;</span>;
<a name="l01502"></a>01502                     <span class="keywordflow">break</span>;
<a name="l01503"></a>01503                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;container&#39;</span>:
<a name="l01504"></a>01504                     $filter .= <span class="stringliteral">&#39;(objectClass=container)&#39;</span>;
<a name="l01505"></a>01505                     <span class="keywordflow">break</span>;
<a name="l01506"></a>01506                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;domain&#39;</span>:
<a name="l01507"></a>01507                     $filter .= <span class="stringliteral">&#39;(objectClass=builtinDomain)&#39;</span>;
<a name="l01508"></a>01508                     <span class="keywordflow">break</span>;
<a name="l01509"></a>01509                 <span class="keywordflow">default</span>:
<a name="l01510"></a>01510                     $filter .= <span class="stringliteral">&#39;(objectClass=user)&#39;</span>;
<a name="l01511"></a>01511                     <span class="keywordflow">break</span>;
<a name="l01512"></a>01512             }
<a name="l01513"></a>01513         }
<a name="l01514"></a>01514         <span class="keywordflow">else</span> {
<a name="l01515"></a>01515             $filter .= <span class="stringliteral">&#39;(objectClass=*)&#39;</span>;
<a name="l01516"></a>01516         }
<a name="l01517"></a>01517         <span class="comment">// If the folder name is null then we will search the root level of AD</span>
<a name="l01518"></a>01518         <span class="comment">// This requires us to not have an OU= part, just the base_dn</span>
<a name="l01519"></a>01519         $searchou = $this-&gt;_base_dn;
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (is_array($folder_name)) {
<a name="l01521"></a>01521             $ou = $dn_type . <span class="stringliteral">&quot;=&quot;</span>.implode(<span class="stringliteral">&quot;,&quot;</span> . $dn_type . <span class="stringliteral">&quot;=&quot;</span>,$folder_name);
<a name="l01522"></a>01522             $filter .= <span class="stringliteral">&#39;(!(distinguishedname=&#39;</span> . $ou . <span class="charliteral">&#39;,&#39;</span> . $this-&gt;_base_dn . <span class="stringliteral">&#39;)))&#39;</span>;
<a name="l01523"></a>01523             $searchou = $ou . <span class="charliteral">&#39;,&#39;</span> . $this-&gt;_base_dn;
<a name="l01524"></a>01524         }
<a name="l01525"></a>01525         <span class="keywordflow">else</span> {
<a name="l01526"></a>01526             $filter .= <span class="stringliteral">&#39;(!(distinguishedname=&#39;</span> . $this-&gt;_base_dn . <span class="stringliteral">&#39;)))&#39;</span>;
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528 
<a name="l01529"></a>01529         <span class="keywordflow">if</span> ($recursive === <span class="keyword">true</span>) {
<a name="l01530"></a>01530             $sr=ldap_search($this-&gt;_conn, $searchou, $filter, array(<span class="stringliteral">&#39;objectclass&#39;</span>, <span class="stringliteral">&#39;distinguishedname&#39;</span>, <span class="stringliteral">&#39;samaccountname&#39;</span>));
<a name="l01531"></a>01531             $entries = @ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01532"></a>01532             <span class="keywordflow">if</span> (is_array($entries)) {
<a name="l01533"></a>01533                 <span class="keywordflow">return</span> $entries;
<a name="l01534"></a>01534             }
<a name="l01535"></a>01535         }
<a name="l01536"></a>01536         <span class="keywordflow">else</span> {
<a name="l01537"></a>01537             $sr=ldap_list($this-&gt;_conn, $searchou, $filter, array(<span class="stringliteral">&#39;objectclass&#39;</span>, <span class="stringliteral">&#39;distinguishedname&#39;</span>, <span class="stringliteral">&#39;samaccountname&#39;</span>));
<a name="l01538"></a>01538             $entries = @ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01539"></a>01539             <span class="keywordflow">if</span> (is_array($entries)) {
<a name="l01540"></a>01540                 <span class="keywordflow">return</span> $entries;
<a name="l01541"></a>01541             }
<a name="l01542"></a>01542         }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01545"></a>01545     }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     <span class="comment">//*****************************************************************************************************************</span>
<a name="l01548"></a>01548     <span class="comment">// COMPUTER FUNCTIONS</span>
<a name="l01549"></a>01549 
<a name="l01557"></a><a class="code" href="classadLDAP.html#a3d2859c7c454e6ba4244d5b4f5941cbb">01557</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a3d2859c7c454e6ba4244d5b4f5941cbb" title="Get information about a specific computer.">computer_info</a>($computer_name,$fields=NULL){
<a name="l01558"></a>01558         <span class="keywordflow">if</span> ($computer_name===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01559"></a>01559         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561         $filter=<span class="stringliteral">&quot;(&amp;(objectClass=computer)(cn=&quot;</span>.$computer_name.<span class="stringliteral">&quot;))&quot;</span>;
<a name="l01562"></a>01562         <span class="keywordflow">if</span> ($fields===NULL){ $fields=array(<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;displayname&quot;</span>,<span class="stringliteral">&quot;dnshostname&quot;</span>,<span class="stringliteral">&quot;distinguishedname&quot;</span>,<span class="stringliteral">&quot;objectcategory&quot;</span>,<span class="stringliteral">&quot;operatingsystem&quot;</span>,<span class="stringliteral">&quot;operatingsystemservicepack&quot;</span>,<span class="stringliteral">&quot;operatingsystemversion&quot;</span>); }
<a name="l01563"></a>01563         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l01564"></a>01564         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01565"></a>01565 
<a name="l01566"></a>01566         <span class="keywordflow">return</span> ($entries);
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568 
<a name="l01577"></a><a class="code" href="classadLDAP.html#af0f5d20ed97d073ea4ecbf5578091ecb">01577</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#af0f5d20ed97d073ea4ecbf5578091ecb" title="Check if a computer is in a group.">computer_ingroup</a>($computer_name,$group,$recursive=NULL){
<a name="l01578"></a>01578         <span class="keywordflow">if</span> ($computer_name===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01579"></a>01579         <span class="keywordflow">if</span> ($group===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01580"></a>01580         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01581"></a>01581         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">// use the default option if they haven&#39;t set it</span>
<a name="l01582"></a>01582 
<a name="l01583"></a>01583         <span class="comment">//get a list of the groups</span>
<a name="l01584"></a>01584         $groups=$this-&gt;<a class="code" href="classadLDAP.html#a2140b1b59154dcd9c731f9d342ca1059" title="Get the groups a computer is in.">computer_groups</a>($computer_name,array(<span class="stringliteral">&quot;memberof&quot;</span>),$recursive);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586         <span class="comment">//return true if the specified group is in the group list</span>
<a name="l01587"></a>01587         <span class="keywordflow">if</span> (in_array($group,$groups)){ <span class="keywordflow">return</span> (<span class="keyword">true</span>); }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589         <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 
<a name="l01599"></a><a class="code" href="classadLDAP.html#a2140b1b59154dcd9c731f9d342ca1059">01599</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a2140b1b59154dcd9c731f9d342ca1059" title="Get the groups a computer is in.">computer_groups</a>($computer_name,$recursive=NULL){
<a name="l01600"></a>01600         <span class="keywordflow">if</span> ($computer_name===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01601"></a>01601         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; } <span class="comment">//use the default option if they haven&#39;t set it</span>
<a name="l01602"></a>01602         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01603"></a>01603 
<a name="l01604"></a>01604         <span class="comment">//search the directory for their information</span>
<a name="l01605"></a>01605         $info=@$this-&gt;<a class="code" href="classadLDAP.html#a3d2859c7c454e6ba4244d5b4f5941cbb" title="Get information about a specific computer.">computer_info</a>($computer_name,array(<span class="stringliteral">&quot;memberof&quot;</span>,<span class="stringliteral">&quot;primarygroupid&quot;</span>));
<a name="l01606"></a>01606         $groups=$this-&gt;<a class="code" href="classadLDAP.html#a131b2784f0f42c19a82bd8110bbcd52e" title="Take an LDAP query and return the nice names, without all the LDAP prefixes (eg.">nice_names</a>($info[0][<span class="stringliteral">&quot;memberof&quot;</span>]); <span class="comment">//presuming the entry returned is our guy (unique usernames)</span>
<a name="l01607"></a>01607 
<a name="l01608"></a>01608         <span class="keywordflow">if</span> ($recursive === <span class="keyword">true</span>){
<a name="l01609"></a>01609             <span class="keywordflow">foreach</span> ($groups as $id =&gt; $group_name){
<a name="l01610"></a>01610               $extra_groups=$this-&gt;<a class="code" href="classadLDAP.html#a0b7f34f208a1774d3002d512b62450fc" title="Return a complete list of &amp;quot;groups in groups&amp;quot;.">recursive_groups</a>($group_name);
<a name="l01611"></a>01611               $groups=array_merge($groups,$extra_groups);
<a name="l01612"></a>01612             }
<a name="l01613"></a>01613         }
<a name="l01614"></a>01614 
<a name="l01615"></a>01615         <span class="keywordflow">return</span> ($groups);
<a name="l01616"></a>01616     }
<a name="l01617"></a>01617 
<a name="l01618"></a>01618     <span class="comment">//************************************************************************************************************</span>
<a name="l01619"></a>01619     <span class="comment">//  ORGANIZATIONAL UNIT FUNCTIONS</span>
<a name="l01620"></a>01620 
<a name="l01627"></a><a class="code" href="classadLDAP.html#af2b9d7a001ebe20d7e837f52171bcb57">01627</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#af2b9d7a001ebe20d7e837f52171bcb57" title="Create an organizational unit.">ou_create</a>($attributes){
<a name="l01628"></a>01628         <span class="keywordflow">if</span> (!is_array($attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Attributes must be an array&quot;</span>); }
<a name="l01629"></a>01629         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;ou_name&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [ou_name]&quot;</span>); }
<a name="l01630"></a>01630         <span class="keywordflow">if</span> (!array_key_exists(<span class="stringliteral">&quot;container&quot;</span>,$attributes)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [container]&quot;</span>); }
<a name="l01631"></a>01631         <span class="keywordflow">if</span> (!is_array($attributes[<span class="stringliteral">&quot;container&quot;</span>])){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Container attribute must be an array.&quot;</span>); }
<a name="l01632"></a>01632         $attributes[<span class="stringliteral">&quot;container&quot;</span>]=array_reverse($attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l01633"></a>01633 
<a name="l01634"></a>01634         $add=array();
<a name="l01635"></a>01635         $add[<span class="stringliteral">&quot;objectClass&quot;</span>] = <span class="stringliteral">&quot;organizationalUnit&quot;</span>;
<a name="l01636"></a>01636 
<a name="l01637"></a>01637         $container=<span class="stringliteral">&quot;OU=&quot;</span>.implode(<span class="stringliteral">&quot;,OU=&quot;</span>,$attributes[<span class="stringliteral">&quot;container&quot;</span>]);
<a name="l01638"></a>01638         $result=ldap_add($this-&gt;_conn,<span class="stringliteral">&quot;CN=&quot;</span>.$add[<span class="stringliteral">&quot;cn&quot;</span>].<span class="stringliteral">&quot;, &quot;</span>.$container.<span class="stringliteral">&quot;,&quot;</span>.$this-&gt;_base_dn,$add);
<a name="l01639"></a>01639         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01642"></a>01642     }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644     <span class="comment">//************************************************************************************************************</span>
<a name="l01645"></a>01645     <span class="comment">// EXCHANGE FUNCTIONS</span>
<a name="l01646"></a>01646 
<a name="l01660"></a><a class="code" href="classadLDAP.html#ab42925626abd09fb164f82f496756b20">01660</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ab42925626abd09fb164f82f496756b20" title="Create an Exchange account.">exchange_create_mailbox</a>($username, $storagegroup, $emailaddress, $mailnickname=NULL, $usedefaults=TRUE, $base_dn=NULL, $isGUID=<span class="keyword">false</span>){
<a name="l01661"></a>01661         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01662"></a>01662         <span class="keywordflow">if</span> ($storagegroup===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory array [storagegroup]&quot;</span>); }
<a name="l01663"></a>01663         <span class="keywordflow">if</span> (!is_array($storagegroup)){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;[storagegroup] must be an array&quot;</span>); }
<a name="l01664"></a>01664         <span class="keywordflow">if</span> ($emailaddress===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [emailaddress]&quot;</span>); }
<a name="l01665"></a>01665 
<a name="l01666"></a>01666         <span class="keywordflow">if</span> ($base_dn===NULL) {
<a name="l01667"></a>01667             $base_dn = $this-&gt;_base_dn;
<a name="l01668"></a>01668         }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670         $container=<span class="stringliteral">&quot;CN=&quot;</span>.implode(<span class="stringliteral">&quot;,CN=&quot;</span>,$storagegroup);
<a name="l01671"></a>01671 
<a name="l01672"></a>01672         <span class="keywordflow">if</span> ($mailnickname===NULL) { $mailnickname=$username; }
<a name="l01673"></a>01673         $mdbUseDefaults = $this-&gt;<a class="code" href="classadLDAP.html#a18c25e51fff2daca9f090818dcc6cc27" title="Convert a boolean value to a string You should never need to call this yourself.">bool2str</a>($usedefaults);
<a name="l01674"></a>01674 
<a name="l01675"></a>01675         $attributes = array(
<a name="l01676"></a>01676             <span class="stringliteral">&#39;exchange_homemdb&#39;</span>=&gt;$container.<span class="stringliteral">&quot;,&quot;</span>.$base_dn,
<a name="l01677"></a>01677             <span class="stringliteral">&#39;exchange_proxyaddress&#39;</span>=&gt;<span class="stringliteral">&#39;SMTP:&#39;</span> . $emailaddress,
<a name="l01678"></a>01678             <span class="stringliteral">&#39;exchange_mailnickname&#39;</span>=&gt;$mailnickname,
<a name="l01679"></a>01679             <span class="stringliteral">&#39;exchange_usedefaults&#39;</span>=&gt;$mdbUseDefaults
<a name="l01680"></a>01680         );
<a name="l01681"></a>01681         $result = $this-&gt;<a class="code" href="classadLDAP.html#ada629d8c7b16ece3a8444f9712cb94a6" title="Modify a user.">user_modify</a>($username,$attributes,$isGUID);
<a name="l01682"></a>01682         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01683"></a>01683         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01684"></a>01684     }
<a name="l01685"></a>01685 
<a name="l01701"></a><a class="code" href="classadLDAP.html#a55df6d59f5151de93b773ff229c048c1">01701</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a55df6d59f5151de93b773ff229c048c1" title="Add an X400 address to Exchange See http://tools.ietf.org/html/rfc1685 for more information...">exchange_add_X400</a>($username, $country, $admd, $pdmd, $org, $surname, $givenname, $isGUID=<span class="keyword">false</span>) {
<a name="l01702"></a>01702         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704         $proxyvalue = <span class="stringliteral">&#39;X400:&#39;</span>;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706         <span class="comment">// Find the dn of the user</span>
<a name="l01707"></a>01707         $user=$this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,array(<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;proxyaddresses&quot;</span>), $isGUID);
<a name="l01708"></a>01708         <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01709"></a>01709         $user_dn=$user[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l01710"></a>01710 
<a name="l01711"></a>01711         <span class="comment">// We do not have to demote an email address from the default so we can just add the new proxy address</span>
<a name="l01712"></a>01712         $attributes[<span class="stringliteral">&#39;exchange_proxyaddress&#39;</span>] = $proxyvalue . <span class="stringliteral">&#39;c=&#39;</span> . $country . <span class="stringliteral">&#39;;a=&#39;</span> . $admd . <span class="stringliteral">&#39;;p=&#39;</span> . $pdmd . <span class="stringliteral">&#39;;o=&#39;</span> . $org . <span class="stringliteral">&#39;;s=&#39;</span> . $surname . <span class="stringliteral">&#39;;g=&#39;</span> . $givenname . <span class="charliteral">&#39;;&#39;</span>;
<a name="l01713"></a>01713 
<a name="l01714"></a>01714         <span class="comment">// Translate the update to the LDAP schema</span>
<a name="l01715"></a>01715         $add=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l01716"></a>01716 
<a name="l01717"></a>01717         <span class="keywordflow">if</span> (!$add){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719         <span class="comment">// Do the update</span>
<a name="l01720"></a>01720         <span class="comment">// Take out the @ to see any errors, usually this error might occur because the address already</span>
<a name="l01721"></a>01721         <span class="comment">// exists in the list of proxyAddresses</span>
<a name="l01722"></a>01722         $result=@ldap_mod_add($this-&gt;_conn,$user_dn,$add);
<a name="l01723"></a>01723         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01724"></a>01724 
<a name="l01725"></a>01725         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727 
<a name="l01737"></a><a class="code" href="classadLDAP.html#a34a9abe87366a8a010ca28537cb7a475">01737</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a34a9abe87366a8a010ca28537cb7a475" title="Add an address to Exchange.">exchange_add_address</a>($username, $emailaddress, $default=FALSE, $isGUID=<span class="keyword">false</span>) {
<a name="l01738"></a>01738         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01739"></a>01739         <span class="keywordflow">if</span> ($emailaddress===NULL) { <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory fields [emailaddress]&quot;</span>); }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         $proxyvalue = <span class="stringliteral">&#39;smtp:&#39;</span>;
<a name="l01742"></a>01742         <span class="keywordflow">if</span> ($default === <span class="keyword">true</span>) {
<a name="l01743"></a>01743             $proxyvalue = <span class="stringliteral">&#39;SMTP:&#39;</span>;
<a name="l01744"></a>01744         }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746         <span class="comment">// Find the dn of the user</span>
<a name="l01747"></a>01747         $user=$this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,array(<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;proxyaddresses&quot;</span>),$isGUID);
<a name="l01748"></a>01748         <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01749"></a>01749         $user_dn=$user[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l01750"></a>01750 
<a name="l01751"></a>01751         <span class="comment">// We need to scan existing proxy addresses and demote the default one</span>
<a name="l01752"></a>01752         <span class="keywordflow">if</span> (is_array($user[0][<span class="stringliteral">&quot;proxyaddresses&quot;</span>]) &amp;&amp; $default===<span class="keyword">true</span>) {
<a name="l01753"></a>01753             $modaddresses = array();
<a name="l01754"></a>01754             <span class="keywordflow">for</span> ($i=0;$i&lt;<span class="keyword">sizeof</span>($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>]);$i++) {
<a name="l01755"></a>01755                 <span class="keywordflow">if</span> (strstr($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i], <span class="stringliteral">&#39;SMTP:&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01756"></a>01756                     $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] = str_replace(<span class="stringliteral">&#39;SMTP:&#39;</span>, <span class="stringliteral">&#39;smtp:&#39;</span>, $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i]);
<a name="l01757"></a>01757                 }
<a name="l01758"></a>01758                 <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l01759"></a>01759                     $modaddresses[<span class="stringliteral">&#39;proxyAddresses&#39;</span>][$i] = $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i];
<a name="l01760"></a>01760                 }
<a name="l01761"></a>01761             }
<a name="l01762"></a>01762             $modaddresses[<span class="stringliteral">&#39;proxyAddresses&#39;</span>][(<span class="keyword">sizeof</span>($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>])-1)] = <span class="stringliteral">&#39;SMTP:&#39;</span> . $emailaddress;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764             $result=@ldap_mod_replace($this-&gt;_conn,$user_dn,$modaddresses);
<a name="l01765"></a>01765             <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01766"></a>01766 
<a name="l01767"></a>01767             <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01768"></a>01768         }
<a name="l01769"></a>01769         <span class="keywordflow">else</span> {
<a name="l01770"></a>01770             <span class="comment">// We do not have to demote an email address from the default so we can just add the new proxy address</span>
<a name="l01771"></a>01771             $attributes[<span class="stringliteral">&#39;exchange_proxyaddress&#39;</span>] = $proxyvalue . $emailaddress;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773             <span class="comment">// Translate the update to the LDAP schema</span>
<a name="l01774"></a>01774             $add=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l01775"></a>01775 
<a name="l01776"></a>01776             <span class="keywordflow">if</span> (!$add){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778             <span class="comment">// Do the update</span>
<a name="l01779"></a>01779             <span class="comment">// Take out the @ to see any errors, usually this error might occur because the address already</span>
<a name="l01780"></a>01780             <span class="comment">// exists in the list of proxyAddresses</span>
<a name="l01781"></a>01781             $result=@ldap_mod_add($this-&gt;_conn,$user_dn,$add);
<a name="l01782"></a>01782             <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01783"></a>01783 
<a name="l01784"></a>01784             <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01785"></a>01785         }
<a name="l01786"></a>01786     }
<a name="l01787"></a>01787 
<a name="l01798"></a><a class="code" href="classadLDAP.html#aa5b375b8a854761c8e746f6710ae7baf">01798</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aa5b375b8a854761c8e746f6710ae7baf" title="Remove an address to Exchange If you remove a default address the account will no...">exchange_del_address</a>($username, $emailaddress, $isGUID=<span class="keyword">false</span>) {
<a name="l01799"></a>01799         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01800"></a>01800         <span class="keywordflow">if</span> ($emailaddress===NULL) { <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory fields [emailaddress]&quot;</span>); }
<a name="l01801"></a>01801 
<a name="l01802"></a>01802         <span class="comment">// Find the dn of the user</span>
<a name="l01803"></a>01803         $user=$this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,array(<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;proxyaddresses&quot;</span>),$isGUID);
<a name="l01804"></a>01804         <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01805"></a>01805         $user_dn=$user[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l01806"></a>01806 
<a name="l01807"></a>01807         <span class="keywordflow">if</span> (is_array($user[0][<span class="stringliteral">&quot;proxyaddresses&quot;</span>])) {
<a name="l01808"></a>01808             $mod = array();
<a name="l01809"></a>01809             <span class="keywordflow">for</span> ($i=0;$i&lt;<span class="keyword">sizeof</span>($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>]);$i++) {
<a name="l01810"></a>01810                 <span class="keywordflow">if</span> (strstr($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i], <span class="stringliteral">&#39;SMTP:&#39;</span>) !== <span class="keyword">false</span> &amp;&amp; $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] == <span class="stringliteral">&#39;SMTP:&#39;</span> . $emailaddress) {
<a name="l01811"></a>01811                     $mod[<span class="stringliteral">&#39;proxyAddresses&#39;</span>][0] = <span class="stringliteral">&#39;SMTP:&#39;</span> . $emailaddress;
<a name="l01812"></a>01812                 }
<a name="l01813"></a>01813                 elseif (strstr($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i], <span class="stringliteral">&#39;smtp:&#39;</span>) !== <span class="keyword">false</span> &amp;&amp; $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] == <span class="stringliteral">&#39;smtp:&#39;</span> . $emailaddress) {
<a name="l01814"></a>01814                     $mod[<span class="stringliteral">&#39;proxyAddresses&#39;</span>][0] = <span class="stringliteral">&#39;smtp:&#39;</span> . $emailaddress;
<a name="l01815"></a>01815                 }
<a name="l01816"></a>01816             }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818             $result=@ldap_mod_del($this-&gt;_conn,$user_dn,$mod);
<a name="l01819"></a>01819             <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01820"></a>01820 
<a name="l01821"></a>01821             <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01822"></a>01822         }
<a name="l01823"></a>01823         <span class="keywordflow">else</span> {
<a name="l01824"></a>01824             <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l01825"></a>01825         }
<a name="l01826"></a>01826     }
<a name="l01835"></a><a class="code" href="classadLDAP.html#aa996c1c14e7782eebd99af900da92ace">01835</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aa996c1c14e7782eebd99af900da92ace" title="Change the default address.">exchange_primary_address</a>($username, $emailaddress, $isGUID=<span class="keyword">false</span>) {
<a name="l01836"></a>01836         <span class="keywordflow">if</span> ($username===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [username]&quot;</span>); }
<a name="l01837"></a>01837         <span class="keywordflow">if</span> ($emailaddress===NULL) { <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory fields [emailaddress]&quot;</span>); }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839         <span class="comment">// Find the dn of the user</span>
<a name="l01840"></a>01840         $user=$this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,array(<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;proxyaddresses&quot;</span>), $isGUID);
<a name="l01841"></a>01841         <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01842"></a>01842         $user_dn=$user[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l01843"></a>01843 
<a name="l01844"></a>01844         <span class="keywordflow">if</span> (is_array($user[0][<span class="stringliteral">&quot;proxyaddresses&quot;</span>])) {
<a name="l01845"></a>01845             $modaddresses = array();
<a name="l01846"></a>01846             <span class="keywordflow">for</span> ($i=0;$i&lt;<span class="keyword">sizeof</span>($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>]);$i++) {
<a name="l01847"></a>01847                 <span class="keywordflow">if</span> (strstr($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i], <span class="stringliteral">&#39;SMTP:&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01848"></a>01848                     $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] = str_replace(<span class="stringliteral">&#39;SMTP:&#39;</span>, <span class="stringliteral">&#39;smtp:&#39;</span>, $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i]);
<a name="l01849"></a>01849                 }
<a name="l01850"></a>01850                 <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] == <span class="stringliteral">&#39;smtp:&#39;</span> . $emailaddress) {
<a name="l01851"></a>01851                     $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] = str_replace(<span class="stringliteral">&#39;smtp:&#39;</span>, <span class="stringliteral">&#39;SMTP:&#39;</span>, $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i]);
<a name="l01852"></a>01852                 }
<a name="l01853"></a>01853                 <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l01854"></a>01854                     $modaddresses[<span class="stringliteral">&#39;proxyAddresses&#39;</span>][$i] = $user[0][<span class="stringliteral">&#39;proxyaddresses&#39;</span>][$i];
<a name="l01855"></a>01855                 }
<a name="l01856"></a>01856             }
<a name="l01857"></a>01857 
<a name="l01858"></a>01858             $result=@ldap_mod_replace($this-&gt;_conn,$user_dn,$modaddresses);
<a name="l01859"></a>01859             <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861             <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01862"></a>01862         }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864     }
<a name="l01865"></a>01865 
<a name="l01875"></a><a class="code" href="classadLDAP.html#ac8175af9bef7605eee7139ca6ab18cf3">01875</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#ac8175af9bef7605eee7139ca6ab18cf3" title="Mail enable a contact Allows email to be sent to them through Exchange.">exchange_contact_mailenable</a>($distinguishedname, $emailaddress, $mailnickname=NULL){
<a name="l01876"></a>01876         <span class="keywordflow">if</span> ($distinguishedname===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [distinguishedname]&quot;</span>); }
<a name="l01877"></a>01877         <span class="keywordflow">if</span> ($emailaddress===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [emailaddress]&quot;</span>); }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879         <span class="keywordflow">if</span> ($mailnickname !== NULL) {
<a name="l01880"></a>01880             <span class="comment">// Find the dn of the user</span>
<a name="l01881"></a>01881             $user=$this-&gt;<a class="code" href="classadLDAP.html#a30dbd0754ece0df04bae672a7712dfd9" title="Get contact information.">contact_info</a>($distinguishedname,array(<span class="stringliteral">&quot;cn&quot;</span>,<span class="stringliteral">&quot;displayname&quot;</span>));
<a name="l01882"></a>01882             <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&quot;displayname&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01883"></a>01883             $mailnickname = $user[0][<span class="stringliteral">&#39;displayname&#39;</span>][0];
<a name="l01884"></a>01884         }
<a name="l01885"></a>01885 
<a name="l01886"></a>01886         $attributes = array(<span class="stringliteral">&quot;email&quot;</span>=&gt;$emailaddress,<span class="stringliteral">&quot;contact_email&quot;</span>=&gt;<span class="stringliteral">&quot;SMTP:&quot;</span> . $emailaddress,<span class="stringliteral">&quot;exchange_proxyaddress&quot;</span>=&gt;<span class="stringliteral">&quot;SMTP:&quot;</span> . $emailaddress,<span class="stringliteral">&quot;exchange_mailnickname&quot;</span>=&gt;$mailnickname);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888         <span class="comment">// Translate the update to the LDAP schema</span>
<a name="l01889"></a>01889         $mod=$this-&gt;<a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes);
<a name="l01890"></a>01890 
<a name="l01891"></a>01891         <span class="comment">// Check to see if this is an enabled status update</span>
<a name="l01892"></a>01892         <span class="keywordflow">if</span> (!$mod){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894         <span class="comment">// Do the update</span>
<a name="l01895"></a>01895         $result=ldap_modify($this-&gt;_conn,$distinguishedname,$mod);
<a name="l01896"></a>01896         <span class="keywordflow">if</span> ($result==<span class="keyword">false</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01897"></a>01897 
<a name="l01898"></a>01898         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l01899"></a>01899     }
<a name="l01900"></a>01900 
<a name="l01907"></a><a class="code" href="classadLDAP.html#a0daf8380bd5e971e7be7b5e809a63b9d">01907</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a0daf8380bd5e971e7be7b5e809a63b9d" title="Returns a list of Exchange Servers in the ConfigurationNamingContext of the domain...">exchange_servers</a>($attributes = array(<span class="stringliteral">&#39;cn&#39;</span>,<span class="stringliteral">&#39;distinguishedname&#39;</span>,<span class="stringliteral">&#39;serialnumber&#39;</span>)) {
<a name="l01908"></a>01908         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01909"></a>01909 
<a name="l01910"></a>01910         $configurationNamingContext = $this-&gt;<a class="code" href="classadLDAP.html#a8f3f5a8494ace203c59bd12ce0dfee1e" title="Get the RootDSE properties from a domain controller.">get_root_dse</a>(array(<span class="stringliteral">&#39;configurationnamingcontext&#39;</span>));
<a name="l01911"></a>01911         $sr = @ldap_search($this-&gt;_conn,$configurationNamingContext[0][<span class="stringliteral">&#39;configurationnamingcontext&#39;</span>][0],<span class="stringliteral">&#39;(&amp;(objectCategory=msExchExchangeServer))&#39;</span>,$attributes);
<a name="l01912"></a>01912         $entries = @ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01913"></a>01913         <span class="keywordflow">return</span> $entries;
<a name="l01914"></a>01914     }
<a name="l01915"></a>01915 
<a name="l01924"></a><a class="code" href="classadLDAP.html#a30a9bc1229163364de777faeecfa4759">01924</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a30a9bc1229163364de777faeecfa4759" title="Returns a list of Storage Groups in Exchange for a given mail server.">exchange_storage_groups</a>($exchangeServer, $attributes = array(<span class="stringliteral">&#39;cn&#39;</span>,<span class="stringliteral">&#39;distinguishedname&#39;</span>), $recursive = NULL) {
<a name="l01925"></a>01925         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01926"></a>01926         <span class="keywordflow">if</span> ($exchangeServer===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [exchangeServer]&quot;</span>); }
<a name="l01927"></a>01927         <span class="keywordflow">if</span> ($recursive===NULL){ $recursive=$this-&gt;_recursive_groups; }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929         $filter = <span class="stringliteral">&#39;(&amp;(objectCategory=msExchStorageGroup))&#39;</span>;
<a name="l01930"></a>01930         $sr=@ldap_search($this-&gt;_conn, $exchangeServer, $filter, $attributes);
<a name="l01931"></a>01931         $entries = @ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01932"></a>01932 
<a name="l01933"></a>01933         <span class="keywordflow">if</span> ($recursive === <span class="keyword">true</span>) {
<a name="l01934"></a>01934             <span class="keywordflow">for</span> ($i=0; $i&lt;$entries[<span class="stringliteral">&#39;count&#39;</span>]; $i++) {
<a name="l01935"></a>01935                 $entries[$i][<span class="stringliteral">&#39;msexchprivatemdb&#39;</span>] = $this-&gt;<a class="code" href="classadLDAP.html#aa4b70b0c5a7014cc0c5f43bd4bb76bdd" title="Returns a list of Databases within any given storage group in Exchange for a given...">exchange_storage_databases</a>($entries[$i][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0]);
<a name="l01936"></a>01936             }
<a name="l01937"></a>01937         }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939         <span class="keywordflow">return</span> $entries;
<a name="l01940"></a>01940     }
<a name="l01941"></a>01941 
<a name="l01949"></a><a class="code" href="classadLDAP.html#aa4b70b0c5a7014cc0c5f43bd4bb76bdd">01949</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#aa4b70b0c5a7014cc0c5f43bd4bb76bdd" title="Returns a list of Databases within any given storage group in Exchange for a given...">exchange_storage_databases</a>($storageGroup, $attributes = array(<span class="stringliteral">&#39;cn&#39;</span>,<span class="stringliteral">&#39;distinguishedname&#39;</span>,<span class="stringliteral">&#39;displayname&#39;</span>)) {
<a name="l01950"></a>01950         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01951"></a>01951         <span class="keywordflow">if</span> ($storageGroup===NULL){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [storageGroup]&quot;</span>); }
<a name="l01952"></a>01952 
<a name="l01953"></a>01953         $filter = <span class="stringliteral">&#39;(&amp;(objectCategory=msExchPrivateMDB))&#39;</span>;
<a name="l01954"></a>01954         $sr=@ldap_search($this-&gt;_conn, $storageGroup, $filter, $attributes);
<a name="l01955"></a>01955         $entries = @ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01956"></a>01956         <span class="keywordflow">return</span> $entries;
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958 
<a name="l01959"></a>01959     <span class="comment">//************************************************************************************************************</span>
<a name="l01960"></a>01960     <span class="comment">// SERVER FUNCTIONS</span>
<a name="l01961"></a>01961 
<a name="l01967"></a><a class="code" href="classadLDAP.html#a295472794438dc1e15f5b833dbece574">01967</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a295472794438dc1e15f5b833dbece574" title="Find the Base DN of your domain controller.">find_base_dn</a>() {
<a name="l01968"></a>01968         $namingContext = $this-&gt;<a class="code" href="classadLDAP.html#a8f3f5a8494ace203c59bd12ce0dfee1e" title="Get the RootDSE properties from a domain controller.">get_root_dse</a>(array(<span class="stringliteral">&#39;defaultnamingcontext&#39;</span>));
<a name="l01969"></a>01969         <span class="keywordflow">return</span> $namingContext[0][<span class="stringliteral">&#39;defaultnamingcontext&#39;</span>][0];
<a name="l01970"></a>01970     }
<a name="l01971"></a>01971 
<a name="l01978"></a><a class="code" href="classadLDAP.html#a8f3f5a8494ace203c59bd12ce0dfee1e">01978</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a8f3f5a8494ace203c59bd12ce0dfee1e" title="Get the RootDSE properties from a domain controller.">get_root_dse</a>($attributes = array(<span class="stringliteral">&quot;*&quot;</span>, <span class="stringliteral">&quot;+&quot;</span>)) {
<a name="l01979"></a>01979         <span class="keywordflow">if</span> (!$this-&gt;_bind){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l01980"></a>01980 
<a name="l01981"></a>01981         $sr = @ldap_read($this-&gt;_conn, NULL, <span class="stringliteral">&#39;objectClass=*&#39;</span>, $attributes);
<a name="l01982"></a>01982         $entries = @ldap_get_entries($this-&gt;_conn, $sr);
<a name="l01983"></a>01983         <span class="keywordflow">return</span> $entries;
<a name="l01984"></a>01984     }
<a name="l01985"></a>01985 
<a name="l01986"></a>01986     <span class="comment">//************************************************************************************************************</span>
<a name="l01987"></a>01987     <span class="comment">// UTILITY FUNCTIONS (Many of these functions are protected and can only be called from within the class)</span>
<a name="l01988"></a>01988 
<a name="l01998"></a><a class="code" href="classadLDAP.html#a6cc8d6aab2845757c448a0c8adb1298e">01998</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a6cc8d6aab2845757c448a0c8adb1298e" title="Get last error from Active Directory.">get_last_error</a>() {
<a name="l01999"></a>01999         <span class="keywordflow">return</span> @ldap_error($this-&gt;_conn);
<a name="l02000"></a>02000     }
<a name="l02001"></a>02001 
<a name="l02007"></a><a class="code" href="classadLDAP.html#a95d5149b1ad5bc848445f1049a252d41">02007</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a95d5149b1ad5bc848445f1049a252d41" title="Detect LDAP support in php.">ldap_supported</a>() {
<a name="l02008"></a>02008         <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;ldap_connect&#39;</span>)) {
<a name="l02009"></a>02009             <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l02010"></a>02010         }
<a name="l02011"></a>02011         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013 
<a name="l02020"></a><a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403">02020</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#ad3669f282a19df6df358643e634a9403" title="Schema.">adldap_schema</a>($attributes){
<a name="l02021"></a>02021 
<a name="l02022"></a>02022         <span class="comment">// LDAP doesn&#39;t like NULL attributes, only set them if they have values</span>
<a name="l02023"></a>02023         <span class="comment">// If you wish to remove an attribute you should set it to a space</span>
<a name="l02024"></a>02024         <span class="comment">// TO DO: Adapt user_modify to use ldap_mod_delete to remove a NULL attribute</span>
<a name="l02025"></a>02025         $mod=array();
<a name="l02026"></a>02026 
<a name="l02027"></a>02027         <span class="comment">// Check every attribute to see if it contains 8bit characters and then UTF8 encode them</span>
<a name="l02028"></a>02028         array_walk($attributes, array($this, <span class="stringliteral">&#39;encode8bit&#39;</span>));
<a name="l02029"></a>02029 
<a name="l02030"></a>02030         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;address_city&quot;</span>]){ $mod[<span class="stringliteral">&quot;l&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;address_city&quot;</span>]; }
<a name="l02031"></a>02031         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;address_code&quot;</span>]){ $mod[<span class="stringliteral">&quot;postalCode&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;address_code&quot;</span>]; }
<a name="l02032"></a>02032         <span class="comment">//if ($attributes[&quot;address_country&quot;]){ $mod[&quot;countryCode&quot;][0]=$attributes[&quot;address_country&quot;]; } // use country codes?</span>
<a name="l02033"></a>02033         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;address_country&quot;</span>]){ $mod[<span class="stringliteral">&quot;c&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;address_country&quot;</span>]; }
<a name="l02034"></a>02034         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;address_pobox&quot;</span>]){ $mod[<span class="stringliteral">&quot;postOfficeBox&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;address_pobox&quot;</span>]; }
<a name="l02035"></a>02035         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;address_state&quot;</span>]){ $mod[<span class="stringliteral">&quot;st&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;address_state&quot;</span>]; }
<a name="l02036"></a>02036         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;address_street&quot;</span>]){ $mod[<span class="stringliteral">&quot;streetAddress&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;address_street&quot;</span>]; }
<a name="l02037"></a>02037         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;company&quot;</span>]){ $mod[<span class="stringliteral">&quot;company&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;company&quot;</span>]; }
<a name="l02038"></a>02038         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;change_password&quot;</span>]){ $mod[<span class="stringliteral">&quot;pwdLastSet&quot;</span>][0]=0; }
<a name="l02039"></a>02039         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;department&quot;</span>]){ $mod[<span class="stringliteral">&quot;department&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;department&quot;</span>]; }
<a name="l02040"></a>02040         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;description&quot;</span>]){ $mod[<span class="stringliteral">&quot;description&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;description&quot;</span>]; }
<a name="l02041"></a>02041         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;display_name&quot;</span>]){ $mod[<span class="stringliteral">&quot;displayName&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;display_name&quot;</span>]; }
<a name="l02042"></a>02042         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;email&quot;</span>]){ $mod[<span class="stringliteral">&quot;mail&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;email&quot;</span>]; }
<a name="l02043"></a>02043         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;expires&quot;</span>]){ $mod[<span class="stringliteral">&quot;accountExpires&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;expires&quot;</span>]; } <span class="comment">//unix epoch format?</span>
<a name="l02044"></a>02044         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;firstname&quot;</span>]){ $mod[<span class="stringliteral">&quot;givenName&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;firstname&quot;</span>]; }
<a name="l02045"></a>02045         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;home_directory&quot;</span>]){ $mod[<span class="stringliteral">&quot;homeDirectory&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;home_directory&quot;</span>]; }
<a name="l02046"></a>02046         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;home_drive&quot;</span>]){ $mod[<span class="stringliteral">&quot;homeDrive&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;home_drive&quot;</span>]; }
<a name="l02047"></a>02047         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;initials&quot;</span>]){ $mod[<span class="stringliteral">&quot;initials&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;initials&quot;</span>]; }
<a name="l02048"></a>02048         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;logon_name&quot;</span>]){ $mod[<span class="stringliteral">&quot;userPrincipalName&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;logon_name&quot;</span>]; }
<a name="l02049"></a>02049         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;manager&quot;</span>]){ $mod[<span class="stringliteral">&quot;manager&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;manager&quot;</span>]; }  <span class="comment">//UNTESTED ***Use DistinguishedName***</span>
<a name="l02050"></a>02050         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;office&quot;</span>]){ $mod[<span class="stringliteral">&quot;physicalDeliveryOfficeName&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;office&quot;</span>]; }
<a name="l02051"></a>02051         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;password&quot;</span>]){ $mod[<span class="stringliteral">&quot;unicodePwd&quot;</span>][0]=$this-&gt;<a class="code" href="classadLDAP.html#ab440140cf001c324d94837a9d187dd02" title="Encode a password for transmission over LDAP.">encode_password</a>($attributes[<span class="stringliteral">&quot;password&quot;</span>]); }
<a name="l02052"></a>02052         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;profile_path&quot;</span>]){ $mod[<span class="stringliteral">&quot;profilepath&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;profile_path&quot;</span>]; }
<a name="l02053"></a>02053         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;script_path&quot;</span>]){ $mod[<span class="stringliteral">&quot;scriptPath&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;script_path&quot;</span>]; }
<a name="l02054"></a>02054         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;surname&quot;</span>]){ $mod[<span class="stringliteral">&quot;sn&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;surname&quot;</span>]; }
<a name="l02055"></a>02055         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;title&quot;</span>]){ $mod[<span class="stringliteral">&quot;title&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;title&quot;</span>]; }
<a name="l02056"></a>02056         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;telephone&quot;</span>]){ $mod[<span class="stringliteral">&quot;telephoneNumber&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;telephone&quot;</span>]; }
<a name="l02057"></a>02057         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;mobile&quot;</span>]){ $mod[<span class="stringliteral">&quot;mobile&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;mobile&quot;</span>]; }
<a name="l02058"></a>02058         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;pager&quot;</span>]){ $mod[<span class="stringliteral">&quot;pager&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;pager&quot;</span>]; }
<a name="l02059"></a>02059         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;ipphone&quot;</span>]){ $mod[<span class="stringliteral">&quot;ipphone&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;ipphone&quot;</span>]; }
<a name="l02060"></a>02060         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;web_page&quot;</span>]){ $mod[<span class="stringliteral">&quot;wWWHomePage&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;web_page&quot;</span>]; }
<a name="l02061"></a>02061         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;fax&quot;</span>]){ $mod[<span class="stringliteral">&quot;facsimileTelephoneNumber&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;fax&quot;</span>]; }
<a name="l02062"></a>02062         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;enabled&quot;</span>]){ $mod[<span class="stringliteral">&quot;userAccountControl&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;enabled&quot;</span>]; }
<a name="l02063"></a>02063 
<a name="l02064"></a>02064         <span class="comment">// Distribution List specific schema</span>
<a name="l02065"></a>02065         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;group_sendpermission&quot;</span>]){ $mod[<span class="stringliteral">&quot;dlMemSubmitPerms&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;group_sendpermission&quot;</span>]; }
<a name="l02066"></a>02066         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;group_rejectpermission&quot;</span>]){ $mod[<span class="stringliteral">&quot;dlMemRejectPerms&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;group_rejectpermission&quot;</span>]; }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068         <span class="comment">// Exchange Schema</span>
<a name="l02069"></a>02069         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_homemdb&quot;</span>]){ $mod[<span class="stringliteral">&quot;homeMDB&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_homemdb&quot;</span>]; }
<a name="l02070"></a>02070         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_mailnickname&quot;</span>]){ $mod[<span class="stringliteral">&quot;mailNickname&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_mailnickname&quot;</span>]; }
<a name="l02071"></a>02071         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_proxyaddress&quot;</span>]){ $mod[<span class="stringliteral">&quot;proxyAddresses&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_proxyaddress&quot;</span>]; }
<a name="l02072"></a>02072         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_usedefaults&quot;</span>]){ $mod[<span class="stringliteral">&quot;mDBUseDefaults&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_usedefaults&quot;</span>]; }
<a name="l02073"></a>02073         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_policyexclude&quot;</span>]){ $mod[<span class="stringliteral">&quot;msExchPoliciesExcluded&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_policyexclude&quot;</span>]; }
<a name="l02074"></a>02074         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_policyinclude&quot;</span>]){ $mod[<span class="stringliteral">&quot;msExchPoliciesIncluded&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_policyinclude&quot;</span>]; }
<a name="l02075"></a>02075         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_addressbook&quot;</span>]){ $mod[<span class="stringliteral">&quot;showInAddressBook&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_addressbook&quot;</span>]; }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077         <span class="comment">// This schema is designed for contacts</span>
<a name="l02078"></a>02078         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;exchange_hidefromlists&quot;</span>]){ $mod[<span class="stringliteral">&quot;msExchHideFromAddressLists&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;exchange_hidefromlists&quot;</span>]; }
<a name="l02079"></a>02079         <span class="keywordflow">if</span> ($attributes[<span class="stringliteral">&quot;contact_email&quot;</span>]){ $mod[<span class="stringliteral">&quot;targetAddress&quot;</span>][0]=$attributes[<span class="stringliteral">&quot;contact_email&quot;</span>]; }
<a name="l02080"></a>02080 
<a name="l02081"></a>02081         <span class="comment">//echo (&quot;&lt;pre&gt;&quot;); print_r($mod);</span>
<a name="l02082"></a>02082         <span class="comment">/*</span>
<a name="l02083"></a>02083 <span class="comment">        // modifying a name is a bit fiddly</span>
<a name="l02084"></a>02084 <span class="comment">        if ($attributes[&quot;firstname&quot;] &amp;&amp; $attributes[&quot;surname&quot;]){</span>
<a name="l02085"></a>02085 <span class="comment">            $mod[&quot;cn&quot;][0]=$attributes[&quot;firstname&quot;].&quot; &quot;.$attributes[&quot;surname&quot;];</span>
<a name="l02086"></a>02086 <span class="comment">            $mod[&quot;displayname&quot;][0]=$attributes[&quot;firstname&quot;].&quot; &quot;.$attributes[&quot;surname&quot;];</span>
<a name="l02087"></a>02087 <span class="comment">            $mod[&quot;name&quot;][0]=$attributes[&quot;firstname&quot;].&quot; &quot;.$attributes[&quot;surname&quot;];</span>
<a name="l02088"></a>02088 <span class="comment">        }</span>
<a name="l02089"></a>02089 <span class="comment">        */</span>
<a name="l02090"></a>02090 
<a name="l02091"></a>02091         <span class="keywordflow">if</span> (count($mod)==0){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l02092"></a>02092         <span class="keywordflow">return</span> ($mod);
<a name="l02093"></a>02093     }
<a name="l02094"></a>02094 
<a name="l02107"></a><a class="code" href="classadLDAP.html#a4b6304f7c2d08529dd9cc8f06111ca2a">02107</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a4b6304f7c2d08529dd9cc8f06111ca2a" title="Coping with AD not returning the primary group http://support.microsoft.com/?kbid=321360...">group_cn</a>($gid){
<a name="l02108"></a>02108         <span class="keywordflow">if</span> ($gid===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l02109"></a>02109         $r=<span class="keyword">false</span>;
<a name="l02110"></a>02110 
<a name="l02111"></a>02111         $filter=<span class="stringliteral">&quot;(&amp;(objectCategory=group)(samaccounttype=&quot;</span>. ADLDAP_SECURITY_GLOBAL_GROUP .<span class="stringliteral">&quot;))&quot;</span>;
<a name="l02112"></a>02112         $fields=array(<span class="stringliteral">&quot;primarygrouptoken&quot;</span>,<span class="stringliteral">&quot;samaccountname&quot;</span>,<span class="stringliteral">&quot;distinguishedname&quot;</span>);
<a name="l02113"></a>02113         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l02114"></a>02114         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l02115"></a>02115 
<a name="l02116"></a>02116         <span class="keywordflow">for</span> ($i=0; $i&lt;$entries[<span class="stringliteral">&quot;count&quot;</span>]; $i++){
<a name="l02117"></a>02117             <span class="keywordflow">if</span> ($entries[$i][<span class="stringliteral">&quot;primarygrouptoken&quot;</span>][0]==$gid){
<a name="l02118"></a>02118                 $r=$entries[$i][<span class="stringliteral">&quot;distinguishedname&quot;</span>][0];
<a name="l02119"></a>02119                 $i=$entries[<span class="stringliteral">&quot;count&quot;</span>];
<a name="l02120"></a>02120             }
<a name="l02121"></a>02121         }
<a name="l02122"></a>02122 
<a name="l02123"></a>02123         <span class="keywordflow">return</span> ($r);
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125 
<a name="l02137"></a><a class="code" href="classadLDAP.html#a463259d457310dc99dd2619098686643">02137</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a463259d457310dc99dd2619098686643" title="Coping with AD not returning the primary group http://support.microsoft.com/?kbid=321360...">get_primary_group</a>($gid, $usersid){
<a name="l02138"></a>02138         <span class="keywordflow">if</span> ($gid===NULL || $usersid===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l02139"></a>02139         $r=<span class="keyword">false</span>;
<a name="l02140"></a>02140 
<a name="l02141"></a>02141         $gsid = substr_replace($usersid,pack(<span class="charliteral">&#39;V&#39;</span>,$gid),strlen($usersid)-4,4);
<a name="l02142"></a>02142         $filter=<span class="stringliteral">&#39;(objectsid=&#39;</span>.$this-&gt;getTextSID($gsid).<span class="charliteral">&#39;)&#39;</span>;
<a name="l02143"></a>02143         $fields=array(<span class="stringliteral">&quot;samaccountname&quot;</span>,<span class="stringliteral">&quot;distinguishedname&quot;</span>);
<a name="l02144"></a>02144         $sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
<a name="l02145"></a>02145         $entries = ldap_get_entries($this-&gt;_conn, $sr);
<a name="l02146"></a>02146 
<a name="l02147"></a>02147         <span class="keywordflow">return</span> $entries[0][<span class="stringliteral">&#39;distinguishedname&#39;</span>][0];
<a name="l02148"></a>02148      }
<a name="l02149"></a>02149 
<a name="l02156"></a><a class="code" href="classadLDAP.html#a7e51aeda655bed0cb30c8c1d84736ee1">02156</a>      <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a7e51aeda655bed0cb30c8c1d84736ee1" title="Convert a binary SID to a text SID.">getTextSID</a>($binsid) {
<a name="l02157"></a>02157         $hex_sid = bin2hex($binsid);
<a name="l02158"></a>02158         $rev = hexdec(substr($hex_sid, 0, 2));
<a name="l02159"></a>02159         $subcount = hexdec(substr($hex_sid, 2, 2));
<a name="l02160"></a>02160         $auth = hexdec(substr($hex_sid, 4, 12));
<a name="l02161"></a>02161         $result = <span class="stringliteral">&quot;$rev-$auth&quot;</span>;
<a name="l02162"></a>02162 
<a name="l02163"></a>02163         <span class="keywordflow">for</span> ($x=0;$x &lt; $subcount; $x++) {
<a name="l02164"></a>02164             $subauth[$x] =
<a name="l02165"></a>02165                 hexdec($this-&gt;<a class="code" href="classadLDAP.html#ae854a006bc20a1326cc3f2019303b570" title="Converts a little-endian hex number to one that hexdec() can convert.">little_endian</a>(substr($hex_sid, 16 + ($x * 8), 8)));
<a name="l02166"></a>02166                 $result .= <span class="stringliteral">&quot;-&quot;</span> . $subauth[$x];
<a name="l02167"></a>02167         }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169         <span class="comment">// Cheat by tacking on the S-</span>
<a name="l02170"></a>02170         <span class="keywordflow">return</span> <span class="stringliteral">&#39;S-&#39;</span> . $result;
<a name="l02171"></a>02171      }
<a name="l02172"></a>02172 
<a name="l02179"></a><a class="code" href="classadLDAP.html#ae854a006bc20a1326cc3f2019303b570">02179</a>      <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#ae854a006bc20a1326cc3f2019303b570" title="Converts a little-endian hex number to one that hexdec() can convert.">little_endian</a>($hex) {
<a name="l02180"></a>02180         $result = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02181"></a>02181         <span class="keywordflow">for</span> ($x = strlen($hex) - 2; $x &gt;= 0; $x = $x - 2) {
<a name="l02182"></a>02182             $result .= substr($hex, $x, 2);
<a name="l02183"></a>02183         }
<a name="l02184"></a>02184         <span class="keywordflow">return</span> $result;
<a name="l02185"></a>02185      }
<a name="l02186"></a>02186 
<a name="l02193"></a><a class="code" href="classadLDAP.html#ac31c9b3b782b23273c4b2cbdd2c2030f">02193</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#ac31c9b3b782b23273c4b2cbdd2c2030f" title="Converts a binary attribute to a string.">binary2text</a>($bin) {
<a name="l02194"></a>02194         $hex_guid = bin2hex($bin);
<a name="l02195"></a>02195         $hex_guid_to_guid_str = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02196"></a>02196         <span class="keywordflow">for</span>($k = 1; $k &lt;= 4; ++$k) {
<a name="l02197"></a>02197             $hex_guid_to_guid_str .= substr($hex_guid, 8 - 2 * $k, 2);
<a name="l02198"></a>02198         }
<a name="l02199"></a>02199         $hex_guid_to_guid_str .= <span class="charliteral">&#39;-&#39;</span>;
<a name="l02200"></a>02200         <span class="keywordflow">for</span>($k = 1; $k &lt;= 2; ++$k) {
<a name="l02201"></a>02201             $hex_guid_to_guid_str .= substr($hex_guid, 12 - 2 * $k, 2);
<a name="l02202"></a>02202         }
<a name="l02203"></a>02203         $hex_guid_to_guid_str .= <span class="charliteral">&#39;-&#39;</span>;
<a name="l02204"></a>02204         <span class="keywordflow">for</span>($k = 1; $k &lt;= 2; ++$k) {
<a name="l02205"></a>02205             $hex_guid_to_guid_str .= substr($hex_guid, 16 - 2 * $k, 2);
<a name="l02206"></a>02206         }
<a name="l02207"></a>02207         $hex_guid_to_guid_str .= <span class="charliteral">&#39;-&#39;</span> . substr($hex_guid, 16, 4);
<a name="l02208"></a>02208         $hex_guid_to_guid_str .= <span class="charliteral">&#39;-&#39;</span> . substr($hex_guid, 20);
<a name="l02209"></a>02209         <span class="keywordflow">return</span> strtoupper($hex_guid_to_guid_str);
<a name="l02210"></a>02210     }
<a name="l02211"></a>02211 
<a name="l02218"></a><a class="code" href="classadLDAP.html#a248f84636dbfbc288e288a6dc6f0b564">02218</a>     <span class="keyword">public</span> function <a class="code" href="classadLDAP.html#a248f84636dbfbc288e288a6dc6f0b564" title="Converts a binary GUID to a string GUID.">decodeGuid</a>($binaryGuid) {
<a name="l02219"></a>02219         <span class="keywordflow">if</span> ($binaryGuid === null){ <span class="keywordflow">return</span> (<span class="stringliteral">&quot;Missing compulsory field [binaryGuid]&quot;</span>); }
<a name="l02220"></a>02220 
<a name="l02221"></a>02221         $strGUID = $this-&gt;<a class="code" href="classadLDAP.html#ac31c9b3b782b23273c4b2cbdd2c2030f" title="Converts a binary attribute to a string.">binary2text</a>($binaryGuid);
<a name="l02222"></a>02222         <span class="keywordflow">return</span> ($strGUID);
<a name="l02223"></a>02223     }
<a name="l02224"></a>02224 
<a name="l02231"></a><a class="code" href="classadLDAP.html#af47e9763c396a4724f7d01d5334d5c35">02231</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#af47e9763c396a4724f7d01d5334d5c35" title="Converts a string GUID to a hexdecimal value so it can be queried.">strguid2hex</a>($strGUID) {
<a name="l02232"></a>02232         $strGUID = str_replace(<span class="charliteral">&#39;-&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $strGUID);
<a name="l02233"></a>02233 
<a name="l02234"></a>02234         $octet_str = <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 6, 2);
<a name="l02235"></a>02235         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 4, 2);
<a name="l02236"></a>02236         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 2, 2);
<a name="l02237"></a>02237         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 0, 2);
<a name="l02238"></a>02238         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 10, 2);
<a name="l02239"></a>02239         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 8, 2);
<a name="l02240"></a>02240         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 14, 2);
<a name="l02241"></a>02241         $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, 12, 2);
<a name="l02242"></a>02242         <span class="comment">//$octet_str .= &#39;\\&#39; . substr($strGUID, 16, strlen($strGUID));</span>
<a name="l02243"></a>02243         <span class="keywordflow">for</span> ($i=16; $i&lt;=(strlen($strGUID)-2); $i++) {
<a name="l02244"></a>02244             <span class="keywordflow">if</span> (($i % 2) == 0) {
<a name="l02245"></a>02245                 $octet_str .= <span class="charliteral">&#39;\\&#39;</span> . substr($strGUID, $i, 2);
<a name="l02246"></a>02246             }
<a name="l02247"></a>02247         }
<a name="l02248"></a>02248 
<a name="l02249"></a>02249         <span class="keywordflow">return</span> $octet_str;
<a name="l02250"></a>02250     }
<a name="l02251"></a>02251 
<a name="l02260"></a><a class="code" href="classadLDAP.html#ab581027573b7b10cbc72fbff8a458196">02260</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#ab581027573b7b10cbc72fbff8a458196" title="Obtain the user&amp;#39;s distinguished name based on their userid.">user_dn</a>($username,$isGUID=<span class="keyword">false</span>){
<a name="l02261"></a>02261         $user=$this-&gt;<a class="code" href="classadLDAP.html#a8cfc3b3fd7602d1db1514035de67572c" title="Find information about the users.">user_info</a>($username,array(<span class="stringliteral">&quot;cn&quot;</span>),$isGUID);
<a name="l02262"></a>02262         <span class="keywordflow">if</span> ($user[0][<span class="stringliteral">&quot;dn&quot;</span>]===NULL){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l02263"></a>02263         $user_dn=$user[0][<span class="stringliteral">&quot;dn&quot;</span>];
<a name="l02264"></a>02264         <span class="keywordflow">return</span> ($user_dn);
<a name="l02265"></a>02265     }
<a name="l02266"></a>02266 
<a name="l02273"></a><a class="code" href="classadLDAP.html#ab440140cf001c324d94837a9d187dd02">02273</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#ab440140cf001c324d94837a9d187dd02" title="Encode a password for transmission over LDAP.">encode_password</a>($password){
<a name="l02274"></a>02274         $password=<span class="stringliteral">&quot;\&quot;&quot;</span>.$password.<span class="stringliteral">&quot;\&quot;&quot;</span>;
<a name="l02275"></a>02275         $encoded=<span class="stringliteral">&quot;&quot;</span>;
<a name="l02276"></a>02276         <span class="keywordflow">for</span> ($i=0; $i &lt;strlen($password); $i++){ $encoded.=<span class="stringliteral">&quot;{$password{$i}}\000&quot;</span>; }
<a name="l02277"></a>02277         <span class="keywordflow">return</span> ($encoded);
<a name="l02278"></a>02278     }
<a name="l02279"></a>02279 
<a name="l02290"></a><a class="code" href="classadLDAP.html#a1e51acd69fce31162fa273fcf20851f6">02290</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a1e51acd69fce31162fa273fcf20851f6" title="Escape strings for the use in LDAP filters.">ldap_slashes</a>($str){
<a name="l02291"></a>02291         <span class="keywordflow">return</span> preg_replace(<span class="stringliteral">&#39;/([\x00-\x1F\*\(\)\\\\])/e&#39;</span>,
<a name="l02292"></a>02292                             <span class="stringliteral">&#39;&quot;\\\\\&quot;.join(&quot;&quot;,unpack(&quot;H2&quot;,&quot;$1&quot;))&#39;</span>,
<a name="l02293"></a>02293                             $str);
<a name="l02294"></a>02294     }
<a name="l02295"></a>02295 
<a name="l02301"></a><a class="code" href="classadLDAP.html#a6a047c7553dc601d222ebd520d207449">02301</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a6a047c7553dc601d222ebd520d207449" title="Select a random domain controller from your domain controller array.">random_controller</a>(){
<a name="l02302"></a>02302         mt_srand(doubleval(microtime()) * 100000000); <span class="comment">// For older PHP versions</span>
<a name="l02303"></a>02303         <span class="keywordflow">return</span> ($this-&gt;_domain_controllers[array_rand($this-&gt;_domain_controllers)]);
<a name="l02304"></a>02304     }
<a name="l02305"></a>02305 
<a name="l02312"></a><a class="code" href="classadLDAP.html#af8031d99c257e2a0563b8acf2761282b">02312</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#af8031d99c257e2a0563b8acf2761282b" title="Account control options.">account_control</a>($options){
<a name="l02313"></a>02313         $val=0;
<a name="l02314"></a>02314 
<a name="l02315"></a>02315         <span class="keywordflow">if</span> (is_array($options)){
<a name="l02316"></a>02316             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;SCRIPT&quot;</span>,$options)){ $val=$val+1; }
<a name="l02317"></a>02317             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;ACCOUNTDISABLE&quot;</span>,$options)){ $val=$val+2; }
<a name="l02318"></a>02318             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;HOMEDIR_REQUIRED&quot;</span>,$options)){ $val=$val+8; }
<a name="l02319"></a>02319             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;LOCKOUT&quot;</span>,$options)){ $val=$val+16; }
<a name="l02320"></a>02320             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;PASSWD_NOTREQD&quot;</span>,$options)){ $val=$val+32; }
<a name="l02321"></a>02321             <span class="comment">//PASSWD_CANT_CHANGE Note You cannot assign this permission by directly modifying the UserAccountControl attribute.</span>
<a name="l02322"></a>02322             <span class="comment">//For information about how to set the permission programmatically, see the &quot;Property flag descriptions&quot; section.</span>
<a name="l02323"></a>02323             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;ENCRYPTED_TEXT_PWD_ALLOWED&quot;</span>,$options)){ $val=$val+128; }
<a name="l02324"></a>02324             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;TEMP_DUPLICATE_ACCOUNT&quot;</span>,$options)){ $val=$val+256; }
<a name="l02325"></a>02325             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;NORMAL_ACCOUNT&quot;</span>,$options)){ $val=$val+512; }
<a name="l02326"></a>02326             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;INTERDOMAIN_TRUST_ACCOUNT&quot;</span>,$options)){ $val=$val+2048; }
<a name="l02327"></a>02327             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;WORKSTATION_TRUST_ACCOUNT&quot;</span>,$options)){ $val=$val+4096; }
<a name="l02328"></a>02328             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;SERVER_TRUST_ACCOUNT&quot;</span>,$options)){ $val=$val+8192; }
<a name="l02329"></a>02329             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;DONT_EXPIRE_PASSWORD&quot;</span>,$options)){ $val=$val+65536; }
<a name="l02330"></a>02330             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;MNS_LOGON_ACCOUNT&quot;</span>,$options)){ $val=$val+131072; }
<a name="l02331"></a>02331             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;SMARTCARD_REQUIRED&quot;</span>,$options)){ $val=$val+262144; }
<a name="l02332"></a>02332             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;TRUSTED_FOR_DELEGATION&quot;</span>,$options)){ $val=$val+524288; }
<a name="l02333"></a>02333             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;NOT_DELEGATED&quot;</span>,$options)){ $val=$val+1048576; }
<a name="l02334"></a>02334             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;USE_DES_KEY_ONLY&quot;</span>,$options)){ $val=$val+2097152; }
<a name="l02335"></a>02335             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;DONT_REQ_PREAUTH&quot;</span>,$options)){ $val=$val+4194304; }
<a name="l02336"></a>02336             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;PASSWORD_EXPIRED&quot;</span>,$options)){ $val=$val+8388608; }
<a name="l02337"></a>02337             <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&quot;TRUSTED_TO_AUTH_FOR_DELEGATION&quot;</span>,$options)){ $val=$val+16777216; }
<a name="l02338"></a>02338         }
<a name="l02339"></a>02339         <span class="keywordflow">return</span> ($val);
<a name="l02340"></a>02340     }
<a name="l02341"></a>02341 
<a name="l02348"></a><a class="code" href="classadLDAP.html#a131b2784f0f42c19a82bd8110bbcd52e">02348</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a131b2784f0f42c19a82bd8110bbcd52e" title="Take an LDAP query and return the nice names, without all the LDAP prefixes (eg.">nice_names</a>($groups){
<a name="l02349"></a>02349 
<a name="l02350"></a>02350         $group_array=array();
<a name="l02351"></a>02351         <span class="keywordflow">for</span> ($i=0; $i&lt;$groups[<span class="stringliteral">&quot;count&quot;</span>]; $i++){ <span class="comment">// For each group</span>
<a name="l02352"></a>02352             $line=$groups[$i];
<a name="l02353"></a>02353 
<a name="l02354"></a>02354             <span class="keywordflow">if</span> (strlen($line)&gt;0){
<a name="l02355"></a>02355                 <span class="comment">// More presumptions, they&#39;re all prefixed with CN=</span>
<a name="l02356"></a>02356                 <span class="comment">// so we ditch the first three characters and the group</span>
<a name="l02357"></a>02357                 <span class="comment">// name goes up to the first comma</span>
<a name="l02358"></a>02358                 $bits=explode(<span class="stringliteral">&quot;,&quot;</span>,$line);
<a name="l02359"></a>02359                 $group_array[]=substr($bits[0],3,(strlen($bits[0])-3));
<a name="l02360"></a>02360             }
<a name="l02361"></a>02361         }
<a name="l02362"></a>02362         <span class="keywordflow">return</span> ($group_array);
<a name="l02363"></a>02363     }
<a name="l02364"></a>02364 
<a name="l02372"></a><a class="code" href="classadLDAP.html#a3b937e0fc298242125f7743950bf7ecf">02372</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a3b937e0fc298242125f7743950bf7ecf" title="Delete a distinguished name from Active Directory You should never need to call this...">dn_delete</a>($dn){
<a name="l02373"></a>02373         $result=ldap_delete($this-&gt;_conn, $dn);
<a name="l02374"></a>02374         <span class="keywordflow">if</span> ($result!=<span class="keyword">true</span>){ <span class="keywordflow">return</span> (<span class="keyword">false</span>); }
<a name="l02375"></a>02375         <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l02376"></a>02376     }
<a name="l02377"></a>02377 
<a name="l02385"></a><a class="code" href="classadLDAP.html#a18c25e51fff2daca9f090818dcc6cc27">02385</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#a18c25e51fff2daca9f090818dcc6cc27" title="Convert a boolean value to a string You should never need to call this yourself.">bool2str</a>($bool) {
<a name="l02386"></a>02386         <span class="keywordflow">return</span> ($bool) ? <span class="stringliteral">&#39;TRUE&#39;</span> : <span class="stringliteral">&#39;FALSE&#39;</span>;
<a name="l02387"></a>02387     }
<a name="l02388"></a>02388 
<a name="l02392"></a><a class="code" href="classadLDAP.html#ab3ed35fa32ed2e5cabb8de262f9372f8">02392</a>     <span class="keyword">protected</span> function <a class="code" href="classadLDAP.html#ab3ed35fa32ed2e5cabb8de262f9372f8" title="Convert 8bit characters e.g.">encode8bit</a>(&amp;$item, $key) {
<a name="l02393"></a>02393         $encode = <span class="keyword">false</span>;
<a name="l02394"></a>02394         <span class="keywordflow">if</span> (is_string($item)) {
<a name="l02395"></a>02395             <span class="keywordflow">for</span> ($i=0; $i&lt;strlen($item); $i++) {
<a name="l02396"></a>02396                 <span class="keywordflow">if</span> (ord($item[$i]) &gt;&gt; 7) {
<a name="l02397"></a>02397                     $encode = <span class="keyword">true</span>;
<a name="l02398"></a>02398                 }
<a name="l02399"></a>02399             }
<a name="l02400"></a>02400         }
<a name="l02401"></a>02401         <span class="keywordflow">if</span> ($encode === <span class="keyword">true</span> &amp;&amp; $key != <span class="stringliteral">&#39;password&#39;</span>) {
<a name="l02402"></a>02402             $item = utf8_encode($item);
<a name="l02403"></a>02403         }
<a name="l02404"></a>02404     }
<a name="l02405"></a>02405 }
<a name="l02406"></a>02406 
<a name="l02420"></a><a class="code" href="classadLDAPException.html">02420</a> <span class="keyword">class </span><a class="code" href="classadLDAPException.html" title="adLDAP Exception Handler">adLDAPException</a> <span class="keyword">extends</span> Exception {}
<a name="l02421"></a>02421 
<a name="l02422"></a>02422 ?&gt;
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
