<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/lib/util/agStaffImportNormalization.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/lib/util/agStaffImportNormalization.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00023"></a><a class="code" href="classagStaffImportNormalization.html">00023</a> <span class="keyword">class </span><a class="code" href="classagStaffImportNormalization.html" title="A Staff data import class.">agStaffImportNormalization</a> <span class="keyword">extends</span> <a class="code" href="classagImportNormalization.html" title="Normalizing import data.">agImportNormalization</a>
<a name="l00024"></a>00024 {
<a name="l00025"></a>00025 
<a name="l00032"></a><a class="code" href="classagStaffImportNormalization.html#ac2005829fcb2e751c01c727cf932d454">00032</a>   <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="classagStaffImportNormalization.html#ac2005829fcb2e751c01c727cf932d454" title="Method to return an instance of this class.">getInstance</a>($tempTable, $logEventLevel = NULL)
<a name="l00033"></a>00033   {
<a name="l00034"></a>00034     $self = <span class="keyword">new</span> <span class="keyword">self</span>();
<a name="l00035"></a>00035     $self-&gt;__init($tempTable, $logEventLevel);
<a name="l00036"></a>00036     <span class="keywordflow">return</span> $self;
<a name="l00037"></a>00037   }
<a name="l00038"></a>00038 
<a name="l00044"></a><a class="code" href="classagStaffImportNormalization.html#af55418483f3bc01f91846c4318e30a95">00044</a>   <span class="keyword">public</span> function <a class="code" href="classagStaffImportNormalization.html#af55418483f3bc01f91846c4318e30a95" title="Method to initialize this class.">__init</a>($tempTable = NULL, $logEventLevel = NULL)
<a name="l00045"></a>00045   {
<a name="l00046"></a>00046     <span class="keywordflow">if</span> (is_null($tempTable)) {
<a name="l00047"></a>00047       $tempTable = <span class="stringliteral">&#39;temp_staff_import&#39;</span>;
<a name="l00048"></a>00048     }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="comment">// DO NOT REMOVE</span>
<a name="l00051"></a>00051     <a class="code" href="classagStaffImportNormalization.html#af55418483f3bc01f91846c4318e30a95" title="Method to initialize this class.">parent::__init</a>($tempTable, $logEventLevel);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     <span class="comment">// set the import components array as a class property</span>
<a name="l00054"></a>00054     $this-&gt;<a class="code" href="classagStaffImportNormalization.html#af97224eac474051b1c3756647d87f380">setImportComponents</a>();
<a name="l00055"></a>00055     $this-&gt;tempTableOptions = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;MYISAM&#39;</span>, <span class="stringliteral">&#39;charset&#39;</span> =&gt; <span class="stringliteral">&#39;utf8&#39;</span>);
<a name="l00056"></a>00056     $this-&gt;importHeaderStrictValidation = TRUE;
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     $this-&gt;eh-&gt;setErrThreshold(intval(<a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;import_error_threshold&#39;</span>)));
<a name="l00059"></a>00059   }
<a name="l00060"></a>00060 
<a name="l00064"></a><a class="code" href="classagStaffImportNormalization.html#a7dbe6da9b34414907bfc8a8bd86e70b6">00064</a>   <span class="keyword">public</span> function <a class="code" href="classagStaffImportNormalization.html#a7dbe6da9b34414907bfc8a8bd86e70b6" title="Imports staff from an excel file.">processXlsImportFile</a>($importFile)
<a name="l00065"></a>00065   {
<a name="l00066"></a>00066     <span class="comment">// process the excel file and create a temporary table</span>
<a name="l00067"></a>00067     <a class="code" href="classagStaffImportNormalization.html#a7dbe6da9b34414907bfc8a8bd86e70b6" title="Imports staff from an excel file.">parent::processXlsImportFile</a>($importFile);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="comment">// start our iterator and initialize our select query</span>
<a name="l00070"></a>00070     $this-&gt;<a class="code" href="classagImportNormalization.html#a1fadece8d6d0a002a469d6bfdc6dacdc" title="Method to initiate the import query from temp.">tempToRaw</a>($this-&gt;<a class="code" href="classagStaffImportNormalization.html#a021a0513617a72bc554d5346d7a258c7" title="Method to dynamically build a (mostly) static tempSelectQuery.">buildTempSelectQuery</a>());
<a name="l00071"></a>00071   }
<a name="l00072"></a>00072 
<a name="l00076"></a><a class="code" href="classagStaffImportNormalization.html#ae9f22ced03f73df7b8ffcf0353052590">00076</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#ae9f22ced03f73df7b8ffcf0353052590" title="Method to set the unprocessed records basename.">setUnprocessedBaseName</a>()
<a name="l00077"></a>00077   {
<a name="l00078"></a>00078     $this-&gt;unprocessedBaseName = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;unprocessed_staff_import_basename&#39;</span>);
<a name="l00079"></a>00079   }
<a name="l00080"></a>00080 
<a name="l00084"></a><a class="code" href="classagStaffImportNormalization.html#a159388e4e06df3e05d317461433b6834">00084</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a159388e4e06df3e05d317461433b6834" title="Method to set the dynamic field type.">setDynamicFieldType</a>()
<a name="l00085"></a>00085   {
<a name="l00086"></a>00086     $this-&gt;dynamicFieldType = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088 
<a name="l00093"></a><a class="code" href="classagStaffImportNormalization.html#a204c4f569cc50bf3e5c3d00b9ce90860">00093</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a204c4f569cc50bf3e5c3d00b9ce90860" title="Method to extend the import specification to include dynamic columns from the file...">addDynamicColumns</a>(array $importFileHeaders)
<a name="l00094"></a>00094   {
<a name="l00095"></a>00095     $dynamicColumns = array_diff($importFileHeaders, array_keys($this-&gt;importSpec));
<a name="l00096"></a>00096     <span class="keywordflow">foreach</span> ($dynamicColumns as $column) {
<a name="l00097"></a>00097       $this-&gt;importSpec[$column] = $this-&gt;dynamicFieldType;
<a name="l00098"></a>00098       $this-&gt;specStrLengths[$column] = <a class="code" href="classagImportHelper.html#aee8ec48641c860f762b2d26855cf4c89">self::getSpecificationStrLen</a>($this-&gt;dynamicFieldType);
<a name="l00099"></a>00099       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Adding dynamic column {&#39;</span> . $column . <span class="stringliteral">&#39;} to the import specification.&#39;</span>);
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101   }
<a name="l00102"></a>00102 
<a name="l00108"></a><a class="code" href="classagStaffImportNormalization.html#aa57e61b80d78e6b909551f0ef590bcdd">00108</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#aa57e61b80d78e6b909551f0ef590bcdd" title="Method to set the classes&amp;#39; import specification.">setImportSpec</a>()
<a name="l00109"></a>00109   {
<a name="l00110"></a>00110     $importSpec[<span class="stringliteral">&#39;entity_id&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;integer&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 6);
<a name="l00111"></a>00111     $importSpec[<span class="stringliteral">&#39;first_name&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00112"></a>00112     $importSpec[<span class="stringliteral">&#39;middle_name&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00113"></a>00113     $importSpec[<span class="stringliteral">&#39;last_name&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00114"></a>00114     $importSpec[<span class="stringliteral">&#39;mobile_phone&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 16);
<a name="l00115"></a>00115     $importSpec[<span class="stringliteral">&#39;home_phone&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 16);
<a name="l00116"></a>00116     $importSpec[<span class="stringliteral">&#39;home_email&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00117"></a>00117     $importSpec[<span class="stringliteral">&#39;work_phone&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 16);
<a name="l00118"></a>00118     $importSpec[<span class="stringliteral">&#39;work_email&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00119"></a>00119     $importSpec[<span class="stringliteral">&#39;home_address_line_1&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00120"></a>00120     $importSpec[<span class="stringliteral">&#39;home_address_line_2&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00121"></a>00121     $importSpec[<span class="stringliteral">&#39;home_address_city&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00122"></a>00122     $importSpec[<span class="stringliteral">&#39;home_address_state&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00123"></a>00123     $importSpec[<span class="stringliteral">&#39;home_address_zip&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 5);
<a name="l00124"></a>00124     $importSpec[<span class="stringliteral">&#39;home_address_country&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 128);
<a name="l00125"></a>00125     $importSpec[<span class="stringliteral">&#39;home_latitude&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;decimal&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 12, <span class="stringliteral">&#39;scale&#39;</span> =&gt; 8);
<a name="l00126"></a>00126     $importSpec[<span class="stringliteral">&#39;home_longitude&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;decimal&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 12, <span class="stringliteral">&#39;scale&#39;</span> =&gt; 8);
<a name="l00127"></a>00127     $importSpec[<span class="stringliteral">&#39;work_address_line_1&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00128"></a>00128     $importSpec[<span class="stringliteral">&#39;work_address_line_2&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00129"></a>00129     $importSpec[<span class="stringliteral">&#39;work_address_city&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00130"></a>00130     $importSpec[<span class="stringliteral">&#39;work_address_state&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255);
<a name="l00131"></a>00131     $importSpec[<span class="stringliteral">&#39;work_address_zip&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 5);
<a name="l00132"></a>00132     $importSpec[<span class="stringliteral">&#39;work_address_country&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 128);
<a name="l00133"></a>00133     $importSpec[<span class="stringliteral">&#39;work_latitude&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;decimal&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 12, <span class="stringliteral">&#39;scale&#39;</span> =&gt; 8);
<a name="l00134"></a>00134     $importSpec[<span class="stringliteral">&#39;work_longitude&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;decimal&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 12, <span class="stringliteral">&#39;scale&#39;</span> =&gt; 8);
<a name="l00135"></a>00135     $importSpec[<span class="stringliteral">&#39;organization&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 128);
<a name="l00136"></a>00136     $importSpec[<span class="stringliteral">&#39;resource_type&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00137"></a>00137     $importSpec[<span class="stringliteral">&#39;resource_status&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 30);
<a name="l00138"></a>00138     $importSpec[<span class="stringliteral">&#39;language_1&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 128); <span class="comment">//ag_person_mj_ag_language</span>
<a name="l00139"></a>00139     $importSpec[<span class="stringliteral">&#39;l1_speak&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64); <span class="comment">//ag_person_language_competency</span>
<a name="l00140"></a>00140     $importSpec[<span class="stringliteral">&#39;l1_read&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00141"></a>00141     $importSpec[<span class="stringliteral">&#39;l1_write&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00142"></a>00142     $importSpec[<span class="stringliteral">&#39;language_2&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 128); <span class="comment">//ag_person_mj_ag_language</span>
<a name="l00143"></a>00143     $importSpec[<span class="stringliteral">&#39;l2_speak&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64); <span class="comment">//ag_person_language_competency</span>
<a name="l00144"></a>00144     $importSpec[<span class="stringliteral">&#39;l2_read&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00145"></a>00145     $importSpec[<span class="stringliteral">&#39;l2_write&#39;</span>] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;string&quot;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="comment">// set the class property to the newly created </span>
<a name="l00148"></a>00148     $this-&gt;importSpec = $importSpec;
<a name="l00149"></a>00149   }
<a name="l00150"></a>00150 
<a name="l00159"></a><a class="code" href="classagStaffImportNormalization.html#a1e8aa7ce79ee831096e7d54404005275">00159</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a1e8aa7ce79ee831096e7d54404005275" title="Method to clean a column name, removing leading and trailing spaces, special characters...">cleanColumnName</a>($columnName)
<a name="l00160"></a>00160   {
<a name="l00161"></a>00161     <span class="comment">// keep this in case we need to throw an error</span>
<a name="l00162"></a>00162     $oldColumnName = $columnName;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="comment">// trim once, for good measure, then replace spaces with underscores</span>
<a name="l00165"></a>00165     $columnName = trim(strtolower($columnName));
<a name="l00166"></a>00166     $columnName = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;_&#39;</span>, trim(strtolower($columnName)));
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="comment">// many db&#39;s complain about numbers prepending column names</span>
<a name="l00169"></a>00169     $columnName = preg_replace(<span class="stringliteral">&#39;/^\d+/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $columnName);
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="comment">// filter out all special characters</span>
<a name="l00172"></a>00172     $columnName = preg_replace(<span class="stringliteral">&#39;/[\W]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $columnName);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">// reduce any duplicate underscore pairs we may have created</span>
<a name="l00175"></a>00175     $columnName = preg_replace(<span class="stringliteral">&#39;/__+/&#39;</span>, <span class="charliteral">&#39;_&#39;</span>, $columnName);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">// lastly, in case this method created an unusable empty string, we throw (eg, fatal)</span>
<a name="l00178"></a>00178     <span class="keywordflow">if</span> (strlen($columnName) == 0) {
<a name="l00179"></a>00179       $errMsg = <span class="stringliteral">&quot;Column name {$oldColumnName} could not be parsed.&quot;</span>;
<a name="l00180"></a>00180       $this-&gt;eh-&gt;logCrit($errMsg, 1);
<a name="l00181"></a>00181       <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($errMsg);
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     <span class="keywordflow">return</span> $columnName;
<a name="l00184"></a>00184   }
<a name="l00185"></a>00185 
<a name="l00193"></a><a class="code" href="classagStaffImportNormalization.html#a2861f14ff9cb761e98e059c594403c03">00193</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a2861f14ff9cb761e98e059c594403c03" title="This method is an extension of the parent validate column headers method allowing...">validateColumnHeaders</a>(array $importFileHeaders, $sheetName)
<a name="l00194"></a>00194   {
<a name="l00195"></a>00195     <span class="comment">// DO NOT REMOVE THIS LINE UNLESS YOU KNOW WHAT YOU ARE DOING</span>
<a name="l00196"></a>00196     $validated = <a class="code" href="classagStaffImportNormalization.html#a2861f14ff9cb761e98e059c594403c03" title="This method is an extension of the parent validate column headers method allowing...">parent::validateColumnHeaders</a>($importFileHeaders, $sheetName);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="keywordflow">return</span> $validated;
<a name="l00199"></a>00199   }
<a name="l00200"></a>00200 
<a name="l00205"></a><a class="code" href="classagStaffImportNormalization.html#a021a0513617a72bc554d5346d7a258c7">00205</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a021a0513617a72bc554d5346d7a258c7" title="Method to dynamically build a (mostly) static tempSelectQuery.">buildTempSelectQuery</a>()
<a name="l00206"></a>00206   {
<a name="l00207"></a>00207     $query = sprintf(
<a name="l00208"></a>00208         <span class="stringliteral">&#39;SELECT t.*</span>
<a name="l00209"></a>00209 <span class="stringliteral">         FROM %s AS t&#39;</span>, $this-&gt;tempTable);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">return</span> $query;
<a name="l00212"></a>00212   }
<a name="l00213"></a>00213 
<a name="l00217"></a><a class="code" href="classagStaffImportNormalization.html#af97224eac474051b1c3756647d87f380">00217</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#af97224eac474051b1c3756647d87f380">setImportComponents</a>()
<a name="l00218"></a>00218   {
<a name="l00219"></a>00219     <span class="comment">// array( [order] =&gt; array(component =&gt; component name, helperClass =&gt; Name of the helper class, throwOnError =&gt; boolean, method =&gt; method name) )</span>
<a name="l00220"></a>00220     <span class="comment">// setEntity creates entity, person, and staff records.</span>
<a name="l00221"></a>00221     $this-&gt;importComponents[] = array(
<a name="l00222"></a>00222       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;createEntityHashes&#39;</span>,
<a name="l00223"></a>00223       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; TRUE,
<a name="l00224"></a>00224       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;createEntityHashes&#39;</span>
<a name="l00225"></a>00225     );
<a name="l00226"></a>00226     $this-&gt;importComponents[] = array(
<a name="l00227"></a>00227       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;entity&#39;</span>,
<a name="l00228"></a>00228       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; TRUE,
<a name="l00229"></a>00229       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setEntities&#39;</span>
<a name="l00230"></a>00230     );
<a name="l00231"></a>00231     $this-&gt;importComponents[] = array(
<a name="l00232"></a>00232       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;personName&#39;</span>,
<a name="l00233"></a>00233       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; TRUE,
<a name="l00234"></a>00234       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setPersonNames&#39;</span>,
<a name="l00235"></a>00235       <span class="stringliteral">&#39;helperClass&#39;</span> =&gt; <span class="stringliteral">&#39;agPersonNameHelper&#39;</span>
<a name="l00236"></a>00236     );
<a name="l00237"></a>00237     $this-&gt;importComponents[] = array(
<a name="l00238"></a>00238       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;phone&#39;</span>,
<a name="l00239"></a>00239       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; FALSE,
<a name="l00240"></a>00240       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setEntityPhone&#39;</span>,
<a name="l00241"></a>00241       <span class="stringliteral">&#39;helperClass&#39;</span> =&gt; <span class="stringliteral">&#39;agEntityPhoneHelper&#39;</span>
<a name="l00242"></a>00242     );
<a name="l00243"></a>00243     $this-&gt;importComponents[] = array(
<a name="l00244"></a>00244       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;email&#39;</span>,
<a name="l00245"></a>00245       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; FALSE,
<a name="l00246"></a>00246       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setEntityEmail&#39;</span>,
<a name="l00247"></a>00247       <span class="stringliteral">&#39;helperClass&#39;</span> =&gt; <span class="stringliteral">&#39;agEntityEmailHelper&#39;</span>
<a name="l00248"></a>00248     );
<a name="l00249"></a>00249     $this-&gt;importComponents[] = array(
<a name="l00250"></a>00250       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;address&#39;</span>,
<a name="l00251"></a>00251       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; FALSE,
<a name="l00252"></a>00252       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setEntityAddress&#39;</span>,
<a name="l00253"></a>00253       <span class="stringliteral">&#39;helperClass&#39;</span> =&gt; <span class="stringliteral">&#39;agEntityAddressHelper&#39;</span>
<a name="l00254"></a>00254     );
<a name="l00255"></a>00255     $this-&gt;importComponents[] = array(
<a name="l00256"></a>00256       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;customField&#39;</span>,
<a name="l00257"></a>00257       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; FALSE,
<a name="l00258"></a>00258       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setPersonCustomField&#39;</span>
<a name="l00259"></a>00259     );
<a name="l00260"></a>00260     $this-&gt;importComponents[] = array(
<a name="l00261"></a>00261       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;staffResource&#39;</span>,
<a name="l00262"></a>00262       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; TRUE,
<a name="l00263"></a>00263       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setStaffResourceOrg&#39;</span>
<a name="l00264"></a>00264     );
<a name="l00265"></a>00265     $this-&gt;importComponents[] = array(
<a name="l00266"></a>00266       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;personLanguage&#39;</span>,
<a name="l00267"></a>00267       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; FALSE,
<a name="l00268"></a>00268       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setPersonLanguage&#39;</span>,
<a name="l00269"></a>00269       <span class="stringliteral">&#39;helperClass&#39;</span> =&gt; <span class="stringliteral">&#39;agPersonLanguageHelper&#39;</span>
<a name="l00270"></a>00270     );
<a name="l00271"></a>00271     $this-&gt;importComponents[] = array(
<a name="l00272"></a>00272       <span class="stringliteral">&#39;component&#39;</span> =&gt; <span class="stringliteral">&#39;setImportEntityHash&#39;</span>,
<a name="l00273"></a>00273       <span class="stringliteral">&#39;throwOnError&#39;</span> =&gt; FALSE,
<a name="l00274"></a>00274       <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;setImportEntityHash&#39;</span>
<a name="l00275"></a>00275     );
<a name="l00276"></a>00276   }
<a name="l00277"></a>00277 
<a name="l00284"></a><a class="code" href="classagStaffImportNormalization.html#a00e3d91c91dd888c4e1cb7bf04cfe233">00284</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a00e3d91c91dd888c4e1cb7bf04cfe233" title="Method to create entity hashes for import rows.">createEntityHashes</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00285"></a>00285   {
<a name="l00286"></a>00286     <span class="comment">// loop through the import data</span>
<a name="l00287"></a>00287     $hashes = array();
<a name="l00288"></a>00288     $matched = 0;
<a name="l00289"></a>00289     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00290"></a>00290 
<a name="l00291"></a>00291       <span class="comment">// first calculate the hash without the entity ID</span>
<a name="l00292"></a>00292       $hashData = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l00293"></a>00293       unset($hashData[<span class="stringliteral">&#39;entity_id&#39;</span>]);
<a name="l00294"></a>00294       ksort($hashData);
<a name="l00295"></a>00295       $hash = md5(json_encode($hashData));
<a name="l00296"></a>00296 
<a name="l00297"></a>00297       <span class="comment">// we do this for in-batch duplicate detection</span>
<a name="l00298"></a>00298       <span class="keywordflow">if</span> (!isset($hashes[$hash])) {
<a name="l00299"></a>00299         $hashes[$hash] = TRUE;
<a name="l00300"></a>00300         $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;import_hash&#39;</span>] = $hash;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <span class="comment">// build a specific hash data array that excludes entity ID</span>
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (!isset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>])) {
<a name="l00304"></a>00304           $entityId = $this-&gt;<a class="code" href="classagStaffImportNormalization.html#ada4d902a55bad438cb0dba8dd7337d58" title="Method to retrieve an entity import row hash.">getEntityFromImportHash</a>($hash);
<a name="l00305"></a>00305           <span class="keywordflow">if</span> (!empty($entityId)) {
<a name="l00306"></a>00306             $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>] = $entityId;
<a name="l00307"></a>00307             $matched++;
<a name="l00308"></a>00308           }
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310       } <span class="keywordflow">else</span> {
<a name="l00311"></a>00311         $eventMsg = <span class="stringliteral">&#39;Duplicate import row found on row &#39;</span> . $rowId . <span class="stringliteral">&#39;. Ignoring duplicate.&#39;</span>;
<a name="l00312"></a>00312         $this-&gt;eh-&gt;logAlert($eventMsg, 1, FALSE);
<a name="l00313"></a>00313         unset($this-&gt;importData[$rowId]);
<a name="l00314"></a>00314       }
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316     unset($rowData);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">if</span> ($matched &gt; 0) {
<a name="l00319"></a>00319       $eventMsg = <span class="stringliteral">&#39;Found &#39;</span> . $matched . <span class="stringliteral">&#39; rows without Entity ID\&#39;s that matched a previous import. &#39;</span> .
<a name="l00320"></a>00320       <span class="stringliteral">&#39;Rows were assigned the matched Entity ID.&#39;</span>;
<a name="l00321"></a>00321       $this-&gt;eh-&gt;logAlert($eventMsg);
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323   }
<a name="l00324"></a>00324 
<a name="l00330"></a><a class="code" href="classagStaffImportNormalization.html#ada4d902a55bad438cb0dba8dd7337d58">00330</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#ada4d902a55bad438cb0dba8dd7337d58" title="Method to retrieve an entity import row hash.">getEntityFromImportHash</a>($importHash) {
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00333"></a>00333       -&gt;select(<span class="stringliteral">&#39;ieh.entity_id&#39;</span>)
<a name="l00334"></a>00334       -&gt;from(<span class="stringliteral">&#39;agImportEntityHash ieh&#39;</span>)
<a name="l00335"></a>00335       -&gt;where(<span class="stringliteral">&#39;ieh.row_hash = ?&#39;</span>, $importHash)
<a name="l00336"></a>00336       -&gt;useResultCache(TRUE, 1800);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     $result = $q-&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (empty($result))
<a name="l00341"></a>00341     {
<a name="l00342"></a>00342       $cacheDriver = <a class="code" href="classagStaffImportNormalization.html#ac2005829fcb2e751c01c727cf932d454" title="Method to return an instance of this class.">Doctrine_Manager::getInstance</a>()-&gt;getAttribute(Doctrine_Core::ATTR_RESULT_CACHE);
<a name="l00343"></a>00343       $cacheDriver-&gt;delete($q-&gt;getResultCacheHash());
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="keywordflow">return</span> $result;
<a name="l00347"></a>00347   }
<a name="l00348"></a>00348 
<a name="l00355"></a><a class="code" href="classagStaffImportNormalization.html#afb77f9f67be934d6964518ab28082b95">00355</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#afb77f9f67be934d6964518ab28082b95" title="Method to set / create new entities, persons, and staff.">setEntities</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00356"></a>00356   {
<a name="l00357"></a>00357     <span class="comment">// we need to capture errors just to make sure we don&#39;t store failed ID inserts</span>
<a name="l00358"></a>00358     <span class="keywordflow">try</span> {
<a name="l00359"></a>00359       $this-&gt;loadCurrentEntities($conn);
<a name="l00360"></a>00360       $this-&gt;setNewEntities($conn);
<a name="l00361"></a>00361     } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00362"></a>00362       <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00363"></a>00363         unset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>]);
<a name="l00364"></a>00364         unset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>]);
<a name="l00365"></a>00365         unset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;staff_id&#39;</span>]);
<a name="l00366"></a>00366       }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368       <span class="comment">// continue throwing our exception</span>
<a name="l00369"></a>00369       <span class="keywordflow">throw</span> $e;
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371   }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="comment">/*</span>
<a name="l00374"></a>00374 <span class="comment">   * Method to load any existing entities from the database into our object.</span>
<a name="l00375"></a>00375 <span class="comment">   * @param Doctrine_Connection $conn A doctrine connection for data manipulation.</span>
<a name="l00376"></a>00376 <span class="comment">   */</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="keyword">protected</span> function loadCurrentEntities(<a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00379"></a>00379   {
<a name="l00380"></a>00380     <span class="comment">// explicit declarations are good</span>
<a name="l00381"></a>00381     $rawEntityIds = array();
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">// loop our import data and pick up any existing entity Ids</span>
<a name="l00384"></a>00384     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00385"></a>00385       $rawData = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l00386"></a>00386 
<a name="l00387"></a>00387       <span class="keywordflow">if</span> (isset($rawData[<span class="stringliteral">&#39;entity_id&#39;</span>])) {
<a name="l00388"></a>00388         $entityId = $rawData[<span class="stringliteral">&#39;entity_id&#39;</span>];
<a name="l00389"></a>00389         <span class="comment">// we apply a small check for dupes</span>
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (!isset($rawEntityIds[$entityId])) {
<a name="l00391"></a>00391           $rawEntityIds[$entityId] = TRUE;
<a name="l00392"></a>00392         } <span class="keywordflow">else</span> {
<a name="l00393"></a>00393           $eventMsg = <span class="stringliteral">&#39;A previous row was identified with Entity ID #&#39;</span> . $entityId . <span class="stringliteral">&#39;. Skipping &#39;</span> .
<a name="l00394"></a>00394             <span class="stringliteral">&#39;subsequent row.&#39;</span>;
<a name="l00395"></a>00395           $this-&gt;eh-&gt;logAlert($eventMsg, 0);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397           unset($this-&gt;importData[$rowId]);
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399       }
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="comment">// find current entity + persons</span>
<a name="l00403"></a>00403     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00404"></a>00404         -&gt;select(<span class="stringliteral">&#39;e.id&#39;</span>)
<a name="l00405"></a>00405         -&gt;addSelect(<span class="stringliteral">&#39;p.id&#39;</span>)
<a name="l00406"></a>00406         -&gt;addSelect(<span class="stringliteral">&#39;s.id&#39;</span>)
<a name="l00407"></a>00407         -&gt;from(<span class="stringliteral">&#39;agEntity e&#39;</span>)
<a name="l00408"></a>00408         -&gt;innerJoin(<span class="stringliteral">&#39;e.agPerson p&#39;</span>)
<a name="l00409"></a>00409         -&gt;leftJoin(<span class="stringliteral">&#39;p.agStaff s&#39;</span>)
<a name="l00410"></a>00410         -&gt;whereIn(<span class="stringliteral">&#39;e.id&#39;</span>, array_keys($rawEntityIds));
<a name="l00411"></a>00411     $entities = $q-&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_ARRAY);
<a name="l00412"></a>00412     $q-&gt;free();
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="comment">// we no longer need this array (used for the -&gt;whereIN)</span>
<a name="l00415"></a>00415     unset($rawEntityIds);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     $this-&gt;eh-&gt;logDebug(<span class="charliteral">&#39;{&#39;</span> . count($entities) . <span class="stringliteral">&#39;} person entities found in the database.&#39;</span>);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     $staffTable = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agStaff&#39;</span>);
<a name="l00420"></a>00420     $staffColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agStaff&#39;</span>);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="comment">//loop foreach $entities member</span>
<a name="l00423"></a>00423     <span class="keywordflow">foreach</span> ($entities as $entityId =&gt; $entityData) {
<a name="l00424"></a>00424       <span class="comment">// if staff id doesn&#39;t exist yet, make it so</span>
<a name="l00425"></a>00425       <span class="keywordflow">if</span> (is_null($entityData[1])) {
<a name="l00426"></a>00426         $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Person ID {&#39;</span> . $entityData[0] . <span class="stringliteral">&#39;} exists but is not staff. &#39;</span> .
<a name="l00427"></a>00427             <span class="stringliteral">&#39;Creating staff record.&#39;</span>);
<a name="l00428"></a>00428         $nRec = <span class="keyword">new</span> <a class="code" href="classagStaff.html">agStaff</a>($staffTable,TRUE);
<a name="l00429"></a>00429         $nRec[<span class="stringliteral">&#39;person_id&#39;</span>] = $entityData[0];
<a name="l00430"></a>00430         $staffColl-&gt;add($nRec, $entityId);
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433     $staffColl-&gt;save($conn);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">// add the newly saved id&#39;s to the entities array</span>
<a name="l00436"></a>00436     <span class="keywordflow">foreach</span>($staffColl as $entityId =&gt; $staffRec) {
<a name="l00437"></a>00437        $entities[$entityId][1] = $staffRec[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="comment">// free some mem</span>
<a name="l00441"></a>00441     $staffColl-&gt;free();
<a name="l00442"></a>00442     unset($staffColl);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="comment">// update our row keys array</span>
<a name="l00445"></a>00445     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Updating primary keys for found entities.&#39;</span>);
<a name="l00446"></a>00446     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00447"></a>00447       <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;entity_id&#39;</span>, $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>])) {
<a name="l00448"></a>00448         $entityId = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>];
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (array_key_exists($entityId, $entities)) {
<a name="l00450"></a>00450           $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>] = $entityId;
<a name="l00451"></a>00451           $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>] = $entities[$entityId][0];
<a name="l00452"></a>00452           $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;staff_id&#39;</span>] = $entities[$entityId][1];
<a name="l00453"></a>00453           unset($entities[$entityId]);
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455       }
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     unset($rowData);
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   <span class="comment">/*</span>
<a name="l00461"></a>00461 <span class="comment">   * Method to set new entities from our $_rawData.</span>
<a name="l00462"></a>00462 <span class="comment">   * @param Doctrine_Connection $conn A doctrine connection for data manipulation.</span>
<a name="l00463"></a>00463 <span class="comment">   */</span>
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   <span class="keyword">protected</span> function setNewEntities(<a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00466"></a>00466   {
<a name="l00467"></a>00467     <span class="comment">// make these explicit at the to to avoid building the graph multiple times</span>
<a name="l00468"></a>00468     $entityTable = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agEntity&#39;</span>);
<a name="l00469"></a>00469     $personTable = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agPersonBulkLoad&#39;</span>);
<a name="l00470"></a>00470     $staffTable = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agStaffBulkLoad&#39;</span>);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="comment">// define the collections once</span>
<a name="l00473"></a>00473     $entityColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEntity&#39;</span>);
<a name="l00474"></a>00474     $personColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agPersonBulkLoad&#39;</span>);
<a name="l00475"></a>00475     $staffColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agStaffBulkLoad&#39;</span>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <span class="comment">// add new entities / persons / staff for records with bad or no entity ids.</span>
<a name="l00478"></a>00478     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00479"></a>00479       <span class="comment">// initially be pessimistic about the actions we&#39;ll need to take</span>
<a name="l00480"></a>00480       $createNew = FALSE;
<a name="l00481"></a>00481       $warnBadEntity = FALSE;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483       <span class="comment">// pick these up by reference so we can use the pointers more easily</span>
<a name="l00484"></a>00484       $rawData = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l00485"></a>00485       $pKeys = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>];
<a name="l00486"></a>00486 
<a name="l00487"></a>00487       <span class="comment">// this should satisfy both NULL entity_ids and ones that didn&#39;t make our initial filter</span>
<a name="l00488"></a>00488       <span class="keywordflow">if</span> (!isset($rawData[<span class="stringliteral">&#39;entity_id&#39;</span>])) {
<a name="l00489"></a>00489         $createNew = TRUE;
<a name="l00490"></a>00490       } elseif (!isset($pKeys[<span class="stringliteral">&#39;entity_id&#39;</span>]) || $rawData[<span class="stringliteral">&#39;entity_id&#39;</span>] != $pKeys[<span class="stringliteral">&#39;entity_id&#39;</span>]) {
<a name="l00491"></a>00491         $createNew = TRUE;
<a name="l00492"></a>00492         $warnBadEntity = TRUE;
<a name="l00493"></a>00493       }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495       <span class="keywordflow">if</span> ($createNew) {
<a name="l00496"></a>00496         $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Creating new entity for import rowId {&#39;</span> . $rowId . <span class="stringliteral">&#39;}.&#39;</span>);
<a name="l00497"></a>00497         $newRec = <span class="keyword">new</span> <a class="code" href="classagEntity.html" title="Extends BaseagEntity and returns entity information.">agEntity</a>($entityTable, TRUE);
<a name="l00498"></a>00498         $entityColl-&gt;add($newRec, $rowId);
<a name="l00499"></a>00499       }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501       <span class="comment">// here we log warnings about bad entities that we&#39;ve been passed and chose to override</span>
<a name="l00502"></a>00502       <span class="keywordflow">if</span> ($warnBadEntity) {
<a name="l00503"></a>00503         $warnMsg = sprintf(<span class="stringliteral">&quot;Bad entity id (%s).  Generated a new entity id.&quot;</span>, $rawData[<span class="stringliteral">&#39;entity_id&#39;</span>]);
<a name="l00504"></a>00504         $this-&gt;eh-&gt;logWarning($warnMsg);
<a name="l00505"></a>00505       }
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Saving new entities.&#39;</span>);
<a name="l00508"></a>00508     $entityColl-&gt;save($conn);
<a name="l00509"></a>00509     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;New entities successfully saved.&#39;</span>);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="comment">// now, loop through using the recently return import data and build staff the same way</span>
<a name="l00512"></a>00512     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00513"></a>00513 
<a name="l00514"></a>00514       <span class="comment">// grab our entityId from the entity collection or skip if unfound</span>
<a name="l00515"></a>00515       <span class="keywordflow">if</span> (! isset($entityColl[$rowId])) {
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>])) {
<a name="l00517"></a>00517           <span class="comment">// no new parent, child record exists</span>
<a name="l00518"></a>00518           <span class="keywordflow">continue</span>;
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520         <span class="comment">// no new parent, child record does not exist</span>
<a name="l00521"></a>00521         $entityId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>];
<a name="l00522"></a>00522       } <span class="keywordflow">else</span> {
<a name="l00523"></a>00523         <span class="comment">// new parent, child record is irrelevant</span>
<a name="l00524"></a>00524         $entityId = $entityColl[$rowId][<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00525"></a>00525       }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527       <span class="comment">// set our pkeys data</span>
<a name="l00528"></a>00528       $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>] = $entityId;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530       <span class="comment">// create a new person entry and add it to the person collection</span>
<a name="l00531"></a>00531       $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Creating new person for import Entity ID {&#39;</span> . $entityId . <span class="stringliteral">&#39;}.&#39;</span>);
<a name="l00532"></a>00532       $newRec = <span class="keyword">new</span> <a class="code" href="classagPersonBulkLoad.html" title="Extends the person object to provide a leaner record object without indexing that...">agPersonBulkLoad</a>($personTable, TRUE);
<a name="l00533"></a>00533       $newRec[<span class="stringliteral">&#39;entity_id&#39;</span>] = $entityId;
<a name="l00534"></a>00534       $personColl-&gt;add($newRec, $rowId);
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     unset($rowData);
<a name="l00537"></a>00537     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Saving new persons.&#39;</span>);
<a name="l00538"></a>00538     $personColl-&gt;save($conn);
<a name="l00539"></a>00539     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;New persons successfully saved.&#39;</span>);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="comment">// now we can free the entity collection&#39;s resources</span>
<a name="l00542"></a>00542     $entityColl-&gt;free();
<a name="l00543"></a>00543     unset($entityColl);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="comment">// repeat for staff</span>
<a name="l00546"></a>00546     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00547"></a>00547 
<a name="l00548"></a>00548       <span class="comment">// grab our entityId from the entity collection or skip if unfound</span>
<a name="l00549"></a>00549       <span class="keywordflow">if</span> (! isset($personColl[$rowId])) {
<a name="l00550"></a>00550         <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;staff_id&#39;</span>])) {
<a name="l00551"></a>00551           <span class="comment">// no new parent, child record exists</span>
<a name="l00552"></a>00552           <span class="keywordflow">continue</span>;
<a name="l00553"></a>00553         }
<a name="l00554"></a>00554         <span class="comment">// no new parent, child record does not exist</span>
<a name="l00555"></a>00555         $personId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>];
<a name="l00556"></a>00556       } <span class="keywordflow">else</span> {
<a name="l00557"></a>00557         <span class="comment">// new parent, child record is irrelevant</span>
<a name="l00558"></a>00558         $personId = $personColl[$rowId][<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00559"></a>00559       }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       <span class="comment">// set our pkeys data</span>
<a name="l00562"></a>00562       $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>] = $personId;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564       <span class="comment">// create a new staff entry and add it to the staff collection</span>
<a name="l00565"></a>00565       $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Creating new staff for import Person ID {&#39;</span> . $personId . <span class="stringliteral">&#39;}.&#39;</span>);
<a name="l00566"></a>00566       $newRec = <span class="keyword">new</span> <a class="code" href="classagStaffBulkLoad.html" title="PluginagStaff is an extension of base class agStaff that provides a lean, unindexed...">agStaffBulkLoad</a>($staffTable, TRUE);
<a name="l00567"></a>00567       $newRec[<span class="stringliteral">&#39;person_id&#39;</span>] = $personId;
<a name="l00568"></a>00568       $staffColl-&gt;add($newRec, $rowId);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     unset($rowData);
<a name="l00571"></a>00571     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Saving new staff.&#39;</span>);
<a name="l00572"></a>00572     $staffColl-&gt;save($conn);
<a name="l00573"></a>00573     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;New staff successfully saved.&#39;</span>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="comment">// now we can free the person collection&#39;s resources</span>
<a name="l00576"></a>00576     $personColl-&gt;free();
<a name="l00577"></a>00577     unset($personColl);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="comment">// repeat for staff</span>
<a name="l00580"></a>00580     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00581"></a>00581       <span class="comment">// grab our staffId from the staff collection</span>
<a name="l00582"></a>00582       <span class="keywordflow">if</span> (isset($staffColl[$rowId])) {
<a name="l00583"></a>00583         $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;staff_id&#39;</span>] = $staffColl[$rowId][<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00584"></a>00584       }
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     unset($rowData);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="comment">// now we can free the staff collection&#39;s resources</span>
<a name="l00589"></a>00589     $staffColl-&gt;free();
<a name="l00590"></a>00590     unset($staffColl);
<a name="l00591"></a>00591   }
<a name="l00592"></a>00592 
<a name="l00599"></a><a class="code" href="classagStaffImportNormalization.html#a8c4208fd0afc55d60da6b00413878328">00599</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a8c4208fd0afc55d60da6b00413878328" title="Method to set person names during staff import.">setPersonNames</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00600"></a>00600   {
<a name="l00601"></a>00601     <span class="comment">// always start with any data maps we&#39;ll need so they&#39;re explicit</span>
<a name="l00602"></a>00602     $importNameTypes = array(<span class="stringliteral">&#39;first_name&#39;</span> =&gt; <span class="stringliteral">&#39;given&#39;</span>, <span class="stringliteral">&#39;middle_name&#39;</span> =&gt; <span class="stringliteral">&#39;middle&#39;</span>, <span class="stringliteral">&#39;last_name&#39;</span> =&gt; <span class="stringliteral">&#39;family&#39;</span>);
<a name="l00603"></a>00603     $personNames = array();
<a name="l00604"></a>00604     $results = array();
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="comment">// let&#39;s get ahold of our helper object since we&#39;re going to use him/her a lot</span>
<a name="l00607"></a>00607     $pnh = &amp; $this-&gt;helperObjects[<span class="stringliteral">&#39;agPersonNameHelper&#39;</span>];
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="comment">// get our name types and map them back to the importNameTypes</span>
<a name="l00610"></a>00610     $nameTypes = $pnh-&gt;getNameTypeIds(array_values($importNameTypes));
<a name="l00611"></a>00611     <span class="keywordflow">foreach</span> ($importNameTypes as $key =&gt; &amp;$val) {
<a name="l00612"></a>00612       $val = $nameTypes[$val];
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614     unset($val);
<a name="l00615"></a>00615     unset($nameTypes);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <span class="comment">// loop through our raw data and build our person name data</span>
<a name="l00618"></a>00618     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00619"></a>00619       <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>])) {
<a name="l00620"></a>00620         $personId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>];
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         <span class="comment">// we start with an empty array, devoid of types in case the entity has no types/values</span>
<a name="l00623"></a>00623         $personNames[$personId] = array();
<a name="l00624"></a>00624         <span class="keywordflow">foreach</span> ($importNameTypes as $nameType =&gt; $nameTypeId) {
<a name="l00625"></a>00625           <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$nameType])) {
<a name="l00626"></a>00626             $personNames[$personId][$nameTypeId][] = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$nameType];
<a name="l00627"></a>00627           }
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629       }
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="comment">// pick up some of our components / objects</span>
<a name="l00633"></a>00633     $keepHistory = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_keep_history&#39;</span>);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     <span class="comment">// execute the helper and finish</span>
<a name="l00636"></a>00636     $results = $pnh-&gt;setPersonNames($personNames, $keepHistory, $throwOnError, $conn);
<a name="l00637"></a>00637     unset($personNames);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="comment">// @todo do your results reporting here</span>
<a name="l00640"></a>00640   }
<a name="l00641"></a>00641 
<a name="l00648"></a><a class="code" href="classagStaffImportNormalization.html#ae269c064f7fba605f38005350af0292f">00648</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#ae269c064f7fba605f38005350af0292f" title="Method to set entity emails during staff import.">setEntityEmail</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00649"></a>00649   {
<a name="l00650"></a>00650     <span class="comment">// always start with any data maps we&#39;ll need so they&#39;re explicit</span>
<a name="l00651"></a>00651     $importEmailTypes = array(<span class="stringliteral">&#39;work_email&#39;</span> =&gt; <span class="stringliteral">&#39;work&#39;</span>, <span class="stringliteral">&#39;home_email&#39;</span> =&gt; <span class="stringliteral">&#39;personal&#39;</span>);
<a name="l00652"></a>00652     $entityEmails = array();
<a name="l00653"></a>00653     $results = array();
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <span class="comment">// let&#39;s get ahold of our helper object since we&#39;re going to use him/her a lot</span>
<a name="l00656"></a>00656     $eeh = &amp; $this-&gt;helperObjects[<span class="stringliteral">&#39;agEntityEmailHelper&#39;</span>];
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="comment">// get our email types and map them back to the importEmailTypes</span>
<a name="l00659"></a>00659     $emailTypes = <a class="code" href="classagEmailHelper.html#aad5de33760446944cecf88bc276f51c3" title="Method to return email contact type ids from email contact type values.">agEmailHelper::getEmailContactTypeIds</a>(array_values($importEmailTypes));
<a name="l00660"></a>00660     <span class="keywordflow">foreach</span> ($importEmailTypes as $key =&gt; &amp;$val) {
<a name="l00661"></a>00661       $val = $emailTypes[$val];
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663     unset($val);
<a name="l00664"></a>00664     unset($emailTypes);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="comment">// loop through our raw data and build our entity email data</span>
<a name="l00667"></a>00667     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00668"></a>00668       <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>])) {
<a name="l00669"></a>00669         <span class="comment">// this just makes it easier to use</span>
<a name="l00670"></a>00670         $entityId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>];
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="comment">// we start with an empty array, devoid of types in case the entity has no types/values</span>
<a name="l00673"></a>00673         $entityEmails[$entityId] = array();
<a name="l00674"></a>00674         <span class="keywordflow">foreach</span> ($importEmailTypes as $emailType =&gt; $emailTypeId) {
<a name="l00675"></a>00675           <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$emailType])) {
<a name="l00676"></a>00676             $entityEmails[$entityId][] = array($emailTypeId, $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$emailType]);
<a name="l00677"></a>00677           }
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679       }
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment">// pick up some of our components / objects</span>
<a name="l00683"></a>00683     $keepHistory = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_keep_history&#39;</span>);
<a name="l00684"></a>00684     $enforceStrict = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;enforce_strict_contact_formatting&#39;</span>);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">// execute the helper and finish</span>
<a name="l00687"></a>00687     $results = $eeh-&gt;setEntityEmail($entityEmails, $keepHistory, $enforceStrict, $throwOnError,
<a name="l00688"></a>00688                                     $conn);
<a name="l00689"></a>00689     unset($entityEmails);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="comment">// @todo do your results reporting here</span>
<a name="l00692"></a>00692   }
<a name="l00693"></a>00693 
<a name="l00700"></a><a class="code" href="classagStaffImportNormalization.html#adb7bce77c3bbbd81ccf1d638dd27f5fa">00700</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#adb7bce77c3bbbd81ccf1d638dd27f5fa" title="Method to set entity phones during staff import.">setEntityPhone</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00701"></a>00701   {
<a name="l00702"></a>00702     <span class="comment">// always start with any data maps we&#39;ll need so they&#39;re explicit</span>
<a name="l00703"></a>00703     $importPhoneTypes = array(<span class="stringliteral">&#39;work_phone&#39;</span> =&gt; <span class="stringliteral">&#39;work&#39;</span>, <span class="stringliteral">&#39;home_phone&#39;</span> =&gt; <span class="stringliteral">&#39;home&#39;</span>, <span class="stringliteral">&#39;mobile_phone&#39;</span> =&gt; <span class="stringliteral">&#39;mobile&#39;</span>);
<a name="l00704"></a>00704     $entityPhones = array();
<a name="l00705"></a>00705     $results = array();
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="comment">// let&#39;s get ahold of our helper object since we&#39;re going to use him/her a lot</span>
<a name="l00708"></a>00708     $eph = &amp; $this-&gt;helperObjects[<span class="stringliteral">&#39;agEntityPhoneHelper&#39;</span>];
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="comment">// get our email types and map them back to the importEmailTypes</span>
<a name="l00711"></a>00711     $phoneTypes = <a class="code" href="classagPhoneHelper.html#a44cc798c505bb32861abf1468c06d0d2" title="Method to return phone contact type ids from phone contact type values.">agPhoneHelper::getPhoneContactTypeIds</a>(array_values($importPhoneTypes));
<a name="l00712"></a>00712     <span class="keywordflow">foreach</span> ($importPhoneTypes as $key =&gt; &amp;$val) {
<a name="l00713"></a>00713       $val = $phoneTypes[$val];
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715     unset($val);
<a name="l00716"></a>00716     unset($phoneTypes);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="comment">// loop through our raw data and build our entity phone data</span>
<a name="l00719"></a>00719     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00720"></a>00720       <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>])) {
<a name="l00721"></a>00721         <span class="comment">// this just makes it easier to use</span>
<a name="l00722"></a>00722         $entityId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>];
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         <span class="comment">// we start with an empty array, devoid of types in case the entity has no types/values</span>
<a name="l00725"></a>00725         $entityPhones[$entityId] = array();
<a name="l00726"></a>00726         <span class="keywordflow">foreach</span> ($importPhoneTypes as $phoneType =&gt; $phoneTypeId) {
<a name="l00727"></a>00727           <span class="keywordflow">if</span> (array_key_exists($phoneType, $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>])) {
<a name="l00728"></a>00728             $entityPhones[$entityId][] = array($phoneTypeId, array($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$phoneType]));
<a name="l00729"></a>00729           }
<a name="l00730"></a>00730         }
<a name="l00731"></a>00731       }
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="comment">// pick up some of our components / objects</span>
<a name="l00735"></a>00735     $keepHistory = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_keep_history&#39;</span>);
<a name="l00736"></a>00736     $enforceStrict = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;enforce_strict_contact_formatting&#39;</span>);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">// execute the helper and finish</span>
<a name="l00739"></a>00739     $results = $eph-&gt;setEntityPhone($entityPhones, $keepHistory, $enforceStrict, $throwOnError,
<a name="l00740"></a>00740                                     $conn);
<a name="l00741"></a>00741     unset($entityPhones);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     <span class="comment">// @todo do your results reporting here</span>
<a name="l00744"></a>00744   }
<a name="l00745"></a>00745 
<a name="l00752"></a><a class="code" href="classagStaffImportNormalization.html#afbb6260c13a08ec929b34805b62d94d4">00752</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#afbb6260c13a08ec929b34805b62d94d4" title="Method to set entity address during staff import.">setEntityAddress</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00753"></a>00753   {
<a name="l00754"></a>00754     <span class="comment">// always start with any data maps we&#39;ll need so they&#39;re explicit</span>
<a name="l00755"></a>00755     $importAddressTypes = array(<span class="stringliteral">&#39;work_address&#39;</span> =&gt; <span class="stringliteral">&#39;work&#39;</span>, <span class="stringliteral">&#39;home_address&#39;</span> =&gt; <span class="stringliteral">&#39;home&#39;</span>);
<a name="l00756"></a>00756     $importAddressElements = array(<span class="stringliteral">&#39;line_1&#39;</span> =&gt; <span class="stringliteral">&#39;line 1&#39;</span>, <span class="stringliteral">&#39;line_2&#39;</span> =&gt; <span class="stringliteral">&#39;line 2&#39;</span>, <span class="stringliteral">&#39;city&#39;</span> =&gt; <span class="stringliteral">&#39;city&#39;</span>,
<a name="l00757"></a>00757       <span class="stringliteral">&#39;state&#39;</span> =&gt; <span class="stringliteral">&#39;state&#39;</span>, <span class="stringliteral">&#39;zip&#39;</span> =&gt; <span class="stringliteral">&#39;zip5&#39;</span>, <span class="stringliteral">&#39;country&#39;</span> =&gt; <span class="stringliteral">&#39;country&#39;</span>);
<a name="l00758"></a>00758     $entityAddresses = array();
<a name="l00759"></a>00759     $missingGeo = 0;
<a name="l00760"></a>00760     $results = array();
<a name="l00761"></a>00761     $errMsg = NULL;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="comment">// let&#39;s get ahold of our helper object since we&#39;re going to use him/her a lot</span>
<a name="l00764"></a>00764     $eah = &amp; $this-&gt;helperObjects[<span class="stringliteral">&#39;agEntityAddressHelper&#39;</span>];
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     <span class="comment">// get our address types and map them back to the importAddressTypes</span>
<a name="l00767"></a>00767     $addressTypes = <a class="code" href="classagAddressHelper.html#af3006478a88ec8725bd473fb7bd8119c" title="Method to return address contact type ids from address contact type values.">agAddressHelper::getAddressContactTypeIds</a>(array_values($importAddressTypes));
<a name="l00768"></a>00768     <span class="keywordflow">foreach</span> ($importAddressTypes as $key =&gt; &amp;$val) {
<a name="l00769"></a>00769       $val = $addressTypes[$val];
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     unset($val);
<a name="l00772"></a>00772     unset($addressTypes);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     <span class="comment">// get our address elements and map them back to the importAddressElements</span>
<a name="l00775"></a>00775     $addressElements = <a class="code" href="classagAddressHelper.html#a481668aa61a0fd4bf3aec3c7039a0246" title="Method to return address element ids from address element values.">agAddressHelper::getAddressElementIds</a>(array_values($importAddressElements));
<a name="l00776"></a>00776     <span class="keywordflow">foreach</span> ($importAddressElements as $key =&gt; &amp;$val) {
<a name="l00777"></a>00777       $val = $addressElements[$val];
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     unset($val);
<a name="l00780"></a>00780     unset($addressElements);
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="comment">// get our address standards and geo match scores</span>
<a name="l00783"></a>00783     $addressStandard = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_address_standard&#39;</span>);
<a name="l00784"></a>00784     $addressStandardId = <a class="code" href="classagAddressHelper.html#a9d1d1b83535c6e2ee23142b83d93dc04" title="Method to return address standard ids from address standard values.">agAddressHelper::getAddressStandardIds</a>(array($addressStandard));
<a name="l00785"></a>00785     $addressStandardId = $addressStandardId[$addressStandard];
<a name="l00786"></a>00786     $geoMatchScore = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_geo_match_score&#39;</span>);
<a name="l00787"></a>00787     $geoMatchScoreId = <a class="code" href="classagGeoHelper.html#a16acd80afb50fed6121c2d722f7bbde3" title="Method to return geo match score ids from geo match score values.">agGeoHelper::getGeoMatchScoreIds</a>(array($geoMatchScore));
<a name="l00788"></a>00788     $geoMatchScoreId = $geoMatchScoreId[$geoMatchScore];
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="comment">// loop through our raw data and build our entity address data</span>
<a name="l00791"></a>00791     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00792"></a>00792       <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>])) {
<a name="l00793"></a>00793         <span class="comment">// this just makes it easier to use</span>
<a name="l00794"></a>00794         $entityId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>];
<a name="l00795"></a>00795         $rawData = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l00796"></a>00796 
<a name="l00797"></a>00797         <span class="comment">// we start with an empty array, devoid of types in case the entity has no types/values</span>
<a name="l00798"></a>00798         list($homeAddr, $workAddr) = array(array(), array());
<a name="l00799"></a>00799         <span class="keywordflow">foreach</span> ($importAddressElements AS $element =&gt; $id) {
<a name="l00800"></a>00800           <span class="keywordflow">if</span> (isset($rawData[<span class="stringliteral">&#39;home_address_&#39;</span> . $element])) {
<a name="l00801"></a>00801             $homeAddr[$id] = $rawData[<span class="stringliteral">&#39;home_address_&#39;</span> . $element];
<a name="l00802"></a>00802           }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804           <span class="keywordflow">if</span> (isset($rawData[<span class="stringliteral">&#39;work_address_&#39;</span> . $element])) {
<a name="l00805"></a>00805             $workAddr[$id] = $rawData[<span class="stringliteral">&#39;work_address_&#39;</span> . $element];
<a name="l00806"></a>00806             $hasWorkElem = TRUE;
<a name="l00807"></a>00807           }
<a name="l00808"></a>00808         }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (count($homeAddr) &gt; 0) {
<a name="l00811"></a>00811           <span class="keywordflow">if</span> (isset($rawData[<span class="stringliteral">&#39;home_latitude&#39;</span>]) &amp;&amp; isset($rawData[<span class="stringliteral">&#39;home_longitude&#39;</span>])) {
<a name="l00812"></a>00812             $homeAddrComp = array($homeAddr, $addressStandardId);
<a name="l00813"></a>00813             $homeAddrComp[] = array(array(array($rawData[<span class="stringliteral">&#39;home_latitude&#39;</span>],
<a name="l00814"></a>00814                   $rawData[<span class="stringliteral">&#39;home_longitude&#39;</span>])),
<a name="l00815"></a>00815               $geoMatchScoreId);
<a name="l00816"></a>00816             $entityAddresses[$entityId][] = array($importAddressTypes[<span class="stringliteral">&#39;home_address&#39;</span>], $homeAddrComp);
<a name="l00817"></a>00817           } <span class="keywordflow">else</span> {
<a name="l00818"></a>00818             <span class="comment">// log our error or at least grab our counter</span>
<a name="l00819"></a>00819             $missingGeo++;
<a name="l00820"></a>00820             <span class="keywordflow">if</span> ($throwOnError) {
<a name="l00821"></a>00821               $errMsg = sprintf(<span class="stringliteral">&#39;Missing home address/geo information from record id  %d&#39;</span>, $rowId);
<a name="l00822"></a>00822               $this-&gt;eh-&gt;logErr($errMsg);
<a name="l00823"></a>00823               <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($errMsg);
<a name="l00824"></a>00824             }
<a name="l00825"></a>00825           }
<a name="l00826"></a>00826         }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <span class="keywordflow">if</span> (count($workAddr) &gt; 0) {
<a name="l00829"></a>00829           <span class="keywordflow">if</span> (isset($rawData[<span class="stringliteral">&#39;work_latitude&#39;</span>]) &amp;&amp; isset($rawData[<span class="stringliteral">&#39;work_longitude&#39;</span>])) {
<a name="l00830"></a>00830             $workAddrComp = array($workAddr, $addressStandardId);
<a name="l00831"></a>00831             $workAddrComp[] = array(array(array($rawData[<span class="stringliteral">&#39;work_latitude&#39;</span>],
<a name="l00832"></a>00832                 $rawData[<span class="stringliteral">&#39;work_longitude&#39;</span>])),
<a name="l00833"></a>00833               $geoMatchScoreId);
<a name="l00834"></a>00834             $entityAddresses[$entityId][] = array($importAddressTypes[<span class="stringliteral">&#39;work_address&#39;</span>], $workAddrComp);
<a name="l00835"></a>00835           } <span class="keywordflow">else</span> {
<a name="l00836"></a>00836             <span class="comment">// log our error or at least grab our counter</span>
<a name="l00837"></a>00837             $missingGeo++;
<a name="l00838"></a>00838             <span class="keywordflow">if</span> ($throwOnError) {
<a name="l00839"></a>00839               $errMsg = sprintf(<span class="stringliteral">&#39;Missing work address/geo information from record id  %d&#39;</span>, $rowId);
<a name="l00840"></a>00840               $this-&gt;eh-&gt;logErr($errMsg);
<a name="l00841"></a>00841               <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($errMsg);
<a name="l00842"></a>00842             }
<a name="l00843"></a>00843           }
<a name="l00844"></a>00844         }
<a name="l00845"></a>00845       }
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="comment">// pick up some of our components / objects</span>
<a name="l00849"></a>00849     $keepHistory = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_keep_history&#39;</span>);
<a name="l00850"></a>00850     $enforceStrict = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;enforce_strict_contact_formatting&#39;</span>);
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="keywordflow">if</span> (!isset($this-&gt;geoSourceId)) {
<a name="l00853"></a>00853       $this-&gt;geoSourceId = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00854"></a>00854           -&gt;select(<span class="stringliteral">&#39;gs.id&#39;</span>)
<a name="l00855"></a>00855           -&gt;from(<span class="stringliteral">&#39;agGeoSource gs&#39;</span>)
<a name="l00856"></a>00856           -&gt;where(<span class="stringliteral">&#39;gs.geo_source = ?&#39;</span>, <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_geo_source&#39;</span>))
<a name="l00857"></a>00857           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     $geoSourceId = $this-&gt;geoSourceId;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     $addressGeo = array();
<a name="l00862"></a>00862     <span class="comment">// @TODO Handle geo upserts along with address.</span>
<a name="l00863"></a>00863     <span class="comment">// execute the helper and finish</span>
<a name="l00864"></a>00864     $results = $eah-&gt;setEntityAddress($entityAddresses, $geoSourceId, $keepHistory, $enforceStrict,
<a name="l00865"></a>00865                                       $throwOnError, $conn);
<a name="l00866"></a>00866     unset($entityAddresses);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="keywordflow">if</span> ($missingGeo &gt; 0) {
<a name="l00869"></a>00869       $warnMsg = <span class="stringliteral">&#39;Batch contains &#39;</span> . $missingGeo . <span class="stringliteral">&#39; addresses without associated geo information.&#39;</span>;
<a name="l00870"></a>00870       $this-&gt;eh-&gt;logWarning($warnMsg);
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872     <span class="comment">// @todo do your results reporting here</span>
<a name="l00873"></a>00873   }
<a name="l00874"></a>00874 
<a name="l00881"></a><a class="code" href="classagStaffImportNormalization.html#a8d0ec4a1b1e7ddd45a77a6af25f7a3a5">00881</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a8d0ec4a1b1e7ddd45a77a6af25f7a3a5" title="Method to set custom field data for persons.">setPersonCustomField</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00882"></a>00882   {
<a name="l00883"></a>00883     $errMsg = NULL;
<a name="l00884"></a>00884     $importCustomFields = array(<span class="stringliteral">&#39;drivers_license_class&#39;</span> =&gt; <span class="stringliteral">&#39;Drivers License Class&#39;</span>,
<a name="l00885"></a>00885       <span class="stringliteral">&#39;pms_id&#39;</span> =&gt; <span class="stringliteral">&#39;PMS ID&#39;</span>,
<a name="l00886"></a>00886       <span class="stringliteral">&#39;civil_service_title&#39;</span> =&gt; <span class="stringliteral">&#39;Civil Service Title&#39;</span>);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     <span class="comment">// save this for future iterations</span>
<a name="l00889"></a>00889     <span class="keywordflow">if</span> (!isset($this-&gt;customFieldIds)) {
<a name="l00890"></a>00890       $this-&gt;customFieldIds = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00891"></a>00891           -&gt;select(<span class="stringliteral">&#39;pcf.person_custom_field&#39;</span>)
<a name="l00892"></a>00892           -&gt;addSelect(<span class="stringliteral">&#39;pcf.id&#39;</span>)
<a name="l00893"></a>00893           -&gt;from(<span class="stringliteral">&#39;agPersonCustomField pcf&#39;</span>)
<a name="l00894"></a>00894           -&gt;whereIn(<span class="stringliteral">&#39;pcf.person_custom_field&#39;</span>, array_values($importCustomFields))
<a name="l00895"></a>00895           -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     $customFieldIds = $this-&gt;customFieldIds;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     <span class="comment">// first loop through and grab all our personIds into a single array</span>
<a name="l00900"></a>00900     <span class="comment">// we intentionally let this fail if there is no person id since we should never have that case</span>
<a name="l00901"></a>00901     $personIds = array();
<a name="l00902"></a>00902     $updatedPersonCustomField = array();
<a name="l00903"></a>00903     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l00904"></a>00904       $personIds[$rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>]] = $rowId;
<a name="l00905"></a>00905       $updatedPersonCustomField[$rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>]] = array();
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <span class="comment">// get all of our custom records in a collection</span>
<a name="l00909"></a>00909     $coll = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>($conn)
<a name="l00910"></a>00910         -&gt;select(<span class="stringliteral">&#39;pcv.*&#39;</span>)
<a name="l00911"></a>00911         -&gt;from(<span class="stringliteral">&#39;agPersonCustomFieldValue pcv&#39;</span>)
<a name="l00912"></a>00912         -&gt;whereIn(<span class="stringliteral">&#39;pcv.person_id&#39;</span>, array_keys($personIds))
<a name="l00913"></a>00913         -&gt;execute();
<a name="l00914"></a>00914 
<a name="l00915"></a>00915     <span class="comment">// Perform custom updates on person with existing custom fields.</span>
<a name="l00916"></a>00916     <span class="keywordflow">foreach</span> ($coll AS $index =&gt; $record) {
<a name="l00917"></a>00917       $pId = $record[<span class="stringliteral">&#39;person_id&#39;</span>];
<a name="l00918"></a>00918       $rawData = $this-&gt;importData[$personIds[$pId]][<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l00919"></a>00919       $recordCustomFieldId = $record[<span class="stringliteral">&#39;person_custom_field_id&#39;</span>];
<a name="l00920"></a>00920       $customField = array_search(array_search($recordCustomFieldId, $customFieldIds),
<a name="l00921"></a>00921                                                $importCustomFields);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923       <span class="keywordflow">if</span> (isset($rawData[$customField])) {
<a name="l00924"></a>00924         $record[<span class="stringliteral">&#39;value&#39;</span>] = $rawData[$customField];
<a name="l00925"></a>00925         $updatedPersonCustomField[$pId][] = $customField;
<a name="l00926"></a>00926       } <span class="keywordflow">else</span> {
<a name="l00927"></a>00927         <span class="comment">// Delete record if record exists in db, but none is provided in import.</span>
<a name="l00928"></a>00928         $coll-&gt;remove($index);
<a name="l00929"></a>00929         $updatedPersonCustomField[$pId][] = $customField;
<a name="l00930"></a>00930       }
<a name="l00931"></a>00931     }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="keywordflow">try</span> {
<a name="l00934"></a>00934       $coll-&gt;save($conn);
<a name="l00935"></a>00935     } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00936"></a>00936       <span class="keywordflow">if</span> ($throwOnError) {
<a name="l00937"></a>00937         <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($errMsg);
<a name="l00938"></a>00938       }
<a name="l00939"></a>00939     }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     $coll-&gt;free();
<a name="l00942"></a>00942     unset($coll);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     $personCustomFieldTable = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agPersonCustomFieldValue&#39;</span>);
<a name="l00945"></a>00945     $coll = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agPersonCustomFieldValue&#39;</span>);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="comment">// Now process person with new custom field if provided in import.</span>
<a name="l00948"></a>00948     <span class="keywordflow">foreach</span> ($personIds AS $pId =&gt; $rowId) {
<a name="l00949"></a>00949       <span class="keywordflow">if</span> (count($updatedPersonCustomField[$pId]) &lt; count($importCustomFields)) {
<a name="l00950"></a>00950         $newCustomFields = array_diff(array_keys($importCustomFields),
<a name="l00951"></a>00951                                                  $updatedPersonCustomField[$pId]);
<a name="l00952"></a>00952         $rawData = $this-&gt;importData[$personIds[$pId]][<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l00953"></a>00953         <span class="keywordflow">foreach</span> ($newCustomFields AS $customField) {
<a name="l00954"></a>00954           $mappedCustomField = $importCustomFields[$customField];
<a name="l00955"></a>00955           <span class="keywordflow">if</span> (isset($rawData[$customField])) {
<a name="l00956"></a>00956             $nRec = <span class="keyword">new</span> <a class="code" href="classagPersonCustomFieldValue.html">agPersonCustomFieldValue</a>($personCustomFieldTable, TRUE);
<a name="l00957"></a>00957             $nRec[<span class="stringliteral">&#39;person_id&#39;</span>] = $pId;
<a name="l00958"></a>00958             $nRec[<span class="stringliteral">&#39;person_custom_field_id&#39;</span>] = $customFieldIds[$importCustomFields[$customField]];
<a name="l00959"></a>00959             $nRec[<span class="stringliteral">&#39;value&#39;</span>] = $rawData[$customField];
<a name="l00960"></a>00960 
<a name="l00961"></a>00961             $coll-&gt;add($nRec);
<a name="l00962"></a>00962           }
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964       }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966       <span class="comment">// get a little memory back</span>
<a name="l00967"></a>00967       unset($personIds[$pId]);
<a name="l00968"></a>00968       unset($updatedPersonCustomField[$pId]);
<a name="l00969"></a>00969     }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971     <span class="comment">// save</span>
<a name="l00972"></a>00972     $coll-&gt;save($conn);
<a name="l00973"></a>00973     $coll-&gt;free();
<a name="l00974"></a>00974   }
<a name="l00975"></a>00975 
<a name="l00983"></a><a class="code" href="classagStaffImportNormalization.html#a3767926b28648c7c29f7d9b378867e80">00983</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a3767926b28648c7c29f7d9b378867e80" title="Method to set staff&amp;#39;s resource and organization relations during staff import...">setStaffResourceOrg</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00984"></a>00984   {
<a name="l00985"></a>00985     <span class="keywordflow">if</span> (!isset($this-&gt;organizationIds)) {
<a name="l00986"></a>00986       $this-&gt;organizationIds = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00987"></a>00987           -&gt;select(<span class="stringliteral">&#39;o.organization&#39;</span>)
<a name="l00988"></a>00988           -&gt;addSelect(<span class="stringliteral">&#39;o.id&#39;</span>)
<a name="l00989"></a>00989           -&gt;from(<span class="stringliteral">&#39;agOrganization o&#39;</span>)
<a name="l00990"></a>00990           -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00991"></a>00991       $this-&gt;organizationIds = array_change_key_case($this-&gt;organizationIds, CASE_LOWER);
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993     $organizationIds = $this-&gt;organizationIds;
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     <span class="keywordflow">if</span> (!isset($this-&gt;stfRscTypeIds)) {
<a name="l00996"></a>00996       $this-&gt;stfRscTypeIds = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00997"></a>00997           -&gt;select(<span class="stringliteral">&#39;srt.staff_resource_type&#39;</span>)
<a name="l00998"></a>00998           -&gt;addSelect(<span class="stringliteral">&#39;srt.id&#39;</span>)
<a name="l00999"></a>00999           -&gt;from(<span class="stringliteral">&#39;agStaffResourceType srt&#39;</span>)
<a name="l01000"></a>01000           -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l01001"></a>01001       $this-&gt;stfRscTypeIds = array_change_key_case($this-&gt;stfRscTypeIds, CASE_LOWER);
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003     $stfRscTypeIds = $this-&gt;stfRscTypeIds;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005     <span class="keywordflow">if</span> (!isset($this-&gt;stfRscStatusIds)) {
<a name="l01006"></a>01006       $this-&gt;stfRscStatusIds = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01007"></a>01007           -&gt;select(<span class="stringliteral">&#39;srs.staff_resource_status&#39;</span>)
<a name="l01008"></a>01008           -&gt;addSelect(<span class="stringliteral">&#39;srs.id&#39;</span>)
<a name="l01009"></a>01009           -&gt;from(<span class="stringliteral">&#39;agStaffResourceStatus srs&#39;</span>)
<a name="l01010"></a>01010           -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l01011"></a>01011       $this-&gt;stfRscStatusIds = array_change_key_case($this-&gt;stfRscStatusIds, CASE_LOWER);
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013     $stfRscStatusIds = $this-&gt;stfRscStatusIds;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="comment">// check for required columns</span>
<a name="l01016"></a>01016     $staffIds = array();
<a name="l01017"></a>01017     $requiredColumns = array( <span class="stringliteral">&#39;organization&#39;</span> =&gt; <span class="stringliteral">&#39;organizationIds&#39;</span>,
<a name="l01018"></a>01018                               <span class="stringliteral">&#39;resource_type&#39;</span> =&gt; <span class="stringliteral">&#39;stfRscTypeIds&#39;</span>,
<a name="l01019"></a>01019                               <span class="stringliteral">&#39;resource_status&#39;</span> =&gt; <span class="stringliteral">&#39;stfRscStatusIds&#39;</span>);
<a name="l01020"></a>01020     <span class="keywordflow">foreach</span> ($this-&gt;importData AS $rowId =&gt; &amp;$rowData) {
<a name="l01021"></a>01021       <span class="comment">// used at the end to determine whether to continue processing this record</span>
<a name="l01022"></a>01022       $err = FALSE;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024       <span class="comment">// loop through each of the required columns and validate it</span>
<a name="l01025"></a>01025       <span class="keywordflow">foreach</span> ($requiredColumns as $column =&gt; $validator) {
<a name="l01026"></a>01026         <span class="keywordflow">if</span> (! isset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$column])) {
<a name="l01027"></a>01027           $errMsg = <span class="stringliteral">&#39;Required column &#39;</span> . $column . <span class="stringliteral">&#39; is missing from record id &#39;</span> . $rowId . <span class="charliteral">&#39;.&#39;</span>;
<a name="l01028"></a>01028           $err = TRUE;
<a name="l01029"></a>01029         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!isset(${$validator}[strtolower($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$column])])) {
<a name="l01030"></a>01030           $errMsg = <span class="stringliteral">&#39;Invalid &#39;</span> . $column . <span class="stringliteral">&#39; &quot;&#39;</span> . $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$column] . <span class="stringliteral">&#39;&quot; given for &#39;</span> .
<a name="l01031"></a>01031           <span class="stringliteral">&#39;record id &#39;</span> . $rowId . <span class="charliteral">&#39;.&#39;</span>;
<a name="l01032"></a>01032           $err = TRUE;
<a name="l01033"></a>01033         } <span class="keywordflow">else</span> {
<a name="l01034"></a>01034           $staffIds[$rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;staff_id&#39;</span>]][strtolower($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][<span class="stringliteral">&#39;resource_type&#39;</span>])] = $rowId;
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         <span class="comment">// oh, poo!</span>
<a name="l01038"></a>01038         <span class="keywordflow">if</span> ($err) {
<a name="l01039"></a>01039           <span class="comment">// log our error either way</span>
<a name="l01040"></a>01040           $this-&gt;eh-&gt;logErr($errMsg);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042           <span class="comment">// if our calling method instructs us to throw, let&#39;s do that too</span>
<a name="l01043"></a>01043           <span class="keywordflow">if</span> ($throwOnError) {
<a name="l01044"></a>01044             <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($errMsg);
<a name="l01045"></a>01045           }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047           <span class="comment">// otherwise just break</span>
<a name="l01048"></a>01048           <span class="keywordflow">break</span>;
<a name="l01049"></a>01049         }
<a name="l01050"></a>01050       }
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="comment">// build a collection of good / known staffIds</span>
<a name="l01054"></a>01054     $coll = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>($conn)
<a name="l01055"></a>01055         -&gt;select(<span class="stringliteral">&#39;sr.*&#39;</span>)
<a name="l01056"></a>01056         -&gt;from(<span class="stringliteral">&#39;agStaffResource sr&#39;</span>)
<a name="l01057"></a>01057         -&gt;whereIn(<span class="stringliteral">&#39;sr.staff_id&#39;</span>, array_keys($staffIds))
<a name="l01058"></a>01058         -&gt;execute();
<a name="l01059"></a>01059 
<a name="l01060"></a>01060     <span class="comment">// Perform organization updates on existing staff resource.</span>
<a name="l01061"></a>01061     <span class="keywordflow">foreach</span> ($coll AS $index =&gt; $record) {
<a name="l01062"></a>01062       $stfId = $record[<span class="stringliteral">&#39;staff_id&#39;</span>];
<a name="l01063"></a>01063       $stfRscType = array_search($record[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>], $stfRscTypeIds);
<a name="l01064"></a>01064 
<a name="l01065"></a>01065       <span class="comment">// check for it in our existing db</span>
<a name="l01066"></a>01066       <span class="keywordflow">if</span> (isset($staffIds[$stfId][$stfRscType])) {
<a name="l01067"></a>01067         $rawData = $this-&gt;importData[$staffIds[$stfId][$stfRscType]][<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l01068"></a>01068 
<a name="l01069"></a>01069         $record[<span class="stringliteral">&#39;organization_id&#39;</span>] = $organizationIds[strtolower($rawData[<span class="stringliteral">&#39;organization&#39;</span>])];
<a name="l01070"></a>01070         $record[<span class="stringliteral">&#39;staff_resource_status_id&#39;</span>] = $stfRscStatusIds[strtolower($rawData[<span class="stringliteral">&#39;resource_status&#39;</span>])];
<a name="l01071"></a>01071         unset($staffIds[$stfId][$stfRscType]);
<a name="l01072"></a>01072       }
<a name="l01073"></a>01073     }
<a name="l01074"></a>01074     unset($record);
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     $coll-&gt;save($conn);
<a name="l01077"></a>01077     $coll-&gt;free();
<a name="l01078"></a>01078     unset($coll);
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     $staffResourceTable = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agStaffResource&#39;</span>);
<a name="l01081"></a>01081     $coll = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agStaffResource&#39;</span>);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <span class="comment">// Now $staffIds are left with only new staff resources.</span>
<a name="l01084"></a>01084     <span class="keywordflow">foreach</span> ($staffIds AS $stfId =&gt; $stfResources) {
<a name="l01085"></a>01085       <span class="keywordflow">foreach</span> ($stfResources AS $stfRsc =&gt; $rowId) {
<a name="l01086"></a>01086         <span class="comment">// pick up our rawdata</span>
<a name="l01087"></a>01087         $rawData = $this-&gt;importData[$rowId][<span class="stringliteral">&#39;_rawData&#39;</span>];
<a name="l01088"></a>01088 
<a name="l01089"></a>01089         <span class="comment">// create a new record object</span>
<a name="l01090"></a>01090         $rec = <span class="keyword">new</span> <a class="code" href="classagStaffResource.html">agStaffResource</a>($staffResourceTable, TRUE);
<a name="l01091"></a>01091         $rec[<span class="stringliteral">&#39;staff_id&#39;</span>] = $stfId;
<a name="l01092"></a>01092         $rec[<span class="stringliteral">&#39;organization_id&#39;</span>] = $organizationIds[strtolower($rawData[<span class="stringliteral">&#39;organization&#39;</span>])];
<a name="l01093"></a>01093         $rec[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>] = $stfRscTypeIds[strtolower($rawData[<span class="stringliteral">&#39;resource_type&#39;</span>])];
<a name="l01094"></a>01094         $rec[<span class="stringliteral">&#39;staff_resource_status_id&#39;</span>] = $stfRscStatusIds[strtolower($rawData[<span class="stringliteral">&#39;resource_status&#39;</span>])];
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         <span class="comment">// add it to our collection</span>
<a name="l01097"></a>01097         $coll-&gt;add($rec);
<a name="l01098"></a>01098       }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100       <span class="comment">// try to offset building all those objects a little</span>
<a name="l01101"></a>01101       unset($staffIds[$stfId]);
<a name="l01102"></a>01102     }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <span class="comment">// save and we&#39;re done</span>
<a name="l01105"></a>01105     $coll-&gt;save($conn);
<a name="l01106"></a>01106     $coll-&gt;free();
<a name="l01107"></a>01107   }
<a name="l01108"></a>01108 
<a name="l01115"></a><a class="code" href="classagStaffImportNormalization.html#aa9e247cb84f06dad3248be189d188e9e">01115</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#aa9e247cb84f06dad3248be189d188e9e" title="Method to set person language during staff import.">setPersonLanguage</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l01116"></a>01116   {
<a name="l01117"></a>01117     <span class="comment">// always start with any data maps we&#39;ll need so they&#39;re explicit</span>
<a name="l01118"></a>01118     $importLanguageComponents = array(<span class="stringliteral">&#39;language_1&#39;</span> =&gt; array(<span class="stringliteral">&#39;l1_speak&#39;</span> =&gt; <span class="stringliteral">&#39;speak&#39;</span>,
<a name="l01119"></a>01119         <span class="stringliteral">&#39;l1_read&#39;</span> =&gt; <span class="stringliteral">&#39;read&#39;</span>,
<a name="l01120"></a>01120         <span class="stringliteral">&#39;l1_write&#39;</span> =&gt; <span class="stringliteral">&#39;write&#39;</span>),
<a name="l01121"></a>01121       <span class="stringliteral">&#39;language_2&#39;</span> =&gt; array(<span class="stringliteral">&#39;l2_speak&#39;</span> =&gt; <span class="stringliteral">&#39;speak&#39;</span>,
<a name="l01122"></a>01122         <span class="stringliteral">&#39;l2_read&#39;</span> =&gt; <span class="stringliteral">&#39;read&#39;</span>,
<a name="l01123"></a>01123         <span class="stringliteral">&#39;l2_write&#39;</span> =&gt; <span class="stringliteral">&#39;write&#39;</span>),
<a name="l01124"></a>01124       <span class="stringliteral">&#39;language_3&#39;</span> =&gt; array(<span class="stringliteral">&#39;l3_speak&#39;</span> =&gt; <span class="stringliteral">&#39;speak&#39;</span>,
<a name="l01125"></a>01125         <span class="stringliteral">&#39;l3_read&#39;</span> =&gt; <span class="stringliteral">&#39;read&#39;</span>,
<a name="l01126"></a>01126         <span class="stringliteral">&#39;l3_write&#39;</span> =&gt; <span class="stringliteral">&#39;write&#39;</span>)
<a name="l01127"></a>01127     );
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     $personLanguages = array();
<a name="l01130"></a>01130     $results = array();
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <span class="comment">// let&#39;s get ahold of our helper object since we&#39;re going to use him/her a lot</span>
<a name="l01133"></a>01133     $plh = &amp; $this-&gt;helperObjects[<span class="stringliteral">&#39;agPersonLanguageHelper&#39;</span>];
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="comment">// loop through our raw data and build our person language data</span>
<a name="l01137"></a>01137     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; $rowData) {
<a name="l01138"></a>01138       <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>])) {
<a name="l01139"></a>01139         <span class="comment">// this just makes it easier to use</span>
<a name="l01140"></a>01140         $personId = $rowData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;person_id&#39;</span>];
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         <span class="comment">// Always initialize $languageComponents as an empty array.  Assign an empty array to</span>
<a name="l01143"></a>01143         <span class="comment">// $personLanguages only if no language was specified from import.</span>
<a name="l01144"></a>01144         $languageComponents = array();
<a name="l01145"></a>01145         <span class="keywordflow">foreach</span> ($importLanguageComponents as $importLanguage =&gt; $langComponents) {
<a name="l01146"></a>01146           <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$importLanguage])) {
<a name="l01147"></a>01147             <span class="comment">// Always initialize $formatCompetencies as an emtpy array. Assign an emtpy array to</span>
<a name="l01148"></a>01148             <span class="comment">// $languageComponents only if no format/competency details is specified for the</span>
<a name="l01149"></a>01149             <span class="comment">// language from import.</span>
<a name="l01150"></a>01150             $formatCompetencies = array();
<a name="l01151"></a>01151             <span class="keywordflow">foreach</span> ($langComponents as $importFormat =&gt; $dbFormat) {
<a name="l01152"></a>01152               <span class="keywordflow">if</span> (isset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$importFormat])) {
<a name="l01153"></a>01153                 $formatCompetencies[$dbFormat] = $rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$importFormat];
<a name="l01154"></a>01154               }
<a name="l01155"></a>01155             }
<a name="l01156"></a>01156             $languageComponents[] = array($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$importLanguage], $formatCompetencies);
<a name="l01157"></a>01157           }
<a name="l01158"></a>01158         }
<a name="l01159"></a>01159         $personLanguages[$personId] = $languageComponents;
<a name="l01160"></a>01160       }
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <span class="comment">// pick up some of our components / objects</span>
<a name="l01164"></a>01164     $keepHistory = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_import_keep_history&#39;</span>);
<a name="l01165"></a>01165     $createEdgeTableValues = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;create_edge_table_values&#39;</span>);
<a name="l01166"></a>01166     ;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     <span class="comment">// execute the helper and finish</span>
<a name="l01169"></a>01169     $results = $plh-&gt;setPersonLanguages($personLanguages, $keepHistory, $createEdgeTableValues,
<a name="l01170"></a>01170                                         $throwOnError, $conn);
<a name="l01171"></a>01171     unset($personLanguages);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     <span class="comment">// @todo do your results reporting here</span>
<a name="l01174"></a>01174   }
<a name="l01175"></a>01175 
<a name="l01182"></a><a class="code" href="classagStaffImportNormalization.html#a1d1ebc2c48fe6ffe4494b12d9d8ca0a5">01182</a>   <span class="keyword">protected</span> function <a class="code" href="classagStaffImportNormalization.html#a1d1ebc2c48fe6ffe4494b12d9d8ca0a5" title="Method to set import entity hash for future retrieval.">setImportEntityHash</a>($throwOnError, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l01183"></a>01183   {
<a name="l01184"></a>01184     $entityHashes = array();
<a name="l01185"></a>01185     $table = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aebd0b52171048edc55a9cf7edefcfa4a" title="returns a table object for given component name">getTable</a>(<span class="stringliteral">&#39;agImportEntityHash&#39;</span>);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187     <span class="comment">// simplify our array to be a k/v pair</span>
<a name="l01188"></a>01188     <span class="keywordflow">foreach</span> ($this-&gt;importData as $importData) {
<a name="l01189"></a>01189       $entityHashes[$importData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;entity_id&#39;</span>]] = $importData[<span class="stringliteral">&#39;primaryKeys&#39;</span>][<span class="stringliteral">&#39;import_hash&#39;</span>];
<a name="l01190"></a>01190     }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <span class="comment">// find all existing records</span>
<a name="l01193"></a>01193     $coll = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>($conn)
<a name="l01194"></a>01194       -&gt;select(<span class="charliteral">&#39;*&#39;</span>)
<a name="l01195"></a>01195         -&gt;from(<span class="stringliteral">&#39;agImportEntityHash ieh INDEXBY ieh.entity_id&#39;</span>)
<a name="l01196"></a>01196         -&gt;whereIn(<span class="stringliteral">&#39;ieh.entity_id&#39;</span>, array_keys($entityHashes))
<a name="l01197"></a>01197         -&gt;execute();
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="comment">// update existing row hashes</span>
<a name="l01200"></a>01200     <span class="keywordflow">foreach</span> ($coll as $entityId =&gt; $rec) {
<a name="l01201"></a>01201       $rec[<span class="stringliteral">&#39;row_hash&#39;</span>] = $entityHashes[$entityId];
<a name="l01202"></a>01202       unset($entityHashes[$entityId]);
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205     <span class="comment">// make new records as appropriate</span>
<a name="l01206"></a>01206     <span class="keywordflow">foreach</span> ($entityHashes as $entityId =&gt; $importHash) {
<a name="l01207"></a>01207       $rec = <span class="keyword">new</span> <a class="code" href="classagImportEntityHash.html">agImportEntityHash</a>($table, TRUE);
<a name="l01208"></a>01208       $rec[<span class="stringliteral">&#39;entity_id&#39;</span>] = $entityId;
<a name="l01209"></a>01209       $rec[<span class="stringliteral">&#39;row_hash&#39;</span>] = $importHash;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211       <span class="comment">// this shouldn&#39;t error if entity uniqueness is preserved above</span>
<a name="l01212"></a>01212       $coll-&gt;add($rec, $entityId);
<a name="l01213"></a>01213     }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215     <span class="comment">// save and release</span>
<a name="l01216"></a>01216     $coll-&gt;save($conn);
<a name="l01217"></a>01217     $coll-&gt;free();
<a name="l01218"></a>01218   }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
