<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: web/wiki/inc/geshi.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>web/wiki/inc/geshi.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00036"></a>00036 <span class="comment">//</span>
<a name="l00037"></a>00037 <span class="comment">// GeSHi Constants</span>
<a name="l00038"></a>00038 <span class="comment">// You should use these constant names in your programs instead of</span>
<a name="l00039"></a>00039 <span class="comment">// their values - you never know when a value may change in a future</span>
<a name="l00040"></a>00040 <span class="comment">// version</span>
<a name="l00041"></a>00041 <span class="comment">//</span>
<a name="l00042"></a>00042 
<a name="l00044"></a>00044 define(<span class="stringliteral">&#39;GESHI_VERSION&#39;</span>, <span class="stringliteral">&#39;1.0.8.8&#39;</span>);
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// Define the root directory for the GeSHi code tree</span>
<a name="l00047"></a>00047 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;GESHI_ROOT&#39;</span>)) {
<a name="l00049"></a>00049     define(<span class="stringliteral">&#39;GESHI_ROOT&#39;</span>, dirname(__FILE__) . DIRECTORY_SEPARATOR);
<a name="l00050"></a>00050 }
<a name="l00053"></a>00053 define(<span class="stringliteral">&#39;GESHI_LANG_ROOT&#39;</span>, GESHI_ROOT . <span class="stringliteral">&#39;geshi&#39;</span> . DIRECTORY_SEPARATOR);
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">// Define if GeSHi should be paranoid about security</span>
<a name="l00056"></a>00056 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;GESHI_SECURITY_PARANOID&#39;</span>)) {
<a name="l00058"></a>00058     define(<span class="stringliteral">&#39;GESHI_SECURITY_PARANOID&#39;</span>, <span class="keyword">false</span>);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">// Line numbers - use with enable_line_numbers()</span>
<a name="l00063"></a>00063 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NO_LINE_NUMBERS&#39;</span>, 0);
<a name="l00065"></a>00065 define(<span class="stringliteral">&#39;GESHI_NORMAL_LINE_NUMBERS&#39;</span>, 1);
<a name="l00067"></a>00067 define(<span class="stringliteral">&#39;GESHI_FANCY_LINE_NUMBERS&#39;</span>, 2);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">// Container HTML type</span>
<a name="l00071"></a>00071 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_HEADER_NONE&#39;</span>, 0);
<a name="l00073"></a>00073 define(<span class="stringliteral">&#39;GESHI_HEADER_DIV&#39;</span>, 1);
<a name="l00075"></a>00075 define(<span class="stringliteral">&#39;GESHI_HEADER_PRE&#39;</span>, 2);
<a name="l00077"></a>00077 define(<span class="stringliteral">&#39;GESHI_HEADER_PRE_VALID&#39;</span>, 3);
<a name="l00091"></a>00091 define(<span class="stringliteral">&#39;GESHI_HEADER_PRE_TABLE&#39;</span>, 4);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">// Capatalisation constants</span>
<a name="l00095"></a>00095 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_CAPS_NO_CHANGE&#39;</span>, 0);
<a name="l00097"></a>00097 define(<span class="stringliteral">&#39;GESHI_CAPS_UPPER&#39;</span>, 1);
<a name="l00099"></a>00099 define(<span class="stringliteral">&#39;GESHI_CAPS_LOWER&#39;</span>, 2);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">// Link style constants</span>
<a name="l00103"></a>00103 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_LINK&#39;</span>, 0);
<a name="l00105"></a>00105 define(<span class="stringliteral">&#39;GESHI_HOVER&#39;</span>, 1);
<a name="l00107"></a>00107 define(<span class="stringliteral">&#39;GESHI_ACTIVE&#39;</span>, 2);
<a name="l00109"></a>00109 define(<span class="stringliteral">&#39;GESHI_VISITED&#39;</span>, 3);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">// Important string starter/finisher</span>
<a name="l00112"></a>00112 <span class="comment">// Note that if you change these, they should be as-is: i.e., don&#39;t</span>
<a name="l00113"></a>00113 <span class="comment">// write them as if they had been run through htmlentities()</span>
<a name="l00115"></a>00115 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_START_IMPORTANT&#39;</span>, <span class="stringliteral">&#39;&lt;BEGIN GeSHi&gt;&#39;</span>);
<a name="l00117"></a>00117 define(<span class="stringliteral">&#39;GESHI_END_IMPORTANT&#39;</span>, <span class="stringliteral">&#39;&lt;END GeSHi&gt;&#39;</span>);
<a name="l00118"></a>00118 
<a name="l00122"></a>00122 <span class="comment">// When strict mode applies for a language</span>
<a name="l00124"></a>00124 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NEVER&#39;</span>, 0);
<a name="l00127"></a>00127 define(<span class="stringliteral">&#39;GESHI_MAYBE&#39;</span>, 1);
<a name="l00129"></a>00129 define(<span class="stringliteral">&#39;GESHI_ALWAYS&#39;</span>, 2);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="comment">// Advanced regexp handling constants, used in language files</span>
<a name="l00133"></a>00133 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_SEARCH&#39;</span>, 0);
<a name="l00136"></a>00136 define(<span class="stringliteral">&#39;GESHI_REPLACE&#39;</span>, 1);
<a name="l00138"></a>00138 define(<span class="stringliteral">&#39;GESHI_MODIFIERS&#39;</span>, 2);
<a name="l00141"></a>00141 define(<span class="stringliteral">&#39;GESHI_BEFORE&#39;</span>, 3);
<a name="l00144"></a>00144 define(<span class="stringliteral">&#39;GESHI_AFTER&#39;</span>, 4);
<a name="l00147"></a>00147 define(<span class="stringliteral">&#39;GESHI_CLASS&#39;</span>, 5);
<a name="l00148"></a>00148 
<a name="l00150"></a>00150 define(<span class="stringliteral">&#39;GESHI_COMMENTS&#39;</span>, 0);
<a name="l00151"></a>00151 
<a name="l00153"></a>00153 define(<span class="stringliteral">&#39;GESHI_PHP_PRE_433&#39;</span>, !(version_compare(PHP_VERSION, <span class="stringliteral">&#39;4.3.3&#39;</span>) === 1));
<a name="l00154"></a>00154 
<a name="l00156"></a>00156 <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;stripos&#39;</span>)) {
<a name="l00157"></a>00157     <span class="comment">// the offset param of preg_match is not supported below PHP 4.3.3</span>
<a name="l00158"></a>00158     <span class="keywordflow">if</span> (GESHI_PHP_PRE_433) {
<a name="l00162"></a>00162         function stripos($haystack, $needle, $offset = null) {
<a name="l00163"></a>00163             <span class="keywordflow">if</span> (!is_null($offset)) {
<a name="l00164"></a>00164                 $haystack = substr($haystack, $offset);
<a name="l00165"></a>00165             }
<a name="l00166"></a>00166             <span class="keywordflow">if</span> (preg_match(<span class="charliteral">&#39;/&#39;</span>. preg_quote($needle, <span class="charliteral">&#39;/&#39;</span>) . <span class="charliteral">&#39;/&#39;</span>, $haystack, $match, PREG_OFFSET_CAPTURE)) {
<a name="l00167"></a>00167                 <span class="keywordflow">return</span> $match[0][1];
<a name="l00168"></a>00168             }
<a name="l00169"></a>00169             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172     <span class="keywordflow">else</span> {
<a name="l00176"></a>00176         function stripos($haystack, $needle, $offset = null) {
<a name="l00177"></a>00177             <span class="keywordflow">if</span> (preg_match(<span class="charliteral">&#39;/&#39;</span>. preg_quote($needle, <span class="charliteral">&#39;/&#39;</span>) . <span class="charliteral">&#39;/&#39;</span>, $haystack, $match, PREG_OFFSET_CAPTURE, $offset)) {
<a name="l00178"></a>00178                 <span class="keywordflow">return</span> $match[0][1];
<a name="l00179"></a>00179             }
<a name="l00180"></a>00180             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00181"></a>00181         }
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00189"></a>00189 define(<span class="stringliteral">&#39;GESHI_MAX_PCRE_SUBPATTERNS&#39;</span>, 500);
<a name="l00195"></a>00195 define(<span class="stringliteral">&#39;GESHI_MAX_PCRE_LENGTH&#39;</span>, 12288);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">//Number format specification</span>
<a name="l00199"></a>00199 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_INT_BASIC&#39;</span>, 1);        <span class="comment">//Default integers \d+</span>
<a name="l00201"></a>00201 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_INT_CSTYLE&#39;</span>, 2);       <span class="comment">//Default C-Style \d+[lL]?</span>
<a name="l00203"></a>00203 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_BIN_SUFFIX&#39;</span>, 16);           <span class="comment">//[01]+[bB]</span>
<a name="l00205"></a>00205 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_BIN_PREFIX_PERCENT&#39;</span>, 32);   <span class="comment">//%[01]+</span>
<a name="l00207"></a>00207 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_BIN_PREFIX_0B&#39;</span>, 64);        <span class="comment">//0b[01]+</span>
<a name="l00209"></a>00209 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_OCT_PREFIX&#39;</span>, 256);           <span class="comment">//0[0-7]+</span>
<a name="l00211"></a>00211 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_OCT_PREFIX_0O&#39;</span>, 512);           <span class="comment">//0[0-7]+</span>
<a name="l00213"></a>00213 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_OCT_SUFFIX&#39;</span>, 1024);           <span class="comment">//[0-7]+[oO]</span>
<a name="l00215"></a>00215 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_HEX_PREFIX&#39;</span>, 4096);           <span class="comment">//0x[0-9a-fA-F]+</span>
<a name="l00217"></a>00217 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_HEX_SUFFIX&#39;</span>, 8192);           <span class="comment">//[0-9][0-9a-fA-F]*h</span>
<a name="l00219"></a>00219 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_FLT_NONSCI&#39;</span>, 65536);          <span class="comment">//\d+\.\d+</span>
<a name="l00221"></a>00221 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_FLT_NONSCI_F&#39;</span>, 131072);       <span class="comment">//\d+(\.\d+)?f</span>
<a name="l00223"></a>00223 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_FLT_SCI_SHORT&#39;</span>, 262144);      <span class="comment">//\.\d+e\d+</span>
<a name="l00225"></a>00225 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_NUMBER_FLT_SCI_ZERO&#39;</span>, 524288);       <span class="comment">//\d+(\.\d+)?e\d+</span>
<a name="l00226"></a>00226 <span class="comment">//Custom formats are passed by RX array</span>
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">// Error detection - use these to analyse faults</span>
<a name="l00232"></a>00232 <span class="comment"></span>define(<span class="stringliteral">&#39;GESHI_ERROR_NO_INPUT&#39;</span>, 1);
<a name="l00234"></a>00234 define(<span class="stringliteral">&#39;GESHI_ERROR_NO_SUCH_LANG&#39;</span>, 2);
<a name="l00236"></a>00236 define(<span class="stringliteral">&#39;GESHI_ERROR_FILE_NOT_READABLE&#39;</span>, 3);
<a name="l00238"></a>00238 define(<span class="stringliteral">&#39;GESHI_ERROR_INVALID_HEADER_TYPE&#39;</span>, 4);
<a name="l00240"></a>00240 define(<span class="stringliteral">&#39;GESHI_ERROR_INVALID_LINE_NUMBER_TYPE&#39;</span>, 5);
<a name="l00255"></a><a class="code" href="classGeSHi.html">00255</a> <span class="keyword">class </span><a class="code" href="classGeSHi.html">GeSHi</a> {
<a name="l00263"></a>00263     var $source = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00264"></a>00264 
<a name="l00269"></a>00269     var $language = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00270"></a>00270 
<a name="l00275"></a>00275     var $language_data = array();
<a name="l00276"></a>00276 
<a name="l00281"></a>00281     var $language_path = GESHI_LANG_ROOT;
<a name="l00282"></a>00282 
<a name="l00288"></a>00288     var $error = <span class="keyword">false</span>;
<a name="l00289"></a>00289 
<a name="l00294"></a>00294     var $error_messages = array(
<a name="l00295"></a>00295         GESHI_ERROR_NO_SUCH_LANG =&gt; <span class="stringliteral">&#39;GeSHi could not find the language {LANGUAGE} (using path {PATH})&#39;</span>,
<a name="l00296"></a>00296         GESHI_ERROR_FILE_NOT_READABLE =&gt; <span class="stringliteral">&#39;The file specified for load_from_file was not readable&#39;</span>,
<a name="l00297"></a>00297         GESHI_ERROR_INVALID_HEADER_TYPE =&gt; <span class="stringliteral">&#39;The header type specified is invalid&#39;</span>,
<a name="l00298"></a>00298         GESHI_ERROR_INVALID_LINE_NUMBER_TYPE =&gt; <span class="stringliteral">&#39;The line number type specified is invalid&#39;</span>
<a name="l00299"></a>00299     );
<a name="l00300"></a>00300 
<a name="l00305"></a>00305     var $strict_mode = <span class="keyword">false</span>;
<a name="l00306"></a>00306 
<a name="l00311"></a>00311     var $use_classes = <span class="keyword">false</span>;
<a name="l00312"></a>00312 
<a name="l00323"></a>00323     var $header_type = GESHI_HEADER_PRE;
<a name="l00324"></a>00324 
<a name="l00329"></a>00329     var $lexic_permissions = array(
<a name="l00330"></a>00330         <span class="stringliteral">&#39;KEYWORDS&#39;</span> =&gt;    array(),
<a name="l00331"></a>00331         <span class="stringliteral">&#39;COMMENTS&#39;</span> =&gt;    array(<span class="stringliteral">&#39;MULTI&#39;</span> =&gt; <span class="keyword">true</span>),
<a name="l00332"></a>00332         <span class="stringliteral">&#39;REGEXPS&#39;</span> =&gt;     array(),
<a name="l00333"></a>00333         <span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00334"></a>00334         <span class="stringliteral">&#39;BRACKETS&#39;</span> =&gt;    <span class="keyword">true</span>,
<a name="l00335"></a>00335         <span class="stringliteral">&#39;SYMBOLS&#39;</span> =&gt;     <span class="keyword">false</span>,
<a name="l00336"></a>00336         <span class="stringliteral">&#39;STRINGS&#39;</span> =&gt;     <span class="keyword">true</span>,
<a name="l00337"></a>00337         <span class="stringliteral">&#39;NUMBERS&#39;</span> =&gt;     <span class="keyword">true</span>,
<a name="l00338"></a>00338         <span class="stringliteral">&#39;METHODS&#39;</span> =&gt;     <span class="keyword">true</span>,
<a name="l00339"></a>00339         <span class="stringliteral">&#39;SCRIPT&#39;</span> =&gt;      <span class="keyword">true</span>
<a name="l00340"></a>00340     );
<a name="l00341"></a>00341 
<a name="l00346"></a>00346     var $time = 0;
<a name="l00347"></a>00347 
<a name="l00352"></a>00352     var $header_content = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00353"></a>00353 
<a name="l00358"></a>00358     var $footer_content = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00359"></a>00359 
<a name="l00364"></a>00364     var $header_content_style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00365"></a>00365 
<a name="l00370"></a>00370     var $footer_content_style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00371"></a>00371 
<a name="l00377"></a>00377     var $force_code_block = <span class="keyword">false</span>;
<a name="l00378"></a>00378 
<a name="l00383"></a>00383     var $link_styles = array();
<a name="l00384"></a>00384 
<a name="l00391"></a>00391     var $enable_important_blocks = <span class="keyword">false</span>;
<a name="l00392"></a>00392 
<a name="l00400"></a>00400     var $important_styles = <span class="stringliteral">&#39;font-weight: bold; color: red;&#39;</span>; <span class="comment">// Styles for important parts of the code</span>
<a name="l00401"></a>00401 
<a name="l00406"></a>00406     var $add_ids = <span class="keyword">false</span>;
<a name="l00407"></a>00407 
<a name="l00412"></a>00412     var $highlight_extra_lines = array();
<a name="l00413"></a>00413 
<a name="l00418"></a>00418     var $highlight_extra_lines_styles = array();
<a name="l00419"></a>00419 
<a name="l00424"></a>00424     var $highlight_extra_lines_style = <span class="stringliteral">&#39;background-color: #ffc;&#39;</span>;
<a name="l00425"></a>00425 
<a name="l00432"></a>00432     var $line_ending = null;
<a name="l00433"></a>00433 
<a name="l00438"></a>00438     var $line_numbers_start = 1;
<a name="l00439"></a>00439 
<a name="l00444"></a>00444     var $overall_style = <span class="stringliteral">&#39;font-family:monospace;&#39;</span>;
<a name="l00445"></a>00445 
<a name="l00450"></a>00450     var $code_style = <span class="stringliteral">&#39;font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;&#39;</span>;
<a name="l00451"></a>00451 
<a name="l00456"></a>00456     var $overall_class = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00457"></a>00457 
<a name="l00462"></a>00462     var $overall_id = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00463"></a>00463 
<a name="l00468"></a>00468     var $line_style1 = <span class="stringliteral">&#39;font-weight: normal; vertical-align:top;&#39;</span>;
<a name="l00469"></a>00469 
<a name="l00474"></a>00474     var $line_style2 = <span class="stringliteral">&#39;font-weight: bold; vertical-align:top;&#39;</span>;
<a name="l00475"></a>00475 
<a name="l00480"></a>00480     var $table_linenumber_style = <span class="stringliteral">&#39;width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;&#39;</span>;
<a name="l00481"></a>00481 
<a name="l00486"></a>00486     var $line_numbers = GESHI_NO_LINE_NUMBERS;
<a name="l00487"></a>00487 
<a name="l00493"></a>00493     var $allow_multiline_span = <span class="keyword">true</span>;
<a name="l00494"></a>00494 
<a name="l00499"></a>00499     var $line_nth_row = 0;
<a name="l00500"></a>00500 
<a name="l00505"></a>00505     var $tab_width = 8;
<a name="l00506"></a>00506 
<a name="l00511"></a>00511     var $use_language_tab_width = <span class="keyword">false</span>;
<a name="l00512"></a>00512 
<a name="l00517"></a>00517     var $link_target = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00518"></a>00518 
<a name="l00524"></a>00524     var $encoding = <span class="stringliteral">&#39;utf-8&#39;</span>;
<a name="l00525"></a>00525 
<a name="l00530"></a>00530     var $keyword_links = <span class="keyword">true</span>;
<a name="l00531"></a>00531 
<a name="l00537"></a>00537     var $loaded_language = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00538"></a>00538 
<a name="l00545"></a>00545     var $parse_cache_built = <span class="keyword">false</span>;
<a name="l00546"></a>00546 
<a name="l00562"></a>00562     var $_kw_replace_group = 0;
<a name="l00563"></a>00563     var $_rx_key = 0;
<a name="l00564"></a>00564 
<a name="l00572"></a>00572     var $_hmr_before = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00573"></a>00573     var $_hmr_replace = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00574"></a>00574     var $_hmr_after = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00575"></a>00575     var $_hmr_key = 0;
<a name="l00576"></a>00576 
<a name="l00593"></a><a class="code" href="classGeSHi.html#a412055a65982b44e5cb73f76de5f2829">00593</a>     function <a class="code" href="classGeSHi.html#a412055a65982b44e5cb73f76de5f2829" title="#@-">GeSHi</a>($source = <span class="stringliteral">&#39;&#39;</span>, $language = <span class="stringliteral">&#39;&#39;</span>, $path = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00594"></a>00594         <span class="keywordflow">if</span> (!empty($source)) {
<a name="l00595"></a>00595             $this-&gt;<a class="code" href="classGeSHi.html#afae4820fed4615380c073cb2ffdaffff" title="Sets the source code for this object.">set_source</a>($source);
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597         <span class="keywordflow">if</span> (!empty($language)) {
<a name="l00598"></a>00598             $this-&gt;<a class="code" href="classGeSHi.html#a0b0ff783617df971bd15d402bc64b84a" title="Sets the language for this object.">set_language</a>($language);
<a name="l00599"></a>00599         }
<a name="l00600"></a>00600         $this-&gt;<a class="code" href="classGeSHi.html#abb84f83f6ed54294258f4a20ced3cd1d" title="Sets the path to the directory containing the language files.">set_language_path</a>($path);
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602 
<a name="l00610"></a><a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578">00610</a>     function <a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a>() {
<a name="l00611"></a>00611         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a>) {
<a name="l00612"></a>00612             <span class="comment">//Put some template variables for debugging here ...</span>
<a name="l00613"></a>00613             $debug_tpl_vars = array(
<a name="l00614"></a>00614                 <span class="stringliteral">&#39;{LANGUAGE}&#39;</span> =&gt; $this-&gt;language,
<a name="l00615"></a>00615                 <span class="stringliteral">&#39;{PATH}&#39;</span> =&gt; $this-&gt;language_path
<a name="l00616"></a>00616             );
<a name="l00617"></a>00617             $msg = str_replace(
<a name="l00618"></a>00618                 array_keys($debug_tpl_vars),
<a name="l00619"></a>00619                 array_values($debug_tpl_vars),
<a name="l00620"></a>00620                 $this-&gt;error_messages[$this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a>]);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622             <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;br /&gt;&lt;strong&gt;GeSHi Error:&lt;/strong&gt; $msg (code {$this-&gt;error})&lt;br /&gt;&quot;</span>;
<a name="l00623"></a>00623         }
<a name="l00624"></a>00624         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 
<a name="l00634"></a><a class="code" href="classGeSHi.html#a09f8d1f4f597ffaa486f4792415caa1b">00634</a>     function <a class="code" href="classGeSHi.html#a09f8d1f4f597ffaa486f4792415caa1b" title="Gets a human-readable language name (thanks to Simon Patterson for the idea :)).">get_language_name</a>() {
<a name="l00635"></a>00635         <span class="keywordflow">if</span> (GESHI_ERROR_NO_SUCH_LANG == $this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a>) {
<a name="l00636"></a>00636             <span class="keywordflow">return</span> $this-&gt;language_data[<span class="stringliteral">&#39;LANG_NAME&#39;</span>] . <span class="stringliteral">&#39; (Unknown Language)&#39;</span>;
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638         <span class="keywordflow">return</span> $this-&gt;language_data[<span class="stringliteral">&#39;LANG_NAME&#39;</span>];
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640 
<a name="l00647"></a><a class="code" href="classGeSHi.html#afae4820fed4615380c073cb2ffdaffff">00647</a>     function <a class="code" href="classGeSHi.html#afae4820fed4615380c073cb2ffdaffff" title="Sets the source code for this object.">set_source</a>($source) {
<a name="l00648"></a>00648         $this-&gt;source = $source;
<a name="l00649"></a>00649         $this-&gt;highlight_extra_lines = array();
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651 
<a name="l00661"></a><a class="code" href="classGeSHi.html#a0b0ff783617df971bd15d402bc64b84a">00661</a>     function <a class="code" href="classGeSHi.html#a0b0ff783617df971bd15d402bc64b84a" title="Sets the language for this object.">set_language</a>($language, $force_reset = <span class="keyword">false</span>) {
<a name="l00662"></a>00662         <span class="keywordflow">if</span> ($force_reset) {
<a name="l00663"></a>00663             $this-&gt;loaded_language = <span class="keyword">false</span>;
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="comment">//Clean up the language name to prevent malicious code injection</span>
<a name="l00667"></a>00667         $language = preg_replace(<span class="stringliteral">&#39;#[^a-zA-Z0-9\-_]#&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $language);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669         $language = strtolower($language);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <span class="comment">//Retreive the full filename</span>
<a name="l00672"></a>00672         $file_name = $this-&gt;language_path . $language . <span class="stringliteral">&#39;.php&#39;</span>;
<a name="l00673"></a>00673         <span class="keywordflow">if</span> ($file_name == $this-&gt;loaded_language) {
<a name="l00674"></a>00674             <span class="comment">// this language is already loaded!</span>
<a name="l00675"></a>00675             <span class="keywordflow">return</span>;
<a name="l00676"></a>00676         }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         $this-&gt;language = $language;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         $this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a> = <span class="keyword">false</span>;
<a name="l00681"></a>00681         $this-&gt;strict_mode = GESHI_NEVER;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683         <span class="comment">//Check if we can read the desired file</span>
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (!is_readable($file_name)) {
<a name="l00685"></a>00685             $this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a> = GESHI_ERROR_NO_SUCH_LANG;
<a name="l00686"></a>00686             <span class="keywordflow">return</span>;
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         <span class="comment">// Load the language for parsing</span>
<a name="l00690"></a>00690         $this-&gt;<a class="code" href="classGeSHi.html#a7597671dc76f5140b3762e79d8bfd7ec" title="Gets language information and stores it for later use.">load_language</a>($file_name);
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692 
<a name="l00705"></a><a class="code" href="classGeSHi.html#abb84f83f6ed54294258f4a20ced3cd1d">00705</a>     function <a class="code" href="classGeSHi.html#abb84f83f6ed54294258f4a20ced3cd1d" title="Sets the path to the directory containing the language files.">set_language_path</a>($path) {
<a name="l00706"></a>00706         <span class="keywordflow">if</span>(strpos($path,<span class="charliteral">&#39;:&#39;</span>)) {
<a name="l00707"></a>00707             <span class="comment">//Security Fix to prevent external directories using fopen wrappers.</span>
<a name="l00708"></a>00708             <span class="keywordflow">if</span>(DIRECTORY_SEPARATOR == <span class="stringliteral">&quot;\\&quot;</span>) {
<a name="l00709"></a>00709                 <span class="keywordflow">if</span>(!preg_match(<span class="stringliteral">&#39;#^[a-zA-Z]:#&#39;</span>, $path) || <span class="keyword">false</span> !== strpos($path, <span class="charliteral">&#39;:&#39;</span>, 2)) {
<a name="l00710"></a>00710                     <span class="keywordflow">return</span>;
<a name="l00711"></a>00711                 }
<a name="l00712"></a>00712             } <span class="keywordflow">else</span> {
<a name="l00713"></a>00713                 <span class="keywordflow">return</span>;
<a name="l00714"></a>00714             }
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716         <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&#39;#[^/a-zA-Z0-9_\.\-\\\s:]#&#39;</span>, $path)) {
<a name="l00717"></a>00717             <span class="comment">//Security Fix to prevent external directories using fopen wrappers.</span>
<a name="l00718"></a>00718             <span class="keywordflow">return</span>;
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720         <span class="keywordflow">if</span>(GESHI_SECURITY_PARANOID &amp;&amp; <span class="keyword">false</span> !== strpos($path, <span class="stringliteral">&#39;/.&#39;</span>)) {
<a name="l00721"></a>00721             <span class="comment">//Security Fix to prevent external directories using fopen wrappers.</span>
<a name="l00722"></a>00722             <span class="keywordflow">return</span>;
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724         <span class="keywordflow">if</span>(GESHI_SECURITY_PARANOID &amp;&amp; <span class="keyword">false</span> !== strpos($path, <span class="stringliteral">&#39;..&#39;</span>)) {
<a name="l00725"></a>00725             <span class="comment">//Security Fix to prevent external directories using fopen wrappers.</span>
<a name="l00726"></a>00726             <span class="keywordflow">return</span>;
<a name="l00727"></a>00727         }
<a name="l00728"></a>00728         <span class="keywordflow">if</span> ($path) {
<a name="l00729"></a>00729             $this-&gt;language_path = (<span class="charliteral">&#39;/&#39;</span> == $path[strlen($path) - 1]) ? $path : $path . <span class="charliteral">&#39;/&#39;</span>;
<a name="l00730"></a>00730             $this-&gt;<a class="code" href="classGeSHi.html#a0b0ff783617df971bd15d402bc64b84a" title="Sets the language for this object.">set_language</a>($this-&gt;language); <span class="comment">// otherwise set_language_path has no effect</span>
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733 
<a name="l00748"></a><a class="code" href="classGeSHi.html#ad1966006cfc7e60fd6aff0b762e9f593">00748</a>     function <a class="code" href="classGeSHi.html#ad1966006cfc7e60fd6aff0b762e9f593" title="Sets the type of header to be used.">set_header_type</a>($type) {
<a name="l00749"></a>00749         <span class="comment">//Check if we got a valid header type</span>
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (!in_array($type, array(GESHI_HEADER_NONE, GESHI_HEADER_DIV,
<a name="l00751"></a>00751             GESHI_HEADER_PRE, GESHI_HEADER_PRE_VALID, GESHI_HEADER_PRE_TABLE))) {
<a name="l00752"></a>00752             $this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a> = GESHI_ERROR_INVALID_HEADER_TYPE;
<a name="l00753"></a>00753             <span class="keywordflow">return</span>;
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="comment">//Set that new header type</span>
<a name="l00757"></a>00757         $this-&gt;header_type = $type;
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759 
<a name="l00769"></a><a class="code" href="classGeSHi.html#a4c4df05fb94a057ad1aed3845a0c67d9">00769</a>     function <a class="code" href="classGeSHi.html#a4c4df05fb94a057ad1aed3845a0c67d9" title="Sets the styles for the code that will be outputted when this object is parsed.">set_overall_style</a>($style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l00770"></a>00770         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l00771"></a>00771             $this-&gt;overall_style = $style;
<a name="l00772"></a>00772         } <span class="keywordflow">else</span> {
<a name="l00773"></a>00773             $this-&gt;overall_style .= $style;
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775     }
<a name="l00776"></a>00776 
<a name="l00785"></a><a class="code" href="classGeSHi.html#a4de2ab19cbe5f6c3da8f49e60a346608">00785</a>     function <a class="code" href="classGeSHi.html#a4de2ab19cbe5f6c3da8f49e60a346608" title="Sets the overall classname for this block of code.">set_overall_class</a>($class) {
<a name="l00786"></a>00786         $this-&gt;overall_class = $class;
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788 
<a name="l00796"></a><a class="code" href="classGeSHi.html#aceb3ebcf9a7842d6431da4f35244b5e3">00796</a>     function <a class="code" href="classGeSHi.html#aceb3ebcf9a7842d6431da4f35244b5e3" title="Sets the overall id for this block of code.">set_overall_id</a>($id) {
<a name="l00797"></a>00797         $this-&gt;overall_id = $id;
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799 
<a name="l00807"></a><a class="code" href="classGeSHi.html#a7dcd5d790a4335f8af0c22277309a015">00807</a>     function <a class="code" href="classGeSHi.html#a7dcd5d790a4335f8af0c22277309a015" title="Sets whether CSS classes should be used to highlight the source.">enable_classes</a>($flag = <span class="keyword">true</span>) {
<a name="l00808"></a>00808         $this-&gt;use_classes = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810 
<a name="l00826"></a><a class="code" href="classGeSHi.html#afae2007c1f25a51aaaee0725b9cac1ed">00826</a>     function <a class="code" href="classGeSHi.html#afae2007c1f25a51aaaee0725b9cac1ed" title="Sets the style for the actual code.">set_code_style</a>($style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l00827"></a>00827         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l00828"></a>00828             $this-&gt;code_style = $style;
<a name="l00829"></a>00829         } <span class="keywordflow">else</span> {
<a name="l00830"></a>00830             $this-&gt;code_style .= $style;
<a name="l00831"></a>00831         }
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833 
<a name="l00846"></a><a class="code" href="classGeSHi.html#aa9586f685747c106b159794d16522b92">00846</a>     function <a class="code" href="classGeSHi.html#aa9586f685747c106b159794d16522b92" title="Sets the styles for the line numbers.">set_line_style</a>($style1, $style2 = <span class="stringliteral">&#39;&#39;</span>, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l00847"></a>00847         <span class="comment">//Check if we got 2 or three parameters</span>
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (is_bool($style2)) {
<a name="l00849"></a>00849             $preserve_defaults = $style2;
<a name="l00850"></a>00850             $style2 = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00851"></a>00851         }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853         <span class="comment">//Actually set the new styles</span>
<a name="l00854"></a>00854         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l00855"></a>00855             $this-&gt;line_style1 = $style1;
<a name="l00856"></a>00856             $this-&gt;line_style2 = $style2;
<a name="l00857"></a>00857         } <span class="keywordflow">else</span> {
<a name="l00858"></a>00858             $this-&gt;line_style1 .= $style1;
<a name="l00859"></a>00859             $this-&gt;line_style2 .= $style2;
<a name="l00860"></a>00860         }
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862 
<a name="l00880"></a><a class="code" href="classGeSHi.html#a2bb9047a1b6c7548f80688cb437cf038">00880</a>     function <a class="code" href="classGeSHi.html#a2bb9047a1b6c7548f80688cb437cf038" title="Sets whether line numbers should be displayed.">enable_line_numbers</a>($flag, $nth_row = 5) {
<a name="l00881"></a>00881         <span class="keywordflow">if</span> (GESHI_NO_LINE_NUMBERS != $flag &amp;&amp; GESHI_NORMAL_LINE_NUMBERS != $flag
<a name="l00882"></a>00882             &amp;&amp; GESHI_FANCY_LINE_NUMBERS != $flag) {
<a name="l00883"></a>00883             $this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a> = GESHI_ERROR_INVALID_LINE_NUMBER_TYPE;
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885         $this-&gt;line_numbers = $flag;
<a name="l00886"></a>00886         $this-&gt;line_nth_row = $nth_row;
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888 
<a name="l00898"></a><a class="code" href="classGeSHi.html#a035c04e0d4620b15ffb73b0a9ef4b36f">00898</a>     function <a class="code" href="classGeSHi.html#a035c04e0d4620b15ffb73b0a9ef4b36f" title="Sets wether spans and other HTML markup generated by GeSHi can span over multiple...">enable_multiline_span</a>($flag) {
<a name="l00899"></a>00899         $this-&gt;allow_multiline_span = (bool) $flag;
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901 
<a name="l00908"></a><a class="code" href="classGeSHi.html#a9c51999881acf1eebc179350f0c72046">00908</a>     function <a class="code" href="classGeSHi.html#a9c51999881acf1eebc179350f0c72046" title="Get current setting for multiline spans, see GeSHi-&amp;gt;enable_multiline_span().">get_multiline_span</a>() {
<a name="l00909"></a>00909         <span class="keywordflow">return</span> $this-&gt;allow_multiline_span;
<a name="l00910"></a>00910     }
<a name="l00911"></a>00911 
<a name="l00923"></a><a class="code" href="classGeSHi.html#aea02b209d3599348d69bb893bb74460e">00923</a>     function <a class="code" href="classGeSHi.html#aea02b209d3599348d69bb893bb74460e" title="Sets the style for a keyword group.">set_keyword_group_style</a>($key, $style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l00924"></a>00924         <span class="comment">//Set the style for this keyword group</span>
<a name="l00925"></a>00925         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l00926"></a>00926             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = $style;
<a name="l00927"></a>00927         } <span class="keywordflow">else</span> {
<a name="l00928"></a>00928             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] .= $style;
<a name="l00929"></a>00929         }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931         <span class="comment">//Update the lexic permissions</span>
<a name="l00932"></a>00932         <span class="keywordflow">if</span> (!isset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key])) {
<a name="l00933"></a>00933             $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = <span class="keyword">true</span>;
<a name="l00934"></a>00934         }
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936 
<a name="l00944"></a><a class="code" href="classGeSHi.html#a887fe064b4741767ce790878c6181f09">00944</a>     function <a class="code" href="classGeSHi.html#a887fe064b4741767ce790878c6181f09" title="Turns highlighting on/off for a keyword group.">set_keyword_group_highlighting</a>($key, $flag = <span class="keyword">true</span>) {
<a name="l00945"></a>00945         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947 
<a name="l00959"></a><a class="code" href="classGeSHi.html#ae0edb0af604f19e7ccacfe034e1ba9c1">00959</a>     function <a class="code" href="classGeSHi.html#ae0edb0af604f19e7ccacfe034e1ba9c1" title="Sets the styles for comment groups.">set_comments_style</a>($key, $style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l00960"></a>00960         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l00961"></a>00961             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][$key] = $style;
<a name="l00962"></a>00962         } <span class="keywordflow">else</span> {
<a name="l00963"></a>00963             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][$key] .= $style;
<a name="l00964"></a>00964         }
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966 
<a name="l00974"></a><a class="code" href="classGeSHi.html#ac14147abdfbdf5af3c72e80127cf0f6d">00974</a>     function <a class="code" href="classGeSHi.html#ac14147abdfbdf5af3c72e80127cf0f6d" title="Turns highlighting on/off for comment groups.">set_comments_highlighting</a>($key, $flag = <span class="keyword">true</span>) {
<a name="l00975"></a>00975         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][$key] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00976"></a>00976     }
<a name="l00977"></a>00977 
<a name="l00988"></a><a class="code" href="classGeSHi.html#aeef6c874be8a7d1fc66cfaf0f180c4d9">00988</a>     function <a class="code" href="classGeSHi.html#aeef6c874be8a7d1fc66cfaf0f180c4d9" title="Sets the styles for escaped characters.">set_escape_characters_style</a>($style, $preserve_defaults = <span class="keyword">false</span>, $group = 0) {
<a name="l00989"></a>00989         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l00990"></a>00990             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>][$group] = $style;
<a name="l00991"></a>00991         } <span class="keywordflow">else</span> {
<a name="l00992"></a>00992             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>][$group] .= $style;
<a name="l00993"></a>00993         }
<a name="l00994"></a>00994     }
<a name="l00995"></a>00995 
<a name="l01002"></a><a class="code" href="classGeSHi.html#ab587206e070ca4500622aaaecabeff78">01002</a>     function <a class="code" href="classGeSHi.html#ab587206e070ca4500622aaaecabeff78" title="Turns highlighting on/off for escaped characters.">set_escape_characters_highlighting</a>($flag = <span class="keyword">true</span>) {
<a name="l01003"></a>01003         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01004"></a>01004     }
<a name="l01005"></a>01005 
<a name="l01020"></a><a class="code" href="classGeSHi.html#adc1c16422680fa5b058b8301a44dd9a1">01020</a>     function <a class="code" href="classGeSHi.html#adc1c16422680fa5b058b8301a44dd9a1" title="Sets the styles for brackets.">set_brackets_style</a>($style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l01021"></a>01021         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01022"></a>01022             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] = $style;
<a name="l01023"></a>01023         } <span class="keywordflow">else</span> {
<a name="l01024"></a>01024             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] .= $style;
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027 
<a name="l01038"></a><a class="code" href="classGeSHi.html#a58958425c4992595ecc057cf5ccfc1d3">01038</a>     function <a class="code" href="classGeSHi.html#a58958425c4992595ecc057cf5ccfc1d3" title="Turns highlighting on/off for brackets.">set_brackets_highlighting</a>($flag) {
<a name="l01039"></a>01039         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;BRACKETS&#39;</span>] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 
<a name="l01053"></a><a class="code" href="classGeSHi.html#ab26232ef62830360484bf06b6f0140de">01053</a>     function <a class="code" href="classGeSHi.html#ab26232ef62830360484bf06b6f0140de" title="Sets the styles for symbols.">set_symbols_style</a>($style, $preserve_defaults = <span class="keyword">false</span>, $group = 0) {
<a name="l01054"></a>01054         <span class="comment">// Update the style of symbols</span>
<a name="l01055"></a>01055         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01056"></a>01056             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SYMBOLS&#39;</span>][$group] = $style;
<a name="l01057"></a>01057         } <span class="keywordflow">else</span> {
<a name="l01058"></a>01058             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SYMBOLS&#39;</span>][$group] .= $style;
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         <span class="comment">// For backward compatibility</span>
<a name="l01062"></a>01062         <span class="keywordflow">if</span> (0 == $group) {
<a name="l01063"></a>01063             $this-&gt;<a class="code" href="classGeSHi.html#adc1c16422680fa5b058b8301a44dd9a1" title="Sets the styles for brackets.">set_brackets_style</a> ($style, $preserve_defaults);
<a name="l01064"></a>01064         }
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066 
<a name="l01073"></a><a class="code" href="classGeSHi.html#ad679eb28054d7aef471315b76cad6071">01073</a>     function <a class="code" href="classGeSHi.html#ad679eb28054d7aef471315b76cad6071" title="Turns highlighting on/off for symbols.">set_symbols_highlighting</a>($flag) {
<a name="l01074"></a>01074         <span class="comment">// Update lexic permissions for this symbol group</span>
<a name="l01075"></a>01075         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;SYMBOLS&#39;</span>] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         <span class="comment">// For backward compatibility</span>
<a name="l01078"></a>01078         $this-&gt;<a class="code" href="classGeSHi.html#a58958425c4992595ecc057cf5ccfc1d3" title="Turns highlighting on/off for brackets.">set_brackets_highlighting</a> ($flag);
<a name="l01079"></a>01079     }
<a name="l01080"></a>01080 
<a name="l01092"></a><a class="code" href="classGeSHi.html#a9ac1d1a9ce4c110ab4efcd080e6f23a6">01092</a>     function <a class="code" href="classGeSHi.html#a9ac1d1a9ce4c110ab4efcd080e6f23a6" title="Sets the styles for strings.">set_strings_style</a>($style, $preserve_defaults = <span class="keyword">false</span>, $group = 0) {
<a name="l01093"></a>01093         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01094"></a>01094             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;STRINGS&#39;</span>][$group] = $style;
<a name="l01095"></a>01095         } <span class="keywordflow">else</span> {
<a name="l01096"></a>01096             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;STRINGS&#39;</span>][$group] .= $style;
<a name="l01097"></a>01097         }
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099 
<a name="l01106"></a><a class="code" href="classGeSHi.html#ac58f6e232b610394892327bef8e52b90">01106</a>     function <a class="code" href="classGeSHi.html#ac58f6e232b610394892327bef8e52b90" title="Turns highlighting on/off for strings.">set_strings_highlighting</a>($flag) {
<a name="l01107"></a>01107         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;STRINGS&#39;</span>] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01108"></a>01108     }
<a name="l01109"></a>01109 
<a name="l01121"></a><a class="code" href="classGeSHi.html#a22a3c4b4b3e365950eb28fdd6b332904">01121</a>     function <a class="code" href="classGeSHi.html#a22a3c4b4b3e365950eb28fdd6b332904" title="Sets the styles for strict code blocks.">set_script_style</a>($style, $preserve_defaults = <span class="keyword">false</span>, $group = 0) {
<a name="l01122"></a>01122         <span class="comment">// Update the style of symbols</span>
<a name="l01123"></a>01123         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01124"></a>01124             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SCRIPT&#39;</span>][$group] = $style;
<a name="l01125"></a>01125         } <span class="keywordflow">else</span> {
<a name="l01126"></a>01126             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SCRIPT&#39;</span>][$group] .= $style;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129 
<a name="l01141"></a><a class="code" href="classGeSHi.html#a679efcddc72479c478462dc9a43efc72">01141</a>     function <a class="code" href="classGeSHi.html#a679efcddc72479c478462dc9a43efc72" title="Sets the styles for numbers.">set_numbers_style</a>($style, $preserve_defaults = <span class="keyword">false</span>, $group = 0) {
<a name="l01142"></a>01142         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01143"></a>01143             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][$group] = $style;
<a name="l01144"></a>01144         } <span class="keywordflow">else</span> {
<a name="l01145"></a>01145             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][$group] .= $style;
<a name="l01146"></a>01146         }
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148 
<a name="l01155"></a><a class="code" href="classGeSHi.html#a718a54c06d45505b2eb26ce50863f228">01155</a>     function <a class="code" href="classGeSHi.html#a718a54c06d45505b2eb26ce50863f228" title="Turns highlighting on/off for numbers.">set_numbers_highlighting</a>($flag) {
<a name="l01156"></a>01156         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;NUMBERS&#39;</span>] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158 
<a name="l01172"></a><a class="code" href="classGeSHi.html#ad8151b253b76e016d9a5ac85f6b14a12">01172</a>     function <a class="code" href="classGeSHi.html#ad8151b253b76e016d9a5ac85f6b14a12" title="Sets the styles for methods.">set_methods_style</a>($key, $style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l01173"></a>01173         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01174"></a>01174             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;METHODS&#39;</span>][$key] = $style;
<a name="l01175"></a>01175         } <span class="keywordflow">else</span> {
<a name="l01176"></a>01176             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;METHODS&#39;</span>][$key] .= $style;
<a name="l01177"></a>01177         }
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179 
<a name="l01186"></a><a class="code" href="classGeSHi.html#afd276fde7975a25899a604a6d57e6a8f">01186</a>     function <a class="code" href="classGeSHi.html#afd276fde7975a25899a604a6d57e6a8f" title="Turns highlighting on/off for methods.">set_methods_highlighting</a>($flag) {
<a name="l01187"></a>01187         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;METHODS&#39;</span>] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01188"></a>01188     }
<a name="l01189"></a>01189 
<a name="l01200"></a><a class="code" href="classGeSHi.html#a4aca7660f7faba909bc9a2874ceed037">01200</a>     function <a class="code" href="classGeSHi.html#a4aca7660f7faba909bc9a2874ceed037" title="Sets the styles for regexps.">set_regexps_style</a>($key, $style, $preserve_defaults = <span class="keyword">false</span>) {
<a name="l01201"></a>01201         <span class="keywordflow">if</span> (!$preserve_defaults) {
<a name="l01202"></a>01202             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key] = $style;
<a name="l01203"></a>01203         } <span class="keywordflow">else</span> {
<a name="l01204"></a>01204             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key] .= $style;
<a name="l01205"></a>01205         }
<a name="l01206"></a>01206     }
<a name="l01207"></a>01207 
<a name="l01215"></a><a class="code" href="classGeSHi.html#a6f7e8905d1faba66bbe95a1933ad9d80">01215</a>     function <a class="code" href="classGeSHi.html#a6f7e8905d1faba66bbe95a1933ad9d80" title="Turns highlighting on/off for regexps.">set_regexps_highlighting</a>($key, $flag) {
<a name="l01216"></a>01216         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key] = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218 
<a name="l01226"></a><a class="code" href="classGeSHi.html#a606ed4c043d9da66a0dcbed7974f4aec">01226</a>     function <a class="code" href="classGeSHi.html#a606ed4c043d9da66a0dcbed7974f4aec" title="Sets whether a set of keywords are checked for in a case sensitive manner.">set_case_sensitivity</a>($key, $case) {
<a name="l01227"></a>01227         $this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][$key] = ($case) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01228"></a>01228     }
<a name="l01229"></a>01229 
<a name="l01240"></a><a class="code" href="classGeSHi.html#ab9b657e416699151c5641bf14c5adc86">01240</a>     function <a class="code" href="classGeSHi.html#ab9b657e416699151c5641bf14c5adc86" title="Sets the case that keywords should use when found.">set_case_keywords</a>($case) {
<a name="l01241"></a>01241         <span class="keywordflow">if</span> (in_array($case, array(
<a name="l01242"></a>01242             GESHI_CAPS_NO_CHANGE, GESHI_CAPS_UPPER, GESHI_CAPS_LOWER))) {
<a name="l01243"></a>01243             $this-&gt;language_data[<span class="stringliteral">&#39;CASE_KEYWORDS&#39;</span>] = $case;
<a name="l01244"></a>01244         }
<a name="l01245"></a>01245     }
<a name="l01246"></a>01246 
<a name="l01255"></a><a class="code" href="classGeSHi.html#a1da1e26794395dc0804c50dd6f7d07a2">01255</a>     function <a class="code" href="classGeSHi.html#a1da1e26794395dc0804c50dd6f7d07a2" title="Sets how many spaces a tab is substituted for.">set_tab_width</a>($width) {
<a name="l01256"></a>01256         $this-&gt;tab_width = intval($width);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258         <span class="comment">//Check if it fit&#39;s the constraints:</span>
<a name="l01259"></a>01259         <span class="keywordflow">if</span> ($this-&gt;tab_width &lt; 1) {
<a name="l01260"></a>01260             <span class="comment">//Return it to the default</span>
<a name="l01261"></a>01261             $this-&gt;tab_width = 8;
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263     }
<a name="l01264"></a>01264 
<a name="l01271"></a><a class="code" href="classGeSHi.html#a3205931d9628c6e3898397c845556efa">01271</a>     function <a class="code" href="classGeSHi.html#a3205931d9628c6e3898397c845556efa" title="Sets whether or not to use tab-stop width specifed by language.">set_use_language_tab_width</a>($use) {
<a name="l01272"></a>01272         $this-&gt;use_language_tab_width = (bool) $use;
<a name="l01273"></a>01273     }
<a name="l01274"></a>01274 
<a name="l01282"></a><a class="code" href="classGeSHi.html#ad9b807a0fb6eaaec6459c95f398d349f">01282</a>     function <a class="code" href="classGeSHi.html#ad9b807a0fb6eaaec6459c95f398d349f" title="Returns the tab width to use, based on the current language and user preference.">get_real_tab_width</a>() {
<a name="l01283"></a>01283         <span class="keywordflow">if</span> (!$this-&gt;use_language_tab_width ||
<a name="l01284"></a>01284             !isset($this-&gt;language_data[<span class="stringliteral">&#39;TAB_WIDTH&#39;</span>])) {
<a name="l01285"></a>01285             <span class="keywordflow">return</span> $this-&gt;tab_width;
<a name="l01286"></a>01286         } <span class="keywordflow">else</span> {
<a name="l01287"></a>01287             <span class="keywordflow">return</span> $this-&gt;language_data[<span class="stringliteral">&#39;TAB_WIDTH&#39;</span>];
<a name="l01288"></a>01288         }
<a name="l01289"></a>01289     }
<a name="l01290"></a>01290 
<a name="l01299"></a><a class="code" href="classGeSHi.html#ac21ef1e78dda6bebce4361c186167f59">01299</a>     function <a class="code" href="classGeSHi.html#ac21ef1e78dda6bebce4361c186167f59" title="Enables/disables strict highlighting.">enable_strict_mode</a>($mode = <span class="keyword">true</span>) {
<a name="l01300"></a>01300         <span class="keywordflow">if</span> (GESHI_MAYBE == $this-&gt;language_data[<span class="stringliteral">&#39;STRICT_MODE_APPLIES&#39;</span>]) {
<a name="l01301"></a>01301             $this-&gt;strict_mode = ($mode) ? GESHI_ALWAYS : GESHI_NEVER;
<a name="l01302"></a>01302         }
<a name="l01303"></a>01303     }
<a name="l01304"></a>01304 
<a name="l01312"></a><a class="code" href="classGeSHi.html#ab068cf775d5f11f1002346897d42af08">01312</a>     function <a class="code" href="classGeSHi.html#ab068cf775d5f11f1002346897d42af08" title="Disables all highlighting.">disable_highlighting</a>() {
<a name="l01313"></a>01313         $this-&gt;<a class="code" href="classGeSHi.html#a15e3ef2c685ab4a68992641ef30a4761" title="Enables all highlighting.">enable_highlighting</a>(<span class="keyword">false</span>);
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315 
<a name="l01326"></a><a class="code" href="classGeSHi.html#a15e3ef2c685ab4a68992641ef30a4761">01326</a>     function <a class="code" href="classGeSHi.html#a15e3ef2c685ab4a68992641ef30a4761" title="Enables all highlighting.">enable_highlighting</a>($flag = <span class="keyword">true</span>) {
<a name="l01327"></a>01327         $flag = $flag ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01328"></a>01328         <span class="keywordflow">foreach</span> ($this-&gt;lexic_permissions as $key =&gt; $value) {
<a name="l01329"></a>01329             <span class="keywordflow">if</span> (is_array($value)) {
<a name="l01330"></a>01330                 <span class="keywordflow">foreach</span> ($value as $k =&gt; $v) {
<a name="l01331"></a>01331                     $this-&gt;lexic_permissions[$key][$k] = $flag;
<a name="l01332"></a>01332                 }
<a name="l01333"></a>01333             } <span class="keywordflow">else</span> {
<a name="l01334"></a>01334                 $this-&gt;lexic_permissions[$key] = $flag;
<a name="l01335"></a>01335             }
<a name="l01336"></a>01336         }
<a name="l01337"></a>01337 
<a name="l01338"></a>01338         <span class="comment">// Context blocks</span>
<a name="l01339"></a>01339         $this-&gt;<a class="code" href="classGeSHi.html#a48a36664603935601b203b64fc9cae70" title="Sets whether context-important blocks are highlighted.">enable_important_blocks</a> = $flag;
<a name="l01340"></a>01340     }
<a name="l01341"></a>01341 
<a name="l01353"></a><a class="code" href="classGeSHi.html#aff9441e15e313a587161d6a0a8104622">01353</a>     function <a class="code" href="classGeSHi.html#aff9441e15e313a587161d6a0a8104622" title="Given a file extension, this method returns either a valid geshi language name, or...">get_language_name_from_extension</a>( $extension, $lookup = array() ) {
<a name="l01354"></a>01354         <span class="keywordflow">if</span> ( !is_array($lookup) || empty($lookup)) {
<a name="l01355"></a>01355             $lookup = array(
<a name="l01356"></a>01356                 <span class="stringliteral">&#39;abap&#39;</span> =&gt; array(<span class="stringliteral">&#39;abap&#39;</span>),
<a name="l01357"></a>01357                 <span class="stringliteral">&#39;actionscript&#39;</span> =&gt; array(<span class="stringliteral">&#39;as&#39;</span>),
<a name="l01358"></a>01358                 <span class="stringliteral">&#39;ada&#39;</span> =&gt; array(<span class="charliteral">&#39;a&#39;</span>, <span class="stringliteral">&#39;ada&#39;</span>, <span class="stringliteral">&#39;adb&#39;</span>, <span class="stringliteral">&#39;ads&#39;</span>),
<a name="l01359"></a>01359                 <span class="stringliteral">&#39;apache&#39;</span> =&gt; array(<span class="stringliteral">&#39;conf&#39;</span>),
<a name="l01360"></a>01360                 <span class="stringliteral">&#39;asm&#39;</span> =&gt; array(<span class="stringliteral">&#39;ash&#39;</span>, <span class="stringliteral">&#39;asm&#39;</span>, <span class="stringliteral">&#39;inc&#39;</span>),
<a name="l01361"></a>01361                 <span class="stringliteral">&#39;asp&#39;</span> =&gt; array(<span class="stringliteral">&#39;asp&#39;</span>),
<a name="l01362"></a>01362                 <span class="stringliteral">&#39;bash&#39;</span> =&gt; array(<span class="stringliteral">&#39;sh&#39;</span>),
<a name="l01363"></a>01363                 <span class="stringliteral">&#39;bf&#39;</span> =&gt; array(<span class="stringliteral">&#39;bf&#39;</span>),
<a name="l01364"></a>01364                 <span class="charliteral">&#39;c&#39;</span> =&gt; array(<span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;h&#39;</span>),
<a name="l01365"></a>01365                 <span class="stringliteral">&#39;c_mac&#39;</span> =&gt; array(<span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;h&#39;</span>),
<a name="l01366"></a>01366                 <span class="stringliteral">&#39;caddcl&#39;</span> =&gt; array(),
<a name="l01367"></a>01367                 <span class="stringliteral">&#39;cadlisp&#39;</span> =&gt; array(),
<a name="l01368"></a>01368                 <span class="stringliteral">&#39;cdfg&#39;</span> =&gt; array(<span class="stringliteral">&#39;cdfg&#39;</span>),
<a name="l01369"></a>01369                 <span class="stringliteral">&#39;cobol&#39;</span> =&gt; array(<span class="stringliteral">&#39;cbl&#39;</span>),
<a name="l01370"></a>01370                 <span class="stringliteral">&#39;cpp&#39;</span> =&gt; array(<span class="stringliteral">&#39;cpp&#39;</span>, <span class="stringliteral">&#39;hpp&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;H&#39;</span>, <span class="stringliteral">&#39;CPP&#39;</span>, <span class="stringliteral">&#39;HPP&#39;</span>),
<a name="l01371"></a>01371                 <span class="stringliteral">&#39;csharp&#39;</span> =&gt; array(<span class="stringliteral">&#39;cs&#39;</span>),
<a name="l01372"></a>01372                 <span class="stringliteral">&#39;css&#39;</span> =&gt; array(<span class="stringliteral">&#39;css&#39;</span>),
<a name="l01373"></a>01373                 <span class="charliteral">&#39;d&#39;</span> =&gt; array(<span class="charliteral">&#39;d&#39;</span>),
<a name="l01374"></a>01374                 <span class="stringliteral">&#39;delphi&#39;</span> =&gt; array(<span class="stringliteral">&#39;dpk&#39;</span>, <span class="stringliteral">&#39;dpr&#39;</span>, <span class="stringliteral">&#39;pp&#39;</span>, <span class="stringliteral">&#39;pas&#39;</span>),
<a name="l01375"></a>01375                 <span class="stringliteral">&#39;diff&#39;</span> =&gt; array(<span class="stringliteral">&#39;diff&#39;</span>, <span class="stringliteral">&#39;patch&#39;</span>),
<a name="l01376"></a>01376                 <span class="stringliteral">&#39;dos&#39;</span> =&gt; array(<span class="stringliteral">&#39;bat&#39;</span>, <span class="stringliteral">&#39;cmd&#39;</span>),
<a name="l01377"></a>01377                 <span class="stringliteral">&#39;gdb&#39;</span> =&gt; array(<span class="stringliteral">&#39;kcrash&#39;</span>, <span class="stringliteral">&#39;crash&#39;</span>, <span class="stringliteral">&#39;bt&#39;</span>),
<a name="l01378"></a>01378                 <span class="stringliteral">&#39;gettext&#39;</span> =&gt; array(<span class="stringliteral">&#39;po&#39;</span>, <span class="stringliteral">&#39;pot&#39;</span>),
<a name="l01379"></a>01379                 <span class="stringliteral">&#39;gml&#39;</span> =&gt; array(<span class="stringliteral">&#39;gml&#39;</span>),
<a name="l01380"></a>01380                 <span class="stringliteral">&#39;gnuplot&#39;</span> =&gt; array(<span class="stringliteral">&#39;plt&#39;</span>),
<a name="l01381"></a>01381                 <span class="stringliteral">&#39;groovy&#39;</span> =&gt; array(<span class="stringliteral">&#39;groovy&#39;</span>),
<a name="l01382"></a>01382                 <span class="stringliteral">&#39;haskell&#39;</span> =&gt; array(<span class="stringliteral">&#39;hs&#39;</span>),
<a name="l01383"></a>01383                 <span class="stringliteral">&#39;html4strict&#39;</span> =&gt; array(<span class="stringliteral">&#39;html&#39;</span>, <span class="stringliteral">&#39;htm&#39;</span>),
<a name="l01384"></a>01384                 <span class="stringliteral">&#39;ini&#39;</span> =&gt; array(<span class="stringliteral">&#39;ini&#39;</span>, <span class="stringliteral">&#39;desktop&#39;</span>),
<a name="l01385"></a>01385                 <span class="stringliteral">&#39;java&#39;</span> =&gt; array(<span class="stringliteral">&#39;java&#39;</span>),
<a name="l01386"></a>01386                 <span class="stringliteral">&#39;javascript&#39;</span> =&gt; array(<span class="stringliteral">&#39;js&#39;</span>),
<a name="l01387"></a>01387                 <span class="stringliteral">&#39;klonec&#39;</span> =&gt; array(<span class="stringliteral">&#39;kl1&#39;</span>),
<a name="l01388"></a>01388                 <span class="stringliteral">&#39;klonecpp&#39;</span> =&gt; array(<span class="stringliteral">&#39;klx&#39;</span>),
<a name="l01389"></a>01389                 <span class="stringliteral">&#39;latex&#39;</span> =&gt; array(<span class="stringliteral">&#39;tex&#39;</span>),
<a name="l01390"></a>01390                 <span class="stringliteral">&#39;lisp&#39;</span> =&gt; array(<span class="stringliteral">&#39;lisp&#39;</span>),
<a name="l01391"></a>01391                 <span class="stringliteral">&#39;lua&#39;</span> =&gt; array(<span class="stringliteral">&#39;lua&#39;</span>),
<a name="l01392"></a>01392                 <span class="stringliteral">&#39;matlab&#39;</span> =&gt; array(<span class="charliteral">&#39;m&#39;</span>),
<a name="l01393"></a>01393                 <span class="stringliteral">&#39;mpasm&#39;</span> =&gt; array(),
<a name="l01394"></a>01394                 <span class="stringliteral">&#39;mysql&#39;</span> =&gt; array(<span class="stringliteral">&#39;sql&#39;</span>),
<a name="l01395"></a>01395                 <span class="stringliteral">&#39;nsis&#39;</span> =&gt; array(),
<a name="l01396"></a>01396                 <span class="stringliteral">&#39;objc&#39;</span> =&gt; array(),
<a name="l01397"></a>01397                 <span class="stringliteral">&#39;oobas&#39;</span> =&gt; array(),
<a name="l01398"></a>01398                 <span class="stringliteral">&#39;oracle8&#39;</span> =&gt; array(),
<a name="l01399"></a>01399                 <span class="stringliteral">&#39;oracle10&#39;</span> =&gt; array(),
<a name="l01400"></a>01400                 <span class="stringliteral">&#39;pascal&#39;</span> =&gt; array(<span class="stringliteral">&#39;pas&#39;</span>),
<a name="l01401"></a>01401                 <span class="stringliteral">&#39;perl&#39;</span> =&gt; array(<span class="stringliteral">&#39;pl&#39;</span>, <span class="stringliteral">&#39;pm&#39;</span>),
<a name="l01402"></a>01402                 <span class="stringliteral">&#39;php&#39;</span> =&gt; array(<span class="stringliteral">&#39;php&#39;</span>, <span class="stringliteral">&#39;php5&#39;</span>, <span class="stringliteral">&#39;phtml&#39;</span>, <span class="stringliteral">&#39;phps&#39;</span>),
<a name="l01403"></a>01403                 <span class="stringliteral">&#39;povray&#39;</span> =&gt; array(<span class="stringliteral">&#39;pov&#39;</span>),
<a name="l01404"></a>01404                 <span class="stringliteral">&#39;providex&#39;</span> =&gt; array(<span class="stringliteral">&#39;pvc&#39;</span>, <span class="stringliteral">&#39;pvx&#39;</span>),
<a name="l01405"></a>01405                 <span class="stringliteral">&#39;prolog&#39;</span> =&gt; array(<span class="stringliteral">&#39;pl&#39;</span>),
<a name="l01406"></a>01406                 <span class="stringliteral">&#39;python&#39;</span> =&gt; array(<span class="stringliteral">&#39;py&#39;</span>),
<a name="l01407"></a>01407                 <span class="stringliteral">&#39;qbasic&#39;</span> =&gt; array(<span class="stringliteral">&#39;bi&#39;</span>),
<a name="l01408"></a>01408                 <span class="stringliteral">&#39;reg&#39;</span> =&gt; array(<span class="stringliteral">&#39;reg&#39;</span>),
<a name="l01409"></a>01409                 <span class="stringliteral">&#39;ruby&#39;</span> =&gt; array(<span class="stringliteral">&#39;rb&#39;</span>),
<a name="l01410"></a>01410                 <span class="stringliteral">&#39;sas&#39;</span> =&gt; array(<span class="stringliteral">&#39;sas&#39;</span>),
<a name="l01411"></a>01411                 <span class="stringliteral">&#39;scala&#39;</span> =&gt; array(<span class="stringliteral">&#39;scala&#39;</span>),
<a name="l01412"></a>01412                 <span class="stringliteral">&#39;scheme&#39;</span> =&gt; array(<span class="stringliteral">&#39;scm&#39;</span>),
<a name="l01413"></a>01413                 <span class="stringliteral">&#39;scilab&#39;</span> =&gt; array(<span class="stringliteral">&#39;sci&#39;</span>),
<a name="l01414"></a>01414                 <span class="stringliteral">&#39;smalltalk&#39;</span> =&gt; array(<span class="stringliteral">&#39;st&#39;</span>),
<a name="l01415"></a>01415                 <span class="stringliteral">&#39;smarty&#39;</span> =&gt; array(),
<a name="l01416"></a>01416                 <span class="stringliteral">&#39;tcl&#39;</span> =&gt; array(<span class="stringliteral">&#39;tcl&#39;</span>),
<a name="l01417"></a>01417                 <span class="stringliteral">&#39;vb&#39;</span> =&gt; array(<span class="stringliteral">&#39;bas&#39;</span>),
<a name="l01418"></a>01418                 <span class="stringliteral">&#39;vbnet&#39;</span> =&gt; array(),
<a name="l01419"></a>01419                 <span class="stringliteral">&#39;visualfoxpro&#39;</span> =&gt; array(),
<a name="l01420"></a>01420                 <span class="stringliteral">&#39;whitespace&#39;</span> =&gt; array(<span class="stringliteral">&#39;ws&#39;</span>),
<a name="l01421"></a>01421                 <span class="stringliteral">&#39;xml&#39;</span> =&gt; array(<span class="stringliteral">&#39;xml&#39;</span>, <span class="stringliteral">&#39;svg&#39;</span>, <span class="stringliteral">&#39;xrc&#39;</span>),
<a name="l01422"></a>01422                 <span class="stringliteral">&#39;z80&#39;</span> =&gt; array(<span class="stringliteral">&#39;z80&#39;</span>, <span class="stringliteral">&#39;asm&#39;</span>, <span class="stringliteral">&#39;inc&#39;</span>)
<a name="l01423"></a>01423             );
<a name="l01424"></a>01424         }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426         <span class="keywordflow">foreach</span> ($lookup as $lang =&gt; $extensions) {
<a name="l01427"></a>01427             <span class="keywordflow">if</span> (in_array($extension, $extensions)) {
<a name="l01428"></a>01428                 <span class="keywordflow">return</span> $lang;
<a name="l01429"></a>01429             }
<a name="l01430"></a>01430         }
<a name="l01431"></a>01431         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01432"></a>01432     }
<a name="l01433"></a>01433 
<a name="l01451"></a><a class="code" href="classGeSHi.html#ad78f694615e13053f89adffc2071250b">01451</a>     function <a class="code" href="classGeSHi.html#ad78f694615e13053f89adffc2071250b" title="Given a file name, this method loads its contents in, and attempts to set the language...">load_from_file</a>($file_name, $lookup = array()) {
<a name="l01452"></a>01452         <span class="keywordflow">if</span> (is_readable($file_name)) {
<a name="l01453"></a>01453             $this-&gt;<a class="code" href="classGeSHi.html#afae4820fed4615380c073cb2ffdaffff" title="Sets the source code for this object.">set_source</a>(file_get_contents($file_name));
<a name="l01454"></a>01454             $this-&gt;<a class="code" href="classGeSHi.html#a0b0ff783617df971bd15d402bc64b84a" title="Sets the language for this object.">set_language</a>($this-&gt;<a class="code" href="classGeSHi.html#aff9441e15e313a587161d6a0a8104622" title="Given a file extension, this method returns either a valid geshi language name, or...">get_language_name_from_extension</a>(substr(strrchr($file_name, <span class="charliteral">&#39;.&#39;</span>), 1), $lookup));
<a name="l01455"></a>01455         } <span class="keywordflow">else</span> {
<a name="l01456"></a>01456             $this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a> = GESHI_ERROR_FILE_NOT_READABLE;
<a name="l01457"></a>01457         }
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459 
<a name="l01467"></a><a class="code" href="classGeSHi.html#ac6087d66b751a4239978b3ea1877246b">01467</a>     function <a class="code" href="classGeSHi.html#ac6087d66b751a4239978b3ea1877246b" title="Adds a keyword to a keyword group for highlighting.">add_keyword</a>($key, $word) {
<a name="l01468"></a>01468         <span class="keywordflow">if</span> (!in_array($word, $this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key])) {
<a name="l01469"></a>01469             $this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key][] = $word;
<a name="l01470"></a>01470 
<a name="l01471"></a>01471             <span class="comment">//NEW in 1.0.8 don&#39;t recompile the whole optimized regexp, simply append it</span>
<a name="l01472"></a>01472             <span class="keywordflow">if</span> ($this-&gt;parse_cache_built) {
<a name="l01473"></a>01473                 $subkey = count($this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$key]) - 1;
<a name="l01474"></a>01474                 $this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$key][$subkey] .= <span class="charliteral">&#39;|&#39;</span> . preg_quote($word, <span class="charliteral">&#39;/&#39;</span>);
<a name="l01475"></a>01475             }
<a name="l01476"></a>01476         }
<a name="l01477"></a>01477     }
<a name="l01478"></a>01478 
<a name="l01492"></a><a class="code" href="classGeSHi.html#aa021fcab0b8139c61f80ea485b8743ed">01492</a>     function <a class="code" href="classGeSHi.html#aa021fcab0b8139c61f80ea485b8743ed" title="Removes a keyword from a keyword group.">remove_keyword</a>($key, $word, $recompile = <span class="keyword">true</span>) {
<a name="l01493"></a>01493         $key_to_remove = array_search($word, $this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]);
<a name="l01494"></a>01494         <span class="keywordflow">if</span> ($key_to_remove !== <span class="keyword">false</span>) {
<a name="l01495"></a>01495             unset($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key][$key_to_remove]);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497             <span class="comment">//NEW in 1.0.8, optionally recompile keyword group</span>
<a name="l01498"></a>01498             <span class="keywordflow">if</span> ($recompile &amp;&amp; $this-&gt;parse_cache_built) {
<a name="l01499"></a>01499                 $this-&gt;<a class="code" href="classGeSHi.html#a3d0ad9c4da51c320af7b240581ac76a9" title="compile optimized regexp list for keyword group">optimize_keyword_group</a>($key);
<a name="l01500"></a>01500             }
<a name="l01501"></a>01501         }
<a name="l01502"></a>01502     }
<a name="l01503"></a>01503 
<a name="l01513"></a><a class="code" href="classGeSHi.html#aa07f57bc129fb6d2bffb53e656fab657">01513</a>     function <a class="code" href="classGeSHi.html#aa07f57bc129fb6d2bffb53e656fab657" title="Creates a new keyword group.">add_keyword_group</a>($key, $styles, $case_sensitive = <span class="keyword">true</span>, $words = array()) {
<a name="l01514"></a>01514         $words = (array) $words;
<a name="l01515"></a>01515         <span class="keywordflow">if</span>  (empty($words)) {
<a name="l01516"></a>01516             <span class="comment">// empty word lists mess up highlighting</span>
<a name="l01517"></a>01517             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01518"></a>01518         }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520         <span class="comment">//Add the new keyword group internally</span>
<a name="l01521"></a>01521         $this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = $words;
<a name="l01522"></a>01522         $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = <span class="keyword">true</span>;
<a name="l01523"></a>01523         $this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][$key] = $case_sensitive;
<a name="l01524"></a>01524         $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = $styles;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526         <span class="comment">//NEW in 1.0.8, cache keyword regexp</span>
<a name="l01527"></a>01527         <span class="keywordflow">if</span> ($this-&gt;parse_cache_built) {
<a name="l01528"></a>01528             $this-&gt;<a class="code" href="classGeSHi.html#a3d0ad9c4da51c320af7b240581ac76a9" title="compile optimized regexp list for keyword group">optimize_keyword_group</a>($key);
<a name="l01529"></a>01529         }
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531 
<a name="l01538"></a><a class="code" href="classGeSHi.html#a80aba8251ea481e8ccc4289b7b3eba09">01538</a>     function <a class="code" href="classGeSHi.html#a80aba8251ea481e8ccc4289b7b3eba09" title="Removes a keyword group.">remove_keyword_group</a> ($key) {
<a name="l01539"></a>01539         <span class="comment">//Remove the keyword group internally</span>
<a name="l01540"></a>01540         unset($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]);
<a name="l01541"></a>01541         unset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]);
<a name="l01542"></a>01542         unset($this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][$key]);
<a name="l01543"></a>01543         unset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545         <span class="comment">//NEW in 1.0.8</span>
<a name="l01546"></a>01546         unset($this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$key]);
<a name="l01547"></a>01547     }
<a name="l01548"></a>01548 
<a name="l01555"></a><a class="code" href="classGeSHi.html#a3d0ad9c4da51c320af7b240581ac76a9">01555</a>     function <a class="code" href="classGeSHi.html#a3d0ad9c4da51c320af7b240581ac76a9" title="compile optimized regexp list for keyword group">optimize_keyword_group</a>($key) {
<a name="l01556"></a>01556         $this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$key] =
<a name="l01557"></a>01557             $this-&gt;<a class="code" href="classGeSHi.html#ab7fb140d0dbb71262e658f98396efc98" title="this functions creates an optimized regular expression list of an array of strings...">optimize_regexp_list</a>($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]);
<a name="l01558"></a>01558         $space_as_whitespace = <span class="keyword">false</span>;
<a name="l01559"></a>01559         <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>])) {
<a name="l01560"></a>01560             <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>])) {
<a name="l01561"></a>01561                 <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][<span class="stringliteral">&#39;SPACE_AS_WHITESPACE&#39;</span>])) {
<a name="l01562"></a>01562                     $space_as_whitespace = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][<span class="stringliteral">&#39;SPACE_AS_WHITESPACE&#39;</span>];
<a name="l01563"></a>01563                 }
<a name="l01564"></a>01564                 <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key][<span class="stringliteral">&#39;SPACE_AS_WHITESPACE&#39;</span>])) {
<a name="l01565"></a>01565                     <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key][<span class="stringliteral">&#39;SPACE_AS_WHITESPACE&#39;</span>])) {
<a name="l01566"></a>01566                         $space_as_whitespace = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key][<span class="stringliteral">&#39;SPACE_AS_WHITESPACE&#39;</span>];
<a name="l01567"></a>01567                     }
<a name="l01568"></a>01568                 }
<a name="l01569"></a>01569             }
<a name="l01570"></a>01570         }
<a name="l01571"></a>01571         <span class="keywordflow">if</span>($space_as_whitespace) {
<a name="l01572"></a>01572             <span class="keywordflow">foreach</span>($this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$key] as $rxk =&gt; $rxv) {
<a name="l01573"></a>01573                 $this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$key][$rxk] =
<a name="l01574"></a>01574                     str_replace(<span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;\\s+&quot;</span>, $rxv);
<a name="l01575"></a>01575             }
<a name="l01576"></a>01576         }
<a name="l01577"></a>01577     }
<a name="l01578"></a>01578 
<a name="l01585"></a><a class="code" href="classGeSHi.html#a6ffaf3c684a94262430cb9a763147f36">01585</a>     function <a class="code" href="classGeSHi.html#a6ffaf3c684a94262430cb9a763147f36" title="Sets the content of the header block.">set_header_content</a>($content) {
<a name="l01586"></a>01586         $this-&gt;header_content = $content;
<a name="l01587"></a>01587     }
<a name="l01588"></a>01588 
<a name="l01595"></a><a class="code" href="classGeSHi.html#aa03a1a04e1f5bb5e00ba870e09bc67c5">01595</a>     function <a class="code" href="classGeSHi.html#aa03a1a04e1f5bb5e00ba870e09bc67c5" title="Sets the content of the footer block.">set_footer_content</a>($content) {
<a name="l01596"></a>01596         $this-&gt;footer_content = $content;
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598 
<a name="l01605"></a><a class="code" href="classGeSHi.html#adbcebdc222d913879a754ebbf751e39e">01605</a>     function <a class="code" href="classGeSHi.html#adbcebdc222d913879a754ebbf751e39e" title="Sets the style for the header content.">set_header_content_style</a>($style) {
<a name="l01606"></a>01606         $this-&gt;header_content_style = $style;
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608 
<a name="l01615"></a><a class="code" href="classGeSHi.html#a849d6d82270ec99f74ef5bb62cba968a">01615</a>     function <a class="code" href="classGeSHi.html#a849d6d82270ec99f74ef5bb62cba968a" title="Sets the style for the footer content.">set_footer_content_style</a>($style) {
<a name="l01616"></a>01616         $this-&gt;footer_content_style = $style;
<a name="l01617"></a>01617     }
<a name="l01618"></a>01618 
<a name="l01626"></a><a class="code" href="classGeSHi.html#ad12d3cb03360b860a4a3f94fcf8cb773">01626</a>     function <a class="code" href="classGeSHi.html#ad12d3cb03360b860a4a3f94fcf8cb773" title="Sets whether to force a surrounding block around the highlighted code or not.">enable_inner_code_block</a>($flag) {
<a name="l01627"></a>01627         $this-&gt;force_code_block = (bool)$flag;
<a name="l01628"></a>01628     }
<a name="l01629"></a>01629 
<a name="l01639"></a><a class="code" href="classGeSHi.html#a331d88c29e6c2741777e8974fb8f86fa">01639</a>     function <a class="code" href="classGeSHi.html#a331d88c29e6c2741777e8974fb8f86fa" title="Sets the base URL to be used for keywords.">set_url_for_keyword_group</a>($group, $url) {
<a name="l01640"></a>01640         $this-&gt;language_data[<span class="stringliteral">&#39;URLS&#39;</span>][$group] = $url;
<a name="l01641"></a>01641     }
<a name="l01642"></a>01642 
<a name="l01651"></a><a class="code" href="classGeSHi.html#aba797bd19581d516d5fff6b575116838">01651</a>     function <a class="code" href="classGeSHi.html#aba797bd19581d516d5fff6b575116838" title="Sets styles for links in code.">set_link_styles</a>($type, $styles) {
<a name="l01652"></a>01652         $this-&gt;link_styles[$type] = $styles;
<a name="l01653"></a>01653     }
<a name="l01654"></a>01654 
<a name="l01661"></a><a class="code" href="classGeSHi.html#aeb1174cc0c50f83cd97102631f12ff1f">01661</a>     function <a class="code" href="classGeSHi.html#aeb1174cc0c50f83cd97102631f12ff1f" title="Sets the target for links in code.">set_link_target</a>($target) {
<a name="l01662"></a>01662         <span class="keywordflow">if</span> (!$target) {
<a name="l01663"></a>01663             $this-&gt;link_target = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01664"></a>01664         } <span class="keywordflow">else</span> {
<a name="l01665"></a>01665             $this-&gt;link_target = <span class="stringliteral">&#39; target=&quot;&#39;</span> . $target . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01666"></a>01666         }
<a name="l01667"></a>01667     }
<a name="l01668"></a>01668 
<a name="l01675"></a><a class="code" href="classGeSHi.html#a5115ed45716dad1da8363ee24c7f2e4c">01675</a>     function <a class="code" href="classGeSHi.html#a5115ed45716dad1da8363ee24c7f2e4c" title="Sets styles for important parts of the code.">set_important_styles</a>($styles) {
<a name="l01676"></a>01676         $this-&gt;important_styles = $styles;
<a name="l01677"></a>01677     }
<a name="l01678"></a>01678 
<a name="l01687"></a><a class="code" href="classGeSHi.html#a48a36664603935601b203b64fc9cae70">01687</a>     function <a class="code" href="classGeSHi.html#a48a36664603935601b203b64fc9cae70" title="Sets whether context-important blocks are highlighted.">enable_important_blocks</a>($flag) {
<a name="l01688"></a>01688         $this-&gt;<a class="code" href="classGeSHi.html#a48a36664603935601b203b64fc9cae70" title="Sets whether context-important blocks are highlighted.">enable_important_blocks</a> = ( $flag ) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01689"></a>01689     }
<a name="l01690"></a>01690 
<a name="l01697"></a><a class="code" href="classGeSHi.html#ad859c22c14e4fc9316bdf58e8c889ae9">01697</a>     function <a class="code" href="classGeSHi.html#ad859c22c14e4fc9316bdf58e8c889ae9" title="Whether CSS IDs should be added to each line.">enable_ids</a>($flag = <span class="keyword">true</span>) {
<a name="l01698"></a>01698         $this-&gt;add_ids = ($flag) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01699"></a>01699     }
<a name="l01700"></a>01700 
<a name="l01715"></a><a class="code" href="classGeSHi.html#ae1b0545f4143201ac3055abc0854196d">01715</a>     function <a class="code" href="classGeSHi.html#ae1b0545f4143201ac3055abc0854196d" title="Specifies which lines to highlight extra.">highlight_lines_extra</a>($lines, $style = null) {
<a name="l01716"></a>01716         <span class="keywordflow">if</span> (is_array($lines)) {
<a name="l01717"></a>01717             <span class="comment">//Split up the job using single lines at a time</span>
<a name="l01718"></a>01718             <span class="keywordflow">foreach</span> ($lines as $line) {
<a name="l01719"></a>01719                 $this-&gt;<a class="code" href="classGeSHi.html#ae1b0545f4143201ac3055abc0854196d" title="Specifies which lines to highlight extra.">highlight_lines_extra</a>($line, $style);
<a name="l01720"></a>01720             }
<a name="l01721"></a>01721         } <span class="keywordflow">else</span> {
<a name="l01722"></a>01722             <span class="comment">//Mark the line as being highlighted specially</span>
<a name="l01723"></a>01723             $lines = intval($lines);
<a name="l01724"></a>01724             $this-&gt;highlight_extra_lines[$lines] = $lines;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726             <span class="comment">//Decide on which style to use</span>
<a name="l01727"></a>01727             <span class="keywordflow">if</span> ($style === null) { <span class="comment">//Check if we should use default style</span>
<a name="l01728"></a>01728                 unset($this-&gt;highlight_extra_lines_styles[$lines]);
<a name="l01729"></a>01729             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($style === <span class="keyword">false</span>) { <span class="comment">//Check if to remove this line</span>
<a name="l01730"></a>01730                 unset($this-&gt;highlight_extra_lines[$lines]);
<a name="l01731"></a>01731                 unset($this-&gt;highlight_extra_lines_styles[$lines]);
<a name="l01732"></a>01732             } <span class="keywordflow">else</span> {
<a name="l01733"></a>01733                 $this-&gt;highlight_extra_lines_styles[$lines] = $style;
<a name="l01734"></a>01734             }
<a name="l01735"></a>01735         }
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737 
<a name="l01744"></a><a class="code" href="classGeSHi.html#af9596b1abed0f222229d09e671f27171">01744</a>     function <a class="code" href="classGeSHi.html#af9596b1abed0f222229d09e671f27171" title="Sets the style for extra-highlighted lines.">set_highlight_lines_extra_style</a>($styles) {
<a name="l01745"></a>01745         $this-&gt;highlight_extra_lines_style = $styles;
<a name="l01746"></a>01746     }
<a name="l01747"></a>01747 
<a name="l01754"></a><a class="code" href="classGeSHi.html#ada1d16529fef7d405460dc26d95ce7d3">01754</a>     function <a class="code" href="classGeSHi.html#ada1d16529fef7d405460dc26d95ce7d3" title="Sets the line-ending.">set_line_ending</a>($line_ending) {
<a name="l01755"></a>01755         $this-&gt;line_ending = (string)$line_ending;
<a name="l01756"></a>01756     }
<a name="l01757"></a>01757 
<a name="l01773"></a><a class="code" href="classGeSHi.html#a5538551eb699fee6a5f5fa1a7171232a">01773</a>     function <a class="code" href="classGeSHi.html#a5538551eb699fee6a5f5fa1a7171232a" title="Sets what number line numbers should start at.">start_line_numbers_at</a>($number) {
<a name="l01774"></a>01774         $this-&gt;line_numbers_start = abs(intval($number));
<a name="l01775"></a>01775     }
<a name="l01776"></a>01776 
<a name="l01789"></a><a class="code" href="classGeSHi.html#a6df6fefebeccaabdc18c8127e7ad6c47">01789</a>     function <a class="code" href="classGeSHi.html#a6df6fefebeccaabdc18c8127e7ad6c47" title="Sets the encoding used for htmlspecialchars(), for international support.">set_encoding</a>($encoding) {
<a name="l01790"></a>01790         <span class="keywordflow">if</span> ($encoding) {
<a name="l01791"></a>01791           $this-&gt;encoding = strtolower($encoding);
<a name="l01792"></a>01792         }
<a name="l01793"></a>01793     }
<a name="l01794"></a>01794 
<a name="l01801"></a><a class="code" href="classGeSHi.html#a9c6d3744089cea99e93c5682d58b83fc">01801</a>     function <a class="code" href="classGeSHi.html#a9c6d3744089cea99e93c5682d58b83fc" title="Turns linking of keywords on or off.">enable_keyword_links</a>($enable = <span class="keyword">true</span>) {
<a name="l01802"></a>01802         $this-&gt;keyword_links = (bool) $enable;
<a name="l01803"></a>01803     }
<a name="l01804"></a>01804 
<a name="l01814"></a><a class="code" href="classGeSHi.html#a3e3303eb8be497200431946eb347eddb">01814</a>     function <a class="code" href="classGeSHi.html#a3e3303eb8be497200431946eb347eddb" title="Setup caches needed for styling.">build_style_cache</a>() {
<a name="l01815"></a>01815         <span class="comment">//Build the style cache needed to highlight numbers appropriate</span>
<a name="l01816"></a>01816         <span class="keywordflow">if</span>($this-&gt;lexic_permissions[<span class="stringliteral">&#39;NUMBERS&#39;</span>]) {
<a name="l01817"></a>01817             <span class="comment">//First check what way highlighting information for numbers are given</span>
<a name="l01818"></a>01818             <span class="keywordflow">if</span>(!isset($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>])) {
<a name="l01819"></a>01819                 $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>] = 0;
<a name="l01820"></a>01820             }
<a name="l01821"></a>01821 
<a name="l01822"></a>01822             <span class="keywordflow">if</span>(is_array($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>])) {
<a name="l01823"></a>01823                 $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>] = $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>];
<a name="l01824"></a>01824             } <span class="keywordflow">else</span> {
<a name="l01825"></a>01825                 $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>] = array();
<a name="l01826"></a>01826                 <span class="keywordflow">if</span>(!$this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>]) {
<a name="l01827"></a>01827                     $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>] =
<a name="l01828"></a>01828                         GESHI_NUMBER_INT_BASIC |
<a name="l01829"></a>01829                         GESHI_NUMBER_FLT_NONSCI;
<a name="l01830"></a>01830                 }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832                 <span class="keywordflow">for</span>($i = 0, $j = $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS&#39;</span>]; $j &gt; 0; ++$i, $j&gt;&gt;=1) {
<a name="l01833"></a>01833                     <span class="comment">//Rearrange style indices if required ...</span>
<a name="l01834"></a>01834                     <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][1&lt;&lt;$i])) {
<a name="l01835"></a>01835                         $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][$i] =
<a name="l01836"></a>01836                             $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][1&lt;&lt;$i];
<a name="l01837"></a>01837                         unset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][1&lt;&lt;$i]);
<a name="l01838"></a>01838                     }
<a name="l01839"></a>01839 
<a name="l01840"></a>01840                     <span class="comment">//Check if this bit is set for highlighting</span>
<a name="l01841"></a>01841                     <span class="keywordflow">if</span>($j&amp;1) {
<a name="l01842"></a>01842                         <span class="comment">//So this bit is set ...</span>
<a name="l01843"></a>01843                         <span class="comment">//Check if it belongs to group 0 or the actual stylegroup</span>
<a name="l01844"></a>01844                         <span class="keywordflow">if</span>(isset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][$i])) {
<a name="l01845"></a>01845                             $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>][$i] = 1 &lt;&lt; $i;
<a name="l01846"></a>01846                         } <span class="keywordflow">else</span> {
<a name="l01847"></a>01847                             <span class="keywordflow">if</span>(!isset($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>][0])) {
<a name="l01848"></a>01848                                 $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>][0] = 0;
<a name="l01849"></a>01849                             }
<a name="l01850"></a>01850                             $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>][0] |= 1 &lt;&lt; $i;
<a name="l01851"></a>01851                         }
<a name="l01852"></a>01852                     }
<a name="l01853"></a>01853                 }
<a name="l01854"></a>01854             }
<a name="l01855"></a>01855         }
<a name="l01856"></a>01856     }
<a name="l01857"></a>01857 
<a name="l01865"></a><a class="code" href="classGeSHi.html#a0d8ba2d1475cad31e31378ba25520893">01865</a>     function <a class="code" href="classGeSHi.html#a0d8ba2d1475cad31e31378ba25520893" title="Setup caches needed for parsing.">build_parse_cache</a>() {
<a name="l01866"></a>01866         <span class="comment">// cache symbol regexp</span>
<a name="l01867"></a>01867         <span class="comment">//As this is a costy operation, we avoid doing it for multiple groups ...</span>
<a name="l01868"></a>01868         <span class="comment">//Instead we perform it for all symbols at once.</span>
<a name="l01869"></a>01869         <span class="comment">//</span>
<a name="l01870"></a>01870         <span class="comment">//For this to work, we need to reorganize the data arrays.</span>
<a name="l01871"></a>01871         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;SYMBOLS&#39;</span>] &amp;&amp; !empty($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOLS&#39;</span>])) {
<a name="l01872"></a>01872             $this-&gt;language_data[<span class="stringliteral">&#39;MULTIPLE_SYMBOL_GROUPS&#39;</span>] = count($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SYMBOLS&#39;</span>]) &gt; 1;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874             $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>] = array();
<a name="l01875"></a>01875             $symbol_preg_multi = array(); <span class="comment">// multi char symbols</span>
<a name="l01876"></a>01876             $symbol_preg_single = array(); <span class="comment">// single char symbols</span>
<a name="l01877"></a>01877             <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOLS&#39;</span>] as $key =&gt; $symbols) {
<a name="l01878"></a>01878                 <span class="keywordflow">if</span> (is_array($symbols)) {
<a name="l01879"></a>01879                     <span class="keywordflow">foreach</span> ($symbols as $sym) {
<a name="l01880"></a>01880                         $sym = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($sym);
<a name="l01881"></a>01881                         <span class="keywordflow">if</span> (!isset($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$sym])) {
<a name="l01882"></a>01882                             $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$sym] = $key;
<a name="l01883"></a>01883                             <span class="keywordflow">if</span> (isset($sym[1])) { <span class="comment">// multiple chars</span>
<a name="l01884"></a>01884                                 $symbol_preg_multi[] = preg_quote($sym, <span class="charliteral">&#39;/&#39;</span>);
<a name="l01885"></a>01885                             } <span class="keywordflow">else</span> { <span class="comment">// single char</span>
<a name="l01886"></a>01886                                 <span class="keywordflow">if</span> ($sym == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l01887"></a>01887                                     <span class="comment">// don&#39;t trigger range out of order error</span>
<a name="l01888"></a>01888                                     $symbol_preg_single[] = <span class="charliteral">&#39;\-&#39;</span>;
<a name="l01889"></a>01889                                 } <span class="keywordflow">else</span> {
<a name="l01890"></a>01890                                     $symbol_preg_single[] = preg_quote($sym, <span class="charliteral">&#39;/&#39;</span>);
<a name="l01891"></a>01891                                 }
<a name="l01892"></a>01892                             }
<a name="l01893"></a>01893                         }
<a name="l01894"></a>01894                     }
<a name="l01895"></a>01895                 } <span class="keywordflow">else</span> {
<a name="l01896"></a>01896                     $symbols = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($symbols);
<a name="l01897"></a>01897                     <span class="keywordflow">if</span> (!isset($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$symbols])) {
<a name="l01898"></a>01898                         $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$symbols] = 0;
<a name="l01899"></a>01899                         <span class="keywordflow">if</span> (isset($symbols[1])) { <span class="comment">// multiple chars</span>
<a name="l01900"></a>01900                             $symbol_preg_multi[] = preg_quote($symbols, <span class="charliteral">&#39;/&#39;</span>);
<a name="l01901"></a>01901                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($symbols == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l01902"></a>01902                             <span class="comment">// don&#39;t trigger range out of order error</span>
<a name="l01903"></a>01903                             $symbol_preg_single[] = <span class="charliteral">&#39;\-&#39;</span>;
<a name="l01904"></a>01904                         } <span class="keywordflow">else</span> { <span class="comment">// single char</span>
<a name="l01905"></a>01905                             $symbol_preg_single[] = preg_quote($symbols, <span class="charliteral">&#39;/&#39;</span>);
<a name="l01906"></a>01906                         }
<a name="l01907"></a>01907                     }
<a name="l01908"></a>01908                 }
<a name="l01909"></a>01909             }
<a name="l01910"></a>01910 
<a name="l01911"></a>01911             <span class="comment">//Now we have an array with each possible symbol as the key and the style as the actual data.</span>
<a name="l01912"></a>01912             <span class="comment">//This way we can set the correct style just the moment we highlight ...</span>
<a name="l01913"></a>01913             <span class="comment">//</span>
<a name="l01914"></a>01914             <span class="comment">//Now we need to rewrite our array to get a search string that</span>
<a name="l01915"></a>01915             $symbol_preg = array();
<a name="l01916"></a>01916             <span class="keywordflow">if</span> (!empty($symbol_preg_multi)) {
<a name="l01917"></a>01917                 rsort($symbol_preg_multi);
<a name="l01918"></a>01918                 $symbol_preg[] = implode(<span class="charliteral">&#39;|&#39;</span>, $symbol_preg_multi);
<a name="l01919"></a>01919             }
<a name="l01920"></a>01920             <span class="keywordflow">if</span> (!empty($symbol_preg_single)) {
<a name="l01921"></a>01921                 rsort($symbol_preg_single);
<a name="l01922"></a>01922                 $symbol_preg[] = <span class="charliteral">&#39;[&#39;</span> . implode(<span class="stringliteral">&#39;&#39;</span>, $symbol_preg_single) . <span class="charliteral">&#39;]&#39;</span>;
<a name="l01923"></a>01923             }
<a name="l01924"></a>01924             $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_SEARCH&#39;</span>] = implode(<span class="stringliteral">&quot;|&quot;</span>, $symbol_preg);
<a name="l01925"></a>01925         }
<a name="l01926"></a>01926 
<a name="l01927"></a>01927         <span class="comment">// cache optimized regexp for keyword matching</span>
<a name="l01928"></a>01928         <span class="comment">// remove old cache</span>
<a name="l01929"></a>01929         $this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>] = array();
<a name="l01930"></a>01930         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>]) as $key) {
<a name="l01931"></a>01931             <span class="keywordflow">if</span> (!isset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]) ||
<a name="l01932"></a>01932                     $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key]) {
<a name="l01933"></a>01933                 $this-&gt;<a class="code" href="classGeSHi.html#a3d0ad9c4da51c320af7b240581ac76a9" title="compile optimized regexp list for keyword group">optimize_keyword_group</a>($key);
<a name="l01934"></a>01934             }
<a name="l01935"></a>01935         }
<a name="l01936"></a>01936 
<a name="l01937"></a>01937         <span class="comment">// brackets</span>
<a name="l01938"></a>01938         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;BRACKETS&#39;</span>]) {
<a name="l01939"></a>01939             $this-&gt;language_data[<span class="stringliteral">&#39;CACHE_BRACKET_MATCH&#39;</span>] = array(<span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;]&#39;</span>, <span class="charliteral">&#39;(&#39;</span>, <span class="charliteral">&#39;)&#39;</span>, <span class="charliteral">&#39;{&#39;</span>, <span class="charliteral">&#39;}&#39;</span>);
<a name="l01940"></a>01940             <span class="keywordflow">if</span> (!$this-&gt;use_classes &amp;&amp; isset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0])) {
<a name="l01941"></a>01941                 $this-&gt;language_data[<span class="stringliteral">&#39;CACHE_BRACKET_REPLACE&#39;</span>] = array(
<a name="l01942"></a>01942                     <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&amp;#91;|&gt;&#39;</span>,
<a name="l01943"></a>01943                     <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&amp;#93;|&gt;&#39;</span>,
<a name="l01944"></a>01944                     <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&amp;#40;|&gt;&#39;</span>,
<a name="l01945"></a>01945                     <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&amp;#41;|&gt;&#39;</span>,
<a name="l01946"></a>01946                     <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&amp;#123;|&gt;&#39;</span>,
<a name="l01947"></a>01947                     <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&amp;#125;|&gt;&#39;</span>,
<a name="l01948"></a>01948                 );
<a name="l01949"></a>01949             }
<a name="l01950"></a>01950             <span class="keywordflow">else</span> {
<a name="l01951"></a>01951                 $this-&gt;language_data[<span class="stringliteral">&#39;CACHE_BRACKET_REPLACE&#39;</span>] = array(
<a name="l01952"></a>01952                     <span class="stringliteral">&#39;&lt;| class=&quot;br0&quot;&gt;&amp;#91;|&gt;&#39;</span>,
<a name="l01953"></a>01953                     <span class="stringliteral">&#39;&lt;| class=&quot;br0&quot;&gt;&amp;#93;|&gt;&#39;</span>,
<a name="l01954"></a>01954                     <span class="stringliteral">&#39;&lt;| class=&quot;br0&quot;&gt;&amp;#40;|&gt;&#39;</span>,
<a name="l01955"></a>01955                     <span class="stringliteral">&#39;&lt;| class=&quot;br0&quot;&gt;&amp;#41;|&gt;&#39;</span>,
<a name="l01956"></a>01956                     <span class="stringliteral">&#39;&lt;| class=&quot;br0&quot;&gt;&amp;#123;|&gt;&#39;</span>,
<a name="l01957"></a>01957                     <span class="stringliteral">&#39;&lt;| class=&quot;br0&quot;&gt;&amp;#125;|&gt;&#39;</span>,
<a name="l01958"></a>01958                 );
<a name="l01959"></a>01959             }
<a name="l01960"></a>01960         }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962         <span class="comment">//Build the parse cache needed to highlight numbers appropriate</span>
<a name="l01963"></a>01963         <span class="keywordflow">if</span>($this-&gt;lexic_permissions[<span class="stringliteral">&#39;NUMBERS&#39;</span>]) {
<a name="l01964"></a>01964             <span class="comment">//Check if the style rearrangements have been processed ...</span>
<a name="l01965"></a>01965             <span class="comment">//This also does some preprocessing to check which style groups are useable ...</span>
<a name="l01966"></a>01966             <span class="keywordflow">if</span>(!isset($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>])) {
<a name="l01967"></a>01967                 $this-&gt;<a class="code" href="classGeSHi.html#a3e3303eb8be497200431946eb347eddb" title="Setup caches needed for styling.">build_style_cache</a>();
<a name="l01968"></a>01968             }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970             <span class="comment">//Number format specification</span>
<a name="l01971"></a>01971             <span class="comment">//All this formats are matched case-insensitively!</span>
<a name="l01972"></a>01972             <span class="keyword">static</span> $numbers_format = array(
<a name="l01973"></a>01973                 GESHI_NUMBER_INT_BASIC =&gt;
<a name="l01974"></a>01974                     <span class="stringliteral">&#39;(?:(?&lt;![0-9a-z_\.%])|(?&lt;=\.\.))(?&lt;![\d\.]e[+\-])([1-9]\d*?|0)(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01975"></a>01975                 GESHI_NUMBER_INT_CSTYLE =&gt;
<a name="l01976"></a>01976                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.%])(?&lt;![\d\.]e[+\-])([1-9]\d*?|0)l(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01977"></a>01977                 GESHI_NUMBER_BIN_SUFFIX =&gt;
<a name="l01978"></a>01978                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])[01]+?[bB](?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01979"></a>01979                 GESHI_NUMBER_BIN_PREFIX_PERCENT =&gt;
<a name="l01980"></a>01980                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.%])(?&lt;![\d\.]e[+\-])%[01]+?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01981"></a>01981                 GESHI_NUMBER_BIN_PREFIX_0B =&gt;
<a name="l01982"></a>01982                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.%])(?&lt;![\d\.]e[+\-])0b[01]+?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01983"></a>01983                 GESHI_NUMBER_OCT_PREFIX =&gt;
<a name="l01984"></a>01984                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])0[0-7]+?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01985"></a>01985                 GESHI_NUMBER_OCT_PREFIX_0O =&gt;
<a name="l01986"></a>01986                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.%])(?&lt;![\d\.]e[+\-])0o[0-7]+?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01987"></a>01987                 GESHI_NUMBER_OCT_SUFFIX =&gt;
<a name="l01988"></a>01988                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])[0-7]+?o(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01989"></a>01989                 GESHI_NUMBER_HEX_PREFIX =&gt;
<a name="l01990"></a>01990                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])0x[0-9a-fA-F]+?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01991"></a>01991                 GESHI_NUMBER_HEX_SUFFIX =&gt;
<a name="l01992"></a>01992                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])\d[0-9a-fA-F]*?[hH](?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01993"></a>01993                 GESHI_NUMBER_FLT_NONSCI =&gt;
<a name="l01994"></a>01994                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])\d+?\.\d+?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01995"></a>01995                 GESHI_NUMBER_FLT_NONSCI_F =&gt;
<a name="l01996"></a>01996                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])(?:\d+?(?:\.\d*?)?|\.\d+?)f(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01997"></a>01997                 GESHI_NUMBER_FLT_SCI_SHORT =&gt;
<a name="l01998"></a>01998                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])\.\d+?(?:e[+\-]?\d+?)?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>,
<a name="l01999"></a>01999                 GESHI_NUMBER_FLT_SCI_ZERO =&gt;
<a name="l02000"></a>02000                     <span class="stringliteral">&#39;(?&lt;![0-9a-z_\.])(?&lt;![\d\.]e[+\-])(?:\d+?(?:\.\d*?)?|\.\d+?)(?:e[+\-]?\d+?)?(?![0-9a-z]|\.(?:[eE][+\-]?)?\d)&#39;</span>
<a name="l02001"></a>02001                 );
<a name="l02002"></a>02002 
<a name="l02003"></a>02003             <span class="comment">//At this step we have an associative array with flag groups for a</span>
<a name="l02004"></a>02004             <span class="comment">//specific style or an string denoting a regexp given its index.</span>
<a name="l02005"></a>02005             $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_RXCACHE&#39;</span>] = array();
<a name="l02006"></a>02006             <span class="keywordflow">foreach</span>($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>] as $key =&gt; $rxdata) {
<a name="l02007"></a>02007                 <span class="keywordflow">if</span>(is_string($rxdata)) {
<a name="l02008"></a>02008                     $regexp = $rxdata;
<a name="l02009"></a>02009                 } <span class="keywordflow">else</span> {
<a name="l02010"></a>02010                     <span class="comment">//This is a bitfield of number flags to highlight:</span>
<a name="l02011"></a>02011                     <span class="comment">//Build an array, implode them together and make this the actual RX</span>
<a name="l02012"></a>02012                     $rxuse = array();
<a name="l02013"></a>02013                     <span class="keywordflow">for</span>($i = 1; $i &lt;= $rxdata; $i&lt;&lt;=1) {
<a name="l02014"></a>02014                         <span class="keywordflow">if</span>($rxdata &amp; $i) {
<a name="l02015"></a>02015                             $rxuse[] = $numbers_format[$i];
<a name="l02016"></a>02016                         }
<a name="l02017"></a>02017                     }
<a name="l02018"></a>02018                     $regexp = implode(<span class="stringliteral">&quot;|&quot;</span>, $rxuse);
<a name="l02019"></a>02019                 }
<a name="l02020"></a>02020 
<a name="l02021"></a>02021                 $this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_RXCACHE&#39;</span>][$key] =
<a name="l02022"></a>02022                     <span class="stringliteral">&quot;/(?&lt;!&lt;\|\/)(?&lt;!&lt;\|!REG3XP)(?&lt;!&lt;\|\/NUM!)(?&lt;!\d\/&gt;)($regexp)(?!(?:&lt;DOT&gt;|(?&gt;[^&lt;]))+&gt;)(?![^&lt;]*&gt;)(?!\|&gt;)(?!\/&gt;)/i&quot;</span>; <span class="comment">//</span>
<a name="l02023"></a>02023             }
<a name="l02024"></a>02024         }
<a name="l02025"></a>02025 
<a name="l02026"></a>02026         $this-&gt;parse_cache_built = <span class="keyword">true</span>;
<a name="l02027"></a>02027     }
<a name="l02028"></a>02028 
<a name="l02039"></a><a class="code" href="classGeSHi.html#a8eabd29ad7817796612b01e1dc7d56cf">02039</a>     function <a class="code" href="classGeSHi.html#a8eabd29ad7817796612b01e1dc7d56cf" title="Returns the code in $this-&amp;gt;source, highlighted and surrounded by the nessecary...">parse_code</a> () {
<a name="l02040"></a>02040         <span class="comment">// Start the timer</span>
<a name="l02041"></a>02041         $start_time = microtime();
<a name="l02042"></a>02042 
<a name="l02043"></a>02043         <span class="comment">// Replace all newlines to a common form.</span>
<a name="l02044"></a>02044         $code = str_replace(<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;source);
<a name="l02045"></a>02045         $code = str_replace(<span class="stringliteral">&quot;\r&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $code);
<a name="l02046"></a>02046 
<a name="l02047"></a>02047         <span class="comment">// Firstly, if there is an error, we won&#39;t highlight</span>
<a name="l02048"></a>02048         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a>) {
<a name="l02049"></a>02049             <span class="comment">//Escape the source for output</span>
<a name="l02050"></a>02050             $result = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($this-&gt;source);
<a name="l02051"></a>02051 
<a name="l02052"></a>02052             <span class="comment">//This fix is related to SF#1923020, but has to be applied regardless of</span>
<a name="l02053"></a>02053             <span class="comment">//actually highlighting symbols.</span>
<a name="l02054"></a>02054             $result = str_replace(array(<span class="stringliteral">&#39;&lt;SEMI&gt;&#39;</span>, <span class="stringliteral">&#39;&lt;PIPE&gt;&#39;</span>), array(<span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;|&#39;</span>), $result);
<a name="l02055"></a>02055 
<a name="l02056"></a>02056             <span class="comment">// Timing is irrelevant</span>
<a name="l02057"></a>02057             $this-&gt;<a class="code" href="classGeSHi.html#a3c86ad4bf29c84453fd48f01aff36b9b" title="Sets the time taken to parse the code.">set_time</a>($start_time, $start_time);
<a name="l02058"></a>02058             $this-&gt;<a class="code" href="classGeSHi.html#aa7421c424ab2263d49ddafd8bf34fae7" title="Takes the parsed code and various options, and creates the HTML surrounding it to...">finalise</a>($result);
<a name="l02059"></a>02059             <span class="keywordflow">return</span> $result;
<a name="l02060"></a>02060         }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062         <span class="comment">// make sure the parse cache is up2date</span>
<a name="l02063"></a>02063         <span class="keywordflow">if</span> (!$this-&gt;parse_cache_built) {
<a name="l02064"></a>02064             $this-&gt;<a class="code" href="classGeSHi.html#a0d8ba2d1475cad31e31378ba25520893" title="Setup caches needed for parsing.">build_parse_cache</a>();
<a name="l02065"></a>02065         }
<a name="l02066"></a>02066 
<a name="l02067"></a>02067         <span class="comment">// Initialise various stuff</span>
<a name="l02068"></a>02068         $length           = strlen($code);
<a name="l02069"></a>02069         $COMMENT_MATCHED  = <span class="keyword">false</span>;
<a name="l02070"></a>02070         $stuff_to_parse   = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02071"></a>02071         $endresult        = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02072"></a>02072 
<a name="l02073"></a>02073         <span class="comment">// &quot;Important&quot; selections are handled like multiline comments</span>
<a name="l02074"></a>02074         <span class="comment">// @todo GET RID OF THIS SHIZ</span>
<a name="l02075"></a>02075         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGeSHi.html#a48a36664603935601b203b64fc9cae70" title="Sets whether context-important blocks are highlighted.">enable_important_blocks</a>) {
<a name="l02076"></a>02076             $this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_MULTI&#39;</span>][GESHI_START_IMPORTANT] = GESHI_END_IMPORTANT;
<a name="l02077"></a>02077         }
<a name="l02078"></a>02078 
<a name="l02079"></a>02079         <span class="keywordflow">if</span> ($this-&gt;strict_mode) {
<a name="l02080"></a>02080             <span class="comment">// Break the source into bits. Each bit will be a portion of the code</span>
<a name="l02081"></a>02081             <span class="comment">// within script delimiters - for example, HTML between &lt; and &gt;</span>
<a name="l02082"></a>02082             $k = 0;
<a name="l02083"></a>02083             $parts = array();
<a name="l02084"></a>02084             $matches = array();
<a name="l02085"></a>02085             $next_match_pointer = null;
<a name="l02086"></a>02086             <span class="comment">// we use a copy to unset delimiters on demand (when they are not found)</span>
<a name="l02087"></a>02087             $delim_copy = $this-&gt;language_data[<span class="stringliteral">&#39;SCRIPT_DELIMITERS&#39;</span>];
<a name="l02088"></a>02088             $i = 0;
<a name="l02089"></a>02089             <span class="keywordflow">while</span> ($i &lt; $length) {
<a name="l02090"></a>02090                 $next_match_pos = $length + 1; <span class="comment">// never true</span>
<a name="l02091"></a>02091                 <span class="keywordflow">foreach</span> ($delim_copy as $dk =&gt; $delimiters) {
<a name="l02092"></a>02092                     <span class="keywordflow">if</span>(is_array($delimiters)) {
<a name="l02093"></a>02093                         <span class="keywordflow">foreach</span> ($delimiters as $open =&gt; $close) {
<a name="l02094"></a>02094                             <span class="comment">// make sure the cache is setup properly</span>
<a name="l02095"></a>02095                             <span class="keywordflow">if</span> (!isset($matches[$dk][$open])) {
<a name="l02096"></a>02096                                 $matches[$dk][$open] = array(
<a name="l02097"></a>02097                                     <span class="stringliteral">&#39;next_match&#39;</span> =&gt; -1,
<a name="l02098"></a>02098                                     <span class="stringliteral">&#39;dk&#39;</span> =&gt; $dk,
<a name="l02099"></a>02099 
<a name="l02100"></a>02100                                     <span class="stringliteral">&#39;open&#39;</span> =&gt; $open, <span class="comment">// needed for grouping of adjacent code blocks (see below)</span>
<a name="l02101"></a>02101                                     <span class="stringliteral">&#39;open_strlen&#39;</span> =&gt; strlen($open),
<a name="l02102"></a>02102 
<a name="l02103"></a>02103                                     <span class="stringliteral">&#39;close&#39;</span> =&gt; $close,
<a name="l02104"></a>02104                                     <span class="stringliteral">&#39;close_strlen&#39;</span> =&gt; strlen($close),
<a name="l02105"></a>02105                                 );
<a name="l02106"></a>02106                             }
<a name="l02107"></a>02107                             <span class="comment">// Get the next little bit for this opening string</span>
<a name="l02108"></a>02108                             <span class="keywordflow">if</span> ($matches[$dk][$open][<span class="stringliteral">&#39;next_match&#39;</span>] &lt; $i) {
<a name="l02109"></a>02109                                 <span class="comment">// only find the next pos if it was not already cached</span>
<a name="l02110"></a>02110                                 $open_pos = strpos($code, $open, $i);
<a name="l02111"></a>02111                                 <span class="keywordflow">if</span> ($open_pos === <span class="keyword">false</span>) {
<a name="l02112"></a>02112                                     <span class="comment">// no match for this delimiter ever</span>
<a name="l02113"></a>02113                                     unset($delim_copy[$dk][$open]);
<a name="l02114"></a>02114                                     <span class="keywordflow">continue</span>;
<a name="l02115"></a>02115                                 }
<a name="l02116"></a>02116                                 $matches[$dk][$open][<span class="stringliteral">&#39;next_match&#39;</span>] = $open_pos;
<a name="l02117"></a>02117                             }
<a name="l02118"></a>02118                             <span class="keywordflow">if</span> ($matches[$dk][$open][<span class="stringliteral">&#39;next_match&#39;</span>] &lt; $next_match_pos) {
<a name="l02119"></a>02119                                 <span class="comment">//So we got a new match, update the close_pos</span>
<a name="l02120"></a>02120                                 $matches[$dk][$open][<span class="stringliteral">&#39;close_pos&#39;</span>] =
<a name="l02121"></a>02121                                     strpos($code, $close, $matches[$dk][$open][<span class="stringliteral">&#39;next_match&#39;</span>]+1);
<a name="l02122"></a>02122 
<a name="l02123"></a>02123                                 $next_match_pointer =&amp; $matches[$dk][$open];
<a name="l02124"></a>02124                                 $next_match_pos = $matches[$dk][$open][<span class="stringliteral">&#39;next_match&#39;</span>];
<a name="l02125"></a>02125                             }
<a name="l02126"></a>02126                         }
<a name="l02127"></a>02127                     } <span class="keywordflow">else</span> {
<a name="l02128"></a>02128                         <span class="comment">//So we should match an RegExp as Strict Block ...</span>
<a name="l02135"></a>02135 <span class="comment"></span>                        <span class="keywordflow">if</span>(!GESHI_PHP_PRE_433 &amp;&amp; <span class="comment">//Needs proper rewrite to work with PHP &gt;=4.3.0; 4.3.3 is guaranteed to work.</span>
<a name="l02136"></a>02136                             preg_match($delimiters, $code, $matches_rx, PREG_OFFSET_CAPTURE, $i)) {
<a name="l02137"></a>02137                             <span class="comment">//We got a match ...</span>
<a name="l02138"></a>02138                             <span class="keywordflow">if</span>(isset($matches_rx[<span class="stringliteral">&#39;start&#39;</span>]) &amp;&amp; isset($matches_rx[<span class="stringliteral">&#39;end&#39;</span>]))
<a name="l02139"></a>02139                             {
<a name="l02140"></a>02140                                 $matches[$dk] = array(
<a name="l02141"></a>02141                                     <span class="stringliteral">&#39;next_match&#39;</span> =&gt; $matches_rx[<span class="stringliteral">&#39;start&#39;</span>][1],
<a name="l02142"></a>02142                                     <span class="stringliteral">&#39;dk&#39;</span> =&gt; $dk,
<a name="l02143"></a>02143 
<a name="l02144"></a>02144                                     <span class="stringliteral">&#39;close_strlen&#39;</span> =&gt; strlen($matches_rx[<span class="stringliteral">&#39;end&#39;</span>][0]),
<a name="l02145"></a>02145                                     <span class="stringliteral">&#39;close_pos&#39;</span> =&gt; $matches_rx[<span class="stringliteral">&#39;end&#39;</span>][1],
<a name="l02146"></a>02146                                     );
<a name="l02147"></a>02147                             } <span class="keywordflow">else</span> {
<a name="l02148"></a>02148                                 $matches[$dk] = array(
<a name="l02149"></a>02149                                     <span class="stringliteral">&#39;next_match&#39;</span> =&gt; $matches_rx[1][1],
<a name="l02150"></a>02150                                     <span class="stringliteral">&#39;dk&#39;</span> =&gt; $dk,
<a name="l02151"></a>02151 
<a name="l02152"></a>02152                                     <span class="stringliteral">&#39;close_strlen&#39;</span> =&gt; strlen($matches_rx[2][0]),
<a name="l02153"></a>02153                                     <span class="stringliteral">&#39;close_pos&#39;</span> =&gt; $matches_rx[2][1],
<a name="l02154"></a>02154                                     );
<a name="l02155"></a>02155                             }
<a name="l02156"></a>02156                         } <span class="keywordflow">else</span> {
<a name="l02157"></a>02157                             <span class="comment">// no match for this delimiter ever</span>
<a name="l02158"></a>02158                             unset($delim_copy[$dk]);
<a name="l02159"></a>02159                             <span class="keywordflow">continue</span>;
<a name="l02160"></a>02160                         }
<a name="l02161"></a>02161 
<a name="l02162"></a>02162                         <span class="keywordflow">if</span> ($matches[$dk][<span class="stringliteral">&#39;next_match&#39;</span>] &lt;= $next_match_pos) {
<a name="l02163"></a>02163                             $next_match_pointer =&amp; $matches[$dk];
<a name="l02164"></a>02164                             $next_match_pos = $matches[$dk][<span class="stringliteral">&#39;next_match&#39;</span>];
<a name="l02165"></a>02165                         }
<a name="l02166"></a>02166                     }
<a name="l02167"></a>02167                 }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169                 <span class="comment">// non-highlightable text</span>
<a name="l02170"></a>02170                 $parts[$k] = array(
<a name="l02171"></a>02171                     1 =&gt; substr($code, $i, $next_match_pos - $i)
<a name="l02172"></a>02172                 );
<a name="l02173"></a>02173                 ++$k;
<a name="l02174"></a>02174 
<a name="l02175"></a>02175                 <span class="keywordflow">if</span> ($next_match_pos &gt; $length) {
<a name="l02176"></a>02176                     <span class="comment">// out of bounds means no next match was found</span>
<a name="l02177"></a>02177                     <span class="keywordflow">break</span>;
<a name="l02178"></a>02178                 }
<a name="l02179"></a>02179 
<a name="l02180"></a>02180                 <span class="comment">// highlightable code</span>
<a name="l02181"></a>02181                 $parts[$k][0] = $next_match_pointer[<span class="stringliteral">&#39;dk&#39;</span>];
<a name="l02182"></a>02182 
<a name="l02183"></a>02183                 <span class="comment">//Only combine for non-rx script blocks</span>
<a name="l02184"></a>02184                 <span class="keywordflow">if</span>(is_array($delim_copy[$next_match_pointer[<span class="stringliteral">&#39;dk&#39;</span>]])) {
<a name="l02185"></a>02185                     <span class="comment">// group adjacent script blocks, e.g. &lt;foobar&gt;&lt;asdf&gt; should be one block, not three!</span>
<a name="l02186"></a>02186                     $i = $next_match_pos + $next_match_pointer[<span class="stringliteral">&#39;open_strlen&#39;</span>];
<a name="l02187"></a>02187                     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l02188"></a>02188                         $close_pos = strpos($code, $next_match_pointer[<span class="stringliteral">&#39;close&#39;</span>], $i);
<a name="l02189"></a>02189                         <span class="keywordflow">if</span> ($close_pos == <span class="keyword">false</span>) {
<a name="l02190"></a>02190                             <span class="keywordflow">break</span>;
<a name="l02191"></a>02191                         }
<a name="l02192"></a>02192                         $i = $close_pos + $next_match_pointer[<span class="stringliteral">&#39;close_strlen&#39;</span>];
<a name="l02193"></a>02193                         <span class="keywordflow">if</span> ($i == $length) {
<a name="l02194"></a>02194                             <span class="keywordflow">break</span>;
<a name="l02195"></a>02195                         }
<a name="l02196"></a>02196                         <span class="keywordflow">if</span> ($code[$i] == $next_match_pointer[<span class="stringliteral">&#39;open&#39;</span>][0] &amp;&amp; ($next_match_pointer[<span class="stringliteral">&#39;open_strlen&#39;</span>] == 1 ||
<a name="l02197"></a>02197                             substr($code, $i, $next_match_pointer[<span class="stringliteral">&#39;open_strlen&#39;</span>]) == $next_match_pointer[<span class="stringliteral">&#39;open&#39;</span>])) {
<a name="l02198"></a>02198                             <span class="comment">// merge adjacent but make sure we don&#39;t merge things like &lt;tag&gt;&lt;!-- comment --&gt;</span>
<a name="l02199"></a>02199                             <span class="keywordflow">foreach</span> ($matches as $submatches) {
<a name="l02200"></a>02200                                 <span class="keywordflow">foreach</span> ($submatches as $match) {
<a name="l02201"></a>02201                                     <span class="keywordflow">if</span> ($match[<span class="stringliteral">&#39;next_match&#39;</span>] == $i) {
<a name="l02202"></a>02202                                         <span class="comment">// a different block already matches here!</span>
<a name="l02203"></a>02203                                         <span class="keywordflow">break</span> 3;
<a name="l02204"></a>02204                                     }
<a name="l02205"></a>02205                                 }
<a name="l02206"></a>02206                             }
<a name="l02207"></a>02207                         } <span class="keywordflow">else</span> {
<a name="l02208"></a>02208                             <span class="keywordflow">break</span>;
<a name="l02209"></a>02209                         }
<a name="l02210"></a>02210                     }
<a name="l02211"></a>02211                 } <span class="keywordflow">else</span> {
<a name="l02212"></a>02212                     $close_pos = $next_match_pointer[<span class="stringliteral">&#39;close_pos&#39;</span>] + $next_match_pointer[<span class="stringliteral">&#39;close_strlen&#39;</span>];
<a name="l02213"></a>02213                     $i = $close_pos;
<a name="l02214"></a>02214                 }
<a name="l02215"></a>02215 
<a name="l02216"></a>02216                 <span class="keywordflow">if</span> ($close_pos === <span class="keyword">false</span>) {
<a name="l02217"></a>02217                     <span class="comment">// no closing delimiter found!</span>
<a name="l02218"></a>02218                     $parts[$k][1] = substr($code, $next_match_pos);
<a name="l02219"></a>02219                     ++$k;
<a name="l02220"></a>02220                     <span class="keywordflow">break</span>;
<a name="l02221"></a>02221                 } <span class="keywordflow">else</span> {
<a name="l02222"></a>02222                     $parts[$k][1] = substr($code, $next_match_pos, $i - $next_match_pos);
<a name="l02223"></a>02223                     ++$k;
<a name="l02224"></a>02224                 }
<a name="l02225"></a>02225             }
<a name="l02226"></a>02226             unset($delim_copy, $next_match_pointer, $next_match_pos, $matches);
<a name="l02227"></a>02227             $num_parts = $k;
<a name="l02228"></a>02228 
<a name="l02229"></a>02229             <span class="keywordflow">if</span> ($num_parts == 1 &amp;&amp; $this-&gt;strict_mode == GESHI_MAYBE) {
<a name="l02230"></a>02230                 <span class="comment">// when we have only one part, we don&#39;t have anything to highlight at all.</span>
<a name="l02231"></a>02231                 <span class="comment">// if we have a &quot;maybe&quot; strict language, this should be handled as highlightable code</span>
<a name="l02232"></a>02232                 $parts = array(
<a name="l02233"></a>02233                     0 =&gt; array(
<a name="l02234"></a>02234                         0 =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l02235"></a>02235                         1 =&gt; <span class="stringliteral">&#39;&#39;</span>
<a name="l02236"></a>02236                     ),
<a name="l02237"></a>02237                     1 =&gt; array(
<a name="l02238"></a>02238                         0 =&gt; null,
<a name="l02239"></a>02239                         1 =&gt; $parts[0][1]
<a name="l02240"></a>02240                     )
<a name="l02241"></a>02241                 );
<a name="l02242"></a>02242                 $num_parts = 2;
<a name="l02243"></a>02243             }
<a name="l02244"></a>02244 
<a name="l02245"></a>02245         } <span class="keywordflow">else</span> {
<a name="l02246"></a>02246             <span class="comment">// Not strict mode - simply dump the source into</span>
<a name="l02247"></a>02247             <span class="comment">// the array at index 1 (the first highlightable block)</span>
<a name="l02248"></a>02248             $parts = array(
<a name="l02249"></a>02249                 0 =&gt; array(
<a name="l02250"></a>02250                     0 =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l02251"></a>02251                     1 =&gt; <span class="stringliteral">&#39;&#39;</span>
<a name="l02252"></a>02252                 ),
<a name="l02253"></a>02253                 1 =&gt; array(
<a name="l02254"></a>02254                     0 =&gt; null,
<a name="l02255"></a>02255                     1 =&gt; $code
<a name="l02256"></a>02256                 )
<a name="l02257"></a>02257             );
<a name="l02258"></a>02258             $num_parts = 2;
<a name="l02259"></a>02259         }
<a name="l02260"></a>02260 
<a name="l02261"></a>02261         <span class="comment">//Unset variables we won&#39;t need any longer</span>
<a name="l02262"></a>02262         unset($code);
<a name="l02263"></a>02263 
<a name="l02264"></a>02264         <span class="comment">//Preload some repeatedly used values regarding hardquotes ...</span>
<a name="l02265"></a>02265         $hq = isset($this-&gt;language_data[<span class="stringliteral">&#39;HARDQUOTE&#39;</span>]) ? $this-&gt;language_data[<span class="stringliteral">&#39;HARDQUOTE&#39;</span>][0] : <span class="keyword">false</span>;
<a name="l02266"></a>02266         $hq_strlen = strlen($hq);
<a name="l02267"></a>02267 
<a name="l02268"></a>02268         <span class="comment">//Preload if line numbers are to be generated afterwards</span>
<a name="l02269"></a>02269         <span class="comment">//Added a check if line breaks should be forced even without line numbers, fixes SF#1727398</span>
<a name="l02270"></a>02270         $check_linenumbers = $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS ||
<a name="l02271"></a>02271             !empty($this-&gt;highlight_extra_lines) || !$this-&gt;allow_multiline_span;
<a name="l02272"></a>02272 
<a name="l02273"></a>02273         <span class="comment">//preload the escape char for faster checking ...</span>
<a name="l02274"></a>02274         $escaped_escape_char = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]);
<a name="l02275"></a>02275 
<a name="l02276"></a>02276         <span class="comment">// this is used for single-line comments</span>
<a name="l02277"></a>02277         $sc_disallowed_before = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02278"></a>02278         $sc_disallowed_after = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02279"></a>02279 
<a name="l02280"></a>02280         <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>])) {
<a name="l02281"></a>02281             <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>])) {
<a name="l02282"></a>02282                 <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_BEFORE&#39;</span>])) {
<a name="l02283"></a>02283                     $sc_disallowed_before = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_BEFORE&#39;</span>];
<a name="l02284"></a>02284                 }
<a name="l02285"></a>02285                 <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_AFTER&#39;</span>])) {
<a name="l02286"></a>02286                     $sc_disallowed_after = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_AFTER&#39;</span>];
<a name="l02287"></a>02287                 }
<a name="l02288"></a>02288             }
<a name="l02289"></a>02289         }
<a name="l02290"></a>02290 
<a name="l02291"></a>02291         <span class="comment">//Fix for SF#1932083: Multichar Quotemarks unsupported</span>
<a name="l02292"></a>02292         $is_string_starter = array();
<a name="l02293"></a>02293         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;STRINGS&#39;</span>]) {
<a name="l02294"></a>02294             <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;QUOTEMARKS&#39;</span>] as $quotemark) {
<a name="l02295"></a>02295                 <span class="keywordflow">if</span> (!isset($is_string_starter[$quotemark[0]])) {
<a name="l02296"></a>02296                     $is_string_starter[$quotemark[0]] = (string)$quotemark;
<a name="l02297"></a>02297                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_string($is_string_starter[$quotemark[0]])) {
<a name="l02298"></a>02298                     $is_string_starter[$quotemark[0]] = array(
<a name="l02299"></a>02299                         $is_string_starter[$quotemark[0]],
<a name="l02300"></a>02300                         $quotemark);
<a name="l02301"></a>02301                 } <span class="keywordflow">else</span> {
<a name="l02302"></a>02302                     $is_string_starter[$quotemark[0]][] = $quotemark;
<a name="l02303"></a>02303                 }
<a name="l02304"></a>02304             }
<a name="l02305"></a>02305         }
<a name="l02306"></a>02306 
<a name="l02307"></a>02307         <span class="comment">// Now we go through each part. We know that even-indexed parts are</span>
<a name="l02308"></a>02308         <span class="comment">// code that shouldn&#39;t be highlighted, and odd-indexed parts should</span>
<a name="l02309"></a>02309         <span class="comment">// be highlighted</span>
<a name="l02310"></a>02310         <span class="keywordflow">for</span> ($key = 0; $key &lt; $num_parts; ++$key) {
<a name="l02311"></a>02311             $STRICTATTRS = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02312"></a>02312 
<a name="l02313"></a>02313             <span class="comment">// If this block should be highlighted...</span>
<a name="l02314"></a>02314             <span class="keywordflow">if</span> (!($key &amp; 1)) {
<a name="l02315"></a>02315                 <span class="comment">// Else not a block to highlight</span>
<a name="l02316"></a>02316                 $endresult .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($parts[$key][1]);
<a name="l02317"></a>02317                 unset($parts[$key]);
<a name="l02318"></a>02318                 <span class="keywordflow">continue</span>;
<a name="l02319"></a>02319             }
<a name="l02320"></a>02320 
<a name="l02321"></a>02321             $result = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02322"></a>02322             $part = $parts[$key][1];
<a name="l02323"></a>02323 
<a name="l02324"></a>02324             $highlight_part = <span class="keyword">true</span>;
<a name="l02325"></a>02325             <span class="keywordflow">if</span> ($this-&gt;strict_mode &amp;&amp; !is_null($parts[$key][0])) {
<a name="l02326"></a>02326                 <span class="comment">// get the class key for this block of code</span>
<a name="l02327"></a>02327                 $script_key = $parts[$key][0];
<a name="l02328"></a>02328                 $highlight_part = $this-&gt;language_data[<span class="stringliteral">&#39;HIGHLIGHT_STRICT_BLOCK&#39;</span>][$script_key];
<a name="l02329"></a>02329                 <span class="keywordflow">if</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SCRIPT&#39;</span>][$script_key] != <span class="stringliteral">&#39;&#39;</span> &amp;&amp;
<a name="l02330"></a>02330                     $this-&gt;lexic_permissions[<span class="stringliteral">&#39;SCRIPT&#39;</span>]) {
<a name="l02331"></a>02331                     <span class="comment">// Add a span element around the source to</span>
<a name="l02332"></a>02332                     <span class="comment">// highlight the overall source block</span>
<a name="l02333"></a>02333                     <span class="keywordflow">if</span> (!$this-&gt;use_classes &amp;&amp;
<a name="l02334"></a>02334                         $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SCRIPT&#39;</span>][$script_key] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l02335"></a>02335                         $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SCRIPT&#39;</span>][$script_key] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02336"></a>02336                     } <span class="keywordflow">else</span> {
<a name="l02337"></a>02337                         $attributes = <span class="stringliteral">&#39; class=&quot;sc&#39;</span> . $script_key . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02338"></a>02338                     }
<a name="l02339"></a>02339                     $result .= <span class="stringliteral">&quot;&lt;span$attributes&gt;&quot;</span>;
<a name="l02340"></a>02340                     $STRICTATTRS = $attributes;
<a name="l02341"></a>02341                 }
<a name="l02342"></a>02342             }
<a name="l02343"></a>02343 
<a name="l02344"></a>02344             <span class="keywordflow">if</span> ($highlight_part) {
<a name="l02345"></a>02345                 <span class="comment">// Now, highlight the code in this block. This code</span>
<a name="l02346"></a>02346                 <span class="comment">// is really the engine of GeSHi (along with the method</span>
<a name="l02347"></a>02347                 <span class="comment">// parse_non_string_part).</span>
<a name="l02348"></a>02348 
<a name="l02349"></a>02349                 <span class="comment">// cache comment regexps incrementally</span>
<a name="l02350"></a>02350                 $next_comment_regexp_key = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02351"></a>02351                 $next_comment_regexp_pos = -1;
<a name="l02352"></a>02352                 $next_comment_multi_pos = -1;
<a name="l02353"></a>02353                 $next_comment_single_pos = -1;
<a name="l02354"></a>02354                 $comment_regexp_cache_per_key = array();
<a name="l02355"></a>02355                 $comment_multi_cache_per_key = array();
<a name="l02356"></a>02356                 $comment_single_cache_per_key = array();
<a name="l02357"></a>02357                 $next_open_comment_multi = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02358"></a>02358                 $next_comment_single_key = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02359"></a>02359                 $escape_regexp_cache_per_key = array();
<a name="l02360"></a>02360                 $next_escape_regexp_key = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02361"></a>02361                 $next_escape_regexp_pos = -1;
<a name="l02362"></a>02362 
<a name="l02363"></a>02363                 $length = strlen($part);
<a name="l02364"></a>02364                 <span class="keywordflow">for</span> ($i = 0; $i &lt; $length; ++$i) {
<a name="l02365"></a>02365                     <span class="comment">// Get the next char</span>
<a name="l02366"></a>02366                     $char = $part[$i];
<a name="l02367"></a>02367                     $char_len = 1;
<a name="l02368"></a>02368 
<a name="l02369"></a>02369                     <span class="comment">// update regexp comment cache if needed</span>
<a name="l02370"></a>02370                     <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_REGEXP&#39;</span>]) &amp;&amp; $next_comment_regexp_pos &lt; $i) {
<a name="l02371"></a>02371                         $next_comment_regexp_pos = $length;
<a name="l02372"></a>02372                         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_REGEXP&#39;</span>] as $comment_key =&gt; $regexp) {
<a name="l02373"></a>02373                             $match_i = <span class="keyword">false</span>;
<a name="l02374"></a>02374                             <span class="keywordflow">if</span> (isset($comment_regexp_cache_per_key[$comment_key]) &amp;&amp;
<a name="l02375"></a>02375                                 ($comment_regexp_cache_per_key[$comment_key][<span class="stringliteral">&#39;pos&#39;</span>] &gt;= $i ||
<a name="l02376"></a>02376                                  $comment_regexp_cache_per_key[$comment_key][<span class="stringliteral">&#39;pos&#39;</span>] === <span class="keyword">false</span>)) {
<a name="l02377"></a>02377                                 <span class="comment">// we have already matched something</span>
<a name="l02378"></a>02378                                 <span class="keywordflow">if</span> ($comment_regexp_cache_per_key[$comment_key][<span class="stringliteral">&#39;pos&#39;</span>] === <span class="keyword">false</span>) {
<a name="l02379"></a>02379                                     <span class="comment">// this comment is never matched</span>
<a name="l02380"></a>02380                                     <span class="keywordflow">continue</span>;
<a name="l02381"></a>02381                                 }
<a name="l02382"></a>02382                                 $match_i = $comment_regexp_cache_per_key[$comment_key][<span class="stringliteral">&#39;pos&#39;</span>];
<a name="l02383"></a>02383                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l02384"></a>02384                                 <span class="comment">//This is to allow use of the offset parameter in preg_match and stay as compatible with older PHP versions as possible</span>
<a name="l02385"></a>02385                                 (GESHI_PHP_PRE_433 &amp;&amp; preg_match($regexp, substr($part, $i), $match, PREG_OFFSET_CAPTURE)) ||
<a name="l02386"></a>02386                                 (!GESHI_PHP_PRE_433 &amp;&amp; preg_match($regexp, $part, $match, PREG_OFFSET_CAPTURE, $i))
<a name="l02387"></a>02387                                 ) {
<a name="l02388"></a>02388                                 $match_i = $match[0][1];
<a name="l02389"></a>02389                                 <span class="keywordflow">if</span> (GESHI_PHP_PRE_433) {
<a name="l02390"></a>02390                                     $match_i += $i;
<a name="l02391"></a>02391                                 }
<a name="l02392"></a>02392 
<a name="l02393"></a>02393                                 $comment_regexp_cache_per_key[$comment_key] = array(
<a name="l02394"></a>02394                                     <span class="stringliteral">&#39;key&#39;</span> =&gt; $comment_key,
<a name="l02395"></a>02395                                     <span class="stringliteral">&#39;length&#39;</span> =&gt; strlen($match[0][0]),
<a name="l02396"></a>02396                                     <span class="stringliteral">&#39;pos&#39;</span> =&gt; $match_i
<a name="l02397"></a>02397                                 );
<a name="l02398"></a>02398                             } <span class="keywordflow">else</span> {
<a name="l02399"></a>02399                                 $comment_regexp_cache_per_key[$comment_key][<span class="stringliteral">&#39;pos&#39;</span>] = <span class="keyword">false</span>;
<a name="l02400"></a>02400                                 <span class="keywordflow">continue</span>;
<a name="l02401"></a>02401                             }
<a name="l02402"></a>02402 
<a name="l02403"></a>02403                             <span class="keywordflow">if</span> ($match_i !== <span class="keyword">false</span> &amp;&amp; $match_i &lt; $next_comment_regexp_pos) {
<a name="l02404"></a>02404                                 $next_comment_regexp_pos = $match_i;
<a name="l02405"></a>02405                                 $next_comment_regexp_key = $comment_key;
<a name="l02406"></a>02406                                 <span class="keywordflow">if</span> ($match_i === $i) {
<a name="l02407"></a>02407                                     <span class="keywordflow">break</span>;
<a name="l02408"></a>02408                                 }
<a name="l02409"></a>02409                             }
<a name="l02410"></a>02410                         }
<a name="l02411"></a>02411                     }
<a name="l02412"></a>02412 
<a name="l02413"></a>02413                     $string_started = <span class="keyword">false</span>;
<a name="l02414"></a>02414 
<a name="l02415"></a>02415                     <span class="keywordflow">if</span> (isset($is_string_starter[$char])) {
<a name="l02416"></a>02416                         <span class="comment">// Possibly the start of a new string ...</span>
<a name="l02417"></a>02417 
<a name="l02418"></a>02418                         <span class="comment">//Check which starter it was ...</span>
<a name="l02419"></a>02419                         <span class="comment">//Fix for SF#1932083: Multichar Quotemarks unsupported</span>
<a name="l02420"></a>02420                         <span class="keywordflow">if</span> (is_array($is_string_starter[$char])) {
<a name="l02421"></a>02421                             $char_new = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02422"></a>02422                             <span class="keywordflow">foreach</span> ($is_string_starter[$char] as $testchar) {
<a name="l02423"></a>02423                                 <span class="keywordflow">if</span> ($testchar === substr($part, $i, strlen($testchar)) &amp;&amp;
<a name="l02424"></a>02424                                     strlen($testchar) &gt; strlen($char_new)) {
<a name="l02425"></a>02425                                     $char_new = $testchar;
<a name="l02426"></a>02426                                     $string_started = <span class="keyword">true</span>;
<a name="l02427"></a>02427                                 }
<a name="l02428"></a>02428                             }
<a name="l02429"></a>02429                             <span class="keywordflow">if</span> ($string_started) {
<a name="l02430"></a>02430                                 $char = $char_new;
<a name="l02431"></a>02431                             }
<a name="l02432"></a>02432                         } <span class="keywordflow">else</span> {
<a name="l02433"></a>02433                             $testchar = $is_string_starter[$char];
<a name="l02434"></a>02434                             <span class="keywordflow">if</span> ($testchar === substr($part, $i, strlen($testchar))) {
<a name="l02435"></a>02435                                 $char = $testchar;
<a name="l02436"></a>02436                                 $string_started = <span class="keyword">true</span>;
<a name="l02437"></a>02437                             }
<a name="l02438"></a>02438                         }
<a name="l02439"></a>02439                         $char_len = strlen($char);
<a name="l02440"></a>02440                     }
<a name="l02441"></a>02441 
<a name="l02442"></a>02442                     <span class="keywordflow">if</span> ($string_started &amp;&amp; ($i != $next_comment_regexp_pos)) {
<a name="l02443"></a>02443                         <span class="comment">// Hand out the correct style information for this string</span>
<a name="l02444"></a>02444                         $string_key = array_search($char, $this-&gt;language_data[<span class="stringliteral">&#39;QUOTEMARKS&#39;</span>]);
<a name="l02445"></a>02445                         <span class="keywordflow">if</span> (!isset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;STRINGS&#39;</span>][$string_key]) ||
<a name="l02446"></a>02446                             !isset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>][$string_key])) {
<a name="l02447"></a>02447                             $string_key = 0;
<a name="l02448"></a>02448                         }
<a name="l02449"></a>02449 
<a name="l02450"></a>02450                         <span class="comment">// parse the stuff before this</span>
<a name="l02451"></a>02451                         $result .= $this-&gt;<a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse);
<a name="l02452"></a>02452                         $stuff_to_parse = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02453"></a>02453 
<a name="l02454"></a>02454                         <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02455"></a>02455                             $string_attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;STRINGS&#39;</span>][$string_key] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02456"></a>02456                         } <span class="keywordflow">else</span> {
<a name="l02457"></a>02457                             $string_attributes = <span class="stringliteral">&#39; class=&quot;st&#39;</span>.$string_key.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02458"></a>02458                         }
<a name="l02459"></a>02459 
<a name="l02460"></a>02460                         <span class="comment">// now handle the string</span>
<a name="l02461"></a>02461                         $string = <span class="stringliteral">&quot;&lt;span$string_attributes&gt;&quot;</span> . <a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">GeSHi::hsc</a>($char);
<a name="l02462"></a>02462                         $start = $i + $char_len;
<a name="l02463"></a>02463                         $string_open = <span class="keyword">true</span>;
<a name="l02464"></a>02464 
<a name="l02465"></a>02465                         <span class="keywordflow">if</span>(empty($this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_REGEXP&#39;</span>])) {
<a name="l02466"></a>02466                             $next_escape_regexp_pos = $length;
<a name="l02467"></a>02467                         }
<a name="l02468"></a>02468 
<a name="l02469"></a>02469                         <span class="keywordflow">do</span> {
<a name="l02470"></a>02470                             <span class="comment">//Get the regular ending pos ...</span>
<a name="l02471"></a>02471                             $close_pos = strpos($part, $char, $start);
<a name="l02472"></a>02472                             <span class="keywordflow">if</span>(<span class="keyword">false</span> === $close_pos) {
<a name="l02473"></a>02473                                 $close_pos = $length;
<a name="l02474"></a>02474                             }
<a name="l02475"></a>02475 
<a name="l02476"></a>02476                             <span class="keywordflow">if</span>($this-&gt;lexic_permissions[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]) {
<a name="l02477"></a>02477                                 <span class="comment">// update escape regexp cache if needed</span>
<a name="l02478"></a>02478                                 <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_REGEXP&#39;</span>]) &amp;&amp; $next_escape_regexp_pos &lt; $start) {
<a name="l02479"></a>02479                                     $next_escape_regexp_pos = $length;
<a name="l02480"></a>02480                                     <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_REGEXP&#39;</span>] as $escape_key =&gt; $regexp) {
<a name="l02481"></a>02481                                         $match_i = <span class="keyword">false</span>;
<a name="l02482"></a>02482                                         <span class="keywordflow">if</span> (isset($escape_regexp_cache_per_key[$escape_key]) &amp;&amp;
<a name="l02483"></a>02483                                             ($escape_regexp_cache_per_key[$escape_key][<span class="stringliteral">&#39;pos&#39;</span>] &gt;= $start ||
<a name="l02484"></a>02484                                              $escape_regexp_cache_per_key[$escape_key][<span class="stringliteral">&#39;pos&#39;</span>] === <span class="keyword">false</span>)) {
<a name="l02485"></a>02485                                             <span class="comment">// we have already matched something</span>
<a name="l02486"></a>02486                                             <span class="keywordflow">if</span> ($escape_regexp_cache_per_key[$escape_key][<span class="stringliteral">&#39;pos&#39;</span>] === <span class="keyword">false</span>) {
<a name="l02487"></a>02487                                                 <span class="comment">// this comment is never matched</span>
<a name="l02488"></a>02488                                                 <span class="keywordflow">continue</span>;
<a name="l02489"></a>02489                                             }
<a name="l02490"></a>02490                                             $match_i = $escape_regexp_cache_per_key[$escape_key][<span class="stringliteral">&#39;pos&#39;</span>];
<a name="l02491"></a>02491                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l02492"></a>02492                                             <span class="comment">//This is to allow use of the offset parameter in preg_match and stay as compatible with older PHP versions as possible</span>
<a name="l02493"></a>02493                                             (GESHI_PHP_PRE_433 &amp;&amp; preg_match($regexp, substr($part, $start), $match, PREG_OFFSET_CAPTURE)) ||
<a name="l02494"></a>02494                                             (!GESHI_PHP_PRE_433 &amp;&amp; preg_match($regexp, $part, $match, PREG_OFFSET_CAPTURE, $start))
<a name="l02495"></a>02495                                             ) {
<a name="l02496"></a>02496                                             $match_i = $match[0][1];
<a name="l02497"></a>02497                                             <span class="keywordflow">if</span> (GESHI_PHP_PRE_433) {
<a name="l02498"></a>02498                                                 $match_i += $start;
<a name="l02499"></a>02499                                             }
<a name="l02500"></a>02500 
<a name="l02501"></a>02501                                             $escape_regexp_cache_per_key[$escape_key] = array(
<a name="l02502"></a>02502                                                 <span class="stringliteral">&#39;key&#39;</span> =&gt; $escape_key,
<a name="l02503"></a>02503                                                 <span class="stringliteral">&#39;length&#39;</span> =&gt; strlen($match[0][0]),
<a name="l02504"></a>02504                                                 <span class="stringliteral">&#39;pos&#39;</span> =&gt; $match_i
<a name="l02505"></a>02505                                             );
<a name="l02506"></a>02506                                         } <span class="keywordflow">else</span> {
<a name="l02507"></a>02507                                             $escape_regexp_cache_per_key[$escape_key][<span class="stringliteral">&#39;pos&#39;</span>] = <span class="keyword">false</span>;
<a name="l02508"></a>02508                                             <span class="keywordflow">continue</span>;
<a name="l02509"></a>02509                                         }
<a name="l02510"></a>02510 
<a name="l02511"></a>02511                                         <span class="keywordflow">if</span> ($match_i !== <span class="keyword">false</span> &amp;&amp; $match_i &lt; $next_escape_regexp_pos) {
<a name="l02512"></a>02512                                             $next_escape_regexp_pos = $match_i;
<a name="l02513"></a>02513                                             $next_escape_regexp_key = $escape_key;
<a name="l02514"></a>02514                                             <span class="keywordflow">if</span> ($match_i === $start) {
<a name="l02515"></a>02515                                                 <span class="keywordflow">break</span>;
<a name="l02516"></a>02516                                             }
<a name="l02517"></a>02517                                         }
<a name="l02518"></a>02518                                     }
<a name="l02519"></a>02519                                 }
<a name="l02520"></a>02520 
<a name="l02521"></a>02521                                 <span class="comment">//Find the next simple escape position</span>
<a name="l02522"></a>02522                                 <span class="keywordflow">if</span>(<span class="stringliteral">&#39;&#39;</span> != $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]) {
<a name="l02523"></a>02523                                     $simple_escape = strpos($part, $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>], $start);
<a name="l02524"></a>02524                                     <span class="keywordflow">if</span>(<span class="keyword">false</span> === $simple_escape) {
<a name="l02525"></a>02525                                         $simple_escape = $length;
<a name="l02526"></a>02526                                     }
<a name="l02527"></a>02527                                 } <span class="keywordflow">else</span> {
<a name="l02528"></a>02528                                     $simple_escape = $length;
<a name="l02529"></a>02529                                 }
<a name="l02530"></a>02530                             } <span class="keywordflow">else</span> {
<a name="l02531"></a>02531                                 $next_escape_regexp_pos = $length;
<a name="l02532"></a>02532                                 $simple_escape = $length;
<a name="l02533"></a>02533                             }
<a name="l02534"></a>02534 
<a name="l02535"></a>02535                             <span class="keywordflow">if</span>($simple_escape &lt; $next_escape_regexp_pos &amp;&amp;
<a name="l02536"></a>02536                                 $simple_escape &lt; $length &amp;&amp;
<a name="l02537"></a>02537                                 $simple_escape &lt; $close_pos) {
<a name="l02538"></a>02538                                 <span class="comment">//The nexxt escape sequence is a simple one ...</span>
<a name="l02539"></a>02539                                 $es_pos = $simple_escape;
<a name="l02540"></a>02540 
<a name="l02541"></a>02541                                 <span class="comment">//Add the stuff not in the string yet ...</span>
<a name="l02542"></a>02542                                 $string .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($part, $start, $es_pos - $start));
<a name="l02543"></a>02543 
<a name="l02544"></a>02544                                 <span class="comment">//Get the style for this escaped char ...</span>
<a name="l02545"></a>02545                                 <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02546"></a>02546                                     $escape_char_attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>][0] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02547"></a>02547                                 } <span class="keywordflow">else</span> {
<a name="l02548"></a>02548                                     $escape_char_attributes = <span class="stringliteral">&#39; class=&quot;es0&quot;&#39;</span>;
<a name="l02549"></a>02549                                 }
<a name="l02550"></a>02550 
<a name="l02551"></a>02551                                 <span class="comment">//Add the style for the escape char ...</span>
<a name="l02552"></a>02552                                 $string .= <span class="stringliteral">&quot;&lt;span$escape_char_attributes&gt;&quot;</span> .
<a name="l02553"></a>02553                                     <a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">GeSHi::hsc</a>($this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]);
<a name="l02554"></a>02554 
<a name="l02555"></a>02555                                 <span class="comment">//Get the byte AFTER the ESCAPE_CHAR we just found</span>
<a name="l02556"></a>02556                                 $es_char = $part[$es_pos + 1];
<a name="l02557"></a>02557                                 <span class="keywordflow">if</span> ($es_char == <span class="stringliteral">&quot;\n&quot;</span>) {
<a name="l02558"></a>02558                                     <span class="comment">// don&#39;t put a newline around newlines</span>
<a name="l02559"></a>02559                                     $string .= <span class="stringliteral">&quot;&lt;/span&gt;\n&quot;</span>;
<a name="l02560"></a>02560                                     $start = $es_pos + 2;
<a name="l02561"></a>02561                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ord($es_char) &gt;= 128) {
<a name="l02562"></a>02562                                     <span class="comment">//This is an non-ASCII char (UTF8 or single byte)</span>
<a name="l02563"></a>02563                                     <span class="comment">//This code tries to work around SF#2037598 ...</span>
<a name="l02564"></a>02564                                     <span class="keywordflow">if</span>(function_exists(<span class="stringliteral">&#39;mb_substr&#39;</span>)) {
<a name="l02565"></a>02565                                         $es_char_m = mb_substr(substr($part, $es_pos+1, 16), 0, 1, $this-&gt;encoding);
<a name="l02566"></a>02566                                         $string .= $es_char_m . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02567"></a>02567                                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!GESHI_PHP_PRE_433 &amp;&amp; <span class="stringliteral">&#39;utf-8&#39;</span> == $this-&gt;encoding) {
<a name="l02568"></a>02568                                         <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&quot;/[\xC2-\xDF][\x80-\xBF]&quot;</span>.
<a name="l02569"></a>02569                                             <span class="stringliteral">&quot;|\xE0[\xA0-\xBF][\x80-\xBF]&quot;</span>.
<a name="l02570"></a>02570                                             <span class="stringliteral">&quot;|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}&quot;</span>.
<a name="l02571"></a>02571                                             <span class="stringliteral">&quot;|\xED[\x80-\x9F][\x80-\xBF]&quot;</span>.
<a name="l02572"></a>02572                                             <span class="stringliteral">&quot;|\xF0[\x90-\xBF][\x80-\xBF]{2}&quot;</span>.
<a name="l02573"></a>02573                                             <span class="stringliteral">&quot;|[\xF1-\xF3][\x80-\xBF]{3}&quot;</span>.
<a name="l02574"></a>02574                                             <span class="stringliteral">&quot;|\xF4[\x80-\x8F][\x80-\xBF]{2}/s&quot;</span>,
<a name="l02575"></a>02575                                             $part, $es_char_m, null, $es_pos + 1)) {
<a name="l02576"></a>02576                                             $es_char_m = $es_char_m[0];
<a name="l02577"></a>02577                                         } <span class="keywordflow">else</span> {
<a name="l02578"></a>02578                                             $es_char_m = $es_char;
<a name="l02579"></a>02579                                         }
<a name="l02580"></a>02580                                         $string .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($es_char_m) . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02581"></a>02581                                     } <span class="keywordflow">else</span> {
<a name="l02582"></a>02582                                         $es_char_m = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($es_char);
<a name="l02583"></a>02583                                     }
<a name="l02584"></a>02584                                     $start = $es_pos + strlen($es_char_m) + 1;
<a name="l02585"></a>02585                                 } <span class="keywordflow">else</span> {
<a name="l02586"></a>02586                                     $string .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($es_char) . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02587"></a>02587                                     $start = $es_pos + 2;
<a name="l02588"></a>02588                                 }
<a name="l02589"></a>02589                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($next_escape_regexp_pos &lt; $length &amp;&amp;
<a name="l02590"></a>02590                                 $next_escape_regexp_pos &lt; $close_pos) {
<a name="l02591"></a>02591                                 $es_pos = $next_escape_regexp_pos;
<a name="l02592"></a>02592                                 <span class="comment">//Add the stuff not in the string yet ...</span>
<a name="l02593"></a>02593                                 $string .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($part, $start, $es_pos - $start));
<a name="l02594"></a>02594 
<a name="l02595"></a>02595                                 <span class="comment">//Get the key and length of this match ...</span>
<a name="l02596"></a>02596                                 $escape = $escape_regexp_cache_per_key[$next_escape_regexp_key];
<a name="l02597"></a>02597                                 $escape_str = substr($part, $es_pos, $escape[<span class="stringliteral">&#39;length&#39;</span>]);
<a name="l02598"></a>02598                                 $escape_key = $escape[<span class="stringliteral">&#39;key&#39;</span>];
<a name="l02599"></a>02599 
<a name="l02600"></a>02600                                 <span class="comment">//Get the style for this escaped char ...</span>
<a name="l02601"></a>02601                                 <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02602"></a>02602                                     $escape_char_attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>][$escape_key] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02603"></a>02603                                 } <span class="keywordflow">else</span> {
<a name="l02604"></a>02604                                     $escape_char_attributes = <span class="stringliteral">&#39; class=&quot;es&#39;</span> . $escape_key . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02605"></a>02605                                 }
<a name="l02606"></a>02606 
<a name="l02607"></a>02607                                 <span class="comment">//Add the style for the escape char ...</span>
<a name="l02608"></a>02608                                 $string .= <span class="stringliteral">&quot;&lt;span$escape_char_attributes&gt;&quot;</span> .
<a name="l02609"></a>02609                                     $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($escape_str) . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02610"></a>02610 
<a name="l02611"></a>02611                                 $start = $es_pos + $escape[<span class="stringliteral">&#39;length&#39;</span>];
<a name="l02612"></a>02612                             } <span class="keywordflow">else</span> {
<a name="l02613"></a>02613                                 <span class="comment">//Copy the remainder of the string ...</span>
<a name="l02614"></a>02614                                 $string .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($part, $start, $close_pos - $start + $char_len)) . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02615"></a>02615                                 $start = $close_pos + $char_len;
<a name="l02616"></a>02616                                 $string_open = <span class="keyword">false</span>;
<a name="l02617"></a>02617                             }
<a name="l02618"></a>02618                         } <span class="keywordflow">while</span>($string_open);
<a name="l02619"></a>02619 
<a name="l02620"></a>02620                         <span class="keywordflow">if</span> ($check_linenumbers) {
<a name="l02621"></a>02621                             <span class="comment">// Are line numbers used? If, we should end the string before</span>
<a name="l02622"></a>02622                             <span class="comment">// the newline and begin it again (so when &lt;li&gt;s are put in the source</span>
<a name="l02623"></a>02623                             <span class="comment">// remains XHTML compliant)</span>
<a name="l02624"></a>02624                             <span class="comment">// note to self: This opens up possibility of config files specifying</span>
<a name="l02625"></a>02625                             <span class="comment">// that languages can/cannot have multiline strings???</span>
<a name="l02626"></a>02626                             $string = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;\n&lt;span$string_attributes&gt;&quot;</span>, $string);
<a name="l02627"></a>02627                         }
<a name="l02628"></a>02628 
<a name="l02629"></a>02629                         $result .= $string;
<a name="l02630"></a>02630                         $string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02631"></a>02631                         $i = $start - 1;
<a name="l02632"></a>02632                         <span class="keywordflow">continue</span>;
<a name="l02633"></a>02633                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;STRINGS&#39;</span>] &amp;&amp; $hq &amp;&amp; $hq[0] == $char &amp;&amp;
<a name="l02634"></a>02634                         substr($part, $i, $hq_strlen) == $hq &amp;&amp; ($i != $next_comment_regexp_pos)) {
<a name="l02635"></a>02635                         <span class="comment">// The start of a hard quoted string</span>
<a name="l02636"></a>02636                         <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02637"></a>02637                             $string_attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;STRINGS&#39;</span>][<span class="stringliteral">&#39;HARD&#39;</span>] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02638"></a>02638                             $escape_char_attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>][<span class="stringliteral">&#39;HARD&#39;</span>] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02639"></a>02639                         } <span class="keywordflow">else</span> {
<a name="l02640"></a>02640                             $string_attributes = <span class="stringliteral">&#39; class=&quot;st_h&quot;&#39;</span>;
<a name="l02641"></a>02641                             $escape_char_attributes = <span class="stringliteral">&#39; class=&quot;es_h&quot;&#39;</span>;
<a name="l02642"></a>02642                         }
<a name="l02643"></a>02643                         <span class="comment">// parse the stuff before this</span>
<a name="l02644"></a>02644                         $result .= $this-&gt;<a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse);
<a name="l02645"></a>02645                         $stuff_to_parse = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02646"></a>02646 
<a name="l02647"></a>02647                         <span class="comment">// now handle the string</span>
<a name="l02648"></a>02648                         $string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02649"></a>02649 
<a name="l02650"></a>02650                         <span class="comment">// look for closing quote</span>
<a name="l02651"></a>02651                         $start = $i + $hq_strlen;
<a name="l02652"></a>02652                         <span class="keywordflow">while</span> ($close_pos = strpos($part, $this-&gt;language_data[<span class="stringliteral">&#39;HARDQUOTE&#39;</span>][1], $start)) {
<a name="l02653"></a>02653                             $start = $close_pos + 1;
<a name="l02654"></a>02654                             <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>] &amp;&amp; $part[$close_pos - 1] == $this-&gt;language_data[<span class="stringliteral">&#39;HARDCHAR&#39;</span>] &amp;&amp;
<a name="l02655"></a>02655                                 (($i + $hq_strlen) != ($close_pos))) { <span class="comment">//Support empty string for HQ escapes if Starter = Escape</span>
<a name="l02656"></a>02656                                 <span class="comment">// make sure this quote is not escaped</span>
<a name="l02657"></a>02657                                 <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;HARDESCAPE&#39;</span>] as $hardescape) {
<a name="l02658"></a>02658                                     <span class="keywordflow">if</span> (substr($part, $close_pos - 1, strlen($hardescape)) == $hardescape) {
<a name="l02659"></a>02659                                         <span class="comment">// check wether this quote is escaped or if it is something like &#39;\\&#39;</span>
<a name="l02660"></a>02660                                         $escape_char_pos = $close_pos - 1;
<a name="l02661"></a>02661                                         <span class="keywordflow">while</span> ($escape_char_pos &gt; 0
<a name="l02662"></a>02662                                                 &amp;&amp; $part[$escape_char_pos - 1] == $this-&gt;language_data[<span class="stringliteral">&#39;HARDCHAR&#39;</span>]) {
<a name="l02663"></a>02663                                             --$escape_char_pos;
<a name="l02664"></a>02664                                         }
<a name="l02665"></a>02665                                         <span class="keywordflow">if</span> (($close_pos - $escape_char_pos) &amp; 1) {
<a name="l02666"></a>02666                                             <span class="comment">// uneven number of escape chars =&gt; this quote is escaped</span>
<a name="l02667"></a>02667                                             <span class="keywordflow">continue</span> 2;
<a name="l02668"></a>02668                                         }
<a name="l02669"></a>02669                                     }
<a name="l02670"></a>02670                                 }
<a name="l02671"></a>02671                             }
<a name="l02672"></a>02672 
<a name="l02673"></a>02673                             <span class="comment">// found closing quote</span>
<a name="l02674"></a>02674                             <span class="keywordflow">break</span>;
<a name="l02675"></a>02675                         }
<a name="l02676"></a>02676 
<a name="l02677"></a>02677                         <span class="comment">//Found the closing delimiter?</span>
<a name="l02678"></a>02678                         <span class="keywordflow">if</span> (!$close_pos) {
<a name="l02679"></a>02679                             <span class="comment">// span till the end of this $part when no closing delimiter is found</span>
<a name="l02680"></a>02680                             $close_pos = $length;
<a name="l02681"></a>02681                         }
<a name="l02682"></a>02682 
<a name="l02683"></a>02683                         <span class="comment">//Get the actual string</span>
<a name="l02684"></a>02684                         $string = substr($part, $i, $close_pos - $i + 1);
<a name="l02685"></a>02685                         $i = $close_pos;
<a name="l02686"></a>02686 
<a name="l02687"></a>02687                         <span class="comment">// handle escape chars and encode html chars</span>
<a name="l02688"></a>02688                         <span class="comment">// (special because when we have escape chars within our string they may not be escaped)</span>
<a name="l02689"></a>02689                         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>] &amp;&amp; $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]) {
<a name="l02690"></a>02690                             $start = 0;
<a name="l02691"></a>02691                             $new_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02692"></a>02692                             <span class="keywordflow">while</span> ($es_pos = strpos($string, $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>], $start)) {
<a name="l02693"></a>02693                                 <span class="comment">// hmtl escape stuff before</span>
<a name="l02694"></a>02694                                 $new_string .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($string, $start, $es_pos - $start));
<a name="l02695"></a>02695                                 <span class="comment">// check if this is a hard escape</span>
<a name="l02696"></a>02696                                 <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;HARDESCAPE&#39;</span>] as $hardescape) {
<a name="l02697"></a>02697                                     <span class="keywordflow">if</span> (substr($string, $es_pos, strlen($hardescape)) == $hardescape) {
<a name="l02698"></a>02698                                         <span class="comment">// indeed, this is a hardescape</span>
<a name="l02699"></a>02699                                         $new_string .= <span class="stringliteral">&quot;&lt;span$escape_char_attributes&gt;&quot;</span> .
<a name="l02700"></a>02700                                             $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($hardescape) . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02701"></a>02701                                         $start = $es_pos + strlen($hardescape);
<a name="l02702"></a>02702                                         <span class="keywordflow">continue</span> 2;
<a name="l02703"></a>02703                                     }
<a name="l02704"></a>02704                                 }
<a name="l02705"></a>02705                                 <span class="comment">// not a hard escape, but a normal escape</span>
<a name="l02706"></a>02706                                 <span class="comment">// they come in pairs of two</span>
<a name="l02707"></a>02707                                 $c = 0;
<a name="l02708"></a>02708                                 <span class="keywordflow">while</span> (isset($string[$es_pos + $c]) &amp;&amp; isset($string[$es_pos + $c + 1])
<a name="l02709"></a>02709                                     &amp;&amp; $string[$es_pos + $c] == $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]
<a name="l02710"></a>02710                                     &amp;&amp; $string[$es_pos + $c + 1] == $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>]) {
<a name="l02711"></a>02711                                     $c += 2;
<a name="l02712"></a>02712                                 }
<a name="l02713"></a>02713                                 <span class="keywordflow">if</span> ($c) {
<a name="l02714"></a>02714                                     $new_string .= <span class="stringliteral">&quot;&lt;span$escape_char_attributes&gt;&quot;</span> .
<a name="l02715"></a>02715                                         str_repeat($escaped_escape_char, $c) .
<a name="l02716"></a>02716                                         <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02717"></a>02717                                     $start = $es_pos + $c;
<a name="l02718"></a>02718                                 } <span class="keywordflow">else</span> {
<a name="l02719"></a>02719                                     <span class="comment">// this is just a single lonely escape char...</span>
<a name="l02720"></a>02720                                     $new_string .= $escaped_escape_char;
<a name="l02721"></a>02721                                     $start = $es_pos + 1;
<a name="l02722"></a>02722                                 }
<a name="l02723"></a>02723                             }
<a name="l02724"></a>02724                             $string = $new_string . $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($string, $start));
<a name="l02725"></a>02725                         } <span class="keywordflow">else</span> {
<a name="l02726"></a>02726                             $string = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($string);
<a name="l02727"></a>02727                         }
<a name="l02728"></a>02728 
<a name="l02729"></a>02729                         <span class="keywordflow">if</span> ($check_linenumbers) {
<a name="l02730"></a>02730                             <span class="comment">// Are line numbers used? If, we should end the string before</span>
<a name="l02731"></a>02731                             <span class="comment">// the newline and begin it again (so when &lt;li&gt;s are put in the source</span>
<a name="l02732"></a>02732                             <span class="comment">// remains XHTML compliant)</span>
<a name="l02733"></a>02733                             <span class="comment">// note to self: This opens up possibility of config files specifying</span>
<a name="l02734"></a>02734                             <span class="comment">// that languages can/cannot have multiline strings???</span>
<a name="l02735"></a>02735                             $string = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;\n&lt;span$string_attributes&gt;&quot;</span>, $string);
<a name="l02736"></a>02736                         }
<a name="l02737"></a>02737 
<a name="l02738"></a>02738                         $result .= <span class="stringliteral">&quot;&lt;span$string_attributes&gt;&quot;</span> . $string . <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02739"></a>02739                         $string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02740"></a>02740                         <span class="keywordflow">continue</span>;
<a name="l02741"></a>02741                     } <span class="keywordflow">else</span> {
<a name="l02742"></a>02742                         <span class="comment">//Have a look for regexp comments</span>
<a name="l02743"></a>02743                         <span class="keywordflow">if</span> ($i == $next_comment_regexp_pos) {
<a name="l02744"></a>02744                             $COMMENT_MATCHED = <span class="keyword">true</span>;
<a name="l02745"></a>02745                             $comment = $comment_regexp_cache_per_key[$next_comment_regexp_key];
<a name="l02746"></a>02746                             $test_str = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($part, $i, $comment[<span class="stringliteral">&#39;length&#39;</span>]));
<a name="l02747"></a>02747 
<a name="l02748"></a>02748                             <span class="comment">//@todo If remove important do remove here</span>
<a name="l02749"></a>02749                             <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;MULTI&#39;</span>]) {
<a name="l02750"></a>02750                                 <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02751"></a>02751                                     $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][$comment[<span class="stringliteral">&#39;key&#39;</span>]] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02752"></a>02752                                 } <span class="keywordflow">else</span> {
<a name="l02753"></a>02753                                     $attributes = <span class="stringliteral">&#39; class=&quot;co&#39;</span> . $comment[<span class="stringliteral">&#39;key&#39;</span>] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02754"></a>02754                                 }
<a name="l02755"></a>02755 
<a name="l02756"></a>02756                                 $test_str = <span class="stringliteral">&quot;&lt;span$attributes&gt;&quot;</span> . $test_str . <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>;
<a name="l02757"></a>02757 
<a name="l02758"></a>02758                                 <span class="comment">// Short-cut through all the multiline code</span>
<a name="l02759"></a>02759                                 <span class="keywordflow">if</span> ($check_linenumbers) {
<a name="l02760"></a>02760                                     <span class="comment">// strreplace to put close span and open span around multiline newlines</span>
<a name="l02761"></a>02761                                     $test_str = str_replace(
<a name="l02762"></a>02762                                         <span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;\n&lt;span$attributes&gt;&quot;</span>,
<a name="l02763"></a>02763                                         str_replace(<span class="stringliteral">&quot;\n &quot;</span>, <span class="stringliteral">&quot;\n&amp;nbsp;&quot;</span>, $test_str)
<a name="l02764"></a>02764                                     );
<a name="l02765"></a>02765                                 }
<a name="l02766"></a>02766                             }
<a name="l02767"></a>02767 
<a name="l02768"></a>02768                             $i += $comment[<span class="stringliteral">&#39;length&#39;</span>] - 1;
<a name="l02769"></a>02769 
<a name="l02770"></a>02770                             <span class="comment">// parse the rest</span>
<a name="l02771"></a>02771                             $result .= $this-&gt;<a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse);
<a name="l02772"></a>02772                             $stuff_to_parse = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02773"></a>02773                         }
<a name="l02774"></a>02774 
<a name="l02775"></a>02775                         <span class="comment">// If we haven&#39;t matched a regexp comment, try multi-line comments</span>
<a name="l02776"></a>02776                         <span class="keywordflow">if</span> (!$COMMENT_MATCHED) {
<a name="l02777"></a>02777                             <span class="comment">// Is this a multiline comment?</span>
<a name="l02778"></a>02778                             <span class="keywordflow">if</span> (!empty($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_MULTI&#39;</span>]) &amp;&amp; $next_comment_multi_pos &lt; $i) {
<a name="l02779"></a>02779                                 $next_comment_multi_pos = $length;
<a name="l02780"></a>02780                                 <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_MULTI&#39;</span>] as $open =&gt; $close) {
<a name="l02781"></a>02781                                     $match_i = <span class="keyword">false</span>;
<a name="l02782"></a>02782                                     <span class="keywordflow">if</span> (isset($comment_multi_cache_per_key[$open]) &amp;&amp;
<a name="l02783"></a>02783                                         ($comment_multi_cache_per_key[$open] &gt;= $i ||
<a name="l02784"></a>02784                                          $comment_multi_cache_per_key[$open] === <span class="keyword">false</span>)) {
<a name="l02785"></a>02785                                         <span class="comment">// we have already matched something</span>
<a name="l02786"></a>02786                                         <span class="keywordflow">if</span> ($comment_multi_cache_per_key[$open] === <span class="keyword">false</span>) {
<a name="l02787"></a>02787                                             <span class="comment">// this comment is never matched</span>
<a name="l02788"></a>02788                                             <span class="keywordflow">continue</span>;
<a name="l02789"></a>02789                                         }
<a name="l02790"></a>02790                                         $match_i = $comment_multi_cache_per_key[$open];
<a name="l02791"></a>02791                                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($match_i = stripos($part, $open, $i)) !== <span class="keyword">false</span>) {
<a name="l02792"></a>02792                                         $comment_multi_cache_per_key[$open] = $match_i;
<a name="l02793"></a>02793                                     } <span class="keywordflow">else</span> {
<a name="l02794"></a>02794                                         $comment_multi_cache_per_key[$open] = <span class="keyword">false</span>;
<a name="l02795"></a>02795                                         <span class="keywordflow">continue</span>;
<a name="l02796"></a>02796                                     }
<a name="l02797"></a>02797                                     <span class="keywordflow">if</span> ($match_i !== <span class="keyword">false</span> &amp;&amp; $match_i &lt; $next_comment_multi_pos) {
<a name="l02798"></a>02798                                         $next_comment_multi_pos = $match_i;
<a name="l02799"></a>02799                                         $next_open_comment_multi = $open;
<a name="l02800"></a>02800                                         <span class="keywordflow">if</span> ($match_i === $i) {
<a name="l02801"></a>02801                                             <span class="keywordflow">break</span>;
<a name="l02802"></a>02802                                         }
<a name="l02803"></a>02803                                     }
<a name="l02804"></a>02804                                 }
<a name="l02805"></a>02805                             }
<a name="l02806"></a>02806                             <span class="keywordflow">if</span> ($i == $next_comment_multi_pos) {
<a name="l02807"></a>02807                                 $open = $next_open_comment_multi;
<a name="l02808"></a>02808                                 $close = $this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_MULTI&#39;</span>][$open];
<a name="l02809"></a>02809                                 $open_strlen = strlen($open);
<a name="l02810"></a>02810                                 $close_strlen = strlen($close);
<a name="l02811"></a>02811                                 $COMMENT_MATCHED = <span class="keyword">true</span>;
<a name="l02812"></a>02812                                 $test_str_match = $open;
<a name="l02813"></a>02813                                 <span class="comment">//@todo If remove important do remove here</span>
<a name="l02814"></a>02814                                 <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;MULTI&#39;</span>] ||
<a name="l02815"></a>02815                                     $open == GESHI_START_IMPORTANT) {
<a name="l02816"></a>02816                                     <span class="keywordflow">if</span> ($open != GESHI_START_IMPORTANT) {
<a name="l02817"></a>02817                                         <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02818"></a>02818                                             $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;MULTI&#39;</span>] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02819"></a>02819                                         } <span class="keywordflow">else</span> {
<a name="l02820"></a>02820                                             $attributes = <span class="stringliteral">&#39; class=&quot;coMULTI&quot;&#39;</span>;
<a name="l02821"></a>02821                                         }
<a name="l02822"></a>02822                                         $test_str = <span class="stringliteral">&quot;&lt;span$attributes&gt;&quot;</span> . $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($open);
<a name="l02823"></a>02823                                     } <span class="keywordflow">else</span> {
<a name="l02824"></a>02824                                         <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02825"></a>02825                                             $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;important_styles . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02826"></a>02826                                         } <span class="keywordflow">else</span> {
<a name="l02827"></a>02827                                             $attributes = <span class="stringliteral">&#39; class=&quot;imp&quot;&#39;</span>;
<a name="l02828"></a>02828                                         }
<a name="l02829"></a>02829 
<a name="l02830"></a>02830                                         <span class="comment">// We don&#39;t include the start of the comment if it&#39;s an</span>
<a name="l02831"></a>02831                                         <span class="comment">// &quot;important&quot; part</span>
<a name="l02832"></a>02832                                         $test_str = <span class="stringliteral">&quot;&lt;span$attributes&gt;&quot;</span>;
<a name="l02833"></a>02833                                     }
<a name="l02834"></a>02834                                 } <span class="keywordflow">else</span> {
<a name="l02835"></a>02835                                     $test_str = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($open);
<a name="l02836"></a>02836                                 }
<a name="l02837"></a>02837 
<a name="l02838"></a>02838                                 $close_pos = strpos( $part, $close, $i + $open_strlen );
<a name="l02839"></a>02839 
<a name="l02840"></a>02840                                 <span class="keywordflow">if</span> ($close_pos === <span class="keyword">false</span>) {
<a name="l02841"></a>02841                                     $close_pos = $length;
<a name="l02842"></a>02842                                 }
<a name="l02843"></a>02843 
<a name="l02844"></a>02844                                 <span class="comment">// Short-cut through all the multiline code</span>
<a name="l02845"></a>02845                                 $rest_of_comment = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($part, $i + $open_strlen, $close_pos - $i - $open_strlen + $close_strlen));
<a name="l02846"></a>02846                                 <span class="keywordflow">if</span> (($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;MULTI&#39;</span>] ||
<a name="l02847"></a>02847                                     $test_str_match == GESHI_START_IMPORTANT) &amp;&amp;
<a name="l02848"></a>02848                                     $check_linenumbers) {
<a name="l02849"></a>02849 
<a name="l02850"></a>02850                                     <span class="comment">// strreplace to put close span and open span around multiline newlines</span>
<a name="l02851"></a>02851                                     $test_str .= str_replace(
<a name="l02852"></a>02852                                         <span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;\n&lt;span$attributes&gt;&quot;</span>,
<a name="l02853"></a>02853                                         str_replace(<span class="stringliteral">&quot;\n &quot;</span>, <span class="stringliteral">&quot;\n&amp;nbsp;&quot;</span>, $rest_of_comment)
<a name="l02854"></a>02854                                     );
<a name="l02855"></a>02855                                 } <span class="keywordflow">else</span> {
<a name="l02856"></a>02856                                     $test_str .= $rest_of_comment;
<a name="l02857"></a>02857                                 }
<a name="l02858"></a>02858 
<a name="l02859"></a>02859                                 <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][<span class="stringliteral">&#39;MULTI&#39;</span>] ||
<a name="l02860"></a>02860                                     $test_str_match == GESHI_START_IMPORTANT) {
<a name="l02861"></a>02861                                     $test_str .= <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02862"></a>02862                                 }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864                                 $i = $close_pos + $close_strlen - 1;
<a name="l02865"></a>02865 
<a name="l02866"></a>02866                                 <span class="comment">// parse the rest</span>
<a name="l02867"></a>02867                                 $result .= $this-&gt;<a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse);
<a name="l02868"></a>02868                                 $stuff_to_parse = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02869"></a>02869                             }
<a name="l02870"></a>02870                         }
<a name="l02871"></a>02871 
<a name="l02872"></a>02872                         <span class="comment">// If we haven&#39;t matched a multiline comment, try single-line comments</span>
<a name="l02873"></a>02873                         <span class="keywordflow">if</span> (!$COMMENT_MATCHED) {
<a name="l02874"></a>02874                             <span class="comment">// cache potential single line comment occurances</span>
<a name="l02875"></a>02875                             <span class="keywordflow">if</span> (!empty($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_SINGLE&#39;</span>]) &amp;&amp; $next_comment_single_pos &lt; $i) {
<a name="l02876"></a>02876                                 $next_comment_single_pos = $length;
<a name="l02877"></a>02877                                 <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_SINGLE&#39;</span>] as $comment_key =&gt; $comment_mark) {
<a name="l02878"></a>02878                                     $match_i = <span class="keyword">false</span>;
<a name="l02879"></a>02879                                     <span class="keywordflow">if</span> (isset($comment_single_cache_per_key[$comment_key]) &amp;&amp;
<a name="l02880"></a>02880                                         ($comment_single_cache_per_key[$comment_key] &gt;= $i ||
<a name="l02881"></a>02881                                          $comment_single_cache_per_key[$comment_key] === <span class="keyword">false</span>)) {
<a name="l02882"></a>02882                                         <span class="comment">// we have already matched something</span>
<a name="l02883"></a>02883                                         <span class="keywordflow">if</span> ($comment_single_cache_per_key[$comment_key] === <span class="keyword">false</span>) {
<a name="l02884"></a>02884                                             <span class="comment">// this comment is never matched</span>
<a name="l02885"></a>02885                                             <span class="keywordflow">continue</span>;
<a name="l02886"></a>02886                                         }
<a name="l02887"></a>02887                                         $match_i = $comment_single_cache_per_key[$comment_key];
<a name="l02888"></a>02888                                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l02889"></a>02889                                         <span class="comment">// case sensitive comments</span>
<a name="l02890"></a>02890                                         ($this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][GESHI_COMMENTS] &amp;&amp;
<a name="l02891"></a>02891                                         ($match_i = stripos($part, $comment_mark, $i)) !== <span class="keyword">false</span>) ||
<a name="l02892"></a>02892                                         <span class="comment">// non case sensitive</span>
<a name="l02893"></a>02893                                         (!$this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][GESHI_COMMENTS] &amp;&amp;
<a name="l02894"></a>02894                                           (($match_i = strpos($part, $comment_mark, $i)) !== <span class="keyword">false</span>))) {
<a name="l02895"></a>02895                                         $comment_single_cache_per_key[$comment_key] = $match_i;
<a name="l02896"></a>02896                                     } <span class="keywordflow">else</span> {
<a name="l02897"></a>02897                                         $comment_single_cache_per_key[$comment_key] = <span class="keyword">false</span>;
<a name="l02898"></a>02898                                         <span class="keywordflow">continue</span>;
<a name="l02899"></a>02899                                     }
<a name="l02900"></a>02900                                     <span class="keywordflow">if</span> ($match_i !== <span class="keyword">false</span> &amp;&amp; $match_i &lt; $next_comment_single_pos) {
<a name="l02901"></a>02901                                         $next_comment_single_pos = $match_i;
<a name="l02902"></a>02902                                         $next_comment_single_key = $comment_key;
<a name="l02903"></a>02903                                         <span class="keywordflow">if</span> ($match_i === $i) {
<a name="l02904"></a>02904                                             <span class="keywordflow">break</span>;
<a name="l02905"></a>02905                                         }
<a name="l02906"></a>02906                                     }
<a name="l02907"></a>02907                                 }
<a name="l02908"></a>02908                             }
<a name="l02909"></a>02909                             <span class="keywordflow">if</span> ($next_comment_single_pos == $i) {
<a name="l02910"></a>02910                                 $comment_key = $next_comment_single_key;
<a name="l02911"></a>02911                                 $comment_mark = $this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_SINGLE&#39;</span>][$comment_key];
<a name="l02912"></a>02912                                 $com_len = strlen($comment_mark);
<a name="l02913"></a>02913 
<a name="l02914"></a>02914                                 <span class="comment">// This check will find special variables like $# in bash</span>
<a name="l02915"></a>02915                                 <span class="comment">// or compiler directives of Delphi beginning {$</span>
<a name="l02916"></a>02916                                 <span class="keywordflow">if</span> ((empty($sc_disallowed_before) || ($i == 0) ||
<a name="l02917"></a>02917                                     (<span class="keyword">false</span> === strpos($sc_disallowed_before, $part[$i-1]))) &amp;&amp;
<a name="l02918"></a>02918                                     (empty($sc_disallowed_after) || ($length &lt;= $i + $com_len) ||
<a name="l02919"></a>02919                                     (<span class="keyword">false</span> === strpos($sc_disallowed_after, $part[$i + $com_len]))))
<a name="l02920"></a>02920                                 {
<a name="l02921"></a>02921                                     <span class="comment">// this is a valid comment</span>
<a name="l02922"></a>02922                                     $COMMENT_MATCHED = <span class="keyword">true</span>;
<a name="l02923"></a>02923                                     <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][$comment_key]) {
<a name="l02924"></a>02924                                         <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l02925"></a>02925                                             $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>][$comment_key] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02926"></a>02926                                         } <span class="keywordflow">else</span> {
<a name="l02927"></a>02927                                             $attributes = <span class="stringliteral">&#39; class=&quot;co&#39;</span> . $comment_key . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02928"></a>02928                                         }
<a name="l02929"></a>02929                                         $test_str = <span class="stringliteral">&quot;&lt;span$attributes&gt;&quot;</span> . $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($this-&gt;<a class="code" href="classGeSHi.html#ab0a9e16a57d121907166a3c6f53822e6" title="Changes the case of a keyword for those languages where a change is asked for.">change_case</a>($comment_mark));
<a name="l02930"></a>02930                                     } <span class="keywordflow">else</span> {
<a name="l02931"></a>02931                                         $test_str = $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($comment_mark);
<a name="l02932"></a>02932                                     }
<a name="l02933"></a>02933 
<a name="l02934"></a>02934                                     <span class="comment">//Check if this comment is the last in the source</span>
<a name="l02935"></a>02935                                     $close_pos = strpos($part, <span class="stringliteral">&quot;\n&quot;</span>, $i);
<a name="l02936"></a>02936                                     $oops = <span class="keyword">false</span>;
<a name="l02937"></a>02937                                     <span class="keywordflow">if</span> ($close_pos === <span class="keyword">false</span>) {
<a name="l02938"></a>02938                                         $close_pos = $length;
<a name="l02939"></a>02939                                         $oops = <span class="keyword">true</span>;
<a name="l02940"></a>02940                                     }
<a name="l02941"></a>02941                                     $test_str .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(substr($part, $i + $com_len, $close_pos - $i - $com_len));
<a name="l02942"></a>02942                                     <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][$comment_key]) {
<a name="l02943"></a>02943                                         $test_str .= <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>;
<a name="l02944"></a>02944                                     }
<a name="l02945"></a>02945 
<a name="l02946"></a>02946                                     <span class="comment">// Take into account that the comment might be the last in the source</span>
<a name="l02947"></a>02947                                     <span class="keywordflow">if</span> (!$oops) {
<a name="l02948"></a>02948                                       $test_str .= <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l02949"></a>02949                                     }
<a name="l02950"></a>02950 
<a name="l02951"></a>02951                                     $i = $close_pos;
<a name="l02952"></a>02952 
<a name="l02953"></a>02953                                     <span class="comment">// parse the rest</span>
<a name="l02954"></a>02954                                     $result .= $this-&gt;<a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse);
<a name="l02955"></a>02955                                     $stuff_to_parse = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02956"></a>02956                                 }
<a name="l02957"></a>02957                             }
<a name="l02958"></a>02958                         }
<a name="l02959"></a>02959                     }
<a name="l02960"></a>02960 
<a name="l02961"></a>02961                     <span class="comment">// Where are we adding this char?</span>
<a name="l02962"></a>02962                     <span class="keywordflow">if</span> (!$COMMENT_MATCHED) {
<a name="l02963"></a>02963                         $stuff_to_parse .= $char;
<a name="l02964"></a>02964                     } <span class="keywordflow">else</span> {
<a name="l02965"></a>02965                         $result .= $test_str;
<a name="l02966"></a>02966                         unset($test_str);
<a name="l02967"></a>02967                         $COMMENT_MATCHED = <span class="keyword">false</span>;
<a name="l02968"></a>02968                     }
<a name="l02969"></a>02969                 }
<a name="l02970"></a>02970                 <span class="comment">// Parse the last bit</span>
<a name="l02971"></a>02971                 $result .= $this-&gt;<a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse);
<a name="l02972"></a>02972                 $stuff_to_parse = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02973"></a>02973             } <span class="keywordflow">else</span> {
<a name="l02974"></a>02974                 $result .= $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($part);
<a name="l02975"></a>02975             }
<a name="l02976"></a>02976             <span class="comment">// Close the &lt;span&gt; that surrounds the block</span>
<a name="l02977"></a>02977             <span class="keywordflow">if</span> ($STRICTATTRS != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l02978"></a>02978                 $result = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;\n&lt;span$STRICTATTRS&gt;&quot;</span>, $result);
<a name="l02979"></a>02979                 $result .= <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l02980"></a>02980             }
<a name="l02981"></a>02981 
<a name="l02982"></a>02982             $endresult .= $result;
<a name="l02983"></a>02983             unset($part, $parts[$key], $result);
<a name="l02984"></a>02984         }
<a name="l02985"></a>02985 
<a name="l02986"></a>02986         <span class="comment">//This fix is related to SF#1923020, but has to be applied regardless of</span>
<a name="l02987"></a>02987         <span class="comment">//actually highlighting symbols.</span>
<a name="l02989"></a>02989 <span class="comment"></span>        $endresult = str_replace(array(<span class="stringliteral">&#39;&lt;SEMI&gt;&#39;</span>, <span class="stringliteral">&#39;&lt;PIPE&gt;&#39;</span>), array(<span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;|&#39;</span>), $endresult);
<a name="l02990"></a>02990 
<a name="l02991"></a>02991 <span class="comment">//        // Parse the last stuff (redundant?)</span>
<a name="l02992"></a>02992 <span class="comment">//        $result .= $this-&gt;parse_non_string_part($stuff_to_parse);</span>
<a name="l02993"></a>02993 
<a name="l02994"></a>02994         <span class="comment">// Lop off the very first and last spaces</span>
<a name="l02995"></a>02995 <span class="comment">//        $result = substr($result, 1, -1);</span>
<a name="l02996"></a>02996 
<a name="l02997"></a>02997         <span class="comment">// We&#39;re finished: stop timing</span>
<a name="l02998"></a>02998         $this-&gt;<a class="code" href="classGeSHi.html#a3c86ad4bf29c84453fd48f01aff36b9b" title="Sets the time taken to parse the code.">set_time</a>($start_time, microtime());
<a name="l02999"></a>02999 
<a name="l03000"></a>03000         $this-&gt;<a class="code" href="classGeSHi.html#aa7421c424ab2263d49ddafd8bf34fae7" title="Takes the parsed code and various options, and creates the HTML surrounding it to...">finalise</a>($endresult);
<a name="l03001"></a>03001         <span class="keywordflow">return</span> $endresult;
<a name="l03002"></a>03002     }
<a name="l03003"></a>03003 
<a name="l03012"></a><a class="code" href="classGeSHi.html#a5cdad1e4917521b8c107ddbf29065de0">03012</a>     function <a class="code" href="classGeSHi.html#a5cdad1e4917521b8c107ddbf29065de0" title="Swaps out spaces and tabs for HTML indentation.">indent</a>(&amp;$result) {
<a name="l03014"></a>03014         <span class="keywordflow">if</span> (<span class="keyword">false</span> !== strpos($result, <span class="stringliteral">&quot;\t&quot;</span>)) {
<a name="l03015"></a>03015             $lines = explode(<span class="stringliteral">&quot;\n&quot;</span>, $result);
<a name="l03016"></a>03016             $result = null;<span class="comment">//Save memory while we process the lines individually</span>
<a name="l03017"></a>03017             $tab_width = $this-&gt;<a class="code" href="classGeSHi.html#ad9b807a0fb6eaaec6459c95f398d349f" title="Returns the tab width to use, based on the current language and user preference.">get_real_tab_width</a>();
<a name="l03018"></a>03018             $tab_string = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span> . str_repeat(<span class="charliteral">&#39; &#39;</span>, $tab_width);
<a name="l03019"></a>03019 
<a name="l03020"></a>03020             <span class="keywordflow">for</span> ($key = 0, $n = count($lines); $key &lt; $n; $key++) {
<a name="l03021"></a>03021                 $line = $lines[$key];
<a name="l03022"></a>03022                 <span class="keywordflow">if</span> (<span class="keyword">false</span> === strpos($line, <span class="stringliteral">&quot;\t&quot;</span>)) {
<a name="l03023"></a>03023                     <span class="keywordflow">continue</span>;
<a name="l03024"></a>03024                 }
<a name="l03025"></a>03025 
<a name="l03026"></a>03026                 $pos = 0;
<a name="l03027"></a>03027                 $length = strlen($line);
<a name="l03028"></a>03028                 $lines[$key] = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// reduce memory</span>
<a name="l03029"></a>03029 
<a name="l03030"></a>03030                 $IN_TAG = <span class="keyword">false</span>;
<a name="l03031"></a>03031                 <span class="keywordflow">for</span> ($i = 0; $i &lt; $length; ++$i) {
<a name="l03032"></a>03032                     $char = $line[$i];
<a name="l03033"></a>03033                     <span class="comment">// Simple engine to work out whether we&#39;re in a tag.</span>
<a name="l03034"></a>03034                     <span class="comment">// If we are we modify $pos. This is so we ignore HTML</span>
<a name="l03035"></a>03035                     <span class="comment">// in the line and only workout the tab replacement</span>
<a name="l03036"></a>03036                     <span class="comment">// via the actual content of the string</span>
<a name="l03037"></a>03037                     <span class="comment">// This test could be improved to include strings in the</span>
<a name="l03038"></a>03038                     <span class="comment">// html so that &lt; or &gt; would be allowed in user&#39;s styles</span>
<a name="l03039"></a>03039                     <span class="comment">// (e.g. quotes: &#39;&lt;&#39; &#39;&gt;&#39;; or similar)</span>
<a name="l03040"></a>03040                     <span class="keywordflow">if</span> ($IN_TAG) {
<a name="l03041"></a>03041                         <span class="keywordflow">if</span> (<span class="charliteral">&#39;&gt;&#39;</span> == $char) {
<a name="l03042"></a>03042                             $IN_TAG = <span class="keyword">false</span>;
<a name="l03043"></a>03043                         }
<a name="l03044"></a>03044                         $lines[$key] .= $char;
<a name="l03045"></a>03045                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;&lt;&#39;</span> == $char) {
<a name="l03046"></a>03046                         $IN_TAG = <span class="keyword">true</span>;
<a name="l03047"></a>03047                         $lines[$key] .= <span class="charliteral">&#39;&lt;&#39;</span>;
<a name="l03048"></a>03048                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;&amp;&#39;</span> == $char) {
<a name="l03049"></a>03049                         $substr = substr($line, $i + 3, 5);
<a name="l03050"></a>03050                         $posi = strpos($substr, <span class="charliteral">&#39;;&#39;</span>);
<a name="l03051"></a>03051                         <span class="keywordflow">if</span> (<span class="keyword">false</span> === $posi) {
<a name="l03052"></a>03052                             ++$pos;
<a name="l03053"></a>03053                         } <span class="keywordflow">else</span> {
<a name="l03054"></a>03054                             $pos -= $posi+2;
<a name="l03055"></a>03055                         }
<a name="l03056"></a>03056                         $lines[$key] .= $char;
<a name="l03057"></a>03057                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;\t&quot;</span> == $char) {
<a name="l03058"></a>03058                         $str = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03059"></a>03059                         <span class="comment">// OPTIMISE - move $strs out. Make an array:</span>
<a name="l03060"></a>03060                         <span class="comment">// $tabs = array(</span>
<a name="l03061"></a>03061                         <span class="comment">//  1 =&gt; &#39;&amp;nbsp;&#39;,</span>
<a name="l03062"></a>03062                         <span class="comment">//  2 =&gt; &#39;&amp;nbsp; &#39;,</span>
<a name="l03063"></a>03063                         <span class="comment">//  3 =&gt; &#39;&amp;nbsp; &amp;nbsp;&#39; etc etc</span>
<a name="l03064"></a>03064                         <span class="comment">// to use instead of building a string every time</span>
<a name="l03065"></a>03065                         $tab_end_width = $tab_width - ($pos % $tab_width); <span class="comment">//Moved out of the look as it doesn&#39;t change within the loop</span>
<a name="l03066"></a>03066                         <span class="keywordflow">if</span> (($pos &amp; 1) || 1 == $tab_end_width) {
<a name="l03067"></a>03067                             $str .= substr($tab_string, 6, $tab_end_width);
<a name="l03068"></a>03068                         } <span class="keywordflow">else</span> {
<a name="l03069"></a>03069                             $str .= substr($tab_string, 0, $tab_end_width+5);
<a name="l03070"></a>03070                         }
<a name="l03071"></a>03071                         $lines[$key] .= $str;
<a name="l03072"></a>03072                         $pos += $tab_end_width;
<a name="l03073"></a>03073 
<a name="l03074"></a>03074                         <span class="keywordflow">if</span> (<span class="keyword">false</span> === strpos($line, <span class="stringliteral">&quot;\t&quot;</span>, $i + 1)) {
<a name="l03075"></a>03075                             $lines[$key] .= substr($line, $i + 1);
<a name="l03076"></a>03076                             <span class="keywordflow">break</span>;
<a name="l03077"></a>03077                         }
<a name="l03078"></a>03078                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == $pos &amp;&amp; <span class="charliteral">&#39; &#39;</span> == $char) {
<a name="l03079"></a>03079                         $lines[$key] .= <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;
<a name="l03080"></a>03080                         ++$pos;
<a name="l03081"></a>03081                     } <span class="keywordflow">else</span> {
<a name="l03082"></a>03082                         $lines[$key] .= $char;
<a name="l03083"></a>03083                         ++$pos;
<a name="l03084"></a>03084                     }
<a name="l03085"></a>03085                 }
<a name="l03086"></a>03086             }
<a name="l03087"></a>03087             $result = implode(<span class="stringliteral">&quot;\n&quot;</span>, $lines);
<a name="l03088"></a>03088             unset($lines);<span class="comment">//We don&#39;t need the lines separated beyond this --- free them!</span>
<a name="l03089"></a>03089         }
<a name="l03090"></a>03090         <span class="comment">// Other whitespace</span>
<a name="l03091"></a>03091         <span class="comment">// BenBE: Fix to reduce the number of replacements to be done</span>
<a name="l03092"></a>03092         $result = preg_replace(<span class="stringliteral">&#39;/^ /m&#39;</span>, <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>, $result);
<a name="l03093"></a>03093         $result = str_replace(<span class="stringliteral">&#39;  &#39;</span>, <span class="stringliteral">&#39; &amp;nbsp;&#39;</span>, $result);
<a name="l03094"></a>03094 
<a name="l03095"></a>03095         <span class="keywordflow">if</span> ($this-&gt;line_numbers == GESHI_NO_LINE_NUMBERS &amp;&amp; $this-&gt;header_type != GESHI_HEADER_PRE_TABLE) {
<a name="l03096"></a>03096             <span class="keywordflow">if</span> ($this-&gt;line_ending === null) {
<a name="l03097"></a>03097                 $result = nl2br($result);
<a name="l03098"></a>03098             } <span class="keywordflow">else</span> {
<a name="l03099"></a>03099                 $result = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;line_ending, $result);
<a name="l03100"></a>03100             }
<a name="l03101"></a>03101         }
<a name="l03102"></a>03102     }
<a name="l03103"></a>03103 
<a name="l03112"></a><a class="code" href="classGeSHi.html#ab0a9e16a57d121907166a3c6f53822e6">03112</a>     function <a class="code" href="classGeSHi.html#ab0a9e16a57d121907166a3c6f53822e6" title="Changes the case of a keyword for those languages where a change is asked for.">change_case</a>($instr) {
<a name="l03113"></a>03113         <span class="keywordflow">switch</span> ($this-&gt;language_data[<span class="stringliteral">&#39;CASE_KEYWORDS&#39;</span>]) {
<a name="l03114"></a>03114             <span class="keywordflow">case</span> GESHI_CAPS_UPPER:
<a name="l03115"></a>03115                 <span class="keywordflow">return</span> strtoupper($instr);
<a name="l03116"></a>03116             <span class="keywordflow">case</span> GESHI_CAPS_LOWER:
<a name="l03117"></a>03117                 <span class="keywordflow">return</span> strtolower($instr);
<a name="l03118"></a>03118             <span class="keywordflow">default</span>:
<a name="l03119"></a>03119                 <span class="keywordflow">return</span> $instr;
<a name="l03120"></a>03120         }
<a name="l03121"></a>03121     }
<a name="l03122"></a>03122 
<a name="l03133"></a><a class="code" href="classGeSHi.html#ac805e25b3d3b98e56721d1b3923695a1">03133</a>     function <a class="code" href="classGeSHi.html#ac805e25b3d3b98e56721d1b3923695a1" title="Handles replacements of keywords to include markup and links if requested.">handle_keyword_replace</a>($match) {
<a name="l03134"></a>03134         $k = $this-&gt;_kw_replace_group;
<a name="l03135"></a>03135         $keyword = $match[0];
<a name="l03136"></a>03136 
<a name="l03137"></a>03137         $before = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03138"></a>03138         $after = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03139"></a>03139 
<a name="l03140"></a>03140         <span class="keywordflow">if</span> ($this-&gt;keyword_links) {
<a name="l03141"></a>03141             <span class="comment">// Keyword links have been ebabled</span>
<a name="l03142"></a>03142 
<a name="l03143"></a>03143             <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;URLS&#39;</span>][$k]) &amp;&amp;
<a name="l03144"></a>03144                 $this-&gt;language_data[<span class="stringliteral">&#39;URLS&#39;</span>][$k] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l03145"></a>03145                 <span class="comment">// There is a base group for this keyword</span>
<a name="l03146"></a>03146 
<a name="l03147"></a>03147                 <span class="comment">// Old system: strtolower</span>
<a name="l03148"></a>03148                 <span class="comment">//$keyword = ( $this-&gt;language_data[&#39;CASE_SENSITIVE&#39;][$group] ) ? $keyword : strtolower($keyword);</span>
<a name="l03149"></a>03149                 <span class="comment">// New system: get keyword from language file to get correct case</span>
<a name="l03150"></a>03150                 <span class="keywordflow">if</span> (!$this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][$k] &amp;&amp;
<a name="l03151"></a>03151                     strpos($this-&gt;language_data[<span class="stringliteral">&#39;URLS&#39;</span>][$k], <span class="stringliteral">&#39;{FNAME}&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03152"></a>03152                     <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k] as $word) {
<a name="l03153"></a>03153                         <span class="keywordflow">if</span> (strcasecmp($word, $keyword) == 0) {
<a name="l03154"></a>03154                             <span class="keywordflow">break</span>;
<a name="l03155"></a>03155                         }
<a name="l03156"></a>03156                     }
<a name="l03157"></a>03157                 } <span class="keywordflow">else</span> {
<a name="l03158"></a>03158                     $word = $keyword;
<a name="l03159"></a>03159                 }
<a name="l03160"></a>03160 
<a name="l03161"></a>03161                 $before = <span class="stringliteral">&#39;&lt;|UR1|&quot;&#39;</span> .
<a name="l03162"></a>03162                     str_replace(
<a name="l03163"></a>03163                         array(
<a name="l03164"></a>03164                             <span class="stringliteral">&#39;{FNAME}&#39;</span>,
<a name="l03165"></a>03165                             <span class="stringliteral">&#39;{FNAMEL}&#39;</span>,
<a name="l03166"></a>03166                             <span class="stringliteral">&#39;{FNAMEU}&#39;</span>,
<a name="l03167"></a>03167                             <span class="charliteral">&#39;.&#39;</span>),
<a name="l03168"></a>03168                         array(
<a name="l03169"></a>03169                             str_replace(<span class="charliteral">&#39;+&#39;</span>, <span class="stringliteral">&#39;%20&#39;</span>, urlencode($this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($word))),
<a name="l03170"></a>03170                             str_replace(<span class="charliteral">&#39;+&#39;</span>, <span class="stringliteral">&#39;%20&#39;</span>, urlencode($this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(strtolower($word)))),
<a name="l03171"></a>03171                             str_replace(<span class="charliteral">&#39;+&#39;</span>, <span class="stringliteral">&#39;%20&#39;</span>, urlencode($this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(strtoupper($word)))),
<a name="l03172"></a>03172                             <span class="stringliteral">&#39;&lt;DOT&gt;&#39;</span>),
<a name="l03173"></a>03173                         $this-&gt;language_data[<span class="stringliteral">&#39;URLS&#39;</span>][$k]
<a name="l03174"></a>03174                     ) . <span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l03175"></a>03175                 $after = <span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;
<a name="l03176"></a>03176             }
<a name="l03177"></a>03177         }
<a name="l03178"></a>03178 
<a name="l03179"></a>03179         <span class="keywordflow">return</span> $before . <span class="stringliteral">&#39;&lt;|/&#39;</span>. $k .<span class="stringliteral">&#39;/&gt;&#39;</span> . $this-&gt;<a class="code" href="classGeSHi.html#ab0a9e16a57d121907166a3c6f53822e6" title="Changes the case of a keyword for those languages where a change is asked for.">change_case</a>($keyword) . <span class="stringliteral">&#39;|&gt;&#39;</span> . $after;
<a name="l03180"></a>03180     }
<a name="l03181"></a>03181 
<a name="l03192"></a><a class="code" href="classGeSHi.html#a21017883a0d35d04d8d806a7bfdd7925">03192</a>     function <a class="code" href="classGeSHi.html#a21017883a0d35d04d8d806a7bfdd7925" title="handles regular expressions highlighting-definitions with callback functions">handle_regexps_callback</a>($matches) {
<a name="l03193"></a>03193         <span class="comment">// before: &quot;&#39; style=\&quot;&#39; . call_user_func(\&quot;$func\&quot;, &#39;\\1&#39;) . &#39;\&quot;\\1|&gt;&#39;&quot;,</span>
<a name="l03194"></a>03194         <span class="keywordflow">return</span>  <span class="stringliteral">&#39; style=&quot;&#39;</span> . call_user_func($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;REGEXPS&#39;</span>][$this-&gt;_rx_key], $matches[1]) . <span class="charliteral">&#39;&quot;&#39;</span>. $matches[1] . <span class="stringliteral">&#39;|&gt;&#39;</span>;
<a name="l03195"></a>03195     }
<a name="l03196"></a>03196 
<a name="l03207"></a><a class="code" href="classGeSHi.html#a531f5ad652fb640d9005b0d8ed8075cf">03207</a>     function <a class="code" href="classGeSHi.html#a531f5ad652fb640d9005b0d8ed8075cf" title="handles newlines in REGEXPS matches.">handle_multiline_regexps</a>($matches) {
<a name="l03208"></a>03208         $before = $this-&gt;_hmr_before;
<a name="l03209"></a>03209         $after = $this-&gt;_hmr_after;
<a name="l03210"></a>03210         <span class="keywordflow">if</span> ($this-&gt;_hmr_replace) {
<a name="l03211"></a>03211             $replace = $this-&gt;_hmr_replace;
<a name="l03212"></a>03212             $search = array();
<a name="l03213"></a>03213 
<a name="l03214"></a>03214             <span class="keywordflow">foreach</span> (array_keys($matches) as $k) {
<a name="l03215"></a>03215                 $search[] = <span class="charliteral">&#39;\\&#39;</span> . $k;
<a name="l03216"></a>03216             }
<a name="l03217"></a>03217 
<a name="l03218"></a>03218             $before = str_replace($search, $matches, $before);
<a name="l03219"></a>03219             $after = str_replace($search, $matches, $after);
<a name="l03220"></a>03220             $replace = str_replace($search, $matches, $replace);
<a name="l03221"></a>03221         } <span class="keywordflow">else</span> {
<a name="l03222"></a>03222             $replace = $matches[0];
<a name="l03223"></a>03223         }
<a name="l03224"></a>03224         <span class="keywordflow">return</span> $before
<a name="l03225"></a>03225                     . <span class="stringliteral">&#39;&lt;|!REG3XP&#39;</span> . $this-&gt;_hmr_key .<span class="stringliteral">&#39;!&gt;&#39;</span>
<a name="l03226"></a>03226                         . str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;|&gt;\n&lt;|!REG3XP&quot;</span> . $this-&gt;_hmr_key . <span class="stringliteral">&#39;!&gt;&#39;</span>, $replace)
<a name="l03227"></a>03227                     . <span class="stringliteral">&#39;|&gt;&#39;</span>
<a name="l03228"></a>03228               . $after;
<a name="l03229"></a>03229     }
<a name="l03230"></a>03230 
<a name="l03240"></a><a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74">03240</a>     function <a class="code" href="classGeSHi.html#aa48862b4146192a1e3553bbdb0720e74" title="Takes a string that has no strings or comments in it, and highlights stuff like keywords...">parse_non_string_part</a>($stuff_to_parse) {
<a name="l03241"></a>03241         $stuff_to_parse = <span class="charliteral">&#39; &#39;</span> . $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($stuff_to_parse);
<a name="l03242"></a>03242 
<a name="l03243"></a>03243         <span class="comment">// Highlight keywords</span>
<a name="l03244"></a>03244         $disallowed_before = <span class="stringliteral">&quot;(?&lt;![a-zA-Z0-9\$_\|\#;&gt;|^&amp;&quot;</span>;
<a name="l03245"></a>03245         $disallowed_after = <span class="stringliteral">&quot;(?![a-zA-Z0-9_\|%\\-&amp;;&quot;</span>;
<a name="l03246"></a>03246         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;STRINGS&#39;</span>]) {
<a name="l03247"></a>03247             $quotemarks = preg_quote(implode($this-&gt;language_data[<span class="stringliteral">&#39;QUOTEMARKS&#39;</span>]), <span class="charliteral">&#39;/&#39;</span>);
<a name="l03248"></a>03248             $disallowed_before .= $quotemarks;
<a name="l03249"></a>03249             $disallowed_after .= $quotemarks;
<a name="l03250"></a>03250         }
<a name="l03251"></a>03251         $disallowed_before .= <span class="stringliteral">&quot;])&quot;</span>;
<a name="l03252"></a>03252         $disallowed_after .= <span class="stringliteral">&quot;])&quot;</span>;
<a name="l03253"></a>03253 
<a name="l03254"></a>03254         $parser_control_pergroup = <span class="keyword">false</span>;
<a name="l03255"></a>03255         <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>])) {
<a name="l03256"></a>03256             <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>])) {
<a name="l03257"></a>03257                 $x = 0; <span class="comment">// check wether per-keyword-group parser_control is enabled</span>
<a name="l03258"></a>03258                 <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_BEFORE&#39;</span>])) {
<a name="l03259"></a>03259                     $disallowed_before = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_BEFORE&#39;</span>];
<a name="l03260"></a>03260                     ++$x;
<a name="l03261"></a>03261                 }
<a name="l03262"></a>03262                 <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_AFTER&#39;</span>])) {
<a name="l03263"></a>03263                     $disallowed_after = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][<span class="stringliteral">&#39;DISALLOWED_AFTER&#39;</span>];
<a name="l03264"></a>03264                     ++$x;
<a name="l03265"></a>03265                 }
<a name="l03266"></a>03266                 $parser_control_pergroup = (count($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>]) - $x) &gt; 0;
<a name="l03267"></a>03267             }
<a name="l03268"></a>03268         }
<a name="l03269"></a>03269 
<a name="l03270"></a>03270         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>]) as $k) {
<a name="l03271"></a>03271             <span class="keywordflow">if</span> (!isset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k]) ||
<a name="l03272"></a>03272             $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k]) {
<a name="l03273"></a>03273 
<a name="l03274"></a>03274                 $case_sensitive = $this-&gt;language_data[<span class="stringliteral">&#39;CASE_SENSITIVE&#39;</span>][$k];
<a name="l03275"></a>03275                 $modifiers = $case_sensitive ? <span class="stringliteral">&#39;&#39;</span> : <span class="charliteral">&#39;i&#39;</span>;
<a name="l03276"></a>03276 
<a name="l03277"></a>03277                 <span class="comment">// NEW in 1.0.8 - per-keyword-group parser control</span>
<a name="l03278"></a>03278                 $disallowed_before_local = $disallowed_before;
<a name="l03279"></a>03279                 $disallowed_after_local = $disallowed_after;
<a name="l03280"></a>03280                 <span class="keywordflow">if</span> ($parser_control_pergroup &amp;&amp; isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k])) {
<a name="l03281"></a>03281                     <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k][<span class="stringliteral">&#39;DISALLOWED_BEFORE&#39;</span>])) {
<a name="l03282"></a>03282                         $disallowed_before_local =
<a name="l03283"></a>03283                             $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k][<span class="stringliteral">&#39;DISALLOWED_BEFORE&#39;</span>];
<a name="l03284"></a>03284                     }
<a name="l03285"></a>03285 
<a name="l03286"></a>03286                     <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k][<span class="stringliteral">&#39;DISALLOWED_AFTER&#39;</span>])) {
<a name="l03287"></a>03287                         $disallowed_after_local =
<a name="l03288"></a>03288                             $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k][<span class="stringliteral">&#39;DISALLOWED_AFTER&#39;</span>];
<a name="l03289"></a>03289                     }
<a name="l03290"></a>03290                 }
<a name="l03291"></a>03291 
<a name="l03292"></a>03292                 $this-&gt;_kw_replace_group = $k;
<a name="l03293"></a>03293 
<a name="l03294"></a>03294                 <span class="comment">//NEW in 1.0.8, the cached regexp list</span>
<a name="l03295"></a>03295                 <span class="comment">// since we don&#39;t want PHP / PCRE to crash due to too large patterns we split them into smaller chunks</span>
<a name="l03296"></a>03296                 <span class="keywordflow">for</span> ($set = 0, $set_length = count($this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$k]); $set &lt;  $set_length; ++$set) {
<a name="l03297"></a>03297                     $keywordset =&amp; $this-&gt;language_data[<span class="stringliteral">&#39;CACHED_KEYWORD_LISTS&#39;</span>][$k][$set];
<a name="l03298"></a>03298                     <span class="comment">// Might make a more unique string for putting the number in soon</span>
<a name="l03299"></a>03299                     <span class="comment">// Basically, we don&#39;t put the styles in yet because then the styles themselves will</span>
<a name="l03300"></a>03300                     <span class="comment">// get highlighted if the language has a CSS keyword in it (like CSS, for example ;))</span>
<a name="l03301"></a>03301                     $stuff_to_parse = preg_replace_callback(
<a name="l03302"></a>03302                         <span class="stringliteral">&quot;/$disallowed_before_local({$keywordset})(?!&lt;DOT&gt;(?:htm|php))$disallowed_after_local/$modifiers&quot;</span>,
<a name="l03303"></a>03303                         array($this, <span class="stringliteral">&#39;handle_keyword_replace&#39;</span>),
<a name="l03304"></a>03304                         $stuff_to_parse
<a name="l03305"></a>03305                         );
<a name="l03306"></a>03306                 }
<a name="l03307"></a>03307             }
<a name="l03308"></a>03308         }
<a name="l03309"></a>03309 
<a name="l03310"></a>03310         <span class="comment">// Regular expressions</span>
<a name="l03311"></a>03311         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>] as $key =&gt; $regexp) {
<a name="l03312"></a>03312             <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key]) {
<a name="l03313"></a>03313                 <span class="keywordflow">if</span> (is_array($regexp)) {
<a name="l03314"></a>03314                     <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l03315"></a>03315                         <span class="comment">// produce valid HTML when we match multiple lines</span>
<a name="l03316"></a>03316                         $this-&gt;_hmr_replace = $regexp[GESHI_REPLACE];
<a name="l03317"></a>03317                         $this-&gt;_hmr_before = $regexp[GESHI_BEFORE];
<a name="l03318"></a>03318                         $this-&gt;_hmr_key = $key;
<a name="l03319"></a>03319                         $this-&gt;_hmr_after = $regexp[GESHI_AFTER];
<a name="l03320"></a>03320                         $stuff_to_parse = preg_replace_callback(
<a name="l03321"></a>03321                             <span class="stringliteral">&quot;/&quot;</span> . $regexp[GESHI_SEARCH] . <span class="stringliteral">&quot;/{$regexp[GESHI_MODIFIERS]}&quot;</span>,
<a name="l03322"></a>03322                             array($this, <span class="stringliteral">&#39;handle_multiline_regexps&#39;</span>),
<a name="l03323"></a>03323                             $stuff_to_parse);
<a name="l03324"></a>03324                         $this-&gt;_hmr_replace = <span class="keyword">false</span>;
<a name="l03325"></a>03325                         $this-&gt;_hmr_before = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03326"></a>03326                         $this-&gt;_hmr_after = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03327"></a>03327                     } <span class="keywordflow">else</span> {
<a name="l03328"></a>03328                         $stuff_to_parse = preg_replace(
<a name="l03329"></a>03329                             <span class="charliteral">&#39;/&#39;</span> . $regexp[GESHI_SEARCH] . <span class="charliteral">&#39;/&#39;</span> . $regexp[GESHI_MODIFIERS],
<a name="l03330"></a>03330                             $regexp[GESHI_BEFORE] . <span class="stringliteral">&#39;&lt;|!REG3XP&#39;</span>. $key .<span class="stringliteral">&#39;!&gt;&#39;</span> . $regexp[GESHI_REPLACE] . <span class="stringliteral">&#39;|&gt;&#39;</span> . $regexp[GESHI_AFTER],
<a name="l03331"></a>03331                             $stuff_to_parse);
<a name="l03332"></a>03332                     }
<a name="l03333"></a>03333                 } <span class="keywordflow">else</span> {
<a name="l03334"></a>03334                     <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l03335"></a>03335                         <span class="comment">// produce valid HTML when we match multiple lines</span>
<a name="l03336"></a>03336                         $this-&gt;_hmr_key = $key;
<a name="l03337"></a>03337                         $stuff_to_parse = preg_replace_callback( <span class="stringliteral">&quot;/(&quot;</span> . $regexp . <span class="stringliteral">&quot;)/&quot;</span>,
<a name="l03338"></a>03338                                               array($this, <span class="stringliteral">&#39;handle_multiline_regexps&#39;</span>), $stuff_to_parse);
<a name="l03339"></a>03339                         $this-&gt;_hmr_key = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03340"></a>03340                     } <span class="keywordflow">else</span> {
<a name="l03341"></a>03341                         $stuff_to_parse = preg_replace( <span class="stringliteral">&quot;/(&quot;</span> . $regexp . <span class="stringliteral">&quot;)/&quot;</span>, <span class="stringliteral">&quot;&lt;|!REG3XP$key!&gt;\\1|&gt;&quot;</span>, $stuff_to_parse);
<a name="l03342"></a>03342                     }
<a name="l03343"></a>03343                 }
<a name="l03344"></a>03344             }
<a name="l03345"></a>03345         }
<a name="l03346"></a>03346 
<a name="l03347"></a>03347         <span class="comment">// Highlight numbers. As of 1.0.8 we support different types of numbers</span>
<a name="l03348"></a>03348         $numbers_found = <span class="keyword">false</span>;
<a name="l03349"></a>03349         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;NUMBERS&#39;</span>] &amp;&amp; preg_match(<span class="stringliteral">&#39;#\d#&#39;</span>, $stuff_to_parse )) {
<a name="l03350"></a>03350             $numbers_found = <span class="keyword">true</span>;
<a name="l03351"></a>03351 
<a name="l03352"></a>03352             <span class="comment">//For each of the formats ...</span>
<a name="l03353"></a>03353             <span class="keywordflow">foreach</span>($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_RXCACHE&#39;</span>] as $id =&gt; $regexp) {
<a name="l03354"></a>03354                 <span class="comment">//Check if it should be highlighted ...</span>
<a name="l03355"></a>03355                 $stuff_to_parse = preg_replace($regexp, <span class="stringliteral">&quot;&lt;|/NUM!$id/&gt;\\1|&gt;&quot;</span>, $stuff_to_parse);
<a name="l03356"></a>03356             }
<a name="l03357"></a>03357         }
<a name="l03358"></a>03358 
<a name="l03359"></a>03359         <span class="comment">//</span>
<a name="l03360"></a>03360         <span class="comment">// Now that&#39;s all done, replace /[number]/ with the correct styles</span>
<a name="l03361"></a>03361         <span class="comment">//</span>
<a name="l03362"></a>03362         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>]) as $k) {
<a name="l03363"></a>03363             <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l03364"></a>03364                 $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> .
<a name="l03365"></a>03365                     (isset($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k]) ?
<a name="l03366"></a>03366                     $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$k] : <span class="stringliteral">&quot;&quot;</span>) . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03367"></a>03367             } <span class="keywordflow">else</span> {
<a name="l03368"></a>03368                 $attributes = <span class="stringliteral">&#39; class=&quot;kw&#39;</span> . $k . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03369"></a>03369             }
<a name="l03370"></a>03370             $stuff_to_parse = str_replace(<span class="stringliteral">&quot;&lt;|/$k/&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;|$attributes&gt;&quot;</span>, $stuff_to_parse);
<a name="l03371"></a>03371         }
<a name="l03372"></a>03372 
<a name="l03373"></a>03373         <span class="keywordflow">if</span> ($numbers_found) {
<a name="l03374"></a>03374             <span class="comment">// Put number styles in</span>
<a name="l03375"></a>03375             <span class="keywordflow">foreach</span>($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_RXCACHE&#39;</span>] as $id =&gt; $regexp) {
<a name="l03376"></a>03376                 <span class="comment">//Commented out for now, as this needs some review ...</span>
<a name="l03377"></a>03377                 <span class="comment">//                if ($numbers_permissions &amp; $id) {</span>
<a name="l03378"></a>03378                 <span class="comment">//Get the appropriate style ...</span>
<a name="l03379"></a>03379                 <span class="comment">//Checking for unset styles is done by the style cache builder ...</span>
<a name="l03380"></a>03380                 <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l03381"></a>03381                     $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>][$id] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03382"></a>03382                 } <span class="keywordflow">else</span> {
<a name="l03383"></a>03383                     $attributes = <span class="stringliteral">&#39; class=&quot;nu&#39;</span>.$id.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03384"></a>03384                 }
<a name="l03385"></a>03385 
<a name="l03386"></a>03386                 <span class="comment">//Set in the correct styles ...</span>
<a name="l03387"></a>03387                 $stuff_to_parse = str_replace(<span class="stringliteral">&quot;/NUM!$id/&quot;</span>, $attributes, $stuff_to_parse);
<a name="l03388"></a>03388                 <span class="comment">//                }</span>
<a name="l03389"></a>03389             }
<a name="l03390"></a>03390         }
<a name="l03391"></a>03391 
<a name="l03392"></a>03392         <span class="comment">// Highlight methods and fields in objects</span>
<a name="l03393"></a>03393         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;METHODS&#39;</span>] &amp;&amp; $this-&gt;language_data[<span class="stringliteral">&#39;OOLANG&#39;</span>]) {
<a name="l03394"></a>03394             $oolang_spaces = <span class="stringliteral">&quot;[\s]*&quot;</span>;
<a name="l03395"></a>03395             $oolang_before = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03396"></a>03396             $oolang_after = <span class="stringliteral">&quot;[a-zA-Z][a-zA-Z0-9_]*&quot;</span>;
<a name="l03397"></a>03397             <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>])) {
<a name="l03398"></a>03398                 <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>])) {
<a name="l03399"></a>03399                     <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>][<span class="stringliteral">&#39;MATCH_BEFORE&#39;</span>])) {
<a name="l03400"></a>03400                         $oolang_before = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>][<span class="stringliteral">&#39;MATCH_BEFORE&#39;</span>];
<a name="l03401"></a>03401                     }
<a name="l03402"></a>03402                     <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>][<span class="stringliteral">&#39;MATCH_AFTER&#39;</span>])) {
<a name="l03403"></a>03403                         $oolang_after = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>][<span class="stringliteral">&#39;MATCH_AFTER&#39;</span>];
<a name="l03404"></a>03404                     }
<a name="l03405"></a>03405                     <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>][<span class="stringliteral">&#39;MATCH_SPACES&#39;</span>])) {
<a name="l03406"></a>03406                         $oolang_spaces = $this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;OOLANG&#39;</span>][<span class="stringliteral">&#39;MATCH_SPACES&#39;</span>];
<a name="l03407"></a>03407                     }
<a name="l03408"></a>03408                 }
<a name="l03409"></a>03409             }
<a name="l03410"></a>03410 
<a name="l03411"></a>03411             <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;OBJECT_SPLITTERS&#39;</span>] as $key =&gt; $splitter) {
<a name="l03412"></a>03412                 <span class="keywordflow">if</span> (<span class="keyword">false</span> !== strpos($stuff_to_parse, $splitter)) {
<a name="l03413"></a>03413                     <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l03414"></a>03414                         $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;METHODS&#39;</span>][$key] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03415"></a>03415                     } <span class="keywordflow">else</span> {
<a name="l03416"></a>03416                         $attributes = <span class="stringliteral">&#39; class=&quot;me&#39;</span> . $key . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03417"></a>03417                     }
<a name="l03418"></a>03418                     $stuff_to_parse = preg_replace(<span class="stringliteral">&quot;/($oolang_before)(&quot;</span> . preg_quote($this-&gt;language_data[<span class="stringliteral">&#39;OBJECT_SPLITTERS&#39;</span>][$key], <span class="charliteral">&#39;/&#39;</span>) . <span class="stringliteral">&quot;)($oolang_spaces)($oolang_after)/&quot;</span>, <span class="stringliteral">&quot;\\1\\2\\3&lt;|$attributes&gt;\\4|&gt;&quot;</span>, $stuff_to_parse);
<a name="l03419"></a>03419                 }
<a name="l03420"></a>03420             }
<a name="l03421"></a>03421         }
<a name="l03422"></a>03422 
<a name="l03423"></a>03423         <span class="comment">//</span>
<a name="l03424"></a>03424         <span class="comment">// Highlight brackets. Yes, I&#39;ve tried adding a semi-colon to this list.</span>
<a name="l03425"></a>03425         <span class="comment">// You try it, and see what happens ;)</span>
<a name="l03426"></a>03426         <span class="comment">// TODO: Fix lexic permissions not converting entities if shouldn&#39;t</span>
<a name="l03427"></a>03427         <span class="comment">// be highlighting regardless</span>
<a name="l03428"></a>03428         <span class="comment">//</span>
<a name="l03429"></a>03429         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;BRACKETS&#39;</span>]) {
<a name="l03430"></a>03430             $stuff_to_parse = str_replace( $this-&gt;language_data[<span class="stringliteral">&#39;CACHE_BRACKET_MATCH&#39;</span>],
<a name="l03431"></a>03431                               $this-&gt;language_data[<span class="stringliteral">&#39;CACHE_BRACKET_REPLACE&#39;</span>], $stuff_to_parse );
<a name="l03432"></a>03432         }
<a name="l03433"></a>03433 
<a name="l03434"></a>03434 
<a name="l03435"></a>03435         <span class="comment">//FIX for symbol highlighting ...</span>
<a name="l03436"></a>03436         <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;SYMBOLS&#39;</span>] &amp;&amp; !empty($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOLS&#39;</span>])) {
<a name="l03437"></a>03437             <span class="comment">//Get all matches and throw away those witin a block that is already highlighted... (i.e. matched by a regexp)</span>
<a name="l03438"></a>03438             $n_symbols = preg_match_all(<span class="stringliteral">&quot;/&lt;\|(?:&lt;DOT&gt;|[^&gt;])+&gt;(?:(?!\|&gt;).*?)\|&gt;|&lt;\/a&gt;|(?:&quot;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_SEARCH&#39;</span>] . <span class="stringliteral">&quot;)+(?![^&lt;]+?&gt;)/&quot;</span>, $stuff_to_parse, $pot_symbols, PREG_OFFSET_CAPTURE | PREG_SET_ORDER);
<a name="l03439"></a>03439             $global_offset = 0;
<a name="l03440"></a>03440             <span class="keywordflow">for</span> ($s_id = 0; $s_id &lt; $n_symbols; ++$s_id) {
<a name="l03441"></a>03441                 $symbol_match = $pot_symbols[$s_id][0][0];
<a name="l03442"></a>03442                 <span class="keywordflow">if</span> (strpos($symbol_match, <span class="charliteral">&#39;&lt;&#39;</span>) !== <span class="keyword">false</span> || strpos($symbol_match, <span class="charliteral">&#39;&gt;&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03443"></a>03443                     <span class="comment">// already highlighted blocks _must_ include either &lt; or &gt;</span>
<a name="l03444"></a>03444                     <span class="comment">// so if this conditional applies, we have to skip this match</span>
<a name="l03445"></a>03445                     <span class="comment">// BenBE: UNLESS the block contains &lt;SEMI&gt; or &lt;PIPE&gt;</span>
<a name="l03446"></a>03446                     <span class="keywordflow">if</span>(strpos($symbol_match, <span class="stringliteral">&#39;&lt;SEMI&gt;&#39;</span>) === <span class="keyword">false</span> &amp;&amp;
<a name="l03447"></a>03447                         strpos($symbol_match, <span class="stringliteral">&#39;&lt;PIPE&gt;&#39;</span>) === <span class="keyword">false</span>) {
<a name="l03448"></a>03448                         <span class="keywordflow">continue</span>;
<a name="l03449"></a>03449                     }
<a name="l03450"></a>03450                 }
<a name="l03451"></a>03451 
<a name="l03452"></a>03452                 <span class="comment">// if we reach this point, we have a valid match which needs to be highlighted</span>
<a name="l03453"></a>03453 
<a name="l03454"></a>03454                 $symbol_length = strlen($symbol_match);
<a name="l03455"></a>03455                 $symbol_offset = $pot_symbols[$s_id][0][1];
<a name="l03456"></a>03456                 unset($pot_symbols[$s_id]);
<a name="l03457"></a>03457                 $symbol_end = $symbol_length + $symbol_offset;
<a name="l03458"></a>03458                 $symbol_hl = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03459"></a>03459 
<a name="l03460"></a>03460                 <span class="comment">// if we have multiple styles, we have to handle them properly</span>
<a name="l03461"></a>03461                 <span class="keywordflow">if</span> ($this-&gt;language_data[<span class="stringliteral">&#39;MULTIPLE_SYMBOL_GROUPS&#39;</span>]) {
<a name="l03462"></a>03462                     $old_sym = -1;
<a name="l03463"></a>03463                     <span class="comment">// Split the current stuff to replace into its atomic symbols ...</span>
<a name="l03464"></a>03464                     preg_match_all(<span class="stringliteral">&quot;/&quot;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_SEARCH&#39;</span>] . <span class="stringliteral">&quot;/&quot;</span>, $symbol_match, $sym_match_syms, PREG_PATTERN_ORDER);
<a name="l03465"></a>03465                     <span class="keywordflow">foreach</span> ($sym_match_syms[0] as $sym_ms) {
<a name="l03466"></a>03466                         <span class="comment">//Check if consequtive symbols belong to the same group to save output ...</span>
<a name="l03467"></a>03467                         <span class="keywordflow">if</span> (isset($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$sym_ms])
<a name="l03468"></a>03468                             &amp;&amp; ($this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$sym_ms] != $old_sym)) {
<a name="l03469"></a>03469                             <span class="keywordflow">if</span> (-1 != $old_sym) {
<a name="l03470"></a>03470                                 $symbol_hl .= <span class="stringliteral">&quot;|&gt;&quot;</span>;
<a name="l03471"></a>03471                             }
<a name="l03472"></a>03472                             $old_sym = $this-&gt;language_data[<span class="stringliteral">&#39;SYMBOL_DATA&#39;</span>][$sym_ms];
<a name="l03473"></a>03473                             <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l03474"></a>03474                                 $symbol_hl .= <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SYMBOLS&#39;</span>][$old_sym] . <span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l03475"></a>03475                             } <span class="keywordflow">else</span> {
<a name="l03476"></a>03476                                 $symbol_hl .= <span class="stringliteral">&#39;&lt;| class=&quot;sy&#39;</span> . $old_sym . <span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l03477"></a>03477                             }
<a name="l03478"></a>03478                         }
<a name="l03479"></a>03479                         $symbol_hl .= $sym_ms;
<a name="l03480"></a>03480                     }
<a name="l03481"></a>03481                     unset($sym_match_syms);
<a name="l03482"></a>03482 
<a name="l03483"></a>03483                     <span class="comment">//Close remaining tags and insert the replacement at the right position ...</span>
<a name="l03484"></a>03484                     <span class="comment">//Take caution if symbol_hl is empty to avoid doubled closing spans.</span>
<a name="l03485"></a>03485                     <span class="keywordflow">if</span> (-1 != $old_sym) {
<a name="l03486"></a>03486                         $symbol_hl .= <span class="stringliteral">&quot;|&gt;&quot;</span>;
<a name="l03487"></a>03487                     }
<a name="l03488"></a>03488                 } <span class="keywordflow">else</span> {
<a name="l03489"></a>03489                     <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l03490"></a>03490                         $symbol_hl = <span class="stringliteral">&#39;&lt;| style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SYMBOLS&#39;</span>][0] . <span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l03491"></a>03491                     } <span class="keywordflow">else</span> {
<a name="l03492"></a>03492                         $symbol_hl = <span class="stringliteral">&#39;&lt;| class=&quot;sy0&quot;&gt;&#39;</span>;
<a name="l03493"></a>03493                     }
<a name="l03494"></a>03494                     $symbol_hl .= $symbol_match . <span class="stringliteral">&#39;|&gt;&#39;</span>;
<a name="l03495"></a>03495                 }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497                 $stuff_to_parse = substr_replace($stuff_to_parse, $symbol_hl, $symbol_offset + $global_offset, $symbol_length);
<a name="l03498"></a>03498 
<a name="l03499"></a>03499                 <span class="comment">// since we replace old text with something of different size,</span>
<a name="l03500"></a>03500                 <span class="comment">// we&#39;ll have to keep track of the differences</span>
<a name="l03501"></a>03501                 $global_offset += strlen($symbol_hl) - $symbol_length;
<a name="l03502"></a>03502             }
<a name="l03503"></a>03503         }
<a name="l03504"></a>03504         <span class="comment">//FIX for symbol highlighting ...</span>
<a name="l03505"></a>03505 
<a name="l03506"></a>03506         <span class="comment">// Add class/style for regexps</span>
<a name="l03507"></a>03507         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>]) as $key) {
<a name="l03508"></a>03508             <span class="keywordflow">if</span> ($this-&gt;lexic_permissions[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key]) {
<a name="l03509"></a>03509                 <span class="keywordflow">if</span> (is_callable($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key])) {
<a name="l03510"></a>03510                     $this-&gt;_rx_key = $key;
<a name="l03511"></a>03511                     $stuff_to_parse = preg_replace_callback(<span class="stringliteral">&quot;/!REG3XP$key!(.*)\|&gt;/U&quot;</span>,
<a name="l03512"></a>03512                         array($this, <span class="stringliteral">&#39;handle_regexps_callback&#39;</span>),
<a name="l03513"></a>03513                         $stuff_to_parse);
<a name="l03514"></a>03514                 } <span class="keywordflow">else</span> {
<a name="l03515"></a>03515                     <span class="keywordflow">if</span> (!$this-&gt;use_classes) {
<a name="l03516"></a>03516                         $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03517"></a>03517                     } <span class="keywordflow">else</span> {
<a name="l03518"></a>03518                         <span class="keywordflow">if</span> (is_array($this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key]) &amp;&amp;
<a name="l03519"></a>03519                             array_key_exists(GESHI_CLASS, $this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key])) {
<a name="l03520"></a>03520                             $attributes = <span class="stringliteral">&#39; class=&quot;&#39;</span> .
<a name="l03521"></a>03521                                 $this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key][GESHI_CLASS] . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03522"></a>03522                         } <span class="keywordflow">else</span> {
<a name="l03523"></a>03523                            $attributes = <span class="stringliteral">&#39; class=&quot;re&#39;</span> . $key . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03524"></a>03524                         }
<a name="l03525"></a>03525                     }
<a name="l03526"></a>03526                     $stuff_to_parse = str_replace(<span class="stringliteral">&quot;!REG3XP$key!&quot;</span>, <span class="stringliteral">&quot;$attributes&quot;</span>, $stuff_to_parse);
<a name="l03527"></a>03527                 }
<a name="l03528"></a>03528             }
<a name="l03529"></a>03529         }
<a name="l03530"></a>03530 
<a name="l03531"></a>03531         <span class="comment">// Replace &lt;DOT&gt; with . for urls</span>
<a name="l03532"></a>03532         $stuff_to_parse = str_replace(<span class="stringliteral">&#39;&lt;DOT&gt;&#39;</span>, <span class="charliteral">&#39;.&#39;</span>, $stuff_to_parse);
<a name="l03533"></a>03533         <span class="comment">// Replace &lt;|UR1| with &lt;a href= for urls also</span>
<a name="l03534"></a>03534         <span class="keywordflow">if</span> (isset($this-&gt;link_styles[GESHI_LINK])) {
<a name="l03535"></a>03535             <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03536"></a>03536                 $stuff_to_parse = str_replace(<span class="stringliteral">&#39;&lt;|UR1|&#39;</span>, <span class="stringliteral">&#39;&lt;a&#39;</span> . $this-&gt;link_target . <span class="stringliteral">&#39; href=&#39;</span>, $stuff_to_parse);
<a name="l03537"></a>03537             } <span class="keywordflow">else</span> {
<a name="l03538"></a>03538                 $stuff_to_parse = str_replace(<span class="stringliteral">&#39;&lt;|UR1|&#39;</span>, <span class="stringliteral">&#39;&lt;a&#39;</span> . $this-&gt;link_target . <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;link_styles[GESHI_LINK] . <span class="stringliteral">&#39;&quot; href=&#39;</span>, $stuff_to_parse);
<a name="l03539"></a>03539             }
<a name="l03540"></a>03540         } <span class="keywordflow">else</span> {
<a name="l03541"></a>03541             $stuff_to_parse = str_replace(<span class="stringliteral">&#39;&lt;|UR1|&#39;</span>, <span class="stringliteral">&#39;&lt;a&#39;</span> . $this-&gt;link_target . <span class="stringliteral">&#39; href=&#39;</span>, $stuff_to_parse);
<a name="l03542"></a>03542         }
<a name="l03543"></a>03543 
<a name="l03544"></a>03544         <span class="comment">//</span>
<a name="l03545"></a>03545         <span class="comment">// NOW we add the span thingy ;)</span>
<a name="l03546"></a>03546         <span class="comment">//</span>
<a name="l03547"></a>03547 
<a name="l03548"></a>03548         $stuff_to_parse = str_replace(<span class="stringliteral">&#39;&lt;|&#39;</span>, <span class="stringliteral">&#39;&lt;span&#39;</span>, $stuff_to_parse);
<a name="l03549"></a>03549         $stuff_to_parse = str_replace ( <span class="stringliteral">&#39;|&gt;&#39;</span>, <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>, $stuff_to_parse );
<a name="l03550"></a>03550         <span class="keywordflow">return</span> substr($stuff_to_parse, 1);
<a name="l03551"></a>03551     }
<a name="l03552"></a>03552 
<a name="l03561"></a><a class="code" href="classGeSHi.html#a3c86ad4bf29c84453fd48f01aff36b9b">03561</a>     function <a class="code" href="classGeSHi.html#a3c86ad4bf29c84453fd48f01aff36b9b" title="Sets the time taken to parse the code.">set_time</a>($start_time, $end_time) {
<a name="l03562"></a>03562         $start = explode(<span class="charliteral">&#39; &#39;</span>, $start_time);
<a name="l03563"></a>03563         $end = explode(<span class="charliteral">&#39; &#39;</span>, $end_time);
<a name="l03564"></a>03564         $this-&gt;time = $end[0] + $end[1] - $start[0] - $start[1];
<a name="l03565"></a>03565     }
<a name="l03566"></a>03566 
<a name="l03573"></a><a class="code" href="classGeSHi.html#a2635a4ec073a69f08842c7c6ff2b4b28">03573</a>     function <a class="code" href="classGeSHi.html#a2635a4ec073a69f08842c7c6ff2b4b28" title="Gets the time taken to parse the code.">get_time</a>() {
<a name="l03574"></a>03574         <span class="keywordflow">return</span> $this-&gt;time;
<a name="l03575"></a>03575     }
<a name="l03576"></a>03576 
<a name="l03583"></a><a class="code" href="classGeSHi.html#a27f98d5131da8bddb6c0237e304f59b3">03583</a>     function <a class="code" href="classGeSHi.html#a27f98d5131da8bddb6c0237e304f59b3" title="Merges arrays recursively, overwriting values of the first array with values of later...">merge_arrays</a>() {
<a name="l03584"></a>03584         $arrays = func_get_args();
<a name="l03585"></a>03585         $narrays = count($arrays);
<a name="l03586"></a>03586 
<a name="l03587"></a>03587         <span class="comment">// check arguments</span>
<a name="l03588"></a>03588         <span class="comment">// comment out if more performance is necessary (in this case the foreach loop will trigger a warning if the argument is not an array)</span>
<a name="l03589"></a>03589         <span class="keywordflow">for</span> ($i = 0; $i &lt; $narrays; $i ++) {
<a name="l03590"></a>03590             <span class="keywordflow">if</span> (!is_array($arrays[$i])) {
<a name="l03591"></a>03591                 <span class="comment">// also array_merge_recursive returns nothing in this case</span>
<a name="l03592"></a>03592                 trigger_error(<span class="stringliteral">&#39;Argument #&#39;</span> . ($i+1) . <span class="stringliteral">&#39; is not an array - trying to merge array with scalar! Returning false!&#39;</span>, E_USER_WARNING);
<a name="l03593"></a>03593                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03594"></a>03594             }
<a name="l03595"></a>03595         }
<a name="l03596"></a>03596 
<a name="l03597"></a>03597         <span class="comment">// the first array is in the output set in every case</span>
<a name="l03598"></a>03598         $ret = $arrays[0];
<a name="l03599"></a>03599 
<a name="l03600"></a>03600         <span class="comment">// merege $ret with the remaining arrays</span>
<a name="l03601"></a>03601         <span class="keywordflow">for</span> ($i = 1; $i &lt; $narrays; $i ++) {
<a name="l03602"></a>03602             <span class="keywordflow">foreach</span> ($arrays[$i] as $key =&gt; $value) {
<a name="l03603"></a>03603                 <span class="keywordflow">if</span> (is_array($value) &amp;&amp; isset($ret[$key])) {
<a name="l03604"></a>03604                     <span class="comment">// if $ret[$key] is not an array you try to merge an scalar value with an array - the result is not defined (incompatible arrays)</span>
<a name="l03605"></a>03605                     <span class="comment">// in this case the call will trigger an E_USER_WARNING and the $ret[$key] will be false.</span>
<a name="l03606"></a>03606                     $ret[$key] = $this-&gt;<a class="code" href="classGeSHi.html#a27f98d5131da8bddb6c0237e304f59b3" title="Merges arrays recursively, overwriting values of the first array with values of later...">merge_arrays</a>($ret[$key], $value);
<a name="l03607"></a>03607                 } <span class="keywordflow">else</span> {
<a name="l03608"></a>03608                     $ret[$key] = $value;
<a name="l03609"></a>03609                 }
<a name="l03610"></a>03610             }
<a name="l03611"></a>03611         }
<a name="l03612"></a>03612 
<a name="l03613"></a>03613         <span class="keywordflow">return</span> $ret;
<a name="l03614"></a>03614     }
<a name="l03615"></a>03615 
<a name="l03624"></a><a class="code" href="classGeSHi.html#a7597671dc76f5140b3762e79d8bfd7ec">03624</a>     function <a class="code" href="classGeSHi.html#a7597671dc76f5140b3762e79d8bfd7ec" title="Gets language information and stores it for later use.">load_language</a>($file_name) {
<a name="l03625"></a>03625         <span class="keywordflow">if</span> ($file_name == $this-&gt;loaded_language) {
<a name="l03626"></a>03626             <span class="comment">// this file is already loaded!</span>
<a name="l03627"></a>03627             <span class="keywordflow">return</span>;
<a name="l03628"></a>03628         }
<a name="l03629"></a>03629 
<a name="l03630"></a>03630         <span class="comment">//Prepare some stuff before actually loading the language file</span>
<a name="l03631"></a>03631         $this-&gt;loaded_language = $file_name;
<a name="l03632"></a>03632         $this-&gt;parse_cache_built = <span class="keyword">false</span>;
<a name="l03633"></a>03633         $this-&gt;<a class="code" href="classGeSHi.html#a15e3ef2c685ab4a68992641ef30a4761" title="Enables all highlighting.">enable_highlighting</a>();
<a name="l03634"></a>03634         $language_data = array();
<a name="l03635"></a>03635 
<a name="l03636"></a>03636         <span class="comment">//Load the language file</span>
<a name="l03637"></a>03637         require $file_name;
<a name="l03638"></a>03638 
<a name="l03639"></a>03639         <span class="comment">// Perhaps some checking might be added here later to check that</span>
<a name="l03640"></a>03640         <span class="comment">// $language data is a valid thing but maybe not</span>
<a name="l03641"></a>03641         $this-&gt;language_data = $language_data;
<a name="l03642"></a>03642 
<a name="l03643"></a>03643         <span class="comment">// Set strict mode if should be set</span>
<a name="l03644"></a>03644         $this-&gt;strict_mode = $this-&gt;language_data[<span class="stringliteral">&#39;STRICT_MODE_APPLIES&#39;</span>];
<a name="l03645"></a>03645 
<a name="l03646"></a>03646         <span class="comment">// Set permissions for all lexics to true</span>
<a name="l03647"></a>03647         <span class="comment">// so they&#39;ll be highlighted by default</span>
<a name="l03648"></a>03648         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>]) as $key) {
<a name="l03649"></a>03649             <span class="keywordflow">if</span> (!empty($this-&gt;language_data[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key])) {
<a name="l03650"></a>03650                 $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = <span class="keyword">true</span>;
<a name="l03651"></a>03651             } <span class="keywordflow">else</span> {
<a name="l03652"></a>03652                 $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$key] = <span class="keyword">false</span>;
<a name="l03653"></a>03653             }
<a name="l03654"></a>03654         }
<a name="l03655"></a>03655 
<a name="l03656"></a>03656         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_SINGLE&#39;</span>]) as $key) {
<a name="l03657"></a>03657             $this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][$key] = <span class="keyword">true</span>;
<a name="l03658"></a>03658         }
<a name="l03659"></a>03659         <span class="keywordflow">foreach</span> (array_keys($this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>]) as $key) {
<a name="l03660"></a>03660             $this-&gt;lexic_permissions[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$key] = <span class="keyword">true</span>;
<a name="l03661"></a>03661         }
<a name="l03662"></a>03662 
<a name="l03663"></a>03663         <span class="comment">// for BenBE and future code reviews:</span>
<a name="l03664"></a>03664         <span class="comment">// we can use empty here since we only check for existance and emptiness of an array</span>
<a name="l03665"></a>03665         <span class="comment">// if it is not an array at all but rather false or null this will work as intended as well</span>
<a name="l03666"></a>03666         <span class="comment">// even if $this-&gt;language_data[&#39;PARSER_CONTROL&#39;] is undefined this won&#39;t trigger a notice</span>
<a name="l03667"></a>03667         <span class="keywordflow">if</span> (!empty($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;ENABLE_FLAGS&#39;</span>])) {
<a name="l03668"></a>03668             <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;ENABLE_FLAGS&#39;</span>] as $flag =&gt; $value) {
<a name="l03669"></a>03669                 <span class="comment">// it&#39;s either true or false and maybe is true as well</span>
<a name="l03670"></a>03670                 $perm = $value !== GESHI_NEVER;
<a name="l03671"></a>03671                 <span class="keywordflow">if</span> ($flag == <span class="stringliteral">&#39;ALL&#39;</span>) {
<a name="l03672"></a>03672                     $this-&gt;<a class="code" href="classGeSHi.html#a15e3ef2c685ab4a68992641ef30a4761" title="Enables all highlighting.">enable_highlighting</a>($perm);
<a name="l03673"></a>03673                     <span class="keywordflow">continue</span>;
<a name="l03674"></a>03674                 }
<a name="l03675"></a>03675                 <span class="keywordflow">if</span> (!isset($this-&gt;lexic_permissions[$flag])) {
<a name="l03676"></a>03676                     <span class="comment">// unknown lexic permission</span>
<a name="l03677"></a>03677                     <span class="keywordflow">continue</span>;
<a name="l03678"></a>03678                 }
<a name="l03679"></a>03679                 <span class="keywordflow">if</span> (is_array($this-&gt;lexic_permissions[$flag])) {
<a name="l03680"></a>03680                     <span class="keywordflow">foreach</span> ($this-&gt;lexic_permissions[$flag] as $key =&gt; $val) {
<a name="l03681"></a>03681                         $this-&gt;lexic_permissions[$flag][$key] = $perm;
<a name="l03682"></a>03682                     }
<a name="l03683"></a>03683                 } <span class="keywordflow">else</span> {
<a name="l03684"></a>03684                     $this-&gt;lexic_permissions[$flag] = $perm;
<a name="l03685"></a>03685                 }
<a name="l03686"></a>03686             }
<a name="l03687"></a>03687             unset($this-&gt;language_data[<span class="stringliteral">&#39;PARSER_CONTROL&#39;</span>][<span class="stringliteral">&#39;ENABLE_FLAGS&#39;</span>]);
<a name="l03688"></a>03688         }
<a name="l03689"></a>03689 
<a name="l03690"></a>03690         <span class="comment">//Fix: Problem where hardescapes weren&#39;t handled if no ESCAPE_CHAR was given</span>
<a name="l03691"></a>03691         <span class="comment">//You need to set one for HARDESCAPES only in this case.</span>
<a name="l03692"></a>03692         <span class="keywordflow">if</span>(!isset($this-&gt;language_data[<span class="stringliteral">&#39;HARDCHAR&#39;</span>])) {
<a name="l03693"></a>03693             $this-&gt;language_data[<span class="stringliteral">&#39;HARDCHAR&#39;</span>] = $this-&gt;language_data[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>];
<a name="l03694"></a>03694         }
<a name="l03695"></a>03695 
<a name="l03696"></a>03696         <span class="comment">//NEW in 1.0.8: Allow styles to be loaded from a separate file to override defaults</span>
<a name="l03697"></a>03697         $style_filename = substr($file_name, 0, -4) . <span class="stringliteral">&#39;.style.php&#39;</span>;
<a name="l03698"></a>03698         <span class="keywordflow">if</span> (is_readable($style_filename)) {
<a name="l03699"></a>03699             <span class="comment">//Clear any style_data that could have been set before ...</span>
<a name="l03700"></a>03700             <span class="keywordflow">if</span> (isset($style_data)) {
<a name="l03701"></a>03701                 unset($style_data);
<a name="l03702"></a>03702             }
<a name="l03703"></a>03703 
<a name="l03704"></a>03704             <span class="comment">//Read the Style Information from the style file</span>
<a name="l03705"></a>03705             include $style_filename;
<a name="l03706"></a>03706 
<a name="l03707"></a>03707             <span class="comment">//Apply the new styles to our current language styles</span>
<a name="l03708"></a>03708             <span class="keywordflow">if</span> (isset($style_data) &amp;&amp; is_array($style_data)) {
<a name="l03709"></a>03709                 $this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>] =
<a name="l03710"></a>03710                     $this-&gt;<a class="code" href="classGeSHi.html#a27f98d5131da8bddb6c0237e304f59b3" title="Merges arrays recursively, overwriting values of the first array with values of later...">merge_arrays</a>($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>], $style_data);
<a name="l03711"></a>03711             }
<a name="l03712"></a>03712         }
<a name="l03713"></a>03713     }
<a name="l03714"></a>03714 
<a name="l03723"></a><a class="code" href="classGeSHi.html#aa7421c424ab2263d49ddafd8bf34fae7">03723</a>     function <a class="code" href="classGeSHi.html#aa7421c424ab2263d49ddafd8bf34fae7" title="Takes the parsed code and various options, and creates the HTML surrounding it to...">finalise</a>(&amp;$parsed_code) {
<a name="l03724"></a>03724         <span class="comment">// Remove end parts of important declarations</span>
<a name="l03725"></a>03725         <span class="comment">// This is BUGGY!! My fault for bad code: fix coming in 1.2</span>
<a name="l03726"></a>03726         <span class="comment">// @todo Remove this crap</span>
<a name="l03727"></a>03727         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGeSHi.html#a48a36664603935601b203b64fc9cae70" title="Sets whether context-important blocks are highlighted.">enable_important_blocks</a> &amp;&amp;
<a name="l03728"></a>03728             (strpos($parsed_code, $this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(GESHI_START_IMPORTANT)) === <span class="keyword">false</span>)) {
<a name="l03729"></a>03729             $parsed_code = str_replace($this-&gt;<a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>(GESHI_END_IMPORTANT), <span class="stringliteral">&#39;&#39;</span>, $parsed_code);
<a name="l03730"></a>03730         }
<a name="l03731"></a>03731 
<a name="l03732"></a>03732         <span class="comment">// Add HTML whitespace stuff if we&#39;re using the &lt;div&gt; header</span>
<a name="l03733"></a>03733         <span class="keywordflow">if</span> ($this-&gt;header_type != GESHI_HEADER_PRE &amp;&amp; $this-&gt;header_type != GESHI_HEADER_PRE_VALID) {
<a name="l03734"></a>03734             $this-&gt;<a class="code" href="classGeSHi.html#a5cdad1e4917521b8c107ddbf29065de0" title="Swaps out spaces and tabs for HTML indentation.">indent</a>($parsed_code);
<a name="l03735"></a>03735         }
<a name="l03736"></a>03736 
<a name="l03737"></a>03737         <span class="comment">// purge some unnecessary stuff</span>
<a name="l03739"></a>03739 <span class="comment"></span>        $parsed_code = preg_replace(<span class="stringliteral">&#39;#&lt;span[^&gt;]+&gt;(\s*)&lt;/span&gt;#&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>, $parsed_code);
<a name="l03740"></a>03740 
<a name="l03741"></a>03741         <span class="comment">// If we are using IDs for line numbers, there needs to be an overall</span>
<a name="l03742"></a>03742         <span class="comment">// ID set to prevent collisions.</span>
<a name="l03743"></a>03743         <span class="keywordflow">if</span> ($this-&gt;add_ids &amp;&amp; !$this-&gt;overall_id) {
<a name="l03744"></a>03744             $this-&gt;overall_id = <span class="stringliteral">&#39;geshi-&#39;</span> . substr(md5(microtime()), 0, 4);
<a name="l03745"></a>03745         }
<a name="l03746"></a>03746 
<a name="l03747"></a>03747         <span class="comment">// Get code into lines</span>
<a name="l03749"></a>03749 <span class="comment"></span>        $code = explode(<span class="stringliteral">&quot;\n&quot;</span>, $parsed_code);
<a name="l03750"></a>03750         $parsed_code = $this-&gt;<a class="code" href="classGeSHi.html#a1bc16b5dd7819813f8b8ba1ba0408ccb" title="Creates the header for the code block (with correct attributes).">header</a>();
<a name="l03751"></a>03751 
<a name="l03752"></a>03752         <span class="comment">// If we&#39;re using line numbers, we insert &lt;li&gt;s and appropriate</span>
<a name="l03753"></a>03753         <span class="comment">// markup to style them (otherwise we don&#39;t need to do anything)</span>
<a name="l03754"></a>03754         <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS &amp;&amp; $this-&gt;header_type != GESHI_HEADER_PRE_TABLE) {
<a name="l03755"></a>03755             <span class="comment">// If we&#39;re using the &lt;pre&gt; header, we shouldn&#39;t add newlines because</span>
<a name="l03756"></a>03756             <span class="comment">// the &lt;pre&gt; will line-break them (and the &lt;li&gt;s already do this for us)</span>
<a name="l03757"></a>03757             $ls = ($this-&gt;header_type != GESHI_HEADER_PRE &amp;&amp; $this-&gt;header_type != GESHI_HEADER_PRE_VALID) ? <span class="stringliteral">&quot;\n&quot;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l03758"></a>03758 
<a name="l03759"></a>03759             <span class="comment">// Set vars to defaults for following loop</span>
<a name="l03760"></a>03760             $i = 0;
<a name="l03761"></a>03761 
<a name="l03762"></a>03762             <span class="comment">// Foreach line...</span>
<a name="l03763"></a>03763             <span class="keywordflow">for</span> ($i = 0, $n = count($code); $i &lt; $n;) {
<a name="l03764"></a>03764                 <span class="comment">//Reset the attributes for a new line ...</span>
<a name="l03765"></a>03765                 $attrs = array();
<a name="l03766"></a>03766 
<a name="l03767"></a>03767                 <span class="comment">// Make lines have at least one space in them if they&#39;re empty</span>
<a name="l03768"></a>03768                 <span class="comment">// BenBE: Checking emptiness using trim instead of relying on blanks</span>
<a name="l03769"></a>03769                 <span class="keywordflow">if</span> (<span class="stringliteral">&#39;&#39;</span> == trim($code[$i])) {
<a name="l03770"></a>03770                     $code[$i] = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;
<a name="l03771"></a>03771                 }
<a name="l03772"></a>03772 
<a name="l03773"></a>03773                 <span class="comment">// If this is a &quot;special line&quot;...</span>
<a name="l03774"></a>03774                 <span class="keywordflow">if</span> ($this-&gt;line_numbers == GESHI_FANCY_LINE_NUMBERS &amp;&amp;
<a name="l03775"></a>03775                     $i % $this-&gt;line_nth_row == ($this-&gt;line_nth_row - 1)) {
<a name="l03776"></a>03776                     <span class="comment">// Set the attributes to style the line</span>
<a name="l03777"></a>03777                     <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03778"></a>03778                         <span class="comment">//$attr = &#39; class=&quot;li2&quot;&#39;;</span>
<a name="l03779"></a>03779                         $attrs[<span class="stringliteral">&#39;class&#39;</span>][] = <span class="stringliteral">&#39;li2&#39;</span>;
<a name="l03780"></a>03780                         $def_attr = <span class="stringliteral">&#39; class=&quot;de2&quot;&#39;</span>;
<a name="l03781"></a>03781                     } <span class="keywordflow">else</span> {
<a name="l03782"></a>03782                         <span class="comment">//$attr = &#39; style=&quot;&#39; . $this-&gt;line_style2 . &#39;&quot;&#39;;</span>
<a name="l03783"></a>03783                         $attrs[<span class="stringliteral">&#39;style&#39;</span>][] = $this-&gt;line_style2;
<a name="l03784"></a>03784                         <span class="comment">// This style &quot;covers up&quot; the special styles set for special lines</span>
<a name="l03785"></a>03785                         <span class="comment">// so that styles applied to special lines don&#39;t apply to the actual</span>
<a name="l03786"></a>03786                         <span class="comment">// code on that line</span>
<a name="l03787"></a>03787                         $def_attr = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;code_style . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03788"></a>03788                     }
<a name="l03789"></a>03789                 } <span class="keywordflow">else</span> {
<a name="l03790"></a>03790                     <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03791"></a>03791                         <span class="comment">//$attr = &#39; class=&quot;li1&quot;&#39;;</span>
<a name="l03792"></a>03792                         $attrs[<span class="stringliteral">&#39;class&#39;</span>][] = <span class="stringliteral">&#39;li1&#39;</span>;
<a name="l03793"></a>03793                         $def_attr = <span class="stringliteral">&#39; class=&quot;de1&quot;&#39;</span>;
<a name="l03794"></a>03794                     } <span class="keywordflow">else</span> {
<a name="l03795"></a>03795                         <span class="comment">//$attr = &#39; style=&quot;&#39; . $this-&gt;line_style1 . &#39;&quot;&#39;;</span>
<a name="l03796"></a>03796                         $attrs[<span class="stringliteral">&#39;style&#39;</span>][] = $this-&gt;line_style1;
<a name="l03797"></a>03797                         $def_attr = <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;code_style . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03798"></a>03798                     }
<a name="l03799"></a>03799                 }
<a name="l03800"></a>03800 
<a name="l03801"></a>03801                 <span class="comment">//Check which type of tag to insert for this line</span>
<a name="l03802"></a>03802                 <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_VALID) {
<a name="l03803"></a>03803                     $start = <span class="stringliteral">&quot;&lt;pre$def_attr&gt;&quot;</span>;
<a name="l03804"></a>03804                     $end = <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l03805"></a>03805                 } <span class="keywordflow">else</span> {
<a name="l03806"></a>03806                     <span class="comment">// Span or div?</span>
<a name="l03807"></a>03807                     $start = <span class="stringliteral">&quot;&lt;div$def_attr&gt;&quot;</span>;
<a name="l03808"></a>03808                     $end = <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l03809"></a>03809                 }
<a name="l03810"></a>03810 
<a name="l03811"></a>03811                 ++$i;
<a name="l03812"></a>03812 
<a name="l03813"></a>03813                 <span class="comment">// Are we supposed to use ids? If so, add them</span>
<a name="l03814"></a>03814                 <span class="keywordflow">if</span> ($this-&gt;add_ids) {
<a name="l03815"></a>03815                     $attrs[<span class="stringliteral">&#39;id&#39;</span>][] = <span class="stringliteral">&quot;$this-&gt;overall_id-$i&quot;</span>;
<a name="l03816"></a>03816                 }
<a name="l03817"></a>03817 
<a name="l03818"></a>03818                 <span class="comment">//Is this some line with extra styles???</span>
<a name="l03819"></a>03819                 <span class="keywordflow">if</span> (in_array($i, $this-&gt;highlight_extra_lines)) {
<a name="l03820"></a>03820                     <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03821"></a>03821                         <span class="keywordflow">if</span> (isset($this-&gt;highlight_extra_lines_styles[$i])) {
<a name="l03822"></a>03822                             $attrs[<span class="stringliteral">&#39;class&#39;</span>][] = <span class="stringliteral">&quot;lx$i&quot;</span>;
<a name="l03823"></a>03823                         } <span class="keywordflow">else</span> {
<a name="l03824"></a>03824                             $attrs[<span class="stringliteral">&#39;class&#39;</span>][] = <span class="stringliteral">&quot;ln-xtra&quot;</span>;
<a name="l03825"></a>03825                         }
<a name="l03826"></a>03826                     } <span class="keywordflow">else</span> {
<a name="l03827"></a>03827                         array_push($attrs[<span class="stringliteral">&#39;style&#39;</span>], $this-&gt;<a class="code" href="classGeSHi.html#a024c45859b2135f1a022a566efea4284" title="Get&amp;#39;s the style that is used for the specified line.">get_line_style</a>($i));
<a name="l03828"></a>03828                     }
<a name="l03829"></a>03829                 }
<a name="l03830"></a>03830 
<a name="l03831"></a>03831                 <span class="comment">// Add in the line surrounded by appropriate list HTML</span>
<a name="l03832"></a>03832                 $attr_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03833"></a>03833                 <span class="keywordflow">foreach</span> ($attrs as $key =&gt; $attr) {
<a name="l03834"></a>03834                     $attr_string .= <span class="charliteral">&#39; &#39;</span> . $key . <span class="stringliteral">&#39;=&quot;&#39;</span> . implode(<span class="charliteral">&#39; &#39;</span>, $attr) . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03835"></a>03835                 }
<a name="l03836"></a>03836 
<a name="l03837"></a>03837                 $parsed_code .= <span class="stringliteral">&quot;&lt;li$attr_string&gt;$start{$code[$i-1]}$end&lt;/li&gt;$ls&quot;</span>;
<a name="l03838"></a>03838                 unset($code[$i - 1]);
<a name="l03839"></a>03839             }
<a name="l03840"></a>03840         } <span class="keywordflow">else</span> {
<a name="l03841"></a>03841             $n = count($code);
<a name="l03842"></a>03842             <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03843"></a>03843                 $attributes = <span class="stringliteral">&#39; class=&quot;de1&quot;&#39;</span>;
<a name="l03844"></a>03844             } <span class="keywordflow">else</span> {
<a name="l03845"></a>03845                 $attributes = <span class="stringliteral">&#39; style=&quot;&#39;</span>. $this-&gt;code_style .<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03846"></a>03846             }
<a name="l03847"></a>03847             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_VALID) {
<a name="l03848"></a>03848                 $parsed_code .= <span class="stringliteral">&#39;&lt;pre&#39;</span>. $attributes .<span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l03849"></a>03849             } elseif ($this-&gt;header_type == GESHI_HEADER_PRE_TABLE) {
<a name="l03850"></a>03850                 <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l03851"></a>03851                     <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03852"></a>03852                         $attrs = <span class="stringliteral">&#39; class=&quot;ln&quot;&#39;</span>;
<a name="l03853"></a>03853                     } <span class="keywordflow">else</span> {
<a name="l03854"></a>03854                         $attrs = <span class="stringliteral">&#39; style=&quot;&#39;</span>. $this-&gt;table_linenumber_style .<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03855"></a>03855                     }
<a name="l03856"></a>03856                     $parsed_code .= <span class="stringliteral">&#39;&lt;td&#39;</span>.$attrs.<span class="stringliteral">&#39;&gt;&lt;pre&#39;</span>.$attributes.<span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l03857"></a>03857                     <span class="comment">// get linenumbers</span>
<a name="l03858"></a>03858                     <span class="comment">// we don&#39;t merge it with the for below, since it should be better for</span>
<a name="l03859"></a>03859                     <span class="comment">// memory consumption this way</span>
<a name="l03860"></a>03860                     <span class="comment">// @todo: but... actually it would still be somewhat nice to merge the two loops</span>
<a name="l03861"></a>03861                     <span class="comment">//        the mem peaks are at different positions</span>
<a name="l03862"></a>03862                     <span class="keywordflow">for</span> ($i = 0; $i &lt; $n; ++$i) {
<a name="l03863"></a>03863                         $close = 0;
<a name="l03864"></a>03864                         <span class="comment">// fancy lines</span>
<a name="l03865"></a>03865                         <span class="keywordflow">if</span> ($this-&gt;line_numbers == GESHI_FANCY_LINE_NUMBERS &amp;&amp;
<a name="l03866"></a>03866                             $i % $this-&gt;line_nth_row == ($this-&gt;line_nth_row - 1)) {
<a name="l03867"></a>03867                             <span class="comment">// Set the attributes to style the line</span>
<a name="l03868"></a>03868                             <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03869"></a>03869                                 $parsed_code .= <span class="stringliteral">&#39;&lt;span class=&quot;xtra li2&quot;&gt;&lt;span class=&quot;de2&quot;&gt;&#39;</span>;
<a name="l03870"></a>03870                             } <span class="keywordflow">else</span> {
<a name="l03871"></a>03871                                 <span class="comment">// This style &quot;covers up&quot; the special styles set for special lines</span>
<a name="l03872"></a>03872                                 <span class="comment">// so that styles applied to special lines don&#39;t apply to the actual</span>
<a name="l03873"></a>03873                                 <span class="comment">// code on that line</span>
<a name="l03874"></a>03874                                 $parsed_code .= <span class="stringliteral">&#39;&lt;span style=&quot;display:block;&#39;</span> . $this-&gt;line_style2 . <span class="stringliteral">&#39;&quot;&gt;&#39;</span>
<a name="l03875"></a>03875                                                   .<span class="stringliteral">&#39;&lt;span style=&quot;&#39;</span> . $this-&gt;code_style .<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l03876"></a>03876                             }
<a name="l03877"></a>03877                             $close += 2;
<a name="l03878"></a>03878                         }
<a name="l03879"></a>03879                         <span class="comment">//Is this some line with extra styles???</span>
<a name="l03880"></a>03880                         <span class="keywordflow">if</span> (in_array($i + 1, $this-&gt;highlight_extra_lines)) {
<a name="l03881"></a>03881                             <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03882"></a>03882                                 <span class="keywordflow">if</span> (isset($this-&gt;highlight_extra_lines_styles[$i])) {
<a name="l03883"></a>03883                                     $parsed_code .= <span class="stringliteral">&quot;&lt;span class=\&quot;xtra lx$i\&quot;&gt;&quot;</span>;
<a name="l03884"></a>03884                                 } <span class="keywordflow">else</span> {
<a name="l03885"></a>03885                                     $parsed_code .= <span class="stringliteral">&quot;&lt;span class=\&quot;xtra ln-xtra\&quot;&gt;&quot;</span>;
<a name="l03886"></a>03886                                 }
<a name="l03887"></a>03887                             } <span class="keywordflow">else</span> {
<a name="l03888"></a>03888                                 $parsed_code .= <span class="stringliteral">&quot;&lt;span style=\&quot;display:block;&quot;</span> . $this-&gt;<a class="code" href="classGeSHi.html#a024c45859b2135f1a022a566efea4284" title="Get&amp;#39;s the style that is used for the specified line.">get_line_style</a>($i) . <span class="stringliteral">&quot;\&quot;&gt;&quot;</span>;
<a name="l03889"></a>03889                             }
<a name="l03890"></a>03890                             ++$close;
<a name="l03891"></a>03891                         }
<a name="l03892"></a>03892                         $parsed_code .= $this-&gt;line_numbers_start + $i;
<a name="l03893"></a>03893                         <span class="keywordflow">if</span> ($close) {
<a name="l03894"></a>03894                             $parsed_code .= str_repeat(<span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>, $close);
<a name="l03895"></a>03895                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($i != $n) {
<a name="l03896"></a>03896                             $parsed_code .= <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l03897"></a>03897                         }
<a name="l03898"></a>03898                     }
<a name="l03899"></a>03899                     $parsed_code .= <span class="stringliteral">&#39;&lt;/pre&gt;&lt;/td&gt;&lt;td&#39;</span>.$attributes.<span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l03900"></a>03900                 }
<a name="l03901"></a>03901                 $parsed_code .= <span class="stringliteral">&#39;&lt;pre&#39;</span>. $attributes .<span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l03902"></a>03902             }
<a name="l03903"></a>03903             <span class="comment">// No line numbers, but still need to handle highlighting lines extra.</span>
<a name="l03904"></a>03904             <span class="comment">// Have to use divs so the full width of the code is highlighted</span>
<a name="l03905"></a>03905             $close = 0;
<a name="l03906"></a>03906             <span class="keywordflow">for</span> ($i = 0; $i &lt; $n; ++$i) {
<a name="l03907"></a>03907                 <span class="comment">// Make lines have at least one space in them if they&#39;re empty</span>
<a name="l03908"></a>03908                 <span class="comment">// BenBE: Checking emptiness using trim instead of relying on blanks</span>
<a name="l03909"></a>03909                 <span class="keywordflow">if</span> (<span class="stringliteral">&#39;&#39;</span> == trim($code[$i])) {
<a name="l03910"></a>03910                     $code[$i] = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;
<a name="l03911"></a>03911                 }
<a name="l03912"></a>03912                 <span class="comment">// fancy lines</span>
<a name="l03913"></a>03913                 <span class="keywordflow">if</span> ($this-&gt;line_numbers == GESHI_FANCY_LINE_NUMBERS &amp;&amp;
<a name="l03914"></a>03914                     $i % $this-&gt;line_nth_row == ($this-&gt;line_nth_row - 1)) {
<a name="l03915"></a>03915                     <span class="comment">// Set the attributes to style the line</span>
<a name="l03916"></a>03916                     <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03917"></a>03917                         $parsed_code .= <span class="stringliteral">&#39;&lt;span class=&quot;xtra li2&quot;&gt;&lt;span class=&quot;de2&quot;&gt;&#39;</span>;
<a name="l03918"></a>03918                     } <span class="keywordflow">else</span> {
<a name="l03919"></a>03919                         <span class="comment">// This style &quot;covers up&quot; the special styles set for special lines</span>
<a name="l03920"></a>03920                         <span class="comment">// so that styles applied to special lines don&#39;t apply to the actual</span>
<a name="l03921"></a>03921                         <span class="comment">// code on that line</span>
<a name="l03922"></a>03922                         $parsed_code .= <span class="stringliteral">&#39;&lt;span style=&quot;display:block;&#39;</span> . $this-&gt;line_style2 . <span class="stringliteral">&#39;&quot;&gt;&#39;</span>
<a name="l03923"></a>03923                                           .<span class="stringliteral">&#39;&lt;span style=&quot;&#39;</span> . $this-&gt;code_style .<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l03924"></a>03924                     }
<a name="l03925"></a>03925                     $close += 2;
<a name="l03926"></a>03926                 }
<a name="l03927"></a>03927                 <span class="comment">//Is this some line with extra styles???</span>
<a name="l03928"></a>03928                 <span class="keywordflow">if</span> (in_array($i + 1, $this-&gt;highlight_extra_lines)) {
<a name="l03929"></a>03929                     <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l03930"></a>03930                         <span class="keywordflow">if</span> (isset($this-&gt;highlight_extra_lines_styles[$i])) {
<a name="l03931"></a>03931                             $parsed_code .= <span class="stringliteral">&quot;&lt;span class=\&quot;xtra lx$i\&quot;&gt;&quot;</span>;
<a name="l03932"></a>03932                         } <span class="keywordflow">else</span> {
<a name="l03933"></a>03933                             $parsed_code .= <span class="stringliteral">&quot;&lt;span class=\&quot;xtra ln-xtra\&quot;&gt;&quot;</span>;
<a name="l03934"></a>03934                         }
<a name="l03935"></a>03935                     } <span class="keywordflow">else</span> {
<a name="l03936"></a>03936                         $parsed_code .= <span class="stringliteral">&quot;&lt;span style=\&quot;display:block;&quot;</span> . $this-&gt;<a class="code" href="classGeSHi.html#a024c45859b2135f1a022a566efea4284" title="Get&amp;#39;s the style that is used for the specified line.">get_line_style</a>($i) . <span class="stringliteral">&quot;\&quot;&gt;&quot;</span>;
<a name="l03937"></a>03937                     }
<a name="l03938"></a>03938                     ++$close;
<a name="l03939"></a>03939                 }
<a name="l03940"></a>03940 
<a name="l03941"></a>03941                 $parsed_code .= $code[$i];
<a name="l03942"></a>03942 
<a name="l03943"></a>03943                 <span class="keywordflow">if</span> ($close) {
<a name="l03944"></a>03944                   $parsed_code .= str_repeat(<span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>, $close);
<a name="l03945"></a>03945                   $close = 0;
<a name="l03946"></a>03946                 }
<a name="l03947"></a>03947                 elseif ($i + 1 &lt; $n) {
<a name="l03948"></a>03948                     $parsed_code .= <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l03949"></a>03949                 }
<a name="l03950"></a>03950                 unset($code[$i]);
<a name="l03951"></a>03951             }
<a name="l03952"></a>03952 
<a name="l03953"></a>03953             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_VALID || $this-&gt;header_type == GESHI_HEADER_PRE_TABLE) {
<a name="l03954"></a>03954                 $parsed_code .= <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l03955"></a>03955             }
<a name="l03956"></a>03956             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_TABLE &amp;&amp; $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l03957"></a>03957                 $parsed_code .= <span class="stringliteral">&#39;&lt;/td&gt;&#39;</span>;
<a name="l03958"></a>03958             }
<a name="l03959"></a>03959         }
<a name="l03960"></a>03960 
<a name="l03961"></a>03961         $parsed_code .= $this-&gt;<a class="code" href="classGeSHi.html#abf47d9d66bd29da310fb40c95e21b574" title="Returns the footer for the code block.">footer</a>();
<a name="l03962"></a>03962     }
<a name="l03963"></a>03963 
<a name="l03971"></a><a class="code" href="classGeSHi.html#a1bc16b5dd7819813f8b8ba1ba0408ccb">03971</a>     function <a class="code" href="classGeSHi.html#a1bc16b5dd7819813f8b8ba1ba0408ccb" title="Creates the header for the code block (with correct attributes).">header</a>() {
<a name="l03972"></a>03972         <span class="comment">// Get attributes needed</span>
<a name="l03977"></a>03977 <span class="comment"></span>        $attributes = <span class="stringliteral">&#39; class=&quot;&#39;</span> . $this-&gt;_genCSSName($this-&gt;language);
<a name="l03978"></a>03978         <span class="keywordflow">if</span> ($this-&gt;overall_class != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l03979"></a>03979             $attributes .= <span class="stringliteral">&quot; &quot;</span>.$this-&gt;_genCSSName($this-&gt;overall_class);
<a name="l03980"></a>03980         }
<a name="l03981"></a>03981         $attributes .= <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03982"></a>03982 
<a name="l03983"></a>03983         <span class="keywordflow">if</span> ($this-&gt;overall_id != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l03984"></a>03984             $attributes .= <span class="stringliteral">&quot; id=\&quot;{$this-&gt;overall_id}\&quot;&quot;</span>;
<a name="l03985"></a>03985         }
<a name="l03986"></a>03986         <span class="keywordflow">if</span> ($this-&gt;overall_style != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; !$this-&gt;use_classes) {
<a name="l03987"></a>03987             $attributes .= <span class="stringliteral">&#39; style=&quot;&#39;</span> . $this-&gt;overall_style . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03988"></a>03988         }
<a name="l03989"></a>03989 
<a name="l03990"></a>03990         $ol_attributes = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03991"></a>03991 
<a name="l03992"></a>03992         <span class="keywordflow">if</span> ($this-&gt;line_numbers_start != 1) {
<a name="l03993"></a>03993             $ol_attributes .= <span class="stringliteral">&#39; start=&quot;&#39;</span> . $this-&gt;line_numbers_start . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03994"></a>03994         }
<a name="l03995"></a>03995 
<a name="l03996"></a>03996         <span class="comment">// Get the header HTML</span>
<a name="l03997"></a>03997         $header = $this-&gt;header_content;
<a name="l03998"></a>03998         <span class="keywordflow">if</span> ($header) {
<a name="l03999"></a>03999             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE || $this-&gt;header_type == GESHI_HEADER_PRE_VALID) {
<a name="l04000"></a>04000                 $header = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&#39;&#39;</span>, $header);
<a name="l04001"></a>04001             }
<a name="l04002"></a>04002             $header = $this-&gt;<a class="code" href="classGeSHi.html#a750460b89d038d36194f39445c97548f" title="Replaces certain keywords in the header and footer with certain configuration values...">replace_keywords</a>($header);
<a name="l04003"></a>04003 
<a name="l04004"></a>04004             <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l04005"></a>04005                 $attr = <span class="stringliteral">&#39; class=&quot;head&quot;&#39;</span>;
<a name="l04006"></a>04006             } <span class="keywordflow">else</span> {
<a name="l04007"></a>04007                 $attr = <span class="stringliteral">&quot; style=\&quot;{$this-&gt;header_content_style}\&quot;&quot;</span>;
<a name="l04008"></a>04008             }
<a name="l04009"></a>04009             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_TABLE &amp;&amp; $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04010"></a>04010                 $header = <span class="stringliteral">&quot;&lt;thead&gt;&lt;tr&gt;&lt;td colspan=\&quot;2\&quot; $attr&gt;$header&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&quot;</span>;
<a name="l04011"></a>04011             } <span class="keywordflow">else</span> {
<a name="l04012"></a>04012                 $header = <span class="stringliteral">&quot;&lt;div$attr&gt;$header&lt;/div&gt;&quot;</span>;
<a name="l04013"></a>04013             }
<a name="l04014"></a>04014         }
<a name="l04015"></a>04015 
<a name="l04016"></a>04016         <span class="keywordflow">if</span> (GESHI_HEADER_NONE == $this-&gt;header_type) {
<a name="l04017"></a>04017             <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04018"></a>04018                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;$header&lt;ol$attributes$ol_attributes&gt;&quot;</span>;
<a name="l04019"></a>04019             }
<a name="l04020"></a>04020             <span class="keywordflow">return</span> $header . ($this-&gt;force_code_block ? <span class="stringliteral">&#39;&lt;div&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l04021"></a>04021         }
<a name="l04022"></a>04022 
<a name="l04023"></a>04023         <span class="comment">// Work out what to return and do it</span>
<a name="l04024"></a>04024         <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04025"></a>04025             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE) {
<a name="l04026"></a>04026                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;pre$attributes&gt;$header&lt;ol$ol_attributes&gt;&quot;</span>;
<a name="l04027"></a>04027             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_DIV ||
<a name="l04028"></a>04028                 $this-&gt;header_type == GESHI_HEADER_PRE_VALID) {
<a name="l04029"></a>04029                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;div$attributes&gt;$header&lt;ol$ol_attributes&gt;&quot;</span>;
<a name="l04030"></a>04030             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_TABLE) {
<a name="l04031"></a>04031                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;table$attributes&gt;$header&lt;tbody&gt;&lt;tr class=\&quot;li1\&quot;&gt;&quot;</span>;
<a name="l04032"></a>04032             }
<a name="l04033"></a>04033         } <span class="keywordflow">else</span> {
<a name="l04034"></a>04034             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE) {
<a name="l04035"></a>04035                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;pre$attributes&gt;$header&quot;</span>  .
<a name="l04036"></a>04036                     ($this-&gt;force_code_block ? <span class="stringliteral">&#39;&lt;div&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l04037"></a>04037             } <span class="keywordflow">else</span> {
<a name="l04038"></a>04038                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;div$attributes&gt;$header&quot;</span> .
<a name="l04039"></a>04039                     ($this-&gt;force_code_block ? <span class="stringliteral">&#39;&lt;div&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l04040"></a>04040             }
<a name="l04041"></a>04041         }
<a name="l04042"></a>04042     }
<a name="l04043"></a>04043 
<a name="l04051"></a><a class="code" href="classGeSHi.html#abf47d9d66bd29da310fb40c95e21b574">04051</a>     function <a class="code" href="classGeSHi.html#abf47d9d66bd29da310fb40c95e21b574" title="Returns the footer for the code block.">footer</a>() {
<a name="l04052"></a>04052         $footer = $this-&gt;footer_content;
<a name="l04053"></a>04053         <span class="keywordflow">if</span> ($footer) {
<a name="l04054"></a>04054             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE) {
<a name="l04055"></a>04055                 $footer = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&#39;&#39;</span>, $footer);;
<a name="l04056"></a>04056             }
<a name="l04057"></a>04057             $footer = $this-&gt;<a class="code" href="classGeSHi.html#a750460b89d038d36194f39445c97548f" title="Replaces certain keywords in the header and footer with certain configuration values...">replace_keywords</a>($footer);
<a name="l04058"></a>04058 
<a name="l04059"></a>04059             <span class="keywordflow">if</span> ($this-&gt;use_classes) {
<a name="l04060"></a>04060                 $attr = <span class="stringliteral">&#39; class=&quot;foot&quot;&#39;</span>;
<a name="l04061"></a>04061             } <span class="keywordflow">else</span> {
<a name="l04062"></a>04062                 $attr = <span class="stringliteral">&quot; style=\&quot;{$this-&gt;footer_content_style}\&quot;&quot;</span>;
<a name="l04063"></a>04063             }
<a name="l04064"></a>04064             <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_PRE_TABLE &amp;&amp; $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04065"></a>04065                 $footer = <span class="stringliteral">&quot;&lt;tfoot&gt;&lt;tr&gt;&lt;td colspan=\&quot;2\&quot;&gt;$footer&lt;/td&gt;&lt;/tr&gt;&lt;/tfoot&gt;&quot;</span>;
<a name="l04066"></a>04066             } <span class="keywordflow">else</span> {
<a name="l04067"></a>04067                 $footer = <span class="stringliteral">&quot;&lt;div$attr&gt;$footer&lt;/div&gt;&quot;</span>;
<a name="l04068"></a>04068             }
<a name="l04069"></a>04069         }
<a name="l04070"></a>04070 
<a name="l04071"></a>04071         <span class="keywordflow">if</span> (GESHI_HEADER_NONE == $this-&gt;header_type) {
<a name="l04072"></a>04072             <span class="keywordflow">return</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) ? <span class="stringliteral">&#39;&lt;/ol&gt;&#39;</span> . $footer : $footer;
<a name="l04073"></a>04073         }
<a name="l04074"></a>04074 
<a name="l04075"></a>04075         <span class="keywordflow">if</span> ($this-&gt;header_type == GESHI_HEADER_DIV || $this-&gt;header_type == GESHI_HEADER_PRE_VALID) {
<a name="l04076"></a>04076             <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04077"></a>04077                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;/ol&gt;$footer&lt;/div&gt;&quot;</span>;
<a name="l04078"></a>04078             }
<a name="l04079"></a>04079             <span class="keywordflow">return</span> ($this-&gt;force_code_block ? <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>) .
<a name="l04080"></a>04080                 <span class="stringliteral">&quot;$footer&lt;/div&gt;&quot;</span>;
<a name="l04081"></a>04081         }
<a name="l04082"></a>04082         elseif ($this-&gt;header_type == GESHI_HEADER_PRE_TABLE) {
<a name="l04083"></a>04083             <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04084"></a>04084                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;/tr&gt;&lt;/tbody&gt;$footer&lt;/table&gt;&quot;</span>;
<a name="l04085"></a>04085             }
<a name="l04086"></a>04086             <span class="keywordflow">return</span> ($this-&gt;force_code_block ? <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>) .
<a name="l04087"></a>04087                 <span class="stringliteral">&quot;$footer&lt;/div&gt;&quot;</span>;
<a name="l04088"></a>04088         }
<a name="l04089"></a>04089         <span class="keywordflow">else</span> {
<a name="l04090"></a>04090             <span class="keywordflow">if</span> ($this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04091"></a>04091                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;/ol&gt;$footer&lt;/pre&gt;&quot;</span>;
<a name="l04092"></a>04092             }
<a name="l04093"></a>04093             <span class="keywordflow">return</span> ($this-&gt;force_code_block ? <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>) .
<a name="l04094"></a>04094                 <span class="stringliteral">&quot;$footer&lt;/pre&gt;&quot;</span>;
<a name="l04095"></a>04095         }
<a name="l04096"></a>04096     }
<a name="l04097"></a>04097 
<a name="l04107"></a><a class="code" href="classGeSHi.html#a750460b89d038d36194f39445c97548f">04107</a>     function <a class="code" href="classGeSHi.html#a750460b89d038d36194f39445c97548f" title="Replaces certain keywords in the header and footer with certain configuration values...">replace_keywords</a>($instr) {
<a name="l04108"></a>04108         $keywords = $replacements = array();
<a name="l04109"></a>04109 
<a name="l04110"></a>04110         $keywords[] = <span class="stringliteral">&#39;&lt;TIME&gt;&#39;</span>;
<a name="l04111"></a>04111         $keywords[] = <span class="stringliteral">&#39;{TIME}&#39;</span>;
<a name="l04112"></a>04112         $replacements[] = $replacements[] = number_format($time = $this-&gt;<a class="code" href="classGeSHi.html#a2635a4ec073a69f08842c7c6ff2b4b28" title="Gets the time taken to parse the code.">get_time</a>(), 3);
<a name="l04113"></a>04113 
<a name="l04114"></a>04114         $keywords[] = <span class="stringliteral">&#39;&lt;LANGUAGE&gt;&#39;</span>;
<a name="l04115"></a>04115         $keywords[] = <span class="stringliteral">&#39;{LANGUAGE}&#39;</span>;
<a name="l04116"></a>04116         $replacements[] = $replacements[] = $this-&gt;language_data[<span class="stringliteral">&#39;LANG_NAME&#39;</span>];
<a name="l04117"></a>04117 
<a name="l04118"></a>04118         $keywords[] = <span class="stringliteral">&#39;&lt;VERSION&gt;&#39;</span>;
<a name="l04119"></a>04119         $keywords[] = <span class="stringliteral">&#39;{VERSION}&#39;</span>;
<a name="l04120"></a>04120         $replacements[] = $replacements[] = GESHI_VERSION;
<a name="l04121"></a>04121 
<a name="l04122"></a>04122         $keywords[] = <span class="stringliteral">&#39;&lt;SPEED&gt;&#39;</span>;
<a name="l04123"></a>04123         $keywords[] = <span class="stringliteral">&#39;{SPEED}&#39;</span>;
<a name="l04124"></a>04124         <span class="keywordflow">if</span> ($time &lt;= 0) {
<a name="l04125"></a>04125             $speed = <span class="stringliteral">&#39;N/A&#39;</span>;
<a name="l04126"></a>04126         } <span class="keywordflow">else</span> {
<a name="l04127"></a>04127             $speed = strlen($this-&gt;source) / $time;
<a name="l04128"></a>04128             <span class="keywordflow">if</span> ($speed &gt;= 1024) {
<a name="l04129"></a>04129                 $speed = sprintf(<span class="stringliteral">&quot;%.2f KB/s&quot;</span>, $speed / 1024.0);
<a name="l04130"></a>04130             } <span class="keywordflow">else</span> {
<a name="l04131"></a>04131                 $speed = sprintf(<span class="stringliteral">&quot;%.0f B/s&quot;</span>, $speed);
<a name="l04132"></a>04132             }
<a name="l04133"></a>04133         }
<a name="l04134"></a>04134         $replacements[] = $replacements[] = $speed;
<a name="l04135"></a>04135 
<a name="l04136"></a>04136         <span class="keywordflow">return</span> str_replace($keywords, $replacements, $instr);
<a name="l04137"></a>04137     }
<a name="l04138"></a>04138 
<a name="l04192"></a><a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a">04192</a>     function <a class="code" href="classGeSHi.html#ac50fc0bb32bcd62ff6b65ddbb5b01c9a" title="Secure replacement for PHP built-in function htmlspecialchars().">hsc</a>($string, $quote_style = ENT_COMPAT) {
<a name="l04193"></a>04193         <span class="comment">// init</span>
<a name="l04194"></a>04194         <span class="keyword">static</span> $aTransSpecchar = array(
<a name="l04195"></a>04195             <span class="charliteral">&#39;&amp;&#39;</span> =&gt; <span class="stringliteral">&#39;&amp;amp;&#39;</span>,
<a name="l04196"></a>04196             <span class="charliteral">&#39;&quot;&#39;</span> =&gt; <span class="stringliteral">&#39;&amp;quot;&#39;</span>,
<a name="l04197"></a>04197             <span class="charliteral">&#39;&lt;&#39;</span> =&gt; <span class="stringliteral">&#39;&amp;lt;&#39;</span>,
<a name="l04198"></a>04198             <span class="charliteral">&#39;&gt;&#39;</span> =&gt; <span class="stringliteral">&#39;&amp;gt;&#39;</span>,
<a name="l04199"></a>04199 
<a name="l04200"></a>04200             <span class="comment">//This fix is related to SF#1923020, but has to be applied</span>
<a name="l04201"></a>04201             <span class="comment">//regardless of actually highlighting symbols.</span>
<a name="l04202"></a>04202 
<a name="l04203"></a>04203             <span class="comment">//Circumvent a bug with symbol highlighting</span>
<a name="l04204"></a>04204             <span class="comment">//This is required as ; would produce undesirable side-effects if it</span>
<a name="l04205"></a>04205             <span class="comment">//was not to be processed as an entity.</span>
<a name="l04206"></a>04206             <span class="charliteral">&#39;;&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;SEMI&gt;&#39;</span>, <span class="comment">// Force ; to be processed as entity</span>
<a name="l04207"></a>04207             <span class="charliteral">&#39;|&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;PIPE&gt;&#39;</span> <span class="comment">// Force | to be processed as entity</span>
<a name="l04208"></a>04208             );                      <span class="comment">// ENT_COMPAT set</span>
<a name="l04209"></a>04209 
<a name="l04210"></a>04210         <span class="keywordflow">switch</span> ($quote_style) {
<a name="l04211"></a>04211             <span class="keywordflow">case</span> ENT_NOQUOTES: <span class="comment">// don&#39;t convert double quotes</span>
<a name="l04212"></a>04212                 unset($aTransSpecchar[<span class="charliteral">&#39;&quot;&#39;</span>]);
<a name="l04213"></a>04213                 <span class="keywordflow">break</span>;
<a name="l04214"></a>04214             <span class="keywordflow">case</span> ENT_QUOTES: <span class="comment">// convert single quotes as well</span>
<a name="l04215"></a>04215                 $aTransSpecchar[<span class="stringliteral">&quot;&#39;&quot;</span>] = <span class="stringliteral">&#39;&amp;#39;&#39;</span>; <span class="comment">// (apos) htmlspecialchars() uses &#39;&amp;#039;&#39;</span>
<a name="l04216"></a>04216                 <span class="keywordflow">break</span>;
<a name="l04217"></a>04217         }
<a name="l04218"></a>04218 
<a name="l04219"></a>04219         <span class="comment">// return translated string</span>
<a name="l04220"></a>04220         <span class="keywordflow">return</span> strtr($string, $aTransSpecchar);
<a name="l04221"></a>04221     }
<a name="l04222"></a>04222 
<a name="l04223"></a>04223     function _genCSSName($name){
<a name="l04224"></a>04224         <span class="keywordflow">return</span> (is_numeric($name[0]) ? <span class="charliteral">&#39;_&#39;</span> : <span class="stringliteral">&#39;&#39;</span>) . $name;
<a name="l04225"></a>04225     }
<a name="l04226"></a>04226 
<a name="l04236"></a><a class="code" href="classGeSHi.html#aefe94b23dc0fddd51756b5d48c417669">04236</a>     function <a class="code" href="classGeSHi.html#aefe94b23dc0fddd51756b5d48c417669" title="Returns a stylesheet for the highlighted code.">get_stylesheet</a>($economy_mode = <span class="keyword">true</span>) {
<a name="l04237"></a>04237         <span class="comment">// If there&#39;s an error, chances are that the language file</span>
<a name="l04238"></a>04238         <span class="comment">// won&#39;t have populated the language data file, so we can&#39;t</span>
<a name="l04239"></a>04239         <span class="comment">// risk getting a stylesheet...</span>
<a name="l04240"></a>04240         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGeSHi.html#ae6b1b64028fe60fbb3c8aaf420793578" title="Returns an error message associated with the last GeSHi operation, or false if no...">error</a>) {
<a name="l04241"></a>04241             <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l04242"></a>04242         }
<a name="l04243"></a>04243 
<a name="l04244"></a>04244         <span class="comment">//Check if the style rearrangements have been processed ...</span>
<a name="l04245"></a>04245         <span class="comment">//This also does some preprocessing to check which style groups are useable ...</span>
<a name="l04246"></a>04246         <span class="keywordflow">if</span>(!isset($this-&gt;language_data[<span class="stringliteral">&#39;NUMBERS_CACHE&#39;</span>])) {
<a name="l04247"></a>04247             $this-&gt;<a class="code" href="classGeSHi.html#a3e3303eb8be497200431946eb347eddb" title="Setup caches needed for styling.">build_style_cache</a>();
<a name="l04248"></a>04248         }
<a name="l04249"></a>04249 
<a name="l04250"></a>04250         <span class="comment">// First, work out what the selector should be. If there&#39;s an ID,</span>
<a name="l04251"></a>04251         <span class="comment">// that should be used, the same for a class. Otherwise, a selector</span>
<a name="l04252"></a>04252         <span class="comment">// of &#39;&#39; means that these styles will be applied anywhere</span>
<a name="l04253"></a>04253         <span class="keywordflow">if</span> ($this-&gt;overall_id) {
<a name="l04254"></a>04254             $selector = <span class="charliteral">&#39;#&#39;</span> . $this-&gt;_genCSSName($this-&gt;overall_id);
<a name="l04255"></a>04255         } <span class="keywordflow">else</span> {
<a name="l04256"></a>04256             $selector = <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_genCSSName($this-&gt;language);
<a name="l04257"></a>04257             <span class="keywordflow">if</span> ($this-&gt;overall_class) {
<a name="l04258"></a>04258                 $selector .= <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_genCSSName($this-&gt;overall_class);
<a name="l04259"></a>04259             }
<a name="l04260"></a>04260         }
<a name="l04261"></a>04261         $selector .= <span class="charliteral">&#39; &#39;</span>;
<a name="l04262"></a>04262 
<a name="l04263"></a>04263         <span class="comment">// Header of the stylesheet</span>
<a name="l04264"></a>04264         <span class="keywordflow">if</span> (!$economy_mode) {
<a name="l04265"></a>04265             $stylesheet = <span class="stringliteral">&quot;/**\n&quot;</span>.
<a name="l04266"></a>04266                 <span class="stringliteral">&quot; * GeSHi Dynamically Generated Stylesheet\n&quot;</span>.
<a name="l04267"></a>04267                 <span class="stringliteral">&quot; * --------------------------------------\n&quot;</span>.
<a name="l04268"></a>04268                 <span class="stringliteral">&quot; * Dynamically generated stylesheet for {$this-&gt;language}\n&quot;</span>.
<a name="l04269"></a>04269                 <span class="stringliteral">&quot; * CSS class: {$this-&gt;overall_class}, CSS id: {$this-&gt;overall_id}\n&quot;</span>.
<a name="l04270"></a>04270                 <span class="stringliteral">&quot; * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann\n&quot;</span> .
<a name="l04271"></a>04271                 <span class="stringliteral">&quot; * (http://qbnz.com/highlighter/ and http://geshi.org/)\n&quot;</span>.
<a name="l04272"></a>04272                 <span class="stringliteral">&quot; * --------------------------------------\n&quot;</span>.
<a name="l04273"></a>04273                 <span class="stringliteral">&quot; */\n&quot;</span>;
<a name="l04274"></a>04274         } <span class="keywordflow">else</span> {
<a name="l04275"></a>04275             $stylesheet = <span class="stringliteral">&quot;/**\n&quot;</span>.
<a name="l04276"></a>04276                 <span class="stringliteral">&quot; * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann\n&quot;</span> .
<a name="l04277"></a>04277                 <span class="stringliteral">&quot; * (http://qbnz.com/highlighter/ and http://geshi.org/)\n&quot;</span>.
<a name="l04278"></a>04278                 <span class="stringliteral">&quot; */\n&quot;</span>;
<a name="l04279"></a>04279         }
<a name="l04280"></a>04280 
<a name="l04281"></a>04281         <span class="comment">// Set the &lt;ol&gt; to have no effect at all if there are line numbers</span>
<a name="l04282"></a>04282         <span class="comment">// (&lt;ol&gt;s have margins that should be destroyed so all layout is</span>
<a name="l04283"></a>04283         <span class="comment">// controlled by the set_overall_style method, which works on the</span>
<a name="l04284"></a>04284         <span class="comment">// &lt;pre&gt; or &lt;div&gt; container). Additionally, set default styles for lines</span>
<a name="l04285"></a>04285         <span class="keywordflow">if</span> (!$economy_mode || $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) {
<a name="l04286"></a>04286             <span class="comment">//$stylesheet .= &quot;$selector, {$selector}ol, {$selector}ol li {margin: 0;}\n&quot;;</span>
<a name="l04287"></a>04287             $stylesheet .= <span class="stringliteral">&quot;$selector.de1, $selector.de2 {{$this-&gt;code_style}}\n&quot;</span>;
<a name="l04288"></a>04288         }
<a name="l04289"></a>04289 
<a name="l04290"></a>04290         <span class="comment">// Add overall styles</span>
<a name="l04291"></a>04291         <span class="comment">// note: neglect economy_mode, empty styles are meaningless</span>
<a name="l04292"></a>04292         <span class="keywordflow">if</span> ($this-&gt;overall_style != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04293"></a>04293             $stylesheet .= <span class="stringliteral">&quot;$selector {{$this-&gt;overall_style}}\n&quot;</span>;
<a name="l04294"></a>04294         }
<a name="l04295"></a>04295 
<a name="l04296"></a>04296         <span class="comment">// Add styles for links</span>
<a name="l04297"></a>04297         <span class="comment">// note: economy mode does not make _any_ sense here</span>
<a name="l04298"></a>04298         <span class="comment">//       either the style is empty and thus no selector is needed</span>
<a name="l04299"></a>04299         <span class="comment">//       or the appropriate key is given.</span>
<a name="l04300"></a>04300         <span class="keywordflow">foreach</span> ($this-&gt;link_styles as $key =&gt; $style) {
<a name="l04301"></a>04301             <span class="keywordflow">if</span> ($style != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04302"></a>04302                 <span class="keywordflow">switch</span> ($key) {
<a name="l04303"></a>04303                     <span class="keywordflow">case</span> GESHI_LINK:
<a name="l04304"></a>04304                         $stylesheet .= <span class="stringliteral">&quot;{$selector}a:link {{$style}}\n&quot;</span>;
<a name="l04305"></a>04305                         <span class="keywordflow">break</span>;
<a name="l04306"></a>04306                     <span class="keywordflow">case</span> GESHI_HOVER:
<a name="l04307"></a>04307                         $stylesheet .= <span class="stringliteral">&quot;{$selector}a:hover {{$style}}\n&quot;</span>;
<a name="l04308"></a>04308                         <span class="keywordflow">break</span>;
<a name="l04309"></a>04309                     <span class="keywordflow">case</span> GESHI_ACTIVE:
<a name="l04310"></a>04310                         $stylesheet .= <span class="stringliteral">&quot;{$selector}a:active {{$style}}\n&quot;</span>;
<a name="l04311"></a>04311                         <span class="keywordflow">break</span>;
<a name="l04312"></a>04312                     <span class="keywordflow">case</span> GESHI_VISITED:
<a name="l04313"></a>04313                         $stylesheet .= <span class="stringliteral">&quot;{$selector}a:visited {{$style}}\n&quot;</span>;
<a name="l04314"></a>04314                         <span class="keywordflow">break</span>;
<a name="l04315"></a>04315                 }
<a name="l04316"></a>04316             }
<a name="l04317"></a>04317         }
<a name="l04318"></a>04318 
<a name="l04319"></a>04319         <span class="comment">// Header and footer</span>
<a name="l04320"></a>04320         <span class="comment">// note: neglect economy_mode, empty styles are meaningless</span>
<a name="l04321"></a>04321         <span class="keywordflow">if</span> ($this-&gt;header_content_style != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04322"></a>04322             $stylesheet .= <span class="stringliteral">&quot;$selector.head {{$this-&gt;header_content_style}}\n&quot;</span>;
<a name="l04323"></a>04323         }
<a name="l04324"></a>04324         <span class="keywordflow">if</span> ($this-&gt;footer_content_style != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04325"></a>04325             $stylesheet .= <span class="stringliteral">&quot;$selector.foot {{$this-&gt;footer_content_style}}\n&quot;</span>;
<a name="l04326"></a>04326         }
<a name="l04327"></a>04327 
<a name="l04328"></a>04328         <span class="comment">// Styles for important stuff</span>
<a name="l04329"></a>04329         <span class="comment">// note: neglect economy_mode, empty styles are meaningless</span>
<a name="l04330"></a>04330         <span class="keywordflow">if</span> ($this-&gt;important_styles != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04331"></a>04331             $stylesheet .= <span class="stringliteral">&quot;$selector.imp {{$this-&gt;important_styles}}\n&quot;</span>;
<a name="l04332"></a>04332         }
<a name="l04333"></a>04333 
<a name="l04334"></a>04334         <span class="comment">// Simple line number styles</span>
<a name="l04335"></a>04335         <span class="keywordflow">if</span> ((!$economy_mode || $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) &amp;&amp; $this-&gt;line_style1 != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04336"></a>04336             $stylesheet .= <span class="stringliteral">&quot;{$selector}li, {$selector}.li1 {{$this-&gt;line_style1}}\n&quot;</span>;
<a name="l04337"></a>04337         }
<a name="l04338"></a>04338         <span class="keywordflow">if</span> ((!$economy_mode || $this-&gt;line_numbers != GESHI_NO_LINE_NUMBERS) &amp;&amp; $this-&gt;table_linenumber_style != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04339"></a>04339             $stylesheet .= <span class="stringliteral">&quot;{$selector}.ln {{$this-&gt;table_linenumber_style}}\n&quot;</span>;
<a name="l04340"></a>04340         }
<a name="l04341"></a>04341         <span class="comment">// If there is a style set for fancy line numbers, echo it out</span>
<a name="l04342"></a>04342         <span class="keywordflow">if</span> ((!$economy_mode || $this-&gt;line_numbers == GESHI_FANCY_LINE_NUMBERS) &amp;&amp; $this-&gt;line_style2 != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04343"></a>04343             $stylesheet .= <span class="stringliteral">&quot;{$selector}.li2 {{$this-&gt;line_style2}}\n&quot;</span>;
<a name="l04344"></a>04344         }
<a name="l04345"></a>04345 
<a name="l04346"></a>04346         <span class="comment">// note: empty styles are meaningless</span>
<a name="l04347"></a>04347         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;KEYWORDS&#39;</span>] as $group =&gt; $styles) {
<a name="l04348"></a>04348             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode ||
<a name="l04349"></a>04349                 (isset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$group]) &amp;&amp;
<a name="l04350"></a>04350                 $this-&gt;lexic_permissions[<span class="stringliteral">&#39;KEYWORDS&#39;</span>][$group]))) {
<a name="l04351"></a>04351                 $stylesheet .= <span class="stringliteral">&quot;$selector.kw$group {{$styles}}\n&quot;</span>;
<a name="l04352"></a>04352             }
<a name="l04353"></a>04353         }
<a name="l04354"></a>04354         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;COMMENTS&#39;</span>] as $group =&gt; $styles) {
<a name="l04355"></a>04355             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode ||
<a name="l04356"></a>04356                 (isset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][$group]) &amp;&amp;
<a name="l04357"></a>04357                 $this-&gt;lexic_permissions[<span class="stringliteral">&#39;COMMENTS&#39;</span>][$group]) ||
<a name="l04358"></a>04358                 (!empty($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_REGEXP&#39;</span>]) &amp;&amp;
<a name="l04359"></a>04359                 !empty($this-&gt;language_data[<span class="stringliteral">&#39;COMMENT_REGEXP&#39;</span>][$group])))) {
<a name="l04360"></a>04360                 $stylesheet .= <span class="stringliteral">&quot;$selector.co$group {{$styles}}\n&quot;</span>;
<a name="l04361"></a>04361             }
<a name="l04362"></a>04362         }
<a name="l04363"></a>04363         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>] as $group =&gt; $styles) {
<a name="l04364"></a>04364             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode || $this-&gt;lexic_permissions[<span class="stringliteral">&#39;ESCAPE_CHAR&#39;</span>])) {
<a name="l04365"></a>04365                 <span class="comment">// NEW: since 1.0.8 we have to handle hardescapes</span>
<a name="l04366"></a>04366                 <span class="keywordflow">if</span> ($group === <span class="stringliteral">&#39;HARD&#39;</span>) {
<a name="l04367"></a>04367                     $group = <span class="stringliteral">&#39;_h&#39;</span>;
<a name="l04368"></a>04368                 }
<a name="l04369"></a>04369                 $stylesheet .= <span class="stringliteral">&quot;$selector.es$group {{$styles}}\n&quot;</span>;
<a name="l04370"></a>04370             }
<a name="l04371"></a>04371         }
<a name="l04372"></a>04372         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;BRACKETS&#39;</span>] as $group =&gt; $styles) {
<a name="l04373"></a>04373             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode || $this-&gt;lexic_permissions[<span class="stringliteral">&#39;BRACKETS&#39;</span>])) {
<a name="l04374"></a>04374                 $stylesheet .= <span class="stringliteral">&quot;$selector.br$group {{$styles}}\n&quot;</span>;
<a name="l04375"></a>04375             }
<a name="l04376"></a>04376         }
<a name="l04377"></a>04377         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SYMBOLS&#39;</span>] as $group =&gt; $styles) {
<a name="l04378"></a>04378             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode || $this-&gt;lexic_permissions[<span class="stringliteral">&#39;SYMBOLS&#39;</span>])) {
<a name="l04379"></a>04379                 $stylesheet .= <span class="stringliteral">&quot;$selector.sy$group {{$styles}}\n&quot;</span>;
<a name="l04380"></a>04380             }
<a name="l04381"></a>04381         }
<a name="l04382"></a>04382         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;STRINGS&#39;</span>] as $group =&gt; $styles) {
<a name="l04383"></a>04383             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode || $this-&gt;lexic_permissions[<span class="stringliteral">&#39;STRINGS&#39;</span>])) {
<a name="l04384"></a>04384                 <span class="comment">// NEW: since 1.0.8 we have to handle hardquotes</span>
<a name="l04385"></a>04385                 <span class="keywordflow">if</span> ($group === <span class="stringliteral">&#39;HARD&#39;</span>) {
<a name="l04386"></a>04386                     $group = <span class="stringliteral">&#39;_h&#39;</span>;
<a name="l04387"></a>04387                 }
<a name="l04388"></a>04388                 $stylesheet .= <span class="stringliteral">&quot;$selector.st$group {{$styles}}\n&quot;</span>;
<a name="l04389"></a>04389             }
<a name="l04390"></a>04390         }
<a name="l04391"></a>04391         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;NUMBERS&#39;</span>] as $group =&gt; $styles) {
<a name="l04392"></a>04392             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode || $this-&gt;lexic_permissions[<span class="stringliteral">&#39;NUMBERS&#39;</span>])) {
<a name="l04393"></a>04393                 $stylesheet .= <span class="stringliteral">&quot;$selector.nu$group {{$styles}}\n&quot;</span>;
<a name="l04394"></a>04394             }
<a name="l04395"></a>04395         }
<a name="l04396"></a>04396         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;METHODS&#39;</span>] as $group =&gt; $styles) {
<a name="l04397"></a>04397             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode || $this-&gt;lexic_permissions[<span class="stringliteral">&#39;METHODS&#39;</span>])) {
<a name="l04398"></a>04398                 $stylesheet .= <span class="stringliteral">&quot;$selector.me$group {{$styles}}\n&quot;</span>;
<a name="l04399"></a>04399             }
<a name="l04400"></a>04400         }
<a name="l04401"></a>04401         <span class="comment">// note: neglect economy_mode, empty styles are meaningless</span>
<a name="l04402"></a>04402         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;SCRIPT&#39;</span>] as $group =&gt; $styles) {
<a name="l04403"></a>04403             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04404"></a>04404                 $stylesheet .= <span class="stringliteral">&quot;$selector.sc$group {{$styles}}\n&quot;</span>;
<a name="l04405"></a>04405             }
<a name="l04406"></a>04406         }
<a name="l04407"></a>04407         <span class="keywordflow">foreach</span> ($this-&gt;language_data[<span class="stringliteral">&#39;STYLES&#39;</span>][<span class="stringliteral">&#39;REGEXPS&#39;</span>] as $group =&gt; $styles) {
<a name="l04408"></a>04408             <span class="keywordflow">if</span> ($styles != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$economy_mode ||
<a name="l04409"></a>04409                 (isset($this-&gt;lexic_permissions[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$group]) &amp;&amp;
<a name="l04410"></a>04410                 $this-&gt;lexic_permissions[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$group]))) {
<a name="l04411"></a>04411                 <span class="keywordflow">if</span> (is_array($this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$group]) &amp;&amp;
<a name="l04412"></a>04412                     array_key_exists(GESHI_CLASS, $this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$group])) {
<a name="l04413"></a>04413                     $stylesheet .= <span class="stringliteral">&quot;$selector.&quot;</span>;
<a name="l04414"></a>04414                     $stylesheet .= $this-&gt;language_data[<span class="stringliteral">&#39;REGEXPS&#39;</span>][$group][GESHI_CLASS];
<a name="l04415"></a>04415                     $stylesheet .= <span class="stringliteral">&quot; {{$styles}}\n&quot;</span>;
<a name="l04416"></a>04416                 } <span class="keywordflow">else</span> {
<a name="l04417"></a>04417                     $stylesheet .= <span class="stringliteral">&quot;$selector.re$group {{$styles}}\n&quot;</span>;
<a name="l04418"></a>04418                 }
<a name="l04419"></a>04419             }
<a name="l04420"></a>04420         }
<a name="l04421"></a>04421         <span class="comment">// Styles for lines being highlighted extra</span>
<a name="l04422"></a>04422         <span class="keywordflow">if</span> (!$economy_mode || (count($this-&gt;highlight_extra_lines)!=count($this-&gt;highlight_extra_lines_styles))) {
<a name="l04423"></a>04423             $stylesheet .= <span class="stringliteral">&quot;{$selector}.ln-xtra, {$selector}li.ln-xtra, {$selector}div.ln-xtra {{$this-&gt;highlight_extra_lines_style}}\n&quot;</span>;
<a name="l04424"></a>04424         }
<a name="l04425"></a>04425         $stylesheet .= <span class="stringliteral">&quot;{$selector}span.xtra { display:block; }\n&quot;</span>;
<a name="l04426"></a>04426         <span class="keywordflow">foreach</span> ($this-&gt;highlight_extra_lines_styles as $lineid =&gt; $linestyle) {
<a name="l04427"></a>04427             $stylesheet .= <span class="stringliteral">&quot;{$selector}.lx$lineid, {$selector}li.lx$lineid, {$selector}div.lx$lineid {{$linestyle}}\n&quot;</span>;
<a name="l04428"></a>04428         }
<a name="l04429"></a>04429 
<a name="l04430"></a>04430         <span class="keywordflow">return</span> $stylesheet;
<a name="l04431"></a>04431     }
<a name="l04432"></a>04432 
<a name="l04440"></a><a class="code" href="classGeSHi.html#a024c45859b2135f1a022a566efea4284">04440</a>     function <a class="code" href="classGeSHi.html#a024c45859b2135f1a022a566efea4284" title="Get&amp;#39;s the style that is used for the specified line.">get_line_style</a>($line) {
<a name="l04441"></a>04441         <span class="comment">//$style = null;</span>
<a name="l04442"></a>04442         $style = null;
<a name="l04443"></a>04443         <span class="keywordflow">if</span> (isset($this-&gt;highlight_extra_lines_styles[$line])) {
<a name="l04444"></a>04444             $style = $this-&gt;highlight_extra_lines_styles[$line];
<a name="l04445"></a>04445         } <span class="keywordflow">else</span> { <span class="comment">// if no &quot;extra&quot; style assigned</span>
<a name="l04446"></a>04446             $style = $this-&gt;highlight_extra_lines_style;
<a name="l04447"></a>04447         }
<a name="l04448"></a>04448 
<a name="l04449"></a>04449         <span class="keywordflow">return</span> $style;
<a name="l04450"></a>04450     }
<a name="l04451"></a>04451 
<a name="l04467"></a><a class="code" href="classGeSHi.html#ab7fb140d0dbb71262e658f98396efc98">04467</a>     function <a class="code" href="classGeSHi.html#ab7fb140d0dbb71262e658f98396efc98" title="this functions creates an optimized regular expression list of an array of strings...">optimize_regexp_list</a>($list, $regexp_delimiter = <span class="charliteral">&#39;/&#39;</span>) {
<a name="l04468"></a>04468         $regex_chars = array(<span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;+&#39;</span>, <span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;?&#39;</span>, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;^&#39;</span>, <span class="charliteral">&#39;]&#39;</span>, <span class="charliteral">&#39;$&#39;</span>,
<a name="l04469"></a>04469             <span class="charliteral">&#39;(&#39;</span>, <span class="charliteral">&#39;)&#39;</span>, <span class="charliteral">&#39;{&#39;</span>, <span class="charliteral">&#39;}&#39;</span>, <span class="charliteral">&#39;=&#39;</span>, <span class="charliteral">&#39;!&#39;</span>, <span class="charliteral">&#39;&lt;&#39;</span>, <span class="charliteral">&#39;&gt;&#39;</span>, <span class="charliteral">&#39;|&#39;</span>, <span class="charliteral">&#39;:&#39;</span>, $regexp_delimiter);
<a name="l04470"></a>04470         sort($list);
<a name="l04471"></a>04471         $regexp_list = array(<span class="stringliteral">&#39;&#39;</span>);
<a name="l04472"></a>04472         $num_subpatterns = 0;
<a name="l04473"></a>04473         $list_key = 0;
<a name="l04474"></a>04474 
<a name="l04475"></a>04475         <span class="comment">// the tokens which we will use to generate the regexp list</span>
<a name="l04476"></a>04476         $tokens = array();
<a name="l04477"></a>04477         $prev_keys = array();
<a name="l04478"></a>04478         <span class="comment">// go through all entries of the list and generate the token list</span>
<a name="l04479"></a>04479         $cur_len = 0;
<a name="l04480"></a>04480         <span class="keywordflow">for</span> ($i = 0, $i_max = count($list); $i &lt; $i_max; ++$i) {
<a name="l04481"></a>04481             <span class="keywordflow">if</span> ($cur_len &gt; GESHI_MAX_PCRE_LENGTH) {
<a name="l04482"></a>04482                 <span class="comment">// seems like the length of this pcre is growing exorbitantly</span>
<a name="l04483"></a>04483                 $regexp_list[++$list_key] = $this-&gt;<a class="code" href="classGeSHi.html#a37e07952edc33c01ee398d0193dbdd0e" title="this function creates the appropriate regexp string of an token array you should...">_optimize_regexp_list_tokens_to_string</a>($tokens);
<a name="l04484"></a>04484                 $num_subpatterns = substr_count($regexp_list[$list_key], <span class="stringliteral">&#39;(?:&#39;</span>);
<a name="l04485"></a>04485                 $tokens = array();
<a name="l04486"></a>04486                 $cur_len = 0;
<a name="l04487"></a>04487             }
<a name="l04488"></a>04488             $level = 0;
<a name="l04489"></a>04489             $entry = preg_quote((<span class="keywordtype">string</span>) $list[$i], $regexp_delimiter);
<a name="l04490"></a>04490             $pointer = &amp;$tokens;
<a name="l04491"></a>04491             <span class="comment">// properly assign the new entry to the correct position in the token array</span>
<a name="l04492"></a>04492             <span class="comment">// possibly generate smaller common denominator keys</span>
<a name="l04493"></a>04493             <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l04494"></a>04494                 <span class="comment">// get the common denominator</span>
<a name="l04495"></a>04495                 <span class="keywordflow">if</span> (isset($prev_keys[$level])) {
<a name="l04496"></a>04496                     <span class="keywordflow">if</span> ($prev_keys[$level] == $entry) {
<a name="l04497"></a>04497                         <span class="comment">// this is a duplicate entry, skip it</span>
<a name="l04498"></a>04498                         <span class="keywordflow">continue</span> 2;
<a name="l04499"></a>04499                     }
<a name="l04500"></a>04500                     $char = 0;
<a name="l04501"></a>04501                     <span class="keywordflow">while</span> (isset($entry[$char]) &amp;&amp; isset($prev_keys[$level][$char])
<a name="l04502"></a>04502                             &amp;&amp; $entry[$char] == $prev_keys[$level][$char]) {
<a name="l04503"></a>04503                         ++$char;
<a name="l04504"></a>04504                     }
<a name="l04505"></a>04505                     <span class="keywordflow">if</span> ($char &gt; 0) {
<a name="l04506"></a>04506                         <span class="comment">// this entry has at least some chars in common with the current key</span>
<a name="l04507"></a>04507                         <span class="keywordflow">if</span> ($char == strlen($prev_keys[$level])) {
<a name="l04508"></a>04508                             <span class="comment">// current key is totally matched, i.e. this entry has just some bits appended</span>
<a name="l04509"></a>04509                             $pointer = &amp;$pointer[$prev_keys[$level]];
<a name="l04510"></a>04510                         } <span class="keywordflow">else</span> {
<a name="l04511"></a>04511                             <span class="comment">// only part of the keys match</span>
<a name="l04512"></a>04512                             $new_key_part1 = substr($prev_keys[$level], 0, $char);
<a name="l04513"></a>04513                             $new_key_part2 = substr($prev_keys[$level], $char);
<a name="l04514"></a>04514 
<a name="l04515"></a>04515                             <span class="keywordflow">if</span> (in_array($new_key_part1[0], $regex_chars)
<a name="l04516"></a>04516                                 || in_array($new_key_part2[0], $regex_chars)) {
<a name="l04517"></a>04517                                 <span class="comment">// this is bad, a regex char as first character</span>
<a name="l04518"></a>04518                                 $pointer[$entry] = array(<span class="stringliteral">&#39;&#39;</span> =&gt; <span class="keyword">true</span>);
<a name="l04519"></a>04519                                 array_splice($prev_keys, $level, count($prev_keys), $entry);
<a name="l04520"></a>04520                                 $cur_len += strlen($entry);
<a name="l04521"></a>04521                                 <span class="keywordflow">continue</span>;
<a name="l04522"></a>04522                             } <span class="keywordflow">else</span> {
<a name="l04523"></a>04523                                 <span class="comment">// relocate previous tokens</span>
<a name="l04524"></a>04524                                 $pointer[$new_key_part1] = array($new_key_part2 =&gt; $pointer[$prev_keys[$level]]);
<a name="l04525"></a>04525                                 unset($pointer[$prev_keys[$level]]);
<a name="l04526"></a>04526                                 $pointer = &amp;$pointer[$new_key_part1];
<a name="l04527"></a>04527                                 <span class="comment">// recreate key index</span>
<a name="l04528"></a>04528                                 array_splice($prev_keys, $level, count($prev_keys), array($new_key_part1, $new_key_part2));
<a name="l04529"></a>04529                                 $cur_len += strlen($new_key_part2);
<a name="l04530"></a>04530                             }
<a name="l04531"></a>04531                         }
<a name="l04532"></a>04532                         ++$level;
<a name="l04533"></a>04533                         $entry = substr($entry, $char);
<a name="l04534"></a>04534                         <span class="keywordflow">continue</span>;
<a name="l04535"></a>04535                     }
<a name="l04536"></a>04536                     <span class="comment">// else: fall trough, i.e. no common denominator was found</span>
<a name="l04537"></a>04537                 }
<a name="l04538"></a>04538                 <span class="keywordflow">if</span> ($level == 0 &amp;&amp; !empty($tokens)) {
<a name="l04539"></a>04539                     <span class="comment">// we can dump current tokens into the string and throw them away afterwards</span>
<a name="l04540"></a>04540                     $new_entry = $this-&gt;<a class="code" href="classGeSHi.html#a37e07952edc33c01ee398d0193dbdd0e" title="this function creates the appropriate regexp string of an token array you should...">_optimize_regexp_list_tokens_to_string</a>($tokens);
<a name="l04541"></a>04541                     $new_subpatterns = substr_count($new_entry, <span class="stringliteral">&#39;(?:&#39;</span>);
<a name="l04542"></a>04542                     <span class="keywordflow">if</span> (GESHI_MAX_PCRE_SUBPATTERNS &amp;&amp; $num_subpatterns + $new_subpatterns &gt; GESHI_MAX_PCRE_SUBPATTERNS) {
<a name="l04543"></a>04543                         $regexp_list[++$list_key] = $new_entry;
<a name="l04544"></a>04544                         $num_subpatterns = $new_subpatterns;
<a name="l04545"></a>04545                     } <span class="keywordflow">else</span> {
<a name="l04546"></a>04546                         <span class="keywordflow">if</span> (!empty($regexp_list[$list_key])) {
<a name="l04547"></a>04547                             $new_entry = <span class="charliteral">&#39;|&#39;</span> . $new_entry;
<a name="l04548"></a>04548                         }
<a name="l04549"></a>04549                         $regexp_list[$list_key] .= $new_entry;
<a name="l04550"></a>04550                         $num_subpatterns += $new_subpatterns;
<a name="l04551"></a>04551                     }
<a name="l04552"></a>04552                     $tokens = array();
<a name="l04553"></a>04553                     $cur_len = 0;
<a name="l04554"></a>04554                 }
<a name="l04555"></a>04555                 <span class="comment">// no further common denominator found</span>
<a name="l04556"></a>04556                 $pointer[$entry] = array(<span class="stringliteral">&#39;&#39;</span> =&gt; <span class="keyword">true</span>);
<a name="l04557"></a>04557                 array_splice($prev_keys, $level, count($prev_keys), $entry);
<a name="l04558"></a>04558 
<a name="l04559"></a>04559                 $cur_len += strlen($entry);
<a name="l04560"></a>04560                 <span class="keywordflow">break</span>;
<a name="l04561"></a>04561             }
<a name="l04562"></a>04562             unset($list[$i]);
<a name="l04563"></a>04563         }
<a name="l04564"></a>04564         <span class="comment">// make sure the last tokens get converted as well</span>
<a name="l04565"></a>04565         $new_entry = $this-&gt;<a class="code" href="classGeSHi.html#a37e07952edc33c01ee398d0193dbdd0e" title="this function creates the appropriate regexp string of an token array you should...">_optimize_regexp_list_tokens_to_string</a>($tokens);
<a name="l04566"></a>04566         <span class="keywordflow">if</span> (GESHI_MAX_PCRE_SUBPATTERNS &amp;&amp; $num_subpatterns + substr_count($new_entry, <span class="stringliteral">&#39;(?:&#39;</span>) &gt; GESHI_MAX_PCRE_SUBPATTERNS) {
<a name="l04567"></a>04567             <span class="keywordflow">if</span> ( !empty($regexp_list[$list_key]) ) {
<a name="l04568"></a>04568               ++$list_key;
<a name="l04569"></a>04569             }
<a name="l04570"></a>04570             $regexp_list[$list_key] = $new_entry;
<a name="l04571"></a>04571         } <span class="keywordflow">else</span> {
<a name="l04572"></a>04572             <span class="keywordflow">if</span> (!empty($regexp_list[$list_key])) {
<a name="l04573"></a>04573                 $new_entry = <span class="charliteral">&#39;|&#39;</span> . $new_entry;
<a name="l04574"></a>04574             }
<a name="l04575"></a>04575             $regexp_list[$list_key] .= $new_entry;
<a name="l04576"></a>04576         }
<a name="l04577"></a>04577         <span class="keywordflow">return</span> $regexp_list;
<a name="l04578"></a>04578     }
<a name="l04590"></a><a class="code" href="classGeSHi.html#a37e07952edc33c01ee398d0193dbdd0e">04590</a>     function <a class="code" href="classGeSHi.html#a37e07952edc33c01ee398d0193dbdd0e" title="this function creates the appropriate regexp string of an token array you should...">_optimize_regexp_list_tokens_to_string</a>(&amp;$tokens, $recursed = <span class="keyword">false</span>) {
<a name="l04591"></a>04591         $list = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04592"></a>04592         <span class="keywordflow">foreach</span> ($tokens as $token =&gt; $sub_tokens) {
<a name="l04593"></a>04593             $list .= $token;
<a name="l04594"></a>04594             $close_entry = isset($sub_tokens[<span class="stringliteral">&#39;&#39;</span>]);
<a name="l04595"></a>04595             unset($sub_tokens[<span class="stringliteral">&#39;&#39;</span>]);
<a name="l04596"></a>04596             <span class="keywordflow">if</span> (!empty($sub_tokens)) {
<a name="l04597"></a>04597                 $list .= <span class="stringliteral">&#39;(?:&#39;</span> . $this-&gt;<a class="code" href="classGeSHi.html#a37e07952edc33c01ee398d0193dbdd0e" title="this function creates the appropriate regexp string of an token array you should...">_optimize_regexp_list_tokens_to_string</a>($sub_tokens, <span class="keyword">true</span>) . <span class="charliteral">&#39;)&#39;</span>;
<a name="l04598"></a>04598                 <span class="keywordflow">if</span> ($close_entry) {
<a name="l04599"></a>04599                     <span class="comment">// make sub_tokens optional</span>
<a name="l04600"></a>04600                     $list .= <span class="charliteral">&#39;?&#39;</span>;
<a name="l04601"></a>04601                 }
<a name="l04602"></a>04602             }
<a name="l04603"></a>04603             $list .= <span class="charliteral">&#39;|&#39;</span>;
<a name="l04604"></a>04604         }
<a name="l04605"></a>04605         <span class="keywordflow">if</span> (!$recursed) {
<a name="l04606"></a>04606             <span class="comment">// do some optimizations</span>
<a name="l04607"></a>04607             <span class="comment">// common trailing strings</span>
<a name="l04608"></a>04608             <span class="comment">// BUGGY!</span>
<a name="l04609"></a>04609             <span class="comment">//$list = preg_replace_callback(&#39;#(?&lt;=^|\:|\|)\w+?(\w+)(?:\|.+\1)+(?=\|)#&#39;, create_function(</span>
<a name="l04610"></a>04610             <span class="comment">//    &#39;$matches&#39;, &#39;return &quot;(?:&quot; . preg_replace(&quot;#&quot; . preg_quote($matches[1], &quot;#&quot;) . &quot;(?=\||$)#&quot;, &quot;&quot;, $matches[0]) . &quot;)&quot; . $matches[1];&#39;), $list);</span>
<a name="l04611"></a>04611             <span class="comment">// (?:p)? =&gt; p?</span>
<a name="l04612"></a>04612             $list = preg_replace(<span class="stringliteral">&#39;#\(\?\:(.)\)\?#&#39;</span>, <span class="stringliteral">&#39;\1?&#39;</span>, $list);
<a name="l04613"></a>04613             <span class="comment">// (?:a|b|c|d|...)? =&gt; [abcd...]?</span>
<a name="l04614"></a>04614             <span class="comment">// TODO: a|bb|c =&gt; [ac]|bb</span>
<a name="l04615"></a>04615             <span class="keyword">static</span> $callback_2;
<a name="l04616"></a>04616             <span class="keywordflow">if</span> (!isset($callback_2)) {
<a name="l04617"></a>04617                 $callback_2 = create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;return &quot;[&quot; . str_replace(&quot;|&quot;, &quot;&quot;, $matches[1]) . &quot;]&quot;;&#39;</span>);
<a name="l04618"></a>04618             }
<a name="l04619"></a>04619             $list = preg_replace_callback(<span class="stringliteral">&#39;#\(\?\:((?:.\|)+.)\)#&#39;</span>, $callback_2, $list);
<a name="l04620"></a>04620         }
<a name="l04621"></a>04621         <span class="comment">// return $list without trailing pipe</span>
<a name="l04622"></a>04622         <span class="keywordflow">return</span> substr($list, 0, -1);
<a name="l04623"></a>04623     }
<a name="l04624"></a>04624 } <span class="comment">// End Class GeSHi</span>
<a name="l04625"></a>04625 
<a name="l04626"></a>04626 
<a name="l04627"></a>04627 <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;geshi_highlight&#39;</span>)) {
<a name="l04639"></a>04639     function geshi_highlight($string, $language, $path = null, $return = <span class="keyword">false</span>) {
<a name="l04640"></a>04640         $geshi = <span class="keyword">new</span> <a class="code" href="classGeSHi.html">GeSHi</a>($string, $language, $path);
<a name="l04641"></a>04641         $geshi-&gt;set_header_type(GESHI_HEADER_NONE);
<a name="l04642"></a>04642 
<a name="l04643"></a>04643         <span class="keywordflow">if</span> ($return) {
<a name="l04644"></a>04644             <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;code&gt;&#39;</span> . $geshi-&gt;parse_code() . <span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>;
<a name="l04645"></a>04645         }
<a name="l04646"></a>04646 
<a name="l04647"></a>04647         echo <span class="stringliteral">&#39;&lt;code&gt;&#39;</span> . $geshi-&gt;parse_code() . <span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>;
<a name="l04648"></a>04648 
<a name="l04649"></a>04649         <span class="keywordflow">if</span> ($geshi-&gt;error()) {
<a name="l04650"></a>04650             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04651"></a>04651         }
<a name="l04652"></a>04652         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04653"></a>04653     }
<a name="l04654"></a>04654 }
<a name="l04655"></a>04655 
<a name="l04656"></a>04656 ?&gt;
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
