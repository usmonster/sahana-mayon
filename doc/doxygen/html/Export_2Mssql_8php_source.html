<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: lib/vendor/symfony/lib/plugins/sfDoctrinePlugin/lib/vendor/doctrine/Doctrine/Export/Mssql.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>lib/vendor/symfony/lib/plugins/sfDoctrinePlugin/lib/vendor/doctrine/Doctrine/Export/Mssql.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">/*</span>
<a name="l00003"></a>00003 <span class="comment"> *  $Id: Mssql.php 7660 2010-06-08 18:30:22Z jwage $</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00006"></a>00006 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00007"></a>00007 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00008"></a>00008 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00009"></a>00009 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00010"></a>00010 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00011"></a>00011 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00012"></a>00012 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00013"></a>00013 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00014"></a>00014 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00015"></a>00015 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This software consists of voluntary contributions made by many individuals</span>
<a name="l00018"></a>00018 <span class="comment"> * and is licensed under the LGPL. For more information, see</span>
<a name="l00019"></a>00019 <span class="comment"> * &lt;http://www.doctrine-project.org&gt;.</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 
<a name="l00035"></a><a class="code" href="classDoctrine__Export__Mssql.html">00035</a> <span class="keyword">class </span><a class="code" href="classDoctrine__Export__Mssql.html">Doctrine_Export_Mssql</a> <span class="keyword">extends</span> <a class="code" href="classDoctrine__Export.html">Doctrine_Export</a>
<a name="l00036"></a>00036 {
<a name="l00043"></a><a class="code" href="classDoctrine__Export__Mssql.html#ae0fa6b92252bc3fec456ebcf146b684c">00043</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#ae0fa6b92252bc3fec456ebcf146b684c" title="create a new database">createDatabase</a>($name)
<a name="l00044"></a>00044     {
<a name="l00045"></a>00045         $name = $this-&gt;conn-&gt;quoteIdentifier($name, <span class="keyword">true</span>);
<a name="l00046"></a>00046         $query = <span class="stringliteral">&quot;CREATE DATABASE $name&quot;</span>;
<a name="l00047"></a>00047         $options = $this-&gt;conn-&gt;getOptions();
<a name="l00048"></a>00048         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;database_device&#39;</span>]) &amp;&amp; $options[<span class="stringliteral">&#39;database_device&#39;</span>]) {
<a name="l00049"></a>00049             $query.= <span class="stringliteral">&#39; ON &#39;</span>.$this-&gt;conn-&gt;options[<span class="stringliteral">&#39;database_device&#39;</span>];
<a name="l00050"></a>00050             $query.= $this-&gt;conn-&gt;options[<span class="stringliteral">&#39;database_size&#39;</span>] ? <span class="charliteral">&#39;=&#39;</span> .
<a name="l00051"></a>00051                      $this-&gt;conn-&gt;options[<span class="stringliteral">&#39;database_size&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00052"></a>00052         }
<a name="l00053"></a>00053         <span class="keywordflow">return</span> $this-&gt;conn-&gt;standaloneQuery($query, array(), <span class="keyword">true</span>);
<a name="l00054"></a>00054     }
<a name="l00055"></a>00055 
<a name="l00062"></a><a class="code" href="classDoctrine__Export__Mssql.html#a6edd8f6a2ba963b04a0920babcbcbb0d">00062</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a6edd8f6a2ba963b04a0920babcbcbb0d" title="drop an existing database">dropDatabase</a>($name)
<a name="l00063"></a>00063     {
<a name="l00064"></a>00064         $name = $this-&gt;conn-&gt;quoteIdentifier($name, <span class="keyword">true</span>);
<a name="l00065"></a>00065         <span class="keywordflow">return</span> $this-&gt;conn-&gt;standaloneQuery(<span class="stringliteral">&#39;DROP DATABASE &#39;</span> . $name, array(), <span class="keyword">true</span>);
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 
<a name="l00074"></a><a class="code" href="classDoctrine__Export__Mssql.html#a65ddf7ac279e4492b81a2edc710eda01">00074</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a65ddf7ac279e4492b81a2edc710eda01" title="Override the parent method.">getTemporaryTableQuery</a>()
<a name="l00075"></a>00075     {
<a name="l00076"></a>00076         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00077"></a>00077     }  
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="classDoctrine__Export__Mssql.html#a4f2bdcb344adeaa5df2139dbefe02afc">00079</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a4f2bdcb344adeaa5df2139dbefe02afc" title="dropIndexSql">dropIndexSql</a>($table, $name)
<a name="l00080"></a>00080     {
<a name="l00081"></a>00081         $name = $this-&gt;conn-&gt;quoteIdentifier($this-&gt;conn-&gt;formatter-&gt;getIndexName($name));
<a name="l00082"></a>00082         $table = $this-&gt;conn-&gt;quoteIdentifier($table);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <span class="keywordflow">return</span> <span class="stringliteral">&#39;DROP INDEX &#39;</span> . $name . <span class="stringliteral">&#39; ON &#39;</span> . $table;
<a name="l00085"></a>00085     }
<a name="l00086"></a>00086 
<a name="l00175"></a><a class="code" href="classDoctrine__Export__Mssql.html#a661bbc316f1c3e7a076e73f9087fa419">00175</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a661bbc316f1c3e7a076e73f9087fa419" title="alter an existing table">alterTable</a>($name, array $changes, $check = <span class="keyword">false</span>)
<a name="l00176"></a>00176     {
<a name="l00177"></a>00177         <span class="keywordflow">if</span> ( !$name ) {
<a name="l00178"></a>00178             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Export__Exception.html">Doctrine_Export_Exception</a>(<span class="stringliteral">&#39;no valid table name specified&#39;</span>);
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="keywordflow">foreach</span> ($changes as $changeName =&gt; $change) {
<a name="l00182"></a>00182             <span class="keywordflow">switch</span> ($changeName) {
<a name="l00183"></a>00183                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;add&#39;</span>:
<a name="l00184"></a>00184                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;remove&#39;</span>:
<a name="l00185"></a>00185                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;name&#39;</span>:
<a name="l00186"></a>00186                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;rename&#39;</span>:
<a name="l00187"></a>00187                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;change&#39;</span>:
<a name="l00188"></a>00188                     <span class="keywordflow">break</span>;
<a name="l00189"></a>00189                 <span class="keywordflow">default</span>:
<a name="l00190"></a>00190                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Export__Exception.html">Doctrine_Export_Exception</a>(<span class="stringliteral">&#39;alterTable: change type &quot;&#39;</span> . $changeName . <span class="stringliteral">&#39;&quot; not yet supported&#39;</span>);
<a name="l00191"></a>00191             }
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194         <span class="keywordflow">if</span> ($check) {
<a name="l00195"></a>00195             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         $query = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00200"></a>00200         $postQueries = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">//SQL Server uses a stored procedure to rename objects</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="keywordflow">if</span> ( ! empty($changes[<span class="stringliteral">&#39;name&#39;</span>])) {
<a name="l00203"></a>00203             $changeName = $this-&gt;conn-&gt;quoteIdentifier($changes[<span class="stringliteral">&#39;name&#39;</span>], <span class="keyword">true</span>);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205             $postQueries .= sprintf(
<a name="l00206"></a>00206                 <span class="stringliteral">&quot;EXECUTE sp_RENAME &#39;%s&#39;, &#39;%s&#39;;&quot;</span>,
<a name="l00207"></a>00207                 $this-&gt;conn-&gt;quoteIdentifier($name),
<a name="l00208"></a>00208                 $changeName
<a name="l00209"></a>00209             );
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="comment">//ADD TABLE</span>
<a name="l00213"></a>00213         <span class="keywordflow">if</span> ( ! empty($changes[<span class="stringliteral">&#39;add&#39;</span>]) &amp;&amp; is_array($changes[<span class="stringliteral">&#39;add&#39;</span>])) {
<a name="l00214"></a>00214             <span class="keywordflow">foreach</span> ($changes[<span class="stringliteral">&#39;add&#39;</span>] as $fieldName =&gt; $field) {
<a name="l00215"></a>00215                 <span class="keywordflow">if</span> ($query) {
<a name="l00216"></a>00216                     $query .= <span class="stringliteral">&#39;, &#39;</span>;
<a name="l00217"></a>00217                 }
<a name="l00218"></a>00218                 $query .= <span class="stringliteral">&#39;ADD &#39;</span> . $this-&gt;<a class="code" href="classDoctrine__Export.html#a1693bf92cd94dea86068e279fc04201d" title="Obtain DBMS specific SQL code portion needed to declare a generic type field to be...">getDeclaration</a>($fieldName, $field);
<a name="l00219"></a>00219             }
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         <span class="comment">//REMOVE TABLE</span>
<a name="l00223"></a>00223         <span class="keywordflow">if</span> ( ! empty($changes[<span class="stringliteral">&#39;remove&#39;</span>]) &amp;&amp; is_array($changes[<span class="stringliteral">&#39;remove&#39;</span>])) {
<a name="l00224"></a>00224                 <span class="keywordflow">if</span> ($query) {
<a name="l00225"></a>00225                     $query .= <span class="stringliteral">&#39;, &#39;</span>;
<a name="l00226"></a>00226                 }
<a name="l00227"></a>00227             $query .= <span class="stringliteral">&#39;DROP COLUMN &#39;</span>;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229             $dropped = array();
<a name="l00230"></a>00230             <span class="keywordflow">foreach</span> ($changes[<span class="stringliteral">&#39;remove&#39;</span>] as $fieldName =&gt; $field) {
<a name="l00231"></a>00231                 
<a name="l00232"></a>00232                 $fieldName = $this-&gt;conn-&gt;quoteIdentifier($fieldName, <span class="keyword">true</span>);
<a name="l00233"></a>00233                 $dropped[] = $fieldName;
<a name="l00234"></a>00234             }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236             $query .= implode(<span class="stringliteral">&#39;, &#39;</span>, $dropped) . <span class="charliteral">&#39; &#39;</span>;
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         $rename = array();
<a name="l00240"></a>00240         <span class="keywordflow">if</span> ( ! empty($changes[<span class="stringliteral">&#39;rename&#39;</span>]) &amp;&amp; is_array($changes[<span class="stringliteral">&#39;rename&#39;</span>])) {
<a name="l00241"></a>00241             <span class="keywordflow">foreach</span> ($changes[<span class="stringliteral">&#39;rename&#39;</span>] as $fieldName =&gt; $field) {
<a name="l00242"></a>00242                 $rename[$field[<span class="stringliteral">&#39;name&#39;</span>]] = $fieldName;
<a name="l00243"></a>00243             }
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="comment">//CHANGE (COLUMN DEFINITION)</span>
<a name="l00247"></a>00247         <span class="keywordflow">if</span> ( ! empty($changes[<span class="stringliteral">&#39;change&#39;</span>]) &amp;&amp; is_array($changes[<span class="stringliteral">&#39;change&#39;</span>])) {
<a name="l00248"></a>00248             <span class="keywordflow">if</span> ($query) {
<a name="l00249"></a>00249                 $query.= <span class="stringliteral">&#39;, &#39;</span>;
<a name="l00250"></a>00250             }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252             $query .= <span class="stringliteral">&quot;ALTER COLUMN &quot;</span>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254             $altered = array();
<a name="l00255"></a>00255             <span class="keywordflow">foreach</span> ($changes[<span class="stringliteral">&#39;change&#39;</span>] as $fieldName =&gt; $field) {
<a name="l00256"></a>00256                 <span class="keywordflow">if</span> (isset($rename[$fieldName])) {
<a name="l00257"></a>00257                     $oldFieldName = $rename[$fieldName];
<a name="l00258"></a>00258                     unset($rename[$fieldName]);
<a name="l00259"></a>00259                 } <span class="keywordflow">else</span> {
<a name="l00260"></a>00260                     $oldFieldName = $fieldName;
<a name="l00261"></a>00261                 }
<a name="l00262"></a>00262                 $oldFieldName = $this-&gt;conn-&gt;quoteIdentifier($oldFieldName, <span class="keyword">true</span>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                 $declaration = $this-&gt;<a class="code" href="classDoctrine__Export.html#a1693bf92cd94dea86068e279fc04201d" title="Obtain DBMS specific SQL code portion needed to declare a generic type field to be...">getDeclaration</a>($fieldName, $field[<span class="stringliteral">&#39;definition&#39;</span>]);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266                 <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(CONSTRAINT\s+([^\s]*)\s+DEFAULT\s+([^\s]*)\s*)|(DEFAULT\s+([^\s]*)\s*)/&#39;</span>, $declaration, $matches)) {
<a name="l00267"></a>00267                     <span class="comment">// Remove the default constraint declaration from the statement</span>
<a name="l00268"></a>00268                     $altered[] = str_replace($matches[0], <span class="stringliteral">&#39;&#39;</span>, $declaration);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270                     <span class="keywordflow">if</span> (count($matches) === 6) {
<a name="l00271"></a>00271                         <span class="comment">// No constraint name provided. Try to make sure it&#39;s unique</span>
<a name="l00272"></a>00272                         $defaultName = <span class="stringliteral">&#39;DF__&#39;</span> . $name . <span class="stringliteral">&#39;__&#39;</span> . $fieldName . <span class="stringliteral">&#39;__&#39;</span> . mt_rand();
<a name="l00273"></a>00273                         $defaultValue = $matches[5];
<a name="l00274"></a>00274                     } <span class="keywordflow">else</span> {
<a name="l00275"></a>00275                         $defaultName = $matches[2];
<a name="l00276"></a>00276                         $defaultValue = $matches[3];
<a name="l00277"></a>00277                     }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279                     $postQueries .= sprintf(
<a name="l00280"></a>00280                         <span class="stringliteral">&#39; ALTER TABLE %s ADD CONSTRAINT %s DEFAULT (%s) FOR %s&#39;</span>,
<a name="l00281"></a>00281                         $name,
<a name="l00282"></a>00282                         $defaultName,
<a name="l00283"></a>00283                         $defaultValue,
<a name="l00284"></a>00284                         $fieldName
<a name="l00285"></a>00285                     );
<a name="l00286"></a>00286                 } <span class="keywordflow">else</span> {
<a name="l00287"></a>00287                     $altered[] = $declaration;
<a name="l00288"></a>00288                 }
<a name="l00289"></a>00289             }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291             $query .= implode(sprintf(
<a name="l00292"></a>00292                 <span class="stringliteral">&quot;; ALTER TABLE %s ALTER COLUMN &quot;</span>,
<a name="l00293"></a>00293                 $this-&gt;conn-&gt;quoteIdentifier($name, <span class="keyword">true</span>)
<a name="l00294"></a>00294             ), $altered) . <span class="charliteral">&#39; &#39;</span>;
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <span class="comment">//RENAME (COLUMN)</span>
<a name="l00298"></a>00298         <span class="keywordflow">if</span> ( ! empty($rename) &amp;&amp; is_array($rename)) {
<a name="l00299"></a>00299             <span class="keywordflow">foreach</span> ($rename as $renameName =&gt; $renamedField) {
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 $field = $changes[<span class="stringliteral">&#39;rename&#39;</span>][$renamedField];
<a name="l00302"></a>00302                 $renamedField = $this-&gt;conn-&gt;quoteIdentifier($renamedField);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                 $postQueries .= sprintf(
<a name="l00305"></a>00305                     <span class="stringliteral">&quot;EXECUTE sp_RENAME &#39;%s.%s&#39;, &#39;%s&#39;, &#39;COLUMN&#39;;&quot;</span>,
<a name="l00306"></a>00306                     $this-&gt;conn-&gt;quoteIdentifier($name),
<a name="l00307"></a>00307                     $renamedField,
<a name="l00308"></a>00308                     $this-&gt;conn-&gt;quoteIdentifier($field[<span class="stringliteral">&#39;name&#39;</span>], <span class="keyword">true</span>)
<a name="l00309"></a>00309                 );
<a name="l00310"></a>00310             }
<a name="l00311"></a>00311         }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         <span class="keywordflow">if</span> ( ! $query &amp;&amp; ! $postQueries) {
<a name="l00314"></a>00314             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00315"></a>00315         }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         $name = $this-&gt;conn-&gt;quoteIdentifier($name, <span class="keyword">true</span>);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         $finalQuery = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00320"></a>00320         <span class="keywordflow">if</span> ($query) {
<a name="l00321"></a>00321             $finalQuery .= <span class="stringliteral">&#39;ALTER TABLE &#39;</span> . $name . <span class="charliteral">&#39; &#39;</span> . trim($query) . <span class="charliteral">&#39;;&#39;</span>;
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         <span class="keywordflow">if</span> ($postQueries) {
<a name="l00325"></a>00325             $finalQuery .= $postQueries;
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">return</span> $this-&gt;conn-&gt;exec($finalQuery);
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00344"></a><a class="code" href="classDoctrine__Export__Mssql.html#a96bfbf12bb0b49758116b6a44b0b1ad3">00344</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a96bfbf12bb0b49758116b6a44b0b1ad3" title="create sequence">createSequence</a>($seqName, $start = 1, array $options = array())
<a name="l00345"></a>00345     {
<a name="l00346"></a>00346         $sequenceName = $this-&gt;conn-&gt;quoteIdentifier($this-&gt;conn-&gt;getSequenceName($seqName), <span class="keyword">true</span>);
<a name="l00347"></a>00347         $seqcolName = $this-&gt;conn-&gt;quoteIdentifier($this-&gt;conn-&gt;options[<span class="stringliteral">&#39;seqcol_name&#39;</span>], <span class="keyword">true</span>);
<a name="l00348"></a>00348         $query = <span class="stringliteral">&#39;CREATE TABLE &#39;</span> . $sequenceName . <span class="stringliteral">&#39; (&#39;</span> . $seqcolName .
<a name="l00349"></a>00349                  <span class="stringliteral">&#39; INT PRIMARY KEY CLUSTERED IDENTITY(&#39;</span> . $start . <span class="stringliteral">&#39;, 1) NOT NULL)&#39;</span>;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         $res = $this-&gt;conn-&gt;exec($query);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="keywordflow">if</span> ($start == 1) {
<a name="l00354"></a>00354             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         <span class="keywordflow">try</span> {
<a name="l00358"></a>00358             $query = <span class="stringliteral">&#39;SET IDENTITY_INSERT &#39;</span> . $sequenceName . <span class="stringliteral">&#39; ON &#39;</span> .
<a name="l00359"></a>00359                      <span class="stringliteral">&#39;INSERT INTO &#39;</span> . $sequenceName . <span class="stringliteral">&#39; (&#39;</span> . $seqcolName . <span class="stringliteral">&#39;) VALUES ( &#39;</span> . $start . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00360"></a>00360             $res = $this-&gt;conn-&gt;exec($query);
<a name="l00361"></a>00361         } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00362"></a>00362             $result = $this-&gt;conn-&gt;exec(<span class="stringliteral">&#39;DROP TABLE &#39;</span> . $sequenceName);
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 
<a name="l00373"></a><a class="code" href="classDoctrine__Export__Mssql.html#a65ef0cab8efb5016fefb7c0f811a49a0">00373</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a65ef0cab8efb5016fefb7c0f811a49a0" title="This function drops an existing sequence.">dropSequenceSql</a>($seqName)
<a name="l00374"></a>00374     {
<a name="l00375"></a>00375         $sequenceName = $this-&gt;conn-&gt;quoteIdentifier($this-&gt;conn-&gt;getSequenceName($seqName), <span class="keyword">true</span>);
<a name="l00376"></a>00376         <span class="keywordflow">return</span> <span class="stringliteral">&#39;DROP TABLE &#39;</span> . $sequenceName;
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378 
<a name="l00407"></a><a class="code" href="classDoctrine__Export__Mssql.html#aa3668ff58ba11eac977b5c4d3ce5f7b9">00407</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#aa3668ff58ba11eac977b5c4d3ce5f7b9" title="create a new table">createTableSql</a>($name, array $fields, array $options = array())
<a name="l00408"></a>00408     {
<a name="l00409"></a>00409         <span class="keywordflow">if</span> ( ! $name) {
<a name="l00410"></a>00410             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Export__Exception.html">Doctrine_Export_Exception</a>(<span class="stringliteral">&#39;no valid table name specified&#39;</span>);
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         <span class="keywordflow">if</span> (empty($fields)) {
<a name="l00414"></a>00414             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Export__Exception.html">Doctrine_Export_Exception</a>(<span class="stringliteral">&#39;no fields specified for table &#39;</span> . $name);
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <span class="comment">// Use field declaration of primary if the primary option not set</span>
<a name="l00418"></a>00418         <span class="keywordflow">if</span> ( ! isset($options[<span class="stringliteral">&#39;primary&#39;</span>])) {
<a name="l00419"></a>00419             <span class="keywordflow">foreach</span> ($fields as $fieldName =&gt; $fieldData) {
<a name="l00420"></a>00420                 <span class="keywordflow">if</span> (isset($fieldData[<span class="stringliteral">&#39;primary&#39;</span>]) &amp;&amp; $fieldData[<span class="stringliteral">&#39;primary&#39;</span>]) {
<a name="l00421"></a>00421                     $options[<span class="stringliteral">&#39;primary&#39;</span>][$fieldName] = $fieldName;
<a name="l00422"></a>00422                 }
<a name="l00423"></a>00423             }
<a name="l00424"></a>00424         }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;primary&#39;</span>])) {
<a name="l00427"></a>00427             <span class="keywordflow">foreach</span> ($options[<span class="stringliteral">&#39;primary&#39;</span>] as $fieldName) {
<a name="l00428"></a>00428                 <span class="keywordflow">if</span> (isset($fields[$fieldName])) {
<a name="l00429"></a>00429                     $fields[$fieldName][<span class="stringliteral">&#39;notnull&#39;</span>] = <span class="keyword">true</span>; <span class="comment">//Silently forcing NOT NULL as MSSQL will kill a query that has a nullable PK</span>
<a name="l00430"></a>00430                 }
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         $queryFields = $this-&gt;<a class="code" href="classDoctrine__Export.html#ae15e0ddf6a9d6e297c46fad8944fb52d" title="Get declaration of a number of field in bulk.">getFieldDeclarationList</a>($fields);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;primary&#39;</span>]) &amp;&amp; ! empty($options[<span class="stringliteral">&#39;primary&#39;</span>])) {
<a name="l00437"></a>00437             $primaryKeys = array_map(array($this-&gt;conn, <span class="stringliteral">&#39;quoteIdentifier&#39;</span>), array_values($options[<span class="stringliteral">&#39;primary&#39;</span>]));
<a name="l00438"></a>00438             $queryFields .= <span class="stringliteral">&#39;, PRIMARY KEY(&#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $primaryKeys) . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         $query = <span class="stringliteral">&#39;CREATE TABLE &#39;</span> . $this-&gt;conn-&gt;quoteIdentifier($name, <span class="keyword">true</span>) . <span class="stringliteral">&#39; (&#39;</span> . $queryFields;
<a name="l00442"></a>00442         
<a name="l00443"></a>00443         $check = $this-&gt;<a class="code" href="classDoctrine__Export.html#a8f21e68c76623c450d33e37ab2a7bd35" title="Obtain DBMS specific SQL code portion needed to set a CHECK constraint declaration...">getCheckDeclaration</a>($fields);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="keywordflow">if</span> ( ! empty($check)) {
<a name="l00446"></a>00446             $query .= <span class="stringliteral">&#39;, &#39;</span> . $check;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         $query .= <span class="charliteral">&#39;)&#39;</span>;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451         $sql[] = $query;
<a name="l00452"></a>00452         
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;indexes&#39;</span>]) &amp;&amp; ! empty($options[<span class="stringliteral">&#39;indexes&#39;</span>])) {
<a name="l00454"></a>00454             <span class="keywordflow">foreach</span>($options[<span class="stringliteral">&#39;indexes&#39;</span>] as $index =&gt; $definition) {
<a name="l00455"></a>00455                 <span class="keywordflow">if</span> (is_array($definition)) {
<a name="l00456"></a>00456                     $sql[] = $this-&gt;<a class="code" href="classDoctrine__Export.html#afb5f8a3436c0a389a5c167e53a59937e" title="Get the stucture of a field into an array.">createIndexSql</a>($name,$index, $definition);
<a name="l00457"></a>00457                 }
<a name="l00458"></a>00458             }
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460         
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;foreignKeys&#39;</span>])) {
<a name="l00462"></a>00462             <span class="keywordflow">foreach</span> ((array) $options[<span class="stringliteral">&#39;foreignKeys&#39;</span>] as $k =&gt; $definition) {
<a name="l00463"></a>00463                 <span class="keywordflow">if</span> (is_array($definition)) {
<a name="l00464"></a>00464                     $sql[] = $this-&gt;<a class="code" href="classDoctrine__Export.html#a1354224500138f0e1874c25ef59045e6" title="createForeignKeySql">createForeignKeySql</a>($name, $definition);
<a name="l00465"></a>00465                 }
<a name="l00466"></a>00466             }
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="keywordflow">return</span> $sql;
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 
<a name="l00480"></a><a class="code" href="classDoctrine__Export__Mssql.html#ad0613d9dd08dc45f7b797a6f02c6deed">00480</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#ad0613d9dd08dc45f7b797a6f02c6deed" title="getNotNullFieldDeclaration Obtain DBMS specific SQL code portion needed to set a...">getNotNullFieldDeclaration</a>(array $definition)
<a name="l00481"></a>00481     {
<a name="l00482"></a>00482         <span class="keywordflow">return</span> (
<a name="l00483"></a>00483             (isset($definition[<span class="stringliteral">&#39;notnull&#39;</span>]) &amp;&amp; $definition[<span class="stringliteral">&#39;notnull&#39;</span>]) || 
<a name="l00484"></a>00484             (isset($definition[<span class="stringliteral">&#39;primary&#39;</span>]) &amp;&amp; $definition[<span class="stringliteral">&#39;primary&#39;</span>])
<a name="l00485"></a>00485         ) ? <span class="stringliteral">&#39; NOT NULL&#39;</span> : <span class="stringliteral">&#39; NULL&#39;</span>;
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487 
<a name="l00494"></a><a class="code" href="classDoctrine__Export__Mssql.html#a8469db30b62b5f977e3d5592ca539401">00494</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Export__Mssql.html#a8469db30b62b5f977e3d5592ca539401">getDefaultFieldDeclaration</a>($field)
<a name="l00495"></a>00495     {
<a name="l00496"></a>00496         $default = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;default&#39;</span>, $field)) {
<a name="l00499"></a>00499             <span class="keywordflow">if</span> ($field[<span class="stringliteral">&#39;default&#39;</span>] === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00500"></a>00500                 $field[<span class="stringliteral">&#39;default&#39;</span>] = empty($field[<span class="stringliteral">&#39;notnull&#39;</span>])
<a name="l00501"></a>00501                     ? null : $this-&gt;valid_default_values[$field[<span class="stringliteral">&#39;type&#39;</span>]];
<a name="l00502"></a>00502 
<a name="l00503"></a>00503                 <span class="keywordflow">if</span> ($field[<span class="stringliteral">&#39;default&#39;</span>] === <span class="stringliteral">&#39;&#39;</span> &amp;&amp;
<a name="l00504"></a>00504                    ($this-&gt;conn-&gt;getAttribute(Doctrine_Core::ATTR_PORTABILITY) &amp; <a class="code" href="classDoctrine__Core.html#a77b44584e283186b6ff6b69072f245cd" title="Portability: convert empty values to null strings in data output by query*() and...">Doctrine_Core::PORTABILITY_EMPTY_TO_NULL</a>)) {
<a name="l00505"></a>00505                     $field[<span class="stringliteral">&#39;default&#39;</span>] = null;
<a name="l00506"></a>00506                 }
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509             <span class="keywordflow">if</span> ($field[<span class="stringliteral">&#39;type&#39;</span>] === <span class="stringliteral">&#39;boolean&#39;</span>) {
<a name="l00510"></a>00510                 $field[<span class="stringliteral">&#39;default&#39;</span>] = $this-&gt;conn-&gt;convertBooleans($field[<span class="stringliteral">&#39;default&#39;</span>]);
<a name="l00511"></a>00511             }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513             <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;defaultConstraintName&#39;</span>, $field)) {
<a name="l00514"></a>00514                 $default .= <span class="stringliteral">&#39; CONSTRAINT &#39;</span> . $field[<span class="stringliteral">&#39;defaultConstraintName&#39;</span>];
<a name="l00515"></a>00515             }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517             $default .= <span class="stringliteral">&#39; DEFAULT &#39;</span> . (is_null($field[<span class="stringliteral">&#39;default&#39;</span>])
<a name="l00518"></a>00518                 ? <span class="stringliteral">&#39;NULL&#39;</span>
<a name="l00519"></a>00519                 : $this-&gt;conn-&gt;quote($field[<span class="stringliteral">&#39;default&#39;</span>], $field[<span class="stringliteral">&#39;type&#39;</span>]));
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         
<a name="l00522"></a>00522         <span class="keywordflow">return</span> $default;
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
