<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/modules/scenario/actions/actions.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/modules/scenario/actions/actions.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00016"></a><a class="code" href="classscenarioActions.html">00016</a> <span class="keyword">class </span><a class="code" href="classscenarioActions.html" title="extends agActions for scenario">scenarioActions</a> <span class="keyword">extends</span> <a class="code" href="classagActions.html" title="extends sfActions for common functionality">agActions</a>
<a name="l00017"></a>00017 {
<a name="l00018"></a>00018 
<a name="l00019"></a>00019   <span class="keyword">protected</span> $_search = <span class="stringliteral">&#39;scenario&#39;</span>;
<a name="l00020"></a>00020   <span class="keyword">public</span> <span class="keyword">static</span> $scenario_id;
<a name="l00021"></a>00021   <span class="keyword">public</span> <span class="keyword">static</span> $scenarioName;
<a name="l00022"></a>00022   <span class="keyword">public</span> <span class="keyword">static</span> $wizardOp;
<a name="l00023"></a>00023 
<a name="l00029"></a><a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8">00029</a>   <span class="keyword">protected</span> function <a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request)
<a name="l00030"></a>00030   {
<a name="l00031"></a>00031     $this-&gt;scenario_id = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>);
<a name="l00032"></a>00032     $this-&gt;scenarioName = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)-&gt;find($this-&gt;scenario_id)-&gt;scenario;
<a name="l00033"></a>00033   }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035   <span class="keyword">protected</span> function wizardHandler(sfWebRequest $request, $step = null)
<a name="l00036"></a>00036   {
<a name="l00037"></a>00037     $encodedWizard = $request-&gt;getCookie(<span class="stringliteral">&#39;wizardOp&#39;</span>); <span class="comment">//we stil want to keep the cookie get/set</span>
<a name="l00038"></a>00038     <span class="comment">//methods incase the frontend shorts something</span>
<a name="l00039"></a>00039     $wizardOp = json_decode($encodedWizard, <span class="keyword">true</span>);
<a name="l00040"></a>00040     $wizardOp[<span class="stringliteral">&#39;scenario_id&#39;</span>] = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>);
<a name="l00041"></a>00041     <span class="keywordflow">if</span> (!isset($wizardOp[<span class="stringliteral">&#39;step&#39;</span>]))
<a name="l00042"></a>00042       $wizardOp[<span class="stringliteral">&#39;step&#39;</span>] = 1;
<a name="l00043"></a>00043     <span class="keywordflow">if</span> ($step != null)
<a name="l00044"></a>00044       $wizardOp[<span class="stringliteral">&#39;step&#39;</span>] = $step;
<a name="l00045"></a>00045     $this-&gt;wizard = <span class="keyword">new</span> <a class="code" href="classagScenarioWizard.html" title="Agasti Scenario Wizard Class - A class to generate and control a workflow.">agScenarioWizard</a>($wizardOp);
<a name="l00046"></a>00046     $this-&gt;wizardDiv = $this-&gt;wizard-&gt;getList();
<a name="l00047"></a>00047   }
<a name="l00048"></a>00048 
<a name="l00054"></a><a class="code" href="classscenarioActions.html#a265fa60b3b67fc0791c5cb819cead934">00054</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a265fa60b3b67fc0791c5cb819cead934">executeList</a>(sfWebRequest $request)
<a name="l00055"></a>00055   {
<a name="l00056"></a>00056     <span class="comment">// we use the get parameters to manage most of this action&#39;s methods</span>
<a name="l00057"></a>00057     $this-&gt;listParams = $request-&gt;getGetParameters();
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <span class="comment">// here are the post params we&#39;re looking for</span>
<a name="l00060"></a>00060     <span class="keywordflow">if</span> ($request-&gt;getPostParameter(<span class="stringliteral">&#39;query&#39;</span>)) {
<a name="l00061"></a>00061 
<a name="l00062"></a>00062       <span class="comment">// if found, we trigger our redirect and add it to our listParams</span>
<a name="l00063"></a>00063       $param = str_replace(<span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;%&#39;</span>, strtolower(trim($request-&gt;getPostParameter(<span class="stringliteral">&#39;query&#39;</span>))));
<a name="l00064"></a>00064 
<a name="l00065"></a>00065       <span class="comment">// merge the results together</span>
<a name="l00066"></a>00066       $this-&gt;listParams = array_merge($this-&gt;listParams, array($postParam =&gt; $param));
<a name="l00067"></a>00067 
<a name="l00068"></a>00068       <span class="comment">// if a post was found we redirect and add everything via http_build_query</span>
<a name="l00069"></a>00069       $this-&gt;redirect(($this-&gt;moduleName . <span class="charliteral">&#39;/&#39;</span> . $this-&gt;actionName . <span class="charliteral">&#39;?&#39;</span> .
<a name="l00070"></a>00070         http_build_query($this-&gt;listParams)));
<a name="l00071"></a>00071     }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00074"></a>00074         -&gt;select(<span class="stringliteral">&#39;a.*, b.*&#39;</span>)
<a name="l00075"></a>00075         -&gt;from(<span class="stringliteral">&#39;agScenario a, a.agScenarioFacilityGroup b&#39;</span>);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="keywordflow">if</span> (isset($this-&gt;listParams[<span class="stringliteral">&#39;query&#39;</span>])) {
<a name="l00078"></a>00078       $q-&gt;where(<span class="stringliteral">&#39;a.scenario LIKE ?&#39;</span>, array( <span class="charliteral">&#39;%&#39;</span> . $this-&gt;listParams[<span class="stringliteral">&#39;query&#39;</span>] . <span class="charliteral">&#39;%&#39;</span>));
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     $this-&gt;ag_scenarios = $q-&gt;execute();
<a name="l00082"></a>00082   }
<a name="l00083"></a>00083 
<a name="l00089"></a><a class="code" href="classscenarioActions.html#ae453fa769e73a49270efcfaa4a0c6a2f">00089</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#ae453fa769e73a49270efcfaa4a0c6a2f">executeListgroup</a>(sfWebRequest $request)
<a name="l00090"></a>00090   {
<a name="l00091"></a>00091     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00092"></a>00092     $this-&gt;wizardHandler($request, 3);
<a name="l00093"></a>00093     $this-&gt;ag_scenario_facility_groups = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00094"></a>00094         -&gt;select(<span class="stringliteral">&#39;a.*, afr.*, afgt.*, afgas.*, fr.*&#39;</span>)
<a name="l00095"></a>00095         -&gt;from(
<a name="l00096"></a>00096             <span class="stringliteral">&#39;agScenarioFacilityGroup a,</span>
<a name="l00097"></a>00097 <span class="stringliteral">                  a.agScenarioFacilityResource afr,</span>
<a name="l00098"></a>00098 <span class="stringliteral">                  a.agFacilityGroupType afgt,</span>
<a name="l00099"></a>00099 <span class="stringliteral">                  a.agFacilityGroupAllocationStatus afgas,</span>
<a name="l00100"></a>00100 <span class="stringliteral">                  a.agFacilityResource fr&#39;</span>
<a name="l00101"></a>00101         )
<a name="l00102"></a>00102         -&gt;where(<span class="stringliteral">&#39;a.scenario_id = ?&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))
<a name="l00103"></a>00103         -&gt;execute();
<a name="l00104"></a>00104     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenarioName . <span class="stringliteral">&#39; Scenario Facility Groups&#39;</span>);
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106 
<a name="l00113"></a><a class="code" href="classscenarioActions.html#a591b9549e3417958cbeb6c259a93a677">00113</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a591b9549e3417958cbeb6c259a93a677" title="executeListshifttemplate() List of scenario with defined shift templates and the...">executeListshifttemplate</a>(sfWebRequest $request)
<a name="l00114"></a>00114   {
<a name="l00115"></a>00115     $query = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agShiftTemplate&#39;</span>)
<a name="l00116"></a>00116         -&gt;createQuery(<span class="stringliteral">&#39;st&#39;</span>)
<a name="l00117"></a>00117         -&gt;select(<span class="stringliteral">&#39;st.scenario_id, s.scenario, count(*) AS count&#39;</span>)
<a name="l00118"></a>00118         -&gt;innerJoin(<span class="stringliteral">&#39;st.agScenario AS s&#39;</span>)
<a name="l00119"></a>00119         -&gt;groupBy(<span class="stringliteral">&#39;st.scenario_id, s.scenario&#39;</span>);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00125"></a>00125     $this-&gt;pager = <span class="keyword">new</span> <a class="code" href="classsfDoctrinePager.html">sfDoctrinePager</a>(<span class="stringliteral">&#39;agShiftTemplate&#39;</span>, 10);
<a name="l00126"></a>00126 
<a name="l00131"></a>00131     $this-&gt;sortColumn = $request-&gt;getParameter(<span class="stringliteral">&#39;sort&#39;</span>) ? $request-&gt;getParameter(<span class="stringliteral">&#39;sort&#39;</span>) : <span class="stringliteral">&#39;scenario&#39;</span>;
<a name="l00132"></a>00132     $this-&gt;sortOrder = $request-&gt;getParameter(<span class="stringliteral">&#39;order&#39;</span>) ? $request-&gt;getParameter(<span class="stringliteral">&#39;order&#39;</span>) : <span class="stringliteral">&#39;ASC&#39;</span>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;sort&#39;</span>)) {
<a name="l00135"></a>00135       $query = $query-&gt;orderBy($request-&gt;getParameter(<span class="stringliteral">&#39;sort&#39;</span>, <span class="stringliteral">&#39;scenario&#39;</span>) . <span class="charliteral">&#39; &#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;order&#39;</span>,
<a name="l00136"></a>00136                                                                                                          <span class="stringliteral">&#39;ASC&#39;</span>));
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138 
<a name="l00143"></a>00143     $this-&gt;pager-&gt;setQuery($query);
<a name="l00144"></a>00144 
<a name="l00148"></a>00148     $this-&gt;pager-&gt;setPage($request-&gt;getParameter(<span class="stringliteral">&#39;page&#39;</span>, 1));
<a name="l00149"></a>00149     $this-&gt;pager-&gt;init();
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151 
<a name="l00159"></a><a class="code" href="classscenarioActions.html#a7bf63b7f0c83793f1ce5601a65ddecbe">00159</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a7bf63b7f0c83793f1ce5601a65ddecbe" title="Define Staff Resource Requirements for all facility groups in a scenario facility...">executeStaffresources</a>(sfWebRequest $request)
<a name="l00160"></a>00160   {
<a name="l00161"></a>00161     $formsArray = array();
<a name="l00162"></a>00162     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00163"></a>00163     $this-&gt;wizardHandler($request, 4);
<a name="l00164"></a>00164     <span class="comment">//the above should not fail.</span>
<a name="l00165"></a>00165     $this-&gt;scenario = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)
<a name="l00166"></a>00166         -&gt;findByDql(<span class="stringliteral">&#39;id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00167"></a>00167         -&gt;getFirst();
<a name="l00168"></a>00168     $this-&gt;ag_scenario_facility_group = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioFacilityGroup&#39;</span>)
<a name="l00169"></a>00169         -&gt;findByDql(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenario_id);
<a name="l00170"></a>00170     $this-&gt;ag_staff_resources = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00171"></a>00171         -&gt;select(<span class="stringliteral">&#39;agSFR.*&#39;</span>)
<a name="l00172"></a>00172         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityResource agSFR&#39;</span>)
<a name="l00173"></a>00173         -&gt;where(<span class="stringliteral">&#39;scenario_facility_group_id = ?&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))
<a name="l00174"></a>00174         -&gt;execute();
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST)) {
<a name="l00177"></a>00177       $facilityGroups = $request-&gt;getParameter(<span class="stringliteral">&#39;staff_resource&#39;</span>);
<a name="l00178"></a>00178       unset($facilityGroups[<span class="stringliteral">&#39;_csrf_token&#39;</span>]);
<a name="l00179"></a>00179 <span class="comment">//continuing workflow?</span>
<a name="l00180"></a>00180       <span class="keywordflow">if</span> ($this-&gt;ag_scenario_facility_group) {
<a name="l00181"></a>00181         <span class="keywordflow">foreach</span> ($facilityGroups as $facilityGroup) {
<a name="l00182"></a>00182           <span class="keywordflow">foreach</span> ($facilityGroup as $facility) {
<a name="l00183"></a>00183 <span class="comment">//are we editing or updating?</span>
<a name="l00184"></a>00184             <span class="keywordflow">foreach</span> ($facility as $facilityStaffResource) {
<a name="l00185"></a>00185               $existing = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00186"></a>00186                   -&gt;select(<span class="stringliteral">&#39;agFSR.*&#39;</span>)
<a name="l00187"></a>00187                   -&gt;from(<span class="stringliteral">&#39;agFacilityStaffResource agFSR&#39;</span>)
<a name="l00188"></a>00188                   -&gt;where(
<a name="l00189"></a>00189                       <span class="stringliteral">&#39;agFSR.staff_resource_type_id = ?&#39;</span>,
<a name="l00190"></a>00190                       $facilityStaffResource[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>]
<a name="l00191"></a>00191                   )
<a name="l00192"></a>00192                   -&gt;andWhere(
<a name="l00193"></a>00193                       <span class="stringliteral">&#39;agFSR.scenario_facility_resource_id = ?&#39;</span>,
<a name="l00194"></a>00194                       $facilityStaffResource[<span class="stringliteral">&#39;scenario_facility_resource_id&#39;</span>]
<a name="l00195"></a>00195                   )
<a name="l00196"></a>00196                   -&gt;fetchOne();
<a name="l00197"></a>00197               <span class="keywordflow">if</span> (!$existing) {
<a name="l00198"></a>00198                 $facilityStaffResourceForm = <span class="keyword">new</span> <a class="code" href="classagEmbeddedAgFacilityStaffResourceForm.html" title="agEmbeddedAgFacilityStaffResourceForm extends agFacilityStaffResourceForm.">agEmbeddedAgFacilityStaffResourceForm</a>($object = null, $options = array(), $CSRFSecret = <span class="keyword">false</span>);
<a name="l00199"></a>00199               } <span class="keywordflow">else</span> {
<a name="l00200"></a>00200                 $facilityStaffResourceForm = <span class="keyword">new</span> <a class="code" href="classagEmbeddedAgFacilityStaffResourceForm.html" title="agEmbeddedAgFacilityStaffResourceForm extends agFacilityStaffResourceForm.">agEmbeddedAgFacilityStaffResourceForm</a>($existing, $options = array(), $CSRFSecret = <span class="keyword">false</span>);
<a name="l00201"></a>00201               }
<a name="l00202"></a>00202               $facilityStaffResourceForm-&gt;bind($facilityStaffResource, null);
<a name="l00207"></a>00207               <span class="keywordflow">if</span> ($facilityStaffResourceForm-&gt;isValid() &amp;&amp; isset($facilityStaffResource[<span class="stringliteral">&#39;minimum_staff&#39;</span>]) &amp;&amp; isset($facilityStaffResource[<span class="stringliteral">&#39;maximum_staff&#39;</span>])) {
<a name="l00208"></a>00208                 $savedResources[] = $facilityStaffResourceForm-&gt;save();
<a name="l00209"></a>00209               } <span class="keywordflow">else</span> {
<a name="l00210"></a>00210                 $facilityStaffResourceForm-&gt;getObject()-&gt;delete();
<a name="l00211"></a>00211               }
<a name="l00212"></a>00212             }
<a name="l00213"></a>00213           }
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215       }
<a name="l00216"></a>00216 <span class="comment">//were there any changes?</span>
<a name="l00217"></a>00217       <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) {
<a name="l00218"></a>00218         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/staffpool?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l00219"></a>00219       } elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;Save&#39;</span>)) {
<a name="l00220"></a>00220         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/staffresources?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l00221"></a>00221       }
<a name="l00222"></a>00222 <span class="comment">//READ/LIST Present forms</span>
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">// Query to get all staff resource types.</span>
<a name="l00226"></a>00226     $dsrt = agScenarioResourceHelper::returnDefaultStaffResourceTypes($this-&gt;scenario_id);
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (count($dsrt) &gt; 0) {
<a name="l00228"></a>00228       $this-&gt;staffResourceTypes = $dsrt;
<a name="l00229"></a>00229     } <span class="keywordflow">else</span> {
<a name="l00230"></a>00230       $this-&gt;staffResourceTypes =
<a name="l00231"></a>00231           <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00232"></a>00232           -&gt;select(<span class="stringliteral">&#39;srt.id, srt.staff_resource_type&#39;</span>)
<a name="l00233"></a>00233           -&gt;from(<span class="stringliteral">&#39;agStaffResourceType srt&#39;</span>)
<a name="l00234"></a>00234           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     $query = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00238"></a>00238       -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00239"></a>00239       -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">//      $currentPage = ($request-&gt;hasParameter(&#39;page&#39;)) ? $request-&gt;getParameter(&#39;page&#39;) : 1;</span>
<a name="l00242"></a>00242     <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;first&#39;</span>))
<a name="l00243"></a>00243     {
<a name="l00244"></a>00244       $currentPage = $request-&gt;getParameter(<span class="stringliteral">&#39;firstPage&#39;</span>);
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246     elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;previous&#39;</span>))
<a name="l00247"></a>00247     {
<a name="l00248"></a>00248       $currentPage = $request-&gt;getParameter(<span class="stringliteral">&#39;previousPage&#39;</span>);
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;next&#39;</span>))
<a name="l00251"></a>00251     {
<a name="l00252"></a>00252       $currentPage = $request-&gt;getParameter(<span class="stringliteral">&#39;nextPage&#39;</span>);
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254     elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;last&#39;</span>))
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256       $currentPage = $request-&gt;getParameter(<span class="stringliteral">&#39;lastPage&#39;</span>);
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     <span class="keywordflow">else</span>
<a name="l00259"></a>00259     {
<a name="l00260"></a>00260       $currentPage = 1;
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262     $resultsPerPage = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;staff_resource_requirements_per_page&#39;</span>);
<a name="l00263"></a>00263     $this-&gt;pager = <span class="keyword">new</span> <a class="code" href="classDoctrine__Pager.html">Doctrine_Pager</a>($query, $currentPage, $resultsPerPage);
<a name="l00264"></a>00264     $groups = $this-&gt;pager-&gt;execute();
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">foreach</span> ($groups as $scenarioFacilityGroup) {
<a name="l00267"></a>00267       $facilitygroups[] = $scenarioFacilityGroup;
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     $this-&gt;scenarioFacilityGroup = $facilitygroups;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordflow">foreach</span> ($this-&gt;scenarioFacilityGroup as $group) {
<a name="l00272"></a>00272       <span class="keywordflow">foreach</span> ($group-&gt;getAgScenarioFacilityResource() as $scenarioFacilityResource) {
<a name="l00273"></a>00273         <span class="keywordflow">foreach</span> ($this-&gt;staffResourceTypes as $srt) {
<a name="l00274"></a>00274           $subKey = $group[<span class="stringliteral">&#39;scenario_facility_group&#39;</span>];
<a name="l00275"></a>00275           $subSubKey = $scenarioFacilityResource-&gt;id;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="comment">//this existing check should be refactored to be more efficient</span>
<a name="l00279"></a>00279           $existing = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00280"></a>00280               -&gt;select(<span class="stringliteral">&#39;agFSR.*&#39;</span>)
<a name="l00281"></a>00281               -&gt;from(<span class="stringliteral">&#39;agFacilityStaffResource agFSR&#39;</span>)
<a name="l00282"></a>00282               -&gt;where(<span class="stringliteral">&#39;agFSR.staff_resource_type_id = ?&#39;</span>, $srt[<span class="stringliteral">&#39;srt_id&#39;</span>])
<a name="l00283"></a>00283               -&gt;andWhere(<span class="stringliteral">&#39;agFSR.scenario_facility_resource_id = ?&#39;</span>, $scenarioFacilityResource-&gt;id)
<a name="l00284"></a>00284               -&gt;fetchOne();
<a name="l00285"></a>00285 
<a name="l00286"></a>00286           <span class="keywordflow">if</span> ($existing) {
<a name="l00287"></a>00287             $formsArray[$subKey][$subSubKey][$srt[<span class="stringliteral">&#39;srt_staff_resource_type&#39;</span>]] =
<a name="l00288"></a>00288                 <span class="keyword">new</span> <a class="code" href="classagEmbeddedAgFacilityStaffResourceForm.html" title="agEmbeddedAgFacilityStaffResourceForm extends agFacilityStaffResourceForm.">agEmbeddedAgFacilityStaffResourceForm</a>($existing);
<a name="l00289"></a>00289           } <span class="keywordflow">else</span> {
<a name="l00290"></a>00290             $formsArray[$subKey][$subSubKey][$srt[<span class="stringliteral">&#39;srt_staff_resource_type&#39;</span>]] =
<a name="l00291"></a>00291                 <span class="keyword">new</span> <a class="code" href="classagEmbeddedAgFacilityStaffResourceForm.html" title="agEmbeddedAgFacilityStaffResourceForm extends agFacilityStaffResourceForm.">agEmbeddedAgFacilityStaffResourceForm</a>();
<a name="l00292"></a>00292           }
<a name="l00293"></a>00293           $facilityLabels[$subKey][$subSubKey] = $scenarioFacilityResource
<a name="l00294"></a>00294                   -&gt;getAgFacilityResource()
<a name="l00295"></a>00295                   -&gt;getAgFacility()-&gt;facility_name .
<a name="l00296"></a>00296               <span class="stringliteral">&#39;: &#39;</span> . ucwords($scenarioFacilityResource
<a name="l00297"></a>00297                       -&gt;getAgFacilityResource()
<a name="l00298"></a>00298                       -&gt;getAgFacilityResourceType()-&gt;facility_resource_type) .
<a name="l00299"></a>00299               <span class="stringliteral">&#39; (&#39;</span> . $scenarioFacilityResource
<a name="l00300"></a>00300                   -&gt;getAgFacilityResource()
<a name="l00301"></a>00301                   -&gt;getAgFacility()-&gt;facility_code . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00302"></a>00302           $formsArray[$subKey][$subSubKey][$srt[<span class="stringliteral">&#39;srt_staff_resource_type&#39;</span>]]-&gt;setDefault(<span class="stringliteral">&#39;scenario_facility_resource_id&#39;</span>,
<a name="l00303"></a>00303                                                                                         $scenarioFacilityResource-&gt;getId());
<a name="l00304"></a>00304           $formsArray[$subKey][$subSubKey][$srt[<span class="stringliteral">&#39;srt_staff_resource_type&#39;</span>]]-&gt;setDefault(<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>,
<a name="l00305"></a>00305                                                                                         $srt[<span class="stringliteral">&#39;srt_id&#39;</span>]);
<a name="l00306"></a>00306           <span class="comment">//$formsArray[$subKey]-&gt;setLabel($subSubKey, $subSubKeyLabel);</span>
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308       }
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     $this-&gt;formsArray = $formsArray;
<a name="l00312"></a>00312     
<a name="l00313"></a>00313     $this-&gt;facilityStaffResourceContainer = <span class="keyword">new</span> <a class="code" href="classagFacilityStaffResourceContainerForm.html" title="Provides embedded subform for editing facility resources.">agFacilityStaffResourceContainerForm</a>($formsArray,
<a name="l00314"></a>00314             $facilityLabels);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenario[<span class="stringliteral">&#39;scenario&#39;</span>] . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l00317"></a>00317   }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="comment">/*   * ***********************************************************************************************</span>
<a name="l00320"></a>00320 <span class="comment">   * This function will handle export facilities. It takes a scenario id as a param.</span>
<a name="l00321"></a>00321 <span class="comment">   * *********************************************************************************************** */</span>
<a name="l00322"></a>00322 
<a name="l00323"></a>00323   <span class="keyword">public</span> function executeFacilityexport(sfWebRequest $request)
<a name="l00324"></a>00324   {
<a name="l00325"></a>00325     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     $scenarioId = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     $facilityExporter = <span class="keyword">new</span> <a class="code" href="classagFacilityExporter.html" title="Export all facilities from the system.">agFacilityExporter</a>($scenarioId);
<a name="l00330"></a>00330     $exportResponse = $facilityExporter-&gt;export();
<a name="l00331"></a>00331     <span class="comment">// Free up some memory by getting rid of the agFacilityExporter object.</span>
<a name="l00332"></a>00332     unset($facilityExporter);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="comment">// check if the file exists</span>
<a name="l00336"></a>00336     $this-&gt;forward404Unless(file_exists($exportResponse[<span class="stringliteral">&#39;filePath&#39;</span>]));
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">// Make sure the browser doesn&#39;t try to deliver a chached version</span>
<a name="l00339"></a>00339     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&quot;Pragma&quot;</span>, <span class="stringliteral">&quot;public&quot;</span>);
<a name="l00340"></a>00340     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&quot;Expires&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l00341"></a>00341     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&quot;Cache-Control&quot;</span>, <span class="stringliteral">&quot;must-revalidate, post-check=0, pre-check=0&quot;</span>);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="comment">// Provide application and file info headers</span>
<a name="l00344"></a>00344     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&#39;Content-Type&#39;</span>, <span class="stringliteral">&#39;application/vnd.ms-excel&#39;</span>);
<a name="l00345"></a>00345     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&#39;Content-Disposition&#39;</span>, <span class="stringliteral">&#39;attachment;filename=&quot;&#39;</span> . $exportResponse[<span class="stringliteral">&#39;fileName&#39;</span>] . <span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l00346"></a>00346     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&quot;Content-Transfer-Encoding&quot;</span>, <span class="stringliteral">&quot;binary&quot;</span>);
<a name="l00347"></a>00347     $this-&gt;getResponse()-&gt;setHttpHeader(<span class="stringliteral">&quot;Content-Length&quot;</span>, <span class="stringliteral">&quot;&quot;</span> . filesize($exportResponse[<span class="stringliteral">&#39;filePath&#39;</span>]));
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     $this-&gt;getResponse()-&gt;sendHttpHeaders();
<a name="l00350"></a>00350     $this-&gt;getResponse()-&gt;setContent(file_get_contents($exportResponse[<span class="stringliteral">&#39;filePath&#39;</span>]));
<a name="l00351"></a>00351     $this-&gt;getResponse()-&gt;send();
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="keywordflow">return</span> sfView::NONE;
<a name="l00354"></a>00354   }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="comment">/*   * ***********************************************************************************************</span>
<a name="l00357"></a>00357 <span class="comment">   * This function will handle incoming facilities. Scenario ID comes in as a param.</span>
<a name="l00358"></a>00358 <span class="comment">   * setScenarioBasics() will use the $request and the ID contained within.</span>
<a name="l00359"></a>00359 <span class="comment">   * *********************************************************************************************** */</span>
<a name="l00360"></a>00360   <span class="keyword">public</span> function executeFacilityimport(sfWebRequest $request)
<a name="l00361"></a>00361   {
<a name="l00362"></a>00362     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00363"></a>00363     $this-&gt;returnPage = $this-&gt;getUser()-&gt;getAttribute(<span class="stringliteral">&#39;returnPage&#39;</span>);
<a name="l00364"></a>00364     $this-&gt;getUser()-&gt;getAttributeHolder()-&gt;remove(<span class="stringliteral">&#39;returnPage&#39;</span>);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     $this-&gt;forward404Unless($scenarioId = $this-&gt;scenario_id);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     $this-&gt;startTime = microtime(<span class="keyword">true</span>);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     $uploadedFile = $_FILES[<span class="stringliteral">&#39;import&#39;</span>];
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">//print(&quot;&lt;pre&gt;&quot; . print_r($_FILES, true) . &quot;&lt;/pre&gt;&quot;);</span>
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     $this-&gt;importPath = sfConfig::get(<span class="stringliteral">&#39;sf_upload_dir&#39;</span>) . DIRECTORY_SEPARATOR . $uploadedFile[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (!move_uploaded_file($uploadedFile[<span class="stringliteral">&#39;tmp_name&#39;</span>], $this-&gt;importPath)) {
<a name="l00378"></a>00378       <span class="keywordflow">return</span> sfView::ERROR;
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380     <span class="comment">//$this-&gt;dispatcher-&gt;notify(new sfEvent($this, &#39;import.start&#39;));</span>
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     $this-&gt;importer = <a class="code" href="classagFacilityImportNormalization.html#a61fb83f1c8477f4d42c995ecaa5e7c48" title="Method to return an instance of this class.">agFacilityImportNormalization::getInstance</a>($scenarioId, NULL, agEventHandler::EVENT_NOTICE);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     $this-&gt;importer-&gt;processXlsImportFile($this-&gt;importPath);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     $left = 1;
<a name="l00387"></a>00387     <span class="keywordflow">while</span> ($left &gt; 0) {
<a name="l00388"></a>00388       $left = $this-&gt;importer-&gt;processBatch();
<a name="l00389"></a>00389       <span class="comment">// print_r($left);</span>
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391     $iterData = $this-&gt;importer-&gt;getIterData();
<a name="l00392"></a>00392     $this-&gt;totalRecords = $iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>];
<a name="l00393"></a>00393     $this-&gt;successful = $iterData[<span class="stringliteral">&#39;processedSuccessful&#39;</span>];
<a name="l00394"></a>00394     $this-&gt;failed = $iterData[<span class="stringliteral">&#39;processedFailed&#39;</span>] + $iterData[<span class="stringliteral">&#39;tempErrCt&#39;</span>];
<a name="l00395"></a>00395     $this-&gt;unprocessed = $iterData[<span class="stringliteral">&#39;unprocessed&#39;</span>];
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment">// Report elapsed time</span>
<a name="l00398"></a>00398     $this-&gt;endTime = microtime(<span class="keyword">true</span>);
<a name="l00399"></a>00399     $time = mktime(0, 0, round(($this-&gt;endTime - $this-&gt;startTime), 0), 0, 0, 2000);
<a name="l00400"></a>00400     $this-&gt;importTime = date(<span class="stringliteral">&quot;H:i:s&quot;</span>, $time);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="comment">// Get the memory usage</span>
<a name="l00403"></a>00403     $peakMemory = $this-&gt;importer-&gt;getPeakMemoryUsage();
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="comment">// Format memory</span>
<a name="l00406"></a>00406     $bytes = array(<span class="stringliteral">&#39;KB&#39;</span>, <span class="stringliteral">&#39;KB&#39;</span>, <span class="stringliteral">&#39;MB&#39;</span>, <span class="stringliteral">&#39;GB&#39;</span>, <span class="stringliteral">&#39;TB&#39;</span>);
<a name="l00407"></a>00407     <span class="keywordflow">if</span> ($peakMemory &lt;= 999) {
<a name="l00408"></a>00408       $peakMemory = 1;
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="keywordflow">for</span> ($i = 0; $peakMemory &gt; 999; $i++) {
<a name="l00411"></a>00411       $peakMemory /= 1024;
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413     $this-&gt;peakMemory = ceil($peakMemory) . <span class="stringliteral">&quot; &quot;</span> . $bytes[$i];
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="comment">// close out import components and create an xls if needed</span>
<a name="l00416"></a>00416     $this-&gt;importer-&gt;concludeImport();
<a name="l00417"></a>00417     $downloadFile = $this-&gt;importer-&gt;getUnprocessedXLS();
<a name="l00418"></a>00418     $this-&gt;unprocessedXLS = $downloadFile;
<a name="l00419"></a>00419   }
<a name="l00420"></a>00420 
<a name="l00425"></a><a class="code" href="classscenarioActions.html#ab4b27fb0861f8005700d06411e78384f">00425</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#ab4b27fb0861f8005700d06411e78384f" title="calls index template">executeIndex</a>(sfWebRequest $request)
<a name="l00426"></a>00426   {
<a name="l00427"></a>00427     $inputs = array(<span class="stringliteral">&#39;scenario_id&#39;</span> =&gt; <span class="keyword">new</span> <a class="code" href="classsfWidgetFormDoctrineChoice.html">sfWidgetFormDoctrineChoice</a>(array(<span class="stringliteral">&#39;model&#39;</span> =&gt; <span class="stringliteral">&#39;agScenario&#39;</span>, <span class="stringliteral">&#39;label&#39;</span> =&gt; <span class="stringliteral">&#39;scenario&#39;</span>, <span class="stringliteral">&#39;add_empty&#39;</span> =&gt; <span class="keyword">true</span>)),
<a name="l00428"></a>00428     );
<a name="l00429"></a>00429     <span class="comment">//set up inputs for form</span>
<a name="l00430"></a>00430     $this-&gt;filterForm = <span class="keyword">new</span> <a class="code" href="classsfForm.html">sfForm</a>();
<a name="l00431"></a>00431     <span class="keywordflow">foreach</span> ($inputs as $key =&gt; $input) {
<a name="l00432"></a>00432       $input-&gt;setAttribute(<span class="stringliteral">&#39;class&#39;</span>, <span class="stringliteral">&#39;filter&#39;</span>);
<a name="l00433"></a>00433       $this-&gt;filterForm-&gt;setWidget($key, $input);
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435   }
<a name="l00436"></a>00436 
<a name="l00441"></a><a class="code" href="classscenarioActions.html#a3b9d2737bf5f511c84b82dbd4518a668">00441</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a3b9d2737bf5f511c84b82dbd4518a668" title="calls up the review confirmation at end of the Scenario Creator">executeReview</a>(sfWebRequest $request)
<a name="l00442"></a>00442   {
<a name="l00443"></a>00443     $this-&gt;getUser()-&gt;setAttribute(<span class="stringliteral">&#39;returnPage&#39;</span>, <span class="stringliteral">&#39;scenarioReview&#39;</span>);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="keywordflow">if</span> ($this-&gt;scenario_id = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)) {
<a name="l00446"></a>00446       <span class="keywordflow">if</span> ($request-&gt;getCookie(<span class="stringliteral">&#39;wizardOp&#39;</span>)) {
<a name="l00447"></a>00447         $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00448"></a>00448         $this-&gt;wizardHandler($request, 8);
<a name="l00449"></a>00449       }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451       $this-&gt;scenario_name = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)-&gt;find($this-&gt;scenario_id)-&gt;getScenario();
<a name="l00452"></a>00452       $this-&gt;scenario_description = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)-&gt;find($this-&gt;scenario_id)-&gt;getDescription();
<a name="l00453"></a>00453 
<a name="l00454"></a>00454       <span class="comment">// default resource types</span>
<a name="l00455"></a>00455       $this-&gt;staffResourceTypeCt = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00456"></a>00456           -&gt;select(<span class="stringliteral">&#39;COUNT(dssrt.id)&#39;</span>)
<a name="l00457"></a>00457           -&gt;from(<span class="stringliteral">&#39;agDefaultScenarioStaffResourceType dssrt&#39;</span>)
<a name="l00458"></a>00458           -&gt;where(<span class="stringliteral">&#39;dssrt.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00459"></a>00459           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00460"></a>00460       <span class="keywordflow">if</span> (empty($this-&gt;staffResourceTypeCt)) {
<a name="l00461"></a>00461         $this-&gt;staffResourceTypeCt = 0;
<a name="l00462"></a>00462       }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464       $this-&gt;facilityResourceTypeCt = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00465"></a>00465           -&gt;select(<span class="stringliteral">&#39;COUNT(dsfrt.id)&#39;</span>)
<a name="l00466"></a>00466           -&gt;from(<span class="stringliteral">&#39;agDefaultScenarioFacilityResourceType dsfrt&#39;</span>)
<a name="l00467"></a>00467           -&gt;where(<span class="stringliteral">&#39;dsfrt.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00468"></a>00468           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00469"></a>00469       <span class="keywordflow">if</span> (empty($this-&gt;facilityResourceTypeCt)) {
<a name="l00470"></a>00470         $this-&gt;facilityResourceTypeCt = 0;
<a name="l00471"></a>00471       }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473       <span class="comment">// Facility groups</span>
<a name="l00474"></a>00474       $this-&gt;facilityGroups = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00475"></a>00475           -&gt;select(<span class="stringliteral">&#39;COUNT(sfg.id)&#39;</span>)
<a name="l00476"></a>00476           -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00477"></a>00477           -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00478"></a>00478           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00479"></a>00479       <span class="keywordflow">if</span> (empty($this-&gt;facilityGroups)) {
<a name="l00480"></a>00480         $this-&gt;facilityGroups = 0;
<a name="l00481"></a>00481       }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483       $this-&gt;facilities = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00484"></a>00484           -&gt;select(<span class="stringliteral">&#39;COUNT(sfr.id)&#39;</span>)
<a name="l00485"></a>00485           -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityResource sfr&#39;</span>)
<a name="l00486"></a>00486           -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00487"></a>00487           -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00488"></a>00488           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00489"></a>00489       <span class="keywordflow">if</span> (empty($this-&gt;facilities)) {
<a name="l00490"></a>00490         $this-&gt;facilities = 0;
<a name="l00491"></a>00491       }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493       <span class="comment">// resource requirements</span>
<a name="l00494"></a>00494       $this-&gt;completedResourceReqs = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00495"></a>00495           -&gt;select(<span class="stringliteral">&#39;COUNT(fsr.id)&#39;</span>)
<a name="l00496"></a>00496           -&gt;from(<span class="stringliteral">&#39;agFacilityStaffResource fsr&#39;</span>)
<a name="l00497"></a>00497           -&gt;innerJoin(<span class="stringliteral">&#39;fsr.agScenarioFacilityResource sfr&#39;</span>)
<a name="l00498"></a>00498           -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00499"></a>00499           -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00500"></a>00500           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00501"></a>00501       <span class="keywordflow">if</span> (empty($this-&gt;completedResourceReqs)) {
<a name="l00502"></a>00502         $this-&gt;completedResourceReqs = 0;
<a name="l00503"></a>00503       }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505       <span class="comment">// staff searches</span>
<a name="l00506"></a>00506       $this-&gt;staffSearches = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00507"></a>00507           -&gt;select(<span class="stringliteral">&#39;COUNT(ssg.id)&#39;</span>)
<a name="l00508"></a>00508           -&gt;from(<span class="stringliteral">&#39;agScenarioStaffGenerator ssg&#39;</span>)
<a name="l00509"></a>00509           -&gt;where(<span class="stringliteral">&#39;ssg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00510"></a>00510           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00511"></a>00511       <span class="keywordflow">if</span> (empty($this-&gt;staffSearches)) {
<a name="l00512"></a>00512         $this-&gt;staffSearches = 0;
<a name="l00513"></a>00513       }
<a name="l00514"></a>00514       <span class="comment">// @todo make a method on search helper to return counts and report that here as well</span>
<a name="l00515"></a>00515       <span class="comment">// shift templates</span>
<a name="l00516"></a>00516       $this-&gt;shiftTemplates = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00517"></a>00517           -&gt;select(<span class="stringliteral">&#39;COUNT(st.id)&#39;</span>)
<a name="l00518"></a>00518           -&gt;from(<span class="stringliteral">&#39;agShiftTemplate st&#39;</span>)
<a name="l00519"></a>00519           -&gt;where(<span class="stringliteral">&#39;st.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00520"></a>00520           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00521"></a>00521       <span class="keywordflow">if</span> (empty($this-&gt;shiftTemplates)) {
<a name="l00522"></a>00522         $this-&gt;shiftTemplates = 0;
<a name="l00523"></a>00523       }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525       <span class="comment">// shifts</span>
<a name="l00526"></a>00526       $shiftsData = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00527"></a>00527           -&gt;select(<span class="stringliteral">&#39;COUNT(ss.id) AS ctShifts&#39;</span>)
<a name="l00528"></a>00528           -&gt;addSelect(<span class="stringliteral">&#39;MIN(ss.minutes_start_to_facility_activation) AS minStart&#39;</span>)
<a name="l00529"></a>00529           -&gt;addSelect(<span class="stringliteral">&#39;MAX((ss.minutes_start_to_facility_activation + ss.task_length_minutes</span>
<a name="l00530"></a>00530 <span class="stringliteral">              + ss.break_length_minutes)) AS maxEnd&#39;</span>)
<a name="l00531"></a>00531           -&gt;from(<span class="stringliteral">&#39;agScenarioShift ss&#39;</span>)
<a name="l00532"></a>00532           -&gt;innerJoin(<span class="stringliteral">&#39;ss.agScenarioFacilityResource sfr&#39;</span>)
<a name="l00533"></a>00533           -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00534"></a>00534           -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00535"></a>00535           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537       <span class="keywordflow">if</span> (array_key_exists(0, $shiftsData)) {
<a name="l00538"></a>00538         $this-&gt;shifts = $shiftsData[0][<span class="stringliteral">&#39;ss_ctShifts&#39;</span>];
<a name="l00539"></a>00539         $this-&gt;operationTime = <a class="code" href="classagDateTimeHelper.html#a44f01e4076795c28e1d24eb7bfff56a1" title="Method to return a minutes figure as a string by day, hour, and minute.">agDateTimeHelper::minsToComponentsStr</a>(($shiftsData[0][<span class="stringliteral">&#39;ss_maxEnd&#39;</span>]
<a name="l00540"></a>00540                 - $shiftsData[0][<span class="stringliteral">&#39;ss_minStart&#39;</span>]), TRUE);
<a name="l00541"></a>00541       } <span class="keywordflow">else</span> {
<a name="l00542"></a>00542         $this-&gt;shifts = 0;
<a name="l00543"></a>00543         $this-&gt;operationTime = 0;
<a name="l00544"></a>00544       }
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 <span class="comment">//p-code</span>
<a name="l00547"></a>00547     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Review &#39;</span> . $this-&gt;scenario_name . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l00548"></a>00548 <span class="comment">//end p-code</span>
<a name="l00549"></a>00549   }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   <span class="keyword">public</span> function executePre(sfWebRequest $request)
<a name="l00552"></a>00552   {
<a name="l00553"></a>00553     
<a name="l00554"></a>00554   }
<a name="l00555"></a>00555 
<a name="l00562"></a><a class="code" href="classscenarioActions.html#a16042a6b2aed35ef2aca88eaaaef4e28">00562</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a16042a6b2aed35ef2aca88eaaaef4e28" title="set up the form to define staff pools, via saved search this function handles all...">executeStaffpool</a>(sfWebRequest $request)
<a name="l00563"></a>00563   {
<a name="l00564"></a>00564     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00565"></a>00565     $this-&gt;wizardHandler($request, 5);
<a name="l00566"></a>00566     $this-&gt;targetModule = <span class="stringliteral">&#39;staff&#39;</span>;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="comment">// Get all available staff counts</span>
<a name="l00569"></a>00569     $totalStaffCount = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00570"></a>00570             -&gt;select(<span class="stringliteral">&#39;count(*)&#39;</span>)
<a name="l00571"></a>00571               -&gt;from(<span class="stringliteral">&#39;agStaffResource sr&#39;</span>)
<a name="l00572"></a>00572                 -&gt;innerJoin(<span class="stringliteral">&#39;sr.agStaffResourceStatus srs&#39;</span>)
<a name="l00573"></a>00573               -&gt;where(<span class="stringliteral">&#39;srs.is_available = ?&#39;</span>, 1)
<a name="l00574"></a>00574             -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="comment">// Get staff counts who are assigned to the current scenario.</span>
<a name="l00577"></a>00577     $scenarioStaffCount = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00578"></a>00578       -&gt;select(<span class="stringliteral">&#39;count(*)&#39;</span>)
<a name="l00579"></a>00579         -&gt;from(<span class="stringliteral">&#39;agScenarioStaffResource ssr&#39;</span>)
<a name="l00580"></a>00580         -&gt;where(<span class="stringliteral">&#39;ssr.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00581"></a>00581         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <span class="comment">// Get staff counts who are assigned to the current scenario by their resource type.</span>
<a name="l00584"></a>00584     $this-&gt;scenarioStaffByResourceCount = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00585"></a>00585             -&gt;select(<span class="stringliteral">&#39;srt.staff_resource_type&#39;</span>)
<a name="l00586"></a>00586             -&gt;addSelect(<span class="stringliteral">&#39;count(*) AS staff_type_count&#39;</span>)
<a name="l00587"></a>00587             -&gt;from(<span class="stringliteral">&#39;agStaffResourceType srt&#39;</span>)
<a name="l00588"></a>00588             -&gt;innerJoin(<span class="stringliteral">&#39;srt.agStaffResource sr&#39;</span>)
<a name="l00589"></a>00589             -&gt;innerJoin(<span class="stringliteral">&#39;sr.agScenarioStaffResource ssr&#39;</span>)
<a name="l00590"></a>00590             -&gt;where(<span class="stringliteral">&#39;ssr.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00591"></a>00591             -&gt;groupBy(<span class="stringliteral">&#39;srt.id&#39;</span>)
<a name="l00592"></a>00592             -&gt;orderBy(<span class="stringliteral">&#39;srt.staff_resource_type&#39;</span>)
<a name="l00593"></a>00593             -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     $this-&gt;summaryCount = array(<span class="stringliteral">&#39;Total Staff Resource in System&#39;</span> =&gt; $totalStaffCount,
<a name="l00596"></a>00596                                 <span class="stringliteral">&#39;Staff Members in Pool&#39;</span> =&gt; $scenarioStaffCount);
<a name="l00597"></a>00597     <span class="comment">//$this-&gt;summaryCount = array(&#39;Total Staff in System&#39; =&gt; $totalStaffCount,</span>
<a name="l00598"></a>00598     <span class="comment">//                            &#39;Staff Members in Pool&#39; =&gt; $scenarioStaffCount);</span>
<a name="l00599"></a>00599     <span class="comment">//$this-&gt;summaryCount = $this-&gt;summaryCount + $scenarioStaffByResourceCount;</span>
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     <span class="comment">// Retrieve saved search objects</span>
<a name="l00602"></a>00602     $this-&gt;saved_searches = $existing = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00603"></a>00603         -&gt;select(<span class="stringliteral">&#39;ssg.*&#39;</span>)
<a name="l00604"></a>00604         -&gt;addSelect(<span class="stringliteral">&#39;s.*&#39;</span>)
<a name="l00605"></a>00605         -&gt;from(<span class="stringliteral">&#39;agScenarioStaffGenerator ssg&#39;</span>)
<a name="l00606"></a>00606         -&gt;innerJoin(<span class="stringliteral">&#39;ssg.agSearch s&#39;</span>)
<a name="l00607"></a>00607         -&gt;where(<span class="stringliteral">&#39;ssg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00608"></a>00608         -&gt;orderBy(<span class="stringliteral">&#39;ssg.search_weight DESC, s.search_name ASC&#39;</span>)
<a name="l00609"></a>00609         -&gt;execute();
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 <span class="comment">//EDIT</span>
<a name="l00612"></a>00612     <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;search_id&#39;</span>) &amp;&amp; !$request-&gt;hasParameter(<span class="stringliteral">&#39;Delete&#39;</span>) &amp;&amp; !$request-&gt;hasParameter(<span class="stringliteral">&#39;Preview&#39;</span>)) {
<a name="l00613"></a>00613       $searchWeight = NULL;
<a name="l00614"></a>00614       $this-&gt;search_id = $request-&gt;getParameter(<span class="stringliteral">&#39;search_id&#39;</span>);
<a name="l00615"></a>00615       $searchWeight = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00616"></a>00616             -&gt;select(<span class="stringliteral">&#39;search_weight&#39;</span>)
<a name="l00617"></a>00617                 -&gt;from(<span class="stringliteral">&#39;agScenarioStaffGenerator&#39;</span>)
<a name="l00618"></a>00618                 -&gt;where(<span class="stringliteral">&#39;search_id = ?&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;search_id&#39;</span>))
<a name="l00619"></a>00619               -&gt;andWhere(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00620"></a>00620               -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00621"></a>00621       $searchInfo = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00622"></a>00622             -&gt; select(<span class="stringliteral">&#39;search_name&#39;</span>)
<a name="l00623"></a>00623                 -&gt;addSelect(<span class="stringliteral">&#39;search_type_id&#39;</span>)
<a name="l00624"></a>00624                 -&gt;addSelect(<span class="stringliteral">&#39;search_condition&#39;</span>)
<a name="l00625"></a>00625               -&gt;from(<span class="stringliteral">&#39;agSearch s&#39;</span>)
<a name="l00626"></a>00626               -&gt;where(<span class="stringliteral">&#39;id = ?&#39;</span>, $this-&gt;search_id)
<a name="l00627"></a>00627               -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l00628"></a>00628         $search_name = $searchInfo[0][<span class="stringliteral">&#39;s_search_name&#39;</span>];
<a name="l00629"></a>00629         $search_type_id = $searchInfo[0][<span class="stringliteral">&#39;s_search_type_id&#39;</span>];
<a name="l00630"></a>00630         $search_condition = json_decode($searchInfo[0][<span class="stringliteral">&#39;s_search_condition&#39;</span>], <span class="keyword">true</span>);
<a name="l00631"></a>00631       <span class="keywordflow">if</span> (empty($searchWeight))
<a name="l00632"></a>00632       {
<a name="l00633"></a>00633         $this-&gt;poolform = <span class="keyword">new</span> <a class="code" href="classagStaffPoolForm.html" title="Agasti ag Staff Pool Form Class - A class to generate either a new staff pool form...">agStaffPoolForm</a>($this-&gt;search_id);
<a name="l00634"></a>00634       }
<a name="l00635"></a>00635       <span class="keywordflow">else</span>
<a name="l00636"></a>00636       {
<a name="l00637"></a>00637         $values = array(<span class="stringliteral">&#39;sg_values&#39;</span> =&gt; array(<span class="stringliteral">&#39;search_weight&#39;</span> =&gt; $searchWeight),
<a name="l00638"></a>00638                         <span class="stringliteral">&#39;s_values&#39;</span> =&gt; array(<span class="stringliteral">&#39;search_name&#39;</span> =&gt; $search_name,
<a name="l00639"></a>00639                                             <span class="stringliteral">&#39;search_type_id&#39;</span> =&gt; $search_type_id));
<a name="l00640"></a>00640         $this-&gt;poolform = <span class="keyword">new</span> <a class="code" href="classagStaffPoolForm.html" title="Agasti ag Staff Pool Form Class - A class to generate either a new staff pool form...">agStaffPoolForm</a>(null, $values);
<a name="l00641"></a>00641       }
<a name="l00642"></a>00642     } elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;Preview&#39;</span>)) {
<a name="l00643"></a>00643       $postParam = $request-&gt;getPostParameter(<span class="stringliteral">&#39;staff_pool&#39;</span>);
<a name="l00644"></a>00644       $search = $postParam[<span class="stringliteral">&#39;search&#39;</span>];
<a name="l00645"></a>00645       $search_condition = json_decode($search[<span class="stringliteral">&#39;search_condition&#39;</span>], <span class="keyword">true</span>);
<a name="l00646"></a>00646       $staff_generator = $postParam[<span class="stringliteral">&#39;staff_generator&#39;</span>];
<a name="l00647"></a>00647       $values = array(<span class="stringliteral">&#39;sg_values&#39;</span> =&gt;
<a name="l00648"></a>00648         array(<span class="stringliteral">&#39;search_weight&#39;</span> =&gt; $staff_generator[<span class="stringliteral">&#39;search_weight&#39;</span>]),
<a name="l00649"></a>00649         <span class="stringliteral">&#39;s_values&#39;</span> =&gt;
<a name="l00650"></a>00650         array(<span class="stringliteral">&#39;search_name&#39;</span> =&gt; $search[<span class="stringliteral">&#39;search_name&#39;</span>],
<a name="l00651"></a>00651           <span class="stringliteral">&#39;search_type_id&#39;</span> =&gt; $search[<span class="stringliteral">&#39;search_type_id&#39;</span>]));
<a name="l00652"></a>00652       $this-&gt;poolform = <span class="keyword">new</span> <a class="code" href="classagStaffPoolForm.html" title="Agasti ag Staff Pool Form Class - A class to generate either a new staff pool form...">agStaffPoolForm</a>(null, $values); <span class="comment">//construct our pool form with POST data</span>
<a name="l00653"></a>00653     } <span class="keywordflow">else</span> {
<a name="l00654"></a>00654       $this-&gt;poolform = <span class="keyword">new</span> <a class="code" href="classagStaffPoolForm.html" title="Agasti ag Staff Pool Form Class - A class to generate either a new staff pool form...">agStaffPoolForm</a>();
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656     $this-&gt;filterForm = <span class="keyword">new</span> <a class="code" href="classagStaffPoolFilterForm.html" title="Agasti Staff Pool Filter Form Class - A class to filter staff pool results.">agStaffPoolFilterForm</a>($this-&gt;scenario_id);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (isset($search_condition)) {
<a name="l00659"></a>00659       <span class="keywordflow">foreach</span> ($search_condition as $querypart) {
<a name="l00660"></a>00660         <span class="comment">//these search definitions should be stored in &#39;search type&#39; table maybe?</span>
<a name="l00661"></a>00661         <span class="keywordflow">if</span> ($querypart[<span class="stringliteral">&#39;field&#39;</span>] == <span class="stringliteral">&#39;agStaffResourceType.staff_resource_type&#39;</span>) {
<a name="l00662"></a>00662           $defaultValue = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()-&gt;select(<span class="stringliteral">&#39;id&#39;</span>)-&gt;from(<span class="stringliteral">&#39;agStaffResourceType&#39;</span>)
<a name="l00663"></a>00663                   -&gt;where(<span class="stringliteral">&#39;staff_resource_type=?&#39;</span>, $querypart[<span class="stringliteral">&#39;condition&#39;</span>])-&gt;execute(array(),
<a name="l00664"></a>00664                                                                                      <span class="stringliteral">&#39;single_value_array&#39;</span>);
<a name="l00665"></a>00665         } <span class="keywordflow">else</span> {
<a name="l00666"></a>00666           $defaultValue = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()-&gt;select(<span class="stringliteral">&#39;id&#39;</span>)-&gt;from(<span class="stringliteral">&#39;agOrganization&#39;</span>)
<a name="l00667"></a>00667                   -&gt;where(<span class="stringliteral">&#39;organization=?&#39;</span>, $querypart[<span class="stringliteral">&#39;condition&#39;</span>])-&gt;execute(array(),
<a name="l00668"></a>00668                                                                               <span class="stringliteral">&#39;single_value_array&#39;</span>);
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670         $this-&gt;filterForm-&gt;setDefault($querypart[<span class="stringliteral">&#39;field&#39;</span>], $defaultValue[0]);
<a name="l00671"></a>00671       }
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Delete&#39;</span>)) {
<a name="l00675"></a>00675 <span class="comment">//DELETE</span>
<a name="l00676"></a>00676       $deleteScenarioStaffGen = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00677"></a>00677         -&gt;delete(<span class="stringliteral">&#39;agScenarioStaffGenerator&#39;</span>)
<a name="l00678"></a>00678         -&gt;where(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00679"></a>00679         -&gt;andWhere(<span class="stringliteral">&#39;search_id = ?&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;search_id&#39;</span>))
<a name="l00680"></a>00680         -&gt;execute();
<a name="l00681"></a>00681       <a class="code" href="classagStaffGeneratorHelper.html#a975722e34edaa4f747bb8b394ee4f2d5" title="Method to generate a scenario staff pool using searches stored in the staff generator...">agStaffGeneratorHelper::generateStaffPool</a>($this-&gt;scenario_id);
<a name="l00682"></a>00682       $this-&gt;redirect(<span class="stringliteral">&#39;scenario/staffpool?id=&#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684 <span class="comment">//PREVIEW either from new search criteria or from saved searches</span>
<a name="l00685"></a>00685     elseif ( $request-&gt;hasParameter(<span class="stringliteral">&#39;Preview&#39;</span>) ||
<a name="l00686"></a>00686              ($request-&gt;hasParameter(<span class="stringliteral">&#39;search_id&#39;</span>) &amp;&amp;
<a name="l00687"></a>00687               !($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) &amp;&amp;
<a name="l00688"></a>00688               !($request-&gt;hasParameter(<span class="stringliteral">&#39;Save&#39;</span>))) )
<a name="l00689"></a>00689     {
<a name="l00690"></a>00690       $query = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00691"></a>00691           -&gt;select(<span class="stringliteral">&#39;agStaffResourceType.staff_resource_type&#39;</span>)
<a name="l00692"></a>00692               -&gt;addSelect(<span class="stringliteral">&#39;count(*) AS staff_type_count&#39;</span>)
<a name="l00693"></a>00693             -&gt;from(<span class="stringliteral">&#39;agStaffResource sr&#39;</span>)
<a name="l00694"></a>00694               -&gt;innerJoin(<span class="stringliteral">&#39;sr.agStaffResourceStatus srs&#39;</span>)
<a name="l00695"></a>00695               -&gt;innerJoin(<span class="stringliteral">&#39;sr.agStaffResourceType agStaffResourceType&#39;</span>)
<a name="l00696"></a>00696               -&gt;innerJoin(<span class="stringliteral">&#39;sr.agOrganization agOrganization&#39;</span>)
<a name="l00697"></a>00697             -&gt;where(<span class="stringliteral">&#39;srs.is_available = ?&#39;</span>, 1)
<a name="l00698"></a>00698             -&gt;groupBy(<span class="stringliteral">&#39;agStaffResourceType.id&#39;</span>)
<a name="l00699"></a>00699             -&gt;orderBy(<span class="stringliteral">&#39;agStaffResourceType.staff_resource_type&#39;</span>);
<a name="l00700"></a>00700       $query = <a class="code" href="classagStaffGeneratorHelper.html#a037fb5ddcde63d74c0b68abc5db8f779" title="Method to execute a preview search by simply passing the conditions array.">agStaffGeneratorHelper::executeStaffPreview</a>($query, $search_condition);
<a name="l00701"></a>00701       $this-&gt;previewStaffCountResults = $query-&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a36531882557012215d8b9024373239fa" title="HYDRATE_NONE.">Doctrine_Core::HYDRATE_NONE</a>);
<a name="l00702"></a>00702     }
<a name="l00703"></a>00703 <span class="comment">//SAVE</span>
<a name="l00704"></a>00704     elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;Save&#39;</span>) || $request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) { <span class="comment">//otherwise, we&#39;re SAVING/UPDATING</span>
<a name="l00705"></a>00705       <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;search_id&#39;</span>)) {
<a name="l00706"></a>00706         $this-&gt;search_id = $request-&gt;getParameter(<span class="stringliteral">&#39;search_id&#39;</span>);
<a name="l00707"></a>00707         $this-&gt;poolform = <span class="keyword">new</span> <a class="code" href="classagStaffPoolForm.html" title="Agasti ag Staff Pool Form Class - A class to generate either a new staff pool form...">agStaffPoolForm</a>($this-&gt;search_id); <span class="comment">//make sfForm with search_id</span>
<a name="l00708"></a>00708       } <span class="keywordflow">else</span> {
<a name="l00709"></a>00709         $this-&gt;poolform = <span class="keyword">new</span> <a class="code" href="classagStaffPoolForm.html" title="Agasti ag Staff Pool Form Class - A class to generate either a new staff pool form...">agStaffPoolForm</a>();
<a name="l00710"></a>00710       }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712       $this-&gt;poolform-&gt;scenario_id = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>);
<a name="l00713"></a>00713       $this-&gt;poolform-&gt;bind($request-&gt;getParameter($this-&gt;poolform-&gt;getName()),
<a name="l00714"></a>00714                                                    $request-&gt;getFiles($this-&gt;poolform-&gt;getName()));
<a name="l00715"></a>00715 
<a name="l00716"></a>00716       <span class="keywordflow">if</span> ($this-&gt;poolform-&gt;isValid()) {
<a name="l00717"></a>00717         $ag_staff_pool = $this-&gt;poolform-&gt;saveEmbeddedForms();
<a name="l00718"></a>00718       }
<a name="l00719"></a>00719       <a class="code" href="classagStaffGeneratorHelper.html#a975722e34edaa4f747bb8b394ee4f2d5" title="Method to generate a scenario staff pool using searches stored in the staff generator...">agStaffGeneratorHelper::generateStaffPool</a>($this-&gt;scenario_id);
<a name="l00720"></a>00720       <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) {
<a name="l00721"></a>00721         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/shifttemplates?id=&#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l00722"></a>00722       } <span class="keywordflow">else</span> {
<a name="l00723"></a>00723         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/staffpool?id=&#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l00724"></a>00724       }
<a name="l00725"></a>00725     }
<a name="l00726"></a>00726     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenarioName . <span class="stringliteral">&#39; Scenario Staff Pool&#39;</span>);
<a name="l00727"></a>00727   }
<a name="l00728"></a>00728 
<a name="l00734"></a><a class="code" href="classscenarioActions.html#a93e25065c82209120026ec3e4e4aec90">00734</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a93e25065c82209120026ec3e4e4aec90">executeGrouptype</a>(sfWebRequest $request)
<a name="l00735"></a>00735   {
<a name="l00736"></a>00736     $this-&gt;ag_facility_group_types = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)
<a name="l00737"></a>00737         -&gt;createQuery(<span class="charliteral">&#39;a&#39;</span>)
<a name="l00738"></a>00738         -&gt;execute();
<a name="l00739"></a>00739     $this-&gt;grouptypeform = <span class="keyword">new</span> <a class="code" href="classagFacilityGroupTypeForm.html" title="agFacilityGroupTypeForm.class.php extended base class.">agFacilityGroupTypeForm</a>();
<a name="l00740"></a>00740   }
<a name="l00741"></a>00741 
<a name="l00746"></a><a class="code" href="classscenarioActions.html#abd674cfb333ad10b6b51439ac6faf048">00746</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#abd674cfb333ad10b6b51439ac6faf048" title="sets up a new scenario meta information form">executeMeta</a>(sfWebRequest $request)
<a name="l00747"></a>00747   {
<a name="l00748"></a>00748     $this-&gt;wizardHandler($request, 1);
<a name="l00749"></a>00749     <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)) {
<a name="l00750"></a>00750       $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00751"></a>00751       $ag_scenario = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)-&gt;find(array($this-&gt;scenario_id));
<a name="l00752"></a>00752       $this-&gt;form = <span class="keyword">new</span> <a class="code" href="classagScenarioForm.html" title="extends BaseagScenarioForm">agScenarioForm</a>($ag_scenario);
<a name="l00753"></a>00753       $this-&gt;metaAction = <span class="stringliteral">&#39;Edit&#39;</span>;
<a name="l00754"></a>00754       $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenarioName . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l00755"></a>00755     } <span class="keywordflow">else</span> {
<a name="l00756"></a>00756       $this-&gt;metaAction = <span class="stringliteral">&#39;Create New&#39;</span>;
<a name="l00757"></a>00757       $this-&gt;form = <span class="keyword">new</span> <a class="code" href="classagScenarioForm.html" title="extends BaseagScenarioForm">agScenarioForm</a>();
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST)) {
<a name="l00760"></a>00760       $this-&gt;form-&gt;bind($request-&gt;getParameter($this-&gt;form-&gt;getName()),
<a name="l00761"></a>00761                                                $request-&gt;getFiles($this-&gt;form-&gt;getName()));
<a name="l00762"></a>00762       <span class="keywordflow">if</span> ($this-&gt;form-&gt;isValid()) {
<a name="l00763"></a>00763         $ag_scenario = $this-&gt;form-&gt;save();
<a name="l00764"></a>00764         <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) {
<a name="l00765"></a>00765           $this-&gt;ag_facility_resources = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00766"></a>00766               -&gt;select(<span class="stringliteral">&#39;a.facility_id, af.*, afrt.*&#39;</span>)
<a name="l00767"></a>00767               -&gt;from(<span class="stringliteral">&#39;agFacilityResource a, a.agFacility af, a.agFacilityResourceType afrt&#39;</span>)
<a name="l00768"></a>00768               -&gt;execute();
<a name="l00769"></a>00769           $this-&gt;groupform = <span class="keyword">new</span> <a class="code" href="classagScenarioFacilityGroupForm.html" title="agScenarioFacilityGroupForm extended class for creating scenario specific facility...">agScenarioFacilityGroupForm</a>();
<a name="l00770"></a>00770 <span class="comment">//        $this-&gt;setTemplate(&#39;scenario/newgroup&#39;);</span>
<a name="l00771"></a>00771           $this-&gt;redirect(<span class="stringliteral">&#39;scenario/resourcetypes?id=&#39;</span> . $ag_scenario-&gt;getId());
<a name="l00772"></a>00772         } <span class="keywordflow">else</span> {
<a name="l00773"></a>00773           $this-&gt;redirect(<span class="stringliteral">&#39;scenario/meta?id=&#39;</span> . $ag_scenario-&gt;getId());
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775       }
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777   }
<a name="l00778"></a>00778 
<a name="l00783"></a><a class="code" href="classscenarioActions.html#af4c19884f7d08e92486c9ce52bd52b17">00783</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#af4c19884f7d08e92486c9ce52bd52b17" title="Default Resource Type definition for a scenario.">executeResourcetypes</a>(sfWebRequest $request)
<a name="l00784"></a>00784   {
<a name="l00785"></a>00785     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00786"></a>00786     $this-&gt;wizardHandler($request, 2);
<a name="l00787"></a>00787     
<a name="l00788"></a>00788     $this-&gt;getUser()-&gt;setAttribute(<span class="stringliteral">&#39;returnPage&#39;</span>, <span class="stringliteral">&#39;scenarioResourceTypes&#39;</span>);
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     $this-&gt;resourceForm = <span class="keyword">new</span> <a class="code" href="classagDefaultResourceTypeForm.html" title="Agasti ag Default Resource Type Form Class - A class to generate either a new staff...">agDefaultResourceTypeForm</a>($this-&gt;scenario_id);
<a name="l00791"></a>00791     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Scenario Creation Wizard - set Default Resource Types needed for &#39;</span> . $this-&gt;scenarioName . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l00792"></a>00792     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST)) {
<a name="l00793"></a>00793       $staffDefaults = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine::getTable</a>(<span class="stringliteral">&#39;agDefaultScenarioStaffResourceType&#39;</span>)
<a name="l00794"></a>00794           -&gt;findByDql(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenario_id);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796       $facilityDefaults = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine::getTable</a>(<span class="stringliteral">&#39;agDefaultScenarioFacilityResourceType&#39;</span>)
<a name="l00797"></a>00797           -&gt;findByDql(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenario_id);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799       $topForm = $request-&gt;getParameter($this-&gt;resourceForm-&gt;getName());
<a name="l00800"></a>00800 
<a name="l00801"></a>00801       $staffParams = $topForm[<span class="stringliteral">&#39;staff_types&#39;</span>];
<a name="l00802"></a>00802       $facilityParams = $topForm[<span class="stringliteral">&#39;facility_types&#39;</span>];
<a name="l00803"></a>00803 <span class="comment">//update and remove</span>
<a name="l00804"></a>00804       <span class="keywordflow">foreach</span> ($staffDefaults as $index =&gt; &amp;$record) {
<a name="l00805"></a>00805         <span class="keywordflow">if</span> (array_key_exists($index, $staffParams)) {
<a name="l00806"></a>00806           $staffDefaultResourceId = $record[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>];
<a name="l00807"></a>00807           <span class="comment">//update</span>
<a name="l00808"></a>00808         }
<a name="l00809"></a>00809 <span class="comment">//remove items from the collection that are not in our post params</span>
<a name="l00810"></a>00810         <span class="keywordflow">else</span> {
<a name="l00811"></a>00811           $staffDefaults-&gt;remove($index);
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813       }
<a name="l00814"></a>00814       <span class="keywordflow">foreach</span> ($facilityDefaults as $index =&gt; &amp;$record) {
<a name="l00815"></a>00815         <span class="keywordflow">if</span> (array_key_exists($index, $facilityParams)) {
<a name="l00816"></a>00816           $facilityDefaultResourceId = $record[<span class="stringliteral">&#39;facility_resource_id&#39;</span>];
<a name="l00817"></a>00817           <span class="comment">//update</span>
<a name="l00818"></a>00818         }
<a name="l00819"></a>00819 <span class="comment">//remove items from the collection that are not in our post params</span>
<a name="l00820"></a>00820         <span class="keywordflow">else</span> {
<a name="l00821"></a>00821           $facilityDefaults-&gt;remove($index);
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823       }
<a name="l00824"></a>00824 <span class="comment">//inserts</span>
<a name="l00825"></a>00825       <span class="keywordflow">if</span> (isset($facilityParams[<span class="stringliteral">&#39;facility_resource_type_id&#39;</span>])) {
<a name="l00826"></a>00826         <span class="keywordflow">foreach</span> ($facilityParams[<span class="stringliteral">&#39;facility_resource_type_id&#39;</span>] as $key =&gt; $value) {
<a name="l00827"></a>00827           $newRec = <span class="keyword">new</span> <a class="code" href="classagDefaultScenarioFacilityResourceType.html">agDefaultScenarioFacilityResourceType</a>();
<a name="l00828"></a>00828 
<a name="l00829"></a>00829           $newRec[<span class="stringliteral">&#39;scenario_id&#39;</span>] = $this-&gt;scenario_id;
<a name="l00830"></a>00830           $newRec[<span class="stringliteral">&#39;facility_resource_type_id&#39;</span>] = $value;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832           $facilityDefaults-&gt;add($newRec);
<a name="l00833"></a>00833           unset($facilityParams[$key]);
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835       }
<a name="l00836"></a>00836       <span class="keywordflow">if</span> (isset($staffParams[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>])) {
<a name="l00837"></a>00837         <span class="keywordflow">foreach</span> ($staffParams[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>] as $key =&gt; $value) {
<a name="l00838"></a>00838           $newRec = <span class="keyword">new</span> <a class="code" href="classagDefaultScenarioStaffResourceType.html">agDefaultScenarioStaffResourceType</a>();
<a name="l00839"></a>00839 
<a name="l00840"></a>00840           $newRec[<span class="stringliteral">&#39;scenario_id&#39;</span>] = $this-&gt;scenario_id;
<a name="l00841"></a>00841           $newRec[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>] = $value;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843           $staffDefaults-&gt;add($newRec);
<a name="l00844"></a>00844           unset($staffParams[$key]);
<a name="l00845"></a>00845         }
<a name="l00846"></a>00846       }
<a name="l00847"></a>00847       <span class="comment">//$conn = Doctrine_Manager::connection();</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849       $staffDefaults-&gt;save();
<a name="l00850"></a>00850       $facilityDefaults-&gt;save();
<a name="l00851"></a>00851       <span class="comment">//$conn-&gt;commit();</span>
<a name="l00852"></a>00852       <span class="keywordflow">if</span> (!isset($staffParams[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>]) || !isset($facilityParams[<span class="stringliteral">&#39;facility_resource_type_id&#39;</span>])) {
<a name="l00853"></a>00853         $this-&gt;noDefaults = <span class="keyword">true</span>;
<a name="l00854"></a>00854         $this-&gt;resourceForm = <span class="keyword">new</span> <a class="code" href="classagDefaultResourceTypeForm.html" title="Agasti ag Default Resource Type Form Class - A class to generate either a new staff...">agDefaultResourceTypeForm</a>($this-&gt;scenario_id);
<a name="l00855"></a>00855       } <span class="keywordflow">else</span> {
<a name="l00856"></a>00856         <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) {
<a name="l00857"></a>00857 
<a name="l00858"></a>00858           <span class="comment">// count our facility groups and redirect to new fgroup or list appropriately</span>
<a name="l00859"></a>00859           $fgroupCt = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00860"></a>00860               -&gt;select(<span class="stringliteral">&#39;count(sfg.id) AS sfg&#39;</span>)
<a name="l00861"></a>00861               -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00862"></a>00862               -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00863"></a>00863               -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865           <span class="keywordflow">if</span> ($fgroupCt &lt; 1 || empty($fgroupCt)) {
<a name="l00866"></a>00866             $this-&gt;redirect(<span class="stringliteral">&#39;scenario/fgroup?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l00867"></a>00867           } <span class="keywordflow">else</span> {
<a name="l00868"></a>00868             $this-&gt;redirect(<span class="stringliteral">&#39;scenario/listgroup?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l00869"></a>00869           }
<a name="l00870"></a>00870         } <span class="keywordflow">else</span> {
<a name="l00871"></a>00871           $this-&gt;redirect(<span class="stringliteral">&#39;scenario/resourcetypes?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873       }
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875   }
<a name="l00876"></a>00876 
<a name="l00883"></a><a class="code" href="classscenarioActions.html#ae1f3a19f3d2e612d376d28cc87d35f51">00883</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#ae1f3a19f3d2e612d376d28cc87d35f51">executeFgroup</a>(sfWebRequest $request)
<a name="l00884"></a>00884   {
<a name="l00885"></a>00885 <span class="comment">//if you are coming here from not within the workflow you fail and get 404</span>
<a name="l00886"></a>00886     $this-&gt;forward404Unless($this-&gt;scenario_id = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l00887"></a>00887 <span class="comment">//set up some things to show up on the screen for our form</span>
<a name="l00888"></a>00888     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l00889"></a>00889     $this-&gt;wizardHandler($request, 3);
<a name="l00890"></a>00890     $this-&gt;scenarioFacilityGroups = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine::getTable</a>(<span class="stringliteral">&#39;agScenarioFacilityGroup&#39;</span>)
<a name="l00891"></a>00891         -&gt;findByDql(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00892"></a>00892         -&gt;getData();
<a name="l00893"></a>00893 
<a name="l00894"></a>00894     $this-&gt;allocatedFacilityResources = <span class="stringliteral">&#39;&#39;</span>;  <span class="comment">//set this default incase none exist</span>
<a name="l00895"></a>00895 <span class="comment">// Get the facility resource types available to this scenario.</span>
<a name="l00896"></a>00896     $this-&gt;facilityResourceTypes = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00897"></a>00897         -&gt;select(<span class="stringliteral">&#39;frt.id, frt.facility_resource_type, facility_resource_type_abbr&#39;</span>)
<a name="l00898"></a>00898         -&gt;from(<span class="stringliteral">&#39;agFacilityResourceType frt&#39;</span>)
<a name="l00899"></a>00899         -&gt;innerJoin(<span class="stringliteral">&#39;frt.agDefaultScenarioFacilityResourceType dsfrt&#39;</span>)
<a name="l00900"></a>00900         -&gt;where(<span class="stringliteral">&#39;dsfrt.scenario_id =?&#39;</span>, $this-&gt;scenario_id)
<a name="l00901"></a>00901         -&gt;orderBy(<span class="stringliteral">&#39;frt.facility_resource_type&#39;</span>)
<a name="l00902"></a>00902         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#aa98a2c96d8437e185eccacf15c81604c" title="HYDRATE_ARRAY.">Doctrine_Core::HYDRATE_ARRAY</a>);
<a name="l00903"></a>00903 <span class="comment">// Get all the facility resources available to this scenario (those that aren&#39;t already in use</span>
<a name="l00904"></a>00904 <span class="comment">// in this scenario).</span>
<a name="l00905"></a>00905     $this-&gt;availableFacilityResources = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00906"></a>00906         -&gt;select(<span class="stringliteral">&#39;fr.id&#39;</span>)
<a name="l00907"></a>00907         -&gt;addSelect(<span class="stringliteral">&#39;f.facility_name&#39;</span>)
<a name="l00908"></a>00908         -&gt;addSelect(<span class="stringliteral">&#39;f.facility_code&#39;</span>)
<a name="l00909"></a>00909         -&gt;addSelect(<span class="stringliteral">&#39;frt.facility_resource_type&#39;</span>)
<a name="l00910"></a>00910         -&gt;addSelect(<span class="stringliteral">&#39;frt.id&#39;</span>)
<a name="l00911"></a>00911         -&gt;addSelect(<span class="stringliteral">&#39;frt.facility_resource_type_abbr&#39;</span>)
<a name="l00912"></a>00912         -&gt;from(<span class="stringliteral">&#39;agFacilityResource fr&#39;</span>)
<a name="l00913"></a>00913         -&gt;innerJoin(<span class="stringliteral">&#39;fr.agFacility f&#39;</span>)
<a name="l00914"></a>00914         -&gt;innerJoin(<span class="stringliteral">&#39;fr.agFacilityResourceType frt&#39;</span>)
<a name="l00915"></a>00915         -&gt;innerJoin(<span class="stringliteral">&#39;frt.agDefaultScenarioFacilityResourceType dsfrt&#39;</span>)
<a name="l00916"></a>00916         -&gt;where(<span class="stringliteral">&#39;NOT EXISTS (</span>
<a name="l00917"></a>00917 <span class="stringliteral">              SELECT s1.id</span>
<a name="l00918"></a>00918 <span class="stringliteral">                FROM agFacilityResource s1</span>
<a name="l00919"></a>00919 <span class="stringliteral">                  INNER JOIN s1.agScenarioFacilityResource s2</span>
<a name="l00920"></a>00920 <span class="stringliteral">                  INNER JOIN s2.agScenarioFacilityGroup s3</span>
<a name="l00921"></a>00921 <span class="stringliteral">              WHERE s3.scenario_id = ?</span>
<a name="l00922"></a>00922 <span class="stringliteral">                AND s1.id = fr.id)&#39;</span>,
<a name="l00923"></a>00923                 $this-&gt;scenario_id)
<a name="l00924"></a>00924         -&gt;andWhere(<span class="stringliteral">&#39;dsfrt.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00925"></a>00925         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927     $this-&gt;facilityStatusForm = <span class="keyword">new</span> <a class="code" href="classsfForm.html">sfForm</a>();
<a name="l00928"></a>00928     $this-&gt;facilityStatusForm-&gt;setWidgets(array(
<a name="l00929"></a>00929       <span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="keyword">new</span> <a class="code" href="classsfWidgetFormDoctrineChoice.html">sfWidgetFormDoctrineChoice</a>(array(<span class="stringliteral">&#39;model&#39;</span> =&gt; <span class="stringliteral">&#39;agFacilityResourceStatus&#39;</span>, <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;getFacilityResourceStatus&#39;</span>), array())
<a name="l00930"></a>00930     ));
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="comment">// Query to get the resource allocation statuses that will be used as table headers.</span>
<a name="l00933"></a>00933     $this-&gt;selectStatuses = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00934"></a>00934         -&gt;select(<span class="stringliteral">&#39;fras.id, fras.facility_resource_allocation_status&#39;</span>)
<a name="l00935"></a>00935         -&gt;from(<span class="stringliteral">&#39;agFacilityResourceAllocationStatus fras&#39;</span>)
<a name="l00936"></a>00936         -&gt;where(<span class="stringliteral">&#39;scenario_display = true&#39;</span>)
<a name="l00937"></a>00937         -&gt;orderBy(<span class="stringliteral">&#39;fras.facility_resource_allocation_status&#39;</span>)
<a name="l00938"></a>00938         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l00939"></a>00939 <span class="comment">// For facility group selection.</span>
<a name="l00940"></a>00940     $facilityGroupChoices = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00941"></a>00941         -&gt;select(<span class="stringliteral">&#39;sfg.id, sfg.scenario_facility_group&#39;</span>)
<a name="l00942"></a>00942         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup sfg&#39;</span>)
<a name="l00943"></a>00943         -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l00944"></a>00944         -&gt;orderBy(<span class="stringliteral">&#39;sfg.scenario_facility_group&#39;</span>)
<a name="l00945"></a>00945         -&gt;execute(array(), <span class="stringliteral">&#39;key_value_pair&#39;</span>);
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (empty($facilityGroupChoices)) {
<a name="l00947"></a>00947       $this-&gt;groupSelector = <span class="keyword">false</span>;
<a name="l00948"></a>00948     } <span class="keywordflow">else</span> {
<a name="l00949"></a>00949       $this-&gt;groupSelector = <span class="keyword">new</span> <a class="code" href="classsfForm.html">sfForm</a>();
<a name="l00950"></a>00950       $this-&gt;groupSelector-&gt;setWidget(<span class="stringliteral">&#39;Change Facility Group:&#39;</span>,
<a name="l00951"></a>00951                                       <span class="keyword">new</span> <a class="code" href="classsfWidgetFormChoice.html">sfWidgetFormChoice</a>(
<a name="l00952"></a>00952               array(<span class="stringliteral">&#39;choices&#39;</span> =&gt; ($request-&gt;getParameter(<span class="stringliteral">&#39;groupid&#39;</span>) ? $facilityGroupChoices : array(0 =&gt; null) + $facilityGroupChoices)),
<a name="l00953"></a>00953               array(<span class="stringliteral">&#39;class&#39;</span> =&gt; <span class="stringliteral">&#39;inputGray&#39;</span>)
<a name="l00954"></a>00954       ));
<a name="l00955"></a>00955       <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;groupid&#39;</span>)) {
<a name="l00956"></a>00956         $this-&gt;groupSelector-&gt;getWidget(<span class="stringliteral">&#39;Change Facility Group:&#39;</span>)-&gt;setDefault($request-&gt;getParameter(<span class="stringliteral">&#39;groupid&#39;</span>));
<a name="l00957"></a>00957       }
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960     <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;groupid&#39;</span>)) {
<a name="l00961"></a>00961 <span class="comment">//EDIT</span>
<a name="l00962"></a>00962       $this-&gt;groupId = $request-&gt;getParameter(<span class="stringliteral">&#39;groupid&#39;</span>);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964       $agScenarioFacilityGroup = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00965"></a>00965           -&gt;select()
<a name="l00966"></a>00966           -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup&#39;</span>)
<a name="l00967"></a>00967           -&gt;where(<span class="stringliteral">&#39;id = ?&#39;</span>, $this-&gt;groupId)
<a name="l00968"></a>00968           -&gt;fetchOne();
<a name="l00969"></a>00969 
<a name="l00970"></a>00970       $this-&gt;groupform = <span class="keyword">new</span> <a class="code" href="classagScenarioFacilityGroupForm.html" title="agScenarioFacilityGroupForm extended class for creating scenario specific facility...">agScenarioFacilityGroupForm</a>($agScenarioFacilityGroup);
<a name="l00971"></a>00971       $allocatedFacilityResources = $this-&gt;getAllocatedFacilityResources($this-&gt;groupId);
<a name="l00972"></a>00972       $this-&gt;allocatedFacilityResources = $this-&gt;parseAllocatedFacilityResources($this-&gt;selectStatuses,
<a name="l00973"></a>00973                                                                                  $allocatedFacilityResources);
<a name="l00974"></a>00974     } <span class="keywordflow">else</span> {
<a name="l00975"></a>00975 <span class="comment">//NEW</span>
<a name="l00976"></a>00976       $this-&gt;groupform = <span class="keyword">new</span> <a class="code" href="classagScenarioFacilityGroupForm.html" title="agScenarioFacilityGroupForm extended class for creating scenario specific facility...">agScenarioFacilityGroupForm</a>();
<a name="l00977"></a>00977       $this-&gt;groupform-&gt;setDefault(<span class="stringliteral">&#39;scenario_id&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST)) {
<a name="l00980"></a>00980 <span class="comment">//SAVE</span>
<a name="l00981"></a>00981       <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Another&#39;</span>) || $request-&gt;hasParameter(<span class="stringliteral">&#39;AssignAll&#39;</span>)) {
<a name="l00982"></a>00982 <span class="comment">//      if($request-&gt;hasParameter(&#39;saveJSON&#39;)) {</span>
<a name="l00983"></a>00983         $this-&gt;groupform-&gt;bind($request-&gt;getParameter($this-&gt;groupform-&gt;getName()),
<a name="l00984"></a>00984                                                       $request-&gt;getFiles($this-&gt;groupform-&gt;getName()));
<a name="l00985"></a>00985         $params = $request-&gt;getParameter(<span class="stringliteral">&#39;ag_scenario_facility_group&#39;</span>);
<a name="l00986"></a>00986         $facilityResources = json_decode($params[<span class="stringliteral">&#39;values&#39;</span>], <span class="keyword">true</span>);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="keywordflow">if</span> ($this-&gt;groupform-&gt;isValid()) {
<a name="l00989"></a>00989           unset($this-&gt;groupform[<span class="stringliteral">&#39;ag_facility_resource_list&#39;</span>]);
<a name="l00990"></a>00990           $agScenarioFacilityGroup = $this-&gt;groupform-&gt;save();          <span class="comment">// The Group object has been created here.</span>
<a name="l00991"></a>00991           <span class="keywordflow">foreach</span> ($facilityResources as $facilityResource) {
<a name="l00992"></a>00992             $incomingFrIds[] = $facilityResource[<span class="stringliteral">&#39;frId&#39;</span>];
<a name="l00993"></a>00993           }
<a name="l00994"></a>00994           $preSaveFrIds = array();
<a name="l00995"></a>00995           <span class="keywordflow">if</span> (isset($allocatedFacilityResources)) {
<a name="l00996"></a>00996             <span class="keywordflow">foreach</span> ($allocatedFacilityResources as $allocatedFacilityResource) {
<a name="l00997"></a>00997               $preSaveFrIds[$allocatedFacilityResource[<span class="stringliteral">&#39;fr_id&#39;</span>]] = $allocatedFacilityResource[<span class="stringliteral">&#39;sfr_id&#39;</span>];
<a name="l00998"></a>00998             }
<a name="l00999"></a>00999           }
<a name="l01000"></a>01000           <span class="comment">// Find existing scen fac resources and update them. Or make new ones and populate.</span>
<a name="l01001"></a>01001           <span class="keywordflow">foreach</span> ($facilityResources as $facilityResource) {
<a name="l01002"></a>01002             <span class="keywordflow">if</span> (in_array($facilityResource[<span class="stringliteral">&#39;frId&#39;</span>], array_keys($preSaveFrIds))) {
<a name="l01003"></a>01003               $scenarioFacRes = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01004"></a>01004                   -&gt;select()
<a name="l01005"></a>01005                   -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityResource&#39;</span>)
<a name="l01006"></a>01006                   -&gt;where(<span class="stringliteral">&#39;id = ?&#39;</span>, $preSaveFrIds[$facilityResource[<span class="stringliteral">&#39;frId&#39;</span>]])
<a name="l01007"></a>01007                   -&gt;fetchOne();
<a name="l01008"></a>01008               <span class="comment">// Knock off the fac res id. Those that are left will be used for a delete query.</span>
<a name="l01009"></a>01009               unset($preSaveFrIds[$facilityResource[<span class="stringliteral">&#39;frId&#39;</span>]]);
<a name="l01010"></a>01010             } <span class="keywordflow">else</span> {
<a name="l01011"></a>01011               $scenarioFacRes = <span class="keyword">new</span> <a class="code" href="classagScenarioFacilityResource.html" title="extends the base ScenarioFacilityResource class for added functionality">agScenarioFacilityResource</a>();
<a name="l01012"></a>01012               $scenarioFacRes[<span class="stringliteral">&#39;facility_resource_id&#39;</span>] = $facilityResource[<span class="stringliteral">&#39;frId&#39;</span>];
<a name="l01013"></a>01013             }
<a name="l01014"></a>01014             $scenarioFacRes[<span class="stringliteral">&#39;scenario_facility_group_id&#39;</span>] = $agScenarioFacilityGroup[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l01015"></a>01015             $scenarioFacRes[<span class="stringliteral">&#39;facility_resource_allocation_status_id&#39;</span>] = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01016"></a>01016                 -&gt;select(<span class="stringliteral">&#39;id&#39;</span>)
<a name="l01017"></a>01017                 -&gt;from(<span class="stringliteral">&#39;agFacilityResourceAllocationStatus&#39;</span>)
<a name="l01018"></a>01018                 -&gt;where(<span class="stringliteral">&#39;facility_resource_allocation_status = ?&#39;</span>, $facilityResource[<span class="stringliteral">&#39;actStat&#39;</span>])
<a name="l01019"></a>01019                 -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l01020"></a>01020             $scenarioFacRes[<span class="stringliteral">&#39;activation_sequence&#39;</span>] = ($facilityResource[<span class="stringliteral">&#39;actSeq&#39;</span>] != null ? $facilityResource[<span class="stringliteral">&#39;actSeq&#39;</span>] : 100);
<a name="l01021"></a>01021             $scenarioFacRes-&gt;save();
<a name="l01022"></a>01022           }
<a name="l01023"></a>01023           <span class="keywordflow">if</span> (count($preSaveFrIds &gt; 0)) {
<a name="l01024"></a>01024             <span class="keywordflow">foreach</span> ($preSaveFrIds as $deletable) {
<a name="l01025"></a>01025               agScenarioFacilityHelper::deleteScenarioFacilityResource($deletable);
<a name="l01026"></a>01026             }
<a name="l01027"></a>01027           }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029           <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) {
<a name="l01030"></a>01030             $return = json_encode(array(
<a name="l01031"></a>01031               <span class="stringliteral">&#39;response&#39;</span> =&gt; url_for(<span class="stringliteral">&#39;scenario/staffresources?id=&#39;</span> . $this-&gt;scenario_id),
<a name="l01032"></a>01032               <span class="stringliteral">&#39;redirect&#39;</span> =&gt; <span class="keyword">true</span>)
<a name="l01033"></a>01033             );
<a name="l01034"></a>01034             <span class="keywordflow">return</span> $this-&gt;renderText($return);
<a name="l01035"></a>01035 <span class="comment">//            $this-&gt;redirect(&#39;scenario/staffresources?id=&#39; . $this-&gt;scenario_id);</span>
<a name="l01036"></a>01036           } elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;Another&#39;</span>)) {
<a name="l01037"></a>01037             $return = json_encode(array(
<a name="l01038"></a>01038               <span class="stringliteral">&#39;response&#39;</span> =&gt; url_for(<span class="stringliteral">&#39;scenario/fgroup?id=&#39;</span> . $this-&gt;scenario_id),
<a name="l01039"></a>01039               <span class="stringliteral">&#39;redirect&#39;</span> =&gt; <span class="keyword">true</span>)
<a name="l01040"></a>01040             );
<a name="l01041"></a>01041             <span class="keywordflow">return</span> $this-&gt;renderText($return);
<a name="l01042"></a>01042 <span class="comment">//            $this-&gt;redirect(&#39;scenario/fgroup?id=&#39; . $this-&gt;scenario_id);</span>
<a name="l01043"></a>01043           } elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;AssignAll&#39;</span>)) {
<a name="l01044"></a>01044 <span class="comment">//            $groups = Doctrine::getTable(&#39;agScenarioFacilityGroup&#39;)</span>
<a name="l01045"></a>01045 <span class="comment">//                    -&gt;findByDql(&#39;scenario_id = ?&#39;, $this-&gt;scenario_id)</span>
<a name="l01046"></a>01046 <span class="comment">//                    -&gt;getData();</span>
<a name="l01047"></a>01047             $return = json_encode(array(
<a name="l01048"></a>01048               <span class="stringliteral">&#39;response&#39;</span> =&gt; url_for(<span class="stringliteral">&#39;scenario/staffresources?id=&#39;</span> . $this-&gt;scenario_id),
<a name="l01049"></a>01049               <span class="stringliteral">&#39;redirect&#39;</span> =&gt; <span class="keyword">true</span>)
<a name="l01050"></a>01050             );
<a name="l01051"></a>01051             <span class="keywordflow">return</span> $this-&gt;renderText($return);
<a name="l01052"></a>01052 <span class="comment">//            $this-&gt;redirect(&#39;scenario/staffresources?id=&#39; . $this-&gt;scenario_id);</span>
<a name="l01053"></a>01053           } elseif ($request-&gt;hasParameter(<span class="stringliteral">&#39;groupid&#39;</span>)) {
<a name="l01054"></a>01054             <span class="comment">//if this is an existing facility group we are editing.</span>
<a name="l01055"></a>01055             $agScenarioFacilityGroup = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioFacilityGroup&#39;</span>)-&gt;find(array($request-&gt;getParameter(<span class="stringliteral">&#39;groupid&#39;</span>)));
<a name="l01056"></a>01056             $this-&gt;groupform = <span class="keyword">new</span> <a class="code" href="classagScenarioFacilityGroupForm.html" title="agScenarioFacilityGroupForm extended class for creating scenario specific facility...">agScenarioFacilityGroupForm</a>($agScenarioFacilityGroup);
<a name="l01057"></a>01057             $this-&gt;redirect(<span class="stringliteral">&#39;scenario/fgroup?id=&#39;</span> . $this-&gt;scenario_id); <span class="comment">//redirect the user to edit the facilitygroup</span>
<a name="l01058"></a>01058           } <span class="keywordflow">else</span> {
<a name="l01059"></a>01059             $this-&gt;redirect(<span class="stringliteral">&#39;scenario/meta?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l01060"></a>01060             <span class="comment">//save and bring back to scenario edit page? or should goto review page.</span>
<a name="l01061"></a>01061           }
<a name="l01062"></a>01062         } <span class="keywordflow">else</span> {
<a name="l01063"></a>01063           <span class="keywordflow">if</span> ($this-&gt;groupform-&gt;hasErrors()) {
<a name="l01064"></a>01064             $errors = $this-&gt;groupform-&gt;getErrorSchema()-&gt;getErrors();
<a name="l01065"></a>01065 <span class="comment">//            $errors = $this-&gt;groupform-&gt;getErrorSchema();</span>
<a name="l01066"></a>01066 <span class="comment">//            $b = $errors-&gt;getMessage();</span>
<a name="l01067"></a>01067             <span class="keywordflow">foreach</span> ($errors as $error) {
<a name="l01068"></a>01068               $message .= $error-&gt;getMessage() . PHP_EOL;
<a name="l01069"></a>01069             }
<a name="l01070"></a>01070           }
<a name="l01071"></a>01071           $return = json_encode(array(<span class="stringliteral">&#39;response&#39;</span> =&gt; $message . <span class="stringliteral">&#39;Please see the field highlighted in red below.&#39;</span>, <span class="stringliteral">&#39;redirect&#39;</span> =&gt; <span class="keyword">false</span>));
<a name="l01072"></a>01072           <span class="keywordflow">return</span> $this-&gt;renderText($return);
<a name="l01073"></a>01073         }
<a name="l01074"></a>01074       }
<a name="l01075"></a>01075 <span class="comment">// END SAVE</span>
<a name="l01076"></a>01076 <span class="comment">// LOAD NEW GROUP</span>
<a name="l01077"></a>01077       <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;change&#39;</span>)) {
<a name="l01078"></a>01078         <span class="keywordflow">return</span> $this-&gt;renderPartial(<span class="stringliteral">&#39;groupform&#39;</span>,
<a name="l01079"></a>01079                                     array(<span class="stringliteral">&#39;facilityStatusForm&#39;</span> =&gt; $this-&gt;facilityStatusForm,
<a name="l01080"></a>01080           <span class="stringliteral">&#39;groupform&#39;</span> =&gt; $this-&gt;groupform,
<a name="l01081"></a>01081           <span class="stringliteral">&#39;availableFacilityResources&#39;</span> =&gt; $this-&gt;availableFacilityResources,
<a name="l01082"></a>01082           <span class="stringliteral">&#39;allocatedFacilityResources&#39;</span> =&gt; $this-&gt;parseAllocatedFacilityResources($this-&gt;selectStatuses,
<a name="l01083"></a>01083                                                                                  $this-&gt;getAllocatedFacilityResources($this-&gt;groupId)
<a name="l01084"></a>01084           ),
<a name="l01085"></a>01085           <span class="stringliteral">&#39;scenario_id&#39;</span> =&gt; $this-&gt;scenario_id,
<a name="l01086"></a>01086           <span class="stringliteral">&#39;selectStatuses&#39;</span> =&gt; $this-&gt;selectStatuses,
<a name="l01087"></a>01087           <span class="stringliteral">&#39;facilityResourceTypes&#39;</span> =&gt; $this-&gt;facilityResourceTypes));
<a name="l01088"></a>01088       }
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090 <span class="comment">// END LOAD NEW GROUP</span>
<a name="l01091"></a>01091 <span class="comment">//p-code</span>
<a name="l01092"></a>01092     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenarioName . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l01093"></a>01093 <span class="comment">//end p-code</span>
<a name="l01094"></a>01094   }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096   <span class="keyword">public</span> function executeFacilityGroupDelete(sfWebRequest $request)
<a name="l01097"></a>01097   {
<a name="l01098"></a>01098     $agScenarioFacilityGroup = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioFacilityGroup&#39;</span>)
<a name="l01099"></a>01099         -&gt;find(array($request-&gt;getParameter(<span class="stringliteral">&#39;groupId&#39;</span>)));
<a name="l01100"></a>01100     $scenarioId = $agScenarioFacilityGroup[<span class="stringliteral">&#39;scenario_id&#39;</span>];
<a name="l01101"></a>01101     $scenarioFacilityResources = $agScenarioFacilityGroup-&gt;getAgScenarioFacilityResource();
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="comment">// Get all facility resources associated with the facility group</span>
<a name="l01104"></a>01104     <span class="keywordflow">foreach</span> ($scenarioFacilityResources as $scenarioFacilityResource) {
<a name="l01105"></a>01105       <span class="comment">// Get all shifts associated with each facility resource associated with the facility group</span>
<a name="l01106"></a>01106       $scenarioShifts = $scenarioFacilityResource-&gt;getAgScenarioShift();
<a name="l01107"></a>01107       <span class="keywordflow">foreach</span> ($scenarioShifts as $scenarioShift) {
<a name="l01108"></a>01108         $scenarioShifts-&gt;delete();
<a name="l01109"></a>01109       }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111       $facilityStaffResources = $scenarioFacilityResource-&gt;getAgFacilityStaffResource();
<a name="l01112"></a>01112       <span class="keywordflow">foreach</span> ($facilityStaffResources as $facilityStaffResource) {
<a name="l01113"></a>01113         $facilityStaffResource-&gt;delete();
<a name="l01114"></a>01114       }
<a name="l01115"></a>01115       $scenarioFacilityResource-&gt;delete();
<a name="l01116"></a>01116     }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118     $scenarioFacilityDistributions = $agScenarioFacilityGroup-&gt;getAgScenarioFacilityDistribution();
<a name="l01119"></a>01119     <span class="keywordflow">foreach</span> ($scenarioFacilityDistributions as $scenarioFacilityDistribution) {
<a name="l01120"></a>01120       $scenarioFacilityDistribution-&gt;delete();
<a name="l01121"></a>01121     }
<a name="l01122"></a>01122     $agScenarioFacilityGroup-&gt;delete();
<a name="l01123"></a>01123     $this-&gt;redirect(<span class="stringliteral">&#39;scenario/listgroup?id=&#39;</span> . $scenarioId);
<a name="l01124"></a>01124   }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126   <span class="keyword">private</span> function getAllocatedFacilityResources($groupId)
<a name="l01127"></a>01127   {
<a name="l01128"></a>01128     $allocatedFacilityResources = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01129"></a>01129         -&gt;select(<span class="stringliteral">&#39;fr.id&#39;</span>)
<a name="l01130"></a>01130         -&gt;addSelect(<span class="stringliteral">&#39;f.facility_name&#39;</span>)
<a name="l01131"></a>01131         -&gt;addSelect(<span class="stringliteral">&#39;f.facility_code&#39;</span>)
<a name="l01132"></a>01132         -&gt;addSelect(<span class="stringliteral">&#39;frt.facility_resource_type&#39;</span>)
<a name="l01133"></a>01133         -&gt;addSelect(<span class="stringliteral">&#39;frt.id&#39;</span>)
<a name="l01134"></a>01134         -&gt;addSelect(<span class="stringliteral">&#39;frt.facility_resource_type_abbr&#39;</span>)
<a name="l01135"></a>01135         -&gt;addSelect(<span class="stringliteral">&#39;sfr.id&#39;</span>)
<a name="l01136"></a>01136         -&gt;addSelect(<span class="stringliteral">&#39;sfr.activation_sequence&#39;</span>)
<a name="l01137"></a>01137         -&gt;addSelect(<span class="stringliteral">&#39;fras.id&#39;</span>)
<a name="l01138"></a>01138         -&gt;addSelect(<span class="stringliteral">&#39;fras.facility_resource_allocation_status&#39;</span>)
<a name="l01139"></a>01139         -&gt;from(<span class="stringliteral">&#39;agFacilityResource fr&#39;</span>)
<a name="l01140"></a>01140         -&gt;innerJoin(<span class="stringliteral">&#39;fr.agFacility f&#39;</span>)
<a name="l01141"></a>01141         -&gt;innerJoin(<span class="stringliteral">&#39;fr.agFacilityResourceType frt&#39;</span>)
<a name="l01142"></a>01142         -&gt;innerJoin(<span class="stringliteral">&#39;fr.agScenarioFacilityResource sfr&#39;</span>)
<a name="l01143"></a>01143         -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agFacilityResourceAllocationStatus fras&#39;</span>)
<a name="l01144"></a>01144         -&gt;where(<span class="stringliteral">&#39;sfr.scenario_facility_group_id = ?&#39;</span>, $groupId)
<a name="l01145"></a>01145         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l01146"></a>01146     <span class="keywordflow">return</span> $allocatedFacilityResources;
<a name="l01147"></a>01147   }
<a name="l01148"></a>01148 
<a name="l01156"></a>01156   <span class="keyword">private</span> function parseAllocatedFacilityResources($selectStatuses, $allocatedFacilityResources)
<a name="l01157"></a>01157   {
<a name="l01158"></a>01158 
<a name="l01159"></a>01159     <span class="keywordflow">foreach</span> ($selectStatuses as $selectStatus) {
<a name="l01160"></a>01160       <span class="keywordflow">foreach</span> ($allocatedFacilityResources as $afr) {
<a name="l01161"></a>01161         <span class="keywordflow">if</span> ($afr[<span class="stringliteral">&#39;fras_id&#39;</span>] == $selectStatus[<span class="stringliteral">&#39;fras_id&#39;</span>]) {
<a name="l01162"></a>01162           $parsedAllocatedFacilityResources[$selectStatus[<span class="stringliteral">&#39;fras_facility_resource_allocation_status&#39;</span>]][] = $afr;
<a name="l01163"></a>01163         }
<a name="l01164"></a>01164       }
<a name="l01165"></a>01165       <span class="comment">// Create an empty array under the $selectStatus key so there&#39;s no missing index warning on render.</span>
<a name="l01166"></a>01166       <span class="keywordflow">if</span> (!isset($parsedAllocatedFacilityResources[$selectStatus[<span class="stringliteral">&#39;fras_facility_resource_allocation_status&#39;</span>]])) {
<a name="l01167"></a>01167         $parsedAllocatedFacilityResources[$selectStatus[<span class="stringliteral">&#39;fras_facility_resource_allocation_status&#39;</span>]] = array();
<a name="l01168"></a>01168       }
<a name="l01169"></a>01169     }
<a name="l01170"></a>01170     <span class="keywordflow">return</span> $parsedAllocatedFacilityResources;
<a name="l01171"></a>01171   }
<a name="l01172"></a>01172 
<a name="l01178"></a><a class="code" href="classscenarioActions.html#a24195da975e07b328247b3c05dbd338f">01178</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a24195da975e07b328247b3c05dbd338f" title="deleteShiftTemplate AJAX called method">executeDeleteshifttemplate</a>(sfWebRequest $request)
<a name="l01179"></a>01179   {
<a name="l01180"></a>01180     $this-&gt;forward404unless($request-&gt;isXmlHttpRequest());
<a name="l01181"></a>01181  <span class="comment">//return $this-&gt;renderText(&#39;Shift Template Deleted&#39;);</span>
<a name="l01182"></a>01182     $shiftTemplateId = $request-&gt;getParameter(<span class="stringliteral">&#39;stId&#39;</span>);
<a name="l01183"></a>01183     $shiftTemplate = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agShiftTemplate&#39;</span>)
<a name="l01184"></a>01184         -&gt;findByDql(<span class="stringliteral">&#39;id = ?&#39;</span>, $shiftTemplateId)
<a name="l01185"></a>01185         -&gt;getFirst();
<a name="l01186"></a>01186 
<a name="l01187"></a>01187     $scenShifts = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>)
<a name="l01188"></a>01188         -&gt;findByDql(<span class="stringliteral">&#39;originator_id = ?&#39;</span>, $shiftTemplateId);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     $scenShifts-&gt;delete();
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     $result = $shiftTemplate-&gt;delete();
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="comment">//we assume here that if no error was thrown the shift template and associated shifts</span>
<a name="l01195"></a>01195     <span class="comment">//have been deleted</span>
<a name="l01196"></a>01196     <span class="keywordflow">return</span> $this-&gt;renderText(<span class="stringliteral">&#39;Shift Template Deleted&#39;</span>);
<a name="l01197"></a>01197   }
<a name="l01198"></a>01198 
<a name="l01204"></a><a class="code" href="classscenarioActions.html#a8a8e727150f47bf18f37bc37a709f448">01204</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a8a8e727150f47bf18f37bc37a709f448" title="addShiftTemplate AJAX called method to add a shift template">executeAddshifttemplate</a>(sfWebRequest $request)
<a name="l01205"></a>01205   {
<a name="l01206"></a>01206     $this-&gt;forward404unless($request-&gt;isXmlHttpRequest());
<a name="l01207"></a>01207     $number = intval($request-&gt;getParameter(<span class="stringliteral">&#39;num&#39;</span>));
<a name="l01208"></a>01208     $defaultDeploymentAlgorithmId = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01209"></a>01209       -&gt;select(<span class="stringliteral">&#39;da.id&#39;</span>)
<a name="l01210"></a>01210       -&gt;from(<span class="stringliteral">&#39;agDeploymentAlgorithm da&#39;</span>)
<a name="l01211"></a>01211       -&gt;where(<span class="stringliteral">&#39;da.deployment_algorithm = ?&#39;</span>, <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_deployment_algorithm&#39;</span>))
<a name="l01212"></a>01212       -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     $shiftTemplate = <span class="keyword">new</span> <a class="code" href="classagShiftTemplate.html">agShiftTemplate</a>();
<a name="l01215"></a>01215     $shiftTemplateForm = <span class="keyword">new</span> <a class="code" href="classagSingleShiftTemplateForm.html" title="Extension of shift templates.">agSingleShiftTemplateForm</a>($request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>), $shiftTemplate);
<a name="l01216"></a>01216     $shiftTemplateForm-&gt;getWidgetSchema()-&gt;setNameFormat(<span class="stringliteral">&#39;shift_template[&#39;</span> . $number . <span class="stringliteral">&#39;][%s]&#39;</span>);
<a name="l01217"></a>01217     $shiftTemplateForm-&gt;setDefault(<span class="stringliteral">&#39;task_length_minutes&#39;</span>,
<a name="l01218"></a>01218                                    <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_shift_task_length&#39;</span>));
<a name="l01219"></a>01219     $shiftTemplateForm-&gt;setDefault(<span class="stringliteral">&#39;break_length_minutes&#39;</span>,
<a name="l01220"></a>01220                                    <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_shift_break_length&#39;</span>));
<a name="l01221"></a>01221     $shiftTemplateForm-&gt;setDefault(<span class="stringliteral">&#39;minutes_start_to_facility_activation&#39;</span>,
<a name="l01222"></a>01222                                    <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_shift_minutes_start_to_facility_activation&#39;</span>));
<a name="l01223"></a>01223     $shiftTemplateForm-&gt;setDefault(<span class="stringliteral">&#39;days_in_operation&#39;</span>,
<a name="l01224"></a>01224                                    <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_days_in_operation&#39;</span>));
<a name="l01225"></a>01225     $shiftTemplateForm-&gt;setDefault(<span class="stringliteral">&#39;max_staff_repeat_shifts&#39;</span>,
<a name="l01226"></a>01226                                    <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_shift_max_staff_repeat_shifts&#39;</span>));
<a name="l01227"></a>01227     $shiftTemplateForm-&gt;setDefault(<span class="stringliteral">&#39;deployment_algorithm_id&#39;</span>, $defaultDeploymentAlgorithmId);
<a name="l01228"></a>01228     <span class="comment">//$shiftTemplateForm-&gt;getWidgetSchema()-&gt;setIdFormat($number . &#39;%s&#39;);</span>
<a name="l01229"></a>01229     unset($shiftTemplateForm[<span class="stringliteral">&#39;_csrf_token&#39;</span>]);
<a name="l01230"></a>01230     <span class="keywordflow">return</span> $this-&gt;renderPartial(<span class="stringliteral">&#39;shifttemplateform&#39;</span>,
<a name="l01231"></a>01231                                 array(<span class="stringliteral">&#39;shifttemplateform&#39;</span> =&gt; $shiftTemplateForm, <span class="stringliteral">&#39;number&#39;</span> =&gt; $number
<a name="l01232"></a>01232         )
<a name="l01233"></a>01233     );
<a name="l01234"></a>01234   }
<a name="l01235"></a>01235 
<a name="l01241"></a><a class="code" href="classscenarioActions.html#ac2b049e35692fd689cc76c5b58c287ba">01241</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#ac2b049e35692fd689cc76c5b58c287ba" title="executeScenarioshifts() Generates a new scenario shift form">executeShifttemplates</a>(sfWebRequest $request)
<a name="l01242"></a>01242   {
<a name="l01243"></a>01243     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l01244"></a>01244     $this-&gt;wizardHandler($request, 6);
<a name="l01245"></a>01245     $requiredResourceCombo = array();
<a name="l01246"></a>01246 
<a name="l01247"></a>01247     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST) and $request-&gt;hasParameter(<span class="stringliteral">&#39;Predefined&#39;</span>))
<a name="l01248"></a>01248     {
<a name="l01249"></a>01249       <span class="comment">// Query for all predefined staff resource and faciltiy resource combinations.</span>
<a name="l01250"></a>01250       <span class="comment">// Note:  Careful with the order of select since agShiftStatus table has no real relation to</span>
<a name="l01251"></a>01251       <span class="comment">// either of the tables in the query. The agShiftStatus.id is automatically placed at the end</span>
<a name="l01252"></a>01252       <span class="comment">// of the result array.</span>
<a name="l01253"></a>01253       $requiredResourceCombo = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01254"></a>01254         -&gt;select(<span class="stringliteral">&#39;dst.staff_resource_type_id&#39;</span>)
<a name="l01255"></a>01255             -&gt;addSelect(<span class="stringliteral">&#39;dft.facility_resource_type_id&#39;</span>)
<a name="l01256"></a>01256             -&gt;addSelect(<span class="stringliteral">&#39;ss.id&#39;</span>)
<a name="l01257"></a>01257           -&gt;from(<span class="stringliteral">&#39;agDefaultScenarioStaffResourceType dst&#39;</span>)
<a name="l01258"></a>01258               -&gt;innerJoin(<span class="stringliteral">&#39;dst.agScenario s&#39;</span>)
<a name="l01259"></a>01259               -&gt;innerJoin(<span class="stringliteral">&#39;s.agDefaultScenarioFacilityResourceType dft&#39;</span>)
<a name="l01260"></a>01260               -&gt;addFrom(<span class="stringliteral">&#39;agShiftStatus ss&#39;</span>)
<a name="l01261"></a>01261           -&gt;where(<span class="stringliteral">&#39;s.id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l01262"></a>01262           -&gt;andWhere(<span class="stringliteral">&#39;ss.disabled = 0&#39;</span>)
<a name="l01263"></a>01263         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a36531882557012215d8b9024373239fa" title="HYDRATE_NONE.">Doctrine_Core::HYDRATE_NONE</a>);
<a name="l01264"></a>01264     }
<a name="l01265"></a>01265     $this-&gt;shifttemplateforms = <span class="keyword">new</span> <a class="code" href="classagShiftTemplateContainerForm.html">agShiftTemplateContainerForm</a>($this-&gt;scenario_id,
<a name="l01266"></a>01266                                                                  $requiredResourceCombo);
<a name="l01267"></a>01267     unset($this-&gt;shifttemplateforms[<span class="stringliteral">&#39;_csrf_token&#39;</span>]);
<a name="l01268"></a>01268     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST))
<a name="l01269"></a>01269     {
<a name="l01270"></a>01270       <span class="comment">//foreach $this-&gt;shifttemplateforms...</span>
<a name="l01271"></a>01271       $this-&gt;shifttemplateforms-&gt;bind($request-&gt;getParameter(<span class="stringliteral">&#39;shift_template&#39;</span>),
<a name="l01272"></a>01272                                                              $request-&gt;getFiles($this-&gt;shifttemplateforms-&gt;getName()));
<a name="l01273"></a>01273       <span class="keywordflow">if</span> ($this-&gt;shifttemplateforms-&gt;isValid())
<a name="l01274"></a>01274       {
<a name="l01275"></a>01275         <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>) || $request-&gt;hasParameter(<span class="stringliteral">&#39;Delete&#39;</span>))
<a name="l01276"></a>01276         {
<a name="l01277"></a>01277           <span class="keywordflow">if</span>  ($request-&gt;hasParameter(<span class="stringliteral">&#39;Delete&#39;</span>))
<a name="l01278"></a>01278           {
<a name="l01279"></a>01279             $ag_shift_template = $this-&gt;shifttemplateforms-&gt;saveEmbeddedForms($request-&gt;getParameter(<span class="stringliteral">&#39;deleteShiftTemplateId&#39;</span>));
<a name="l01280"></a>01280           }
<a name="l01281"></a>01281 
<a name="l01282"></a>01282           <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>))
<a name="l01283"></a>01283           {
<a name="l01284"></a>01284             $ag_shift_template = $this-&gt;shifttemplateforms-&gt;saveEmbeddedForms();
<a name="l01285"></a>01285           }
<a name="l01286"></a>01286           $generatedResult = <a class="code" href="classagShiftGeneratorHelper.html#a8842adfac706eae81d304e8bbb47f499" title="Auto-generate shifts from ag_shift_template table to ag_scenario_shift table.">agShiftGeneratorHelper::shiftGenerator</a>($this-&gt;scenario_id);
<a name="l01287"></a>01287 
<a name="l01288"></a>01288           <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>))
<a name="l01289"></a>01289           {
<a name="l01290"></a>01290             <span class="comment">//if this is a long process should be a try/catch here</span>
<a name="l01291"></a>01291             $this-&gt;redirect(<span class="stringliteral">&#39;scenario/shifts?id=&#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l01292"></a>01292           }
<a name="l01293"></a>01293 
<a name="l01294"></a>01294           <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Delete&#39;</span>))
<a name="l01295"></a>01295           {
<a name="l01296"></a>01296             $this-&gt;redirect(<span class="stringliteral">&#39;scenario/shifttemplates?id=&#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l01297"></a>01297           }
<a name="l01298"></a>01298         }
<a name="l01299"></a>01299       }
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenarioName . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l01303"></a>01303   }
<a name="l01304"></a>01304 
<a name="l01309"></a><a class="code" href="classscenarioActions.html#a86059215d42d2a7858c90ce0beebbcfd">01309</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a86059215d42d2a7858c90ce0beebbcfd" title="CRUDL for shifts (create update delete and list).">executeShifts</a>(sfWebRequest $request)
<a name="l01310"></a>01310   {
<a name="l01311"></a>01311 <span class="comment">//CREATE  / UPDATE</span>
<a name="l01312"></a>01312     $this-&gt;<a class="code" href="classscenarioActions.html#a235ceb825a1d177f85c056d13adfbcc8" title="sets up basic scenario information from a web request, used in most actions here">setScenarioBasics</a>($request);
<a name="l01313"></a>01313     $this-&gt;wizardHandler($request, 7);
<a name="l01314"></a>01314     <span class="keywordflow">if</span> ($request-&gt;isMethod(sfRequest::POST)) {
<a name="l01315"></a>01315 
<a name="l01316"></a>01316       <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>) &amp;&amp; $request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>) == <span class="stringliteral">&#39;new&#39;</span>) {
<a name="l01317"></a>01317 
<a name="l01318"></a>01318         $this-&gt;scenarioshiftform = <span class="keyword">new</span> <a class="code" href="classagScenarioShiftForm.html" title="Creates Scenario Shift form.">agScenarioShiftForm</a>($this-&gt;scenario_id);
<a name="l01319"></a>01319       } elseif ($request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>) &amp;&amp; is_numeric($request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>))) {
<a name="l01320"></a>01320         $ag_scenario_shift = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>)
<a name="l01321"></a>01321             -&gt;findByDql(<span class="stringliteral">&#39;id = ?&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>))
<a name="l01322"></a>01322             -&gt;getFirst();
<a name="l01323"></a>01323         $this-&gt;scenarioshiftform = <span class="keyword">new</span> <a class="code" href="classagScenarioShiftForm.html" title="Creates Scenario Shift form.">agScenarioShiftForm</a>($this-&gt;scenario_id, $ag_scenario_shift);
<a name="l01324"></a>01324       }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326       <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;Save&#39;</span>)) {
<a name="l01327"></a>01327 
<a name="l01328"></a>01328         <span class="comment">//SAVE</span>
<a name="l01329"></a>01329         unset($this-&gt;scenarioshiftform[<span class="stringliteral">&#39;_csrf_token&#39;</span>]);
<a name="l01330"></a>01330         $this-&gt;scenarioshiftform-&gt;bind($request-&gt;getParameter(<span class="stringliteral">&#39;shift_template&#39;</span>),
<a name="l01331"></a>01331                                                               $request-&gt;getFiles($this-&gt;scenarioshiftform-&gt;getName()));
<a name="l01332"></a>01332 <span class="comment">//$formvalues = $request-&gt;getParameter($this-&gt;scenarioshiftform-&gt;getName());</span>
<a name="l01333"></a>01333         <span class="keywordflow">if</span> ($this-&gt;scenarioshiftform-&gt;isValid()) { <span class="comment">//form is not passing validation because the bind is failing?</span>
<a name="l01334"></a>01334           $ag_scenario_shift = $this-&gt;scenarioshiftform-&gt;save();
<a name="l01335"></a>01335           $this-&gt;generateUrl(<span class="stringliteral">&#39;scenario_shifts&#39;</span>,
<a name="l01336"></a>01336                              array(<span class="stringliteral">&#39;module&#39;</span> =&gt; <span class="stringliteral">&#39;scenario&#39;</span>,
<a name="l01337"></a>01337             <span class="stringliteral">&#39;action&#39;</span> =&gt; <span class="stringliteral">&#39;shifts&#39;</span>, <span class="stringliteral">&#39;id&#39;</span> =&gt; $this-&gt;scenario_id, <span class="stringliteral">&#39;shiftid&#39;</span> =&gt; $ag_scenario_shift-&gt;getId()));
<a name="l01338"></a>01338           $this-&gt;redirect(<span class="stringliteral">&#39;scenario/shifts?id=&#39;</span> . $this-&gt;scenario_id . <span class="stringliteral">&#39;&amp;shiftid=&#39;</span> . $ag_scenario_shift-&gt;getId());
<a name="l01339"></a>01339         } <span class="keywordflow">else</span> {
<a name="l01340"></a>01340           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Exception.html">Doctrine_Exception</a>(<span class="stringliteral">&#39;Invalid data caught, please go back and try again.&#39;</span>);
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342         <span class="comment">//$this-&gt;redirect(&#39;scenario/shifts?id=&#39; . $this-&gt;scenario_id); //need to pass in scenario id</span>
<a name="l01343"></a>01343       } elseif ($request-&gt;getParameter(<span class="stringliteral">&#39;Delete&#39;</span>)) {
<a name="l01344"></a>01344         $ag_scenario_shift = $this-&gt;scenarioshiftform-&gt;getObject();
<a name="l01345"></a>01345         $ag_scenario_shift-&gt;delete();
<a name="l01346"></a>01346         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/shifts?id=&#39;</span> . $this-&gt;scenario_id);
<a name="l01347"></a>01347 
<a name="l01348"></a>01348         <span class="comment">//DELETE</span>
<a name="l01349"></a>01349       }
<a name="l01350"></a>01350     } <span class="keywordflow">else</span> {
<a name="l01351"></a>01351 <span class="comment">//READ</span>
<a name="l01352"></a>01352       <span class="keywordflow">if</span> ($request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>) == <span class="stringliteral">&#39;new&#39;</span>) {
<a name="l01353"></a>01353         $this-&gt;scenarioshiftform = <span class="keyword">new</span> <a class="code" href="classagScenarioShiftForm.html" title="Creates Scenario Shift form.">agScenarioShiftForm</a>($this-&gt;scenario_id);
<a name="l01354"></a>01354         $this-&gt;setTemplate(<span class="stringliteral">&#39;editshift&#39;</span>);
<a name="l01355"></a>01355       } elseif ($request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>) &amp;&amp; is_numeric($request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>))) {
<a name="l01356"></a>01356 
<a name="l01357"></a>01357         $ag_scenario_shift = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>)
<a name="l01358"></a>01358             -&gt;findByDql(<span class="stringliteral">&#39;id = ?&#39;</span>, $request-&gt;getParameter(<span class="stringliteral">&#39;shiftid&#39;</span>))
<a name="l01359"></a>01359             -&gt;getFirst();
<a name="l01360"></a>01360 
<a name="l01361"></a>01361         $this-&gt;scenarioshiftform = <span class="keyword">new</span> <a class="code" href="classagScenarioShiftForm.html" title="Creates Scenario Shift form.">agScenarioShiftForm</a>($this-&gt;scenario_id, $ag_scenario_shift);
<a name="l01362"></a>01362         $this-&gt;setTemplate(<span class="stringliteral">&#39;editshift&#39;</span>);
<a name="l01363"></a>01363       } <span class="keywordflow">else</span> {
<a name="l01364"></a>01364 <span class="comment">//LIST</span>
<a name="l01365"></a>01365         <span class="comment">// shifts</span>
<a name="l01366"></a>01366         $shiftsData = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01367"></a>01367             -&gt;select(<span class="stringliteral">&#39;COUNT(ss.id) AS ctShifts&#39;</span>)
<a name="l01368"></a>01368             -&gt;addSelect(<span class="stringliteral">&#39;MIN(ss.minutes_start_to_facility_activation) AS minStart&#39;</span>)
<a name="l01369"></a>01369             -&gt;addSelect(<span class="stringliteral">&#39;MAX((ss.minutes_start_to_facility_activation + ss.task_length_minutes</span>
<a name="l01370"></a>01370 <span class="stringliteral">              + ss.break_length_minutes)) AS maxEnd&#39;</span>)
<a name="l01371"></a>01371             -&gt;from(<span class="stringliteral">&#39;agScenarioShift ss&#39;</span>)
<a name="l01372"></a>01372             -&gt;innerJoin(<span class="stringliteral">&#39;ss.agScenarioFacilityResource sfr&#39;</span>)
<a name="l01373"></a>01373             -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup sfg&#39;</span>)
<a name="l01374"></a>01374             -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id)
<a name="l01375"></a>01375             -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>);
<a name="l01376"></a>01376 
<a name="l01377"></a>01377         <span class="keywordflow">if</span> (array_key_exists(0, $shiftsData)) {
<a name="l01378"></a>01378           $this-&gt;shifts = $shiftsData[0][<span class="stringliteral">&#39;ss_ctShifts&#39;</span>];
<a name="l01379"></a>01379           $this-&gt;operationTime = <a class="code" href="classagDateTimeHelper.html#a44f01e4076795c28e1d24eb7bfff56a1" title="Method to return a minutes figure as a string by day, hour, and minute.">agDateTimeHelper::minsToComponentsStr</a>(($shiftsData[0][<span class="stringliteral">&#39;ss_maxEnd&#39;</span>]
<a name="l01380"></a>01380                   - $shiftsData[0][<span class="stringliteral">&#39;ss_minStart&#39;</span>]), TRUE);
<a name="l01381"></a>01381         } <span class="keywordflow">else</span> {
<a name="l01382"></a>01382           $this-&gt;shifts = 0;
<a name="l01383"></a>01383           $this-&gt;operationTime = 0;
<a name="l01384"></a>01384         }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 
<a name="l01387"></a>01387         $query = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01388"></a>01388             -&gt;select(<span class="stringliteral">&#39;ss.*, sfg.id, sfg.scenario_facility_group, sfr.id&#39;</span>)
<a name="l01389"></a>01389             -&gt;from(<span class="stringliteral">&#39;agScenarioShift as ss&#39;</span>)
<a name="l01390"></a>01390             -&gt;leftJoin(<span class="stringliteral">&#39;ss.agScenarioFacilityResource AS sfr&#39;</span>)
<a name="l01391"></a>01391             -&gt;leftJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup AS sfg&#39;</span>)
<a name="l01392"></a>01392             <span class="comment">//-&gt;leftJoin(&#39;sfg.agScenario AS s&#39;)</span>
<a name="l01393"></a>01393             -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenario_id);
<a name="l01394"></a>01394 
<a name="l01398"></a>01398         $this-&gt;pager = <span class="keyword">new</span> <a class="code" href="classsfDoctrinePager.html">sfDoctrinePager</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>, 20);
<a name="l01403"></a>01403         $this-&gt;pager-&gt;setQuery($query);
<a name="l01404"></a>01404 
<a name="l01408"></a>01408         $this-&gt;pager-&gt;setPage($request-&gt;getParameter(<span class="stringliteral">&#39;page&#39;</span>, 1));
<a name="l01409"></a>01409         $this-&gt;pager-&gt;init();
<a name="l01410"></a>01410       }
<a name="l01411"></a>01411     }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413 <span class="comment">//p-code</span>
<a name="l01414"></a>01414     $this-&gt;getResponse()-&gt;setTitle(<span class="stringliteral">&#39;Sahana Agasti Edit &#39;</span> . $this-&gt;scenario_name . <span class="stringliteral">&#39; Scenario&#39;</span>);
<a name="l01415"></a>01415 <span class="comment">//end p-code</span>
<a name="l01416"></a>01416   }
<a name="l01417"></a>01417 
<a name="l01424"></a><a class="code" href="classscenarioActions.html#a040af8d3f976f5e68c07ec26ffd06fdc">01424</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a040af8d3f976f5e68c07ec26ffd06fdc" title="executeScenarioshiftgroup() Display a list of scenario with scenario shifts defined...">executeScenarioshiftgroup</a>(sfWebRequest $request)
<a name="l01425"></a>01425   {
<a name="l01426"></a>01426     $query = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)
<a name="l01427"></a>01427         -&gt;createQuery(<span class="charliteral">&#39;s&#39;</span>)
<a name="l01428"></a>01428         -&gt;select(<span class="stringliteral">&#39;s.id, s.scenario,count(*) AS count&#39;</span>)
<a name="l01429"></a>01429         -&gt;from(<span class="stringliteral">&#39;agScenario AS s&#39;</span>)
<a name="l01430"></a>01430         -&gt;innerJoin(<span class="stringliteral">&#39;s.agScenarioFacilityGroup AS sfg&#39;</span>)
<a name="l01431"></a>01431         -&gt;innerJoin(<span class="stringliteral">&#39;sfg.agScenarioFacilityResource AS sfr&#39;</span>)
<a name="l01432"></a>01432         -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioShift AS ss&#39;</span>)
<a name="l01433"></a>01433         -&gt;groupBy(<span class="stringliteral">&#39;s.id, s.scenario&#39;</span>);
<a name="l01434"></a>01434 
<a name="l01438"></a>01438     $this-&gt;pager = <span class="keyword">new</span> <a class="code" href="classsfDoctrinePager.html">sfDoctrinePager</a>(<span class="stringliteral">&#39;agScenario&#39;</span>, 20);
<a name="l01439"></a>01439 
<a name="l01444"></a>01444     $this-&gt;pager-&gt;setQuery($query);
<a name="l01445"></a>01445 
<a name="l01449"></a>01449     $this-&gt;pager-&gt;setPage($request-&gt;getParameter(<span class="stringliteral">&#39;page&#39;</span>, 1));
<a name="l01450"></a>01450     $this-&gt;pager-&gt;init();
<a name="l01451"></a>01451   }
<a name="l01452"></a>01452 
<a name="l01457"></a><a class="code" href="classscenarioActions.html#aa51ae804bd19970b791f453e63a867fa">01457</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#aa51ae804bd19970b791f453e63a867fa" title="executeShowscenarioshiftgroup() defines the list of scenario shifts by scenario.">executeShowscenarioshiftgroup</a>(sfWebRequest $request)
<a name="l01458"></a>01458   {
<a name="l01459"></a>01459     $this-&gt;scenarioId = $request-&gt;getParameter(<span class="stringliteral">&#39;scenId&#39;</span>);
<a name="l01460"></a>01460     $this-&gt;scenarioName = ucwords(<a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)-&gt;find($this-&gt;scenarioId)-&gt;getScenario());
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     $query = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01463"></a>01463         -&gt;select(<span class="stringliteral">&#39;ss.*&#39;</span>)
<a name="l01464"></a>01464         -&gt;from(<span class="stringliteral">&#39;agScenarioShift AS ss&#39;</span>)
<a name="l01465"></a>01465         -&gt;innerJoin(<span class="stringliteral">&#39;ss.agScenarioFacilityResource AS sfr&#39;</span>)
<a name="l01466"></a>01466         -&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup AS sfg&#39;</span>)
<a name="l01467"></a>01467         -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id=?&#39;</span>, $this-&gt;scenarioId)
<a name="l01468"></a>01468     ;
<a name="l01469"></a>01469 
<a name="l01473"></a>01473     $this-&gt;pager = <span class="keyword">new</span> <a class="code" href="classsfDoctrinePager.html">sfDoctrinePager</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>, 20);
<a name="l01474"></a>01474 
<a name="l01479"></a>01479     $this-&gt;pager-&gt;setQuery($query);
<a name="l01480"></a>01480 
<a name="l01484"></a>01484     $this-&gt;pager-&gt;setPage($request-&gt;getParameter(<span class="stringliteral">&#39;page&#39;</span>, 1));
<a name="l01485"></a>01485     $this-&gt;pager-&gt;init();
<a name="l01486"></a>01486   }
<a name="l01487"></a>01487 
<a name="l01492"></a><a class="code" href="classscenarioActions.html#adce506a46667170c0a5a5c021b037498">01492</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#adce506a46667170c0a5a5c021b037498">executeGrouptypecreate</a>(sfWebRequest $request)
<a name="l01493"></a>01493   {
<a name="l01494"></a>01494     $this-&gt;ag_facility_group_types = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)
<a name="l01495"></a>01495         -&gt;createQuery(<span class="charliteral">&#39;a&#39;</span>)
<a name="l01496"></a>01496         -&gt;execute();
<a name="l01497"></a>01497     $this-&gt;forward404Unless($request-&gt;isMethod(sfRequest::POST));
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     $this-&gt;grouptypeform = <span class="keyword">new</span> <a class="code" href="classagFacilityGroupTypeForm.html" title="agFacilityGroupTypeForm.class.php extended base class.">agFacilityGroupTypeForm</a>();
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     $this-&gt;<a class="code" href="classscenarioActions.html#a98d15e227b4bf593398cff7e3a32afaa">processGrouptypeform</a>($request, $this-&gt;grouptypeform);
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     $this-&gt;setTemplate(<span class="stringliteral">&#39;grouptype&#39;</span>);
<a name="l01504"></a>01504   }
<a name="l01505"></a>01505 
<a name="l01510"></a><a class="code" href="classscenarioActions.html#a37e113ec940afdaecc212ed557b809c1">01510</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a37e113ec940afdaecc212ed557b809c1" title="Provides the edit group type form to the browser.">executeEditgrouptype</a>(sfWebRequest $request)
<a name="l01511"></a>01511   {
<a name="l01512"></a>01512     $this-&gt;forward404Unless($ag_facility_group_type = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)-&gt;find(array($request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))),
<a name="l01513"></a>01513                                                                                                                                         sprintf(<span class="stringliteral">&#39;Object ag_facility_group_type does not exist (%s).&#39;</span>,
<a name="l01514"></a>01514                                                                                                                                                 $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)));
<a name="l01515"></a>01515     $this-&gt;ag_facility_group_types = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)
<a name="l01516"></a>01516         -&gt;createQuery(<span class="charliteral">&#39;a&#39;</span>)
<a name="l01517"></a>01517         -&gt;execute();
<a name="l01518"></a>01518     $this-&gt;grouptypeform = <span class="keyword">new</span> <a class="code" href="classagFacilityGroupTypeForm.html" title="agFacilityGroupTypeForm.class.php extended base class.">agFacilityGroupTypeForm</a>($ag_facility_group_type);
<a name="l01519"></a>01519   }
<a name="l01520"></a>01520 
<a name="l01525"></a><a class="code" href="classscenarioActions.html#a359133320fde6037fbbb9be0f8514280">01525</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a359133320fde6037fbbb9be0f8514280" title="processing the update of a facility group type">executeGrouptypeupdate</a>(sfWebRequest $request)
<a name="l01526"></a>01526   {
<a name="l01527"></a>01527     $this-&gt;forward404Unless($request-&gt;isMethod(sfRequest::POST) || $request-&gt;isMethod(sfRequest::PUT));
<a name="l01528"></a>01528     $this-&gt;forward404Unless($ag_facility_group_type = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)-&gt;find(array($request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))),
<a name="l01529"></a>01529                                                                                                                                         sprintf(<span class="stringliteral">&#39;Object ag_facility_group_type does not exist (%s).&#39;</span>,
<a name="l01530"></a>01530                                                                                                                                                 $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)));
<a name="l01531"></a>01531     $this-&gt;grouptypeform = <span class="keyword">new</span> <a class="code" href="classagFacilityGroupTypeForm.html" title="agFacilityGroupTypeForm.class.php extended base class.">agFacilityGroupTypeForm</a>($ag_facility_group_type);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533     $this-&gt;<a class="code" href="classscenarioActions.html#a98d15e227b4bf593398cff7e3a32afaa">processGrouptypeform</a>($request, $this-&gt;grouptypeform);
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     $this-&gt;setTemplate(<span class="stringliteral">&#39;grouptype&#39;</span>);
<a name="l01536"></a>01536   }
<a name="l01537"></a>01537 
<a name="l01543"></a><a class="code" href="classscenarioActions.html#af1fd6ab08f86f2692d2871fc7dbd8363">01543</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#af1fd6ab08f86f2692d2871fc7dbd8363">executeDelete</a>(sfWebRequest $request)
<a name="l01544"></a>01544   {
<a name="l01545"></a>01545     $request-&gt;checkCSRFProtection();
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     $this-&gt;forward404Unless($ag_scenario = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenario&#39;</span>)-&gt;find(array($request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))),
<a name="l01548"></a>01548                                                                                                                     sprintf(<span class="stringliteral">&#39;Object ag_scenario does not exist (%s).&#39;</span>,
<a name="l01549"></a>01549                                                                                                                             $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)));
<a name="l01550"></a>01550 
<a name="l01551"></a>01551     $shiftTemplates = $ag_scenario-&gt;getAgShiftTemplate();
<a name="l01552"></a>01552 <span class="comment">//get all scenario shift templates</span>
<a name="l01553"></a>01553     <span class="keywordflow">foreach</span> ($shiftTemplates as $shiftTemplate) {
<a name="l01554"></a>01554       $shiftTemplate-&gt;delete();
<a name="l01555"></a>01555     }
<a name="l01556"></a>01556 
<a name="l01557"></a>01557     $scenarioStaffGenerators = $ag_scenario-&gt;getAgScenarioStaffGenerator();
<a name="l01558"></a>01558 <span class="comment">//get all scenario staff generator records (staff pool definitions) associated with the scenario</span>
<a name="l01559"></a>01559     <span class="keywordflow">foreach</span> ($scenarioStaffGenerators as $scenarioStaffGenerator) {
<a name="l01560"></a>01560       $scenarioStaffGenerator-&gt;delete();
<a name="l01561"></a>01561     }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563     $scenarioStaffResources = $ag_scenario-&gt;getAgScenarioStaffResource();
<a name="l01564"></a>01564 <span class="comment">//get all scenario staff resources</span>
<a name="l01565"></a>01565     <span class="keywordflow">foreach</span> ($scenarioStaffResources as $scenarioStaffResource) {
<a name="l01566"></a>01566       $scenarioStaffResource-&gt;delete();
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569     $scenarioStaffResources = $ag_scenario-&gt;getAgScenarioStaffResource();
<a name="l01570"></a>01570 <span class="comment">//get all scenario staff resources</span>
<a name="l01571"></a>01571     <span class="keywordflow">foreach</span> ($scenarioStaffResources as $scenarioStaffResource) {
<a name="l01572"></a>01572       $scenarioStaffResource-&gt;delete();
<a name="l01573"></a>01573     }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     $sfGroups = $ag_scenario-&gt;getAgScenarioFacilityGroup();
<a name="l01576"></a>01576 <span class="comment">//get all facility groups associated with the scenario</span>
<a name="l01577"></a>01577     <span class="keywordflow">foreach</span> ($sfGroups as $sfRes) {
<a name="l01578"></a>01578       $groupRes = $sfRes-&gt;getAgScenarioFacilityResource();
<a name="l01579"></a>01579 <span class="comment">//get all facility resources associated with the facility group</span>
<a name="l01580"></a>01580       <span class="keywordflow">foreach</span> ($groupRes as $gRes) {
<a name="l01581"></a>01581         $gRes-&gt;delete();
<a name="l01582"></a>01582       }
<a name="l01583"></a>01583       $sfRes-&gt;delete();
<a name="l01584"></a>01584     }
<a name="l01585"></a>01585     $ag_scenario-&gt;delete();
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     $this-&gt;redirect(<span class="stringliteral">&#39;scenario/list&#39;</span>);
<a name="l01589"></a>01589   }
<a name="l01590"></a>01590 
<a name="l01595"></a><a class="code" href="classscenarioActions.html#a7ca861231e1cd78f266a390e4f6c49c1">01595</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a7ca861231e1cd78f266a390e4f6c49c1" title="executeDeletegrouptype executes the logic to delete a facility group type">executeDeletegrouptype</a>(sfWebRequest $request)
<a name="l01596"></a>01596   {
<a name="l01597"></a>01597     $request-&gt;checkCSRFProtection();
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     $this-&gt;forward404Unless($ag_facility_group_type = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)-&gt;find(array($request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))),
<a name="l01600"></a>01600                                                                                                                                         sprintf(<span class="stringliteral">&#39;Object ag_facility_group_type does not exist (%s).&#39;</span>,
<a name="l01601"></a>01601                                                                                                                                                 $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)));
<a name="l01602"></a>01602     $facilityGroupTypeId = $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>);
<a name="l01603"></a>01603     $scenarioFacilityGroupByTypeCount = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01604"></a>01604                                         -&gt;select(<span class="stringliteral">&#39;COUNT(g.id)&#39;</span>)
<a name="l01605"></a>01605                                         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup AS g&#39;</span>)
<a name="l01606"></a>01606                                         -&gt;where(<span class="stringliteral">&#39;g.facility_group_type_id = ?&#39;</span>, $facilityGroupTypeId)
<a name="l01607"></a>01607                                         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609     $eventFacilityGroupByTypeCount = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01610"></a>01610                                      -&gt;select(<span class="stringliteral">&#39;COUNT(g.id)&#39;</span>)
<a name="l01611"></a>01611                                      -&gt;from(<span class="stringliteral">&#39;agEventFacilityGroup AS g&#39;</span>)
<a name="l01612"></a>01612                                      -&gt;where(<span class="stringliteral">&#39;g.facility_group_type_id = ?&#39;</span>, $facilityGroupTypeId)
<a name="l01613"></a>01613                                      -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l01614"></a>01614 
<a name="l01615"></a>01615     <span class="keywordflow">if</span> ( ($scenarioFacilityGroupByTypeCount == 0) &amp;&amp; ($eventFacilityGroupByTypeCount == 0) )
<a name="l01616"></a>01616     {
<a name="l01617"></a>01617       $ag_facility_group_type-&gt;delete();
<a name="l01618"></a>01618 
<a name="l01619"></a>01619       $this-&gt;redirect(<span class="stringliteral">&#39;scenario/grouptype&#39;</span>);
<a name="l01620"></a>01620     }
<a name="l01621"></a>01621     $this-&gt;facilityGroupType = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agFacilityGroupType&#39;</span>)-&gt;find($facilityGroupTypeId)-&gt;getFacilityGroupType();
<a name="l01622"></a>01622   }
<a name="l01623"></a>01623 
<a name="l01628"></a><a class="code" href="classscenarioActions.html#af0c2da9dadc70cfd0bfa1e9a716128ef">01628</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#af0c2da9dadc70cfd0bfa1e9a716128ef" title="executeDeleteshifttemplategroup()">executeDeleteshifttemplategroup</a>(sfWebRequest $request)
<a name="l01629"></a>01629   {
<a name="l01630"></a>01630     $this-&gt;forward404Unless($shftTmpGrp = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agShiftTemplate&#39;</span>)-&gt;createQuery(<span class="stringliteral">&#39;st&#39;</span>)-&gt;where(<span class="stringliteral">&#39;st.scenario_id=?&#39;</span>,
<a name="l01631"></a>01631                                                                                                                $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))-&gt;execute(),
<a name="l01632"></a>01632                                                                                                                                       sprintf(<span class="stringliteral">&#39;Object shift_template_group does not exist for scenario (%s).&#39;</span>,
<a name="l01633"></a>01633                                                                                                                                               $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>)));
<a name="l01634"></a>01634 
<a name="l01635"></a>01635 <span class="comment">//Delete all scenario shift relating to the scenario.</span>
<a name="l01636"></a>01636     $scenShftGrp = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>)-&gt;createQuery(<span class="stringliteral">&#39;ss&#39;</span>)-&gt;innerJoin(<span class="stringliteral">&#39;ss.agScenarioFacilityResource AS sfr&#39;</span>)-&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup AS sfg&#39;</span>)-&gt;where(<span class="stringliteral">&#39;sfg.scenario_id=?&#39;</span>,
<a name="l01637"></a>01637                                                                                                                                                                                             $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>))-&gt;execute();
<a name="l01638"></a>01638     <span class="keywordflow">foreach</span> ($scenShftGrp as $scenShft) {
<a name="l01639"></a>01639       $scenShft-&gt;delete();
<a name="l01640"></a>01640     }
<a name="l01641"></a>01641 
<a name="l01642"></a>01642 <span class="comment">//Delete all shift templates relating to the scenario.</span>
<a name="l01643"></a>01643     <span class="keywordflow">foreach</span> ($shftTmpGrp as $shftTmp) {
<a name="l01644"></a>01644       $shftTmp-&gt;delete();
<a name="l01645"></a>01645     }
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     $this-&gt;redirect(<span class="stringliteral">&#39;scenario/listshifttemplate&#39;</span>);
<a name="l01648"></a>01648   }
<a name="l01649"></a>01649 
<a name="l01654"></a><a class="code" href="classscenarioActions.html#a85416f5c2ab3fee0ae16f27ffe627b36">01654</a>   <span class="keyword">public</span> function <a class="code" href="classscenarioActions.html#a85416f5c2ab3fee0ae16f27ffe627b36" title="executeDeletescenarioshiftgroup()">executeDeletescenarioshiftgroup</a>(sfWebRequest $request)
<a name="l01655"></a>01655   {
<a name="l01656"></a>01656 <span class="comment">//    $request-&gt;checkCSRFProtection();</span>
<a name="l01657"></a>01657 <span class="comment">//    $this-&gt;forward404Unless($ag_scenario_shift_group = Doctrine_Core::getTable(&#39;agScenarioShift&#39;)-&gt;find(array($request-&gt;getParameter(&#39;scenId&#39;))), sprintf(&#39;Object ag_scenario_shift_group does not exist for scenario (%s).&#39;, $request-&gt;getParameter(&#39;scenId&#39;)));</span>
<a name="l01658"></a>01658     $this-&gt;forward404Unless($scenShftGrp = <a class="code" href="classDoctrine__Core.html#a2b20202aaba378351e7915e75b4b7e27" title="Get the Doctrine_Table object for the passed model.">Doctrine_Core::getTable</a>(<span class="stringliteral">&#39;agScenarioShift&#39;</span>)-&gt;createQuery(<span class="stringliteral">&#39;ss&#39;</span>)-&gt;innerJoin(<span class="stringliteral">&#39;ss.agScenarioFacilityResource AS sfr&#39;</span>)-&gt;innerJoin(<span class="stringliteral">&#39;sfr.agScenarioFacilityGroup AS sfg&#39;</span>)-&gt;where(<span class="stringliteral">&#39;sfg.scenario_id=?&#39;</span>,
<a name="l01659"></a>01659                                                                                                                                                                                                                     $request-&gt;getParameter(<span class="stringliteral">&#39;scenId&#39;</span>))-&gt;execute(),
<a name="l01660"></a>01660                                                                                                                                                                                                                                            sprintf(<span class="stringliteral">&#39;Object ag_scenario_shift_group does not exist for scenario (%s).&#39;</span>,
<a name="l01661"></a>01661                                                                                                                                                                                                                                                    $request-&gt;getParameter(<span class="stringliteral">&#39;scenId&#39;</span>)));
<a name="l01662"></a>01662 
<a name="l01663"></a>01663 <span class="comment">//Delete all scenario shift relating to the scenario.</span>
<a name="l01664"></a>01664     <span class="keywordflow">foreach</span> ($scenShftGrp as $scenShft) {
<a name="l01665"></a>01665       $scenShft-&gt;delete();
<a name="l01666"></a>01666     }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668     $this-&gt;redirect(<span class="stringliteral">&#39;scenario/scenarioshiftgroup&#39;</span>);
<a name="l01669"></a>01669   }
<a name="l01670"></a>01670 
<a name="l01678"></a><a class="code" href="classscenarioActions.html#adfd27bb851a3120811ba5f46af3e43e0">01678</a>   <span class="keyword">protected</span> function <a class="code" href="classscenarioActions.html#adfd27bb851a3120811ba5f46af3e43e0">processForm</a>(sfWebRequest $request, <a class="code" href="classsfForm.html">sfForm</a> $form)
<a name="l01679"></a>01679   {
<a name="l01680"></a>01680     $form-&gt;<a class="code" href="classsfForm.html#aa2f933561b7d73c96dae34e7e750151f" title="Binds the form with input values.">bind</a>($request-&gt;getParameter($form-&gt;<a class="code" href="classsfForm.html#ae2e0f2776affc971966229ce8ef37734" title="Returns the array name under which user data can retrieved.">getName</a>()), $request-&gt;getFiles($form-&gt;<a class="code" href="classsfForm.html#ae2e0f2776affc971966229ce8ef37734" title="Returns the array name under which user data can retrieved.">getName</a>()));
<a name="l01681"></a>01681     <span class="keywordflow">if</span> ($form-&gt;<a class="code" href="classsfForm.html#a3ce24db3ab577be065df5f5f370de6bb" title="Returns true if the form is valid.">isValid</a>()) {
<a name="l01682"></a>01682 
<a name="l01683"></a>01683       $ag_scenario = $form-&gt;save();
<a name="l01684"></a>01684       <span class="keywordflow">if</span> ($request-&gt;hasParameter(<span class="stringliteral">&#39;Continue&#39;</span>)) {
<a name="l01685"></a>01685         $this-&gt;ag_facility_resources = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l01686"></a>01686             -&gt;select(<span class="stringliteral">&#39;a.facility_id, af.*, afrt.*&#39;</span>)
<a name="l01687"></a>01687             -&gt;from(<span class="stringliteral">&#39;agFacilityResource a, a.agFacility af, a.agFacilityResourceType afrt&#39;</span>)
<a name="l01688"></a>01688             -&gt;execute();
<a name="l01689"></a>01689         $this-&gt;groupform = <span class="keyword">new</span> <a class="code" href="classagScenarioFacilityGroupForm.html" title="agScenarioFacilityGroupForm extended class for creating scenario specific facility...">agScenarioFacilityGroupForm</a>();
<a name="l01690"></a>01690 <span class="comment">//        $this-&gt;setTemplate(&#39;scenario/newgroup&#39;);</span>
<a name="l01691"></a>01691         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/fgroup?id=&#39;</span> . $ag_scenario-&gt;getId());
<a name="l01692"></a>01692       } <span class="keywordflow">else</span> {
<a name="l01693"></a>01693         $this-&gt;redirect(<span class="stringliteral">&#39;scenario/meta?id=&#39;</span> . $ag_scenario-&gt;getId());
<a name="l01694"></a>01694       }
<a name="l01695"></a>01695     }
<a name="l01696"></a>01696   }
<a name="l01697"></a>01697 
<a name="l01705"></a><a class="code" href="classscenarioActions.html#a98d15e227b4bf593398cff7e3a32afaa">01705</a>   <span class="keyword">protected</span> function <a class="code" href="classscenarioActions.html#a98d15e227b4bf593398cff7e3a32afaa">processGrouptypeform</a>(sfWebRequest $request, <a class="code" href="classsfForm.html">sfForm</a> $grouptypeform)
<a name="l01706"></a>01706   {
<a name="l01707"></a>01707     $grouptypeform-&gt;<a class="code" href="classsfForm.html#aa2f933561b7d73c96dae34e7e750151f" title="Binds the form with input values.">bind</a>($request-&gt;getParameter($grouptypeform-&gt;<a class="code" href="classsfForm.html#ae2e0f2776affc971966229ce8ef37734" title="Returns the array name under which user data can retrieved.">getName</a>()),
<a name="l01708"></a>01708                                                 $request-&gt;getFiles($grouptypeform-&gt;<a class="code" href="classsfForm.html#ae2e0f2776affc971966229ce8ef37734" title="Returns the array name under which user data can retrieved.">getName</a>()));
<a name="l01709"></a>01709     <span class="keywordflow">if</span> ($grouptypeform-&gt;<a class="code" href="classsfForm.html#a3ce24db3ab577be065df5f5f370de6bb" title="Returns true if the form is valid.">isValid</a>()) {
<a name="l01710"></a>01710       $ag_facility_group_type = $grouptypeform-&gt;save();
<a name="l01711"></a>01711 
<a name="l01712"></a>01712       $this-&gt;redirect(<span class="stringliteral">&#39;scenario/grouptype&#39;</span>);
<a name="l01713"></a>01713     }
<a name="l01714"></a>01714   }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716   <span class="keyword">public</span> function processShifttemplateform(sfWebRequest $request, <a class="code" href="classsfForm.html">sfForm</a> $shiftTemplateForm)
<a name="l01717"></a>01717   {
<a name="l01718"></a>01718     $shiftTemplateForm-&gt;<a class="code" href="classsfForm.html#aa2f933561b7d73c96dae34e7e750151f" title="Binds the form with input values.">bind</a>($request-&gt;getParameter($shiftTemplateForm-&gt;<a class="code" href="classsfForm.html#ae2e0f2776affc971966229ce8ef37734" title="Returns the array name under which user data can retrieved.">getName</a>()),
<a name="l01719"></a>01719                                                     $request-&gt;getFiles($shiftTemplateForm-&gt;<a class="code" href="classsfForm.html#ae2e0f2776affc971966229ce8ef37734" title="Returns the array name under which user data can retrieved.">getName</a>()));
<a name="l01720"></a>01720     <span class="keywordflow">if</span> ($shiftTemplateForm-&gt;<a class="code" href="classsfForm.html#a3ce24db3ab577be065df5f5f370de6bb" title="Returns true if the form is valid.">isValid</a>()) {
<a name="l01721"></a>01721       $ag_shift_template = $this-&gt;shiftGeneratorForm-&gt;saveEmbeddedForms();
<a name="l01722"></a>01722       $this-&gt;redirect(<span class="stringliteral">&#39;scenario/newshifttemplates?id=&#39;</span> . $request-&gt;getParameter(<span class="stringliteral">&#39;id&#39;</span>));
<a name="l01723"></a>01723     }
<a name="l01724"></a>01724   }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
