<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/lib/util/agImportHelper.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/lib/util/agImportHelper.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00017"></a><a class="code" href="classagImportHelper.html">00017</a> <span class="keyword">abstract</span> <span class="keyword">class </span><a class="code" href="classagImportHelper.html" title="Abstract class to provide import helper methods.">agImportHelper</a> <span class="keyword">extends</span> <a class="code" href="classagPdoHelper.html" title="Provides methods for implementing PDO queries.">agPdoHelper</a>
<a name="l00018"></a>00018 {
<a name="l00019"></a>00019   <span class="keyword">const</span> CONN_TEMP_READ = <span class="stringliteral">&#39;import_temp_read&#39;</span>;
<a name="l00020"></a>00020   <span class="keyword">const</span> CONN_TEMP_WRITE = <span class="stringliteral">&#39;import_temp_write&#39;</span>;
<a name="l00021"></a>00021 
<a name="l00022"></a>00022   <span class="keyword">protected</span> $fileInfo,
<a name="l00023"></a>00023   $tempTable,
<a name="l00024"></a>00024   $tempTableOptions = array(),
<a name="l00025"></a>00025   $importSpec = array(),
<a name="l00026"></a>00026   $specStrLengths = array(),
<a name="l00027"></a>00027   $requiredImportColumns = array(),
<a name="l00028"></a>00028   $successColumn = <span class="stringliteral">&#39;_import_success&#39;</span>,
<a name="l00029"></a>00029   $idColumn = <span class="stringliteral">&#39;id&#39;</span>,
<a name="l00030"></a>00030   $excelImportBatchSize = 2500,
<a name="l00031"></a>00031   $dynamicFieldType,
<a name="l00032"></a>00032   $importHeaderStrictValidation = FALSE,
<a name="l00033"></a>00033   $iterData,
<a name="l00034"></a>00034   $maxBatchTime;
<a name="l00035"></a>00035 
<a name="l00039"></a>00039   <span class="keyword">protected</span> $eh;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   <span class="keyword">abstract</span> <span class="keyword">protected</span> function setImportSpec();
<a name="l00042"></a>00042 
<a name="l00043"></a>00043   <span class="keyword">abstract</span> <span class="keyword">protected</span> function setDynamicFieldType();
<a name="l00044"></a>00044 
<a name="l00045"></a>00045   <span class="keyword">abstract</span> <span class="keyword">protected</span> function cleanColumnName($columnName);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047   <span class="keyword">abstract</span> <span class="keyword">protected</span> function addDynamicColumns(array $importHeaders);
<a name="l00048"></a>00048 
<a name="l00054"></a><a class="code" href="classagImportHelper.html#ae0dd6d6ba63e563285eaf47bafec251a">00054</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#ae0dd6d6ba63e563285eaf47bafec251a" title="Method to initialize this class.">__init</a>($tempTable, $logEventLevel)
<a name="l00055"></a>00055   {
<a name="l00056"></a>00056     <span class="keywordflow">if</span> (<a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;clear_cache_on_import&#39;</span>) == 1) {
<a name="l00057"></a>00057       apc_clear_cache();
<a name="l00058"></a>00058       apc_clear_cache(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00059"></a>00059     }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061     $this-&gt;maxBatchTime = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;bulk_operation_max_batch_time&#39;</span>);
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     $this-&gt;eh = <span class="keyword">new</span> <a class="code" href="classagEventHandler.html" title="Abstract class to provide event and log handling methods.">agEventHandler</a>($logEventLevel, agEventHandler::EVENT_NOTICE,
<a name="l00064"></a>00064             sfContext::getInstance());
<a name="l00065"></a>00065 
<a name="l00066"></a>00066     <span class="comment">// get our error threshold</span>
<a name="l00067"></a>00067     $this-&gt;errThreshold = intval(<a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;import_error_threshold&#39;</span>));
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="comment">// sets our temp table and builds our import specification</span>
<a name="l00070"></a>00070     $this-&gt;tempTable = $tempTable;
<a name="l00071"></a>00071     $this-&gt;<a class="code" href="classagImportHelper.html#a8df7ce050f29e22fcdf0c45d5a923008" title="Method to process and refine an import specification.">processImportSpec</a>();
<a name="l00072"></a>00072     $this-&gt;setDynamicFieldType();
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="comment">// reset our iterators</span>
<a name="l00075"></a>00075     $this-&gt;<a class="code" href="classagImportHelper.html#a76e7ff4946fbf5f951636791e21620ca" title="Method to reset ALL iter data.">resetIterData</a>();
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">// memory usage</span>
<a name="l00078"></a>00078     $this-&gt;peakMemory = 0;
<a name="l00079"></a>00079   }
<a name="l00080"></a>00080 
<a name="l00084"></a><a class="code" href="classagImportHelper.html#a48814188b9077dfd052d723351429812">00084</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a48814188b9077dfd052d723351429812" title="Method to set the import connection object property.">setConnections</a>()
<a name="l00085"></a>00085   {
<a name="l00086"></a>00086     $dm = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="comment">// always re-parent, then &#39;copy&#39; the connection</span>
<a name="l00089"></a>00089     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00090"></a>00090     $adapter = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>()-&gt;getDbh();
<a name="l00091"></a>00091     $this-&gt;_conn[self::CONN_TEMP_READ] = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>($adapter, self::CONN_TEMP_READ);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     <span class="comment">// always re-parent, then &#39;copy&#39; the connection</span>
<a name="l00094"></a>00094     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00095"></a>00095     $adapter = $dm-&gt;getCurrentConnection()-&gt;getDbh();
<a name="l00096"></a>00096     $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>($adapter, self::CONN_TEMP_WRITE);
<a name="l00097"></a>00097     $conn-&gt;setAttribute(Doctrine_Core::ATTR_AUTO_FREE_QUERY_OBJECTS, TRUE);
<a name="l00098"></a>00098     $conn-&gt;setAttribute(Doctrine_Core::ATTR_USE_DQL_CALLBACKS, FALSE);
<a name="l00099"></a>00099     $conn-&gt;setAttribute(Doctrine_Core::ATTR_AUTOLOAD_TABLE_CLASSES, FALSE);
<a name="l00100"></a>00100     $conn-&gt;setAttribute(<a class="code" href="classDoctrine__Core.html#a91839462e9d627a6b20ed0629a98b77d" title="ATTRIBUTE CONSTANTS.">Doctrine_Core::ATTR_AUTOCOMMIT</a>, FALSE);
<a name="l00101"></a>00101     $conn-&gt;setAttribute(Doctrine_Core::ATTR_LOAD_REFERENCES, FALSE);
<a name="l00102"></a>00102     $conn-&gt;setAttribute(Doctrine_Core::ATTR_VALIDATE, FALSE);
<a name="l00103"></a>00103     $conn-&gt;setAttribute(Doctrine_Core::ATTR_CASCADE_SAVES, FALSE);
<a name="l00104"></a>00104     $this-&gt;_conn[self::CONN_TEMP_WRITE] = $conn;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="comment">// reset our default connection</span>
<a name="l00107"></a>00107     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00108"></a>00108   }
<a name="l00109"></a>00109 
<a name="l00113"></a><a class="code" href="classagImportHelper.html#a0a661a2107c5f1d551cd4199feae66a2">00113</a>   <span class="keyword">public</span> function <a class="code" href="classagImportHelper.html#a0a661a2107c5f1d551cd4199feae66a2" title="This classes&amp;#39; destructor.">__destruct</a>()
<a name="l00114"></a>00114   {
<a name="l00115"></a>00115     <span class="comment">// the parent&#39;s destructor will rollback any oustanding open transactions and close conns</span>
<a name="l00116"></a>00116     <a class="code" href="classagImportHelper.html#a0a661a2107c5f1d551cd4199feae66a2" title="This classes&amp;#39; destructor.">parent::__destruct</a>();
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="comment">// removes the temporary file</span>
<a name="l00119"></a>00119     $file = $this-&gt;fileInfo[<span class="stringliteral">&#39;dirname&#39;</span>] . DIRECTORY_SEPARATOR . $this-&gt;fileInfo[<span class="stringliteral">&#39;basename&#39;</span>];
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (!@unlink($file)) {
<a name="l00121"></a>00121       $this-&gt;eh-&gt;logAlert(<span class="stringliteral">&#39;Failed to delete the {&#39;</span> . $this-&gt;fileInfo[<span class="stringliteral">&#39;basename&#39;</span>] . <span class="stringliteral">&#39;} import file.&#39;</span>);
<a name="l00122"></a>00122     } <span class="keywordflow">else</span> {
<a name="l00123"></a>00123       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully deleted the {&#39;</span> . $this-&gt;fileInfo[<span class="stringliteral">&#39;basename&#39;</span>] . <span class="stringliteral">&#39;} import file.&#39;</span>);
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126 
<a name="l00135"></a><a class="code" href="classagImportHelper.html#aee8ec48641c860f762b2d26855cf4c89">00135</a>   <span class="keyword">protected</span> <span class="keyword">static</span> function <a class="code" href="classagImportHelper.html#aee8ec48641c860f762b2d26855cf4c89">getSpecificationStrLen</a>(array $columnDefinition) {
<a name="l00136"></a>00136     <span class="comment">// string length / type comparison auto-magic</span>
<a name="l00137"></a>00137     <span class="keywordflow">switch</span>($columnDefinition[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l00138"></a>00138       <span class="keywordflow">case</span> <span class="stringliteral">&#39;integer&#39;</span>:
<a name="l00139"></a>00139       <span class="keywordflow">case</span> <span class="stringliteral">&#39;int&#39;</span>:
<a name="l00140"></a>00140         <span class="keywordflow">return</span> strlen(pow(256, $columnDefinition[<span class="stringliteral">&#39;length&#39;</span>])) + 1;
<a name="l00141"></a>00141         <span class="keywordflow">break</span>;
<a name="l00142"></a>00142       <span class="keywordflow">case</span> <span class="stringliteral">&#39;decimal&#39;</span>:
<a name="l00143"></a>00143       <span class="keywordflow">case</span> <span class="stringliteral">&#39;dec&#39;</span>:
<a name="l00144"></a>00144         <span class="keywordflow">return</span> $columnDefinition[<span class="stringliteral">&#39;length&#39;</span>] + 2;
<a name="l00145"></a>00145         <span class="keywordflow">break</span>;
<a name="l00146"></a>00146       <span class="keywordflow">default</span>:
<a name="l00147"></a>00147         <span class="keywordflow">return</span> $columnDefinition[<span class="stringliteral">&#39;length&#39;</span>];
<a name="l00148"></a>00148         <span class="keywordflow">break</span>;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151 
<a name="l00155"></a><a class="code" href="classagImportHelper.html#a8df7ce050f29e22fcdf0c45d5a923008">00155</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a8df7ce050f29e22fcdf0c45d5a923008" title="Method to process and refine an import specification.">processImportSpec</a>()
<a name="l00156"></a>00156   {
<a name="l00157"></a>00157     <span class="comment">// first get the basics from our helper (this must be set in the child classes)</span>
<a name="l00158"></a>00158     $this-&gt;setImportSpec();
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">// now add some records-keeping fields we&#39;ll need across usages</span>
<a name="l00161"></a>00161     $this-&gt;requiredImportColumns[$this-&gt;idColumn] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;integer&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 20,
<a name="l00162"></a>00162       <span class="stringliteral">&#39;autoincrement&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;primary&#39;</span> =&gt; <span class="keyword">true</span>);
<a name="l00163"></a>00163     $this-&gt;requiredImportColumns[$this-&gt;successColumn] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&quot;boolean&quot;</span>);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="comment">// we can&#39;t trust that they got it right so we&#39;re going to clean import spec columns</span>
<a name="l00166"></a>00166     <span class="keywordflow">foreach</span> ($this-&gt;importSpec as $column =&gt; $value) {
<a name="l00167"></a>00167       $cleanColumn = $this-&gt;cleanColumnName($column);
<a name="l00168"></a>00168       <span class="keywordflow">if</span> ($column != $cleanColumn) {
<a name="l00169"></a>00169         unset($this-&gt;importSpec[$column]);
<a name="l00170"></a>00170         $this-&gt;importSpec[$cleanColumn] = $value;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         $eventMsg = <span class="stringliteral">&#39;Import spec column name {&#39;</span> . $column . <span class="stringliteral">&#39;} was not clean and was &#39;</span> .
<a name="l00173"></a>00173             <span class="stringliteral">&#39;automatically renamed to {&#39;</span> . $cleanColumn . <span class="stringliteral">&#39;}. It is recommended you correct this in&#39;</span> .
<a name="l00174"></a>00174             <span class="stringliteral">&#39;your import spec declaration.&#39;</span>;
<a name="l00175"></a>00175         $this-&gt;eh-&gt;logWarning($eventMsg);
<a name="l00176"></a>00176       }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178       $this-&gt;specStrLengths[$cleanColumn] = <a class="code" href="classagImportHelper.html#aee8ec48641c860f762b2d26855cf4c89">self::getSpecificationStrLen</a>($value);
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180   }
<a name="l00181"></a>00181 
<a name="l00185"></a><a class="code" href="classagImportHelper.html#a76e7ff4946fbf5f951636791e21620ca">00185</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a76e7ff4946fbf5f951636791e21620ca" title="Method to reset ALL iter data.">resetIterData</a>()
<a name="l00186"></a>00186   {
<a name="l00187"></a>00187     $this-&gt;iterData = array();
<a name="l00188"></a>00188     $this-&gt;<a class="code" href="classagImportHelper.html#a886c5c81c56a4ac584f1574bdb6571c1" title="Method to reset the temp iterator data.">resetTempIterData</a>();
<a name="l00189"></a>00189   }
<a name="l00190"></a>00190 
<a name="l00194"></a><a class="code" href="classagImportHelper.html#a886c5c81c56a4ac584f1574bdb6571c1">00194</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a886c5c81c56a4ac584f1574bdb6571c1" title="Method to reset the temp iterator data.">resetTempIterData</a>()
<a name="l00195"></a>00195   {
<a name="l00196"></a>00196     $this-&gt;iterData[<span class="stringliteral">&#39;tempPosition&#39;</span>] = 0;
<a name="l00197"></a>00197     $this-&gt;iterData[<span class="stringliteral">&#39;tempCount&#39;</span>] = 0;
<a name="l00198"></a>00198     $this-&gt;iterData[<span class="stringliteral">&#39;tempErrCt&#39;</span>] = 0;
<a name="l00199"></a>00199   }
<a name="l00200"></a>00200 
<a name="l00209"></a><a class="code" href="classagImportHelper.html#a895d6262085bfd6b0b40e21516f95769">00209</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a895d6262085bfd6b0b40e21516f95769" title="Method to lazily load and return the pathinfo for $importFile.">getFileInfo</a>($importFile)
<a name="l00210"></a>00210   {
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (!isset($this-&gt;fileInfo)) {
<a name="l00212"></a>00212       $this-&gt;fileInfo = pathinfo($importFile);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     <span class="keywordflow">return</span> $this-&gt;fileInfo;
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216 
<a name="l00221"></a><a class="code" href="classagImportHelper.html#a6e668b52fd23e135385ba2fcef739ccf">00221</a>   <span class="keyword">public</span> function <a class="code" href="classagImportHelper.html#a6e668b52fd23e135385ba2fcef739ccf" title="Method to get the iterData array.">getIterData</a>()
<a name="l00222"></a>00222   {
<a name="l00223"></a>00223     <span class="keywordflow">return</span> $this-&gt;iterData;
<a name="l00224"></a>00224   }
<a name="l00225"></a>00225 
<a name="l00231"></a><a class="code" href="classagImportHelper.html#a472e879aed0f57b0307cc69e20fa78fd">00231</a>   <span class="keyword">public</span> function <a class="code" href="classagImportHelper.html#a472e879aed0f57b0307cc69e20fa78fd" title="Returns the peak memory.">getPeakMemoryUsage</a>()
<a name="l00232"></a>00232   {
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="comment">// Take some peak memory metrics</span>
<a name="l00235"></a>00235     $memoryUsage = memory_get_usage();
<a name="l00236"></a>00236     <span class="keywordflow">if</span> ($memoryUsage &gt; $this-&gt;peakMemory) {
<a name="l00237"></a>00237       $this-&gt;peakMemory = $memoryUsage;
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keywordflow">return</span> $this-&gt;peakMemory;
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <span class="keyword">public</span> function processXlsImportFile($importFile)
<a name="l00244"></a>00244   {
<a name="l00245"></a>00245     <span class="comment">// Validates the uploaded files Excel 2003 extention</span>
<a name="l00246"></a>00246     $this-&gt;<a class="code" href="classagImportHelper.html#a895d6262085bfd6b0b40e21516f95769" title="Method to lazily load and return the pathinfo for $importFile.">getFileInfo</a>($importFile);
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (strtolower($this-&gt;fileInfo[<span class="stringliteral">&#39;extension&#39;</span>]) &lt;&gt; <span class="stringliteral">&#39;xls&#39;</span>) {
<a name="l00248"></a>00248       $errMsg = <span class="charliteral">&#39;{&#39;</span> . $this-&gt;fileInfo[<span class="stringliteral">&#39;basename&#39;</span>] .
<a name="l00249"></a>00249           <span class="stringliteral">&#39;} is not a Microsoft Excel 2003 &quot;.xls&quot; workbook.&#39;</span>;
<a name="l00250"></a>00250       $this-&gt;eh-&gt;logEmerg($errMsg);
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">// opens the import file</span>
<a name="l00254"></a>00254     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Opening the import file (&#39;</span> . $this-&gt;fileInfo[<span class="stringliteral">&#39;basename&#39;</span>] . <span class="stringliteral">&#39;).&#39;</span>);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="comment">// Get the current PHP error level</span>
<a name="l00257"></a>00257     $errorlevel = error_reporting();
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">// ignores php warnings generated by old, crufty lib (Spreadsheet_Excel_Reader)</span>
<a name="l00260"></a>00260     error_reporting($errorlevel &amp; ~E_NOTICE &amp; ~E_DEPRECATED);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     $xlsObj = <span class="keyword">new</span> <a class="code" href="classspreadsheetExcelReader.html">spreadsheetExcelReader</a>($importFile, FALSE);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="comment">// restores original PHP error level</span>
<a name="l00265"></a>00265     error_reporting($errorlevel);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully opened the import file (&#39;</span> . $this-&gt;fileInfo[<span class="stringliteral">&#39;basename&#39;</span>] . <span class="stringliteral">&#39;).&#39;</span>);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="comment">// Get some info about the workbook&#39;s composition</span>
<a name="l00270"></a>00270     $numSheets = count($xlsObj-&gt;sheets);
<a name="l00271"></a>00271     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Number of worksheets found: {&#39;</span> . $numSheets . <span class="charliteral">&#39;}&#39;</span>);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="comment">// Create a simplified array from the worksheets</span>
<a name="l00274"></a>00274     <span class="keywordflow">for</span> ($sheet = 0; $sheet &lt; $numSheets; $sheet++) {
<a name="l00275"></a>00275       set_time_limit($this-&gt;maxBatchTime);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277       <span class="comment">// Get the sheet name</span>
<a name="l00278"></a>00278       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Opening worksheet {&#39;</span> . $sheet . <span class="charliteral">&#39;}&#39;</span>);
<a name="l00279"></a>00279       $sheetName = $xlsObj-&gt;boundsheets[$sheet][<span class="stringliteral">&#39;name&#39;</span>];
<a name="l00280"></a>00280 
<a name="l00281"></a>00281       <span class="comment">// We don&#39;t import sheets named &quot;Lookup&quot; so we&#39;ll skip the remainder of this loop</span>
<a name="l00282"></a>00282       <span class="keywordflow">if</span> (strtolower($sheetName) == <span class="stringliteral">&#39;lookup&#39;</span>) {
<a name="l00283"></a>00283         $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Ignoring {&#39;</span> . $sheetName . <span class="stringliteral">&#39;} worksheet&#39;</span>);
<a name="l00284"></a>00284         <span class="keywordflow">continue</span>;
<a name="l00285"></a>00285       }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287       <span class="comment">// Check whether the sheet has a header row.</span>
<a name="l00288"></a>00288       <span class="keywordflow">if</span> (isset($xlsObj-&gt;sheets[$sheet][<span class="stringliteral">&#39;cells&#39;</span>][1]))
<a name="l00289"></a>00289       {
<a name="l00290"></a>00290         <span class="comment">// Grab column headers at the beginning of each sheet.</span>
<a name="l00291"></a>00291         $currentSheetHeaders = $xlsObj-&gt;sheets[$sheet][<span class="stringliteral">&#39;cells&#39;</span>][1];
<a name="l00292"></a>00292       }
<a name="l00293"></a>00293       <span class="keywordflow">else</span>
<a name="l00294"></a>00294       {
<a name="l00295"></a>00295         $eventMsg = <span class="stringliteral">&quot;This worksheet &quot;</span> . $sheetName . <span class="stringliteral">&quot; does not have a valid column headers for data import.&quot;</span>;
<a name="l00296"></a>00296         $errCount = 1;
<a name="l00297"></a>00297         $this-&gt;eh-&gt;logEmerg($eventMsg, $errCount);
<a name="l00298"></a>00298       }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300       <span class="comment">// clean the column headers to ensure consistency</span>
<a name="l00301"></a>00301       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Cleaning worksheet headers&#39;</span>);
<a name="l00302"></a>00302       <span class="keywordflow">foreach</span> ($currentSheetHeaders as $index =&gt; &amp;$header) {
<a name="l00303"></a>00303         $header = $this-&gt;cleanColumnName($header);
<a name="l00304"></a>00304       }
<a name="l00305"></a>00305       unset($header);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307       <span class="comment">// count our total rows (specific to each sheet)</span>
<a name="l00308"></a>00308       $numRows = $xlsObj-&gt;rowcount($sheet);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310       <span class="comment">// Check for consistant column header in all data worksheets.  Use the column header from</span>
<a name="l00311"></a>00311       <span class="comment">// the first worksheet as the import column header for all data worksheets.</span>
<a name="l00312"></a>00312       <span class="keywordflow">if</span> ($sheet == 0) {
<a name="l00313"></a>00313         <span class="comment">// count our columns (only needed once since first sheet is treated as template)</span>
<a name="l00314"></a>00314         $numCols = $xlsObj-&gt;colcount($sheet);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="comment">// Extend import spec headers with dynamic staff resource requirement columns from xls file.</span>
<a name="l00317"></a>00317         $this-&gt;addDynamicColumns($currentSheetHeaders);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         <span class="comment">// Might seem weird, but we do this to ensure that column orders are consistent in import</span>
<a name="l00320"></a>00320         <span class="comment">// spec AND the sheet headers (makes some things faster)</span>
<a name="l00321"></a>00321         $importSpec = array();
<a name="l00322"></a>00322         <span class="keywordflow">foreach</span> ($currentSheetHeaders as $header) {
<a name="l00323"></a>00323           $importSpec[$header] = $this-&gt;importSpec[$header];
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325         $this-&gt;importSpec = $importSpec;
<a name="l00326"></a>00326         unset($header);
<a name="l00327"></a>00327         unset($importSpec);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="comment">// create the temp table</span>
<a name="l00330"></a>00330         $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Creating temporary import table {&#39;</span> . $this-&gt;tempTable . <span class="charliteral">&#39;}&#39;</span>);
<a name="l00331"></a>00331         $this-&gt;<a class="code" href="classagImportHelper.html#aaf1270a84f93b2331c1ba9a50d8be409" title="Method to create an import temp table.">createTempTable</a>();
<a name="l00332"></a>00332       }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Validating column headers for sheet {&#39;</span> . $sheetName . <span class="stringliteral">&#39;}.&#39;</span>);
<a name="l00335"></a>00335       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classagImportHelper.html#a192156cd03776ef5797781696bdf3111" title="This method provides simple validation of import file column headers.">validateColumnHeaders</a>($currentSheetHeaders, $sheetName)) {
<a name="l00336"></a>00336         $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Valid column headers found!&#39;</span>);
<a name="l00337"></a>00337       } <span class="keywordflow">else</span> {
<a name="l00338"></a>00338         <span class="keywordflow">if</span> ($this-&gt;importHeaderStrictValidation) {
<a name="l00339"></a>00339           $errMsg = <span class="stringliteral">&#39;Unable to import file due to failed validation of import headers. (Strict &#39;</span> .
<a name="l00340"></a>00340               <span class="stringliteral">&#39;header validation is currently enforced!)&#39;</span>;
<a name="l00341"></a>00341           $this-&gt;eh-&gt;logEmerg($errMsg);
<a name="l00342"></a>00342         } <span class="keywordflow">else</span> {
<a name="l00343"></a>00343           $errMsg = <span class="stringliteral">&#39;Import sheet {&#39;</span> . $sheetName . <span class="stringliteral">&#39;} failed column header validation. Skipping &#39;</span> .
<a name="l00344"></a>00344               <span class="stringliteral">&#39;import of this sheet. (Strict header validation is not currently enforced!)&#39;</span>;
<a name="l00345"></a>00345           $this-&gt;eh-&gt;logErr($errMsg);
<a name="l00346"></a>00346           <span class="keywordflow">continue</span>;
<a name="l00347"></a>00347         }
<a name="l00348"></a>00348       }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       <span class="comment">// Declare our initial batch data</span>
<a name="l00351"></a>00351       $batches = intval(ceil(($numRows / $this-&gt;excelImportBatchSize)));
<a name="l00352"></a>00352       $batchStart = 2;
<a name="l00353"></a>00353       $batchEnd = $this-&gt;excelImportBatchSize;
<a name="l00354"></a>00354       <span class="keywordflow">if</span> ($batchEnd &gt; $numRows) {
<a name="l00355"></a>00355         $batchEnd = $numRows;
<a name="l00356"></a>00356       }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358       <span class="comment">// start by looping our batches</span>
<a name="l00359"></a>00359       <span class="keywordflow">for</span> ($batch = 1; $batch &lt;= $batches; $batch++) {
<a name="l00360"></a>00360         $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Processing batch {&#39;</span> . $batch . <span class="stringliteral">&#39;} of {&#39;</span> . $batches . <span class="stringliteral">&#39;}.&#39;</span>);
<a name="l00361"></a>00361         <span class="comment">// each batch clears the import data array</span>
<a name="l00362"></a>00362         $importFileData = array();
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="comment">// begin adding rows and continue to the end for this batch</span>
<a name="l00365"></a>00365         <span class="keywordflow">for</span> ($row = $batchStart; $row &lt;= $batchEnd; $row++) {
<a name="l00366"></a>00366           $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Reading row {&#39;</span> . $row . <span class="stringliteral">&#39;} into import data array.&#39;</span>);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368           <span class="comment">// used to tell if the row is empty</span>
<a name="l00369"></a>00369           $notNull = FALSE;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371           <span class="comment">// helpful little declarations</span>
<a name="l00372"></a>00372           $importRow = array();
<a name="l00373"></a>00373 
<a name="l00374"></a>00374           <span class="comment">// then loop the columns</span>
<a name="l00375"></a>00375           <span class="keywordflow">for</span> ($col = 1; $col &lt;= $numCols; $col++) {
<a name="l00376"></a>00376             <span class="comment">// try to grab the raw value</span>
<a name="l00377"></a>00377             $val = $xlsObj-&gt;raw($row, $col, $sheet);
<a name="l00378"></a>00378             <span class="keywordflow">if</span> (!$val) {
<a name="l00379"></a>00379               <span class="comment">// failing that, grab its formatted value</span>
<a name="l00380"></a>00380               $val = $xlsObj-&gt;val($row, $col, $sheet);
<a name="l00381"></a>00381             }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383             <span class="comment">// clean the data a little, null out long values and zero length strings</span>
<a name="l00384"></a>00384             $val = trim($val);
<a name="l00385"></a>00385             <span class="keywordflow">if</span> ($val == <span class="stringliteral">&#39;&#39;</span> || is_null($val)) {
<a name="l00386"></a>00386               $val = NULL;
<a name="l00387"></a>00387             } elseif (strlen(strval($val)) &gt; $this-&gt;specStrLengths[$currentSheetHeaders[$col]]) {
<a name="l00388"></a>00388               $eventMsg = <span class="stringliteral">&#39;Value in sheet {&#39;</span> . $sheet . <span class="stringliteral">&#39;} row {&#39;</span> . $row . <span class="stringliteral">&#39;} column {&#39;</span> .
<a name="l00389"></a>00389                   $currentSheetHeaders[$col] . <span class="stringliteral">&#39;} is too long and was set to NULL.&#39;</span>;
<a name="l00390"></a>00390               $this-&gt;eh-&gt;logWarning($eventMsg);
<a name="l00391"></a>00391               $val = NULL;
<a name="l00392"></a>00392             } <span class="keywordflow">else</span> {
<a name="l00393"></a>00393               $notNull = TRUE;
<a name="l00394"></a>00394             }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396             <span class="comment">// add the data, either way, to our importRow variable using the column name we picked up</span>
<a name="l00397"></a>00397             <span class="comment">// off the first sheet</span>
<a name="l00398"></a>00398             $importRow[$currentSheetHeaders[$col]] = $val;
<a name="l00399"></a>00399             unset($val);
<a name="l00400"></a>00400           }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402           <span class="comment">// check for empty rows early to prevent</span>
<a name="l00403"></a>00403           <span class="keywordflow">if</span> (!$notNull) {
<a name="l00404"></a>00404             $this-&gt;eh-&gt;logWarning(<span class="stringliteral">&#39;Empty row found at sheet {&#39;</span> . $sheet . <span class="stringliteral">&#39;} row {&#39;</span> . $row . <span class="stringliteral">&#39;}. Skipping.&#39;</span>);
<a name="l00405"></a>00405           } <span class="keywordflow">else</span> {
<a name="l00406"></a>00406             $importFileData[$row] = $importRow;
<a name="l00407"></a>00407           }
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="comment">// process this batch</span>
<a name="l00411"></a>00411         $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully loaded batch {&#39;</span> . $batch . <span class="stringliteral">&#39;} from file, now inserting into &#39;</span> .
<a name="l00412"></a>00412             <span class="stringliteral">&#39;temp table {&#39;</span> . $this-&gt;tempTable . <span class="charliteral">&#39;}&#39;</span>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         $inserted = $this-&gt;saveImportTempIter($importFileData);
<a name="l00415"></a>00415         $this-&gt;iterData[<span class="stringliteral">&#39;tempCount&#39;</span>] += $inserted;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <span class="comment">// up our batch counters</span>
<a name="l00418"></a>00418         $batchStart = $batchEnd + 1;
<a name="l00419"></a>00419         $batchEnd = $batchStart + $this-&gt;excelImportBatchSize;
<a name="l00420"></a>00420         <span class="keywordflow">if</span> ($batchEnd &gt; $numRows) {
<a name="l00421"></a>00421           $batchEnd = $numRows;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423       }
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="comment">// Log our success and return T/F based on whether or not any non-fatal errors occurred</span>
<a name="l00427"></a>00427     $okMsg = <span class="stringliteral">&#39;Completed insertion of &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;tempCount&#39;</span>] . <span class="stringliteral">&#39; rows from the import &#39;</span> .
<a name="l00428"></a>00428         <span class="stringliteral">&#39;file to the temporary table.&#39;</span>;
<a name="l00429"></a>00429     $this-&gt;eh-&gt;logNotice($okMsg);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="keywordflow">return</span> ($this-&gt;eh-&gt;getErrCount() == 0) ? TRUE : FALSE;
<a name="l00432"></a>00432   }
<a name="l00433"></a>00433 
<a name="l00440"></a>00440   <span class="keyword">private</span> function prepareImportTemp(<a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn)
<a name="l00441"></a>00441   {
<a name="l00442"></a>00442     <span class="comment">// loop through the import spec and build our columns / values blocks</span>
<a name="l00443"></a>00443     $cols = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00444"></a>00444     $vals = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00445"></a>00445     <span class="keywordflow">foreach</span> ($this-&gt;importSpec as $column =&gt; $spec) {
<a name="l00446"></a>00446       $cols = $cols . <span class="charliteral">&#39;`&#39;</span> . $column . <span class="stringliteral">&#39;`, &#39;</span>;
<a name="l00447"></a>00447       $vals = $vals . <span class="charliteral">&#39;:&#39;</span> . $column . <span class="stringliteral">&#39;, &#39;</span>;
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="comment">// this removews a trailing comma from the last statement</span>
<a name="l00451"></a>00451     $cols = substr($cols, 0, -2);
<a name="l00452"></a>00452     $vals = substr($vals, 0, -2);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="comment">// build our prepared sql statement</span>
<a name="l00455"></a>00455     $sql = <span class="stringliteral">&#39;INSERT INTO &#39;</span> . $this-&gt;tempTable . <span class="stringliteral">&#39; (&#39;</span> . $cols . <span class="stringliteral">&#39;) VALUES (&#39;</span> . $vals . <span class="stringliteral">&#39;);&#39;</span>;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <span class="comment">// grab our connection and prepare the query</span>
<a name="l00458"></a>00458     $query = $conn-&gt;<a class="code" href="classDoctrine__Connection.html#adb7b37fd5332c4b38ab61669e23a883d" title="prepare">prepare</a>($sql);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="comment">// return the prepared query</span>
<a name="l00461"></a>00461     <span class="keywordflow">return</span> $query;
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463 
<a name="l00470"></a>00470   <span class="keyword">private</span> function saveImportTempIter(array $importDataSet)
<a name="l00471"></a>00471   {
<a name="l00472"></a>00472     <span class="comment">// first check to see if it&#39;s even worth running</span>
<a name="l00473"></a>00473     <span class="keywordflow">if</span> (empty($importDataSet)) {
<a name="l00474"></a>00474       $this-&gt;eh-&gt;logWarning(<span class="stringliteral">&#39;Cannot save empty dataset to temp table.&#39;</span>);
<a name="l00475"></a>00475       <span class="keywordflow">return</span> 0;
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <span class="comment">// prepare our insert query statement</span>
<a name="l00479"></a>00479     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_WRITE);
<a name="l00480"></a>00480     $conn-&gt;<a class="code" href="classDoctrine__Connection.html#aae5e07b4cb9d55c3f14c3c3efaed4bf6" title="beginTransaction Start a transaction or set a savepoint.">beginTransaction</a>();
<a name="l00481"></a>00481     $query = $this-&gt;prepareImportTemp($conn);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">// set up some initial vars</span>
<a name="l00485"></a>00485     $inserted = 0;
<a name="l00486"></a>00486     $errCt = 0;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">// loop through the import data set and execute the prepared pdo query for each</span>
<a name="l00489"></a>00489     <span class="keywordflow">foreach</span> ($importDataSet as $rowId =&gt; $row) {
<a name="l00490"></a>00490       <span class="keywordflow">try</span> {
<a name="l00491"></a>00491         $query-&gt;execute($row);
<a name="l00492"></a>00492         $inserted++;
<a name="l00493"></a>00493       } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00494"></a>00494         <span class="comment">// in the event of an insert error, don&#39;t continue</span>
<a name="l00495"></a>00495         $errMsg = <span class="stringliteral">&#39;Failed to insert data in row &#39;</span> . $rowId . <span class="stringliteral">&#39; to temp table.&#39;</span>;
<a name="l00496"></a>00496         $this-&gt;eh-&gt;logErr($errMsg, 1, FALSE);
<a name="l00497"></a>00497         $errCt++;
<a name="l00498"></a>00498       }
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="keywordflow">try</span> {
<a name="l00502"></a>00502       $conn-&gt;<a class="code" href="classDoctrine__Connection.html#a2c65858f9d5fcf856b7920a6f4141773" title="commit Commit the database changes done during a transaction that is in progress...">commit</a>();
<a name="l00503"></a>00503       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully committed &#39;</span> . $inserted . <span class="stringliteral">&#39; new records to the temp table.&#39;</span>);
<a name="l00504"></a>00504     } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00505"></a>00505       $errMsg = <span class="stringliteral">&#39;Failed to commit records in batch ending with row &#39;</span> . $rowId;
<a name="l00506"></a>00506       $errCt = count($importDataSet);
<a name="l00507"></a>00507       $this-&gt;eh-&gt;logErr($errMsg, $errCt, FALSE);
<a name="l00508"></a>00508       $inserted = 0;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     $this-&gt;iterData[<span class="stringliteral">&#39;tempErrCt&#39;</span>] += $errCt;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="comment">// if no problems occurred so far, try to commit</span>
<a name="l00514"></a>00514     <span class="keywordflow">return</span> $inserted;
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516 
<a name="l00521"></a><a class="code" href="classagImportHelper.html#a7532700b89b85c76cd09fa20018a5b77">00521</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a7532700b89b85c76cd09fa20018a5b77" title="Method to drop temporary table.">dropTempTable</a>()
<a name="l00522"></a>00522   {
<a name="l00523"></a>00523     <span class="comment">// get a connection</span>
<a name="l00524"></a>00524     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_WRITE);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     <span class="comment">// drop the table</span>
<a name="l00527"></a>00527     <span class="keywordflow">try</span> {
<a name="l00528"></a>00528       <span class="comment">// uses the Doctrine_Export methods see Doctrine_Export api for more details</span>
<a name="l00529"></a>00529       $conn-&gt;export-&gt;dropTable($this-&gt;tempTable);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531       <span class="comment">// log this info event</span>
<a name="l00532"></a>00532       $eventMsg = <span class="stringliteral">&#39;Dropped temporary table {&#39;</span> . $this-&gt;tempTable . <span class="charliteral">&#39;}&#39;</span>;
<a name="l00533"></a>00533       $this-&gt;eh-&gt;logInfo($eventMsg);
<a name="l00534"></a>00534     } <span class="keywordflow">catch</span> (<a class="code" href="classDoctrine__Connection__Exception.html">Doctrine_Connection_Exception</a> $e) {
<a name="l00535"></a>00535       <span class="comment">// we only want to silence &#39;no such table&#39; errors</span>
<a name="l00536"></a>00536       <span class="keywordflow">if</span> ($e-&gt;<a class="code" href="classDoctrine__Connection__Exception.html#a5e5da356e5f52213759816af007ea4c5" title="getPortableCode returns portable error code">getPortableCode</a>() !== Doctrine_Core::ERR_NOSUCHTABLE) {
<a name="l00537"></a>00537         $this-&gt;eh-&gt;logEmerg(<span class="stringliteral">&#39;Failed to drop temp table {&#39;</span> . $this-&gt;tempTable . <span class="charliteral">&#39;}&#39;</span>);
<a name="l00538"></a>00538       } <span class="keywordflow">else</span> {
<a name="l00539"></a>00539         $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Temp table {&#39;</span> . $this-&gt;tempTable . <span class="stringliteral">&#39;} does not exist. Skipping drop.&#39;</span>);
<a name="l00540"></a>00540       }
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542   }
<a name="l00543"></a>00543 
<a name="l00547"></a><a class="code" href="classagImportHelper.html#aaf1270a84f93b2331c1ba9a50d8be409">00547</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#aaf1270a84f93b2331c1ba9a50d8be409" title="Method to create an import temp table.">createTempTable</a>()
<a name="l00548"></a>00548   {
<a name="l00549"></a>00549     <span class="comment">// get a connection</span>
<a name="l00550"></a>00550     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_WRITE);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="comment">// Drop temp if it exists</span>
<a name="l00553"></a>00553     $this-&gt;<a class="code" href="classagImportHelper.html#a7532700b89b85c76cd09fa20018a5b77" title="Method to drop temporary table.">dropTempTable</a>();
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="comment">// add our required columns</span>
<a name="l00556"></a>00556     $importSpec = $this-&gt;importSpec + $this-&gt;requiredImportColumns;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="comment">// Create the table</span>
<a name="l00559"></a>00559     <span class="keywordflow">try</span> {
<a name="l00560"></a>00560       <span class="comment">// uses the Doctrine_Export methods see Doctrine_Export api for more details</span>
<a name="l00561"></a>00561       $conn-&gt;export-&gt;createTable($this-&gt;tempTable, $importSpec, $this-&gt;tempTableOptions);
<a name="l00562"></a>00562       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully created temp table {&#39;</span> . $this-&gt;tempTable . <span class="stringliteral">&#39;}.&#39;</span>);
<a name="l00563"></a>00563     } <span class="keywordflow">catch</span> (<a class="code" href="classDoctrine__Exception.html">Doctrine_Exception</a> $e) {
<a name="l00564"></a>00564       $this-&gt;eh-&gt;logEmerg(<span class="stringliteral">&#39;Error creating temp table ({&#39;</span> . $this-&gt;tempTable . <span class="stringliteral">&#39;} for import.&#39;</span>);
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566   }
<a name="l00567"></a>00567 
<a name="l00576"></a><a class="code" href="classagImportHelper.html#a192156cd03776ef5797781696bdf3111">00576</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportHelper.html#a192156cd03776ef5797781696bdf3111" title="This method provides simple validation of import file column headers.">validateColumnHeaders</a>(array $importFileHeaders, $sheetName)
<a name="l00577"></a>00577   {
<a name="l00578"></a>00578     <span class="comment">// Check if import file header is empty</span>
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (empty($importFileHeaders)) {
<a name="l00580"></a>00580       $errMsg = <span class="stringliteral">&#39;Worksheet {&#39;</span> . $sheetName . <span class="stringliteral">&#39;} is missing column headers.&#39;</span>;
<a name="l00581"></a>00581       $this-&gt;eh-&gt;logErr($errMsg);
<a name="l00582"></a>00582       <span class="keywordflow">return</span> FALSE;
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="comment">// just grab the headers</span>
<a name="l00586"></a>00586     $importSpecHeaders = array_keys($this-&gt;importSpec);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="comment">// process a diff of the file headers and spec headers</span>
<a name="l00589"></a>00589     $importSpecDiff = array_diff($importSpecHeaders, $importFileHeaders);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     <span class="comment">// return true / false and return info as appropriate</span>
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (empty($importSpecDiff)) {
<a name="l00593"></a>00593       <span class="keywordflow">return</span> TRUE;
<a name="l00594"></a>00594     } <span class="keywordflow">else</span> {
<a name="l00595"></a>00595       $this-&gt;eh-&gt;logErr(<span class="stringliteral">&#39;Error processing sheet headers: Missing required columns.&#39;</span>);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597       <span class="keywordflow">foreach</span> ($importSpecDiff as $missing) {
<a name="l00598"></a>00598         $this-&gt;eh-&gt;logWarning(<span class="stringliteral">&#39;Column header {&#39;</span> . $missing . <span class="stringliteral">&#39;} is missing.&#39;</span>);
<a name="l00599"></a>00599       }
<a name="l00600"></a>00600       <span class="keywordflow">return</span> FALSE;
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
