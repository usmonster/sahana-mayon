<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: lib/vendor/symfony/lib/plugins/sfPropelPlugin/lib/addon/sfPropelDatabaseSchema.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>lib/vendor/symfony/lib/plugins/sfPropelPlugin/lib/addon/sfPropelDatabaseSchema.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment">* This file is part of the symfony package.</span>
<a name="l00005"></a>00005 <span class="comment">* (c) Fabien Potencier &lt;fabien.potencier@symfony-project.com&gt;</span>
<a name="l00006"></a>00006 <span class="comment">* (c) Francois Zaninotto &lt;francois.zaninotto@symfony-project.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment">*</span>
<a name="l00008"></a>00008 <span class="comment">* For the full copyright and license information, please view the LICENSE</span>
<a name="l00009"></a>00009 <span class="comment">* file that was distributed with this source code.</span>
<a name="l00010"></a>00010 <span class="comment">*/</span>
<a name="l00011"></a>00011 
<a name="l00021"></a><a class="code" href="classsfPropelDatabaseSchema.html">00021</a> <span class="keyword">class </span><a class="code" href="classsfPropelDatabaseSchema.html">sfPropelDatabaseSchema</a>
<a name="l00022"></a>00022 {
<a name="l00023"></a>00023   <span class="keyword">protected</span> $connection_name = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00024"></a>00024   <span class="keyword">protected</span> $database        = array();
<a name="l00025"></a>00025 
<a name="l00031"></a><a class="code" href="classsfPropelDatabaseSchema.html#a63b6ac1a26df84db5dd439ffacbab55f">00031</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a63b6ac1a26df84db5dd439ffacbab55f" title="Dumps schema as array.">asArray</a>()
<a name="l00032"></a>00032   {
<a name="l00033"></a>00033     <span class="keywordflow">return</span> array($this-&gt;connection_name =&gt; $this-&gt;database);
<a name="l00034"></a>00034   }
<a name="l00035"></a>00035 
<a name="l00041"></a><a class="code" href="classsfPropelDatabaseSchema.html#a76dd153db132aa5e709a798d77c241e9">00041</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a76dd153db132aa5e709a798d77c241e9" title="Load schema from array.">loadArray</a>($schema_array)
<a name="l00042"></a>00042   {
<a name="l00043"></a>00043     <span class="keywordflow">if</span> (is_array($schema_array) &amp;&amp; !empty($schema_array))
<a name="l00044"></a>00044     {
<a name="l00045"></a>00045       $database = array();
<a name="l00046"></a>00046       $connection_name = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048       <span class="keywordflow">if</span> (isset($schema_array[<span class="stringliteral">&#39;classes&#39;</span>]))
<a name="l00049"></a>00049       {
<a name="l00050"></a>00050         <span class="comment">// New schema syntax</span>
<a name="l00051"></a>00051         $schema_array = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a093712a929a3848f561d2efff25ce863" title="Converts new yaml schema format to old yaml schema.">convertNewToOldYaml</a>($schema_array);
<a name="l00052"></a>00052       }
<a name="l00053"></a>00053 
<a name="l00054"></a>00054       <span class="keywordflow">if</span> (count($schema_array) &gt; 1)
<a name="l00055"></a>00055       {
<a name="l00056"></a>00056         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(<span class="stringliteral">&#39;A schema.yml must only contain 1 database entry.&#39;</span>);
<a name="l00057"></a>00057       }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059       $tmp = array_keys($schema_array);
<a name="l00060"></a>00060       $connection_name = array_shift($tmp);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062       <span class="keywordflow">if</span> ($connection_name)
<a name="l00063"></a>00063       {
<a name="l00064"></a>00064         $database = $schema_array[$connection_name];
<a name="l00065"></a>00065       }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067       $this-&gt;connection_name = $connection_name;
<a name="l00068"></a>00068       $this-&gt;database = $database;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070       $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a6e1c6b09f4c902e640b65577eb8d8dfe" title="Fixes databases in yaml shorthand schema.">fixYAMLDatabase</a>();
<a name="l00071"></a>00071       $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a0838ba71efb5b18ed78117442b1e5d70" title="Fixes i18n tables in yaml shorthand schema.">fixYAMLI18n</a>();
<a name="l00072"></a>00072       $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a1e661993dd99a6d7327fa78184a9c1d4" title="Fixes columns in yaml shorthand schema.">fixYAMLColumns</a>();
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074   }
<a name="l00075"></a>00075 
<a name="l00081"></a><a class="code" href="classsfPropelDatabaseSchema.html#a239377d30d9e37438f640d84f48da429">00081</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a239377d30d9e37438f640d84f48da429" title="Load schema from YAML file.">loadYAML</a>($file)
<a name="l00082"></a>00082   {
<a name="l00083"></a>00083     $schema_array = <a class="code" href="classsfYaml.html#adc58a6b2520f3e7a8349b72b9153b779" title="Loads YAML into a PHP array.">sfYaml::load</a>($file);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">if</span> (!is_array($schema_array))
<a name="l00086"></a>00086     {
<a name="l00087"></a>00087       <span class="keywordflow">return</span>; <span class="comment">// No defined schema here, skipping</span>
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (!isset($schema_array[<span class="stringliteral">&#39;classes&#39;</span>]))
<a name="l00091"></a>00091     {
<a name="l00092"></a>00092       <span class="comment">// Old schema syntax: we convert it</span>
<a name="l00093"></a>00093       $schema_array = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#ad83c8748d9612fa182606f6e54df5803" title="Converts old yaml format schema to new yaml schema.">convertOldToNewYaml</a>($schema_array);
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a76dd153db132aa5e709a798d77c241e9" title="Load schema from array.">loadArray</a>($schema_array);
<a name="l00097"></a>00097   }
<a name="l00098"></a>00098 
<a name="l00106"></a><a class="code" href="classsfPropelDatabaseSchema.html#ad83c8748d9612fa182606f6e54df5803">00106</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#ad83c8748d9612fa182606f6e54df5803" title="Converts old yaml format schema to new yaml schema.">convertOldToNewYaml</a>($schema)
<a name="l00107"></a>00107   {
<a name="l00108"></a>00108     <span class="keywordflow">if</span> (is_array($schema) &amp;&amp; !empty($schema))
<a name="l00109"></a>00109     {
<a name="l00110"></a>00110       $new_schema = array();
<a name="l00111"></a>00111 
<a name="l00112"></a>00112       $tmp = array_keys($schema);
<a name="l00113"></a>00113       $connection_name = array_shift($tmp);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115       <span class="keywordflow">if</span> (!empty($connection_name) &amp;&amp; isset($schema[$connection_name]))
<a name="l00116"></a>00116       {
<a name="l00117"></a>00117         $new_schema[<span class="stringliteral">&#39;connection&#39;</span>] = $connection_name;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         $classes = array();
<a name="l00120"></a>00120         <span class="keywordflow">foreach</span>($schema[$connection_name] as $table =&gt; $table_params)
<a name="l00121"></a>00121         {
<a name="l00122"></a>00122           <span class="keywordflow">if</span> ($table == <span class="stringliteral">&#39;_attributes&#39;</span>)
<a name="l00123"></a>00123           {
<a name="l00124"></a>00124             <span class="comment">// Database attributes</span>
<a name="l00125"></a>00125             $new_schema = array_merge($new_schema, $table_params);
<a name="l00126"></a>00126           }
<a name="l00127"></a>00127           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&#39;_propel_behaviors&#39;</span> == $table)
<a name="l00128"></a>00128           {
<a name="l00129"></a>00129             <span class="comment">// Database behaviors</span>
<a name="l00130"></a>00130             $new_schema[<span class="stringliteral">&#39;propel_behaviors&#39;</span>] = $table_params;
<a name="l00131"></a>00131           }
<a name="l00132"></a>00132           <span class="keywordflow">else</span>
<a name="l00133"></a>00133           {
<a name="l00134"></a>00134             <span class="comment">// Table</span>
<a name="l00135"></a>00135             $phpName = <a class="code" href="classsfInflector.html#a5424338afa474c5b37969ad674bb13a2" title="Returns a camelized string from a lower case and underscored string by replaceing...">sfInflector::camelize</a>($table);
<a name="l00136"></a>00136             <span class="keywordflow">if</span> (isset($table_params[<span class="stringliteral">&#39;_attributes&#39;</span>]))
<a name="l00137"></a>00137             {
<a name="l00138"></a>00138               $table_attributes = $table_params[<span class="stringliteral">&#39;_attributes&#39;</span>];
<a name="l00139"></a>00139               unset($table_params[<span class="stringliteral">&#39;_attributes&#39;</span>]);
<a name="l00140"></a>00140               <span class="keywordflow">if</span> (isset($table_attributes[<span class="stringliteral">&#39;phpName&#39;</span>]))
<a name="l00141"></a>00141               {
<a name="l00142"></a>00142                 $phpName = $table_attributes[<span class="stringliteral">&#39;phpName&#39;</span>];
<a name="l00143"></a>00143                 unset($table_attributes[<span class="stringliteral">&#39;phpName&#39;</span>]);
<a name="l00144"></a>00144               }
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146             <span class="keywordflow">else</span>
<a name="l00147"></a>00147             {
<a name="l00148"></a>00148               $table_attributes = array();
<a name="l00149"></a>00149             }
<a name="l00150"></a>00150             $classes[$phpName] = $table_attributes;
<a name="l00151"></a>00151             $classes[$phpName][<span class="stringliteral">&#39;tableName&#39;</span>] = $table;
<a name="l00152"></a>00152             $classes[$phpName][<span class="stringliteral">&#39;columns&#39;</span>] = array();
<a name="l00153"></a>00153             <span class="keywordflow">foreach</span>($table_params as $column =&gt; $column_params)
<a name="l00154"></a>00154             {
<a name="l00155"></a>00155               <span class="keywordflow">switch</span>($column)
<a name="l00156"></a>00156               {
<a name="l00157"></a>00157                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_behaviors&#39;</span>:
<a name="l00158"></a>00158                   $classes[$phpName][<span class="stringliteral">&#39;behaviors&#39;</span>] = $column_params;
<a name="l00159"></a>00159                   <span class="keywordflow">break</span>;
<a name="l00160"></a>00160                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_propel_behaviors&#39;</span>:
<a name="l00161"></a>00161                   $classes[$phpName][<span class="stringliteral">&#39;propel_behaviors&#39;</span>] = $column_params;
<a name="l00162"></a>00162                   <span class="keywordflow">break</span>;
<a name="l00163"></a>00163                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_inheritance&#39;</span>:
<a name="l00164"></a>00164                   $classes[$phpName][<span class="stringliteral">&#39;inheritance&#39;</span>] = $column_params;
<a name="l00165"></a>00165                   <span class="keywordflow">break</span>;
<a name="l00166"></a>00166                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_nestedSet&#39;</span>:
<a name="l00167"></a>00167                   $classes[$phpName][<span class="stringliteral">&#39;nestedSet&#39;</span>] = $column_params;
<a name="l00168"></a>00168                   <span class="keywordflow">break</span>;
<a name="l00169"></a>00169                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_foreignKeys&#39;</span>:
<a name="l00170"></a>00170                   $classes[$phpName][<span class="stringliteral">&#39;foreignKeys&#39;</span>] = $column_params;
<a name="l00171"></a>00171                   <span class="keywordflow">break</span>;
<a name="l00172"></a>00172                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_indexes&#39;</span>:
<a name="l00173"></a>00173                   $classes[$phpName][<span class="stringliteral">&#39;indexes&#39;</span>] = $column_params;
<a name="l00174"></a>00174                   <span class="keywordflow">break</span>;
<a name="l00175"></a>00175                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;_uniques&#39;</span>:
<a name="l00176"></a>00176                   $classes[$phpName][<span class="stringliteral">&#39;uniques&#39;</span>] = $column_params;
<a name="l00177"></a>00177                   <span class="keywordflow">break</span>;
<a name="l00178"></a>00178                 <span class="keywordflow">default</span>:
<a name="l00179"></a>00179                   $classes[$phpName][<span class="stringliteral">&#39;columns&#39;</span>][$column] = $column_params;
<a name="l00180"></a>00180               }
<a name="l00181"></a>00181             }
<a name="l00182"></a>00182           }
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         $new_schema[<span class="stringliteral">&#39;classes&#39;</span>] = $classes;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187       }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189       <span class="keywordflow">return</span> $new_schema;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191   }
<a name="l00192"></a>00192 
<a name="l00200"></a><a class="code" href="classsfPropelDatabaseSchema.html#a093712a929a3848f561d2efff25ce863">00200</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a093712a929a3848f561d2efff25ce863" title="Converts new yaml schema format to old yaml schema.">convertNewToOldYaml</a>($schema)
<a name="l00201"></a>00201   {
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (isset($schema[<span class="stringliteral">&#39;connection&#39;</span>]))
<a name="l00203"></a>00203     {
<a name="l00204"></a>00204       $connection_name = $schema[<span class="stringliteral">&#39;connection&#39;</span>];
<a name="l00205"></a>00205       unset($schema[<span class="stringliteral">&#39;connection&#39;</span>]);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207     <span class="keywordflow">else</span>
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209       $connection_name = <span class="stringliteral">&#39;propel&#39;</span>;
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     $database = array();
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="comment">// Tables</span>
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (isset($schema[<span class="stringliteral">&#39;classes&#39;</span>]))
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217       $tables = array();
<a name="l00218"></a>00218       <span class="keywordflow">foreach</span> ($schema[<span class="stringliteral">&#39;classes&#39;</span>] as $className =&gt; $classParams)
<a name="l00219"></a>00219       {
<a name="l00220"></a>00220         $tableParams = array();
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         <span class="comment">// Columns</span>
<a name="l00223"></a>00223         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;columns&#39;</span>]))
<a name="l00224"></a>00224         {
<a name="l00225"></a>00225           $tableParams = array_merge($classParams[<span class="stringliteral">&#39;columns&#39;</span>], $tableParams);
<a name="l00226"></a>00226           unset($classParams[<span class="stringliteral">&#39;columns&#39;</span>]);
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         <span class="comment">// Indexes and foreign keys</span>
<a name="l00230"></a>00230         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;indexes&#39;</span>]))
<a name="l00231"></a>00231         {
<a name="l00232"></a>00232           $tableParams[<span class="stringliteral">&#39;_indexes&#39;</span>] = $classParams[<span class="stringliteral">&#39;indexes&#39;</span>];
<a name="l00233"></a>00233           unset($classParams[<span class="stringliteral">&#39;indexes&#39;</span>]);
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;uniques&#39;</span>]))
<a name="l00236"></a>00236         {
<a name="l00237"></a>00237           $tableParams[<span class="stringliteral">&#39;_uniques&#39;</span>] = $classParams[<span class="stringliteral">&#39;uniques&#39;</span>];
<a name="l00238"></a>00238           unset($classParams[<span class="stringliteral">&#39;uniques&#39;</span>]);
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;foreignKeys&#39;</span>]))
<a name="l00241"></a>00241         {
<a name="l00242"></a>00242           $tableParams[<span class="stringliteral">&#39;_foreignKeys&#39;</span>] = $classParams[<span class="stringliteral">&#39;foreignKeys&#39;</span>];
<a name="l00243"></a>00243           unset($classParams[<span class="stringliteral">&#39;foreignKeys&#39;</span>]);
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="comment">// Behaviors</span>
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;behaviors&#39;</span>]))
<a name="l00248"></a>00248         {
<a name="l00249"></a>00249           $tableParams[<span class="stringliteral">&#39;_behaviors&#39;</span>] = $classParams[<span class="stringliteral">&#39;behaviors&#39;</span>];
<a name="l00250"></a>00250           unset($classParams[<span class="stringliteral">&#39;behaviors&#39;</span>]);
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;propel_behaviors&#39;</span>]))
<a name="l00253"></a>00253         {
<a name="l00254"></a>00254           $tableParams[<span class="stringliteral">&#39;_propel_behaviors&#39;</span>] = $classParams[<span class="stringliteral">&#39;propel_behaviors&#39;</span>];
<a name="l00255"></a>00255           unset($classParams[<span class="stringliteral">&#39;propel_behaviors&#39;</span>]);
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="comment">// Inheritance</span>
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;inheritance&#39;</span>]))
<a name="l00260"></a>00260         {
<a name="l00261"></a>00261           $tableParams[<span class="stringliteral">&#39;_inheritance&#39;</span>] = $classParams[<span class="stringliteral">&#39;inheritance&#39;</span>];
<a name="l00262"></a>00262           unset($classParams[<span class="stringliteral">&#39;inheritance&#39;</span>]);
<a name="l00263"></a>00263         }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="comment">// Nested sets</span>
<a name="l00266"></a>00266         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;nestedSet&#39;</span>]))
<a name="l00267"></a>00267         {
<a name="l00268"></a>00268           $tableParams[<span class="stringliteral">&#39;_nestedSet&#39;</span>] = $classParams[<span class="stringliteral">&#39;nestedSet&#39;</span>];
<a name="l00269"></a>00269           unset($classParams[<span class="stringliteral">&#39;nestedSet&#39;</span>]);
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="comment">// Table attributes</span>
<a name="l00273"></a>00273         $tableAttributes = array();
<a name="l00274"></a>00274         <span class="keywordflow">if</span> (isset($classParams[<span class="stringliteral">&#39;tableName&#39;</span>]))
<a name="l00275"></a>00275         {
<a name="l00276"></a>00276           $tableName = $classParams[<span class="stringliteral">&#39;tableName&#39;</span>];
<a name="l00277"></a>00277           unset($classParams[<span class="stringliteral">&#39;tableName&#39;</span>]);
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279         <span class="keywordflow">else</span>
<a name="l00280"></a>00280         {
<a name="l00281"></a>00281           $tableName = <a class="code" href="classsfInflector.html#a1d799a0c71dbc6a73d8c36455fa7202b" title="Returns an underscore-syntaxed version or the CamelCased string.">sfInflector::underscore</a>($className);
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (<a class="code" href="classsfInflector.html#a5424338afa474c5b37969ad674bb13a2" title="Returns a camelized string from a lower case and underscored string by replaceing...">sfInflector::camelize</a>($tableName) != $className)
<a name="l00285"></a>00285         {
<a name="l00286"></a>00286           $tableAttributes[<span class="stringliteral">&#39;phpName&#39;</span>] = $className;
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span> ($tableAttributes || $classParams)
<a name="l00290"></a>00290         {
<a name="l00291"></a>00291           $tableParams[<span class="stringliteral">&#39;_attributes&#39;</span>] = array_merge($tableAttributes, $classParams);
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         $tables[$tableName] = $tableParams;
<a name="l00295"></a>00295       }
<a name="l00296"></a>00296       $database = array_merge($database, $tables);
<a name="l00297"></a>00297       unset($schema[<span class="stringliteral">&#39;classes&#39;</span>]);
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="comment">// Database behaviors</span>
<a name="l00301"></a>00301     <span class="keywordflow">if</span> (isset($schema[<span class="stringliteral">&#39;propel_behaviors&#39;</span>]))
<a name="l00302"></a>00302     {
<a name="l00303"></a>00303       $database[<span class="stringliteral">&#39;_propel_behaviors&#39;</span>] = $schema[<span class="stringliteral">&#39;propel_behaviors&#39;</span>];
<a name="l00304"></a>00304       unset($schema[<span class="stringliteral">&#39;propel_behaviors&#39;</span>]);
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="comment">// Database attributes</span>
<a name="l00308"></a>00308     <span class="keywordflow">if</span> ($schema)
<a name="l00309"></a>00309     {
<a name="l00310"></a>00310       $database[<span class="stringliteral">&#39;_attributes&#39;</span>] = $schema;
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">return</span> array($connection_name =&gt; $database);
<a name="l00314"></a>00314   }
<a name="l00315"></a>00315 
<a name="l00321"></a><a class="code" href="classsfPropelDatabaseSchema.html#a2504d15308932c3dcc8814ef367cd780">00321</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a2504d15308932c3dcc8814ef367cd780" title="Dumps schema as propel xml.">asXML</a>()
<a name="l00322"></a>00322   {
<a name="l00323"></a>00323     $xml = <span class="stringliteral">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;</span>;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     $xml .= <span class="stringliteral">&quot;&lt;database name=\&quot;$this-&gt;connection_name\&quot;&quot;</span>.$this-&gt;getAttributesFor($this-&gt;database).<span class="stringliteral">&quot;&gt;\n&quot;</span>;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (isset($this-&gt;database[<span class="stringliteral">&#39;_propel_behaviors&#39;</span>]))
<a name="l00328"></a>00328     {
<a name="l00329"></a>00329       <span class="keywordflow">foreach</span> ($this-&gt;database[<span class="stringliteral">&#39;_propel_behaviors&#39;</span>] as $name =&gt; $parameters)
<a name="l00330"></a>00330       {
<a name="l00331"></a>00331         $xml .= <span class="stringliteral">&quot;\n  &lt;behavior name=\&quot;$name\&quot;&quot;</span>;
<a name="l00332"></a>00332         <span class="keywordflow">if</span> (is_array($parameters) &amp;&amp; count($parameters))
<a name="l00333"></a>00333         {
<a name="l00334"></a>00334           $xml .= <span class="stringliteral">&quot;&gt;\n&quot;</span>;
<a name="l00335"></a>00335           <span class="keywordflow">foreach</span> ($parameters as $key =&gt; $value)
<a name="l00336"></a>00336           {
<a name="l00337"></a>00337             $xml .= <span class="stringliteral">&quot;    &lt;parameter name=\&quot;$key\&quot; value=\&quot;{$this-&gt;fixXMLBoolean($value)}\&quot;/&gt;\n&quot;</span>;
<a name="l00338"></a>00338           }
<a name="l00339"></a>00339           $xml .= <span class="stringliteral">&quot;  &lt;/behavior&gt;\n&quot;</span>;
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341         <span class="keywordflow">else</span>
<a name="l00342"></a>00342         {
<a name="l00343"></a>00343           $xml .= <span class="stringliteral">&quot;/&gt;\n&quot;</span>;
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345       }
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="comment">// tables</span>
<a name="l00349"></a>00349     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#ada19775538eee88a1ac9e92f5a42952a" title="Returns the children for a given hash.">getChildren</a>($this-&gt;database) as $tb_name =&gt; $table)
<a name="l00350"></a>00350     {
<a name="l00351"></a>00351       <span class="comment">// capture nested set config for this table</span>
<a name="l00352"></a>00352       <span class="keywordflow">if</span> ($isNestedSet = isset($table[<span class="stringliteral">&#39;_nestedSet&#39;</span>]))
<a name="l00353"></a>00353       {
<a name="l00354"></a>00354         $treeConfig = $table[<span class="stringliteral">&#39;_nestedSet&#39;</span>];
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (
<a name="l00356"></a>00356           !isset($treeConfig[<span class="stringliteral">&#39;left&#39;</span>])
<a name="l00357"></a>00357           ||
<a name="l00358"></a>00358           !isset($treeConfig[<span class="stringliteral">&#39;right&#39;</span>])
<a name="l00359"></a>00359           ||
<a name="l00360"></a>00360           !isset($table[$treeConfig[<span class="stringliteral">&#39;left&#39;</span>]])
<a name="l00361"></a>00361           ||
<a name="l00362"></a>00362           !isset($table[$treeConfig[<span class="stringliteral">&#39;right&#39;</span>]])
<a name="l00363"></a>00363           ||
<a name="l00364"></a>00364           (isset($treeConfig[<span class="stringliteral">&#39;scope&#39;</span>]) &amp;&amp; !isset($table[$treeConfig[<span class="stringliteral">&#39;scope&#39;</span>]]))
<a name="l00365"></a>00365         )
<a name="l00366"></a>00366         {
<a name="l00367"></a>00367           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(sprintf(<span class="stringliteral">&#39;Incorrect NestedSet configuration for &quot;%s&quot; table.&#39;</span>, $tb_name));
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369       }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371       $xml .= <span class="stringliteral">&quot;\n  &lt;table name=\&quot;$tb_name\&quot;&quot;</span>.$this-&gt;getAttributesFor($table);
<a name="l00372"></a>00372       <span class="keywordflow">if</span> ($isNestedSet)
<a name="l00373"></a>00373       {
<a name="l00374"></a>00374         $xml .= <span class="stringliteral">&#39; treeMode=&quot;NestedSet&quot;&#39;</span>;
<a name="l00375"></a>00375       }
<a name="l00376"></a>00376       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;_behaviors&#39;</span>]))
<a name="l00377"></a>00377       {
<a name="l00378"></a>00378         $xml .= sprintf(<span class="stringliteral">&quot; behaviors=\&quot;%s\&quot;&quot;</span>, htmlspecialchars(serialize($table[<span class="stringliteral">&#39;_behaviors&#39;</span>])), ENT_QUOTES, sfConfig::get(<span class="stringliteral">&#39;sf_charset&#39;</span>));
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380       $xml .= <span class="stringliteral">&quot;&gt;\n&quot;</span>;
<a name="l00381"></a>00381       
<a name="l00382"></a>00382       <span class="comment">// behaviors</span>
<a name="l00383"></a>00383       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;_propel_behaviors&#39;</span>]))
<a name="l00384"></a>00384       {
<a name="l00385"></a>00385         <span class="keywordflow">foreach</span> ($table[<span class="stringliteral">&#39;_propel_behaviors&#39;</span>] as $behavior_name =&gt; $parameters)
<a name="l00386"></a>00386         {
<a name="l00387"></a>00387           <span class="keywordflow">if</span> ($parameters)
<a name="l00388"></a>00388           {
<a name="l00389"></a>00389             $xml .= <span class="stringliteral">&quot;    &lt;behavior name=\&quot;$behavior_name\&quot;&gt;\n&quot;</span>;
<a name="l00390"></a>00390             <span class="keywordflow">foreach</span> ($parameters as $param_name =&gt; $param_value)
<a name="l00391"></a>00391             {
<a name="l00392"></a>00392               $xml .= <span class="stringliteral">&quot;      &lt;parameter name=\&quot;$param_name\&quot; value=\&quot;{$this-&gt;fixXMLBoolean($param_value)}\&quot; /&gt;\n&quot;</span>;
<a name="l00393"></a>00393             }
<a name="l00394"></a>00394             $xml .= <span class="stringliteral">&quot;    &lt;/behavior&gt;\n&quot;</span>;
<a name="l00395"></a>00395           }
<a name="l00396"></a>00396           <span class="keywordflow">else</span>
<a name="l00397"></a>00397           {
<a name="l00398"></a>00398             $xml .= <span class="stringliteral">&quot;    &lt;behavior name=\&quot;$behavior_name\&quot; /&gt;\n&quot;</span>;
<a name="l00399"></a>00399           }
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401       }
<a name="l00402"></a>00402       
<a name="l00403"></a>00403       <span class="comment">// columns</span>
<a name="l00404"></a>00404       <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#ada19775538eee88a1ac9e92f5a42952a" title="Returns the children for a given hash.">getChildren</a>($table) as $col_name =&gt; $column)
<a name="l00405"></a>00405       {
<a name="l00406"></a>00406         <span class="comment">// inheritance</span>
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (
<a name="l00408"></a>00408           isset($table[<span class="stringliteral">&#39;_inheritance&#39;</span>])
<a name="l00409"></a>00409           &amp;&amp;
<a name="l00410"></a>00410           isset($table[<span class="stringliteral">&#39;_inheritance&#39;</span>][<span class="stringliteral">&#39;column&#39;</span>])
<a name="l00411"></a>00411           &amp;&amp;
<a name="l00412"></a>00412           $col_name == $table[<span class="stringliteral">&#39;_inheritance&#39;</span>][<span class="stringliteral">&#39;column&#39;</span>]
<a name="l00413"></a>00413           &amp;&amp;
<a name="l00414"></a>00414           isset($table[<span class="stringliteral">&#39;_inheritance&#39;</span>][<span class="stringliteral">&#39;classes&#39;</span>])
<a name="l00415"></a>00415           &amp;&amp;
<a name="l00416"></a>00416           is_array($table[<span class="stringliteral">&#39;_inheritance&#39;</span>][<span class="stringliteral">&#39;classes&#39;</span>])
<a name="l00417"></a>00417         )
<a name="l00418"></a>00418         {
<a name="l00419"></a>00419           $column[<span class="stringliteral">&#39;inheritance&#39;</span>] = $table[<span class="stringliteral">&#39;_inheritance&#39;</span>][<span class="stringliteral">&#39;classes&#39;</span>];
<a name="l00420"></a>00420           unset($table[<span class="stringliteral">&#39;_inheritance&#39;</span>]);
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="comment">// add nested set attributes to this column</span>
<a name="l00424"></a>00424         <span class="keywordflow">if</span> ($isNestedSet &amp;&amp; in_array($col_name, $treeConfig))
<a name="l00425"></a>00425         {
<a name="l00426"></a>00426           <span class="keywordflow">if</span> ($col_name == $treeConfig[<span class="stringliteral">&#39;left&#39;</span>])
<a name="l00427"></a>00427           {
<a name="l00428"></a>00428             $column[<span class="stringliteral">&#39;nestedSetLeftKey&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l00429"></a>00429           }
<a name="l00430"></a>00430           elseif ($col_name == $treeConfig[<span class="stringliteral">&#39;right&#39;</span>])
<a name="l00431"></a>00431           {
<a name="l00432"></a>00432             $column[<span class="stringliteral">&#39;nestedSetRightKey&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l00433"></a>00433           }
<a name="l00434"></a>00434           elseif (isset($treeConfig[<span class="stringliteral">&#39;scope&#39;</span>]) &amp;&amp; $col_name == $treeConfig[<span class="stringliteral">&#39;scope&#39;</span>])
<a name="l00435"></a>00435           {
<a name="l00436"></a>00436             $column[<span class="stringliteral">&#39;treeScopeKey&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l00437"></a>00437           }
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440         $xml .= <span class="stringliteral">&quot;    &lt;column name=\&quot;$col_name\&quot;&quot;</span>.$this-&gt;getAttributesForColumn($tb_name, $col_name, $column);
<a name="l00441"></a>00441       }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       <span class="comment">// indexes</span>
<a name="l00444"></a>00444       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;_indexes&#39;</span>]))
<a name="l00445"></a>00445       {
<a name="l00446"></a>00446         <span class="keywordflow">foreach</span> ($table[<span class="stringliteral">&#39;_indexes&#39;</span>] as $index_name =&gt; $index)
<a name="l00447"></a>00447         {
<a name="l00448"></a>00448           $xml .= <span class="stringliteral">&quot;    &lt;index name=\&quot;$index_name\&quot;&gt;\n&quot;</span>;
<a name="l00449"></a>00449           <span class="keywordflow">foreach</span> ($index as $index_column)
<a name="l00450"></a>00450           {
<a name="l00451"></a>00451             preg_match(<span class="stringliteral">&#39;/^(.+?)\(([\d]+)\)$/&#39;</span>, $index_column, $matches);
<a name="l00452"></a>00452             <span class="keywordflow">if</span> (isset($matches[2]))
<a name="l00453"></a>00453             {
<a name="l00454"></a>00454               $xml .= <span class="stringliteral">&quot;      &lt;index-column name=\&quot;{$matches[1]}\&quot; size=\&quot;{$matches[2]}\&quot; /&gt;\n&quot;</span>;
<a name="l00455"></a>00455             }
<a name="l00456"></a>00456             <span class="keywordflow">else</span>
<a name="l00457"></a>00457             {
<a name="l00458"></a>00458               $xml .= <span class="stringliteral">&quot;      &lt;index-column name=\&quot;$index_column\&quot; /&gt;\n&quot;</span>;
<a name="l00459"></a>00459             }
<a name="l00460"></a>00460           }
<a name="l00461"></a>00461           $xml .= <span class="stringliteral">&quot;    &lt;/index&gt;\n&quot;</span>;
<a name="l00462"></a>00462         }
<a name="l00463"></a>00463       }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465       <span class="comment">// uniques</span>
<a name="l00466"></a>00466       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;_uniques&#39;</span>]))
<a name="l00467"></a>00467       {
<a name="l00468"></a>00468         <span class="keywordflow">foreach</span> ($table[<span class="stringliteral">&#39;_uniques&#39;</span>] as $unique_name =&gt; $index)
<a name="l00469"></a>00469         {
<a name="l00470"></a>00470           $xml .= <span class="stringliteral">&quot;    &lt;unique name=\&quot;$unique_name\&quot;&gt;\n&quot;</span>;
<a name="l00471"></a>00471           <span class="keywordflow">foreach</span> ($index as $unique_column)
<a name="l00472"></a>00472           {
<a name="l00473"></a>00473             preg_match(<span class="stringliteral">&#39;/^(.+?)\(([\d]+)\)$/&#39;</span>, $unique_column, $matches);
<a name="l00474"></a>00474             <span class="keywordflow">if</span> (isset($matches[2]))
<a name="l00475"></a>00475             {
<a name="l00476"></a>00476               $xml .= <span class="stringliteral">&quot;      &lt;unique-column name=\&quot;{$matches[1]}\&quot; size=\&quot;{$matches[2]}\&quot; /&gt;\n&quot;</span>;
<a name="l00477"></a>00477             }
<a name="l00478"></a>00478             <span class="keywordflow">else</span>
<a name="l00479"></a>00479             {
<a name="l00480"></a>00480               $xml .= <span class="stringliteral">&quot;      &lt;unique-column name=\&quot;$unique_column\&quot; /&gt;\n&quot;</span>;
<a name="l00481"></a>00481             }
<a name="l00482"></a>00482           }
<a name="l00483"></a>00483           $xml .= <span class="stringliteral">&quot;    &lt;/unique&gt;\n&quot;</span>;
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485       }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487       <span class="comment">// foreign-keys</span>
<a name="l00488"></a>00488       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;_foreignKeys&#39;</span>]))
<a name="l00489"></a>00489       {
<a name="l00490"></a>00490         <span class="keywordflow">foreach</span> ($table[<span class="stringliteral">&#39;_foreignKeys&#39;</span>] as $fkey_name =&gt; $fkey)
<a name="l00491"></a>00491         {
<a name="l00492"></a>00492           <span class="keywordflow">if</span> (!isset($fkey[<span class="stringliteral">&#39;foreignTable&#39;</span>]))
<a name="l00493"></a>00493           {
<a name="l00494"></a>00494             <span class="keywordflow">if</span> (
<a name="l00495"></a>00495               !isset($fkey[<span class="stringliteral">&#39;foreignClass&#39;</span>])
<a name="l00496"></a>00496               ||
<a name="l00497"></a>00497               !$fkey[<span class="stringliteral">&#39;foreignTable&#39;</span>] = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a12f683d75590377dfc6cc463d47357bd" title="Find table by name.">findTable</a>($fkey[<span class="stringliteral">&#39;foreignClass&#39;</span>])
<a name="l00498"></a>00498             )
<a name="l00499"></a>00499             {
<a name="l00500"></a>00500               <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(sprintf(<span class="stringliteral">&#39;Unable to resolve foreign table for foreign key &quot;%s&quot;: %s&#39;</span>, $fkey_name, var_export($fkey, <span class="keyword">true</span>)));
<a name="l00501"></a>00501             }
<a name="l00502"></a>00502           }
<a name="l00503"></a>00503           unset($fkey[<span class="stringliteral">&#39;foreignClass&#39;</span>]);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505           $xml .= <span class="stringliteral">&#39;    &lt;foreign-key&#39;</span>;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507           <span class="comment">// foreign key name</span>
<a name="l00508"></a>00508           <span class="keywordflow">if</span> (!is_numeric($fkey_name))
<a name="l00509"></a>00509           {
<a name="l00510"></a>00510             $xml .= <span class="stringliteral">&quot; name=\&quot;$fkey_name\&quot;&quot;</span>;
<a name="l00511"></a>00511           }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513           <span class="comment">// other attributes</span>
<a name="l00514"></a>00514           <span class="keywordflow">foreach</span> ($fkey as $attribute_name =&gt; $attribute_value)
<a name="l00515"></a>00515           {
<a name="l00516"></a>00516             <span class="keywordflow">if</span> (is_string($attribute_value))
<a name="l00517"></a>00517             {
<a name="l00518"></a>00518               $xml .= <span class="stringliteral">&quot; $attribute_name=\&quot;$attribute_value\&quot;&quot;</span>;
<a name="l00519"></a>00519             }
<a name="l00520"></a>00520           }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522           $xml .= <span class="stringliteral">&quot;&gt;\n&quot;</span>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524           <span class="comment">// references</span>
<a name="l00525"></a>00525           <span class="keywordflow">if</span> (isset($fkey[<span class="stringliteral">&#39;references&#39;</span>]))
<a name="l00526"></a>00526           {
<a name="l00527"></a>00527             <span class="keywordflow">foreach</span> ($fkey[<span class="stringliteral">&#39;references&#39;</span>] as $reference)
<a name="l00528"></a>00528             {
<a name="l00529"></a>00529               $xml .= <span class="stringliteral">&quot;      &lt;reference local=\&quot;{$reference[&#39;local&#39;]}\&quot; foreign=\&quot;{$reference[&#39;foreign&#39;]}\&quot; /&gt;\n&quot;</span>;
<a name="l00530"></a>00530             }
<a name="l00531"></a>00531           }
<a name="l00532"></a>00532           $xml .= <span class="stringliteral">&quot;    &lt;/foreign-key&gt;\n&quot;</span>;
<a name="l00533"></a>00533         }
<a name="l00534"></a>00534       }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536       $xml .= <span class="stringliteral">&quot;  &lt;/table&gt;\n&quot;</span>;
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538     $xml .= <span class="stringliteral">&quot;\n&lt;/database&gt;\n&quot;</span>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="keywordflow">return</span> $xml;
<a name="l00541"></a>00541   }
<a name="l00542"></a>00542 
<a name="l00547"></a><a class="code" href="classsfPropelDatabaseSchema.html#a6e1c6b09f4c902e640b65577eb8d8dfe">00547</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a6e1c6b09f4c902e640b65577eb8d8dfe" title="Fixes databases in yaml shorthand schema.">fixYAMLDatabase</a>()
<a name="l00548"></a>00548   {
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (!isset($this-&gt;database[<span class="stringliteral">&#39;_attributes&#39;</span>]))
<a name="l00550"></a>00550     {
<a name="l00551"></a>00551       $this-&gt;database[<span class="stringliteral">&#39;_attributes&#39;</span>] = array();
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">// conventions for database attributes</span>
<a name="l00555"></a>00555     $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>($this-&gt;database[<span class="stringliteral">&#39;_attributes&#39;</span>], <span class="stringliteral">&#39;defaultIdMethod&#39;</span>, <span class="stringliteral">&#39;native&#39;</span>);
<a name="l00556"></a>00556     $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>($this-&gt;database[<span class="stringliteral">&#39;_attributes&#39;</span>], <span class="stringliteral">&#39;package&#39;</span>, <span class="stringliteral">&#39;lib.model&#39;</span>);
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558 
<a name="l00563"></a><a class="code" href="classsfPropelDatabaseSchema.html#a0838ba71efb5b18ed78117442b1e5d70">00563</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a0838ba71efb5b18ed78117442b1e5d70" title="Fixes i18n tables in yaml shorthand schema.">fixYAMLI18n</a>()
<a name="l00564"></a>00564   {
<a name="l00565"></a>00565     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>() as $i18n_table =&gt; $columns)
<a name="l00566"></a>00566     {
<a name="l00567"></a>00567       $pos = strpos($i18n_table, <span class="stringliteral">&#39;_i18n&#39;</span>);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569       $has_primary_key = <span class="keyword">false</span>;
<a name="l00570"></a>00570       <span class="keywordflow">foreach</span> ($columns as $column =&gt; $attributes)
<a name="l00571"></a>00571       {
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (is_array($attributes) &amp;&amp; array_key_exists(<span class="stringliteral">&#39;primaryKey&#39;</span>, $attributes))
<a name="l00573"></a>00573         {
<a name="l00574"></a>00574           $has_primary_key = <span class="keyword">true</span>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576       }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       <span class="keywordflow">if</span> ($pos &gt; 0 &amp;&amp; $pos == strlen($i18n_table) - 5 &amp;&amp; !$has_primary_key)
<a name="l00579"></a>00579       {
<a name="l00580"></a>00580         <span class="comment">// i18n table without primary key</span>
<a name="l00581"></a>00581         $main_table = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a12f683d75590377dfc6cc463d47357bd" title="Find table by name.">findTable</a>(substr($i18n_table, 0, $pos));
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <span class="keywordflow">if</span> ($main_table)
<a name="l00584"></a>00584         {
<a name="l00585"></a>00585           <span class="comment">// set i18n attributes for main table</span>
<a name="l00586"></a>00586           $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>($this-&gt;database[$main_table][<span class="stringliteral">&#39;_attributes&#39;</span>], <span class="stringliteral">&#39;isI18N&#39;</span>, 1);
<a name="l00587"></a>00587           $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>($this-&gt;database[$main_table][<span class="stringliteral">&#39;_attributes&#39;</span>], <span class="stringliteral">&#39;i18nTable&#39;</span>, $i18n_table);
<a name="l00588"></a>00588 
<a name="l00589"></a>00589           <span class="comment">// set id and culture columns for i18n table</span>
<a name="l00590"></a>00590           $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>($this-&gt;database[$i18n_table], <span class="stringliteral">&#39;id&#39;</span>, array(
<a name="l00591"></a>00591             <span class="stringliteral">&#39;type&#39;</span>             =&gt; <span class="stringliteral">&#39;integer&#39;</span>,
<a name="l00592"></a>00592             <span class="stringliteral">&#39;required&#39;</span>         =&gt; <span class="keyword">true</span>,
<a name="l00593"></a>00593             <span class="stringliteral">&#39;primaryKey&#39;</span>       =&gt; <span class="keyword">true</span>,
<a name="l00594"></a>00594             <span class="stringliteral">&#39;foreignTable&#39;</span>     =&gt; $main_table,
<a name="l00595"></a>00595             <span class="stringliteral">&#39;foreignReference&#39;</span> =&gt; <span class="stringliteral">&#39;id&#39;</span>,
<a name="l00596"></a>00596             <span class="stringliteral">&#39;onDelete&#39;</span>         =&gt; <span class="stringliteral">&#39;cascade&#39;</span>,
<a name="l00597"></a>00597           ));
<a name="l00598"></a>00598           $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>($this-&gt;database[$i18n_table], <span class="stringliteral">&#39;culture&#39;</span>, array(
<a name="l00599"></a>00599             <span class="stringliteral">&#39;isCulture&#39;</span>  =&gt; <span class="keyword">true</span>,
<a name="l00600"></a>00600             <span class="stringliteral">&#39;type&#39;</span>       =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00601"></a>00601             <span class="stringliteral">&#39;size&#39;</span>       =&gt; <span class="charliteral">&#39;7&#39;</span>,
<a name="l00602"></a>00602             <span class="stringliteral">&#39;required&#39;</span>   =&gt; <span class="keyword">true</span>,
<a name="l00603"></a>00603             <span class="stringliteral">&#39;primaryKey&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00604"></a>00604           ));
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606         <span class="keywordflow">else</span>
<a name="l00607"></a>00607         {
<a name="l00608"></a>00608           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(sprintf(<span class="stringliteral">&#39;Missing main table for internationalized table &quot;%s&quot;.&#39;</span>, $i18n_table));
<a name="l00609"></a>00609         }
<a name="l00610"></a>00610       }
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612   }
<a name="l00613"></a>00613 
<a name="l00618"></a><a class="code" href="classsfPropelDatabaseSchema.html#a1e661993dd99a6d7327fa78184a9c1d4">00618</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a1e661993dd99a6d7327fa78184a9c1d4" title="Fixes columns in yaml shorthand schema.">fixYAMLColumns</a>()
<a name="l00619"></a>00619   {
<a name="l00620"></a>00620     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>() as $table =&gt; $columns)
<a name="l00621"></a>00621     {
<a name="l00622"></a>00622       $has_primary_key = <span class="keyword">false</span>;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624       <span class="keywordflow">foreach</span> ($columns as $column =&gt; $attributes)
<a name="l00625"></a>00625       {
<a name="l00626"></a>00626         <span class="keywordflow">if</span> ($attributes == null)
<a name="l00627"></a>00627         {
<a name="l00628"></a>00628           <span class="comment">// conventions for null attributes</span>
<a name="l00629"></a>00629           <span class="keywordflow">if</span> ($column == <span class="stringliteral">&#39;created_at&#39;</span> || $column == <span class="stringliteral">&#39;updated_at&#39;</span>)
<a name="l00630"></a>00630           {
<a name="l00631"></a>00631             <span class="comment">// timestamp convention</span>
<a name="l00632"></a>00632             $this-&gt;database[$table][$column][<span class="stringliteral">&#39;type&#39;</span>]= <span class="stringliteral">&#39;timestamp&#39;</span>;
<a name="l00633"></a>00633           }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635           <span class="keywordflow">if</span> ($column == <span class="stringliteral">&#39;id&#39;</span>)
<a name="l00636"></a>00636           {
<a name="l00637"></a>00637             <span class="comment">// primary key convention</span>
<a name="l00638"></a>00638             $this-&gt;database[$table][<span class="stringliteral">&#39;id&#39;</span>] = array(
<a name="l00639"></a>00639             <span class="stringliteral">&#39;type&#39;</span>          =&gt; <span class="stringliteral">&#39;integer&#39;</span>,
<a name="l00640"></a>00640             <span class="stringliteral">&#39;required&#39;</span>      =&gt; <span class="keyword">true</span>,
<a name="l00641"></a>00641             <span class="stringliteral">&#39;primaryKey&#39;</span>    =&gt; <span class="keyword">true</span>,
<a name="l00642"></a>00642             <span class="stringliteral">&#39;autoIncrement&#39;</span> =&gt; <span class="keyword">true</span>
<a name="l00643"></a>00643             );
<a name="l00644"></a>00644             $has_primary_key = <span class="keyword">true</span>;
<a name="l00645"></a>00645           }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647           $pos = strpos($column, <span class="stringliteral">&#39;_id&#39;</span>);
<a name="l00648"></a>00648           <span class="keywordflow">if</span> ($pos &gt; 0 &amp;&amp; $pos == strlen($column) - 3)
<a name="l00649"></a>00649           {
<a name="l00650"></a>00650             <span class="comment">// foreign key convention</span>
<a name="l00651"></a>00651             $foreign_table = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a12f683d75590377dfc6cc463d47357bd" title="Find table by name.">findTable</a>(substr($column, 0, $pos));
<a name="l00652"></a>00652             <span class="keywordflow">if</span> ($foreign_table)
<a name="l00653"></a>00653             {
<a name="l00654"></a>00654               $this-&gt;database[$table][$column] = array(
<a name="l00655"></a>00655                 <span class="stringliteral">&#39;type&#39;</span>             =&gt; <span class="stringliteral">&#39;integer&#39;</span>,
<a name="l00656"></a>00656                 <span class="stringliteral">&#39;foreignTable&#39;</span>     =&gt; $foreign_table,
<a name="l00657"></a>00657                 <span class="stringliteral">&#39;foreignReference&#39;</span> =&gt; <span class="stringliteral">&#39;id&#39;</span>,
<a name="l00658"></a>00658               );
<a name="l00659"></a>00659             }
<a name="l00660"></a>00660             <span class="keywordflow">else</span>
<a name="l00661"></a>00661             {
<a name="l00662"></a>00662               <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(sprintf(<span class="stringliteral">&#39;Unable to resolve foreign table for column &quot;%s&quot;.&#39;</span>, $column));
<a name="l00663"></a>00663             }
<a name="l00664"></a>00664           }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667         <span class="keywordflow">else</span>
<a name="l00668"></a>00668         {
<a name="l00669"></a>00669           <span class="keywordflow">if</span> (!is_array($attributes))
<a name="l00670"></a>00670           {
<a name="l00671"></a>00671             <span class="comment">// compact type given as single attribute</span>
<a name="l00672"></a>00672             $this-&gt;database[$table][$column] = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a684664c52f909c7c11622e500766ba39" title="Returns attributes for compact type.">getAttributesFromCompactType</a>($attributes);
<a name="l00673"></a>00673           }
<a name="l00674"></a>00674           <span class="keywordflow">else</span>
<a name="l00675"></a>00675           {
<a name="l00676"></a>00676             <span class="keywordflow">if</span> (isset($attributes[<span class="stringliteral">&#39;type&#39;</span>]))
<a name="l00677"></a>00677             {
<a name="l00678"></a>00678               <span class="comment">// compact type given as value of the type attribute</span>
<a name="l00679"></a>00679               $this-&gt;database[$table][$column] = array_merge($this-&gt;database[$table][$column], $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a684664c52f909c7c11622e500766ba39" title="Returns attributes for compact type.">getAttributesFromCompactType</a>($attributes[<span class="stringliteral">&#39;type&#39;</span>]));
<a name="l00680"></a>00680             }
<a name="l00681"></a>00681             <span class="keywordflow">if</span> (isset($attributes[<span class="stringliteral">&#39;primaryKey&#39;</span>]))
<a name="l00682"></a>00682             {
<a name="l00683"></a>00683               $has_primary_key = <span class="keyword">true</span>;
<a name="l00684"></a>00684             }
<a name="l00685"></a>00685           }
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689       <span class="keywordflow">if</span> (!$has_primary_key)
<a name="l00690"></a>00690       {
<a name="l00691"></a>00691         <span class="comment">// convention for tables without primary key</span>
<a name="l00692"></a>00692         $this-&gt;database[$table][<span class="stringliteral">&#39;id&#39;</span>] = array(
<a name="l00693"></a>00693         <span class="stringliteral">&#39;type&#39;</span>          =&gt; <span class="stringliteral">&#39;integer&#39;</span>,
<a name="l00694"></a>00694         <span class="stringliteral">&#39;required&#39;</span>      =&gt; <span class="keyword">true</span>,
<a name="l00695"></a>00695         <span class="stringliteral">&#39;primaryKey&#39;</span>    =&gt; <span class="keyword">true</span>,
<a name="l00696"></a>00696         <span class="stringliteral">&#39;autoIncrement&#39;</span> =&gt; <span class="keyword">true</span>
<a name="l00697"></a>00697         );
<a name="l00698"></a>00698       }
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700   }
<a name="l00701"></a>00701 
<a name="l00709"></a><a class="code" href="classsfPropelDatabaseSchema.html#a684664c52f909c7c11622e500766ba39">00709</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a684664c52f909c7c11622e500766ba39" title="Returns attributes for compact type.">getAttributesFromCompactType</a>($type)
<a name="l00710"></a>00710   {
<a name="l00711"></a>00711     preg_match(<span class="stringliteral">&#39;/varchar\(([\d]+)\)/&#39;</span>, $type, $matches);
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (isset($matches[1]))
<a name="l00713"></a>00713     {
<a name="l00714"></a>00714       <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;size&#39;</span> =&gt; $matches[1]);
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716     <span class="keywordflow">else</span>
<a name="l00717"></a>00717     {
<a name="l00718"></a>00718       <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;type&#39;</span> =&gt; $type);
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720   }
<a name="l00721"></a>00721 
<a name="l00729"></a><a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab">00729</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#af014e006e322813c56c32b40862762ab" title="Sets entry if not set.">setIfNotSet</a>(&amp;$entry, $key, $value)
<a name="l00730"></a>00730   {
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (!isset($entry[$key]))
<a name="l00732"></a>00732     {
<a name="l00733"></a>00733       $entry[$key] = $value;
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735   }
<a name="l00736"></a>00736 
<a name="l00744"></a><a class="code" href="classsfPropelDatabaseSchema.html#a12f683d75590377dfc6cc463d47357bd">00744</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a12f683d75590377dfc6cc463d47357bd" title="Find table by name.">findTable</a>($table_name)
<a name="l00745"></a>00745   {
<a name="l00746"></a>00746     <span class="comment">// find a table from a phpName or a name</span>
<a name="l00747"></a>00747     $table_match = <span class="keyword">false</span>;
<a name="l00748"></a>00748     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>() as $tb_name =&gt; $table)
<a name="l00749"></a>00749     {
<a name="l00750"></a>00750       <span class="keywordflow">if</span> (
<a name="l00751"></a>00751       ($tb_name == $table_name)
<a name="l00752"></a>00752       || (isset($table[<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;phpName&#39;</span>]) &amp;&amp;
<a name="l00753"></a>00753       (
<a name="l00754"></a>00754       $table[<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;phpName&#39;</span>] == <a class="code" href="classsfInflector.html#a5424338afa474c5b37969ad674bb13a2" title="Returns a camelized string from a lower case and underscored string by replaceing...">sfInflector::camelize</a>($table_name)
<a name="l00755"></a>00755       || $table[<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;phpName&#39;</span>] == $table_name
<a name="l00756"></a>00756       )
<a name="l00757"></a>00757       || (<a class="code" href="classsfInflector.html#a1d799a0c71dbc6a73d8c36455fa7202b" title="Returns an underscore-syntaxed version or the CamelCased string.">sfInflector::underscore</a>($table_name) == $tb_name))
<a name="l00758"></a>00758       )
<a name="l00759"></a>00759       {
<a name="l00760"></a>00760         $table_match = $tb_name;
<a name="l00761"></a>00761         <span class="keywordflow">break</span>;
<a name="l00762"></a>00762       }
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     <span class="keywordflow">return</span> $table_match;
<a name="l00766"></a>00766   }
<a name="l00767"></a>00767 
<a name="l00777"></a><a class="code" href="classsfPropelDatabaseSchema.html#ac45c6d2a01b662bc9d0639c818482aa7">00777</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#ac45c6d2a01b662bc9d0639c818482aa7" title="Get attributes for column.">getAttributesForColumn</a>($tb_name, $col_name, $column)
<a name="l00778"></a>00778   {
<a name="l00779"></a>00779     $attributes_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (is_array($column))
<a name="l00781"></a>00781     {
<a name="l00782"></a>00782       <span class="keywordflow">foreach</span> ($column as $key =&gt; $value)
<a name="l00783"></a>00783       {
<a name="l00784"></a>00784         <span class="keywordflow">if</span> (!in_array($key, array(<span class="stringliteral">&#39;foreignClass&#39;</span>, <span class="stringliteral">&#39;foreignTable&#39;</span>, <span class="stringliteral">&#39;foreignReference&#39;</span>, <span class="stringliteral">&#39;fkPhpName&#39;</span>, <span class="stringliteral">&#39;fkRefPhpName&#39;</span>, <span class="stringliteral">&#39;onDelete&#39;</span>, <span class="stringliteral">&#39;onUpdate&#39;</span>, <span class="stringliteral">&#39;index&#39;</span>, <span class="stringliteral">&#39;unique&#39;</span>, <span class="stringliteral">&#39;sequence&#39;</span>, <span class="stringliteral">&#39;inheritance&#39;</span>)))
<a name="l00785"></a>00785         {
<a name="l00786"></a>00786           $attributes_string .= <span class="stringliteral">&quot; $key=\&quot;&quot;</span>.htmlspecialchars($this-&gt;getCorrectValueFor($key, $value), ENT_QUOTES, sfConfig::get(<span class="stringliteral">&#39;sf_charset&#39;</span>)).<span class="stringliteral">&quot;\&quot;&quot;</span>;
<a name="l00787"></a>00787         }
<a name="l00788"></a>00788       }
<a name="l00789"></a>00789       <span class="keywordflow">if</span> (isset($column[<span class="stringliteral">&#39;inheritance&#39;</span>]))
<a name="l00790"></a>00790       {
<a name="l00791"></a>00791         $attributes_string .= <span class="stringliteral">&#39; inheritance=&quot;single&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         $extended_package = isset($this-&gt;database[$tb_name][<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;package&#39;</span>]) ? $this-&gt;database[$tb_name][<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;package&#39;</span>] : $this-&gt;database[<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;package&#39;</span>];
<a name="l00794"></a>00794         $extended_class   = isset($this-&gt;database[$tb_name][<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;phpName&#39;</span>]) ? $this-&gt;database[$tb_name][<span class="stringliteral">&#39;_attributes&#39;</span>][<span class="stringliteral">&#39;phpName&#39;</span>] : <a class="code" href="classsfInflector.html#a5424338afa474c5b37969ad674bb13a2" title="Returns a camelized string from a lower case and underscored string by replaceing...">sfInflector::camelize</a>($tb_name);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         <span class="keywordflow">foreach</span> ($column[<span class="stringliteral">&#39;inheritance&#39;</span>] as $key =&gt; $class)
<a name="l00797"></a>00797         {
<a name="l00798"></a>00798           <span class="comment">// each inheritance class can have its own package</span>
<a name="l00799"></a>00799           $package = null;
<a name="l00800"></a>00800           <span class="keywordflow">if</span> (is_array($class))
<a name="l00801"></a>00801           {
<a name="l00802"></a>00802             $package = isset($class[<span class="stringliteral">&#39;package&#39;</span>]) ? $class[<span class="stringliteral">&#39;package&#39;</span>] : null;
<a name="l00803"></a>00803             $class   = $class[<span class="stringliteral">&#39;phpName&#39;</span>];
<a name="l00804"></a>00804           }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806           $attributes_string .= vsprintf(<span class="stringliteral">&#39;      &lt;inheritance extends=&quot;%s.%s&quot; key=&quot;%s&quot; class=&quot;%s&quot;%s /&gt;&#39;</span>, array(
<a name="l00807"></a>00807             $extended_package,
<a name="l00808"></a>00808             $extended_class,
<a name="l00809"></a>00809             $key,
<a name="l00810"></a>00810             $class,
<a name="l00811"></a>00811             $package ? <span class="stringliteral">&quot; package=\&quot;$package\&quot;&quot;</span> : <span class="stringliteral">&#39;&#39;</span>,
<a name="l00812"></a>00812           )).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00813"></a>00813         }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815         $attributes_string .= <span class="stringliteral">&#39;    &lt;/column&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00816"></a>00816       }
<a name="l00817"></a>00817       <span class="keywordflow">else</span>
<a name="l00818"></a>00818       {
<a name="l00819"></a>00819         $attributes_string .= <span class="stringliteral">&quot; /&gt;\n&quot;</span>;
<a name="l00820"></a>00820       }
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822     <span class="keywordflow">else</span>
<a name="l00823"></a>00823     {
<a name="l00824"></a>00824       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(sprintf(<span class="stringliteral">&#39;Incorrect settings for column &quot;%s&quot; of table &quot;%s&quot;.&#39;</span>, $col_name, $tb_name));
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="comment">// conventions for foreign key attributes</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (is_array($column) &amp;&amp; (isset($column[<span class="stringliteral">&#39;foreignTable&#39;</span>]) || isset($column[<span class="stringliteral">&#39;foreignClass&#39;</span>])))
<a name="l00829"></a>00829     {
<a name="l00830"></a>00830       <span class="keywordflow">if</span> (isset($column[<span class="stringliteral">&#39;foreignTable&#39;</span>]))
<a name="l00831"></a>00831       {
<a name="l00832"></a>00832         $attributes_string .= <span class="stringliteral">&quot;    &lt;foreign-key foreignTable=\&quot;{$column[&#39;foreignTable&#39;]}\&quot;&quot;</span>;
<a name="l00833"></a>00833       }
<a name="l00834"></a>00834       <span class="keywordflow">else</span>
<a name="l00835"></a>00835       {
<a name="l00836"></a>00836         $foreignTable = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a12f683d75590377dfc6cc463d47357bd" title="Find table by name.">findTable</a>($column[<span class="stringliteral">&#39;foreignClass&#39;</span>]);
<a name="l00837"></a>00837         <span class="keywordflow">if</span> (!$foreignTable)
<a name="l00838"></a>00838         {
<a name="l00839"></a>00839           <span class="comment">// Let&#39;s assume that the class given is from another schema</span>
<a name="l00840"></a>00840           <span class="comment">// We have no access to the other schema&#39;s phpNames</span>
<a name="l00841"></a>00841           <span class="comment">// So our last guess is to try to underscore the class name</span>
<a name="l00842"></a>00842           $foreignTable = <a class="code" href="classsfInflector.html#a1d799a0c71dbc6a73d8c36455fa7202b" title="Returns an underscore-syntaxed version or the CamelCased string.">sfInflector::underscore</a>($column[<span class="stringliteral">&#39;foreignClass&#39;</span>]);
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844         $attributes_string .= <span class="stringliteral">&quot;    &lt;foreign-key foreignTable=\&quot;&quot;</span>.$foreignTable.<span class="stringliteral">&quot;\&quot;&quot;</span>;
<a name="l00845"></a>00845       }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847       <span class="keywordflow">if</span> (isset($column[<span class="stringliteral">&#39;onDelete&#39;</span>]))
<a name="l00848"></a>00848       {
<a name="l00849"></a>00849         $attributes_string .= <span class="stringliteral">&quot; onDelete=\&quot;{$column[&#39;onDelete&#39;]}\&quot;&quot;</span>;
<a name="l00850"></a>00850       }
<a name="l00851"></a>00851       <span class="keywordflow">if</span> (isset($column[<span class="stringliteral">&#39;onUpdate&#39;</span>]))
<a name="l00852"></a>00852       {
<a name="l00853"></a>00853         $attributes_string .= <span class="stringliteral">&quot; onUpdate=\&quot;{$column[&#39;onUpdate&#39;]}\&quot;&quot;</span>;
<a name="l00854"></a>00854       }
<a name="l00855"></a>00855       <span class="keywordflow">if</span> (isset($column[<span class="stringliteral">&#39;fkPhpName&#39;</span>]))
<a name="l00856"></a>00856       {
<a name="l00857"></a>00857         $attributes_string .= <span class="stringliteral">&quot; phpName=\&quot;{$column[&#39;fkPhpName&#39;]}\&quot;&quot;</span>;
<a name="l00858"></a>00858       }
<a name="l00859"></a>00859       <span class="keywordflow">if</span> (isset($column[<span class="stringliteral">&#39;fkRefPhpName&#39;</span>]))
<a name="l00860"></a>00860       {
<a name="l00861"></a>00861         $attributes_string .= <span class="stringliteral">&quot; refPhpName=\&quot;{$column[&#39;fkRefPhpName&#39;]}\&quot;&quot;</span>;
<a name="l00862"></a>00862       }
<a name="l00863"></a>00863       $attributes_string .= <span class="stringliteral">&quot;&gt;\n&quot;</span>;
<a name="l00864"></a>00864       $attributes_string .= <span class="stringliteral">&quot;      &lt;reference local=\&quot;$col_name\&quot; foreign=\&quot;{$column[&#39;foreignReference&#39;]}\&quot; /&gt;\n&quot;</span>;
<a name="l00865"></a>00865       $attributes_string .= <span class="stringliteral">&quot;    &lt;/foreign-key&gt;\n&quot;</span>;
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">// conventions for index and unique index attributes</span>
<a name="l00869"></a>00869     <span class="keywordflow">if</span> (is_array($column) &amp;&amp; isset($column[<span class="stringliteral">&#39;index&#39;</span>]))
<a name="l00870"></a>00870     {
<a name="l00871"></a>00871       <span class="keywordflow">if</span> ($column[<span class="stringliteral">&#39;index&#39;</span>] === <span class="stringliteral">&#39;unique&#39;</span>)
<a name="l00872"></a>00872       {
<a name="l00873"></a>00873         $attributes_string .= <span class="stringliteral">&quot;    &lt;unique&gt;\n&quot;</span>;
<a name="l00874"></a>00874         $attributes_string .= <span class="stringliteral">&quot;      &lt;unique-column name=\&quot;$col_name\&quot; /&gt;\n&quot;</span>;
<a name="l00875"></a>00875         $attributes_string .= <span class="stringliteral">&quot;    &lt;/unique&gt;\n&quot;</span>;
<a name="l00876"></a>00876       }
<a name="l00877"></a>00877       <span class="keywordflow">else</span>
<a name="l00878"></a>00878       {
<a name="l00879"></a>00879         $attributes_string .= <span class="stringliteral">&quot;    &lt;index&gt;\n&quot;</span>;
<a name="l00880"></a>00880         $attributes_string .= <span class="stringliteral">&quot;      &lt;index-column name=\&quot;$col_name\&quot; /&gt;\n&quot;</span>;
<a name="l00881"></a>00881         $attributes_string .= <span class="stringliteral">&quot;    &lt;/index&gt;\n&quot;</span>;
<a name="l00882"></a>00882       }
<a name="l00883"></a>00883     }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="comment">// conventions for sequence name attributes</span>
<a name="l00886"></a>00886     <span class="comment">// required for databases using sequences for auto-increment columns (e.g. PostgreSQL or Oracle)</span>
<a name="l00887"></a>00887     <span class="keywordflow">if</span> (is_array($column) &amp;&amp; isset($column[<span class="stringliteral">&#39;sequence&#39;</span>]))
<a name="l00888"></a>00888     {
<a name="l00889"></a>00889       $attributes_string .= <span class="stringliteral">&quot;    &lt;id-method-parameter value=\&quot;{$column[&#39;sequence&#39;]}\&quot; /&gt;\n&quot;</span>;
<a name="l00890"></a>00890     }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="keywordflow">return</span> $attributes_string;
<a name="l00893"></a>00893   }
<a name="l00894"></a>00894 
<a name="l00902"></a><a class="code" href="classsfPropelDatabaseSchema.html#a20b03a5280a701a1af34a74f88c0ec65">00902</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a20b03a5280a701a1af34a74f88c0ec65" title="Returns attributes for a tag.">getAttributesFor</a>($tag)
<a name="l00903"></a>00903   {
<a name="l00904"></a>00904     <span class="keywordflow">if</span> (!isset($tag[<span class="stringliteral">&#39;_attributes&#39;</span>]))
<a name="l00905"></a>00905     {
<a name="l00906"></a>00906       <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908     $attributes = $tag[<span class="stringliteral">&#39;_attributes&#39;</span>];
<a name="l00909"></a>00909     $attributes_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00910"></a>00910     <span class="keywordflow">foreach</span> ($attributes as $key =&gt; $value)
<a name="l00911"></a>00911     {
<a name="l00912"></a>00912       $attributes_string .= <span class="charliteral">&#39; &#39;</span>.$key.<span class="stringliteral">&#39;=&quot;&#39;</span>.htmlspecialchars($this-&gt;getCorrectValueFor($key, $value), ENT_QUOTES, sfConfig::get(<span class="stringliteral">&#39;sf_charset&#39;</span>)).<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l00913"></a>00913     }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915     <span class="keywordflow">return</span> $attributes_string;
<a name="l00916"></a>00916   }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918   <span class="keyword">protected</span> function getCorrectValueFor($key, $value)
<a name="l00919"></a>00919   {
<a name="l00920"></a>00920     $booleans = array(<span class="stringliteral">&#39;required&#39;</span>, <span class="stringliteral">&#39;primaryKey&#39;</span>, <span class="stringliteral">&#39;autoincrement&#39;</span>, <span class="stringliteral">&#39;autoIncrement&#39;</span>, <span class="stringliteral">&#39;isI18N&#39;</span>, <span class="stringliteral">&#39;isCulture&#39;</span>);
<a name="l00921"></a>00921     <span class="keywordflow">if</span> (in_array($key, $booleans))
<a name="l00922"></a>00922     {
<a name="l00923"></a>00923       <span class="keywordflow">return</span> $value == 1 ? <span class="stringliteral">&#39;true&#39;</span> : <span class="stringliteral">&#39;false&#39;</span>;
<a name="l00924"></a>00924     }
<a name="l00925"></a>00925     <span class="keywordflow">else</span>
<a name="l00926"></a>00926     {
<a name="l00927"></a>00927       <span class="keywordflow">return</span> null === $value ? <span class="stringliteral">&#39;null&#39;</span> : $value;
<a name="l00928"></a>00928     }
<a name="l00929"></a>00929   }
<a name="l00930"></a>00930 
<a name="l00936"></a><a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24">00936</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>()
<a name="l00937"></a>00937   {
<a name="l00938"></a>00938     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#ada19775538eee88a1ac9e92f5a42952a" title="Returns the children for a given hash.">getChildren</a>($this-&gt;database);
<a name="l00939"></a>00939   }
<a name="l00940"></a>00940 
<a name="l00948"></a><a class="code" href="classsfPropelDatabaseSchema.html#ada19775538eee88a1ac9e92f5a42952a">00948</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#ada19775538eee88a1ac9e92f5a42952a" title="Returns the children for a given hash.">getChildren</a>($hash)
<a name="l00949"></a>00949   {
<a name="l00950"></a>00950     <span class="keywordflow">foreach</span> ($hash as $key =&gt; $value)
<a name="l00951"></a>00951     {
<a name="l00952"></a>00952       <span class="comment">// ignore special children (starting with _)</span>
<a name="l00953"></a>00953       <span class="keywordflow">if</span> ($key[0] == <span class="charliteral">&#39;_&#39;</span>)
<a name="l00954"></a>00954       {
<a name="l00955"></a>00955         unset($hash[$key]);
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">return</span> $hash;
<a name="l00960"></a>00960   }
<a name="l00961"></a>00961 
<a name="l00967"></a><a class="code" href="classsfPropelDatabaseSchema.html#a8f828e30a8cf8d194646010491ebc3b8">00967</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a8f828e30a8cf8d194646010491ebc3b8" title="Loads propel xml schema.">loadXML</a>($file)
<a name="l00968"></a>00968   {
<a name="l00969"></a>00969     $schema = simplexml_load_file($file);
<a name="l00970"></a>00970     $database = array();
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="comment">// database</span>
<a name="l00973"></a>00973     list($database_name, $database_attributes) = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#aab8e8e5f792c5584e74f8bd6c0dd8622" title="Returns name and attributes from given hash.">getNameAndAttributes</a>($schema-&gt;attributes());
<a name="l00974"></a>00974     <span class="keywordflow">if</span> ($database_name)
<a name="l00975"></a>00975     {
<a name="l00976"></a>00976       $this-&gt;connection_name = $database_name;
<a name="l00977"></a>00977     }
<a name="l00978"></a>00978     <span class="keywordflow">else</span>
<a name="l00979"></a>00979     {
<a name="l00980"></a>00980       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(<span class="stringliteral">&#39;The database tag misses a name attribute.&#39;</span>);
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982     <span class="keywordflow">if</span> ($database_attributes)
<a name="l00983"></a>00983     {
<a name="l00984"></a>00984       $database[<span class="stringliteral">&#39;_attributes&#39;</span>] = $database_attributes;
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987     <span class="comment">// tables</span>
<a name="l00988"></a>00988     <span class="keywordflow">foreach</span> ($schema as $table)
<a name="l00989"></a>00989     {
<a name="l00990"></a>00990       list($table_name, $table_attributes) = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#aab8e8e5f792c5584e74f8bd6c0dd8622" title="Returns name and attributes from given hash.">getNameAndAttributes</a>($table-&gt;attributes());
<a name="l00991"></a>00991       <span class="keywordflow">if</span> ($table_name)
<a name="l00992"></a>00992       {
<a name="l00993"></a>00993         $database[$table_name] = array();
<a name="l00994"></a>00994       }
<a name="l00995"></a>00995       <span class="keywordflow">else</span>
<a name="l00996"></a>00996       {
<a name="l00997"></a>00997         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(<span class="stringliteral">&#39;A table tag misses the name attribute.&#39;</span>);
<a name="l00998"></a>00998       }
<a name="l00999"></a>00999       <span class="keywordflow">if</span> ($table_attributes)
<a name="l01000"></a>01000       {
<a name="l01001"></a>01001         $database[$table_name][<span class="stringliteral">&#39;_attributes&#39;</span>] = $table_attributes;
<a name="l01002"></a>01002       }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004       <span class="comment">// columns</span>
<a name="l01005"></a>01005       <span class="keywordflow">foreach</span> ($table-&gt;xpath(<span class="stringliteral">&#39;column&#39;</span>) as $column)
<a name="l01006"></a>01006       {
<a name="l01007"></a>01007         list($column_name, $column_attributes) = $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#aab8e8e5f792c5584e74f8bd6c0dd8622" title="Returns name and attributes from given hash.">getNameAndAttributes</a>($column-&gt;attributes());
<a name="l01008"></a>01008         <span class="keywordflow">if</span> ($column_name)
<a name="l01009"></a>01009         {
<a name="l01010"></a>01010           $database[$table_name][$column_name] = $column_attributes;
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012         <span class="keywordflow">else</span>
<a name="l01013"></a>01013         {
<a name="l01014"></a>01014           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(<span class="stringliteral">&#39;A column tag misses the name attribute.&#39;</span>);
<a name="l01015"></a>01015         }
<a name="l01016"></a>01016       }
<a name="l01017"></a>01017 
<a name="l01018"></a>01018       <span class="comment">// foreign-keys</span>
<a name="l01019"></a>01019       $database[$table_name][<span class="stringliteral">&#39;_foreignKeys&#39;</span>] = array();
<a name="l01020"></a>01020       <span class="keywordflow">foreach</span> ($table-&gt;xpath(<span class="stringliteral">&#39;foreign-key&#39;</span>) as $foreign_key)
<a name="l01021"></a>01021       {
<a name="l01022"></a>01022         $foreign_key_table = array();
<a name="l01023"></a>01023 
<a name="l01024"></a>01024         <span class="comment">// foreign key attributes</span>
<a name="l01025"></a>01025         <span class="keywordflow">if</span> (isset($foreign_key[<span class="stringliteral">&#39;foreignTable&#39;</span>]))
<a name="l01026"></a>01026         {
<a name="l01027"></a>01027           $foreign_key_table[<span class="stringliteral">&#39;foreignTable&#39;</span>] = (string) $foreign_key[<span class="stringliteral">&#39;foreignTable&#39;</span>];
<a name="l01028"></a>01028         }
<a name="l01029"></a>01029         <span class="keywordflow">else</span>
<a name="l01030"></a>01030         {
<a name="l01031"></a>01031           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classsfException.html">sfException</a>(<span class="stringliteral">&#39;A foreign key misses the foreignTable attribute.&#39;</span>);
<a name="l01032"></a>01032         }
<a name="l01033"></a>01033         <span class="keywordflow">if</span> (isset($foreign_key[<span class="stringliteral">&#39;onDelete&#39;</span>]))
<a name="l01034"></a>01034         {
<a name="l01035"></a>01035           $foreign_key_table[<span class="stringliteral">&#39;onDelete&#39;</span>] = (string) $foreign_key[<span class="stringliteral">&#39;onDelete&#39;</span>];
<a name="l01036"></a>01036         }
<a name="l01037"></a>01037         <span class="keywordflow">if</span> (isset($foreign_key[<span class="stringliteral">&#39;onUpdate&#39;</span>]))
<a name="l01038"></a>01038         {
<a name="l01039"></a>01039           $foreign_key_table[<span class="stringliteral">&#39;onUpdate&#39;</span>] = (string) $foreign_key[<span class="stringliteral">&#39;onUpdate&#39;</span>];
<a name="l01040"></a>01040         }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="comment">// foreign key references</span>
<a name="l01043"></a>01043         $foreign_key_table[<span class="stringliteral">&#39;references&#39;</span>] = array();
<a name="l01044"></a>01044         <span class="keywordflow">foreach</span> ($foreign_key-&gt;xpath(<span class="stringliteral">&#39;reference&#39;</span>) as $reference)
<a name="l01045"></a>01045         {
<a name="l01046"></a>01046           $reference_attributes = array();
<a name="l01047"></a>01047           <span class="keywordflow">foreach</span> ($reference-&gt;attributes() as $reference_attribute_name =&gt; $reference_attribute_value)
<a name="l01048"></a>01048           {
<a name="l01049"></a>01049             $reference_attributes[$reference_attribute_name] = strval($reference_attribute_value);
<a name="l01050"></a>01050           }
<a name="l01051"></a>01051           $foreign_key_table[<span class="stringliteral">&#39;references&#39;</span>][] = $reference_attributes;
<a name="l01052"></a>01052         }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054         <span class="keywordflow">if</span> (isset($foreign_key[<span class="stringliteral">&#39;name&#39;</span>]))
<a name="l01055"></a>01055         {
<a name="l01056"></a>01056           $database[$table_name][<span class="stringliteral">&#39;_foreignKeys&#39;</span>][(string)$foreign_key[<span class="stringliteral">&#39;name&#39;</span>]] = $foreign_key_table;
<a name="l01057"></a>01057         }
<a name="l01058"></a>01058         <span class="keywordflow">else</span>
<a name="l01059"></a>01059         {
<a name="l01060"></a>01060           $database[$table_name][<span class="stringliteral">&#39;_foreignKeys&#39;</span>][] = $foreign_key_table;
<a name="l01061"></a>01061         }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063       }
<a name="l01064"></a>01064       $this-&gt;removeEmptyKey($database[$table_name], <span class="stringliteral">&#39;_foreignKeys&#39;</span>);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066       <span class="comment">// indexes</span>
<a name="l01067"></a>01067       $database[$table_name][<span class="stringliteral">&#39;_indexes&#39;</span>] = array();
<a name="l01068"></a>01068       <span class="keywordflow">foreach</span> ($table-&gt;xpath(<span class="stringliteral">&#39;index&#39;</span>) as $index)
<a name="l01069"></a>01069       {
<a name="l01070"></a>01070         $index_keys = array();
<a name="l01071"></a>01071         <span class="keywordflow">foreach</span> ($index-&gt;xpath(<span class="stringliteral">&#39;index-column&#39;</span>) as $index_key)
<a name="l01072"></a>01072         {
<a name="l01073"></a>01073           $index_keys[] = strval($index_key[<span class="stringliteral">&#39;name&#39;</span>]);
<a name="l01074"></a>01074         }
<a name="l01075"></a>01075         $database[$table_name][<span class="stringliteral">&#39;_indexes&#39;</span>][strval($index[<span class="stringliteral">&#39;name&#39;</span>])] = $index_keys;
<a name="l01076"></a>01076       }
<a name="l01077"></a>01077       $this-&gt;removeEmptyKey($database[$table_name], <span class="stringliteral">&#39;_indexes&#39;</span>);
<a name="l01078"></a>01078 
<a name="l01079"></a>01079       <span class="comment">// unique indexes</span>
<a name="l01080"></a>01080       $database[$table_name][<span class="stringliteral">&#39;_uniques&#39;</span>] = array();
<a name="l01081"></a>01081       <span class="keywordflow">foreach</span> ($table-&gt;xpath(<span class="stringliteral">&#39;unique&#39;</span>) as $index)
<a name="l01082"></a>01082       {
<a name="l01083"></a>01083         $unique_keys = array();
<a name="l01084"></a>01084         <span class="keywordflow">foreach</span> ($index-&gt;xpath(<span class="stringliteral">&#39;unique-column&#39;</span>) as $unique_key)
<a name="l01085"></a>01085         {
<a name="l01086"></a>01086           $unique_keys[] = strval($unique_key[<span class="stringliteral">&#39;name&#39;</span>]);
<a name="l01087"></a>01087         }
<a name="l01088"></a>01088         $database[$table_name][<span class="stringliteral">&#39;_uniques&#39;</span>][strval($index[<span class="stringliteral">&#39;name&#39;</span>])] = $unique_keys;
<a name="l01089"></a>01089       }
<a name="l01090"></a>01090       $this-&gt;removeEmptyKey($database[$table_name], <span class="stringliteral">&#39;_uniques&#39;</span>);
<a name="l01091"></a>01091     }
<a name="l01092"></a>01092     $this-&gt;database = $database;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#ad74ed023c57fd6b33294256d793faba2" title="Fixed xml for using short hand syntax.">fixXML</a>();
<a name="l01095"></a>01095   }
<a name="l01096"></a>01096 
<a name="l01102"></a><a class="code" href="classsfPropelDatabaseSchema.html#ad74ed023c57fd6b33294256d793faba2">01102</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#ad74ed023c57fd6b33294256d793faba2" title="Fixed xml for using short hand syntax.">fixXML</a>()
<a name="l01103"></a>01103   {
<a name="l01104"></a>01104     $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a85b4ad563ecb6a4f85572da8ab7afb9c" title="Fixes xml foreign keys.">fixXMLForeignKeys</a>();
<a name="l01105"></a>01105     $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a4c7e23bef9719f4706fb1da7dac564dd" title="Fixes xml indices.">fixXMLIndexes</a>();
<a name="l01106"></a>01106     <span class="comment">// $this-&gt;fixXMLColumns();</span>
<a name="l01107"></a>01107   }
<a name="l01108"></a>01108 
<a name="l01114"></a><a class="code" href="classsfPropelDatabaseSchema.html#a85b4ad563ecb6a4f85572da8ab7afb9c">01114</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a85b4ad563ecb6a4f85572da8ab7afb9c" title="Fixes xml foreign keys.">fixXMLForeignKeys</a>()
<a name="l01115"></a>01115   {
<a name="l01116"></a>01116     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>() as $table =&gt; $columns)
<a name="l01117"></a>01117     {
<a name="l01118"></a>01118       <span class="keywordflow">if</span> (isset($this-&gt;database[$table][<span class="stringliteral">&#39;_foreignKeys&#39;</span>]))
<a name="l01119"></a>01119       {
<a name="l01120"></a>01120         $foreign_keys = $this-&gt;database[$table][<span class="stringliteral">&#39;_foreignKeys&#39;</span>];
<a name="l01121"></a>01121         <span class="keywordflow">foreach</span> ($foreign_keys as $foreign_key_name =&gt; $foreign_key_attributes)
<a name="l01122"></a>01122         {
<a name="l01123"></a>01123           <span class="comment">// Only single foreign keys can be simplified</span>
<a name="l01124"></a>01124           <span class="keywordflow">if</span> (count($foreign_key_attributes[<span class="stringliteral">&#39;references&#39;</span>]) == 1)
<a name="l01125"></a>01125           {
<a name="l01126"></a>01126             $reference = $foreign_key_attributes[<span class="stringliteral">&#39;references&#39;</span>][0];
<a name="l01127"></a>01127 
<a name="l01128"></a>01128             <span class="comment">// set simple foreign key</span>
<a name="l01129"></a>01129             $this-&gt;database[$table][$reference[<span class="stringliteral">&#39;local&#39;</span>]][<span class="stringliteral">&#39;foreignTable&#39;</span>] = $foreign_key_attributes[<span class="stringliteral">&#39;foreignTable&#39;</span>];
<a name="l01130"></a>01130             $this-&gt;database[$table][$reference[<span class="stringliteral">&#39;local&#39;</span>]][<span class="stringliteral">&#39;foreignReference&#39;</span>] = $reference[<span class="stringliteral">&#39;foreign&#39;</span>];
<a name="l01131"></a>01131             <span class="keywordflow">if</span> (isset($foreign_key_attributes[<span class="stringliteral">&#39;onDelete&#39;</span>]))
<a name="l01132"></a>01132             {
<a name="l01133"></a>01133               $this-&gt;database[$table][$reference[<span class="stringliteral">&#39;local&#39;</span>]][<span class="stringliteral">&#39;onDelete&#39;</span>] = $foreign_key_attributes[<span class="stringliteral">&#39;onDelete&#39;</span>];
<a name="l01134"></a>01134             }
<a name="l01135"></a>01135             <span class="keywordflow">if</span> (isset($foreign_key_attributes[<span class="stringliteral">&#39;onUpdate&#39;</span>]))
<a name="l01136"></a>01136             {
<a name="l01137"></a>01137               $this-&gt;database[$table][$reference[<span class="stringliteral">&#39;local&#39;</span>]][<span class="stringliteral">&#39;onUpdate&#39;</span>] = $foreign_key_attributes[<span class="stringliteral">&#39;onUpdate&#39;</span>];
<a name="l01138"></a>01138             }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140             <span class="comment">// remove complex foreign key</span>
<a name="l01141"></a>01141             unset($this-&gt;database[$table][<span class="stringliteral">&#39;_foreignKeys&#39;</span>][$foreign_key_name]);
<a name="l01142"></a>01142           }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144           $this-&gt;removeEmptyKey($this-&gt;database[$table], <span class="stringliteral">&#39;_foreignKeys&#39;</span>);
<a name="l01145"></a>01145         }
<a name="l01146"></a>01146       }
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148   }
<a name="l01149"></a>01149 
<a name="l01155"></a><a class="code" href="classsfPropelDatabaseSchema.html#a4c7e23bef9719f4706fb1da7dac564dd">01155</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a4c7e23bef9719f4706fb1da7dac564dd" title="Fixes xml indices.">fixXMLIndexes</a>()
<a name="l01156"></a>01156   {
<a name="l01157"></a>01157     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>() as $table =&gt; $columns)
<a name="l01158"></a>01158     {
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (isset($this-&gt;database[$table][<span class="stringliteral">&#39;_indexes&#39;</span>]))
<a name="l01160"></a>01160       {
<a name="l01161"></a>01161         $indexes = $this-&gt;database[$table][<span class="stringliteral">&#39;_indexes&#39;</span>];
<a name="l01162"></a>01162         <span class="keywordflow">foreach</span> ($indexes as $index =&gt; $references)
<a name="l01163"></a>01163         {
<a name="l01164"></a>01164           <span class="comment">// Only single indexes can be simplified</span>
<a name="l01165"></a>01165           <span class="keywordflow">if</span> (count($references) == 1 &amp;&amp; <span class="keyword">false</span> !== substr($index, 0, strlen($index) - 6) &amp;&amp; array_key_exists(substr($index, 0, strlen($index) - 6), $columns))
<a name="l01166"></a>01166           {
<a name="l01167"></a>01167             $reference = $references[0];
<a name="l01168"></a>01168 
<a name="l01169"></a>01169             <span class="comment">// set simple index</span>
<a name="l01170"></a>01170             $this-&gt;database[$table][$reference][<span class="stringliteral">&#39;index&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172             <span class="comment">// remove complex index</span>
<a name="l01173"></a>01173             unset($this-&gt;database[$table][<span class="stringliteral">&#39;_indexes&#39;</span>][$index]);
<a name="l01174"></a>01174           }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176           $this-&gt;removeEmptyKey($this-&gt;database[$table], <span class="stringliteral">&#39;_indexes&#39;</span>);
<a name="l01177"></a>01177         }
<a name="l01178"></a>01178       }
<a name="l01179"></a>01179       <span class="keywordflow">if</span> (isset($this-&gt;database[$table][<span class="stringliteral">&#39;_uniques&#39;</span>]))
<a name="l01180"></a>01180       {
<a name="l01181"></a>01181         $uniques = $this-&gt;database[$table][<span class="stringliteral">&#39;_uniques&#39;</span>];
<a name="l01182"></a>01182         <span class="keywordflow">foreach</span> ($uniques as $index =&gt; $references)
<a name="l01183"></a>01183         {
<a name="l01184"></a>01184           <span class="comment">// Only single unique indexes can be simplified</span>
<a name="l01185"></a>01185           <span class="keywordflow">if</span> (count($references) == 1 &amp;&amp; <span class="keyword">false</span> !== substr($index, 0, strlen($index) - 7) &amp;&amp; array_key_exists(substr($index, 0, strlen($index) - 7), $columns))
<a name="l01186"></a>01186           {
<a name="l01187"></a>01187             $reference = $references[0];
<a name="l01188"></a>01188 
<a name="l01189"></a>01189             <span class="comment">// set simple index</span>
<a name="l01190"></a>01190             $this-&gt;database[$table][$reference][<span class="stringliteral">&#39;index&#39;</span>] = <span class="stringliteral">&#39;unique&#39;</span>;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192             <span class="comment">// remove complex unique index</span>
<a name="l01193"></a>01193             unset($this-&gt;database[$table][<span class="stringliteral">&#39;_uniques&#39;</span>][$index]);
<a name="l01194"></a>01194           }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196           $this-&gt;removeEmptyKey($this-&gt;database[$table], <span class="stringliteral">&#39;_uniques&#39;</span>);
<a name="l01197"></a>01197         }
<a name="l01198"></a>01198       }
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200   }
<a name="l01201"></a>01201 
<a name="l01207"></a><a class="code" href="classsfPropelDatabaseSchema.html#a4ea7bb7302449574a5d5e28a8ae1797b">01207</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#a4ea7bb7302449574a5d5e28a8ae1797b" title="Fixes xml columns.">fixXMLColumns</a>()
<a name="l01208"></a>01208   {
<a name="l01209"></a>01209     <span class="keywordflow">foreach</span> ($this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>() as $table =&gt; $columns)
<a name="l01210"></a>01210     {
<a name="l01211"></a>01211       <span class="keywordflow">foreach</span> ($columns as $column =&gt; $attributes)
<a name="l01212"></a>01212       {
<a name="l01213"></a>01213         <span class="keywordflow">if</span> ($column == <span class="stringliteral">&#39;id&#39;</span> &amp;&amp; !array_diff($attributes, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;integer&#39;</span>, <span class="stringliteral">&#39;required&#39;</span> =&gt; <span class="stringliteral">&#39;true&#39;</span>, <span class="stringliteral">&#39;primaryKey&#39;</span> =&gt; <span class="stringliteral">&#39;true&#39;</span>, <span class="stringliteral">&#39;autoIncrement&#39;</span> =&gt; <span class="stringliteral">&#39;true&#39;</span>)))
<a name="l01214"></a>01214         {
<a name="l01215"></a>01215           <span class="comment">// simplify primary keys</span>
<a name="l01216"></a>01216           $this-&gt;database[$table][<span class="stringliteral">&#39;id&#39;</span>] = null;
<a name="l01217"></a>01217         }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219         <span class="keywordflow">if</span> (($column == <span class="stringliteral">&#39;created_at&#39;</span>) || ($column == <span class="stringliteral">&#39;updated_at&#39;</span>) &amp;&amp; !array_diff($attributes, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;timestamp&#39;</span>)))
<a name="l01220"></a>01220         {
<a name="l01221"></a>01221           <span class="comment">// simplify timestamps</span>
<a name="l01222"></a>01222           $this-&gt;database[$table][$column] = null;
<a name="l01223"></a>01223         }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225         $pos                 = strpos($column, <span class="stringliteral">&#39;_id&#39;</span>);
<a name="l01226"></a>01226         $has_fk_name         = $pos &gt; 0 &amp;&amp; $pos == strlen($column) - 3;
<a name="l01227"></a>01227         $is_foreign_key      = isset($attributes[<span class="stringliteral">&#39;type&#39;</span>]) &amp;&amp; $attributes[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;integer&#39;</span> &amp;&amp; isset($attributes[<span class="stringliteral">&#39;foreignReference&#39;</span>]) &amp;&amp; $attributes[<span class="stringliteral">&#39;foreignReference&#39;</span>] == <span class="stringliteral">&#39;id&#39;</span>;
<a name="l01228"></a>01228         $has_foreign_table   = isset($attributes[<span class="stringliteral">&#39;foreignTable&#39;</span>]) &amp;&amp; array_key_exists($attributes[<span class="stringliteral">&#39;foreignTable&#39;</span>], $this-&gt;<a class="code" href="classsfPropelDatabaseSchema.html#a8b2f8dc02537bc9ce5546bb9fb1d5e24" title="Returns the tables for database.">getTables</a>());
<a name="l01229"></a>01229         $has_other_attribute = isset($attributes[<span class="stringliteral">&#39;onDelete&#39;</span>]);
<a name="l01230"></a>01230         <span class="keywordflow">if</span> ($has_fk_name &amp;&amp; $has_foreign_table &amp;&amp; $is_foreign_key &amp;&amp; !$has_other_attribute)
<a name="l01231"></a>01231         {
<a name="l01232"></a>01232           <span class="comment">// simplify foreign key</span>
<a name="l01233"></a>01233           $this-&gt;database[$table][$column] = null;
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235       }
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237   }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239   <span class="keyword">protected</span> function fixXMLBoolean($value)
<a name="l01240"></a>01240   {
<a name="l01241"></a>01241     <span class="keywordflow">switch</span> (<span class="keyword">true</span>)
<a name="l01242"></a>01242     {
<a name="l01243"></a>01243       <span class="keywordflow">case</span> <span class="keyword">true</span> === $value:
<a name="l01244"></a>01244         <span class="keywordflow">return</span> <span class="stringliteral">&#39;true&#39;</span>;
<a name="l01245"></a>01245       <span class="keywordflow">case</span> <span class="keyword">false</span> === $value:
<a name="l01246"></a>01246         <span class="keywordflow">return</span> <span class="stringliteral">&#39;false&#39;</span>;
<a name="l01247"></a>01247       <span class="keywordflow">default</span>:
<a name="l01248"></a>01248         <span class="keywordflow">return</span> $value;
<a name="l01249"></a>01249     }
<a name="l01250"></a>01250   }
<a name="l01251"></a>01251 
<a name="l01257"></a><a class="code" href="classsfPropelDatabaseSchema.html#ad3ada90d75a1765ea3232fa75ff3862e">01257</a>   <span class="keyword">public</span> function <a class="code" href="classsfPropelDatabaseSchema.html#ad3ada90d75a1765ea3232fa75ff3862e" title="Dumps schema as yaml.">asYAML</a>()
<a name="l01258"></a>01258   {
<a name="l01259"></a>01259     <span class="keywordflow">return</span> <a class="code" href="classsfYaml.html#ad910b7e301c2c836449107560cc165ec" title="Dumps a PHP array to a YAML string.">sfYaml::dump</a>(array($this-&gt;connection_name =&gt; $this-&gt;database), 3);
<a name="l01260"></a>01260   }
<a name="l01261"></a>01261 
<a name="l01270"></a><a class="code" href="classsfPropelDatabaseSchema.html#aab8e8e5f792c5584e74f8bd6c0dd8622">01270</a>   <span class="keyword">protected</span> function <a class="code" href="classsfPropelDatabaseSchema.html#aab8e8e5f792c5584e74f8bd6c0dd8622" title="Returns name and attributes from given hash.">getNameAndAttributes</a>($hash, $name_attribute = <span class="stringliteral">&#39;name&#39;</span>)
<a name="l01271"></a>01271   {
<a name="l01272"></a>01272     <span class="comment">// tag name</span>
<a name="l01273"></a>01273     $name = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01274"></a>01274     <span class="keywordflow">if</span> (isset($hash[$name_attribute]))
<a name="l01275"></a>01275     {
<a name="l01276"></a>01276       $name = strval($hash[$name_attribute]);
<a name="l01277"></a>01277       unset($hash[$name_attribute]);
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280     <span class="comment">// tag attributes</span>
<a name="l01281"></a>01281     $attributes = array();
<a name="l01282"></a>01282     <span class="keywordflow">foreach</span> ($hash as $attribute =&gt; $value)
<a name="l01283"></a>01283     {
<a name="l01284"></a>01284       $value = (string) $value;
<a name="l01285"></a>01285       <span class="keywordflow">if</span> (in_array($value, array(<span class="stringliteral">&#39;true&#39;</span>, <span class="stringliteral">&#39;on&#39;</span>)))
<a name="l01286"></a>01286       {
<a name="l01287"></a>01287         $value = <span class="keyword">true</span>;
<a name="l01288"></a>01288       }
<a name="l01289"></a>01289       elseif (in_array($value, array(<span class="stringliteral">&#39;false&#39;</span>, <span class="stringliteral">&#39;off&#39;</span>)))
<a name="l01290"></a>01290       {
<a name="l01291"></a>01291         $value = <span class="keyword">false</span>;
<a name="l01292"></a>01292       }
<a name="l01293"></a>01293       $attributes[$attribute] = $value;
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296     <span class="keywordflow">return</span> array($name, $attributes);
<a name="l01297"></a>01297   }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299   <span class="keyword">protected</span> function removeEmptyKey(&amp;$hash, $key)
<a name="l01300"></a>01300   {
<a name="l01301"></a>01301     <span class="keywordflow">if</span> (isset($hash[$key]) &amp;&amp; !$hash[$key])
<a name="l01302"></a>01302     {
<a name="l01303"></a>01303       unset($hash[$key]);
<a name="l01304"></a>01304     }
<a name="l01305"></a>01305   }
<a name="l01306"></a>01306 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
