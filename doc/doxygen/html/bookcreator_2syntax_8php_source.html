<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: web/wiki/lib/plugins/bookcreator/syntax.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>web/wiki/lib/plugins/bookcreator/syntax.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00009"></a>00009 <span class="comment">// must be run within Dokuwiki</span>
<a name="l00010"></a>00010 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;DOKU_INC&#39;</span>)) die();
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;DOKU_PLUGIN&#39;</span>)) define(<span class="stringliteral">&#39;DOKU_PLUGIN&#39;</span>, DOKU_INC . <span class="stringliteral">&#39;lib/plugins/&#39;</span>);
<a name="l00013"></a>00013 require_once(DOKU_PLUGIN . <span class="stringliteral">&#39;syntax.php&#39;</span>);
<a name="l00014"></a>00014 require_once(DOKU_INC.<span class="stringliteral">&#39;inc/search.php&#39;</span>);
<a name="l00015"></a>00015 
<a name="l00020"></a><a class="code" href="classsyntax__plugin__bookcreator.html">00020</a> <span class="keyword">class </span><a class="code" href="classsyntax__plugin__bookcreator.html" title="All DokuWiki plugins to extend the parser/rendering mechanism need to inherit from...">syntax_plugin_bookcreator</a> <span class="keyword">extends</span> <a class="code" href="classDokuWiki__Syntax__Plugin.html" title="All DokuWiki plugins to extend the parser/rendering mechanism need to inherit from...">DokuWiki_Syntax_Plugin</a> {
<a name="l00021"></a>00021     
<a name="l00022"></a>00022     var $usercansave;
<a name="l00023"></a>00023 
<a name="l00024"></a><a class="code" href="classsyntax__plugin__bookcreator.html#aa2e6176d3e931457306082ad04bc2f83">00024</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#aa2e6176d3e931457306082ad04bc2f83" title="General Info.">getInfo</a>() {
<a name="l00025"></a>00025       <span class="keywordflow">return</span> array(
<a name="l00026"></a>00026               <span class="stringliteral">&#39;author&#39;</span> =&gt; <span class="stringliteral">&#39;Luigi micco&#39;</span>,
<a name="l00027"></a>00027               <span class="stringliteral">&#39;email&#39;</span>  =&gt; <span class="stringliteral">&#39;l.micco@tiscali.it&#39;</span>,
<a name="l00028"></a>00028               <span class="stringliteral">&#39;date&#39;</span>   =&gt; <span class="stringliteral">&#39;2010-04-19&#39;</span>,
<a name="l00029"></a>00029               <span class="stringliteral">&#39;name&#39;</span>   =&gt; <span class="stringliteral">&#39;bookcreator Plugin (syntax component)&#39;</span>,
<a name="l00030"></a>00030               <span class="stringliteral">&#39;desc&#39;</span>   =&gt; <span class="stringliteral">&#39;Allow to make a book (PDF or text) from selected pages&#39;</span>,
<a name="l00031"></a>00031               <span class="stringliteral">&#39;url&#39;</span>    =&gt; <span class="stringliteral">&#39;http://www.bitlibero.com/dokuwiki/bookcreator-19.04.2010.zip&#39;</span>,
<a name="l00032"></a>00032               );
<a name="l00033"></a>00033     }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035     function connectTo($mode) {
<a name="l00036"></a>00036         $this-&gt;Lexer-&gt;addSpecialPattern(<span class="stringliteral">&#39;~~\w*?BOOK.*?~~&#39;</span>, $mode, <span class="stringliteral">&#39;plugin_bookcreator&#39;</span>);
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="comment">//function getType() { return &#39;substition&#39;; }</span>
<a name="l00040"></a><a class="code" href="classsyntax__plugin__bookcreator.html#ae65df749bc936d9b591c831d5aa68d88">00040</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#ae65df749bc936d9b591c831d5aa68d88" title="Syntax Type.">getType</a>(){ <span class="keywordflow">return</span> <span class="stringliteral">&#39;container&#39;</span>;}
<a name="l00041"></a><a class="code" href="classsyntax__plugin__bookcreator.html#ae834b89b966932c095b5754d0b6b572c">00041</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#ae834b89b966932c095b5754d0b6b572c" title="Paragraph Type.">getPType</a>(){ <span class="keywordflow">return</span> <span class="stringliteral">&#39;block&#39;</span>;}
<a name="l00042"></a>00042 
<a name="l00046"></a><a class="code" href="classsyntax__plugin__bookcreator.html#a8d2daba49e6f4f93f579e77d6305080e">00046</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#a8d2daba49e6f4f93f579e77d6305080e" title="Where to sort in?">getSort</a>(){
<a name="l00047"></a>00047         <span class="keywordflow">return</span> 190; 
<a name="l00048"></a>00048     }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="classsyntax__plugin__bookcreator.html#acd2b7e209ad67fb1b9363b08e3544b04">00051</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#acd2b7e209ad67fb1b9363b08e3544b04" title="Handler to prepare matched data for the rendering process.">handle</a>($match, $state, $pos, &amp;$handler) {
<a name="l00052"></a>00052       
<a name="l00053"></a>00053       $match = substr($match, 2, -2); <span class="comment">// strip markup</span>
<a name="l00054"></a>00054       <span class="keywordflow">if</span> (substr($match, 0, 7) == <span class="stringliteral">&#39;ARCHIVE&#39;</span>) $type = <span class="stringliteral">&#39;archive&#39;</span>;
<a name="l00055"></a>00055       <span class="keywordflow">else</span> $type = <span class="stringliteral">&#39;book&#39;</span>;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057       $num = 10;
<a name="l00058"></a>00058       $order = <span class="stringliteral">&#39;date&#39;</span>;
<a name="l00059"></a>00059       <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;archive&#39;</span>) {
<a name="l00060"></a>00060         list($junk, $params) = explode(<span class="charliteral">&#39;:&#39;</span>, $match, 2);
<a name="l00061"></a>00061         list($param1, $param2) = explode(<span class="charliteral">&#39;&amp;&#39;</span>, $params, 2);
<a name="l00062"></a>00062         
<a name="l00063"></a>00063         <span class="keywordflow">if</span> (is_numeric($param1)) {
<a name="l00064"></a>00064           $num = $param1;
<a name="l00065"></a>00065           <span class="keywordflow">if</span> (is_string($param2)) $order = $param2;
<a name="l00066"></a>00066         } elseif (is_string($param1)) {
<a name="l00067"></a>00067           $order = $param1;
<a name="l00068"></a>00068           <span class="keywordflow">if</span> (is_numeric($param2)) $num = $param2;
<a name="l00069"></a>00069         }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071       }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073       <span class="keywordflow">return</span> array($type, $num, $order);
<a name="l00074"></a>00074     
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="classsyntax__plugin__bookcreator.html#a959e733de65ebbe2f2f12658fddf0cb8">00077</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#a959e733de65ebbe2f2f12658fddf0cb8" title="Handles the actual output creation.">render</a>($mode, &amp;$renderer, $data) {
<a name="l00078"></a>00078       global $ID;
<a name="l00079"></a>00079       global $conf;
<a name="l00080"></a>00080       global $INFO;
<a name="l00081"></a>00081       global $lang;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083       list($type, $num, $order) = $data;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085       <span class="keywordflow">if</span> ($type == <span class="stringliteral">&quot;book&quot;</span>) {
<a name="l00086"></a>00086         $renderer-&gt;info[<span class="stringliteral">&#39;cache&#39;</span>] = <span class="keyword">false</span>;
<a name="l00087"></a>00087         <span class="keywordflow">if</span> (($mode == <span class="stringliteral">&#39;text&#39;</span>) &amp;&amp; (isset($_GET[<span class="stringliteral">&#39;do&#39;</span>]) &amp;&amp; ($_GET[<span class="stringliteral">&#39;do&#39;</span>] == <span class="stringliteral">&#39;export_text&#39;</span>) )) {
<a name="l00088"></a>00088           $mode = <span class="stringliteral">&#39;xhtml&#39;</span>;
<a name="l00089"></a>00089         }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="keywordflow">if</span> ($mode == <span class="stringliteral">&#39;xhtml&#39;</span>) {
<a name="l00092"></a>00092 
<a name="l00093"></a>00093           <span class="comment">// verifica che se l&#39;utente può salvare/eliminare le selezioni</span>
<a name="l00094"></a>00094           $this-&gt;usercansave = (auth_quickaclcheck($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&#39;:*&#39;</span>) &gt;= AUTH_CREATE);
<a name="l00095"></a>00095           <span class="comment">// verifica che se l&#39;utente può salvare/eliminare le selezioni</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097           <span class="keywordflow">if</span> ($this-&gt;usercansave) {        
<a name="l00098"></a>00098             <span class="keywordflow">if</span> ((isset($_POST[<span class="stringliteral">&#39;task&#39;</span>])) &amp;&amp; ($_POST[<span class="stringliteral">&#39;task&#39;</span>] == <span class="stringliteral">&quot;save&quot;</span>)) {
<a name="l00099"></a>00099               checkSecurityToken();
<a name="l00100"></a>00100               <span class="keywordflow">if</span> (isset($_COOKIE[<span class="stringliteral">&#39;list-pagelist&#39;</span>])) {
<a name="l00101"></a>00101                 <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">&#39;bookcreator_title&#39;</span>])) {
<a name="l00102"></a>00102                   $list = explode(<span class="stringliteral">&quot;|&quot;</span>, $_COOKIE[<span class="stringliteral">&#39;list-pagelist&#39;</span>]);
<a name="l00103"></a>00103                   $content = <span class="stringliteral">&quot;====== &quot;</span>.$_POST[<span class="stringliteral">&#39;bookcreator_title&#39;</span>].<span class="stringliteral">&quot; ======&quot;</span>.DOKU_LF;    
<a name="l00104"></a>00104                   <span class="keywordflow">for</span> ($n = 0; $n &lt; count($list); $n++) {            
<a name="l00105"></a>00105                     $page = $list[$n];
<a name="l00106"></a>00106                     $content .= <span class="stringliteral">&quot;  * [[:$page]]&quot;</span>.DOKU_LF;    
<a name="l00107"></a>00107                   }
<a name="l00108"></a>00108                   saveWikiText($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&quot;:&quot;</span>.$_POST[<span class="stringliteral">&#39;bookcreator_title&#39;</span>],$content, <span class="stringliteral">&quot;selection created&quot;</span>);
<a name="l00109"></a>00109                   msg($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_saved&#39;</span>).<span class="stringliteral">&quot;: &quot;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&quot;:&quot;</span>.$_POST[<span class="stringliteral">&#39;bookcreator_title&#39;</span>]);
<a name="l00110"></a>00110                 } <span class="keywordflow">else</span> {
<a name="l00111"></a>00111                   msg($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_needtitle&#39;</span>));
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113               } <span class="keywordflow">else</span> {
<a name="l00114"></a>00114                 msg($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_empty&#39;</span>));
<a name="l00115"></a>00115               }
<a name="l00116"></a>00116             } elseif ((isset($_POST[<span class="stringliteral">&#39;task&#39;</span>])) &amp;&amp; ($_POST[<span class="stringliteral">&#39;task&#39;</span>] == <span class="stringliteral">&quot;del&quot;</span>)) {
<a name="l00117"></a>00117               saveWikiText($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&quot;:&quot;</span>.$_POST[<span class="stringliteral">&#39;page&#39;</span>],<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&quot;selection removed&quot;</span>);
<a name="l00118"></a>00118               msg($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_deleted&#39;</span>).<span class="stringliteral">&quot;: &quot;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&quot;:&quot;</span>.$_POST[<span class="stringliteral">&#39;page&#39;</span>]);
<a name="l00119"></a>00119             }
<a name="l00120"></a>00120           }
<a name="l00121"></a>00121         
<a name="l00122"></a>00122           <span class="keywordflow">if</span> ((isset($_GET[<span class="stringliteral">&#39;do&#39;</span>])) || (isset($_GET[<span class="stringliteral">&#39;mddo&#39;</span>]))) {
<a name="l00123"></a>00123             <span class="keywordflow">if</span> (($_GET[<span class="stringliteral">&#39;do&#39;</span>] == <span class="stringliteral">&#39;export_html&#39;</span>) || ($_GET[<span class="stringliteral">&#39;do&#39;</span>] == <span class="stringliteral">&#39;export_text&#39;</span>)) {
<a name="l00124"></a>00124               <span class="keywordflow">if</span> (isset($_COOKIE[<span class="stringliteral">&#39;list-pagelist&#39;</span>])) {
<a name="l00125"></a>00125                 $renderer-&gt;doc = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00126"></a>00126                 $list = explode(<span class="stringliteral">&quot;|&quot;</span>, $_COOKIE[<span class="stringliteral">&#39;list-pagelist&#39;</span>]);
<a name="l00127"></a>00127               }
<a name="l00128"></a>00128               
<a name="l00129"></a>00129               $render_mode = <span class="stringliteral">&#39;xhtml&#39;</span>;
<a name="l00130"></a>00130               $lf_subst = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00131"></a>00131               <span class="keywordflow">if</span> ($_GET[<span class="stringliteral">&#39;do&#39;</span>] == <span class="stringliteral">&#39;export_text&#39;</span>) {
<a name="l00132"></a>00132                 $render_mode = <span class="stringliteral">&#39;text&#39;</span>;
<a name="l00133"></a>00133                 $lf_subst = <span class="stringliteral">&#39;&lt;br&gt;&#39;</span>;
<a name="l00134"></a>00134               }
<a name="l00135"></a>00135               
<a name="l00136"></a>00136               <span class="keywordflow">for</span> ($n = 0; $n &lt; count($list); $n++) {            
<a name="l00137"></a>00137                 $page = $list[$n];
<a name="l00138"></a>00138                 $renderer-&gt;doc .= str_replace(DOKU_LF,$lf_subst,p_cached_output(wikiFN($page),$render_mode)); <span class="comment">//p_wiki_xhtml($page,$REV,false);</span>
<a name="l00139"></a>00139               }  
<a name="l00140"></a>00140             
<a name="l00141"></a>00141             } 
<a name="l00142"></a>00142           } <span class="keywordflow">else</span> {
<a name="l00143"></a>00143             $renderer-&gt;info[<span class="stringliteral">&#39;cache&#39;</span>] = FALSE;
<a name="l00144"></a>00144             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/core.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00145"></a>00145             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/events.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00146"></a>00146             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/css.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00147"></a>00147             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/coordinates.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00148"></a>00148             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/drag.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00149"></a>00149             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/dragsort.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00150"></a>00150             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/cookies.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00151"></a>00151             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;script language=&quot;JavaScript&quot; type=&quot;text/javascript&quot; src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/sorter/more.js&quot;&gt;&lt;/script&gt;&#39;</span>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 
<a name="l00154"></a>00154             <span class="keywordflow">if</span> (isset($_COOKIE[<span class="stringliteral">&#39;bookcreator&#39;</span>]) || ((isset($_POST[<span class="stringliteral">&#39;task&#39;</span>])) &amp;&amp; ($_POST[<span class="stringliteral">&#39;task&#39;</span>] == <span class="stringliteral">&quot;read&quot;</span>)) )  {
<a name="l00155"></a>00155               $list = array();
<a name="l00156"></a>00156               $i = 0;
<a name="l00157"></a>00157               
<a name="l00158"></a>00158               <span class="comment">// c&#39;è una selezione salvata da recuperare</span>
<a name="l00159"></a>00159               <span class="keywordflow">if</span> ((isset($_POST[<span class="stringliteral">&#39;task&#39;</span>])) &amp;&amp; ($_POST[<span class="stringliteral">&#39;task&#39;</span>] == <span class="stringliteral">&quot;read&quot;</span>)) {
<a name="l00160"></a>00160                 checkSecurityToken();
<a name="l00161"></a>00161                 $renderer-&gt;doc .= <span class="stringliteral">&quot;</span>
<a name="l00162"></a>00162 <span class="stringliteral">  &lt;script type=&#39;text/javascript&#39;&gt;&lt;!--//--&gt;&lt;![CDATA[//&gt;&lt;!-- </span>
<a name="l00163"></a>00163 <span class="stringliteral">  book_removeAllPages(&#39;bookcreator&#39;);</span>
<a name="l00164"></a>00164 <span class="stringliteral">  //--&gt;&lt;!]]&gt;&lt;/script&gt;&quot;</span>;
<a name="l00165"></a>00165                 $select= rawWiki($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&quot;:&quot;</span>.$_POST[<span class="stringliteral">&#39;page&#39;</span>]);
<a name="l00166"></a>00166                 $lines = explode(<span class="stringliteral">&quot;\n&quot;</span>, $select);
<a name="l00167"></a>00167                 $nr = count($lines);
<a name="l00168"></a>00168                 <span class="keywordflow">for</span>($n=0; $n&lt;$nr; $n++) {
<a name="l00169"></a>00169                   <span class="keywordflow">if</span> (trim($lines[$n]) == <span class="stringliteral">&#39;&#39;</span>) <span class="keywordflow">continue</span>;
<a name="l00170"></a>00170                   <span class="keywordflow">if</span> ((($n &gt; 0) &amp;&amp; substr($lines[$n], 0, 7) != <span class="stringliteral">&quot;  * [[:&quot;</span>) ) <span class="keywordflow">continue</span>;
<a name="l00171"></a>00171                   
<a name="l00172"></a>00172                   <span class="keywordflow">if</span> ($n === 0){
<a name="l00173"></a>00173                     $lines[$n] = str_replace(<span class="stringliteral">&quot;====== &quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$lines[$n]);
<a name="l00174"></a>00174                     $lines[$n] = str_replace(<span class="stringliteral">&quot; ======&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$lines[$n]);
<a name="l00175"></a>00175                     $title = $lines[$i];
<a name="l00176"></a>00176                   } <span class="keywordflow">else</span> {
<a name="l00177"></a>00177                     $lines[$n] = str_replace(<span class="stringliteral">&quot;  * [[:&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$lines[$n]);
<a name="l00178"></a>00178                     $lines[$n] = str_replace(<span class="stringliteral">&quot;]]&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$lines[$n]);
<a name="l00179"></a>00179                     $list[$n] = $lines[$n];
<a name="l00180"></a>00180                     $renderer-&gt;doc .= <span class="stringliteral">&#39;</span>
<a name="l00181"></a>00181 <span class="stringliteral">  &lt;script type=&quot;text/javascript&quot;&gt;&lt;!--//--&gt;&lt;![CDATA[//&gt;&lt;!-- </span>
<a name="l00182"></a>00182 <span class="stringliteral">  book_changePage(\&#39;bookcreator[&#39;</span>.$list[$n].<span class="stringliteral">&#39;]\&#39;, 1, new Date(\&#39;July 21, 2099 00:00:00\&#39;), \&#39;/\&#39;);</span>
<a name="l00183"></a>00183 <span class="stringliteral">  //--&gt;&lt;!]]&gt;&lt;/script&gt;&#39;</span>;
<a name="l00184"></a>00184                     $i++;
<a name="l00185"></a>00185                   }
<a name="l00186"></a>00186                 }
<a name="l00187"></a>00187               <span class="comment">// oppure quella appena selezionata</span>
<a name="l00188"></a>00188               } elseif (isset($_COOKIE[<span class="stringliteral">&#39;bookcreator&#39;</span>]) )  {
<a name="l00189"></a>00189                 $fav=$_COOKIE[<span class="stringliteral">&#39;bookcreator&#39;</span>];
<a name="l00190"></a>00190 
<a name="l00191"></a>00191                 <span class="comment">//Se non ci sono pagine già inserite</span>
<a name="l00192"></a>00192                 <span class="keywordflow">if</span> ( ($fav == <span class="stringliteral">&quot;&quot;</span>) || ( count($fav) == 0) ) {
<a name="l00193"></a>00193                   $renderer-&gt;doc .= $this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_empty&#39;</span>);
<a name="l00194"></a>00194                   <span class="keywordflow">return</span>;
<a name="l00195"></a>00195                 }
<a name="l00196"></a>00196               
<a name="l00197"></a>00197                 <span class="keywordflow">foreach</span> ($fav as $page =&gt; $cpt) {
<a name="l00198"></a>00198                   list($cpt, $date) = explode(<span class="stringliteral">&quot;;&quot;</span>, $cpt);
<a name="l00199"></a>00199                   <span class="keywordflow">if</span> ($cpt&lt;1) <span class="keywordflow">continue</span>;
<a name="l00200"></a>00200                   $i++;
<a name="l00201"></a>00201                   $list[$i] = $page;
<a name="l00202"></a>00202                 }
<a name="l00203"></a>00203               }
<a name="l00204"></a>00204               
<a name="l00205"></a>00205               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;table width=&#39;100%&#39; border=&#39;0&#39; &gt;&lt;tr&gt;&quot;</span>;
<a name="l00206"></a>00206               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;td width=&#39;60%&#39; valign=&#39;top&#39;&gt;&quot;</span>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208               <span class="comment">// Pagine selezionate</span>
<a name="l00209"></a>00209               <span class="keywordflow">for</span> ($n = 1; $n &lt;= $i; $n++) {            
<a name="l00210"></a>00210                 $page = $list[$n];
<a name="l00211"></a>00211                 <span class="keywordflow">if</span> ($n == 1) {
<a name="l00212"></a>00212                   $renderer-&gt;header($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_toprint&#39;</span>), 2, 0);
<a name="l00213"></a>00213                   $renderer-&gt;doc.= <span class="stringliteral">&#39;&lt;ul id=&quot;pagelist&quot; class=&quot;boxes&quot;&gt;&#39;</span>;
<a name="l00214"></a>00214                 }
<a name="l00215"></a>00215                 $lien = $this-&gt;createLink($page);
<a name="l00216"></a>00216                 $renderer-&gt;doc.= <span class="stringliteral">&#39;  &lt;li itemID=&quot;&#39;</span>.$page.<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00217"></a>00217                 $renderer-&gt;doc .= <span class="stringliteral">&#39; &lt;a href=&quot;javascript:book_changePage(\&#39;bookcreator[&#39;</span>.$page.<span class="stringliteral">&#39;]\&#39;, 0, new Date(\&#39;July 21, 2099 00:00:00\&#39;), \&#39;/\&#39;); book_recharge();&quot;&gt;&lt;img src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/images/remove.png&quot; title=&quot;&#39;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_remove&#39;</span>).<span class="stringliteral">&#39;&quot; border=&quot;0&quot; style=&quot;vertical-align:middle;&quot; name=&quot;ctrl&quot; /&gt;&lt;/a&gt;&amp;nbsp;&amp;nbsp;&#39;</span>;
<a name="l00218"></a>00218                 $renderer-&gt;doc .= $lien;
<a name="l00219"></a>00219                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/li&gt;&#39;</span>;
<a name="l00220"></a>00220                 <span class="keywordflow">if</span> ( $n==$i ) {
<a name="l00221"></a>00221                   $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/ul&gt;&#39;</span>; 
<a name="l00222"></a>00222                   $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;br /&gt;&quot;</span>;
<a name="l00223"></a>00223                 }
<a name="l00224"></a>00224               }
<a name="l00225"></a>00225               <span class="comment">// Pagine selezionate</span>
<a name="l00226"></a>00226 
<a name="l00227"></a>00227               <span class="comment">// Pagine escluse dal libro</span>
<a name="l00228"></a>00228               <span class="keywordflow">if</span> (isset($fav))   {
<a name="l00229"></a>00229                 $i=0;
<a name="l00230"></a>00230                 <span class="keywordflow">foreach</span> ($fav as $page =&gt; $cpt) {
<a name="l00231"></a>00231                   list($cpt, $date) = explode(<span class="stringliteral">&quot;;&quot;</span>, $cpt);
<a name="l00232"></a>00232                   <span class="keywordflow">if</span> ($cpt==0) {
<a name="l00233"></a>00233                     <span class="keywordflow">if</span> (!$i) {
<a name="l00234"></a>00234                       $renderer-&gt;header($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_removed&#39;</span>), 2, 0);
<a name="l00235"></a>00235                       $renderer-&gt;listu_open();
<a name="l00236"></a>00236                     }  
<a name="l00237"></a>00237                     $lien = $this-&gt;createLink($page);
<a name="l00238"></a>00238                     $i++;
<a name="l00239"></a>00239                     $renderer-&gt;doc.= <span class="stringliteral">&quot;&lt;div id=\&quot;ex__$page\&quot;&gt;&quot;</span>;
<a name="l00240"></a>00240                     $renderer-&gt;listitem_open(1);
<a name="l00241"></a>00241                     $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;a href=&quot;javascript:book_changePage(\&#39;bookcreator[&#39;</span>.$page.<span class="stringliteral">&#39;]\&#39;, 1, new Date(\&#39;July 21, 2099 00:00:00\&#39;), \&#39;/\&#39;);  book_recharge();&quot;&gt;&lt;img src=&quot;&#39;</span>.DOKU_URL.<span class="stringliteral">&#39;lib/plugins/bookcreator/images/include.png&quot; title=&quot;&#39;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_include&#39;</span>).<span class="stringliteral">&#39;&quot; border=&quot;0&quot; style=&quot;vertical-align:middle;&quot; name=&quot;ctrl&quot; /&gt;&lt;/a&gt; &#39;</span>;
<a name="l00242"></a>00242                     $renderer-&gt;doc .= $lien;
<a name="l00243"></a>00243                     $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;/div&gt;&quot;</span>; 
<a name="l00244"></a>00244                     $renderer-&gt;listitem_close();
<a name="l00245"></a>00245                   }
<a name="l00246"></a>00246                 }
<a name="l00247"></a>00247                 <span class="keywordflow">if</span> ($i) $renderer-&gt;listu_close();
<a name="l00248"></a>00248               }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250               <span class="comment">// azzera selezione</span>
<a name="l00251"></a>00251               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;div align=&#39;center&#39;&gt;&quot;</span>; 
<a name="l00252"></a>00252               $onclick = <span class="stringliteral">&quot;javascript:if(confirm(&#39;&quot;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_reserconfirm&#39;</span>).<span class="stringliteral">&quot;&#39;)) {book_removeAllPages(&#39;bookcreator&#39;); document.reset.submit();}&quot;</span>;
<a name="l00253"></a>00253               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;form name=&quot;reset&quot; class=&quot;button&quot; method=&quot;get&quot; action=&quot;&#39;</span>.wl($ID).<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00254"></a>00254               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;button&#39; value=&#39;&quot;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_reset&#39;</span>).<span class="stringliteral">&quot;&#39; class=&#39;button&#39; onclick=\&quot;&quot;</span>.$onclick.<span class="stringliteral">&quot;\&quot;&gt;&quot;</span>;
<a name="l00255"></a>00255               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;id&#39; value=&#39;$ID&#39;/&gt;&quot;</span>;
<a name="l00256"></a>00256               $renderer-&gt;doc .= formSecurityToken(<span class="keyword">false</span>);
<a name="l00257"></a>00257               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l00258"></a>00258               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00259"></a>00259               <span class="comment">// azzera selezione</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;/td&gt;&quot;</span>;
<a name="l00262"></a>00262               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;td width=&#39;40%&#39; valign=&#39;top&#39; &gt;&quot;</span>;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;div align=&#39;center&#39;&gt;&quot;</span>; 
<a name="l00265"></a>00265               
<a name="l00266"></a>00266               <span class="comment">//Esportazione PDF</span>
<a name="l00267"></a>00267               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;form class=&quot;button&quot; method=&quot;get&quot; action=&quot;&#39;</span>.wl($ID).<span class="stringliteral">&#39;&quot; accept-charset=&quot;&#39;</span>.$lang[<span class="stringliteral">&#39;encoding&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00268"></a>00268               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;fieldset style=\&quot;text-align:left;\&quot;&gt;&lt;legend&gt;&lt;b&gt;&quot;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_export&#39;</span>).<span class="stringliteral">&quot;&lt;/b&gt;&lt;/legend&gt;&quot;</span>;
<a name="l00269"></a>00269               $renderer-&gt;doc .= $this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_title&#39;</span>).<span class="stringliteral">&quot; &quot;</span>;
<a name="l00270"></a>00270               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;input type=&quot;text&quot; class=&quot;edit&quot; value=&quot;&#39;</span>.$title.<span class="stringliteral">&#39;&quot; name=&quot;pdfbook_title&quot; size=&quot;40&quot; /&gt;&#39;</span>;
<a name="l00271"></a>00271               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;select name=&quot;do&quot; size=&quot;1&quot;&gt;&#39;</span>;
<a name="l00272"></a>00272               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;option value=&quot;export_html&quot; selected=&quot;selected&quot;&gt;&#39;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_exportprint&#39;</span>).<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274               <span class="keywordflow">if</span> (file_exists(DOKU_PLUGIN.<span class="stringliteral">&quot;text/renderer.php&quot;</span>) &amp;&amp; !plugin_isdisabled(<span class="stringliteral">&quot;text&quot;</span>)) {
<a name="l00275"></a>00275                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;option value=&quot;export_text&quot;&gt;&#39;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_exporttext&#39;</span>).<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l00276"></a>00276               }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278               <span class="keywordflow">if</span> (file_exists(DOKU_PLUGIN.<span class="stringliteral">&quot;dw2pdf/action.php&quot;</span>) &amp;&amp; !plugin_isdisabled(<span class="stringliteral">&quot;dw2pdf&quot;</span>)) {
<a name="l00279"></a>00279                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;option value=&quot;export_pdfbook&quot; selected=&quot;selected&quot;&gt;&#39;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_exportpdf&#39;</span>).<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l00280"></a>00280               }
<a name="l00281"></a>00281               
<a name="l00282"></a>00282               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/select&gt;&#39;</span>;
<a name="l00283"></a>00283               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; value=&quot;&#39;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_create&#39;</span>).<span class="stringliteral">&#39;&quot; class=&quot;button&quot;/&gt;</span>
<a name="l00284"></a>00284 <span class="stringliteral">                  &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;&#39;</span>.$ID.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l00285"></a>00285               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/fieldset&gt;&#39;</span>;
<a name="l00286"></a>00286               $renderer-&gt;doc .= formSecurityToken(<span class="keyword">false</span>);
<a name="l00287"></a>00287               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l00288"></a>00288               <span class="comment">//Esportazione PDF</span>
<a name="l00289"></a>00289               
<a name="l00290"></a>00290               <span class="keywordflow">if</span> ($this-&gt;usercansave) {
<a name="l00291"></a>00291                 <span class="comment">//Salva selezione</span>
<a name="l00292"></a>00292                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;form class=&quot;button&quot; method=&quot;post&quot; action=&quot;&#39;</span>.wl($ID).<span class="stringliteral">&#39;&quot; accept-charset=&quot;&#39;</span>.$lang[<span class="stringliteral">&#39;encoding&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00293"></a>00293                 $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;fieldset style=\&quot;text-align:left;\&quot;&gt;&lt;legend&gt;&lt;b&gt;&quot;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_saveselection&#39;</span>).<span class="stringliteral">&quot;&lt;/b&gt;&lt;/legend&gt;&quot;</span>;
<a name="l00294"></a>00294                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;input type=&quot;text&quot; class=&quot;edit&quot; value=&quot;&#39;</span>.$title.<span class="stringliteral">&#39;&quot; name=&quot;bookcreator_title&quot; /&gt;&#39;</span>;
<a name="l00295"></a>00295                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; value=&quot;&#39;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_save&#39;</span>).<span class="stringliteral">&#39;&quot; class=&quot;button&quot;/&gt;&#39;</span>;
<a name="l00296"></a>00296                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;task&quot; value=&quot;save&quot; /&gt;</span>
<a name="l00297"></a>00297 <span class="stringliteral">                    &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;&#39;</span>.$ID.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l00298"></a>00298                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/fieldset&gt;&#39;</span>;
<a name="l00299"></a>00299                 $renderer-&gt;doc .= formSecurityToken(<span class="keyword">false</span>);
<a name="l00300"></a>00300                 $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l00301"></a>00301                 <span class="comment">//Salva selezione</span>
<a name="l00302"></a>00302               }
<a name="l00303"></a>00303               
<a name="l00304"></a>00304               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;/tr&gt;&lt;/td&gt;&quot;</span>;
<a name="l00307"></a>00307               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;/table&gt;&quot;</span>;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309             } <span class="keywordflow">else</span> {
<a name="l00310"></a>00310               $renderer-&gt;doc .= $this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_nocookies&#39;</span>);
<a name="l00311"></a>00311             }
<a name="l00312"></a>00312               
<a name="l00313"></a>00313             <span class="comment">// genera la lista delle selezioni salvate</span>
<a name="l00314"></a>00314             $result = $this-&gt;_getlist($order);
<a name="l00315"></a>00315             <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($result) &gt; 0) {
<a name="l00316"></a>00316               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;form class=&quot;button&quot; id=&quot;bookcreator__selections__list&quot; name=&quot;bookcreator__selections__list&quot; method=&quot;post&quot; action=&quot;&#39;</span>.wl($ID).<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00317"></a>00317               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;fieldset style=\&quot;text-align:left;\&quot;&gt;&lt;legend&gt;&lt;b&gt;&quot;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_listselections&#39;</span>).<span class="stringliteral">&quot;&lt;/b&gt;&lt;/legend&gt;&quot;</span>;
<a name="l00318"></a>00318               $this-&gt;_showlist($renderer, $result, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l00319"></a>00319               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;task&#39; value=&#39;&#39;/&gt;&quot;</span>;
<a name="l00320"></a>00320               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;page&#39; value=&#39;&#39;/&gt;&quot;</span>;
<a name="l00321"></a>00321               $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;id&#39; value=&#39;$ID&#39;/&gt;&quot;</span>;
<a name="l00322"></a>00322               $renderer-&gt;doc .= formSecurityToken(<span class="keyword">false</span>);
<a name="l00323"></a>00323               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/fieldset&gt;&#39;</span>;
<a name="l00324"></a>00324               $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l00325"></a>00325             }  
<a name="l00326"></a>00326             <span class="comment">// genera la lista delle selezioni salvate</span>
<a name="l00327"></a>00327           }  
<a name="l00328"></a>00328         }
<a name="l00329"></a>00329         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00330"></a>00330       } <span class="keywordflow">else</span> {
<a name="l00331"></a>00331       
<a name="l00332"></a>00332         <span class="keywordflow">if</span> ($mode == <span class="stringliteral">&#39;xhtml&#39;</span>) {
<a name="l00333"></a>00333           <span class="comment">// genera la lista delle selezioni salvate</span>
<a name="l00334"></a>00334           $result = $this-&gt;_getlist($order, $num);
<a name="l00335"></a>00335           <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($result) &gt; 0) {
<a name="l00336"></a>00336             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;form class=&quot;button&quot; id=&quot;bookcreator__selections__list&quot; name=&quot;bookcreator__selections__list&quot; method=&quot;post&quot; action=&quot;&#39;</span>.wl($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;book_page&#39;</span>)).<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00337"></a>00337             $this-&gt;_showlist($renderer, $result);
<a name="l00338"></a>00338             $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;task&#39; value=&#39;&#39;/&gt;&quot;</span>;
<a name="l00339"></a>00339             $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;page&#39; value=&#39;&#39;/&gt;&quot;</span>;
<a name="l00340"></a>00340             $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;input type=&#39;hidden&#39; name=&#39;id&#39; value=&#39;&quot;</span>.$this-&gt;getConf(<span class="stringliteral">&#39;book_page&#39;</span>).<span class="stringliteral">&quot;&#39;/&gt;&quot;</span>;
<a name="l00341"></a>00341             $renderer-&gt;doc .= formSecurityToken(<span class="keyword">false</span>);
<a name="l00342"></a>00342             $renderer-&gt;doc .= <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l00343"></a>00343           }  
<a name="l00344"></a>00344           <span class="comment">// genera la lista delle selezioni salvate</span>
<a name="l00345"></a>00345         }
<a name="l00346"></a>00346         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348       }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00354"></a><a class="code" href="classsyntax__plugin__bookcreator.html#aebd8fde91cea7cd447a3b02ffabf781b">00354</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#aebd8fde91cea7cd447a3b02ffabf781b" title="usort callback to sort by file lastmodified time">_datesort</a>($a,$b){
<a name="l00355"></a>00355         <span class="keywordflow">if</span>($b[<span class="stringliteral">&#39;rev&#39;</span>] &lt; $a[<span class="stringliteral">&#39;rev&#39;</span>]) <span class="keywordflow">return</span> -1;
<a name="l00356"></a>00356         <span class="keywordflow">if</span>($b[<span class="stringliteral">&#39;rev&#39;</span>] &gt; $a[<span class="stringliteral">&#39;rev&#39;</span>]) <span class="keywordflow">return</span> 1;
<a name="l00357"></a>00357         <span class="keywordflow">return</span> strcmp($b[<span class="stringliteral">&#39;id&#39;</span>],$a[<span class="stringliteral">&#39;id&#39;</span>]);
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359 
<a name="l00363"></a><a class="code" href="classsyntax__plugin__bookcreator.html#a37c286bea6fd80c18569e7522b6acf89">00363</a>     function <a class="code" href="classsyntax__plugin__bookcreator.html#a37c286bea6fd80c18569e7522b6acf89" title="usort callback to sort by file title">_titlesort</a>($a,$b){
<a name="l00364"></a>00364         <span class="keywordflow">if</span>($a[<span class="stringliteral">&#39;id&#39;</span>] &lt;= $b[<span class="stringliteral">&#39;id&#39;</span>]) <span class="keywordflow">return</span> -1;
<a name="l00365"></a>00365         <span class="keywordflow">if</span>($a[<span class="stringliteral">&#39;id&#39;</span>] &gt; $b[<span class="stringliteral">&#39;id&#39;</span>]) <span class="keywordflow">return</span> 1;
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     function _getlist($order, $limit=0) {
<a name="l00369"></a>00369       global $conf;
<a name="l00370"></a>00370       
<a name="l00371"></a>00371       $result = array();
<a name="l00372"></a>00372       $opts = array(<span class="stringliteral">&#39;depth&#39;</span> =&gt; 1,<span class="stringliteral">&#39;listfiles&#39;</span> =&gt; <span class="keyword">true</span>,<span class="stringliteral">&#39;listdirs&#39;</span> =&gt; <span class="keyword">false</span>,<span class="stringliteral">&#39;skipacl&#39;</span> =&gt; <span class="keyword">false</span>, <span class="stringliteral">&#39;pagesonly&#39;</span> =&gt; <span class="keyword">true</span>,<span class="stringliteral">&#39;meta&#39;</span> =&gt; <span class="keyword">true</span>);
<a name="l00373"></a>00373       $tt = str_replace(<span class="charliteral">&#39;:&#39;</span>,<span class="charliteral">&#39;/&#39;</span>,$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>));
<a name="l00374"></a>00374       search(&amp;$result,$conf[<span class="stringliteral">&#39;datadir&#39;</span>],<span class="stringliteral">&#39;search_allpages&#39;</span>,$opts,$tt);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376       <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($result) &gt; 0) {
<a name="l00377"></a>00377       
<a name="l00378"></a>00378         <span class="keywordflow">if</span>($order == <span class="stringliteral">&#39;date&#39;</span>){
<a name="l00379"></a>00379           usort($result,array($this,<span class="stringliteral">&#39;_datesort&#39;</span>));
<a name="l00380"></a>00380         }elseif($order == <span class="stringliteral">&#39;title&#39;</span>){
<a name="l00381"></a>00381           usort($result,array($this,<span class="stringliteral">&#39;_titlesort&#39;</span>));
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383         
<a name="l00384"></a>00384         <span class="keywordflow">if</span> ($limit != 0) $result = array_slice($result, 0, $limit);
<a name="l00385"></a>00385       }
<a name="l00386"></a>00386       <span class="keywordflow">return</span> $result;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     
<a name="l00390"></a>00390     function _showlist(&amp;$renderer, $result, $showbin = <span class="keyword">false</span>, $showtime = <span class="keyword">false</span>) {
<a name="l00391"></a>00391 
<a name="l00392"></a>00392       $renderer-&gt;doc .= <span class="stringliteral">&#39;</span>
<a name="l00393"></a>00393 <span class="stringliteral">&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--//--&gt;&lt;![CDATA[//&gt;&lt;!-- </span>
<a name="l00394"></a>00394 <span class="stringliteral">function actionList(action,page) {</span>
<a name="l00395"></a>00395 <span class="stringliteral">  var msg = &quot;&quot;;</span>
<a name="l00396"></a>00396 <span class="stringliteral">  var flag = true;</span>
<a name="l00397"></a>00397 <span class="stringliteral">  var flagconfirm = true;</span>
<a name="l00398"></a>00398 <span class="stringliteral">  if (action == &quot;del&quot;) {</span>
<a name="l00399"></a>00399 <span class="stringliteral">    msg = &quot;&#39;</span>.$this-&gt;getLang(<span class="stringliteral">&#39;bookcreator_confirmdel&#39;</span>).<span class="stringliteral">&#39;&quot;;</span>
<a name="l00400"></a>00400 <span class="stringliteral">  } else {</span>
<a name="l00401"></a>00401 <span class="stringliteral">    if (book_countPages(&quot;bookcreator&quot;) == 0) {</span>
<a name="l00402"></a>00402 <span class="stringliteral">      flag = false;</span>
<a name="l00403"></a>00403 <span class="stringliteral">    }  </span>
<a name="l00404"></a>00404 <span class="stringliteral">    msg = &quot;&#39;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_confirmload&#39;</span>).<span class="stringliteral">&#39;&quot;;</span>
<a name="l00405"></a>00405 <span class="stringliteral">  }</span>
<a name="l00406"></a>00406 <span class="stringliteral">  </span>
<a name="l00407"></a>00407 <span class="stringliteral">  if (flag) flagconfirm = confirm(msg);</span>
<a name="l00408"></a>00408 <span class="stringliteral">  if(flagconfirm) {</span>
<a name="l00409"></a>00409 <span class="stringliteral">    document.bookcreator__selections__list.task.value=action;</span>
<a name="l00410"></a>00410 <span class="stringliteral">    document.bookcreator__selections__list.page.value=page;</span>
<a name="l00411"></a>00411 <span class="stringliteral">    document.bookcreator__selections__list.submit();</span>
<a name="l00412"></a>00412 <span class="stringliteral">    return true;</span>
<a name="l00413"></a>00413 <span class="stringliteral">  }  </span>
<a name="l00414"></a>00414 <span class="stringliteral">}</span>
<a name="l00415"></a>00415 <span class="stringliteral">//--&gt;&lt;!]]&gt;&lt;/script&gt;&#39;</span>;
<a name="l00416"></a>00416     
<a name="l00417"></a>00417     
<a name="l00418"></a>00418       $renderer-&gt;listu_open();
<a name="l00419"></a>00419       <span class="keywordflow">foreach</span>($result as $item){
<a name="l00420"></a>00420         $itemtitle = p_get_first_heading($item[<span class="stringliteral">&#39;id&#39;</span>]);
<a name="l00421"></a>00421         $nons = noNS($item[<span class="stringliteral">&#39;id&#39;</span>]);
<a name="l00422"></a>00422         $renderer-&gt;listitem_open(1);
<a name="l00423"></a>00423         <span class="keywordflow">if</span> (($showbin) &amp;&amp; (auth_quickaclcheck($item[<span class="stringliteral">&#39;id&#39;</span>]) &gt;= AUTH_DELETE)) {
<a name="l00424"></a>00424           $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;a href=\&quot;javascript:actionList(&#39;del&#39;,&#39;&quot;</span>.$nons.<span class="stringliteral">&quot;&#39;);\&quot; &gt;&lt;img src=&#39;&quot;</span>.DOKU_URL.<span class="stringliteral">&quot;lib/plugins/bookcreator/images/remove.png&#39; title=&#39;&quot;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_delselection&#39;</span>).<span class="stringliteral">&quot;&#39; border=&#39;0&#39; style=&#39;vertical-align:middle;&#39; /&gt;&lt;/a&gt; &quot;</span>;
<a name="l00425"></a>00425         }  
<a name="l00426"></a>00426         $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;a href=&#39;&quot;</span>.wl($this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#a41db1825b875b7ed65920b3e386bff31" title="getConf($setting)">getConf</a>(<span class="stringliteral">&#39;save_namespace&#39;</span>).<span class="stringliteral">&quot;:&quot;</span>.$nons).<span class="stringliteral">&quot;&#39;&gt;&lt;img src=&#39;&quot;</span>.DOKU_URL.<span class="stringliteral">&quot;lib/plugins/bookcreator/images/include.png&#39; title=&#39;&quot;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_showpage&#39;</span>).<span class="stringliteral">&quot;&#39; border=&#39;0&#39; style=&#39;vertical-align:middle;&#39; /&gt;&lt;/a&gt; &quot;</span>;
<a name="l00427"></a>00427         $renderer-&gt;doc .= <span class="stringliteral">&quot;&lt;a href=\&quot;javascript:actionList(&#39;read&#39;,&#39;&quot;</span>.$nons.<span class="stringliteral">&quot;&#39;);\&quot; title=&#39;&quot;</span>.$this-&gt;<a class="code" href="classDokuWiki__Syntax__Plugin.html#ad10d22a79346478e1d65dd00a68c3a2c" title="getLang($id)">getLang</a>(<span class="stringliteral">&#39;bookcreator_loadselection&#39;</span>).<span class="stringliteral">&quot;&#39;&gt;&quot;</span>.$itemtitle.<span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>;
<a name="l00428"></a>00428         <span class="keywordflow">if</span> ($showtime) $renderer-&gt;cdata(<span class="stringliteral">&#39; (&#39;</span>.dformat($item[<span class="stringliteral">&#39;mtime&#39;</span>]).<span class="charliteral">&#39;)&#39;</span>);
<a name="l00429"></a>00429         $renderer-&gt;listitem_close();
<a name="l00430"></a>00430       }
<a name="l00431"></a>00431       $renderer-&gt;listu_close();
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     function createLink($page, $title=<span class="stringliteral">&quot;&quot;</span>) {
<a name="l00436"></a>00436       $pos = strrpos(utf8_decode($page), <span class="charliteral">&#39;:&#39;</span>);
<a name="l00437"></a>00437       $pageName = p_get_first_heading($page);
<a name="l00438"></a>00438       <span class="keywordflow">if</span>($pageName == NULL) {
<a name="l00439"></a>00439         <span class="keywordflow">if</span>($pos != FALSE) {
<a name="l00440"></a>00440           $pageName = utf8_substr($page, $pos+1, utf8_strlen($page));
<a name="l00441"></a>00441         } <span class="keywordflow">else</span> {
<a name="l00442"></a>00442           $pageName = $page;
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444         $pageName = str_replace(<span class="charliteral">&#39;_&#39;</span>, <span class="charliteral">&#39; &#39;</span>, $pageName);
<a name="l00445"></a>00445       }    
<a name="l00446"></a>00446       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;a href=&#39;&quot;</span>.wl($page, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="stringliteral">&quot;&amp;&quot;</span>).<span class="stringliteral">&quot;&#39;&gt;&quot;</span>.$pageName.<span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>;
<a name="l00447"></a>00447    }
<a name="l00448"></a>00448    
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 ?&gt;
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
