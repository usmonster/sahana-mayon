<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: web/wiki/lib/plugins/dw2pdf/mpdf/mpdf.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>web/wiki/lib/plugins/dw2pdf/mpdf/mpdf.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="comment">// ******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment">// Software: mPDF, Unicode-HTML Free PDF generator                              *</span>
<a name="l00006"></a>00006 <span class="comment">// Version:  4.4           based on                                             *</span>
<a name="l00007"></a>00007 <span class="comment">//           FPDF 1.52 by Olivier PLATHEY                                       *</span>
<a name="l00008"></a>00008 <span class="comment">//           UFPDF 0.1 by Steven Wittens                                        *</span>
<a name="l00009"></a>00009 <span class="comment">//           HTML2FPDF 3.0.2beta by Renato Coelho                               *</span>
<a name="l00010"></a>00010 <span class="comment">// Date:     2010-03-24                                                         *</span>
<a name="l00011"></a>00011 <span class="comment">// Author:   Ian Back &lt;ianb@bpm1.com&gt;                                           *</span>
<a name="l00012"></a>00012 <span class="comment">// License:  GPL                                                                *</span>
<a name="l00013"></a>00013 <span class="comment">//                                                                              *</span>
<a name="l00014"></a>00014 <span class="comment">// Changes:  See changelog.txt                                                  *</span>
<a name="l00015"></a>00015 <span class="comment">// ******************************************************************************</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 define(<span class="stringliteral">&#39;mPDF_VERSION&#39;</span>,<span class="stringliteral">&#39;4.4&#39;</span>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 define(<span class="stringliteral">&#39;AUTOFONT_CJK&#39;</span>,1);
<a name="l00021"></a>00021 define(<span class="stringliteral">&#39;AUTOFONT_THAIVIET&#39;</span>,2);
<a name="l00022"></a>00022 define(<span class="stringliteral">&#39;AUTOFONT_RTL&#39;</span>,4);
<a name="l00023"></a>00023 define(<span class="stringliteral">&#39;AUTOFONT_INDIC&#39;</span>,8);
<a name="l00024"></a>00024 define(<span class="stringliteral">&#39;AUTOFONT_ALL&#39;</span>,15);
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 define(<span class="stringliteral">&#39;_BORDER_ALL&#39;</span>,15);
<a name="l00027"></a>00027 define(<span class="stringliteral">&#39;_BORDER_TOP&#39;</span>,8);
<a name="l00028"></a>00028 define(<span class="stringliteral">&#39;_BORDER_RIGHT&#39;</span>,4);
<a name="l00029"></a>00029 define(<span class="stringliteral">&#39;_BORDER_BOTTOM&#39;</span>,2);
<a name="l00030"></a>00030 define(<span class="stringliteral">&#39;_BORDER_LEFT&#39;</span>,1);
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;_MPDF_PATH&#39;</span>)) define(<span class="stringliteral">&#39;_MPDF_PATH&#39;</span>, dirname(preg_replace(<span class="stringliteral">&#39;/\\\\/&#39;</span>,<span class="charliteral">&#39;/&#39;</span>,__FILE__)) . <span class="charliteral">&#39;/&#39;</span>); <span class="comment">// mPDF 4.2 \ to /</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 require_once(_MPDF_PATH.<span class="stringliteral">&#39;includes/functions.php&#39;</span>);
<a name="l00035"></a>00035 require_once(_MPDF_PATH.<span class="stringliteral">&#39;config_cp.php&#39;</span>);
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;_JPGRAPH_PATH&#39;</span>)) define(<span class="stringliteral">&quot;_JPGRAPH_PATH&quot;</span>, _MPDF_PATH.<span class="stringliteral">&#39;jpgraph/&#39;</span>); 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;_MPDF_TEMP_PATH&#39;</span>)) define(<span class="stringliteral">&quot;_MPDF_TEMP_PATH&quot;</span>, _MPDF_PATH.<span class="stringliteral">&#39;tmp/&#39;</span>);  <span class="comment">// mPDF 4.3.007E</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 $errorlevel=error_reporting();
<a name="l00042"></a>00042 $errorlevel=error_reporting($errorlevel &amp; ~E_NOTICE);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">//error_reporting(E_ALL);</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="keywordflow">if</span>(function_exists(<span class="stringliteral">&quot;date_default_timezone_set&quot;</span>) and function_exists(<span class="stringliteral">&quot;date_default_timezone_get&quot;</span>))
<a name="l00047"></a>00047 @date_default_timezone_set(@date_default_timezone_get());
<a name="l00048"></a>00048 <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&quot;mb_strlen&quot;</span>)) { die(<span class="stringliteral">&quot;Error - mPDF requires mb_string functions. Ensure that PHP is compiled with php_mbstring.dll enabled.&quot;</span>); }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">class </span><a class="code" href="classmPDF.html">mPDF</a>
<a name="l00051"></a>00051 {
<a name="l00052"></a>00052 
<a name="l00054"></a>00054 <span class="comment">// EXTERNAL (PUBLIC) VARIABLES</span>
<a name="l00055"></a>00055 <span class="comment">// Define these in config.php</span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 var $watermarkImgBehind; <span class="comment">// mPDF 4.3.018</span>
<a name="l00059"></a>00059 var $justifyB4br;   <span class="comment">// mPDF 4.3.003</span>
<a name="l00060"></a>00060 var $packTableData; <span class="comment">// mPDF 4.3.009</span>
<a name="l00061"></a>00061 var $pgsIns;    <span class="comment">// mPDF 4.2.020</span>
<a name="l00062"></a>00062 var $PDFA;      <span class="comment">// mPDF 4.2.018</span>
<a name="l00063"></a>00063 var $PDFAauto;    <span class="comment">// mPDF 4.2.018</span>
<a name="l00064"></a>00064 var $ICCProfile;    <span class="comment">// mPDF 4.2.018</span>
<a name="l00065"></a>00065 var $simpleTables;  <span class="comment">// mPDF 4.2.017</span>
<a name="l00066"></a>00066 var $enableImports; <span class="comment">// mPDF 4.2.006 Adding mPDFI</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 var $debug;
<a name="l00069"></a>00069 var $showStats;
<a name="l00070"></a>00070 var $setAutoTopMargin;
<a name="l00071"></a>00071 var $setAutoBottomMargin;
<a name="l00072"></a>00072 var $autoMarginPadding;
<a name="l00073"></a>00073 <span class="comment">// mPDF 4.2</span>
<a name="l00074"></a>00074 var $collapseBlockMargins;
<a name="l00075"></a>00075 var $useSubstitutionsMB;
<a name="l00076"></a>00076 var $falseBoldWeight;
<a name="l00077"></a>00077 var $normalLineheight;
<a name="l00078"></a>00078 var $progressBar;
<a name="l00079"></a>00079 var $incrementFPR1;
<a name="l00080"></a>00080 var $incrementFPR2;
<a name="l00081"></a>00081 var $incrementFPR3;
<a name="l00082"></a>00082 var $incrementFPR4;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 var $hyphenate;
<a name="l00085"></a>00085 var $hyphenateTables;
<a name="l00086"></a>00086 var $SHYlang;
<a name="l00087"></a>00087 var $SHYleftmin;
<a name="l00088"></a>00088 var $SHYrightmin;
<a name="l00089"></a>00089 var $SHYcharmin;
<a name="l00090"></a>00090 var $SHYcharmax;
<a name="l00091"></a>00091 var $SHYlanguages;
<a name="l00092"></a>00092 <span class="comment">// PageNumber Conditional Text</span>
<a name="l00093"></a>00093 var $pagenumPrefix;
<a name="l00094"></a>00094 var $pagenumSuffix;
<a name="l00095"></a>00095 var $nbpgPrefix;
<a name="l00096"></a>00096 var $nbpgSuffix;
<a name="l00097"></a>00097 var $showImageErrors;
<a name="l00098"></a>00098 var $allow_output_buffering;
<a name="l00099"></a>00099 var $autoPadding;
<a name="l00100"></a>00100 var $useGraphs;
<a name="l00101"></a>00101 var $autoFontGroupSize;
<a name="l00102"></a>00102 var $disableMultilingualJustify;
<a name="l00103"></a>00103 var $tabSpaces;
<a name="l00104"></a>00104 var $useLang;
<a name="l00105"></a>00105 var $restoreBlockPagebreaks;
<a name="l00106"></a>00106 var $watermarkTextAlpha;
<a name="l00107"></a>00107 var $watermarkImageAlpha;
<a name="l00108"></a>00108 var $watermark_size;
<a name="l00109"></a>00109 var $watermark_pos;
<a name="l00110"></a>00110 var $annotSize;
<a name="l00111"></a>00111 var $annotMargin;
<a name="l00112"></a>00112 var $annotOpacity;
<a name="l00113"></a>00113 var $title2annots;
<a name="l00114"></a>00114 var $keepColumns;
<a name="l00115"></a>00115 var $keep_table_proportions;
<a name="l00116"></a>00116 var $ignore_table_widths;
<a name="l00117"></a>00117 var $ignore_table_percents;
<a name="l00118"></a>00118 var $list_align_style;
<a name="l00119"></a>00119 var $list_number_suffix;
<a name="l00120"></a>00120 var $useSubstitutions;
<a name="l00121"></a>00121 var $CSSselectMedia;  <span class="comment">// mPDF 4.3.001</span>
<a name="l00122"></a>00122 <span class="comment">// $disablePrintCSS depracated</span>
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 var $forcePortraitHeaders;
<a name="l00125"></a>00125 var $forcePortraitMargins;
<a name="l00126"></a>00126 var $displayDefaultOrientation;
<a name="l00127"></a>00127 var $ignore_invalid_utf8;
<a name="l00128"></a>00128 var $allowedCSStags;
<a name="l00129"></a>00129 var $useOnlyCoreFonts;
<a name="l00130"></a>00130 var $use_CJK_only;
<a name="l00131"></a>00131 var $allow_charset_conversion;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 var $jSpacing;
<a name="l00134"></a>00134 var $jSWord;
<a name="l00135"></a>00135 var $jSmaxChar;
<a name="l00136"></a>00136 var $jSmaxCharLast;
<a name="l00137"></a>00137 var $jSmaxWordLast;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 var $orphansAllowed;
<a name="l00140"></a>00140 var $max_colH_correction;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 var $table_error_report;
<a name="l00144"></a>00144 var $table_error_report_param;
<a name="l00145"></a>00145 var $biDirectional;
<a name="l00146"></a>00146 var $text_input_as_HTML; 
<a name="l00147"></a>00147 var $anchor2Bookmark;
<a name="l00148"></a>00148 var $list_indent_first_level;
<a name="l00149"></a>00149 var $shrink_tables_to_fit;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 var $rtlCSS;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 var $allow_html_optional_endtags;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 var $img_dpi;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 var $defaultheaderfontsize;
<a name="l00158"></a>00158 var $defaultheaderfontstyle;
<a name="l00159"></a>00159 var $defaultheaderline;
<a name="l00160"></a>00160 var $defaultfooterfontsize;
<a name="l00161"></a>00161 var $defaultfooterfontstyle;
<a name="l00162"></a>00162 var $defaultfooterline; 
<a name="l00163"></a>00163 var $header_line_spacing;
<a name="l00164"></a>00164 var $footer_line_spacing;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 var $textarea_lineheight;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 var $pregRTLchars;  
<a name="l00169"></a>00169 var $pregUHCchars;
<a name="l00170"></a>00170 var $pregSJISchars;
<a name="l00171"></a>00171 var $pregCJKchars;
<a name="l00172"></a>00172 var $pregASCIIchars1;
<a name="l00173"></a>00173 var $pregASCIIchars2;
<a name="l00174"></a>00174 var $pregASCIIchars3;
<a name="l00175"></a>00175 var $pregVIETchars; 
<a name="l00176"></a>00176 var $pregVIETPluschars;
<a name="l00177"></a>00177 var $pregHEBchars;
<a name="l00178"></a>00178 var $pregARABICchars; 
<a name="l00179"></a>00179 var $pregNonARABICchars;  
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">// INDIC</span>
<a name="l00182"></a>00182 var $pregHIchars;
<a name="l00183"></a>00183 var $pregBNchars;
<a name="l00184"></a>00184 var $pregPAchars;
<a name="l00185"></a>00185 var $pregGUchars;
<a name="l00186"></a>00186 var $pregORchars;
<a name="l00187"></a>00187 var $pregTAchars;
<a name="l00188"></a>00188 var $pregTEchars;
<a name="l00189"></a>00189 var $pregKNchars;
<a name="l00190"></a>00190 var $pregMLchars;
<a name="l00191"></a>00191 var $pregSHchars;
<a name="l00192"></a>00192 var $pregINDextra;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 var $mirrorMargins;
<a name="l00195"></a>00195 var $default_lineheight_correction;
<a name="l00196"></a>00196 var $watermarkText;
<a name="l00197"></a>00197 var $watermarkImage;
<a name="l00198"></a>00198 var $showWatermarkText;
<a name="l00199"></a>00199 var $showWatermarkImage;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 var $fontsizes;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="comment">// Aliases for backward compatability</span>
<a name="l00204"></a>00204 var $UnvalidatedText; <span class="comment">// alias = $watermarkText</span>
<a name="l00205"></a>00205 var $TopicIsUnvalidated;  <span class="comment">// alias = $showWatermarkText</span>
<a name="l00206"></a>00206 var $use_embeddedfonts_1252;  <span class="comment">// alias = $useOnlyCoreFonts</span>
<a name="l00207"></a>00207 var $useOddEven;    <span class="comment">// alias = $mirrorMargins</span>
<a name="l00208"></a>00208 
<a name="l00210"></a>00210 <span class="comment">// INTERNAL VARIABLES</span>
<a name="l00212"></a>00212 <span class="comment"></span>var $watermarkImgAlpha; <span class="comment">// mPDF 4.3.018</span>
<a name="l00213"></a>00213 var $PDFAwarnings;  <span class="comment">// mPDF 4.2.018</span>
<a name="l00214"></a>00214 var $MetadataRoot;  <span class="comment">// mPDF 4.2.018</span>
<a name="l00215"></a>00215 var $OutputIntentRoot;  <span class="comment">// mPDF 4.2.018</span>
<a name="l00216"></a>00216 var $InfoRoot;    <span class="comment">// mPDF 4.2.018</span>
<a name="l00217"></a>00217 <span class="comment">// mPDF 4.2.006 From mPDFI</span>
<a name="l00218"></a>00218 var $current_filename;
<a name="l00219"></a>00219 var $parsers;
<a name="l00220"></a>00220 var $current_parser;
<a name="l00221"></a>00221 var $_obj_stack;
<a name="l00222"></a>00222 var $_don_obj_stack;
<a name="l00223"></a>00223 var $_current_obj_id;
<a name="l00224"></a>00224 var $tpls;
<a name="l00225"></a>00225 var $tpl;
<a name="l00226"></a>00226 var $tplprefix;
<a name="l00227"></a>00227 var $_res;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 var $pdf_version;
<a name="l00231"></a>00231 <span class="comment">// mPDF 4.2</span>
<a name="l00232"></a>00232 var $noImageFile;
<a name="l00233"></a>00233 var $lastblockbottommargin;
<a name="l00234"></a>00234 var $baselineC;
<a name="l00235"></a>00235 var $subPos;
<a name="l00236"></a>00236 var $subArrMB;
<a name="l00237"></a>00237 var $ReqFontStyle;  <span class="comment">// mPDF 4.2</span>
<a name="l00238"></a>00238 var $tableClipPath ;  <span class="comment">// mPDF 4.2</span>
<a name="l00239"></a>00239 var $forceExactLineheight;  <span class="comment">// mPDF 4.2</span>
<a name="l00240"></a>00240 var $listOcc;   <span class="comment">// mPDF 4.2</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">// mPDF 4.1</span>
<a name="l00243"></a>00243 var $fullImageHeight;
<a name="l00244"></a>00244 <span class="comment">// mPDF 4.0</span>
<a name="l00245"></a>00245 var $inFixedPosBlock;   <span class="comment">// Internal flag for position:fixed block</span>
<a name="l00246"></a>00246 var $fixedPosBlock;   <span class="comment">// Buffer string for position:fixed block</span>
<a name="l00247"></a>00247 var $fixedPosBlockDepth;
<a name="l00248"></a>00248 var $fixedPosBlockBBox;
<a name="l00249"></a>00249 var $fixedPosBlockSave;
<a name="l00250"></a>00250 var $maxPosL;
<a name="l00251"></a>00251 var $maxPosR;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 var $loaded;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 var $useSubsets;  
<a name="l00256"></a>00256 var $extraFontSubsets;
<a name="l00257"></a>00257 var $docTemplateStart;    <span class="comment">// Internal flag for page (page no. -1) that docTemplate starts on</span>
<a name="l00258"></a>00258 var $time0;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="comment">// Classes</span>
<a name="l00261"></a>00261 var $t1asm;
<a name="l00262"></a>00262 var $indic;
<a name="l00263"></a>00263 var $barcode;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 var $SHYpatterns;
<a name="l00266"></a>00266 var $loadedSHYpatterns;
<a name="l00267"></a>00267 var $loadedSHYdictionary;
<a name="l00268"></a>00268 var $SHYdictionary;
<a name="l00269"></a>00269 var $SHYdictionaryWords;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 var $spanbgcolorarray;
<a name="l00272"></a>00272 var $default_font;
<a name="l00273"></a>00273 var $list_lineheight;
<a name="l00274"></a>00274 var $headerbuffer;
<a name="l00275"></a>00275 var $lastblocklevelchange;
<a name="l00276"></a>00276 var $nestedtablejustfinished;
<a name="l00277"></a>00277 var $linebreakjustfinished;
<a name="l00278"></a>00278 var $cell_border_dominance_L;
<a name="l00279"></a>00279 var $cell_border_dominance_R;
<a name="l00280"></a>00280 var $cell_border_dominance_T;
<a name="l00281"></a>00281 var $cell_border_dominance_B;
<a name="l00282"></a>00282 var $tbCSSlvl;
<a name="l00283"></a>00283 var $listCSSlvl;
<a name="l00284"></a>00284 var $table_keep_together;
<a name="l00285"></a>00285 var $plainCell_properties;
<a name="l00286"></a>00286 var $inherit_lineheight;
<a name="l00287"></a>00287 var $listitemtype;
<a name="l00288"></a>00288 var $shrin_k1;
<a name="l00289"></a>00289 var $outerfilled;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 var $blockContext;
<a name="l00292"></a>00292 var $floatDivs;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 var $tablecascadeCSS;
<a name="l00295"></a>00295 var $listcascadeCSS;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 var $patterns;
<a name="l00298"></a>00298 var $pageBackgrounds;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 var $bodyBackgroundGradient;
<a name="l00301"></a>00301 var $bodyBackgroundImage;
<a name="l00302"></a>00302 var $bodyBackgroundColor;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 var $writingHTMLheader; <span class="comment">// internal flag - used both for writing HTMLHeaders/Footers and FixedPos block</span>
<a name="l00305"></a>00305 var $writingHTMLfooter;
<a name="l00306"></a>00306 var $autoFontGroups;
<a name="l00307"></a>00307 var $angle;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 var $gradients;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 var $kwt_Reference;
<a name="l00312"></a>00312 var $kwt_BMoutlines;
<a name="l00313"></a>00313 var $kwt_toc;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 var $tbrot_Reference;
<a name="l00316"></a>00316 var $tbrot_BMoutlines;
<a name="l00317"></a>00317 var $tbrot_toc;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 var $col_Reference;
<a name="l00320"></a>00320 var $col_BMoutlines;
<a name="l00321"></a>00321 var $col_toc;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 var $currentGraphId;
<a name="l00324"></a>00324 var $graphs;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 var $floatbuffer;
<a name="l00327"></a>00327 var $floatmargins;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 var $bullet;
<a name="l00330"></a>00330 var $bulletarray;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 var $rtlAsArabicFarsi;    <span class="comment">// DEPRACATED</span>
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 var $currentLang;
<a name="l00335"></a>00335 var $default_lang;
<a name="l00336"></a>00336 var $default_jSpacing;
<a name="l00337"></a>00337 var $default_available_fonts;
<a name="l00338"></a>00338 var $default_dir;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 var $pageTemplate;
<a name="l00341"></a>00341 var $docTemplate;
<a name="l00342"></a>00342 var $docTemplateContinue;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 var $arabGlyphs;
<a name="l00345"></a>00345 var $arabHex;
<a name="l00346"></a>00346 var $persianGlyphs;
<a name="l00347"></a>00347 var $persianHex;
<a name="l00348"></a>00348 var $arabVowels;
<a name="l00349"></a>00349 var $arabPrevLink;
<a name="l00350"></a>00350 var $arabNextLink;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 var $formobjects; <span class="comment">// array of Form Objects for WMF</span>
<a name="l00354"></a>00354 var $gdiObjectArray;      <span class="comment">// array of GDI objects for WMF</span>
<a name="l00355"></a>00355 var $InlineProperties;  <span class="comment">// Should have done this a long time ago</span>
<a name="l00356"></a>00356 var $InlineAnnots;
<a name="l00357"></a>00357 var $ktAnnots;
<a name="l00358"></a>00358 var $tbrot_Annots;
<a name="l00359"></a>00359 var $kwt_Annots;
<a name="l00360"></a>00360 var $columnAnnots;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 var $PageAnnots;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 var $pageDim; <span class="comment">// Keep track of page wxh for orientation changes - set in _beginpage, used in _putannots</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 var $breakpoints;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 var $tableLevel;
<a name="l00370"></a>00370 var $tbctr;
<a name="l00371"></a>00371 var $innermostTableLevel;
<a name="l00372"></a>00372 var $saveTableCounter;
<a name="l00373"></a>00373 var $cellBorderBuffer;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 var $saveHTMLFooter_height;
<a name="l00376"></a>00376 var $saveHTMLFooterE_height;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 var $firstPageBoxHeader;
<a name="l00379"></a>00379 var $firstPageBoxHeaderEven;
<a name="l00380"></a>00380 var $firstPageBoxFooter;
<a name="l00381"></a>00381 var $firstPageBoxFooterEven;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 var $page_box;
<a name="l00384"></a>00384 var $show_marks;  <span class="comment">// crop or cross marks</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 var $basepathIsLocal;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 var $use_kwt;
<a name="l00389"></a>00389 var $kwt;
<a name="l00390"></a>00390 var $kwt_height;
<a name="l00391"></a>00391 var $kwt_y0;
<a name="l00392"></a>00392 var $kwt_x0;
<a name="l00393"></a>00393 var $kwt_buffer;
<a name="l00394"></a>00394 var $kwt_Links;
<a name="l00395"></a>00395 var $kwt_moved;
<a name="l00396"></a>00396 var $kwt_saved;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 <span class="comment">// NOT USED???</span>
<a name="l00399"></a>00399 var $formBgColor;
<a name="l00400"></a>00400 var $formBgColorSmall;  <span class="comment">// Color used for background of form fields if reduced in size (so border disappears)</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 var $PageNumSubstitutions;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404  
<a name="l00405"></a>00405 var $table_borders_separate;
<a name="l00406"></a>00406 var $base_table_properties;
<a name="l00407"></a>00407 var $borderstyles;
<a name="l00408"></a>00408 <span class="comment">// doesn&#39;t include none or hidden</span>
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 var $listjustfinished;
<a name="l00411"></a>00411 var $blockjustfinished;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 var $orig_bMargin;
<a name="l00414"></a>00414 var $orig_tMargin;
<a name="l00415"></a>00415 var $orig_lMargin;
<a name="l00416"></a>00416 var $orig_rMargin;
<a name="l00417"></a>00417 var $orig_hMargin;
<a name="l00418"></a>00418 var $orig_fMargin;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 var $pageheaders;
<a name="l00421"></a>00421 var $pagefooters;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 var $pageHTMLheaders;
<a name="l00424"></a>00424 var $pageHTMLfooters;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 var $saveHTMLHeader;
<a name="l00427"></a>00427 var $saveHTMLFooter;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 var $HTMLheaderPageLinks;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="comment">// See config_fonts.php for these next 5 values</span>
<a name="l00432"></a>00432 var $available_fonts;
<a name="l00433"></a>00433 var $available_unifonts;
<a name="l00434"></a>00434 var $sans_fonts;
<a name="l00435"></a>00435 var $serif_fonts;
<a name="l00436"></a>00436 var $mono_fonts;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438 <span class="comment">// List of ALL available CJK fonts (incl. styles) (Adobe add-ons)  hw removed</span>
<a name="l00439"></a>00439 var $available_CJK_fonts;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 var $cascadeCSS;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 var $HTMLHeader;
<a name="l00444"></a>00444 var $HTMLFooter;
<a name="l00445"></a>00445 var $HTMLHeaderE; <span class="comment">// for Even pages</span>
<a name="l00446"></a>00446 var $HTMLFooterE; <span class="comment">// for Even pages</span>
<a name="l00447"></a>00447 var $bufferoutput; 
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 var $showdefaultpagenos;  <span class="comment">// DEPRACATED -left for backward compatability</span>
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 var $chrs;
<a name="l00455"></a>00455 var $ords;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 <span class="comment">// CJK fonts</span>
<a name="l00458"></a>00458 var $Big5_widths;
<a name="l00459"></a>00459 var $GB_widths;
<a name="l00460"></a>00460 var $SJIS_widths;
<a name="l00461"></a>00461 var $UHC_widths;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="comment">// SetProtection</span>
<a name="l00464"></a>00464 var $encrypted;    <span class="comment">//whether document is protected</span>
<a name="l00465"></a>00465 var $Uvalue;             <span class="comment">//U entry in pdf document</span>
<a name="l00466"></a>00466 var $Ovalue;             <span class="comment">//O entry in pdf document</span>
<a name="l00467"></a>00467 var $Pvalue;             <span class="comment">//P entry in pdf document</span>
<a name="l00468"></a>00468 var $enc_obj_id;         <span class="comment">//encryption object id</span>
<a name="l00469"></a>00469 var $last_rc4_key;       <span class="comment">//last RC4 key encrypted (cached for optimisation)</span>
<a name="l00470"></a>00470 var $last_rc4_key_c;     <span class="comment">//last RC4 computed key</span>
<a name="l00471"></a>00471 var $encryption_key;
<a name="l00472"></a>00472 var $padding;   <span class="comment">//used for encryption</span>
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="comment">// Bookmark</span>
<a name="l00475"></a>00475 var $BMoutlines;
<a name="l00476"></a>00476 var $OutlineRoot;
<a name="l00477"></a>00477 <span class="comment">// TOC</span>
<a name="l00478"></a>00478 var $_toc;
<a name="l00479"></a>00479 var $TOCmark;
<a name="l00480"></a>00480 var $TOCfont;
<a name="l00481"></a>00481 var $TOCfontsize;
<a name="l00482"></a>00482 var $TOCindent;
<a name="l00483"></a>00483 var $TOCheader;
<a name="l00484"></a>00484 var $TOCfooter;
<a name="l00485"></a>00485 var $TOCpreHTML;
<a name="l00486"></a>00486 var $TOCpostHTML;
<a name="l00487"></a>00487 var $TOCbookmarkText;
<a name="l00488"></a>00488 var $TOCusePaging;
<a name="l00489"></a>00489 var $TOCuseLinking;
<a name="l00490"></a>00490 var $TOCorientation;
<a name="l00491"></a>00491 var $TOC_margin_left;
<a name="l00492"></a>00492 var $TOC_margin_right;
<a name="l00493"></a>00493 var $TOC_margin_top;
<a name="l00494"></a>00494 var $TOC_margin_bottom;
<a name="l00495"></a>00495 var $TOC_margin_header;
<a name="l00496"></a>00496 var $TOC_margin_footer;
<a name="l00497"></a>00497 var $TOC_odd_header_name;
<a name="l00498"></a>00498 var $TOC_even_header_name;
<a name="l00499"></a>00499 var $TOC_odd_footer_name;
<a name="l00500"></a>00500 var $TOC_even_footer_name;
<a name="l00501"></a>00501 var $TOC_odd_header_value;
<a name="l00502"></a>00502 var $TOC_even_header_value;
<a name="l00503"></a>00503 var $TOC_odd_footer_value;
<a name="l00504"></a>00504 var $TOC_even_footer_value;
<a name="l00505"></a>00505 var $TOC_start;
<a name="l00506"></a>00506 var $TOC_end;
<a name="l00507"></a>00507 var $TOC_npages;
<a name="l00508"></a>00508 var $m_TOC; 
<a name="l00509"></a>00509 <span class="comment">// INDEX</span>
<a name="l00510"></a>00510 var $ColActive;
<a name="l00511"></a>00511 var $ChangePage;    <span class="comment">//Flag indicating that a page break has occurred</span>
<a name="l00512"></a>00512 var $Reference;
<a name="l00513"></a>00513 var $CurrCol;
<a name="l00514"></a>00514 var $NbCol;
<a name="l00515"></a>00515 var $y0;      <span class="comment">//Top ordinate of columns</span>
<a name="l00516"></a>00516 var $ColL;
<a name="l00517"></a>00517 var $ColWidth;
<a name="l00518"></a>00518 var $ColGap;
<a name="l00519"></a>00519 <span class="comment">// COLUMNS </span>
<a name="l00520"></a>00520 var $ColR;
<a name="l00521"></a>00521 var $ChangeColumn;
<a name="l00522"></a>00522 var $columnbuffer;
<a name="l00523"></a>00523 var $ColDetails;
<a name="l00524"></a>00524 var $columnLinks;
<a name="l00525"></a>00525 var $colvAlign;
<a name="l00526"></a>00526 <span class="comment">// Substitutions</span>
<a name="l00527"></a>00527 var $substitute;    <span class="comment">// Array of substitution strings e.g. &lt;ttz&gt;112&lt;/ttz&gt;</span>
<a name="l00528"></a>00528 var $entsearch;   <span class="comment">// Array of HTML entities (&gt;ASCII 127) to substitute</span>
<a name="l00529"></a>00529 var $entsubstitute; <span class="comment">// Array of substitution decimal unicode for the Hi entities</span>
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 <span class="comment">// Default values if no style sheet offered (cf. http://www.w3.org/TR/CSS21/sample.html)</span>
<a name="l00533"></a>00533 var $defaultCSS;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 var $form_element_spacing;
<a name="l00536"></a>00536 var $linemaxfontsize;
<a name="l00537"></a>00537 var $lineheight_correction;
<a name="l00538"></a>00538 var $lastoptionaltag; <span class="comment">// Save current block item which HTML specifies optionsl endtag</span>
<a name="l00539"></a>00539 var $pageoutput;
<a name="l00540"></a>00540 var $charset_in;
<a name="l00541"></a>00541 var $blk;
<a name="l00542"></a>00542 var $blklvl;
<a name="l00543"></a>00543 var $ColumnAdjust;
<a name="l00544"></a>00544 var $ws;  <span class="comment">// Word spacing</span>
<a name="l00545"></a>00545 var $HREF;
<a name="l00546"></a>00546 var $pgwidth;
<a name="l00547"></a>00547 var $fontlist; 
<a name="l00548"></a>00548 var $issetfont;
<a name="l00549"></a>00549 var $issetcolor;
<a name="l00550"></a>00550 var $oldx;
<a name="l00551"></a>00551 var $oldy;
<a name="l00552"></a>00552 var $B;
<a name="l00553"></a>00553 var $U;
<a name="l00554"></a>00554 var $I;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 var $tdbegin;
<a name="l00557"></a>00557 var $table;
<a name="l00558"></a>00558 var $cell;
<a name="l00559"></a>00559 var $col;
<a name="l00560"></a>00560 var $row;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 var $divbegin;
<a name="l00563"></a>00563 var $divalign;
<a name="l00564"></a>00564 var $divwidth;
<a name="l00565"></a>00565 var $divheight;
<a name="l00566"></a>00566 var $divrevert;
<a name="l00567"></a>00567 var $spanbgcolor;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 var $spanlvl;
<a name="l00570"></a>00570 var $listlvl;
<a name="l00571"></a>00571 var $listnum;
<a name="l00572"></a>00572 var $listtype;
<a name="l00573"></a>00573 var $listoccur;
<a name="l00574"></a>00574 var $listlist;
<a name="l00575"></a>00575 var $listitem;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 var $pjustfinished;
<a name="l00578"></a>00578 var $ignorefollowingspaces;
<a name="l00579"></a>00579 var $SUP;
<a name="l00580"></a>00580 var $SUB;
<a name="l00581"></a>00581 var $SMALL;
<a name="l00582"></a>00582 var $BIG;
<a name="l00583"></a>00583 var $toupper;
<a name="l00584"></a>00584 var $tolower;
<a name="l00585"></a>00585 var $dash_on;
<a name="l00586"></a>00586 var $dotted_on;
<a name="l00587"></a>00587 var $strike;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 var $CSS;
<a name="l00590"></a>00590 var $textbuffer;
<a name="l00591"></a>00591 var $currentfontstyle;
<a name="l00592"></a>00592 var $currentfontfamily;
<a name="l00593"></a>00593 var $currentfontsize;
<a name="l00594"></a>00594 var $colorarray;
<a name="l00595"></a>00595 var $bgcolorarray;
<a name="l00596"></a>00596 var $internallink;
<a name="l00597"></a>00597 var $enabledtags;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 var $lineheight;
<a name="l00600"></a>00600 var $basepath;
<a name="l00601"></a>00601 var $outlineparam;
<a name="l00602"></a>00602 var $outline_on;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 var $specialcontent;
<a name="l00605"></a>00605 var $selectoption;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 var $usecss;
<a name="l00608"></a>00608 var $usepre;
<a name="l00609"></a>00609 var $usetableheader;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 var $tableheadernrows;
<a name="l00612"></a>00612 var $tablefooternrows;  <span class="comment">// mPDF 4.0</span>
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 var $objectbuffer;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 <span class="comment">// Table Rotation</span>
<a name="l00617"></a>00617 var $table_rotate;
<a name="l00618"></a>00618 var $tbrot_maxw;
<a name="l00619"></a>00619 var $tbrot_maxh;
<a name="l00620"></a>00620 var $tablebuffer; 
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 var $tbrot_align;
<a name="l00623"></a>00623 var $tbrot_Links;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 var $divbuffer;   <span class="comment">// Buffer used when keeping DIV on one page</span>
<a name="l00626"></a>00626 var $keep_block_together; <span class="comment">// Keep a Block from page-break-inside: avoid</span>
<a name="l00627"></a>00627 var $ktLinks;   <span class="comment">// Keep-together Block links array</span>
<a name="l00628"></a>00628 var $ktBlock;   <span class="comment">// Keep-together Block array</span>
<a name="l00629"></a>00629 var $ktReference;
<a name="l00630"></a>00630 var $ktBMoutlines;
<a name="l00631"></a>00631 var $_kttoc;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 var $tbrot_y0;
<a name="l00634"></a>00634 var $tbrot_x0;
<a name="l00635"></a>00635 var $tbrot_w;
<a name="l00636"></a>00636 var $tbrot_h;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 var $is_MB;   <span class="comment">// renamed from isunicode</span>
<a name="l00639"></a>00639 var $codepage;
<a name="l00640"></a>00640 var $isCJK;
<a name="l00641"></a>00641 var $mb_enc;
<a name="l00642"></a>00642 var $directionality;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 var $extgstates; <span class="comment">// Used for alpha channel - Transparency (Watermark)</span>
<a name="l00645"></a>00645 var $tt_savefont;
<a name="l00646"></a>00646 var $mgl;
<a name="l00647"></a>00647 var $mgt;
<a name="l00648"></a>00648 var $mgr;
<a name="l00649"></a>00649 var $mgb;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 var $tts;
<a name="l00652"></a>00652 var $ttz;
<a name="l00653"></a>00653 var $tta;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 var $headerDetails;
<a name="l00656"></a>00656 var $footerDetails;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="comment">// Best to alter the below variables using default stylesheet above</span>
<a name="l00659"></a>00659 var $div_margin_bottom; 
<a name="l00660"></a>00660 var $div_bottom_border;
<a name="l00661"></a>00661 var $p_margin_bottom;
<a name="l00662"></a>00662 var $p_bottom_border;
<a name="l00663"></a>00663 var $page_break_after_avoid;
<a name="l00664"></a>00664 var $margin_bottom_collapse;
<a name="l00665"></a>00665 var $img_margin_top;  <span class="comment">// default is set at top of fn.openTag &#39;IMG&#39;</span>
<a name="l00666"></a>00666 var $img_margin_bottom;
<a name="l00667"></a>00667 var $list_indent;
<a name="l00668"></a>00668 var $list_align;
<a name="l00669"></a>00669 var $list_margin_bottom; 
<a name="l00670"></a>00670 var $default_font_size; <span class="comment">// in pts</span>
<a name="l00671"></a>00671 var $original_default_font_size;  <span class="comment">// used to save default sizes when using table default</span>
<a name="l00672"></a>00672 var $original_default_font;
<a name="l00673"></a>00673 var $watermark_font;
<a name="l00674"></a>00674 var $defaultAlign;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="comment">// TABLE</span>
<a name="l00677"></a>00677 var $defaultTableAlign;
<a name="l00678"></a>00678 var $tablethead;
<a name="l00679"></a>00679 var $thead_font_weight;
<a name="l00680"></a>00680 var $thead_font_style;
<a name="l00681"></a>00681 var $thead_valign_default;
<a name="l00682"></a>00682 var $thead_textalign_default; 
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 var $tabletfoot;
<a name="l00685"></a>00685 var $tfoot_font_weight;
<a name="l00686"></a>00686 var $tfoot_font_style;
<a name="l00687"></a>00687 var $tfoot_valign_default;
<a name="l00688"></a>00688 var $tfoot_textalign_default;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 var $trow_text_rotate;
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 var $cellPaddingL;
<a name="l00693"></a>00693 var $cellPaddingR;
<a name="l00694"></a>00694 var $cellPaddingT;
<a name="l00695"></a>00695 var $cellPaddingB;
<a name="l00696"></a>00696 var $table_lineheight;
<a name="l00697"></a>00697 var $table_border_attr_set;
<a name="l00698"></a>00698 var $table_border_css_set;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 var $shrin_k;     <span class="comment">// factor with which to shrink tables - used internally - do not change</span>
<a name="l00701"></a>00701 var $shrink_this_table_to_fit;  <span class="comment">// 0 or false to disable; value (if set) gives maximum factor to reduce fontsize</span>
<a name="l00702"></a>00702 var $MarginCorrection;  <span class="comment">// corrects for OddEven Margins</span>
<a name="l00703"></a>00703 var $margin_footer;
<a name="l00704"></a>00704 var $margin_header;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 var $tabletheadjustfinished;
<a name="l00707"></a>00707 var $usingCoreFont;
<a name="l00708"></a>00708 var $charspacing;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 <span class="comment">//Private properties FROM FPDF</span>
<a name="l00711"></a>00711 var $DisplayPreferences; 
<a name="l00712"></a>00712 var $outlines;
<a name="l00713"></a>00713 var $flowingBlockAttr;
<a name="l00714"></a>00714 var $page;               <span class="comment">//current page number</span>
<a name="l00715"></a>00715 var $n;                  <span class="comment">//current object number</span>
<a name="l00716"></a>00716 var $offsets;            <span class="comment">//array of object offsets</span>
<a name="l00717"></a>00717 var $buffer;             <span class="comment">//buffer holding in-memory PDF</span>
<a name="l00718"></a>00718 var $pages;              <span class="comment">//array containing pages</span>
<a name="l00719"></a>00719 var $state;              <span class="comment">//current document state</span>
<a name="l00720"></a>00720 var $compress;           <span class="comment">//compression flag</span>
<a name="l00721"></a>00721 var $DefOrientation;     <span class="comment">//default orientation</span>
<a name="l00722"></a>00722 var $CurOrientation;     <span class="comment">//current orientation</span>
<a name="l00723"></a>00723 var $OrientationChanges; <span class="comment">//array indicating orientation changes</span>
<a name="l00724"></a>00724 var $k;                  <span class="comment">//scale factor (number of points in user unit)</span>
<a name="l00725"></a>00725 var $fwPt;
<a name="l00726"></a>00726 var $fhPt;         <span class="comment">//dimensions of page format in points</span>
<a name="l00727"></a>00727 var $fw;
<a name="l00728"></a>00728 var $fh;             <span class="comment">//dimensions of page format in user unit</span>
<a name="l00729"></a>00729 var $wPt;
<a name="l00730"></a>00730 var $hPt;           <span class="comment">//current dimensions of page in points</span>
<a name="l00731"></a>00731 var $w;
<a name="l00732"></a>00732 var $h;               <span class="comment">//current dimensions of page in user unit</span>
<a name="l00733"></a>00733 var $lMargin;            <span class="comment">//left margin</span>
<a name="l00734"></a>00734 var $tMargin;            <span class="comment">//top margin</span>
<a name="l00735"></a>00735 var $rMargin;            <span class="comment">//right margin</span>
<a name="l00736"></a>00736 var $bMargin;            <span class="comment">//page break margin</span>
<a name="l00737"></a>00737 var $cMarginL;            <span class="comment">//cell margin Left</span>
<a name="l00738"></a>00738 var $cMarginR;            <span class="comment">//cell margin Right</span>
<a name="l00739"></a>00739 var $cMarginT;            <span class="comment">//cell margin Left</span>
<a name="l00740"></a>00740 var $cMarginB;            <span class="comment">//cell margin Right</span>
<a name="l00741"></a>00741 var $DeflMargin;            <span class="comment">//Default left margin</span>
<a name="l00742"></a>00742 var $DefrMargin;            <span class="comment">//Default right margin</span>
<a name="l00743"></a>00743 var $x;
<a name="l00744"></a>00744 var $y;               <span class="comment">//current position in user unit for cell positioning</span>
<a name="l00745"></a>00745 var $lasth;              <span class="comment">//height of last cell printed</span>
<a name="l00746"></a>00746 var $LineWidth;          <span class="comment">//line width in user unit</span>
<a name="l00747"></a>00747 var $CoreFonts;          <span class="comment">//array of standard font names</span>
<a name="l00748"></a>00748 var $fonts;              <span class="comment">//array of used fonts</span>
<a name="l00749"></a>00749 var $FontFiles;          <span class="comment">//array of font files</span>
<a name="l00750"></a>00750 var $diffs;              <span class="comment">//array of encoding differences</span>
<a name="l00751"></a>00751 var $images;             <span class="comment">//array of used images</span>
<a name="l00752"></a>00752 var $PageLinks;          <span class="comment">//array of links in pages</span>
<a name="l00753"></a>00753 var $links;              <span class="comment">//array of internal links</span>
<a name="l00754"></a>00754 var $FontFamily;         <span class="comment">//current font family</span>
<a name="l00755"></a>00755 var $FontStyle;          <span class="comment">//current font style</span>
<a name="l00756"></a>00756 var $underline;          <span class="comment">//underlining flag</span>
<a name="l00757"></a>00757 var $CurrentFont;        <span class="comment">//current font info</span>
<a name="l00758"></a>00758 var $FontSizePt;         <span class="comment">//current font size in points</span>
<a name="l00759"></a>00759 var $FontSize;           <span class="comment">//current font size in user unit</span>
<a name="l00760"></a>00760 var $DrawColor;          <span class="comment">//commands for drawing color</span>
<a name="l00761"></a>00761 var $FillColor;          <span class="comment">//commands for filling color</span>
<a name="l00762"></a>00762 var $TextColor;          <span class="comment">//commands for text color</span>
<a name="l00763"></a>00763 var $ColorFlag;          <span class="comment">//indicates whether fill and text colors are different</span>
<a name="l00764"></a>00764 var $autoPageBreak;      <span class="comment">//automatic page breaking</span>
<a name="l00765"></a>00765 var $PageBreakTrigger;   <span class="comment">//threshold used to trigger page breaks</span>
<a name="l00766"></a>00766 var $InFooter;           <span class="comment">//flag set when processing footer</span>
<a name="l00767"></a>00767 var $InHTMLFooter;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 var $processingFooter;   <span class="comment">//flag set when processing footer - added for columns</span>
<a name="l00770"></a>00770 var $processingHeader;   <span class="comment">//flag set when processing header - added for columns</span>
<a name="l00771"></a>00771 var $ZoomMode;           <span class="comment">//zoom display mode</span>
<a name="l00772"></a>00772 var $LayoutMode;         <span class="comment">//layout display mode</span>
<a name="l00773"></a>00773 var $title;              <span class="comment">//title</span>
<a name="l00774"></a>00774 var $subject;            <span class="comment">//subject</span>
<a name="l00775"></a>00775 var $author;             <span class="comment">//author</span>
<a name="l00776"></a>00776 var $keywords;           <span class="comment">//keywords</span>
<a name="l00777"></a>00777 var $creator;            <span class="comment">//creator</span>
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 var $aliasNbPg;       <span class="comment">//alias for total number of pages</span>
<a name="l00780"></a>00780 var $aliasNbPgGp;       <span class="comment">//alias for total number of pages in page group</span>
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 var $ispre;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 var $outerblocktags;
<a name="l00785"></a>00785 var $innerblocktags;
<a name="l00786"></a>00786 <span class="comment">// NOT Currently used</span>
<a name="l00787"></a>00787 var $inlinetags;
<a name="l00788"></a>00788 var $listtags;
<a name="l00789"></a>00789 var $tabletags;
<a name="l00790"></a>00790 var $formtags;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 <span class="comment">// **********************************</span>
<a name="l00794"></a>00794 <span class="comment">// **********************************</span>
<a name="l00795"></a>00795 <span class="comment">// **********************************</span>
<a name="l00796"></a>00796 <span class="comment">// **********************************</span>
<a name="l00797"></a>00797 <span class="comment">// **********************************</span>
<a name="l00798"></a>00798 <span class="comment">// **********************************</span>
<a name="l00799"></a>00799 <span class="comment">// **********************************</span>
<a name="l00800"></a>00800 <span class="comment">// **********************************</span>
<a name="l00801"></a>00801 <span class="comment">// **********************************</span>
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 function <a class="code" href="classmPDF.html">mPDF</a>($codepage=<span class="stringliteral">&#39;win-1252&#39;</span>,$format=<span class="stringliteral">&#39;A4&#39;</span>,$default_font_size=0,$default_font=<span class="stringliteral">&#39;&#39;</span>,$mgl=15,$mgr=15,$mgt=16,$mgb=16,$mgh=9,$mgf=9, $orientation=<span class="charliteral">&#39;P&#39;</span>) {
<a name="l00804"></a>00804 
<a name="l00805"></a>00805   <span class="comment">// mPDF 4.0</span>
<a name="l00806"></a>00806   $this-&gt;time0 = microtime(<span class="keyword">true</span>);
<a name="l00807"></a>00807   $unit=<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l00808"></a>00808   <span class="keywordflow">if</span> (strlen($codepage)==0) { $codepage=<span class="stringliteral">&#39;win-1252&#39;</span>; }
<a name="l00809"></a>00809   <span class="comment">//Some checks</span>
<a name="l00810"></a>00810   $this-&gt;_dochecks();
<a name="l00811"></a>00811 
<a name="l00812"></a>00812   <span class="comment">// Set up Aliases for backwards compatability</span>
<a name="l00813"></a>00813   $this-&gt;UnvalidatedText =&amp; $this-&gt;watermarkText;
<a name="l00814"></a>00814   $this-&gt;TopicIsUnvalidated =&amp; $this-&gt;showWatermarkText;
<a name="l00815"></a>00815   $this-&gt;AliasNbPg =&amp; $this-&gt;aliasNbPg;
<a name="l00816"></a>00816   $this-&gt;AliasNbPgGp =&amp; $this-&gt;aliasNbPgGp;
<a name="l00817"></a>00817   $this-&gt;BiDirectional =&amp; $this-&gt;biDirectional;
<a name="l00818"></a>00818   $this-&gt;Anchor2Bookmark =&amp; $this-&gt;anchor2Bookmark;
<a name="l00819"></a>00819   $this-&gt;KeepColumns =&amp; $this-&gt;keepColumns;
<a name="l00820"></a>00820   $this-&gt;use_embeddedfonts_1252 =&amp; $this-&gt;useOnlyCoreFonts;
<a name="l00821"></a>00821   $this-&gt;useOddEven =&amp; $this-&gt;mirrorMargins;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 
<a name="l00824"></a>00824   <span class="comment">//Initialization of properties</span>
<a name="l00825"></a>00825   $this-&gt;page=0;
<a name="l00826"></a>00826   $this-&gt;n=2;
<a name="l00827"></a>00827   $this-&gt;buffer=<span class="stringliteral">&#39;&#39;</span>;
<a name="l00828"></a>00828   $this-&gt;objectbuffer = array();
<a name="l00829"></a>00829   $this-&gt;pages=array();
<a name="l00830"></a>00830   $this-&gt;OrientationChanges=array();
<a name="l00831"></a>00831   $this-&gt;state=0;
<a name="l00832"></a>00832   $this-&gt;fonts=array();
<a name="l00833"></a>00833   $this-&gt;FontFiles=array();
<a name="l00834"></a>00834   $this-&gt;diffs=array();
<a name="l00835"></a>00835   $this-&gt;images=array();
<a name="l00836"></a>00836   $this-&gt;links=array();
<a name="l00837"></a>00837   $this-&gt;InFooter=<span class="keyword">false</span>;
<a name="l00838"></a>00838   $this-&gt;processingFooter=<span class="keyword">false</span>;
<a name="l00839"></a>00839   $this-&gt;processingHeader=<span class="keyword">false</span>;
<a name="l00840"></a>00840   $this-&gt;lasth=0;
<a name="l00841"></a>00841   $this-&gt;FontFamily=<span class="stringliteral">&#39;&#39;</span>;
<a name="l00842"></a>00842   $this-&gt;FontStyle=<span class="stringliteral">&#39;&#39;</span>;
<a name="l00843"></a>00843   $this-&gt;FontSizePt=9;
<a name="l00844"></a>00844   $this-&gt;underline=<span class="keyword">false</span>;
<a name="l00845"></a>00845   $this-&gt;DrawColor=<span class="stringliteral">&#39;0 G&#39;</span>;
<a name="l00846"></a>00846   $this-&gt;FillColor=<span class="stringliteral">&#39;0 g&#39;</span>;
<a name="l00847"></a>00847   $this-&gt;TextColor=<span class="stringliteral">&#39;0 g&#39;</span>;
<a name="l00848"></a>00848   $this-&gt;ColorFlag=<span class="keyword">false</span>;
<a name="l00849"></a>00849   $this-&gt;extgstates = array();
<a name="l00850"></a>00850 
<a name="l00851"></a>00851   $this-&gt;is_MB=<span class="keyword">false</span>;   <span class="comment">// renamed from isunicode</span>
<a name="l00852"></a>00852   $this-&gt;isCJK = <span class="keyword">false</span>;
<a name="l00853"></a>00853   $this-&gt;mb_enc=<span class="stringliteral">&#39;windows-1252&#39;</span>;
<a name="l00854"></a>00854   $this-&gt;directionality=<span class="stringliteral">&#39;ltr&#39;</span>;
<a name="l00855"></a>00855   $this-&gt;defaultAlign = <span class="charliteral">&#39;L&#39;</span>;
<a name="l00856"></a>00856   $this-&gt;defaultTableAlign = <span class="charliteral">&#39;L&#39;</span>;
<a name="l00857"></a>00857 
<a name="l00858"></a>00858   <span class="comment">// mPDF 4.0</span>
<a name="l00859"></a>00859   $this-&gt;fixedPosBlockSave = array();
<a name="l00860"></a>00860   $this-&gt;useSubsets = <span class="keyword">false</span>;
<a name="l00861"></a>00861   $this-&gt;extraFontSubsets = 0;
<a name="l00862"></a>00862   $this-&gt;loaded = array();
<a name="l00863"></a>00863 
<a name="l00864"></a>00864   $this-&gt;SHYpatterns = array();
<a name="l00865"></a>00865   $this-&gt;loadedSHYdictionary = <span class="keyword">false</span>;
<a name="l00866"></a>00866   $this-&gt;SHYdictionary = array();
<a name="l00867"></a>00867   $this-&gt;SHYdictionaryWords = array();
<a name="l00868"></a>00868   $this-&gt;blockContext = 1;
<a name="l00869"></a>00869   $this-&gt;floatDivs = array();
<a name="l00870"></a>00870   $this-&gt;DisplayPreferences=<span class="stringliteral">&#39;&#39;</span>; 
<a name="l00871"></a>00871 
<a name="l00872"></a>00872   $this-&gt;tablecascadeCSS = array();
<a name="l00873"></a>00873   $this-&gt;listcascadeCSS = array();
<a name="l00874"></a>00874 
<a name="l00875"></a>00875   $this-&gt;patterns = array();    <span class="comment">// Tiling patterns used for backgrounds</span>
<a name="l00876"></a>00876   $this-&gt;pageBackgrounds = array();
<a name="l00877"></a>00877   $this-&gt;writingHTMLheader = <span class="keyword">false</span>; <span class="comment">// internal flag - used both for writing HTMLHeaders/Footers and FixedPos block</span>
<a name="l00878"></a>00878   $this-&gt;writingHTMLfooter = <span class="keyword">false</span>; <span class="comment">// internal flag - used both for writing HTMLHeaders/Footers and FixedPos block</span>
<a name="l00879"></a>00879   $this-&gt;gradients = array();
<a name="l00880"></a>00880 
<a name="l00881"></a>00881   $this-&gt;kwt_Reference = array();
<a name="l00882"></a>00882   $this-&gt;kwt_BMoutlines = array();
<a name="l00883"></a>00883   $this-&gt;kwt_toc = array();
<a name="l00884"></a>00884 
<a name="l00885"></a>00885   $this-&gt;tbrot_Reference = array();
<a name="l00886"></a>00886   $this-&gt;tbrot_BMoutlines = array();
<a name="l00887"></a>00887   $this-&gt;tbrot_toc = array();
<a name="l00888"></a>00888 
<a name="l00889"></a>00889   $this-&gt;col_Reference = array();
<a name="l00890"></a>00890   $this-&gt;col_BMoutlines = array();
<a name="l00891"></a>00891   $this-&gt;col_toc = array();
<a name="l00892"></a>00892   $this-&gt;graphs = array();
<a name="l00893"></a>00893 
<a name="l00894"></a>00894   $this-&gt;pgsIns = array();    <span class="comment">// mPDF 4.2.020</span>
<a name="l00895"></a>00895   $this-&gt;PDFAwarnings = array();  <span class="comment">// mPDF 4.2.018</span>
<a name="l00896"></a>00896 
<a name="l00897"></a>00897   <span class="comment">// mPDF 4.2</span>
<a name="l00898"></a>00898   $this-&gt;baselineC = 0.35;  <span class="comment">// Baseline for text</span>
<a name="l00899"></a>00899   $this-&gt;noImageFile = str_replace(<span class="stringliteral">&quot;\\&quot;</span>,<span class="stringliteral">&quot;/&quot;</span>,dirname(__FILE__)) . <span class="stringliteral">&#39;/includes/no_image.jpg&#39;</span>;
<a name="l00900"></a>00900   $this-&gt;subPos = 0;
<a name="l00901"></a>00901   $this-&gt;forceExactLineheight = <span class="keyword">false</span>;
<a name="l00902"></a>00902   $this-&gt;listOcc = 0;
<a name="l00903"></a>00903   $this-&gt;normalLineheight = 1.3;
<a name="l00904"></a>00904   <span class="comment">// These are intended as configuration variables, and should be set in config.php - which will override these values; </span>
<a name="l00905"></a>00905   <span class="comment">// set here as failsafe as will cause an error if not defined</span>
<a name="l00906"></a>00906   $this-&gt;incrementFPR1 = 10;
<a name="l00907"></a>00907   $this-&gt;incrementFPR2 = 10;
<a name="l00908"></a>00908   $this-&gt;incrementFPR3 = 10;
<a name="l00909"></a>00909   $this-&gt;incrementFPR4 = 10;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911   <span class="comment">// mPDF 4.1</span>
<a name="l00912"></a>00912   $this-&gt;fullImageHeight = <span class="keyword">false</span>;
<a name="l00913"></a>00913   $this-&gt;floatbuffer = array();
<a name="l00914"></a>00914   $this-&gt;floatmargins = array();
<a name="l00915"></a>00915   $this-&gt;autoFontGroups = 0;
<a name="l00916"></a>00916   $this-&gt;formobjects=array(); <span class="comment">// array of Form Objects for WMF</span>
<a name="l00917"></a>00917   $this-&gt;InlineProperties=array();
<a name="l00918"></a>00918   $this-&gt;InlineAnnots=array();
<a name="l00919"></a>00919   $this-&gt;ktAnnots=array();
<a name="l00920"></a>00920   $this-&gt;tbrot_Annots=array();
<a name="l00921"></a>00921   $this-&gt;kwt_Annots=array();
<a name="l00922"></a>00922   $this-&gt;columnAnnots=array();
<a name="l00923"></a>00923   $this-&gt;pageDim=array(); 
<a name="l00924"></a>00924   $this-&gt;breakpoints = array(); <span class="comment">// used in columnbuffer</span>
<a name="l00925"></a>00925   $this-&gt;tableLevel=0;
<a name="l00926"></a>00926   $this-&gt;tbctr=array(); <span class="comment">// counter for nested tables at each level</span>
<a name="l00927"></a>00927   $this-&gt;page_box = array();
<a name="l00928"></a>00928   $this-&gt;show_marks = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// crop or cross marks</span>
<a name="l00929"></a>00929   $this-&gt;kwt = <span class="keyword">false</span>;
<a name="l00930"></a>00930   $this-&gt;kwt_height = 0;
<a name="l00931"></a>00931   $this-&gt;kwt_y0 = 0;
<a name="l00932"></a>00932   $this-&gt;kwt_x0 = 0;
<a name="l00933"></a>00933   $this-&gt;kwt_buffer = array();
<a name="l00934"></a>00934   $this-&gt;kwt_Links = array();
<a name="l00935"></a>00935   $this-&gt;kwt_moved = <span class="keyword">false</span>;
<a name="l00936"></a>00936   $this-&gt;kwt_saved = <span class="keyword">false</span>;
<a name="l00937"></a>00937   $this-&gt;PageNumSubstitutions = array();
<a name="l00938"></a>00938   $this-&gt;base_table_properties=array();
<a name="l00939"></a>00939   $this-&gt;borderstyles = array(<span class="stringliteral">&#39;inset&#39;</span>,<span class="stringliteral">&#39;groove&#39;</span>,<span class="stringliteral">&#39;outset&#39;</span>,<span class="stringliteral">&#39;ridge&#39;</span>,<span class="stringliteral">&#39;dotted&#39;</span>,<span class="stringliteral">&#39;dashed&#39;</span>,<span class="stringliteral">&#39;solid&#39;</span>,<span class="stringliteral">&#39;double&#39;</span>);
<a name="l00940"></a>00940   $this-&gt;tbrot_align = <span class="charliteral">&#39;C&#39;</span>;
<a name="l00941"></a>00941   $this-&gt;pageheaders=array();
<a name="l00942"></a>00942   $this-&gt;pagefooters=array();
<a name="l00943"></a>00943 
<a name="l00944"></a>00944   $this-&gt;pageHTMLheaders=array();
<a name="l00945"></a>00945   $this-&gt;pageHTMLfooters=array();
<a name="l00946"></a>00946   $this-&gt;HTMLheaderPageLinks = array();
<a name="l00947"></a>00947   $this-&gt;cascadeCSS = array();
<a name="l00948"></a>00948   $this-&gt;bufferoutput = <span class="keyword">false</span>; 
<a name="l00949"></a>00949   $this-&gt;encrypted=<span class="keyword">false</span>;       <span class="comment">//whether document is protected</span>
<a name="l00950"></a>00950   $this-&gt;BMoutlines=array();
<a name="l00951"></a>00951   $this-&gt;_toc=array();
<a name="l00952"></a>00952   $this-&gt;TOCheader=<span class="keyword">false</span>;
<a name="l00953"></a>00953   $this-&gt;TOCfooter=<span class="keyword">false</span>;
<a name="l00954"></a>00954   $this-&gt;ColActive=0;           <span class="comment">//Flag indicating that columns are on (the index is being processed)</span>
<a name="l00955"></a>00955   $this-&gt;ChangePage=0;          <span class="comment">//Flag indicating that a page break has occurred</span>
<a name="l00956"></a>00956   $this-&gt;<a class="code" href="classReference.html">Reference</a>=array();     <span class="comment">//Array containing the references</span>
<a name="l00957"></a>00957   $this-&gt;CurrCol=0;               <span class="comment">//Current column number</span>
<a name="l00958"></a>00958   $this-&gt;ColL = array(0);     <span class="comment">// Array of Left pos of columns - absolute - needs Margin correction for Odd-Even</span>
<a name="l00959"></a>00959   $this-&gt;ColR = array(0);     <span class="comment">// Array of Right pos of columns - absolute pos - needs Margin correction for Odd-Even</span>
<a name="l00960"></a>00960   $this-&gt;ChangeColumn = 0;
<a name="l00961"></a>00961   $this-&gt;columnbuffer = array();
<a name="l00962"></a>00962   $this-&gt;ColDetails = array();    <span class="comment">// Keeps track of some column details</span>
<a name="l00963"></a>00963   $this-&gt;columnLinks = array();   <span class="comment">// Cross references PageLinks</span>
<a name="l00964"></a>00964   $this-&gt;substitute = array();    <span class="comment">// Array of substitution strings e.g. &lt;ttz&gt;112&lt;/ttz&gt;</span>
<a name="l00965"></a>00965   $this-&gt;entsearch = array();   <span class="comment">// Array of HTML entities (&gt;ASCII 127) to substitute</span>
<a name="l00966"></a>00966   $this-&gt;entsubstitute = array(); <span class="comment">// Array of substitution decimal unicode for the Hi entities</span>
<a name="l00967"></a>00967   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00968"></a>00968   $this-&gt;charset_in = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00969"></a>00969   $this-&gt;blk = array();
<a name="l00970"></a>00970   $this-&gt;blklvl = 0;
<a name="l00971"></a>00971   $this-&gt;TOCmark = 0;
<a name="l00972"></a>00972   $this-&gt;tts = <span class="keyword">false</span>;
<a name="l00973"></a>00973   $this-&gt;ttz = <span class="keyword">false</span>;
<a name="l00974"></a>00974   $this-&gt;tta = <span class="keyword">false</span>;
<a name="l00975"></a>00975   $this-&gt;ispre=<span class="keyword">false</span>;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   $this-&gt;headerDetails=array();
<a name="l00978"></a>00978   $this-&gt;footerDetails=array();
<a name="l00979"></a>00979   $this-&gt;div_bottom_border = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00980"></a>00980   $this-&gt;p_bottom_border = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00981"></a>00981   $this-&gt;page_break_after_avoid = <span class="keyword">false</span>;
<a name="l00982"></a>00982   $this-&gt;margin_bottom_collapse = <span class="keyword">false</span>;
<a name="l00983"></a>00983   $this-&gt;tablethead = 0;
<a name="l00984"></a>00984   $this-&gt;tabletfoot = 0;
<a name="l00985"></a>00985   $this-&gt;table_border_attr_set = 0;
<a name="l00986"></a>00986   $this-&gt;table_border_css_set = 0;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988   $this-&gt;shrin_k = 1.0;
<a name="l00989"></a>00989   $this-&gt;shrink_this_table_to_fit = 0;
<a name="l00990"></a>00990   $this-&gt;MarginCorrection = 0;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992   $this-&gt;tabletheadjustfinished = <span class="keyword">false</span>;
<a name="l00993"></a>00993   $this-&gt;usingCoreFont = <span class="keyword">false</span>;
<a name="l00994"></a>00994   $this-&gt;charspacing=0;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   $this-&gt;outlines=array();
<a name="l00997"></a>00997   $this-&gt;autoPageBreak = <span class="keyword">true</span>;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999 
<a name="l01000"></a>01000   require(_MPDF_PATH.<span class="stringliteral">&#39;config.php&#39;</span>); <span class="comment">// config data</span>
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="comment">//Scale factor</span>
<a name="l01003"></a>01003   $this-&gt;k=72/25.4; <span class="comment">// Will only use mm</span>
<a name="l01004"></a>01004 
<a name="l01005"></a>01005   $this-&gt;_setPageSize($format, $orientation); <span class="comment">// mPDF 4.2.024</span>
<a name="l01006"></a>01006   $this-&gt;DefOrientation=$orientation;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008   $this-&gt;margin_header=$mgh;
<a name="l01009"></a>01009   $this-&gt;margin_footer=$mgf;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011   $bmargin=$mgb;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013   $this-&gt;DeflMargin = $mgl;
<a name="l01014"></a>01014   $this-&gt;DefrMargin = $mgr;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016   <span class="comment">// v1.4 Save orginal settings in case of changed orientation</span>
<a name="l01017"></a>01017   $this-&gt;orig_tMargin = $mgt;
<a name="l01018"></a>01018   $this-&gt;orig_bMargin = $bmargin;
<a name="l01019"></a>01019   $this-&gt;orig_lMargin = $this-&gt;DeflMargin;
<a name="l01020"></a>01020   $this-&gt;orig_rMargin = $this-&gt;DefrMargin;
<a name="l01021"></a>01021   $this-&gt;orig_hMargin = $this-&gt;margin_header;
<a name="l01022"></a>01022   $this-&gt;orig_fMargin = $this-&gt;margin_footer;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024   <span class="comment">// mPDF 4.0</span>
<a name="l01025"></a>01025   <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin==<span class="stringliteral">&#39;pad&#39;</span>) { $mgt += $this-&gt;margin_header; }
<a name="l01026"></a>01026   <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin==<span class="stringliteral">&#39;pad&#39;</span>) { $mgb += $this-&gt;margin_footer; }
<a name="l01027"></a>01027   $this-&gt;SetMargins($this-&gt;DeflMargin,$this-&gt;DefrMargin,$mgt);  <span class="comment">// sets l r t margin</span>
<a name="l01028"></a>01028   <span class="comment">//Automatic page break</span>
<a name="l01029"></a>01029   $this-&gt;SetAutoPageBreak($this-&gt;autoPageBreak,$bmargin); <span class="comment">// sets $this-&gt;bMargin &amp; PageBreakTrigger</span>
<a name="l01030"></a>01030 
<a name="l01031"></a>01031   $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033   <span class="comment">//Interior cell margin (1 mm) ? not used</span>
<a name="l01034"></a>01034   $this-&gt;cMarginL = 1;
<a name="l01035"></a>01035   $this-&gt;cMarginR = 1;
<a name="l01036"></a>01036   <span class="comment">//Line width (0.2 mm)</span>
<a name="l01037"></a>01037   $this-&gt;LineWidth=.567/$this-&gt;k;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039   <span class="comment">//To make the function Footer() work - replaces {nb} with page number</span>
<a name="l01040"></a>01040   $this-&gt;AliasNbPages();
<a name="l01041"></a>01041   $this-&gt;AliasNbPageGroups();
<a name="l01042"></a>01042 
<a name="l01043"></a>01043 
<a name="l01044"></a>01044   <span class="comment">//Enable all tags as default</span>
<a name="l01045"></a>01045   $this-&gt;DisableTags();
<a name="l01046"></a>01046   <span class="comment">//Full width display mode</span>
<a name="l01047"></a>01047   $this-&gt;SetDisplayMode(100); <span class="comment">// fullwidth?   &#39;fullpage&#39;</span>
<a name="l01048"></a>01048   <span class="comment">//Compression</span>
<a name="l01049"></a>01049   $this-&gt;SetCompression(<span class="keyword">true</span>);
<a name="l01050"></a>01050   <span class="comment">//Set default display preferences</span>
<a name="l01051"></a>01051   $this-&gt;SetDisplayPreferences(<span class="stringliteral">&#39;&#39;</span>); <span class="comment">// mPDF 3.0</span>
<a name="l01052"></a>01052 
<a name="l01053"></a>01053   <span class="comment">// mPDF 4.0</span>
<a name="l01054"></a>01054   <span class="keywordflow">if</span> (substr($codepage,-2)==<span class="stringliteral">&#39;-s&#39;</span>) {
<a name="l01055"></a>01055     $codepage = substr($codepage,0,(strlen($codepage)-2));
<a name="l01056"></a>01056     $useSubsets = <span class="keyword">true</span>;
<a name="l01057"></a>01057   }
<a name="l01058"></a>01058   require(_MPDF_PATH.<span class="stringliteral">&#39;config_fonts.php&#39;</span>); <span class="comment">// font data</span>
<a name="l01059"></a>01059 
<a name="l01060"></a>01060   <span class="comment">//Standard fonts</span>
<a name="l01061"></a>01061   $this-&gt;CoreFonts=array(<span class="stringliteral">&#39;courier&#39;</span>=&gt;<span class="stringliteral">&#39;Courier&#39;</span>,<span class="stringliteral">&#39;courierB&#39;</span>=&gt;<span class="stringliteral">&#39;Courier-Bold&#39;</span>,<span class="stringliteral">&#39;courierI&#39;</span>=&gt;<span class="stringliteral">&#39;Courier-Oblique&#39;</span>,<span class="stringliteral">&#39;courierBI&#39;</span>=&gt;<span class="stringliteral">&#39;Courier-BoldOblique&#39;</span>,
<a name="l01062"></a>01062     <span class="stringliteral">&#39;helvetica&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica&#39;</span>,<span class="stringliteral">&#39;helveticaB&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica-Bold&#39;</span>,<span class="stringliteral">&#39;helveticaI&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica-Oblique&#39;</span>,<span class="stringliteral">&#39;helveticaBI&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica-BoldOblique&#39;</span>,
<a name="l01063"></a>01063     <span class="stringliteral">&#39;times&#39;</span>=&gt;<span class="stringliteral">&#39;Times-Roman&#39;</span>,<span class="stringliteral">&#39;timesB&#39;</span>=&gt;<span class="stringliteral">&#39;Times-Bold&#39;</span>,<span class="stringliteral">&#39;timesI&#39;</span>=&gt;<span class="stringliteral">&#39;Times-Italic&#39;</span>,<span class="stringliteral">&#39;timesBI&#39;</span>=&gt;<span class="stringliteral">&#39;Times-BoldItalic&#39;</span>,
<a name="l01064"></a>01064     <span class="stringliteral">&#39;symbol&#39;</span>=&gt;<span class="stringliteral">&#39;Symbol&#39;</span>,<span class="stringliteral">&#39;zapfdingbats&#39;</span>=&gt;<span class="stringliteral">&#39;ZapfDingbats&#39;</span>);
<a name="l01065"></a>01065   $this-&gt;fontlist=array(<span class="stringliteral">&quot;times&quot;</span>,<span class="stringliteral">&quot;courier&quot;</span>,<span class="stringliteral">&quot;helvetica&quot;</span>,<span class="stringliteral">&quot;symbol&quot;</span>,<span class="stringliteral">&quot;zapfdingbats&quot;</span>);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067   <span class="keywordflow">switch</span>(strtolower($codepage)){
<a name="l01068"></a>01068   <span class="keywordflow">case</span> <span class="stringliteral">&#39;utf-8&#39;</span>: $codepage=<span class="stringliteral">&#39;UTF-8&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01069"></a>01069   <span class="keywordflow">case</span> <span class="stringliteral">&#39;big5&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;big-5&#39;</span>: $codepage=<span class="stringliteral">&#39;BIG5&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01070"></a>01070   <span class="keywordflow">case</span> <span class="stringliteral">&#39;gbk&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;cp936&#39;</span>: $codepage=<span class="stringliteral">&#39;GBK&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01071"></a>01071   <span class="keywordflow">case</span> <span class="stringliteral">&#39;uhc&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;cp949&#39;</span>: $codepage=<span class="stringliteral">&#39;UHC&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01072"></a>01072   <span class="keywordflow">case</span> <span class="stringliteral">&#39;shift_jis&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;shift-jis&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;sjis&#39;</span>: $codepage=<span class="stringliteral">&#39;SHIFT_JIS&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01073"></a>01073   <span class="keywordflow">case</span> <span class="stringliteral">&#39;win-1251&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;windows-1251&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;cp1251&#39;</span>: $codepage=<span class="stringliteral">&#39;win-1251&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01074"></a>01074   <span class="keywordflow">case</span> <span class="stringliteral">&#39;win-1252&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;windows-1252&#39;</span>: <span class="keywordflow">case</span> <span class="stringliteral">&#39;cp1252&#39;</span>: $codepage=<span class="stringliteral">&#39;win-1252&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01075"></a>01075   <span class="keywordflow">case</span> <span class="stringliteral">&#39;iso-8859-2&#39;</span>: $codepage=<span class="stringliteral">&#39;iso-8859-2&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01076"></a>01076   <span class="keywordflow">case</span> <span class="stringliteral">&#39;iso-8859-4&#39;</span>: $codepage=<span class="stringliteral">&#39;iso-8859-4&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01077"></a>01077   <span class="keywordflow">case</span> <span class="stringliteral">&#39;iso-8859-7&#39;</span>: $codepage=<span class="stringliteral">&#39;iso-8859-7&#39;</span>;<span class="keywordflow">break</span>;
<a name="l01078"></a>01078   <span class="keywordflow">case</span> <span class="stringliteral">&#39;iso-8859-9&#39;</span>: $codepage=<span class="stringliteral">&#39;iso-8859-9&#39;</span>;<span class="keywordflow">break</span>; 
<a name="l01079"></a>01079   }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081   $this-&gt;default_available_fonts = $this-&gt;available_unifonts;
<a name="l01082"></a>01082 
<a name="l01083"></a>01083   <span class="comment">// Autodetect IF codepage is a language_country string (en-GB or en_GB or en)</span>
<a name="l01084"></a>01084   <span class="keywordflow">if</span> ((strlen($codepage) == 5 &amp;&amp; $codepage != <span class="stringliteral">&#39;UTF-8&#39;</span>) || strlen($codepage) == 2) {
<a name="l01085"></a>01085     <span class="comment">// in HTMLToolkit</span>
<a name="l01086"></a>01086     list ($codepage,$mpdf_pdf_unifonts,$mpdf_directionality,$mpdf_jSpacing) = GetCodepage($codepage);
<a name="l01087"></a>01087     $this-&gt;jSpacing = $mpdf_jSpacing;
<a name="l01088"></a>01088     <span class="keywordflow">if</span> (($codepage != <span class="stringliteral">&#39;BIG5&#39;</span>) &amp;&amp; ($codepage != <span class="stringliteral">&#39;GBK&#39;</span>) &amp;&amp; ($codepage != <span class="stringliteral">&#39;UHC&#39;</span>) &amp;&amp; ($codepage != <span class="stringliteral">&#39;SHIFT_JIS&#39;</span>)) { 
<a name="l01089"></a>01089       <span class="keywordflow">if</span> ($mpdf_pdf_unifonts) { 
<a name="l01090"></a>01090         $this-&gt;RestrictUnicodeFonts($mpdf_pdf_unifonts); 
<a name="l01091"></a>01091         $this-&gt;default_available_fonts = $mpdf_pdf_unifonts;
<a name="l01092"></a>01092       }
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094     $this-&gt;SetDirectionality($mpdf_directionality);
<a name="l01095"></a>01095     $this-&gt;currentLang = $codepage;
<a name="l01096"></a>01096     $this-&gt;default_lang = $codepage;
<a name="l01097"></a>01097     $this-&gt;default_jSpacing = $mpdf_jSpacing;
<a name="l01098"></a>01098     $this-&gt;default_dir = $mpdf_directionality;
<a name="l01099"></a>01099   }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101   <span class="comment">// mPDF 4.0 TEMPORARY FIX to disable win-1251 dejavu fonts</span>
<a name="l01102"></a>01102   <span class="keywordflow">if</span> ($codepage==<span class="stringliteral">&#39;win-1251&#39;</span>) {
<a name="l01103"></a>01103     <span class="keywordflow">foreach</span>($this-&gt;available_fonts AS $k=&gt;$v) {
<a name="l01104"></a>01104       <span class="keywordflow">if</span> (substr($v,0,6)==<span class="stringliteral">&#39;dejavu&#39;</span>) { unset($this-&gt;available_fonts[$k]); }
<a name="l01105"></a>01105     }
<a name="l01106"></a>01106   }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108   $this-&gt;codepage =  $codepage;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110   <span class="comment">// mPDF 4.0</span>
<a name="l01111"></a>01111   <span class="keywordflow">if</span> ($useSubsets &amp;&amp; $codepage==<span class="stringliteral">&#39;UTF-8&#39;</span>) {
<a name="l01112"></a>01112     $this-&gt;useSubsets = <span class="keyword">true</span>;
<a name="l01113"></a>01113   }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115   <span class="keywordflow">if</span> ($codepage == <span class="stringliteral">&#39;UTF-8&#39;</span>) { $this-&gt;is_MB = <span class="keyword">true</span>; }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117   <span class="comment">// mPDF 4.2.018</span>
<a name="l01118"></a>01118   <span class="keywordflow">if</span> (($codepage==<span class="stringliteral">&#39;win-1252&#39;</span> || $codepage==<span class="stringliteral">&#39;win-1251&#39;</span> || $codepage==<span class="stringliteral">&#39;iso-8859-2&#39;</span> || $codepage==<span class="stringliteral">&#39;iso-8859-4&#39;</span> || $codepage==<span class="stringliteral">&#39;iso-8859-7&#39;</span> || $codepage==<span class="stringliteral">&#39;iso-8859-9&#39;</span> || $codepage == <span class="stringliteral">&#39;BIG5&#39;</span> || $codepage == <span class="stringliteral">&#39;GBK&#39;</span> || $codepage == <span class="stringliteral">&#39;UHC&#39;</span> || $codepage == <span class="stringliteral">&#39;SHIFT_JIS&#39;</span>) &amp;&amp; !$this-&gt;PDFA) {
<a name="l01119"></a>01119     $this-&gt;useSubstitutions = <span class="keyword">true</span>;
<a name="l01120"></a>01120     $this-&gt;SetSubstitutions();
<a name="l01121"></a>01121   }
<a name="l01122"></a>01122   <span class="keywordflow">else</span> { $this-&gt;useSubstitutions = <span class="keyword">false</span>; }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124   <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;MPDF_FONTPATH&#39;</span>)) {
<a name="l01125"></a>01125     <span class="keywordflow">if</span> ($this-&gt;is_MB) { define(<span class="stringliteral">&#39;MPDF_FONTPATH&#39;</span>,_MPDF_PATH.<span class="stringliteral">&#39;unifont/&#39;</span>); }
<a name="l01126"></a>01126     <span class="keywordflow">else</span> { define(<span class="stringliteral">&#39;MPDF_FONTPATH&#39;</span>,_MPDF_PATH.<span class="stringliteral">&#39;font/&#39;</span>); }
<a name="l01127"></a>01127   }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129   <span class="keywordflow">if</span> (file_exists(_MPDF_PATH.<span class="stringliteral">&#39;mpdf.css&#39;</span>)) {
<a name="l01130"></a>01130     $css = file_get_contents(_MPDF_PATH.<span class="stringliteral">&#39;mpdf.css&#39;</span>);
<a name="l01131"></a>01131     $css2 = $this-&gt;<a class="code" href="classmPDF.html#a20d1475a1efa2a8b85e8716e8bb57af8" title="CSS parser ///.">ReadDefaultCSS</a>($css);
<a name="l01132"></a>01132     $this-&gt;defaultCSS = $this-&gt;array_merge_recursive_unique($this-&gt;defaultCSS,$css2); 
<a name="l01133"></a>01133   }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135   <span class="keywordflow">if</span> ($default_font==<span class="stringliteral">&#39;&#39;</span>) { 
<a name="l01136"></a>01136     <span class="keywordflow">if</span> ($codepage == <span class="stringliteral">&#39;win-1252&#39;</span>) { 
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (in_array(strtolower($this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]),$this-&gt;mono_fonts)) { $default_font = <span class="stringliteral">&#39;courier&#39;</span>; }
<a name="l01138"></a>01138     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array(strtolower($this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]),$this-&gt;sans_fonts)) { $default_font = <span class="stringliteral">&#39;helvetica&#39;</span>; }
<a name="l01139"></a>01139     <span class="keywordflow">else</span> { $default_font = <span class="stringliteral">&#39;times&#39;</span>; }
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141     <span class="keywordflow">else</span> { $default_font = $this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; }
<a name="l01142"></a>01142   }
<a name="l01143"></a>01143   <span class="keywordflow">if</span> (!$default_font_size) { 
<a name="l01144"></a>01144     $mmsize = $this-&gt;ConvertSize($this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]);
<a name="l01145"></a>01145     $default_font_size = $mmsize*($this-&gt;k);
<a name="l01146"></a>01146   }
<a name="l01147"></a>01147 
<a name="l01148"></a>01148   <span class="keywordflow">if</span> ($default_font) { $this-&gt;SetDefaultFont($default_font); }
<a name="l01149"></a>01149   <span class="keywordflow">if</span> ($default_font_size) { $this-&gt;SetDefaultFontSize($default_font_size); }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151   $this-&gt;setMBencoding($this-&gt;codepage);  <span class="comment">// sets $this-&gt;mb_enc</span>
<a name="l01152"></a>01152   @mb_regex_encoding(<span class="stringliteral">&#39;UTF-8&#39;</span>); 
<a name="l01153"></a>01153 
<a name="l01154"></a>01154   $this-&gt;setHiEntitySubstitutions();
<a name="l01155"></a>01155 
<a name="l01156"></a>01156   $this-&gt;SetLineHeight(); <span class="comment">// lineheight is in mm</span>
<a name="l01157"></a>01157 
<a name="l01158"></a>01158   $this-&gt;SetFillColor(255);
<a name="l01159"></a>01159   $this-&gt;HREF=<span class="stringliteral">&#39;&#39;</span>;
<a name="l01160"></a>01160   $this-&gt;oldy=-1;
<a name="l01161"></a>01161   $this-&gt;B=0;
<a name="l01162"></a>01162   $this-&gt;U=0;
<a name="l01163"></a>01163   $this-&gt;I=0;
<a name="l01164"></a>01164 
<a name="l01165"></a>01165   $this-&gt;listlvl=0;
<a name="l01166"></a>01166   $this-&gt;listnum=0; 
<a name="l01167"></a>01167   $this-&gt;listtype=<span class="stringliteral">&#39;&#39;</span>;
<a name="l01168"></a>01168   $this-&gt;listoccur=array();
<a name="l01169"></a>01169   $this-&gt;listlist=array();
<a name="l01170"></a>01170   $this-&gt;listitem=array();
<a name="l01171"></a>01171 
<a name="l01172"></a>01172   $this-&gt;tdbegin=<span class="keyword">false</span>; 
<a name="l01173"></a>01173   $this-&gt;table=array(); 
<a name="l01174"></a>01174   $this-&gt;cell=array();  
<a name="l01175"></a>01175   $this-&gt;col=-1; 
<a name="l01176"></a>01176   $this-&gt;row=-1; 
<a name="l01177"></a>01177   $this-&gt;cellBorderBuffer = array();
<a name="l01178"></a>01178 
<a name="l01179"></a>01179   $this-&gt;divbegin=<span class="keyword">false</span>;
<a name="l01180"></a>01180   $this-&gt;divalign=$this-&gt;defaultAlign;
<a name="l01181"></a>01181   $this-&gt;divwidth=0; 
<a name="l01182"></a>01182   $this-&gt;divheight=0; 
<a name="l01183"></a>01183   $this-&gt;spanbgcolor=<span class="keyword">false</span>;
<a name="l01184"></a>01184   $this-&gt;divrevert=<span class="keyword">false</span>;
<a name="l01185"></a>01185 
<a name="l01186"></a>01186   $this-&gt;issetfont=<span class="keyword">false</span>;
<a name="l01187"></a>01187   $this-&gt;issetcolor=<span class="keyword">false</span>;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189   $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l01190"></a>01190   $this-&gt;listjustfinished=<span class="keyword">false</span>;
<a name="l01191"></a>01191   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; <span class="comment">//in order to eliminate exceeding left-side spaces</span>
<a name="l01192"></a>01192   $this-&gt;toupper=<span class="keyword">false</span>;
<a name="l01193"></a>01193   $this-&gt;tolower=<span class="keyword">false</span>;
<a name="l01194"></a>01194   $this-&gt;dash_on=<span class="keyword">false</span>;
<a name="l01195"></a>01195   $this-&gt;dotted_on=<span class="keyword">false</span>;
<a name="l01196"></a>01196   $this-&gt;SUP=<span class="keyword">false</span>;
<a name="l01197"></a>01197   $this-&gt;SUB=<span class="keyword">false</span>;
<a name="l01198"></a>01198   $this-&gt;strike=<span class="keyword">false</span>;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200   $this-&gt;currentfontfamily=<span class="stringliteral">&#39;&#39;</span>;
<a name="l01201"></a>01201   $this-&gt;currentfontsize=<span class="stringliteral">&#39;&#39;</span>;
<a name="l01202"></a>01202   $this-&gt;currentfontstyle=<span class="stringliteral">&#39;&#39;</span>;
<a name="l01203"></a>01203   $this-&gt;colorarray=array();
<a name="l01204"></a>01204   $this-&gt;spanbgcolorarray=array();
<a name="l01205"></a>01205   $this-&gt;textbuffer=array();
<a name="l01206"></a>01206   $this-&gt;CSS=array();
<a name="l01207"></a>01207   $this-&gt;internallink=array();
<a name="l01208"></a>01208   $this-&gt;basepath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210   $this-&gt;SetBasePath(<span class="stringliteral">&#39;&#39;</span>);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212   $this-&gt;outlineparam = array();
<a name="l01213"></a>01213   $this-&gt;outline_on = <span class="keyword">false</span>;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215   $this-&gt;specialcontent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01216"></a>01216   $this-&gt;selectoption = array();
<a name="l01217"></a>01217 
<a name="l01218"></a>01218   $this-&gt;usetableheader=<span class="keyword">false</span>;
<a name="l01219"></a>01219   $this-&gt;usecss=<span class="keyword">true</span>;
<a name="l01220"></a>01220   $this-&gt;usepre=<span class="keyword">true</span>;
<a name="l01221"></a>01221 
<a name="l01222"></a>01222   <span class="keywordflow">for</span>($i=0;$i&lt;256;$i++) {
<a name="l01223"></a>01223     $this-&gt;chrs[$i] = chr($i);
<a name="l01224"></a>01224     $this-&gt;ords[chr($i)] = $i;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226   }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 <span class="comment">// mPDF 4.2.024</span>
<a name="l01232"></a>01232 function _setPageSize($format, &amp;$orientation) {
<a name="l01233"></a>01233   <span class="comment">//Page format</span>
<a name="l01234"></a>01234   <span class="keywordflow">if</span>(is_string($format))
<a name="l01235"></a>01235   {
<a name="l01236"></a>01236     <span class="keywordflow">if</span> ($format==<span class="stringliteral">&#39;&#39;</span>) { $format = <span class="stringliteral">&#39;A4&#39;</span>; }
<a name="l01237"></a>01237     $pfo = <span class="charliteral">&#39;P&#39;</span>; <span class="comment">// mPDF 4.2.025</span>
<a name="l01238"></a>01238     <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&#39;/([0-9a-zA-Z]*)-L/i&#39;</span>,$format,$m)) {  <span class="comment">// e.g. A4-L = A$ landscape</span>
<a name="l01239"></a>01239       $format=$m[1]; 
<a name="l01240"></a>01240       $pfo=<span class="charliteral">&#39;L&#39;</span>;   <span class="comment">// mPDF 4.2.025</span>
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242     $format = $this-&gt;_getPageFormat($format);
<a name="l01243"></a>01243     <span class="keywordflow">if</span> (!$format) { $this-&gt;Error(<span class="stringliteral">&#39;Unknown page format: &#39;</span>.$format); }
<a name="l01244"></a>01244     <span class="keywordflow">else</span> { $orientation = $pfo; } <span class="comment">// mPDF 4.2.025</span>
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     $this-&gt;fwPt=$format[0];
<a name="l01247"></a>01247     $this-&gt;fhPt=$format[1];
<a name="l01248"></a>01248   }
<a name="l01249"></a>01249   <span class="keywordflow">else</span>
<a name="l01250"></a>01250   {
<a name="l01251"></a>01251     <span class="keywordflow">if</span> (!$format[0] || !$format[1]) { $this-&gt;Error(<span class="stringliteral">&#39;Invalid page format: &#39;</span>.$format[0].<span class="charliteral">&#39; &#39;</span>.$format[1]); }
<a name="l01252"></a>01252     $this-&gt;fwPt=$format[0]*$this-&gt;k;
<a name="l01253"></a>01253     $this-&gt;fhPt=$format[1]*$this-&gt;k;
<a name="l01254"></a>01254   }
<a name="l01255"></a>01255   $this-&gt;fw=$this-&gt;fwPt/$this-&gt;k;
<a name="l01256"></a>01256   $this-&gt;fh=$this-&gt;fhPt/$this-&gt;k;
<a name="l01257"></a>01257   <span class="comment">//Page orientation</span>
<a name="l01258"></a>01258   $orientation=strtolower($orientation);
<a name="l01259"></a>01259   <span class="keywordflow">if</span>($orientation==<span class="charliteral">&#39;p&#39;</span> or $orientation==<span class="stringliteral">&#39;portrait&#39;</span>)
<a name="l01260"></a>01260   {
<a name="l01261"></a>01261     $orientation=<span class="charliteral">&#39;P&#39;</span>;
<a name="l01262"></a>01262     $this-&gt;wPt=$this-&gt;fwPt;
<a name="l01263"></a>01263     $this-&gt;hPt=$this-&gt;fhPt;
<a name="l01264"></a>01264   }
<a name="l01265"></a>01265   elseif($orientation==<span class="charliteral">&#39;l&#39;</span> or $orientation==<span class="stringliteral">&#39;landscape&#39;</span>)
<a name="l01266"></a>01266   {
<a name="l01267"></a>01267     $orientation=<span class="charliteral">&#39;L&#39;</span>;
<a name="l01268"></a>01268     $this-&gt;wPt=$this-&gt;fhPt;
<a name="l01269"></a>01269     $this-&gt;hPt=$this-&gt;fwPt;
<a name="l01270"></a>01270   }
<a name="l01271"></a>01271   <span class="keywordflow">else</span> $this-&gt;Error(<span class="stringliteral">&#39;Incorrect orientation: &#39;</span>.$orientation);
<a name="l01272"></a>01272   $this-&gt;CurOrientation=$orientation;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274   $this-&gt;w=$this-&gt;wPt/$this-&gt;k;
<a name="l01275"></a>01275   $this-&gt;h=$this-&gt;hPt/$this-&gt;k;
<a name="l01276"></a>01276 }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 <span class="comment">// mPDF 4.2.024</span>
<a name="l01279"></a>01279 function _getPageFormat($format) {
<a name="l01280"></a>01280     <span class="keywordflow">switch</span> (strtoupper($format)) {
<a name="l01281"></a>01281       <span class="keywordflow">case</span> <span class="stringliteral">&#39;4A0&#39;</span>: {$format = array(4767.87,6740.79); <span class="keywordflow">break</span>;}
<a name="l01282"></a>01282       <span class="keywordflow">case</span> <span class="stringliteral">&#39;2A0&#39;</span>: {$format = array(3370.39,4767.87); <span class="keywordflow">break</span>;}
<a name="l01283"></a>01283       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A0&#39;</span>: {$format = array(2383.94,3370.39); <span class="keywordflow">break</span>;}
<a name="l01284"></a>01284       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A1&#39;</span>: {$format = array(1683.78,2383.94); <span class="keywordflow">break</span>;}
<a name="l01285"></a>01285       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A2&#39;</span>: {$format = array(1190.55,1683.78); <span class="keywordflow">break</span>;}
<a name="l01286"></a>01286       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A3&#39;</span>: {$format = array(841.89,1190.55); <span class="keywordflow">break</span>;}
<a name="l01287"></a>01287       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A4&#39;</span>: <span class="keywordflow">default</span>: {$format = array(595.28,841.89); <span class="keywordflow">break</span>;}
<a name="l01288"></a>01288       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A5&#39;</span>: {$format = array(419.53,595.28); <span class="keywordflow">break</span>;}
<a name="l01289"></a>01289       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A6&#39;</span>: {$format = array(297.64,419.53); <span class="keywordflow">break</span>;}
<a name="l01290"></a>01290       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A7&#39;</span>: {$format = array(209.76,297.64); <span class="keywordflow">break</span>;}
<a name="l01291"></a>01291       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A8&#39;</span>: {$format = array(147.40,209.76); <span class="keywordflow">break</span>;}
<a name="l01292"></a>01292       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A9&#39;</span>: {$format = array(104.88,147.40); <span class="keywordflow">break</span>;}
<a name="l01293"></a>01293       <span class="keywordflow">case</span> <span class="stringliteral">&#39;A10&#39;</span>: {$format = array(73.70,104.88); <span class="keywordflow">break</span>;}
<a name="l01294"></a>01294       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B0&#39;</span>: {$format = array(2834.65,4008.19); <span class="keywordflow">break</span>;}
<a name="l01295"></a>01295       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B1&#39;</span>: {$format = array(2004.09,2834.65); <span class="keywordflow">break</span>;}
<a name="l01296"></a>01296       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B2&#39;</span>: {$format = array(1417.32,2004.09); <span class="keywordflow">break</span>;}
<a name="l01297"></a>01297       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B3&#39;</span>: {$format = array(1000.63,1417.32); <span class="keywordflow">break</span>;}
<a name="l01298"></a>01298       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B4&#39;</span>: {$format = array(708.66,1000.63); <span class="keywordflow">break</span>;}
<a name="l01299"></a>01299       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B5&#39;</span>: {$format = array(498.90,708.66); <span class="keywordflow">break</span>;}
<a name="l01300"></a>01300       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B6&#39;</span>: {$format = array(354.33,498.90); <span class="keywordflow">break</span>;}
<a name="l01301"></a>01301       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B7&#39;</span>: {$format = array(249.45,354.33); <span class="keywordflow">break</span>;}
<a name="l01302"></a>01302       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B8&#39;</span>: {$format = array(175.75,249.45); <span class="keywordflow">break</span>;}
<a name="l01303"></a>01303       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B9&#39;</span>: {$format = array(124.72,175.75); <span class="keywordflow">break</span>;}
<a name="l01304"></a>01304       <span class="keywordflow">case</span> <span class="stringliteral">&#39;B10&#39;</span>: {$format = array(87.87,124.72); <span class="keywordflow">break</span>;}
<a name="l01305"></a>01305       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C0&#39;</span>: {$format = array(2599.37,3676.54); <span class="keywordflow">break</span>;}
<a name="l01306"></a>01306       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C1&#39;</span>: {$format = array(1836.85,2599.37); <span class="keywordflow">break</span>;}
<a name="l01307"></a>01307       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C2&#39;</span>: {$format = array(1298.27,1836.85); <span class="keywordflow">break</span>;}
<a name="l01308"></a>01308       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C3&#39;</span>: {$format = array(918.43,1298.27); <span class="keywordflow">break</span>;}
<a name="l01309"></a>01309       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C4&#39;</span>: {$format = array(649.13,918.43); <span class="keywordflow">break</span>;}
<a name="l01310"></a>01310       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C5&#39;</span>: {$format = array(459.21,649.13); <span class="keywordflow">break</span>;}
<a name="l01311"></a>01311       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C6&#39;</span>: {$format = array(323.15,459.21); <span class="keywordflow">break</span>;}
<a name="l01312"></a>01312       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C7&#39;</span>: {$format = array(229.61,323.15); <span class="keywordflow">break</span>;}
<a name="l01313"></a>01313       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C8&#39;</span>: {$format = array(161.57,229.61); <span class="keywordflow">break</span>;}
<a name="l01314"></a>01314       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C9&#39;</span>: {$format = array(113.39,161.57); <span class="keywordflow">break</span>;}
<a name="l01315"></a>01315       <span class="keywordflow">case</span> <span class="stringliteral">&#39;C10&#39;</span>: {$format = array(79.37,113.39); <span class="keywordflow">break</span>;}
<a name="l01316"></a>01316       <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA0&#39;</span>: {$format = array(2437.80,3458.27); <span class="keywordflow">break</span>;}
<a name="l01317"></a>01317       <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA1&#39;</span>: {$format = array(1729.13,2437.80); <span class="keywordflow">break</span>;}
<a name="l01318"></a>01318       <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA2&#39;</span>: {$format = array(1218.90,1729.13); <span class="keywordflow">break</span>;}
<a name="l01319"></a>01319       <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA3&#39;</span>: {$format = array(864.57,1218.90); <span class="keywordflow">break</span>;}
<a name="l01320"></a>01320       <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA4&#39;</span>: {$format = array(609.45,864.57); <span class="keywordflow">break</span>;}
<a name="l01321"></a>01321       <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA0&#39;</span>: {$format = array(2551.18,3628.35); <span class="keywordflow">break</span>;}
<a name="l01322"></a>01322       <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA1&#39;</span>: {$format = array(1814.17,2551.18); <span class="keywordflow">break</span>;}
<a name="l01323"></a>01323       <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA2&#39;</span>: {$format = array(1275.59,1814.17); <span class="keywordflow">break</span>;}
<a name="l01324"></a>01324       <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA3&#39;</span>: {$format = array(907.09,1275.59); <span class="keywordflow">break</span>;}
<a name="l01325"></a>01325       <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA4&#39;</span>: {$format = array(637.80,907.09); <span class="keywordflow">break</span>;}
<a name="l01326"></a>01326       <span class="keywordflow">case</span> <span class="stringliteral">&#39;LETTER&#39;</span>: {$format = array(612.00,792.00); <span class="keywordflow">break</span>;}
<a name="l01327"></a>01327       <span class="keywordflow">case</span> <span class="stringliteral">&#39;LEGAL&#39;</span>: {$format = array(612.00,1008.00); <span class="keywordflow">break</span>;}
<a name="l01328"></a>01328       <span class="keywordflow">case</span> <span class="stringliteral">&#39;EXECUTIVE&#39;</span>: {$format = array(521.86,756.00); <span class="keywordflow">break</span>;}
<a name="l01329"></a>01329       <span class="keywordflow">case</span> <span class="stringliteral">&#39;FOLIO&#39;</span>: {$format = array(612.00,936.00); <span class="keywordflow">break</span>;}
<a name="l01330"></a>01330       <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>: {$format=array(362.83,561.26 );  <span class="keywordflow">break</span>;}    <span class="comment">//  &#39;B&#39; format paperback size 128x198mm</span>
<a name="l01331"></a>01331       <span class="keywordflow">case</span> <span class="charliteral">&#39;A&#39;</span>: {$format=array(314.65,504.57 );  <span class="keywordflow">break</span>;}    <span class="comment">//  &#39;A&#39; format paperback size 111x178mm</span>
<a name="l01332"></a>01332       <span class="keywordflow">case</span> <span class="stringliteral">&#39;DEMY&#39;</span>: {$format=array(382.68,612.28 );  <span class="keywordflow">break</span>;}   <span class="comment">//  &#39;Demy&#39; format paperback size 135x216mm</span>
<a name="l01333"></a>01333       <span class="keywordflow">case</span> <span class="stringliteral">&#39;ROYAL&#39;</span>: {$format=array(433.70,663.30 );  <span class="keywordflow">break</span>;}  <span class="comment">//  &#39;Royal&#39; format paperback size 153x234mm</span>
<a name="l01334"></a>01334       <span class="keywordflow">default</span>: $format = <span class="keyword">false</span>;
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336   <span class="keywordflow">return</span> $format;
<a name="l01337"></a>01337 }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339 
<a name="l01340"></a>01340 
<a name="l01341"></a>01341 function RestrictUnicodeFonts($res) {
<a name="l01342"></a>01342   <span class="comment">// $res = array of (Unicode) fonts to restrict to: e.g. norasi|norasiB - language specific</span>
<a name="l01343"></a>01343   <span class="keywordflow">if</span> (count($res)) {  <span class="comment">// Leave full list of available fonts if passed blank array</span>
<a name="l01344"></a>01344     $this-&gt;available_unifonts = $res;
<a name="l01345"></a>01345   }
<a name="l01346"></a>01346   <span class="keywordflow">else</span> { $this-&gt;available_unifonts = $this-&gt;default_available_fonts; }
<a name="l01347"></a>01347   <span class="keywordflow">if</span> (count($this-&gt;available_unifonts) == 0) { $this-&gt;available_unifonts[] = $this-&gt;default_available_fonts[0]; }
<a name="l01348"></a>01348   $this-&gt;available_unifonts = array_values($this-&gt;available_unifonts);
<a name="l01349"></a>01349 }
<a name="l01350"></a>01350 
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 function setMBencoding($enc) {
<a name="l01353"></a>01353   <span class="comment">// only call mb_internal_encoding if need to change</span>
<a name="l01354"></a>01354   $curr = $this-&gt;mb_enc;
<a name="l01355"></a>01355   <span class="comment">// Sets encoding string for use in mb_string functions</span>
<a name="l01356"></a>01356   <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;win-1252&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;windows-1252&#39;</span>; }
<a name="l01357"></a>01357   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;win-1251&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;windows-1251&#39;</span>; }
<a name="l01358"></a>01358   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;UTF-8&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;UTF-8&#39;</span>; }
<a name="l01359"></a>01359   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;BIG5&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;UTF-8&#39;</span>; }
<a name="l01360"></a>01360   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;GBK&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;UTF-8&#39;</span>; }  <span class="comment">// cp936</span>
<a name="l01361"></a>01361   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;SHIFT_JIS&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;UTF-8&#39;</span>; }
<a name="l01362"></a>01362   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($enc == <span class="stringliteral">&#39;UHC&#39;</span>) { $this-&gt;mb_enc = <span class="stringliteral">&#39;UTF-8&#39;</span>; }  <span class="comment">// cp949</span>
<a name="l01363"></a>01363   <span class="keywordflow">else</span> { $this-&gt;mb_enc = $enc; }  <span class="comment">// works for iso-8859-n</span>
<a name="l01364"></a>01364   <span class="keywordflow">if</span> ($this-&gt;mb_enc &amp;&amp; $curr != $this-&gt;mb_enc) { 
<a name="l01365"></a>01365     mb_internal_encoding($this-&gt;mb_enc); 
<a name="l01366"></a>01366   }
<a name="l01367"></a>01367 }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 function getMBencoding() {
<a name="l01370"></a>01370   <span class="keywordflow">return</span> $this-&gt;mb_enc;
<a name="l01371"></a>01371 }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 
<a name="l01374"></a>01374 
<a name="l01375"></a>01375 function SetMargins($left,$right,$top) {
<a name="l01376"></a>01376   <span class="comment">//Set left, top and right margins</span>
<a name="l01377"></a>01377   $this-&gt;lMargin=$left;
<a name="l01378"></a>01378   $this-&gt;rMargin=$right;
<a name="l01379"></a>01379   $this-&gt;tMargin=$top;
<a name="l01380"></a>01380 }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382 function ResetMargins() {
<a name="l01383"></a>01383   <span class="comment">//ReSet left, top margins</span>
<a name="l01384"></a>01384   <span class="keywordflow">if</span> (($this-&gt;forcePortraitHeaders || $this-&gt;forcePortraitMargins) &amp;&amp; $this-&gt;DefOrientation==<span class="charliteral">&#39;P&#39;</span> &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span>) {
<a name="l01385"></a>01385       <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l01386"></a>01386     $this-&gt;tMargin=$this-&gt;orig_rMargin;
<a name="l01387"></a>01387     $this-&gt;bMargin=$this-&gt;orig_lMargin;
<a name="l01388"></a>01388       }
<a name="l01389"></a>01389       <span class="keywordflow">else</span> {  <span class="comment">// ODD  // OR NOT MIRRORING MARGINS/FOOTERS</span>
<a name="l01390"></a>01390     $this-&gt;tMargin=$this-&gt;orig_lMargin;
<a name="l01391"></a>01391     $this-&gt;bMargin=$this-&gt;orig_rMargin;
<a name="l01392"></a>01392       }
<a name="l01393"></a>01393      $this-&gt;lMargin=$this-&gt;DeflMargin;
<a name="l01394"></a>01394      $this-&gt;rMargin=$this-&gt;DefrMargin;
<a name="l01395"></a>01395      $this-&gt;MarginCorrection = 0;
<a name="l01396"></a>01396      $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin;
<a name="l01397"></a>01397   }
<a name="l01398"></a>01398   <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l01399"></a>01399     $this-&gt;lMargin=$this-&gt;DefrMargin;
<a name="l01400"></a>01400     $this-&gt;rMargin=$this-&gt;DeflMargin;
<a name="l01401"></a>01401     $this-&gt;MarginCorrection = $this-&gt;DefrMargin-$this-&gt;DeflMargin;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403   }
<a name="l01404"></a>01404   <span class="keywordflow">else</span> {  <span class="comment">// ODD  // OR NOT MIRRORING MARGINS/FOOTERS</span>
<a name="l01405"></a>01405     $this-&gt;lMargin=$this-&gt;DeflMargin;
<a name="l01406"></a>01406     $this-&gt;rMargin=$this-&gt;DefrMargin;
<a name="l01407"></a>01407     <span class="keywordflow">if</span> ($this-&gt;mirrorMargins) { $this-&gt;MarginCorrection = $this-&gt;DeflMargin-$this-&gt;DefrMargin; }
<a name="l01408"></a>01408   }
<a name="l01409"></a>01409   $this-&gt;x=$this-&gt;lMargin;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411 }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413 function SetLeftMargin($margin) {
<a name="l01414"></a>01414   <span class="comment">//Set left margin</span>
<a name="l01415"></a>01415   $this-&gt;lMargin=$margin;
<a name="l01416"></a>01416   <span class="keywordflow">if</span>($this-&gt;page&gt;0 and $this-&gt;x&lt;$margin) $this-&gt;x=$margin;
<a name="l01417"></a>01417 }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419 function SetTopMargin($margin) {
<a name="l01420"></a>01420   <span class="comment">//Set top margin</span>
<a name="l01421"></a>01421   $this-&gt;tMargin=$margin;
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 function SetRightMargin($margin) {
<a name="l01425"></a>01425   <span class="comment">//Set right margin</span>
<a name="l01426"></a>01426   $this-&gt;rMargin=$margin;
<a name="l01427"></a>01427 }
<a name="l01428"></a>01428 
<a name="l01429"></a>01429 function SetAutoPageBreak($auto,$margin=0) {
<a name="l01430"></a>01430   <span class="comment">//Set auto page break mode and triggering margin</span>
<a name="l01431"></a>01431   $this-&gt;autoPageBreak=$auto;
<a name="l01432"></a>01432   $this-&gt;bMargin=$margin;
<a name="l01433"></a>01433   $this-&gt;PageBreakTrigger=$this-&gt;h-$margin;
<a name="l01434"></a>01434 }
<a name="l01435"></a>01435 
<a name="l01436"></a>01436 function SetDisplayMode($zoom,$layout=<span class="stringliteral">&#39;continuous&#39;</span>) {
<a name="l01437"></a>01437   <span class="comment">//Set display mode in viewer</span>
<a name="l01438"></a>01438   <span class="keywordflow">if</span>($zoom==<span class="stringliteral">&#39;fullpage&#39;</span> or $zoom==<span class="stringliteral">&#39;fullwidth&#39;</span> or $zoom==<span class="stringliteral">&#39;real&#39;</span> or $zoom==<span class="stringliteral">&#39;default&#39;</span> or !is_string($zoom))
<a name="l01439"></a>01439     $this-&gt;ZoomMode=$zoom;
<a name="l01440"></a>01440   <span class="keywordflow">else</span>
<a name="l01441"></a>01441     $this-&gt;Error(<span class="stringliteral">&#39;Incorrect zoom display mode: &#39;</span>.$zoom);
<a name="l01442"></a>01442   <span class="keywordflow">if</span>($layout==<span class="stringliteral">&#39;single&#39;</span> or $layout==<span class="stringliteral">&#39;continuous&#39;</span> or $layout==<span class="stringliteral">&#39;two&#39;</span> or $layout==<span class="stringliteral">&#39;default&#39;</span>)
<a name="l01443"></a>01443     $this-&gt;LayoutMode=$layout;
<a name="l01444"></a>01444   <span class="keywordflow">else</span>
<a name="l01445"></a>01445     $this-&gt;Error(<span class="stringliteral">&#39;Incorrect layout display mode: &#39;</span>.$layout);
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 function SetCompression($compress) {
<a name="l01449"></a>01449   <span class="comment">//Set page compression</span>
<a name="l01450"></a>01450   <span class="keywordflow">if</span>(function_exists(<span class="stringliteral">&#39;gzcompress&#39;</span>)) $this-&gt;compress=$compress;
<a name="l01451"></a>01451   <span class="keywordflow">else</span> $this-&gt;compress=<span class="keyword">false</span>;
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454 function SetTitle($title) {
<a name="l01455"></a>01455   <span class="comment">//Title of document // Arrives as UTF-8</span>
<a name="l01456"></a>01456   $this-&gt;title = $title;
<a name="l01457"></a>01457 }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459 function SetSubject($subject) {
<a name="l01460"></a>01460   <span class="comment">//Subject of document</span>
<a name="l01461"></a>01461   $this-&gt;subject= $subject;
<a name="l01462"></a>01462 }
<a name="l01463"></a>01463 
<a name="l01464"></a>01464 function SetAuthor($author) {
<a name="l01465"></a>01465   <span class="comment">//Author of document</span>
<a name="l01466"></a>01466   $this-&gt;author= $author;
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 function SetKeywords($keywords) {
<a name="l01470"></a>01470   <span class="comment">//Keywords of document</span>
<a name="l01471"></a>01471   $this-&gt;keywords= $keywords;
<a name="l01472"></a>01472 }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474 function SetCreator($creator) {
<a name="l01475"></a>01475   <span class="comment">//Creator of document</span>
<a name="l01476"></a>01476   $this-&gt;creator= $creator;
<a name="l01477"></a>01477 }
<a name="l01478"></a>01478 
<a name="l01479"></a>01479 
<a name="l01480"></a>01480 function SetAnchor2Bookmark($x) {
<a name="l01481"></a>01481   $this-&gt;anchor2Bookmark = $x;
<a name="l01482"></a>01482 }
<a name="l01483"></a>01483 
<a name="l01484"></a>01484 function AliasNbPages($alias=<span class="stringliteral">&#39;{nb}&#39;</span>) {
<a name="l01485"></a>01485   <span class="comment">//Define an alias for total number of pages</span>
<a name="l01486"></a>01486   $this-&gt;aliasNbPg=$alias;
<a name="l01487"></a>01487 }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489 function AliasNbPageGroups($alias=<span class="stringliteral">&#39;{nbpg}&#39;</span>) {
<a name="l01490"></a>01490   <span class="comment">//Define an alias for total number of pages in a group</span>
<a name="l01491"></a>01491   $this-&gt;aliasNbPgGp=$alias;
<a name="l01492"></a>01492 }
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 function SetAlpha($alpha, $bm=<span class="stringliteral">&#39;Normal&#39;</span>, $return=<span class="keyword">false</span>) {  <span class="comment">// mPDF 4.3.017</span>
<a name="l01495"></a>01495 <span class="comment">// alpha: real value from 0 (transparent) to 1 (opaque)</span>
<a name="l01496"></a>01496 <span class="comment">// bm:    blend mode, one of the following:</span>
<a name="l01497"></a>01497 <span class="comment">//          Normal, Multiply, Screen, Overlay, Darken, Lighten, ColorDodge, ColorBurn,</span>
<a name="l01498"></a>01498 <span class="comment">//          HardLight, SoftLight, Difference, Exclusion, Hue, Saturation, Color, Luminosity</span>
<a name="l01499"></a>01499 <span class="comment">// set alpha for stroking (CA) and non-stroking (ca) operations</span>
<a name="l01500"></a>01500   <span class="comment">// mPDF 4.2.018</span>
<a name="l01501"></a>01501   <span class="keywordflow">if</span> ($this-&gt;PDFA &amp;&amp; $alpha!=1) { 
<a name="l01502"></a>01502     <span class="keywordflow">if</span> (!$this-&gt;PDFAauto) { $this-&gt;PDFAwarnings[] = <span class="stringliteral">&quot;Image opacity must be 100% (Opacity changed to 100%)&quot;</span>; }
<a name="l01503"></a>01503     $alpha = 1; 
<a name="l01504"></a>01504   }
<a name="l01505"></a>01505   $gs = $this-&gt;AddExtGState(array(<span class="stringliteral">&#39;ca&#39;</span>=&gt;$alpha, <span class="stringliteral">&#39;CA&#39;</span>=&gt;$alpha, <span class="stringliteral">&#39;BM&#39;</span>=&gt;<span class="charliteral">&#39;/&#39;</span>.$bm));
<a name="l01506"></a>01506   <span class="keywordflow">if</span> ($return) { <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;/GS%d gs&#39;</span>, $gs); } <span class="comment">// mPDF 4.3.017</span>
<a name="l01507"></a>01507   <span class="keywordflow">else</span> { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/GS%d gs&#39;</span>, $gs)); }
<a name="l01508"></a>01508 }
<a name="l01509"></a>01509 
<a name="l01510"></a>01510 function AddExtGState($parms) {
<a name="l01511"></a>01511   $n = count($this-&gt;extgstates);
<a name="l01512"></a>01512   <span class="comment">// check if graphics state already exists</span>
<a name="l01513"></a>01513   <span class="keywordflow">for</span> ($i=1; $i&lt;=$n; $i++) {
<a name="l01514"></a>01514     <span class="keywordflow">if</span> ($this-&gt;extgstates[$i][<span class="stringliteral">&#39;parms&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>]==$parms[<span class="stringliteral">&#39;ca&#39;</span>] &amp;&amp; $this-&gt;extgstates[$i][<span class="stringliteral">&#39;parms&#39;</span>][<span class="stringliteral">&#39;CA&#39;</span>]==$parms[<span class="stringliteral">&#39;CA&#39;</span>] &amp;&amp; $this-&gt;extgstates[$i][<span class="stringliteral">&#39;parms&#39;</span>][<span class="stringliteral">&#39;BM&#39;</span>]==$parms[<span class="stringliteral">&#39;BM&#39;</span>]) {
<a name="l01515"></a>01515       <span class="keywordflow">return</span> $i;
<a name="l01516"></a>01516     }
<a name="l01517"></a>01517   }
<a name="l01518"></a>01518   $n++;
<a name="l01519"></a>01519   $this-&gt;extgstates[$n][<span class="stringliteral">&#39;parms&#39;</span>] = $parms;
<a name="l01520"></a>01520   <span class="keywordflow">return</span> $n;
<a name="l01521"></a>01521 }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523 
<a name="l01524"></a>01524 
<a name="l01525"></a>01525 function Error($msg) {
<a name="l01526"></a>01526   <span class="comment">//Fatal error</span>
<a name="l01527"></a>01527   header(<span class="stringliteral">&#39;Content-Type: text/html; charset=utf-8&#39;</span>);
<a name="l01528"></a>01528   die(<span class="stringliteral">&#39;&lt;B&gt;mPDF error: &lt;/B&gt;&#39;</span>.$msg);
<a name="l01529"></a>01529 }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531 function Open() {
<a name="l01532"></a>01532   <span class="comment">//Begin document</span>
<a name="l01533"></a>01533   <span class="keywordflow">if</span>($this-&gt;state==0) $this-&gt;_begindoc();
<a name="l01534"></a>01534 }
<a name="l01535"></a>01535 
<a name="l01536"></a>01536 function Close() {
<a name="l01537"></a>01537   <span class="comment">//Terminate document</span>
<a name="l01538"></a>01538   <span class="keywordflow">if</span>($this-&gt;state==3) <span class="keywordflow">return</span>;
<a name="l01539"></a>01539   <span class="keywordflow">if</span>($this-&gt;page==0) $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l01540"></a>01540   <span class="keywordflow">if</span> (count($this-&gt;cellBorderBuffer)) { $this-&gt;printcellbuffer(); } <span class="comment">// *TABLES*</span>
<a name="l01541"></a>01541   <span class="keywordflow">if</span> (count($this-&gt;tablebuffer)) { $this-&gt;printtablebuffer(); } <span class="comment">// *TABLES*</span>
<a name="l01542"></a>01542   <span class="keywordflow">if</span> (count($this-&gt;divbuffer)) { $this-&gt;printdivbuffer(); }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544   <span class="comment">// BODY Backgrounds</span>
<a name="l01545"></a>01545   $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01546"></a>01546   $bby = $this-&gt;h;
<a name="l01547"></a>01547   $bbw = $this-&gt;w;
<a name="l01548"></a>01548   $bbh = $this-&gt;h;
<a name="l01549"></a>01549   <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundColor) {
<a name="l01550"></a>01550     $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f rg&#39;</span>,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;R&#39;</span>]/255,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;G&#39;</span>]/255,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;B&#39;</span>]/255).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01551"></a>01551     $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re f&#39;</span>,0,$bby*$this-&gt;k,$bbw*$this-&gt;k,-$bbh*$this-&gt;k).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01552"></a>01552   }
<a name="l01553"></a>01553   <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage) {
<a name="l01554"></a>01554       <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;image_id&#39;</span>]) { <span class="comment">// Background pattern</span>
<a name="l01555"></a>01555       $n = count($this-&gt;patterns)+1;
<a name="l01556"></a>01556       <span class="comment">// mPDF 4.3.015</span>
<a name="l01557"></a>01557       list($orig_w, $orig_h, $x_repeat, $y_repeat) = $this-&gt;_resizeBackgroundImage($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;orig_w&#39;</span>], $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;orig_h&#39;</span>], $bbw, $bbh, $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;resize&#39;</span>], $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;x_repeat&#39;</span>], $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;y_repeat&#39;</span>]);
<a name="l01558"></a>01558       <span class="comment">// mPDF 3.1 $bbx = 0, &#39;y&#39;=&gt;0</span>
<a name="l01559"></a>01559       $this-&gt;patterns[$n] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;0, <span class="charliteral">&#39;y&#39;</span>=&gt;0, <span class="charliteral">&#39;w&#39;</span>=&gt;$bbw, <span class="charliteral">&#39;h&#39;</span>=&gt;$bbh, <span class="stringliteral">&#39;pgh&#39;</span>=&gt;$this-&gt;h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;image_id&#39;</span>], <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;x_pos&#39;</span>], <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;y_pos&#39;</span>], <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat); <span class="comment">// mPDF 4.3.015</span>
<a name="l01560"></a>01560       <span class="comment">// mPDF 4.3.017</span>
<a name="l01561"></a>01561       <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l01562"></a>01562       <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l01563"></a>01563       $s .= sprintf(<span class="stringliteral">&#39;q /Pattern cs /P%d scn %s %.3f %.3f %.3f %.3f re f Q&#39;</span>, $n, $opac, 0,$bby*$this-&gt;k,$bbw*$this-&gt;k,-$bbh*$this-&gt;k) .<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01564"></a>01564       }
<a name="l01565"></a>01565   }
<a name="l01566"></a>01566 
<a name="l01567"></a>01567 
<a name="l01568"></a>01568 
<a name="l01569"></a>01569   $s .= $this-&gt;PrintPageBackgrounds();
<a name="l01570"></a>01570   $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;\\1&#39;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l01571"></a>01571   $this-&gt;pageBackgrounds = array();
<a name="l01572"></a>01572 
<a name="l01573"></a>01573   <span class="keywordflow">if</span> (!$this-&gt;TOCmark) { <span class="comment">//Page footer</span>
<a name="l01574"></a>01574     $this-&gt;InFooter=<span class="keyword">true</span>;
<a name="l01575"></a>01575     $this-&gt;Footer();
<a name="l01576"></a>01576     $this-&gt;InFooter=<span class="keyword">false</span>;
<a name="l01577"></a>01577   }
<a name="l01578"></a>01578   <span class="keywordflow">if</span> ($this-&gt;TOCmark || count($this-&gt;m_TOC)) { $this-&gt;insertTOC(); }  <span class="comment">// *TOC*</span>
<a name="l01579"></a>01579 
<a name="l01580"></a>01580   <span class="comment">//Close page</span>
<a name="l01581"></a>01581   $this-&gt;_endpage();
<a name="l01582"></a>01582 
<a name="l01583"></a>01583   <span class="comment">//Close document</span>
<a name="l01584"></a>01584   $this-&gt;_enddoc();
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 <span class="comment">// mPDF 4.3.015</span>
<a name="l01588"></a>01588 function _resizeBackgroundImage($imw, $imh, $cw, $ch, $resize=0, $repx, $repy) {
<a name="l01589"></a>01589   $cw = $cw*$this-&gt;k;
<a name="l01590"></a>01590   $ch = $ch*$this-&gt;k;
<a name="l01591"></a>01591   <span class="keywordflow">if</span> (!$resize) { <span class="keywordflow">return</span> array($imw, $imh, $repx, $repy); }
<a name="l01592"></a>01592   <span class="keywordflow">if</span> ($resize==1 &amp;&amp; $imw &gt; $cw) {
<a name="l01593"></a>01593     $h = $imh * $cw/$imw;
<a name="l01594"></a>01594     $repx = <span class="keyword">false</span>;
<a name="l01595"></a>01595     <span class="keywordflow">return</span> array($cw, $h, $repx, $repy); 
<a name="l01596"></a>01596   }
<a name="l01597"></a>01597   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($resize==2 &amp;&amp; $imh &gt; $ch) {
<a name="l01598"></a>01598     $w = $imw * $ch/$imh;
<a name="l01599"></a>01599     $repy = <span class="keyword">false</span>;
<a name="l01600"></a>01600     <span class="keywordflow">return</span> array($w, $ch, $repx, $repy); 
<a name="l01601"></a>01601   }
<a name="l01602"></a>01602   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($resize==3) {
<a name="l01603"></a>01603     $w = $imw;
<a name="l01604"></a>01604     $h = $imh;
<a name="l01605"></a>01605     $saverepx = $repx;
<a name="l01606"></a>01606     <span class="keywordflow">if</span> ($w &gt; $cw) {
<a name="l01607"></a>01607       $h = $h * $cw/$w;
<a name="l01608"></a>01608       $w = $cw;
<a name="l01609"></a>01609       $repx = <span class="keyword">false</span>;
<a name="l01610"></a>01610     }
<a name="l01611"></a>01611     <span class="keywordflow">if</span> ($h &gt; $ch) {
<a name="l01612"></a>01612       $w = $w * $ch/$h;
<a name="l01613"></a>01613       $h = $ch;
<a name="l01614"></a>01614       $repy = <span class="keyword">false</span>;
<a name="l01615"></a>01615       $repx = $saverepx;
<a name="l01616"></a>01616     }
<a name="l01617"></a>01617     <span class="keywordflow">return</span> array($w, $h, $repx, $repy); 
<a name="l01618"></a>01618   }
<a name="l01619"></a>01619   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($resize==4) {
<a name="l01620"></a>01620     $h = $imh * $cw/$imw;
<a name="l01621"></a>01621     $repx = <span class="keyword">false</span>;
<a name="l01622"></a>01622     <span class="keywordflow">return</span> array($cw, $h, $repx, $repy); 
<a name="l01623"></a>01623   }
<a name="l01624"></a>01624   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($resize==5) {
<a name="l01625"></a>01625     $w = $imw * $ch/$imh;
<a name="l01626"></a>01626     $repy = <span class="keyword">false</span>;
<a name="l01627"></a>01627     <span class="keywordflow">return</span> array($w, $ch, $repx, $repy); 
<a name="l01628"></a>01628   }
<a name="l01629"></a>01629   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($resize==6) {
<a name="l01630"></a>01630     $repx = <span class="keyword">false</span>;
<a name="l01631"></a>01631     $repy = <span class="keyword">false</span>;
<a name="l01632"></a>01632     <span class="keywordflow">return</span> array($cw, $ch, $repx, $repy); 
<a name="l01633"></a>01633   }
<a name="l01634"></a>01634   <span class="keywordflow">return</span> array($imw, $imh, $repx, $repy);
<a name="l01635"></a>01635 }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637 
<a name="l01638"></a>01638 function PrintPageBackgrounds($adjustmenty=0) { <span class="comment">// mPDF 4.2.014 Adjustment added for HTMLFooters</span>
<a name="l01639"></a>01639   $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01640"></a>01640   ksort($this-&gt;pageBackgrounds);
<a name="l01641"></a>01641   <span class="keywordflow">foreach</span>($this-&gt;pageBackgrounds AS $bl=&gt;$pbs) {
<a name="l01642"></a>01642     <span class="keywordflow">foreach</span> ($pbs AS $pb) {
<a name="l01643"></a>01643       <span class="keywordflow">if</span> (!isset($pb[<span class="stringliteral">&#39;image_id&#39;</span>]) &amp;&amp; !isset($pb[<span class="stringliteral">&#39;gradient&#39;</span>])) { <span class="comment">// Background colour</span>
<a name="l01644"></a>01644       <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;clippath&#39;</span>]) &amp;&amp; $pb[<span class="stringliteral">&#39;clippath&#39;</span>]) { $s .= $pb[<span class="stringliteral">&#39;clippath&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l01645"></a>01645       $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f rg&#39;</span>,$pb[<span class="stringliteral">&#39;col&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]/255,$pb[<span class="stringliteral">&#39;col&#39;</span>][<span class="charliteral">&#39;G&#39;</span>]/255,$pb[<span class="stringliteral">&#39;col&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]/255).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01646"></a>01646       $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re f&#39;</span>,$pb[<span class="charliteral">&#39;x&#39;</span>]*$this-&gt;k,($this-&gt;h-$pb[<span class="charliteral">&#39;y&#39;</span>])*$this-&gt;k,$pb[<span class="charliteral">&#39;w&#39;</span>]*$this-&gt;k,-$pb[<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01647"></a>01647       <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;clippath&#39;</span>]) &amp;&amp; $pb[<span class="stringliteral">&#39;clippath&#39;</span>]) { $s .= <span class="charliteral">&#39;Q&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l01648"></a>01648       }
<a name="l01649"></a>01649     }
<a name="l01650"></a>01650     <span class="keywordflow">foreach</span> ($pbs AS $pb) {
<a name="l01651"></a>01651       <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;image_id&#39;</span>]) &amp;&amp; $pb[<span class="stringliteral">&#39;image_id&#39;</span>]) {  <span class="comment">// Background pattern</span>
<a name="l01652"></a>01652       $pb[<span class="charliteral">&#39;y&#39;</span>] -= $adjustmenty; <span class="comment">// mPDF 4.2.014 </span>
<a name="l01653"></a>01653       $pb[<span class="charliteral">&#39;h&#39;</span>] += $adjustmenty; <span class="comment">// mPDF 4.2.014 </span>
<a name="l01654"></a>01654       $n = count($this-&gt;patterns)+1;
<a name="l01655"></a>01655       <span class="comment">// mPDF 4.3.015</span>
<a name="l01656"></a>01656       list($orig_w, $orig_h, $x_repeat, $y_repeat) = $this-&gt;_resizeBackgroundImage($pb[<span class="stringliteral">&#39;orig_w&#39;</span>], $pb[<span class="stringliteral">&#39;orig_h&#39;</span>], $pb[<span class="charliteral">&#39;w&#39;</span>], $pb[<span class="charliteral">&#39;h&#39;</span>], $pb[<span class="stringliteral">&#39;resize&#39;</span>], $pb[<span class="stringliteral">&#39;x_repeat&#39;</span>], $pb[<span class="stringliteral">&#39;y_repeat&#39;</span>]);
<a name="l01657"></a>01657       $this-&gt;patterns[$n] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;$pb[<span class="charliteral">&#39;x&#39;</span>], <span class="charliteral">&#39;y&#39;</span>=&gt;$pb[<span class="charliteral">&#39;y&#39;</span>], <span class="charliteral">&#39;w&#39;</span>=&gt;$pb[<span class="charliteral">&#39;w&#39;</span>], <span class="charliteral">&#39;h&#39;</span>=&gt;$pb[<span class="charliteral">&#39;h&#39;</span>], <span class="stringliteral">&#39;pgh&#39;</span>=&gt;$this-&gt;h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$pb[<span class="stringliteral">&#39;image_id&#39;</span>], <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$pb[<span class="stringliteral">&#39;x_pos&#39;</span>], <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$pb[<span class="stringliteral">&#39;y_pos&#39;</span>], <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat);  <span class="comment">// mPDF 4.3.015</span>
<a name="l01658"></a>01658       $x = $pb[<span class="charliteral">&#39;x&#39;</span>]*$this-&gt;k;
<a name="l01659"></a>01659       $y = ($this-&gt;h - $pb[<span class="charliteral">&#39;y&#39;</span>])*$this-&gt;k;
<a name="l01660"></a>01660       $w = $pb[<span class="charliteral">&#39;w&#39;</span>]*$this-&gt;k;
<a name="l01661"></a>01661       $h = -$pb[<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k;
<a name="l01662"></a>01662       <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;clippath&#39;</span>]) &amp;&amp; $pb[<span class="stringliteral">&#39;clippath&#39;</span>]) { $s .= $pb[<span class="stringliteral">&#39;clippath&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l01663"></a>01663       <span class="comment">// mPDF 4.0</span>
<a name="l01664"></a>01664       <span class="keywordflow">if</span> ($this-&gt;writingHTMLfooter || $this-&gt;writingHTMLheader) {
<a name="l01665"></a>01665         $iw = $pb[<span class="stringliteral">&#39;orig_w&#39;</span>]/$this-&gt;k;
<a name="l01666"></a>01666         $ih = $pb[<span class="stringliteral">&#39;orig_h&#39;</span>]/$this-&gt;k;
<a name="l01667"></a>01667         $w = $pb[<span class="charliteral">&#39;w&#39;</span>];
<a name="l01668"></a>01668         $h = $pb[<span class="charliteral">&#39;h&#39;</span>];
<a name="l01669"></a>01669         $x0 = $pb[<span class="charliteral">&#39;x&#39;</span>];
<a name="l01670"></a>01670         $y0 = $pb[<span class="charliteral">&#39;y&#39;</span>];
<a name="l01671"></a>01671 
<a name="l01672"></a>01672         <span class="comment">// Number to repeat</span>
<a name="l01673"></a>01673         <span class="keywordflow">if</span> ($pb[<span class="stringliteral">&#39;x_repeat&#39;</span>]) { $nx = ceil($w/$iw); } 
<a name="l01674"></a>01674         <span class="keywordflow">else</span> { $nx = 1; }
<a name="l01675"></a>01675         <span class="keywordflow">if</span> ($pb[<span class="stringliteral">&#39;y_repeat&#39;</span>]) { $ny = ceil($h/$ih); }
<a name="l01676"></a>01676         <span class="keywordflow">else</span> { $ny = 1; }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678         $x_pos = $pb[<span class="stringliteral">&#39;x_pos&#39;</span>];
<a name="l01679"></a>01679         <span class="keywordflow">if</span> (stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { 
<a name="l01680"></a>01680           $x_pos += 0; 
<a name="l01681"></a>01681           $x_pos /= 100; 
<a name="l01682"></a>01682           $x_pos = ($w * $x_pos) - ($iw * $x_pos);
<a name="l01683"></a>01683         }
<a name="l01684"></a>01684         $y_pos = $pb[<span class="stringliteral">&#39;y_pos&#39;</span>];
<a name="l01685"></a>01685         <span class="keywordflow">if</span> (stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { 
<a name="l01686"></a>01686           $y_pos += 0; 
<a name="l01687"></a>01687           $y_pos /= 100; 
<a name="l01688"></a>01688           $y_pos = ($h * $y_pos) - ($ih * $y_pos);
<a name="l01689"></a>01689         }
<a name="l01690"></a>01690         <span class="keywordflow">if</span> ($nx&gt;1) {
<a name="l01691"></a>01691           <span class="keywordflow">while</span>($x_pos&gt;0) { $x_pos -= $iw; }
<a name="l01692"></a>01692         }
<a name="l01693"></a>01693         <span class="keywordflow">if</span> ($ny&gt;1) {
<a name="l01694"></a>01694           <span class="keywordflow">while</span>($y_pos&gt;0) { $y_pos -= $ih; }
<a name="l01695"></a>01695         }
<a name="l01696"></a>01696         <span class="keywordflow">for</span>($xi=0;$xi&lt;$nx;$xi++) {
<a name="l01697"></a>01697           <span class="keywordflow">for</span>($yi=0;$yi&lt;$ny;$yi++) {
<a name="l01698"></a>01698           $x = $x0 + $x_pos + ($iw*$xi);
<a name="l01699"></a>01699           $y = $y0 + $y_pos + ($ih*$yi);
<a name="l01700"></a>01700           <span class="comment">// mPDF 4.3.017</span>
<a name="l01701"></a>01701           <span class="keywordflow">if</span> ($pb[<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $pb[<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($pb[<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l01702"></a>01702           <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l01703"></a>01703           $s .= sprintf(<span class="stringliteral">&quot;q %s %.3f 0 0 %.3f %.3f %.3f cm /I%d Do Q&quot;</span>, $opac,$iw*$this-&gt;k,$ih*$this-&gt;k,$x*$this-&gt;k,($this-&gt;h-($y+$ih))*$this-&gt;k,$pb[<span class="stringliteral">&#39;image_id&#39;</span>]) .<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01704"></a>01704           }
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706       }
<a name="l01707"></a>01707       <span class="keywordflow">else</span> {
<a name="l01708"></a>01708         <span class="comment">// mPDF 4.3.017</span>
<a name="l01709"></a>01709         <span class="keywordflow">if</span> ($pb[<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $pb[<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($pb[<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l01710"></a>01710         <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l01711"></a>01711         $s .= sprintf(<span class="stringliteral">&#39;q /Pattern cs /P%d scn %s %.3f %.3f %.3f %.3f re f Q&#39;</span>, $n, $opac, $x, $y, $w, $h) .<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01712"></a>01712       }
<a name="l01713"></a>01713       <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;clippath&#39;</span>]) &amp;&amp; $pb[<span class="stringliteral">&#39;clippath&#39;</span>]) { $s .= <span class="charliteral">&#39;Q&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l01714"></a>01714       }
<a name="l01715"></a>01715     }
<a name="l01716"></a>01716   }
<a name="l01717"></a>01717   <span class="keywordflow">return</span> $s;
<a name="l01718"></a>01718 }
<a name="l01719"></a>01719 
<a name="l01720"></a>01720 <span class="comment">// Depracated - can use AddPage for all</span>
<a name="l01721"></a>01721 function AddPages($orientation=<span class="stringliteral">&#39;&#39;</span>,$condition=<span class="stringliteral">&#39;&#39;</span>, $resetpagenum=<span class="stringliteral">&#39;&#39;</span>, $pagenumstyle=<span class="stringliteral">&#39;&#39;</span>, $suppress=<span class="stringliteral">&#39;&#39;</span>,$mgl=<span class="stringliteral">&#39;&#39;</span>,$mgr=<span class="stringliteral">&#39;&#39;</span>,$mgt=<span class="stringliteral">&#39;&#39;</span>,$mgb=<span class="stringliteral">&#39;&#39;</span>,$mgh=<span class="stringliteral">&#39;&#39;</span>,$mgf=<span class="stringliteral">&#39;&#39;</span>,$ohname=<span class="stringliteral">&#39;&#39;</span>,$ehname=<span class="stringliteral">&#39;&#39;</span>,$ofname=<span class="stringliteral">&#39;&#39;</span>,$efname=<span class="stringliteral">&#39;&#39;</span>,$ohvalue=0,$ehvalue=0,$ofvalue=0,$efvalue=0,$pagesel=<span class="stringliteral">&#39;&#39;</span>,$newformat=<span class="stringliteral">&#39;&#39;</span>)
<a name="l01722"></a>01722 {
<a name="l01723"></a>01723   $this-&gt;AddPage($orientation,$condition,$resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf, $ohname, $ehname, $ofname, $efname, $ohvalue, $ehvalue, $ofvalue, $efvalue,$pagesel,$newformat=<span class="stringliteral">&#39;&#39;</span>);
<a name="l01724"></a>01724 }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 <span class="comment">// mPDF 4.2 Added $pagesel, $newformat [4.2.024]</span>
<a name="l01727"></a>01727 function AddPage($orientation=<span class="stringliteral">&#39;&#39;</span>,$condition=<span class="stringliteral">&#39;&#39;</span>, $resetpagenum=<span class="stringliteral">&#39;&#39;</span>, $pagenumstyle=<span class="stringliteral">&#39;&#39;</span>, $suppress=<span class="stringliteral">&#39;&#39;</span>,$mgl=<span class="stringliteral">&#39;&#39;</span>,$mgr=<span class="stringliteral">&#39;&#39;</span>,$mgt=<span class="stringliteral">&#39;&#39;</span>,$mgb=<span class="stringliteral">&#39;&#39;</span>,$mgh=<span class="stringliteral">&#39;&#39;</span>,$mgf=<span class="stringliteral">&#39;&#39;</span>,$ohname=<span class="stringliteral">&#39;&#39;</span>,$ehname=<span class="stringliteral">&#39;&#39;</span>,$ofname=<span class="stringliteral">&#39;&#39;</span>,$efname=<span class="stringliteral">&#39;&#39;</span>,$ohvalue=0,$ehvalue=0,$ofvalue=0,$efvalue=0,$pagesel=<span class="stringliteral">&#39;&#39;</span>,$newformat=<span class="stringliteral">&#39;&#39;</span>)
<a name="l01728"></a>01728 {
<a name="l01729"></a>01729 
<a name="l01730"></a>01730   <span class="comment">// Float DIV</span>
<a name="l01731"></a>01731   <span class="comment">// Cannot do with columns on, or if any change in page orientation/margins etc.</span>
<a name="l01732"></a>01732   <span class="comment">// If next page already exists - i.e background /headers and footers already written</span>
<a name="l01733"></a>01733   <span class="keywordflow">if</span> ($this-&gt;state &gt; 0 &amp;&amp; $this-&gt;page &lt; count($this-&gt;pages)) {
<a name="l01734"></a>01734     $bak_cml = $this-&gt;cMarginL;
<a name="l01735"></a>01735     $bak_cmr = $this-&gt;cMarginR; 
<a name="l01736"></a>01736     $bak_dw = $this-&gt;divwidth;
<a name="l01737"></a>01737     <span class="comment">// Paint Div Border if necessary</span>
<a name="l01738"></a>01738       <span class="keywordflow">if</span> ($this-&gt;blklvl &gt; 0) {
<a name="l01739"></a>01739       $save_tr = $this-&gt;table_rotate; <span class="comment">// *TABLES*</span>
<a name="l01740"></a>01740       $this-&gt;table_rotate = 0;  <span class="comment">// *TABLES*</span>
<a name="l01741"></a>01741       <span class="keywordflow">if</span> ($this-&gt;y == $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) {  $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]++; }
<a name="l01742"></a>01742       <span class="keywordflow">if</span> (($this-&gt;y &gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) || $this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;is_table&#39;</span>] ) { $toplvl = $this-&gt;blklvl; }
<a name="l01743"></a>01743       <span class="keywordflow">else</span> { $toplvl = $this-&gt;blklvl-1; }
<a name="l01744"></a>01744       $sy = $this-&gt;y;
<a name="l01745"></a>01745       <span class="keywordflow">for</span> ($bl=1;$bl&lt;=$toplvl;$bl++) {
<a name="l01746"></a>01746         $this-&gt;PaintDivBB(<span class="stringliteral">&#39;pagebottom&#39;</span>,0,$bl);
<a name="l01747"></a>01747       }
<a name="l01748"></a>01748       $this-&gt;y = $sy;
<a name="l01749"></a>01749       $this-&gt;table_rotate = $save_tr; <span class="comment">// *TABLES*</span>
<a name="l01750"></a>01750     }
<a name="l01751"></a>01751     $s = $this-&gt;PrintPageBackgrounds();
<a name="l01752"></a>01752 
<a name="l01753"></a>01753     <span class="comment">// Writes after the marker so not overwritten later by page background etc.</span>
<a name="l01754"></a>01754     $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l01755"></a>01755     $this-&gt;pageBackgrounds = array();
<a name="l01756"></a>01756   
<a name="l01757"></a>01757     $family=$this-&gt;FontFamily;
<a name="l01758"></a>01758     $style=$this-&gt;FontStyle.($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01759"></a>01759     $size=$this-&gt;FontSizePt;
<a name="l01760"></a>01760     $lw=$this-&gt;LineWidth;
<a name="l01761"></a>01761     $dc=$this-&gt;DrawColor;
<a name="l01762"></a>01762     $fc=$this-&gt;FillColor;
<a name="l01763"></a>01763     $tc=$this-&gt;TextColor;
<a name="l01764"></a>01764     $cf=$this-&gt;ColorFlag;
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     $this-&gt;printfloatbuffer();
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="comment">//Move to next page</span>
<a name="l01769"></a>01769     $this-&gt;page++;
<a name="l01770"></a>01770   
<a name="l01771"></a>01771     $this-&gt;ResetMargins();
<a name="l01772"></a>01772     $this-&gt;SetAutoPageBreak($this-&gt;autoPageBreak,$this-&gt;bMargin);
<a name="l01773"></a>01773     $this-&gt;x=$this-&gt;lMargin;
<a name="l01774"></a>01774     $this-&gt;y=$this-&gt;tMargin;
<a name="l01775"></a>01775     $this-&gt;FontFamily=<span class="stringliteral">&#39;&#39;</span>;
<a name="l01776"></a>01776     $this-&gt;_out(<span class="stringliteral">&#39;2 J&#39;</span>);
<a name="l01777"></a>01777     $this-&gt;LineWidth=$lw;
<a name="l01778"></a>01778     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f w&#39;</span>,$lw*$this-&gt;k));
<a name="l01779"></a>01779     <span class="keywordflow">if</span>($family) $this-&gt;SetFont($family,$style,$size,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l01780"></a>01780     $this-&gt;DrawColor=$dc;
<a name="l01781"></a>01781     <span class="keywordflow">if</span>($dc!=<span class="stringliteral">&#39;0 G&#39;</span>) $this-&gt;_out($dc);
<a name="l01782"></a>01782     $this-&gt;FillColor=$fc;
<a name="l01783"></a>01783     <span class="keywordflow">if</span>($fc!=<span class="stringliteral">&#39;0 g&#39;</span>) $this-&gt;_out($fc);
<a name="l01784"></a>01784     $this-&gt;TextColor=$tc;
<a name="l01785"></a>01785     $this-&gt;ColorFlag=$cf;
<a name="l01786"></a>01786     <span class="keywordflow">for</span>($bl=1;$bl&lt;=$this-&gt;blklvl;$bl++) {
<a name="l01787"></a>01787       $this-&gt;blk[$bl][<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l01788"></a>01788       <span class="comment">// Don&#39;t correct more than once for background DIV containing a Float</span>
<a name="l01789"></a>01789       <span class="keywordflow">if</span> (!isset($this-&gt;blk[$bl][<span class="stringliteral">&#39;marginCorrected&#39;</span>][$this-&gt;page])) { $this-&gt;blk[$bl][<span class="stringliteral">&#39;x0&#39;</span>] += $this-&gt;MarginCorrection; }
<a name="l01790"></a>01790       $this-&gt;blk[$bl][<span class="stringliteral">&#39;marginCorrected&#39;</span>][$this-&gt;page] = <span class="keyword">true</span>; 
<a name="l01791"></a>01791     }
<a name="l01792"></a>01792     $this-&gt;cMarginL = $bak_cml;
<a name="l01793"></a>01793     $this-&gt;cMarginR = $bak_cmr;
<a name="l01794"></a>01794     $this-&gt;divwidth = $bak_dw;
<a name="l01795"></a>01795     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01796"></a>01796   }
<a name="l01797"></a>01797 
<a name="l01798"></a>01798   <span class="comment">//Start a new page</span>
<a name="l01799"></a>01799   <span class="keywordflow">if</span>($this-&gt;state==0) $this-&gt;Open();
<a name="l01800"></a>01800 
<a name="l01801"></a>01801   <span class="comment">// mPDF 3.0 - Moved here from WriteFlowingBlock, FinishFlowingBlock and printbuffer</span>
<a name="l01802"></a>01802   $bak_cml = $this-&gt;cMarginL;
<a name="l01803"></a>01803   $bak_cmr = $this-&gt;cMarginR; 
<a name="l01804"></a>01804   $bak_dw = $this-&gt;divwidth;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806   <span class="comment">// mPDF 4.2</span>
<a name="l01807"></a>01807   $bak_lh = $this-&gt;lineheight;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809   $orientation = substr(strtoupper($orientation),0,1);
<a name="l01810"></a>01810   $condition = strtoupper($condition);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812   <span class="comment">// mPDF 4.2</span>
<a name="l01813"></a>01813   <span class="keywordflow">if</span> ($condition == <span class="stringliteral">&#39;NEXT-EVEN&#39;</span>) {  <span class="comment">// always adds at least one new page to create an Even page</span>
<a name="l01814"></a>01814      <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins) { $condition = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l01815"></a>01815      <span class="keywordflow">else</span> { 
<a name="l01816"></a>01816     <span class="keywordflow">if</span> ($pagesel) { $pbch = $pagesel; $pagesel = <span class="stringliteral">&#39;&#39;</span>; }  <span class="comment">// *CSS-PAGE*</span>
<a name="l01817"></a>01817     <span class="keywordflow">else</span> { $pbch = <span class="keyword">false</span>; } <span class="comment">// *CSS-PAGE*</span>
<a name="l01818"></a>01818     $this-&gt;AddPage($this-&gt;CurOrientation,<span class="charliteral">&#39;O&#39;</span>); 
<a name="l01819"></a>01819     <span class="keywordflow">if</span> ($pbch ) { $pagesel = $pbch; } <span class="comment">// *CSS-PAGE*</span>
<a name="l01820"></a>01820     $condition = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l01821"></a>01821      }
<a name="l01822"></a>01822   }
<a name="l01823"></a>01823   <span class="keywordflow">if</span> ($condition == <span class="stringliteral">&#39;NEXT-ODD&#39;</span>) { <span class="comment">// always adds at least one new page to create an Odd page</span>
<a name="l01824"></a>01824      <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins) { $condition = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l01825"></a>01825      <span class="keywordflow">else</span> { 
<a name="l01826"></a>01826     <span class="keywordflow">if</span> ($pagesel) { $pbch = $pagesel; $pagesel = <span class="stringliteral">&#39;&#39;</span>; }  <span class="comment">// *CSS-PAGE*</span>
<a name="l01827"></a>01827     <span class="keywordflow">else</span> { $pbch = <span class="keyword">false</span>; } <span class="comment">// *CSS-PAGE*</span>
<a name="l01828"></a>01828     $this-&gt;AddPage($this-&gt;CurOrientation,<span class="charliteral">&#39;E&#39;</span>); 
<a name="l01829"></a>01829     <span class="keywordflow">if</span> ($pbch ) { $pagesel = $pbch; } <span class="comment">// *CSS-PAGE*</span>
<a name="l01830"></a>01830     $condition = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l01831"></a>01831      }
<a name="l01832"></a>01832   }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834 
<a name="l01835"></a>01835   <span class="keywordflow">if</span> ($condition == <span class="charliteral">&#39;E&#39;</span>) {  <span class="comment">// only adds new page if needed to create an Even page</span>
<a name="l01836"></a>01836      <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins || ($this-&gt;page)%2==0) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l01837"></a>01837   }
<a name="l01838"></a>01838   <span class="keywordflow">if</span> ($condition == <span class="charliteral">&#39;O&#39;</span>) {  <span class="comment">// only adds new page if needed to create an Odd page</span>
<a name="l01839"></a>01839      <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins || ($this-&gt;page)%2==1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l01840"></a>01840   }
<a name="l01841"></a>01841 
<a name="l01842"></a>01842   <span class="keywordflow">if</span> ($resetpagenum || $pagenumstyle || $suppress) {
<a name="l01843"></a>01843     $this-&gt;PageNumSubstitutions[] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;($this-&gt;page+1), <span class="stringliteral">&#39;reset&#39;</span>=&gt; $resetpagenum, <span class="stringliteral">&#39;type&#39;</span>=&gt;$pagenumstyle, <span class="stringliteral">&#39;suppress&#39;</span>=&gt;$suppress);
<a name="l01844"></a>01844   }
<a name="l01845"></a>01845 
<a name="l01846"></a>01846   <span class="comment">// mPDF 4.0</span>
<a name="l01847"></a>01847   $save_tr = $this-&gt;table_rotate; <span class="comment">// *TABLES*</span>
<a name="l01848"></a>01848   $this-&gt;table_rotate = 0;  <span class="comment">// *TABLES*</span>
<a name="l01849"></a>01849   $save_kwt = $this-&gt;kwt;
<a name="l01850"></a>01850   $this-&gt;kwt = 0;
<a name="l01851"></a>01851 
<a name="l01852"></a>01852 
<a name="l01853"></a>01853   <span class="comment">// Paint Div Border if necessary</span>
<a name="l01854"></a>01854     <span class="comment">//PAINTS BACKGROUND COLOUR OR BORDERS for DIV - DISABLED FOR COLUMNS (cf. AcceptPageBreak) AT PRESENT in -&gt;PaintDivBB</span>
<a name="l01855"></a>01855     <span class="keywordflow">if</span> (!$this-&gt;ColActive &amp;&amp; $this-&gt;blklvl &gt; 0) {
<a name="l01856"></a>01856     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) &amp;&amp; $this-&gt;y == $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) {  
<a name="l01857"></a>01857       <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>])) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]++; }
<a name="l01858"></a>01858       <span class="keywordflow">else</span> { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] = 1; }
<a name="l01859"></a>01859     }
<a name="l01860"></a>01860     <span class="keywordflow">if</span> ((isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) &amp;&amp; $this-&gt;y &gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) || $this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;is_table&#39;</span>] ) { $toplvl = $this-&gt;blklvl; }
<a name="l01861"></a>01861     <span class="keywordflow">else</span> { $toplvl = $this-&gt;blklvl-1; }
<a name="l01862"></a>01862     $sy = $this-&gt;y;
<a name="l01863"></a>01863     <span class="keywordflow">for</span> ($bl=1;$bl&lt;=$toplvl;$bl++) {
<a name="l01864"></a>01864       $this-&gt;PaintDivBB(<span class="stringliteral">&#39;pagebottom&#39;</span>,0,$bl);
<a name="l01865"></a>01865     }
<a name="l01866"></a>01866     $this-&gt;y = $sy;
<a name="l01867"></a>01867     <span class="comment">// RESET block y0 and x0 - see below</span>
<a name="l01868"></a>01868   }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870   <span class="comment">// BODY Backgrounds</span>
<a name="l01871"></a>01871   <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l01872"></a>01872     $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01873"></a>01873     $bby = $this-&gt;h;
<a name="l01874"></a>01874     $bbw = $this-&gt;w;
<a name="l01875"></a>01875     $bbh = $this-&gt;h;
<a name="l01876"></a>01876     <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundColor) {
<a name="l01877"></a>01877       $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f rg&#39;</span>,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;R&#39;</span>]/255,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;G&#39;</span>]/255,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;B&#39;</span>]/255).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01878"></a>01878       $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re f&#39;</span>,0,$bby*$this-&gt;k,$bbw*$this-&gt;k,-$bbh*$this-&gt;k).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01879"></a>01879     }
<a name="l01880"></a>01880     <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage) {
<a name="l01881"></a>01881         <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;image_id&#39;</span>]) { <span class="comment">// Background pattern</span>
<a name="l01882"></a>01882         $n = count($this-&gt;patterns)+1;
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 
<a name="l01885"></a>01885         <span class="comment">// mPDF 4.3.015</span>
<a name="l01886"></a>01886         list($orig_w, $orig_h, $x_repeat, $y_repeat) = $this-&gt;_resizeBackgroundImage($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;orig_w&#39;</span>], $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;orig_h&#39;</span>], $bbw, $bbh, $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;resize&#39;</span>],$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;x_repeat&#39;</span>],$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;y_repeat&#39;</span>]);
<a name="l01887"></a>01887         <span class="comment">// mPDF 3.1 &#39;y&#39;=&gt;0</span>
<a name="l01888"></a>01888         $this-&gt;patterns[$n] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;0, <span class="charliteral">&#39;y&#39;</span>=&gt;0, <span class="charliteral">&#39;w&#39;</span>=&gt;$bbw, <span class="charliteral">&#39;h&#39;</span>=&gt;$bbh, <span class="stringliteral">&#39;pgh&#39;</span>=&gt;$this-&gt;h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;image_id&#39;</span>], <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;x_pos&#39;</span>], <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;y_pos&#39;</span>], <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat); <span class="comment">// mPDF 4.3.015</span>
<a name="l01889"></a>01889         <span class="comment">// mPDF 4.3.017</span>
<a name="l01890"></a>01890         <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l01891"></a>01891         <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l01892"></a>01892         $s .= sprintf(<span class="stringliteral">&#39;q /Pattern cs /P%d scn %s %.3f %.3f %.3f %.3f re f Q&#39;</span>, $n, $opac, 0,$bby*$this-&gt;k,$bbw*$this-&gt;k,-$bbh*$this-&gt;k) .<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01893"></a>01893         }
<a name="l01894"></a>01894     }
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     $s .= $this-&gt;PrintPageBackgrounds();
<a name="l01897"></a>01897     $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;\\1&#39;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l01898"></a>01898     $this-&gt;pageBackgrounds = array();
<a name="l01899"></a>01899   }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901   $save_cols = <span class="keyword">false</span>;
<a name="l01902"></a>01902 
<a name="l01903"></a>01903   $family=$this-&gt;FontFamily;
<a name="l01904"></a>01904   $style=$this-&gt;FontStyle.($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01905"></a>01905   $size=$this-&gt;FontSizePt;
<a name="l01906"></a>01906   $this-&gt;ColumnAdjust = <span class="keyword">true</span>; <span class="comment">// enables column height adjustment for the page</span>
<a name="l01907"></a>01907   $lw=$this-&gt;LineWidth;
<a name="l01908"></a>01908   $dc=$this-&gt;DrawColor;
<a name="l01909"></a>01909   $fc=$this-&gt;FillColor;
<a name="l01910"></a>01910   $tc=$this-&gt;TextColor;
<a name="l01911"></a>01911   $cf=$this-&gt;ColorFlag;
<a name="l01912"></a>01912   <span class="keywordflow">if</span>($this-&gt;page&gt;0)
<a name="l01913"></a>01913   {
<a name="l01914"></a>01914     <span class="comment">//Page footer</span>
<a name="l01915"></a>01915     $this-&gt;InFooter=<span class="keyword">true</span>;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     <span class="comment">// mPDF 3.0</span>
<a name="l01918"></a>01918     $this-&gt;Reset();
<a name="l01919"></a>01919     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l01920"></a>01920 
<a name="l01921"></a>01921     $this-&gt;Footer();
<a name="l01922"></a>01922     <span class="comment">//Close page</span>
<a name="l01923"></a>01923     $this-&gt;_endpage();
<a name="l01924"></a>01924   }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926 
<a name="l01927"></a>01927 
<a name="l01928"></a>01928 
<a name="l01929"></a>01929 
<a name="l01930"></a>01930   <span class="comment">//Start new page</span>
<a name="l01931"></a>01931   <span class="comment">// mPDF 4.2 pagesel,$newformat 4.2.024</span>
<a name="l01932"></a>01932   $this-&gt;_beginpage($orientation,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$newformat);
<a name="l01933"></a>01933   <span class="comment">// mPDF 4.2 Moved here from Header() - so it goes before ___BACKGROUND___PATTERNS marker</span>
<a name="l01934"></a>01934   <span class="keywordflow">if</span> ($this-&gt;docTemplate) {
<a name="l01935"></a>01935     $pagecount = $this-&gt;SetSourceFile($this-&gt;docTemplate);
<a name="l01936"></a>01936     <span class="keywordflow">if</span> (($this-&gt;page - $this-&gt;docTemplateStart) &gt; $pagecount) {
<a name="l01937"></a>01937       <span class="keywordflow">if</span> ($this-&gt;docTemplateContinue) { 
<a name="l01938"></a>01938         $tplIdx = $this-&gt;<a class="code" href="classmPDF.html#a76b08baa17ffab5b6d56b7f3dbb56fe4">ImportPage</a>($pagecount);
<a name="l01939"></a>01939         $this-&gt;UseTemplate($tplIdx);
<a name="l01940"></a>01940       }
<a name="l01941"></a>01941     }
<a name="l01942"></a>01942     <span class="keywordflow">else</span> {
<a name="l01943"></a>01943       $tplIdx = $this-&gt;<a class="code" href="classmPDF.html#a76b08baa17ffab5b6d56b7f3dbb56fe4">ImportPage</a>(($this-&gt;page - $this-&gt;docTemplateStart));
<a name="l01944"></a>01944       $this-&gt;UseTemplate($tplIdx);
<a name="l01945"></a>01945     }
<a name="l01946"></a>01946   }
<a name="l01947"></a>01947   <span class="keywordflow">if</span> ($this-&gt;pageTemplate) {
<a name="l01948"></a>01948     $this-&gt;UseTemplate($this-&gt;pageTemplate);
<a name="l01949"></a>01949   }
<a name="l01950"></a>01950 
<a name="l01951"></a>01951   <span class="comment">// Tiling Patterns  // Moved here mPDF 4.0</span>
<a name="l01952"></a>01952   $this-&gt;_out(<span class="stringliteral">&#39;___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>));
<a name="l01953"></a>01953   $this-&gt;pageBackgrounds = array();
<a name="l01954"></a>01954 
<a name="l01955"></a>01955   <span class="comment">//Set line cap style to square</span>
<a name="l01956"></a>01956   $this-&gt;_out(<span class="stringliteral">&#39;2 J&#39;</span>);
<a name="l01957"></a>01957   <span class="comment">//Set line width</span>
<a name="l01958"></a>01958   $this-&gt;LineWidth=$lw;
<a name="l01959"></a>01959   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f w&#39;</span>,$lw*$this-&gt;k));
<a name="l01960"></a>01960   <span class="comment">//Set font</span>
<a name="l01961"></a>01961   <span class="keywordflow">if</span>($family) $this-&gt;SetFont($family,$style,$size,<span class="keyword">true</span>,<span class="keyword">true</span>); <span class="comment">// forces write</span>
<a name="l01962"></a>01962   <span class="comment">//Set colors</span>
<a name="l01963"></a>01963   $this-&gt;DrawColor=$dc;
<a name="l01964"></a>01964   <span class="keywordflow">if</span>($dc!=<span class="stringliteral">&#39;0 G&#39;</span>) $this-&gt;_out($dc);
<a name="l01965"></a>01965   $this-&gt;FillColor=$fc;
<a name="l01966"></a>01966   <span class="keywordflow">if</span>($fc!=<span class="stringliteral">&#39;0 g&#39;</span>) $this-&gt;_out($fc);
<a name="l01967"></a>01967   $this-&gt;TextColor=$tc;
<a name="l01968"></a>01968   $this-&gt;ColorFlag=$cf;
<a name="l01969"></a>01969 
<a name="l01970"></a>01970   <span class="comment">//Page header</span>
<a name="l01971"></a>01971   $this-&gt;Header();
<a name="l01972"></a>01972 
<a name="l01973"></a>01973   <span class="comment">//Restore line width</span>
<a name="l01974"></a>01974   <span class="keywordflow">if</span>($this-&gt;LineWidth!=$lw)
<a name="l01975"></a>01975   {
<a name="l01976"></a>01976     $this-&gt;LineWidth=$lw;
<a name="l01977"></a>01977     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f w&#39;</span>,$lw*$this-&gt;k));
<a name="l01978"></a>01978   }
<a name="l01979"></a>01979   <span class="comment">//Restore font</span>
<a name="l01980"></a>01980   <span class="keywordflow">if</span>($family) $this-&gt;SetFont($family,$style,$size,<span class="keyword">true</span>,<span class="keyword">true</span>); <span class="comment">// forces write</span>
<a name="l01981"></a>01981   <span class="comment">//Restore colors</span>
<a name="l01982"></a>01982   <span class="keywordflow">if</span>($this-&gt;DrawColor!=$dc)
<a name="l01983"></a>01983   {
<a name="l01984"></a>01984     $this-&gt;DrawColor=$dc;
<a name="l01985"></a>01985     $this-&gt;_out($dc);
<a name="l01986"></a>01986   }
<a name="l01987"></a>01987   <span class="keywordflow">if</span>($this-&gt;FillColor!=$fc)
<a name="l01988"></a>01988   {
<a name="l01989"></a>01989     $this-&gt;FillColor=$fc;
<a name="l01990"></a>01990     $this-&gt;_out($fc);
<a name="l01991"></a>01991   }
<a name="l01992"></a>01992   $this-&gt;TextColor=$tc;
<a name="l01993"></a>01993   $this-&gt;ColorFlag=$cf;
<a name="l01994"></a>01994   $this-&gt;InFooter=<span class="keyword">false</span>;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996 
<a name="l01997"></a>01997 
<a name="l01998"></a>01998     <span class="comment">//RESET BLOCK BORDER TOP</span>
<a name="l01999"></a>01999     <span class="keywordflow">if</span> (!$this-&gt;ColActive) {
<a name="l02000"></a>02000     <span class="keywordflow">for</span>($bl=1;$bl&lt;=$this-&gt;blklvl;$bl++) {
<a name="l02001"></a>02001       $this-&gt;blk[$bl][<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l02002"></a>02002       <span class="keywordflow">if</span> (isset($this-&gt;blk[$bl][<span class="stringliteral">&#39;x0&#39;</span>])) { $this-&gt;blk[$bl][<span class="stringliteral">&#39;x0&#39;</span>] += $this-&gt;MarginCorrection; }
<a name="l02003"></a>02003       <span class="keywordflow">else</span> { $this-&gt;blk[$bl][<span class="stringliteral">&#39;x0&#39;</span>] = $this-&gt;MarginCorrection; }
<a name="l02004"></a>02004       <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l02005"></a>02005       $this-&gt;blk[$bl][<span class="stringliteral">&#39;marginCorrected&#39;</span>][$this-&gt;page] = <span class="keyword">true</span>; 
<a name="l02006"></a>02006     }
<a name="l02007"></a>02007   }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009   <span class="comment">// mPDF 4.0</span>
<a name="l02010"></a>02010   $this-&gt;table_rotate = $save_tr; <span class="comment">// *TABLES*</span>
<a name="l02011"></a>02011   $this-&gt;kwt = $save_kwt;
<a name="l02012"></a>02012 
<a name="l02013"></a>02013   $this-&gt;cMarginL = $bak_cml;
<a name="l02014"></a>02014   $this-&gt;cMarginR = $bak_cmr;
<a name="l02015"></a>02015   $this-&gt;divwidth = $bak_dw;
<a name="l02016"></a>02016   <span class="comment">// mPDF 4.2</span>
<a name="l02017"></a>02017   $this-&gt;lineheight = $bak_lh;
<a name="l02018"></a>02018 }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020 
<a name="l02021"></a>02021 function PageNo() {
<a name="l02022"></a>02022   <span class="comment">//Get current page number</span>
<a name="l02023"></a>02023   <span class="keywordflow">return</span> $this-&gt;page;
<a name="l02024"></a>02024 }
<a name="l02025"></a>02025 
<a name="l02026"></a>02026 function SetDrawColor($r,$g=-1,$b=-1,$col4=-1) {
<a name="l02027"></a>02027   <span class="comment">//Set color for all stroking operations</span>
<a name="l02028"></a>02028   <span class="keywordflow">if</span>(($r==0 and $g==0 and $b==0 &amp;&amp; $col4 == -1) or $g==-1)  $this-&gt;DrawColor=sprintf(<span class="stringliteral">&#39;%.3f G&#39;</span>,$r/255);
<a name="l02029"></a>02029   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($col4 == -1) $this-&gt;DrawColor=sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f RG&#39;</span>,$r/255,$g/255,$b/255);
<a name="l02030"></a>02030   <span class="keywordflow">else</span> {
<a name="l02031"></a>02031     <span class="comment">// CMYK</span>
<a name="l02032"></a>02032     <span class="comment">// mPDF 4.2.018</span>
<a name="l02033"></a>02033     <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&quot;PDFA1-b does not permit CMYK colours (fn. SetDrawColor).&quot;</span>); }
<a name="l02034"></a>02034     $this-&gt;DrawColor = sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f K&#39;</span>, $r/100, $g/100, $b/100, $col4/100);
<a name="l02035"></a>02035   }
<a name="l02036"></a>02036   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;DrawColor&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;DrawColor&#39;</span>] != $this-&gt;DrawColor) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;DrawColor&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($this-&gt;DrawColor); }
<a name="l02037"></a>02037   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;DrawColor&#39;</span>] = $this-&gt;DrawColor;
<a name="l02038"></a>02038 }
<a name="l02039"></a>02039 
<a name="l02040"></a>02040 function SetFillColor($r,$g=-1,$b=-1,$col4=-1) {
<a name="l02041"></a>02041   <span class="comment">//Set color for all filling operations</span>
<a name="l02042"></a>02042   <span class="keywordflow">if</span>(($r==0 and $g==0 and $b==0 &amp;&amp; $col4 == -1) or $g==-1)  $this-&gt;FillColor=sprintf(<span class="stringliteral">&#39;%.3f g&#39;</span>,$r/255);
<a name="l02043"></a>02043   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($col4 == -1) $this-&gt;FillColor=sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f rg&#39;</span>,$r/255,$g/255,$b/255);
<a name="l02044"></a>02044   <span class="keywordflow">else</span> {
<a name="l02045"></a>02045     <span class="comment">// CMYK</span>
<a name="l02046"></a>02046     <span class="comment">// mPDF 4.2.018</span>
<a name="l02047"></a>02047     <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&quot;PDFA1-b does not permit CMYK colours (fn. SetFillColor).&quot;</span>); }
<a name="l02048"></a>02048     $this-&gt;FillColor = sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f k&#39;</span>, $r/100, $g/100, $b/100, $col4/100);
<a name="l02049"></a>02049   }
<a name="l02050"></a>02050   $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor);
<a name="l02051"></a>02051   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>] != $this-&gt;FillColor) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($this-&gt;FillColor); }
<a name="l02052"></a>02052   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>] = $this-&gt;FillColor;
<a name="l02053"></a>02053 }
<a name="l02054"></a>02054 
<a name="l02055"></a>02055 function SetTextColor($r,$g=-1,$b=-1,$col4=-1) {
<a name="l02056"></a>02056   <span class="comment">//Set color for text</span>
<a name="l02057"></a>02057   <span class="keywordflow">if</span>(($r==0 and $g==0 and $b==0 &amp;&amp; $col4 == -1) or $g==-1)  $this-&gt;TextColor=sprintf(<span class="stringliteral">&#39;%.3f g&#39;</span>,$r/255);
<a name="l02058"></a>02058   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($col4 == -1) $this-&gt;TextColor=sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f rg&#39;</span>,$r/255,$g/255,$b/255);
<a name="l02059"></a>02059   <span class="keywordflow">else</span> {
<a name="l02060"></a>02060     <span class="comment">// CMYK</span>
<a name="l02061"></a>02061     <span class="comment">// mPDF 4.2.018</span>
<a name="l02062"></a>02062     <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&quot;PDFA1-b does not permit CMYK colours (fn. SetTextColor).&quot;</span>); }
<a name="l02063"></a>02063     $this-&gt;TextColor = sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f k&#39;</span>, $r/100, $g/100, $b/100, $col4/100);
<a name="l02064"></a>02064   }
<a name="l02065"></a>02065   $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor);
<a name="l02066"></a>02066 }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068 
<a name="l02069"></a>02069 
<a name="l02070"></a>02070 function GetStringWidth($s) {
<a name="l02071"></a>02071       <span class="comment">//Get width of a string in the current font</span>
<a name="l02072"></a>02072       $s = (string)$s;
<a name="l02073"></a>02073       $cw = &amp;$this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l02074"></a>02074       $w = 0;
<a name="l02075"></a>02075       <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02076"></a>02076         $unicode = $this-&gt;UTF8StringToArray($s);
<a name="l02077"></a>02077         <span class="keywordflow">foreach</span>($unicode as $char) {
<a name="l02078"></a>02078           <span class="keywordflow">if</span> ($char == 173) { <span class="keywordflow">continue</span>; } <span class="comment">// Soft Hyphens</span>
<a name="l02079"></a>02079           elseif (isset($cw[$char])) { $w+=$cw[$char]; } 
<a name="l02080"></a>02080         <span class="comment">//  elseif(isset($this-&gt;ords[$char]) &amp;&amp; isset($cw[$this-&gt;ords[$char]])) { $w+=$cw[$this-&gt;ords[$char]]; } // mPDF 4.2</span>
<a name="l02081"></a>02081           elseif(isset($this-&gt;chrs[$char]) &amp;&amp; isset($cw[$this-&gt;chrs[$char]])) { $w+=$cw[$this-&gt;chrs[$char]]; } 
<a name="l02082"></a>02082           elseif(isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;MissingWidth&#39;</span>])) { $w += $this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;MissingWidth&#39;</span>]; }
<a name="l02083"></a>02083           elseif(isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;MissingWidth&#39;</span>])) { $w += $this-&gt;CurrentFont[<span class="stringliteral">&#39;MissingWidth&#39;</span>]; }
<a name="l02084"></a>02084           <span class="keywordflow">else</span> { $w += 500; }
<a name="l02085"></a>02085         }
<a name="l02086"></a>02086       } 
<a name="l02087"></a>02087       <span class="keywordflow">else</span> {
<a name="l02088"></a>02088         $l = strlen($s);
<a name="l02089"></a>02089         <span class="keywordflow">for</span>($i=0; $i&lt;$l; $i++) {
<a name="l02090"></a>02090           <span class="comment">// Soft Hyphens chr(173)</span>
<a name="l02091"></a>02091           <span class="keywordflow">if</span> (substr($s,$i,1) == chr(173) &amp;&amp; ($this-&gt;FontFamily!=<span class="stringliteral">&#39;symbol&#39;</span> &amp;&amp; $this-&gt;FontFamily!=<span class="stringliteral">&#39;zapfdingbats&#39;</span>)) { 
<a name="l02092"></a>02092             <span class="keywordflow">continue</span>;
<a name="l02093"></a>02093           }
<a name="l02094"></a>02094           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($cw[substr($s,$i,1)])) { $w += $cw[substr($s,$i,1)]; } 
<a name="l02095"></a>02095           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($cw[$this-&gt;ords[substr($s,$i,1)]])) { $w += $cw[$this-&gt;ords[substr($s,$i,1)]]; }
<a name="l02096"></a>02096         }
<a name="l02097"></a>02097       }
<a name="l02098"></a>02098       unset($cw);
<a name="l02099"></a>02099       <span class="keywordflow">return</span> ($w * $this-&gt;FontSize/ 1000);
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 function SetLineWidth($width) {
<a name="l02103"></a>02103   <span class="comment">//Set line width</span>
<a name="l02104"></a>02104   $this-&gt;LineWidth=$width;
<a name="l02105"></a>02105   $lwout = (sprintf(<span class="stringliteral">&#39;%.3f w&#39;</span>,$width*$this-&gt;k));
<a name="l02106"></a>02106   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;LineWidth&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;LineWidth&#39;</span>] != $lwout) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;LineWidth&#39;</span>]) || $this-&gt;keep_block_together)) {
<a name="l02107"></a>02107      $this-&gt;_out($lwout); 
<a name="l02108"></a>02108   }
<a name="l02109"></a>02109   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;LineWidth&#39;</span>] = $lwout;
<a name="l02110"></a>02110 }
<a name="l02111"></a>02111 
<a name="l02112"></a>02112 function Line($x1,$y1,$x2,$y2) {
<a name="l02113"></a>02113   <span class="comment">//Draw a line</span>
<a name="l02114"></a>02114   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S&#39;</span>,$x1*$this-&gt;k,($this-&gt;h-$y1)*$this-&gt;k,$x2*$this-&gt;k,($this-&gt;h-$y2)*$this-&gt;k));
<a name="l02115"></a>02115 }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117 function Arrow($x1,$y1,$x2,$y2,$headsize=3,$fill=<span class="charliteral">&#39;B&#39;</span>,$angle=25) {
<a name="l02118"></a>02118   <span class="comment">//F == fill //S == stroke //B == stroke and fill </span>
<a name="l02119"></a>02119   <span class="comment">// angle = splay of arrowhead - 1 - 89 degrees</span>
<a name="l02120"></a>02120   <span class="keywordflow">if</span>($fill==<span class="charliteral">&#39;F&#39;</span>)  $fill=<span class="charliteral">&#39;f&#39;</span>;
<a name="l02121"></a>02121   elseif($fill==<span class="stringliteral">&#39;FD&#39;</span> or $fill==<span class="stringliteral">&#39;DF&#39;</span> or $fill==<span class="charliteral">&#39;B&#39;</span>) $fill=&#39;B&#39;;
<a name="l02122"></a>02122   else $fill=&#39;S&#39;;
<a name="l02123"></a>02123   $a = atan2(($y2-$y1),($x2-$x1));
<a name="l02124"></a>02124   $b = $a + deg2rad($angle);
<a name="l02125"></a>02125   $c = $a - deg2rad($angle);
<a name="l02126"></a>02126   $x3 = $x2 - ($headsize* cos($b));
<a name="l02127"></a>02127   $y3 = $this-&gt;h-($y2 - ($headsize* sin($b)));
<a name="l02128"></a>02128   $x4 = $x2 - ($headsize* cos($c));
<a name="l02129"></a>02129   $y4 = $this-&gt;h-($y2 - ($headsize* sin($c)));
<a name="l02130"></a>02130 
<a name="l02131"></a>02131   $x5 = $x3-($x3-$x4)/2;  <span class="comment">// mid point of base of arrowhead - to join arrow line to</span>
<a name="l02132"></a>02132   $y5 = $y3-($y3-$y4)/2;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134   $s = &#39;&#39;;
<a name="l02135"></a>02135   $s.=sprintf(&#39;%.3f %.3f m %.3f %.3f l S&#39;,$x1*$this-&gt;k,($this-&gt;h-$y1)*$this-&gt;k,$x5*$this-&gt;k,$y5*$this-&gt;k);
<a name="l02136"></a>02136   $this-&gt;_out($s);
<a name="l02137"></a>02137 
<a name="l02138"></a>02138   $s = &#39;&#39;;
<a name="l02139"></a>02139   $s.=sprintf(&#39;%.3f %.3f m %.3f %.3f l %.3f %.3f l %.3f %.3f l %.3f %.3f l &#39;,$x5*$this-&gt;k,$y5*$this-&gt;k,$x3*$this-&gt;k,$y3*$this-&gt;k,$x2*$this-&gt;k,($this-&gt;h-$y2)*$this-&gt;k,$x4*$this-&gt;k,$y4*$this-&gt;k,$x5*$this-&gt;k,$y5*$this-&gt;k);
<a name="l02140"></a>02140   $s.=$fill;
<a name="l02141"></a>02141   $this-&gt;_out($s);
<a name="l02142"></a>02142 }
<a name="l02143"></a>02143 
<a name="l02144"></a>02144 
<a name="l02145"></a>02145 function Rect($x,$y,$w,$h,$style=&#39;&#39;) {
<a name="l02146"></a>02146   <span class="comment">//Draw a rectangle</span>
<a name="l02147"></a>02147   <span class="keywordflow">if</span>($style==<span class="charliteral">&#39;F&#39;</span>) $op=<span class="charliteral">&#39;f&#39;</span>;
<a name="l02148"></a>02148   elseif($style==<span class="stringliteral">&#39;FD&#39;</span> or $style==<span class="stringliteral">&#39;DF&#39;</span>) $op=&#39;B&#39;;
<a name="l02149"></a>02149   else $op=&#39;S&#39;;
<a name="l02150"></a>02150   $this-&gt;_out(sprintf(&#39;%.3f %.3f %.3f %.3f re %s&#39;,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,$w*$this-&gt;k,-$h*$this-&gt;k,$op));
<a name="l02151"></a>02151 }
<a name="l02152"></a>02152 
<a name="l02153"></a>02153 function AddFont($family,$style=&#39;&#39;,$file=&#39;&#39;) {
<a name="l02154"></a>02154 
<a name="l02155"></a>02155   <span class="keywordflow">if</span> ($this-&gt;isCJK &amp;&amp; $this-&gt;use_CJK_only) { <span class="keywordflow">return</span>; }
<a name="l02156"></a>02156   <span class="keywordflow">if</span>(empty($family)) { <span class="keywordflow">return</span>; }
<a name="l02157"></a>02157   $family = strtolower($family);
<a name="l02158"></a>02158   $style=strtoupper($style);
<a name="l02159"></a>02159   $style=str_replace(<span class="charliteral">&#39;U&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$style);
<a name="l02160"></a>02160   <span class="keywordflow">if</span>($style==<span class="stringliteral">&#39;IB&#39;</span>) $style=<span class="stringliteral">&#39;BI&#39;</span>;
<a name="l02161"></a>02161   $fontkey = $family.$style;
<a name="l02162"></a>02162   <span class="comment">// check if the font has been already added</span>
<a name="l02163"></a>02163   <span class="keywordflow">if</span>(isset($this-&gt;fonts[$fontkey])) {
<a name="l02164"></a>02164     <span class="keywordflow">return</span>;
<a name="l02165"></a>02165   }
<a name="l02166"></a>02166 
<a name="l02167"></a>02167   <span class="keywordflow">if</span> (($this-&gt;is_MB) &amp;&amp; (!$this-&gt;usingCoreFont)) {
<a name="l02168"></a>02168       <span class="keywordflow">if</span>($file==<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02169"></a>02169         $file = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $family).strtolower($style).<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l02170"></a>02170       }
<a name="l02171"></a>02171       <span class="keywordflow">if</span>(!file_exists(MPDF_FONTPATH.$file)) {
<a name="l02172"></a>02172         <span class="comment">// try to load the basic file without styles</span>
<a name="l02173"></a>02173         $file = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $family).<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l02174"></a>02174       }
<a name="l02175"></a>02175       include(MPDF_FONTPATH.$file);
<a name="l02176"></a>02176       <span class="comment">// mPDF 4.1</span>
<a name="l02177"></a>02177       <span class="keywordflow">if</span> ($this-&gt;useSubsets &amp;&amp; file_exists(MPDF_FONTPATH.substr($file,0,(strpos($file,<span class="charliteral">&#39;.&#39;</span>))).<span class="stringliteral">&#39;.dat&#39;</span>)) { $type = <span class="stringliteral">&quot;Type1subset&quot;</span>; }
<a name="l02178"></a>02178       <span class="keywordflow">if</span>(!isset($name)) {
<a name="l02179"></a>02179         $this-&gt;Error(<span class="stringliteral">&#39;Could not include font definition file&#39;</span>);
<a name="l02180"></a>02180       }
<a name="l02181"></a>02181       $i = count($this-&gt;fonts)+$this-&gt;extraFontSubsets+1;
<a name="l02182"></a>02182       <span class="comment">// mPDF 4.0</span>
<a name="l02183"></a>02183       $sbarr = range(0,32);  
<a name="l02184"></a>02184       <span class="comment">// Always include space, and 0-9 in first subset for use in page number aliases {nb} {nbpg}</span>
<a name="l02185"></a>02185       <span class="keywordflow">for</span>($ctr=0; $ctr&lt;10; $ctr++) { $sbarr[($ctr+33)] = ($ctr+48); }
<a name="l02186"></a>02186       $this-&gt;fonts[$fontkey] = array(<span class="charliteral">&#39;i&#39;</span>=&gt;$i, <span class="stringliteral">&#39;type&#39;</span>=&gt;$type, <span class="stringliteral">&#39;name&#39;</span>=&gt;$name, <span class="stringliteral">&#39;desc&#39;</span>=&gt;$desc, <span class="stringliteral">&#39;up&#39;</span>=&gt;$up, <span class="stringliteral">&#39;ut&#39;</span>=&gt;$ut, <span class="stringliteral">&#39;cw&#39;</span>=&gt;$cw, <span class="stringliteral">&#39;enc&#39;</span>=&gt;$enc, <span class="stringliteral">&#39;file&#39;</span>=&gt;$file, <span class="stringliteral">&#39;ctg&#39;</span>=&gt;$ctg, <span class="stringliteral">&#39;subsets&#39;</span>=&gt;array(0=&gt;$sbarr), <span class="stringliteral">&#39;subsetfontids&#39;</span>=&gt;array($i), <span class="stringliteral">&#39;used&#39;</span>=&gt;<span class="keyword">false</span>);
<a name="l02187"></a>02187 
<a name="l02188"></a>02188       <span class="comment">/* mPDF 4.2 Not required in MB document/fonts</span>
<a name="l02189"></a>02189 <span class="comment">      if(isset($diff) AND (!empty($diff))) {</span>
<a name="l02190"></a>02190 <span class="comment">        //Search existing encodings</span>
<a name="l02191"></a>02191 <span class="comment">        $d=0;</span>
<a name="l02192"></a>02192 <span class="comment">        $nb=count($this-&gt;diffs);</span>
<a name="l02193"></a>02193 <span class="comment">        for($i=1;$i&lt;=$nb;$i++) {</span>
<a name="l02194"></a>02194 <span class="comment">          if($this-&gt;diffs[$i]==$diff) {</span>
<a name="l02195"></a>02195 <span class="comment">            $d=$i;</span>
<a name="l02196"></a>02196 <span class="comment">            break;</span>
<a name="l02197"></a>02197 <span class="comment">          }</span>
<a name="l02198"></a>02198 <span class="comment">        }</span>
<a name="l02199"></a>02199 <span class="comment">        if($d==0) {</span>
<a name="l02200"></a>02200 <span class="comment">          $d=$nb+1;</span>
<a name="l02201"></a>02201 <span class="comment">          $this-&gt;diffs[$d]=$diff;</span>
<a name="l02202"></a>02202 <span class="comment">        }</span>
<a name="l02203"></a>02203 <span class="comment">        $this-&gt;fonts[$fontkey][&#39;diff&#39;]=$d;</span>
<a name="l02204"></a>02204 <span class="comment">      }</span>
<a name="l02205"></a>02205 <span class="comment">      */</span>
<a name="l02206"></a>02206       <span class="keywordflow">if</span>(!empty($file)) {
<a name="l02207"></a>02207         <span class="comment">// mPDF 4.0</span>
<a name="l02208"></a>02208         <span class="keywordflow">if</span> ($this-&gt;useSubsets &amp;&amp; $type == <span class="stringliteral">&quot;Type1subset&quot;</span>) {
<a name="l02209"></a>02209           $this-&gt;FontFiles[$file]=array(<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&quot;Type1subset&quot;</span>);
<a name="l02210"></a>02210         }
<a name="l02211"></a>02211         <span class="keywordflow">else</span> <span class="keywordflow">if</span>((strcasecmp($type,<span class="stringliteral">&quot;TrueType&quot;</span>) == 0) OR (strcasecmp($type,<span class="stringliteral">&quot;TrueTypeUnicode&quot;</span>) == 0)) {
<a name="l02212"></a>02212           $this-&gt;FontFiles[$file]=array(<span class="stringliteral">&#39;length1&#39;</span>=&gt;$originalsize);
<a name="l02213"></a>02213         }
<a name="l02214"></a>02214         <span class="keywordflow">else</span> {
<a name="l02215"></a>02215           $this-&gt;FontFiles[$file]=array(<span class="stringliteral">&#39;length1&#39;</span>=&gt;$size1,<span class="stringliteral">&#39;length2&#39;</span>=&gt;$size2);
<a name="l02216"></a>02216         }
<a name="l02217"></a>02217       }
<a name="l02218"></a>02218   }
<a name="l02219"></a>02219   <span class="keywordflow">else</span> {  <span class="comment">// if not unicode (or embedded)</span>
<a name="l02220"></a>02220 
<a name="l02221"></a>02221     <span class="keywordflow">if</span>($file==<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02222"></a>02222       $file=str_replace(<span class="charliteral">&#39; &#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$family).strtolower($style);
<a name="l02223"></a>02223 
<a name="l02224"></a>02224       <span class="keywordflow">if</span> ($this-&gt;is_MB) {
<a name="l02225"></a>02225         $file=$file.<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l02226"></a>02226       }
<a name="l02227"></a>02227       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;codepage != <span class="stringliteral">&#39;win-1252&#39;</span>) {
<a name="l02228"></a>02228         $file=$file.<span class="charliteral">&#39;-&#39;</span>.$this-&gt;codepage.<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l02229"></a>02229       }
<a name="l02230"></a>02230       <span class="keywordflow">else</span> {  <span class="comment">// is there any other?</span>
<a name="l02231"></a>02231         $file=$file.<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l02232"></a>02232       }
<a name="l02233"></a>02233 
<a name="l02234"></a>02234 
<a name="l02235"></a>02235     }
<a name="l02236"></a>02236     <span class="keywordflow">if</span>(defined(<span class="stringliteral">&#39;MPDF_FONTPATH&#39;</span>)) { $file=MPDF_FONTPATH.$file; }
<a name="l02237"></a>02237     include($file);
<a name="l02238"></a>02238     <span class="keywordflow">if</span>(!isset($name)) $this-&gt;Error(<span class="stringliteral">&#39;Could not include font definition file - &#39;</span>.$family.<span class="charliteral">&#39; &#39;</span>.$style);
<a name="l02239"></a>02239     $i=count($this-&gt;fonts)+$this-&gt;extraFontSubsets+1;
<a name="l02240"></a>02240     $this-&gt;fonts[$family.$style]=array(<span class="charliteral">&#39;i&#39;</span>=&gt;$i,<span class="stringliteral">&#39;type&#39;</span>=&gt;$type,<span class="stringliteral">&#39;name&#39;</span>=&gt;$name,<span class="stringliteral">&#39;desc&#39;</span>=&gt;$desc,<span class="stringliteral">&#39;up&#39;</span>=&gt;$up,<span class="stringliteral">&#39;ut&#39;</span>=&gt;$ut,<span class="stringliteral">&#39;cw&#39;</span>=&gt;$cw,<span class="stringliteral">&#39;enc&#39;</span>=&gt;$enc,<span class="stringliteral">&#39;file&#39;</span>=&gt;$file, <span class="stringliteral">&#39;used&#39;</span>=&gt;<span class="keyword">false</span>);
<a name="l02241"></a>02241     <span class="keywordflow">if</span>($diff)
<a name="l02242"></a>02242     {
<a name="l02243"></a>02243       <span class="comment">//Search existing encodings</span>
<a name="l02244"></a>02244       $d=0;
<a name="l02245"></a>02245       $nb=count($this-&gt;diffs);
<a name="l02246"></a>02246       <span class="keywordflow">for</span>($i=1;$i&lt;=$nb;$i++)
<a name="l02247"></a>02247         <span class="keywordflow">if</span>($this-&gt;diffs[$i]==$diff) {
<a name="l02248"></a>02248           $d=$i;
<a name="l02249"></a>02249           <span class="keywordflow">break</span>;
<a name="l02250"></a>02250         }
<a name="l02251"></a>02251       <span class="keywordflow">if</span>($d==0) {
<a name="l02252"></a>02252         $d=$nb+1;
<a name="l02253"></a>02253         $this-&gt;diffs[$d]=$diff;
<a name="l02254"></a>02254       }
<a name="l02255"></a>02255       $this-&gt;fonts[$family.$style][<span class="stringliteral">&#39;diff&#39;</span>]=$d;
<a name="l02256"></a>02256     }
<a name="l02257"></a>02257     <span class="keywordflow">if</span>($file) {
<a name="l02258"></a>02258       <span class="keywordflow">if</span>($type==<span class="stringliteral">&#39;TrueType&#39;</span>) $this-&gt;FontFiles[$file]=array(<span class="stringliteral">&#39;length1&#39;</span>=&gt;$originalsize);
<a name="l02259"></a>02259       <span class="keywordflow">else</span> $this-&gt;FontFiles[$file]=array(<span class="stringliteral">&#39;length1&#39;</span>=&gt;$size1,<span class="stringliteral">&#39;length2&#39;</span>=&gt;$size2);
<a name="l02260"></a>02260     }
<a name="l02261"></a>02261     <span class="comment">// ADDED fontlist is defined in html2fpdf</span>
<a name="l02262"></a>02262     <span class="keywordflow">if</span> (isset($this-&gt;fontlist)) { $this-&gt;fontlist[] = strtolower($family); }
<a name="l02263"></a>02263     <span class="keywordflow">else</span> { $this-&gt;fontlist = array(strtolower($family)); }
<a name="l02264"></a>02264   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02265"></a>02265 }
<a name="l02266"></a>02266 
<a name="l02267"></a>02267 
<a name="l02268"></a>02268 
<a name="l02269"></a>02269 function SetFont($family,$style=<span class="stringliteral">&#39;&#39;</span>,$size=0, $write=<span class="keyword">true</span>, $forcewrite=<span class="keyword">false</span>) {
<a name="l02270"></a>02270   $family=strtolower($family);
<a name="l02271"></a>02271   <span class="comment">// save previous values - ? not required mPDF 4.0</span>
<a name="l02272"></a>02272   <span class="comment">// $this-&gt;prevFontFamily = $this-&gt;FontFamily;</span>
<a name="l02273"></a>02273   <span class="comment">// $this-&gt;prevFontStyle = $this-&gt;FontStyle;</span>
<a name="l02274"></a>02274   <span class="comment">// Select a font; size given in points</span>
<a name="l02275"></a>02275 
<a name="l02276"></a>02276   <span class="keywordflow">if</span>($family==<span class="stringliteral">&#39;&#39;</span>) { 
<a name="l02277"></a>02277     <span class="keywordflow">if</span> ($this-&gt;FontFamily) { $family=$this-&gt;FontFamily; }
<a name="l02278"></a>02278     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;default_font) { $family=$this-&gt;default_font; }
<a name="l02279"></a>02279     <span class="keywordflow">else</span> { $this-&gt;Error(<span class="stringliteral">&quot;No font or default font set!&quot;</span>); }
<a name="l02280"></a>02280   }
<a name="l02281"></a>02281 
<a name="l02282"></a>02282   <span class="comment">// mPDF 4.2</span>
<a name="l02283"></a>02283   $this-&gt;ReqFontStyle = $style; <span class="comment">// required or requested style - used later for artificial bold/italic</span>
<a name="l02284"></a>02284 
<a name="l02285"></a>02285   <span class="keywordflow">if</span> (($family == <span class="stringliteral">&#39;symbol&#39;</span>) || ($family == <span class="stringliteral">&#39;zapfdingbats&#39;</span>)  || ($family == <span class="stringliteral">&#39;times&#39;</span>)  || ($family == <span class="stringliteral">&#39;courier&#39;</span>) || ($family == <span class="stringliteral">&#39;helvetica&#39;</span>)) { 
<a name="l02286"></a>02286     <span class="comment">// mPDF 4.2.018</span>
<a name="l02287"></a>02287     <span class="keywordflow">if</span> ($this-&gt;PDFA) {
<a name="l02288"></a>02288        <span class="keywordflow">if</span> ($family == <span class="stringliteral">&#39;symbol&#39;</span> || $family == <span class="stringliteral">&#39;zapfdingbats&#39;</span>) { 
<a name="l02289"></a>02289       $this-&gt;Error(<span class="stringliteral">&quot;Symbol and Zapfdingbats cannot be embedded in mPDF (required for PDFA1-b).&quot;</span>);
<a name="l02290"></a>02290        }
<a name="l02291"></a>02291        <span class="keywordflow">if</span> ($family == <span class="stringliteral">&#39;times&#39;</span>  || $family == <span class="stringliteral">&#39;courier&#39;</span>) { 
<a name="l02292"></a>02292       <span class="keywordflow">if</span> (!$this-&gt;PDFAauto) { $this-&gt;PDFAwarnings[] = <span class="stringliteral">&quot;Core Adobe font &quot;</span>.ucfirst($family).<span class="stringliteral">&quot; cannot be embedded in mPDF, which is required for PDFA1-b. (Embedded font will be substituted.)&quot;</span>; }
<a name="l02293"></a>02293       <span class="keywordflow">if</span> ($family == <span class="stringliteral">&#39;times&#39;</span>) { $family = <span class="stringliteral">&#39;serif&#39;</span>; }
<a name="l02294"></a>02294       <span class="keywordflow">if</span> ($family == <span class="stringliteral">&#39;courier&#39;</span>) { $family = <span class="stringliteral">&#39;mono&#39;</span>; }
<a name="l02295"></a>02295        }
<a name="l02296"></a>02296        $this-&gt;usingCoreFont = <span class="keyword">false</span>;
<a name="l02297"></a>02297     }
<a name="l02298"></a>02298     <span class="keywordflow">else</span> { $this-&gt;usingCoreFont = <span class="keyword">true</span>; }
<a name="l02299"></a>02299   }
<a name="l02300"></a>02300   <span class="keywordflow">else</span> {  $this-&gt;usingCoreFont = <span class="keyword">false</span>; }
<a name="l02301"></a>02301 
<a name="l02302"></a>02302   <span class="keywordflow">if</span>($family==<span class="stringliteral">&#39;symbol&#39;</span> or $family==<span class="stringliteral">&#39;zapfdingbats&#39;</span>) { $style=<span class="stringliteral">&#39;&#39;</span>; }
<a name="l02303"></a>02303   $style=strtoupper($style);
<a name="l02304"></a>02304   <span class="keywordflow">if</span>(is_int(strpos($style,<span class="charliteral">&#39;U&#39;</span>))) {
<a name="l02305"></a>02305     $this-&gt;underline=<span class="keyword">true</span>;
<a name="l02306"></a>02306     $style=str_replace(<span class="charliteral">&#39;U&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$style);
<a name="l02307"></a>02307   }
<a name="l02308"></a>02308   <span class="keywordflow">else</span> { $this-&gt;underline=<span class="keyword">false</span>; }
<a name="l02309"></a>02309   <span class="keywordflow">if</span> ($style==<span class="stringliteral">&#39;IB&#39;</span>) $style=<span class="stringliteral">&#39;BI&#39;</span>;
<a name="l02310"></a>02310   <span class="keywordflow">if</span> ($size==0) $size=$this-&gt;FontSizePt;
<a name="l02311"></a>02311 
<a name="l02312"></a>02312   $fontkey=$family.$style;
<a name="l02313"></a>02313 
<a name="l02314"></a>02314   <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02315"></a>02315     <span class="comment">// CJK fonts</span>
<a name="l02316"></a>02316     <span class="keywordflow">if</span> (!in_array($fontkey,$this-&gt;available_unifonts)) {
<a name="l02317"></a>02317       <span class="comment">// If font[nostyle] exists - set it</span>
<a name="l02318"></a>02318       <span class="keywordflow">if</span> (in_array($family,$this-&gt;available_unifonts)) {
<a name="l02319"></a>02319         $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02320"></a>02320       }
<a name="l02321"></a>02321 
<a name="l02322"></a>02322       <span class="comment">// Else if only one font available - set it (assumes if only one font available it will not have a style)</span>
<a name="l02323"></a>02323       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($this-&gt;available_unifonts) == 1) {
<a name="l02324"></a>02324         $family = $this-&gt;available_unifonts[0];
<a name="l02325"></a>02325         $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02326"></a>02326       }
<a name="l02327"></a>02327 
<a name="l02328"></a>02328       <span class="keywordflow">else</span> {
<a name="l02329"></a>02329         $found = 0;
<a name="l02330"></a>02330         <span class="comment">// else substitute font of similar type</span>
<a name="l02331"></a>02331         <span class="keywordflow">if</span> (in_array($family,$this-&gt;sans_fonts)) { 
<a name="l02332"></a>02332           $i = array_intersect($this-&gt;sans_fonts,$this-&gt;available_unifonts);
<a name="l02333"></a>02333           <span class="keywordflow">if</span> (count($i)) {
<a name="l02334"></a>02334             $i = array_values($i);
<a name="l02335"></a>02335             <span class="comment">// with requested style if possible</span>
<a name="l02336"></a>02336             <span class="keywordflow">if</span> (!in_array(($i[0].$style),$this-&gt;available_unifonts)) {
<a name="l02337"></a>02337               $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02338"></a>02338             }
<a name="l02339"></a>02339             $family = $i[0]; 
<a name="l02340"></a>02340             $found = 1;
<a name="l02341"></a>02341           }
<a name="l02342"></a>02342         }
<a name="l02343"></a>02343         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($family,$this-&gt;serif_fonts)) { 
<a name="l02344"></a>02344           $i = array_intersect($this-&gt;serif_fonts,$this-&gt;available_unifonts);
<a name="l02345"></a>02345           <span class="keywordflow">if</span> (count($i)) {
<a name="l02346"></a>02346             $i = array_values($i);
<a name="l02347"></a>02347             <span class="comment">// with requested style if possible</span>
<a name="l02348"></a>02348             <span class="keywordflow">if</span> (!in_array(($i[0].$style),$this-&gt;available_unifonts)) {
<a name="l02349"></a>02349               $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02350"></a>02350             }
<a name="l02351"></a>02351             $family = $i[0]; 
<a name="l02352"></a>02352             $found = 1;
<a name="l02353"></a>02353           }
<a name="l02354"></a>02354         }
<a name="l02355"></a>02355         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($family,$this-&gt;mono_fonts)) {
<a name="l02356"></a>02356           $i = array_intersect($this-&gt;mono_fonts,$this-&gt;available_unifonts);
<a name="l02357"></a>02357           <span class="keywordflow">if</span> (count($i)) {
<a name="l02358"></a>02358             $i = array_values($i);
<a name="l02359"></a>02359             <span class="comment">// with requested style if possible</span>
<a name="l02360"></a>02360             <span class="keywordflow">if</span> (!in_array(($i[0].$style),$this-&gt;available_unifonts)) {
<a name="l02361"></a>02361               $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02362"></a>02362             }
<a name="l02363"></a>02363             $family = $i[0]; 
<a name="l02364"></a>02364             $found = 1;
<a name="l02365"></a>02365           }
<a name="l02366"></a>02366         }
<a name="l02367"></a>02367 
<a name="l02368"></a>02368         <span class="keywordflow">if</span> (!$found) {
<a name="l02369"></a>02369           <span class="comment">// set first available font</span>
<a name="l02370"></a>02370           $fs = $this-&gt;available_unifonts[0];
<a name="l02371"></a>02371           <span class="comment">// mPDF 4.0 Added 0-9</span>
<a name="l02372"></a>02372           preg_match(<span class="stringliteral">&#39;/^([a-z_0-9]+)([BI]{0,2})$/&#39;</span>,$fs,$fas);
<a name="l02373"></a>02373           <span class="comment">// with requested style if possible</span>
<a name="l02374"></a>02374           $ws = $fas[1].$style;
<a name="l02375"></a>02375           <span class="keywordflow">if</span> (in_array($ws,$this-&gt;available_unifonts)) {
<a name="l02376"></a>02376             $family = $fas[1]; <span class="comment">// leave $style as is</span>
<a name="l02377"></a>02377           }
<a name="l02378"></a>02378           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($fas[1],$this-&gt;available_unifonts)) {
<a name="l02379"></a>02379           <span class="comment">// or without style</span>
<a name="l02380"></a>02380             $family = $fas[1];
<a name="l02381"></a>02381             $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02382"></a>02382           }
<a name="l02383"></a>02383           <span class="keywordflow">else</span> {
<a name="l02384"></a>02384           <span class="comment">// or with the style specified </span>
<a name="l02385"></a>02385             $family = $fas[1];
<a name="l02386"></a>02386             $style = $fas[2];
<a name="l02387"></a>02387           }
<a name="l02388"></a>02388         }
<a name="l02389"></a>02389       }
<a name="l02390"></a>02390 
<a name="l02391"></a>02391       $this-&gt;isCJK = <span class="keyword">false</span>;
<a name="l02392"></a>02392       $this-&gt;setMBencoding(<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l02393"></a>02393 
<a name="l02394"></a>02394       $fontkey = $family.$style; 
<a name="l02395"></a>02395     }
<a name="l02396"></a>02396     <span class="keywordflow">else</span> {
<a name="l02397"></a>02397       $this-&gt;isCJK = <span class="keyword">false</span>;
<a name="l02398"></a>02398       $this-&gt;setMBencoding(<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l02399"></a>02399     }
<a name="l02400"></a>02400 
<a name="l02401"></a>02401     <span class="comment">// try to add font (if not already added)</span>
<a name="l02402"></a>02402     $this-&gt;AddFont($family, $style);
<a name="l02403"></a>02403 
<a name="l02404"></a>02404     <span class="comment">//Test if font is already selected</span>
<a name="l02405"></a>02405     <span class="keywordflow">if</span>(($this-&gt;FontFamily == $family) AND ($this-&gt;FontStyle == $style) AND ($this-&gt;FontSizePt == $size) &amp;&amp; !$forcewrite) {
<a name="l02406"></a>02406       <span class="keywordflow">return</span> $family;
<a name="l02407"></a>02407     }
<a name="l02408"></a>02408 
<a name="l02409"></a>02409     $fontkey = $family.$style; 
<a name="l02410"></a>02410     <span class="comment">//Select it</span>
<a name="l02411"></a>02411     $this-&gt;FontFamily = $family;
<a name="l02412"></a>02412     $this-&gt;FontStyle = $style;
<a name="l02413"></a>02413     $this-&gt;FontSizePt = $size;
<a name="l02414"></a>02414     $this-&gt;FontSize = $size / $this-&gt;k;
<a name="l02415"></a>02415     $this-&gt;CurrentFont = &amp;$this-&gt;fonts[$fontkey];
<a name="l02416"></a>02416     <span class="keywordflow">if</span> ($write) { 
<a name="l02417"></a>02417       $fontout = (sprintf(<span class="stringliteral">&#39;BT /F%d %.3f Tf ET&#39;</span>, $this-&gt;CurrentFont[<span class="charliteral">&#39;i&#39;</span>], $this-&gt;FontSizePt));
<a name="l02418"></a>02418       <span class="comment">// Edited mPDF 3.0</span>
<a name="l02419"></a>02419       <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] != $fontout) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($fontout); }
<a name="l02420"></a>02420       $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] = $fontout;
<a name="l02421"></a>02421     }
<a name="l02422"></a>02422 
<a name="l02423"></a>02423 
<a name="l02424"></a>02424 
<a name="l02425"></a>02425     <span class="comment">// Added - currentfont (lowercase) used in HTML2PDF</span>
<a name="l02426"></a>02426     $this-&gt;currentfontfamily=$family;
<a name="l02427"></a>02427     $this-&gt;currentfontsize=$size;
<a name="l02428"></a>02428     $this-&gt;currentfontstyle=$style.($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l02429"></a>02429   }
<a name="l02430"></a>02430 
<a name="l02431"></a>02431   <span class="keywordflow">else</span> {  <span class="comment">// if not unicode/CJK - or core embedded font</span>
<a name="l02432"></a>02432 
<a name="l02433"></a>02433     <span class="comment">// mPDF 4.2.018</span>
<a name="l02434"></a>02434     <span class="keywordflow">if</span> ($this-&gt;PDFA &amp;&amp; $this-&gt;useOnlyCoreFonts) {
<a name="l02435"></a>02435       $this-&gt;Error(<span class="stringliteral">&#39;Core Adobe fonts cannot be embedded in mPDF (required for PDFA1-b) - cannot use &lt;i&gt;$mpdf-&gt;useOnlyCoreFonts&lt;/i&gt;.&#39;</span>);
<a name="l02436"></a>02436     }
<a name="l02437"></a>02437     $this-&gt;isCJK = <span class="keyword">false</span>;
<a name="l02438"></a>02438     $this-&gt;setMBencoding($this-&gt;codepage);
<a name="l02439"></a>02439 
<a name="l02440"></a>02440     <span class="comment">//Test if font is already selected</span>
<a name="l02441"></a>02441     <span class="keywordflow">if</span>(($this-&gt;FontFamily == $family) AND ($this-&gt;FontStyle == $style) AND ($this-&gt;FontSizePt == $size) &amp;&amp; !$forcewrite) {
<a name="l02442"></a>02442       <span class="keywordflow">return</span> $family;
<a name="l02443"></a>02443     }
<a name="l02444"></a>02444 
<a name="l02445"></a>02445     <span class="comment">// ALWAYS SUBSTITUTE ARIAL TIMES COURIER IN 1252</span>
<a name="l02446"></a>02446     <span class="keywordflow">if</span> (!isset($this-&gt;CoreFonts[$fontkey]) &amp;&amp; ($this-&gt;useOnlyCoreFonts) &amp;&amp; ($this-&gt;codepage == <span class="stringliteral">&#39;win-1252&#39;</span>)) {
<a name="l02447"></a>02447       <span class="keywordflow">if</span> (in_array($family,$this-&gt;serif_fonts)) { $family = <span class="stringliteral">&#39;times&#39;</span>; }
<a name="l02448"></a>02448       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($family,$this-&gt;mono_fonts)) { $family = <span class="stringliteral">&#39;courier&#39;</span>; }
<a name="l02449"></a>02449       <span class="keywordflow">else</span> { $family = <span class="stringliteral">&#39;helvetica&#39;</span>; }
<a name="l02450"></a>02450       $this-&gt;usingCoreFont = <span class="keyword">true</span>;
<a name="l02451"></a>02451       $fontkey = $family.$style; 
<a name="l02452"></a>02452     }
<a name="l02453"></a>02453 
<a name="l02454"></a>02454     <span class="comment">// Test to see if requested font/style is available - or substitute</span>
<a name="l02455"></a>02455     <span class="keywordflow">if</span> (!in_array($fontkey,$this-&gt;available_fonts) &amp;&amp; (!$this-&gt;usingCoreFont) ) {
<a name="l02456"></a>02456 
<a name="l02457"></a>02457       <span class="comment">// If font[nostyle] exists - set it</span>
<a name="l02458"></a>02458       <span class="keywordflow">if</span> (in_array($family,$this-&gt;available_fonts)) {
<a name="l02459"></a>02459         $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02460"></a>02460       }
<a name="l02461"></a>02461       <span class="comment">// Else if only one font available - set it (assumes if only one font available it will not have a style)</span>
<a name="l02462"></a>02462       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($this-&gt;available_fonts) == 1) {
<a name="l02463"></a>02463         $family = $this-&gt;available_fonts[0];
<a name="l02464"></a>02464         $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02465"></a>02465       }
<a name="l02466"></a>02466       <span class="keywordflow">else</span> {
<a name="l02467"></a>02467         $found = 0;
<a name="l02468"></a>02468         <span class="comment">// else substitute font of similar type</span>
<a name="l02469"></a>02469         <span class="keywordflow">if</span> (in_array($family,$this-&gt;sans_fonts)) { 
<a name="l02470"></a>02470           $i = array_intersect($this-&gt;sans_fonts,$this-&gt;available_fonts);
<a name="l02471"></a>02471           <span class="keywordflow">if</span> (count($i)) {
<a name="l02472"></a>02472             $i = array_values($i);
<a name="l02473"></a>02473             <span class="comment">// with requested style if possible</span>
<a name="l02474"></a>02474             <span class="keywordflow">if</span> (!in_array(($i[0].$style),$this-&gt;available_fonts)) {
<a name="l02475"></a>02475               $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02476"></a>02476             }
<a name="l02477"></a>02477             $family = $i[0]; 
<a name="l02478"></a>02478             $found = 1;
<a name="l02479"></a>02479           }
<a name="l02480"></a>02480         }
<a name="l02481"></a>02481         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($family,$this-&gt;serif_fonts)) { 
<a name="l02482"></a>02482           $i = array_intersect($this-&gt;serif_fonts,$this-&gt;available_fonts);
<a name="l02483"></a>02483           <span class="keywordflow">if</span> (count($i)) {
<a name="l02484"></a>02484             $i = array_values($i);
<a name="l02485"></a>02485             <span class="comment">// with requested style if possible</span>
<a name="l02486"></a>02486             <span class="keywordflow">if</span> (!in_array(($i[0].$style),$this-&gt;available_fonts)) {
<a name="l02487"></a>02487               $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02488"></a>02488             }
<a name="l02489"></a>02489             $family = $i[0]; 
<a name="l02490"></a>02490             $found = 1;
<a name="l02491"></a>02491           }
<a name="l02492"></a>02492         }
<a name="l02493"></a>02493         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($family,$this-&gt;mono_fonts)) {
<a name="l02494"></a>02494           $i = array_intersect($this-&gt;mono_fonts,$this-&gt;available_fonts);
<a name="l02495"></a>02495           <span class="keywordflow">if</span> (count($i)) {
<a name="l02496"></a>02496             $i = array_values($i);
<a name="l02497"></a>02497             <span class="comment">// with requested style if possible</span>
<a name="l02498"></a>02498             <span class="keywordflow">if</span> (!in_array(($i[0].$style),$this-&gt;available_fonts)) {
<a name="l02499"></a>02499               $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02500"></a>02500             }
<a name="l02501"></a>02501             $family = $i[0]; 
<a name="l02502"></a>02502             $found = 1;
<a name="l02503"></a>02503           }
<a name="l02504"></a>02504         }
<a name="l02505"></a>02505         <span class="keywordflow">if</span> (!$found) {
<a name="l02506"></a>02506           <span class="comment">// set first available font</span>
<a name="l02507"></a>02507           $fs = $this-&gt;available_unifonts[0];
<a name="l02508"></a>02508           <span class="comment">// mPDF 4.0 Added 0-9</span>
<a name="l02509"></a>02509           preg_match(<span class="stringliteral">&#39;/^([a-z_0-9]+)([BI]{0,2})$/&#39;</span>,$fs,$fas);
<a name="l02510"></a>02510           <span class="comment">// with requested style if possible</span>
<a name="l02511"></a>02511           $ws = $fas[1].$style;
<a name="l02512"></a>02512           <span class="keywordflow">if</span> (in_array($ws,$this-&gt;available_fonts)) {
<a name="l02513"></a>02513             $family = $fas[1]; <span class="comment">// leave $style as is</span>
<a name="l02514"></a>02514           }
<a name="l02515"></a>02515           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($fas[1],$this-&gt;available_fonts)) {
<a name="l02516"></a>02516           <span class="comment">// or without style</span>
<a name="l02517"></a>02517             $family = $fas[1];
<a name="l02518"></a>02518             $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02519"></a>02519           }
<a name="l02520"></a>02520           <span class="keywordflow">else</span> {
<a name="l02521"></a>02521           <span class="comment">// or with the style specified </span>
<a name="l02522"></a>02522             $family = $fas[1];
<a name="l02523"></a>02523             $style = $fas[2];
<a name="l02524"></a>02524           }
<a name="l02525"></a>02525         }
<a name="l02526"></a>02526       }
<a name="l02527"></a>02527       $fontkey = $family.$style; 
<a name="l02528"></a>02528     }
<a name="l02529"></a>02529 
<a name="l02530"></a>02530     <span class="comment">// mPDF 4.0</span>
<a name="l02531"></a>02531     <span class="keywordflow">if</span>(!isset($this-&gt;fonts[$fontkey]))  {
<a name="l02532"></a>02532       <span class="comment">// STANDARD CORE FONTS</span>
<a name="l02533"></a>02533       <span class="keywordflow">if</span> (isset($this-&gt;CoreFonts[$fontkey])) {
<a name="l02534"></a>02534         <span class="comment">//Load metric file</span>
<a name="l02535"></a>02535         $file=$family;
<a name="l02536"></a>02536         <span class="keywordflow">if</span>($family==<span class="stringliteral">&#39;times&#39;</span> || $family==<span class="stringliteral">&#39;helvetica&#39;</span> || $family==<span class="stringliteral">&#39;courier&#39;</span>) { $file.=strtolower($style); }
<a name="l02537"></a>02537         $file.=<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l02538"></a>02538         include(_MPDF_PATH.<span class="stringliteral">&#39;font/&#39;</span>.$file);
<a name="l02539"></a>02539         <span class="keywordflow">if</span>(!isset($cw)) { $this-&gt;Error(<span class="stringliteral">&#39;Could not include font metric file&#39;</span>); }
<a name="l02540"></a>02540         $i=count($this-&gt;fonts)+$this-&gt;extraFontSubsets+1;
<a name="l02541"></a>02541         $this-&gt;fonts[$fontkey]=array(<span class="charliteral">&#39;i&#39;</span>=&gt;$i,<span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;core&#39;</span>,<span class="stringliteral">&#39;name&#39;</span>=&gt;$this-&gt;CoreFonts[$fontkey],<span class="stringliteral">&#39;desc&#39;</span>=&gt;$desc,<span class="stringliteral">&#39;up&#39;</span>=&gt;$up,<span class="stringliteral">&#39;ut&#39;</span>=&gt;$ut,<span class="stringliteral">&#39;cw&#39;</span>=&gt;$cw);
<a name="l02542"></a>02542       }
<a name="l02543"></a>02543       <span class="keywordflow">else</span> {
<a name="l02544"></a>02544         <span class="comment">// try to add font </span>
<a name="l02545"></a>02545         $this-&gt;AddFont($family, $style);
<a name="l02546"></a>02546       }
<a name="l02547"></a>02547     }
<a name="l02548"></a>02548     <span class="comment">//Test if font is already selected</span>
<a name="l02549"></a>02549     <span class="keywordflow">if</span>(($this-&gt;FontFamily == $family) AND ($this-&gt;FontStyle == $style) AND ($this-&gt;FontSizePt == $size) &amp;&amp; !$forcewrite) {
<a name="l02550"></a>02550       <span class="keywordflow">return</span> $family;
<a name="l02551"></a>02551     }
<a name="l02552"></a>02552     <span class="comment">//Select it</span>
<a name="l02553"></a>02553     $this-&gt;FontFamily=$family;
<a name="l02554"></a>02554     $this-&gt;FontStyle=$style;
<a name="l02555"></a>02555     $this-&gt;FontSizePt=$size;
<a name="l02556"></a>02556     $this-&gt;FontSize=$size/$this-&gt;k;
<a name="l02557"></a>02557     $this-&gt;CurrentFont=&amp;$this-&gt;fonts[$fontkey];
<a name="l02558"></a>02558     <span class="keywordflow">if</span> ($write) { 
<a name="l02559"></a>02559       $fontout = (sprintf(<span class="stringliteral">&#39;BT /F%d %.3f Tf ET&#39;</span>, $this-&gt;CurrentFont[<span class="charliteral">&#39;i&#39;</span>], $this-&gt;FontSizePt));
<a name="l02560"></a>02560       <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] != $fontout) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($fontout); }
<a name="l02561"></a>02561       $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] = $fontout;
<a name="l02562"></a>02562     }
<a name="l02563"></a>02563     <span class="comment">// Added - currentfont (lowercase) used in HTML2PDF</span>
<a name="l02564"></a>02564     $this-&gt;currentfontfamily=$family;
<a name="l02565"></a>02565     $this-&gt;currentfontsize=$size;
<a name="l02566"></a>02566     $this-&gt;currentfontstyle=$style.($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l02567"></a>02567 
<a name="l02568"></a>02568   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02569"></a>02569   <span class="keywordflow">return</span> $family;
<a name="l02570"></a>02570 }
<a name="l02571"></a>02571 
<a name="l02572"></a>02572 function SetFontSize($size,$write=<span class="keyword">true</span>) {
<a name="l02573"></a>02573   <span class="comment">//Set font size in points</span>
<a name="l02574"></a>02574   <span class="keywordflow">if</span>($this-&gt;FontSizePt==$size) <span class="keywordflow">return</span>;
<a name="l02575"></a>02575   $this-&gt;FontSizePt=$size;
<a name="l02576"></a>02576   $this-&gt;FontSize=$size/$this-&gt;k;
<a name="l02577"></a>02577   $this-&gt;currentfontsize=$size;
<a name="l02578"></a>02578     <span class="keywordflow">if</span> ($write) { 
<a name="l02579"></a>02579       $fontout = (sprintf(<span class="stringliteral">&#39;BT /F%d %.3f Tf ET&#39;</span>, $this-&gt;CurrentFont[<span class="charliteral">&#39;i&#39;</span>], $this-&gt;FontSizePt));
<a name="l02580"></a>02580       <span class="comment">// Edited mPDF 3.0</span>
<a name="l02581"></a>02581       <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] != $fontout) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($fontout); }
<a name="l02582"></a>02582       $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] = $fontout;
<a name="l02583"></a>02583     }
<a name="l02584"></a>02584 }
<a name="l02585"></a>02585 
<a name="l02586"></a>02586 function AddLink() {
<a name="l02587"></a>02587   <span class="comment">//Create a new internal link</span>
<a name="l02588"></a>02588   $n=count($this-&gt;links)+1;
<a name="l02589"></a>02589   $this-&gt;links[$n]=array(0,0);
<a name="l02590"></a>02590   <span class="keywordflow">return</span> $n;
<a name="l02591"></a>02591 }
<a name="l02592"></a>02592 
<a name="l02593"></a>02593 function SetLink($link,$y=0,$page=-1) {
<a name="l02594"></a>02594   <span class="comment">//Set destination of internal link</span>
<a name="l02595"></a>02595   <span class="keywordflow">if</span>($y==-1) $y=$this-&gt;y;
<a name="l02596"></a>02596   <span class="keywordflow">if</span>($page==-1) $page=$this-&gt;page;
<a name="l02597"></a>02597   $this-&gt;links[$link]=array($page,$y);
<a name="l02598"></a>02598 }
<a name="l02599"></a>02599 
<a name="l02600"></a>02600 function Link($x,$y,$w,$h,$link) {
<a name="l02601"></a>02601   <span class="keywordflow">if</span> ($this-&gt;keep_block_together) { <span class="comment">// Save to array - don&#39;t write yet</span>
<a name="l02602"></a>02602     $this-&gt;ktLinks[$this-&gt;page][]=array($x*$this-&gt;k,$this-&gt;hPt-$y*$this-&gt;k,$w*$this-&gt;k,$h*$this-&gt;k,$link);
<a name="l02603"></a>02603     <span class="keywordflow">return</span>;
<a name="l02604"></a>02604   }
<a name="l02605"></a>02605   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) { <span class="comment">// *TABLES*</span>
<a name="l02606"></a>02606     $this-&gt;tbrot_Links[$this-&gt;page][]=array($x*$this-&gt;k,$this-&gt;hPt-$y*$this-&gt;k,$w*$this-&gt;k,$h*$this-&gt;k,$link);  <span class="comment">// *TABLES*</span>
<a name="l02607"></a>02607     <span class="keywordflow">return</span>; <span class="comment">// *TABLES*</span>
<a name="l02608"></a>02608   } <span class="comment">// *TABLES*</span>
<a name="l02609"></a>02609   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l02610"></a>02610     $this-&gt;kwt_Links[$this-&gt;page][]=array($x*$this-&gt;k,$this-&gt;hPt-$y*$this-&gt;k,$w*$this-&gt;k,$h*$this-&gt;k,$link);
<a name="l02611"></a>02611     <span class="keywordflow">return</span>;
<a name="l02612"></a>02612   }
<a name="l02613"></a>02613   <span class="comment">// mPDF 4.0</span>
<a name="l02614"></a>02614   <span class="keywordflow">if</span> ($this-&gt;writingHTMLheader || $this-&gt;writingHTMLfooter) {
<a name="l02615"></a>02615     $this-&gt;HTMLheaderPageLinks[]=array($x*$this-&gt;k,$this-&gt;hPt-$y*$this-&gt;k,$w*$this-&gt;k,$h*$this-&gt;k,$link);
<a name="l02616"></a>02616     <span class="keywordflow">return</span>;
<a name="l02617"></a>02617   }
<a name="l02618"></a>02618   <span class="comment">//Put a link on the page</span>
<a name="l02619"></a>02619   $this-&gt;PageLinks[$this-&gt;page][]=array($x*$this-&gt;k,$this-&gt;hPt-$y*$this-&gt;k,$w*$this-&gt;k,$h*$this-&gt;k,$link);
<a name="l02620"></a>02620   <span class="comment">// Save cross-reference to Column buffer</span>
<a name="l02621"></a>02621 
<a name="l02622"></a>02622 }
<a name="l02623"></a>02623 
<a name="l02624"></a>02624 function Text($x,$y,$txt) {
<a name="l02625"></a>02625   <span class="comment">// Output a string</span>
<a name="l02626"></a>02626   <span class="comment">// Called (only) by Watermark</span>
<a name="l02627"></a>02627   <span class="comment">// Expects input to be mb_encoded if necessary and RTL reversed</span>
<a name="l02628"></a>02628   <span class="comment">// NON_BREAKING SPACE</span>
<a name="l02629"></a>02629   <span class="comment">// mPDF 4.0 </span>
<a name="l02630"></a>02630   $this-&gt;CurrentFont[<span class="stringliteral">&#39;used&#39;</span>]= <span class="keyword">true</span>;
<a name="l02631"></a>02631   <span class="comment">// mPDF 4.0 Subset fonts are unibyte at output stage</span>
<a name="l02632"></a>02632   <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont &amp;&amp; (!$this-&gt;useSubsets || $this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>]!=<span class="stringliteral">&#39;Type1subset&#39;</span>)) {
<a name="l02633"></a>02633         $txt2 = str_replace($this-&gt;chrs[194].$this-&gt;chrs[160],$this-&gt;chrs[32],$txt); 
<a name="l02634"></a>02634     <span class="keywordflow">if</span> (!$this-&gt;usingCoreFont) {
<a name="l02635"></a>02635       <span class="comment">//Convert string to UTF-16BE without BOM</span>
<a name="l02636"></a>02636       $txt2= $this-&gt;UTF8ToUTF16BE($txt2, <span class="keyword">false</span>);
<a name="l02637"></a>02637     }
<a name="l02638"></a>02638     $s=sprintf(<span class="stringliteral">&#39;BT %.3f %.3f Td (%s) Tj ET&#39;</span>,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,$this-&gt;_escape($txt2));
<a name="l02639"></a>02639   }
<a name="l02640"></a>02640   <span class="comment">// mPDF 4.0 Subset fonts</span>
<a name="l02641"></a>02641   <span class="keywordflow">else</span>
<a name="l02642"></a>02642   <span class="keywordflow">if</span> ($this-&gt;useSubsets &amp;&amp; $this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;Type1subset&#39;</span> &amp;&amp; !$this-&gt;isCJK &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02643"></a>02643         $txt2 = str_replace($this-&gt;chrs[160],$this-&gt;chrs[32],$txt);
<a name="l02644"></a>02644     $txt2 = $this-&gt;UTF8toSubset($txt2);
<a name="l02645"></a>02645     $s=sprintf(<span class="stringliteral">&#39;BT %.3f %.3f Td %s Tj ET&#39;</span>,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,$txt2);
<a name="l02646"></a>02646   }
<a name="l02647"></a>02647   <span class="keywordflow">else</span> {
<a name="l02648"></a>02648         $txt2 = str_replace($this-&gt;chrs[160],$this-&gt;chrs[32],$txt);
<a name="l02649"></a>02649     $s=sprintf(<span class="stringliteral">&#39;BT %.3f %.3f Td (%s) Tj ET&#39;</span>,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,$this-&gt;_escape($txt2));
<a name="l02650"></a>02650   }
<a name="l02651"></a>02651   <span class="keywordflow">if</span>($this-&gt;underline and $txt!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02652"></a>02652     $s.=<span class="charliteral">&#39; &#39;</span>.$this-&gt;_dounderline($x,$y + (0.1* $this-&gt;FontSize),$txt);
<a name="l02653"></a>02653   }
<a name="l02654"></a>02654   <span class="keywordflow">if</span>($this-&gt;ColorFlag) $s=<span class="stringliteral">&#39;q &#39;</span>.$this-&gt;TextColor.<span class="charliteral">&#39; &#39;</span>.$s.<span class="stringliteral">&#39; Q&#39;</span>;
<a name="l02655"></a>02655   $this-&gt;_out($s);
<a name="l02656"></a>02656 }
<a name="l02657"></a>02657 
<a name="l02658"></a>02658 
<a name="l02659"></a>02659 <span class="comment">// mPDF 4.0</span>
<a name="l02660"></a>02660 function ResetSpacing() {
<a name="l02661"></a>02661   <span class="keywordflow">if</span> ($this-&gt;ws != 0) { $this-&gt;_out(<span class="stringliteral">&#39;BT 0 Tw ET&#39;</span>); }
<a name="l02662"></a>02662   $this-&gt;ws=0;
<a name="l02663"></a>02663   <span class="keywordflow">if</span> ($this-&gt;charspacing != 0) { $this-&gt;_out(<span class="stringliteral">&#39;BT 0 Tc ET&#39;</span>); }
<a name="l02664"></a>02664   $this-&gt;charspacing=0;
<a name="l02665"></a>02665 }
<a name="l02666"></a>02666 
<a name="l02667"></a>02667 <span class="comment">// mPDF 4.0</span>
<a name="l02668"></a>02668 function SetSpacing($cs,$ws) {
<a name="l02669"></a>02669   <span class="keywordflow">if</span> ($cs) { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;BT %.3f Tc ET&#39;</span>,$cs)); }
<a name="l02670"></a>02670   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;charspacing != 0) { $this-&gt;_out(<span class="stringliteral">&#39;BT 0 Tc ET&#39;</span>); }
<a name="l02671"></a>02671   $this-&gt;charspacing=$cs;
<a name="l02672"></a>02672   <span class="keywordflow">if</span> ($ws) { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;BT %.3f Tw ET&#39;</span>,$ws)); }
<a name="l02673"></a>02673   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;ws != 0) { $this-&gt;_out(<span class="stringliteral">&#39;BT 0 Tw ET&#39;</span>); }
<a name="l02674"></a>02674   $this-&gt;ws=$ws;
<a name="l02675"></a>02675 }
<a name="l02676"></a>02676 
<a name="l02677"></a>02677 <span class="comment">// WORD SPACING</span>
<a name="l02678"></a>02678 function GetJspacing($nc,$ns,$w) {
<a name="l02679"></a>02679   $ws = 0; 
<a name="l02680"></a>02680   $charspacing = 0;
<a name="l02681"></a>02681   $ww = $this-&gt;jSWord;
<a name="l02682"></a>02682   $ncx = $nc-1;
<a name="l02683"></a>02683   <span class="keywordflow">if</span> ($nc == 0 &amp;&amp; $ns == 0) { <span class="keywordflow">return</span> array(0,0); }
<a name="l02684"></a>02684   <span class="keywordflow">if</span> ($nc==1) { $charspacing = $w; }
<a name="l02685"></a>02685   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;jSpacing == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l02686"></a>02686     <span class="keywordflow">if</span> ($nc) { $charspacing = $w / ($ncx ); }
<a name="l02687"></a>02687   }
<a name="l02688"></a>02688   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;jSpacing == <span class="charliteral">&#39;W&#39;</span>) {
<a name="l02689"></a>02689     <span class="keywordflow">if</span> ($ns) { $ws = $w / $ns; }
<a name="l02690"></a>02690   }
<a name="l02691"></a>02691   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$ns) {
<a name="l02692"></a>02692     <span class="keywordflow">if</span> ($nc) { $charspacing = $w / ($ncx ); }
<a name="l02693"></a>02693     <span class="keywordflow">if</span> (($this-&gt;jSmaxChar &gt; 0) &amp;&amp; ($charspacing &gt; $this-&gt;jSmaxChar)) { 
<a name="l02694"></a>02694       $charspacing = $this-&gt;jSmaxChar;
<a name="l02695"></a>02695     }
<a name="l02696"></a>02696   }
<a name="l02697"></a>02697   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($ns == ($ncx )) {
<a name="l02698"></a>02698     $charspacing = $w / $ns;
<a name="l02699"></a>02699   }
<a name="l02700"></a>02700   <span class="keywordflow">else</span> {
<a name="l02701"></a>02701     <span class="keywordflow">if</span> ($nc) { 
<a name="l02702"></a>02702        <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02703"></a>02703       $cs = ($w * (1 - $this-&gt;jSWord)) / ($ncx -$ns); 
<a name="l02704"></a>02704       <span class="keywordflow">if</span> (($this-&gt;jSmaxChar &gt; 0) &amp;&amp; ($cs &gt; $this-&gt;jSmaxChar)) {
<a name="l02705"></a>02705         $cs = $this-&gt;jSmaxChar;
<a name="l02706"></a>02706         $ww = 1 - (($cs * ($ncx -$ns))/$w);
<a name="l02707"></a>02707       }
<a name="l02708"></a>02708       $charspacing = $cs; 
<a name="l02709"></a>02709       $ws = (($w * ($ww) ) / $ns) - $charspacing;
<a name="l02710"></a>02710        }
<a name="l02711"></a>02711        <span class="keywordflow">else</span> {
<a name="l02712"></a>02712       $cs = ($w * (1 - $this-&gt;jSWord)) / ($ncx );
<a name="l02713"></a>02713       <span class="keywordflow">if</span> (($this-&gt;jSmaxChar &gt; 0) &amp;&amp; ($cs &gt; $this-&gt;jSmaxChar)) {
<a name="l02714"></a>02714         $cs = $this-&gt;jSmaxChar;
<a name="l02715"></a>02715         $ww = 1 - (($cs * ($ncx ))/$w);
<a name="l02716"></a>02716       }
<a name="l02717"></a>02717       $charspacing = $cs; 
<a name="l02718"></a>02718       $ws = ($w * ($ww) ) / $ns;
<a name="l02719"></a>02719        }  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02720"></a>02720     }
<a name="l02721"></a>02721   }
<a name="l02722"></a>02722   <span class="keywordflow">return</span> array($charspacing,$ws); 
<a name="l02723"></a>02723 }
<a name="l02724"></a>02724 
<a name="l02725"></a>02725 <span class="comment">// mPDF 4.2 Last parameters added above and below font</span>
<a name="l02726"></a>02726 function Cell($w,$h=0,$txt=<span class="stringliteral">&#39;&#39;</span>,$border=0,$ln=0,$align=<span class="stringliteral">&#39;&#39;</span>,$fill=0,$link=<span class="stringliteral">&#39;&#39;</span>, $currentx=0, $lcpaddingL=0, $lcpaddingR=0, $valign=<span class="charliteral">&#39;M&#39;</span>, $spanfill=0, $abovefont=0, $belowfont=0) {
<a name="l02727"></a>02727   <span class="comment">//Output a cell</span>
<a name="l02728"></a>02728   <span class="comment">// Expects input to be mb_encoded if necessary and RTL reversed</span>
<a name="l02729"></a>02729   <span class="comment">// NON_BREAKING SPACE</span>
<a name="l02730"></a>02730   <span class="keywordflow">if</span> ($this-&gt;is_MB) { <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02731"></a>02731         $txt = str_replace($this-&gt;chrs[194].$this-&gt;chrs[160],$this-&gt;chrs[32],$txt);   <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02732"></a>02732   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02733"></a>02733   <span class="keywordflow">else</span> {  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02734"></a>02734         $txt = str_replace($this-&gt;chrs[160],$this-&gt;chrs[32],$txt);
<a name="l02735"></a>02735   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02736"></a>02736 
<a name="l02737"></a>02737   $k=$this-&gt;k;
<a name="l02738"></a>02738   $oldcolumn = $this-&gt;CurrCol;
<a name="l02739"></a>02739   <span class="comment">// Automatic page break</span>
<a name="l02740"></a>02740   <span class="comment">// Allows PAGE-BREAK-AFTER = avoid to work</span>
<a name="l02741"></a>02741   <span class="comment">// mPDF 4.2.008</span>
<a name="l02742"></a>02742   <span class="keywordflow">if</span> (!$this-&gt;tableLevel &amp;&amp; (($this-&gt;y+$this-&gt;divheight&gt;$this-&gt;PageBreakTrigger) || ($this-&gt;y+$h&gt;$this-&gt;PageBreakTrigger) || 
<a name="l02743"></a>02743     ($this-&gt;y+($h*2)&gt;$this-&gt;PageBreakTrigger &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;page_break_after_avoid&#39;</span>])) and !$this-&gt;InFooter and $this-&gt;AcceptPageBreak()) {
<a name="l02744"></a>02744     $x=$this-&gt;x;<span class="comment">//Current X position</span>
<a name="l02745"></a>02745 
<a name="l02746"></a>02746 
<a name="l02747"></a>02747     <span class="comment">// WORD SPACING</span>
<a name="l02748"></a>02748     $ws=$this-&gt;ws;<span class="comment">//Word Spacing</span>
<a name="l02749"></a>02749     $charspacing=$this-&gt;charspacing;<span class="comment">//Character Spacing</span>
<a name="l02750"></a>02750     <span class="comment">// mPDF 4.0</span>
<a name="l02751"></a>02751     $this-&gt;ResetSpacing();
<a name="l02752"></a>02752 
<a name="l02753"></a>02753     $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l02754"></a>02754     <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l02755"></a>02755     $x += $this-&gt;MarginCorrection;
<a name="l02756"></a>02756     <span class="keywordflow">if</span> ($currentx) { 
<a name="l02757"></a>02757       $currentx += $this-&gt;MarginCorrection;
<a name="l02758"></a>02758     } 
<a name="l02759"></a>02759     $this-&gt;x=$x;
<a name="l02760"></a>02760     <span class="comment">// WORD SPACING</span>
<a name="l02761"></a>02761     <span class="comment">// mPDF 4.0</span>
<a name="l02762"></a>02762     $this-&gt;SetSpacing($charspacing,$ws);
<a name="l02763"></a>02763   }
<a name="l02764"></a>02764 
<a name="l02765"></a>02765   <span class="comment">// Test: to put border round each cell: $border=1;</span>
<a name="l02766"></a>02766   <span class="comment">// Test: to put line through centre of cell: $this-&gt;Line($this-&gt;x,$this-&gt;y+($h/2),$this-&gt;x+50,$this-&gt;y+($h/2));</span>
<a name="l02767"></a>02767 
<a name="l02768"></a>02768 
<a name="l02769"></a>02769   <span class="comment">// KEEP BLOCK TOGETHER Update/overwrite the lowest bottom of printing y value on first page</span>
<a name="l02770"></a>02770   <span class="keywordflow">if</span> ($this-&gt;keep_block_together) {
<a name="l02771"></a>02771     <span class="keywordflow">if</span> ($h) { $this-&gt;ktBlock[$this-&gt;page][<span class="stringliteral">&#39;bottom_margin&#39;</span>] = $this-&gt;y+$h; }
<a name="l02772"></a>02772 <span class="comment">//    else { $this-&gt;ktBlock[$this-&gt;page][&#39;bottom_margin&#39;] = $this-&gt;y+$this-&gt;divheight; }</span>
<a name="l02773"></a>02773   }
<a name="l02774"></a>02774 
<a name="l02775"></a>02775   <span class="keywordflow">if</span>($w==0) $w = $this-&gt;w-$this-&gt;rMargin-$this-&gt;x;
<a name="l02776"></a>02776   $s=<span class="stringliteral">&#39;&#39;</span>;
<a name="l02777"></a>02777   <span class="keywordflow">if</span>($fill==1 &amp;&amp; $this-&gt;FillColor) { 
<a name="l02778"></a>02778     <span class="keywordflow">if</span>((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>] != $this-&gt;FillColor) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>]) || $this-&gt;keep_block_together) { $s .= $this-&gt;FillColor.<span class="charliteral">&#39; &#39;</span>; }
<a name="l02779"></a>02779     $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;FillColor&#39;</span>] = $this-&gt;FillColor;
<a name="l02780"></a>02780   }
<a name="l02781"></a>02781 
<a name="l02782"></a>02782   <span class="comment">// mPDF 4.0</span>
<a name="l02783"></a>02783   $boxtop = $this-&gt;y;
<a name="l02784"></a>02784   $boxheight = $h;
<a name="l02785"></a>02785   $boxbottom = $this-&gt;y+$h;
<a name="l02786"></a>02786 
<a name="l02787"></a>02787   <span class="keywordflow">if</span>($txt!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02788"></a>02788     <span class="comment">// FONT SIZE - this determines the baseline caculation</span>
<a name="l02789"></a>02789     <span class="keywordflow">if</span> ($this-&gt;linemaxfontsize &amp;&amp; !$this-&gt;processingHeader) { $bfs = $this-&gt;linemaxfontsize; }
<a name="l02790"></a>02790     <span class="keywordflow">else</span>  { $bfs = $this-&gt;FontSize; }
<a name="l02791"></a>02791         <span class="comment">//Calculate baseline Superscript and Subscript Y coordinate adjustment</span>
<a name="l02792"></a>02792     $bfx = $this-&gt;baselineC;  <span class="comment">// mPDF 4.2</span>
<a name="l02793"></a>02793         $baseline = $bfx*$bfs;
<a name="l02794"></a>02794     <span class="keywordflow">if</span>($this-&gt;SUP) { $baseline += ($bfx-1.05)*$this-&gt;FontSize; }
<a name="l02795"></a>02795     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($this-&gt;SUB) { $baseline += ($bfx + 0.04)*$this-&gt;FontSize; }
<a name="l02796"></a>02796     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($this-&gt;bullet) { $baseline += ($bfx-0.7)*$this-&gt;FontSize; }
<a name="l02797"></a>02797 
<a name="l02798"></a>02798     <span class="comment">// Vertical align (for Images)</span>
<a name="l02799"></a>02799     <span class="comment">// mPDF 4.2</span>
<a name="l02800"></a>02800     <span class="keywordflow">if</span> ($abovefont || $belowfont) { <span class="comment">// from flowing block - valign always M</span>
<a name="l02801"></a>02801       $va = $abovefont + (0.5*$bfs);
<a name="l02802"></a>02802     }
<a name="l02803"></a>02803     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;lineheight_correction) { 
<a name="l02804"></a>02804       <span class="keywordflow">if</span> ($valign == <span class="charliteral">&#39;T&#39;</span>) { $va = (0.5 * $bfs * $this-&gt;lineheight_correction); }
<a name="l02805"></a>02805       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($valign == <span class="charliteral">&#39;B&#39;</span>) { $va = $h-(0.5 * $bfs * $this-&gt;lineheight_correction); }
<a name="l02806"></a>02806       <span class="keywordflow">else</span> { $va = 0.5*$h; }  <span class="comment">// Middle</span>
<a name="l02807"></a>02807     }
<a name="l02808"></a>02808     <span class="keywordflow">else</span> { 
<a name="l02809"></a>02809       <span class="keywordflow">if</span> ($valign == <span class="charliteral">&#39;T&#39;</span>) { $va = (0.5 * $bfs * $this-&gt;default_lineheight_correction); }
<a name="l02810"></a>02810       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($valign == <span class="charliteral">&#39;B&#39;</span>) { $va = $h-(0.5 * $bfs * $this-&gt;default_lineheight_correction); }
<a name="l02811"></a>02811       <span class="keywordflow">else</span> { $va = 0.5*$h; }  <span class="comment">// Middle</span>
<a name="l02812"></a>02812     }
<a name="l02813"></a>02813 
<a name="l02814"></a>02814     <span class="comment">// ONLY SET THESE IF WANT TO CONFINE BORDER +- FILL TO FIT FONTSIZE - NOT FULL CELL</span>
<a name="l02815"></a>02815     <span class="keywordflow">if</span> ($spanfill) {
<a name="l02816"></a>02816       $boxtop = $this-&gt;y+$baseline+$va-($this-&gt;FontSize*(0.5+$bfx));
<a name="l02817"></a>02817       $boxheight = $this-&gt;FontSize;
<a name="l02818"></a>02818       $boxbottom = $boxtop + $boxheight;
<a name="l02819"></a>02819     }
<a name="l02820"></a>02820   }
<a name="l02821"></a>02821 
<a name="l02822"></a>02822 
<a name="l02823"></a>02823   <span class="keywordflow">if</span>($fill==1 or $border==1) {
<a name="l02824"></a>02824     <span class="keywordflow">if</span> ($fill==1) $op=($border==1) ? <span class="charliteral">&#39;B&#39;</span> : <span class="charliteral">&#39;f&#39;</span>;
<a name="l02825"></a>02825     <span class="keywordflow">else</span> $op=<span class="charliteral">&#39;S&#39;</span>;
<a name="l02826"></a>02826     $s.=sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re %s &#39;</span>,$this-&gt;x*$k,($this-&gt;h-$boxtop)*$k,$w*$k,-$boxheight*$k,$op);
<a name="l02827"></a>02827   }
<a name="l02828"></a>02828 
<a name="l02829"></a>02829   <span class="keywordflow">if</span>(is_string($border)) {
<a name="l02830"></a>02830     $x=$this-&gt;x;
<a name="l02831"></a>02831     $y=$this-&gt;y;
<a name="l02832"></a>02832     <span class="keywordflow">if</span>(is_int(strpos($border,<span class="charliteral">&#39;L&#39;</span>)))
<a name="l02833"></a>02833       $s.=sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S &#39;</span>,$x*$k,($this-&gt;h-$boxtop)*$k,$x*$k,($this-&gt;h-($boxbottom))*$k);
<a name="l02834"></a>02834     <span class="keywordflow">if</span>(is_int(strpos($border,<span class="charliteral">&#39;T&#39;</span>)))
<a name="l02835"></a>02835       $s.=sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S &#39;</span>,$x*$k,($this-&gt;h-$boxtop)*$k,($x+$w)*$k,($this-&gt;h-$boxtop)*$k);
<a name="l02836"></a>02836     <span class="keywordflow">if</span>(is_int(strpos($border,<span class="charliteral">&#39;R&#39;</span>)))
<a name="l02837"></a>02837       $s.=sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S &#39;</span>,($x+$w)*$k,($this-&gt;h-$boxtop)*$k,($x+$w)*$k,($this-&gt;h-($boxbottom))*$k);
<a name="l02838"></a>02838     <span class="keywordflow">if</span>(is_int(strpos($border,<span class="charliteral">&#39;B&#39;</span>)))
<a name="l02839"></a>02839       $s.=sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S &#39;</span>,$x*$k,($this-&gt;h-($boxbottom))*$k,($x+$w)*$k,($this-&gt;h-($boxbottom))*$k);
<a name="l02840"></a>02840   }
<a name="l02841"></a>02841 
<a name="l02842"></a>02842   <span class="keywordflow">if</span>($txt!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02843"></a>02843     $stringWidth = $this-&gt;GetStringWidth($txt) + ( $this-&gt;charspacing * mb_strlen( $txt, $this-&gt;mb_enc ) / $k )
<a name="l02844"></a>02844          + ( $this-&gt;ws * mb_substr_count( $txt, <span class="charliteral">&#39; &#39;</span>, $this-&gt;mb_enc ) / $k );
<a name="l02845"></a>02845 
<a name="l02846"></a>02846     <span class="comment">// Set x OFFSET FOR PRINTING</span>
<a name="l02847"></a>02847     <span class="keywordflow">if</span>($align==<span class="charliteral">&#39;R&#39;</span>) {
<a name="l02848"></a>02848       $dx=$w-$this-&gt;cMarginR - $stringWidth - $lcpaddingR;
<a name="l02849"></a>02849     }
<a name="l02850"></a>02850     elseif($align==<span class="charliteral">&#39;C&#39;</span>) {
<a name="l02851"></a>02851       $dx=(($w - $stringWidth )/2);
<a name="l02852"></a>02852     }
<a name="l02853"></a>02853     elseif($align==<span class="charliteral">&#39;L&#39;</span> or $align==<span class="charliteral">&#39;J&#39;</span>) $dx=$this-&gt;cMarginL + $lcpaddingL;
<a name="l02854"></a>02854         else $dx = 0;
<a name="l02855"></a>02855 
<a name="l02856"></a>02856 
<a name="l02857"></a>02857     <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a>($this-&gt;ColorFlag) $s.=&#39;q &#39;.$this-&gt;TextColor.&#39; &#39;;
<a name="l02858"></a>02858 
<a name="l02859"></a>02859     <span class="comment">// OUTLINE</span>
<a name="l02860"></a>02860     <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a>($this-&gt;outline_on) {
<a name="l02861"></a>02861       $s.=<span class="charliteral">&#39; &#39;</span>.sprintf(<span class="stringliteral">&#39;%.3f w&#39;</span>,$this-&gt;LineWidth*$k).<span class="charliteral">&#39; &#39;</span>;
<a name="l02862"></a>02862       $s.=<span class="stringliteral">&quot; $this-&gt;DrawColor &quot;</span>;
<a name="l02863"></a>02863       $s.=<span class="stringliteral">&quot; 2 Tr &quot;</span>;
<a name="l02864"></a>02864         }
<a name="l02865"></a>02865     <span class="comment">// mPDF 4.2 Artificial BOLD</span>
<a name="l02866"></a>02866     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;falseBoldWeight &amp;&amp; strpos($this-&gt;ReqFontStyle,<span class="stringliteral">&quot;B&quot;</span>) !== <span class="keyword">false</span> &amp;&amp; strpos($this-&gt;FontStyle,<span class="stringliteral">&quot;B&quot;</span>) === <span class="keyword">false</span>) { <span class="comment">// can&#39;t use together with OUTLINE</span>
<a name="l02867"></a>02867       $s  .= <span class="stringliteral">&#39; 2 Tr 1 J 1 j &#39;</span>;
<a name="l02868"></a>02868       $s .= <span class="charliteral">&#39; &#39;</span>.sprintf(<span class="stringliteral">&#39;%.3f w&#39;</span>,($this-&gt;FontSize/130)*$k*$this-&gt;falseBoldWeight).<span class="charliteral">&#39; &#39;</span>;
<a name="l02869"></a>02869       $tc = strtoupper($this-&gt;TextColor); <span class="comment">// change 0 0 0 rg to 0 0 0 RG</span>
<a name="l02870"></a>02870       <span class="keywordflow">if</span>($this-&gt;FillColor!=$tc) { $s .= <span class="charliteral">&#39; &#39;</span>.$tc.<span class="charliteral">&#39; &#39;</span>; }    <span class="comment">// stroke (outline) = same colour as text(fill)</span>
<a name="l02871"></a>02871     }
<a name="l02872"></a>02872     <span class="comment">// mPDF 4.2 Artificial ITALIC</span>
<a name="l02873"></a>02873     <span class="keywordflow">if</span> (strpos($this-&gt;ReqFontStyle,<span class="stringliteral">&quot;I&quot;</span>) !== <span class="keyword">false</span> &amp;&amp; strpos($this-&gt;FontStyle,<span class="stringliteral">&quot;I&quot;</span>) === <span class="keyword">false</span>) {  <span class="comment">// Artificial italic</span>
<a name="l02874"></a>02874       $aix = <span class="stringliteral">&#39;1 0 0.261799 1 %.3f %.3f Tm &#39;</span>; 
<a name="l02875"></a>02875     }
<a name="l02876"></a>02876     <span class="keywordflow">else</span> { $aix = <span class="stringliteral">&#39;%.3f %.3f Td &#39;</span>; }
<a name="l02877"></a>02877 
<a name="l02878"></a>02878     <span class="comment">// THE TEXT</span>
<a name="l02879"></a>02879     <span class="comment">// mPDF 4.0 </span>
<a name="l02880"></a>02880     $this-&gt;CurrentFont[<span class="stringliteral">&#39;used&#39;</span>]= <span class="keyword">true</span>;
<a name="l02881"></a>02881     <span class="comment">// WORD SPACING</span>
<a name="l02882"></a>02882     <span class="comment">// IF multibyte - Tw has no effect - need to do word spacing by setting character spacing for spaces between words</span>
<a name="l02883"></a>02883     <span class="comment">// mPDF 4.0 Subset fonts are unibyte at output stage</span>
<a name="l02884"></a>02884 
<a name="l02885"></a>02885     <span class="keywordflow">if</span> ($this-&gt;ws &amp;&amp; $this-&gt;is_MB &amp;&amp; (!$this-&gt;useSubsets || $this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>]!=<span class="stringliteral">&#39;Type1subset&#39;</span>)) {
<a name="l02886"></a>02886       $space = <span class="charliteral">&#39; &#39;</span>;
<a name="l02887"></a>02887       <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02888"></a>02888       <span class="comment">//Convert string to UTF-16BE without BOM</span>
<a name="l02889"></a>02889       $space= $this-&gt;UTF8ToUTF16BE($space , <span class="keyword">false</span>);
<a name="l02890"></a>02890       }
<a name="l02891"></a>02891       $space=$this-&gt;_escape($space ); 
<a name="l02892"></a>02892       $s.=sprintf(<span class="stringliteral">&#39;BT &#39;</span>.$aix,($this-&gt;x+$dx)*$k,($this-&gt;h-($this-&gt;y+$baseline+$va))*$k);
<a name="l02893"></a>02893       $t = preg_split(<span class="stringliteral">&#39;/[ ]/u&#39;</span>,$txt);
<a name="l02894"></a>02894       <span class="keywordflow">for</span>($i=0;$i&lt;count($t);$i++) {
<a name="l02895"></a>02895       $tx = $t[$i]; 
<a name="l02896"></a>02896         <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02897"></a>02897         <span class="comment">//Convert string to UTF-16BE without BOM</span>
<a name="l02898"></a>02898         $tx = $this-&gt;UTF8ToUTF16BE($tx , <span class="keyword">false</span>);
<a name="l02899"></a>02899       }
<a name="l02900"></a>02900 
<a name="l02901"></a>02901       $tx = $this-&gt;_escape($tx); 
<a name="l02902"></a>02902 
<a name="l02903"></a>02903       $s.=sprintf(<span class="stringliteral">&#39; %.3f Tc (%s) Tj&#39;</span>,$this-&gt;charspacing,$tx);
<a name="l02904"></a>02904       <span class="keywordflow">if</span> (($i+1)&lt;count($t)) {
<a name="l02905"></a>02905         $s.=sprintf(<span class="stringliteral">&#39; %.3f Tc (%s) Tj&#39;</span>,$this-&gt;ws+$this-&gt;charspacing,$space);
<a name="l02906"></a>02906       }
<a name="l02907"></a>02907       }
<a name="l02908"></a>02908       $s.=<span class="stringliteral">&#39; ET&#39;</span>;
<a name="l02909"></a>02909     }
<a name="l02910"></a>02910     <span class="keywordflow">else</span> {
<a name="l02911"></a>02911       $txt2= $txt;
<a name="l02912"></a>02912       <span class="comment">// mPDF 4.0 Subset fonts</span>
<a name="l02913"></a>02913       <span class="keywordflow">if</span> ($this-&gt;useSubsets &amp;&amp; $this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;Type1subset&#39;</span> &amp;&amp; !$this-&gt;isCJK &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02914"></a>02914       $txt2 = $this-&gt;UTF8toSubset($txt2);
<a name="l02915"></a>02915       $s.=sprintf(<span class="stringliteral">&#39;BT &#39;</span>.$aix.<span class="stringliteral">&#39; %s Tj ET&#39;</span>,($this-&gt;x+$dx)*$k,($this-&gt;h-($this-&gt;y+$baseline+$va))*$k,$txt2);
<a name="l02916"></a>02916       }
<a name="l02917"></a>02917       <span class="keywordflow">else</span> {
<a name="l02918"></a>02918       <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l02919"></a>02919         <span class="comment">//Convert string to UTF-16BE without BOM</span>
<a name="l02920"></a>02920         $txt2= $this-&gt;UTF8ToUTF16BE($txt2, <span class="keyword">false</span>);
<a name="l02921"></a>02921       }
<a name="l02922"></a>02922       $txt2=$this-&gt;_escape($txt2); 
<a name="l02923"></a>02923       $s.=sprintf(<span class="stringliteral">&#39;BT &#39;</span>.$aix.<span class="stringliteral">&#39; (%s) Tj ET&#39;</span>,($this-&gt;x+$dx)*$k,($this-&gt;h-($this-&gt;y+$baseline+$va))*$k,$txt2);
<a name="l02924"></a>02924       }
<a name="l02925"></a>02925     } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02926"></a>02926 
<a name="l02927"></a>02927     <span class="comment">// UNDERLINE</span>
<a name="l02928"></a>02928     <span class="comment">// mPDF 4.0</span>
<a name="l02929"></a>02929     <span class="keywordflow">if</span>($this-&gt;underline) {
<a name="l02930"></a>02930       $c = strtoupper($this-&gt;TextColor); <span class="comment">// change 0 0 0 rg to 0 0 0 RG</span>
<a name="l02931"></a>02931       <span class="keywordflow">if</span>($this-&gt;FillColor!=$c) { $s.= <span class="charliteral">&#39; &#39;</span>.$c.<span class="charliteral">&#39; &#39;</span>; }
<a name="l02932"></a>02932       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;up&#39;</span>])) { $up=$this-&gt;CurrentFont[<span class="stringliteral">&#39;up&#39;</span>]; }
<a name="l02933"></a>02933       <span class="keywordflow">else</span> { $up = -100; }
<a name="l02934"></a>02934       $adjusty = (-$up/1000* $this-&gt;FontSize);  
<a name="l02935"></a>02935       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;ut&#39;</span>])) { $ut=$this-&gt;CurrentFont[<span class="stringliteral">&#39;ut&#39;</span>]/1000* $this-&gt;FontSize; }
<a name="l02936"></a>02936       <span class="keywordflow">else</span> { $ut = 60/1000* $this-&gt;FontSize; }
<a name="l02937"></a>02937       $olw = $this-&gt;LineWidth;
<a name="l02938"></a>02938       $s.=<span class="charliteral">&#39; &#39;</span>.(sprintf(<span class="stringliteral">&#39; %.3f w&#39;</span>,$ut*$this-&gt;k));
<a name="l02939"></a>02939       $s.=<span class="charliteral">&#39; &#39;</span>.$this-&gt;_dounderline($this-&gt;x+$dx,$this-&gt;y+$baseline+$va+$adjusty,$txt);
<a name="l02940"></a>02940       $s.=<span class="charliteral">&#39; &#39;</span>.(sprintf(<span class="stringliteral">&#39; %.3f w&#39;</span>,$olw*$this-&gt;k));
<a name="l02941"></a>02941       <span class="keywordflow">if</span>($this-&gt;FillColor!=$c) { $s.= <span class="charliteral">&#39; &#39;</span>.$this-&gt;FillColor.<span class="charliteral">&#39; &#39;</span>; }
<a name="l02942"></a>02942     }
<a name="l02943"></a>02943 
<a name="l02944"></a>02944       <span class="comment">// STRIKETHROUGH</span>
<a name="l02945"></a>02945     <span class="comment">// mPDF 4.0</span>
<a name="l02946"></a>02946     <span class="keywordflow">if</span>($this-&gt;strike) {
<a name="l02947"></a>02947       $c = strtoupper($this-&gt;TextColor); <span class="comment">// change 0 0 0 rg to 0 0 0 RG</span>
<a name="l02948"></a>02948       <span class="keywordflow">if</span>($this-&gt;FillColor!=$c) { $s.= <span class="charliteral">&#39; &#39;</span>.$c.<span class="charliteral">&#39; &#39;</span>; }
<a name="l02949"></a>02949           <span class="comment">//Superscript and Subscript Y coordinate adjustment (now for striked-through texts)</span>
<a name="l02950"></a>02950       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;CapHeight&#39;</span>])) { $ch=$this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;CapHeight&#39;</span>]; }
<a name="l02951"></a>02951       <span class="keywordflow">else</span> { $ch = 700; }
<a name="l02952"></a>02952       $adjusty = (-$ch/1000* $this-&gt;FontSize) * 0.35; 
<a name="l02953"></a>02953       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;ut&#39;</span>])) { $ut=$this-&gt;CurrentFont[<span class="stringliteral">&#39;ut&#39;</span>]/1000* $this-&gt;FontSize; }
<a name="l02954"></a>02954       <span class="keywordflow">else</span> { $ut = 60/1000* $this-&gt;FontSize; }
<a name="l02955"></a>02955       $olw = $this-&gt;LineWidth;
<a name="l02956"></a>02956       $s.=<span class="charliteral">&#39; &#39;</span>.(sprintf(<span class="stringliteral">&#39; %.3f w&#39;</span>,$ut*$this-&gt;k));
<a name="l02957"></a>02957       $s.=<span class="charliteral">&#39; &#39;</span>.$this-&gt;_dounderline($this-&gt;x+$dx,$this-&gt;y+$baseline+$va+$adjusty,$txt);
<a name="l02958"></a>02958       $s.=<span class="charliteral">&#39; &#39;</span>.(sprintf(<span class="stringliteral">&#39; %.3f w&#39;</span>,$olw));
<a name="l02959"></a>02959       <span class="keywordflow">if</span>($this-&gt;FillColor!=$c) { $s.= <span class="charliteral">&#39; &#39;</span>.$this-&gt;FillColor.<span class="charliteral">&#39; &#39;</span>; }
<a name="l02960"></a>02960     }
<a name="l02961"></a>02961 
<a name="l02962"></a>02962     <span class="comment">// COLOR</span>
<a name="l02963"></a>02963     <span class="keywordflow">if</span>($this-&gt;ColorFlag) $s.=<span class="stringliteral">&#39; Q&#39;</span>;
<a name="l02964"></a>02964 
<a name="l02965"></a>02965     <span class="comment">// LINK</span>
<a name="l02966"></a>02966     <span class="keywordflow">if</span>($link!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02967"></a>02967       $this-&gt;Link($this-&gt;x+$dx,$this-&gt;y+$va-.5*$this-&gt;FontSize,$stringWidth,$this-&gt;FontSize,$link);
<a name="l02968"></a>02968     }
<a name="l02969"></a>02969   }
<a name="l02970"></a>02970   <span class="keywordflow">if</span>($s) $this-&gt;_out($s);
<a name="l02971"></a>02971 
<a name="l02972"></a>02972   <span class="comment">// WORD SPACING</span>
<a name="l02973"></a>02973   <span class="keywordflow">if</span> ($this-&gt;ws &amp;&amp; $this-&gt;is_MB) {  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02974"></a>02974     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;BT %.3f Tc ET&#39;</span>,$this-&gt;charspacing)); <span class="comment">// *UNICODE-FONTS* </span>
<a name="l02975"></a>02975   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l02976"></a>02976 
<a name="l02977"></a>02977   $this-&gt;lasth=$h;
<a name="l02978"></a>02978   <span class="keywordflow">if</span>( strpos($txt,<span class="stringliteral">&quot;\n&quot;</span>) !== <span class="keyword">false</span>) $ln=1; <span class="comment">// cell recognizes \n from &lt;BR&gt; tag</span>
<a name="l02979"></a>02979   <span class="keywordflow">if</span>($ln&gt;0)
<a name="l02980"></a>02980   {
<a name="l02981"></a>02981     <span class="comment">//Go to next line</span>
<a name="l02982"></a>02982     $this-&gt;y += $h;
<a name="l02983"></a>02983     <span class="keywordflow">if</span>($ln==1) {
<a name="l02984"></a>02984       <span class="comment">//Move to next line</span>
<a name="l02985"></a>02985       <span class="keywordflow">if</span> ($currentx != 0) { $this-&gt;x=$currentx; } 
<a name="l02986"></a>02986       <span class="keywordflow">else</span> { $this-&gt;x=$this-&gt;lMargin; }
<a name="l02987"></a>02987       }
<a name="l02988"></a>02988   }
<a name="l02989"></a>02989   <span class="keywordflow">else</span> $this-&gt;x+=$w;
<a name="l02990"></a>02990 
<a name="l02991"></a>02991 
<a name="l02992"></a>02992 }
<a name="l02993"></a>02993 
<a name="l02994"></a>02994 
<a name="l02995"></a>02995 function MultiCell($w,$h,$txt,$border=0,$align=<span class="stringliteral">&#39;&#39;</span>,$fill=0,$link=<span class="stringliteral">&#39;&#39;</span>,$directionality=<span class="stringliteral">&#39;ltr&#39;</span>,$encoded=<span class="keyword">false</span>)
<a name="l02996"></a>02996 {
<a name="l02997"></a>02997   <span class="comment">// Parameter (pre-)encoded - When called internally from ToC or textarea: mb_encoding already done - but not reverse RTL/Indic</span>
<a name="l02998"></a>02998   <span class="keywordflow">if</span> (!$encoded) {
<a name="l02999"></a>02999     $txt = $this-&gt;purify_utf8_text($txt);
<a name="l03000"></a>03000     <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l03001"></a>03001       $txt = $this-&gt;all_entities_to_utf8($txt);
<a name="l03002"></a>03002     }
<a name="l03003"></a>03003     <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $txt = mb_convert_encoding($txt,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l03004"></a>03004     <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l03005"></a>03005   }
<a name="l03006"></a>03006   <span class="keywordflow">if</span> (!$align) { $align = $this-&gt;defaultAlign; }
<a name="l03007"></a>03007   <span class="comment">//Output text with automatic or explicit line breaks</span>
<a name="l03008"></a>03008   $cw=&amp;$this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l03009"></a>03009   <span class="keywordflow">if</span>($w==0) $w=$this-&gt;w-$this-&gt;rMargin-$this-&gt;x;
<a name="l03010"></a>03010 
<a name="l03011"></a>03011   <span class="keywordflow">if</span> ($this-&gt;is_MB)  {
<a name="l03012"></a>03012     $wmax = ($w - ($this-&gt;cMarginL+$this-&gt;cMarginR));
<a name="l03013"></a>03013     $s=preg_replace(<span class="stringliteral">&quot;/\r/u&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$txt);
<a name="l03014"></a>03014     $nb=mb_strlen($s, $this-&gt;mb_enc );
<a name="l03015"></a>03015     <span class="keywordflow">while</span>($nb&gt;0 and mb_substr($s,$nb-1,1,$this-&gt;mb_enc )==<span class="stringliteral">&quot;\n&quot;</span>) $nb--;
<a name="l03016"></a>03016   }
<a name="l03017"></a>03017   <span class="keywordflow">else</span> {
<a name="l03018"></a>03018     $wmax=($w- ($this-&gt;cMarginL+$this-&gt;cMarginR))*1000/$this-&gt;FontSize;
<a name="l03019"></a>03019     $s=str_replace(<span class="stringliteral">&quot;\r&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$txt);
<a name="l03020"></a>03020     $nb=strlen($s);
<a name="l03021"></a>03021     <span class="keywordflow">while</span>($nb&gt;0 and $s[$nb-1]==<span class="stringliteral">&quot;\n&quot;</span>)  $nb--;
<a name="l03022"></a>03022   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l03023"></a>03023   $b=0;
<a name="l03024"></a>03024   <span class="keywordflow">if</span>($border) {
<a name="l03025"></a>03025     <span class="keywordflow">if</span>($border==1) {
<a name="l03026"></a>03026       $border=<span class="stringliteral">&#39;LTRB&#39;</span>;
<a name="l03027"></a>03027       $b=<span class="stringliteral">&#39;LRT&#39;</span>;
<a name="l03028"></a>03028       $b2=<span class="stringliteral">&#39;LR&#39;</span>;
<a name="l03029"></a>03029     }
<a name="l03030"></a>03030     <span class="keywordflow">else</span> {
<a name="l03031"></a>03031       $b2=<span class="stringliteral">&#39;&#39;</span>;
<a name="l03032"></a>03032       <span class="keywordflow">if</span>(is_int(strpos($border,<span class="charliteral">&#39;L&#39;</span>))) $b2.=<span class="charliteral">&#39;L&#39;</span>;
<a name="l03033"></a>03033       <span class="keywordflow">if</span>(is_int(strpos($border,<span class="charliteral">&#39;R&#39;</span>))) $b2.=<span class="charliteral">&#39;R&#39;</span>;
<a name="l03034"></a>03034       $b=is_int(strpos($border,<span class="charliteral">&#39;T&#39;</span>)) ? $b2.<span class="charliteral">&#39;T&#39;</span> : $b2;
<a name="l03035"></a>03035     }
<a name="l03036"></a>03036   }
<a name="l03037"></a>03037   $sep=-1;
<a name="l03038"></a>03038   $i=0;
<a name="l03039"></a>03039   $j=0;
<a name="l03040"></a>03040   $l=0;
<a name="l03041"></a>03041   $ns=0;
<a name="l03042"></a>03042   $nl=1;
<a name="l03043"></a>03043 
<a name="l03044"></a>03044 
<a name="l03045"></a>03045    <span class="keywordflow">if</span> ($this-&gt;is_MB)  {
<a name="l03046"></a>03046   <span class="keywordflow">while</span>($i&lt;$nb) {
<a name="l03047"></a>03047     <span class="comment">//Get next character</span>
<a name="l03048"></a>03048     $c = mb_substr($s,$i,1,$this-&gt;mb_enc );
<a name="l03049"></a>03049     <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&quot;/[\n]/u&quot;</span>, $c)) {
<a name="l03050"></a>03050       <span class="comment">//Explicit line break</span>
<a name="l03051"></a>03051       <span class="comment">// WORD SPACING</span>
<a name="l03052"></a>03052       <span class="comment">// mPDF 4.0</span>
<a name="l03053"></a>03053       $this-&gt;ResetSpacing();
<a name="l03054"></a>03054       $tmp = $this-&gt;mb_rtrim(mb_substr($s,$j,$i-$j,$this-&gt;mb_enc),<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03055"></a>03055       <span class="comment">// DIRECTIONALITY</span>
<a name="l03056"></a>03056 
<a name="l03057"></a>03057       $this-&gt;Cell($w,$h,$tmp,$b,2,$align,$fill,$link);
<a name="l03058"></a>03058       $i++;
<a name="l03059"></a>03059       $sep=-1;
<a name="l03060"></a>03060       $j=$i;
<a name="l03061"></a>03061       $l=0;
<a name="l03062"></a>03062       $ns=0;
<a name="l03063"></a>03063       $nl++;
<a name="l03064"></a>03064       <span class="keywordflow">if</span>($border and $nl==2) $b=$b2;
<a name="l03065"></a>03065       <span class="keywordflow">continue</span>;
<a name="l03066"></a>03066     }
<a name="l03067"></a>03067     <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&quot;/[ ]/u&quot;</span>, $c)) {
<a name="l03068"></a>03068       $sep=$i;
<a name="l03069"></a>03069       $ls=$l;
<a name="l03070"></a>03070       $ns++;
<a name="l03071"></a>03071     }
<a name="l03072"></a>03072 
<a name="l03073"></a>03073     $l = $this-&gt;GetStringWidth(mb_substr($s, $j, $i-$j,$this-&gt;mb_enc ));
<a name="l03074"></a>03074 
<a name="l03075"></a>03075     <span class="keywordflow">if</span>($l&gt;$wmax) {
<a name="l03076"></a>03076       <span class="comment">//Automatic line break</span>
<a name="l03077"></a>03077       <span class="keywordflow">if</span>($sep==-1) {  <span class="comment">// Only one word</span>
<a name="l03078"></a>03078         <span class="keywordflow">if</span>($i==$j) $i++;
<a name="l03079"></a>03079         <span class="comment">// WORD SPACING</span>
<a name="l03080"></a>03080         <span class="comment">// mPDF 4.0</span>
<a name="l03081"></a>03081         $this-&gt;ResetSpacing();
<a name="l03082"></a>03082         $tmp = $this-&gt;mb_rtrim(mb_substr($s,$j,$i-$j,$this-&gt;mb_enc),<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03083"></a>03083         <span class="comment">// DIRECTIONALITY</span>
<a name="l03084"></a>03084 
<a name="l03085"></a>03085         $this-&gt;Cell($w,$h,$tmp,$b,2,$align,$fill,$link);
<a name="l03086"></a>03086       }
<a name="l03087"></a>03087       <span class="keywordflow">else</span> {
<a name="l03088"></a>03088         $tmp = $this-&gt;mb_rtrim(mb_substr($s,$j,$sep-$j,$this-&gt;mb_enc),<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03089"></a>03089         <span class="keywordflow">if</span>($align==<span class="charliteral">&#39;J&#39;</span>) {
<a name="l03090"></a>03090           <span class="comment">//$this-&gt;ws=($ns&gt;1) ? ((($wmax-$ls)/($ns-1))) : 0;</span>
<a name="l03091"></a>03091           <span class="comment">//$this-&gt;_out(sprintf(&#39;%.3f Tw&#39;,$this-&gt;ws*$this-&gt;k));</span>
<a name="l03092"></a>03092 
<a name="l03094"></a>03094           <span class="comment">// JUSTIFY J using Unicode fonts (Word spacing doesn&#39;t work)</span>
<a name="l03095"></a>03095           <span class="comment">// WORD SPACING UNICODE</span>
<a name="l03096"></a>03096           <span class="comment">// Change NON_BREAKING SPACE to spaces so they are &#39;spaced&#39; properly</span>
<a name="l03097"></a>03097           $tmp = str_replace($this-&gt;chrs[194].$this-&gt;chrs[160],$this-&gt;chrs[32],$tmp ); 
<a name="l03098"></a>03098           $len_ligne = $this-&gt;GetStringWidth($tmp );
<a name="l03099"></a>03099           $nb_carac = mb_strlen( $tmp , $this-&gt;mb_enc ) ;  
<a name="l03100"></a>03100           $nb_spaces = mb_substr_count( $tmp ,<span class="charliteral">&#39; &#39;</span>, $this-&gt;mb_enc ) ;  
<a name="l03101"></a>03101           list($charspacing,$ws) = $this-&gt;GetJspacing($nb_carac,$nb_spaces,((($w-2) - $len_ligne) * $this-&gt;k));
<a name="l03102"></a>03102           <span class="comment">// mPDF 4.0</span>
<a name="l03103"></a>03103           $this-&gt;SetSpacing($charspacing,$ws);
<a name="l03105"></a>03105         }
<a name="l03106"></a>03106 
<a name="l03107"></a>03107         <span class="comment">// DIRECTIONALITY</span>
<a name="l03108"></a>03108 
<a name="l03109"></a>03109         $this-&gt;Cell($w,$h,$tmp,$b,2,$align,$fill,$link);
<a name="l03110"></a>03110         $i=$sep+1;
<a name="l03111"></a>03111       }
<a name="l03112"></a>03112       $sep=-1;
<a name="l03113"></a>03113       $j=$i;
<a name="l03114"></a>03114       $l=0;
<a name="l03115"></a>03115       $ns=0;
<a name="l03116"></a>03116       $nl++;
<a name="l03117"></a>03117       <span class="keywordflow">if</span>($border and $nl==2) $b=$b2;
<a name="l03118"></a>03118     }
<a name="l03119"></a>03119     <span class="keywordflow">else</span> $i++;
<a name="l03120"></a>03120   }
<a name="l03121"></a>03121   <span class="comment">//Last chunk</span>
<a name="l03122"></a>03122   <span class="comment">// WORD SPACING</span>
<a name="l03123"></a>03123   <span class="comment">// mPDF 4.0</span>
<a name="l03124"></a>03124   $this-&gt;ResetSpacing();
<a name="l03125"></a>03125 
<a name="l03126"></a>03126    }
<a name="l03127"></a>03127 
<a name="l03128"></a>03128 
<a name="l03129"></a>03129    <span class="keywordflow">else</span> {
<a name="l03130"></a>03130   <span class="keywordflow">while</span>($i&lt;$nb) {
<a name="l03131"></a>03131     <span class="comment">//Get next character</span>
<a name="l03132"></a>03132     $c=substr($s,$i,1);
<a name="l03133"></a>03133     <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&quot;/[\n]/u&quot;</span>, $c)) {
<a name="l03134"></a>03134       <span class="comment">//Explicit line break</span>
<a name="l03135"></a>03135       <span class="comment">// WORD SPACING</span>
<a name="l03136"></a>03136       <span class="comment">// mPDF 4.0</span>
<a name="l03137"></a>03137       $this-&gt;ResetSpacing();
<a name="l03138"></a>03138       $this-&gt;Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill,$link);
<a name="l03139"></a>03139       $i++;
<a name="l03140"></a>03140       $sep=-1;
<a name="l03141"></a>03141       $j=$i;
<a name="l03142"></a>03142       $l=0;
<a name="l03143"></a>03143       $ns=0;
<a name="l03144"></a>03144       $nl++;
<a name="l03145"></a>03145       <span class="keywordflow">if</span>($border and $nl==2) $b=$b2;
<a name="l03146"></a>03146       <span class="keywordflow">continue</span>;
<a name="l03147"></a>03147     }
<a name="l03148"></a>03148     <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&quot;/[ ]/u&quot;</span>, $c)) {
<a name="l03149"></a>03149       $sep=$i;
<a name="l03150"></a>03150       $ls=$l;
<a name="l03151"></a>03151       $ns++;
<a name="l03152"></a>03152     }
<a name="l03153"></a>03153 
<a name="l03154"></a>03154     $l+=$cw[$c];
<a name="l03155"></a>03155     <span class="keywordflow">if</span>($l&gt;$wmax) {
<a name="l03156"></a>03156       <span class="comment">//Automatic line break</span>
<a name="l03157"></a>03157       <span class="keywordflow">if</span>($sep==-1) {
<a name="l03158"></a>03158         <span class="keywordflow">if</span>($i==$j) $i++;
<a name="l03159"></a>03159         <span class="comment">// WORD SPACING</span>
<a name="l03160"></a>03160         <span class="comment">// mPDF 4.0</span>
<a name="l03161"></a>03161         $this-&gt;ResetSpacing();
<a name="l03162"></a>03162         $this-&gt;Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill,$link);
<a name="l03163"></a>03163       }
<a name="l03164"></a>03164       <span class="keywordflow">else</span> {
<a name="l03165"></a>03165         <span class="keywordflow">if</span>($align==<span class="charliteral">&#39;J&#39;</span>) {
<a name="l03166"></a>03166           $tmp = rtrim(substr($s,$j,$sep-$j));
<a name="l03168"></a>03168           <span class="comment">// JUSTIFY J using Unicode fonts (Word spacing doesn&#39;t work)</span>
<a name="l03169"></a>03169           <span class="comment">// WORD SPACING NON_UNICDOE/CJK</span>
<a name="l03170"></a>03170           <span class="comment">// Change NON_BREAKING SPACE to spaces so they are &#39;spaced&#39; properly</span>
<a name="l03171"></a>03171           $tmp = str_replace($this-&gt;chrs[160],$this-&gt;chrs[32],$tmp);
<a name="l03172"></a>03172           $len_ligne = $this-&gt;GetStringWidth($tmp );
<a name="l03173"></a>03173           $nb_carac = strlen( $tmp ) ;  
<a name="l03174"></a>03174           $nb_spaces = substr_count( $tmp ,<span class="charliteral">&#39; &#39;</span> ) ;  
<a name="l03175"></a>03175           list($charspacing,$ws) = $this-&gt;GetJspacing($nb_carac,$nb_spaces,((($w-2) - $len_ligne) * $this-&gt;k));
<a name="l03176"></a>03176           <span class="comment">// mPDF 4.0</span>
<a name="l03177"></a>03177           $this-&gt;SetSpacing($charspacing,$ws);
<a name="l03179"></a>03179         }
<a name="l03180"></a>03180         $this-&gt;Cell($w,$h,substr($s,$j,$sep-$j),$b,2,$align,$fill,$link);
<a name="l03181"></a>03181         $i=$sep+1;
<a name="l03182"></a>03182       }
<a name="l03183"></a>03183       $sep=-1;
<a name="l03184"></a>03184       $j=$i;
<a name="l03185"></a>03185       $l=0;
<a name="l03186"></a>03186       $ns=0;
<a name="l03187"></a>03187       $nl++;
<a name="l03188"></a>03188       <span class="keywordflow">if</span>($border and $nl==2) $b=$b2;
<a name="l03189"></a>03189     }
<a name="l03190"></a>03190     <span class="keywordflow">else</span> $i++;
<a name="l03191"></a>03191   }
<a name="l03192"></a>03192   <span class="comment">//Last chunk</span>
<a name="l03193"></a>03193   <span class="comment">// WORD SPACING</span>
<a name="l03194"></a>03194   <span class="comment">// mPDF 4.0</span>
<a name="l03195"></a>03195   $this-&gt;ResetSpacing();
<a name="l03196"></a>03196 
<a name="l03197"></a>03197    }  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l03198"></a>03198 
<a name="l03199"></a>03199   <span class="comment">//Last chunk</span>
<a name="l03200"></a>03200    <span class="keywordflow">if</span>($border and is_int(strpos($border,<span class="charliteral">&#39;B&#39;</span>)))  $b.=<span class="charliteral">&#39;B&#39;</span>;
<a name="l03201"></a>03201    <span class="keywordflow">if</span> ($this-&gt;is_MB)  {
<a name="l03202"></a>03202     $tmp = $this-&gt;mb_rtrim(mb_substr($s,$j,$i-$j,$this-&gt;mb_enc),<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03203"></a>03203     <span class="comment">// DIRECTIONALITY</span>
<a name="l03204"></a>03204       $this-&gt;Cell($w,$h,$tmp,$b,2,$align,$fill,$link);
<a name="l03205"></a>03205    }
<a name="l03206"></a>03206    <span class="keywordflow">else</span> { $this-&gt;Cell($w,$h,substr($s,$j,$i-$j),$b,2,$align,$fill,$link); }
<a name="l03207"></a>03207    $this-&gt;x=$this-&gt;lMargin;
<a name="l03208"></a>03208 }
<a name="l03209"></a>03209 
<a name="l03210"></a>03210 
<a name="l03211"></a>03211 
<a name="l03212"></a>03212 
<a name="l03213"></a>03213 function saveInlineProperties() {
<a name="l03214"></a>03214    $saved = array();
<a name="l03215"></a>03215    $saved[ <span class="stringliteral">&#39;family&#39;</span> ] = $this-&gt;FontFamily;
<a name="l03216"></a>03216    $saved[ <span class="stringliteral">&#39;style&#39;</span> ] = $this-&gt;FontStyle;
<a name="l03217"></a>03217    $saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ] = $this-&gt;FontSizePt;
<a name="l03218"></a>03218    $saved[ <span class="stringliteral">&#39;size&#39;</span> ] = $this-&gt;FontSize;
<a name="l03219"></a>03219    $saved[ <span class="stringliteral">&#39;HREF&#39;</span> ] = $this-&gt;HREF; 
<a name="l03220"></a>03220    $saved[ <span class="stringliteral">&#39;underline&#39;</span> ] = $this-&gt;underline; 
<a name="l03221"></a>03221    $saved[ <span class="stringliteral">&#39;strike&#39;</span> ] = $this-&gt;strike;
<a name="l03222"></a>03222    $saved[ <span class="stringliteral">&#39;SUP&#39;</span> ] = $this-&gt;SUP; 
<a name="l03223"></a>03223    $saved[ <span class="stringliteral">&#39;SUB&#39;</span> ] = $this-&gt;SUB; 
<a name="l03224"></a>03224    $saved[ <span class="stringliteral">&#39;linewidth&#39;</span> ] = $this-&gt;LineWidth;
<a name="l03225"></a>03225    $saved[ <span class="stringliteral">&#39;drawcolor&#39;</span> ] = $this-&gt;DrawColor;
<a name="l03226"></a>03226    $saved[ <span class="stringliteral">&#39;is_outline&#39;</span> ] = $this-&gt;outline_on;
<a name="l03227"></a>03227    $saved[ <span class="stringliteral">&#39;outlineparam&#39;</span> ] = $this-&gt;outlineparam;
<a name="l03228"></a>03228    $saved[ <span class="stringliteral">&#39;toupper&#39;</span> ] = $this-&gt;toupper;
<a name="l03229"></a>03229    $saved[ <span class="stringliteral">&#39;tolower&#39;</span> ] = $this-&gt;tolower;
<a name="l03230"></a>03230 
<a name="l03231"></a>03231    $saved[ <span class="charliteral">&#39;I&#39;</span> ] = $this-&gt;I;
<a name="l03232"></a>03232    $saved[ <span class="charliteral">&#39;B&#39;</span> ] = $this-&gt;B;
<a name="l03233"></a>03233    $saved[ <span class="stringliteral">&#39;colorarray&#39;</span> ] = $this-&gt;colorarray;
<a name="l03234"></a>03234    $saved[ <span class="stringliteral">&#39;bgcolorarray&#39;</span> ] = $this-&gt;spanbgcolorarray;
<a name="l03235"></a>03235    $saved[ <span class="stringliteral">&#39;color&#39;</span> ] = $this-&gt;TextColor; 
<a name="l03236"></a>03236    $saved[ <span class="stringliteral">&#39;bgcolor&#39;</span> ] = $this-&gt;FillColor;
<a name="l03237"></a>03237    $saved[<span class="stringliteral">&#39;lang&#39;</span>] = $this-&gt;currentLang;
<a name="l03238"></a>03238 
<a name="l03239"></a>03239    <span class="keywordflow">return</span> $saved;
<a name="l03240"></a>03240 }
<a name="l03241"></a>03241 
<a name="l03242"></a>03242 function restoreInlineProperties( $saved) {
<a name="l03243"></a>03243 
<a name="l03244"></a>03244    <span class="comment">// mPDF 4.0 $this-&gt;FontFamily Resets below - don&#39;t change here - change via SetFont()</span>
<a name="l03245"></a>03245   <span class="comment">// or it will not change $this-&gt;CurrentFont</span>
<a name="l03246"></a>03246    <span class="comment">//$this-&gt;FontFamily = $saved[ &#39;family&#39; ];</span>
<a name="l03247"></a>03247    $FontFamily = $saved[ <span class="stringliteral">&#39;family&#39;</span> ];
<a name="l03248"></a>03248 
<a name="l03249"></a>03249    $this-&gt;FontStyle = $saved[ <span class="stringliteral">&#39;style&#39;</span> ];
<a name="l03250"></a>03250    $this-&gt;FontSizePt = $saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ];
<a name="l03251"></a>03251    $this-&gt;FontSize = $saved[ <span class="stringliteral">&#39;size&#39;</span> ];
<a name="l03252"></a>03252 
<a name="l03253"></a>03253    $this-&gt;currentLang =  $saved[<span class="stringliteral">&#39;lang&#39;</span>];
<a name="l03254"></a>03254    <span class="keywordflow">if</span> ($this-&gt;useLang &amp;&amp; $this-&gt;is_MB &amp;&amp; $this-&gt;currentLang != $this-&gt;default_lang &amp;&amp; ((strlen($this-&gt;currentLang) == 5 &amp;&amp; $this-&gt;currentLang != <span class="stringliteral">&#39;UTF-8&#39;</span>) || strlen($this-&gt;currentLang ) == 2)) { 
<a name="l03255"></a>03255   list ($codepage,$mpdf_pdf_unifonts,$mpdf_directionality,$mpdf_jSpacing) = GetCodepage($this-&gt;currentLang);
<a name="l03256"></a>03256   <span class="keywordflow">if</span> ($codepage == <span class="stringliteral">&#39;SHIFT_JIS&#39;</span>) { $FontFamily = <span class="stringliteral">&#39;sjis&#39;</span>; } <span class="comment">// mPDF 4.0 see above</span>
<a name="l03257"></a>03257   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($codepage == <span class="stringliteral">&#39;UHC&#39;</span>) { $FontFamily = <span class="stringliteral">&#39;uhc&#39;</span>; } <span class="comment">// mPDF 4.0 see above</span>
<a name="l03258"></a>03258   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($codepage == <span class="stringliteral">&#39;BIG5&#39;</span>) { $FontFamily = <span class="stringliteral">&#39;big5&#39;</span>; } <span class="comment">// mPDF 4.0 see above</span>
<a name="l03259"></a>03259   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($codepage == <span class="stringliteral">&#39;GBK&#39;</span>) { $FontFamily = <span class="stringliteral">&#39;gb&#39;</span>; }  <span class="comment">// mPDF 4.0 see above</span>
<a name="l03260"></a>03260   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($mpdf_pdf_unifonts) { $this-&gt;RestrictUnicodeFonts($mpdf_pdf_unifonts); }
<a name="l03261"></a>03261   <span class="keywordflow">else</span> { $this-&gt;RestrictUnicodeFonts($this-&gt;default_available_fonts ); }
<a name="l03262"></a>03262    }
<a name="l03263"></a>03263    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;useLang &amp;&amp; $this-&gt;is_MB ) { 
<a name="l03264"></a>03264   $this-&gt;RestrictUnicodeFonts($this-&gt;default_available_fonts ); 
<a name="l03265"></a>03265    }
<a name="l03266"></a>03266 
<a name="l03267"></a>03267    $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor); <span class="comment">//Restore ColorFlag as well</span>
<a name="l03268"></a>03268 
<a name="l03269"></a>03269    $this-&gt;HREF = $saved[ <span class="stringliteral">&#39;HREF&#39;</span> ];
<a name="l03270"></a>03270    $this-&gt;underline = $saved[ <span class="stringliteral">&#39;underline&#39;</span> ];
<a name="l03271"></a>03271    $this-&gt;strike = $saved[ <span class="stringliteral">&#39;strike&#39;</span> ];
<a name="l03272"></a>03272    $this-&gt;SUP = $saved[ <span class="stringliteral">&#39;SUP&#39;</span> ];
<a name="l03273"></a>03273    $this-&gt;SUB = $saved[ <span class="stringliteral">&#39;SUB&#39;</span> ];
<a name="l03274"></a>03274    $this-&gt;LineWidth = $saved[ <span class="stringliteral">&#39;linewidth&#39;</span> ];
<a name="l03275"></a>03275    $this-&gt;DrawColor = $saved[ <span class="stringliteral">&#39;drawcolor&#39;</span> ];
<a name="l03276"></a>03276    $this-&gt;outline_on = $saved[ <span class="stringliteral">&#39;is_outline&#39;</span> ];
<a name="l03277"></a>03277    $this-&gt;outlineparam = $saved[ <span class="stringliteral">&#39;outlineparam&#39;</span> ];
<a name="l03278"></a>03278 
<a name="l03279"></a>03279    $this-&gt;toupper = $saved[ <span class="stringliteral">&#39;toupper&#39;</span> ];
<a name="l03280"></a>03280    $this-&gt;tolower = $saved[ <span class="stringliteral">&#39;tolower&#39;</span> ];
<a name="l03281"></a>03281 
<a name="l03282"></a>03282    <span class="comment">// mPDF 4.0</span>
<a name="l03283"></a>03283    $this-&gt;SetFont($FontFamily, $saved[ <span class="stringliteral">&#39;style&#39;</span> ].($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>),$saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ],<span class="keyword">false</span>);
<a name="l03284"></a>03284    <span class="comment">//$this-&gt;currentfontfamily = $saved[ &#39;family&#39; ];</span>
<a name="l03285"></a>03285 
<a name="l03286"></a>03286    $this-&gt;currentfontstyle = $saved[ <span class="stringliteral">&#39;style&#39;</span> ].($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l03287"></a>03287    $this-&gt;currentfontsize = $saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ];
<a name="l03288"></a>03288    $this-&gt;SetStyle(<span class="charliteral">&#39;U&#39;</span>,$this-&gt;underline);
<a name="l03289"></a>03289    $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,$saved[ <span class="charliteral">&#39;B&#39;</span> ]);
<a name="l03290"></a>03290    $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,$saved[ <span class="charliteral">&#39;I&#39;</span> ]);
<a name="l03291"></a>03291 
<a name="l03292"></a>03292    $this-&gt;TextColor = $saved[ <span class="stringliteral">&#39;color&#39;</span> ];
<a name="l03293"></a>03293    $this-&gt;FillColor = $saved[ <span class="stringliteral">&#39;bgcolor&#39;</span> ];
<a name="l03294"></a>03294    $this-&gt;colorarray = $saved[ <span class="stringliteral">&#39;colorarray&#39;</span> ];
<a name="l03295"></a>03295     $cor = $saved[ <span class="stringliteral">&#39;colorarray&#39;</span> ];
<a name="l03296"></a>03296     <span class="keywordflow">if</span> ($cor) $this-&gt;SetTextColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l03297"></a>03297    $this-&gt;spanbgcolorarray = $saved[ <span class="stringliteral">&#39;bgcolorarray&#39;</span> ];
<a name="l03298"></a>03298     $cor = $saved[ <span class="stringliteral">&#39;bgcolorarray&#39;</span> ];
<a name="l03299"></a>03299     <span class="keywordflow">if</span> ($cor) $this-&gt;SetFillColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l03300"></a>03300 }
<a name="l03301"></a>03301 
<a name="l03302"></a>03302 
<a name="l03303"></a>03303 
<a name="l03304"></a>03304 <span class="comment">// mPDF 3.0</span>
<a name="l03305"></a>03305 <span class="comment">// Used when ColActive for tables - updated to return first block with background fill OR borders</span>
<a name="l03306"></a>03306 function GetFirstBlockFill() {
<a name="l03307"></a>03307   <span class="comment">// Returns the first blocklevel that uses a bgcolor fill</span>
<a name="l03308"></a>03308   $startfill = 0;
<a name="l03309"></a>03309   <span class="keywordflow">for</span> ($i=1;$i&lt;=$this-&gt;blklvl;$i++) {
<a name="l03310"></a>03310     <span class="keywordflow">if</span> ($this-&gt;blk[$i][<span class="stringliteral">&#39;bgcolor&#39;</span>] || $this-&gt;blk[$i][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] || $this-&gt;blk[$i][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]  || $this-&gt;blk[$i][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]  || $this-&gt;blk[$i][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]  ) {
<a name="l03311"></a>03311       $startfill = $i;
<a name="l03312"></a>03312       <span class="keywordflow">break</span>;
<a name="l03313"></a>03313     }
<a name="l03314"></a>03314   }
<a name="l03315"></a>03315   <span class="keywordflow">return</span> $startfill;
<a name="l03316"></a>03316 }
<a name="l03317"></a>03317 
<a name="l03318"></a>03318 function SetBlockFill($blvl) {
<a name="l03319"></a>03319   <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;bgcolor&#39;</span>]) {
<a name="l03320"></a>03320     $this-&gt;SetFillColor($this-&gt;blk[$blvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],$this-&gt;blk[$blvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],$this-&gt;blk[$blvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l03321"></a>03321     <span class="keywordflow">return</span> 1;
<a name="l03322"></a>03322   }
<a name="l03323"></a>03323   <span class="keywordflow">else</span> {
<a name="l03324"></a>03324     $this-&gt;SetFillColor(255);
<a name="l03325"></a>03325     <span class="keywordflow">return</span> 0;
<a name="l03326"></a>03326   }
<a name="l03327"></a>03327 }
<a name="l03328"></a>03328 
<a name="l03329"></a>03329 
<a name="l03330"></a>03330 <span class="comment">//-------------------------FLOWING BLOCK------------------------------------//</span>
<a name="l03331"></a>03331 <span class="comment">//The following functions were originally written by Damon Kohler           //</span>
<a name="l03332"></a>03332 <span class="comment">//--------------------------------------------------------------------------//</span>
<a name="l03333"></a>03333 
<a name="l03334"></a>03334 function saveFont() {
<a name="l03335"></a>03335    $saved = array();
<a name="l03336"></a>03336    $saved[ <span class="stringliteral">&#39;family&#39;</span> ] = $this-&gt;FontFamily;
<a name="l03337"></a>03337    $saved[ <span class="stringliteral">&#39;style&#39;</span> ] = $this-&gt;FontStyle;
<a name="l03338"></a>03338    $saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ] = $this-&gt;FontSizePt;
<a name="l03339"></a>03339    $saved[ <span class="stringliteral">&#39;size&#39;</span> ] = $this-&gt;FontSize;
<a name="l03340"></a>03340    $saved[ <span class="stringliteral">&#39;curr&#39;</span> ] = &amp;$this-&gt;CurrentFont;
<a name="l03341"></a>03341    $saved[ <span class="stringliteral">&#39;color&#39;</span> ] = $this-&gt;TextColor; 
<a name="l03342"></a>03342    $saved[ <span class="stringliteral">&#39;spanbgcolor&#39;</span> ] = $this-&gt;spanbgcolor; 
<a name="l03343"></a>03343    $saved[ <span class="stringliteral">&#39;spanbgcolorarray&#39;</span> ] = $this-&gt;spanbgcolorarray; 
<a name="l03344"></a>03344    $saved[ <span class="stringliteral">&#39;HREF&#39;</span> ] = $this-&gt;HREF;
<a name="l03345"></a>03345    $saved[ <span class="stringliteral">&#39;underline&#39;</span> ] = $this-&gt;underline; 
<a name="l03346"></a>03346    $saved[ <span class="stringliteral">&#39;strike&#39;</span> ] = $this-&gt;strike;
<a name="l03347"></a>03347    $saved[ <span class="stringliteral">&#39;SUP&#39;</span> ] = $this-&gt;SUP;
<a name="l03348"></a>03348    $saved[ <span class="stringliteral">&#39;SUB&#39;</span> ] = $this-&gt;SUB;
<a name="l03349"></a>03349    $saved[ <span class="stringliteral">&#39;linewidth&#39;</span> ] = $this-&gt;LineWidth;
<a name="l03350"></a>03350    $saved[ <span class="stringliteral">&#39;drawcolor&#39;</span> ] = $this-&gt;DrawColor;
<a name="l03351"></a>03351    $saved[ <span class="stringliteral">&#39;is_outline&#39;</span> ] = $this-&gt;outline_on;
<a name="l03352"></a>03352    $saved[ <span class="stringliteral">&#39;outlineparam&#39;</span> ] = $this-&gt;outlineparam;
<a name="l03353"></a>03353    <span class="comment">// mPDF 4.2</span>
<a name="l03354"></a>03354    $saved[ <span class="stringliteral">&#39;ReqFontStyle&#39;</span> ] = $this-&gt;ReqFontStyle;
<a name="l03355"></a>03355    <span class="keywordflow">return</span> $saved;
<a name="l03356"></a>03356 }
<a name="l03357"></a>03357 
<a name="l03358"></a>03358 function restoreFont( $saved, $write=<span class="keyword">true</span>) {
<a name="l03359"></a>03359    <span class="keywordflow">if</span> (!isset($saved) || empty($saved)) <span class="keywordflow">return</span>;
<a name="l03360"></a>03360 
<a name="l03361"></a>03361    $this-&gt;FontFamily = $saved[ <span class="stringliteral">&#39;family&#39;</span> ];
<a name="l03362"></a>03362    $this-&gt;FontStyle = $saved[ <span class="stringliteral">&#39;style&#39;</span> ];
<a name="l03363"></a>03363    $this-&gt;FontSizePt = $saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ];
<a name="l03364"></a>03364    $this-&gt;FontSize = $saved[ <span class="stringliteral">&#39;size&#39;</span> ];
<a name="l03365"></a>03365    $this-&gt;CurrentFont = &amp;$saved[ <span class="stringliteral">&#39;curr&#39;</span> ];
<a name="l03366"></a>03366    $this-&gt;TextColor = $saved[ <span class="stringliteral">&#39;color&#39;</span> ]; 
<a name="l03367"></a>03367    $this-&gt;spanbgcolor = $saved[ <span class="stringliteral">&#39;spanbgcolor&#39;</span> ]; 
<a name="l03368"></a>03368    $this-&gt;spanbgcolorarray = $saved[ <span class="stringliteral">&#39;spanbgcolorarray&#39;</span> ]; 
<a name="l03369"></a>03369    $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor); <span class="comment">//Restore ColorFlag as well</span>
<a name="l03370"></a>03370    $this-&gt;HREF = $saved[ <span class="stringliteral">&#39;HREF&#39;</span> ]; 
<a name="l03371"></a>03371    $this-&gt;underline = $saved[ <span class="stringliteral">&#39;underline&#39;</span> ]; 
<a name="l03372"></a>03372    $this-&gt;strike = $saved[ <span class="stringliteral">&#39;strike&#39;</span> ]; 
<a name="l03373"></a>03373    $this-&gt;SUP = $saved[ <span class="stringliteral">&#39;SUP&#39;</span> ]; 
<a name="l03374"></a>03374    $this-&gt;SUB = $saved[ <span class="stringliteral">&#39;SUB&#39;</span> ]; 
<a name="l03375"></a>03375    $this-&gt;LineWidth = $saved[ <span class="stringliteral">&#39;linewidth&#39;</span> ]; 
<a name="l03376"></a>03376    $this-&gt;DrawColor = $saved[ <span class="stringliteral">&#39;drawcolor&#39;</span> ]; 
<a name="l03377"></a>03377    $this-&gt;outline_on = $saved[ <span class="stringliteral">&#39;is_outline&#39;</span> ]; 
<a name="l03378"></a>03378    $this-&gt;outlineparam = $saved[ <span class="stringliteral">&#39;outlineparam&#39;</span> ];
<a name="l03379"></a>03379    <span class="keywordflow">if</span> ($write) { 
<a name="l03380"></a>03380     $this-&gt;SetFont($saved[ <span class="stringliteral">&#39;family&#39;</span> ],$saved[ <span class="stringliteral">&#39;style&#39;</span> ].($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>),$saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ],<span class="keyword">true</span>,<span class="keyword">true</span>);  <span class="comment">// force output</span>
<a name="l03381"></a>03381   $fontout = (sprintf(<span class="stringliteral">&#39;BT /F%d %.3f Tf ET&#39;</span>, $this-&gt;CurrentFont[<span class="charliteral">&#39;i&#39;</span>], $this-&gt;FontSizePt));
<a name="l03382"></a>03382   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] != $fontout) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($fontout); }
<a name="l03383"></a>03383   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>] = $fontout;
<a name="l03384"></a>03384    }
<a name="l03385"></a>03385    <span class="keywordflow">else</span> 
<a name="l03386"></a>03386     $this-&gt;SetFont($saved[ <span class="stringliteral">&#39;family&#39;</span> ],$saved[ <span class="stringliteral">&#39;style&#39;</span> ].($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>),$saved[ <span class="stringliteral">&#39;sizePt&#39;</span> ]);
<a name="l03387"></a>03387    <span class="comment">// mPDF 4.2</span>
<a name="l03388"></a>03388    $this-&gt;ReqFontStyle = $saved[ <span class="stringliteral">&#39;ReqFontStyle&#39;</span> ];
<a name="l03389"></a>03389 }
<a name="l03390"></a>03390 
<a name="l03391"></a>03391 function newFlowingBlock( $w, $h, $a = <span class="stringliteral">&#39;&#39;</span>, $is_table = <span class="keyword">false</span>, $is_list = <span class="keyword">false</span>, $blockstate = 0, $newblock=<span class="keyword">true</span> )
<a name="l03392"></a>03392 {
<a name="l03393"></a>03393    <span class="keywordflow">if</span> (!$a) { $a = $this-&gt;defaultAlign; }
<a name="l03394"></a>03394    <span class="comment">// cell width in points</span>
<a name="l03395"></a>03395 
<a name="l03396"></a>03396    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;width&#39;</span> ] = ($w * $this-&gt;k);
<a name="l03397"></a>03397    <span class="comment">// line height in user units</span>
<a name="l03398"></a>03398    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;is_table&#39;</span> ] = $is_table;
<a name="l03399"></a>03399    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;is_list&#39;</span> ] = $is_list;
<a name="l03400"></a>03400    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;height&#39;</span> ] = $h;
<a name="l03401"></a>03401    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;lineCount&#39;</span> ] = 0;
<a name="l03402"></a>03402    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;align&#39;</span> ] = $a;
<a name="l03403"></a>03403    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;font&#39;</span> ] = array();
<a name="l03404"></a>03404    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;content&#39;</span> ] = array();
<a name="l03405"></a>03405    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;contentWidth&#39;</span> ] = 0;
<a name="l03406"></a>03406    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;blockstate&#39;</span> ] = $blockstate;
<a name="l03407"></a>03407 
<a name="l03408"></a>03408    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;newblock&#39;</span> ] = $newblock;
<a name="l03409"></a>03409    $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;valign&#39;</span> ] = <span class="charliteral">&#39;M&#39;</span>;
<a name="l03410"></a>03410 }
<a name="l03411"></a>03411 
<a name="l03412"></a>03412 function finishFlowingBlock($endofblock=<span class="keyword">false</span>, $next=<span class="stringliteral">&#39;&#39;</span>) {  <span class="comment">// mPDF 4.3.003</span>
<a name="l03413"></a>03413    $currentx = $this-&gt;x;
<a name="l03414"></a>03414    <span class="comment">//prints out the last chunk</span>
<a name="l03415"></a>03415    $is_table = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;is_table&#39;</span> ];
<a name="l03416"></a>03416    $is_list = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;is_list&#39;</span> ];
<a name="l03417"></a>03417    $maxWidth =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;width&#39;</span> ];
<a name="l03418"></a>03418    $lineHeight =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;height&#39;</span> ];
<a name="l03419"></a>03419    $align =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;align&#39;</span> ];
<a name="l03420"></a>03420    $content =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;content&#39;</span> ];
<a name="l03421"></a>03421    $font =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;font&#39;</span> ];
<a name="l03422"></a>03422    $contentWidth =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;contentWidth&#39;</span> ];
<a name="l03423"></a>03423    $lineCount =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;lineCount&#39;</span> ];
<a name="l03424"></a>03424    $valign =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;valign&#39;</span> ];
<a name="l03425"></a>03425    $blockstate = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;blockstate&#39;</span> ];
<a name="l03426"></a>03426 
<a name="l03427"></a>03427    $newblock = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;newblock&#39;</span> ];
<a name="l03428"></a>03428 
<a name="l03429"></a>03429   <span class="comment">// *********** BLOCK BACKGROUND COLOR *****************//</span>
<a name="l03430"></a>03430   <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolor&#39;</span>] &amp;&amp; !$is_table) {
<a name="l03431"></a>03431     <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l03432"></a>03432     $fill = 0;
<a name="l03433"></a>03433 <span class="comment">//    $fill = 1;</span>
<a name="l03434"></a>03434 <span class="comment">//    $bcor = $this-&gt;blk[$this-&gt;blklvl][&#39;bgcolorarray&#39;];</span>
<a name="l03435"></a>03435 <span class="comment">//    $this-&gt;SetFillColor($bcor[&#39;R&#39;],$bcor[&#39;G&#39;],$bcor[&#39;B&#39;]);</span>
<a name="l03436"></a>03436   }
<a name="l03437"></a>03437   <span class="keywordflow">else</span> {
<a name="l03438"></a>03438     $this-&gt;SetFillColor(255);
<a name="l03439"></a>03439     $fill = 0;
<a name="l03440"></a>03440   }
<a name="l03441"></a>03441 
<a name="l03442"></a>03442   <span class="comment">// mPDF 4.0</span>
<a name="l03443"></a>03443 <span class="comment">//  if ($this-&gt;ws != 0) { $this-&gt;_out(&#39;BT 0 Tw ET&#39;); }</span>
<a name="l03444"></a>03444 <span class="comment">//  $this-&gt;ws=0;</span>
<a name="l03445"></a>03445 <span class="comment">//  if ($this-&gt;charspacing != 0) { $this-&gt;_out(&#39;BT 0 Tc ET&#39;); }</span>
<a name="l03446"></a>03446 <span class="comment">//  $this-&gt;charspacing=0;</span>
<a name="l03447"></a>03447 
<a name="l03448"></a>03448   <span class="comment">// mPDF 4.3.003</span>
<a name="l03449"></a>03449   <span class="comment">// Right trim content and adjust width if need to justify (later)</span>
<a name="l03450"></a>03450   <span class="keywordflow">if</span> (!$endofblock &amp;&amp; $align==<span class="charliteral">&#39;J&#39;</span> &amp;&amp; ($next==<span class="stringliteral">&#39;image&#39;</span> || $next==<span class="stringliteral">&#39;select&#39;</span> || $next==<span class="stringliteral">&#39;input&#39;</span> || $next==<span class="stringliteral">&#39;textarea&#39;</span> || ($next==<span class="stringliteral">&#39;br&#39;</span> &amp;&amp; $this-&gt;justifyB4br))) {
<a name="l03451"></a>03451     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/[ ]+$/&#39;</span>,$content[count($content)-1], $m)) {
<a name="l03452"></a>03452       $strip = strlen($m[0]);
<a name="l03453"></a>03453       $content[count($content)-1] = substr($content[count($content)-1],0,(strlen($content[count($content)-1])-$strip));
<a name="l03454"></a>03454       $this-&gt;restoreFont( $font[ count($content)-1 ],<span class="keyword">false</span> );
<a name="l03455"></a>03455       $contentWidth -= $this-&gt;GetStringWidth($m[0]) * $this-&gt;k;
<a name="l03456"></a>03456     }
<a name="l03457"></a>03457   }
<a name="l03458"></a>03458 
<a name="l03459"></a>03459   <span class="comment">// the amount of space taken up so far in user units</span>
<a name="l03460"></a>03460   $usedWidth = 0;
<a name="l03461"></a>03461 
<a name="l03462"></a>03462   <span class="comment">// COLS</span>
<a name="l03463"></a>03463   $oldcolumn = $this-&gt;CurrCol;
<a name="l03464"></a>03464 
<a name="l03465"></a>03465 
<a name="l03466"></a>03466   <span class="comment">// Print out each chunk</span>
<a name="l03467"></a>03467 
<a name="l03468"></a>03468   <span class="keywordflow">if</span> ($is_table) { 
<a name="l03469"></a>03469     $ipaddingL = 0; 
<a name="l03470"></a>03470     $ipaddingR = 0; 
<a name="l03471"></a>03471     $paddingL = 0;
<a name="l03472"></a>03472     $paddingR = 0;
<a name="l03473"></a>03473   } 
<a name="l03474"></a>03474   <span class="keywordflow">else</span> { 
<a name="l03475"></a>03475     $ipaddingL = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>]; 
<a name="l03476"></a>03476     $ipaddingR = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_right&#39;</span>]; 
<a name="l03477"></a>03477     $paddingL = ($ipaddingL * $this-&gt;k); 
<a name="l03478"></a>03478     $paddingR = ($ipaddingR * $this-&gt;k);
<a name="l03479"></a>03479     $this-&gt;cMarginL =  $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l03480"></a>03480     $this-&gt;cMarginR =  $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l03481"></a>03481 
<a name="l03482"></a>03482     <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l03483"></a>03483     $fpaddingR = 0;
<a name="l03484"></a>03484     $fpaddingL = 0;
<a name="l03485"></a>03485     <span class="keywordflow">if</span> (count($this-&gt;floatDivs)) {
<a name="l03486"></a>03486       list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl);
<a name="l03487"></a>03487       <span class="keywordflow">if</span> ($r_exists) { $fpaddingR = $r_width; }
<a name="l03488"></a>03488       <span class="keywordflow">if</span> ($l_exists) { $fpaddingL = $l_width; }
<a name="l03489"></a>03489     }
<a name="l03490"></a>03490 
<a name="l03491"></a>03491     $usey = $this-&gt;y + 0.002;
<a name="l03492"></a>03492     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 0) ) { 
<a name="l03493"></a>03493       $usey += $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l03494"></a>03494     }
<a name="l03495"></a>03495     <span class="comment">// If float exists at this level</span>
<a name="l03496"></a>03496     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingR += $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l03497"></a>03497     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingL += $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l03498"></a>03498   } <span class="comment">// *TABLES*</span>
<a name="l03499"></a>03499 
<a name="l03500"></a>03500     <span class="comment">// Set Current lineheight (correction factor)</span>
<a name="l03501"></a>03501     $lhfixed = <span class="keyword">false</span>; 
<a name="l03502"></a>03502     <span class="keywordflow">if</span> ($is_list) {
<a name="l03503"></a>03503       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;listOcc],$am)) { 
<a name="l03504"></a>03504         $lhfixed = <span class="keyword">true</span>; 
<a name="l03505"></a>03505         $def_fontsize = $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$this-&gt;listlvl][$this-&gt;listOcc][$this-&gt;listnum][<span class="stringliteral">&#39;size&#39;</span>];
<a name="l03506"></a>03506         $this-&gt;lineheight_correction = $am[1] / $def_fontsize ;
<a name="l03507"></a>03507       }
<a name="l03508"></a>03508       <span class="keywordflow">else</span> { 
<a name="l03509"></a>03509         $this-&gt;lineheight_correction = $this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;listOcc]; 
<a name="l03510"></a>03510       }
<a name="l03511"></a>03511     }
<a name="l03512"></a>03512     <span class="keywordflow">else</span>
<a name="l03513"></a>03513     <span class="keywordflow">if</span> ($is_table) {
<a name="l03514"></a>03514       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;table_lineheight,$am)) { 
<a name="l03515"></a>03515         $lhfixed = <span class="keyword">true</span>; 
<a name="l03516"></a>03516         $def_fontsize = $this-&gt;FontSize;        <span class="comment">// needs to be default font-size for block ****</span>
<a name="l03517"></a>03517         $this-&gt;lineheight_correction = $lineHeight / $def_fontsize ; 
<a name="l03518"></a>03518       }
<a name="l03519"></a>03519       <span class="keywordflow">else</span> { 
<a name="l03520"></a>03520         $this-&gt;lineheight_correction = $this-&gt;table_lineheight; 
<a name="l03521"></a>03521       }
<a name="l03522"></a>03522     }
<a name="l03523"></a>03523     <span class="keywordflow">else</span>
<a name="l03524"></a>03524     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) {
<a name="l03525"></a>03525       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>],$am)) { 
<a name="l03526"></a>03526         $lhfixed = <span class="keyword">true</span>; 
<a name="l03527"></a>03527         $def_fontsize = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>];  <span class="comment">// needs to be default font-size for block ****</span>
<a name="l03528"></a>03528         $this-&gt;lineheight_correction = $am[1] / $def_fontsize ;
<a name="l03529"></a>03529       }
<a name="l03530"></a>03530       <span class="keywordflow">else</span> { 
<a name="l03531"></a>03531         $this-&gt;lineheight_correction = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]; 
<a name="l03532"></a>03532       }
<a name="l03533"></a>03533     } 
<a name="l03534"></a>03534     <span class="keywordflow">else</span> {
<a name="l03535"></a>03535       $this-&gt;lineheight_correction = $this-&gt;normalLineheight; 
<a name="l03536"></a>03536     }
<a name="l03537"></a>03537 
<a name="l03538"></a>03538     <span class="comment">// mPDF 4.2</span>
<a name="l03539"></a>03539     <span class="comment">//  correct lineheight to maximum fontsize</span>
<a name="l03540"></a>03540     <span class="keywordflow">if</span> ($lhfixed) { $maxlineHeight = $this-&gt;lineheight; }
<a name="l03541"></a>03541     <span class="keywordflow">else</span> { $maxlineHeight = 0; }
<a name="l03542"></a>03542     $this-&gt;forceExactLineheight = <span class="keyword">true</span>;
<a name="l03543"></a>03543     $maxfontsize = 0;
<a name="l03544"></a>03544     <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk )
<a name="l03545"></a>03545     {
<a name="l03546"></a>03546               $this-&gt;restoreFont( $font[ $k ],<span class="keyword">false</span> );
<a name="l03547"></a>03547       <span class="keywordflow">if</span> (!isset($this-&gt;objectbuffer[$k])) { 
<a name="l03548"></a>03548       <span class="keywordflow">if</span> ($this-&gt;is_MB) {
<a name="l03549"></a>03549             $content[$k] = $chunk = str_replace(<span class="stringliteral">&quot;\xc2\xad&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$chunk ); 
<a name="l03550"></a>03550       }
<a name="l03551"></a>03551       <span class="comment">// mPDF 3.0 Soft Hyphens chr(173)</span>
<a name="l03552"></a>03552       <span class="keywordflow">else</span>
<a name="l03553"></a>03553       <span class="keywordflow">if</span> ($this-&gt;FontFamily!=<span class="stringliteral">&#39;symbol&#39;</span> &amp;&amp; $this-&gt;FontFamily!=<span class="stringliteral">&#39;zapfdingbats&#39;</span>) {
<a name="l03554"></a>03554             $content[$k] = $chunk = str_replace($this-&gt;chrs[173],<span class="stringliteral">&#39;&#39;</span>,$chunk );
<a name="l03555"></a>03555       }
<a name="l03556"></a>03556       <span class="comment">// Special case of sub/sup carried over on its own to last line</span>
<a name="l03557"></a>03557       <span class="keywordflow">if</span> (($this-&gt;SUB || $this-&gt;SUP) &amp;&amp; count($content)==1) { $actfs = $this-&gt;FontSize*100/55; } <span class="comment">// 55% is font change for sub/sup</span>
<a name="l03558"></a>03558       <span class="keywordflow">else</span> { $actfs = $this-&gt;FontSize; }
<a name="l03559"></a>03559       <span class="comment">// mPDF 4.2</span>
<a name="l03560"></a>03560       <span class="keywordflow">if</span> (!$lhfixed) { $maxlineHeight = max($maxlineHeight,$actfs * $this-&gt;lineheight_correction ); }
<a name="l03561"></a>03561       <span class="keywordflow">if</span> ($lhfixed &amp;&amp; ($actfs &gt; $def_fontsize || ($actfs &gt; ($lineHeight * $this-&gt;lineheight_correction) &amp;&amp; $is_list))) { 
<a name="l03562"></a>03562         $this-&gt;forceExactLineheight = <span class="keyword">false</span>; 
<a name="l03563"></a>03563       }
<a name="l03564"></a>03564       $maxfontsize = max($maxfontsize,$actfs);
<a name="l03565"></a>03565       }
<a name="l03566"></a>03566     }
<a name="l03567"></a>03567 
<a name="l03568"></a>03568     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03569"></a>03569     $lastfontreqstyle = $font[count($font)-1][<span class="stringliteral">&#39;ReqFontStyle&#39;</span>];
<a name="l03570"></a>03570     $lastfontstyle = $font[count($font)-1][<span class="stringliteral">&#39;style&#39;</span>];
<a name="l03571"></a>03571     <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;ltr&#39;</span> &amp;&amp; strpos($lastfontreqstyle,<span class="stringliteral">&quot;I&quot;</span>) !== <span class="keyword">false</span> &amp;&amp; strpos($lastfontstyle,<span class="stringliteral">&quot;I&quot;</span>) === <span class="keyword">false</span>) {  <span class="comment">// Artificial italic</span>
<a name="l03572"></a>03572       $lastitalic = $this-&gt;FontSize*0.15*$this-&gt;k;
<a name="l03573"></a>03573     }
<a name="l03574"></a>03574     <span class="keywordflow">else</span> { $lastitalic = 0; }
<a name="l03575"></a>03575 
<a name="l03576"></a>03576 
<a name="l03577"></a>03577     <span class="comment">// mPDF 4.2 Moved here from later</span>
<a name="l03578"></a>03578     <span class="keywordflow">if</span> ($is_list &amp;&amp; is_array($this-&gt;bulletarray) &amp;&amp; count($this-&gt;bulletarray)) {
<a name="l03579"></a>03579         $actfs = $this-&gt;bulletarray[<span class="stringliteral">&#39;fontsize&#39;</span>];
<a name="l03580"></a>03580       <span class="keywordflow">if</span> (!$lhfixed) { $maxlineHeight = max($maxlineHeight,$actfs * $this-&gt;lineheight_correction );  }  <span class="comment">// mPDF 4.2</span>
<a name="l03581"></a>03581       <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $actfs &gt; $def_fontsize) { $this-&gt;forceExactLineheight = <span class="keyword">false</span>; }
<a name="l03582"></a>03582       $maxfontsize = max($maxfontsize,$actfs);
<a name="l03583"></a>03583     }
<a name="l03584"></a>03584 
<a name="l03585"></a>03585     <span class="comment">// when every text item checked i.e. $maxfontsize is set properly</span>
<a name="l03586"></a>03586 
<a name="l03587"></a>03587     $af = 0;  <span class="comment">// Above font</span>
<a name="l03588"></a>03588     $bf = 0;  <span class="comment">// Below font</span>
<a name="l03589"></a>03589     $mta = 0; <span class="comment">// Maximum top-aligned </span>
<a name="l03590"></a>03590     $mba = 0; <span class="comment">// Maximum bottom-aligned </span>
<a name="l03591"></a>03591 
<a name="l03592"></a>03592     <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk )
<a name="l03593"></a>03593     {
<a name="l03594"></a>03594       <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[$k])) { 
<a name="l03595"></a>03595       $oh = $this-&gt;objectbuffer[$k][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l03596"></a>03596       $va = $this-&gt;objectbuffer[$k][<span class="stringliteral">&#39;vertical-align&#39;</span>]; <span class="comment">// = $objattr[&#39;vertical-align&#39;] = set as M,T,B,S</span>
<a name="l03597"></a>03597       <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $oh &gt; $def_fontsize) { $this-&gt;forceExactLineheight = <span class="keyword">false</span>; }
<a name="l03598"></a>03598 
<a name="l03599"></a>03599       <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;BS&#39;</span>) {  <span class="comment">//  (BASELINE default)</span>
<a name="l03600"></a>03600         $af = max($af, ($oh - ($maxfontsize * (0.5 + $this-&gt;baselineC))));
<a name="l03601"></a>03601       }
<a name="l03602"></a>03602       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;M&#39;</span>) { 
<a name="l03603"></a>03603         $af = max($af, ($oh - $maxfontsize)/2);
<a name="l03604"></a>03604         $bf = max($bf, ($oh - $maxfontsize)/2);
<a name="l03605"></a>03605       }
<a name="l03606"></a>03606       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TT&#39;</span>) { 
<a name="l03607"></a>03607         $bf = max($bf, ($oh - $maxfontsize));
<a name="l03608"></a>03608       }
<a name="l03609"></a>03609       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TB&#39;</span>) { 
<a name="l03610"></a>03610         $af = max($af, ($oh - $maxfontsize));
<a name="l03611"></a>03611       }
<a name="l03612"></a>03612       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;T&#39;</span>) { 
<a name="l03613"></a>03613         $mta = max($mta, $oh);
<a name="l03614"></a>03614       }
<a name="l03615"></a>03615       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;B&#39;</span>) { 
<a name="l03616"></a>03616         $mba = max($mba, $oh);
<a name="l03617"></a>03617       }
<a name="l03618"></a>03618       }
<a name="l03619"></a>03619     }
<a name="l03620"></a>03620     <span class="keywordflow">if</span> ((!$lhfixed || !$this-&gt;forceExactLineheight) &amp;&amp; ($af &gt; (($maxlineHeight - $maxfontsize)/2) || $bf &gt; (($maxlineHeight - $maxfontsize)/2))) {
<a name="l03621"></a>03621       $maxlineHeight = $maxfontsize + $af + $bf;
<a name="l03622"></a>03622     }
<a name="l03623"></a>03623     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$lhfixed) { $af = $bf = ($maxlineHeight - $maxfontsize)/2; }
<a name="l03624"></a>03624     <span class="keywordflow">if</span> ($mta &gt; $maxlineHeight) { 
<a name="l03625"></a>03625       $bf += ($mta - $maxlineHeight);
<a name="l03626"></a>03626       $maxlineHeight = $mta;
<a name="l03627"></a>03627     }
<a name="l03628"></a>03628     <span class="keywordflow">if</span> ($mba &gt; $maxlineHeight) { 
<a name="l03629"></a>03629       $af += ($mba - $maxlineHeight);
<a name="l03630"></a>03630       $maxlineHeight = $mba;
<a name="l03631"></a>03631     }
<a name="l03632"></a>03632 
<a name="l03633"></a>03633     $lineHeight = $maxlineHeight;
<a name="l03634"></a>03634     <span class="comment">// mPDF 4.2 If NOT images, and maxfontsize NOT &gt; lineHeight - this value determines text baseline positioning</span>
<a name="l03635"></a>03635     <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $af==0 &amp;&amp; $bf==0 &amp;&amp; $maxfontsize&lt;=($def_fontsize * $this-&gt;lineheight_correction * 0.8 )) { 
<a name="l03636"></a>03636       $this-&gt;linemaxfontsize = $def_fontsize; 
<a name="l03637"></a>03637     }
<a name="l03638"></a>03638     <span class="keywordflow">else</span> { $this-&gt;linemaxfontsize = $maxfontsize; }
<a name="l03639"></a>03639 
<a name="l03640"></a>03640     <span class="comment">// Get PAGEBREAK TO TEST for height including the bottom border/padding</span>
<a name="l03641"></a>03641     $check_h = max($this-&gt;divheight,$lineHeight);
<a name="l03642"></a>03642 
<a name="l03643"></a>03643     <span class="keywordflow">if</span> ($this-&gt;blklvl &gt; 0 &amp;&amp; !$is_table) { 
<a name="l03644"></a>03644        <span class="keywordflow">if</span> ($endofblock &amp;&amp; $blockstate &gt; 1) { 
<a name="l03645"></a>03645       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;page_break_after_avoid&#39;</span>]) {  $check_h += $lineHeight; }
<a name="l03646"></a>03646       $check_h += ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]);
<a name="l03647"></a>03647        }
<a name="l03648"></a>03648        <span class="keywordflow">if</span> (($newblock &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; $lineCount == 0) || ($endofblock &amp;&amp; $blockstate &gt; 1 &amp;&amp; $lineCount == 0)) { 
<a name="l03649"></a>03649       $check_h += ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]);
<a name="l03650"></a>03650        }
<a name="l03651"></a>03651     }
<a name="l03652"></a>03652 
<a name="l03653"></a>03653     <span class="comment">// mPDF 4.2 Force PAGE break if column height cannot take check-height</span>
<a name="l03654"></a>03654     <span class="keywordflow">if</span> ($this-&gt;ColActive &amp;&amp; $check_h &gt; ($this-&gt;PageBreakTrigger - $this-&gt;y0)) { $this-&gt;CurrCol = $this-&gt;NbCol; } 
<a name="l03655"></a>03655 
<a name="l03656"></a>03656     <span class="comment">// PAGEBREAK</span>
<a name="l03657"></a>03657     <span class="comment">//&#39;If&#39; below used in order to fix &quot;first-line of other page with justify on&quot; bug</span>
<a name="l03658"></a>03658     <span class="comment">// mPDF 4.2.008 Disable in Tables</span>
<a name="l03659"></a>03659     <span class="keywordflow">if</span>(!$is_table &amp;&amp; $this-&gt;y+$check_h &gt; $this-&gt;PageBreakTrigger and !$this-&gt;InFooter and $this-&gt;AcceptPageBreak()) {
<a name="l03660"></a>03660               $bak_x=$this-&gt;x;<span class="comment">//Current X position</span>
<a name="l03661"></a>03661       <span class="comment">// WORD SPACING</span>
<a name="l03662"></a>03662       $ws=$this-&gt;ws;<span class="comment">//Word Spacing</span>
<a name="l03663"></a>03663       $charspacing=$this-&gt;charspacing;<span class="comment">//Character Spacing</span>
<a name="l03664"></a>03664       <span class="comment">// mPDF 4.0</span>
<a name="l03665"></a>03665       $this-&gt;ResetSpacing();
<a name="l03666"></a>03666 
<a name="l03667"></a>03667           $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l03668"></a>03668 
<a name="l03669"></a>03669           $this-&gt;x=$bak_x;
<a name="l03670"></a>03670       <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l03671"></a>03671       $currentx += $this-&gt;MarginCorrection;
<a name="l03672"></a>03672       $this-&gt;x += $this-&gt;MarginCorrection;
<a name="l03673"></a>03673 
<a name="l03674"></a>03674       <span class="comment">// WORD SPACING</span>
<a name="l03675"></a>03675       <span class="comment">// mPDF 4.0</span>
<a name="l03676"></a>03676       $this-&gt;SetSpacing($charspacing,$ws);
<a name="l03677"></a>03677     }
<a name="l03678"></a>03678 
<a name="l03679"></a>03679 
<a name="l03680"></a>03680     <span class="comment">// TOP MARGIN</span>
<a name="l03681"></a>03681     <span class="keywordflow">if</span> ($newblock &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>]) &amp;&amp; $lineCount == 0 &amp;&amp; !$is_table &amp;&amp; !$is_list) { 
<a name="l03682"></a>03682       $this-&gt;DivLn($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>],$this-&gt;blklvl-1,<span class="keyword">true</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_collapse&#39;</span>]); 
<a name="l03683"></a>03683     }
<a name="l03684"></a>03684 
<a name="l03685"></a>03685     <span class="keywordflow">if</span> ($newblock &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; $lineCount == 0 &amp;&amp; !$is_table &amp;&amp; !$is_list) { 
<a name="l03686"></a>03686       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l03687"></a>03687       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] = $this-&gt;page;
<a name="l03688"></a>03688     }
<a name="l03689"></a>03689 
<a name="l03690"></a>03690   <span class="comment">// ADDED for Paragraph_indent</span>
<a name="l03691"></a>03691   $WidthCorrection = 0;
<a name="l03692"></a>03692   <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>]) &amp;&amp; ($lineCount == 0) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list) &amp;&amp; ($align != <span class="charliteral">&#39;C&#39;</span>)) { 
<a name="l03693"></a>03693     <span class="comment">// mPDF 4.0</span>
<a name="l03694"></a>03694     $ti = $this-&gt;ConvertSize($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l03695"></a>03695     $WidthCorrection = ($ti*$this-&gt;k); 
<a name="l03696"></a>03696   } 
<a name="l03697"></a>03697 
<a name="l03698"></a>03698 
<a name="l03699"></a>03699   <span class="comment">// PADDING and BORDER spacing/fill</span>
<a name="l03700"></a>03700   <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>]) || ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>])) &amp;&amp; ($lineCount == 0) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l03701"></a>03701       <span class="comment">// mPDF 3.0 Also does border when Columns active</span>
<a name="l03702"></a>03702       <span class="comment">// $state = 0 normal; 1 top; 2 bottom; 3 top and bottom</span>
<a name="l03703"></a>03703       $this-&gt;DivLn($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>],-3,<span class="keyword">true</span>,<span class="keyword">false</span>,1); 
<a name="l03704"></a>03704       $this-&gt;x = $currentx;
<a name="l03705"></a>03705   }
<a name="l03706"></a>03706 
<a name="l03707"></a>03707 
<a name="l03708"></a>03708   <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l03709"></a>03709   $fpaddingR = 0;
<a name="l03710"></a>03710   $fpaddingL = 0;
<a name="l03711"></a>03711   <span class="keywordflow">if</span> (count($this-&gt;floatDivs)) {
<a name="l03712"></a>03712     list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl);
<a name="l03713"></a>03713     <span class="keywordflow">if</span> ($r_exists) { $fpaddingR = $r_width; }
<a name="l03714"></a>03714     <span class="keywordflow">if</span> ($l_exists) { $fpaddingL = $l_width; }
<a name="l03715"></a>03715   }
<a name="l03716"></a>03716 
<a name="l03717"></a>03717   $usey = $this-&gt;y + 0.002;
<a name="l03718"></a>03718   <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 0) ) { 
<a name="l03719"></a>03719     $usey += $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l03720"></a>03720   }
<a name="l03721"></a>03721   <span class="comment">// If float exists at this level</span>
<a name="l03722"></a>03722   <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingR += $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l03723"></a>03723   <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingL += $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l03724"></a>03724 
<a name="l03725"></a>03725   <span class="keywordflow">if</span> ($content) {
<a name="l03726"></a>03726     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03727"></a>03727     $empty = $maxWidth - $lastitalic-$WidthCorrection - $contentWidth - (($this-&gt;cMarginL+$this-&gt;cMarginR)* $this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) );
<a name="l03728"></a>03728     $empty /= $this-&gt;k;
<a name="l03729"></a>03729 
<a name="l03730"></a>03730     <span class="comment">// In FinishFlowing Block no lines are justified as it is always last line</span>
<a name="l03731"></a>03731     <span class="comment">// but if orphansAllowed have allowed content width to go over max width, use J charspacing to compress line</span>
<a name="l03732"></a>03732     <span class="comment">// JUSTIFICATION J - NOT!</span>
<a name="l03733"></a>03733     $nb_carac = 0;
<a name="l03734"></a>03734     $nb_spaces = 0;
<a name="l03735"></a>03735     <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk ) {
<a name="l03736"></a>03736       <span class="keywordflow">if</span> (!isset($this-&gt;objectbuffer[$k]) || (isset($this-&gt;objectbuffer[$k]) &amp;&amp; !$this-&gt;objectbuffer[$k])) {
<a name="l03737"></a>03737         <span class="keywordflow">if</span> ($this-&gt;is_MB) {
<a name="l03738"></a>03738               $chunk = str_replace($this-&gt;chrs[194].$this-&gt;chrs[160],$this-&gt;chrs[32],$chunk ); 
<a name="l03739"></a>03739         }
<a name="l03740"></a>03740         <span class="keywordflow">else</span> {
<a name="l03741"></a>03741               $chunk = str_replace($this-&gt;chrs[160],$this-&gt;chrs[32],$chunk );
<a name="l03742"></a>03742         } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l03743"></a>03743         $nb_carac += mb_strlen( $chunk, $this-&gt;mb_enc );  
<a name="l03744"></a>03744         $nb_spaces += mb_substr_count( $chunk,<span class="charliteral">&#39; &#39;</span>, $this-&gt;mb_enc );  
<a name="l03745"></a>03745       }
<a name="l03746"></a>03746     }
<a name="l03747"></a>03747     <span class="comment">// if it&#39;s justified, we need to find the char/word spacing (or if orphans have allowed length of line to go over the maxwidth)</span>
<a name="l03748"></a>03748     <span class="comment">// If &quot;orphans&quot; in fact is just a final space - ignore this</span>
<a name="l03749"></a>03749     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03750"></a>03750     <span class="comment">// mPDF 4.3.003  Justify line if following is object - image etc.</span>
<a name="l03751"></a>03751     <span class="keywordflow">if</span> (((($contentWidth + $lastitalic) &gt; $maxWidth) &amp;&amp; ($content[count($content)-1] != <span class="charliteral">&#39; &#39;</span>) )  ||
<a name="l03752"></a>03752       (!$endofblock &amp;&amp; $align==<span class="charliteral">&#39;J&#39;</span> &amp;&amp; ($next==<span class="stringliteral">&#39;image&#39;</span> || $next==<span class="stringliteral">&#39;select&#39;</span> || $next==<span class="stringliteral">&#39;input&#39;</span> || $next==<span class="stringliteral">&#39;textarea&#39;</span> || ($next==<span class="stringliteral">&#39;br&#39;</span> &amp;&amp; $this-&gt;justifyB4br)))
<a name="l03753"></a>03753       ) {
<a name="l03754"></a>03754       <span class="comment">// WORD SPACING</span>
<a name="l03755"></a>03755       <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03756"></a>03756       list($charspacing,$ws) = $this-&gt;GetJspacing($nb_carac,$nb_spaces,($maxWidth-$lastitalic-$contentWidth-$WidthCorrection-(($this-&gt;cMarginL+$this-&gt;cMarginR)*$this-&gt;k)-($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) )));
<a name="l03757"></a>03757       <span class="comment">// mPDF 4.0</span>
<a name="l03758"></a>03758       $this-&gt;SetSpacing($charspacing,$ws);
<a name="l03759"></a>03759     }
<a name="l03760"></a>03760     <span class="comment">// mPDF 4.0 Check if will fit at word/char spacing of previous line - if so continue it</span>
<a name="l03761"></a>03761     <span class="comment">// but only allow a maximum of $this-&gt;jSmaxWordLast and $this-&gt;jSmaxCharLast</span>
<a name="l03762"></a>03762     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03763"></a>03763     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($contentWidth &lt; ($maxWidth - $lastitalic-$WidthCorrection - (($this-&gt;cMarginL+$this-&gt;cMarginR)* $this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k)))) {
<a name="l03764"></a>03764       <span class="keywordflow">if</span> ($this-&gt;ws &gt; $this-&gt;jSmaxWordLast) {
<a name="l03765"></a>03765         $ws=$this-&gt;jSmaxWord;
<a name="l03766"></a>03766         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;BT %.3f Tw ET&#39;</span>,$ws)); 
<a name="l03767"></a>03767         $this-&gt;ws=$ws;
<a name="l03768"></a>03768       }
<a name="l03769"></a>03769       <span class="keywordflow">if</span> ($this-&gt;charspacing &gt; $this-&gt;jSmaxCharLast) {
<a name="l03770"></a>03770         $charspacing=$this-&gt;jSmaxCharLast;
<a name="l03771"></a>03771         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;BT %.3f Tc ET&#39;</span>,$charspacing)); 
<a name="l03772"></a>03772         $this-&gt;charspacing=$charspacing;
<a name="l03773"></a>03773       }
<a name="l03774"></a>03774       <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03775"></a>03775       $check = $maxWidth - $lastitalic-$WidthCorrection - $contentWidth - (($this-&gt;cMarginL+$this-&gt;cMarginR)* $this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) ) - ( $this-&gt;charspacing * $nb_carac) - ( $this-&gt;ws * $nb_spaces);
<a name="l03776"></a>03776       <span class="keywordflow">if</span> ($check &lt;= 0) {
<a name="l03777"></a>03777         <span class="comment">// mPDF 4.0</span>
<a name="l03778"></a>03778         $this-&gt;ResetSpacing();
<a name="l03779"></a>03779       }
<a name="l03780"></a>03780     }
<a name="l03781"></a>03781     <span class="keywordflow">else</span> {
<a name="l03782"></a>03782       <span class="comment">// mPDF 4.0</span>
<a name="l03783"></a>03783       $this-&gt;ResetSpacing();
<a name="l03784"></a>03784     }
<a name="l03785"></a>03785 
<a name="l03786"></a>03786     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l03787"></a>03787     $empty = $maxWidth - $lastitalic-$WidthCorrection - $contentWidth - (($this-&gt;cMarginL+$this-&gt;cMarginR)* $this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) ) - ( $this-&gt;charspacing * $nb_carac) - ( $this-&gt;ws * $nb_spaces);
<a name="l03788"></a>03788     $empty /= $this-&gt;k;
<a name="l03789"></a>03789 
<a name="l03790"></a>03790     <span class="comment">// mPDF 4.0</span>
<a name="l03791"></a>03791     <span class="keywordflow">if</span> (!$is_table) { 
<a name="l03792"></a>03792       $this-&gt;maxPosR = max($this-&gt;maxPosR , ($this-&gt;w - $this-&gt;rMargin - $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_right_margin&#39;</span>] - $empty)); 
<a name="l03793"></a>03793       $this-&gt;maxPosL = min($this-&gt;maxPosL , ($this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $empty)); 
<a name="l03794"></a>03794     }
<a name="l03795"></a>03795 
<a name="l03796"></a>03796     $arraysize = count($content);
<a name="l03797"></a>03797 
<a name="l03798"></a>03798     $margins = ($this-&gt;cMarginL+$this-&gt;cMarginR) + ($ipaddingL+$ipaddingR + $fpaddingR + $fpaddingR );
<a name="l03799"></a>03799 
<a name="l03800"></a>03800     <span class="keywordflow">if</span> (!$is_table) { $this-&gt;DivLn($lineHeight,$this-&gt;blklvl,<span class="keyword">false</span>); }  <span class="comment">// false -&gt; don&#39;t advance y</span>
<a name="l03801"></a>03801 
<a name="l03802"></a>03802     <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l03803"></a>03803     $all_rtl = <span class="keyword">false</span>;
<a name="l03804"></a>03804     $contains_rtl = <span class="keyword">false</span>;
<a name="l03805"></a>03805 
<a name="l03806"></a>03806 
<a name="l03807"></a>03807     $this-&gt;x = $currentx + $this-&gt;cMarginL + $ipaddingL + $fpaddingL;
<a name="l03808"></a>03808     <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;R&#39;</span>) { $this-&gt;x += $empty; }
<a name="l03809"></a>03809     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;J&#39;</span>) {
<a name="l03810"></a>03810       <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span> &amp;&amp; $contains_rtl) { $this-&gt;x += $empty; }
<a name="l03811"></a>03811       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;ltr&#39;</span> &amp;&amp; $all_rtl) { $this-&gt;x += $empty; }
<a name="l03812"></a>03812     }
<a name="l03813"></a>03813     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;C&#39;</span>) { $this-&gt;x += ($empty / 2); }
<a name="l03814"></a>03814 
<a name="l03815"></a>03815     <span class="comment">// Paragraph INDENT</span>
<a name="l03816"></a>03816     $WidthCorrection = 0; 
<a name="l03817"></a>03817     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>]) &amp;&amp; ($lineCount == 0) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list) &amp;&amp; ($align !=<span class="charliteral">&#39;C&#39;</span>)) { 
<a name="l03818"></a>03818       <span class="comment">// mPDF 4.0</span>
<a name="l03819"></a>03819       $ti = $this-&gt;ConvertSize($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l03820"></a>03820       $this-&gt;x += $ti; 
<a name="l03821"></a>03821     }
<a name="l03822"></a>03822 
<a name="l03823"></a>03823 
<a name="l03824"></a>03824           <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk )
<a name="l03825"></a>03825           {
<a name="l03826"></a>03826 
<a name="l03827"></a>03827       <span class="comment">// FOR IMAGES</span>
<a name="l03828"></a>03828     <span class="keywordflow">if</span> (($this-&gt;directionality==<span class="stringliteral">&#39;rtl&#39;</span> &amp;&amp; $contains_rtl) || $all_rtl) { $dirk = $arraysize-1 - $k; } <span class="keywordflow">else</span> { $dirk = $k; }
<a name="l03829"></a>03829 
<a name="l03830"></a>03830     <span class="comment">// mPDF 4.2</span>
<a name="l03831"></a>03831     $va = <span class="charliteral">&#39;M&#39;</span>;  <span class="comment">// default for text</span>
<a name="l03832"></a>03832     <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[$dirk]) &amp;&amp; $this-&gt;objectbuffer[$dirk]) {
<a name="l03833"></a>03833       $xadj = $this-&gt;x - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-X&#39;</span>]; 
<a name="l03834"></a>03834       $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-X&#39;</span>] += $xadj;
<a name="l03835"></a>03835       $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;BORDER-X&#39;</span>] += $xadj;
<a name="l03836"></a>03836       $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;INNER-X&#39;</span>] += $xadj;
<a name="l03837"></a>03837       <span class="comment">// mPDF 4.2</span>
<a name="l03838"></a>03838       $va = $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;vertical-align&#39;</span>];
<a name="l03839"></a>03839       $yadj = $this-&gt;y - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-Y&#39;</span>];
<a name="l03840"></a>03840       <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;BS&#39;</span>) { 
<a name="l03841"></a>03841         $yadj += $af + ($this-&gt;linemaxfontsize * (0.5 + $this-&gt;baselineC)) - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l03842"></a>03842       }
<a name="l03843"></a>03843       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;M&#39;</span> || $va == <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l03844"></a>03844         $yadj += $af + ($this-&gt;linemaxfontsize /2) - ($this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>]/2);
<a name="l03845"></a>03845       }
<a name="l03846"></a>03846       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TB&#39;</span>) { 
<a name="l03847"></a>03847         $yadj += $af + $this-&gt;linemaxfontsize - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l03848"></a>03848       }
<a name="l03849"></a>03849       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TT&#39;</span>) { 
<a name="l03850"></a>03850         $yadj += $af;
<a name="l03851"></a>03851       }
<a name="l03852"></a>03852       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;B&#39;</span>) { 
<a name="l03853"></a>03853         $yadj += $af + $this-&gt;linemaxfontsize + $bf - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l03854"></a>03854       }
<a name="l03855"></a>03855       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;T&#39;</span>) { 
<a name="l03856"></a>03856         $yadj += 0;
<a name="l03857"></a>03857       }
<a name="l03858"></a>03858       $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-Y&#39;</span>] += $yadj;
<a name="l03859"></a>03859       $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;BORDER-Y&#39;</span>] += $yadj;
<a name="l03860"></a>03860       $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;INNER-Y&#39;</span>] += $yadj;
<a name="l03861"></a>03861     }
<a name="l03862"></a>03862 
<a name="l03863"></a>03863 
<a name="l03864"></a>03864 
<a name="l03865"></a>03865       <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l03866"></a>03866       <span class="keywordflow">if</span> ((($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) &amp;&amp; ($contains_rtl )) || ($all_rtl )) { $this-&gt;restoreFont( $font[ $arraysize-1 - $k ] ); }
<a name="l03867"></a>03867       <span class="keywordflow">else</span> { $this-&gt;restoreFont( $font[ $k ] ); }
<a name="l03868"></a>03868       <span class="comment">// *********** SPAN BACKGROUND COLOR ***************** //</span>
<a name="l03869"></a>03869       <span class="keywordflow">if</span> (isset($this-&gt;spanbgcolor) &amp;&amp; $this-&gt;spanbgcolor) { 
<a name="l03870"></a>03870         $cor = $this-&gt;spanbgcolorarray;
<a name="l03871"></a>03871         $this-&gt;SetFillColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l03872"></a>03872         $save_fill = $fill; $spanfill = 1; $fill = 1;
<a name="l03873"></a>03873       }
<a name="l03874"></a>03874       <span class="comment">// WORD SPACING</span>
<a name="l03875"></a>03875           $stringWidth = $this-&gt;GetStringWidth($chunk ) + ( $this-&gt;charspacing * mb_strlen($chunk,$this-&gt;mb_enc ) / $this-&gt;k )  
<a name="l03876"></a>03876         + ( $this-&gt;ws * mb_substr_count($chunk,<span class="charliteral">&#39; &#39;</span>,$this-&gt;mb_enc ) / $this-&gt;k );
<a name="l03877"></a>03877       <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[$dirk])) { 
<a name="l03878"></a>03878         <span class="comment">// mPDF 4.2.031</span>
<a name="l03879"></a>03879         <span class="keywordflow">if</span> ($this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;dottab&#39;</span>) { 
<a name="l03880"></a>03880           $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] +=$empty; 
<a name="l03881"></a>03881         }
<a name="l03882"></a>03882         $stringWidth = $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>];
<a name="l03883"></a>03883       }
<a name="l03884"></a>03884 
<a name="l03885"></a>03885       <span class="comment">// mPDF 4.2 af , bf above and below font</span>
<a name="l03886"></a>03886       <span class="keywordflow">if</span> ($k == $arraysize-1) $this-&gt;Cell( $stringWidth, $lineHeight, $chunk, <span class="stringliteral">&#39;&#39;</span>, 1, <span class="stringliteral">&#39;&#39;</span>, $fill, $this-&gt;HREF , $currentx,0,0,<span class="charliteral">&#39;M&#39;</span>, $fill, $af, $bf ); <span class="comment">//mono-style line or last part (skips line)</span>
<a name="l03887"></a>03887       <span class="keywordflow">else</span> $this-&gt;Cell( $stringWidth, $lineHeight, $chunk, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, $fill, $this-&gt;HREF, 0, 0,0,<span class="charliteral">&#39;M&#39;</span>, $fill, $af, $bf );<span class="comment">//first or middle part</span>
<a name="l03888"></a>03888 
<a name="l03889"></a>03889 
<a name="l03890"></a>03890       <span class="comment">// *********** SPAN BACKGROUND COLOR OFF - RESET BLOCK BGCOLOR ***************** //</span>
<a name="l03891"></a>03891       <span class="keywordflow">if</span> (isset($spanfill) &amp;&amp; $spanfill) { 
<a name="l03892"></a>03892         $fill = $save_fill; $spanfill = 0; 
<a name="l03893"></a>03893         <span class="keywordflow">if</span> ($fill) { $this-&gt;SetFillColor($bcor[<span class="charliteral">&#39;R&#39;</span>],$bcor[<span class="charliteral">&#39;G&#39;</span>],$bcor[<span class="charliteral">&#39;B&#39;</span>]); }
<a name="l03894"></a>03894       }
<a name="l03895"></a>03895           }
<a name="l03896"></a>03896 
<a name="l03897"></a>03897   $this-&gt;printobjectbuffer($is_table);
<a name="l03898"></a>03898 
<a name="l03899"></a>03899 
<a name="l03900"></a>03900   $this-&gt;objectbuffer = array();
<a name="l03901"></a>03901 
<a name="l03902"></a>03902   <span class="comment">// mPDF 4.0</span>
<a name="l03903"></a>03903   $this-&gt;ResetSpacing();
<a name="l03904"></a>03904 
<a name="l03905"></a>03905   <span class="comment">// LIST BULLETS/NUMBERS</span>
<a name="l03906"></a>03906   <span class="keywordflow">if</span> ($is_list &amp;&amp; is_array($this-&gt;bulletarray) &amp;&amp; ($lineCount == 0) ) {
<a name="l03907"></a>03907     <span class="comment">// mPDF 4.0</span>
<a name="l03908"></a>03908     $savedFont = $this-&gt;saveFont();
<a name="l03909"></a>03909 
<a name="l03910"></a>03910     $bull = $this-&gt;bulletarray;
<a name="l03911"></a>03911     <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;level&#39;</span>]) &amp;&amp; isset($bull[<span class="stringliteral">&#39;occur&#39;</span>]) &amp;&amp; isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]])) { 
<a name="l03912"></a>03912     $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]]); 
<a name="l03913"></a>03913     }
<a name="l03914"></a>03914     <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;level&#39;</span>]) &amp;&amp; isset($bull[<span class="stringliteral">&#39;occur&#39;</span>]) &amp;&amp; isset($bull[<span class="stringliteral">&#39;num&#39;</span>]) &amp;&amp; isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]][$bull[<span class="stringliteral">&#39;num&#39;</span>]]) &amp;&amp; $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]][$bull[<span class="stringliteral">&#39;num&#39;</span>]]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]][$bull[<span class="stringliteral">&#39;num&#39;</span>]]); }
<a name="l03915"></a>03915     <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;font&#39;</span>]) &amp;&amp; $bull[<span class="stringliteral">&#39;font&#39;</span>] == <span class="stringliteral">&#39;zapfdingbats&#39;</span>) {
<a name="l03916"></a>03916     $this-&gt;bullet = <span class="keyword">true</span>;
<a name="l03917"></a>03917     $this-&gt;SetFont(<span class="stringliteral">&#39;zapfdingbats&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;FontSizePt/2.5);
<a name="l03918"></a>03918     }
<a name="l03919"></a>03919     <span class="keywordflow">else</span> { $this-&gt;SetFont($this-&gt;FontFamily,$this-&gt;FontStyle,$this-&gt;FontSizePt,<span class="keyword">true</span>,<span class="keyword">true</span>); }  <span class="comment">// force output</span>
<a name="l03920"></a>03920         <span class="comment">//Output bullet</span>
<a name="l03921"></a>03921     $this-&gt;x = $currentx;
<a name="l03922"></a>03922     <span class="keywordflow">if</span> (isset($bull[<span class="charliteral">&#39;x&#39;</span>])) { $this-&gt;x += $bull[<span class="charliteral">&#39;x&#39;</span>]; }
<a name="l03923"></a>03923     $this-&gt;y -= $lineHeight;
<a name="l03924"></a>03924     <span class="comment">// mPDF 4.0</span>
<a name="l03925"></a>03925         <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;txt&#39;</span>])) { $this-&gt;Cell($bull[<span class="charliteral">&#39;w&#39;</span>], $lineHeight,$bull[<span class="stringliteral">&#39;txt&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$bull[<span class="stringliteral">&#39;align&#39;</span>],0,<span class="stringliteral">&#39;&#39;</span>,0,-$this-&gt;cMarginL, -$this-&gt;cMarginR ); }
<a name="l03926"></a>03926     <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;font&#39;</span>]) &amp;&amp; $bull[<span class="stringliteral">&#39;font&#39;</span>] == <span class="stringliteral">&#39;zapfdingbats&#39;</span>) {
<a name="l03927"></a>03927     $this-&gt;bullet = <span class="keyword">false</span>;
<a name="l03928"></a>03928     }
<a name="l03929"></a>03929     $this-&gt;x = $currentx; <span class="comment">// Reset</span>
<a name="l03930"></a>03930     $this-&gt;y += $lineHeight;
<a name="l03931"></a>03931 
<a name="l03932"></a>03932 
<a name="l03933"></a>03933     <span class="comment">// mPDF 3.0 ? does nothing as $savedFont is not defined</span>
<a name="l03934"></a>03934     <span class="comment">// mPDF 4.0</span>
<a name="l03935"></a>03935      $this-&gt;restoreFont( $savedFont );
<a name="l03936"></a>03936     <span class="comment">// $font = array( $savedFont );</span>
<a name="l03937"></a>03937 
<a name="l03938"></a>03938     $this-&gt;bulletarray = array(); <span class="comment">// prevents repeat of bullet/number if &lt;li&gt;....&lt;br /&gt;.....&lt;/li&gt;</span>
<a name="l03939"></a>03939   }
<a name="l03940"></a>03940 
<a name="l03941"></a>03941 
<a name="l03942"></a>03942   } <span class="comment">// END IF CONTENT</span>
<a name="l03943"></a>03943 
<a name="l03944"></a>03944   <span class="comment">// Update values if set to skipline</span>
<a name="l03945"></a>03945   <span class="keywordflow">if</span> ($this-&gt;floatmargins) { $this-&gt;_advanceFloatMargins(); }
<a name="l03946"></a>03946 
<a name="l03947"></a>03947 
<a name="l03948"></a>03948   <span class="keywordflow">if</span> ($endofblock &amp;&amp; $blockstate&gt;1) { 
<a name="l03949"></a>03949     <span class="comment">// If float exists at this level</span>
<a name="l03950"></a>03950     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>])) { $fry1 = $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]; }
<a name="l03951"></a>03951     <span class="keywordflow">else</span> { $fry1 = 0; }
<a name="l03952"></a>03952     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>])) { $fly1 = $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]; }
<a name="l03953"></a>03953     <span class="keywordflow">else</span> { $fly1 = 0; }
<a name="l03954"></a>03954     <span class="keywordflow">if</span> ($this-&gt;y &lt; $fry1 || $this-&gt;y &lt; $fly1) { 
<a name="l03955"></a>03955       $drop = max($fry1,$fly1) - $this-&gt;y;
<a name="l03956"></a>03956       $this-&gt;DivLn($drop); 
<a name="l03957"></a>03957       $this-&gt;x = $currentx;
<a name="l03958"></a>03958     }
<a name="l03959"></a>03959   }
<a name="l03960"></a>03960 
<a name="l03961"></a>03961 
<a name="l03962"></a>03962   <span class="comment">// PADDING and BORDER spacing/fill</span>
<a name="l03963"></a>03963   <span class="keywordflow">if</span> ($endofblock &amp;&amp; ($blockstate &gt; 1) &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] || $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>] || $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;css_set_height&#39;</span>]) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l03964"></a>03964       <span class="comment">// mPDF 4.0 If CSS height set, extend bottom - if on same page as block started, and CSS HEIGHT &gt; actual height, </span>
<a name="l03965"></a>03965       <span class="comment">//  and does not force pagebreak</span>
<a name="l03966"></a>03966       $extra = 0;
<a name="l03967"></a>03967       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;css_set_height&#39;</span>] &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]==$this-&gt;page) {
<a name="l03968"></a>03968         <span class="comment">// predicted height</span>
<a name="l03969"></a>03969         $h1 = ($this-&gt;y-$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>]) + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l03970"></a>03970         <span class="keywordflow">if</span> ($h1 &lt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;css_set_height&#39;</span>]) { $extra = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;css_set_height&#39;</span>] - $h1; }
<a name="l03971"></a>03971         <span class="keywordflow">if</span>($this-&gt;y + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $extra &gt; $this-&gt;PageBreakTrigger) {
<a name="l03972"></a>03972           $extra = $this-&gt;PageBreakTrigger - ($this-&gt;y + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l03973"></a>03973         }
<a name="l03974"></a>03974       }
<a name="l03975"></a>03975 
<a name="l03976"></a>03976       <span class="comment">// mPDF 3.0 Also does border when Columns active</span>
<a name="l03977"></a>03977       <span class="comment">// $state = 0 normal; 1 top; 2 bottom; 3 top and bottom</span>
<a name="l03978"></a>03978       $this-&gt;DivLn($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $extra,-3,<span class="keyword">true</span>,<span class="keyword">false</span>,2); 
<a name="l03979"></a>03979       $this-&gt;x = $currentx;
<a name="l03980"></a>03980 
<a name="l03981"></a>03981 
<a name="l03982"></a>03982   }
<a name="l03983"></a>03983 
<a name="l03984"></a>03984   <span class="comment">// SET Bottom y1 of block (used for painting borders)</span>
<a name="l03985"></a>03985   <span class="keywordflow">if</span> (($endofblock) &amp;&amp; ($blockstate &gt; 1) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l03986"></a>03986     $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y1&#39;</span>] = $this-&gt;y;
<a name="l03987"></a>03987   }
<a name="l03988"></a>03988 
<a name="l03989"></a>03989   <span class="comment">// BOTTOM MARGIN</span>
<a name="l03990"></a>03990   <span class="keywordflow">if</span> (($endofblock) &amp;&amp; ($blockstate &gt; 1) &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_bottom&#39;</span>]) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l03991"></a>03991     <span class="keywordflow">if</span>($this-&gt;y+$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_bottom&#39;</span>] &lt; $this-&gt;PageBreakTrigger and !$this-&gt;InFooter) {
<a name="l03992"></a>03992       $this-&gt;DivLn($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_bottom&#39;</span>],$this-&gt;blklvl-1,<span class="keyword">true</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_collapse&#39;</span>]); 
<a name="l03993"></a>03993     }
<a name="l03994"></a>03994   }
<a name="l03995"></a>03995 
<a name="l03996"></a>03996   <span class="comment">// Reset lineheight</span>
<a name="l03997"></a>03997   $lineHeight = $this-&gt;divheight;
<a name="l03998"></a>03998 }
<a name="l03999"></a>03999 
<a name="l04000"></a>04000 
<a name="l04001"></a>04001 
<a name="l04002"></a>04002 
<a name="l04003"></a>04003 
<a name="l04004"></a>04004 function printobjectbuffer($is_table=<span class="keyword">false</span>) {
<a name="l04005"></a>04005     <span class="keywordflow">if</span> ($is_table &amp;&amp; $this-&gt;shrin_k &gt; 1) { $k = $this-&gt;shrin_k; } 
<a name="l04006"></a>04006     <span class="keywordflow">else</span> { $k = 1; }
<a name="l04007"></a>04007     $save_y = $this-&gt;y;
<a name="l04008"></a>04008     $save_x = $this-&gt;x;
<a name="l04009"></a>04009     $save_currentfontfamily = $this-&gt;FontFamily;
<a name="l04010"></a>04010     $save_currentfontsize = $this-&gt;FontSizePt;
<a name="l04011"></a>04011     $save_currentfontstyle = $this-&gt;FontStyle.($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l04012"></a>04012     <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $rtlalign = <span class="charliteral">&#39;R&#39;</span>; } <span class="keywordflow">else</span> { $rtlalign = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l04013"></a>04013     <span class="keywordflow">foreach</span> ($this-&gt;objectbuffer AS $ib =&gt; $objattr) { 
<a name="l04014"></a>04014            <span class="comment">// mPDF 3.0</span>
<a name="l04015"></a>04015        <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;bookmark&#39;</span> || $objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;indexentry&#39;</span> || $objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;toc&#39;</span>) {
<a name="l04016"></a>04016       $x = $objattr[<span class="stringliteral">&#39;OUTER-X&#39;</span>]; 
<a name="l04017"></a>04017       $y = $objattr[<span class="stringliteral">&#39;OUTER-Y&#39;</span>];
<a name="l04018"></a>04018       $this-&gt;y = $y - $this-&gt;FontSize/2;
<a name="l04019"></a>04019       $this-&gt;x = $x;
<a name="l04020"></a>04020       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;bookmark&#39;</span> ) { $this-&gt;Bookmark($objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>],$objattr[<span class="stringliteral">&#39;bklevel&#39;</span>] ,$y - $this-&gt;FontSize); }  <span class="comment">// *BOOKMARKS*</span>
<a name="l04021"></a>04021       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;indexentry&#39;</span>) { $this-&gt;IndexEntry($objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>]); } <span class="comment">// *INDEX*</span>
<a name="l04022"></a>04022       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;toc&#39;</span>) { $this-&gt;TOC_Entry($objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>], $objattr[<span class="stringliteral">&#39;toclevel&#39;</span>], $objattr[<span class="stringliteral">&#39;toc_id&#39;</span>]); } <span class="comment">// *TOC*</span>
<a name="l04023"></a>04023        }
<a name="l04024"></a>04024        <span class="keywordflow">else</span> { 
<a name="l04025"></a>04025       $y = $objattr[<span class="stringliteral">&#39;OUTER-Y&#39;</span>];
<a name="l04026"></a>04026       $x = $objattr[<span class="stringliteral">&#39;OUTER-X&#39;</span>];
<a name="l04027"></a>04027       $w = $objattr[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>];
<a name="l04028"></a>04028       $h = $objattr[<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l04029"></a>04029       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;text&#39;</span>])) { $texto = $objattr[<span class="stringliteral">&#39;text&#39;</span>]; }
<a name="l04030"></a>04030       $this-&gt;y = $y;
<a name="l04031"></a>04031       $this-&gt;x = $x;
<a name="l04032"></a>04032       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;fontfamily&#39;</span>])) { $this-&gt;SetFont($objattr[<span class="stringliteral">&#39;fontfamily&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,$objattr[<span class="stringliteral">&#39;fontsize&#39;</span>] ); }
<a name="l04033"></a>04033        }
<a name="l04034"></a>04034 
<a name="l04035"></a>04035     <span class="comment">// HR</span>
<a name="l04036"></a>04036        <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;hr&#39;</span>) {
<a name="l04037"></a>04037       $this-&gt;SetDrawColor($objattr[<span class="stringliteral">&#39;color&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],$objattr[<span class="stringliteral">&#39;color&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],$objattr[<span class="stringliteral">&#39;color&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l04038"></a>04038       <span class="keywordflow">switch</span>($objattr[<span class="stringliteral">&#39;align&#39;</span>]) {
<a name="l04039"></a>04039               <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>:
<a name="l04040"></a>04040                   $empty = $objattr[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] - $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>];
<a name="l04041"></a>04041                   $empty /= 2;
<a name="l04042"></a>04042                   $x += $empty;
<a name="l04043"></a>04043                     <span class="keywordflow">break</span>;
<a name="l04044"></a>04044               <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:
<a name="l04045"></a>04045                   $empty = $objattr[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] - $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>];
<a name="l04046"></a>04046                   $x += $empty;
<a name="l04047"></a>04047                   <span class="keywordflow">break</span>;
<a name="l04048"></a>04048       }
<a name="l04049"></a>04049           $oldlinewidth = $this-&gt;LineWidth;
<a name="l04050"></a>04050       $this-&gt;SetLineWidth($objattr[<span class="stringliteral">&#39;linewidth&#39;</span>]/$k );
<a name="l04051"></a>04051       $this-&gt;y += ($objattr[<span class="stringliteral">&#39;linewidth&#39;</span>]/2) + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]/$k;
<a name="l04052"></a>04052       $this-&gt;Line($x,$this-&gt;y,$x+$objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>],$this-&gt;y);
<a name="l04053"></a>04053       $this-&gt;SetLineWidth($oldlinewidth);
<a name="l04054"></a>04054       $this-&gt;SetDrawColor(0);
<a name="l04055"></a>04055        }
<a name="l04056"></a>04056     <span class="comment">// IMAGE</span>
<a name="l04057"></a>04057        <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;image&#39;</span>) {
<a name="l04058"></a>04058       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;opacity&#39;</span>])) { $this-&gt;SetAlpha($objattr[<span class="stringliteral">&#39;opacity&#39;</span>]); }
<a name="l04059"></a>04059       <span class="comment">// mPDF 4.3.016</span>
<a name="l04060"></a>04060       $rotate = 0;
<a name="l04061"></a>04061       $obiw = $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>];
<a name="l04062"></a>04062       $obih = $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>];
<a name="l04063"></a>04063       $sx = $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>]*$this-&gt;k / $objattr[<span class="stringliteral">&#39;orig_w&#39;</span>];
<a name="l04064"></a>04064       $sy = abs($objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>])*$this-&gt;k / abs($objattr[<span class="stringliteral">&#39;orig_h&#39;</span>]);
<a name="l04065"></a>04065       $sx = ($objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>]*$this-&gt;k / $objattr[<span class="stringliteral">&#39;orig_w&#39;</span>]);
<a name="l04066"></a>04066       $sy = ($objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>]*$this-&gt;k / $objattr[<span class="stringliteral">&#39;orig_h&#39;</span>]);
<a name="l04067"></a>04067 
<a name="l04068"></a>04068       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;ROTATE&#39;</span>])) { $rotate = $objattr[<span class="stringliteral">&#39;ROTATE&#39;</span>]; }
<a name="l04069"></a>04069       <span class="keywordflow">if</span> ($rotate==90) { 
<a name="l04070"></a>04070         <span class="comment">// Clockwise</span>
<a name="l04071"></a>04071         $obiw = $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>];
<a name="l04072"></a>04072         $obih = $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>];
<a name="l04073"></a>04073         $tr = $this-&gt;transformTranslate(0, -$objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>], <span class="keyword">true</span>) ;
<a name="l04074"></a>04074         $tr .= <span class="charliteral">&#39; &#39;</span>. $this-&gt;transformRotate(90, $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>],($objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] +$objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] ),<span class="keyword">true</span>) ;
<a name="l04075"></a>04075         $sx = $obiw*$this-&gt;k / $objattr[<span class="stringliteral">&#39;orig_h&#39;</span>];
<a name="l04076"></a>04076         $sy = abs($obih)*$this-&gt;k / abs($objattr[<span class="stringliteral">&#39;orig_w&#39;</span>]);
<a name="l04077"></a>04077       }
<a name="l04078"></a>04078       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($rotate==-90) { 
<a name="l04079"></a>04079         <span class="comment">// AntiClockwise</span>
<a name="l04080"></a>04080         $obiw = $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>];
<a name="l04081"></a>04081         $obih = $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>];
<a name="l04082"></a>04082         $tr = $this-&gt;transformTranslate($objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>], ($objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>]-$objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>]), <span class="keyword">true</span>) ;
<a name="l04083"></a>04083         $tr .= <span class="charliteral">&#39; &#39;</span>. $this-&gt;transformRotate(-90, $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>],($objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] +$objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] ),<span class="keyword">true</span>) ;
<a name="l04084"></a>04084         $sx = $obiw*$this-&gt;k / $objattr[<span class="stringliteral">&#39;orig_h&#39;</span>];
<a name="l04085"></a>04085         $sy = abs($obih)*$this-&gt;k / abs($objattr[<span class="stringliteral">&#39;orig_w&#39;</span>]);
<a name="l04086"></a>04086       }
<a name="l04087"></a>04087       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($rotate==180) { 
<a name="l04088"></a>04088         <span class="comment">// Mirror</span>
<a name="l04089"></a>04089         $tr = $this-&gt;transformTranslate($objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>], -$objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>], <span class="keyword">true</span>) ;
<a name="l04090"></a>04090         $tr .= <span class="charliteral">&#39; &#39;</span>. $this-&gt;transformRotate(180, $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>],($objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] +$objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>] ),<span class="keyword">true</span>) ;
<a name="l04091"></a>04091       }
<a name="l04092"></a>04092       <span class="keywordflow">else</span> { $tr = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l04093"></a>04093       <span class="comment">// mPDF 4.3.013 SVG files</span>
<a name="l04094"></a>04094       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;itype&#39;</span>]) &amp;&amp; $objattr[<span class="stringliteral">&#39;itype&#39;</span>]==<span class="stringliteral">&#39;svg&#39;</span>) { 
<a name="l04095"></a>04095         $outstring = sprintf(<span class="stringliteral">&#39;q &#39;</span>.$tr.<span class="stringliteral">&#39; %.3f 0 0 %.3f %.3f %.3f cm /FO%d Do Q&#39;</span>, $sx, -$sy, $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>]*$this-&gt;k-$sx*$objattr[<span class="stringliteral">&#39;wmf_x&#39;</span>], (($this-&gt;h-$objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>])*$this-&gt;k)+$sy*$objattr[<span class="stringliteral">&#39;wmf_y&#39;</span>], $objattr[<span class="stringliteral">&#39;ID&#39;</span>]);  <span class="comment">// mPDF 4.3.016</span>
<a name="l04096"></a>04096       }
<a name="l04097"></a>04097       <span class="keywordflow">else</span> { 
<a name="l04098"></a>04098         $outstring = sprintf(<span class="stringliteral">&quot;q &quot;</span>.$tr.<span class="stringliteral">&quot; %.3f 0 0 %.3f %.3f %.3f cm /I%d Do Q&quot;</span>,$obiw*$this-&gt;k, $obih*$this-&gt;k, $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>] *$this-&gt;k, ($this-&gt;h-($objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] +$obih ))*$this-&gt;k,$objattr[<span class="stringliteral">&#39;ID&#39;</span>] );  <span class="comment">// mPDF 4.3.016</span>
<a name="l04099"></a>04099       }
<a name="l04100"></a>04100       $this-&gt;_out($outstring);
<a name="l04101"></a>04101       <span class="comment">// LINK</span>
<a name="l04102"></a>04102       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;link&#39;</span>])) $this-&gt;Link($objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>],$objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>],$objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>],$objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>],$objattr[<span class="stringliteral">&#39;link&#39;</span>]);
<a name="l04103"></a>04103       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>])) { $this-&gt;PaintImgBorder($objattr,$is_table); }
<a name="l04104"></a>04104       <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;opacity&#39;</span>])) { $this-&gt;SetAlpha(1); }
<a name="l04105"></a>04105        }
<a name="l04106"></a>04106 
<a name="l04107"></a>04107 
<a name="l04108"></a>04108 
<a name="l04109"></a>04109     <span class="comment">// mPDF 3.0 Normal spacing</span>
<a name="l04110"></a>04110     <span class="comment">// mPDF 4.0</span>
<a name="l04111"></a>04111        $this-&gt;ResetSpacing();
<a name="l04112"></a>04112 
<a name="l04113"></a>04113     <span class="comment">// mPDF 4.2.031</span>
<a name="l04114"></a>04114        <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;dottab&#39;</span>) {
<a name="l04115"></a>04115         $sp = $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>);
<a name="l04116"></a>04116         $nb=floor(($w-2*$sp)/$this-&gt;GetStringWidth(<span class="charliteral">&#39;.&#39;</span>));
<a name="l04117"></a>04117         <span class="keywordflow">if</span> ($nb&gt;0) { $dots=<span class="charliteral">&#39; &#39;</span>.str_repeat(<span class="charliteral">&#39;.&#39;</span>,$nb).<span class="charliteral">&#39; &#39;</span>; }
<a name="l04118"></a>04118         <span class="keywordflow">else</span> { $dots=<span class="charliteral">&#39; &#39;</span>; }
<a name="l04119"></a>04119         $this-&gt;Cell($w,$h,$dots,0,0,<span class="charliteral">&#39;C&#39;</span>);
<a name="l04120"></a>04120        }
<a name="l04121"></a>04121 
<a name="l04122"></a>04122     }
<a name="l04123"></a>04123     $this-&gt;SetFont($save_currentfontfamily,$save_currentfontstyle,$save_currentfontsize);
<a name="l04124"></a>04124     $this-&gt;y = $save_y;
<a name="l04125"></a>04125     $this-&gt;x = $save_x;
<a name="l04126"></a>04126     unset($content);
<a name="l04127"></a>04127 }
<a name="l04128"></a>04128 
<a name="l04129"></a>04129 
<a name="l04130"></a>04130 function WriteFlowingBlock( $s)
<a name="l04131"></a>04131 {
<a name="l04132"></a>04132     $currentx = $this-&gt;x; 
<a name="l04133"></a>04133     $is_table = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;is_table&#39;</span> ];
<a name="l04134"></a>04134     $is_list = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;is_list&#39;</span> ];
<a name="l04135"></a>04135     <span class="comment">// width of all the content so far in points</span>
<a name="l04136"></a>04136     $contentWidth =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;contentWidth&#39;</span> ];
<a name="l04137"></a>04137     <span class="comment">// cell width in points</span>
<a name="l04138"></a>04138     $maxWidth =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;width&#39;</span> ];
<a name="l04139"></a>04139     $lineCount =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;lineCount&#39;</span> ];
<a name="l04140"></a>04140     <span class="comment">// line height in user units</span>
<a name="l04141"></a>04141     $lineHeight =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;height&#39;</span> ];
<a name="l04142"></a>04142     $align =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;align&#39;</span> ];
<a name="l04143"></a>04143     $content =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;content&#39;</span> ];
<a name="l04144"></a>04144     $font =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;font&#39;</span> ];
<a name="l04145"></a>04145     $valign =&amp; $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;valign&#39;</span> ];
<a name="l04146"></a>04146     $blockstate = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;blockstate&#39;</span> ];
<a name="l04147"></a>04147 
<a name="l04148"></a>04148     $newblock = $this-&gt;flowingBlockAttr[ <span class="stringliteral">&#39;newblock&#39;</span> ];
<a name="l04149"></a>04149   <span class="comment">// *********** BLOCK BACKGROUND COLOR ***************** //</span>
<a name="l04150"></a>04150   <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolor&#39;</span>] &amp;&amp; !$is_table) {
<a name="l04151"></a>04151     <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l04152"></a>04152     $fill = 0;
<a name="l04153"></a>04153 <span class="comment">//    $fill = 1;</span>
<a name="l04154"></a>04154 <span class="comment">//    $bcor = $this-&gt;blk[$this-&gt;blklvl][&#39;bgcolorarray&#39;];</span>
<a name="l04155"></a>04155 <span class="comment">//    $this-&gt;SetFillColor($bcor[&#39;R&#39;],$bcor[&#39;G&#39;],$bcor[&#39;B&#39;]);</span>
<a name="l04156"></a>04156   }
<a name="l04157"></a>04157   <span class="keywordflow">else</span> {
<a name="l04158"></a>04158     $this-&gt;SetFillColor(255);
<a name="l04159"></a>04159     $fill = 0;
<a name="l04160"></a>04160   }
<a name="l04161"></a>04161     $font[] = $this-&gt;saveFont();
<a name="l04162"></a>04162     $content[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04163"></a>04163     $currContent =&amp; $content[ count( $content ) - 1 ];
<a name="l04164"></a>04164     <span class="comment">// where the line should be cutoff if it is to be justified</span>
<a name="l04165"></a>04165     $cutoffWidth = $contentWidth;
<a name="l04166"></a>04166 
<a name="l04167"></a>04167   $curlyquote = mb_convert_encoding(<span class="stringliteral">&quot;\xe2\x80\x9e&quot;</span>,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l04168"></a>04168   $curlylowquote = mb_convert_encoding(<span class="stringliteral">&quot;\xe2\x80\x9d&quot;</span>,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l04169"></a>04169 
<a name="l04170"></a>04170   <span class="comment">// COLS</span>
<a name="l04171"></a>04171   $oldcolumn = $this-&gt;CurrCol;
<a name="l04172"></a>04172 
<a name="l04173"></a>04173 
<a name="l04174"></a>04174    <span class="keywordflow">if</span> ($is_table) { 
<a name="l04175"></a>04175   $ipaddingL = 0; 
<a name="l04176"></a>04176   $ipaddingR = 0; 
<a name="l04177"></a>04177   $paddingL = 0; 
<a name="l04178"></a>04178   $paddingR = 0; 
<a name="l04179"></a>04179   $cpaddingadjustL = 0;
<a name="l04180"></a>04180   $cpaddingadjustR = 0;
<a name="l04181"></a>04181   <span class="comment">// Added mPDF 3.0</span>
<a name="l04182"></a>04182   $fpaddingR = 0;
<a name="l04183"></a>04183   $fpaddingL = 0;
<a name="l04184"></a>04184   } 
<a name="l04185"></a>04185    <span class="keywordflow">else</span> { 
<a name="l04186"></a>04186     $ipaddingL = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>]; 
<a name="l04187"></a>04187     $ipaddingR = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_right&#39;</span>]; 
<a name="l04188"></a>04188     $paddingL = ($ipaddingL * $this-&gt;k); 
<a name="l04189"></a>04189     $paddingR = ($ipaddingR * $this-&gt;k); 
<a name="l04190"></a>04190     $this-&gt;cMarginL =  $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l04191"></a>04191     $cpaddingadjustL = -$this-&gt;cMarginL;
<a name="l04192"></a>04192     $this-&gt;cMarginR =  $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l04193"></a>04193     $cpaddingadjustR = -$this-&gt;cMarginR;
<a name="l04194"></a>04194     <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l04195"></a>04195     $fpaddingR = 0;
<a name="l04196"></a>04196     $fpaddingL = 0;
<a name="l04197"></a>04197     <span class="keywordflow">if</span> (count($this-&gt;floatDivs)) {
<a name="l04198"></a>04198       list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl);
<a name="l04199"></a>04199       <span class="keywordflow">if</span> ($r_exists) { $fpaddingR = $r_width; }
<a name="l04200"></a>04200       <span class="keywordflow">if</span> ($l_exists) { $fpaddingL = $l_width; }
<a name="l04201"></a>04201     }
<a name="l04202"></a>04202 
<a name="l04203"></a>04203     $usey = $this-&gt;y + 0.002;
<a name="l04204"></a>04204     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 0) ) { 
<a name="l04205"></a>04205       $usey += $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l04206"></a>04206     }
<a name="l04207"></a>04207     <span class="comment">// If float exists at this level</span>
<a name="l04208"></a>04208     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingR += $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l04209"></a>04209     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingL += $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l04210"></a>04210    }  <span class="comment">// *TABLES*</span>
<a name="l04211"></a>04211 
<a name="l04212"></a>04212      <span class="comment">//OBJECTS - IMAGES &amp; FORM Elements (NB has already skipped line/page if required - in printbuffer)</span>
<a name="l04213"></a>04213       <span class="keywordflow">if</span> (substr($s,0,3) == <span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>) { <span class="comment">//identifier has been identified!</span>
<a name="l04214"></a>04214     <span class="comment">// mPDF 4.0</span>
<a name="l04215"></a>04215     $objattr = $this-&gt;_getObjAttr($s);
<a name="l04216"></a>04216     $h_corr = 0; 
<a name="l04217"></a>04217     <span class="keywordflow">if</span> ($is_table) {  <span class="comment">// *TABLES*</span>
<a name="l04218"></a>04218       $maximumW = ($maxWidth/$this-&gt;k) - ($this-&gt;cellPaddingL + $this-&gt;cMarginL + $this-&gt;cellPaddingR + $this-&gt;cMarginR);   <span class="comment">// *TABLES*</span>
<a name="l04219"></a>04219     } <span class="comment">// *TABLES*</span>
<a name="l04220"></a>04220     <span class="keywordflow">else</span> {  <span class="comment">// *TABLES*</span>
<a name="l04221"></a>04221       <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 0) &amp;&amp; (!$is_table)) { $h_corr = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l04222"></a>04222       $maximumW = ($maxWidth/$this-&gt;k) - ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_right&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $fpaddingL + $fpaddingR ); 
<a name="l04223"></a>04223     } <span class="comment">// *TABLES*</span>
<a name="l04224"></a>04224     $objattr = $this-&gt;inlineObject($objattr[<span class="stringliteral">&#39;type&#39;</span>],$this-&gt;lMargin + $fpaddingL + ($contentWidth/$this-&gt;k),($this-&gt;y + $h_corr), $objattr, $this-&gt;lMargin,($contentWidth/$this-&gt;k),$maximumW,$lineHeight,<span class="keyword">true</span>,$is_table);
<a name="l04225"></a>04225 
<a name="l04226"></a>04226     <span class="comment">// SET LINEHEIGHT for this line ================ RESET AT END</span>
<a name="l04227"></a>04227     $lineHeight = MAX($lineHeight,$objattr[<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>]);
<a name="l04228"></a>04228     $this-&gt;objectbuffer[count($content)-1] = $objattr;
<a name="l04229"></a>04229     <span class="comment">// mPDF 4.2</span>
<a name="l04230"></a>04230     <span class="comment">// if (isset($objattr[&#39;vertical-align&#39;])) { $valign = $objattr[&#39;vertical-align&#39;]; }</span>
<a name="l04231"></a>04231     <span class="comment">// else { $valign = &#39;&#39;; }</span>
<a name="l04232"></a>04232     $contentWidth += ($objattr[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] * $this-&gt;k);
<a name="l04233"></a>04233     <span class="keywordflow">return</span>;
<a name="l04234"></a>04234   }
<a name="l04235"></a>04235 
<a name="l04236"></a>04236 
<a name="l04237"></a>04237    <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l04238"></a>04238   $tmp = mb_strlen( $s, $this-&gt;mb_enc );
<a name="l04239"></a>04239    }
<a name="l04240"></a>04240    <span class="keywordflow">else</span> {
<a name="l04241"></a>04241   $tmp = strlen( $s );
<a name="l04242"></a>04242    }  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l04243"></a>04243 
<a name="l04244"></a>04244    $orphs = 0; 
<a name="l04245"></a>04245    $check = 0;
<a name="l04246"></a>04246 
<a name="l04247"></a>04247 
<a name="l04248"></a>04248    <span class="comment">// for every character in the string</span>
<a name="l04249"></a>04249    <span class="keywordflow">for</span> ( $i = 0; $i &lt; $tmp; $i++ )  {
<a name="l04250"></a>04250 
<a name="l04251"></a>04251   <span class="comment">// extract the current character</span>
<a name="l04252"></a>04252   <span class="comment">// get the width of the character in points</span>
<a name="l04253"></a>04253   <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l04254"></a>04254         $c = mb_substr($s,$i,1,$this-&gt;mb_enc );
<a name="l04255"></a>04255     $cw = ($this-&gt;GetStringWidth($c) * $this-&gt;k);
<a name="l04256"></a>04256   }
<a name="l04257"></a>04257   <span class="keywordflow">else</span> {
<a name="l04258"></a>04258         $c = substr($s,$i,1);
<a name="l04259"></a>04259     <span class="comment">// mPDF 3.0 Soft Hyphens chr(173)</span>
<a name="l04260"></a>04260     <span class="keywordflow">if</span> ($c == chr(173) &amp;&amp; ($this-&gt;FontFamily!=<span class="stringliteral">&#39;symbol&#39;</span> &amp;&amp; $this-&gt;FontFamily!=<span class="stringliteral">&#39;zapfdingbats&#39;</span>)) { $cw = 0;  }
<a name="l04261"></a>04261     <span class="keywordflow">else</span> { $cw = $this-&gt;CurrentFont[ <span class="stringliteral">&#39;cw&#39;</span> ][ $c ] * ( $this-&gt;FontSizePt / 1000 ); }
<a name="l04262"></a>04262   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l04263"></a>04263   <span class="keywordflow">if</span> ($c==<span class="charliteral">&#39; &#39;</span>) { $check = 1; }
<a name="l04264"></a>04264 
<a name="l04265"></a>04265   <span class="comment">// CHECK for ORPHANS</span>
<a name="l04266"></a>04266   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($c==<span class="charliteral">&#39;.&#39;</span> || $c==<span class="charliteral">&#39;,&#39;</span> || $c==<span class="charliteral">&#39;)&#39;</span> || $c==<span class="charliteral">&#39;;&#39;</span> || $c==<span class="charliteral">&#39;:&#39;</span> || $c==<span class="charliteral">&#39;!&#39;</span> || $c==<span class="charliteral">&#39;?&#39;</span>|| $c==<span class="charliteral">&#39;&quot;&#39;</span> || $c==$curlyquote || $c==$curlylowquote || $c==<span class="stringliteral">&quot;\xef\xbc\x8c&quot;</span> || $c==<span class="stringliteral">&quot;\xe3\x80\x82&quot;</span>)  {$check++; }
<a name="l04267"></a>04267   <span class="keywordflow">else</span> { $check = 0; }
<a name="l04268"></a>04268 
<a name="l04269"></a>04269   <span class="comment">// There&#39;s an orphan &#39;. &#39; or &#39;, &#39; or &lt;sup&gt;32&lt;/sup&gt; about to be cut off at the end of line</span>
<a name="l04270"></a>04270   <span class="keywordflow">if</span>($check==1) {
<a name="l04271"></a>04271     $currContent .= $c;
<a name="l04272"></a>04272     $cutoffWidth = $contentWidth;
<a name="l04273"></a>04273     $contentWidth += $cw;
<a name="l04274"></a>04274     <span class="keywordflow">continue</span>;
<a name="l04275"></a>04275   }
<a name="l04276"></a>04276   <span class="keywordflow">if</span>(($this-&gt;SUP || $this-&gt;SUB) &amp;&amp; ($orphs &lt; $this-&gt;orphansAllowed)) {  <span class="comment">// ? disable orphans in table if  borders used</span>
<a name="l04277"></a>04277     $currContent .= $c;
<a name="l04278"></a>04278     $cutoffWidth = $contentWidth;
<a name="l04279"></a>04279     $contentWidth += $cw;
<a name="l04280"></a>04280     $orphs++;
<a name="l04281"></a>04281     <span class="keywordflow">continue</span>;
<a name="l04282"></a>04282   }
<a name="l04283"></a>04283   <span class="keywordflow">else</span> { $orphs = 0; }
<a name="l04284"></a>04284 
<a name="l04285"></a>04285   <span class="comment">// ADDED for Paragraph_indent</span>
<a name="l04286"></a>04286   $WidthCorrection = 0; 
<a name="l04287"></a>04287   <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>]) &amp;&amp; ($lineCount == 0) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list) &amp;&amp; ($align != <span class="charliteral">&#39;C&#39;</span>)) { 
<a name="l04288"></a>04288     <span class="comment">// mPDF 4.0</span>
<a name="l04289"></a>04289     $ti = $this-&gt;ConvertSize($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l04290"></a>04290     $WidthCorrection = ($ti*$this-&gt;k); 
<a name="l04291"></a>04291   } 
<a name="l04292"></a>04292 
<a name="l04293"></a>04293   <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l04294"></a>04294   $fpaddingR = 0;
<a name="l04295"></a>04295   $fpaddingL = 0;
<a name="l04296"></a>04296   <span class="keywordflow">if</span> (count($this-&gt;floatDivs)) {
<a name="l04297"></a>04297     list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl);
<a name="l04298"></a>04298     <span class="keywordflow">if</span> ($r_exists) { $fpaddingR = $r_width; }
<a name="l04299"></a>04299     <span class="keywordflow">if</span> ($l_exists) { $fpaddingL = $l_width; }
<a name="l04300"></a>04300   }
<a name="l04301"></a>04301 
<a name="l04302"></a>04302   $usey = $this-&gt;y + 0.002;
<a name="l04303"></a>04303   <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 0) ) { 
<a name="l04304"></a>04304     $usey += $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l04305"></a>04305   }
<a name="l04306"></a>04306 
<a name="l04307"></a>04307   <span class="comment">// If float exists at this level</span>
<a name="l04308"></a>04308   <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingR += $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l04309"></a>04309   <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>]) &amp;&amp; $usey &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $usey &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] &amp;&amp; !$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>]) { $fpaddingL += $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l04310"></a>04310 
<a name="l04311"></a>04311 
<a name="l04312"></a>04312 
<a name="l04313"></a>04313        <span class="comment">// try adding another char</span>
<a name="l04314"></a>04314   <span class="keywordflow">if</span> (( $contentWidth + $cw &gt; $maxWidth - $WidthCorrection - (($this-&gt;cMarginL+$this-&gt;cMarginR)*$this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) ) +  0.001))  {<span class="comment">// 0.001 is to correct for deviations converting mm=&gt;pts</span>
<a name="l04315"></a>04315     <span class="comment">// it won&#39;t fit, output what we already have</span>
<a name="l04316"></a>04316     $lineCount++;
<a name="l04317"></a>04317  
<a name="l04318"></a>04318     <span class="comment">// contains any content that didn&#39;t make it into this print</span>
<a name="l04319"></a>04319     $savedContent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04320"></a>04320     $savedFont = array();
<a name="l04321"></a>04321     <span class="comment">// mPDF 4.2.031   Dot Tabs</span>
<a name="l04322"></a>04322     $savedObj = array();
<a name="l04323"></a>04323 
<a name="l04324"></a>04324       $words = explode( <span class="charliteral">&#39; &#39;</span>, $currContent ); 
<a name="l04326"></a>04326       <span class="comment">// HYPHENATION</span>
<a name="l04327"></a>04327       $currWord = $words[count($words)-1] ;
<a name="l04328"></a>04328       $success = <span class="keyword">false</span>;
<a name="l04329"></a>04329 
<a name="l04330"></a>04330 
<a name="l04331"></a>04331     <span class="comment">// if it looks like we didn&#39;t finish any words for this chunk</span>
<a name="l04332"></a>04332     <span class="keywordflow">if</span> ( count( $words ) == 1 ) {
<a name="l04333"></a>04333       <span class="comment">// TO correct for error when word too wide for page - but only when one long word from left to right margin</span>
<a name="l04334"></a>04334       <span class="keywordflow">if</span> (count($content) == 1 &amp;&amp; $currContent != <span class="charliteral">&#39; &#39;</span>) {
<a name="l04335"></a>04335       $lastContent = $words[0]; 
<a name="l04336"></a>04336       $savedFont = $this-&gt;saveFont();
<a name="l04337"></a>04337       <span class="comment">// replace the current content with the cropped version</span>
<a name="l04338"></a>04338       $currContent = $this-&gt;mb_rtrim( $lastContent, $this-&gt;mb_enc );
<a name="l04339"></a>04339       }
<a name="l04340"></a>04340       <span class="keywordflow">else</span> {
<a name="l04341"></a>04341       <span class="comment">// save and crop off the content currently on the stack</span>
<a name="l04342"></a>04342       $savedContent = array_pop( $content );
<a name="l04343"></a>04343       $savedFont = array_pop( $font );
<a name="l04344"></a>04344       <span class="comment">// trim any trailing spaces off the last bit of content</span>
<a name="l04345"></a>04345       $currContent =&amp; $content[ count( $content ) - 1 ];
<a name="l04346"></a>04346       $currContent = $this-&gt;mb_rtrim( $currContent, $this-&gt;mb_enc );
<a name="l04347"></a>04347       }
<a name="l04348"></a>04348     }
<a name="l04349"></a>04349     <span class="keywordflow">else</span> {  <span class="comment">// otherwise, we need to find which bit to cut off</span>
<a name="l04350"></a>04350              $lastContent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04351"></a>04351       <span class="comment">// mPDF 3.0</span>
<a name="l04352"></a>04352               <span class="keywordflow">for</span> ( $w = 0; $w &lt; count( $words ) - 1; $w++) { $lastContent .= $words[ $w ].<span class="stringliteral">&quot; &quot;</span>; }
<a name="l04353"></a>04353               $savedContent = $words[ count( $words ) - 1 ];
<a name="l04354"></a>04354               $savedFont = $this-&gt;saveFont();
<a name="l04355"></a>04355               <span class="comment">// replace the current content with the cropped version</span>
<a name="l04356"></a>04356               $currContent = $this-&gt;mb_rtrim( $lastContent, $this-&gt;mb_enc );
<a name="l04357"></a>04357     }
<a name="l04358"></a>04358 
<a name="l04359"></a>04359     <span class="comment">// mPDF 4.2.031   Dot Tabs</span>
<a name="l04360"></a>04360     <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[(count($content)-1)]) &amp;&amp; $this-&gt;objectbuffer[(count($content)-1)][<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;dottab&#39;</span>) {
<a name="l04361"></a>04361       $savedObj = array_pop( $this-&gt;objectbuffer );
<a name="l04362"></a>04362       $contentWidth -= ($this-&gt;objectbuffer[(count($content)-1)][<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] * $this-&gt;k);
<a name="l04363"></a>04363     }
<a name="l04364"></a>04364 
<a name="l04365"></a>04365     <span class="comment">// Set Current lineheight (correction factor)</span>
<a name="l04366"></a>04366     $lhfixed = <span class="keyword">false</span>; 
<a name="l04367"></a>04367     <span class="keywordflow">if</span> ($is_list) {
<a name="l04368"></a>04368       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;listOcc],$am)) { 
<a name="l04369"></a>04369         $lhfixed = <span class="keyword">true</span>; 
<a name="l04370"></a>04370         $def_fontsize = $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$this-&gt;listlvl][$this-&gt;listOcc][$this-&gt;listnum][<span class="stringliteral">&#39;size&#39;</span>];
<a name="l04371"></a>04371         $this-&gt;lineheight_correction = $am[1] / $def_fontsize ;
<a name="l04372"></a>04372       }
<a name="l04373"></a>04373       <span class="keywordflow">else</span> { 
<a name="l04374"></a>04374         $this-&gt;lineheight_correction = $this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;listOcc]; 
<a name="l04375"></a>04375       }
<a name="l04376"></a>04376     }
<a name="l04377"></a>04377     <span class="keywordflow">else</span>
<a name="l04378"></a>04378     <span class="keywordflow">if</span> ($is_table) {
<a name="l04379"></a>04379       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;table_lineheight,$am)) { 
<a name="l04380"></a>04380         $lhfixed = <span class="keyword">true</span>; 
<a name="l04381"></a>04381         $def_fontsize = $this-&gt;FontSize;        <span class="comment">// needs to be default font-size for block ****</span>
<a name="l04382"></a>04382         $this-&gt;lineheight_correction = $lineHeight / $def_fontsize ; 
<a name="l04383"></a>04383       }
<a name="l04384"></a>04384       <span class="keywordflow">else</span> { 
<a name="l04385"></a>04385         $this-&gt;lineheight_correction = $this-&gt;table_lineheight; 
<a name="l04386"></a>04386       }
<a name="l04387"></a>04387     }
<a name="l04388"></a>04388     <span class="keywordflow">else</span>
<a name="l04389"></a>04389     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) {
<a name="l04390"></a>04390       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>],$am)) { 
<a name="l04391"></a>04391         $lhfixed = <span class="keyword">true</span>; 
<a name="l04392"></a>04392         $def_fontsize = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>];  <span class="comment">// needs to be default font-size for block ****</span>
<a name="l04393"></a>04393         $this-&gt;lineheight_correction = $am[1] / $def_fontsize ;
<a name="l04394"></a>04394       }
<a name="l04395"></a>04395       <span class="keywordflow">else</span> { 
<a name="l04396"></a>04396         $this-&gt;lineheight_correction = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]; 
<a name="l04397"></a>04397       }
<a name="l04398"></a>04398     } 
<a name="l04399"></a>04399     <span class="keywordflow">else</span> {
<a name="l04400"></a>04400       $this-&gt;lineheight_correction = $this-&gt;normalLineheight; 
<a name="l04401"></a>04401     }
<a name="l04402"></a>04402 
<a name="l04403"></a>04403     <span class="comment">// update $contentWidth and $cutoffWidth since they changed with cropping</span>
<a name="l04404"></a>04404     <span class="comment">// Also correct lineheight to maximum fontsize (not for tables)</span>
<a name="l04405"></a>04405     $contentWidth = 0;
<a name="l04406"></a>04406     <span class="comment">// mPDF 4.2</span>
<a name="l04407"></a>04407     <span class="comment">//  correct lineheight to maximum fontsize</span>
<a name="l04408"></a>04408     <span class="keywordflow">if</span> ($lhfixed) { $maxlineHeight = $this-&gt;lineheight; }
<a name="l04409"></a>04409     <span class="keywordflow">else</span> { $maxlineHeight = 0; }
<a name="l04410"></a>04410     $this-&gt;forceExactLineheight = <span class="keyword">true</span>;
<a name="l04411"></a>04411     $maxfontsize = 0;
<a name="l04412"></a>04412     <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk )
<a name="l04413"></a>04413     {
<a name="l04414"></a>04414               $this-&gt;restoreFont( $font[ $k ]);
<a name="l04415"></a>04415       <span class="keywordflow">if</span> (!isset($this-&gt;objectbuffer[$k])) { 
<a name="l04416"></a>04416       <span class="keywordflow">if</span> ($this-&gt;is_MB) {
<a name="l04417"></a>04417             $content[$k] = $chunk = str_replace(<span class="stringliteral">&quot;\xc2\xad&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$chunk ); 
<a name="l04418"></a>04418       }
<a name="l04419"></a>04419       <span class="comment">// mPDF 3.0 Soft Hyphens chr(173)</span>
<a name="l04420"></a>04420       <span class="keywordflow">else</span>
<a name="l04421"></a>04421       <span class="keywordflow">if</span> ($this-&gt;FontFamily!=<span class="stringliteral">&#39;symbol&#39;</span> &amp;&amp; $this-&gt;FontFamily!=<span class="stringliteral">&#39;zapfdingbats&#39;</span>) {
<a name="l04422"></a>04422             $content[$k] = $chunk = str_replace($this-&gt;chrs[173],<span class="stringliteral">&#39;&#39;</span>,$chunk );
<a name="l04423"></a>04423       }
<a name="l04424"></a>04424       $contentWidth += $this-&gt;GetStringWidth( $chunk ) * $this-&gt;k; 
<a name="l04425"></a>04425       <span class="comment">// mPDF 4.2</span>
<a name="l04426"></a>04426       <span class="keywordflow">if</span> (!$lhfixed) { $maxlineHeight = max($maxlineHeight,$this-&gt;FontSize * $this-&gt;lineheight_correction ); }
<a name="l04427"></a>04427       <span class="keywordflow">if</span> ($lhfixed &amp;&amp; ($this-&gt;FontSize &gt; $def_fontsize || ($this-&gt;FontSize &gt; ($lineHeight * $this-&gt;lineheight_correction) &amp;&amp; $is_list))) { 
<a name="l04428"></a>04428         $this-&gt;forceExactLineheight = <span class="keyword">false</span>; 
<a name="l04429"></a>04429       }
<a name="l04430"></a>04430       $maxfontsize = max($maxfontsize,$this-&gt;FontSize); 
<a name="l04431"></a>04431       }
<a name="l04432"></a>04432     }
<a name="l04433"></a>04433 
<a name="l04434"></a>04434     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l04435"></a>04435     $lastfontreqstyle = $font[count($font)-1][<span class="stringliteral">&#39;ReqFontStyle&#39;</span>];
<a name="l04436"></a>04436     $lastfontstyle = $font[count($font)-1][<span class="stringliteral">&#39;style&#39;</span>];
<a name="l04437"></a>04437     <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;ltr&#39;</span> &amp;&amp; strpos($lastfontreqstyle,<span class="stringliteral">&quot;I&quot;</span>) !== <span class="keyword">false</span> &amp;&amp; strpos($lastfontstyle,<span class="stringliteral">&quot;I&quot;</span>) === <span class="keyword">false</span>) {  <span class="comment">// Artificial italic</span>
<a name="l04438"></a>04438       $lastitalic = $this-&gt;FontSize*0.15*$this-&gt;k;
<a name="l04439"></a>04439     }
<a name="l04440"></a>04440     <span class="keywordflow">else</span> { $lastitalic = 0; }
<a name="l04441"></a>04441 
<a name="l04442"></a>04442 
<a name="l04443"></a>04443     <span class="comment">// mPDF 4.2 Moved here from later</span>
<a name="l04444"></a>04444     <span class="keywordflow">if</span> ($is_list &amp;&amp; is_array($this-&gt;bulletarray) &amp;&amp; $this-&gt;bulletarray) {
<a name="l04445"></a>04445         $actfs = $this-&gt;bulletarray[<span class="stringliteral">&#39;fontsize&#39;</span>];
<a name="l04446"></a>04446       <span class="keywordflow">if</span> (!$lhfixed) { $maxlineHeight = max($maxlineHeight,$actfs * $this-&gt;lineheight_correction );  }  <span class="comment">// mPDF 4.2</span>
<a name="l04447"></a>04447       <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $actfs &gt; $def_fontsize) { $this-&gt;forceExactLineheight = <span class="keyword">false</span>; }
<a name="l04448"></a>04448       $maxfontsize = max($maxfontsize,$actfs);
<a name="l04449"></a>04449     }
<a name="l04450"></a>04450 
<a name="l04451"></a>04451     <span class="comment">// when every text item checked i.e. $maxfontsize is set properly</span>
<a name="l04452"></a>04452 
<a name="l04453"></a>04453     $af = 0;  <span class="comment">// Above font</span>
<a name="l04454"></a>04454     $bf = 0;  <span class="comment">// Below font</span>
<a name="l04455"></a>04455     $mta = 0; <span class="comment">// Maximum top-aligned </span>
<a name="l04456"></a>04456     $mba = 0; <span class="comment">// Maximum bottom-aligned </span>
<a name="l04457"></a>04457 
<a name="l04458"></a>04458     <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk ) {
<a name="l04459"></a>04459       <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[$k]) &amp;&amp; $this-&gt;objectbuffer[$k]) { 
<a name="l04460"></a>04460       $contentWidth += $this-&gt;objectbuffer[$k][<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] * $this-&gt;k; 
<a name="l04461"></a>04461       $oh = $this-&gt;objectbuffer[$k][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l04462"></a>04462       $va = $this-&gt;objectbuffer[$k][<span class="stringliteral">&#39;vertical-align&#39;</span>]; <span class="comment">// = $objattr[&#39;vertical-align&#39;] = set as M,T,B,S</span>
<a name="l04463"></a>04463       <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $oh &gt; $def_fontsize) { $this-&gt;forceExactLineheight = <span class="keyword">false</span>; }
<a name="l04464"></a>04464 
<a name="l04465"></a>04465       <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;BS&#39;</span>) {  <span class="comment">//  (BASELINE default)</span>
<a name="l04466"></a>04466         $af = max($af, ($oh - ($maxfontsize * (0.5 + $this-&gt;baselineC))));
<a name="l04467"></a>04467       }
<a name="l04468"></a>04468       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;M&#39;</span>) { 
<a name="l04469"></a>04469         $af = max($af, ($oh - $maxfontsize)/2);
<a name="l04470"></a>04470         $bf = max($bf, ($oh - $maxfontsize)/2);
<a name="l04471"></a>04471       }
<a name="l04472"></a>04472       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TT&#39;</span>) { 
<a name="l04473"></a>04473         $bf = max($bf, ($oh - $maxfontsize));
<a name="l04474"></a>04474       }
<a name="l04475"></a>04475       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TB&#39;</span>) { 
<a name="l04476"></a>04476         $af = max($af, ($oh - $maxfontsize));
<a name="l04477"></a>04477       }
<a name="l04478"></a>04478       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;T&#39;</span>) { 
<a name="l04479"></a>04479         $mta = max($mta, $oh);
<a name="l04480"></a>04480       }
<a name="l04481"></a>04481       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;B&#39;</span>) { 
<a name="l04482"></a>04482         $mba = max($mba, $oh);
<a name="l04483"></a>04483       }
<a name="l04484"></a>04484       }
<a name="l04485"></a>04485     }
<a name="l04486"></a>04486     <span class="keywordflow">if</span> ((!$lhfixed || !$this-&gt;forceExactLineheight) &amp;&amp; ($af &gt; (($maxlineHeight - $maxfontsize)/2) || $bf &gt; (($maxlineHeight - $maxfontsize)/2))) {
<a name="l04487"></a>04487       $maxlineHeight = $maxfontsize + $af + $bf;
<a name="l04488"></a>04488     }
<a name="l04489"></a>04489     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$lhfixed) { $af = $bf = ($maxlineHeight - $maxfontsize)/2; }
<a name="l04490"></a>04490 
<a name="l04491"></a>04491     <span class="keywordflow">if</span> ($mta &gt; $maxlineHeight) { 
<a name="l04492"></a>04492       $bf += ($mta - $maxlineHeight);
<a name="l04493"></a>04493       $maxlineHeight = $mta;
<a name="l04494"></a>04494     }
<a name="l04495"></a>04495     <span class="keywordflow">if</span> ($mba &gt; $maxlineHeight) { 
<a name="l04496"></a>04496       $af += ($mba - $maxlineHeight);
<a name="l04497"></a>04497       $maxlineHeight = $mba;
<a name="l04498"></a>04498     }
<a name="l04499"></a>04499 
<a name="l04500"></a>04500 
<a name="l04501"></a>04501     $lineHeight = $maxlineHeight; 
<a name="l04502"></a>04502     $cutoffWidth = $contentWidth;
<a name="l04503"></a>04503     <span class="comment">// mPDF 4.2 If NOT images, and maxfontsize NOT &gt; lineHeight - this value determines text baseline positioning</span>
<a name="l04504"></a>04504     <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $af==0 &amp;&amp; $bf==0 &amp;&amp; $maxfontsize&lt;=($def_fontsize * $this-&gt;lineheight_correction * 0.8 )) { 
<a name="l04505"></a>04505       $this-&gt;linemaxfontsize = $def_fontsize; 
<a name="l04506"></a>04506     }
<a name="l04507"></a>04507     <span class="keywordflow">else</span> { $this-&gt;linemaxfontsize = $maxfontsize; }
<a name="l04508"></a>04508 
<a name="l04509"></a>04509 
<a name="l04510"></a>04510     <span class="comment">// JUSTIFICATION J</span>
<a name="l04511"></a>04511     $nb_carac = 0;
<a name="l04512"></a>04512     $nb_spaces = 0;
<a name="l04513"></a>04513     <span class="comment">// if it&#39;s justified, we need to find the char/word spacing (or if orphans have allowed length of line to go over the maxwidth)</span>
<a name="l04514"></a>04514     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l04515"></a>04515     <span class="keywordflow">if</span>(( $align == <span class="charliteral">&#39;J&#39;</span> ) || ($cutoffWidth + $lastitalic &gt; $maxWidth - $WidthCorrection - (($this-&gt;cMarginL+$this-&gt;cMarginR)*$this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) ) +  0.001)) {   <span class="comment">// 0.001 is to correct for deviations converting mm=&gt;pts</span>
<a name="l04516"></a>04516       <span class="comment">// JUSTIFY J (Use character spacing)</span>
<a name="l04517"></a>04517       <span class="comment">// WORD SPACING</span>
<a name="l04518"></a>04518       <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk ) {
<a name="l04519"></a>04519           <span class="keywordflow">if</span> (!isset($this-&gt;objectbuffer[$k]) || (isset($this-&gt;objectbuffer[$k]) &amp;&amp; !$this-&gt;objectbuffer[$k])) {
<a name="l04520"></a>04520           <span class="keywordflow">if</span> ($this-&gt;is_MB) {
<a name="l04521"></a>04521                 $chunk = str_replace($this-&gt;chrs[194].$this-&gt;chrs[160],$this-&gt;chrs[32],$chunk ); 
<a name="l04522"></a>04522           }
<a name="l04523"></a>04523           <span class="keywordflow">else</span> {
<a name="l04524"></a>04524                 $chunk = str_replace($this-&gt;chrs[160],$this-&gt;chrs[32],$chunk );
<a name="l04525"></a>04525           } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l04526"></a>04526           $nb_carac += mb_strlen( $chunk, $this-&gt;mb_enc ) ;  
<a name="l04527"></a>04527           $nb_spaces += mb_substr_count( $chunk,<span class="charliteral">&#39; &#39;</span>, $this-&gt;mb_enc ) ;  
<a name="l04528"></a>04528         }
<a name="l04529"></a>04529       }
<a name="l04530"></a>04530       <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l04531"></a>04531       list($charspacing,$ws) = $this-&gt;GetJspacing($nb_carac,$nb_spaces,($maxWidth-$lastitalic-$cutoffWidth-$WidthCorrection-(($this-&gt;cMarginL+$this-&gt;cMarginR)*$this-&gt;k)-($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) )));
<a name="l04532"></a>04532       <span class="comment">// mPDF 4.0</span>
<a name="l04533"></a>04533       $this-&gt;SetSpacing($charspacing,$ws);
<a name="l04534"></a>04534     }
<a name="l04535"></a>04535 
<a name="l04536"></a>04536     <span class="comment">// otherwise, we want normal spacing</span>
<a name="l04537"></a>04537     <span class="keywordflow">else</span> {
<a name="l04538"></a>04538       <span class="comment">// mPDF 4.0</span>
<a name="l04539"></a>04539       $this-&gt;ResetSpacing();
<a name="l04540"></a>04540     }
<a name="l04541"></a>04541 
<a name="l04542"></a>04542     <span class="comment">// WORD SPACING</span>
<a name="l04543"></a>04543     <span class="comment">// mPDF 4.2 $lastitalic to shorten if line ends with artificial ITALIC</span>
<a name="l04544"></a>04544     $empty = $maxWidth - $lastitalic-$WidthCorrection - $contentWidth - (($this-&gt;cMarginL+$this-&gt;cMarginR)* $this-&gt;k) - ($paddingL+$paddingR +(($fpaddingL + $fpaddingR) * $this-&gt;k) ) - ( $this-&gt;charspacing * $nb_carac) - ( $this-&gt;ws * $nb_spaces);
<a name="l04545"></a>04545     $empty /= $this-&gt;k;
<a name="l04546"></a>04546     $b = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">//do not use borders</span>
<a name="l04547"></a>04547     <span class="comment">// Get PAGEBREAK TO TEST for height including the top border/padding</span>
<a name="l04548"></a>04548     $check_h = max($this-&gt;divheight,$lineHeight);
<a name="l04549"></a>04549     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($this-&gt;blklvl &gt; 0) &amp;&amp; ($lineCount == 1) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l04550"></a>04550       $check_h += ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]);
<a name="l04551"></a>04551     }
<a name="l04552"></a>04552 
<a name="l04553"></a>04553     <span class="comment">// mPDF 4.2 Force PAGE break if column height cannot take check-height</span>
<a name="l04554"></a>04554     <span class="keywordflow">if</span> ($this-&gt;ColActive &amp;&amp; $check_h &gt; ($this-&gt;PageBreakTrigger - $this-&gt;y0)) { $this-&gt;CurrCol = $this-&gt;NbCol; } 
<a name="l04555"></a>04555 
<a name="l04556"></a>04556     <span class="comment">// PAGEBREAK</span>
<a name="l04557"></a>04557     <span class="comment">// &#39;If&#39; below used in order to fix &quot;first-line of other page with justify on&quot; bug </span>
<a name="l04558"></a>04558     <span class="comment">// mPDF 4.2.008 Disable in Tables</span>
<a name="l04559"></a>04559     <span class="keywordflow">if</span>(!$is_table &amp;&amp; ($this-&gt;y+$check_h) &gt; $this-&gt;PageBreakTrigger and !$this-&gt;InFooter and $this-&gt;AcceptPageBreak()) {
<a name="l04560"></a>04560       $bak_x=$this-&gt;x;<span class="comment">//Current X position</span>
<a name="l04561"></a>04561 
<a name="l04562"></a>04562       <span class="comment">// WORD SPACING</span>
<a name="l04563"></a>04563       $ws=$this-&gt;ws;<span class="comment">//Word Spacing</span>
<a name="l04564"></a>04564       $charspacing=$this-&gt;charspacing;<span class="comment">//Character Spacing</span>
<a name="l04565"></a>04565       <span class="comment">// mPDF 4.0</span>
<a name="l04566"></a>04566       $this-&gt;ResetSpacing();
<a name="l04567"></a>04567 
<a name="l04568"></a>04568           $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l04569"></a>04569 
<a name="l04570"></a>04570           $this-&gt;x = $bak_x;
<a name="l04571"></a>04571       <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l04572"></a>04572       $currentx += $this-&gt;MarginCorrection;
<a name="l04573"></a>04573       $this-&gt;x += $this-&gt;MarginCorrection;
<a name="l04574"></a>04574 
<a name="l04575"></a>04575       <span class="comment">// WORD SPACING</span>
<a name="l04576"></a>04576       <span class="comment">// mPDF 4.0</span>
<a name="l04577"></a>04577       $this-&gt;SetSpacing($charspacing,$ws);
<a name="l04578"></a>04578     }
<a name="l04579"></a>04579 
<a name="l04580"></a>04580 
<a name="l04581"></a>04581     <span class="comment">// TOP MARGIN</span>
<a name="l04582"></a>04582     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>]) &amp;&amp; ($lineCount == 1) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l04583"></a>04583       $this-&gt;DivLn($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>],$this-&gt;blklvl-1,<span class="keyword">true</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_collapse&#39;</span>]); 
<a name="l04584"></a>04584     }
<a name="l04585"></a>04585 
<a name="l04586"></a>04586 
<a name="l04587"></a>04587     <span class="comment">// Update y0 for top of block (used to paint border)</span>
<a name="l04588"></a>04588     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 1) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l04589"></a>04589       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l04590"></a>04590       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] = $this-&gt;page;
<a name="l04591"></a>04591     }
<a name="l04592"></a>04592 
<a name="l04593"></a>04593     <span class="comment">// TOP PADDING and BORDER spacing/fill</span>
<a name="l04594"></a>04594     <span class="keywordflow">if</span> (($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>]) || ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>])) &amp;&amp; ($lineCount == 1) &amp;&amp; (!$is_table) &amp;&amp; (!$is_list)) { 
<a name="l04595"></a>04595       <span class="comment">// mPDF 3.0 Also does border when Columns active</span>
<a name="l04596"></a>04596       <span class="comment">// $state = 0 normal; 1 top; 2 bottom; 3 top and bottom</span>
<a name="l04597"></a>04597       $this-&gt;DivLn($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>],-3,<span class="keyword">true</span>,<span class="keyword">false</span>,1);
<a name="l04598"></a>04598     }
<a name="l04599"></a>04599 
<a name="l04600"></a>04600     $arraysize = count($content);
<a name="l04601"></a>04601 
<a name="l04602"></a>04602     $margins = ($this-&gt;cMarginL+$this-&gt;cMarginR) + ($ipaddingL+$ipaddingR + $fpaddingR + $fpaddingR );
<a name="l04603"></a>04603  
<a name="l04604"></a>04604     <span class="comment">// PAINT BACKGROUND FOR THIS LINE</span>
<a name="l04605"></a>04605     <span class="keywordflow">if</span> (!$is_table) { $this-&gt;DivLn($lineHeight,$this-&gt;blklvl,<span class="keyword">false</span>); }  <span class="comment">// false -&gt; don&#39;t advance y</span>
<a name="l04606"></a>04606 
<a name="l04607"></a>04607   
<a name="l04608"></a>04608     $this-&gt;x = $currentx + $this-&gt;cMarginL + $ipaddingL + $fpaddingL ;
<a name="l04609"></a>04609     <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;R&#39;</span>) { $this-&gt;x += $empty; }
<a name="l04610"></a>04610     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;C&#39;</span>) { $this-&gt;x += ($empty / 2); }
<a name="l04611"></a>04611 
<a name="l04612"></a>04612     <span class="comment">// Paragraph INDENT</span>
<a name="l04613"></a>04613     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>]) &amp;&amp; ($newblock) &amp;&amp; ($blockstate==1 || $blockstate==3) &amp;&amp; ($lineCount == 1) &amp;&amp; (!$is_table) &amp;&amp; ($this-&gt;directionality!=<span class="stringliteral">&#39;rtl&#39;</span>) &amp;&amp; ($align !=<span class="charliteral">&#39;C&#39;</span>)) { 
<a name="l04614"></a>04614       <span class="comment">// mPDF 4.0</span>
<a name="l04615"></a>04615       $ti = $this-&gt;ConvertSize($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l04616"></a>04616       $this-&gt;x += $ti; 
<a name="l04617"></a>04617     }
<a name="l04618"></a>04618 
<a name="l04619"></a>04619 
<a name="l04620"></a>04620     <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l04621"></a>04621     $all_rtl = <span class="keyword">false</span>;
<a name="l04622"></a>04622     $contains_rtl = <span class="keyword">false</span>;
<a name="l04623"></a>04623 
<a name="l04624"></a>04624     <span class="keywordflow">foreach</span> ( $content as $k =&gt; $chunk ) {
<a name="l04625"></a>04625 
<a name="l04626"></a>04626       <span class="comment">// FOR IMAGES - UPDATE POSITION</span>
<a name="l04627"></a>04627       <span class="keywordflow">if</span> (($this-&gt;directionality==<span class="stringliteral">&#39;rtl&#39;</span> &amp;&amp; $contains_rtl) || $all_rtl) { $dirk = $arraysize-1 - $k ; } <span class="keywordflow">else</span> { $dirk = $k; }
<a name="l04628"></a>04628 
<a name="l04629"></a>04629       <span class="comment">// mPDF 4.2</span>
<a name="l04630"></a>04630       $va = <span class="charliteral">&#39;M&#39;</span>;  <span class="comment">// default for text</span>
<a name="l04631"></a>04631       <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[$dirk]) &amp;&amp; $this-&gt;objectbuffer[$dirk]) {
<a name="l04632"></a>04632         $xadj = $this-&gt;x - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-X&#39;</span>] ; 
<a name="l04633"></a>04633         $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-X&#39;</span>] += $xadj;
<a name="l04634"></a>04634         $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;BORDER-X&#39;</span>] += $xadj;
<a name="l04635"></a>04635         $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;INNER-X&#39;</span>] += $xadj;
<a name="l04636"></a>04636         <span class="comment">// mPDF 4.2</span>
<a name="l04637"></a>04637         $va = $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;vertical-align&#39;</span>];
<a name="l04638"></a>04638         $yadj = $this-&gt;y - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-Y&#39;</span>];
<a name="l04639"></a>04639         <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;BS&#39;</span>) { 
<a name="l04640"></a>04640         $yadj += $af + ($this-&gt;linemaxfontsize * (0.5 + $this-&gt;baselineC)) - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l04641"></a>04641         }
<a name="l04642"></a>04642         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;M&#39;</span> || $va == <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l04643"></a>04643         $yadj += $af + ($this-&gt;linemaxfontsize /2) - ($this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>]/2);
<a name="l04644"></a>04644         }
<a name="l04645"></a>04645         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TB&#39;</span>) { 
<a name="l04646"></a>04646         $yadj += $af + $this-&gt;linemaxfontsize - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l04647"></a>04647         }
<a name="l04648"></a>04648         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="stringliteral">&#39;TT&#39;</span>) { 
<a name="l04649"></a>04649         $yadj += $af;
<a name="l04650"></a>04650         }
<a name="l04651"></a>04651         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;B&#39;</span>) { 
<a name="l04652"></a>04652         $yadj += $af + $this-&gt;linemaxfontsize + $bf - $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>];
<a name="l04653"></a>04653         }
<a name="l04654"></a>04654         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($va == <span class="charliteral">&#39;T&#39;</span>) { 
<a name="l04655"></a>04655         $yadj += 0;
<a name="l04656"></a>04656         }
<a name="l04657"></a>04657         $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-Y&#39;</span>] += $yadj;
<a name="l04658"></a>04658         $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;BORDER-Y&#39;</span>] += $yadj;
<a name="l04659"></a>04659         $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;INNER-Y&#39;</span>] += $yadj;
<a name="l04660"></a>04660       }
<a name="l04661"></a>04661 
<a name="l04662"></a>04662       <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l04663"></a>04663       <span class="keywordflow">if</span> ((($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) &amp;&amp; ($contains_rtl )) || ($all_rtl )) { $this-&gt;restoreFont($font[$arraysize-1 - $k]); }
<a name="l04664"></a>04664       <span class="keywordflow">else</span> { $this-&gt;restoreFont( $font[ $k ] ); }
<a name="l04665"></a>04665 
<a name="l04666"></a>04666       <span class="comment">// *********** SPAN BACKGROUND COLOR ***************** //</span>
<a name="l04667"></a>04667       <span class="keywordflow">if</span> ($this-&gt;spanbgcolor) { 
<a name="l04668"></a>04668         $cor = $this-&gt;spanbgcolorarray;
<a name="l04669"></a>04669         $this-&gt;SetFillColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l04670"></a>04670         $save_fill = $fill; $spanfill = 1; $fill = 1;
<a name="l04671"></a>04671       }
<a name="l04672"></a>04672 
<a name="l04673"></a>04673       <span class="comment">// WORD SPACING</span>
<a name="l04674"></a>04674           $stringWidth = $this-&gt;GetStringWidth($chunk ) + ( $this-&gt;charspacing * mb_strlen($chunk,$this-&gt;mb_enc ) / $this-&gt;k )  
<a name="l04675"></a>04675         + ( $this-&gt;ws * mb_substr_count($chunk,<span class="charliteral">&#39; &#39;</span>,$this-&gt;mb_enc ) / $this-&gt;k );
<a name="l04676"></a>04676       <span class="keywordflow">if</span> (isset($this-&gt;objectbuffer[$dirk])) { $stringWidth = $this-&gt;objectbuffer[$dirk][<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>];  }
<a name="l04677"></a>04677 
<a name="l04678"></a>04678       <span class="keywordflow">if</span> ($stringWidth &gt; 0) {
<a name="l04679"></a>04679                      <span class="keywordflow">if</span> ($k == $arraysize-1) { 
<a name="l04680"></a>04680         $stringWidth -= ( $this-&gt;charspacing / $this-&gt;k ); 
<a name="l04681"></a>04681         <span class="comment">// mPDF 4.2 af , bf above and below font</span>
<a name="l04682"></a>04682         $this-&gt;Cell( $stringWidth, $lineHeight, $chunk, <span class="stringliteral">&#39;&#39;</span>, 1, <span class="stringliteral">&#39;&#39;</span>, $fill, $this-&gt;HREF , $currentx,0,0,<span class="charliteral">&#39;M&#39;</span>, $fill, $af, $bf ); <span class="comment">//mono-style line or last part (skips line)</span>
<a name="l04683"></a>04683          }
<a name="l04684"></a>04684                      <span class="keywordflow">else</span> $this-&gt;Cell( $stringWidth, $lineHeight, $chunk, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, $fill, $this-&gt;HREF, 0, 0,0,<span class="charliteral">&#39;M&#39;</span>, $fill, $af, $bf );<span class="comment">//first or middle part</span>
<a name="l04685"></a>04685       }
<a name="l04686"></a>04686       <span class="keywordflow">else</span> {  <span class="comment">// If a space started a new chunk at the end of a line</span>
<a name="l04687"></a>04687         $this-&gt;x = $currentx; $this-&gt;y += $lineHeight; 
<a name="l04688"></a>04688       }
<a name="l04689"></a>04689       <span class="comment">// *********** SPAN BACKGROUND COLOR OFF - RESET BLOCK BGCOLOR ***************** //</span>
<a name="l04690"></a>04690       <span class="keywordflow">if</span> (isset($spanfill) &amp;&amp; $spanfill) { 
<a name="l04691"></a>04691         $fill = $save_fill; $spanfill = 0; 
<a name="l04692"></a>04692         <span class="keywordflow">if</span> ($fill) { $this-&gt;SetFillColor($bcor[<span class="charliteral">&#39;R&#39;</span>],$bcor[<span class="charliteral">&#39;G&#39;</span>],$bcor[<span class="charliteral">&#39;B&#39;</span>]); }
<a name="l04693"></a>04693       }
<a name="l04694"></a>04694     }
<a name="l04695"></a>04695     <span class="comment">// mPDF 4.0</span>
<a name="l04696"></a>04696     <span class="keywordflow">if</span> (!$is_table) { 
<a name="l04697"></a>04697       $this-&gt;maxPosR = max($this-&gt;maxPosR , ($this-&gt;w - $this-&gt;rMargin - $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_right_margin&#39;</span>])); 
<a name="l04698"></a>04698       $this-&gt;maxPosL = min($this-&gt;maxPosL , ($this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>])); 
<a name="l04699"></a>04699     }
<a name="l04700"></a>04700 
<a name="l04701"></a>04701     <span class="comment">// move on to the next line, reset variables, tack on saved content and current char</span>
<a name="l04702"></a>04702 
<a name="l04703"></a>04703     $this-&gt;printobjectbuffer($is_table);
<a name="l04704"></a>04704     $this-&gt;objectbuffer = array();
<a name="l04705"></a>04705 
<a name="l04706"></a>04706     <span class="comment">// LIST BULLETS/NUMBERS</span>
<a name="l04707"></a>04707     <span class="keywordflow">if</span> ($is_list &amp;&amp; is_array($this-&gt;bulletarray) &amp;&amp; ($lineCount == 1) ) {
<a name="l04708"></a>04708       <span class="comment">// mPDF 4.0</span>
<a name="l04709"></a>04709       $this-&gt;ResetSpacing();
<a name="l04710"></a>04710 
<a name="l04711"></a>04711       $bull = $this-&gt;bulletarray;
<a name="l04712"></a>04712         <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;level&#39;</span>]) &amp;&amp; isset($bull[<span class="stringliteral">&#39;occur&#39;</span>]) &amp;&amp; isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]])) { 
<a name="l04713"></a>04713       $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]]); 
<a name="l04714"></a>04714       }
<a name="l04715"></a>04715       <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;level&#39;</span>]) &amp;&amp; isset($bull[<span class="stringliteral">&#39;occur&#39;</span>]) &amp;&amp; isset($bull[<span class="stringliteral">&#39;num&#39;</span>]) &amp;&amp; isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]][$bull[<span class="stringliteral">&#39;num&#39;</span>]]) &amp;&amp; $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]][$bull[<span class="stringliteral">&#39;num&#39;</span>]]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$bull[<span class="stringliteral">&#39;level&#39;</span>]][$bull[<span class="stringliteral">&#39;occur&#39;</span>]][$bull[<span class="stringliteral">&#39;num&#39;</span>]]); }
<a name="l04716"></a>04716         <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;font&#39;</span>]) &amp;&amp; $bull[<span class="stringliteral">&#39;font&#39;</span>] == <span class="stringliteral">&#39;zapfdingbats&#39;</span>) {
<a name="l04717"></a>04717       $this-&gt;bullet = <span class="keyword">true</span>;
<a name="l04718"></a>04718       $this-&gt;SetFont(<span class="stringliteral">&#39;zapfdingbats&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;FontSizePt/2.5);
<a name="l04719"></a>04719       }
<a name="l04720"></a>04720       <span class="keywordflow">else</span> { $this-&gt;SetFont($this-&gt;FontFamily,$this-&gt;FontStyle,$this-&gt;FontSizePt,<span class="keyword">true</span>,<span class="keyword">true</span>); }  <span class="comment">// force output</span>
<a name="l04721"></a>04721           <span class="comment">//Output bullet</span>
<a name="l04722"></a>04722         $this-&gt;x = $currentx;
<a name="l04723"></a>04723       <span class="keywordflow">if</span> (isset($bull[<span class="charliteral">&#39;x&#39;</span>])) { $this-&gt;x += $bull[<span class="charliteral">&#39;x&#39;</span>]; }
<a name="l04724"></a>04724       $this-&gt;y -= $lineHeight;
<a name="l04725"></a>04725       <span class="comment">// mPDF 4.0</span>
<a name="l04726"></a>04726       <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;txt&#39;</span>])) { $this-&gt;Cell($bull[<span class="charliteral">&#39;w&#39;</span>], $lineHeight,$bull[<span class="stringliteral">&#39;txt&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$bull[<span class="stringliteral">&#39;align&#39;</span>],0,<span class="stringliteral">&#39;&#39;</span>,0,-$this-&gt;cMarginL, -$this-&gt;cMarginR ); }
<a name="l04727"></a>04727         <span class="keywordflow">if</span> (isset($bull[<span class="stringliteral">&#39;font&#39;</span>]) &amp;&amp; $bull[<span class="stringliteral">&#39;font&#39;</span>] == <span class="stringliteral">&#39;zapfdingbats&#39;</span>) {
<a name="l04728"></a>04728       $this-&gt;bullet = <span class="keyword">false</span>;
<a name="l04729"></a>04729       }
<a name="l04730"></a>04730       $this-&gt;x = $currentx; <span class="comment">// Reset</span>
<a name="l04731"></a>04731       $this-&gt;y += $lineHeight;
<a name="l04732"></a>04732 
<a name="l04733"></a>04733 
<a name="l04734"></a>04734       $this-&gt;bulletarray = array(); <span class="comment">// prevents repeat of bullet/number if &lt;li&gt;....&lt;br /&gt;.....&lt;/li&gt;</span>
<a name="l04735"></a>04735     }
<a name="l04736"></a>04736 
<a name="l04737"></a>04737 
<a name="l04738"></a>04738     <span class="comment">// Update values if set to skipline</span>
<a name="l04739"></a>04739     <span class="keywordflow">if</span> ($this-&gt;floatmargins) { $this-&gt;_advanceFloatMargins(); }
<a name="l04740"></a>04740 
<a name="l04741"></a>04741     <span class="comment">// Reset lineheight</span>
<a name="l04742"></a>04742     $lineHeight = $this-&gt;divheight;
<a name="l04743"></a>04743     $valign = <span class="charliteral">&#39;M&#39;</span>;
<a name="l04744"></a>04744 
<a name="l04745"></a>04745     $this-&gt;restoreFont( $savedFont );
<a name="l04746"></a>04746 
<a name="l04747"></a>04747     <span class="comment">// mPDF 4.2.031   Dot Tabs</span>
<a name="l04748"></a>04748     $font = array();
<a name="l04749"></a>04749     $content = array();
<a name="l04750"></a>04750 
<a name="l04751"></a>04751     $contentWidth = 0;
<a name="l04752"></a>04752     <span class="keywordflow">if</span> (!empty($savedObj)) {
<a name="l04753"></a>04753       $this-&gt;objectbuffer[] = $savedObj;
<a name="l04754"></a>04754       $font[] = $savedFont;
<a name="l04755"></a>04755       $content[] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04756"></a>04756       $contentWidth += $savedObj[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] * $this-&gt;k;
<a name="l04757"></a>04757     }
<a name="l04758"></a>04758     $font[] = $savedFont;
<a name="l04759"></a>04759     $content[] = $savedContent . $c;
<a name="l04760"></a>04760     $currContent =&amp; $content[ (count($content)-1) ];
<a name="l04761"></a>04761     $contentWidth += $this-&gt;GetStringWidth( $currContent ) * $this-&gt;k;
<a name="l04762"></a>04762     $cutoffWidth = $contentWidth;
<a name="l04763"></a>04763       }
<a name="l04764"></a>04764       <span class="comment">// another character will fit, so add it on</span>
<a name="l04765"></a>04765   <span class="keywordflow">else</span> {
<a name="l04766"></a>04766     $contentWidth += $cw;
<a name="l04767"></a>04767     $currContent .= $c;
<a name="l04768"></a>04768   }
<a name="l04769"></a>04769     }
<a name="l04770"></a>04770     unset($content);
<a name="l04771"></a>04771 }
<a name="l04772"></a>04772 <span class="comment">//----------------------END OF FLOWING BLOCK------------------------------------//</span>
<a name="l04773"></a>04773 
<a name="l04774"></a>04774 
<a name="l04775"></a>04775 <span class="comment">// Update values if set to skipline</span>
<a name="l04776"></a>04776 function _advanceFloatMargins() {
<a name="l04777"></a>04777   <span class="comment">// Update floatmargins - L</span>
<a name="l04778"></a>04778   <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>]) &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] != $this-&gt;y) {
<a name="l04779"></a>04779     $yadj = $this-&gt;y - $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>];
<a name="l04780"></a>04780     $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l04781"></a>04781     $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] += $yadj;
<a name="l04782"></a>04782 
<a name="l04783"></a>04783     <span class="comment">// Update objattr in floatbuffer</span>
<a name="l04784"></a>04784     <span class="keywordflow">if</span> ($this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l04785"></a>04785       $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;BORDER-Y&#39;</span>] += $yadj;
<a name="l04786"></a>04786     }
<a name="l04787"></a>04787     $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;INNER-Y&#39;</span>] += $yadj;
<a name="l04788"></a>04788     $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;OUTER-Y&#39;</span>] += $yadj;
<a name="l04789"></a>04789 
<a name="l04790"></a>04790     <span class="comment">// Unset values</span>
<a name="l04791"></a>04791     $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;
<a name="l04792"></a>04792     $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;
<a name="l04793"></a>04793     $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04794"></a>04794   }
<a name="l04795"></a>04795   <span class="comment">// Update floatmargins - R</span>
<a name="l04796"></a>04796   <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] != $this-&gt;y) {
<a name="l04797"></a>04797     $yadj = $this-&gt;y - $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>];
<a name="l04798"></a>04798     $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l04799"></a>04799     $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] += $yadj;
<a name="l04800"></a>04800 
<a name="l04801"></a>04801     <span class="comment">// Update objattr in floatbuffer</span>
<a name="l04802"></a>04802     <span class="keywordflow">if</span> ($this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l04803"></a>04803       $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;BORDER-Y&#39;</span>] += $yadj;
<a name="l04804"></a>04804     }
<a name="l04805"></a>04805     $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;INNER-Y&#39;</span>] += $yadj;
<a name="l04806"></a>04806     $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;OUTER-Y&#39;</span>] += $yadj;
<a name="l04807"></a>04807 
<a name="l04808"></a>04808     <span class="comment">// Unset values</span>
<a name="l04809"></a>04809     $this-&gt;floatbuffer[$this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;
<a name="l04810"></a>04810     $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;
<a name="l04811"></a>04811     $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04812"></a>04812   }
<a name="l04813"></a>04813 }
<a name="l04814"></a>04814 
<a name="l04815"></a>04815 
<a name="l04816"></a>04816 
<a name="l04818"></a>04818 <span class="comment">// ADDED forcewrap - to call from inline OBJECT functions to breakwords if necessary in cell</span>
<a name="l04820"></a>04820 <span class="comment"></span>function WordWrap(&amp;$text, $maxwidth, $forcewrap = 0) {
<a name="l04821"></a>04821     $biggestword=0;
<a name="l04822"></a>04822     $toonarrow=<span class="keyword">false</span>;
<a name="l04823"></a>04823 
<a name="l04824"></a>04824     $text = ltrim($text);
<a name="l04825"></a>04825     $text = $this-&gt;mb_rtrim($text, $this-&gt;mb_enc);
<a name="l04826"></a>04826 
<a name="l04827"></a>04827     <span class="keywordflow">if</span> ($text===<span class="stringliteral">&#39;&#39;</span>) <span class="keywordflow">return</span> 0;
<a name="l04828"></a>04828     $space = $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>);
<a name="l04829"></a>04829     $lines = explode(<span class="stringliteral">&quot;\n&quot;</span>, $text);
<a name="l04830"></a>04830     $text = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04831"></a>04831     $count = 0;
<a name="l04832"></a>04832     <span class="keywordflow">foreach</span> ($lines as $line) {
<a name="l04833"></a>04833   <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l04834"></a>04834     $words = mb_split(<span class="charliteral">&#39; &#39;</span>, $line);
<a name="l04835"></a>04835   }
<a name="l04836"></a>04836   <span class="keywordflow">else</span> {
<a name="l04837"></a>04837     $words = explode(<span class="charliteral">&#39; &#39;</span>, $line); <span class="comment">// mPDF 4.0</span>
<a name="l04838"></a>04838   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l04839"></a>04839   $width = 0;
<a name="l04840"></a>04840   <span class="keywordflow">foreach</span> ($words as $word) {
<a name="l04841"></a>04841     $word = $this-&gt;mb_rtrim($word, $this-&gt;mb_enc);
<a name="l04842"></a>04842     $word = ltrim($word);
<a name="l04843"></a>04843     $wordwidth = $this-&gt;GetStringWidth($word);
<a name="l04844"></a>04844 
<a name="l04845"></a>04845     <span class="comment">//Warn user that maxwidth is insufficient</span>
<a name="l04846"></a>04846     <span class="keywordflow">if</span> ($wordwidth &gt; $maxwidth + 0.0001) {
<a name="l04847"></a>04847       <span class="keywordflow">if</span> ($wordwidth &gt; $biggestword) { $biggestword = $wordwidth; }
<a name="l04848"></a>04848       $toonarrow=<span class="keyword">true</span>;
<a name="l04849"></a>04849       <span class="comment">// ADDED</span>
<a name="l04850"></a>04850       <span class="keywordflow">if</span> ($forcewrap) {
<a name="l04851"></a>04851         <span class="keywordflow">while</span>($wordwidth &gt; $maxwidth) {
<a name="l04852"></a>04852         $chw = 0; <span class="comment">// check width</span>
<a name="l04853"></a>04853         <span class="keywordflow">for</span> ( $i = 0; $i &lt; mb_strlen($word, $this-&gt;mb_enc ); $i++ ) {
<a name="l04854"></a>04854           $chw = $this-&gt;GetStringWidth(mb_substr($word,0,$i+1,$this-&gt;mb_enc ));
<a name="l04855"></a>04855           <span class="keywordflow">if</span> ($chw &gt; $maxwidth ) {
<a name="l04856"></a>04856             <span class="keywordflow">if</span> ($text) {
<a name="l04857"></a>04857               $text = $this-&gt;mb_rtrim($text, $this-&gt;mb_enc).<span class="stringliteral">&quot;\n&quot;</span>.mb_substr($word,0,$i,$this-&gt;mb_enc );
<a name="l04858"></a>04858               $count++;
<a name="l04859"></a>04859             }
<a name="l04860"></a>04860             <span class="keywordflow">else</span> {
<a name="l04861"></a>04861               $text = mb_substr($word,0,$i,$this-&gt;mb_enc );
<a name="l04862"></a>04862             }
<a name="l04863"></a>04863             $word = mb_substr($word,$i,mb_strlen($word, $this-&gt;mb_enc )-$i,$this-&gt;mb_enc );
<a name="l04864"></a>04864             $wordwidth = $this-&gt;GetStringWidth($word);
<a name="l04865"></a>04865             $width = $maxwidth; 
<a name="l04866"></a>04866             <span class="keywordflow">break</span>;
<a name="l04867"></a>04867           }
<a name="l04868"></a>04868         }
<a name="l04869"></a>04869         }
<a name="l04870"></a>04870       }
<a name="l04871"></a>04871     }
<a name="l04872"></a>04872 
<a name="l04873"></a>04873     <span class="keywordflow">if</span> ($width + $wordwidth  &lt; $maxwidth - 0.0001) {
<a name="l04874"></a>04874       $width += $wordwidth + $space;
<a name="l04875"></a>04875       $text .= $word.<span class="charliteral">&#39; &#39;</span>;
<a name="l04876"></a>04876     }
<a name="l04877"></a>04877     <span class="keywordflow">else</span> {
<a name="l04878"></a>04878       $width = $wordwidth + $space;
<a name="l04879"></a>04879       $text = $this-&gt;mb_rtrim($text, $this-&gt;mb_enc).<span class="stringliteral">&quot;\n&quot;</span>.$word.<span class="charliteral">&#39; &#39;</span>;
<a name="l04880"></a>04880       $count++;
<a name="l04881"></a>04881             }
<a name="l04882"></a>04882   }
<a name="l04883"></a>04883 
<a name="l04884"></a>04884   $text = $this-&gt;mb_rtrim($text, $this-&gt;mb_enc).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l04885"></a>04885   $count++;
<a name="l04886"></a>04886     }
<a name="l04887"></a>04887     $text = $this-&gt;mb_rtrim($text, $this-&gt;mb_enc);
<a name="l04888"></a>04888 
<a name="l04889"></a>04889     <span class="comment">//Return -(wordsize) if word is bigger than maxwidth </span>
<a name="l04890"></a>04890 
<a name="l04891"></a>04891   <span class="comment">// ADDED</span>
<a name="l04892"></a>04892   <span class="keywordflow">if</span> ($forcewrap) { <span class="keywordflow">return</span> $count; }
<a name="l04893"></a>04893       <span class="keywordflow">if</span> (($toonarrow) &amp;&amp; ($this-&gt;table_error_report)) {
<a name="l04894"></a>04894     $this-&gt;Error(<span class="stringliteral">&quot;Word is too long to fit in table - &quot;</span>.$this-&gt;table_error_report_param); 
<a name="l04895"></a>04895   }
<a name="l04896"></a>04896     <span class="keywordflow">if</span> ($toonarrow) <span class="keywordflow">return</span> -$biggestword;
<a name="l04897"></a>04897     <span class="keywordflow">else</span> <span class="keywordflow">return</span> $count;
<a name="l04898"></a>04898 }
<a name="l04899"></a>04899 
<a name="l04900"></a>04900 function _SetTextRendering($mode) { 
<a name="l04901"></a>04901   <span class="keywordflow">if</span> (!(($mode == 0) || ($mode == 1) || ($mode == 2))) 
<a name="l04902"></a>04902   $this-&gt;Error(<span class="stringliteral">&quot;Text rendering mode should be 0, 1 or 2 (value : $mode)&quot;</span>); 
<a name="l04903"></a>04903   $tr = ($mode.<span class="stringliteral">&#39; Tr&#39;</span>); 
<a name="l04904"></a>04904   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>] != $tr) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($tr); }
<a name="l04905"></a>04905   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>] = $tr;
<a name="l04906"></a>04906 
<a name="l04907"></a>04907 } 
<a name="l04908"></a>04908 
<a name="l04909"></a>04909 function SetTextOutline($width, $r=0, $g=-1, $b=-1) { 
<a name="l04910"></a>04910   <span class="keywordflow">if</span> ($width == <span class="keyword">false</span>) <span class="comment">//Now resets all values</span>
<a name="l04911"></a>04911   { 
<a name="l04912"></a>04912     $this-&gt;outline_on = <span class="keyword">false</span>;
<a name="l04913"></a>04913     $this-&gt;SetLineWidth(0.2); 
<a name="l04914"></a>04914     $this-&gt;SetDrawColor(0); 
<a name="l04915"></a>04915     $this-&gt;_SetTextRendering(0); 
<a name="l04916"></a>04916     $tr = (<span class="stringliteral">&#39;0 Tr&#39;</span>); 
<a name="l04917"></a>04917   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>] != $tr) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($tr); }
<a name="l04918"></a>04918   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>] = $tr;
<a name="l04919"></a>04919   }
<a name="l04920"></a>04920   <span class="keywordflow">else</span>
<a name="l04921"></a>04921   { 
<a name="l04922"></a>04922     $this-&gt;SetLineWidth($width); 
<a name="l04923"></a>04923     $this-&gt;SetDrawColor($r, $g , $b); 
<a name="l04924"></a>04924     $tr = (<span class="stringliteral">&#39;2 Tr&#39;</span>); 
<a name="l04925"></a>04925   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>] != $tr) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($tr); }
<a name="l04926"></a>04926   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;TextRendering&#39;</span>] = $tr;
<a name="l04927"></a>04927   } 
<a name="l04928"></a>04928 }
<a name="l04929"></a>04929 <span class="comment">// mPDF 4.2</span>
<a name="l04930"></a>04930 function Image($file,$x,$y,$w=0,$h=0,$type=<span class="stringliteral">&#39;&#39;</span>,$link=<span class="stringliteral">&#39;&#39;</span>,$paint=<span class="keyword">true</span>, $constrain=<span class="keyword">true</span>, $watermark=<span class="keyword">false</span>, $shownoimg=<span class="keyword">true</span>, $allowvector=<span class="keyword">true</span>) {
<a name="l04931"></a>04931   $orig_srcpath = $file; <span class="comment">// mPDF 4.2.029</span>
<a name="l04932"></a>04932   $this-&gt;GetFullPath($file); <span class="comment">// mPDF 4.2.029</span>
<a name="l04933"></a>04933 
<a name="l04934"></a>04934   $info=$this-&gt;_getImage($file, <span class="keyword">true</span>, $allowvector, $orig_srcpath ); <span class="comment">// mPDF 4.2.029</span>
<a name="l04935"></a>04935   <span class="keywordflow">if</span>(!$info &amp;&amp; $paint) {
<a name="l04936"></a>04936     $info = $this-&gt;_getImage($this-&gt;noImageFile);
<a name="l04937"></a>04937     <span class="keywordflow">if</span> ($info) { 
<a name="l04938"></a>04938       $file = $this-&gt;noImageFile; 
<a name="l04939"></a>04939       $w = ($info[<span class="charliteral">&#39;w&#39;</span>] * 0.2645);   <span class="comment">// 14 x 16px</span>
<a name="l04940"></a>04940       $h = ($info[<span class="charliteral">&#39;h&#39;</span>] * 0.2645);   <span class="comment">// 14 x 16px</span>
<a name="l04941"></a>04941     }
<a name="l04942"></a>04942   }
<a name="l04943"></a>04943   <span class="keywordflow">if</span>(!$info) <span class="keywordflow">return</span> <span class="keyword">false</span>;    <span class="comment">// mPDF 4.2</span>
<a name="l04944"></a>04944 
<a name="l04945"></a>04945   <span class="comment">//Automatic width and height calculation if needed</span>
<a name="l04946"></a>04946   <span class="keywordflow">if</span>($w==0 and $h==0) {
<a name="l04947"></a>04947            <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;svg&#39;</span>) { 
<a name="l04948"></a>04948       <span class="comment">// SVG units are pts</span>
<a name="l04949"></a>04949       <span class="comment">// divide by k to get user units</span>
<a name="l04950"></a>04950       $w = abs($info[<span class="charliteral">&#39;w&#39;</span>])/$this-&gt;k;
<a name="l04951"></a>04951       $h = abs($info[<span class="charliteral">&#39;h&#39;</span>]) /$this-&gt;k;
<a name="l04952"></a>04952     }
<a name="l04953"></a>04953     <span class="keywordflow">else</span> {
<a name="l04954"></a>04954       <span class="comment">//Put image at default dpi</span>
<a name="l04955"></a>04955       $w=($info[<span class="charliteral">&#39;w&#39;</span>]/$this-&gt;k) * (72/$this-&gt;img_dpi);
<a name="l04956"></a>04956       $h=($info[<span class="charliteral">&#39;h&#39;</span>]/$this-&gt;k) * (72/$this-&gt;img_dpi);
<a name="l04957"></a>04957     }
<a name="l04958"></a>04958   }
<a name="l04959"></a>04959   <span class="keywordflow">if</span>($w==0) $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]); 
<a name="l04960"></a>04960   <span class="keywordflow">if</span>($h==0) $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l04961"></a>04961 
<a name="l04962"></a>04962   <span class="keywordflow">if</span> ($watermark) {
<a name="l04963"></a>04963     $maxw = $this-&gt;w;
<a name="l04964"></a>04964     $maxh = $this-&gt;h;
<a name="l04965"></a>04965     <span class="comment">// Size = D PF or array</span>
<a name="l04966"></a>04966     <span class="keywordflow">if</span> (is_array($this-&gt;watermark_size)) {
<a name="l04967"></a>04967     $w = $this-&gt;watermark_size[0];
<a name="l04968"></a>04968     $h = $this-&gt;watermark_size[1];
<a name="l04969"></a>04969     }
<a name="l04970"></a>04970     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_string($this-&gt;watermark_size)) {
<a name="l04971"></a>04971     $maxw -= $this-&gt;watermark_size*2;
<a name="l04972"></a>04972     $maxh -= $this-&gt;watermark_size*2;
<a name="l04973"></a>04973     $w = $maxw;
<a name="l04974"></a>04974     $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l04975"></a>04975     <span class="keywordflow">if</span> ($h &gt; $maxh )  {
<a name="l04976"></a>04976       $h = $maxh ; $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l04977"></a>04977     }
<a name="l04978"></a>04978     }
<a name="l04979"></a>04979     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;watermark_size == <span class="charliteral">&#39;F&#39;</span>) {
<a name="l04980"></a>04980     <span class="keywordflow">if</span> ($this-&gt;ColActive) { $maxw = $this-&gt;w - ($this-&gt;DeflMargin + $this-&gt;DefrMargin); }
<a name="l04981"></a>04981     <span class="keywordflow">else</span> { $maxw = $this-&gt;pgwidth; }
<a name="l04982"></a>04982     $maxh = $this-&gt;h - ($this-&gt;tMargin + $this-&gt;bMargin);
<a name="l04983"></a>04983     $w = $maxw;
<a name="l04984"></a>04984     $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l04985"></a>04985     <span class="keywordflow">if</span> ($h &gt; $maxh )  {
<a name="l04986"></a>04986       $h = $maxh ; $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l04987"></a>04987     }
<a name="l04988"></a>04988     }
<a name="l04989"></a>04989     <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ($this-&gt;watermark_size == <span class="charliteral">&#39;P&#39;</span>) { <span class="comment">// Default P</span>
<a name="l04990"></a>04990     $w = $maxw;
<a name="l04991"></a>04991     $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l04992"></a>04992     <span class="keywordflow">if</span> ($h &gt; $maxh )  {
<a name="l04993"></a>04993       $h = $maxh ; $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l04994"></a>04994     }
<a name="l04995"></a>04995     }
<a name="l04996"></a>04996     <span class="comment">// Automatically resize to maximum dimensions of page if too large</span>
<a name="l04997"></a>04997     <span class="keywordflow">if</span> ($w &gt; $maxw) {
<a name="l04998"></a>04998     $w = $maxw;
<a name="l04999"></a>04999     $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l05000"></a>05000     }
<a name="l05001"></a>05001     <span class="keywordflow">if</span> ($h &gt; $maxh )  {
<a name="l05002"></a>05002     $h = $maxh ;
<a name="l05003"></a>05003     $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l05004"></a>05004     }
<a name="l05005"></a>05005     <span class="comment">// Position</span>
<a name="l05006"></a>05006     <span class="keywordflow">if</span> (is_array($this-&gt;watermark_pos)) {
<a name="l05007"></a>05007     $x = $this-&gt;watermark_pos[0];
<a name="l05008"></a>05008     $y = $this-&gt;watermark_pos[1];
<a name="l05009"></a>05009     }
<a name="l05010"></a>05010     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;watermark_pos == <span class="charliteral">&#39;F&#39;</span>)  {  <span class="comment">// centred on printable area</span>
<a name="l05011"></a>05011       $x = ($this-&gt;lMargin + ($this-&gt;pgwidth)/2) - ($w/2);
<a name="l05012"></a>05012     $y = ($this-&gt;tMargin + ($this-&gt;h - ($this-&gt;tMargin + $this-&gt;bMargin))/2) - ($h/2);
<a name="l05013"></a>05013     }
<a name="l05014"></a>05014     <span class="keywordflow">else</span> {  <span class="comment">// default P - centred on whole page</span>
<a name="l05015"></a>05015     $x = ($this-&gt;w/2) - ($w/2);
<a name="l05016"></a>05016     $y = ($this-&gt;h/2) - ($h/2);
<a name="l05017"></a>05017     }
<a name="l05018"></a>05018     <span class="comment">// mPDF 4.3.013</span>
<a name="l05019"></a>05019     <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;svg&#39;</span>) { 
<a name="l05020"></a>05020     $sx = $w*$this-&gt;k / $info[<span class="charliteral">&#39;w&#39;</span>];
<a name="l05021"></a>05021     $sy = -$h*$this-&gt;k / $info[<span class="charliteral">&#39;h&#39;</span>];
<a name="l05022"></a>05022     $outstring = sprintf(<span class="stringliteral">&#39;q %f 0 0 %f %f %f cm /FO%d Do Q&#39;</span>, $sx, $sy, $x*$this-&gt;k-$sx*$info[<span class="charliteral">&#39;x&#39;</span>], (($this-&gt;h-$y)*$this-&gt;k)-$sy*$info[<span class="charliteral">&#39;y&#39;</span>], $info[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l05023"></a>05023     }
<a name="l05024"></a>05024     <span class="keywordflow">else</span> { 
<a name="l05025"></a>05025     $outstring = sprintf(<span class="stringliteral">&quot;q %.3f 0 0 %.3f %.3f %.3f cm /I%d Do Q&quot;</span>,$w*$this-&gt;k,$h*$this-&gt;k,$x*$this-&gt;k,($this-&gt;h-($y+$h))*$this-&gt;k,$info[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l05026"></a>05026     }
<a name="l05027"></a>05027 
<a name="l05028"></a>05028     <span class="comment">// mPDF 4.3.018</span>
<a name="l05029"></a>05029     <span class="keywordflow">if</span> ($this-&gt;watermarkImgBehind) { 
<a name="l05030"></a>05030     $outstring = $this-&gt;watermarkImgAlpha . <span class="stringliteral">&quot;\n&quot;</span> . $outstring . <span class="stringliteral">&quot;\n&quot;</span> . $this-&gt;SetAlpha(1, <span class="stringliteral">&#39;Normal&#39;</span>, <span class="keyword">true</span>) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l05031"></a>05031     $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$outstring.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;\\1&#39;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l05032"></a>05032     }
<a name="l05033"></a>05033     <span class="keywordflow">else</span> { $this-&gt;_out($outstring); }
<a name="l05034"></a>05034 
<a name="l05035"></a>05035     <span class="keywordflow">return</span> 0;
<a name="l05036"></a>05036   } <span class="comment">// end of IF watermark</span>
<a name="l05037"></a>05037 
<a name="l05038"></a>05038   <span class="keywordflow">if</span> ($constrain) {
<a name="l05039"></a>05039     <span class="comment">// Automatically resize to maximum dimensions of page if too large</span>
<a name="l05040"></a>05040     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]) { $maxw = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]; }
<a name="l05041"></a>05041     <span class="keywordflow">else</span> { $maxw = $this-&gt;pgwidth; }
<a name="l05042"></a>05042     <span class="keywordflow">if</span> ($w &gt; $maxw) {
<a name="l05043"></a>05043     $w = $maxw;
<a name="l05044"></a>05044     $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l05045"></a>05045     }
<a name="l05046"></a>05046     <span class="keywordflow">if</span> ($h &gt; $this-&gt;h - ($this-&gt;tMargin + $this-&gt;bMargin + 10))  {  <span class="comment">// see below - +10 to avoid drawing too close to border of page</span>
<a name="l05047"></a>05047       $h = $this-&gt;h - ($this-&gt;tMargin + $this-&gt;bMargin + 10) ;  <span class="comment">// mPDF 4.1</span>
<a name="l05048"></a>05048     <span class="keywordflow">if</span> ($this-&gt;fullImageHeight) { $h = $this-&gt;fullImageHeight; }  <span class="comment">// mPDF 4.1</span>
<a name="l05049"></a>05049     $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l05050"></a>05050     }
<a name="l05051"></a>05051 
<a name="l05052"></a>05052 
<a name="l05053"></a>05053     <span class="comment">//Avoid drawing out of the paper(exceeding width limits).</span>
<a name="l05054"></a>05054     <span class="comment">//if ( ($x + $w) &gt; $this-&gt;fw ) {</span>
<a name="l05055"></a>05055     <span class="keywordflow">if</span> ( ($x + $w) &gt; $this-&gt;w ) {
<a name="l05056"></a>05056     $x = $this-&gt;lMargin;
<a name="l05057"></a>05057     $y += 5;
<a name="l05058"></a>05058     }
<a name="l05059"></a>05059 
<a name="l05060"></a>05060     $changedpage = <span class="keyword">false</span>;
<a name="l05061"></a>05061     $oldcolumn = $this-&gt;CurrCol;
<a name="l05062"></a>05062     <span class="comment">//Avoid drawing out of the page.</span>
<a name="l05063"></a>05063     <span class="keywordflow">if</span>($y+$h&gt;$this-&gt;PageBreakTrigger and !$this-&gt;InFooter and $this-&gt;AcceptPageBreak()) {
<a name="l05064"></a>05064     $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l05065"></a>05065     <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l05066"></a>05066     $x=$x +$this-&gt;MarginCorrection;
<a name="l05067"></a>05067     $y = $tMargin + $this-&gt;margin_header;
<a name="l05068"></a>05068     $changedpage = <span class="keyword">true</span>;
<a name="l05069"></a>05069     }
<a name="l05070"></a>05070   } <span class="comment">// end of IF constrain</span>
<a name="l05071"></a>05071 
<a name="l05072"></a>05072   <span class="comment">// mPDF 4.3.013</span>
<a name="l05073"></a>05073   <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;svg&#39;</span>) { 
<a name="l05074"></a>05074     $sx = $w*$this-&gt;k / $info[<span class="charliteral">&#39;w&#39;</span>];
<a name="l05075"></a>05075     $sy = -$h*$this-&gt;k / $info[<span class="charliteral">&#39;h&#39;</span>];
<a name="l05076"></a>05076     $outstring = sprintf(<span class="stringliteral">&#39;q %f 0 0 %f %f %f cm /FO%d Do Q&#39;</span>, $sx, $sy, $x*$this-&gt;k-$sx*$info[<span class="charliteral">&#39;x&#39;</span>], (($this-&gt;h-$y)*$this-&gt;k)-$sy*$info[<span class="charliteral">&#39;y&#39;</span>], $info[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l05077"></a>05077   }
<a name="l05078"></a>05078   <span class="keywordflow">else</span> { 
<a name="l05079"></a>05079     $outstring = sprintf(<span class="stringliteral">&quot;q %.3f 0 0 %.3f %.3f %.3f cm /I%d Do Q&quot;</span>,$w*$this-&gt;k,$h*$this-&gt;k,$x*$this-&gt;k,($this-&gt;h-($y+$h))*$this-&gt;k,$info[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l05080"></a>05080   }
<a name="l05081"></a>05081 
<a name="l05082"></a>05082   <span class="keywordflow">if</span>($paint) {
<a name="l05083"></a>05083     $this-&gt;_out($outstring);
<a name="l05084"></a>05084     <span class="keywordflow">if</span>($link) $this-&gt;Link($x,$y,$w,$h,$link);
<a name="l05085"></a>05085 
<a name="l05086"></a>05086     <span class="comment">// Avoid writing text on top of the image. // THIS WAS OUTSIDE THE if ($paint) bit!!!!!!!!!!!!!!!!</span>
<a name="l05087"></a>05087     $this-&gt;y = $y + $h;
<a name="l05088"></a>05088   }
<a name="l05089"></a>05089 
<a name="l05090"></a>05090   <span class="comment">//Return width-height array</span>
<a name="l05091"></a>05091   $sizesarray[<span class="stringliteral">&#39;WIDTH&#39;</span>] = $w;
<a name="l05092"></a>05092   $sizesarray[<span class="stringliteral">&#39;HEIGHT&#39;</span>] = $h;
<a name="l05093"></a>05093   $sizesarray[<span class="charliteral">&#39;X&#39;</span>] = $x; <span class="comment">//Position before painting image</span>
<a name="l05094"></a>05094   $sizesarray[<span class="charliteral">&#39;Y&#39;</span>] = $y; <span class="comment">//Position before painting image</span>
<a name="l05095"></a>05095   $sizesarray[<span class="stringliteral">&#39;OUTPUT&#39;</span>] = $outstring;
<a name="l05096"></a>05096   <span class="comment">// mPDF 3.0 Tiling patterns</span>
<a name="l05097"></a>05097   $sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>] = $info[<span class="charliteral">&#39;i&#39;</span>];
<a name="l05098"></a>05098   <span class="keywordflow">return</span> $sizesarray;
<a name="l05099"></a>05099 }
<a name="l05100"></a>05100 
<a name="l05101"></a>05101 
<a name="l05102"></a>05102 
<a name="l05103"></a>05103 <span class="comment">//=============================================================</span>
<a name="l05104"></a>05104 <span class="comment">//=============================================================</span>
<a name="l05105"></a>05105 <span class="comment">//=============================================================</span>
<a name="l05106"></a>05106 <span class="comment">//=============================================================</span>
<a name="l05107"></a>05107 <span class="comment">//=============================================================</span>
<a name="l05108"></a>05108 <span class="comment">// mPDF 4.0</span>
<a name="l05109"></a>05109 function _getObjAttr($t) {
<a name="l05110"></a>05110   $c = explode(<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>,$t,2);
<a name="l05111"></a>05111   $c = explode(<span class="stringliteral">&quot;,&quot;</span>,$c[1],2);
<a name="l05112"></a>05112   <span class="keywordflow">foreach</span>($c as $v) {
<a name="l05113"></a>05113     $v = explode(<span class="stringliteral">&quot;=&quot;</span>,$v,2);
<a name="l05114"></a>05114     $sp[$v[0]] = $v[1];
<a name="l05115"></a>05115   }
<a name="l05116"></a>05116   <span class="keywordflow">return</span> (unserialize($sp[<span class="stringliteral">&#39;objattr&#39;</span>]));
<a name="l05117"></a>05117 }
<a name="l05118"></a>05118 
<a name="l05119"></a>05119 
<a name="l05120"></a>05120 function inlineObject($type,$x,$y,$objattr,$Lmargin,$widthUsed,$maxWidth,$lineHeight,$paint=<span class="keyword">false</span>,$is_table=<span class="keyword">false</span>)
<a name="l05121"></a>05121 {
<a name="l05122"></a>05122    <span class="keywordflow">if</span> ($is_table) { $k = $this-&gt;shrin_k; } <span class="keywordflow">else</span> { $k = 1; }
<a name="l05123"></a>05123 
<a name="l05124"></a>05124    <span class="comment">// NB $x is only used when paint=true</span>
<a name="l05125"></a>05125   <span class="comment">// Lmargin not used</span>
<a name="l05126"></a>05126    $w = 0; 
<a name="l05127"></a>05127    <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;width&#39;</span>])) { $w = $objattr[<span class="stringliteral">&#39;width&#39;</span>]/$k; }
<a name="l05128"></a>05128    $h = 0;
<a name="l05129"></a>05129    <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;height&#39;</span>])) { $h = abs($objattr[<span class="stringliteral">&#39;height&#39;</span>]/$k); }  
<a name="l05130"></a>05130 
<a name="l05131"></a>05131    $widthLeft = $maxWidth - $widthUsed;
<a name="l05132"></a>05132    $maxHeight = $this-&gt;h - ($this-&gt;tMargin + $this-&gt;bMargin + 10) ; <span class="comment">// mPDF 4.1</span>
<a name="l05133"></a>05133    <span class="keywordflow">if</span> ($this-&gt;fullImageHeight) { $maxHeight = $this-&gt;fullImageHeight; } <span class="comment">// mPDF 4.1</span>
<a name="l05134"></a>05134   <span class="comment">// For Images</span>
<a name="l05135"></a>05135    <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;border_left&#39;</span>])) {
<a name="l05136"></a>05136   $extraWidth = ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>]+ $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>])/$k;
<a name="l05137"></a>05137   $extraHeight = ($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]+ $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>])/$k;
<a name="l05138"></a>05138   <span class="comment">// mPDF 4.0</span>
<a name="l05139"></a>05139   <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;image&#39;</span> || $type == <span class="stringliteral">&#39;barcode&#39;</span>) {
<a name="l05140"></a>05140     $extraWidth += ($objattr[<span class="stringliteral">&#39;padding_left&#39;</span>] + $objattr[<span class="stringliteral">&#39;padding_right&#39;</span>])/$k;
<a name="l05141"></a>05141     $extraHeight += ($objattr[<span class="stringliteral">&#39;padding_top&#39;</span>] + $objattr[<span class="stringliteral">&#39;padding_bottom&#39;</span>])/$k;
<a name="l05142"></a>05142   }
<a name="l05143"></a>05143    }
<a name="l05144"></a>05144 
<a name="l05145"></a>05145    <span class="comment">// mPDF 4.2 Failsafe (e.g. for HR)</span>
<a name="l05146"></a>05146    <span class="keywordflow">if</span> (!isset($objattr[<span class="stringliteral">&#39;vertical-align&#39;</span>])) { $objattr[<span class="stringliteral">&#39;vertical-align&#39;</span>] = <span class="charliteral">&#39;M&#39;</span>; }
<a name="l05147"></a>05147 
<a name="l05148"></a>05148    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;image&#39;</span> || (isset($objattr[<span class="stringliteral">&#39;subtype&#39;</span>]) &amp;&amp; $objattr[<span class="stringliteral">&#39;subtype&#39;</span>] == <span class="stringliteral">&#39;IMAGE&#39;</span>)) {
<a name="l05149"></a>05149     <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;itype&#39;</span>]) &amp;&amp; ($objattr[<span class="stringliteral">&#39;itype&#39;</span>] == <span class="stringliteral">&#39;wmf&#39;</span> || $objattr[<span class="stringliteral">&#39;itype&#39;</span>] == <span class="stringliteral">&#39;svg&#39;</span>)) { <span class="comment">// mPDF 4.3.013</span>
<a name="l05150"></a>05150   $file = $objattr[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l05151"></a>05151   $info=$this-&gt;formobjects[$file];
<a name="l05152"></a>05152     }
<a name="l05153"></a>05153     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;file&#39;</span>])) {
<a name="l05154"></a>05154   $file = $objattr[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l05155"></a>05155   $info=$this-&gt;images[$file];
<a name="l05156"></a>05156     }
<a name="l05157"></a>05157    }
<a name="l05158"></a>05158     <span class="comment">// mPDF 3.0</span>
<a name="l05159"></a>05159     <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;annot&#39;</span> || $type == <span class="stringliteral">&#39;bookmark&#39;</span> || $type == <span class="stringliteral">&#39;indexentry&#39;</span> || $type == <span class="stringliteral">&#39;toc&#39;</span>) {
<a name="l05160"></a>05160   $w = 0.00001;
<a name="l05161"></a>05161   $h = 0.00001;
<a name="l05162"></a>05162    }
<a name="l05163"></a>05163 
<a name="l05164"></a>05164    <span class="comment">// TEST whether need to skipline</span>
<a name="l05165"></a>05165    <span class="keywordflow">if</span> (!$paint) {
<a name="l05166"></a>05166   <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;hr&#39;</span>) {  <span class="comment">// always force new line</span>
<a name="l05167"></a>05167     <span class="keywordflow">if</span> (($y + $h + $lineHeight &gt; $this-&gt;PageBreakTrigger) &amp;&amp; !$this-&gt;InFooter &amp;&amp; !$is_table) { <span class="keywordflow">return</span> array(-2, $w ,$h ); } <span class="comment">// New page + new line</span>
<a name="l05168"></a>05168     <span class="keywordflow">else</span> { <span class="keywordflow">return</span> array(1, $w ,$h ); } <span class="comment">// new line</span>
<a name="l05169"></a>05169   }
<a name="l05170"></a>05170   <span class="keywordflow">else</span> {
<a name="l05171"></a>05171     <span class="keywordflow">if</span> ($widthUsed &gt; 0 &amp;&amp; $w &gt; $widthLeft &amp;&amp; (!$is_table || $type != <span class="stringliteral">&#39;image&#39;</span>)) {  <span class="comment">// New line needed</span>
<a name="l05172"></a>05172       <span class="keywordflow">if</span> (($y + $h + $lineHeight &gt; $this-&gt;PageBreakTrigger) &amp;&amp; !$this-&gt;InFooter) { <span class="keywordflow">return</span> array(-2,$w ,$h ); } <span class="comment">// New page + new line</span>
<a name="l05173"></a>05173       <span class="keywordflow">return</span> array(1,$w ,$h ); <span class="comment">// new line</span>
<a name="l05174"></a>05174     }
<a name="l05175"></a>05175     <span class="comment">// mPDF 4.2.011</span>
<a name="l05176"></a>05176     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($widthUsed &gt; 0 &amp;&amp; $w &gt; $widthLeft &amp;&amp; $is_table) {  <span class="comment">// New line needed in TABLE</span>
<a name="l05177"></a>05177       <span class="keywordflow">return</span> array(1,$w ,$h ); <span class="comment">// new line</span>
<a name="l05178"></a>05178     }
<a name="l05179"></a>05179     <span class="comment">// Will fit on line but NEW PAGE REQUIRED</span>
<a name="l05180"></a>05180     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($y + $h &gt; $this-&gt;PageBreakTrigger) &amp;&amp; !$this-&gt;InFooter &amp;&amp; !$is_table) { <span class="keywordflow">return</span> array(-1,$w ,$h ); }
<a name="l05181"></a>05181     <span class="keywordflow">else</span> { <span class="keywordflow">return</span> array(0,$w ,$h ); }
<a name="l05182"></a>05182   }
<a name="l05183"></a>05183    }
<a name="l05184"></a>05184 
<a name="l05185"></a>05185     <span class="comment">// mPDF 3.0</span>
<a name="l05186"></a>05186    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;annot&#39;</span> || $type == <span class="stringliteral">&#39;bookmark&#39;</span> || $type == <span class="stringliteral">&#39;indexentry&#39;</span> || $type == <span class="stringliteral">&#39;toc&#39;</span>) {
<a name="l05187"></a>05187   $w = 0.00001;
<a name="l05188"></a>05188   $h = 0.00001;
<a name="l05189"></a>05189   $objattr[<span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>] = 0;
<a name="l05190"></a>05190   $objattr[<span class="stringliteral">&#39;BORDER-HEIGHT&#39;</span>] = 0;
<a name="l05191"></a>05191   $objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>] = $x;
<a name="l05192"></a>05192   $objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>] = $y;
<a name="l05193"></a>05193   $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] = 0;
<a name="l05194"></a>05194   $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>] = 0;
<a name="l05195"></a>05195   $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>] = $x;
<a name="l05196"></a>05196   $objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] = $y;
<a name="l05197"></a>05197   }
<a name="l05198"></a>05198 
<a name="l05199"></a>05199   <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;image&#39;</span>) {
<a name="l05200"></a>05200   <span class="comment">// Automatically resize to width remaining</span>
<a name="l05201"></a>05201   <span class="keywordflow">if</span> ($w &gt; $widthLeft  &amp;&amp; !$is_table) {
<a name="l05202"></a>05202     $w = $widthLeft ;
<a name="l05203"></a>05203     $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l05204"></a>05204   }
<a name="l05205"></a>05205   $img_w = $w - $extraWidth ;
<a name="l05206"></a>05206   $img_h = $h - $extraHeight ;
<a name="l05207"></a>05207   <span class="comment">// mPDF 4.0</span>
<a name="l05208"></a>05208   $objattr[<span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>] = $img_w + $objattr[<span class="stringliteral">&#39;padding_left&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;padding_right&#39;</span>]/$k + (($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05209"></a>05209   $objattr[<span class="stringliteral">&#39;BORDER-HEIGHT&#39;</span>] = $img_h + $objattr[<span class="stringliteral">&#39;padding_top&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;padding_bottom&#39;</span>]/$k + (($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05210"></a>05210   $objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>] = $x + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>]/$k + (($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05211"></a>05211   $objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>] = $y + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]/$k + (($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05212"></a>05212   $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] = $img_w;
<a name="l05213"></a>05213   $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>] = $img_h;
<a name="l05214"></a>05214   $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>] = $x + $objattr[<span class="stringliteral">&#39;padding_left&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>]/$k + ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k);
<a name="l05215"></a>05215   $objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] = $y + $objattr[<span class="stringliteral">&#39;padding_top&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]/$k + ($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k) ;
<a name="l05216"></a>05216   $objattr[<span class="stringliteral">&#39;ID&#39;</span>] = $info[<span class="charliteral">&#39;i&#39;</span>];
<a name="l05217"></a>05217    }
<a name="l05218"></a>05218 
<a name="l05219"></a>05219    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;input&#39;</span> &amp;&amp; $objattr[<span class="stringliteral">&#39;subtype&#39;</span>] == <span class="stringliteral">&#39;IMAGE&#39;</span>) { 
<a name="l05220"></a>05220   $img_w = $w - $extraWidth ;
<a name="l05221"></a>05221   $img_h = $h - $extraHeight ;
<a name="l05222"></a>05222   $objattr[<span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>] = $img_w + (($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05223"></a>05223   $objattr[<span class="stringliteral">&#39;BORDER-HEIGHT&#39;</span>] = $img_h + (($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k + $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05224"></a>05224   $objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>] = $x + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>]/$k + (($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05225"></a>05225   $objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>] = $y + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]/$k + (($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k)/2) ;
<a name="l05226"></a>05226   $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] = $img_w;
<a name="l05227"></a>05227   $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>] = $img_h;
<a name="l05228"></a>05228   $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>] = $x + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>]/$k + ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k);
<a name="l05229"></a>05229   $objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] = $y + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]/$k + ($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/$k) ;
<a name="l05230"></a>05230   $objattr[<span class="stringliteral">&#39;ID&#39;</span>] = $info[<span class="charliteral">&#39;i&#39;</span>];
<a name="l05231"></a>05231    }
<a name="l05232"></a>05232 
<a name="l05233"></a>05233 
<a name="l05234"></a>05234 
<a name="l05235"></a>05235    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;textarea&#39;</span>) {
<a name="l05236"></a>05236   <span class="comment">// Automatically resize to width remaining</span>
<a name="l05237"></a>05237   <span class="keywordflow">if</span> ($w &gt; $widthLeft &amp;&amp; !$is_table) {
<a name="l05238"></a>05238     $w = $widthLeft ;
<a name="l05239"></a>05239   }
<a name="l05240"></a>05240   <span class="keywordflow">if</span> (($y + $h &gt; $this-&gt;PageBreakTrigger) &amp;&amp; !$this-&gt;InFooter) {
<a name="l05241"></a>05241     $h=$this-&gt;h - $y - $this-&gt;bMargin;
<a name="l05242"></a>05242   }
<a name="l05243"></a>05243    }
<a name="l05244"></a>05244 
<a name="l05245"></a>05245    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;hr&#39;</span>) {
<a name="l05246"></a>05246   <span class="keywordflow">if</span> ($is_table) { 
<a name="l05247"></a>05247     $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] = $maxWidth * $objattr[<span class="stringliteral">&#39;W-PERCENT&#39;</span>]/100; 
<a name="l05248"></a>05248     $objattr[<span class="stringliteral">&#39;width&#39;</span>] = $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>]; 
<a name="l05249"></a>05249     <span class="comment">// mPDF 3.0</span>
<a name="l05250"></a>05250     $w = $maxWidth;
<a name="l05251"></a>05251   }
<a name="l05252"></a>05252   <span class="keywordflow">else</span> { 
<a name="l05253"></a>05253     <span class="keywordflow">if</span> ($w&gt;$maxWidth) { $w = $maxWidth; }
<a name="l05254"></a>05254     $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] = $w; 
<a name="l05255"></a>05255     <span class="comment">// mPDF 3.0</span>
<a name="l05256"></a>05256     $w = $maxWidth;
<a name="l05257"></a>05257   }
<a name="l05258"></a>05258   }
<a name="l05259"></a>05259 
<a name="l05260"></a>05260 
<a name="l05261"></a>05261 
<a name="l05262"></a>05262    <span class="keywordflow">if</span> (($type == <span class="stringliteral">&#39;select&#39;</span>) || ($type == <span class="stringliteral">&#39;input&#39;</span> &amp;&amp; ($objattr[<span class="stringliteral">&#39;subtype&#39;</span>] == <span class="stringliteral">&#39;TEXT&#39;</span> || $objattr[<span class="stringliteral">&#39;subtype&#39;</span>] == <span class="stringliteral">&#39;PASSWORD&#39;</span>))) {
<a name="l05263"></a>05263   <span class="comment">// Automatically resize to width remaining</span>
<a name="l05264"></a>05264   <span class="keywordflow">if</span> ($w &gt; $widthLeft &amp;&amp; !$is_table) {
<a name="l05265"></a>05265     $w = $widthLeft;
<a name="l05266"></a>05266   }
<a name="l05267"></a>05267    }
<a name="l05268"></a>05268 
<a name="l05269"></a>05269    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;textarea&#39;</span> || $type == <span class="stringliteral">&#39;select&#39;</span> || $type == <span class="stringliteral">&#39;input&#39;</span>) {
<a name="l05270"></a>05270   <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;fontsize&#39;</span>])) $objattr[<span class="stringliteral">&#39;fontsize&#39;</span>] /= $k;
<a name="l05271"></a>05271   <span class="keywordflow">if</span> (isset($objattr[<span class="stringliteral">&#39;linewidth&#39;</span>])) $objattr[<span class="stringliteral">&#39;linewidth&#39;</span>] /= $k;
<a name="l05272"></a>05272    }
<a name="l05273"></a>05273 
<a name="l05274"></a>05274   <span class="comment">// mPDF 3.0</span>
<a name="l05275"></a>05275    <span class="keywordflow">if</span> (!isset($objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>])) { $objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>] = 0; }
<a name="l05276"></a>05276    <span class="keywordflow">if</span> (!isset($objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>])) { $objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>] = 0; }
<a name="l05277"></a>05277    <span class="keywordflow">if</span> (!isset($objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>])) { $objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] = 0; }
<a name="l05278"></a>05278    <span class="keywordflow">if</span> (!isset($objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>])) { $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>] = 0; }
<a name="l05279"></a>05279 
<a name="l05280"></a>05280    <span class="comment">//Return width-height array</span>
<a name="l05281"></a>05281    $objattr[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] = $w;
<a name="l05282"></a>05282    $objattr[<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>] = $h;
<a name="l05283"></a>05283    $objattr[<span class="stringliteral">&#39;OUTER-X&#39;</span>] = $x;
<a name="l05284"></a>05284    $objattr[<span class="stringliteral">&#39;OUTER-Y&#39;</span>] = $y;
<a name="l05285"></a>05285    <span class="keywordflow">return</span> $objattr;
<a name="l05286"></a>05286 }
<a name="l05287"></a>05287 
<a name="l05288"></a>05288 
<a name="l05289"></a>05289 <span class="comment">//=============================================================</span>
<a name="l05290"></a>05290 <span class="comment">//=============================================================</span>
<a name="l05291"></a>05291 <span class="comment">//=============================================================</span>
<a name="l05292"></a>05292 <span class="comment">//=============================================================</span>
<a name="l05293"></a>05293 <span class="comment">//=============================================================</span>
<a name="l05294"></a>05294 
<a name="l05295"></a>05295 
<a name="l05296"></a>05296 
<a name="l05297"></a>05297 
<a name="l05298"></a>05298 function SetDash($black=<span class="keyword">false</span>,$white=<span class="keyword">false</span>)
<a name="l05299"></a>05299 {
<a name="l05300"></a>05300         <span class="keywordflow">if</span>($black and $white) $s=sprintf(<span class="stringliteral">&#39;[%.3f %.3f] 0 d&#39;</span>,$black*$this-&gt;k,$white*$this-&gt;k);
<a name="l05301"></a>05301         <span class="keywordflow">else</span> $s=<span class="stringliteral">&#39;[] 0 d&#39;</span>;
<a name="l05302"></a>05302   <span class="keywordflow">if</span>($this-&gt;page&gt;0 &amp;&amp; ((isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Dash&#39;</span>]) &amp;&amp; $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Dash&#39;</span>] != $s) || !isset($this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Dash&#39;</span>]) || $this-&gt;keep_block_together)) { $this-&gt;_out($s); }
<a name="l05303"></a>05303   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Dash&#39;</span>] = $s;
<a name="l05304"></a>05304 
<a name="l05305"></a>05305 }
<a name="l05306"></a>05306 
<a name="l05307"></a>05307 function SetDisplayPreferences($preferences) {
<a name="l05308"></a>05308   <span class="comment">// String containing any or none of /HideMenubar/HideToolbar/HideWindowUI/DisplayDocTitle/CenterWindow/FitWindow</span>
<a name="l05309"></a>05309     $this-&gt;DisplayPreferences .= $preferences;
<a name="l05310"></a>05310 }
<a name="l05311"></a>05311 
<a name="l05312"></a>05312 
<a name="l05313"></a>05313 function Ln($h=<span class="stringliteral">&#39;&#39;</span>,$collapsible=0)
<a name="l05314"></a>05314 {
<a name="l05315"></a>05315 <span class="comment">// Added collapsible to allow collapsible top-margin on new page</span>
<a name="l05316"></a>05316   <span class="comment">//Line feed; default value is last cell height</span>
<a name="l05317"></a>05317   $this-&gt;x = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l05318"></a>05318   <span class="keywordflow">if</span> ($collapsible &amp;&amp; ($this-&gt;y==$this-&gt;tMargin) &amp;&amp; (!$this-&gt;ColActive)) { $h = 0; }
<a name="l05319"></a>05319   <span class="keywordflow">if</span>(is_string($h)) $this-&gt;y+=$this-&gt;lasth;
<a name="l05320"></a>05320   <span class="keywordflow">else</span> $this-&gt;y+=$h;
<a name="l05321"></a>05321 }
<a name="l05322"></a>05322 
<a name="l05323"></a>05323 
<a name="l05324"></a>05324 <span class="comment">// mPDF 3.0 Also does border when Columns active</span>
<a name="l05325"></a>05325 <span class="comment">// $state = 0 normal; 1 top; 2 bottom; 3 top and bottom</span>
<a name="l05326"></a>05326 function DivLn($h,$level=-3,$move_y=<span class="keyword">true</span>,$collapsible=<span class="keyword">false</span>,$state=0) {
<a name="l05327"></a>05327   <span class="comment">// this-&gt;x is returned as it was</span>
<a name="l05328"></a>05328   <span class="comment">// adds lines (y) where DIV bgcolors are filled in</span>
<a name="l05329"></a>05329   <span class="comment">// mPDF 4.2 allows .00001 as nominal height used for bookmarks/annotations etc.</span>
<a name="l05330"></a>05330   <span class="keywordflow">if</span> ($collapsible &amp;&amp; (sprintf(<span class="stringliteral">&quot;%0.4f&quot;</span>, $this-&gt;y)==sprintf(<span class="stringliteral">&quot;%0.4f&quot;</span>, $this-&gt;tMargin)) &amp;&amp; (!$this-&gt;ColActive)) { <span class="keywordflow">return</span>; }
<a name="l05331"></a>05331 
<a name="l05332"></a>05332   <span class="comment">// mPDF 3.0</span>
<a name="l05333"></a>05333   <span class="comment">// Still use this method if columns or page-break-inside: avoid, as it allows repositioning later</span>
<a name="l05334"></a>05334   <span class="comment">// otherwise, now uses PaintDivBB()</span>
<a name="l05335"></a>05335   <span class="keywordflow">if</span> (!$this-&gt;ColActive &amp;&amp; !$this-&gt;keep_block_together &amp;&amp; !$this-&gt;kwt) {  <span class="comment">// mPDF 4.0 added kwt</span>
<a name="l05336"></a>05336   <span class="keywordflow">if</span> ($move_y &amp;&amp; !$this-&gt;ColActive) { $this-&gt;y += $h; }
<a name="l05337"></a>05337   <span class="keywordflow">return</span>; 
<a name="l05338"></a>05338   }
<a name="l05339"></a>05339 
<a name="l05340"></a>05340   <span class="keywordflow">if</span> ($level == -3) { $level = $this-&gt;blklvl; }
<a name="l05341"></a>05341   $firstblockfill = $this-&gt;GetFirstBlockFill();
<a name="l05342"></a>05342   <span class="keywordflow">if</span> ($firstblockfill &amp;&amp; $this-&gt;blklvl &gt; 0 &amp;&amp; $this-&gt;blklvl &gt;= $firstblockfill) {
<a name="l05343"></a>05343   $last_x = 0;
<a name="l05344"></a>05344   $last_w = 0;
<a name="l05345"></a>05345   $last_fc = $this-&gt;FillColor;
<a name="l05346"></a>05346   $bak_x = $this-&gt;x;
<a name="l05347"></a>05347   $bak_h = $this-&gt;divheight;
<a name="l05348"></a>05348   $this-&gt;divheight = 0; <span class="comment">// Temporarily turn off divheight - as Cell() uses it to check for PageBreak</span>
<a name="l05349"></a>05349   <span class="keywordflow">for</span> ($blvl=$firstblockfill;$blvl&lt;=$level;$blvl++) {
<a name="l05350"></a>05350     $this-&gt;SetBlockFill($blvl);
<a name="l05351"></a>05351     $this-&gt;x = $this-&gt;lMargin + $this-&gt;blk[$blvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l05352"></a>05352     <span class="keywordflow">if</span> ($last_x != $this-&gt;lMargin + $this-&gt;blk[$blvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>] || $last_w != $this-&gt;blk[$blvl][<span class="stringliteral">&#39;width&#39;</span>] || $last_fc != $this-&gt;FillColor) {
<a name="l05353"></a>05353       $x = $this-&gt;x;  <span class="comment">// mPDF 3.0</span>
<a name="l05354"></a>05354       $this-&gt;Cell( ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;width&#39;</span>]), $h, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, 1);
<a name="l05355"></a>05355       <span class="comment">// mPDF 3.0 Also does border when Columns active</span>
<a name="l05356"></a>05356       <span class="keywordflow">if</span> (!$this-&gt;keep_block_together &amp;&amp; !$this-&gt;writingHTMLheader &amp;&amp; !$this-&gt;writingHTMLfooter) {
<a name="l05357"></a>05357         $this-&gt;x = $x;
<a name="l05358"></a>05358         <span class="comment">// $state = 0 normal; 1 top; 2 bottom; 3 top and bottom</span>
<a name="l05359"></a>05359         <span class="keywordflow">if</span> ($blvl == $this-&gt;blklvl) { $this-&gt;PaintDivLnBorder($state,$blvl,$h); }
<a name="l05360"></a>05360         <span class="keywordflow">else</span> { $this-&gt;PaintDivLnBorder(0,$blvl,$h); }
<a name="l05361"></a>05361       }
<a name="l05362"></a>05362     }
<a name="l05363"></a>05363     $last_x = $this-&gt;lMargin + $this-&gt;blk[$blvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l05364"></a>05364     $last_w = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l05365"></a>05365     $last_fc = $this-&gt;FillColor;
<a name="l05366"></a>05366   }
<a name="l05367"></a>05367   <span class="comment">// Reset current block fill</span>
<a name="l05368"></a>05368   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>])) { 
<a name="l05369"></a>05369     $bcor = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>];
<a name="l05370"></a>05370     $this-&gt;SetFillColor($bcor[<span class="charliteral">&#39;R&#39;</span>],$bcor[<span class="charliteral">&#39;G&#39;</span>],$bcor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l05371"></a>05371   }
<a name="l05372"></a>05372   $this-&gt;x = $bak_x;
<a name="l05373"></a>05373   $this-&gt;divheight = $bak_h;
<a name="l05374"></a>05374   }
<a name="l05375"></a>05375   <span class="keywordflow">if</span> ($move_y) { $this-&gt;y += $h; }
<a name="l05376"></a>05376 }
<a name="l05377"></a>05377 
<a name="l05378"></a>05378 function GetX()
<a name="l05379"></a>05379 {
<a name="l05380"></a>05380   <span class="comment">//Get x position</span>
<a name="l05381"></a>05381   <span class="keywordflow">return</span> $this-&gt;x;
<a name="l05382"></a>05382 }
<a name="l05383"></a>05383 
<a name="l05384"></a>05384 function SetX($x)
<a name="l05385"></a>05385 {
<a name="l05386"></a>05386   <span class="comment">//Set x position</span>
<a name="l05387"></a>05387   <span class="keywordflow">if</span>($x &gt;= 0) $this-&gt;x=$x;
<a name="l05388"></a>05388   <span class="keywordflow">else</span> $this-&gt;x = $this-&gt;w + $x;
<a name="l05389"></a>05389 }
<a name="l05390"></a>05390 
<a name="l05391"></a>05391 function GetY()
<a name="l05392"></a>05392 {
<a name="l05393"></a>05393   <span class="comment">//Get y position</span>
<a name="l05394"></a>05394   <span class="keywordflow">return</span> $this-&gt;y;
<a name="l05395"></a>05395 }
<a name="l05396"></a>05396 
<a name="l05397"></a>05397 function SetY($y)
<a name="l05398"></a>05398 {
<a name="l05399"></a>05399   <span class="comment">//Set y position and reset x</span>
<a name="l05400"></a>05400   $this-&gt;x=$this-&gt;lMargin;
<a name="l05401"></a>05401   <span class="keywordflow">if</span>($y&gt;=0)
<a name="l05402"></a>05402     $this-&gt;y=$y;
<a name="l05403"></a>05403   <span class="keywordflow">else</span>
<a name="l05404"></a>05404     $this-&gt;y=$this-&gt;h+$y;
<a name="l05405"></a>05405 }
<a name="l05406"></a>05406 
<a name="l05407"></a>05407 function SetXY($x,$y)
<a name="l05408"></a>05408 {
<a name="l05409"></a>05409   <span class="comment">//Set x and y positions</span>
<a name="l05410"></a>05410   $this-&gt;SetY($y);
<a name="l05411"></a>05411   $this-&gt;SetX($x);
<a name="l05412"></a>05412 }
<a name="l05413"></a>05413 
<a name="l05414"></a>05414 
<a name="l05415"></a>05415 
<a name="l05416"></a>05416 function Output($name=<span class="stringliteral">&#39;&#39;</span>,$dest=<span class="stringliteral">&#39;&#39;</span>)
<a name="l05417"></a>05417 {
<a name="l05418"></a>05418 
<a name="l05419"></a>05419   <span class="comment">//Output PDF to some destination</span>
<a name="l05420"></a>05420   global $_SERVER;
<a name="l05421"></a>05421   <span class="comment">// mPDF 4.0</span>
<a name="l05422"></a>05422   <span class="keywordflow">if</span> ($this-&gt;showStats) {
<a name="l05423"></a>05423     echo <span class="stringliteral">&#39;&lt;div&gt;Generated in &#39;</span>.sprintf(<span class="stringliteral">&#39;%.2f&#39;</span>,(microtime(<span class="keyword">true</span>) - $this-&gt;time0)).<span class="stringliteral">&#39; seconds&lt;/div&gt;&#39;</span>;
<a name="l05424"></a>05424   }
<a name="l05425"></a>05425   <span class="comment">//Finish document if necessary</span>
<a name="l05426"></a>05426   <span class="keywordflow">if</span>($this-&gt;state &lt; 3) $this-&gt;Close();
<a name="l05427"></a>05427   <span class="comment">// fn. error_get_last is only in PHP&gt;=5.2</span>
<a name="l05428"></a>05428   <span class="keywordflow">if</span> ($this-&gt;debug &amp;&amp; function_exists(<span class="stringliteral">&#39;error_get_last&#39;</span>) &amp;&amp; error_get_last()) {
<a name="l05429"></a>05429      $e = error_get_last(); 
<a name="l05430"></a>05430      <span class="keywordflow">if</span> (($e[<span class="stringliteral">&#39;type&#39;</span>] &lt; 2048 &amp;&amp; $e[<span class="stringliteral">&#39;type&#39;</span>] != 8) || (intval($e[<span class="stringliteral">&#39;type&#39;</span>]) &amp; intval(ini_get(<span class="stringliteral">&quot;error_reporting&quot;</span>)))) {
<a name="l05431"></a>05431     echo <span class="stringliteral">&quot;&lt;p&gt;Error message detected - PDF file generation aborted.&lt;/p&gt;&quot;</span>; 
<a name="l05432"></a>05432     echo $e[<span class="stringliteral">&#39;message&#39;</span>].<span class="stringliteral">&#39;&lt;br /&gt;&#39;</span>;
<a name="l05433"></a>05433     echo <span class="stringliteral">&#39;File: &#39;</span>.$e[<span class="stringliteral">&#39;file&#39;</span>].<span class="stringliteral">&#39;&lt;br /&gt;&#39;</span>;
<a name="l05434"></a>05434     echo <span class="stringliteral">&#39;Line: &#39;</span>.$e[<span class="stringliteral">&#39;line&#39;</span>].<span class="stringliteral">&#39;&lt;br /&gt;&#39;</span>;
<a name="l05435"></a>05435     exit; 
<a name="l05436"></a>05436      }
<a name="l05437"></a>05437   }
<a name="l05438"></a>05438 
<a name="l05439"></a>05439   <span class="comment">// mPDF 4.2.018</span>
<a name="l05440"></a>05440   <span class="keywordflow">if</span> ($this-&gt;PDFA &amp;&amp; $this-&gt;encrypted) { $this-&gt;Error(<span class="stringliteral">&quot;PDFA1-b does not permit encryption of documents.&quot;</span>); }
<a name="l05441"></a>05441   <span class="keywordflow">if</span> (count($this-&gt;PDFAwarnings) &amp;&amp; $this-&gt;PDFA &amp;&amp; !$this-&gt;PDFAauto) {
<a name="l05442"></a>05442     echo <span class="stringliteral">&#39;&lt;div&gt;WARNING - This file could not be generated as it stands as a PDFA1-b compliant file.&lt;/div&gt;&#39;</span>;
<a name="l05443"></a>05443     echo <span class="stringliteral">&#39;&lt;div&gt;These issues can be automatically fixed by mPDF using &lt;i&gt;$mpdf-&amp;gt;PDFAauto=true;&lt;/i&gt;&lt;/div&gt;&#39;</span>;
<a name="l05444"></a>05444     echo <span class="stringliteral">&#39;&lt;div&gt;Action that mPDF will take to automatically force PDFA1-b compliance are shown in brackets.&lt;/div&gt;&#39;</span>;
<a name="l05445"></a>05445     echo <span class="stringliteral">&#39;&lt;div&gt;Warning(s) generated:&lt;/div&gt;&lt;ul&gt;&#39;</span>;
<a name="l05446"></a>05446     <span class="keywordflow">foreach</span>($this-&gt;PDFAwarnings AS $w) {
<a name="l05447"></a>05447       echo <span class="stringliteral">&#39;&lt;li&gt;&#39;</span>.$w.<span class="stringliteral">&#39;&lt;/li&gt;&#39;</span>;
<a name="l05448"></a>05448     }
<a name="l05449"></a>05449     echo <span class="stringliteral">&#39;&lt;/ul&gt;&#39;</span>;
<a name="l05450"></a>05450     exit;
<a name="l05451"></a>05451   }
<a name="l05452"></a>05452 
<a name="l05453"></a>05453   <span class="comment">// mPDF 4.0</span>
<a name="l05454"></a>05454   <span class="keywordflow">if</span> ($this-&gt;showStats) {
<a name="l05455"></a>05455     echo <span class="stringliteral">&#39;&lt;div&gt;Compiled in &#39;</span>.sprintf(<span class="stringliteral">&#39;%.2f&#39;</span>,(microtime(<span class="keyword">true</span>) - $this-&gt;time0)).<span class="stringliteral">&#39; seconds (total)&lt;/div&gt;&#39;</span>;
<a name="l05456"></a>05456     echo <span class="stringliteral">&#39;&lt;div&gt;Peak Memory usage &#39;</span>.number_format((memory_get_peak_usage(<span class="keyword">true</span>)/(1024*1024)),2).<span class="stringliteral">&#39; MB&lt;/div&gt;&#39;</span>;
<a name="l05457"></a>05457     echo <span class="stringliteral">&#39;&lt;div&gt;PDF file size &#39;</span>.number_format((strlen($this-&gt;buffer)/1024)).<span class="stringliteral">&#39; kB&lt;/div&gt;&#39;</span>;
<a name="l05458"></a>05458     echo <span class="stringliteral">&#39;&lt;div&gt;Number of fonts &#39;</span>.count($this-&gt;fonts).<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l05459"></a>05459     exit;
<a name="l05460"></a>05460   }
<a name="l05461"></a>05461 
<a name="l05462"></a>05462   <span class="keywordflow">if</span>(is_bool($dest)) $dest=$dest ? <span class="charliteral">&#39;D&#39;</span> : <span class="charliteral">&#39;F&#39;</span>;
<a name="l05463"></a>05463   $dest=strtoupper($dest);
<a name="l05464"></a>05464   <span class="keywordflow">if</span>($dest==<span class="stringliteral">&#39;&#39;</span>) {
<a name="l05465"></a>05465     <span class="keywordflow">if</span>($name==<span class="stringliteral">&#39;&#39;</span>) {
<a name="l05466"></a>05466       $name=<span class="stringliteral">&#39;mpdf.pdf&#39;</span>;
<a name="l05467"></a>05467       $dest=<span class="charliteral">&#39;I&#39;</span>;
<a name="l05468"></a>05468     }
<a name="l05469"></a>05469     <span class="keywordflow">else</span> { $dest=<span class="charliteral">&#39;F&#39;</span>; }
<a name="l05470"></a>05470   }
<a name="l05471"></a>05471 
<a name="l05472"></a>05472     <span class="keywordflow">switch</span>($dest) {
<a name="l05473"></a>05473        <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:
<a name="l05474"></a>05474       <span class="comment">// mPDF 3.0 // Edited mPDF 3.1</span>
<a name="l05475"></a>05475       <span class="keywordflow">if</span> ($this-&gt;debug &amp;&amp; !$this-&gt;allow_output_buffering &amp;&amp; ob_get_contents()) { echo <span class="stringliteral">&quot;&lt;p&gt;Output has already been sent from the script - PDF file generation aborted.&lt;/p&gt;&quot;</span>; exit; }
<a name="l05476"></a>05476       <span class="comment">//Send to standard output</span>
<a name="l05477"></a>05477       <span class="keywordflow">if</span>(isset($_SERVER[<span class="stringliteral">&#39;SERVER_NAME&#39;</span>]))
<a name="l05478"></a>05478       {
<a name="l05479"></a>05479         <span class="comment">//We send to a browser</span>
<a name="l05480"></a>05480         header(<span class="stringliteral">&#39;Content-Type: application/pdf&#39;</span>);
<a name="l05481"></a>05481         <span class="keywordflow">if</span>(headers_sent())
<a name="l05482"></a>05482           $this-&gt;Error(<span class="stringliteral">&#39;Some data has already been output to browser, can\&#39;t send PDF file&#39;</span>);
<a name="l05483"></a>05483         header(<span class="stringliteral">&#39;Content-Length: &#39;</span>.strlen($this-&gt;buffer));
<a name="l05484"></a>05484         header(<span class="stringliteral">&#39;Content-disposition: inline; filename=&quot;&#39;</span>.$name.<span class="charliteral">&#39;&quot;&#39;</span>);  <span class="comment">// mPDF 4.3.007B</span>
<a name="l05485"></a>05485         <span class="comment">// mPDF 4.2</span>
<a name="l05486"></a>05486         header(<span class="stringliteral">&#39;Pragma: no-cache&#39;</span>);
<a name="l05487"></a>05487         <span class="comment">// mPDF 4.3.012B IE6 : this header avoid IE6 to open directly the pdf file</span>
<a name="l05488"></a>05488         <span class="comment">//header(&#39;Cache-Control: no-cache, must-revalidate&#39;);</span>
<a name="l05489"></a>05489         header(<span class="stringliteral">&#39;Cache-Control: maxage=0&#39;</span>);
<a name="l05490"></a>05490 
<a name="l05491"></a>05491       }
<a name="l05492"></a>05492       echo $this-&gt;buffer;
<a name="l05493"></a>05493       <span class="keywordflow">break</span>;
<a name="l05494"></a>05494        <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>:
<a name="l05495"></a>05495       <span class="comment">//Download file</span>
<a name="l05496"></a>05496       <span class="comment">// mPDF 4.0</span>
<a name="l05497"></a>05497       <span class="keywordflow">if</span>(isset($_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>]) and strpos($_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>],<span class="stringliteral">&#39;MSIE&#39;</span>)) {
<a name="l05498"></a>05498         <span class="keywordflow">if</span>(isset($_SERVER[<span class="stringliteral">&#39;HTTPS&#39;</span>]) &amp;&amp; $_SERVER[<span class="stringliteral">&#39;HTTPS&#39;</span>]==<span class="stringliteral">&#39;on&#39;</span>) {
<a name="l05499"></a>05499           header(<span class="stringliteral">&#39;HTTP/1.1 200 OK&#39;</span>);
<a name="l05500"></a>05500           header(<span class="stringliteral">&#39;Status: 200 OK&#39;</span>);
<a name="l05501"></a>05501           header(<span class="stringliteral">&#39;Pragma: anytextexeptno-cache&#39;</span>, <span class="keyword">true</span>);
<a name="l05502"></a>05502           header(<span class="stringliteral">&quot;Cache-Control: public, must-revalidate&quot;</span>);
<a name="l05503"></a>05503         } 
<a name="l05504"></a>05504         <span class="keywordflow">else</span> {
<a name="l05505"></a>05505           header(<span class="stringliteral">&#39;Pragma: no-cache&#39;</span>);
<a name="l05506"></a>05506           <span class="comment">// mPDF 4.3.012B IE6 : this header avoid IE6 to open directly the pdf file</span>
<a name="l05507"></a>05507           <span class="comment">//header(&#39;Cache-Control: no-cache, must-revalidate&#39;);</span>
<a name="l05508"></a>05508           header(<span class="stringliteral">&#39;Cache-Control: maxage=0&#39;</span>);
<a name="l05509"></a>05509         }
<a name="l05510"></a>05510         header(<span class="stringliteral">&#39;Content-Type: application/force-download&#39;</span>);
<a name="l05511"></a>05511       } 
<a name="l05512"></a>05512       <span class="keywordflow">else</span> {
<a name="l05513"></a>05513         header(<span class="stringliteral">&#39;Content-Type: application/octet-stream&#39;</span>);
<a name="l05514"></a>05514       }
<a name="l05515"></a>05515       <span class="keywordflow">if</span>(headers_sent())
<a name="l05516"></a>05516         $this-&gt;Error(<span class="stringliteral">&#39;Some data has already been output to browser, can\&#39;t send PDF file&#39;</span>);
<a name="l05517"></a>05517       header(<span class="stringliteral">&#39;Content-Length: &#39;</span>.strlen($this-&gt;buffer));
<a name="l05518"></a>05518       header(<span class="stringliteral">&#39;Content-disposition: attachment; filename=&quot;&#39;</span>.$name.<span class="charliteral">&#39;&quot;&#39;</span>);  <span class="comment">// mPDF 4.3.007B</span>
<a name="l05519"></a>05519       echo $this-&gt;buffer;
<a name="l05520"></a>05520       <span class="keywordflow">break</span>;
<a name="l05521"></a>05521        <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>:
<a name="l05522"></a>05522       <span class="comment">//Save to local file</span>
<a name="l05523"></a>05523       $f=fopen($name,<span class="stringliteral">&#39;wb&#39;</span>);
<a name="l05524"></a>05524       <span class="keywordflow">if</span>(!$f) $this-&gt;Error(<span class="stringliteral">&#39;Unable to create output file: &#39;</span>.$name);
<a name="l05525"></a>05525       fwrite($f,$this-&gt;buffer,strlen($this-&gt;buffer));
<a name="l05526"></a>05526       fclose($f);
<a name="l05527"></a>05527       <span class="keywordflow">break</span>;
<a name="l05528"></a>05528        <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:
<a name="l05529"></a>05529       <span class="comment">//Return as a string</span>
<a name="l05530"></a>05530       <span class="keywordflow">return</span> $this-&gt;buffer;
<a name="l05531"></a>05531        <span class="keywordflow">default</span>:
<a name="l05532"></a>05532       $this-&gt;Error(<span class="stringliteral">&#39;Incorrect output destination: &#39;</span>.$dest);
<a name="l05533"></a>05533     }
<a name="l05534"></a>05534   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l05535"></a>05535 }
<a name="l05536"></a>05536 
<a name="l05537"></a>05537 
<a name="l05538"></a>05538 <span class="comment">// *****************************************************************************</span>
<a name="l05539"></a>05539 <span class="comment">//                                                                             *</span>
<a name="l05540"></a>05540 <span class="comment">//                             Protected methods                               *</span>
<a name="l05541"></a>05541 <span class="comment">//                                                                             *</span>
<a name="l05542"></a>05542 <span class="comment">// *****************************************************************************</span>
<a name="l05543"></a>05543 function _dochecks()
<a name="l05544"></a>05544 {
<a name="l05545"></a>05545   <span class="comment">//Check for locale-related bug</span>
<a name="l05546"></a>05546   <span class="keywordflow">if</span>(1.1==1)
<a name="l05547"></a>05547     $this-&gt;Error(<span class="stringliteral">&#39;Don\&#39;t alter the locale before including class file&#39;</span>);
<a name="l05548"></a>05548   <span class="comment">//Check for decimal separator</span>
<a name="l05549"></a>05549   <span class="keywordflow">if</span>(sprintf(<span class="stringliteral">&#39;%.1f&#39;</span>,1.0)!=<span class="stringliteral">&#39;1.0&#39;</span>)
<a name="l05550"></a>05550     setlocale(LC_NUMERIC,<span class="charliteral">&#39;C&#39;</span>);
<a name="l05551"></a>05551 }
<a name="l05552"></a>05552 
<a name="l05553"></a>05553 function _begindoc()
<a name="l05554"></a>05554 {
<a name="l05555"></a>05555   <span class="comment">//Start document</span>
<a name="l05556"></a>05556   $this-&gt;state=1;
<a name="l05557"></a>05557   $this-&gt;_out(<span class="stringliteral">&#39;%PDF-&#39;</span>.$this-&gt;pdf_version);
<a name="l05558"></a>05558   $this-&gt;_out(<span class="charliteral">&#39;%&#39;</span>.chr(226).chr(227).chr(207).chr(211)); <span class="comment">// mPDF 4.2.018  4 chars &gt; 128 to show binary file</span>
<a name="l05559"></a>05559 }
<a name="l05560"></a>05560 
<a name="l05561"></a>05561 
<a name="l05562"></a>05562 <span class="comment">// mPDF 4.0 Write out all HTML Headers and Footers</span>
<a name="l05563"></a>05563 function _puthtmlheaders() {
<a name="l05564"></a>05564   $this-&gt;state=2;
<a name="l05565"></a>05565   $nb=$this-&gt;page;
<a name="l05566"></a>05566   <span class="keywordflow">for</span>($n=1;$n&lt;=$nb;$n++) {
<a name="l05567"></a>05567     <span class="keywordflow">if</span> ($this-&gt;mirrorMargins &amp;&amp; $n%2==0) { $OE = <span class="charliteral">&#39;E&#39;</span>; } <span class="comment">// EVEN</span>
<a name="l05568"></a>05568     <span class="keywordflow">else</span> { $OE = <span class="charliteral">&#39;O&#39;</span>; }
<a name="l05569"></a>05569     $this-&gt;page = $n;
<a name="l05570"></a>05570     <span class="keywordflow">if</span> (isset($this-&gt;saveHTMLHeader[$n][$OE])) {
<a name="l05571"></a>05571     $html = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;html&#39;</span>];
<a name="l05572"></a>05572     $this-&gt;lMargin = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;ml&#39;</span>];
<a name="l05573"></a>05573     $this-&gt;rMargin = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;mr&#39;</span>];
<a name="l05574"></a>05574     $this-&gt;tMargin = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;mh&#39;</span>];
<a name="l05575"></a>05575     $this-&gt;bMargin = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;mf&#39;</span>];
<a name="l05576"></a>05576     $this-&gt;margin_header = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;mh&#39;</span>];
<a name="l05577"></a>05577     $this-&gt;margin_footer = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;mf&#39;</span>];
<a name="l05578"></a>05578     $this-&gt;w = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;pw&#39;</span>];
<a name="l05579"></a>05579     $this-&gt;h = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;ph&#39;</span>];
<a name="l05580"></a>05580     $rotate = $this-&gt;saveHTMLHeader[$n][$OE][<span class="stringliteral">&#39;rotate&#39;</span>];
<a name="l05581"></a>05581     $this-&gt;Reset();
<a name="l05582"></a>05582     $this-&gt;pageoutput[$n] = array();
<a name="l05583"></a>05583     $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l05584"></a>05584     $this-&gt;x = $this-&gt;lMargin;
<a name="l05585"></a>05585     $this-&gt;y = $this-&gt;margin_header;
<a name="l05586"></a>05586 
<a name="l05587"></a>05587     $html = str_replace(<span class="stringliteral">&#39;{PAGENO}&#39;</span>,$this-&gt;pagenumPrefix.$this-&gt;docPageNum($n).$this-&gt;pagenumSuffix,$html);
<a name="l05588"></a>05588     $html = str_replace($this-&gt;aliasNbPgGp,$this-&gt;nbpgPrefix.$this-&gt;docPageNumTotal($n).$this-&gt;nbpgSuffix,$html );  <span class="comment">// {nbpg}</span>
<a name="l05589"></a>05589     $html = str_replace($this-&gt;aliasNbPg,$nb,$html ); <span class="comment">// {nb}</span>
<a name="l05590"></a>05590     $html = preg_replace(<span class="stringliteral">&#39;/\{DATE\s+(.*?)\}/e&#39;</span>,<span class="stringliteral">&quot;date(&#39;\\1&#39;)&quot;</span>,$html );
<a name="l05591"></a>05591 
<a name="l05592"></a>05592     $this-&gt;HTMLheaderPageLinks = array();
<a name="l05593"></a>05593     $this-&gt;pageBackgrounds = array();
<a name="l05594"></a>05594 
<a name="l05595"></a>05595     $this-&gt;writingHTMLheader = <span class="keyword">true</span>;
<a name="l05596"></a>05596     $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);  <span class="comment">// parameter 4 saves output to $this-&gt;headerbuffer</span>
<a name="l05597"></a>05597     $this-&gt;writingHTMLheader = <span class="keyword">false</span>;
<a name="l05598"></a>05598     $this-&gt;Reset();
<a name="l05599"></a>05599     $this-&gt;pageoutput[$n] = array();
<a name="l05600"></a>05600 
<a name="l05601"></a>05601     $s = $this-&gt;PrintPageBackgrounds();
<a name="l05602"></a>05602     $this-&gt;headerbuffer = $s . $this-&gt;headerbuffer;
<a name="l05603"></a>05603 
<a name="l05604"></a>05604     $os = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05605"></a>05605     <span class="keywordflow">if</span> ($rotate) {
<a name="l05606"></a>05606       $os .= sprintf(<span class="stringliteral">&#39;q 0 -1 1 0 0 %.3f cm &#39;</span>,($this-&gt;w*$this-&gt;k));
<a name="l05607"></a>05607     }
<a name="l05608"></a>05608     $os .= $this-&gt;headerbuffer ;
<a name="l05609"></a>05609     <span class="keywordflow">if</span> ($rotate) {
<a name="l05610"></a>05610       $os .= <span class="stringliteral">&#39; Q&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l05611"></a>05611     }
<a name="l05612"></a>05612 
<a name="l05613"></a>05613     <span class="comment">// Writes over the page background but behind any other output on page</span>
<a name="l05614"></a>05614     $os = preg_replace(<span class="stringliteral">&#39;/\\\\/&#39;</span>,<span class="stringliteral">&#39;\\\\\\\\&#39;</span>,$os);  <span class="comment">// mPDF 4.3.012C</span>
<a name="l05615"></a>05615     $this-&gt;pages[$n] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$os.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;\\1&#39;</span>, $this-&gt;pages[$n]);
<a name="l05616"></a>05616 
<a name="l05617"></a>05617     <span class="comment">// mPDF 4.0</span>
<a name="l05618"></a>05618     $lks = $this-&gt;HTMLheaderPageLinks; 
<a name="l05619"></a>05619     <span class="keywordflow">foreach</span>($lks AS $lk) {
<a name="l05620"></a>05620       <span class="keywordflow">if</span> ($rotate) {
<a name="l05621"></a>05621         $lw = $lk[2];
<a name="l05622"></a>05622         $lh = $lk[3];
<a name="l05623"></a>05623         $lk[2] = $lh;
<a name="l05624"></a>05624         $lk[3] = $lw; <span class="comment">// swap width and height</span>
<a name="l05625"></a>05625         $ax = $lk[0]/$this-&gt;k;
<a name="l05626"></a>05626         $ay = $lk[1]/$this-&gt;k;
<a name="l05627"></a>05627         $bx = $ay-($lh/$this-&gt;k);
<a name="l05628"></a>05628         $by = $this-&gt;w-$ax;
<a name="l05629"></a>05629         $lk[0] = $bx*$this-&gt;k;
<a name="l05630"></a>05630         $lk[1] = ($this-&gt;h-$by)*$this-&gt;k - $lw;
<a name="l05631"></a>05631       }
<a name="l05632"></a>05632       $this-&gt;PageLinks[$n][]=$lk;
<a name="l05633"></a>05633     }
<a name="l05634"></a>05634 
<a name="l05635"></a>05635 
<a name="l05636"></a>05636     }
<a name="l05637"></a>05637     <span class="keywordflow">if</span> (isset($this-&gt;saveHTMLFooter[$n][$OE])) {
<a name="l05638"></a>05638     $html = $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;html&#39;</span>];
<a name="l05639"></a>05639     $this-&gt;lMargin = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;ml&#39;</span>];
<a name="l05640"></a>05640     $this-&gt;rMargin = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;mr&#39;</span>];
<a name="l05641"></a>05641     $this-&gt;tMargin = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;mh&#39;</span>];
<a name="l05642"></a>05642     $this-&gt;bMargin = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;mf&#39;</span>];
<a name="l05643"></a>05643     $this-&gt;margin_header = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;mh&#39;</span>];
<a name="l05644"></a>05644     $this-&gt;margin_footer = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;mf&#39;</span>];
<a name="l05645"></a>05645     $this-&gt;w = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;pw&#39;</span>];
<a name="l05646"></a>05646     $this-&gt;h = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;ph&#39;</span>];
<a name="l05647"></a>05647     $rotate = $this-&gt;saveHTMLFooter[$n][$OE][<span class="stringliteral">&#39;rotate&#39;</span>];
<a name="l05648"></a>05648     $this-&gt;Reset();
<a name="l05649"></a>05649     $this-&gt;pageoutput[$n] = array();
<a name="l05650"></a>05650     $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l05651"></a>05651     $this-&gt;x = $this-&gt;lMargin;
<a name="l05652"></a>05652     $top_y = $this-&gt;y = $this-&gt;h - $this-&gt;margin_footer;
<a name="l05653"></a>05653 
<a name="l05654"></a>05654     <span class="comment">// if bottom-margin==0, corrects to avoid division by zero</span>
<a name="l05655"></a>05655     <span class="keywordflow">if</span> ($this-&gt;y == $this-&gt;h) { $top_y = $this-&gt;y = ($this-&gt;h - 0.1); }
<a name="l05656"></a>05656 
<a name="l05657"></a>05657     $html = str_replace(<span class="stringliteral">&#39;{PAGENO}&#39;</span>,$this-&gt;pagenumPrefix.$this-&gt;docPageNum($n).$this-&gt;pagenumSuffix,$html);
<a name="l05658"></a>05658     $html = str_replace($this-&gt;aliasNbPgGp,$this-&gt;nbpgPrefix.$this-&gt;docPageNumTotal($n).$this-&gt;nbpgSuffix,$html );  <span class="comment">// {nbpg}</span>
<a name="l05659"></a>05659     $html = str_replace($this-&gt;aliasNbPg,$nb,$html ); <span class="comment">// {nb}</span>
<a name="l05660"></a>05660     $html = preg_replace(<span class="stringliteral">&#39;/\{DATE\s+(.*?)\}/e&#39;</span>,<span class="stringliteral">&quot;date(&#39;\\1&#39;)&quot;</span>,$html );
<a name="l05661"></a>05661 
<a name="l05662"></a>05662 
<a name="l05663"></a>05663     $this-&gt;HTMLheaderPageLinks = array();
<a name="l05664"></a>05664     $this-&gt;pageBackgrounds = array();
<a name="l05665"></a>05665 
<a name="l05666"></a>05666     $this-&gt;writingHTMLfooter = <span class="keyword">true</span>;
<a name="l05667"></a>05667     $this-&gt;InFooter = <span class="keyword">true</span>;
<a name="l05668"></a>05668     $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);  <span class="comment">// parameter 4 saves output to $this-&gt;headerbuffer</span>
<a name="l05669"></a>05669     $this-&gt;writingHTMLfooter = <span class="keyword">false</span>;
<a name="l05670"></a>05670     $this-&gt;InFooter = <span class="keyword">false</span>;
<a name="l05671"></a>05671     $this-&gt;Reset();
<a name="l05672"></a>05672     $this-&gt;pageoutput[$n] = array();
<a name="l05673"></a>05673 
<a name="l05674"></a>05674     $fheight = $this-&gt;y - $top_y;
<a name="l05675"></a>05675     $adj = -$fheight;
<a name="l05676"></a>05676 
<a name="l05677"></a>05677     $s = $this-&gt;PrintPageBackgrounds(-$adj);  <span class="comment">// mPDF 4.2.014</span>
<a name="l05678"></a>05678     $this-&gt;headerbuffer = $s . $this-&gt;headerbuffer;
<a name="l05679"></a>05679 
<a name="l05680"></a>05680     $os = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05681"></a>05681     $os .= $this-&gt;StartTransform(<span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l05682"></a>05682     <span class="keywordflow">if</span> ($rotate) {
<a name="l05683"></a>05683       $os .= sprintf(<span class="stringliteral">&#39;q 0 -1 1 0 0 %.3f cm &#39;</span>,($this-&gt;w*$this-&gt;k));
<a name="l05684"></a>05684     }
<a name="l05685"></a>05685     $os .= $this-&gt;transformTranslate(0, $adj, <span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l05686"></a>05686     $os .= $this-&gt;headerbuffer ;
<a name="l05687"></a>05687     <span class="keywordflow">if</span> ($rotate) {
<a name="l05688"></a>05688       $os .= <span class="stringliteral">&#39; Q&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l05689"></a>05689     }
<a name="l05690"></a>05690     $os .= $this-&gt;StopTransform(<span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l05691"></a>05691     <span class="comment">// Writes over the page background but behind any other output on page</span>
<a name="l05692"></a>05692     $os = preg_replace(<span class="stringliteral">&#39;/\\\\/&#39;</span>,<span class="stringliteral">&#39;\\\\\\\\&#39;</span>,$os);  <span class="comment">// mPDF 4.3.012C</span>
<a name="l05693"></a>05693     $this-&gt;pages[$n] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$os.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;\\1&#39;</span>, $this-&gt;pages[$n]);
<a name="l05694"></a>05694 
<a name="l05695"></a>05695     <span class="comment">// mPDF 4.0</span>
<a name="l05696"></a>05696     $lks = $this-&gt;HTMLheaderPageLinks; 
<a name="l05697"></a>05697     <span class="keywordflow">foreach</span>($lks AS $lk) {
<a name="l05698"></a>05698       $lk[1] -= $adj*$this-&gt;k;
<a name="l05699"></a>05699       <span class="keywordflow">if</span> ($rotate) {
<a name="l05700"></a>05700         $lw = $lk[2];
<a name="l05701"></a>05701         $lh = $lk[3];
<a name="l05702"></a>05702         $lk[2] = $lh;
<a name="l05703"></a>05703         $lk[3] = $lw; <span class="comment">// swap width and height</span>
<a name="l05704"></a>05704 
<a name="l05705"></a>05705         $ax = $lk[0]/$this-&gt;k;
<a name="l05706"></a>05706         $ay = $lk[1]/$this-&gt;k;
<a name="l05707"></a>05707         $bx = $ay-($lh/$this-&gt;k);
<a name="l05708"></a>05708         $by = $this-&gt;w-$ax;
<a name="l05709"></a>05709         $lk[0] = $bx*$this-&gt;k;
<a name="l05710"></a>05710         $lk[1] = ($this-&gt;h-$by)*$this-&gt;k - $lw;
<a name="l05711"></a>05711       }
<a name="l05712"></a>05712       $this-&gt;PageLinks[$n][]=$lk;
<a name="l05713"></a>05713     }
<a name="l05714"></a>05714     }
<a name="l05715"></a>05715   }
<a name="l05716"></a>05716   $this-&gt;page=$nb;
<a name="l05717"></a>05717   $this-&gt;state=1;
<a name="l05718"></a>05718 }
<a name="l05719"></a>05719 
<a name="l05720"></a>05720 
<a name="l05721"></a>05721 function _putpages()
<a name="l05722"></a>05722 {
<a name="l05723"></a>05723   $nb=$this-&gt;page;
<a name="l05724"></a>05724   $filter=($this-&gt;compress) ? <span class="stringliteral">&#39;/Filter /FlateDecode &#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l05725"></a>05725 
<a name="l05726"></a>05726   <span class="comment">// mPDF 4.2.024  Changed to &#39;def&#39; </span>
<a name="l05727"></a>05727   <span class="keywordflow">if</span>($this-&gt;DefOrientation==<span class="charliteral">&#39;P&#39;</span>) {
<a name="l05728"></a>05728     $defwPt=$this-&gt;fwPt;
<a name="l05729"></a>05729     $defhPt=$this-&gt;fhPt;
<a name="l05730"></a>05730   }
<a name="l05731"></a>05731   <span class="keywordflow">else</span> {
<a name="l05732"></a>05732     $defwPt=$this-&gt;fhPt;
<a name="l05733"></a>05733     $defhPt=$this-&gt;fwPt;
<a name="l05734"></a>05734   }
<a name="l05735"></a>05735   $annotid=(3+2*$nb);
<a name="l05736"></a>05736   <span class="keywordflow">for</span>($n=1;$n&lt;=$nb;$n++)
<a name="l05737"></a>05737   {
<a name="l05738"></a>05738     <span class="comment">// mPDF 4.2.024</span>
<a name="l05739"></a>05739     <span class="keywordflow">if</span>(isset($this-&gt;OrientationChanges[$n])) { 
<a name="l05740"></a>05740       $hPt=$this-&gt;pageDim[$n][<span class="charliteral">&#39;w&#39;</span>]*$this-&gt;k;
<a name="l05741"></a>05741       $wPt=$this-&gt;pageDim[$n][<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k;
<a name="l05742"></a>05742     }
<a name="l05743"></a>05743     <span class="keywordflow">else</span> { 
<a name="l05744"></a>05744       $wPt=$this-&gt;pageDim[$n][<span class="charliteral">&#39;w&#39;</span>]*$this-&gt;k;
<a name="l05745"></a>05745       $hPt=$this-&gt;pageDim[$n][<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k;
<a name="l05746"></a>05746     }
<a name="l05747"></a>05747     <span class="comment">// mPDF 4.0 Moved</span>
<a name="l05748"></a>05748     <span class="comment">//Replace number of pages</span>
<a name="l05749"></a>05749     <span class="keywordflow">if</span>(!empty($this-&gt;aliasNbPg)) {
<a name="l05750"></a>05750       <span class="comment">// mPDF 4.0</span>
<a name="l05751"></a>05751       <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;useSubsets) { $s1 = $this-&gt;UTF8ToUTF16BE($this-&gt;aliasNbPg, <span class="keyword">false</span>); }
<a name="l05752"></a>05752       <span class="keywordflow">else</span> { $s1 = $this-&gt;aliasNbPg; }
<a name="l05753"></a>05753       <span class="keywordflow">if</span> ($this-&gt;useSubsets) { 
<a name="l05754"></a>05754         $r = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05755"></a>05755         $nstr = <span class="stringliteral">&quot;$nb&quot;</span>;
<a name="l05756"></a>05756         <span class="keywordflow">for</span>($i=0;$i&lt;strlen($nstr);$i++) {
<a name="l05757"></a>05757           $r .= sprintf(<span class="stringliteral">&quot;%02s&quot;</span>, strtoupper(dechex(intval($nstr{$i})+33))); 
<a name="l05758"></a>05758         }
<a name="l05759"></a>05759       }
<a name="l05760"></a>05760       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;is_MB) { $r = $this-&gt;UTF8ToUTF16BE($nb, <span class="keyword">false</span>); } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l05761"></a>05761       <span class="keywordflow">else</span> { $r = $nb; }
<a name="l05762"></a>05762       <span class="keywordflow">if</span> (preg_match_all(<span class="stringliteral">&#39;/{mpdfheadernbpg (C|R) ff=(\S*) fs=(\S*) fz=(.*?)}/&#39;</span>,$this-&gt;pages[$n],$m)) {
<a name="l05763"></a>05763         <span class="keywordflow">for</span>($hi=0;$hi&lt;count($m[0]);$hi++) {
<a name="l05764"></a>05764           $pos = $m[1][$hi];
<a name="l05765"></a>05765           $hff = $m[2][$hi];
<a name="l05766"></a>05766           $hfst = $m[3][$hi];
<a name="l05767"></a>05767           $hfsz = $m[4][$hi];
<a name="l05768"></a>05768           $this-&gt;SetFont($hff,$hfst,$hfsz, <span class="keyword">false</span>);
<a name="l05769"></a>05769           $x1 = $this-&gt;GetStringWidth($this-&gt;aliasNbPg);
<a name="l05770"></a>05770           $x2 = $this-&gt;GetStringWidth($nb);
<a name="l05771"></a>05771           $xadj = $x1 - $x2;
<a name="l05772"></a>05772           <span class="keywordflow">if</span> ($pos==<span class="charliteral">&#39;C&#39;</span>) { $xadj /= 2; }
<a name="l05773"></a>05773           $rep = sprintf(<span class="stringliteral">&#39; q 1 0 0 1 %.3f 0 cm &#39;</span>, $xadj*$this-&gt;k); 
<a name="l05774"></a>05774           $this-&gt;pages[$n] = str_replace($m[0][$hi], $rep, $this-&gt;pages[$n]);
<a name="l05775"></a>05775         }
<a name="l05776"></a>05776       }
<a name="l05777"></a>05777       $this-&gt;pages[$n]=str_replace($s1,$r,$this-&gt;pages[$n]);
<a name="l05778"></a>05778     }
<a name="l05779"></a>05779     <span class="comment">//Replace number of pages in group</span>
<a name="l05780"></a>05780     <span class="keywordflow">if</span>(!empty($this-&gt;aliasNbPgGp)) {
<a name="l05781"></a>05781       <span class="comment">// mPDF 4.0</span>
<a name="l05782"></a>05782       <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;useSubsets) { $s2 = $this-&gt;UTF8ToUTF16BE($this-&gt;aliasNbPgGp, <span class="keyword">false</span>); }
<a name="l05783"></a>05783       <span class="keywordflow">else</span> { $s2 = $this-&gt;aliasNbPgGp; }
<a name="l05784"></a>05784       $nbt = $this-&gt;docPageNumTotal($n);
<a name="l05785"></a>05785       <span class="keywordflow">if</span> ($this-&gt;useSubsets) { 
<a name="l05786"></a>05786         $r = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05787"></a>05787         $nstr = <span class="stringliteral">&quot;$nbt&quot;</span>;
<a name="l05788"></a>05788         <span class="keywordflow">for</span>($i=0;$i&lt;strlen($nstr);$i++) {
<a name="l05789"></a>05789           $r .= sprintf(<span class="stringliteral">&quot;%02s&quot;</span>, strtoupper(dechex(intval($nstr{$i})+33))); 
<a name="l05790"></a>05790         }
<a name="l05791"></a>05791       }
<a name="l05792"></a>05792       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;is_MB) { $r = $this-&gt;UTF8ToUTF16BE($nbt, <span class="keyword">false</span>); }  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l05793"></a>05793       <span class="keywordflow">else</span> { $r = $nbt; }
<a name="l05794"></a>05794       <span class="keywordflow">if</span> (preg_match_all(<span class="stringliteral">&#39;/{mpdfheadernbpggp (C|R) ff=(\S*) fs=(\S*) fz=(.*?)}/&#39;</span>,$this-&gt;pages[$n],$m)) {
<a name="l05795"></a>05795         <span class="keywordflow">for</span>($hi=0;$hi&lt;count($m[0]);$hi++) {
<a name="l05796"></a>05796           $pos = $m[1][$hi];
<a name="l05797"></a>05797           $hff = $m[2][$hi];
<a name="l05798"></a>05798           $hfst = $m[3][$hi];
<a name="l05799"></a>05799           $hfsz = $m[4][$hi];
<a name="l05800"></a>05800           $this-&gt;SetFont($hff,$hfst,$hfsz, <span class="keyword">false</span>);
<a name="l05801"></a>05801           $x1 = $this-&gt;GetStringWidth($this-&gt;aliasNbPgGp);
<a name="l05802"></a>05802           <span class="comment">// mPDF 3.0</span>
<a name="l05803"></a>05803           $x2 = $this-&gt;GetStringWidth($nbt);
<a name="l05804"></a>05804           $xadj = $x1 - $x2;
<a name="l05805"></a>05805           <span class="keywordflow">if</span> ($pos==<span class="charliteral">&#39;C&#39;</span>) { $xadj /= 2; }
<a name="l05806"></a>05806           $rep = sprintf(<span class="stringliteral">&#39; q 1 0 0 1 %.3f 0 cm &#39;</span>, $xadj*$this-&gt;k); 
<a name="l05807"></a>05807           $this-&gt;pages[$n] = str_replace($m[0][$hi], $rep, $this-&gt;pages[$n]);
<a name="l05808"></a>05808         }
<a name="l05809"></a>05809       }
<a name="l05810"></a>05810       $this-&gt;pages[$n]=str_replace($s2,$r,$this-&gt;pages[$n]);
<a name="l05811"></a>05811     }
<a name="l05812"></a>05812 
<a name="l05813"></a>05813     <span class="comment">// mPDF 3.0 Remove Pattern marker</span>
<a name="l05814"></a>05814     $this-&gt;pages[$n] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$n]);
<a name="l05815"></a>05815 
<a name="l05816"></a>05816     <span class="comment">//Page</span>
<a name="l05817"></a>05817     $this-&gt;_newobj();
<a name="l05818"></a>05818     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Page&#39;</span>);
<a name="l05819"></a>05819     $this-&gt;_out(<span class="stringliteral">&#39;/Parent 1 0 R&#39;</span>);
<a name="l05820"></a>05820     <span class="keywordflow">if</span>(isset($this-&gt;OrientationChanges[$n])) {
<a name="l05821"></a>05821       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/MediaBox [0 0 %.3f %.3f]&#39;</span>,$hPt,$wPt));
<a name="l05822"></a>05822       <span class="keywordflow">if</span> (isset($this-&gt;OrientationChanges[$n]) &amp;&amp; $this-&gt;displayDefaultOrientation) {
<a name="l05823"></a>05823         <span class="keywordflow">if</span> ($this-&gt;DefOrientation==<span class="charliteral">&#39;P&#39;</span>) { $this-&gt;_out(<span class="stringliteral">&#39;/Rotate 270&#39;</span>); }
<a name="l05824"></a>05824         <span class="keywordflow">else</span> { $this-&gt;_out(<span class="stringliteral">&#39;/Rotate 90&#39;</span>); }
<a name="l05825"></a>05825       }
<a name="l05826"></a>05826     }
<a name="l05827"></a>05827     <span class="comment">// mPDF 4.2.024</span>
<a name="l05828"></a>05828     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($wPt != $defwPt || $hPt != $defhPt) {
<a name="l05829"></a>05829       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/MediaBox [0 0 %.3f %.3f]&#39;</span>,$wPt,$hPt));
<a name="l05830"></a>05830     }
<a name="l05831"></a>05831     $this-&gt;_out(<span class="stringliteral">&#39;/Resources 2 0 R&#39;</span>);
<a name="l05832"></a>05832 
<a name="l05833"></a>05833     $annotsnum = 0;
<a name="l05834"></a>05834     <span class="keywordflow">if</span> (isset($this-&gt;PageLinks[$n])) { $annotsnum += count($this-&gt;PageLinks[$n]); }
<a name="l05835"></a>05835     <span class="keywordflow">if</span> ($annotsnum ) {
<a name="l05836"></a>05836       $s = <span class="stringliteral">&#39;/Annots [ &#39;</span>;
<a name="l05837"></a>05837       <span class="keywordflow">for</span>($i=0;$i&lt;$annotsnum;$i++) { 
<a name="l05838"></a>05838         $s .= ($annotid + $i) . <span class="stringliteral">&#39; 0 R &#39;</span>;
<a name="l05839"></a>05839       } 
<a name="l05840"></a>05840       $annotid += $annotsnum;
<a name="l05841"></a>05841       $s .= <span class="stringliteral">&#39;] &#39;</span>;
<a name="l05842"></a>05842       $this-&gt;_out($s);
<a name="l05843"></a>05843     }
<a name="l05844"></a>05844 
<a name="l05845"></a>05845     $this-&gt;_out(<span class="stringliteral">&#39;/Contents &#39;</span>.($this-&gt;n+1).<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l05846"></a>05846     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05847"></a>05847 
<a name="l05848"></a>05848     <span class="comment">//Page content</span>
<a name="l05849"></a>05849     $this-&gt;_newobj();
<a name="l05850"></a>05850     $p=($this-&gt;compress) ? gzcompress($this-&gt;pages[$n]) : $this-&gt;pages[$n];
<a name="l05851"></a>05851     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>.$filter.<span class="stringliteral">&#39;/Length &#39;</span>.strlen($p).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l05852"></a>05852     $this-&gt;_putstream($p);
<a name="l05853"></a>05853     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05854"></a>05854   }
<a name="l05855"></a>05855   $this-&gt;_putannots($n);
<a name="l05856"></a>05856 
<a name="l05857"></a>05857 
<a name="l05858"></a>05858   <span class="comment">//Pages root</span>
<a name="l05859"></a>05859   $this-&gt;offsets[1]=strlen($this-&gt;buffer);
<a name="l05860"></a>05860   $this-&gt;_out(<span class="stringliteral">&#39;1 0 obj&#39;</span>);
<a name="l05861"></a>05861   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Pages&#39;</span>);
<a name="l05862"></a>05862   $kids=<span class="stringliteral">&#39;/Kids [&#39;</span>;
<a name="l05863"></a>05863   <span class="keywordflow">for</span>($i=0;$i&lt;$nb;$i++)
<a name="l05864"></a>05864     $kids.=(3+2*$i).<span class="stringliteral">&#39; 0 R &#39;</span>;
<a name="l05865"></a>05865   $this-&gt;_out($kids.<span class="charliteral">&#39;]&#39;</span>);
<a name="l05866"></a>05866   $this-&gt;_out(<span class="stringliteral">&#39;/Count &#39;</span>.$nb);
<a name="l05867"></a>05867   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/MediaBox [0 0 %.3f %.3f]&#39;</span>,$defwPt,$defhPt));  <span class="comment">// mPDF 4.2.024</span>
<a name="l05868"></a>05868   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l05869"></a>05869   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05870"></a>05870 }
<a name="l05871"></a>05871 
<a name="l05872"></a>05872 
<a name="l05873"></a>05873 function _putannots($n) {
<a name="l05874"></a>05874   $nb=$this-&gt;page;
<a name="l05875"></a>05875   <span class="keywordflow">for</span>($n=1;$n&lt;=$nb;$n++)
<a name="l05876"></a>05876   {
<a name="l05877"></a>05877     $annotobjs = array();
<a name="l05878"></a>05878     <span class="keywordflow">if</span>(isset($this-&gt;PageLinks[$n]) || isset($this-&gt;PageAnnots[$n])) {
<a name="l05879"></a>05879       $wPt=$this-&gt;pageDim[$n][<span class="charliteral">&#39;w&#39;</span>]*$this-&gt;k;
<a name="l05880"></a>05880       $hPt=$this-&gt;pageDim[$n][<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k;
<a name="l05881"></a>05881 
<a name="l05882"></a>05882       <span class="comment">//Links</span>
<a name="l05883"></a>05883       <span class="keywordflow">if</span>(isset($this-&gt;PageLinks[$n])) {
<a name="l05884"></a>05884          <span class="keywordflow">foreach</span>($this-&gt;PageLinks[$n] as $key =&gt; $pl) {
<a name="l05885"></a>05885         $this-&gt;_newobj();
<a name="l05886"></a>05886         $annot=<span class="stringliteral">&#39;&#39;</span>;
<a name="l05887"></a>05887         $rect=sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f&#39;</span>,$pl[0],$pl[1],$pl[0]+$pl[2],$pl[1]-$pl[3]);
<a name="l05888"></a>05888         $annot .= <span class="stringliteral">&#39;&lt;&lt;/Type /Annot /Subtype /Link /Rect [&#39;</span>.$rect.<span class="charliteral">&#39;]&#39;</span>;
<a name="l05889"></a>05889         $annot .= <span class="stringliteral">&#39; /Contents &#39;</span>.$this-&gt;_UTF16BEtextstring($pl[4]);
<a name="l05890"></a>05890         $annot .= <span class="stringliteral">&#39; /NM (&#39;</span>.sprintf(<span class="stringliteral">&#39;%04u-%04u&#39;</span>, $n, $key).<span class="charliteral">&#39;)&#39;</span>;
<a name="l05891"></a>05891         $annot .= <span class="stringliteral">&#39; /M &#39;</span>.$this-&gt;_textstring(<span class="stringliteral">&#39;D:&#39;</span>.date(<span class="stringliteral">&#39;YmdHis&#39;</span>));
<a name="l05892"></a>05892         $annot .= <span class="stringliteral">&#39; /Border [0 0 0]&#39;</span>;
<a name="l05893"></a>05893         <span class="comment">// mPDF 4.2.018</span>
<a name="l05894"></a>05894         <span class="keywordflow">if</span> ($this-&gt;PDFA) { $annot .= <span class="stringliteral">&#39; /F 28&#39;</span>; }
<a name="l05895"></a>05895         <span class="keywordflow">if</span> (strpos($pl[4],<span class="charliteral">&#39;@&#39;</span>)===0) {
<a name="l05896"></a>05896           $p=substr($pl[4],1);
<a name="l05897"></a>05897           <span class="comment">//  $h=isset($this-&gt;OrientationChanges[$p]) ? $wPt : $hPt;</span>
<a name="l05898"></a>05898           $htarg=$this-&gt;pageDim[$p][<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k;
<a name="l05899"></a>05899           $annot.=sprintf(<span class="stringliteral">&#39; /Dest [%d 0 R /XYZ 0 %.3f null]&gt;&gt;&#39;</span>,1+2*$p,$htarg);
<a name="l05900"></a>05900         }
<a name="l05901"></a>05901         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(is_string($pl[4])) {
<a name="l05902"></a>05902           $annot .= <span class="stringliteral">&#39; /A &lt;&lt;/S /URI /URI &#39;</span>.$this-&gt;_textstring($pl[4]).<span class="stringliteral">&#39;&gt;&gt; &gt;&gt;&#39;</span>;
<a name="l05903"></a>05903         }
<a name="l05904"></a>05904         <span class="keywordflow">else</span> {
<a name="l05905"></a>05905           $l=$this-&gt;links[$pl[4]];
<a name="l05906"></a>05906           <span class="comment">// mPDF 3.0</span>
<a name="l05907"></a>05907           <span class="comment">// may not be set if #link points to non-existent target</span>
<a name="l05908"></a>05908           <span class="keywordflow">if</span> (isset($this-&gt;pageDim[$l[0]][<span class="charliteral">&#39;h&#39;</span>])) { $htarg=$this-&gt;pageDim[$l[0]][<span class="charliteral">&#39;h&#39;</span>]*$this-&gt;k; }
<a name="l05909"></a>05909           <span class="keywordflow">else</span> { $htarg=$this-&gt;h*$this-&gt;k; } <span class="comment">// doesn&#39;t really matter</span>
<a name="l05910"></a>05910           $annot.=sprintf(<span class="stringliteral">&#39; /Dest [%d 0 R /XYZ 0 %.3f null]&gt;&gt;&#39;</span>,1+2*$l[0],$htarg-$l[1]*$this-&gt;k);
<a name="l05911"></a>05911         }
<a name="l05912"></a>05912         $this-&gt;_out($annot);
<a name="l05913"></a>05913         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05914"></a>05914          }
<a name="l05915"></a>05915       }
<a name="l05916"></a>05916 
<a name="l05917"></a>05917 
<a name="l05918"></a>05918     }
<a name="l05919"></a>05919   }
<a name="l05920"></a>05920 }
<a name="l05921"></a>05921 
<a name="l05922"></a>05922 
<a name="l05923"></a>05923 
<a name="l05924"></a>05924 
<a name="l05925"></a>05925 
<a name="l05926"></a>05926 
<a name="l05927"></a><a class="code" href="classmPDF.html#abc862900d0692ae1d96c31d68799d44a">05927</a> function <a class="code" href="classmPDF.html#abc862900d0692ae1d96c31d68799d44a">_putfonts</a>() {
<a name="l05928"></a>05928   <span class="keywordflow">if</span> ($this-&gt;is_MB) {
<a name="l05929"></a>05929       $nf=$this-&gt;n;
<a name="l05930"></a>05930       <span class="comment">/* mPDF 4.2 Not required in MB document/fonts</span>
<a name="l05931"></a>05931 <span class="comment">      foreach($this-&gt;diffs as $diff) {</span>
<a name="l05932"></a>05932 <span class="comment">        //Encodings</span>
<a name="l05933"></a>05933 <span class="comment">        $this-&gt;_newobj();</span>
<a name="l05934"></a>05934 <span class="comment">        $this-&gt;_out(&#39;&lt;&lt;/Type /Encoding /BaseEncoding /WinAnsiEncoding /Differences [&#39;.$diff.&#39;]&gt;&gt;&#39;);</span>
<a name="l05935"></a>05935 <span class="comment">        $this-&gt;_out(&#39;endobj&#39;);</span>
<a name="l05936"></a>05936 <span class="comment">      }</span>
<a name="l05937"></a>05937 <span class="comment">      */</span>
<a name="l05938"></a>05938       <span class="comment">// mPDF 4.1</span>
<a name="l05939"></a>05939       $mqr=ini_get(<span class="stringliteral">&quot;magic_quotes_runtime&quot;</span>);
<a name="l05940"></a>05940       <span class="keywordflow">if</span> ($mqr) { set_magic_quotes_runtime(0); }
<a name="l05941"></a>05941       <span class="keywordflow">foreach</span>($this-&gt;FontFiles as $file=&gt;$info) {
<a name="l05942"></a>05942          <span class="comment">// mPDF 4.0</span>
<a name="l05943"></a>05943          <span class="keywordflow">if</span> (!isset($info[<span class="stringliteral">&#39;type&#39;</span>]) || $info[<span class="stringliteral">&#39;type&#39;</span>]!=<span class="stringliteral">&#39;Type1subset&#39;</span>) {
<a name="l05944"></a>05944           <span class="comment">// mPDF 4.0</span>
<a name="l05945"></a>05945           $used = <span class="keyword">true</span>;
<a name="l05946"></a>05946           <span class="keywordflow">foreach</span>($this-&gt;fonts AS $f) {
<a name="l05947"></a>05947           <span class="keywordflow">if</span> ($f[<span class="stringliteral">&#39;file&#39;</span>] == $file &amp;&amp; $f[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) { $used = $f[<span class="stringliteral">&#39;used&#39;</span>]; }
<a name="l05948"></a>05948           }
<a name="l05949"></a>05949           <span class="keywordflow">if</span> ($used) {
<a name="l05950"></a>05950         <span class="comment">//Font file embedding</span>
<a name="l05951"></a>05951         $this-&gt;_newobj();
<a name="l05952"></a>05952         $this-&gt;FontFiles[$file][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n;
<a name="l05953"></a>05953         $font=<span class="stringliteral">&#39;&#39;</span>;
<a name="l05954"></a>05954         $f=fopen(MPDF_FONTPATH.$file,<span class="stringliteral">&#39;rb&#39;</span>,1);
<a name="l05955"></a>05955         <span class="keywordflow">if</span>(!$f) {
<a name="l05956"></a>05956           $this-&gt;Error(<span class="stringliteral">&#39;Font file not found&#39;</span>);
<a name="l05957"></a>05957         }
<a name="l05958"></a>05958         <span class="keywordflow">while</span>(!feof($f)) {
<a name="l05959"></a>05959           $font .= fread($f, 2048);
<a name="l05960"></a>05960         }
<a name="l05961"></a>05961         fclose($f);
<a name="l05962"></a>05962         $compressed=(substr($file,-2)==<span class="stringliteral">&#39;.z&#39;</span>);
<a name="l05963"></a>05963         <span class="keywordflow">if</span>(!$compressed &amp;&amp; isset($info[<span class="stringliteral">&#39;length2&#39;</span>])) {
<a name="l05964"></a>05964           $header=($this-&gt;ords[substr($font,0,1)]==128);
<a name="l05965"></a>05965           <span class="keywordflow">if</span>($header) {
<a name="l05966"></a>05966             <span class="comment">//Strip first binary header</span>
<a name="l05967"></a>05967             $font=substr($font,6);
<a name="l05968"></a>05968           }
<a name="l05969"></a>05969           <span class="keywordflow">if</span>($header &amp;&amp; $this-&gt;ords[substr($font,$info[<span class="stringliteral">&#39;length1&#39;</span>],1)]==128) {
<a name="l05970"></a>05970             <span class="comment">//Strip second binary header</span>
<a name="l05971"></a>05971             $font=substr($font,0,$info[<span class="stringliteral">&#39;length1&#39;</span>]).substr($font,$info[<span class="stringliteral">&#39;length1&#39;</span>]+6);
<a name="l05972"></a>05972           }
<a name="l05973"></a>05973         }
<a name="l05974"></a>05974         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.strlen($font));
<a name="l05975"></a>05975         <span class="keywordflow">if</span>($compressed) {
<a name="l05976"></a>05976           $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l05977"></a>05977         }
<a name="l05978"></a>05978         $this-&gt;_out(<span class="stringliteral">&#39;/Length1 &#39;</span>.$info[<span class="stringliteral">&#39;length1&#39;</span>]);
<a name="l05979"></a>05979         <span class="keywordflow">if</span>(isset($info[<span class="stringliteral">&#39;length2&#39;</span>])) {
<a name="l05980"></a>05980           $this-&gt;_out(<span class="stringliteral">&#39;/Length2 &#39;</span>.$info[<span class="stringliteral">&#39;length2&#39;</span>].<span class="stringliteral">&#39; /Length3 0&#39;</span>);
<a name="l05981"></a>05981         }
<a name="l05982"></a>05982         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l05983"></a>05983         $this-&gt;_putstream($font);
<a name="l05984"></a>05984         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05985"></a>05985           }
<a name="l05986"></a>05986          }
<a name="l05987"></a>05987       }
<a name="l05988"></a>05988       <span class="comment">// mPDF 4.1</span>
<a name="l05989"></a>05989       <span class="keywordflow">if</span> ($mqr) { set_magic_quotes_runtime($mqr); }
<a name="l05990"></a>05990       <span class="keywordflow">foreach</span>($this-&gt;fonts as $k=&gt;$font) {
<a name="l05991"></a>05991         <span class="comment">//Font objects</span>
<a name="l05992"></a>05992         $type=$font[<span class="stringliteral">&#39;type&#39;</span>];
<a name="l05993"></a>05993         $name=$font[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l05994"></a>05994         <span class="keywordflow">if</span>($type==<span class="stringliteral">&#39;Type0&#39;</span>) { 
<a name="l05995"></a>05995           $this-&gt;fonts[$k][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n+1;
<a name="l05996"></a>05996           $this-&gt;_newobj();
<a name="l05997"></a>05997           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l05998"></a>05998           $this-&gt;_putType0($font);
<a name="l05999"></a>05999         }
<a name="l06000"></a>06000         <span class="keywordflow">else</span> <span class="keywordflow">if</span>($type==<span class="stringliteral">&#39;core&#39;</span>) {
<a name="l06001"></a>06001           <span class="comment">//Standard font</span>
<a name="l06002"></a>06002           <span class="comment">// mPDF 4.2.018</span>
<a name="l06003"></a>06003           <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&#39;Core fonts are not allowed in PDF/A1-b files (Times, Helvetica, Courier etc.)&#39;</span>); }
<a name="l06004"></a>06004           $this-&gt;fonts[$k][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n+1;
<a name="l06005"></a>06005           $this-&gt;_newobj();
<a name="l06006"></a>06006           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06007"></a>06007           $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$name);
<a name="l06008"></a>06008           $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type1&#39;</span>);
<a name="l06009"></a>06009           <span class="keywordflow">if</span>($name!=<span class="stringliteral">&#39;Symbol&#39;</span> &amp;&amp; $name!=<span class="stringliteral">&#39;ZapfDingbats&#39;</span>) {
<a name="l06010"></a>06010             $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /WinAnsiEncoding&#39;</span>);
<a name="l06011"></a>06011           }
<a name="l06012"></a>06012           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06013"></a>06013           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06014"></a>06014         } 
<a name="l06015"></a>06015         <span class="comment">// Only uses Type 1 when utf-8 encoded for embedded SUBSETS</span>
<a name="l06016"></a>06016         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type==<span class="stringliteral">&#39;Type1subset&#39;</span>) {
<a name="l06017"></a>06017            $ssfaid=<span class="stringliteral">&quot;A&quot;</span>;
<a name="l06018"></a>06018            <span class="keywordflow">if</span> (!class_exists(<span class="stringliteral">&#39;t1asm&#39;</span>)) { include(_MPDF_PATH .<span class="stringliteral">&#39;classes/t1asm.php&#39;</span>); }
<a name="l06019"></a>06019            <span class="comment">// Create Type1 file using t1asm</span>
<a name="l06020"></a>06020            $asm = <span class="keyword">new</span> <a class="code" href="classt1asm.html">t1asm</a>();
<a name="l06021"></a>06021            $asm-&gt;LoadFontFile(MPDF_FONTPATH.substr($font[<span class="stringliteral">&#39;file&#39;</span>],0,(strpos($font[<span class="stringliteral">&#39;file&#39;</span>],<span class="charliteral">&#39;.&#39;</span>))));
<a name="l06022"></a>06022            <span class="keywordflow">for</span>($sfid=0;$sfid&lt;count($font[<span class="stringliteral">&#39;subsetfontids&#39;</span>]);$sfid++) {
<a name="l06023"></a>06023           $this-&gt;fonts[$k][<span class="charliteral">&#39;n&#39;</span>][$sfid]=$this-&gt;n+1;    <span class="comment">// NB an array for subset</span>
<a name="l06024"></a>06024           $subsetname = <span class="stringliteral">&#39;MPDFA&#39;</span>.$ssfaid.<span class="charliteral">&#39;+&#39;</span>.$name;
<a name="l06025"></a>06025           $ssfaid++;
<a name="l06026"></a>06026           $asm-&gt;DefineChars($font[<span class="stringliteral">&#39;subsets&#39;</span>][$sfid], $this-&gt;PDFA);  <span class="comment">// mPDF 4.2.018</span>
<a name="l06027"></a>06027           $fontstream = $asm-&gt;OutputPFB(<span class="stringliteral">&#39;&#39;</span>);
<a name="l06028"></a>06028 
<a name="l06030"></a>06030           $widthstring = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06031"></a>06031           $toUnistring = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06032"></a>06032           <span class="keywordflow">foreach</span>($font[<span class="stringliteral">&#39;subsets&#39;</span>][$sfid] AS $cp=&gt;$u) {
<a name="l06033"></a>06033             <span class="keywordflow">if</span> (isset($font[<span class="stringliteral">&#39;cw&#39;</span>][$u])) {
<a name="l06034"></a>06034               $widthstring .= $font[<span class="stringliteral">&#39;cw&#39;</span>][$u].<span class="charliteral">&#39; &#39;</span>;
<a name="l06035"></a>06035             }
<a name="l06036"></a>06036             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($cp &lt;32) { 
<a name="l06037"></a>06037               $widthstring .= <span class="charliteral">&#39;0&#39;</span>.<span class="charliteral">&#39; &#39;</span>;
<a name="l06038"></a>06038             }
<a name="l06039"></a>06039             <span class="keywordflow">else</span> {
<a name="l06040"></a>06040               $widthstring .= $font[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;MissingWidth&#39;</span>].<span class="charliteral">&#39; &#39;</span>;
<a name="l06041"></a>06041             }
<a name="l06042"></a>06042             $toUnistring .= sprintf(<span class="stringliteral">&quot;&lt;%02s&gt; &lt;%04s&gt;\n&quot;</span>, strtoupper(dechex($cp)), strtoupper(dechex($u)));
<a name="l06043"></a>06043           }
<a name="l06044"></a>06044           <span class="comment">//Additional Type1 or TrueType font</span>
<a name="l06045"></a>06045           $this-&gt;_newobj();
<a name="l06046"></a>06046           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06047"></a>06047           $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$subsetname);
<a name="l06048"></a>06048           $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type1&#39;</span>);
<a name="l06049"></a>06049           $this-&gt;_out(<span class="stringliteral">&#39;/FirstChar 0 /LastChar &#39;</span>.(count($font[<span class="stringliteral">&#39;subsets&#39;</span>][$sfid])-1));
<a name="l06050"></a>06050           $this-&gt;_out(<span class="stringliteral">&#39;/Widths &#39;</span>.($this-&gt;n+1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06051"></a>06051           $this-&gt;_out(<span class="stringliteral">&#39;/FontDescriptor &#39;</span>.($this-&gt;n+2).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06052"></a>06052 
<a name="l06053"></a>06053           <span class="comment">// mPDF 4.0</span>
<a name="l06054"></a>06054           $this-&gt;_out(<span class="stringliteral">&#39;/Encoding &#39;</span>.($this-&gt;n + 3).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06055"></a>06055           $this-&gt;_out(<span class="stringliteral">&#39;/ToUnicode &#39;</span>.($this-&gt;n + 4).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06056"></a>06056           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06057"></a>06057           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06058"></a>06058 
<a name="l06059"></a>06059           <span class="comment">//Widths</span>
<a name="l06060"></a>06060           $this-&gt;_newobj();
<a name="l06061"></a>06061           $this-&gt;_out(<span class="charliteral">&#39;[&#39;</span>.$widthstring.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06062"></a>06062           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06063"></a>06063           <span class="comment">//Descriptor</span>
<a name="l06064"></a>06064           $this-&gt;_newobj();
<a name="l06065"></a>06065           $s=<span class="stringliteral">&#39;&lt;&lt;/Type /FontDescriptor /FontName /&#39;</span>.$subsetname;
<a name="l06066"></a>06066           <span class="keywordflow">foreach</span>($font[<span class="stringliteral">&#39;desc&#39;</span>] as $kd=&gt;$v) {
<a name="l06067"></a>06067             $s.=<span class="stringliteral">&#39; /&#39;</span>.$kd.<span class="charliteral">&#39; &#39;</span>.$v;
<a name="l06068"></a>06068           }
<a name="l06069"></a>06069 
<a name="l06070"></a>06070           <span class="comment">// mPDF 4.2.018 CharSet for PDF/A</span>
<a name="l06071"></a>06071           <span class="keywordflow">if</span> ($this-&gt;PDFA) {
<a name="l06072"></a>06072             $s.=<span class="stringliteral">&#39; /CharSet (&#39;</span>.$asm-&gt;pdfa_charset.<span class="charliteral">&#39;)&#39;</span>;
<a name="l06073"></a>06073           }
<a name="l06074"></a>06074 
<a name="l06075"></a>06075           $s.=<span class="stringliteral">&#39; /FontFile &#39;</span>.($this-&gt;n + 3).<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06076"></a>06076           $this-&gt;_out($s.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06077"></a>06077           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06078"></a>06078           <span class="comment">//Encodings</span>
<a name="l06079"></a>06079           $this-&gt;_newobj();
<a name="l06080"></a>06080           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Encoding /BaseEncoding /WinAnsiEncoding /Differences [ &#39;</span>.$asm-&gt;pdf_diffstr .<span class="stringliteral">&#39; ]&gt;&gt;&#39;</span>);
<a name="l06081"></a>06081           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06082"></a>06082           <span class="comment">// mPDF 4.0</span>
<a name="l06083"></a>06083           <span class="comment">// ToUnicode</span>
<a name="l06084"></a>06084           <span class="comment">// Uses the .map files to determine mapping of 7F-FF to Unicode characters</span>
<a name="l06085"></a>06085           <span class="comment">// Allows copying and pasting of PDF text to another editor</span>
<a name="l06086"></a>06086           $toUni = <span class="stringliteral">&quot;stream\n&quot;</span>;
<a name="l06087"></a>06087           $toUni .= <span class="stringliteral">&quot;/CIDInit /ProcSet findresource begin\n&quot;</span>;
<a name="l06088"></a>06088           $toUni .= <span class="stringliteral">&quot;12 dict begin\n&quot;</span>;
<a name="l06089"></a>06089           $toUni .= <span class="stringliteral">&quot;begincmap\n&quot;</span>;
<a name="l06090"></a>06090           $toUni .= <span class="stringliteral">&quot;/CIDSystemInfo\n&quot;</span>;
<a name="l06091"></a>06091           $toUni .= <span class="stringliteral">&quot;&lt;&lt;/Registry (Adobe)\n&quot;</span>;
<a name="l06092"></a>06092           $toUni .= <span class="stringliteral">&quot;/Ordering (UCS)\n&quot;</span>;
<a name="l06093"></a>06093           $toUni .= <span class="stringliteral">&quot;/Supplement 0\n&quot;</span>;
<a name="l06094"></a>06094           $toUni .= <span class="stringliteral">&quot;&gt;&gt; def\n&quot;</span>;
<a name="l06095"></a>06095           $toUni .= <span class="stringliteral">&quot;/CMapName /Adobe-Identity-UCS def\n&quot;</span>;
<a name="l06096"></a>06096           $toUni .= <span class="stringliteral">&quot;/CMapType 2 def\n&quot;</span>;
<a name="l06097"></a>06097           $toUni .= <span class="stringliteral">&quot;1 begincodespacerange\n&quot;</span>;
<a name="l06098"></a>06098           $toUni .= <span class="stringliteral">&quot;&lt;00&gt; &lt;FF&gt;\n&quot;</span>;
<a name="l06099"></a>06099           $toUni .= <span class="stringliteral">&quot;endcodespacerange\n&quot;</span>;
<a name="l06100"></a>06100           $toUni .= count($font[<span class="stringliteral">&#39;subsets&#39;</span>][$sfid]).<span class="stringliteral">&quot; beginbfchar\n&quot;</span>;
<a name="l06101"></a>06101           $toUni .= $toUnistring;
<a name="l06102"></a>06102           $toUni .= <span class="stringliteral">&quot;endbfchar\n&quot;</span>;
<a name="l06103"></a>06103           $toUni .= <span class="stringliteral">&quot;endcmap\n&quot;</span>;
<a name="l06104"></a>06104           $toUni .= <span class="stringliteral">&quot;CMapName currentdict /CMap defineresource pop\n&quot;</span>;
<a name="l06105"></a>06105           $toUni .= <span class="stringliteral">&quot;end\n&quot;</span>;
<a name="l06106"></a>06106           $toUni .= <span class="stringliteral">&quot;end\n&quot;</span>;
<a name="l06107"></a>06107           $toUni .= <span class="stringliteral">&quot;endstream\n&quot;</span>;
<a name="l06108"></a>06108           $toUni .= <span class="stringliteral">&quot;endobj&quot;</span>;
<a name="l06109"></a>06109           $this-&gt;_newobj();
<a name="l06110"></a>06110           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.(strlen($toUni)-24).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06111"></a>06111           $this-&gt;_out($toUni);
<a name="l06112"></a>06112 
<a name="l06113"></a>06113           <span class="comment">//Font file </span>
<a name="l06114"></a>06114           $this-&gt;_newobj();
<a name="l06115"></a>06115           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.strlen($fontstream));
<a name="l06116"></a>06116           $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l06117"></a>06117           $this-&gt;_out(<span class="stringliteral">&#39;/Length1 &#39;</span>.$asm-&gt;of_size1);
<a name="l06118"></a>06118           <span class="keywordflow">if</span>(isset($asm-&gt;of_size2)) {
<a name="l06119"></a>06119             $this-&gt;_out(<span class="stringliteral">&#39;/Length2 &#39;</span>.$asm-&gt;of_size2.<span class="stringliteral">&#39; /Length3 0&#39;</span>);
<a name="l06120"></a>06120           }
<a name="l06121"></a>06121           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06122"></a>06122           $this-&gt;_putstream($fontstream);
<a name="l06123"></a>06123           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06124"></a>06124            }  <span class="comment">// foreach subset</span>
<a name="l06125"></a>06125            unset($asm );
<a name="l06126"></a>06126         } 
<a name="l06127"></a>06127         <span class="keywordflow">else</span> {
<a name="l06128"></a>06128           <span class="comment">// mPDF 4.0</span>
<a name="l06129"></a>06129           <span class="keywordflow">if</span> (!$font[<span class="stringliteral">&#39;used&#39;</span>] &amp;&amp; $type==<span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) { <span class="keywordflow">continue</span>; }
<a name="l06130"></a>06130           <span class="comment">//Allow for additional types</span>
<a name="l06131"></a>06131           $mtd=<span class="stringliteral">&#39;_put&#39;</span>.strtolower($type);
<a name="l06132"></a>06132           <span class="keywordflow">if</span>(!method_exists($this, $mtd)) {
<a name="l06133"></a>06133             $this-&gt;Error(<span class="stringliteral">&#39;Unsupported font type: &#39;</span>.$type.<span class="stringliteral">&#39; (&#39;</span>.$name.<span class="charliteral">&#39;)&#39;</span>);
<a name="l06134"></a>06134           }
<a name="l06135"></a>06135           $this-&gt;fonts[$k][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n+1;
<a name="l06136"></a>06136           $this-&gt;$mtd($font);
<a name="l06137"></a>06137         }
<a name="l06138"></a>06138       }
<a name="l06139"></a>06139   }
<a name="l06140"></a>06140   <span class="keywordflow">else</span> {
<a name="l06141"></a>06141 
<a name="l06142"></a>06142     $nf=$this-&gt;n;
<a name="l06143"></a>06143     <span class="keywordflow">foreach</span>($this-&gt;diffs as $diff)
<a name="l06144"></a>06144     {
<a name="l06145"></a>06145       <span class="comment">//Encodings</span>
<a name="l06146"></a>06146       $this-&gt;_newobj();
<a name="l06147"></a>06147       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Encoding /BaseEncoding /WinAnsiEncoding /Differences [&#39;</span>.$diff.<span class="stringliteral">&#39;]&gt;&gt;&#39;</span>);
<a name="l06148"></a>06148       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06149"></a>06149     }
<a name="l06150"></a>06150     <span class="comment">// mPDF 4.1</span>
<a name="l06151"></a>06151     $mqr=ini_get(<span class="stringliteral">&quot;magic_quotes_runtime&quot;</span>);
<a name="l06152"></a>06152     <span class="keywordflow">if</span> ($mqr) { set_magic_quotes_runtime(0); }
<a name="l06153"></a>06153     <span class="keywordflow">foreach</span>($this-&gt;FontFiles as $file=&gt;$info)
<a name="l06154"></a>06154     {
<a name="l06155"></a>06155       <span class="comment">//Font file embedding</span>
<a name="l06156"></a>06156       $this-&gt;_newobj();
<a name="l06157"></a>06157       $this-&gt;FontFiles[$file][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n;
<a name="l06158"></a>06158       <span class="keywordflow">if</span>(defined(<span class="stringliteral">&#39;MPDF_FONTPATH&#39;</span>))
<a name="l06159"></a>06159         $file=MPDF_FONTPATH.$file;
<a name="l06160"></a>06160       $size=filesize($file);
<a name="l06161"></a>06161       <span class="keywordflow">if</span>(!$size)
<a name="l06162"></a>06162         $this-&gt;Error(<span class="stringliteral">&#39;Font file not found&#39;</span>);
<a name="l06163"></a>06163       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.$size);
<a name="l06164"></a>06164       <span class="keywordflow">if</span>(substr($file,-2)==<span class="stringliteral">&#39;.z&#39;</span>)
<a name="l06165"></a>06165         $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l06166"></a>06166       $this-&gt;_out(<span class="stringliteral">&#39;/Length1 &#39;</span>.$info[<span class="stringliteral">&#39;length1&#39;</span>]);
<a name="l06167"></a>06167       <span class="keywordflow">if</span>(isset($info[<span class="stringliteral">&#39;length2&#39;</span>]))
<a name="l06168"></a>06168         $this-&gt;_out(<span class="stringliteral">&#39;/Length2 &#39;</span>.$info[<span class="stringliteral">&#39;length2&#39;</span>].<span class="stringliteral">&#39; /Length3 0&#39;</span>);
<a name="l06169"></a>06169       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06170"></a>06170       $f=fopen($file,<span class="stringliteral">&#39;rb&#39;</span>);
<a name="l06171"></a>06171       $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06172"></a>06172       <span class="keywordflow">while</span> (!feof($f)) {
<a name="l06173"></a>06173         $s .= fread($f, 2048);
<a name="l06174"></a>06174       }
<a name="l06175"></a>06175 
<a name="l06176"></a>06176       $this-&gt;_putstream($s);
<a name="l06177"></a>06177       fclose($f);
<a name="l06178"></a>06178       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06179"></a>06179     }
<a name="l06180"></a>06180     <span class="comment">// mPDF 4.1</span>
<a name="l06181"></a>06181     <span class="keywordflow">if</span> ($mqr) { set_magic_quotes_runtime($mqr); }
<a name="l06182"></a>06182     <span class="keywordflow">foreach</span>($this-&gt;fonts as $k=&gt;$font)
<a name="l06183"></a>06183     {
<a name="l06184"></a>06184       <span class="comment">//Font objects</span>
<a name="l06185"></a>06185       $this-&gt;fonts[$k][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n+1;
<a name="l06186"></a>06186       $type=$font[<span class="stringliteral">&#39;type&#39;</span>];
<a name="l06187"></a>06187       $name=$font[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l06188"></a>06188       <span class="keywordflow">if</span>($type==<span class="stringliteral">&#39;core&#39;</span>)
<a name="l06189"></a>06189       {
<a name="l06190"></a>06190         <span class="comment">//Standard font</span>
<a name="l06191"></a>06191         <span class="comment">// mPDF 4.2.018</span>
<a name="l06192"></a>06192         <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&#39;Core fonts are not allowed in PDF/A1-b files (Times, Helvetica, Courier etc.)&#39;</span>); }
<a name="l06193"></a>06193         $this-&gt;_newobj();
<a name="l06194"></a>06194         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06195"></a>06195         $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$name);
<a name="l06196"></a>06196         $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type1&#39;</span>);
<a name="l06197"></a>06197         <span class="keywordflow">if</span>($name!=<span class="stringliteral">&#39;Symbol&#39;</span> and $name!=<span class="stringliteral">&#39;ZapfDingbats&#39;</span>)
<a name="l06198"></a>06198           $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /WinAnsiEncoding&#39;</span>);
<a name="l06199"></a>06199         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06200"></a>06200         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06201"></a>06201       }
<a name="l06202"></a>06202       elseif($type==<span class="stringliteral">&#39;Type1&#39;</span> or $type==<span class="stringliteral">&#39;TrueType&#39;</span>)
<a name="l06203"></a>06203       {
<a name="l06204"></a>06204         <span class="comment">//Additional Type1 or TrueType font</span>
<a name="l06205"></a>06205         $this-&gt;_newobj();
<a name="l06206"></a>06206         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06207"></a>06207         $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$name);
<a name="l06208"></a>06208         $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /&#39;</span>.$type);
<a name="l06209"></a>06209         $this-&gt;_out(<span class="stringliteral">&#39;/FirstChar 32 /LastChar 255&#39;</span>);
<a name="l06210"></a>06210         $this-&gt;_out(<span class="stringliteral">&#39;/Widths &#39;</span>.($this-&gt;n+1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06211"></a>06211         $this-&gt;_out(<span class="stringliteral">&#39;/FontDescriptor &#39;</span>.($this-&gt;n+2).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06212"></a>06212 
<a name="l06213"></a>06213         <span class="comment">// mPDF 4.0</span>
<a name="l06214"></a>06214         $mapdata = <span class="keyword">false</span>; 
<a name="l06215"></a>06215         <span class="keywordflow">if</span>($font[<span class="stringliteral">&#39;enc&#39;</span>])  {
<a name="l06216"></a>06216           <span class="keywordflow">if</span>(isset($font[<span class="stringliteral">&#39;diff&#39;</span>])) {
<a name="l06217"></a>06217             $this-&gt;_out(<span class="stringliteral">&#39;/Encoding &#39;</span>.($nf+$font[<span class="stringliteral">&#39;diff&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06218"></a>06218             $mapdata = @file(_MPDF_PATH .<span class="stringliteral">&#39;maps/&#39;</span>.$font[<span class="stringliteral">&#39;enc&#39;</span>].<span class="stringliteral">&#39;.map&#39;</span>);
<a name="l06219"></a>06219             <span class="keywordflow">if</span> ($mapdata) {
<a name="l06220"></a>06220               $this-&gt;_out(<span class="stringliteral">&#39;/ToUnicode &#39;</span>.($this-&gt;n + 3).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06221"></a>06221             }
<a name="l06222"></a>06222           }
<a name="l06223"></a>06223           <span class="keywordflow">else</span>
<a name="l06224"></a>06224             $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /WinAnsiEncoding&#39;</span>);
<a name="l06225"></a>06225         }
<a name="l06226"></a>06226         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06227"></a>06227         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06228"></a>06228         <span class="comment">//Widths</span>
<a name="l06229"></a>06229         $this-&gt;_newobj();
<a name="l06230"></a>06230         $cw=&amp;$font[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l06231"></a>06231         $s=<span class="charliteral">&#39;[&#39;</span>;
<a name="l06232"></a>06232         <span class="keywordflow">for</span>($i=32;$i&lt;=255;$i++)
<a name="l06233"></a>06233           $s.=$cw[$this-&gt;chrs[$i]].<span class="charliteral">&#39; &#39;</span>;
<a name="l06234"></a>06234         $this-&gt;_out($s.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06235"></a>06235         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06236"></a>06236         <span class="comment">//Descriptor</span>
<a name="l06237"></a>06237         $this-&gt;_newobj();
<a name="l06238"></a>06238         $s=<span class="stringliteral">&#39;&lt;&lt;/Type /FontDescriptor /FontName /&#39;</span>.$name;
<a name="l06239"></a>06239         <span class="keywordflow">foreach</span>($font[<span class="stringliteral">&#39;desc&#39;</span>] as $k=&gt;$v)
<a name="l06240"></a>06240           $s.=<span class="stringliteral">&#39; /&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$v;
<a name="l06241"></a>06241         $file=$font[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l06242"></a>06242         <span class="keywordflow">if</span>($file)
<a name="l06243"></a>06243           $s.=<span class="stringliteral">&#39; /FontFile&#39;</span>.($type==<span class="stringliteral">&#39;Type1&#39;</span> ? <span class="stringliteral">&#39;&#39;</span> : <span class="charliteral">&#39;2&#39;</span>).<span class="charliteral">&#39; &#39;</span>.$this-&gt;FontFiles[$file][<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06244"></a>06244         $this-&gt;_out($s.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06245"></a>06245         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06246"></a>06246 
<a name="l06247"></a>06247 
<a name="l06248"></a>06248         <span class="comment">// mPDF 4.0</span>
<a name="l06249"></a>06249         <span class="comment">// ToUnicode</span>
<a name="l06250"></a>06250         <span class="comment">// Uses the .map files to determine mapping of 7F-FF to Unicode characters</span>
<a name="l06251"></a>06251         <span class="comment">// Allows copying and pasting of PDF text to another editor</span>
<a name="l06252"></a>06252         <span class="keywordflow">if</span>($mapdata) {
<a name="l06253"></a>06253           $toUni = <span class="stringliteral">&quot;stream\n&quot;</span>;
<a name="l06254"></a>06254           $toUni .= <span class="stringliteral">&quot;/CIDInit /ProcSet findresource begin\n&quot;</span>;
<a name="l06255"></a>06255           $toUni .= <span class="stringliteral">&quot;12 dict begin\n&quot;</span>;
<a name="l06256"></a>06256           $toUni .= <span class="stringliteral">&quot;begincmap\n&quot;</span>;
<a name="l06257"></a>06257           $toUni .= <span class="stringliteral">&quot;/CIDSystemInfo\n&quot;</span>;
<a name="l06258"></a>06258           $toUni .= <span class="stringliteral">&quot;&lt;&lt;/Registry (Adobe)\n&quot;</span>;
<a name="l06259"></a>06259           $toUni .= <span class="stringliteral">&quot;/Ordering (UCS)\n&quot;</span>;
<a name="l06260"></a>06260           $toUni .= <span class="stringliteral">&quot;/Supplement 0\n&quot;</span>;
<a name="l06261"></a>06261           $toUni .= <span class="stringliteral">&quot;&gt;&gt; def\n&quot;</span>;
<a name="l06262"></a>06262           $toUni .= <span class="stringliteral">&quot;/CMapName /Adobe-Identity-UCS def\n&quot;</span>;
<a name="l06263"></a>06263           $toUni .= <span class="stringliteral">&quot;/CMapType 2 def\n&quot;</span>;
<a name="l06264"></a>06264           $toUni .= <span class="stringliteral">&quot;1 begincodespacerange\n&quot;</span>;
<a name="l06265"></a>06265           $toUni .= <span class="stringliteral">&quot;&lt;00&gt; &lt;FF&gt;\n&quot;</span>;
<a name="l06266"></a>06266           $toUni .= <span class="stringliteral">&quot;endcodespacerange\n&quot;</span>;
<a name="l06267"></a>06267           $toUni .= <span class="stringliteral">&quot;1 beginbfrange\n&quot;</span>;
<a name="l06268"></a>06268           $toUni .= <span class="stringliteral">&quot;&lt;00&gt; &lt;7F&gt; &lt;0000&gt;\n&quot;</span>;
<a name="l06269"></a>06269           $toUni .= <span class="stringliteral">&quot;endbfrange\n&quot;</span>;
<a name="l06270"></a>06270           $unip = array();
<a name="l06271"></a>06271           <span class="keywordflow">foreach</span>($mapdata AS $ms) {
<a name="l06272"></a>06272             $tp = hexdec(substr($ms, 1, 2));
<a name="l06273"></a>06273             <span class="keywordflow">if</span> ($tp &gt; 127) {
<a name="l06274"></a>06274               $unip[$tp] = substr($ms, 6, 4);
<a name="l06275"></a>06275             }
<a name="l06276"></a>06276           }
<a name="l06277"></a>06277           $toUni .= count($unip).<span class="stringliteral">&quot; beginbfchar\n&quot;</span>;
<a name="l06278"></a>06278           <span class="keywordflow">foreach</span>($unip AS $cp=&gt;$u) {
<a name="l06279"></a>06279             $toUni .= sprintf(<span class="stringliteral">&quot;&lt;%02s&gt; &lt;%04s&gt;\n&quot;</span>, strtoupper(dechex($cp)), $u);
<a name="l06280"></a>06280           }
<a name="l06281"></a>06281           $toUni .= <span class="stringliteral">&quot;endbfchar\n&quot;</span>;
<a name="l06282"></a>06282           $toUni .= <span class="stringliteral">&quot;endcmap\n&quot;</span>;
<a name="l06283"></a>06283           $toUni .= <span class="stringliteral">&quot;CMapName currentdict /CMap defineresource pop\n&quot;</span>;
<a name="l06284"></a>06284           $toUni .= <span class="stringliteral">&quot;end\n&quot;</span>;
<a name="l06285"></a>06285           $toUni .= <span class="stringliteral">&quot;end\n&quot;</span>;
<a name="l06286"></a>06286           $toUni .= <span class="stringliteral">&quot;endstream\n&quot;</span>;
<a name="l06287"></a>06287           $toUni .= <span class="stringliteral">&quot;endobj&quot;</span>;
<a name="l06288"></a>06288           $this-&gt;_newobj();
<a name="l06289"></a>06289           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.(strlen($toUni)-24).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06290"></a>06290           $this-&gt;_out($toUni);
<a name="l06291"></a>06291         }
<a name="l06292"></a>06292       }
<a name="l06293"></a>06293       <span class="keywordflow">else</span>
<a name="l06294"></a>06294       {
<a name="l06295"></a>06295         <span class="comment">//Allow for additional types including TrueTypeUnicode</span>
<a name="l06296"></a>06296         $mtd=<span class="stringliteral">&#39;_put&#39;</span>.strtolower($type);
<a name="l06297"></a>06297         <span class="keywordflow">if</span>(!method_exists($this,$mtd))
<a name="l06298"></a>06298           $this-&gt;Error(<span class="stringliteral">&#39;Unsupported font type: &#39;</span>.$type.<span class="stringliteral">&#39; (&#39;</span>.$name.<span class="charliteral">&#39;)&#39;</span>);
<a name="l06299"></a>06299         $this-&gt;$mtd($font);
<a name="l06300"></a>06300       }
<a name="l06301"></a>06301     }
<a name="l06302"></a>06302 
<a name="l06303"></a>06303 
<a name="l06304"></a>06304   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l06305"></a>06305 }
<a name="l06306"></a>06306 
<a name="l06307"></a>06307 
<a name="l06308"></a>06308 
<a name="l06309"></a>06309 <span class="comment">// Unicode fonts</span>
<a name="l06310"></a>06310 function _puttruetypeunicode($font) {
<a name="l06311"></a>06311       <span class="comment">// Type0 Font</span>
<a name="l06312"></a>06312       <span class="comment">// A composite font - a font composed of other fonts, organized hierarchically</span>
<a name="l06313"></a>06313       $this-&gt;_newobj();
<a name="l06314"></a>06314       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06315"></a>06315       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type0&#39;</span>);
<a name="l06316"></a>06316       $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$font[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39;&#39;</span>);
<a name="l06317"></a>06317       $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /Identity-H&#39;</span>); <span class="comment">//The horizontal identity mapping for 2-byte CIDs; may be used with CIDFonts using any Registry, Ordering, and Supplement values.</span>
<a name="l06318"></a>06318       $this-&gt;_out(<span class="stringliteral">&#39;/DescendantFonts [&#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R]&#39;</span>);
<a name="l06319"></a>06319       $this-&gt;_out(<span class="stringliteral">&#39;/ToUnicode &#39;</span>.($this-&gt;n + 2).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06320"></a>06320       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06321"></a>06321       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06322"></a>06322       
<a name="l06323"></a>06323       <span class="comment">// CIDFontType2</span>
<a name="l06324"></a>06324       <span class="comment">// A CIDFont whose glyph descriptions are based on TrueType font technology</span>
<a name="l06325"></a>06325       $this-&gt;_newobj();
<a name="l06326"></a>06326       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06327"></a>06327       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /CIDFontType2&#39;</span>);
<a name="l06328"></a>06328       $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$font[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39;&#39;</span>);
<a name="l06329"></a>06329       $this-&gt;_out(<span class="stringliteral">&#39;/CIDSystemInfo &#39;</span>.($this-&gt;n + 2).<span class="stringliteral">&#39; 0 R&#39;</span>); 
<a name="l06330"></a>06330       $this-&gt;_out(<span class="stringliteral">&#39;/FontDescriptor &#39;</span>.($this-&gt;n + 3).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06331"></a>06331       <span class="keywordflow">if</span> (isset($font[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;MissingWidth&#39;</span>])){
<a name="l06332"></a>06332         $this-&gt;_out(<span class="stringliteral">&#39;/DW &#39;</span>.$font[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;MissingWidth&#39;</span>].<span class="stringliteral">&#39;&#39;</span>); <span class="comment">// The default width for glyphs in the CIDFont MissingWidth</span>
<a name="l06333"></a>06333       }
<a name="l06334"></a>06334       $w = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06335"></a>06335       <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;cw&#39;</span>] as $cid =&gt; $width) {
<a name="l06336"></a>06336         $w .= <span class="stringliteral">&#39;&#39;</span>.$cid.<span class="stringliteral">&#39; [&#39;</span>.$width.<span class="stringliteral">&#39;] &#39;</span>; <span class="comment">// define a specific width for each individual CID</span>
<a name="l06337"></a>06337       }
<a name="l06338"></a>06338       $this-&gt;_out(<span class="stringliteral">&#39;/W [&#39;</span>.$w.<span class="charliteral">&#39;]&#39;</span>); <span class="comment">// A description of the widths for the glyphs in the CIDFont</span>
<a name="l06339"></a>06339 
<a name="l06340"></a>06340       $this-&gt;_out(<span class="stringliteral">&#39;/CIDToGIDMap &#39;</span>.($this-&gt;n + 4).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06341"></a>06341 
<a name="l06342"></a>06342       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06343"></a>06343       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06344"></a>06344       
<a name="l06345"></a>06345       <span class="comment">// ToUnicode</span>
<a name="l06346"></a>06346       <span class="comment">// is a stream object that contains the definition of the CMap</span>
<a name="l06347"></a>06347       <span class="comment">// (PDF Reference 1.3 chap. 5.9)</span>
<a name="l06348"></a>06348       $this-&gt;_newobj();
<a name="l06349"></a>06349       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length 345&gt;&gt;&#39;</span>);
<a name="l06350"></a>06350       $this-&gt;_out(<span class="stringliteral">&#39;stream&#39;</span>);
<a name="l06351"></a>06351       $this-&gt;_out(<span class="stringliteral">&#39;/CIDInit /ProcSet findresource begin&#39;</span>);
<a name="l06352"></a>06352       $this-&gt;_out(<span class="stringliteral">&#39;12 dict begin&#39;</span>);
<a name="l06353"></a>06353       $this-&gt;_out(<span class="stringliteral">&#39;begincmap&#39;</span>);
<a name="l06354"></a>06354       $this-&gt;_out(<span class="stringliteral">&#39;/CIDSystemInfo&#39;</span>);
<a name="l06355"></a>06355       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Registry (Adobe)&#39;</span>);
<a name="l06356"></a>06356       $this-&gt;_out(<span class="stringliteral">&#39;/Ordering (UCS)&#39;</span>);
<a name="l06357"></a>06357       $this-&gt;_out(<span class="stringliteral">&#39;/Supplement 0&#39;</span>);
<a name="l06358"></a>06358       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt; def&#39;</span>);
<a name="l06359"></a>06359       $this-&gt;_out(<span class="stringliteral">&#39;/CMapName /Adobe-Identity-UCS def&#39;</span>);
<a name="l06360"></a>06360       $this-&gt;_out(<span class="stringliteral">&#39;/CMapType 2 def&#39;</span>);
<a name="l06361"></a>06361       $this-&gt;_out(<span class="stringliteral">&#39;1 begincodespacerange&#39;</span>);
<a name="l06362"></a>06362       $this-&gt;_out(<span class="stringliteral">&#39;&lt;0000&gt; &lt;FFFF&gt;&#39;</span>);
<a name="l06363"></a>06363       $this-&gt;_out(<span class="stringliteral">&#39;endcodespacerange&#39;</span>);
<a name="l06364"></a>06364       $this-&gt;_out(<span class="stringliteral">&#39;1 beginbfrange&#39;</span>);
<a name="l06365"></a>06365       $this-&gt;_out(<span class="stringliteral">&#39;&lt;0000&gt; &lt;FFFF&gt; &lt;0000&gt;&#39;</span>);
<a name="l06366"></a>06366       $this-&gt;_out(<span class="stringliteral">&#39;endbfrange&#39;</span>);
<a name="l06367"></a>06367       $this-&gt;_out(<span class="stringliteral">&#39;endcmap&#39;</span>);
<a name="l06368"></a>06368       $this-&gt;_out(<span class="stringliteral">&#39;CMapName currentdict /CMap defineresource pop&#39;</span>);
<a name="l06369"></a>06369       $this-&gt;_out(<span class="stringliteral">&#39;end&#39;</span>);
<a name="l06370"></a>06370       $this-&gt;_out(<span class="stringliteral">&#39;end&#39;</span>);
<a name="l06371"></a>06371       $this-&gt;_out(<span class="stringliteral">&#39;endstream&#39;</span>);
<a name="l06372"></a>06372       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06373"></a>06373 
<a name="l06374"></a>06374       <span class="comment">// CIDSystemInfo dictionary</span>
<a name="l06375"></a>06375       <span class="comment">// A dictionary containing entries that define the character collection of the CIDFont.</span>
<a name="l06376"></a>06376       $this-&gt;_newobj();
<a name="l06377"></a>06377       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Registry (Adobe)&#39;</span>); <span class="comment">// A string identifying an issuer of character collections</span>
<a name="l06378"></a>06378       $this-&gt;_out(<span class="stringliteral">&#39;/Ordering (UCS)&#39;</span>); <span class="comment">// A string that uniquely names a character collection issued by a specific registry</span>
<a name="l06379"></a>06379       $this-&gt;_out(<span class="stringliteral">&#39;/Supplement 0&#39;</span>); <span class="comment">// The supplement number of the character collection.</span>
<a name="l06380"></a>06380       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06381"></a>06381       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06382"></a>06382       
<a name="l06383"></a>06383       <span class="comment">// Font descriptor</span>
<a name="l06384"></a>06384       <span class="comment">// A font descriptor describing the CIDFont&#39;s default metrics other than its glyph widths</span>
<a name="l06385"></a>06385       $this-&gt;_newobj();
<a name="l06386"></a>06386       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /FontDescriptor&#39;</span>);
<a name="l06387"></a>06387       $this-&gt;_out(<span class="stringliteral">&#39;/FontName /&#39;</span>.$font[<span class="stringliteral">&#39;name&#39;</span>]);
<a name="l06388"></a>06388       <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;desc&#39;</span>] as $key =&gt; $value) {
<a name="l06389"></a>06389         $this-&gt;_out(<span class="charliteral">&#39;/&#39;</span>.$key.<span class="charliteral">&#39; &#39;</span>.$value);
<a name="l06390"></a>06390       }
<a name="l06391"></a>06391       <span class="keywordflow">if</span> ($font[<span class="stringliteral">&#39;file&#39;</span>]) {
<a name="l06392"></a>06392         <span class="comment">// obj ID of a stream containing a TrueType font program</span>
<a name="l06393"></a>06393         $this-&gt;_out(<span class="stringliteral">&#39;/FontFile2 &#39;</span>.$this-&gt;FontFiles[$font[<span class="stringliteral">&#39;file&#39;</span>]][<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06394"></a>06394       }
<a name="l06395"></a>06395       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06396"></a>06396       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06397"></a>06397 
<a name="l06398"></a>06398       <span class="comment">// Embed CIDToGIDMap</span>
<a name="l06399"></a>06399       <span class="comment">// A specification of the mapping from CIDs to glyph indices</span>
<a name="l06400"></a>06400       $this-&gt;_newobj();
<a name="l06401"></a>06401       $ctgfile = MPDF_FONTPATH.$font[<span class="stringliteral">&#39;ctg&#39;</span>];
<a name="l06402"></a>06402       <span class="keywordflow">if</span>(!file_exists($ctgfile)) {
<a name="l06403"></a>06403         $this-&gt;Error(<span class="stringliteral">&#39;Font file not found: &#39;</span>.$ctgfile);
<a name="l06404"></a>06404       }
<a name="l06405"></a>06405       $size = filesize($ctgfile);
<a name="l06406"></a>06406       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.$size.<span class="stringliteral">&#39;&#39;</span>);
<a name="l06407"></a>06407       <span class="keywordflow">if</span>(substr($ctgfile, -2) == <span class="stringliteral">&#39;.z&#39;</span>) { <span class="comment">// check file extension</span>
<a name="l06408"></a>06408         <span class="comment">// Decompresses data encoded using the public-domain </span>
<a name="l06409"></a>06409         <span class="comment">// zlib/deflate compression method, reproducing the </span>
<a name="l06410"></a>06410         <span class="comment">// original text or binary data </span>
<a name="l06411"></a>06411         $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l06412"></a>06412       }
<a name="l06413"></a>06413       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06414"></a>06414       $this-&gt;_putstream(file_get_contents($ctgfile));
<a name="l06415"></a>06415       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06416"></a>06416 
<a name="l06417"></a>06417 }
<a name="l06418"></a>06418 
<a name="l06419"></a>06419 
<a name="l06420"></a>06420 function _putfontwidths($font, $cidoffset=0) {
<a name="l06421"></a>06421       ksort($font[<span class="stringliteral">&#39;cw&#39;</span>]);
<a name="l06422"></a>06422       $rangeid = 0;
<a name="l06423"></a>06423       $range = array();
<a name="l06424"></a>06424       $prevcid = -2;
<a name="l06425"></a>06425       $prevwidth = -1;
<a name="l06426"></a>06426       $interval = <span class="keyword">false</span>;
<a name="l06427"></a>06427       <span class="comment">// for each character</span>
<a name="l06428"></a>06428       <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;cw&#39;</span>] as $cid =&gt; $width) {
<a name="l06429"></a>06429         $cid -= $cidoffset;
<a name="l06430"></a>06430         <span class="keywordflow">if</span> (!isset($font[<span class="stringliteral">&#39;dw&#39;</span>]) || (isset($font[<span class="stringliteral">&#39;dw&#39;</span>]) &amp;&amp; $width != $font[<span class="stringliteral">&#39;dw&#39;</span>])) {
<a name="l06431"></a>06431           <span class="keywordflow">if</span> ($cid == ($prevcid + 1)) {
<a name="l06432"></a>06432             <span class="comment">// consecutive CID</span>
<a name="l06433"></a>06433             <span class="keywordflow">if</span> ($width == $prevwidth) {
<a name="l06434"></a>06434               <span class="keywordflow">if</span> ($width == $range[$rangeid][0]) {
<a name="l06435"></a>06435                 $range[$rangeid][] = $width;
<a name="l06436"></a>06436               } <span class="keywordflow">else</span> {
<a name="l06437"></a>06437                 array_pop($range[$rangeid]);
<a name="l06438"></a>06438                 <span class="comment">// new range</span>
<a name="l06439"></a>06439                 $rangeid = $prevcid;
<a name="l06440"></a>06440                 $range[$rangeid] = array();
<a name="l06441"></a>06441                 $range[$rangeid][] = $prevwidth;
<a name="l06442"></a>06442                 $range[$rangeid][] = $width;
<a name="l06443"></a>06443               }
<a name="l06444"></a>06444               $interval = <span class="keyword">true</span>;
<a name="l06445"></a>06445               $range[$rangeid][<span class="stringliteral">&#39;interval&#39;</span>] = <span class="keyword">true</span>;
<a name="l06446"></a>06446             } <span class="keywordflow">else</span> {
<a name="l06447"></a>06447               <span class="keywordflow">if</span> ($interval) {
<a name="l06448"></a>06448                 <span class="comment">// new range</span>
<a name="l06449"></a>06449                 $rangeid = $cid;
<a name="l06450"></a>06450                 $range[$rangeid] = array();
<a name="l06451"></a>06451                 $range[$rangeid][] = $width;
<a name="l06452"></a>06452               } <span class="keywordflow">else</span> {
<a name="l06453"></a>06453                 $range[$rangeid][] = $width;
<a name="l06454"></a>06454               }
<a name="l06455"></a>06455               $interval = <span class="keyword">false</span>;
<a name="l06456"></a>06456             }
<a name="l06457"></a>06457           } <span class="keywordflow">else</span> {
<a name="l06458"></a>06458             <span class="comment">// new range</span>
<a name="l06459"></a>06459             $rangeid = $cid;
<a name="l06460"></a>06460             $range[$rangeid] = array();
<a name="l06461"></a>06461             $range[$rangeid][] = $width;
<a name="l06462"></a>06462             $interval = <span class="keyword">false</span>;
<a name="l06463"></a>06463           }
<a name="l06464"></a>06464           $prevcid = $cid;
<a name="l06465"></a>06465           $prevwidth = $width;
<a name="l06466"></a>06466         }
<a name="l06467"></a>06467       }
<a name="l06468"></a>06468       <span class="comment">// optimize ranges</span>
<a name="l06469"></a>06469       $prevk = -1;
<a name="l06470"></a>06470       $nextk = -1;
<a name="l06471"></a>06471       $prevint = <span class="keyword">false</span>;
<a name="l06472"></a>06472       <span class="keywordflow">foreach</span> ($range as $k =&gt; $ws) {
<a name="l06473"></a>06473         $cws = count($ws);
<a name="l06474"></a>06474         <span class="keywordflow">if</span> (($k == $nextk) AND (!$prevint) AND ((!isset($ws[<span class="stringliteral">&#39;interval&#39;</span>])) OR ($cws &lt; 4))) {
<a name="l06475"></a>06475           <span class="keywordflow">if</span> (isset($range[$k][<span class="stringliteral">&#39;interval&#39;</span>])) {
<a name="l06476"></a>06476             unset($range[$k][<span class="stringliteral">&#39;interval&#39;</span>]);
<a name="l06477"></a>06477           }
<a name="l06478"></a>06478           $range[$prevk] = array_merge($range[$prevk], $range[$k]);
<a name="l06479"></a>06479           unset($range[$k]);
<a name="l06480"></a>06480         } <span class="keywordflow">else</span> {
<a name="l06481"></a>06481           $prevk = $k;
<a name="l06482"></a>06482         }
<a name="l06483"></a>06483         $nextk = $k + $cws;
<a name="l06484"></a>06484         <span class="keywordflow">if</span> (isset($ws[<span class="stringliteral">&#39;interval&#39;</span>])) {
<a name="l06485"></a>06485           <span class="keywordflow">if</span> ($cws &gt; 3) {
<a name="l06486"></a>06486             $prevint = <span class="keyword">true</span>;
<a name="l06487"></a>06487           } <span class="keywordflow">else</span> {
<a name="l06488"></a>06488             $prevint = <span class="keyword">false</span>;
<a name="l06489"></a>06489           }
<a name="l06490"></a>06490           unset($range[$k][<span class="stringliteral">&#39;interval&#39;</span>]);
<a name="l06491"></a>06491           --$nextk;
<a name="l06492"></a>06492         } <span class="keywordflow">else</span> {
<a name="l06493"></a>06493           $prevint = <span class="keyword">false</span>;
<a name="l06494"></a>06494         }
<a name="l06495"></a>06495       }
<a name="l06496"></a>06496       <span class="comment">// output data</span>
<a name="l06497"></a>06497       $w = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06498"></a>06498       <span class="keywordflow">foreach</span> ($range as $k =&gt; $ws) {
<a name="l06499"></a>06499         <span class="keywordflow">if</span> (count(array_count_values($ws)) == 1) {
<a name="l06500"></a>06500           <span class="comment">// interval mode is more compact</span>
<a name="l06501"></a>06501           $w .= <span class="charliteral">&#39; &#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.($k + count($ws) - 1).<span class="charliteral">&#39; &#39;</span>.$ws[0];
<a name="l06502"></a>06502         } <span class="keywordflow">else</span> {
<a name="l06503"></a>06503           <span class="comment">// range mode</span>
<a name="l06504"></a>06504           $w .= <span class="charliteral">&#39; &#39;</span>.$k.<span class="stringliteral">&#39; [ &#39;</span>.implode(<span class="charliteral">&#39; &#39;</span>, $ws).<span class="stringliteral">&#39; ]&#39;</span>;
<a name="l06505"></a>06505         }
<a name="l06506"></a>06506       }
<a name="l06507"></a>06507       $this-&gt;_out(<span class="stringliteral">&#39;/W [&#39;</span>.$w.<span class="stringliteral">&#39; ]&#39;</span>);
<a name="l06508"></a>06508 }
<a name="l06509"></a>06509 
<a name="l06510"></a>06510 
<a name="l06511"></a>06511 
<a name="l06512"></a>06512 
<a name="l06513"></a>06513 
<a name="l06514"></a>06514 function _putimages()
<a name="l06515"></a>06515 {
<a name="l06516"></a>06516   $filter=($this-&gt;compress) ? <span class="stringliteral">&#39;/Filter /FlateDecode &#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l06517"></a>06517   reset($this-&gt;images);
<a name="l06518"></a>06518   <span class="keywordflow">while</span>(list($file,$info)=each($this-&gt;images))
<a name="l06519"></a>06519   {
<a name="l06520"></a>06520     $this-&gt;_newobj();
<a name="l06521"></a>06521     $this-&gt;images[$file][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n;
<a name="l06522"></a>06522     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /XObject&#39;</span>);
<a name="l06523"></a>06523     $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Image&#39;</span>);
<a name="l06524"></a>06524     $this-&gt;_out(<span class="stringliteral">&#39;/Width &#39;</span>.$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l06525"></a>06525     $this-&gt;_out(<span class="stringliteral">&#39;/Height &#39;</span>.$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l06526"></a>06526 
<a name="l06527"></a>06527     <span class="comment">// mPDF 4.0</span>
<a name="l06528"></a>06528     <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;masked&#39;</span>])) {
<a name="l06529"></a>06529       $this-&gt;_out(<span class="stringliteral">&#39;/SMask &#39;</span>.($this-&gt;n - 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06530"></a>06530     }
<a name="l06531"></a>06531 
<a name="l06532"></a>06532     <span class="keywordflow">if</span>($info[<span class="stringliteral">&#39;cs&#39;</span>]==<span class="stringliteral">&#39;Indexed&#39;</span>)
<a name="l06533"></a>06533       $this-&gt;_out(<span class="stringliteral">&#39;/ColorSpace [/Indexed /DeviceRGB &#39;</span>.(strlen($info[<span class="stringliteral">&#39;pal&#39;</span>])/3-1).<span class="charliteral">&#39; &#39;</span>.($this-&gt;n+1).<span class="stringliteral">&#39; 0 R]&#39;</span>);
<a name="l06534"></a>06534     <span class="keywordflow">else</span>
<a name="l06535"></a>06535     {
<a name="l06536"></a>06536       $this-&gt;_out(<span class="stringliteral">&#39;/ColorSpace /&#39;</span>.$info[<span class="stringliteral">&#39;cs&#39;</span>]);
<a name="l06537"></a>06537       <span class="keywordflow">if</span>($info[<span class="stringliteral">&#39;cs&#39;</span>]==<span class="stringliteral">&#39;DeviceCMYK&#39;</span>) {
<a name="l06538"></a>06538         <span class="comment">// mPDF 4.2.018</span>
<a name="l06539"></a>06539         <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&quot;PDFA1-b does not permit Images using DeviceCMYK colour space (&quot;</span>.$file.<span class="stringliteral">&quot;).&quot;</span>); }
<a name="l06540"></a>06540         $this-&gt;_out(<span class="stringliteral">&#39;/Decode [1 0 1 0 1 0 1 0]&#39;</span>);
<a name="l06541"></a>06541       }
<a name="l06542"></a>06542     }
<a name="l06543"></a>06543     $this-&gt;_out(<span class="stringliteral">&#39;/BitsPerComponent &#39;</span>.$info[<span class="stringliteral">&#39;bpc&#39;</span>]);
<a name="l06544"></a>06544     <span class="comment">// mPDF 4.0</span>
<a name="l06545"></a>06545     <span class="keywordflow">if</span> (isset($info[<span class="charliteral">&#39;f&#39;</span>]) &amp;&amp; $info[<span class="charliteral">&#39;f&#39;</span>]) { $this-&gt;_out(<span class="stringliteral">&#39;/Filter /&#39;</span>.$info[<span class="charliteral">&#39;f&#39;</span>]); }
<a name="l06546"></a>06546     <span class="keywordflow">if</span>(isset($info[<span class="stringliteral">&#39;parms&#39;</span>])) { $this-&gt;_out($info[<span class="stringliteral">&#39;parms&#39;</span>]); }
<a name="l06547"></a>06547     <span class="keywordflow">if</span>(isset($info[<span class="stringliteral">&#39;trns&#39;</span>]) and is_array($info[<span class="stringliteral">&#39;trns&#39;</span>]))
<a name="l06548"></a>06548     {
<a name="l06549"></a>06549       $trns=<span class="stringliteral">&#39;&#39;</span>;
<a name="l06550"></a>06550       <span class="keywordflow">for</span>($i=0;$i&lt;count($info[<span class="stringliteral">&#39;trns&#39;</span>]);$i++)
<a name="l06551"></a>06551         $trns.=$info[<span class="stringliteral">&#39;trns&#39;</span>][$i].<span class="charliteral">&#39; &#39;</span>.$info[<span class="stringliteral">&#39;trns&#39;</span>][$i].<span class="charliteral">&#39; &#39;</span>;
<a name="l06552"></a>06552       $this-&gt;_out(<span class="stringliteral">&#39;/Mask [&#39;</span>.$trns.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06553"></a>06553     }
<a name="l06554"></a>06554     $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($info[<span class="stringliteral">&#39;data&#39;</span>]).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06555"></a>06555     $this-&gt;_putstream($info[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l06556"></a>06556     unset($this-&gt;images[$file][<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l06557"></a>06557     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06558"></a>06558     <span class="comment">//Palette</span>
<a name="l06559"></a>06559     <span class="keywordflow">if</span>($info[<span class="stringliteral">&#39;cs&#39;</span>]==<span class="stringliteral">&#39;Indexed&#39;</span>)
<a name="l06560"></a>06560     {
<a name="l06561"></a>06561       $this-&gt;_newobj();
<a name="l06562"></a>06562       $pal=($this-&gt;compress) ? gzcompress($info[<span class="stringliteral">&#39;pal&#39;</span>]) : $info[<span class="stringliteral">&#39;pal&#39;</span>];
<a name="l06563"></a>06563       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>.$filter.<span class="stringliteral">&#39;/Length &#39;</span>.strlen($pal).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06564"></a>06564       $this-&gt;_putstream($pal);
<a name="l06565"></a>06565       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06566"></a>06566     }
<a name="l06567"></a>06567   }
<a name="l06568"></a>06568 }
<a name="l06569"></a>06569 
<a name="l06570"></a>06570 function _putinfo()
<a name="l06571"></a>06571 {
<a name="l06572"></a>06572   $this-&gt;_out(<span class="stringliteral">&#39;/Producer &#39;</span>.$this-&gt;_UTF16BEtextstring(<span class="stringliteral">&#39;mPDF &#39;</span>.mPDF_VERSION));
<a name="l06573"></a>06573   <span class="keywordflow">if</span>(!empty($this-&gt;title))
<a name="l06574"></a>06574     $this-&gt;_out(<span class="stringliteral">&#39;/Title &#39;</span>.$this-&gt;_UTF16BEtextstring($this-&gt;title));
<a name="l06575"></a>06575   <span class="keywordflow">if</span>(!empty($this-&gt;subject))
<a name="l06576"></a>06576     $this-&gt;_out(<span class="stringliteral">&#39;/Subject &#39;</span>.$this-&gt;_UTF16BEtextstring($this-&gt;subject));
<a name="l06577"></a>06577   <span class="keywordflow">if</span>(!empty($this-&gt;author))
<a name="l06578"></a>06578     $this-&gt;_out(<span class="stringliteral">&#39;/Author &#39;</span>.$this-&gt;_UTF16BEtextstring($this-&gt;author));
<a name="l06579"></a>06579   <span class="keywordflow">if</span>(!empty($this-&gt;keywords))
<a name="l06580"></a>06580     $this-&gt;_out(<span class="stringliteral">&#39;/Keywords &#39;</span>.$this-&gt;_UTF16BEtextstring($this-&gt;keywords));
<a name="l06581"></a>06581   <span class="keywordflow">if</span>(!empty($this-&gt;creator))
<a name="l06582"></a>06582     $this-&gt;_out(<span class="stringliteral">&#39;/Creator &#39;</span>.$this-&gt;_UTF16BEtextstring($this-&gt;creator));
<a name="l06583"></a>06583   <span class="comment">// mPDF 4.2.018</span>
<a name="l06584"></a>06584   $z = date(<span class="charliteral">&#39;O&#39;</span>); <span class="comment">// +0200</span>
<a name="l06585"></a>06585   $offset = substr($z,0,3).<span class="stringliteral">&quot;&#39;&quot;</span>.substr($z,3,2).<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l06586"></a>06586   $this-&gt;_out(<span class="stringliteral">&#39;/CreationDate &#39;</span>.$this-&gt;_textstring(date(<span class="stringliteral">&#39;YmdHis&#39;</span>).$offset));
<a name="l06587"></a>06587   $this-&gt;_out(<span class="stringliteral">&#39;/ModDate &#39;</span>.$this-&gt;_textstring(date(<span class="stringliteral">&#39;YmdHis&#39;</span>).$offset));
<a name="l06588"></a>06588 }
<a name="l06589"></a>06589 
<a name="l06590"></a>06590 <span class="comment">// mPDF 4.2.018</span>
<a name="l06591"></a>06591 function _putmetadata() {
<a name="l06592"></a>06592   $this-&gt;_newobj();
<a name="l06593"></a>06593   $this-&gt;MetadataRoot = $this-&gt;n;
<a name="l06594"></a>06594   $Producer = <span class="stringliteral">&#39;mPDF &#39;</span>.mPDF_VERSION;
<a name="l06595"></a>06595   $z = date(<span class="charliteral">&#39;O&#39;</span>); <span class="comment">// +0200</span>
<a name="l06596"></a>06596   $offset = substr($z,0,3).<span class="charliteral">&#39;:&#39;</span>.substr($z,3,2);
<a name="l06597"></a>06597   $CreationDate = date(<span class="stringliteral">&#39;Y-m-d\TH:i:s&#39;</span>).$offset; <span class="comment">// 2006-03-10T10:47:26-05:00 2006-06-19T09:05:17Z</span>
<a name="l06598"></a>06598   $uuid = sprintf(<span class="stringliteral">&#39;%04x%04x-%04x-%04x-%04x-%04x%04x%04x&#39;</span>, mt_rand(0, 0xffff), mt_rand(0, 0xffff),
<a name="l06599"></a>06599       mt_rand(0, 0xffff), mt_rand(0, 0x0fff) | 0x4000, mt_rand(0, 0x3fff) | 0x8000,
<a name="l06600"></a>06600       mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff)  );
<a name="l06601"></a>06601 
<a name="l06602"></a>06602 
<a name="l06603"></a>06603   $m = <span class="stringliteral">&#39;&lt;?xpacket begin=&quot;&#39;</span>.chr(239).chr(187).chr(191).<span class="stringliteral">&#39;&quot; id=&quot;W5M0MpCehiHzreSzNTczkc9d&quot;?&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>; <span class="comment">// begin = FEFF BOM</span>
<a name="l06604"></a>06604   $m .= <span class="stringliteral">&#39; &lt;x:xmpmeta xmlns:x=&quot;adobe:ns:meta/&quot; x:xmptk=&quot;3.1-701&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06605"></a>06605   $m .= <span class="stringliteral">&#39;  &lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06606"></a>06606   $m .= <span class="stringliteral">&#39;   &lt;rdf:Description rdf:about=&quot;&quot; xmlns:pdf=&quot;http://ns.adobe.com/pdf/1.3/&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06607"></a>06607   $m .= <span class="stringliteral">&#39;    &lt;pdf:Producer&gt;&#39;</span>.$Producer.<span class="stringliteral">&#39;&lt;/pdf:Producer&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06608"></a>06608   <span class="keywordflow">if</span>(!empty($this-&gt;keywords)) {
<a name="l06609"></a>06609     $m .= <span class="stringliteral">&#39;    &lt;pdf:Keywords&gt;&#39;</span>.$this-&gt;keywords.<span class="stringliteral">&#39;&lt;/pdf:Keywords&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06610"></a>06610   }
<a name="l06611"></a>06611   $m .= <span class="stringliteral">&#39;   &lt;/rdf:Description&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06612"></a>06612   $m .= <span class="stringliteral">&#39;   &lt;rdf:Description rdf:about=&quot;&quot; xmlns:xmp=&quot;http://ns.adobe.com/xap/1.0/&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06613"></a>06613   $m .= <span class="stringliteral">&#39;    &lt;xmp:CreateDate&gt;&#39;</span>.$CreationDate.<span class="stringliteral">&#39;&lt;/xmp:CreateDate&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06614"></a>06614   $m .= <span class="stringliteral">&#39;    &lt;xmp:ModifyDate&gt;&#39;</span>.$CreationDate.<span class="stringliteral">&#39;&lt;/xmp:ModifyDate&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06615"></a>06615   $m .= <span class="stringliteral">&#39;    &lt;xmp:MetadataDate&gt;&#39;</span>.$CreationDate.<span class="stringliteral">&#39;&lt;/xmp:MetadataDate&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06616"></a>06616 
<a name="l06617"></a>06617   <span class="keywordflow">if</span>(!empty($this-&gt;creator)) {
<a name="l06618"></a>06618     $m .= <span class="stringliteral">&#39;    &lt;xmp:CreatorTool&gt;&#39;</span>.$this-&gt;creator.<span class="stringliteral">&#39;&lt;/xmp:CreatorTool&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06619"></a>06619   }
<a name="l06620"></a>06620 
<a name="l06621"></a>06621 
<a name="l06622"></a>06622   $m .= <span class="stringliteral">&#39;   &lt;/rdf:Description&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06623"></a>06623   $m .= <span class="stringliteral">&#39;   &lt;rdf:Description rdf:about=&quot;&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06624"></a>06624   $m .= <span class="stringliteral">&#39;    &lt;dc:format&gt;application/pdf&lt;/dc:format&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06625"></a>06625   <span class="keywordflow">if</span>(!empty($this-&gt;title)) {
<a name="l06626"></a>06626     $m .= <span class="stringliteral">&#39;    &lt;dc:title&gt;</span>
<a name="l06627"></a>06627 <span class="stringliteral">     &lt;rdf:Alt&gt;</span>
<a name="l06628"></a>06628 <span class="stringliteral">      &lt;rdf:li xml:lang=&quot;x-default&quot;&gt;&#39;</span>.$this-&gt;title.<span class="stringliteral">&#39;&lt;/rdf:li&gt;</span>
<a name="l06629"></a>06629 <span class="stringliteral">     &lt;/rdf:Alt&gt;</span>
<a name="l06630"></a>06630 <span class="stringliteral">    &lt;/dc:title&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06631"></a>06631   }
<a name="l06632"></a>06632   <span class="keywordflow">if</span>(!empty($this-&gt;keywords)) {
<a name="l06633"></a>06633     $m .= <span class="stringliteral">&#39;    &lt;dc:subject&gt;</span>
<a name="l06634"></a>06634 <span class="stringliteral">     &lt;rdf:Bag&gt;</span>
<a name="l06635"></a>06635 <span class="stringliteral">      &lt;rdf:li&gt;&#39;</span>.$this-&gt;keywords.<span class="stringliteral">&#39;&lt;/rdf:li&gt;</span>
<a name="l06636"></a>06636 <span class="stringliteral">     &lt;/rdf:Bag&gt;</span>
<a name="l06637"></a>06637 <span class="stringliteral">    &lt;/dc:subject&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06638"></a>06638   }
<a name="l06639"></a>06639   <span class="keywordflow">if</span>(!empty($this-&gt;subject)) {
<a name="l06640"></a>06640     $m .= <span class="stringliteral">&#39;    &lt;dc:description&gt;</span>
<a name="l06641"></a>06641 <span class="stringliteral">     &lt;rdf:Alt&gt;</span>
<a name="l06642"></a>06642 <span class="stringliteral">      &lt;rdf:li xml:lang=&quot;x-default&quot;&gt;&#39;</span>.$this-&gt;subject.<span class="stringliteral">&#39;&lt;/rdf:li&gt;</span>
<a name="l06643"></a>06643 <span class="stringliteral">     &lt;/rdf:Alt&gt;</span>
<a name="l06644"></a>06644 <span class="stringliteral">    &lt;/dc:description&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06645"></a>06645   }
<a name="l06646"></a>06646   <span class="keywordflow">if</span>(!empty($this-&gt;author)) {
<a name="l06647"></a>06647     $m .= <span class="stringliteral">&#39;    &lt;dc:creator&gt;</span>
<a name="l06648"></a>06648 <span class="stringliteral">     &lt;rdf:Seq&gt;</span>
<a name="l06649"></a>06649 <span class="stringliteral">      &lt;rdf:li&gt;&#39;</span>.$this-&gt;author.<span class="stringliteral">&#39;&lt;/rdf:li&gt;</span>
<a name="l06650"></a>06650 <span class="stringliteral">     &lt;/rdf:Seq&gt;</span>
<a name="l06651"></a>06651 <span class="stringliteral">    &lt;/dc:creator&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06652"></a>06652   }
<a name="l06653"></a>06653   $m .= <span class="stringliteral">&#39;   &lt;/rdf:Description&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06654"></a>06654 
<a name="l06655"></a>06655 <span class="comment">// This bit is specific to PDFA-1b</span>
<a name="l06656"></a>06656   $m .= <span class="stringliteral">&#39;   &lt;rdf:Description rdf:about=&quot;&quot; xmlns:pdfaid=&quot;http://www.aiim.org/pdfa/ns/id/&quot; &gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06657"></a>06657   $m .= <span class="stringliteral">&#39;    &lt;pdfaid:part&gt;1&lt;/pdfaid:part&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06658"></a>06658   $m .= <span class="stringliteral">&#39;    &lt;pdfaid:conformance&gt;B&lt;/pdfaid:conformance&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06659"></a>06659   $m .= <span class="stringliteral">&#39;    &lt;pdfaid:amd&gt;2005&lt;/pdfaid:amd&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06660"></a>06660   $m .= <span class="stringliteral">&#39;   &lt;/rdf:Description&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06661"></a>06661 
<a name="l06662"></a>06662   $m .= <span class="stringliteral">&#39;   &lt;rdf:Description rdf:about=&quot;&quot; xmlns:xmpMM=&quot;http://ns.adobe.com/xap/1.0/mm/&quot;&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06663"></a>06663   $m .= <span class="stringliteral">&#39;    &lt;xmpMM:DocumentID&gt;uuid:&#39;</span>.$uuid.<span class="stringliteral">&#39;&lt;/xmpMM:DocumentID&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06664"></a>06664   $m .= <span class="stringliteral">&#39;   &lt;/rdf:Description&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06665"></a>06665   $m .= <span class="stringliteral">&#39;  &lt;/rdf:RDF&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06666"></a>06666   $m .= <span class="stringliteral">&#39; &lt;/x:xmpmeta&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06667"></a>06667   $m .= str_repeat(str_repeat(<span class="charliteral">&#39; &#39;</span>,100).<span class="stringliteral">&quot;\n&quot;</span>,20);  <span class="comment">// 2-4kB whitespace padding required</span>
<a name="l06668"></a>06668   $m .= <span class="stringliteral">&#39;&lt;?xpacket end=&quot;w&quot;?&gt;&#39;</span>;  <span class="comment">// &quot;r&quot; read only</span>
<a name="l06669"></a>06669   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type/Metadata/Subtype/XML/Length &#39;</span>.strlen($m).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06670"></a>06670   $this-&gt;_putstream($m);
<a name="l06671"></a>06671   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06672"></a>06672 }
<a name="l06673"></a>06673 
<a name="l06674"></a>06674 <span class="comment">// mPDF 4.2.018</span>
<a name="l06675"></a>06675 function _putoutputintent() {
<a name="l06676"></a>06676   $this-&gt;_newobj();
<a name="l06677"></a>06677   $this-&gt;OutputIntentRoot = $this-&gt;n;
<a name="l06678"></a>06678   <span class="keywordflow">if</span> ($this-&gt;compress) { $s = gzcompress($s); }
<a name="l06679"></a>06679   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /OutputIntent&#39;</span>);
<a name="l06680"></a>06680   <span class="keywordflow">if</span> ($this-&gt;ICCProfile)
<a name="l06681"></a>06681     $this-&gt;_out(<span class="stringliteral">&#39;/Info (&#39;</span>.$this-&gt;ICCProfile.<span class="charliteral">&#39;)&#39;</span>);
<a name="l06682"></a>06682   <span class="keywordflow">else</span> 
<a name="l06683"></a>06683     $this-&gt;_out(<span class="stringliteral">&#39;/Info (sRGB)&#39;</span>);
<a name="l06684"></a>06684   $this-&gt;_out(<span class="stringliteral">&#39;/S /GTS_PDFA1&#39;</span>);
<a name="l06685"></a>06685   $this-&gt;_out(<span class="stringliteral">&#39;/OutputConditionIdentifier (Custom)&#39;</span>);
<a name="l06686"></a>06686   $this-&gt;_out(<span class="stringliteral">&#39;/OutputCondition ()&#39;</span>);
<a name="l06687"></a>06687   $this-&gt;_out(<span class="stringliteral">&#39;/DestOutputProfile &#39;</span>.($this-&gt;n+1).<span class="stringliteral">&#39; 0 R &gt;&gt;&#39;</span>);
<a name="l06688"></a>06688   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06689"></a>06689 
<a name="l06690"></a>06690   $this-&gt;_newobj();
<a name="l06691"></a>06691   <span class="keywordflow">if</span> ($this-&gt;ICCProfile)
<a name="l06692"></a>06692     $s = file_get_contents(_MPDF_PATH.<span class="stringliteral">&#39;iccprofiles/&#39;</span>.$this-&gt;ICCProfile.<span class="stringliteral">&#39;.icc&#39;</span>);
<a name="l06693"></a>06693   <span class="keywordflow">else</span> 
<a name="l06694"></a>06694     $s = file_get_contents(_MPDF_PATH.<span class="stringliteral">&#39;iccprofiles/sRGB_IEC61966-2-1.icc&#39;</span>);
<a name="l06695"></a>06695   <span class="keywordflow">if</span> ($this-&gt;compress) { $s = gzcompress($s); }
<a name="l06696"></a>06696   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/N 3&#39;</span>);
<a name="l06697"></a>06697   <span class="keywordflow">if</span> ($this-&gt;compress)
<a name="l06698"></a>06698     $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode &#39;</span>);
<a name="l06699"></a>06699   $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($s).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06700"></a>06700   $this-&gt;_putstream($s);
<a name="l06701"></a>06701   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06702"></a>06702 }
<a name="l06703"></a>06703 
<a name="l06704"></a>06704 
<a name="l06705"></a>06705 function _putcatalog() {
<a name="l06706"></a>06706   $this-&gt;_out(<span class="stringliteral">&#39;/Type /Catalog&#39;</span>);
<a name="l06707"></a>06707   $this-&gt;_out(<span class="stringliteral">&#39;/Pages 1 0 R&#39;</span>);
<a name="l06708"></a>06708   <span class="keywordflow">if</span>($this-&gt;ZoomMode==<span class="stringliteral">&#39;fullpage&#39;</span>) $this-&gt;_out(<span class="stringliteral">&#39;/OpenAction [3 0 R /Fit]&#39;</span>);
<a name="l06709"></a>06709   elseif($this-&gt;ZoomMode==<span class="stringliteral">&#39;fullwidth&#39;</span>) $this-&gt;_out(&#39;/OpenAction [3 0 R /FitH null]&#39;);
<a name="l06710"></a>06710   elseif($this-&gt;ZoomMode==&#39;real&#39;) $this-&gt;_out(&#39;/OpenAction [3 0 R /XYZ null null 1]&#39;);
<a name="l06711"></a>06711   elseif(!is_string($this-&gt;ZoomMode)) $this-&gt;_out(&#39;/OpenAction [3 0 R /XYZ null null &#39;.($this-&gt;ZoomMode/100).&#39;]&#39;);
<a name="l06712"></a>06712   else  $this-&gt;_out(&#39;/OpenAction [3 0 R /XYZ null null null]&#39;); <span class="comment">// mPDF 4.3.007F</span>
<a name="l06713"></a>06713   <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a>($this-&gt;LayoutMode==&#39;single&#39;) $this-&gt;_out(&#39;/PageLayout /SinglePage&#39;);
<a name="l06714"></a>06714   elseif($this-&gt;LayoutMode==&#39;continuous&#39;) $this-&gt;_out(&#39;/PageLayout /OneColumn&#39;);
<a name="l06715"></a>06715   elseif($this-&gt;LayoutMode==&#39;two&#39;) {
<a name="l06716"></a>06716     <span class="keywordflow">if</span> ($this-&gt;mirrorMargins) { $this-&gt;_out(<span class="stringliteral">&#39;/PageLayout /TwoColumnRight&#39;</span>); }
<a name="l06717"></a>06717     <span class="keywordflow">else</span> { $this-&gt;_out(<span class="stringliteral">&#39;/PageLayout /TwoColumnLeft&#39;</span>); }
<a name="l06718"></a>06718   }
<a name="l06719"></a>06719   <span class="keywordflow">if</span>(count($this-&gt;BMoutlines)&gt;0) {
<a name="l06720"></a>06720         $this-&gt;_out(<span class="stringliteral">&#39;/Outlines &#39;</span>.$this-&gt;OutlineRoot.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06721"></a>06721         $this-&gt;_out(<span class="stringliteral">&#39;/PageMode /UseOutlines&#39;</span>);
<a name="l06722"></a>06722   }
<a name="l06723"></a>06723   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;FullScreen&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/PageMode /FullScreen&#39;</span>);
<a name="l06724"></a>06724 
<a name="l06725"></a>06725   <span class="comment">// mPDF 4.2.018 - Metadata</span>
<a name="l06726"></a>06726   <span class="keywordflow">if</span> ($this-&gt;PDFA) { 
<a name="l06727"></a>06727     $this-&gt;_out(<span class="stringliteral">&#39;/Metadata &#39;</span>.$this-&gt;MetadataRoot.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06728"></a>06728   }
<a name="l06729"></a>06729   <span class="comment">// mPDF 4.2.018 - OutputIntents</span>
<a name="l06730"></a>06730   <span class="keywordflow">if</span> ($this-&gt;PDFA || $this-&gt;ICCProfile) { 
<a name="l06731"></a>06731     $this-&gt;_out(<span class="stringliteral">&#39;/OutputIntents [&#39;</span>.$this-&gt;OutputIntentRoot.<span class="stringliteral">&#39; 0 R]&#39;</span>);
<a name="l06732"></a>06732   }
<a name="l06733"></a>06733 
<a name="l06734"></a>06734   <span class="keywordflow">if</span>($this-&gt;DisplayPreferences || $this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span> || $this-&gt;mirrorMargins) {
<a name="l06735"></a>06735   $this-&gt;_out(<span class="stringliteral">&#39;/ViewerPreferences&lt;&lt;&#39;</span>);
<a name="l06736"></a>06736   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;HideMenubar&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/HideMenubar true&#39;</span>);
<a name="l06737"></a>06737   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;HideToolbar&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/HideToolbar true&#39;</span>);
<a name="l06738"></a>06738   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;HideWindowUI&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/HideWindowUI true&#39;</span>);
<a name="l06739"></a>06739   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;DisplayDocTitle&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/DisplayDocTitle true&#39;</span>);
<a name="l06740"></a>06740   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;CenterWindow&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/CenterWindow true&#39;</span>);
<a name="l06741"></a>06741   <span class="keywordflow">if</span>(is_int(strpos($this-&gt;DisplayPreferences,<span class="stringliteral">&#39;FitWindow&#39;</span>))) $this-&gt;_out(<span class="stringliteral">&#39;/FitWindow true&#39;</span>);
<a name="l06742"></a>06742   <span class="keywordflow">if</span>($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) $this-&gt;_out(<span class="stringliteral">&#39;/Direction /R2L&#39;</span>);
<a name="l06743"></a>06743   <span class="comment">// mPDF 4.0</span>
<a name="l06744"></a>06744   <span class="keywordflow">if</span>($this-&gt;mirrorMargins) {
<a name="l06745"></a>06745     <span class="comment">// if ($this-&gt;DefOrientation==&#39;P&#39;) $this-&gt;_out(&#39;/Duplex /DuplexFlipShortEdge&#39;);</span>
<a name="l06746"></a>06746     $this-&gt;_out(<span class="stringliteral">&#39;/Duplex /DuplexFlipLongEdge&#39;</span>); <span class="comment">// PDF v1.7+</span>
<a name="l06747"></a>06747   }
<a name="l06748"></a>06748   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06749"></a>06749   }
<a name="l06750"></a>06750 }
<a name="l06751"></a>06751 
<a name="l06752"></a>06752 <span class="comment">// Inactive function left for backwards compatability</span>
<a name="l06753"></a>06753 function SetUserRights($enable=<span class="keyword">true</span>, $annots=<span class="stringliteral">&quot;&quot;</span>, $form=<span class="stringliteral">&quot;&quot;</span>, $signature=<span class="stringliteral">&quot;&quot;</span>) {
<a name="l06754"></a>06754   <span class="comment">// Does nothing</span>
<a name="l06755"></a>06755 }
<a name="l06756"></a>06756 
<a name="l06757"></a>06757 function _enddoc() {
<a name="l06758"></a>06758   $this-&gt;_puthtmlheaders(); <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l06759"></a>06759   $this-&gt;_putpages();
<a name="l06760"></a>06760   $this-&gt;_putresources();
<a name="l06761"></a>06761   <span class="comment">//Info</span>
<a name="l06762"></a>06762   $this-&gt;_newobj();
<a name="l06763"></a>06763   $this-&gt;InfoRoot = $this-&gt;n;
<a name="l06764"></a>06764   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l06765"></a>06765   $this-&gt;_putinfo();
<a name="l06766"></a>06766   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06767"></a>06767   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06768"></a>06768   <span class="comment">// mPDF 4.2.018</span>
<a name="l06769"></a>06769   <span class="comment">// METADATA</span>
<a name="l06770"></a>06770   <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;_putmetadata(); }
<a name="l06771"></a>06771   <span class="comment">// OUTPUTINTENT</span>
<a name="l06772"></a>06772   <span class="keywordflow">if</span> ($this-&gt;PDFA || $this-&gt;ICCProfile) { $this-&gt;_putoutputintent(); }
<a name="l06773"></a>06773 
<a name="l06774"></a>06774   <span class="comment">//Catalog</span>
<a name="l06775"></a>06775   $this-&gt;_newobj();
<a name="l06776"></a>06776   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l06777"></a>06777   $this-&gt;_putcatalog();
<a name="l06778"></a>06778   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06779"></a>06779   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06780"></a>06780   <span class="comment">//Cross-ref</span>
<a name="l06781"></a>06781   $o=strlen($this-&gt;buffer);
<a name="l06782"></a>06782   $this-&gt;_out(<span class="stringliteral">&#39;xref&#39;</span>);
<a name="l06783"></a>06783   $this-&gt;_out(<span class="stringliteral">&#39;0 &#39;</span>.($this-&gt;n+1));
<a name="l06784"></a>06784   $this-&gt;_out(<span class="stringliteral">&#39;0000000000 65535 f &#39;</span>);
<a name="l06785"></a>06785   <span class="keywordflow">for</span>($i=1; $i &lt;= $this-&gt;n ; $i++)
<a name="l06786"></a>06786     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%010d 00000 n &#39;</span>,$this-&gt;offsets[$i]));
<a name="l06787"></a>06787   <span class="comment">//Trailer</span>
<a name="l06788"></a>06788   $this-&gt;_out(<span class="stringliteral">&#39;trailer&#39;</span>);
<a name="l06789"></a>06789   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l06790"></a>06790   $this-&gt;_puttrailer();
<a name="l06791"></a>06791   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06792"></a>06792   $this-&gt;_out(<span class="stringliteral">&#39;startxref&#39;</span>);
<a name="l06793"></a>06793   $this-&gt;_out($o);
<a name="l06794"></a>06794   <span class="comment">// mPDF 4.2.010</span>
<a name="l06795"></a>06795   $this-&gt;buffer .= <span class="stringliteral">&#39;%%EOF&#39;</span>;
<a name="l06796"></a>06796   $this-&gt;state=3;
<a name="l06797"></a>06797 }
<a name="l06798"></a>06798 
<a name="l06799"></a>06799 <span class="comment">// mPDF 4.2  pagesel, $newformat [4.2.024]</span>
<a name="l06800"></a>06800 function _beginpage($orientation,$mgl=<span class="stringliteral">&#39;&#39;</span>,$mgr=<span class="stringliteral">&#39;&#39;</span>,$mgt=<span class="stringliteral">&#39;&#39;</span>,$mgb=<span class="stringliteral">&#39;&#39;</span>,$mgh=<span class="stringliteral">&#39;&#39;</span>,$mgf=<span class="stringliteral">&#39;&#39;</span>,$ohname=<span class="stringliteral">&#39;&#39;</span>,$ehname=<span class="stringliteral">&#39;&#39;</span>,$ofname=<span class="stringliteral">&#39;&#39;</span>,$efname=<span class="stringliteral">&#39;&#39;</span>,$ohvalue=0,$ehvalue=0,$ofvalue=0,$efvalue=0,$pagesel=<span class="stringliteral">&#39;&#39;</span>,$newformat=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l06801"></a>06801   $this-&gt;page++;
<a name="l06802"></a>06802   $this-&gt;pages[$this-&gt;page]=<span class="stringliteral">&#39;&#39;</span>;
<a name="l06803"></a>06803   $this-&gt;state=2;
<a name="l06804"></a>06804   $resetHTMLHeadersrequired = <span class="keyword">false</span>;
<a name="l06805"></a>06805 
<a name="l06806"></a>06806   <span class="comment">// mPDF 4.2.024</span>
<a name="l06807"></a>06807   <span class="keywordflow">if</span> ($newformat) { $this-&gt;_setPageSize($newformat, $orientation); }
<a name="l06808"></a>06808   <span class="comment">// Paged media (page-box)</span>
<a name="l06809"></a>06809   <span class="comment">// mPDF 4.2</span>
<a name="l06810"></a>06810   <span class="keywordflow">if</span> ($pagesel || (isset($this-&gt;page_box[<span class="stringliteral">&#39;using&#39;</span>]) &amp;&amp; $this-&gt;page_box[<span class="stringliteral">&#39;using&#39;</span>])) {
<a name="l06811"></a>06811     <span class="keywordflow">if</span> ($pagesel || $this-&gt;page==1) { $first = <span class="keyword">true</span>; }
<a name="l06812"></a>06812     <span class="keywordflow">else</span> { $first = <span class="keyword">false</span>; }
<a name="l06813"></a>06813     <span class="keywordflow">if</span> ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page % 2==0)) { $oddEven = <span class="charliteral">&#39;E&#39;</span>; }
<a name="l06814"></a>06814     <span class="keywordflow">else</span> { $oddEven = <span class="charliteral">&#39;O&#39;</span>; }
<a name="l06815"></a>06815     <span class="keywordflow">if</span> ($pagesel) { $psel = $pagesel; }
<a name="l06816"></a>06816     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>]) { $psel = $this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>]; }
<a name="l06817"></a>06817     <span class="keywordflow">else</span> { $psel = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l06818"></a>06818     list($orientation,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$hname,$fname,$bg,$resetpagenum,$pagenumstyle,$suppress,$marks,$newformat) = $this-&gt;SetPagedMediaCSS($psel, $first, $oddEven);
<a name="l06819"></a>06819 
<a name="l06820"></a>06820     <span class="keywordflow">if</span> ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page % 2==0)) { 
<a name="l06821"></a>06821       <span class="keywordflow">if</span> ($hname) { $ehvalue = 1; $ehname = $hname; } <span class="keywordflow">else</span> { $ehvalue = -1; }
<a name="l06822"></a>06822       <span class="keywordflow">if</span> ($fname) { $efvalue = 1; $efname = $fname; } <span class="keywordflow">else</span> { $efvalue = -1; }
<a name="l06823"></a>06823     }
<a name="l06824"></a>06824     <span class="keywordflow">else</span> { 
<a name="l06825"></a>06825       <span class="keywordflow">if</span> ($hname) { $ohvalue = 1; $ohname = $hname; } <span class="keywordflow">else</span> { $ohvalue = -1; }
<a name="l06826"></a>06826       <span class="keywordflow">if</span> ($fname) { $ofvalue = 1; $ofname = $fname; } <span class="keywordflow">else</span> { $ofvalue = -1; }
<a name="l06827"></a>06827     }
<a name="l06828"></a>06828     <span class="keywordflow">if</span> ($resetpagenum || $pagenumstyle || $suppress) {
<a name="l06829"></a>06829       $this-&gt;PageNumSubstitutions[] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;($this-&gt;page), <span class="stringliteral">&#39;reset&#39;</span>=&gt; $resetpagenum, <span class="stringliteral">&#39;type&#39;</span>=&gt;$pagenumstyle, <span class="stringliteral">&#39;suppress&#39;</span>=&gt;$suppress);
<a name="l06830"></a>06830     }
<a name="l06831"></a>06831       <span class="comment">// PAGED MEDIA - CROP / CROSS MARKS from @PAGE</span>
<a name="l06832"></a>06832     $this-&gt;show_marks = $marks;
<a name="l06833"></a>06833 
<a name="l06834"></a>06834     <span class="comment">// Background color</span>
<a name="l06835"></a>06835     <span class="keywordflow">if</span> (isset($bg[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>])) {
<a name="l06836"></a>06836       $cor = $this-&gt;ConvertColor($bg[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]);
<a name="l06837"></a>06837       <span class="keywordflow">if</span> ($cor) { 
<a name="l06838"></a>06838         $this-&gt;bodyBackgroundColor = $cor; 
<a name="l06839"></a>06839       }
<a name="l06840"></a>06840     }
<a name="l06841"></a>06841     <span class="keywordflow">else</span> { $this-&gt;bodyBackgroundColor = <span class="keyword">false</span>; } <span class="comment">// mPDF 4.2</span>
<a name="l06842"></a>06842 
<a name="l06843"></a>06843     <span class="comment">// Tiling Patterns</span>
<a name="l06844"></a>06844     <span class="keywordflow">if</span> (isset($bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) &amp;&amp; $bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) {  <span class="comment">// mPDF 4.3.011</span>
<a name="l06845"></a>06845       $file = $bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>];
<a name="l06846"></a>06846       $sizesarray = $this-&gt;Image($file,0,0,0,0,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);  <span class="comment">// mPDF 4.3.032</span>
<a name="l06847"></a>06847       <span class="keywordflow">if</span> (isset($sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>])) {
<a name="l06848"></a>06848         $image_id = $sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>];
<a name="l06849"></a>06849         $orig_w = $sizesarray[<span class="stringliteral">&#39;WIDTH&#39;</span>]*$this-&gt;k;    <span class="comment">// in user units i.e. mm</span>
<a name="l06850"></a>06850         $orig_h = $sizesarray[<span class="stringliteral">&#39;HEIGHT&#39;</span>]*$this-&gt;k;   <span class="comment">// (using $this-&gt;img_dpi)</span>
<a name="l06851"></a>06851         $x_repeat = <span class="keyword">true</span>;
<a name="l06852"></a>06852         $y_repeat = <span class="keyword">true</span>;
<a name="l06853"></a>06853         <span class="keywordflow">if</span> ($bg[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $bg[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-x&#39;</span>) { $y_repeat = <span class="keyword">false</span>; } 
<a name="l06854"></a>06854         <span class="keywordflow">if</span> ($bg[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $bg[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-y&#39;</span>) { $x_repeat = <span class="keyword">false</span>; }
<a name="l06855"></a>06855         $x_pos = 0;
<a name="l06856"></a>06856         $y_pos = 0;
<a name="l06857"></a>06857         <span class="keywordflow">if</span> ($bg[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]) { 
<a name="l06858"></a>06858           $ppos = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$bg[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]);
<a name="l06859"></a>06859           $x_pos = $ppos[0];
<a name="l06860"></a>06860           $y_pos = $ppos[1];
<a name="l06861"></a>06861           <span class="keywordflow">if</span> (!stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $x_pos = $this-&gt;ConvertSize($x_pos ,$this-&gt;pgwidth,$this-&gt;FontSize); }
<a name="l06862"></a>06862           <span class="keywordflow">if</span> (!stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $y_pos = $this-&gt;ConvertSize($y_pos ,$this-&gt;pgwidth,$this-&gt;FontSize); }
<a name="l06863"></a>06863         }
<a name="l06864"></a>06864         <span class="comment">// mPDF 4.3.015</span>
<a name="l06865"></a>06865         <span class="keywordflow">if</span> (isset($bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>])) { $resize = $bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>]; }
<a name="l06866"></a>06866         <span class="keywordflow">else</span> { $resize = 0; }
<a name="l06867"></a>06867         <span class="comment">// mPDF 4.3.017</span>
<a name="l06868"></a>06868         <span class="keywordflow">if</span> (isset($bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>])) { $opacity = $bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>]; }
<a name="l06869"></a>06869         <span class="keywordflow">else</span> { $opacity = 1; }
<a name="l06870"></a>06870         $this-&gt;bodyBackgroundImage = array(<span class="stringliteral">&#39;image_id&#39;</span>=&gt;$image_id, <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$x_pos, <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$y_pos, <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat, <span class="stringliteral">&#39;resize&#39;</span>=&gt;$resize, <span class="stringliteral">&#39;opacity&#39;</span>=&gt;$opacity);  <span class="comment">// mPDF 4.3.015  4.3.017</span>
<a name="l06871"></a>06871         <span class="comment">// $this-&gt;bodyBackgroundGradient = false; // mPDF 4.2</span>
<a name="l06872"></a>06872       }
<a name="l06873"></a>06873     }
<a name="l06874"></a>06874     <span class="keywordflow">else</span> { $this-&gt;bodyBackgroundImage = <span class="keyword">false</span>; } <span class="comment">// mPDF 4.2</span>
<a name="l06875"></a>06875 
<a name="l06876"></a>06876     $this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>] = $psel;
<a name="l06877"></a>06877     $this-&gt;page_box[<span class="stringliteral">&#39;using&#39;</span>] = <span class="keyword">true</span>;
<a name="l06878"></a>06878   }
<a name="l06879"></a>06879 
<a name="l06880"></a>06880   <span class="comment">//Page orientation</span>
<a name="l06881"></a>06881   <span class="keywordflow">if</span>(!$orientation)
<a name="l06882"></a>06882     $orientation=$this-&gt;DefOrientation;
<a name="l06883"></a>06883   <span class="keywordflow">else</span> {
<a name="l06884"></a>06884     $orientation=strtoupper(substr($orientation,0,1));
<a name="l06885"></a>06885     <span class="keywordflow">if</span>($orientation!=$this-&gt;DefOrientation)
<a name="l06886"></a>06886       $this-&gt;OrientationChanges[$this-&gt;page]=<span class="keyword">true</span>;
<a name="l06887"></a>06887   }
<a name="l06888"></a>06888   <span class="keywordflow">if</span>($orientation!=$this-&gt;CurOrientation || $newformat) { <span class="comment">// mPDF 4.2.024</span>
<a name="l06889"></a>06889 
<a name="l06890"></a>06890     <span class="comment">//Change orientation</span>
<a name="l06891"></a>06891     <span class="keywordflow">if</span>($orientation==<span class="charliteral">&#39;P&#39;</span>) {
<a name="l06892"></a>06892       $this-&gt;wPt=$this-&gt;fwPt;
<a name="l06893"></a>06893       $this-&gt;hPt=$this-&gt;fhPt;
<a name="l06894"></a>06894       $this-&gt;w=$this-&gt;fw;
<a name="l06895"></a>06895       $this-&gt;h=$this-&gt;fh;
<a name="l06896"></a>06896        <span class="keywordflow">if</span> (($this-&gt;forcePortraitHeaders || $this-&gt;forcePortraitMargins) &amp;&amp; $this-&gt;DefOrientation==<span class="charliteral">&#39;P&#39;</span>) {
<a name="l06897"></a>06897       $this-&gt;tMargin = $this-&gt;orig_tMargin;
<a name="l06898"></a>06898       $this-&gt;bMargin = $this-&gt;orig_bMargin;
<a name="l06899"></a>06899       $this-&gt;DeflMargin = $this-&gt;orig_lMargin;
<a name="l06900"></a>06900       $this-&gt;DefrMargin = $this-&gt;orig_rMargin;
<a name="l06901"></a>06901       $this-&gt;margin_header = $this-&gt;orig_hMargin;
<a name="l06902"></a>06902       $this-&gt;margin_footer = $this-&gt;orig_fMargin;
<a name="l06903"></a>06903        }
<a name="l06904"></a>06904        <span class="keywordflow">else</span> { $resetHTMLHeadersrequired = <span class="keyword">true</span>; } <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l06905"></a>06905     }
<a name="l06906"></a>06906     <span class="keywordflow">else</span> {
<a name="l06907"></a>06907       $this-&gt;wPt=$this-&gt;fhPt;
<a name="l06908"></a>06908       $this-&gt;hPt=$this-&gt;fwPt;
<a name="l06909"></a>06909       $this-&gt;w=$this-&gt;fh;
<a name="l06910"></a>06910       $this-&gt;h=$this-&gt;fw;
<a name="l06911"></a>06911        <span class="keywordflow">if</span> (($this-&gt;forcePortraitHeaders || $this-&gt;forcePortraitMargins) &amp;&amp; $this-&gt;DefOrientation==<span class="charliteral">&#39;P&#39;</span>) {
<a name="l06912"></a>06912       $this-&gt;tMargin = $this-&gt;orig_lMargin;
<a name="l06913"></a>06913       $this-&gt;bMargin = $this-&gt;orig_rMargin;
<a name="l06914"></a>06914       $this-&gt;DeflMargin = $this-&gt;orig_bMargin;
<a name="l06915"></a>06915       $this-&gt;DefrMargin = $this-&gt;orig_tMargin;
<a name="l06916"></a>06916       $this-&gt;margin_header = $this-&gt;orig_hMargin;
<a name="l06917"></a>06917       $this-&gt;margin_footer = $this-&gt;orig_fMargin;
<a name="l06918"></a>06918        }
<a name="l06919"></a>06919        <span class="keywordflow">else</span> { $resetHTMLHeadersrequired = <span class="keyword">true</span>; } <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l06920"></a>06920 
<a name="l06921"></a>06921     }
<a name="l06922"></a>06922     $this-&gt;CurOrientation=$orientation;
<a name="l06923"></a>06923     $this-&gt;ResetMargins();
<a name="l06924"></a>06924     $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l06925"></a>06925     $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin;
<a name="l06926"></a>06926   }
<a name="l06927"></a>06927 
<a name="l06928"></a>06928   $this-&gt;pageDim[$this-&gt;page][<span class="charliteral">&#39;w&#39;</span>]=$this-&gt;w ;
<a name="l06929"></a>06929   $this-&gt;pageDim[$this-&gt;page][<span class="charliteral">&#39;h&#39;</span>]=$this-&gt;h ;
<a name="l06930"></a>06930   <span class="comment">// If Page Margins are re-defined</span>
<a name="l06931"></a>06931   <span class="comment">// strlen()&gt;0 is used to pick up (integer) 0, (string) &#39;0&#39;, or set value</span>
<a name="l06932"></a>06932   <span class="keywordflow">if</span> ((strlen($mgl)&gt;0 &amp;&amp; $this-&gt;DeflMargin != $mgl) || (strlen($mgr)&gt;0 &amp;&amp; $this-&gt;DefrMargin != $mgr) || (strlen($mgt)&gt;0 &amp;&amp; $this-&gt;tMargin != $mgt) || (strlen($mgb)&gt;0 &amp;&amp; $this-&gt;bMargin != $mgb) || (strlen($mgh)&gt;0 &amp;&amp; $this-&gt;margin_header!=$mgh) || (strlen($mgf)&gt;0 &amp;&amp; $this-&gt;margin_footer!=$mgf)) {
<a name="l06933"></a>06933     <span class="keywordflow">if</span> (strlen($mgl)&gt;0)  $this-&gt;DeflMargin = $mgl;
<a name="l06934"></a>06934     <span class="keywordflow">if</span> (strlen($mgr)&gt;0)  $this-&gt;DefrMargin = $mgr;
<a name="l06935"></a>06935     <span class="keywordflow">if</span> (strlen($mgt)&gt;0)  $this-&gt;tMargin = $mgt;
<a name="l06936"></a>06936     <span class="keywordflow">if</span> (strlen($mgb)&gt;0)  $this-&gt;bMargin = $mgb;
<a name="l06937"></a>06937     <span class="keywordflow">if</span> (strlen($mgh)&gt;0)  $this-&gt;margin_header=$mgh;
<a name="l06938"></a>06938     <span class="keywordflow">if</span> (strlen($mgf)&gt;0)  $this-&gt;margin_footer=$mgf;
<a name="l06939"></a>06939     $this-&gt;ResetMargins();
<a name="l06940"></a>06940     $this-&gt;SetAutoPageBreak($this-&gt;autoPageBreak,$this-&gt;bMargin);
<a name="l06941"></a>06941     $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l06942"></a>06942     $resetHTMLHeadersrequired = <span class="keyword">true</span>;   <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l06943"></a>06943   }
<a name="l06944"></a>06944 
<a name="l06945"></a>06945   <span class="comment">// mPDF 4.2 Moved page-box stuff</span>
<a name="l06946"></a>06946   <span class="comment">// Moved in v1.4 to allow for changes in page orientation (Sets lMargin, rMargin, MarginCorrection)</span>
<a name="l06947"></a>06947   $this-&gt;ResetMargins();
<a name="l06948"></a>06948   $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;  <span class="comment">// mPDF 4.3.007C</span>
<a name="l06949"></a>06949   $this-&gt;SetAutoPageBreak($this-&gt;autoPageBreak,$this-&gt;bMargin);
<a name="l06950"></a>06950 
<a name="l06951"></a>06951   <span class="comment">// Reset column top margin</span>
<a name="l06952"></a>06952   $this-&gt;y0 = $this-&gt;tMargin;
<a name="l06953"></a>06953 
<a name="l06954"></a>06954   $this-&gt;x=$this-&gt;lMargin;
<a name="l06955"></a>06955   $this-&gt;y=$this-&gt;tMargin;
<a name="l06956"></a>06956   $this-&gt;FontFamily=<span class="stringliteral">&#39;&#39;</span>;
<a name="l06957"></a>06957 
<a name="l06958"></a>06958 
<a name="l06959"></a>06959   <span class="comment">// HEADERS AND FOOTERS</span>
<a name="l06960"></a>06960   <span class="keywordflow">if</span> ($ohvalue&lt;0 || strtoupper($ohvalue)==<span class="stringliteral">&#39;OFF&#39;</span>) { 
<a name="l06961"></a>06961     $this-&gt;HTMLHeader = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l06962"></a>06962     $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); 
<a name="l06963"></a>06963     $resetHTMLHeadersrequired = <span class="keyword">true</span>; <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l06964"></a>06964   }
<a name="l06965"></a>06965   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($ohname &amp;&amp; $ohvalue&gt;0) {
<a name="l06966"></a>06966      <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$ohname,$n)) {
<a name="l06967"></a>06967     <span class="keywordflow">if</span> (isset($this-&gt;pageHTMLheaders[$n[1]])) { $this-&gt;HTMLHeader = $this-&gt;pageHTMLheaders[$n[1]]; }
<a name="l06968"></a>06968     <span class="keywordflow">else</span> { $this-&gt;HTMLHeader = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l06969"></a>06969     $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); 
<a name="l06970"></a>06970     $resetHTMLHeadersrequired = <span class="keyword">true</span>;
<a name="l06971"></a>06971      }
<a name="l06972"></a>06972      <span class="keywordflow">else</span> {
<a name="l06973"></a>06973     <span class="keywordflow">if</span> (isset($this-&gt;pageheaders[$ohname])) { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pageheaders[$ohname]; } 
<a name="l06974"></a>06974     <span class="keywordflow">else</span> { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); }
<a name="l06975"></a>06975     $this-&gt;HTMLHeader = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l06976"></a>06976     $resetHTMLHeadersrequired = <span class="keyword">false</span>;
<a name="l06977"></a>06977      }
<a name="l06978"></a>06978   }
<a name="l06979"></a>06979 
<a name="l06980"></a>06980   <span class="keywordflow">if</span> ($ehvalue&lt;0 || strtoupper($ehvalue)==<span class="stringliteral">&#39;OFF&#39;</span>) { 
<a name="l06981"></a>06981     $this-&gt;HTMLHeaderE = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l06982"></a>06982     $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); 
<a name="l06983"></a>06983     $resetHTMLHeadersrequired = <span class="keyword">true</span>; <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l06984"></a>06984   }
<a name="l06985"></a>06985   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($ehname &amp;&amp; $ehvalue&gt;0) {
<a name="l06986"></a>06986      <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$ehname,$n)) {
<a name="l06987"></a>06987     <span class="keywordflow">if</span> (isset($this-&gt;pageHTMLheaders[$n[1]])) { $this-&gt;HTMLHeaderE = $this-&gt;pageHTMLheaders[$n[1]]; } 
<a name="l06988"></a>06988     <span class="keywordflow">else</span> { $this-&gt;HTMLHeaderE = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l06989"></a>06989     $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); 
<a name="l06990"></a>06990     $resetHTMLHeadersrequired = <span class="keyword">true</span>;
<a name="l06991"></a>06991      }
<a name="l06992"></a>06992      <span class="keywordflow">else</span> {
<a name="l06993"></a>06993     <span class="keywordflow">if</span> (isset($this-&gt;pageheaders[$ehname])) { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $this-&gt;pageheaders[$ehname]; }
<a name="l06994"></a>06994     <span class="keywordflow">else</span> { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); }
<a name="l06995"></a>06995     $this-&gt;HTMLHeaderE = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l06996"></a>06996     $resetHTMLHeadersrequired = <span class="keyword">false</span>;
<a name="l06997"></a>06997      }
<a name="l06998"></a>06998   }
<a name="l06999"></a>06999 
<a name="l07000"></a>07000   <span class="keywordflow">if</span> ($ofvalue&lt;0 || strtoupper($ofvalue)==<span class="stringliteral">&#39;OFF&#39;</span>) { 
<a name="l07001"></a>07001     $this-&gt;HTMLFooter = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l07002"></a>07002     $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); 
<a name="l07003"></a>07003     $resetHTMLHeadersrequired = <span class="keyword">true</span>; <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l07004"></a>07004   }
<a name="l07005"></a>07005   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($ofname &amp;&amp; $ofvalue&gt;0) {
<a name="l07006"></a>07006      <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$ofname,$n)) {
<a name="l07007"></a>07007     <span class="keywordflow">if</span> (isset($this-&gt;pageHTMLfooters[$n[1]])) { $this-&gt;HTMLFooter = $this-&gt;pageHTMLfooters[$n[1]]; }
<a name="l07008"></a>07008     <span class="keywordflow">else</span> { $this-&gt;HTMLFooter = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l07009"></a>07009     $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); 
<a name="l07010"></a>07010     $resetHTMLHeadersrequired = <span class="keyword">true</span>;
<a name="l07011"></a>07011      }
<a name="l07012"></a>07012      <span class="keywordflow">else</span> {
<a name="l07013"></a>07013     <span class="keywordflow">if</span> (isset($this-&gt;pagefooters[$ofname])) { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pagefooters[$ofname]; }
<a name="l07014"></a>07014     <span class="keywordflow">else</span> { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); }
<a name="l07015"></a>07015     $this-&gt;HTMLFooter = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l07016"></a>07016     $resetHTMLHeadersrequired = <span class="keyword">true</span>;
<a name="l07017"></a>07017      }
<a name="l07018"></a>07018   }
<a name="l07019"></a>07019 
<a name="l07020"></a>07020   <span class="keywordflow">if</span> ($efvalue&lt;0 || strtoupper($efvalue)==<span class="stringliteral">&#39;OFF&#39;</span>) { 
<a name="l07021"></a>07021     $this-&gt;HTMLFooterE = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l07022"></a>07022     $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); 
<a name="l07023"></a>07023     $resetHTMLHeadersrequired = <span class="keyword">true</span>; <span class="comment">// *HTMLHEADERS-FOOTERS*</span>
<a name="l07024"></a>07024   }
<a name="l07025"></a>07025   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($efname &amp;&amp; $efvalue&gt;0) {
<a name="l07026"></a>07026      <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$efname,$n)) {
<a name="l07027"></a>07027     <span class="keywordflow">if</span> (isset($this-&gt;pageHTMLfooters[$n[1]])) { $this-&gt;HTMLFooterE = $this-&gt;pageHTMLfooters[$n[1]]; } 
<a name="l07028"></a>07028     <span class="keywordflow">else</span> { $this-&gt;HTMLFooterE = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l07029"></a>07029     $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); 
<a name="l07030"></a>07030     $resetHTMLHeadersrequired = <span class="keyword">true</span>;
<a name="l07031"></a>07031      }
<a name="l07032"></a>07032      <span class="keywordflow">else</span> {
<a name="l07033"></a>07033     <span class="keywordflow">if</span> (isset($this-&gt;pagefooters[$efname])) { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $this-&gt;pagefooters[$efname]; } 
<a name="l07034"></a>07034     <span class="keywordflow">else</span> { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); }
<a name="l07035"></a>07035     $this-&gt;HTMLFooterE = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l07036"></a>07036     $resetHTMLHeadersrequired = <span class="keyword">true</span>;
<a name="l07037"></a>07037      }
<a name="l07038"></a>07038   }
<a name="l07039"></a>07039 
<a name="l07040"></a>07040   <span class="keywordflow">if</span> ($resetHTMLHeadersrequired) {
<a name="l07041"></a>07041     $this-&gt;SetHTMLHeader($this-&gt;HTMLHeader );
<a name="l07042"></a>07042     $this-&gt;SetHTMLHeader($this-&gt;HTMLHeaderE ,<span class="charliteral">&#39;E&#39;</span>);
<a name="l07043"></a>07043     $this-&gt;SetHTMLFooter($this-&gt;HTMLFooter );
<a name="l07044"></a>07044     $this-&gt;SetHTMLFooter($this-&gt;HTMLFooterE ,<span class="charliteral">&#39;E&#39;</span>);
<a name="l07045"></a>07045   }
<a name="l07046"></a>07046 
<a name="l07047"></a>07047   <span class="comment">// mPDF 4.0</span>
<a name="l07048"></a>07048   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l07049"></a>07049     $this-&gt;_setAutoHeaderHeight($this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>], $this-&gt;HTMLHeaderE);
<a name="l07050"></a>07050     $this-&gt;_setAutoFooterHeight($this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>], $this-&gt;HTMLFooterE);
<a name="l07051"></a>07051   }
<a name="l07052"></a>07052   <span class="keywordflow">else</span> {  <span class="comment">// ODD or DEFAULT</span>
<a name="l07053"></a>07053     $this-&gt;_setAutoHeaderHeight($this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>], $this-&gt;HTMLHeader);
<a name="l07054"></a>07054     $this-&gt;_setAutoFooterHeight($this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>], $this-&gt;HTMLFooter);
<a name="l07055"></a>07055   }
<a name="l07056"></a>07056   <span class="comment">// Reset column top margin</span>
<a name="l07057"></a>07057   $this-&gt;y0 = $this-&gt;tMargin;
<a name="l07058"></a>07058 
<a name="l07059"></a>07059   $this-&gt;x=$this-&gt;lMargin;
<a name="l07060"></a>07060   $this-&gt;y=$this-&gt;tMargin;
<a name="l07061"></a>07061 }
<a name="l07062"></a>07062 
<a name="l07063"></a>07063 
<a name="l07064"></a>07064 <span class="comment">// mPDF 4.0</span>
<a name="l07065"></a>07065 function _setAutoHeaderHeight(&amp;$det, &amp;$htmlh) {
<a name="l07066"></a>07066   <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin==<span class="stringliteral">&#39;pad&#39;</span>) {
<a name="l07067"></a>07067   <span class="keywordflow">if</span> ($htmlh[<span class="charliteral">&#39;h&#39;</span>]) { $h = $htmlh[<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l07068"></a>07068   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($det) { $h = $this-&gt;_getHFHeight($det,<span class="charliteral">&#39;H&#39;</span>); }
<a name="l07069"></a>07069   <span class="keywordflow">else</span> { $h = 0; }
<a name="l07070"></a>07070   $this-&gt;tMargin = $this-&gt;margin_header + $h + $this-&gt;orig_tMargin;
<a name="l07071"></a>07071   }
<a name="l07072"></a>07072   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin==<span class="stringliteral">&#39;stretch&#39;</span>) {
<a name="l07073"></a>07073   <span class="keywordflow">if</span> ($htmlh[<span class="charliteral">&#39;h&#39;</span>]) { $h = $htmlh[<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l07074"></a>07074   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($det) { $h = $this-&gt;_getHFHeight($det,<span class="charliteral">&#39;H&#39;</span>); }
<a name="l07075"></a>07075   <span class="keywordflow">else</span> { $h = 0; }
<a name="l07076"></a>07076   $this-&gt;tMargin = max($this-&gt;orig_tMargin, $this-&gt;margin_header + $h + $this-&gt;autoMarginPadding);
<a name="l07077"></a>07077   }
<a name="l07078"></a>07078 }
<a name="l07079"></a>07079 
<a name="l07080"></a>07080 <span class="comment">// mPDF 4.0</span>
<a name="l07081"></a>07081 function _setAutoFooterHeight(&amp;$det, &amp;$htmlf) {
<a name="l07082"></a>07082   <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin==<span class="stringliteral">&#39;pad&#39;</span>) {
<a name="l07083"></a>07083   <span class="keywordflow">if</span> ($htmlf[<span class="charliteral">&#39;h&#39;</span>]) { $h = $htmlf[<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l07084"></a>07084   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($det) { $h = $this-&gt;_getHFHeight($det,<span class="charliteral">&#39;F&#39;</span>); }
<a name="l07085"></a>07085   <span class="keywordflow">else</span> { $h = 0; }
<a name="l07086"></a>07086   $this-&gt;bMargin = $this-&gt;margin_footer + $h + $this-&gt;orig_bMargin;
<a name="l07087"></a>07087   $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin ;
<a name="l07088"></a>07088   }
<a name="l07089"></a>07089   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin==<span class="stringliteral">&#39;stretch&#39;</span>) {
<a name="l07090"></a>07090   <span class="keywordflow">if</span> ($htmlf[<span class="charliteral">&#39;h&#39;</span>]) { $h = $htmlf[<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l07091"></a>07091   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($det) { $h = $this-&gt;_getHFHeight($det,<span class="charliteral">&#39;F&#39;</span>); }
<a name="l07092"></a>07092   <span class="keywordflow">else</span> { $h = 0; }
<a name="l07093"></a>07093   $this-&gt;bMargin = max($this-&gt;orig_bMargin, $this-&gt;margin_footer + $h + $this-&gt;autoMarginPadding);
<a name="l07094"></a>07094   $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin ;
<a name="l07095"></a>07095   }
<a name="l07096"></a>07096 }
<a name="l07097"></a>07097 <span class="comment">// mPDF 4.0</span>
<a name="l07098"></a>07098 function _getHFHeight(&amp;$det,$end) {
<a name="l07099"></a>07099   $h = 0;
<a name="l07100"></a>07100   <span class="keywordflow">if</span>(count($det)) {
<a name="l07101"></a>07101     <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;L&#39;</span>,<span class="charliteral">&#39;C&#39;</span>,<span class="charliteral">&#39;R&#39;</span>) AS $pos) {
<a name="l07102"></a>07102       <span class="keywordflow">if</span> (isset($det[$pos][<span class="stringliteral">&#39;content&#39;</span>]) &amp;&amp; $det[$pos][<span class="stringliteral">&#39;content&#39;</span>]) {
<a name="l07103"></a>07103       <span class="keywordflow">if</span> (isset($det[$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) &amp;&amp; $det[$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) { $hfsz = $det[$pos][<span class="stringliteral">&#39;font-size&#39;</span>]; }
<a name="l07104"></a>07104       <span class="keywordflow">else</span> { $hfsz = $this-&gt;default_font_size; }
<a name="l07105"></a>07105       $h = max($h,$hfsz/$this-&gt;k);
<a name="l07106"></a>07106       }
<a name="l07107"></a>07107     }
<a name="l07108"></a>07108     <span class="keywordflow">if</span> ($det[<span class="stringliteral">&#39;line&#39;</span>] &amp;&amp; $end==<span class="charliteral">&#39;H&#39;</span>) { $h += $h/$this-&gt;k*$this-&gt;header_line_spacing; }
<a name="l07109"></a>07109     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($det[<span class="stringliteral">&#39;line&#39;</span>] &amp;&amp; $end==<span class="charliteral">&#39;F&#39;</span>) { $h += $h/$this-&gt;k*$this-&gt;footer_line_spacing; }
<a name="l07110"></a>07110     }
<a name="l07111"></a>07111   <span class="keywordflow">return</span> $h;
<a name="l07112"></a>07112 }
<a name="l07113"></a>07113 
<a name="l07114"></a>07114 
<a name="l07115"></a>07115 function _endpage() {
<a name="l07116"></a>07116   $this-&gt;printfloatbuffer();
<a name="l07117"></a>07117 
<a name="l07118"></a>07118   <span class="comment">//End of page contents</span>
<a name="l07119"></a>07119   $this-&gt;state=1;
<a name="l07120"></a>07120 }
<a name="l07121"></a>07121 
<a name="l07122"></a>07122 <span class="comment">// mPDF 4.2.006</span>
<a name="l07123"></a>07123 function _newobj($obj_id=<span class="keyword">false</span>,$onlynewobj=<span class="keyword">false</span>) {
<a name="l07124"></a>07124     <span class="keywordflow">if</span> (!$obj_id) {
<a name="l07125"></a>07125       $obj_id = ++$this-&gt;n;
<a name="l07126"></a>07126     }
<a name="l07127"></a>07127     <span class="comment">//Begin a new object</span>
<a name="l07128"></a>07128     <span class="keywordflow">if</span> (!$onlynewobj) {
<a name="l07129"></a>07129       $this-&gt;offsets[$obj_id] = strlen($this-&gt;buffer);
<a name="l07130"></a>07130       $this-&gt;_out($obj_id.<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l07131"></a>07131       $this-&gt;_current_obj_id = $obj_id; <span class="comment">// for later use with encryption</span>
<a name="l07132"></a>07132     }
<a name="l07133"></a>07133 }
<a name="l07134"></a>07134 
<a name="l07135"></a>07135 function _dounderline($x,$y,$txt) {
<a name="l07136"></a>07136   <span class="comment">// mPDF 4.0 changed to line instead of rectangle</span>
<a name="l07137"></a>07137   <span class="comment">// Now print line exactly where $y secifies - called from Text() and Cell() - adjust  position there</span>
<a name="l07138"></a>07138   <span class="comment">// WORD SPACING</span>
<a name="l07139"></a>07139       $w =($this-&gt;GetStringWidth($txt)*$this-&gt;k) + ($this-&gt;charspacing * mb_strlen( $txt, $this-&gt;mb_enc )) 
<a name="l07140"></a>07140      + ( $this-&gt;ws * mb_substr_count( $txt, <span class="charliteral">&#39; &#39;</span>, $this-&gt;mb_enc ));
<a name="l07141"></a>07141   <span class="comment">//Draw a line</span>
<a name="l07142"></a>07142   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S&#39;</span>,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,($x*$this-&gt;k)+$w,($this-&gt;h-$y)*$this-&gt;k);
<a name="l07143"></a>07143 }
<a name="l07144"></a>07144 
<a name="l07145"></a>07145 
<a name="l07146"></a>07146 <span class="comment">// mPDF 4.2</span>
<a name="l07147"></a>07147 function _imageError($file, $firsttime, $msg) {
<a name="l07148"></a>07148   <span class="comment">// Save re-trying image URL&#39;s which have already failed</span>
<a name="l07149"></a>07149   $this-&gt;failedimages[$file] = <span class="keyword">true</span>;
<a name="l07150"></a>07150   <span class="keywordflow">if</span> ($firsttime &amp;&amp; ($this-&gt;showImageErrors || $this-&gt;debug)) {
<a name="l07151"></a>07151       $this-&gt;Error(<span class="stringliteral">&quot;IMAGE Error (&quot;</span>.$file.<span class="stringliteral">&quot;): &quot;</span>.$msg);
<a name="l07152"></a>07152   }
<a name="l07153"></a>07153   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07154"></a>07154 }
<a name="l07155"></a>07155 
<a name="l07156"></a>07156 
<a name="l07157"></a>07157 <span class="comment">// mPDF 4.2</span>
<a name="l07158"></a>07158 function _getImage(&amp;$file, $firsttime=<span class="keyword">true</span>, $allowvector=<span class="keyword">true</span>, $orig_srcpath=<span class="keyword">false</span>) { <span class="comment">// mPDF 4.2.029 / 4.3.012</span>
<a name="l07159"></a>07159   <span class="comment">// firsttime i.e. whether to add to this-&gt;images - use false when calling iteratively</span>
<a name="l07160"></a>07160 
<a name="l07161"></a>07161   <span class="comment">// Image Data passed directly as var:varname</span>
<a name="l07162"></a>07162   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/var:\s*(.*)/&#39;</span>,$file, $v)) { 
<a name="l07163"></a>07163     $data = $this-&gt;$v[1];
<a name="l07164"></a>07164     $file = md5($data);
<a name="l07165"></a>07165   }
<a name="l07166"></a>07166   <span class="comment">// mPDF 4.2.016</span>
<a name="l07167"></a>07167   <span class="keywordflow">if</span> ($firsttime &amp;&amp; preg_match(<span class="stringliteral">&#39;/(.*\/)([^\/]*)/&#39;</span>,$file,$fm)) {
<a name="l07168"></a>07168     <span class="keywordflow">if</span> (strlen($fm[2])) { $file = $fm[1].preg_replace(<span class="stringliteral">&#39;/ /&#39;</span>,<span class="stringliteral">&#39;%20&#39;</span>,$fm[2]); }
<a name="l07169"></a>07169   }
<a name="l07170"></a>07170   <span class="comment">// mPDF 4.2.029</span>
<a name="l07171"></a>07171   <span class="keywordflow">if</span> ($orig_srcpath &amp;&amp; isset($this-&gt;images[$orig_srcpath])) { $file=$orig_srcpath; <span class="keywordflow">return</span> $this-&gt;images[$orig_srcpath]; }
<a name="l07172"></a>07172   <span class="keywordflow">if</span> (isset($this-&gt;images[$file])) { <span class="keywordflow">return</span> $this-&gt;images[$file]; }
<a name="l07173"></a>07173   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($orig_srcpath &amp;&amp; isset($this-&gt;formobjects[$orig_srcpath])) { $file=$orig_srcpath; <span class="keywordflow">return</span> $this-&gt;formobjects[$file]; }
<a name="l07174"></a>07174   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;formobjects[$file])) { <span class="keywordflow">return</span> $this-&gt;formobjects[$file]; }
<a name="l07175"></a>07175   <span class="comment">// Save re-trying image URL&#39;s which have already failed</span>
<a name="l07176"></a>07176   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($firsttime &amp;&amp; isset($this-&gt;failedimages[$file])) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;&#39;</span>); } 
<a name="l07177"></a>07177   <span class="keywordflow">if</span> (!$data) {
<a name="l07178"></a>07178     $type = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07179"></a>07179     $data = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07180"></a>07180     $mqr=ini_get(<span class="stringliteral">&quot;magic_quotes_runtime&quot;</span>);
<a name="l07181"></a>07181     <span class="keywordflow">if</span> ($mqr) { set_magic_quotes_runtime(0); }
<a name="l07182"></a>07182 
<a name="l07183"></a>07183     <span class="comment">// mPDF 4.2.029</span>
<a name="l07184"></a>07184     <span class="keywordflow">if</span> ($orig_srcpath &amp;&amp; $this-&gt;basepathIsLocal &amp;&amp; $check = @fopen($orig_srcpath,<span class="stringliteral">&quot;rb&quot;</span>)) {
<a name="l07185"></a>07185       fclose($check); 
<a name="l07186"></a>07186       $file=$orig_srcpath;
<a name="l07187"></a>07187       $data = file_get_contents($file);
<a name="l07188"></a>07188       $type = $this-&gt;_imageTypeFromString($data);
<a name="l07189"></a>07189     }
<a name="l07190"></a>07190     <span class="keywordflow">if</span> (!$data &amp;&amp; $check = @fopen($file,<span class="stringliteral">&quot;rb&quot;</span>)) {  <span class="comment">// mPDF 4.2.029</span>
<a name="l07191"></a>07191       fclose($check); 
<a name="l07192"></a>07192       $data = file_get_contents($file);
<a name="l07193"></a>07193       $type = $this-&gt;_imageTypeFromString($data);
<a name="l07194"></a>07194     }
<a name="l07195"></a>07195     <span class="keywordflow">if</span> ((!$data || !$type) &amp;&amp; !ini_get(<span class="stringliteral">&#39;allow_url_fopen&#39;</span>)) {  <span class="comment">// only worth trying if remote file and !ini_get(&#39;allow_url_fopen&#39;)</span>
<a name="l07196"></a>07196       $this-&gt;file_get_contents_by_socket($file, $data); <span class="comment">// needs full url?? even on local (never needed for local)</span>
<a name="l07197"></a>07197       <span class="keywordflow">if</span> ($data) { $type = $this-&gt;_imageTypeFromString($data); }
<a name="l07198"></a>07198     }
<a name="l07199"></a>07199     <span class="keywordflow">if</span> ((!$data || !$type) &amp;&amp; !ini_get(<span class="stringliteral">&#39;allow_url_fopen&#39;</span>) &amp;&amp; function_exists(<span class="stringliteral">&quot;curl_init&quot;</span>)) {
<a name="l07200"></a>07200       $this-&gt;file_get_contents_by_curl($file, $data);   <span class="comment">// needs full url?? even on local (never needed for local)</span>
<a name="l07201"></a>07201       <span class="keywordflow">if</span> ($data) { $type = $this-&gt;_imageTypeFromString($data); }
<a name="l07202"></a>07202     }
<a name="l07203"></a>07203 
<a name="l07204"></a>07204     <span class="keywordflow">if</span> ($mqr) { set_magic_quotes_runtime($mqr); }
<a name="l07205"></a>07205   }
<a name="l07206"></a>07206   <span class="keywordflow">if</span> (!$data) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Could not find image file&#39;</span>); }
<a name="l07207"></a>07207   <span class="keywordflow">if</span> (!$type) { $type = $this-&gt;_imageTypeFromString($data); }
<a name="l07208"></a>07208   <span class="comment">// mPDF 4.3.013 SVG files</span>
<a name="l07209"></a>07209   <span class="keywordflow">if</span> (($type == <span class="stringliteral">&#39;wmf&#39;</span> || $type == <span class="stringliteral">&#39;svg&#39;</span>) &amp;&amp; !$allowvector) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;WMF or SVG image file not supported in this context&#39;</span>); }
<a name="l07210"></a>07210 
<a name="l07211"></a>07211   <span class="comment">// mPDF 4.3.013 SVG files</span>
<a name="l07212"></a>07212   <span class="comment">// SVG</span>
<a name="l07213"></a>07213   <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;svg&#39;</span>) {
<a name="l07214"></a>07214     <span class="keywordflow">if</span> (!class_exists(<span class="stringliteral">&#39;SVG&#39;</span>)) { include(_MPDF_PATH .<span class="stringliteral">&#39;classes/svg.php&#39;</span>); }
<a name="l07215"></a>07215     $svg = <span class="keyword">new</span> <a class="code" href="classSVG.html">SVG</a>($this);
<a name="l07216"></a>07216     $family=$this-&gt;FontFamily;
<a name="l07217"></a>07217     $style=$this-&gt;FontStyle;
<a name="l07218"></a>07218     $size=$this-&gt;FontSizePt;
<a name="l07219"></a>07219     $info = $svg-&gt;ImageSVG($data);
<a name="l07220"></a>07220     <span class="comment">//Restore font</span>
<a name="l07221"></a>07221     <span class="keywordflow">if</span>($family) $this-&gt;SetFont($family,$style,$size,<span class="keyword">false</span>);
<a name="l07222"></a>07222     <span class="keywordflow">if</span> (!$info) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing SVG file&#39;</span>); }
<a name="l07223"></a>07223     $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;svg&#39;</span>;
<a name="l07224"></a>07224     $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;formobjects)+1;
<a name="l07225"></a>07225     $this-&gt;formobjects[$file]=$info;
<a name="l07226"></a>07226     <span class="keywordflow">return</span> $info;
<a name="l07227"></a>07227   }
<a name="l07228"></a>07228 
<a name="l07229"></a>07229   <span class="comment">// JPEG</span>
<a name="l07230"></a>07230   <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;jpeg&#39;</span> || $type == <span class="stringliteral">&#39;jpg&#39;</span>) {
<a name="l07231"></a>07231     $hdr = $this-&gt;_jpgHeaderFromString($data);
<a name="l07232"></a>07232     <span class="keywordflow">if</span> (!$hdr) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing JPG header&#39;</span>); }
<a name="l07233"></a>07233     $a = $this-&gt;_jpgDataFromHeader($hdr);
<a name="l07234"></a>07234     <span class="comment">// mPDF 4.2.018</span>
<a name="l07235"></a>07235     <span class="keywordflow">if</span> ($a[2] == <span class="stringliteral">&#39;DeviceCMYK&#39;</span> &amp;&amp; $this-&gt;PDFA) { 
<a name="l07236"></a>07236       <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&quot;gd_info&quot;</span>)) { $this-&gt;Error(<span class="stringliteral">&quot;JPG image may not use CMYK color space (&quot;</span>.$file.<span class="stringliteral">&quot;).&quot;</span>); }
<a name="l07237"></a>07237       <span class="keywordflow">if</span> (!$this-&gt;PDFAauto) { $this-&gt;PDFAwarnings[] = <span class="stringliteral">&quot;JPG image may not use CMYK color space - &quot;</span>.$file.<span class="stringliteral">&quot; - (Image converted to RGB. NB This will alter the colour profile of the image.)&quot;</span>; }
<a name="l07238"></a>07238       <span class="comment">// convert to RGB image</span>
<a name="l07239"></a>07239       $im = @imagecreatefromstring($data);
<a name="l07240"></a>07240       <span class="keywordflow">if</span> ($im) {
<a name="l07241"></a>07241         $tempfile = _MPDF_TEMP_PATH.<span class="stringliteral">&#39;_tempImgPNG&#39;</span>.RAND(1,10000).<span class="stringliteral">&#39;.png&#39;</span>; <span class="comment">// mPDF 4.3.007E</span>
<a name="l07242"></a>07242         imageinterlace($im, <span class="keyword">false</span>);
<a name="l07243"></a>07243         $check = @imagepng($im, $tempfile);
<a name="l07244"></a>07244         <span class="keywordflow">if</span> (!$check) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error creating temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) whilst using GD library to parse JPG(CMYK) image&#39;</span>); }
<a name="l07245"></a>07245         $info = $this-&gt;_getImage($tempfile, <span class="keyword">false</span>);
<a name="l07246"></a>07246         <span class="keywordflow">if</span> (!$info) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) created with GD library to parse JPG(CMYK) image&#39;</span>); }
<a name="l07247"></a>07247         imagedestroy($im);
<a name="l07248"></a>07248         unlink($tempfile);
<a name="l07249"></a>07249         $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;jpg&#39;</span>;
<a name="l07250"></a>07250         <span class="keywordflow">if</span> ($firsttime) {
<a name="l07251"></a>07251           $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07252"></a>07252           $this-&gt;images[$file]=$info;
<a name="l07253"></a>07253         }
<a name="l07254"></a>07254         <span class="keywordflow">return</span> $info;
<a name="l07255"></a>07255       }
<a name="l07256"></a>07256       <span class="keywordflow">else</span> { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error creating GD image file from JPG(CMYK) image&#39;</span>); }
<a name="l07257"></a>07257     }
<a name="l07258"></a>07258     $info = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$a[0],<span class="charliteral">&#39;h&#39;</span>=&gt;$a[1],<span class="stringliteral">&#39;cs&#39;</span>=&gt;$a[2],<span class="stringliteral">&#39;bpc&#39;</span>=&gt;$a[3],<span class="charliteral">&#39;f&#39;</span>=&gt;<span class="stringliteral">&#39;DCTDecode&#39;</span>,<span class="stringliteral">&#39;data&#39;</span>=&gt;$data);
<a name="l07259"></a>07259     $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;jpg&#39;</span>;
<a name="l07260"></a>07260     <span class="keywordflow">if</span> ($firsttime) {
<a name="l07261"></a>07261       $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07262"></a>07262       $this-&gt;images[$file]=$info;
<a name="l07263"></a>07263     }
<a name="l07264"></a>07264     <span class="keywordflow">return</span> $info;
<a name="l07265"></a>07265   }
<a name="l07266"></a>07266 
<a name="l07267"></a>07267   <span class="comment">// PNG</span>
<a name="l07268"></a>07268   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;png&#39;</span>) {
<a name="l07269"></a>07269     <span class="comment">//Check signature</span>
<a name="l07270"></a>07270     <span class="keywordflow">if</span>(substr($data,0,8)!=$this-&gt;chrs[137].<span class="stringliteral">&#39;PNG&#39;</span>.$this-&gt;chrs[13].$this-&gt;chrs[10].$this-&gt;chrs[26].$this-&gt;chrs[10]) { 
<a name="l07271"></a>07271       <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing PNG identifier&#39;</span>); 
<a name="l07272"></a>07272     }
<a name="l07273"></a>07273     <span class="comment">//Read header chunk</span>
<a name="l07274"></a>07274     <span class="keywordflow">if</span>(substr($data,12,4)!=<span class="stringliteral">&#39;IHDR&#39;</span>) { 
<a name="l07275"></a>07275       <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Incorrect PNG file (no IHDR block found)&#39;</span>); 
<a name="l07276"></a>07276     }
<a name="l07277"></a>07277     $w=$this-&gt;_fourbytes2int(substr($data,16,4));
<a name="l07278"></a>07278     $h=$this-&gt;_fourbytes2int(substr($data,20,4));
<a name="l07279"></a>07279     $bpc=$this-&gt;ords[substr($data,24,1)];
<a name="l07280"></a>07280     $errpng = <span class="keyword">false</span>;
<a name="l07281"></a>07281     $pngalpha = <span class="keyword">false</span>; 
<a name="l07282"></a>07282     <span class="keywordflow">if</span>($bpc&gt;8) { $errpng = <span class="stringliteral">&#39;not 8-bit depth&#39;</span>; }
<a name="l07283"></a>07283     $ct=$this-&gt;ords[substr($data,25,1)];
<a name="l07284"></a>07284     <span class="keywordflow">if</span>($ct==0) { $colspace=<span class="stringliteral">&#39;DeviceGray&#39;</span>; }
<a name="l07285"></a>07285     elseif($ct==2) { $colspace=<span class="stringliteral">&#39;DeviceRGB&#39;</span>; }
<a name="l07286"></a>07286     elseif($ct==3) { $colspace=<span class="stringliteral">&#39;Indexed&#39;</span>; }
<a name="l07287"></a>07287     <span class="keywordflow">else</span> { $errpng = <span class="stringliteral">&#39;alpha channel&#39;</span>; $pngalpha = <span class="keyword">true</span>; } 
<a name="l07288"></a>07288     <span class="keywordflow">if</span>($this-&gt;ords[substr($data,26,1)]!=0) { $errpng = <span class="stringliteral">&#39;compression method&#39;</span>; }
<a name="l07289"></a>07289     <span class="keywordflow">if</span>($this-&gt;ords[substr($data,27,1)]!=0) { $errpng = <span class="stringliteral">&#39;filter method&#39;</span>; }
<a name="l07290"></a>07290     <span class="keywordflow">if</span>($this-&gt;ords[substr($data,28,1)]!=0) { $errpng = <span class="stringliteral">&#39;interlaced file&#39;</span>; }
<a name="l07291"></a>07291 
<a name="l07292"></a>07292     <span class="keywordflow">if</span> ($errpng || $pngalpha) {
<a name="l07293"></a>07293       <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;gd_info&#39;</span>)) { $gd = gd_info(); }
<a name="l07294"></a>07294       <span class="keywordflow">else</span> {$gd = array(); }
<a name="l07295"></a>07295       <span class="keywordflow">if</span> (!isset($gd[<span class="stringliteral">&#39;PNG Support&#39;</span>])) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;GD library required for PNG image (&#39;</span>.$errpng.<span class="charliteral">&#39;)&#39;</span>); }
<a name="l07296"></a>07296       $im = imagecreatefromstring($data);
<a name="l07297"></a>07297       <span class="keywordflow">if</span> (!$im) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error creating GD image from PNG file (&#39;</span>.$errpng.<span class="charliteral">&#39;)&#39;</span>); }
<a name="l07298"></a>07298       $w = imagesx($im);
<a name="l07299"></a>07299       $h = imagesy($im);
<a name="l07300"></a>07300       <span class="keywordflow">if</span> ($im) {
<a name="l07301"></a>07301          $tempfile = _MPDF_TEMP_PATH.<span class="stringliteral">&#39;_tempImgPNG&#39;</span>.RAND(1,10000).<span class="stringliteral">&#39;.png&#39;</span>;  <span class="comment">// mPDF 4.3.007E</span>
<a name="l07302"></a>07302          <span class="comment">// Alpha channel set</span>
<a name="l07303"></a>07303          <span class="keywordflow">if</span> ($pngalpha) { 
<a name="l07304"></a>07304         <span class="comment">// mPDF 4.2.018</span>
<a name="l07305"></a>07305         <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&quot;PDFA1-b does not permit images with alpha channel transparency (&quot;</span>.$file.<span class="stringliteral">&quot;).&quot;</span>); }
<a name="l07306"></a>07306         $imgalpha = imagecreate($w, $h);
<a name="l07307"></a>07307         <span class="comment">// generate gray scale pallete</span>
<a name="l07308"></a>07308         <span class="keywordflow">for</span> ($c = 0; $c &lt; 256; ++$c) { ImageColorAllocate($imgalpha, $c, $c, $c); }
<a name="l07309"></a>07309         <span class="comment">// extract alpha channel</span>
<a name="l07310"></a>07310         <span class="keywordflow">for</span> ($xpx = 0; $xpx &lt; $w; ++$xpx) {
<a name="l07311"></a>07311           <span class="keywordflow">for</span> ($ypx = 0; $ypx &lt; $h; ++$ypx) {
<a name="l07312"></a>07312             $colorindex = imagecolorat($im, $xpx, $ypx);
<a name="l07313"></a>07313             $col = imagecolorsforindex($im, $colorindex);
<a name="l07314"></a>07314             $gammacorr = 2.2; <span class="comment">// gamma correction</span>
<a name="l07315"></a>07315             $gamma = (pow((((127 - $col[<span class="stringliteral">&#39;alpha&#39;</span>]) * 255 / 127) / 255), $gammacorr) * 255);
<a name="l07316"></a>07316             imagesetpixel($imgalpha, $xpx, $ypx, $gamma);
<a name="l07317"></a>07317           }
<a name="l07318"></a>07318         }
<a name="l07319"></a>07319         <span class="comment">// create temp alpha file</span>
<a name="l07320"></a>07320         $tempfile_alpha = _MPDF_TEMP_PATH.<span class="stringliteral">&#39;_tempMskPNG&#39;</span>.RAND(1,10000).<span class="stringliteral">&#39;.png&#39;</span>; <span class="comment">// mPDF 4.3.007E</span>
<a name="l07321"></a>07321         $check = @imagepng($imgalpha, $tempfile_alpha);
<a name="l07322"></a>07322         <span class="keywordflow">if</span> (!$check) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Failed to create temporary image file (&#39;</span>.$tempfile_alpha.<span class="stringliteral">&#39;) parsing PNG image with alpha channel (&#39;</span>.$errpng.<span class="charliteral">&#39;)&#39;</span>); }
<a name="l07323"></a>07323         imagedestroy($imgalpha);
<a name="l07324"></a>07324         <span class="comment">// extract image without alpha channel</span>
<a name="l07325"></a>07325         $imgplain = imagecreatetruecolor($w, $h);
<a name="l07326"></a>07326         imagecopy($imgplain, $im, 0, 0, 0, 0, $w, $h);
<a name="l07327"></a>07327         <span class="comment">// create temp image file</span>
<a name="l07328"></a>07328         $check = @imagepng($imgplain, $tempfile);
<a name="l07329"></a>07329         <span class="keywordflow">if</span> (!$check) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Failed to create temporary image file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) parsing PNG image with alpha channel (&#39;</span>.$errpng.<span class="charliteral">&#39;)&#39;</span>); }
<a name="l07330"></a>07330         imagedestroy($imgplain);
<a name="l07331"></a>07331         <span class="comment">// embed mask image</span>
<a name="l07332"></a>07332         $minfo = $this-&gt;_getImage($tempfile_alpha, <span class="keyword">false</span>);
<a name="l07333"></a>07333         unlink($tempfile_alpha);
<a name="l07334"></a>07334         <span class="keywordflow">if</span> (!$minfo) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing temporary file (&#39;</span>.$tempfile_alpha.<span class="stringliteral">&#39;) created with GD library to parse PNG image&#39;</span>); }
<a name="l07335"></a>07335         $imgmask = count($this-&gt;images)+1;
<a name="l07336"></a>07336         $minfo[<span class="stringliteral">&#39;cs&#39;</span>] = <span class="stringliteral">&#39;DeviceGray&#39;</span>;
<a name="l07337"></a>07337         $minfo[<span class="charliteral">&#39;i&#39;</span>]=$imgmask ;
<a name="l07338"></a>07338         $this-&gt;images[$tempfile_alpha] = $minfo;
<a name="l07339"></a>07339         <span class="comment">// embed image, masked with previously embedded mask</span>
<a name="l07340"></a>07340         $info = $this-&gt;_getImage($tempfile, <span class="keyword">false</span>);
<a name="l07341"></a>07341         unlink($tempfile);
<a name="l07342"></a>07342         <span class="keywordflow">if</span> (!$info) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) created with GD library to parse PNG image&#39;</span>); }
<a name="l07343"></a>07343         $info[<span class="stringliteral">&#39;masked&#39;</span>] = $imgmask;
<a name="l07344"></a>07344         $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07345"></a>07345         $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;png&#39;</span>;
<a name="l07346"></a>07346         $this-&gt;images[$file]=$info;
<a name="l07347"></a>07347         <span class="keywordflow">return</span> $info;
<a name="l07348"></a>07348          }
<a name="l07349"></a>07349          <span class="keywordflow">else</span> {   <span class="comment">// No alpha/transparency set</span>
<a name="l07350"></a>07350         imagealphablending($im, <span class="keyword">false</span>);
<a name="l07351"></a>07351         imagesavealpha($im, <span class="keyword">false</span>); 
<a name="l07352"></a>07352         imageinterlace($im, <span class="keyword">false</span>);
<a name="l07353"></a>07353         $check = @imagepng($im, $tempfile );
<a name="l07354"></a>07354         <span class="keywordflow">if</span> (!$check) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Failed to create temporary image file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) parsing PNG image (&#39;</span>.$errpng.<span class="charliteral">&#39;)&#39;</span>); }
<a name="l07355"></a>07355         imagedestroy($im);
<a name="l07356"></a>07356         $info = $this-&gt;_getImage($tempfile, <span class="keyword">false</span>) ;
<a name="l07357"></a>07357         unlink($tempfile ); 
<a name="l07358"></a>07358         <span class="keywordflow">if</span> (!$info) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) created with GD library to parse PNG image&#39;</span>); }
<a name="l07359"></a>07359         $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07360"></a>07360         $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;png&#39;</span>;
<a name="l07361"></a>07361         $this-&gt;images[$file]=$info;
<a name="l07362"></a>07362         <span class="keywordflow">return</span> $info;
<a name="l07363"></a>07363          }
<a name="l07364"></a>07364       }
<a name="l07365"></a>07365     }
<a name="l07366"></a>07366 
<a name="l07367"></a>07367     $parms=<span class="stringliteral">&#39;/DecodeParms &lt;&lt;/Predictor 15 /Colors &#39;</span>.($ct==2 ? 3 : 1).<span class="stringliteral">&#39; /BitsPerComponent &#39;</span>.$bpc.<span class="stringliteral">&#39; /Columns &#39;</span>.$w.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l07368"></a>07368     <span class="comment">//Scan chunks looking for palette, transparency and image data</span>
<a name="l07369"></a>07369     $pal=<span class="stringliteral">&#39;&#39;</span>;
<a name="l07370"></a>07370     $trns=<span class="stringliteral">&#39;&#39;</span>;
<a name="l07371"></a>07371     $pngdata=<span class="stringliteral">&#39;&#39;</span>;
<a name="l07372"></a>07372     $p = 33;
<a name="l07373"></a>07373     <span class="keywordflow">do</span> {
<a name="l07374"></a>07374       $n=$this-&gt;_fourbytes2int(substr($data,$p,4)); $p += 4;
<a name="l07375"></a>07375       $type=substr($data,$p,4); $p += 4;
<a name="l07376"></a>07376       <span class="keywordflow">if</span>($type==<span class="stringliteral">&#39;PLTE&#39;</span>) {
<a name="l07377"></a>07377         <span class="comment">//Read palette</span>
<a name="l07378"></a>07378         $pal=substr($data,$p,$n); $p += $n;
<a name="l07379"></a>07379         $p += 4;
<a name="l07380"></a>07380       }
<a name="l07381"></a>07381       elseif($type==<span class="stringliteral">&#39;tRNS&#39;</span>) {
<a name="l07382"></a>07382         <span class="comment">//Read transparency info</span>
<a name="l07383"></a>07383         $t=substr($data,$p,$n); $p += $n;
<a name="l07384"></a>07384         <span class="keywordflow">if</span>($ct==0) $trns=array($this-&gt;ords[substr($t,1,1)]);
<a name="l07385"></a>07385         elseif($ct==2) $trns=array($this-&gt;ords[substr($t,1,1)],$this-&gt;ords[substr($t,3,1)],$this-&gt;ords[substr($t,5,1)]);
<a name="l07386"></a>07386         else
<a name="l07387"></a>07387         {
<a name="l07388"></a>07388           $pos=strpos($t,$this-&gt;chrs[0]);
<a name="l07389"></a>07389           <span class="keywordflow">if</span>(is_int($pos)) $trns=array($pos);
<a name="l07390"></a>07390         }
<a name="l07391"></a>07391         $p += 4;
<a name="l07392"></a>07392       }
<a name="l07393"></a>07393       elseif($type==<span class="stringliteral">&#39;IDAT&#39;</span>) {
<a name="l07394"></a>07394         $pngdata.=substr($data,$p,$n);  $p += $n;
<a name="l07395"></a>07395         $p += 4;
<a name="l07396"></a>07396       }
<a name="l07397"></a>07397       elseif($type==<span class="stringliteral">&#39;IEND&#39;</span>) { <span class="keywordflow">break</span>; }
<a name="l07398"></a>07398       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/[a-zA-Z]{4}/&#39;</span>,$type)) { $p += $n+4; }
<a name="l07399"></a>07399       <span class="keywordflow">else</span> { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing PNG image data&#39;</span>); }
<a name="l07400"></a>07400     }
<a name="l07401"></a>07401     <span class="keywordflow">while</span>($n);
<a name="l07402"></a>07402     <span class="keywordflow">if</span> (!$pngdata) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing PNG image data - no IDAT data found&#39;</span>); }
<a name="l07403"></a>07403     <span class="keywordflow">if</span>($colspace==<span class="stringliteral">&#39;Indexed&#39;</span> and empty($pal)) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing PNG image data - missing colour palette&#39;</span>); }
<a name="l07404"></a>07404     $info = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$w,<span class="charliteral">&#39;h&#39;</span>=&gt;$h,<span class="stringliteral">&#39;cs&#39;</span>=&gt;$colspace,<span class="stringliteral">&#39;bpc&#39;</span>=&gt;$bpc,<span class="charliteral">&#39;f&#39;</span>=&gt;<span class="stringliteral">&#39;FlateDecode&#39;</span>,<span class="stringliteral">&#39;parms&#39;</span>=&gt;$parms,<span class="stringliteral">&#39;pal&#39;</span>=&gt;$pal,<span class="stringliteral">&#39;trns&#39;</span>=&gt;$trns,<span class="stringliteral">&#39;data&#39;</span>=&gt;$pngdata);
<a name="l07405"></a>07405     $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;png&#39;</span>;
<a name="l07406"></a>07406     <span class="keywordflow">if</span> ($firsttime) {
<a name="l07407"></a>07407       $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07408"></a>07408       $this-&gt;images[$file]=$info;
<a name="l07409"></a>07409     }
<a name="l07410"></a>07410     <span class="keywordflow">return</span> $info;
<a name="l07411"></a>07411   }
<a name="l07412"></a>07412 
<a name="l07413"></a>07413   <span class="comment">// GIF</span>
<a name="l07414"></a>07414   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;gif&#39;</span>) {
<a name="l07415"></a>07415     <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;gd_info&#39;</span>)) { $gd = gd_info(); }
<a name="l07416"></a>07416     <span class="keywordflow">else</span> {$gd = array(); }
<a name="l07417"></a>07417     <span class="keywordflow">if</span> (isset($gd[<span class="stringliteral">&#39;GIF Read Support&#39;</span>]) &amp;&amp; $gd[<span class="stringliteral">&#39;GIF Read Support&#39;</span>]) {
<a name="l07418"></a>07418       $im = @imagecreatefromstring($data);
<a name="l07419"></a>07419       <span class="keywordflow">if</span> ($im) {
<a name="l07420"></a>07420         $tempfile = _MPDF_TEMP_PATH.<span class="stringliteral">&#39;_tempImgPNG&#39;</span>.RAND(1,10000).<span class="stringliteral">&#39;.png&#39;</span>; <span class="comment">// mPDF 4.3.007E</span>
<a name="l07421"></a>07421         imagealphablending($im, <span class="keyword">false</span>);
<a name="l07422"></a>07422         imagesavealpha($im, <span class="keyword">false</span>); 
<a name="l07423"></a>07423         imageinterlace($im, <span class="keyword">false</span>);
<a name="l07424"></a>07424         $check = @imagepng($im, $tempfile);
<a name="l07425"></a>07425         <span class="keywordflow">if</span> (!$check) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error creating temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) whilst using GD library to parse GIF image&#39;</span>); }
<a name="l07426"></a>07426         $info = $this-&gt;_getImage($tempfile, <span class="keyword">false</span>);
<a name="l07427"></a>07427         <span class="keywordflow">if</span> (!$info) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) created with GD library to parse GIF image&#39;</span>); }
<a name="l07428"></a>07428         imagedestroy($im);
<a name="l07429"></a>07429         unlink($tempfile);
<a name="l07430"></a>07430         $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;gif&#39;</span>;
<a name="l07431"></a>07431         <span class="keywordflow">if</span> ($firsttime) {
<a name="l07432"></a>07432           $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07433"></a>07433           $this-&gt;images[$file]=$info;
<a name="l07434"></a>07434         }
<a name="l07435"></a>07435         <span class="keywordflow">return</span> $info;
<a name="l07436"></a>07436       }
<a name="l07437"></a>07437       <span class="keywordflow">else</span> { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error creating GD image file from GIF image&#39;</span>); }
<a name="l07438"></a>07438     }
<a name="l07439"></a>07439 
<a name="l07440"></a>07440     <span class="keywordflow">if</span> (!class_exists(<span class="stringliteral">&#39;gif&#39;</span>)) { 
<a name="l07441"></a>07441       include_once(_MPDF_PATH.<span class="stringliteral">&#39;classes/gif.php&#39;</span>); 
<a name="l07442"></a>07442       $gif=<span class="keyword">new</span> <a class="code" href="classCGIF.html">CGIF</a>();
<a name="l07443"></a>07443     }
<a name="l07444"></a>07444 
<a name="l07445"></a>07445     $h=0;
<a name="l07446"></a>07446     $w=0;
<a name="l07447"></a>07447     $gif-&gt;loadFile($data, 0);
<a name="l07448"></a>07448 
<a name="l07449"></a>07449     <span class="keywordflow">if</span>(isset($gif-&gt;m_img-&gt;m_gih-&gt;m_bLocalClr) &amp;&amp; $gif-&gt;m_img-&gt;m_gih-&gt;m_bLocalClr) {
<a name="l07450"></a>07450       $nColors = $gif-&gt;m_img-&gt;m_gih-&gt;m_nTableSize;
<a name="l07451"></a>07451       $pal = $gif-&gt;m_img-&gt;m_gih-&gt;m_colorTable-&gt;toString();
<a name="l07452"></a>07452       <span class="keywordflow">if</span>($bgColor != -1) {
<a name="l07453"></a>07453         $bgColor = $gif-&gt;m_img-&gt;m_gih-&gt;m_colorTable-&gt;colorIndex($bgColor);
<a name="l07454"></a>07454       }
<a name="l07455"></a>07455       $colspace=<span class="stringliteral">&#39;Indexed&#39;</span>;
<a name="l07456"></a>07456     } elseif(isset($gif-&gt;m_gfh-&gt;m_bGlobalClr) &amp;&amp; $gif-&gt;m_gfh-&gt;m_bGlobalClr) {
<a name="l07457"></a>07457       $nColors = $gif-&gt;m_gfh-&gt;m_nTableSize;
<a name="l07458"></a>07458       $pal = $gif-&gt;m_gfh-&gt;m_colorTable-&gt;toString();
<a name="l07459"></a>07459       <span class="keywordflow">if</span>((isset($bgColor)) and $bgColor != -1) {
<a name="l07460"></a>07460         $bgColor = $gif-&gt;m_gfh-&gt;m_colorTable-&gt;colorIndex($bgColor);
<a name="l07461"></a>07461       }
<a name="l07462"></a>07462       $colspace=<span class="stringliteral">&#39;Indexed&#39;</span>;
<a name="l07463"></a>07463     } <span class="keywordflow">else</span> {
<a name="l07464"></a>07464       $nColors = 0;
<a name="l07465"></a>07465       $bgColor = -1;
<a name="l07466"></a>07466       $colspace=<span class="stringliteral">&#39;DeviceGray&#39;</span>;
<a name="l07467"></a>07467       $pal=<span class="stringliteral">&#39;&#39;</span>;
<a name="l07468"></a>07468     }
<a name="l07469"></a>07469 
<a name="l07470"></a>07470     $trns=<span class="stringliteral">&#39;&#39;</span>;
<a name="l07471"></a>07471     <span class="keywordflow">if</span>(isset($gif-&gt;m_img-&gt;m_bTrans) &amp;&amp; $gif-&gt;m_img-&gt;m_bTrans &amp;&amp; ($nColors &gt; 0)) {
<a name="l07472"></a>07472       $trns=array($gif-&gt;m_img-&gt;m_nTrans);
<a name="l07473"></a>07473     }
<a name="l07474"></a>07474     $gifdata=$gif-&gt;m_img-&gt;m_data;
<a name="l07475"></a>07475     $w=$gif-&gt;m_gfh-&gt;m_nWidth;
<a name="l07476"></a>07476     $h=$gif-&gt;m_gfh-&gt;m_nHeight;
<a name="l07477"></a>07477     $gif-&gt;ClearData();
<a name="l07478"></a>07478 
<a name="l07479"></a>07479     <span class="keywordflow">if</span>($colspace==<span class="stringliteral">&#39;Indexed&#39;</span> and empty($pal)) {
<a name="l07480"></a>07480       <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing GIF image - missing colour palette&#39;</span>); 
<a name="l07481"></a>07481     }
<a name="l07482"></a>07482     <span class="keywordflow">if</span> ($this-&gt;compress) {
<a name="l07483"></a>07483       $gifdata=gzcompress($gifdata);
<a name="l07484"></a>07484       $info = array( <span class="charliteral">&#39;w&#39;</span>=&gt;$w, <span class="charliteral">&#39;h&#39;</span>=&gt;$h, <span class="stringliteral">&#39;cs&#39;</span>=&gt;$colspace, <span class="stringliteral">&#39;bpc&#39;</span>=&gt;8, <span class="charliteral">&#39;f&#39;</span>=&gt;<span class="stringliteral">&#39;FlateDecode&#39;</span>, <span class="stringliteral">&#39;pal&#39;</span>=&gt;$pal, <span class="stringliteral">&#39;trns&#39;</span>=&gt;$trns, <span class="stringliteral">&#39;data&#39;</span>=&gt;$gifdata);
<a name="l07485"></a>07485     } 
<a name="l07486"></a>07486     <span class="keywordflow">else</span> {
<a name="l07487"></a>07487       $info = array( <span class="charliteral">&#39;w&#39;</span>=&gt;$w, <span class="charliteral">&#39;h&#39;</span>=&gt;$h, <span class="stringliteral">&#39;cs&#39;</span>=&gt;$colspace, <span class="stringliteral">&#39;bpc&#39;</span>=&gt;8, <span class="stringliteral">&#39;pal&#39;</span>=&gt;$pal, <span class="stringliteral">&#39;trns&#39;</span>=&gt;$trns, <span class="stringliteral">&#39;data&#39;</span>=&gt;$gifdata);
<a name="l07488"></a>07488     } 
<a name="l07489"></a>07489     $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;gif&#39;</span>;
<a name="l07490"></a>07490     <span class="keywordflow">if</span> ($firsttime) {
<a name="l07491"></a>07491       $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07492"></a>07492       $this-&gt;images[$file]=$info;
<a name="l07493"></a>07493     }
<a name="l07494"></a>07494     <span class="keywordflow">return</span> $info;
<a name="l07495"></a>07495   }
<a name="l07496"></a>07496 
<a name="l07497"></a>07497 
<a name="l07498"></a>07498   <span class="comment">// UNKNOWN TYPE - try GD imagecreatefromstring</span>
<a name="l07499"></a>07499   <span class="keywordflow">else</span> {
<a name="l07500"></a>07500     <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;gd_info&#39;</span>)) { $gd = gd_info(); }
<a name="l07501"></a>07501     <span class="keywordflow">else</span> {$gd = array(); }
<a name="l07502"></a>07502     <span class="keywordflow">if</span> (isset($gd[<span class="stringliteral">&#39;PNG Support&#39;</span>]) &amp;&amp; $gd[<span class="stringliteral">&#39;PNG Support&#39;</span>]) {
<a name="l07503"></a>07503       $im = @imagecreatefromstring($data);
<a name="l07504"></a>07504       <span class="keywordflow">if</span> (!$im) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing image file - image type not recognised, and not supported by GD imagecreate&#39;</span>); }
<a name="l07505"></a>07505       $tempfile = _MPDF_TEMP_PATH.<span class="stringliteral">&#39;_tempImgPNG&#39;</span>.RAND(1,10000).<span class="stringliteral">&#39;.png&#39;</span>; <span class="comment">// mPDF 4.3.007E</span>
<a name="l07506"></a>07506       imagealphablending($im, <span class="keyword">false</span>);
<a name="l07507"></a>07507       imagesavealpha($im, <span class="keyword">false</span>); 
<a name="l07508"></a>07508       imageinterlace($im, <span class="keyword">false</span>);
<a name="l07509"></a>07509       $check = @imagepng($im, $tempfile);
<a name="l07510"></a>07510       <span class="keywordflow">if</span> (!$check) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error creating temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) whilst using GD library to parse unknown image type&#39;</span>); }
<a name="l07511"></a>07511       $info = $this-&gt;_getImage($tempfile, <span class="keyword">false</span>);
<a name="l07512"></a>07512       imagedestroy($im);
<a name="l07513"></a>07513       unlink($tempfile);
<a name="l07514"></a>07514       <span class="keywordflow">if</span> (!$info) { <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing temporary file (&#39;</span>.$tempfile.<span class="stringliteral">&#39;) created with GD library to parse unknown image type&#39;</span>); }
<a name="l07515"></a>07515       $info[<span class="stringliteral">&#39;type&#39;</span>]=<span class="stringliteral">&#39;png&#39;</span>;
<a name="l07516"></a>07516       <span class="keywordflow">if</span> ($firsttime) {
<a name="l07517"></a>07517         $info[<span class="charliteral">&#39;i&#39;</span>]=count($this-&gt;images)+1;
<a name="l07518"></a>07518         $this-&gt;images[$file]=$info;
<a name="l07519"></a>07519       }
<a name="l07520"></a>07520       <span class="keywordflow">return</span> $info;
<a name="l07521"></a>07521     }
<a name="l07522"></a>07522   }
<a name="l07523"></a>07523 
<a name="l07524"></a>07524   <span class="keywordflow">return</span> $this-&gt;_imageError($file, $firsttime, <span class="stringliteral">&#39;Error parsing image file - image type not recognised&#39;</span>); 
<a name="l07525"></a>07525 }
<a name="l07526"></a>07526 <span class="comment">//==============================================================</span>
<a name="l07527"></a>07527 <span class="comment">// mPDF 4.2</span>
<a name="l07528"></a>07528 function _fourbytes2int($s) {
<a name="l07529"></a>07529   <span class="comment">//Read a 4-byte integer from string</span>
<a name="l07530"></a>07530   <span class="keywordflow">return</span> (ord(substr($s, 0, 1))&lt;&lt;24) + (ord(substr($s, 1, 1))&lt;&lt;16) + (ord(substr($s, 2, 1))&lt;&lt;8) + ord(substr($s, 3, 1));
<a name="l07531"></a>07531 }
<a name="l07532"></a>07532 <span class="comment">//==============================================================</span>
<a name="l07533"></a>07533 <span class="comment">// mPDF 4.2</span>
<a name="l07534"></a>07534 function _twobytes2int($s) {
<a name="l07535"></a>07535   <span class="comment">//Read a 2-byte integer from string</span>
<a name="l07536"></a>07536   <span class="keywordflow">return</span> (ord(substr($s, 0, 1))&lt;&lt;8) + ord(substr($s, 1, 1));
<a name="l07537"></a>07537 }
<a name="l07538"></a>07538 
<a name="l07539"></a>07539 <span class="comment">//==============================================================</span>
<a name="l07540"></a>07540 <span class="comment">// mPDF 4.2</span>
<a name="l07541"></a>07541 function _jpgHeaderFromString(&amp;$data) {
<a name="l07542"></a>07542   $p = 4;
<a name="l07543"></a>07543   $p += $this-&gt;_twobytes2int(substr($data, $p, 2)); <span class="comment">// Length of initial marker block</span>
<a name="l07544"></a>07544   $marker = substr($data, $p, 2);
<a name="l07545"></a>07545   <span class="keywordflow">while</span>($marker != chr(255).chr(192) &amp;&amp; $p&lt;strlen($data)) { <span class="comment">// Start of frame marker (FFC0)</span>
<a name="l07546"></a>07546     $p += ($this-&gt;_twobytes2int(substr($data, $p+2, 2))) + 2; <span class="comment">// Length of marker block</span>
<a name="l07547"></a>07547     $marker = substr($data, $p, 2);
<a name="l07548"></a>07548   }
<a name="l07549"></a>07549     
<a name="l07550"></a>07550   <span class="keywordflow">if</span> ($marker != chr(255).chr(192)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l07551"></a>07551   <span class="keywordflow">return</span> substr($data, $p+2, 10);
<a name="l07552"></a>07552 }
<a name="l07553"></a>07553 <span class="comment">//==============================================================</span>
<a name="l07554"></a>07554 <span class="comment">// mPDF 4.2</span>
<a name="l07555"></a>07555 function _jpgDataFromHeader($hdr) {
<a name="l07556"></a>07556   $bpc = ord(substr($hdr, 2, 1));
<a name="l07557"></a>07557   <span class="keywordflow">if</span> (!$bpc) { $bpc = 8; }
<a name="l07558"></a>07558   $h = $this-&gt;_twobytes2int(substr($hdr, 3, 2));
<a name="l07559"></a>07559   $w = $this-&gt;_twobytes2int(substr($hdr, 5, 2));
<a name="l07560"></a>07560   $channels = ord(substr($hdr, 7, 1));
<a name="l07561"></a>07561   <span class="keywordflow">if</span> ($channels==3) { $colspace=<span class="stringliteral">&#39;DeviceRGB&#39;</span>; }  
<a name="l07562"></a>07562   elseif($channels==4) { $colspace=<span class="stringliteral">&#39;DeviceCMYK&#39;</span>; }
<a name="l07563"></a>07563   <span class="keywordflow">else</span> { $colspace=<span class="stringliteral">&#39;DeviceGray&#39;</span>; }
<a name="l07564"></a>07564   <span class="keywordflow">return</span> array($w, $h, $colspace, $bpc);
<a name="l07565"></a>07565 }
<a name="l07566"></a>07566 <span class="comment">//==============================================================</span>
<a name="l07567"></a>07567 <span class="comment">// mPDF 4.2</span>
<a name="l07568"></a>07568 function file_get_contents_by_curl($url, &amp;$data) {
<a name="l07569"></a>07569   $timeout = 5;
<a name="l07570"></a>07570   $ch = curl_init($url);
<a name="l07571"></a>07571   curl_setopt($ch, CURLOPT_HEADER, 0);
<a name="l07572"></a>07572   curl_setopt($ch, CURLOPT_NOBODY, 0);
<a name="l07573"></a>07573   curl_setopt ( $ch , CURLOPT_RETURNTRANSFER , 1 );
<a name="l07574"></a>07574   curl_setopt ( $ch , CURLOPT_CONNECTTIMEOUT , $timeout );
<a name="l07575"></a>07575   $data = curl_exec($ch);
<a name="l07576"></a>07576   curl_close($ch);
<a name="l07577"></a>07577 }
<a name="l07578"></a>07578 <span class="comment">//==============================================================</span>
<a name="l07579"></a>07579 <span class="comment">// mPDF 4.2</span>
<a name="l07580"></a>07580 function file_get_contents_by_socket($url, &amp;$data) {
<a name="l07581"></a>07581   $timeout = 1;
<a name="l07582"></a>07582   $p = parse_url($url);
<a name="l07583"></a>07583   $file = $p[<span class="stringliteral">&#39;path&#39;</span>];
<a name="l07584"></a>07584   <span class="keywordflow">if</span> ($p[<span class="stringliteral">&#39;query&#39;</span>]) { $file .= <span class="charliteral">&#39;?&#39;</span>.$p[<span class="stringliteral">&#39;query&#39;</span>]; }
<a name="l07585"></a>07585   <span class="keywordflow">if</span>(!($fh = @fsockopen($p[<span class="stringliteral">&#39;host&#39;</span>], 80, $errno, $errstr, $timeout))) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l07586"></a>07586   $getstring =
<a name="l07587"></a>07587     <span class="stringliteral">&quot;GET &quot;</span>.$file.<span class="stringliteral">&quot; HTTP/1.0 \r\n&quot;</span> .
<a name="l07588"></a>07588     <span class="stringliteral">&quot;Host: &quot;</span>.$p[<span class="stringliteral">&#39;host&#39;</span>].<span class="stringliteral">&quot; \r\n&quot;</span> .
<a name="l07589"></a>07589     <span class="stringliteral">&quot;Connection: close\r\n\r\n&quot;</span>;
<a name="l07590"></a>07590   fwrite($fh, $getstring);
<a name="l07591"></a>07591   <span class="comment">// Get rid of HTTP header</span>
<a name="l07592"></a>07592   $s = fgets($fh, 1024);
<a name="l07593"></a>07593   <span class="keywordflow">if</span> (!$s) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l07594"></a>07594   $httpheader .= $s;
<a name="l07595"></a>07595   <span class="keywordflow">while</span> (!feof($fh)) {
<a name="l07596"></a>07596     $s = fgets($fh, 1024);
<a name="l07597"></a>07597     <span class="keywordflow">if</span> ( $s == <span class="stringliteral">&quot;\r\n&quot;</span> ) { <span class="keywordflow">break</span>; }
<a name="l07598"></a>07598   }
<a name="l07599"></a>07599   $data = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07600"></a>07600   <span class="keywordflow">while</span> (!feof($fh)) {
<a name="l07601"></a>07601     $data .= fgets($fh, 1024);
<a name="l07602"></a>07602   }
<a name="l07603"></a>07603   fclose($fh);
<a name="l07604"></a>07604 }
<a name="l07605"></a>07605 
<a name="l07606"></a>07606 <span class="comment">//==============================================================</span>
<a name="l07607"></a>07607 <span class="comment">// mPDF 4.2</span>
<a name="l07608"></a>07608 function _imageTypeFromString(&amp;$data) {
<a name="l07609"></a>07609   $type = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07610"></a>07610   <span class="keywordflow">if</span> (substr($data, 6, 4)== <span class="stringliteral">&#39;JFIF&#39;</span>) { 
<a name="l07611"></a>07611     $type = <span class="stringliteral">&#39;jpeg&#39;</span>; 
<a name="l07612"></a>07612   }
<a name="l07613"></a>07613   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (substr($data, 0, 6)== <span class="stringliteral">&quot;GIF87a&quot;</span> || substr($data, 0, 6)== <span class="stringliteral">&quot;GIF89a&quot;</span>) { 
<a name="l07614"></a>07614     $type = <span class="stringliteral">&#39;gif&#39;</span>;
<a name="l07615"></a>07615   }
<a name="l07616"></a>07616   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (substr($data, 0, 8)== chr(137).<span class="stringliteral">&#39;PNG&#39;</span>.chr(13).chr(10).chr(26).chr(10)) { 
<a name="l07617"></a>07617     $type = <span class="stringliteral">&#39;png&#39;</span>;
<a name="l07618"></a>07618   }
<a name="l07619"></a>07619   <span class="comment">// mPDF 4.3.013 SVG files</span>
<a name="l07620"></a>07620   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/&lt;svg.*&lt;\/svg&gt;/is&#39;</span>,$data)) { 
<a name="l07621"></a>07621     $type = <span class="stringliteral">&#39;svg&#39;</span>;
<a name="l07622"></a>07622   }
<a name="l07623"></a>07623   <span class="keywordflow">return</span> $type;
<a name="l07624"></a>07624 }
<a name="l07625"></a>07625 <span class="comment">//==============================================================</span>
<a name="l07626"></a>07626 
<a name="l07627"></a>07627 
<a name="l07628"></a>07628 <span class="comment">// mPDF 4.3.013 SVG files</span>
<a name="l07629"></a>07629 <span class="comment">// Moved outside WMF as also needed for SVG</span>
<a name="l07630"></a>07630 function _putformobjects() {
<a name="l07631"></a>07631   reset($this-&gt;formobjects);
<a name="l07632"></a>07632   <span class="keywordflow">while</span>(list($file,$info)=each($this-&gt;formobjects)) {
<a name="l07633"></a>07633     $this-&gt;_newobj();
<a name="l07634"></a>07634     $this-&gt;formobjects[$file][<span class="charliteral">&#39;n&#39;</span>]=$this-&gt;n;
<a name="l07635"></a>07635     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /XObject&#39;</span>);
<a name="l07636"></a>07636     $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Form&#39;</span>);
<a name="l07637"></a>07637     $this-&gt;_out(<span class="stringliteral">&#39;/Group &#39;</span>.($this-&gt;n+1).<span class="stringliteral">&#39; 0 R&#39;</span>); <span class="comment">// mPDF 4.3.017</span>
<a name="l07638"></a>07638     $this-&gt;_out(<span class="stringliteral">&#39;/BBox [&#39;</span>.$info[<span class="charliteral">&#39;x&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$info[<span class="charliteral">&#39;y&#39;</span>].<span class="charliteral">&#39; &#39;</span>.($info[<span class="charliteral">&#39;w&#39;</span>]+$info[<span class="charliteral">&#39;x&#39;</span>]).<span class="charliteral">&#39; &#39;</span>.($info[<span class="charliteral">&#39;h&#39;</span>]+$info[<span class="charliteral">&#39;y&#39;</span>]).<span class="charliteral">&#39;]&#39;</span>);
<a name="l07639"></a>07639     <span class="keywordflow">if</span> ($this-&gt;compress)
<a name="l07640"></a>07640       $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l07641"></a>07641     $data=($this-&gt;compress) ? gzcompress($info[<span class="stringliteral">&#39;data&#39;</span>]) : $info[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l07642"></a>07642     $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($data).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07643"></a>07643     $this-&gt;_putstream($data);
<a name="l07644"></a>07644     unset($this-&gt;formobjects[$file][<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l07645"></a>07645     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l07646"></a>07646     <span class="comment">// mPDF 4.3.017  Required for SVG transparency (opacity) to work</span>
<a name="l07647"></a>07647     $this-&gt;_newobj();
<a name="l07648"></a>07648     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Group&#39;</span>);
<a name="l07649"></a>07649     $this-&gt;_out(<span class="stringliteral">&#39;/S /Transparency&#39;</span>);
<a name="l07650"></a>07650     $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07651"></a>07651     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l07652"></a>07652   }
<a name="l07653"></a>07653 }
<a name="l07654"></a>07654 
<a name="l07655"></a>07655 function _freadint($f)
<a name="l07656"></a>07656 {
<a name="l07657"></a>07657   <span class="comment">//Read a 4-byte integer from file</span>
<a name="l07658"></a>07658   $i=$this-&gt;ords[fread($f,1)]&lt;&lt;24;
<a name="l07659"></a>07659   $i+=$this-&gt;ords[fread($f,1)]&lt;&lt;16;
<a name="l07660"></a>07660   $i+=$this-&gt;ords[fread($f,1)]&lt;&lt;8;
<a name="l07661"></a>07661   $i+=$this-&gt;ords[fread($f,1)];
<a name="l07662"></a>07662   <span class="keywordflow">return</span> $i;
<a name="l07663"></a>07663 }
<a name="l07664"></a>07664 
<a name="l07665"></a>07665 function _UTF16BEtextstring($s) {
<a name="l07666"></a>07666   $s = $this-&gt;UTF8ToUTF16BE($s, <span class="keyword">true</span>);
<a name="l07667"></a>07667   <span class="keywordflow">return</span> <span class="charliteral">&#39;(&#39;</span>. $this-&gt;_escape($s).<span class="charliteral">&#39;)&#39;</span>;
<a name="l07668"></a>07668 }
<a name="l07669"></a>07669 
<a name="l07670"></a>07670 function _textstring($s) {
<a name="l07671"></a>07671   <span class="keywordflow">return</span> <span class="charliteral">&#39;(&#39;</span>. $this-&gt;_escape($s).<span class="charliteral">&#39;)&#39;</span>;
<a name="l07672"></a>07672 }
<a name="l07673"></a>07673 
<a name="l07674"></a>07674 
<a name="l07675"></a>07675 function _escape($s)
<a name="l07676"></a>07676 {
<a name="l07677"></a>07677   <span class="comment">// the chr(13) substitution fixes the Bugs item #1421290.</span>
<a name="l07678"></a>07678   <span class="keywordflow">return</span> strtr($s, array(<span class="charliteral">&#39;)&#39;</span> =&gt; <span class="stringliteral">&#39;\\)&#39;</span>, <span class="charliteral">&#39;(&#39;</span> =&gt; <span class="stringliteral">&#39;\\(&#39;</span>, <span class="charliteral">&#39;\\&#39;</span> =&gt; <span class="stringliteral">&#39;\\\\&#39;</span>, $this-&gt;chrs[13] =&gt; <span class="charliteral">&#39;\r&#39;</span>));
<a name="l07679"></a>07679 }
<a name="l07680"></a>07680 
<a name="l07681"></a>07681 function _putstream($s) {
<a name="l07682"></a>07682   $this-&gt;_out(<span class="stringliteral">&#39;stream&#39;</span>);
<a name="l07683"></a>07683   $this-&gt;_out($s);
<a name="l07684"></a>07684   $this-&gt;_out(<span class="stringliteral">&#39;endstream&#39;</span>);
<a name="l07685"></a>07685 }
<a name="l07686"></a>07686 
<a name="l07687"></a>07687 
<a name="l07688"></a>07688 function _out($s,$ln=<span class="keyword">true</span>) {
<a name="l07689"></a>07689   <span class="keywordflow">if</span>($this-&gt;state==2) {
<a name="l07690"></a>07690      <span class="keywordflow">if</span> ($this-&gt;bufferoutput) {
<a name="l07691"></a>07691     $this-&gt;headerbuffer.= $s.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l07692"></a>07692      }
<a name="l07693"></a>07693      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate &amp;&amp; !$this-&gt;processingHeader &amp;&amp; !$this-&gt;processingFooter) {
<a name="l07694"></a>07694     <span class="comment">// Captures eveything in buffer for rotated tables; </span>
<a name="l07695"></a>07695     $this-&gt;tablebuffer[] = array(
<a name="l07696"></a>07696     <span class="charliteral">&#39;s&#39;</span> =&gt; $s,              <span class="comment">// Text string to output  </span>
<a name="l07697"></a>07697     <span class="charliteral">&#39;x&#39;</span> =&gt; $this-&gt;x,            <span class="comment">// x when printed  </span>
<a name="l07698"></a>07698     <span class="charliteral">&#39;y&#39;</span> =&gt; $this-&gt;y,            <span class="comment">// y when printed (after column break) </span>
<a name="l07699"></a>07699     );
<a name="l07700"></a>07700      }
<a name="l07701"></a>07701      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;kwt &amp;&amp; !$this-&gt;processingHeader &amp;&amp; !$this-&gt;processingFooter) {
<a name="l07702"></a>07702     <span class="comment">// Captures eveything in buffer for keep-with-table (h1-6); </span>
<a name="l07703"></a>07703     $this-&gt;kwt_buffer[] = array(
<a name="l07704"></a>07704     <span class="charliteral">&#39;s&#39;</span> =&gt; $s,              <span class="comment">// Text string to output </span>
<a name="l07705"></a>07705     <span class="charliteral">&#39;x&#39;</span> =&gt; $this-&gt;x,            <span class="comment">// x when printed  </span>
<a name="l07706"></a>07706     <span class="charliteral">&#39;y&#39;</span> =&gt; $this-&gt;y,            <span class="comment">// y when printed  </span>
<a name="l07707"></a>07707     );
<a name="l07708"></a>07708      }
<a name="l07709"></a>07709      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($this-&gt;keep_block_together) &amp;&amp; (!$this-&gt;processingHeader) &amp;&amp; (!$this-&gt;processingFooter)) {
<a name="l07710"></a>07710     <span class="comment">// Captures eveything in buffer; </span>
<a name="l07711"></a>07711     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/q \d+\.\d\d+ 0 0 (\d+\.\d\d+) \d+\.\d\d+ \d+\.\d\d+ cm \/I\d+ Do Q/&#39;</span>,$s,$m)) { <span class="comment">// Image data</span>
<a name="l07712"></a>07712       $h = ($m[1]/$this-&gt;k);
<a name="l07713"></a>07713       <span class="comment">// Update/overwrite the lowest bottom of printing y value for Keep together block</span>
<a name="l07714"></a>07714       $this-&gt;ktBlock[$this-&gt;page][<span class="stringliteral">&#39;bottom_margin&#39;</span>] = $this-&gt;y+$h;
<a name="l07715"></a>07715     }
<a name="l07716"></a>07716     <span class="keywordflow">else</span> {  <span class="comment">// Td Text Set in Cell()</span>
<a name="l07717"></a>07717       <span class="keywordflow">if</span> (isset($this-&gt;ktBlock[$this-&gt;page][<span class="stringliteral">&#39;bottom_margin&#39;</span>])) { $h = $this-&gt;ktBlock[$this-&gt;page][<span class="stringliteral">&#39;bottom_margin&#39;</span>] - $this-&gt;y; }
<a name="l07718"></a>07718       <span class="keywordflow">else</span> { $h = 0; }
<a name="l07719"></a>07719     }
<a name="l07720"></a>07720     <span class="keywordflow">if</span> ($h &lt; 0) { $h = -$h; }
<a name="l07721"></a>07721     $this-&gt;divbuffer[] = array(
<a name="l07722"></a>07722     <span class="stringliteral">&#39;page&#39;</span> =&gt; $this-&gt;page,
<a name="l07723"></a>07723     <span class="charliteral">&#39;s&#39;</span> =&gt; $s,              <span class="comment">// Text string to output </span>
<a name="l07724"></a>07724     <span class="charliteral">&#39;x&#39;</span> =&gt; $this-&gt;x,            <span class="comment">// x when printed </span>
<a name="l07725"></a>07725     <span class="charliteral">&#39;y&#39;</span> =&gt; $this-&gt;y,            <span class="comment">// y when printed (after column break)</span>
<a name="l07726"></a>07726     <span class="charliteral">&#39;h&#39;</span> =&gt; $h             <span class="comment">// actual y at bottom when printed = y+h</span>
<a name="l07727"></a>07727     );
<a name="l07728"></a>07728      }
<a name="l07729"></a>07729      <span class="keywordflow">else</span> {
<a name="l07730"></a>07730     $this-&gt;pages[$this-&gt;page] .= $s.($ln == <span class="keyword">true</span> ? <span class="stringliteral">&quot;\n&quot;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l07731"></a>07731      }
<a name="l07732"></a>07732 
<a name="l07733"></a>07733   }
<a name="l07734"></a>07734   <span class="keywordflow">else</span> {
<a name="l07735"></a>07735     $this-&gt;buffer .= $s.($ln == <span class="keyword">true</span> ? <span class="stringliteral">&quot;\n&quot;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l07736"></a>07736   }
<a name="l07737"></a>07737 }
<a name="l07738"></a>07738 
<a name="l07739"></a>07739 <span class="comment">// add a watermark </span>
<a name="l07740"></a>07740 function watermark( $texte, $angle=45, $fontsize=96, $alpha=0.2 )
<a name="l07741"></a>07741 {
<a name="l07742"></a>07742 
<a name="l07743"></a>07743   <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&#39;PDFA does not permit transparency, so mPDF does not allow Watermarks!&#39;</span>); } <span class="comment">// mPDF 4.2.018</span>
<a name="l07744"></a>07744   <span class="keywordflow">if</span> (!$this-&gt;watermark_font) { $this-&gt;watermark_font = $this-&gt;default_font; }
<a name="l07745"></a>07745       $this-&gt;SetFont( $this-&gt;watermark_font, <span class="stringliteral">&quot;B&quot;</span>, $fontsize, <span class="keyword">false</span> ); <span class="comment">// Don&#39;t output</span>
<a name="l07746"></a>07746   $texte= $this-&gt;purify_utf8_text($texte);
<a name="l07747"></a>07747   <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l07748"></a>07748     $texte= $this-&gt;all_entities_to_utf8($texte);
<a name="l07749"></a>07749   }
<a name="l07750"></a>07750   <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $texte = mb_convert_encoding($texte,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l07751"></a>07751   <span class="comment">// DIRECTIONALITY</span>
<a name="l07752"></a>07752   <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l07753"></a>07753 
<a name="l07754"></a>07754   $this-&gt;SetAlpha($alpha);
<a name="l07755"></a>07755 
<a name="l07756"></a>07756   $this-&gt;SetTextColor(0);
<a name="l07757"></a>07757   $szfont = $fontsize;
<a name="l07758"></a>07758   $loop   = 0;
<a name="l07759"></a>07759   $maxlen = (min($this-&gt;w,$this-&gt;h) );  <span class="comment">// sets max length of text as 7/8 width/height of page</span>
<a name="l07760"></a>07760   <span class="keywordflow">while</span> ( $loop == 0 )
<a name="l07761"></a>07761   {
<a name="l07762"></a>07762        $this-&gt;SetFont( $this-&gt;watermark_font, <span class="stringliteral">&quot;B&quot;</span>, $szfont, <span class="keyword">false</span> );  <span class="comment">// Don&#39;t output</span>
<a name="l07763"></a>07763    $offset =  ((sin(deg2rad($angle))) * ($szfont/$this-&gt;k));
<a name="l07764"></a>07764 
<a name="l07765"></a>07765        $strlen = $this-&gt;GetStringWidth($texte);
<a name="l07766"></a>07766        <span class="keywordflow">if</span> ( $strlen &gt; $maxlen - $offset  )
<a name="l07767"></a>07767           $szfont --;
<a name="l07768"></a>07768        <span class="keywordflow">else</span>
<a name="l07769"></a>07769           $loop ++;
<a name="l07770"></a>07770   }
<a name="l07771"></a>07771 
<a name="l07772"></a>07772   $this-&gt;SetFont( $this-&gt;watermark_font, <span class="stringliteral">&quot;B&quot;</span>, $szfont-0.1, <span class="keyword">true</span>, <span class="keyword">true</span>); <span class="comment">// Output The -0.1 is because SetFont above is not written to PDF</span>
<a name="l07773"></a>07773                       <span class="comment">// Repeating it will not output anything as mPDF thinks it is set</span>
<a name="l07774"></a>07774   $adj = ((cos(deg2rad($angle))) * ($strlen/2));
<a name="l07775"></a>07775   $opp = ((sin(deg2rad($angle))) * ($strlen/2));
<a name="l07776"></a>07776   $wx = ($this-&gt;w/2) - $adj + $offset/3;
<a name="l07777"></a>07777   $wy = ($this-&gt;h/2) + $opp;
<a name="l07778"></a>07778   $this-&gt;Rotate($angle,$wx,$wy);
<a name="l07779"></a>07779   $this-&gt;Text($wx,$wy,$texte);
<a name="l07780"></a>07780   $this-&gt;Rotate(0);
<a name="l07781"></a>07781   $this-&gt;SetTextColor(0,0,0);
<a name="l07782"></a>07782 
<a name="l07783"></a>07783   $this-&gt;SetAlpha(1);
<a name="l07784"></a>07784 
<a name="l07785"></a>07785 }
<a name="l07786"></a>07786 
<a name="l07787"></a>07787 <span class="comment">// add a watermark Image</span>
<a name="l07788"></a>07788 function watermarkImg( $src, $alpha=0.2 ) {
<a name="l07789"></a>07789   <span class="keywordflow">if</span> ($this-&gt;PDFA) { $this-&gt;Error(<span class="stringliteral">&#39;PDFA does not permit transparency, so mPDF does not allow Watermarks!&#39;</span>); } <span class="comment">// mPDF 4.2.018</span>
<a name="l07790"></a>07790   <span class="comment">// mPDF 4.3.018</span>
<a name="l07791"></a>07791   <span class="keywordflow">if</span> ($this-&gt;watermarkImgBehind) { $this-&gt;watermarkImgAlpha = $this-&gt;SetAlpha($alpha, <span class="stringliteral">&#39;Normal&#39;</span>, <span class="keyword">true</span>); }
<a name="l07792"></a>07792   <span class="keywordflow">else</span> { $this-&gt;SetAlpha($alpha); }
<a name="l07793"></a>07793   $this-&gt;Image($src,0,0,0,0,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l07794"></a>07794   <span class="comment">// mPDF 4.3.018</span>
<a name="l07795"></a>07795   <span class="keywordflow">if</span> (!$this-&gt;watermarkImgBehind) { $this-&gt;SetAlpha(1); }
<a name="l07796"></a>07796 }
<a name="l07797"></a>07797 
<a name="l07798"></a>07798 
<a name="l07799"></a>07799 function Rotate($angle,$x=-1,$y=-1)
<a name="l07800"></a>07800 {
<a name="l07801"></a>07801   <span class="keywordflow">if</span>($x==-1)
<a name="l07802"></a>07802     $x=$this-&gt;x;
<a name="l07803"></a>07803   <span class="keywordflow">if</span>($y==-1)
<a name="l07804"></a>07804     $y=$this-&gt;y;
<a name="l07805"></a>07805   <span class="keywordflow">if</span>($this-&gt;angle!=0)
<a name="l07806"></a>07806     $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l07807"></a>07807   $this-&gt;angle=$angle;
<a name="l07808"></a>07808   <span class="keywordflow">if</span>($angle!=0)
<a name="l07809"></a>07809   {
<a name="l07810"></a>07810     $angle*=M_PI/180;
<a name="l07811"></a>07811     $c=cos($angle);
<a name="l07812"></a>07812     $s=sin($angle);
<a name="l07813"></a>07813     $cx=$x*$this-&gt;k;
<a name="l07814"></a>07814     $cy=($this-&gt;h-$y)*$this-&gt;k;
<a name="l07815"></a>07815     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;q %.5f %.5f %.5f %.5f %.3f %.3f cm 1 0 0 1 %.3f %.3f cm&#39;</span>,$c,$s,-$s,$c,$cx,$cy,-$cx,-$cy));
<a name="l07816"></a>07816   }
<a name="l07817"></a>07817 }
<a name="l07818"></a>07818 
<a name="l07819"></a>07819 <span class="comment">// From Invoice</span>
<a name="l07820"></a>07820 function RoundedRect($x, $y, $w, $h, $r, $style = <span class="stringliteral">&#39;&#39;</span>)
<a name="l07821"></a>07821 {
<a name="l07822"></a>07822   $k = $this-&gt;k;
<a name="l07823"></a>07823   $hp = $this-&gt;h;
<a name="l07824"></a>07824   <span class="keywordflow">if</span>($style==<span class="charliteral">&#39;F&#39;</span>)
<a name="l07825"></a>07825     $op=<span class="charliteral">&#39;f&#39;</span>;
<a name="l07826"></a>07826   elseif($style==<span class="stringliteral">&#39;FD&#39;</span> or $style==<span class="stringliteral">&#39;DF&#39;</span>)
<a name="l07827"></a>07827     $op=&#39;B&#39;;
<a name="l07828"></a>07828   else
<a name="l07829"></a>07829     $op=&#39;S&#39;;
<a name="l07830"></a>07830   $MyArc = 4/3 * (sqrt(2) - 1);
<a name="l07831"></a>07831   $this-&gt;_out(sprintf(&#39;%.3f %.3f m&#39;,($x+$r)*$k,($hp-$y)*$k ));
<a name="l07832"></a>07832   $xc = $x+$w-$r ;
<a name="l07833"></a>07833   $yc = $y+$r;
<a name="l07834"></a>07834   $this-&gt;_out(sprintf(&#39;%.3f %.3f l&#39;, $xc*$k,($hp-$y)*$k ));
<a name="l07835"></a>07835 
<a name="l07836"></a>07836   $this-&gt;_Arc($xc + $r*$MyArc, $yc - $r, $xc + $r, $yc - $r*$MyArc, $xc + $r, $yc);
<a name="l07837"></a>07837   $xc = $x+$w-$r ;
<a name="l07838"></a>07838   $yc = $y+$h-$r;
<a name="l07839"></a>07839   $this-&gt;_out(sprintf(&#39;%.3f %.3f l&#39;,($x+$w)*$k,($hp-$yc)*$k));
<a name="l07840"></a>07840   $this-&gt;_Arc($xc + $r, $yc + $r*$MyArc, $xc + $r*$MyArc, $yc + $r, $xc, $yc + $r);
<a name="l07841"></a>07841   $xc = $x+$r ;
<a name="l07842"></a>07842   $yc = $y+$h-$r;
<a name="l07843"></a>07843   $this-&gt;_out(sprintf(&#39;%.3f %.3f l&#39;,$xc*$k,($hp-($y+$h))*$k));
<a name="l07844"></a>07844   $this-&gt;_Arc($xc - $r*$MyArc, $yc + $r, $xc - $r, $yc + $r*$MyArc, $xc - $r, $yc);
<a name="l07845"></a>07845   $xc = $x+$r ;
<a name="l07846"></a>07846   $yc = $y+$r;
<a name="l07847"></a>07847   $this-&gt;_out(sprintf(&#39;%.3f %.3f l&#39;,($x)*$k,($hp-$yc)*$k ));
<a name="l07848"></a>07848   $this-&gt;_Arc($xc - $r, $yc - $r*$MyArc, $xc - $r*$MyArc, $yc - $r, $xc, $yc - $r);
<a name="l07849"></a>07849   $this-&gt;_out($op);
<a name="l07850"></a>07850 }
<a name="l07851"></a>07851 
<a name="l07852"></a>07852 function _Arc($x1, $y1, $x2, $y2, $x3, $y3)
<a name="l07853"></a>07853 {
<a name="l07854"></a>07854   $h = $this-&gt;h;
<a name="l07855"></a>07855   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f c &#39;</span>, $x1*$this-&gt;k, ($h-$y1)*$this-&gt;k,
<a name="l07856"></a>07856             $x2*$this-&gt;k, ($h-$y2)*$this-&gt;k, $x3*$this-&gt;k, ($h-$y3)*$this-&gt;k));
<a name="l07857"></a>07857 }
<a name="l07858"></a>07858 
<a name="l07859"></a>07859 
<a name="l07860"></a>07860 
<a name="l07861"></a>07861 
<a name="l07862"></a>07862 <span class="comment">//====================================================</span>
<a name="l07863"></a>07863 
<a name="l07864"></a>07864 
<a name="l07865"></a>07865 
<a name="l07866"></a>07866 <span class="comment">// Label and number of invoice/estimate</span>
<a name="l07867"></a>07867 
<a name="l07868"></a>07868 
<a name="l07869"></a>07869 
<a name="l07870"></a>07870 
<a name="l07871"></a>07871 
<a name="l07872"></a>07872 <span class="comment">// Converts UTF-8 strings to codepoints array.&lt;br&gt;</span>
<a name="l07873"></a>07873 function UTF8StringToArray($str) {
<a name="l07874"></a>07874       $unicode = array(); <span class="comment">// array containing unicode values</span>
<a name="l07875"></a>07875       $bytes  = array(); <span class="comment">// array containing single character byte sequences</span>
<a name="l07876"></a>07876       $numbytes  = 1; <span class="comment">// number of octetc needed to represent the UTF-8 character</span>
<a name="l07877"></a>07877       
<a name="l07878"></a>07878       $str .= <span class="stringliteral">&quot;&quot;</span>; <span class="comment">// force $str to be a string</span>
<a name="l07879"></a>07879       $length = strlen($str);
<a name="l07880"></a>07880       
<a name="l07881"></a>07881       <span class="keywordflow">for</span>($i = 0; $i &lt; $length; $i++) {
<a name="l07882"></a>07882         $char = $this-&gt;ords[substr($str,$i,1)]; <span class="comment">// get one string character at time</span>
<a name="l07883"></a>07883         <span class="keywordflow">if</span>(count($bytes) == 0) { <span class="comment">// get starting octect</span>
<a name="l07884"></a>07884           <span class="keywordflow">if</span> ($char &lt;= 0x7F) {
<a name="l07885"></a>07885             $unicode[] = $char; <span class="comment">// use the character &quot;as is&quot; because is ASCII</span>
<a name="l07886"></a>07886             $numbytes = 1;
<a name="l07887"></a>07887           } elseif (($char &gt;&gt; 0x05) == 0x06) { <span class="comment">// 2 bytes character (0x06 = 110 BIN)</span>
<a name="l07888"></a>07888             $bytes[] = ($char - 0xC0) &lt;&lt; 0x06; 
<a name="l07889"></a>07889             $numbytes = 2;
<a name="l07890"></a>07890           } elseif (($char &gt;&gt; 0x04) == 0x0E) { <span class="comment">// 3 bytes character (0x0E = 1110 BIN)</span>
<a name="l07891"></a>07891             $bytes[] = ($char - 0xE0) &lt;&lt; 0x0C; 
<a name="l07892"></a>07892             $numbytes = 3;
<a name="l07893"></a>07893           } elseif (($char &gt;&gt; 0x03) == 0x1E) { <span class="comment">// 4 bytes character (0x1E = 11110 BIN)</span>
<a name="l07894"></a>07894             $bytes[] = ($char - 0xF0) &lt;&lt; 0x12; 
<a name="l07895"></a>07895             $numbytes = 4;
<a name="l07896"></a>07896           } <span class="keywordflow">else</span> {
<a name="l07897"></a>07897             <span class="comment">// use replacement character for other invalid sequences</span>
<a name="l07898"></a>07898             $unicode[] = 0xFFFD;
<a name="l07899"></a>07899             $bytes = array();
<a name="l07900"></a>07900             $numbytes = 1;
<a name="l07901"></a>07901           }
<a name="l07902"></a>07902         } elseif (($char &gt;&gt; 0x06) == 0x02) { <span class="comment">// bytes 2, 3 and 4 must start with 0x02 = 10 BIN</span>
<a name="l07903"></a>07903           $bytes[] = $char - 0x80;
<a name="l07904"></a>07904           <span class="keywordflow">if</span> (count($bytes) == $numbytes) {
<a name="l07905"></a>07905             <span class="comment">// compose UTF-8 bytes to a single unicode value</span>
<a name="l07906"></a>07906             $char = $bytes[0];
<a name="l07907"></a>07907             <span class="keywordflow">for</span>($j = 1; $j &lt; $numbytes; $j++) {
<a name="l07908"></a>07908               $char += ($bytes[$j] &lt;&lt; (($numbytes - $j - 1) * 0x06));
<a name="l07909"></a>07909             }
<a name="l07910"></a>07910             <span class="keywordflow">if</span> ((($char &gt;= 0xD800) AND ($char &lt;= 0xDFFF)) OR ($char &gt;= 0x10FFFF)) {
<a name="l07911"></a>07911               <span class="comment">// The definition of UTF-8 prohibits encoding character numbers between</span>
<a name="l07912"></a>07912               <span class="comment">// U+D800 and U+DFFF, which are reserved for use with the UTF-16</span>
<a name="l07913"></a>07913               <span class="comment">// encoding form (as surrogate pairs) and do not directly represent</span>
<a name="l07914"></a>07914               <span class="comment">// characters.</span>
<a name="l07915"></a>07915               $unicode[] = 0xFFFD; <span class="comment">// use replacement character</span>
<a name="l07916"></a>07916             }
<a name="l07917"></a>07917             <span class="keywordflow">else</span> {
<a name="l07918"></a>07918               $unicode[] = $char; <span class="comment">// add char to array</span>
<a name="l07919"></a>07919             }
<a name="l07920"></a>07920             <span class="comment">// reset data for next char</span>
<a name="l07921"></a>07921             $bytes = array(); 
<a name="l07922"></a>07922             $numbytes = 1;
<a name="l07923"></a>07923           }
<a name="l07924"></a>07924         } <span class="keywordflow">else</span> {
<a name="l07925"></a>07925           <span class="comment">// use replacement character for other invalid sequences</span>
<a name="l07926"></a>07926           $unicode[] = 0xFFFD;
<a name="l07927"></a>07927           $bytes = array();
<a name="l07928"></a>07928           $numbytes = 1;
<a name="l07929"></a>07929         }
<a name="l07930"></a>07930       }
<a name="l07931"></a>07931       <span class="keywordflow">return</span> $unicode;
<a name="l07932"></a>07932 }
<a name="l07933"></a>07933 
<a name="l07934"></a>07934 
<a name="l07935"></a>07935 <span class="comment">// mPDF 4.0 Convert utf-8 string to &lt;HHHHHH&gt; for Font Subsets</span>
<a name="l07936"></a>07936 function UTF8toSubset($str) {
<a name="l07937"></a>07937   $ret = <span class="charliteral">&#39;&lt;&#39;</span>;
<a name="l07938"></a>07938   <span class="comment">// mPDF 4.0</span>
<a name="l07939"></a>07939   $str = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($this-&gt;aliasNbPg,<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>, chr(7), $str );
<a name="l07940"></a>07940   $str = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($this-&gt;aliasNbPgGp,<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>, chr(8), $str );
<a name="l07941"></a>07941   $unicode = $this-&gt;UTF8StringToArray($str);
<a name="l07942"></a>07942   $orig_fid = $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][0];
<a name="l07943"></a>07943   $last_fid = $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][0];
<a name="l07944"></a>07944   <span class="keywordflow">foreach</span>($unicode as $c) {
<a name="l07945"></a>07945      <span class="comment">// mPDF 4.0</span>
<a name="l07946"></a>07946      <span class="keywordflow">if</span> ($c == 7 || $c == 8) { 
<a name="l07947"></a>07947       <span class="keywordflow">if</span> ($orig_fid != $last_fid) {
<a name="l07948"></a>07948         $ret .= <span class="stringliteral">&#39;&gt; Tj /F&#39;</span>.$orig_fid.<span class="charliteral">&#39; &#39;</span>.$this-&gt;FontSizePt.<span class="stringliteral">&#39; Tf &lt;&#39;</span>;
<a name="l07949"></a>07949         $last_fid = $orig_fid;
<a name="l07950"></a>07950       }
<a name="l07951"></a>07951       <span class="keywordflow">if</span> ($c == 7) { $ret .= $this-&gt;aliasNbPg; }
<a name="l07952"></a>07952       <span class="keywordflow">else</span> { $ret .= $this-&gt;aliasNbPgGp; }
<a name="l07953"></a>07953       <span class="keywordflow">continue</span>;
<a name="l07954"></a>07954      }
<a name="l07955"></a>07955      <span class="keywordflow">for</span> ($i=0; $i&lt;99; $i++) {
<a name="l07956"></a>07956     <span class="comment">// return c as decimal char</span>
<a name="l07957"></a>07957     $init = array_search($c, $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsets&#39;</span>][$i]);
<a name="l07958"></a>07958     <span class="keywordflow">if</span> ($init!==<span class="keyword">false</span>) {
<a name="l07959"></a>07959       <span class="keywordflow">if</span> ($this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$i] != $last_fid) {
<a name="l07960"></a>07960         $ret .= <span class="stringliteral">&#39;&gt; Tj /F&#39;</span>.$this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$i].<span class="charliteral">&#39; &#39;</span>.$this-&gt;FontSizePt.<span class="stringliteral">&#39; Tf &lt;&#39;</span>;
<a name="l07961"></a>07961         $last_fid = $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$i];
<a name="l07962"></a>07962       }
<a name="l07963"></a>07963       $ret .= sprintf(<span class="stringliteral">&quot;%02s&quot;</span>, strtoupper(dechex($init)));
<a name="l07964"></a>07964       <span class="keywordflow">break</span>;
<a name="l07965"></a>07965     }
<a name="l07966"></a>07966     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($this-&gt;CurrentFont[<span class="stringliteral">&#39;subsets&#39;</span>][$i]) &lt; 255) {
<a name="l07967"></a>07967       $n = count($this-&gt;CurrentFont[<span class="stringliteral">&#39;subsets&#39;</span>][$i]);
<a name="l07968"></a>07968       $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsets&#39;</span>][$i][$n] = $c;
<a name="l07969"></a>07969       <span class="keywordflow">if</span> ($this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$i] != $last_fid) {
<a name="l07970"></a>07970         $ret .= <span class="stringliteral">&#39;&gt; Tj /F&#39;</span>.$this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$i].<span class="charliteral">&#39; &#39;</span>.$this-&gt;FontSizePt.<span class="stringliteral">&#39; Tf &lt;&#39;</span>;
<a name="l07971"></a>07971         $last_fid = $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$i];
<a name="l07972"></a>07972       }
<a name="l07973"></a>07973       $ret .= sprintf(<span class="stringliteral">&quot;%02s&quot;</span>, strtoupper(dechex($n)));
<a name="l07974"></a>07974       <span class="keywordflow">break</span>;
<a name="l07975"></a>07975     }
<a name="l07976"></a>07976     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;subsets&#39;</span>][($i+1)])) {
<a name="l07977"></a>07977       $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsets&#39;</span>][($i+1)] = range(0,32);
<a name="l07978"></a>07978       $new_fid = count($this-&gt;fonts)+$this-&gt;extraFontSubsets+1;
<a name="l07979"></a>07979       $this-&gt;CurrentFont[<span class="stringliteral">&#39;subsetfontids&#39;</span>][($i+1)] = $new_fid;
<a name="l07980"></a>07980       $this-&gt;extraFontSubsets++;
<a name="l07981"></a>07981     }
<a name="l07982"></a>07982      }
<a name="l07983"></a>07983   }
<a name="l07984"></a>07984   $ret .= <span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l07985"></a>07985   <span class="keywordflow">if</span> ($last_fid != $orig_fid) {
<a name="l07986"></a>07986     $ret .= <span class="stringliteral">&#39; Tj /F&#39;</span>.$orig_fid.<span class="charliteral">&#39; &#39;</span>.$this-&gt;FontSizePt.<span class="stringliteral">&#39; Tf &lt;&gt; &#39;</span>;
<a name="l07987"></a>07987   }
<a name="l07988"></a>07988   <span class="keywordflow">return</span> $ret;
<a name="l07989"></a>07989 }
<a name="l07990"></a>07990 
<a name="l07991"></a>07991 
<a name="l07992"></a>07992 <span class="comment">// Converts UTF-8 strings to UTF16-BE.</span>
<a name="l07993"></a>07993 function UTF8ToUTF16BE($str, $setbom=<span class="keyword">true</span>) {
<a name="l07994"></a>07994   $outstr = <span class="stringliteral">&quot;&quot;</span>; <span class="comment">// string to be returned</span>
<a name="l07995"></a>07995   <span class="keywordflow">if</span> ($setbom) {
<a name="l07996"></a>07996     $outstr .= <span class="stringliteral">&quot;\xFE\xFF&quot;</span>; <span class="comment">// Byte Order Mark (BOM)</span>
<a name="l07997"></a>07997   }
<a name="l07998"></a>07998   $outstr .= mb_convert_encoding($str, <span class="stringliteral">&#39;UTF-16BE&#39;</span>, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l07999"></a>07999   <span class="keywordflow">return</span> $outstr;
<a name="l08000"></a>08000 }
<a name="l08001"></a>08001 
<a name="l08002"></a>08002 
<a name="l08003"></a>08003 
<a name="l08004"></a>08004 
<a name="l08005"></a>08005 function _getfontpath() {
<a name="l08006"></a>08006   <span class="comment">// mPDF 4.0  Depracated. Use MPDF_FONTPATH</span>
<a name="l08007"></a>08007   <span class="keywordflow">return</span> defined(<span class="stringliteral">&#39;MPDF_FONTPATH&#39;</span>) ? MPDF_FONTPATH : <span class="stringliteral">&#39;&#39;</span>;
<a name="l08008"></a>08008 }
<a name="l08009"></a>08009 
<a name="l08010"></a>08010 
<a name="l08011"></a>08011 
<a name="l08012"></a>08012 
<a name="l08013"></a>08013 <span class="comment">// ====================================================</span>
<a name="l08014"></a>08014 <span class="comment">// ====================================================</span>
<a name="l08015"></a>08015 
<a name="l08016"></a>08016 
<a name="l08017"></a>08017 
<a name="l08018"></a>08018 
<a name="l08026"></a>08026 function SetAutoFont($af = AUTOFONT_ALL) {
<a name="l08027"></a>08027   <span class="keywordflow">if</span> (!$this-&gt;is_MB) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l08028"></a>08028   <span class="keywordflow">if</span> (!$af &amp;&amp; $af !== 0) { $af = AUTOFONT_ALL; }
<a name="l08029"></a>08029   $this-&gt;autoFontGroups = $af;
<a name="l08030"></a>08030   <span class="keywordflow">if</span> ($this-&gt;autoFontGroups ) { 
<a name="l08031"></a>08031     $this-&gt;useSubstitutions = <span class="keyword">false</span>; 
<a name="l08032"></a>08032     $this-&gt;useLang = <span class="keyword">true</span>;
<a name="l08033"></a>08033     <span class="comment">// mPDF 4.0</span>
<a name="l08034"></a>08034   }
<a name="l08035"></a>08035 }
<a name="l08036"></a>08036 
<a name="l08037"></a>08037 
<a name="l08038"></a>08038 function SetDefaultFont($font) {
<a name="l08039"></a>08039   <span class="comment">// Disallow embedded fonts to be used as defaults except in win-1252</span>
<a name="l08040"></a>08040   <span class="keywordflow">if</span> ($this-&gt;codepage != <span class="stringliteral">&#39;win-1252&#39;</span> || $this-&gt;PDFA) { <span class="comment">// mPDF 4.2.018</span>
<a name="l08041"></a>08041     <span class="keywordflow">if</span> (strtolower($font) == <span class="stringliteral">&#39;times&#39;</span>) { $font = <span class="stringliteral">&#39;serif&#39;</span>; }
<a name="l08042"></a>08042     <span class="keywordflow">if</span> (strtolower($font) == <span class="stringliteral">&#39;courier&#39;</span>) { $font = <span class="stringliteral">&#39;monospace&#39;</span>; }
<a name="l08043"></a>08043     <span class="keywordflow">if</span> ((strtolower($font) == <span class="stringliteral">&#39;arial&#39;</span>) || (strtolower($font) == <span class="stringliteral">&#39;helvetica&#39;</span>)) { $font = <span class="stringliteral">&#39;sans-serif&#39;</span>; }
<a name="l08044"></a>08044   }
<a name="l08045"></a>08045     $font = $this-&gt;SetFont($font);  <span class="comment">// returns substituted font if necessary</span>
<a name="l08046"></a>08046   $this-&gt;default_font = $font;
<a name="l08047"></a>08047   $this-&gt;original_default_font = $font;
<a name="l08048"></a>08048   <span class="keywordflow">if</span> (!$this-&gt;watermark_font ) { $this-&gt;watermark_font = $font; } <span class="comment">// *WATERMARK*</span>
<a name="l08049"></a>08049   $this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $font; <span class="comment">// mPDF 4.2</span>
<a name="l08050"></a>08050   $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $font;  <span class="comment">// mPDF 4.2</span>
<a name="l08051"></a>08051 }
<a name="l08052"></a>08052 
<a name="l08053"></a>08053 function SetDefaultFontSize($fontsize) {
<a name="l08054"></a>08054   $this-&gt;default_font_size = $fontsize;
<a name="l08055"></a>08055   $this-&gt;original_default_font_size = $fontsize;
<a name="l08056"></a>08056   $this-&gt;SetFontSize($fontsize);
<a name="l08057"></a>08057   $this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $fontsize . <span class="stringliteral">&#39;pt&#39;</span>;
<a name="l08058"></a>08058   $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $fontsize . <span class="stringliteral">&#39;pt&#39;</span>; <span class="comment">// mPDF 4.2</span>
<a name="l08059"></a>08059 }
<a name="l08060"></a>08060 
<a name="l08061"></a>08061 <span class="comment">// mPDF 4.2</span>
<a name="l08062"></a>08062 function SetDefaultBodyCSS($prop, $val) {
<a name="l08063"></a>08063    <span class="keywordflow">if</span> ($prop) {
<a name="l08064"></a>08064   $this-&gt;defaultCSS[<span class="stringliteral">&#39;BODY&#39;</span>][strtoupper($prop)] = $val;
<a name="l08065"></a>08065   $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][strtoupper($prop)] = $val;
<a name="l08066"></a>08066   }
<a name="l08067"></a>08067 }
<a name="l08068"></a>08068 
<a name="l08069"></a>08069 
<a name="l08070"></a>08070 function SetDirectionality($dir=<span class="stringliteral">&#39;ltr&#39;</span>) {
<a name="l08071"></a>08071     $this-&gt;directionality = <span class="stringliteral">&#39;ltr&#39;</span>; 
<a name="l08072"></a>08072     $this-&gt;defaultAlign = <span class="charliteral">&#39;L&#39;</span>;
<a name="l08073"></a>08073     $this-&gt;defaultTableAlign = <span class="charliteral">&#39;L&#39;</span>;
<a name="l08074"></a>08074 }
<a name="l08075"></a>08075 
<a name="l08076"></a>08076 function reverse_align(&amp;$align) {
<a name="l08077"></a>08077   <span class="keywordflow">if</span> (strtolower($align) == <span class="stringliteral">&#39;right&#39;</span>) { $align = <span class="stringliteral">&#39;left&#39;</span>; }
<a name="l08078"></a>08078   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtolower($align) == <span class="stringliteral">&#39;left&#39;</span>) { $align = <span class="stringliteral">&#39;right&#39;</span>; }
<a name="l08079"></a>08079   <span class="keywordflow">if</span> (strtoupper($align) == <span class="charliteral">&#39;R&#39;</span>) { $align = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l08080"></a>08080   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($align) == <span class="charliteral">&#39;L&#39;</span>) { $align = <span class="charliteral">&#39;R&#39;</span>; }
<a name="l08081"></a>08081 }
<a name="l08082"></a>08082 
<a name="l08083"></a>08083 
<a name="l08084"></a>08084 <span class="comment">// Added to set line-height-correction</span>
<a name="l08085"></a>08085 function SetLineHeightCorrection($val) {
<a name="l08086"></a>08086   <span class="keywordflow">if</span> ($val &gt; 0) { $this-&gt;default_lineheight_correction = $val; }
<a name="l08087"></a>08087   <span class="keywordflow">else</span> { $this-&gt;default_lineheight_correction = 1.2; }
<a name="l08088"></a>08088 }
<a name="l08089"></a>08089 
<a name="l08090"></a>08090 <span class="comment">// Set a (fixed) lineheight to an actual value - either to named fontsize(pts) or default</span>
<a name="l08091"></a>08091 <span class="comment">// mPDF 4.2</span>
<a name="l08092"></a>08092 function SetLineHeight($FontPt=<span class="stringliteral">&#39;&#39;</span>,$spacing = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08093"></a>08093    <span class="keywordflow">if</span> ($this-&gt;shrin_k &gt; 1) { $k = $this-&gt;shrin_k; }
<a name="l08094"></a>08094    <span class="keywordflow">else</span> { $k = 1; }
<a name="l08095"></a>08095    <span class="keywordflow">if</span> ($spacing &gt; 0) { 
<a name="l08096"></a>08096   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/mm/&#39;</span>,$spacing)) { 
<a name="l08097"></a>08097     $this-&gt;lineheight = ($spacing + 0.0) / $k; <span class="comment">// convert to number</span>
<a name="l08098"></a>08098   }
<a name="l08099"></a>08099   <span class="keywordflow">else</span>  { 
<a name="l08100"></a>08100     <span class="keywordflow">if</span> ($FontPt) { $this-&gt;lineheight = (($FontPt/$this-&gt;k) *$spacing); }
<a name="l08101"></a>08101     <span class="keywordflow">else</span> { $this-&gt;lineheight = (($this-&gt;FontSizePt/$this-&gt;k) *$spacing); }
<a name="l08102"></a>08102   }
<a name="l08103"></a>08103    }
<a name="l08104"></a>08104    <span class="keywordflow">else</span> {
<a name="l08105"></a>08105   <span class="keywordflow">if</span> ($FontPt) { $this-&gt;lineheight = (($FontPt/$this-&gt;k) *$this-&gt;normalLineheight); }
<a name="l08106"></a>08106   <span class="keywordflow">else</span> { $this-&gt;lineheight = (($this-&gt;FontSizePt/$this-&gt;k) *$this-&gt;normalLineheight); }
<a name="l08107"></a>08107    }
<a name="l08108"></a>08108 }
<a name="l08109"></a>08109 
<a name="l08110"></a>08110 <span class="comment">// mPDF 4.2</span>
<a name="l08111"></a>08111 function _computeLineheight($lh, $fs=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08112"></a>08112   <span class="keywordflow">if</span> ($this-&gt;shrin_k &gt; 1) { $k = $this-&gt;shrin_k; }
<a name="l08113"></a>08113   <span class="keywordflow">else</span> { $k = 1; }
<a name="l08114"></a>08114   <span class="keywordflow">if</span> (!$fs) { $fs = $this-&gt;FontSize; }
<a name="l08115"></a>08115   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/mm/&#39;</span>,$lh)) { 
<a name="l08116"></a>08116     <span class="keywordflow">return</span> (($lh + 0.0) / $k); <span class="comment">// convert to number</span>
<a name="l08117"></a>08117   }
<a name="l08118"></a>08118   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($lh &gt; 0) { 
<a name="l08119"></a>08119     <span class="keywordflow">return</span> ($fs * $lh);
<a name="l08120"></a>08120   }
<a name="l08121"></a>08121   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;normalLineheight)) { <span class="keywordflow">return</span> ($fs * $this-&gt;normalLineheight); }
<a name="l08122"></a>08122   <span class="keywordflow">else</span> <span class="keywordflow">return</span> ($fs * $this-&gt;default_lineheight_correction); 
<a name="l08123"></a>08123 }
<a name="l08124"></a>08124 
<a name="l08125"></a>08125 
<a name="l08126"></a>08126 function SetBasePath($str=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08127"></a>08127   <span class="comment">// mPDF 4.2.029</span>
<a name="l08128"></a>08128   <span class="keywordflow">if</span> ( isset($_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>]) ) { $host = $_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>]; }
<a name="l08129"></a>08129   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( isset($_SERVER[<span class="stringliteral">&#39;SERVER_NAME&#39;</span>]) ) { $host = $_SERVER[<span class="stringliteral">&#39;SERVER_NAME&#39;</span>]; }
<a name="l08130"></a>08130   <span class="keywordflow">else</span> { $host = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08131"></a>08131   <span class="keywordflow">if</span> (!$str) { 
<a name="l08132"></a>08132   <span class="keywordflow">if</span> ($_SERVER[<span class="stringliteral">&#39;SCRIPT_NAME&#39;</span>]) { $currentPath = dirname($_SERVER[<span class="stringliteral">&#39;SCRIPT_NAME&#39;</span>]); }
<a name="l08133"></a>08133   <span class="keywordflow">else</span> { $currentPath = dirname($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]); }
<a name="l08134"></a>08134   $currentPath = str_replace(<span class="stringliteral">&quot;\\&quot;</span>,<span class="stringliteral">&quot;/&quot;</span>,$currentPath);
<a name="l08135"></a>08135   <span class="keywordflow">if</span> ($currentPath == <span class="charliteral">&#39;/&#39;</span>) { $currentPath = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08136"></a>08136   <span class="keywordflow">if</span> ($host) { $currpath = <span class="stringliteral">&#39;http://&#39;</span> . $host . $currentPath .<span class="charliteral">&#39;/&#39;</span>; }
<a name="l08137"></a>08137   <span class="keywordflow">else</span> { $currpath = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08138"></a>08138   $this-&gt;basepath = $currpath; 
<a name="l08139"></a>08139   $this-&gt;basepathIsLocal = <span class="keyword">true</span>; 
<a name="l08140"></a>08140   <span class="keywordflow">return</span>; 
<a name="l08141"></a>08141   }
<a name="l08142"></a>08142   $str = preg_replace(<span class="stringliteral">&#39;/\?.*/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$str);
<a name="l08143"></a>08143   <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;/(http|https|ftp):\/\/.*\//i&#39;</span>,$str)) { $str .= <span class="charliteral">&#39;/&#39;</span>; } 
<a name="l08144"></a>08144   $str .= <span class="stringliteral">&#39;xxx&#39;</span>;  <span class="comment">// in case $str ends in / e.g. http://www.bbc.co.uk/</span>
<a name="l08145"></a>08145   $this-&gt;basepath = dirname($str) . <span class="stringliteral">&quot;/&quot;</span>;  <span class="comment">// returns e.g. e.g. http://www.google.com/dir1/dir2/dir3/</span>
<a name="l08146"></a>08146   $this-&gt;basepath = str_replace(<span class="stringliteral">&quot;\\&quot;</span>,<span class="stringliteral">&quot;/&quot;</span>,$this-&gt;basepath); <span class="comment">//If on Windows</span>
<a name="l08147"></a>08147   $tr = parse_url($this-&gt;basepath);
<a name="l08148"></a>08148   <span class="keywordflow">if</span> (isset($tr[<span class="stringliteral">&#39;host&#39;</span>]) &amp;&amp; ($tr[<span class="stringliteral">&#39;host&#39;</span>] == $host)) { $this-&gt;basepathIsLocal = <span class="keyword">true</span>; }
<a name="l08149"></a>08149   <span class="keywordflow">else</span> { $this-&gt;basepathIsLocal = <span class="keyword">false</span>; }
<a name="l08150"></a>08150 }
<a name="l08151"></a>08151 
<a name="l08152"></a>08152 <span class="comment">// mPDF 4.0</span>
<a name="l08153"></a>08153 function GetFullPath(&amp;$path,$basepath=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08154"></a>08154   <span class="comment">// When parsing CSS need to pass temporary basepath - so links are relative to current stylesheet</span>
<a name="l08155"></a>08155   <span class="keywordflow">if</span> (!$basepath) { $basepath = $this-&gt;basepath; }
<a name="l08156"></a>08156   <span class="comment">//Fix path value</span>
<a name="l08157"></a>08157   $path = str_replace(<span class="stringliteral">&quot;\\&quot;</span>,<span class="stringliteral">&quot;/&quot;</span>,$path); <span class="comment">//If on Windows</span>
<a name="l08158"></a>08158   <span class="comment">//Get link info and obtain its absolute path</span>
<a name="l08159"></a>08159   $regexp = <span class="stringliteral">&#39;|^./|&#39;</span>;  <span class="comment">// Inadvertently corrects &quot;./path/etc&quot; and &quot;//www.domain.com/etc&quot;</span>
<a name="l08160"></a>08160   $path = preg_replace($regexp,<span class="stringliteral">&#39;&#39;</span>,$path);
<a name="l08161"></a>08161 
<a name="l08162"></a>08162   <span class="keywordflow">if</span>(substr($path,0,1) == <span class="charliteral">&#39;#&#39;</span>) { <span class="keywordflow">return</span>; }
<a name="l08163"></a>08163   <span class="keywordflow">if</span> (stristr($path,<span class="stringliteral">&quot;mailto:&quot;</span>) !== <span class="keyword">false</span>) { <span class="keywordflow">return</span>; }
<a name="l08164"></a>08164   <span class="keywordflow">if</span> (strpos($path,<span class="stringliteral">&quot;../&quot;</span>) !== <span class="keyword">false</span> ) { <span class="comment">//It is a Relative Link</span>
<a name="l08165"></a>08165     $backtrackamount = substr_count($path,<span class="stringliteral">&quot;../&quot;</span>);
<a name="l08166"></a>08166     $maxbacktrack = substr_count($basepath,<span class="stringliteral">&quot;/&quot;</span>) - 1;
<a name="l08167"></a>08167     $filepath = str_replace(<span class="stringliteral">&quot;../&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$path);
<a name="l08168"></a>08168     $path = $basepath;
<a name="l08169"></a>08169     <span class="comment">//If it is an invalid relative link, then make it go to directory root</span>
<a name="l08170"></a>08170     <span class="keywordflow">if</span> ($backtrackamount &gt; $maxbacktrack) $backtrackamount = $maxbacktrack;
<a name="l08171"></a>08171     <span class="comment">//Backtrack some directories</span>
<a name="l08172"></a>08172     <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $backtrackamount + 1 ; $i++ ) $path = substr( $path, 0 , strrpos($path,<span class="stringliteral">&quot;/&quot;</span>) );
<a name="l08173"></a>08173     $path = $path . <span class="stringliteral">&quot;/&quot;</span> . $filepath; <span class="comment">//Make it an absolute path</span>
<a name="l08174"></a>08174   }
<a name="l08175"></a>08175   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strpos($path,<span class="stringliteral">&quot;:/&quot;</span>) === <span class="keyword">false</span> || strpos($path,<span class="stringliteral">&quot;:/&quot;</span>) &gt; 10) { <span class="comment">//It is a Local Link</span>
<a name="l08176"></a>08176     <span class="keywordflow">if</span> (substr($path,0,1) == <span class="stringliteral">&quot;/&quot;</span>) { 
<a name="l08177"></a>08177       $tr = parse_url($basepath);
<a name="l08178"></a>08178       $root = $tr[<span class="stringliteral">&#39;scheme&#39;</span>].<span class="stringliteral">&#39;://&#39;</span>.$tr[<span class="stringliteral">&#39;host&#39;</span>];
<a name="l08179"></a>08179       $path = $root . $path; 
<a name="l08180"></a>08180     }
<a name="l08181"></a>08181     <span class="keywordflow">else</span> { $path = $basepath . $path; }
<a name="l08182"></a>08182   }
<a name="l08183"></a>08183   <span class="comment">//Do nothing if it is an Absolute Link</span>
<a name="l08184"></a>08184 }
<a name="l08185"></a>08185 
<a name="l08186"></a>08186 
<a name="l08187"></a>08187 <span class="comment">// Used for external CSS files</span>
<a name="l08188"></a>08188 function _get_file($path) {
<a name="l08189"></a>08189   <span class="comment">// If local file try using local path (? quicker, but also allowed even if allow_url_fopen false)</span>
<a name="l08190"></a>08190   $contents = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08191"></a>08191   $contents = @file_get_contents($path);
<a name="l08192"></a>08192   <span class="keywordflow">if</span> ($contents) { <span class="keywordflow">return</span> $contents; }
<a name="l08193"></a>08193   <span class="keywordflow">if</span> ($this-&gt;basepathIsLocal) {
<a name="l08194"></a>08194     $tr = parse_url($path);
<a name="l08195"></a>08195     $lp=getenv(<span class="stringliteral">&quot;SCRIPT_NAME&quot;</span>);
<a name="l08196"></a>08196     $ap=realpath($lp);
<a name="l08197"></a>08197     $ap=str_replace(<span class="stringliteral">&quot;\\&quot;</span>,<span class="stringliteral">&quot;/&quot;</span>,$ap);
<a name="l08198"></a>08198     $docroot=substr($ap,0,strpos($ap,$lp));
<a name="l08199"></a>08199     <span class="comment">// WriteHTML parses all paths to full URLs; may be local file name from calling -&gt;Image() directly</span>
<a name="l08200"></a>08200     <span class="keywordflow">if</span> ($tr[<span class="stringliteral">&#39;scheme&#39;</span>] &amp;&amp; $tr[<span class="stringliteral">&#39;host&#39;</span>] &amp;&amp; $_SERVER[<span class="stringliteral">&quot;DOCUMENT_ROOT&quot;</span>] ) { 
<a name="l08201"></a>08201       $localpath = $_SERVER[<span class="stringliteral">&quot;DOCUMENT_ROOT&quot;</span>] . $tr[<span class="stringliteral">&#39;path&#39;</span>]; 
<a name="l08202"></a>08202     }
<a name="l08203"></a>08203     <span class="comment">// DOCUMENT_ROOT is not returned on IIS</span>
<a name="l08204"></a>08204     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($docroot) {
<a name="l08205"></a>08205       $localpath = $docroot . $tr[<span class="stringliteral">&#39;path&#39;</span>];
<a name="l08206"></a>08206     }
<a name="l08207"></a>08207     <span class="keywordflow">else</span> { $localpath = $path; }
<a name="l08208"></a>08208     $contents = @file_get_contents($localpath);
<a name="l08209"></a>08209   }
<a name="l08210"></a>08210   <span class="comment">// if not use full URL</span>
<a name="l08211"></a>08211   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$contents &amp;&amp; !ini_get(<span class="stringliteral">&#39;allow_url_fopen&#39;</span>) &amp;&amp; function_exists(<span class="stringliteral">&quot;curl_init&quot;</span>))  {
<a name="l08212"></a>08212     $ch = curl_init($path);
<a name="l08213"></a>08213     curl_setopt($ch, CURLOPT_HEADER, 0);
<a name="l08214"></a>08214     curl_setopt ( $ch , CURLOPT_RETURNTRANSFER , 1 );
<a name="l08215"></a>08215     $contents = curl_exec($ch);
<a name="l08216"></a>08216     curl_close($ch);
<a name="l08217"></a>08217   }
<a name="l08218"></a>08218   <span class="keywordflow">return</span> $contents;
<a name="l08219"></a>08219 }
<a name="l08220"></a>08220 
<a name="l08221"></a>08221 function UseCSS($opt=<span class="keyword">true</span>)
<a name="l08222"></a>08222 {
<a name="l08223"></a>08223   $this-&gt;usecss=$opt;
<a name="l08224"></a>08224 }
<a name="l08225"></a>08225 
<a name="l08226"></a>08226 function UseTableHeader($opt=<span class="keyword">true</span>)
<a name="l08227"></a>08227 {
<a name="l08228"></a>08228   $this-&gt;usetableheader=$opt;
<a name="l08229"></a>08229 }
<a name="l08230"></a>08230 
<a name="l08231"></a>08231 function UsePRE($opt=<span class="keyword">true</span>)
<a name="l08232"></a>08232 {
<a name="l08233"></a>08233   $this-&gt;usepre=$opt;
<a name="l08234"></a>08234 }
<a name="l08235"></a>08235 
<a name="l08236"></a>08236 <span class="comment">// Edited mPDF 3.0 - added offset &amp; extras (prefix/suffix)</span>
<a name="l08237"></a>08237 function docPageNum($num = 0, $extras = <span class="keyword">false</span>) {
<a name="l08238"></a>08238   <span class="keywordflow">if</span> ($num &lt; 1) { $num = $this-&gt;page; }
<a name="l08239"></a>08239   $type = <span class="charliteral">&#39;1&#39;</span>;  <span class="comment">// set default decimal</span>
<a name="l08240"></a>08240   $ppgno = $num;
<a name="l08241"></a>08241   $suppress = 0;
<a name="l08242"></a>08242   $offset = 0;
<a name="l08243"></a>08243   <span class="comment">// mPDF 4.2.020</span>
<a name="l08244"></a>08244   $lastreset = 0;
<a name="l08245"></a>08245   <span class="keywordflow">foreach</span>($this-&gt;PageNumSubstitutions AS $psarr) {
<a name="l08246"></a>08246     <span class="keywordflow">if</span> ($num &gt;= $psarr[<span class="stringliteral">&#39;from&#39;</span>]) {
<a name="l08247"></a>08247       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]) { 
<a name="l08248"></a>08248         <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]&gt;1) { $offset = $psarr[<span class="stringliteral">&#39;reset&#39;</span>]-1; }
<a name="l08249"></a>08249         $ppgno = $num - $psarr[<span class="stringliteral">&#39;from&#39;</span>] + 1 + $offset; 
<a name="l08250"></a>08250         <span class="comment">// mPDF 4.2.020</span>
<a name="l08251"></a>08251         $lastreset = $psarr[<span class="stringliteral">&#39;from&#39;</span>];
<a name="l08252"></a>08252       }
<a name="l08253"></a>08253       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;type&#39;</span>]) { $type = $psarr[<span class="stringliteral">&#39;type&#39;</span>]; }
<a name="l08254"></a>08254       <span class="keywordflow">if</span> (strtoupper($psarr[<span class="stringliteral">&#39;suppress&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $psarr[<span class="stringliteral">&#39;suppress&#39;</span>]==1) { $suppress = 1; }
<a name="l08255"></a>08255       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($psarr[<span class="stringliteral">&#39;suppress&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>) { $suppress = 0; }
<a name="l08256"></a>08256     }
<a name="l08257"></a>08257   }
<a name="l08258"></a>08258   <span class="keywordflow">if</span> ($suppress) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08259"></a>08259   <span class="comment">// mPDF 4.2.020</span>
<a name="l08260"></a>08260   <span class="keywordflow">foreach</span>($this-&gt;pgsIns AS $k=&gt;$v) {
<a name="l08261"></a>08261     <span class="keywordflow">if</span> ($k&gt;$lastreset &amp;&amp; $k&lt;$num) {
<a name="l08262"></a>08262       $ppgno -= $v;
<a name="l08263"></a>08263     }
<a name="l08264"></a>08264   }
<a name="l08265"></a>08265   <span class="keywordflow">if</span> ($type==<span class="charliteral">&#39;A&#39;</span>) { $ppgno = $this-&gt;dec2alpha($ppgno,<span class="keyword">true</span>); }
<a name="l08266"></a>08266   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type==<span class="charliteral">&#39;a&#39;</span>) { $ppgno = $this-&gt;dec2alpha($ppgno,<span class="keyword">false</span>);}
<a name="l08267"></a>08267   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type==<span class="charliteral">&#39;I&#39;</span>) { $ppgno = $this-&gt;dec2roman($ppgno,<span class="keyword">true</span>); }
<a name="l08268"></a>08268   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type==<span class="charliteral">&#39;i&#39;</span>) { $ppgno = $this-&gt;dec2roman($ppgno,<span class="keyword">false</span>); }
<a name="l08269"></a>08269   <span class="keywordflow">if</span> ($extras) { $ppgno = $this-&gt;pagenumPrefix . $ppgno . $this-&gt;pagenumSuffix; }
<a name="l08270"></a>08270   <span class="keywordflow">return</span> $ppgno;
<a name="l08271"></a>08271 }
<a name="l08272"></a>08272 
<a name="l08273"></a>08273 <span class="comment">// mPDF 3.0</span>
<a name="l08274"></a>08274 function docPageSettings($num = 0) {
<a name="l08275"></a>08275   <span class="comment">// Retruns current type (numberstyle), suppression state for this page number; </span>
<a name="l08276"></a>08276   <span class="comment">// reset is only returned if set for this page number</span>
<a name="l08277"></a>08277   <span class="keywordflow">if</span> ($num &lt; 1) { $num = $this-&gt;page; }
<a name="l08278"></a>08278   $type = <span class="charliteral">&#39;1&#39;</span>;  <span class="comment">// set default decimal</span>
<a name="l08279"></a>08279   $ppgno = $num;
<a name="l08280"></a>08280   $suppress = 0;
<a name="l08281"></a>08281   $offset = 0;
<a name="l08282"></a>08282   $reset = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08283"></a>08283   <span class="keywordflow">foreach</span>($this-&gt;PageNumSubstitutions AS $psarr) {
<a name="l08284"></a>08284     <span class="keywordflow">if</span> ($num &gt;= $psarr[<span class="stringliteral">&#39;from&#39;</span>]) {
<a name="l08285"></a>08285       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]) { 
<a name="l08286"></a>08286         <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]&gt;1) { $offset = $psarr[<span class="stringliteral">&#39;reset&#39;</span>]-1; }
<a name="l08287"></a>08287         $ppgno = $num - $psarr[<span class="stringliteral">&#39;from&#39;</span>] + 1 + $offset; 
<a name="l08288"></a>08288       }
<a name="l08289"></a>08289       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;type&#39;</span>]) { $type = $psarr[<span class="stringliteral">&#39;type&#39;</span>]; }
<a name="l08290"></a>08290       <span class="keywordflow">if</span> (strtoupper($psarr[<span class="stringliteral">&#39;suppress&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $psarr[<span class="stringliteral">&#39;suppress&#39;</span>]==1) { $suppress = 1; }
<a name="l08291"></a>08291       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($psarr[<span class="stringliteral">&#39;suppress&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>) { $suppress = 0; }
<a name="l08292"></a>08292     }
<a name="l08293"></a>08293     <span class="keywordflow">if</span> ($num == $psarr[<span class="stringliteral">&#39;from&#39;</span>]) { $reset = $psarr[<span class="stringliteral">&#39;reset&#39;</span>]; }
<a name="l08294"></a>08294   }
<a name="l08295"></a>08295   <span class="keywordflow">if</span> ($suppress) { $suppress = <span class="stringliteral">&#39;on&#39;</span>; }
<a name="l08296"></a>08296   <span class="keywordflow">else</span> { $suppress = <span class="stringliteral">&#39;off&#39;</span>; }
<a name="l08297"></a>08297   <span class="keywordflow">return</span> array($type, $suppress, $reset);
<a name="l08298"></a>08298 }
<a name="l08299"></a>08299 
<a name="l08300"></a>08300 function docPageNumTotal($num = 0, $extras = <span class="keyword">false</span>) {
<a name="l08301"></a>08301   <span class="keywordflow">if</span> ($num &lt; 1) { $num = $this-&gt;page; }
<a name="l08302"></a>08302   $type = <span class="charliteral">&#39;1&#39;</span>;  <span class="comment">// set default decimal</span>
<a name="l08303"></a>08303   $ppgstart = 1;
<a name="l08304"></a>08304   $ppgend = count($this-&gt;pages)+1; 
<a name="l08305"></a>08305   $suppress = 0;
<a name="l08306"></a>08306   $offset = 0;
<a name="l08307"></a>08307   <span class="keywordflow">foreach</span>($this-&gt;PageNumSubstitutions AS $psarr) {
<a name="l08308"></a>08308     <span class="keywordflow">if</span> ($num &gt;= $psarr[<span class="stringliteral">&#39;from&#39;</span>]) {
<a name="l08309"></a>08309       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]) { 
<a name="l08310"></a>08310         <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]&gt;1) { $offset = $psarr[<span class="stringliteral">&#39;reset&#39;</span>]-1; }
<a name="l08311"></a>08311         $ppgstart = $psarr[<span class="stringliteral">&#39;from&#39;</span>] + $offset; 
<a name="l08312"></a>08312         $ppgend = count($this-&gt;pages)+1 + $offset; 
<a name="l08313"></a>08313       }
<a name="l08314"></a>08314       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;type&#39;</span>]) { $type = $psarr[<span class="stringliteral">&#39;type&#39;</span>]; }
<a name="l08315"></a>08315       <span class="keywordflow">if</span> (strtoupper($psarr[<span class="stringliteral">&#39;suppress&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $psarr[<span class="stringliteral">&#39;suppress&#39;</span>]==1) { $suppress = 1; }
<a name="l08316"></a>08316       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($psarr[<span class="stringliteral">&#39;suppress&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>) { $suppress = 0; }
<a name="l08317"></a>08317     }
<a name="l08318"></a>08318     <span class="keywordflow">if</span> ($num &lt; $psarr[<span class="stringliteral">&#39;from&#39;</span>]) {
<a name="l08319"></a>08319       <span class="keywordflow">if</span> ($psarr[<span class="stringliteral">&#39;reset&#39;</span>]) { 
<a name="l08320"></a>08320         $ppgend = $psarr[<span class="stringliteral">&#39;from&#39;</span>] + $offset; 
<a name="l08321"></a>08321         <span class="keywordflow">break</span>;
<a name="l08322"></a>08322       }
<a name="l08323"></a>08323     }
<a name="l08324"></a>08324   }
<a name="l08325"></a>08325   <span class="keywordflow">if</span> ($suppress) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08326"></a>08326   $ppgno = $ppgend-$ppgstart+$offset; 
<a name="l08327"></a>08327   <span class="keywordflow">if</span> ($extras) { $ppgno = $this-&gt;nbpgPrefix . $ppgno . $this-&gt;nbpgSuffix; }
<a name="l08328"></a>08328   <span class="keywordflow">return</span> $ppgno;
<a name="l08329"></a>08329 }
<a name="l08330"></a>08330 
<a name="l08331"></a>08331 function RestartDocTemplate() {
<a name="l08332"></a>08332   $this-&gt;docTemplateStart = $this-&gt;page;
<a name="l08333"></a>08333 }
<a name="l08334"></a>08334 
<a name="l08335"></a>08335 
<a name="l08336"></a>08336 
<a name="l08337"></a>08337 <span class="comment">//Page header</span>
<a name="l08338"></a>08338 function Header($content=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08339"></a>08339 
<a name="l08340"></a>08340   $this-&gt;cMarginL = 0;
<a name="l08341"></a>08341   $this-&gt;cMarginR = 0;
<a name="l08342"></a>08342 
<a name="l08343"></a>08343   <span class="comment">// mPDF 4.2 </span>
<a name="l08344"></a>08344   <span class="comment">// Template moved to AddPage()</span>
<a name="l08345"></a>08345 
<a name="l08346"></a>08346   <span class="comment">// mPDF 4.0</span>
<a name="l08347"></a>08347   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page%2==0) &amp;&amp; $this-&gt;HTMLHeaderE) || ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page%2==1) &amp;&amp; $this-&gt;HTMLHeader) || (!$this-&gt;mirrorMargins &amp;&amp; $this-&gt;HTMLHeader)) {
<a name="l08348"></a>08348   $this-&gt;writeHTMLHeaders(); 
<a name="l08349"></a>08349   <span class="keywordflow">return</span>;
<a name="l08350"></a>08350   }
<a name="l08351"></a>08351   $this-&gt;processingHeader=<span class="keyword">true</span>;
<a name="l08352"></a>08352   $h = $this-&gt;headerDetails;
<a name="l08353"></a>08353   <span class="keywordflow">if</span>(count($h)) {
<a name="l08354"></a>08354 
<a name="l08355"></a>08355   <span class="keywordflow">if</span> ($this-&gt;forcePortraitHeaders &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;CurOrientation!=$this-&gt;DefOrientation) {
<a name="l08356"></a>08356     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;q 0 -1 1 0 0 %.3f cm &#39;</span>,($this-&gt;h*$this-&gt;k)));
<a name="l08357"></a>08357     $yadj = $this-&gt;w - $this-&gt;h;
<a name="l08358"></a>08358     $headerpgwidth = $this-&gt;h - $this-&gt;orig_lMargin - $this-&gt;orig_rMargin;
<a name="l08359"></a>08359     <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l08360"></a>08360       $headerlmargin = $this-&gt;orig_rMargin;
<a name="l08361"></a>08361     }
<a name="l08362"></a>08362     <span class="keywordflow">else</span> {
<a name="l08363"></a>08363       $headerlmargin = $this-&gt;orig_lMargin;
<a name="l08364"></a>08364     }
<a name="l08365"></a>08365   }
<a name="l08366"></a>08366   <span class="keywordflow">else</span> { 
<a name="l08367"></a>08367     $yadj = 0; 
<a name="l08368"></a>08368     $headerpgwidth = $this-&gt;pgwidth;
<a name="l08369"></a>08369     $headerlmargin = $this-&gt;lMargin;
<a name="l08370"></a>08370   }
<a name="l08371"></a>08371 
<a name="l08372"></a>08372   $this-&gt;y = $this-&gt;margin_header - $yadj ;
<a name="l08373"></a>08373   $this-&gt;SetTextColor(0);
<a name="l08374"></a>08374       $this-&gt;SUP = <span class="keyword">false</span>;
<a name="l08375"></a>08375   $this-&gt;SUB = <span class="keyword">false</span>;
<a name="l08376"></a>08376   $this-&gt;bullet = <span class="keyword">false</span>;
<a name="l08377"></a>08377 
<a name="l08378"></a>08378   <span class="comment">// only show pagenumber if numbering on</span>
<a name="l08379"></a>08379   <span class="comment">// mPDF 3.0 Add PageNum prefix/suffix</span>
<a name="l08380"></a>08380   $pgno = $this-&gt;docPageNum($this-&gt;page, <span class="keyword">true</span>); 
<a name="l08381"></a>08381 
<a name="l08382"></a>08382   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l08383"></a>08383       $side = <span class="stringliteral">&#39;even&#39;</span>;
<a name="l08384"></a>08384   }
<a name="l08385"></a>08385   <span class="keywordflow">else</span> {  <span class="comment">// ODD  // OR NOT MIRRORING MARGINS/FOOTERS = DEFAULT</span>
<a name="l08386"></a>08386       $side = <span class="stringliteral">&#39;odd&#39;</span>;
<a name="l08387"></a>08387   }
<a name="l08388"></a>08388   $maxfontheight = 0;
<a name="l08389"></a>08389   <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;L&#39;</span>,<span class="charliteral">&#39;C&#39;</span>,<span class="charliteral">&#39;R&#39;</span>) AS $pos) {
<a name="l08390"></a>08390     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) {
<a name="l08391"></a>08391     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) { $hfsz = $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]; }
<a name="l08392"></a>08392     <span class="keywordflow">else</span> { $hfsz = $this-&gt;default_font_size; }
<a name="l08393"></a>08393     $maxfontheight = max($maxfontheight,$hfsz);
<a name="l08394"></a>08394     }
<a name="l08395"></a>08395   }
<a name="l08396"></a>08396   <span class="comment">// LEFT-CENTER-RIGHT</span>
<a name="l08397"></a>08397   <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;L&#39;</span>,<span class="charliteral">&#39;C&#39;</span>,<span class="charliteral">&#39;R&#39;</span>) AS $pos) {
<a name="l08398"></a>08398     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) {
<a name="l08399"></a>08399     $hd = str_replace(<span class="stringliteral">&#39;{PAGENO}&#39;</span>,$pgno,$h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]);
<a name="l08400"></a>08400     <span class="comment">// mPDF 3.0</span>
<a name="l08401"></a>08401     $hd = str_replace($this-&gt;aliasNbPgGp,$this-&gt;nbpgPrefix.$this-&gt;aliasNbPgGp.$this-&gt;nbpgSuffix,$hd); <span class="comment">// {nbpg}</span>
<a name="l08402"></a>08402     $hd = preg_replace(<span class="stringliteral">&#39;/\{DATE\s+(.*?)\}/e&#39;</span>,<span class="stringliteral">&quot;date(&#39;\\1&#39;)&quot;</span>,$hd);
<a name="l08403"></a>08403     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-family&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-family&#39;</span>]) { $hff = $h[$side][$pos][<span class="stringliteral">&#39;font-family&#39;</span>]; }
<a name="l08404"></a>08404     <span class="comment">// mPDF 3.0 original_ in case pagebreak in middle of table</span>
<a name="l08405"></a>08405     <span class="keywordflow">else</span> { $hff = $this-&gt;original_default_font; }
<a name="l08406"></a>08406     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) { $hfsz = $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]; }
<a name="l08407"></a>08407     <span class="comment">// mPDF 3.0 original_ in case pagebreak in middle of table</span>
<a name="l08408"></a>08408     <span class="keywordflow">else</span> { $hfsz = $this-&gt;original_default_font_size; } <span class="comment">// pts</span>
<a name="l08409"></a>08409     $maxfontheight = max($maxfontheight,$hfsz);
<a name="l08410"></a>08410     $hfst = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08411"></a>08411     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-style&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-style&#39;</span>]) { 
<a name="l08412"></a>08412       $hfst = $h[$side][$pos][<span class="stringliteral">&#39;font-style&#39;</span>];
<a name="l08413"></a>08413     }
<a name="l08414"></a>08414     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;color&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;color&#39;</span>]) { 
<a name="l08415"></a>08415       $hfcol = $h[$side][$pos][<span class="stringliteral">&#39;color&#39;</span>]; 
<a name="l08416"></a>08416       $cor = $this-&gt;ConvertColor($hfcol);
<a name="l08417"></a>08417       <span class="keywordflow">if</span> ($cor) { $this-&gt;SetTextColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]); }
<a name="l08418"></a>08418     }
<a name="l08419"></a>08419     <span class="keywordflow">else</span> { $hfcol = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08420"></a>08420     <span class="comment">// mPDF 3.0 Force output</span>
<a name="l08421"></a>08421     $this-&gt;SetFont($hff,$hfst,$hfsz,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l08422"></a>08422     $this-&gt;x = $headerlmargin ;
<a name="l08423"></a>08423     $this-&gt;y = $this-&gt;margin_header - $yadj ;
<a name="l08424"></a>08424 
<a name="l08425"></a>08425     $hd = $this-&gt;purify_utf8_text($hd);
<a name="l08426"></a>08426     <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l08427"></a>08427       $hd = $this-&gt;all_entities_to_utf8($hd);
<a name="l08428"></a>08428     }
<a name="l08429"></a>08429     <span class="comment">// CONVERT CODEPAGE</span>
<a name="l08430"></a>08430     <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $hd = mb_convert_encoding($hd,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l08431"></a>08431     <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l08432"></a>08432     <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l08433"></a>08433     $align = $pos;
<a name="l08434"></a>08434     <span class="keywordflow">if</span> ($pos!=<span class="charliteral">&#39;L&#39;</span> &amp;&amp; (stripos($hd,$this-&gt;aliasNbPg)!==<span class="keyword">false</span> || stripos($hd,$this-&gt;aliasNbPgGp)!==<span class="keyword">false</span>)) { 
<a name="l08435"></a>08435       <span class="keywordflow">if</span> (stripos($hd,$this-&gt;aliasNbPgGp)!==<span class="keyword">false</span>) { $type= <span class="stringliteral">&#39;nbpggp&#39;</span>; } <span class="keywordflow">else</span> { $type= <span class="stringliteral">&#39;nbpg&#39;</span>; }
<a name="l08436"></a>08436       $this-&gt;_out(<span class="stringliteral">&#39;{mpdfheader&#39;</span>.$type.<span class="charliteral">&#39; &#39;</span>.$pos.<span class="stringliteral">&#39; ff=&#39;</span>.$hff.<span class="stringliteral">&#39; fs=&#39;</span>.$hfst.<span class="stringliteral">&#39; fz=&#39;</span>.$hfsz.<span class="charliteral">&#39;}&#39;</span>); 
<a name="l08437"></a>08437       $this-&gt;Cell($headerpgwidth ,$maxfontheight/$this-&gt;k ,$hd,0,0,$align,0,<span class="stringliteral">&#39;&#39;</span>,0,0,0,<span class="charliteral">&#39;M&#39;</span>);
<a name="l08438"></a>08438       $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l08439"></a>08439     }
<a name="l08440"></a>08440     <span class="keywordflow">else</span> { 
<a name="l08441"></a>08441       $this-&gt;Cell($headerpgwidth ,$maxfontheight/$this-&gt;k ,$hd,0,0,$align,0,<span class="stringliteral">&#39;&#39;</span>,0,0,0,<span class="charliteral">&#39;M&#39;</span>);
<a name="l08442"></a>08442     }
<a name="l08443"></a>08443     <span class="keywordflow">if</span> ($hfcol) { $this-&gt;SetTextColor(0); }
<a name="l08444"></a>08444     }
<a name="l08445"></a>08445   }
<a name="l08446"></a>08446   <span class="comment">//Return Font to normal</span>
<a name="l08447"></a>08447   $this-&gt;SetFont($this-&gt;default_font,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;original_default_font_size);
<a name="l08448"></a>08448   <span class="comment">// LINE</span>
<a name="l08449"></a>08449   <span class="keywordflow">if</span> (isset($h[$side][<span class="stringliteral">&#39;line&#39;</span>]) &amp;&amp; $h[$side][<span class="stringliteral">&#39;line&#39;</span>]) { 
<a name="l08450"></a>08450     $this-&gt;SetLineWidth(0.1);
<a name="l08451"></a>08451     $this-&gt;SetDrawColor(0);
<a name="l08452"></a>08452     $this-&gt;Line($headerlmargin , $this-&gt;margin_header + ($maxfontheight*(1+$this-&gt;header_line_spacing)/$this-&gt;k) - $yadj , $headerlmargin + $headerpgwidth, $this-&gt;margin_header + ($maxfontheight*(1+$this-&gt;header_line_spacing)/$this-&gt;k) - $yadj  );
<a name="l08453"></a>08453   }
<a name="l08454"></a>08454   <span class="keywordflow">if</span> ($this-&gt;forcePortraitHeaders &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;CurOrientation!=$this-&gt;DefOrientation) {
<a name="l08455"></a>08455     $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l08456"></a>08456   }
<a name="l08457"></a>08457   }
<a name="l08458"></a>08458   $this-&gt;SetY($this-&gt;tMargin);
<a name="l08459"></a>08459 
<a name="l08460"></a>08460   $this-&gt;processingHeader=<span class="keyword">false</span>;
<a name="l08461"></a>08461 }
<a name="l08462"></a>08462 
<a name="l08463"></a>08463 
<a name="l08464"></a>08464 
<a name="l08465"></a>08465 <span class="comment">// mPDF 4.0</span>
<a name="l08466"></a>08466 function TableHeaderFooter($content=<span class="stringliteral">&#39;&#39;</span>,$tablestartpage=<span class="stringliteral">&#39;&#39;</span>,$tablestartcolumn =<span class="stringliteral">&#39;&#39;</span>,$horf = <span class="charliteral">&#39;H&#39;</span>) {
<a name="l08467"></a>08467   <span class="keywordflow">if</span>((($this-&gt;usetableheader &amp;&amp; $horf==<span class="charliteral">&#39;H&#39;</span>) || $horf==<span class="charliteral">&#39;F&#39;</span>) &amp;&amp; !empty($content)) { <span class="comment">// mPDF 3.0</span>
<a name="l08468"></a>08468 
<a name="l08469"></a>08469   $table = &amp;$this-&gt;table[1][1];
<a name="l08470"></a>08470   <span class="comment">// Advance down page by half width of top border</span>
<a name="l08471"></a>08471   <span class="comment">// mPDF 4.0</span>
<a name="l08472"></a>08472   <span class="keywordflow">if</span> ($horf==<span class="charliteral">&#39;H&#39;</span>) { <span class="comment">// Only if header</span>
<a name="l08473"></a>08473     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $adv = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2 + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];  }
<a name="l08474"></a>08474     <span class="keywordflow">else</span> { $adv = $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] /2 ; }
<a name="l08475"></a>08475     <span class="keywordflow">if</span> ($adv) { 
<a name="l08476"></a>08476        <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l08477"></a>08477       $this-&gt;y += ($adv);
<a name="l08478"></a>08478        }
<a name="l08479"></a>08479        <span class="keywordflow">else</span> {
<a name="l08480"></a>08480       $this-&gt;DivLn($adv,$this-&gt;blklvl,<span class="keyword">true</span>); 
<a name="l08481"></a>08481        }
<a name="l08482"></a>08482     }
<a name="l08483"></a>08483   }
<a name="l08484"></a>08484 
<a name="l08485"></a>08485    <span class="comment">// mPDF 4.0</span>
<a name="l08486"></a>08486    <span class="keywordflow">if</span> ($horf==<span class="charliteral">&#39;F&#39;</span>) { <span class="comment">// Table Footer</span>
<a name="l08487"></a>08487   $firstrow = count($table[<span class="stringliteral">&#39;cells&#39;</span>]) - $this-&gt;tablefooternrows;
<a name="l08488"></a>08488   $lastrow = count($table[<span class="stringliteral">&#39;cells&#39;</span>]) - 1;
<a name="l08489"></a>08489    }
<a name="l08490"></a>08490    <span class="keywordflow">else</span> {   <span class="comment">// Table Header</span>
<a name="l08491"></a>08491   $firstrow = 0;
<a name="l08492"></a>08492   $lastrow = $this-&gt;tableheadernrows - 1;
<a name="l08493"></a>08493    }
<a name="l08494"></a>08494 
<a name="l08495"></a>08495    $topy = $content[$firstrow][0][<span class="charliteral">&#39;y&#39;</span>]-$this-&gt;y;
<a name="l08496"></a>08496 
<a name="l08497"></a>08497    <span class="comment">// mPDF 4.0</span>
<a name="l08498"></a>08498    <span class="keywordflow">for</span> ($i=$firstrow ; $i&lt;=$lastrow; $i++) {
<a name="l08499"></a>08499 
<a name="l08500"></a>08500     $y = $this-&gt;y;
<a name="l08501"></a>08501 
<a name="l08502"></a>08502 
<a name="l08503"></a>08503     $colctr = 0;
<a name="l08504"></a>08504     <span class="keywordflow">foreach</span>($content[$i] as $tablehf)
<a name="l08505"></a>08505     {
<a name="l08506"></a>08506   $colctr++;
<a name="l08507"></a>08507   $y = $tablehf[<span class="charliteral">&#39;y&#39;</span>] - $topy;
<a name="l08508"></a>08508 
<a name="l08509"></a>08509       $this-&gt;y = $y;
<a name="l08510"></a>08510       <span class="comment">//Set some cell values</span>
<a name="l08511"></a>08511       $x = $tablehf[<span class="charliteral">&#39;x&#39;</span>];
<a name="l08512"></a>08512   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; ($tablestartpage == <span class="stringliteral">&#39;ODD&#39;</span>) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l08513"></a>08513     $x = $x +$this-&gt;MarginCorrection;
<a name="l08514"></a>08514   }
<a name="l08515"></a>08515   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; ($tablestartpage == <span class="stringliteral">&#39;EVEN&#39;</span>) &amp;&amp; (($this-&gt;page)%2==1)) { <span class="comment">// ODD</span>
<a name="l08516"></a>08516     $x = $x +$this-&gt;MarginCorrection;
<a name="l08517"></a>08517   }
<a name="l08518"></a>08518       $w = $tablehf[<span class="charliteral">&#39;w&#39;</span>];
<a name="l08519"></a>08519       $h = $tablehf[<span class="charliteral">&#39;h&#39;</span>];
<a name="l08520"></a>08520       $va = $tablehf[<span class="stringliteral">&#39;va&#39;</span>];
<a name="l08521"></a>08521       $R = $tablehf[<span class="charliteral">&#39;R&#39;</span>];
<a name="l08522"></a>08522       $mih = $tablehf[<span class="stringliteral">&#39;mih&#39;</span>];
<a name="l08523"></a>08523       $fill = $tablehf[<span class="stringliteral">&#39;bgcolor&#39;</span>];
<a name="l08524"></a>08524       $border = $tablehf[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l08525"></a>08525       $border_details = $tablehf[<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l08526"></a>08526       $padding = $tablehf[<span class="stringliteral">&#39;padding&#39;</span>];
<a name="l08527"></a>08527   $this-&gt;tabletheadjustfinished = <span class="keyword">true</span>;
<a name="l08528"></a>08528 
<a name="l08529"></a>08529       $textbuffer = $tablehf[<span class="stringliteral">&#39;textbuffer&#39;</span>];
<a name="l08530"></a>08530 
<a name="l08531"></a>08531       $align = $tablehf[<span class="charliteral">&#39;a&#39;</span>];
<a name="l08532"></a>08532       <span class="comment">//Align</span>
<a name="l08533"></a>08533       $this-&gt;divalign=$align;
<a name="l08534"></a>08534   $this-&gt;x = $x;
<a name="l08535"></a>08535 
<a name="l08536"></a>08536   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l08537"></a>08537      $tablefill = isset($table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1]) ? $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1] : 0;   <span class="comment">// mPDF 4.3.005</span>
<a name="l08538"></a>08538      <span class="keywordflow">if</span> ($tablefill) {
<a name="l08539"></a>08539           $color = $this-&gt;ConvertColor($tablefill);
<a name="l08540"></a>08540           <span class="keywordflow">if</span> ($color) $this-&gt;SetFillColor($color[<span class="charliteral">&#39;R&#39;</span>],$color[<span class="charliteral">&#39;G&#39;</span>],$color[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l08541"></a>08541         $xadj = ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l08542"></a>08542         $yadj = ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l08543"></a>08543         $wadj = $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l08544"></a>08544         $hadj = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>];
<a name="l08545"></a>08545         <span class="comment">// mPDF 4.0</span>
<a name="l08546"></a>08546           <span class="keywordflow">if</span> ($i == $firstrow &amp;&amp; $horf==<span class="charliteral">&#39;H&#39;</span>) {    <span class="comment">// Top</span>
<a name="l08547"></a>08547           $yadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l08548"></a>08548           $hadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l08549"></a>08549           }
<a name="l08550"></a>08550           <span class="keywordflow">if</span> (($i == ($lastrow) || (isset($tablehf[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+$tablehf[<span class="stringliteral">&#39;rowspan&#39;</span>]) == ($lastrow+1))  || (!isset($tablehf[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+1) == ($lastrow+1))) &amp;&amp; $horf==<span class="charliteral">&#39;F&#39;</span>) { <span class="comment">// Bottom</span>
<a name="l08551"></a>08551           $hadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l08552"></a>08552           }
<a name="l08553"></a>08553           <span class="keywordflow">if</span> ($colctr == 1) {   <span class="comment">// Left</span>
<a name="l08554"></a>08554           $xadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l08555"></a>08555           $wadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l08556"></a>08556           }
<a name="l08557"></a>08557           <span class="keywordflow">if</span> ($colctr == count($content[$i]) ) {  <span class="comment">// Right</span>
<a name="l08558"></a>08558           $wadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l08559"></a>08559           }
<a name="l08560"></a>08560         $this-&gt;Rect($x - $xadj, $y - $yadj, $w + $wadj, $h + $hadj, <span class="charliteral">&#39;F&#39;</span>);
<a name="l08561"></a>08561      }
<a name="l08562"></a>08562   }
<a name="l08563"></a>08563 
<a name="l08564"></a>08564   <span class="comment">// TABLE BORDER - if separate</span>
<a name="l08565"></a>08565   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $table[<span class="stringliteral">&#39;border&#39;</span>]) { 
<a name="l08566"></a>08566       $halfspaceL = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l08567"></a>08567       $halfspaceR = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l08568"></a>08568       $halfspaceT = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l08569"></a>08569       $halfspaceB = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l08570"></a>08570       $tbx = $x;
<a name="l08571"></a>08571       $tby = $y;
<a name="l08572"></a>08572       $tbw = $w;
<a name="l08573"></a>08573       $tbh = $h;
<a name="l08574"></a>08574       $tab_bord = 0;
<a name="l08575"></a>08575       <span class="comment">// mPDF 4.0</span>
<a name="l08576"></a>08576       $corner = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08577"></a>08577       <span class="keywordflow">if</span> ($i == $firstrow &amp;&amp; $horf==<span class="charliteral">&#39;H&#39;</span>) {    <span class="comment">// Top</span>
<a name="l08578"></a>08578         $tby -= $halfspaceT + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l08579"></a>08579         $tbh += $halfspaceT + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l08580"></a>08580         $this-&gt;setBorder($tab_bord , _BORDER_TOP); 
<a name="l08581"></a>08581         $corner .= <span class="charliteral">&#39;T&#39;</span>;
<a name="l08582"></a>08582       }
<a name="l08583"></a>08583           <span class="keywordflow">if</span> (($i == ($lastrow) || (isset($tablehf[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+$tablehf[<span class="stringliteral">&#39;rowspan&#39;</span>]) == ($lastrow+1))  || (!isset($tablehf[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+1) == ($lastrow+1))) &amp;&amp; $horf==<span class="charliteral">&#39;F&#39;</span>) { <span class="comment">// Bottom</span>
<a name="l08584"></a>08584         $tbh += $halfspaceB + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l08585"></a>08585         $this-&gt;setBorder($tab_bord , _BORDER_BOTTOM); 
<a name="l08586"></a>08586         $corner .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l08587"></a>08587       }
<a name="l08588"></a>08588       <span class="keywordflow">if</span> ($colctr == 1) { <span class="comment">// Top Left</span>
<a name="l08589"></a>08589         $tbx -= $halfspaceL + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l08590"></a>08590         $tbw += $halfspaceL + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l08591"></a>08591         $this-&gt;setBorder($tab_bord , _BORDER_LEFT); 
<a name="l08592"></a>08592         $corner .= <span class="charliteral">&#39;L&#39;</span>;
<a name="l08593"></a>08593       }
<a name="l08594"></a>08594       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($colctr == count($content[$i])) {  <span class="comment">// Right</span>
<a name="l08595"></a>08595         $tbw += $halfspaceR + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l08596"></a>08596         $this-&gt;setBorder($tab_bord , _BORDER_RIGHT); 
<a name="l08597"></a>08597         $corner .= <span class="charliteral">&#39;R&#39;</span>;
<a name="l08598"></a>08598       }
<a name="l08599"></a>08599       <span class="comment">// mPDF 3.0</span>
<a name="l08600"></a>08600       $this-&gt;_tableRect($tbx, $tby, $tbw, $tbh, $tab_bord , $table[<span class="stringliteral">&#39;border_details&#39;</span>], <span class="keyword">false</span>, $table[<span class="stringliteral">&#39;borders_separate&#39;</span>], <span class="stringliteral">&#39;table&#39;</span>, $corner, $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>], $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] );
<a name="l08601"></a>08601   }
<a name="l08602"></a>08602 
<a name="l08603"></a>08603   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;empty_cells&#39;</span>]!=<span class="stringliteral">&#39;hide&#39;</span> || !empty($textbuffer) || !$table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $paintcell = <span class="keyword">true</span>; }
<a name="l08604"></a>08604   <span class="keywordflow">else</span> { $paintcell = <span class="keyword">false</span>; } 
<a name="l08605"></a>08605 
<a name="l08606"></a>08606   <span class="comment">//Vertical align</span>
<a name="l08607"></a>08607   <span class="keywordflow">if</span> ($R &amp;&amp; INTVAL($R) &gt; 0 &amp;&amp; isset($va) &amp;&amp; $va!=<span class="charliteral">&#39;B&#39;</span>) { $va=<span class="charliteral">&#39;B&#39;</span>;}
<a name="l08608"></a>08608 
<a name="l08609"></a>08609   <span class="keywordflow">if</span> (!isset($va) || empty($va) || $va==<span class="charliteral">&#39;M&#39;</span>) $this-&gt;y += ($h-$mih)/2;
<a name="l08610"></a>08610       elseif (isset($va) &amp;&amp; $va==<span class="charliteral">&#39;B&#39;</span>) $this-&gt;y += $h-$mih;
<a name="l08611"></a>08611   <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a> ($fill &amp;&amp; $paintcell)
<a name="l08612"></a>08612       {
<a name="l08613"></a>08613     $color = $this-&gt;ConvertColor($fill);
<a name="l08614"></a>08614     <span class="keywordflow">if</span> ($color) $this-&gt;SetFillColor($color[<span class="charliteral">&#39;R&#39;</span>],$color[<span class="charliteral">&#39;G&#39;</span>],$color[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l08615"></a>08615     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l08616"></a>08616       $this-&gt;Rect($x+ ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2), $y+ ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2), $w- $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>], $h- $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>], <span class="charliteral">&#39;F&#39;</span>);
<a name="l08617"></a>08617     }
<a name="l08618"></a>08618     <span class="keywordflow">else</span> { 
<a name="l08619"></a>08619       $this-&gt;Rect($x, $y, $w, $h, <span class="charliteral">&#39;F&#39;</span>);
<a name="l08620"></a>08620     }
<a name="l08621"></a>08621   }
<a name="l08622"></a>08622 
<a name="l08623"></a>08623 
<a name="l08624"></a>08624   <span class="keywordflow">if</span> (isset($tablehf[<span class="stringliteral">&#39;background-image&#39;</span>]) &amp;&amp; $paintcell){ <span class="comment">// mPDF 4.3.006</span>
<a name="l08625"></a>08625     <span class="keywordflow">if</span> ($tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;image_id&#39;</span>]) { <span class="comment">// Background pattern</span>
<a name="l08626"></a>08626     $n = count($this-&gt;patterns)+1;
<a name="l08627"></a>08627     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l08628"></a>08628       $px = $x+ ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l08629"></a>08629       $py = $y+ ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l08630"></a>08630       $pw = $w- $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l08631"></a>08631       $ph = $h- $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>];
<a name="l08632"></a>08632     }
<a name="l08633"></a>08633     <span class="keywordflow">else</span> {
<a name="l08634"></a>08634       $px = $x;
<a name="l08635"></a>08635       $py = $y;
<a name="l08636"></a>08636       $pw = $w;
<a name="l08637"></a>08637       $ph = $h;
<a name="l08638"></a>08638     }
<a name="l08639"></a>08639     <span class="comment">// mPDF 4.3.015</span>
<a name="l08640"></a>08640     list($orig_w, $orig_h, $x_repeat, $y_repeat) = $this-&gt;_resizeBackgroundImage($tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;orig_w&#39;</span>], $tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;orig_h&#39;</span>], $pw, $ph, $tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;resize&#39;</span>], $tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;x_repeat&#39;</span>] , $tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;y_repeat&#39;</span>]);
<a name="l08641"></a>08641     $this-&gt;patterns[$n] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;$px, <span class="charliteral">&#39;y&#39;</span>=&gt;$py, <span class="charliteral">&#39;w&#39;</span>=&gt;$pw, <span class="charliteral">&#39;h&#39;</span>=&gt;$ph, <span class="stringliteral">&#39;pgh&#39;</span>=&gt;$this-&gt;h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;image_id&#39;</span>], <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;x_pos&#39;</span>] , <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;y_pos&#39;</span>] , <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat); <span class="comment">// mPDF 4.3.015</span>
<a name="l08642"></a>08642     <span class="comment">// mPDF 4.3.017</span>
<a name="l08643"></a>08643     <span class="keywordflow">if</span> ($tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($tablehf[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l08644"></a>08644     <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08645"></a>08645     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;q /Pattern cs /P%d scn %s %.3f %.3f %.3f %.3f re f Q&#39;</span>, $n, $opac, $px*$this-&gt;k, ($this-&gt;h-$py)*$this-&gt;k, $pw*$this-&gt;k, -$ph*$this-&gt;k));
<a name="l08646"></a>08646     }
<a name="l08647"></a>08647   }
<a name="l08648"></a>08648 
<a name="l08649"></a>08649     <span class="comment">//Border</span>
<a name="l08650"></a>08650   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $paintcell &amp;&amp; $border) {  <span class="comment">// mPDF 4.2.017</span>
<a name="l08651"></a>08651     $this-&gt;_tableRect($x+ ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2)+($border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2), $y+ ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)+($border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2), $w-$table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]-($border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2)-($border_details[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2), $h- $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]-($border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2)-($border_details[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2), $border, $border_details, <span class="keyword">false</span>, $table[<span class="stringliteral">&#39;borders_separate&#39;</span>]);
<a name="l08652"></a>08652   }
<a name="l08653"></a>08653   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($paintcell &amp;&amp; $border) {   <span class="comment">// mPDF 4.2.017</span>
<a name="l08654"></a>08654     $this-&gt;_tableRect($x, $y, $w, $h, $border, $border_details, <span class="keyword">true</span>, $table[<span class="stringliteral">&#39;borders_separate&#39;</span>]);    <span class="comment">// true causes buffer</span>
<a name="l08655"></a>08655   }
<a name="l08656"></a>08656 
<a name="l08657"></a>08657   <span class="comment">//Print cell content</span>
<a name="l08658"></a>08658      <span class="comment">// $this-&gt;divheight = $this-&gt;table_lineheight*$this-&gt;lineheight; // mPDF 4.2</span>
<a name="l08659"></a>08659       <span class="keywordflow">if</span> (!empty($textbuffer)) {
<a name="l08660"></a>08660 
<a name="l08661"></a>08661     <span class="keywordflow">if</span> ($R) {
<a name="l08662"></a>08662           $cellPtSize = $textbuffer[0][11] / $this-&gt;shrin_k;
<a name="l08663"></a>08663           $cellFontHeight = ($cellPtSize/$this-&gt;k);
<a name="l08664"></a>08664           $opx = $this-&gt;x;
<a name="l08665"></a>08665           $opy = $this-&gt;y;
<a name="l08666"></a>08666           $angle = INTVAL($R);
<a name="l08667"></a>08667           <span class="comment">// Only allow 45 - 90 degrees (when bottom-aligned) or -90</span>
<a name="l08668"></a>08668           <span class="keywordflow">if</span> ($angle &gt; 90) { $angle = 90; }
<a name="l08669"></a>08669           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &gt; 0 &amp;&amp; (isset($va) &amp;&amp; $va!=<span class="charliteral">&#39;B&#39;</span>)) { $angle = 90; }
<a name="l08670"></a>08670           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &gt; 0 &amp;&amp; $angle &lt;45) { $angle = 45; }
<a name="l08671"></a>08671           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $angle = -90; }
<a name="l08672"></a>08672           $offset = ((sin(deg2rad($angle))) * 0.37 * $cellFontHeight);
<a name="l08673"></a>08673           <span class="keywordflow">if</span> (isset($align) &amp;&amp; $align ==<span class="charliteral">&#39;R&#39;</span>) { 
<a name="l08674"></a>08674             $this-&gt;x += ($w) + ($offset) - ($cellFontHeight/3) - ($padding[<span class="charliteral">&#39;R&#39;</span>] + $border_details[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l08675"></a>08675           }
<a name="l08676"></a>08676           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!isset($align ) || $align ==<span class="charliteral">&#39;C&#39;</span>) { 
<a name="l08677"></a>08677             $this-&gt;x += ($w/2) + ($offset); 
<a name="l08678"></a>08678           }
<a name="l08679"></a>08679           <span class="keywordflow">else</span> { 
<a name="l08680"></a>08680             $this-&gt;x += ($offset) + ($cellFontHeight/3)+($padding[<span class="charliteral">&#39;L&#39;</span>] + $border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l08681"></a>08681           }
<a name="l08682"></a>08682           $str = ltrim(implode(<span class="charliteral">&#39; &#39;</span>,$tablehf[<span class="stringliteral">&#39;text&#39;</span>]));
<a name="l08683"></a>08683           $str = $this-&gt;mb_rtrim($str ,$this-&gt;mb_enc);
<a name="l08684"></a>08684 
<a name="l08685"></a>08685           <span class="keywordflow">if</span> (!isset($va) || $va==<span class="charliteral">&#39;M&#39;</span>) { 
<a name="l08686"></a>08686             $this-&gt;y -= ($h-$mih)/2; <span class="comment">//Undo what was added earlier VERTICAL ALIGN</span>
<a name="l08687"></a>08687             <span class="keywordflow">if</span> ($angle &gt; 0) { $this-&gt;y += (($h-$mih)/2)+($padding[<span class="charliteral">&#39;T&#39;</span>] + $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) + ($mih-($padding[<span class="charliteral">&#39;T&#39;</span>] + $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$border_details[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$padding[<span class="charliteral">&#39;B&#39;</span>])); }
<a name="l08688"></a>08688             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $this-&gt;y += (($h-$mih)/2)+($padding[<span class="charliteral">&#39;T&#39;</span>] + $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); }
<a name="l08689"></a>08689           }
<a name="l08690"></a>08690           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($va) &amp;&amp; $va==<span class="charliteral">&#39;B&#39;</span>) { 
<a name="l08691"></a>08691             $this-&gt;y -= $h-$mih; <span class="comment">//Undo what was added earlier VERTICAL ALIGN</span>
<a name="l08692"></a>08692             <span class="keywordflow">if</span> ($angle &gt; 0) { $this-&gt;y += $h-($border_details[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$padding[<span class="charliteral">&#39;B&#39;</span>]); }
<a name="l08693"></a>08693             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $this-&gt;y += $h-$mih+($padding[<span class="charliteral">&#39;T&#39;</span>] + $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); }
<a name="l08694"></a>08694           }
<a name="l08695"></a>08695           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($va) &amp;&amp; $va==<span class="charliteral">&#39;T&#39;</span>) { 
<a name="l08696"></a>08696             <span class="keywordflow">if</span> ($angle &gt; 0) { $this-&gt;y += $mih-($border_details[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$padding[<span class="charliteral">&#39;B&#39;</span>]); }
<a name="l08697"></a>08697             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $this-&gt;y += ($padding[<span class="charliteral">&#39;T&#39;</span>] + $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); }
<a name="l08698"></a>08698           }
<a name="l08699"></a>08699 
<a name="l08700"></a>08700           $this-&gt;Rotate($angle,$this-&gt;x,$this-&gt;y);
<a name="l08701"></a>08701           $s_fs = $this-&gt;FontSizePt;
<a name="l08702"></a>08702           $s_f = $this-&gt;FontFamily; <span class="comment">// mPDF 3.0</span>
<a name="l08703"></a>08703           $s_st = $this-&gt;FontStyle; <span class="comment">// mPDF 3.0</span>
<a name="l08704"></a>08704           $this-&gt;SetFont($textbuffer[0][4],$textbuffer[0][2],$cellPtSize,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l08705"></a>08705           $this-&gt;Text($this-&gt;x,$this-&gt;y,$str);
<a name="l08706"></a>08706           $this-&gt;Rotate(0);
<a name="l08707"></a>08707           $this-&gt;SetFont($s_f,$s_st,$s_fs,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l08708"></a>08708           $this-&gt;x = $opx;
<a name="l08709"></a>08709           $this-&gt;y = $opy;
<a name="l08710"></a>08710     }
<a name="l08711"></a>08711     <span class="keywordflow">else</span> {
<a name="l08712"></a>08712       <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { <span class="comment">// NB twice border width</span>
<a name="l08713"></a>08713         $xadj = $border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $padding[<span class="charliteral">&#39;L&#39;</span>] +($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l08714"></a>08714         $wadj = $border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $border_details[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $padding[<span class="charliteral">&#39;L&#39;</span>] +$padding[<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l08715"></a>08715         $yadj = $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $padding[<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l08716"></a>08716       }
<a name="l08717"></a>08717       <span class="keywordflow">else</span> {
<a name="l08718"></a>08718         $xadj = $border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $padding[<span class="charliteral">&#39;L&#39;</span>];
<a name="l08719"></a>08719         $wadj = ($border_details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $border_details[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2 + $padding[<span class="charliteral">&#39;L&#39;</span>] + $padding[<span class="charliteral">&#39;R&#39;</span>];
<a name="l08720"></a>08720         $yadj = $border_details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $padding[<span class="charliteral">&#39;T&#39;</span>];
<a name="l08721"></a>08721       }
<a name="l08722"></a>08722 
<a name="l08723"></a>08723       $this-&gt;divwidth=$w-($wadj);
<a name="l08724"></a>08724       $this-&gt;x += $xadj;
<a name="l08725"></a>08725       $this-&gt;y += $yadj;
<a name="l08726"></a>08726       $this-&gt;printbuffer($textbuffer,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">true</span>);
<a name="l08727"></a>08727     }
<a name="l08728"></a>08728 
<a name="l08729"></a>08729   }
<a name="l08730"></a>08730       $textbuffer = array();
<a name="l08731"></a>08731      }
<a name="l08732"></a>08732      $this-&gt;y = $y + $h; <span class="comment">//Update y coordinate</span>
<a name="l08733"></a>08733    }
<a name="l08734"></a>08734 
<a name="l08735"></a>08735   }<span class="comment">//end of &#39;if usetableheader ...&#39;</span>
<a name="l08736"></a>08736 }
<a name="l08737"></a>08737 
<a name="l08738"></a>08738 function SetHTMLHeader($header=<span class="stringliteral">&#39;&#39;</span>,$OE=<span class="stringliteral">&#39;&#39;</span>,$write=<span class="keyword">false</span>) {
<a name="l08739"></a>08739   <span class="comment">// mPDF 4.0</span>
<a name="l08740"></a>08740   $height = 0;
<a name="l08741"></a>08741   <span class="keywordflow">if</span> (is_array($header) &amp;&amp; isset($header[<span class="stringliteral">&#39;html&#39;</span>]) &amp;&amp; $header[<span class="stringliteral">&#39;html&#39;</span>]) { 
<a name="l08742"></a>08742     $Hhtml = $header[<span class="stringliteral">&#39;html&#39;</span>]; 
<a name="l08743"></a>08743     <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin) {
<a name="l08744"></a>08744       <span class="keywordflow">if</span> (isset($header[<span class="charliteral">&#39;h&#39;</span>])) { $height = $header[<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l08745"></a>08745       <span class="keywordflow">else</span> { $height = $this-&gt;_gethtmlheight($Hhtml); }
<a name="l08746"></a>08746     }
<a name="l08747"></a>08747   }
<a name="l08748"></a>08748   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_array($header) &amp;&amp; $header) { 
<a name="l08749"></a>08749     $Hhtml = $header; 
<a name="l08750"></a>08750     <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin) { $height = $this-&gt;_gethtmlheight($Hhtml); }
<a name="l08751"></a>08751   }
<a name="l08752"></a>08752   <span class="keywordflow">else</span> { $Hhtml = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08753"></a>08753   <span class="comment">// mPDF 4.0</span>
<a name="l08754"></a>08754   <span class="keywordflow">if</span> ($OE != <span class="charliteral">&#39;E&#39;</span>) { $OE = <span class="charliteral">&#39;O&#39;</span>; }
<a name="l08755"></a>08755   <span class="keywordflow">if</span> ($OE == <span class="charliteral">&#39;E&#39;</span>) {
<a name="l08756"></a>08756      <span class="comment">// mPDF 4.0</span>
<a name="l08757"></a>08757      <span class="keywordflow">if</span> ($Hhtml) {
<a name="l08758"></a>08758     $this-&gt;HTMLHeaderE[<span class="stringliteral">&#39;html&#39;</span>] = $Hhtml;
<a name="l08759"></a>08759     $this-&gt;HTMLHeaderE[<span class="charliteral">&#39;h&#39;</span>] = $height;
<a name="l08760"></a>08760      }
<a name="l08761"></a>08761      <span class="keywordflow">else</span> { $this-&gt;HTMLHeaderE = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08762"></a>08762   }
<a name="l08763"></a>08763   <span class="keywordflow">else</span> {
<a name="l08764"></a>08764      <span class="comment">// mPDF 4.0</span>
<a name="l08765"></a>08765      <span class="keywordflow">if</span> ($Hhtml) {
<a name="l08766"></a>08766     $this-&gt;HTMLHeader[<span class="stringliteral">&#39;html&#39;</span>] = $Hhtml;
<a name="l08767"></a>08767     $this-&gt;HTMLHeader[<span class="charliteral">&#39;h&#39;</span>] = $height;
<a name="l08768"></a>08768      }
<a name="l08769"></a>08769      <span class="keywordflow">else</span> { $this-&gt;HTMLHeader = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08770"></a>08770   }
<a name="l08771"></a>08771   <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins &amp;&amp; $OE == <span class="charliteral">&#39;E&#39;</span>) { <span class="keywordflow">return</span>; }
<a name="l08772"></a>08772   <span class="keywordflow">if</span> ($Hhtml==<span class="stringliteral">&#39;&#39;</span>) { <span class="keywordflow">return</span>; }
<a name="l08773"></a>08773   <span class="keywordflow">if</span> ($OE == <span class="charliteral">&#39;E&#39;</span>) {
<a name="l08774"></a>08774     $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); <span class="comment">// override and clear any other non-HTML header/footer</span>
<a name="l08775"></a>08775   }
<a name="l08776"></a>08776   <span class="keywordflow">else</span> {
<a name="l08777"></a>08777     $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array();  <span class="comment">// override and clear any non-HTML other header/footer</span>
<a name="l08778"></a>08778   }
<a name="l08779"></a>08779   <span class="comment">// mPDF 4.0</span>
<a name="l08780"></a>08780   <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin==<span class="stringliteral">&#39;pad&#39;</span>) {
<a name="l08781"></a>08781     $this-&gt;tMargin = $this-&gt;margin_header + $height + $this-&gt;orig_tMargin;
<a name="l08782"></a>08782     <span class="keywordflow">if</span> (isset($this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mt&#39;</span>])) { $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mt&#39;</span>] = $this-&gt;tMargin; }
<a name="l08783"></a>08783   }
<a name="l08784"></a>08784   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;setAutoTopMargin==<span class="stringliteral">&#39;stretch&#39;</span>) {
<a name="l08785"></a>08785     $this-&gt;tMargin = max($this-&gt;orig_tMargin, $this-&gt;margin_header + $height + $this-&gt;autoMarginPadding);
<a name="l08786"></a>08786     <span class="keywordflow">if</span> (isset($this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mt&#39;</span>])) { $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mt&#39;</span>] = $this-&gt;tMargin; }
<a name="l08787"></a>08787   }
<a name="l08788"></a>08788   <span class="keywordflow">if</span> ($write &amp;&amp; $this-&gt;state!=0 &amp;&amp; (($this-&gt;mirrorMargins &amp;&amp; $OE == <span class="charliteral">&#39;E&#39;</span> &amp;&amp; ($this-&gt;page)%2==0) || ($this-&gt;mirrorMargins &amp;&amp; $OE != <span class="charliteral">&#39;E&#39;</span> &amp;&amp; ($this-&gt;page)%2==1) || !$this-&gt;mirrorMargins)) { $this-&gt;writeHTMLHeaders(); }
<a name="l08789"></a>08789 }
<a name="l08790"></a>08790 
<a name="l08791"></a>08791 function SetHTMLFooter($footer=<span class="stringliteral">&#39;&#39;</span>,$OE=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08792"></a>08792   <span class="comment">// mPDF 4.0</span>
<a name="l08793"></a>08793   $height = 0;
<a name="l08794"></a>08794   <span class="keywordflow">if</span> (is_array($footer) &amp;&amp; isset($footer[<span class="stringliteral">&#39;html&#39;</span>]) &amp;&amp; $footer[<span class="stringliteral">&#39;html&#39;</span>]) { 
<a name="l08795"></a>08795     $Fhtml = $footer[<span class="stringliteral">&#39;html&#39;</span>]; 
<a name="l08796"></a>08796     <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin) {
<a name="l08797"></a>08797       <span class="keywordflow">if</span> (isset($footer[<span class="charliteral">&#39;h&#39;</span>])) { $height = $footer[<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l08798"></a>08798       <span class="keywordflow">else</span> { $height = $this-&gt;_gethtmlheight($Fhtml); }
<a name="l08799"></a>08799     }
<a name="l08800"></a>08800   }
<a name="l08801"></a>08801   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_array($footer) &amp;&amp; $footer) { 
<a name="l08802"></a>08802     $Fhtml = $footer; 
<a name="l08803"></a>08803     <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin) { $height = $this-&gt;_gethtmlheight($Fhtml); }
<a name="l08804"></a>08804   }
<a name="l08805"></a>08805   <span class="keywordflow">else</span> { $Fhtml = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08806"></a>08806   <span class="comment">// mPDF 4.0</span>
<a name="l08807"></a>08807   <span class="keywordflow">if</span> ($OE != <span class="charliteral">&#39;E&#39;</span>) { $OE = <span class="charliteral">&#39;O&#39;</span>; }
<a name="l08808"></a>08808   <span class="keywordflow">if</span> ($OE == <span class="charliteral">&#39;E&#39;</span>) {
<a name="l08809"></a>08809      <span class="comment">// mPDF 4.0</span>
<a name="l08810"></a>08810      <span class="keywordflow">if</span> ($Fhtml) {
<a name="l08811"></a>08811     $this-&gt;HTMLFooterE[<span class="stringliteral">&#39;html&#39;</span>] = $Fhtml;
<a name="l08812"></a>08812     $this-&gt;HTMLFooterE[<span class="charliteral">&#39;h&#39;</span>] = $height;
<a name="l08813"></a>08813      }
<a name="l08814"></a>08814      <span class="keywordflow">else</span> { $this-&gt;HTMLFooterE = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08815"></a>08815   }
<a name="l08816"></a>08816   <span class="keywordflow">else</span> {
<a name="l08817"></a>08817      <span class="comment">// mPDF 4.0</span>
<a name="l08818"></a>08818      <span class="keywordflow">if</span> ($Fhtml) {
<a name="l08819"></a>08819     $this-&gt;HTMLFooter[<span class="stringliteral">&#39;html&#39;</span>] = $Fhtml;
<a name="l08820"></a>08820     $this-&gt;HTMLFooter[<span class="charliteral">&#39;h&#39;</span>] = $height;
<a name="l08821"></a>08821      }
<a name="l08822"></a>08822      <span class="keywordflow">else</span> { $this-&gt;HTMLFooter = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l08823"></a>08823   }
<a name="l08824"></a>08824   <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins &amp;&amp; $OE == <span class="charliteral">&#39;E&#39;</span>) { <span class="keywordflow">return</span>; }
<a name="l08825"></a>08825   <span class="keywordflow">if</span> ($Fhtml==<span class="stringliteral">&#39;&#39;</span>) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l08826"></a>08826   <span class="keywordflow">if</span> ($OE == <span class="charliteral">&#39;E&#39;</span>) {
<a name="l08827"></a>08827     $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); <span class="comment">// override and clear any other header/footer</span>
<a name="l08828"></a>08828   }
<a name="l08829"></a>08829   <span class="keywordflow">else</span> {
<a name="l08830"></a>08830     $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array();  <span class="comment">// override and clear any other header/footer</span>
<a name="l08831"></a>08831   }
<a name="l08832"></a>08832   <span class="comment">// mPDF 4.0</span>
<a name="l08833"></a>08833   <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin==<span class="stringliteral">&#39;pad&#39;</span>) {
<a name="l08834"></a>08834     $this-&gt;bMargin = $this-&gt;margin_footer + $height + $this-&gt;orig_bMargin;
<a name="l08835"></a>08835     $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin ;
<a name="l08836"></a>08836     <span class="keywordflow">if</span> (isset($this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mb&#39;</span>])) { $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mb&#39;</span>] = $this-&gt;bMargin; }
<a name="l08837"></a>08837   }
<a name="l08838"></a>08838   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;setAutoBottomMargin==<span class="stringliteral">&#39;stretch&#39;</span>) {
<a name="l08839"></a>08839     $this-&gt;bMargin = max($this-&gt;orig_bMargin, $this-&gt;margin_footer + $height + $this-&gt;autoMarginPadding);
<a name="l08840"></a>08840     $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin ;
<a name="l08841"></a>08841     <span class="keywordflow">if</span> (isset($this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mb&#39;</span>])) { $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mb&#39;</span>] = $this-&gt;bMargin; }
<a name="l08842"></a>08842   }
<a name="l08843"></a>08843 }
<a name="l08844"></a>08844 
<a name="l08845"></a>08845 <span class="comment">// mPDF 4.0</span>
<a name="l08846"></a>08846 function _getHtmlHeight($html) {
<a name="l08847"></a>08847     $save_state = $this-&gt;state;
<a name="l08848"></a>08848     $this-&gt;state = 2;
<a name="l08849"></a>08849     $this-&gt;Reset();
<a name="l08850"></a>08850     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l08851"></a>08851     $save_x = $this-&gt;x;
<a name="l08852"></a>08852     $save_y = $this-&gt;y;
<a name="l08853"></a>08853     $this-&gt;x = $this-&gt;lMargin;
<a name="l08854"></a>08854     $this-&gt;y = $this-&gt;margin_header;
<a name="l08855"></a>08855     $html = str_replace(<span class="stringliteral">&#39;{PAGENO}&#39;</span>,$this-&gt;pagenumPrefix.$this-&gt;docPageNum($this-&gt;page).$this-&gt;pagenumSuffix,$html);
<a name="l08856"></a>08856     $html = str_replace($this-&gt;aliasNbPgGp,$this-&gt;nbpgPrefix.$this-&gt;docPageNumTotal($this-&gt;page).$this-&gt;nbpgSuffix,$html );
<a name="l08857"></a>08857     $html = str_replace($this-&gt;aliasNbPg,$this-&gt;page,$html );
<a name="l08858"></a>08858     $html = preg_replace(<span class="stringliteral">&#39;/\{DATE\s+(.*?)\}/e&#39;</span>,<span class="stringliteral">&quot;date(&#39;\\1&#39;)&quot;</span>,$html );
<a name="l08859"></a>08859     $this-&gt;HTMLheaderPageLinks = array();
<a name="l08860"></a>08860     $savepb = $this-&gt;pageBackgrounds;
<a name="l08861"></a>08861     $this-&gt;writingHTMLheader = <span class="keyword">true</span>;
<a name="l08862"></a>08862     $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);  <span class="comment">// parameter 4 saves output to $this-&gt;headerbuffer</span>
<a name="l08863"></a>08863     $this-&gt;writingHTMLheader = <span class="keyword">false</span>;
<a name="l08864"></a>08864     $h = ($this-&gt;y - $this-&gt;margin_header);
<a name="l08865"></a>08865     $this-&gt;Reset();
<a name="l08866"></a>08866     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l08867"></a>08867     $this-&gt;headerbuffer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08868"></a>08868     $this-&gt;pageBackgrounds = $savepb;
<a name="l08869"></a>08869     $this-&gt;x = $save_x;
<a name="l08870"></a>08870     $this-&gt;y = $save_y;
<a name="l08871"></a>08871     $this-&gt;state = $save_state;
<a name="l08872"></a>08872     <span class="keywordflow">return</span> $h;
<a name="l08873"></a>08873 }
<a name="l08874"></a>08874 
<a name="l08875"></a>08875 
<a name="l08876"></a>08876 <span class="comment">// Called internally from Header</span>
<a name="l08877"></a>08877 function writeHTMLHeaders() {
<a name="l08878"></a>08878   <span class="comment">// mPDF 4.0</span>
<a name="l08879"></a>08879   <span class="keywordflow">if</span> ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page)%2==0) { $OE = <span class="charliteral">&#39;E&#39;</span>; }  <span class="comment">// EVEN</span>
<a name="l08880"></a>08880   <span class="keywordflow">else</span> { $OE = <span class="charliteral">&#39;O&#39;</span>; }
<a name="l08881"></a>08881   <span class="keywordflow">if</span> ($OE == <span class="charliteral">&#39;E&#39;</span>) {
<a name="l08882"></a>08882     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;html&#39;</span>] = $this-&gt;HTMLHeaderE[<span class="stringliteral">&#39;html&#39;</span>] ;
<a name="l08883"></a>08883   }
<a name="l08884"></a>08884   <span class="keywordflow">else</span> {
<a name="l08885"></a>08885     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;html&#39;</span>] = $this-&gt;HTMLHeader[<span class="stringliteral">&#39;html&#39;</span>] ;
<a name="l08886"></a>08886   }
<a name="l08887"></a>08887   <span class="keywordflow">if</span> ($this-&gt;forcePortraitHeaders &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;CurOrientation!=$this-&gt;DefOrientation) {
<a name="l08888"></a>08888     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;rotate&#39;</span>] = <span class="keyword">true</span>;
<a name="l08889"></a>08889     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;ml&#39;</span>] = $this-&gt;tMargin;
<a name="l08890"></a>08890     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mr&#39;</span>] = $this-&gt;bMargin;
<a name="l08891"></a>08891     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mh&#39;</span>] = $this-&gt;margin_header;
<a name="l08892"></a>08892     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mf&#39;</span>] = $this-&gt;margin_footer;
<a name="l08893"></a>08893     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;pw&#39;</span>] = $this-&gt;h;
<a name="l08894"></a>08894     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;ph&#39;</span>] = $this-&gt;w;
<a name="l08895"></a>08895   }
<a name="l08896"></a>08896   <span class="keywordflow">else</span> {
<a name="l08897"></a>08897     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;ml&#39;</span>] = $this-&gt;lMargin;
<a name="l08898"></a>08898     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mr&#39;</span>] = $this-&gt;rMargin;
<a name="l08899"></a>08899     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mh&#39;</span>] = $this-&gt;margin_header;
<a name="l08900"></a>08900     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;mf&#39;</span>] = $this-&gt;margin_footer;
<a name="l08901"></a>08901     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;pw&#39;</span>] = $this-&gt;w;
<a name="l08902"></a>08902     $this-&gt;saveHTMLHeader[$this-&gt;page][$OE][<span class="stringliteral">&#39;ph&#39;</span>] = $this-&gt;h;
<a name="l08903"></a>08903   }
<a name="l08904"></a>08904 }
<a name="l08905"></a>08905 
<a name="l08906"></a>08906 function writeHTMLFooters() {
<a name="l08907"></a>08907   <span class="comment">// mPDF 4.0</span>
<a name="l08908"></a>08908   <span class="keywordflow">if</span> ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page)%2==0) { $OE = <span class="charliteral">&#39;E&#39;</span>; }  <span class="comment">// EVEN</span>
<a name="l08909"></a>08909   <span class="keywordflow">else</span> { $OE = <span class="charliteral">&#39;O&#39;</span>; }
<a name="l08910"></a>08910   <span class="keywordflow">if</span> ($OE == <span class="charliteral">&#39;E&#39;</span>) {
<a name="l08911"></a>08911     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;html&#39;</span>] = $this-&gt;HTMLFooterE[<span class="stringliteral">&#39;html&#39;</span>] ;
<a name="l08912"></a>08912   }
<a name="l08913"></a>08913   <span class="keywordflow">else</span> {
<a name="l08914"></a>08914     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;html&#39;</span>] = $this-&gt;HTMLFooter[<span class="stringliteral">&#39;html&#39;</span>] ;
<a name="l08915"></a>08915   }
<a name="l08916"></a>08916   <span class="keywordflow">if</span> ($this-&gt;forcePortraitHeaders &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;CurOrientation!=$this-&gt;DefOrientation) {
<a name="l08917"></a>08917     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;rotate&#39;</span>] = <span class="keyword">true</span>;
<a name="l08918"></a>08918     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;ml&#39;</span>] = $this-&gt;tMargin;
<a name="l08919"></a>08919     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mr&#39;</span>] = $this-&gt;bMargin;
<a name="l08920"></a>08920     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mt&#39;</span>] = $this-&gt;rMargin;
<a name="l08921"></a>08921     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mb&#39;</span>] = $this-&gt;lMargin;
<a name="l08922"></a>08922     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mh&#39;</span>] = $this-&gt;margin_header;
<a name="l08923"></a>08923     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mf&#39;</span>] = $this-&gt;margin_footer;
<a name="l08924"></a>08924     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;pw&#39;</span>] = $this-&gt;h;
<a name="l08925"></a>08925     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;ph&#39;</span>] = $this-&gt;w;
<a name="l08926"></a>08926   }
<a name="l08927"></a>08927   <span class="keywordflow">else</span> {
<a name="l08928"></a>08928     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;ml&#39;</span>] = $this-&gt;lMargin;
<a name="l08929"></a>08929     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mr&#39;</span>] = $this-&gt;rMargin;
<a name="l08930"></a>08930     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mt&#39;</span>] = $this-&gt;tMargin;
<a name="l08931"></a>08931     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mb&#39;</span>] = $this-&gt;bMargin;
<a name="l08932"></a>08932     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mh&#39;</span>] = $this-&gt;margin_header;
<a name="l08933"></a>08933     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;mf&#39;</span>] = $this-&gt;margin_footer;
<a name="l08934"></a>08934     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;pw&#39;</span>] = $this-&gt;w;
<a name="l08935"></a>08935     $this-&gt;saveHTMLFooter[$this-&gt;page][$OE][<span class="stringliteral">&#39;ph&#39;</span>] = $this-&gt;h;
<a name="l08936"></a>08936   }
<a name="l08937"></a>08937 }
<a name="l08938"></a>08938 
<a name="l08939"></a>08939 function DefHeaderByName($name,$arr) {
<a name="l08940"></a>08940   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08941"></a>08941   $this-&gt;pageheaders[$name] = $arr;
<a name="l08942"></a>08942 }
<a name="l08943"></a>08943 
<a name="l08944"></a>08944 function DefFooterByName($name,$arr) {
<a name="l08945"></a>08945   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08946"></a>08946   $this-&gt;pagefooters[$name] = $arr;
<a name="l08947"></a>08947 }
<a name="l08948"></a>08948 
<a name="l08949"></a>08949 function SetHeaderByName($name,$side=<span class="charliteral">&#39;O&#39;</span>,$write=<span class="keyword">false</span>) {
<a name="l08950"></a>08950   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08951"></a>08951   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $this-&gt;pageheaders[$name]; }
<a name="l08952"></a>08952   <span class="keywordflow">else</span> { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pageheaders[$name]; }
<a name="l08953"></a>08953   <span class="keywordflow">if</span> ($write) { $this-&gt;Header(); }
<a name="l08954"></a>08954 }
<a name="l08955"></a>08955 
<a name="l08956"></a>08956 function SetFooterByName($name,$side=<span class="charliteral">&#39;O&#39;</span>) {
<a name="l08957"></a>08957   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08958"></a>08958   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $this-&gt;pagefooters[$name]; }
<a name="l08959"></a>08959   <span class="keywordflow">else</span> { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pagefooters[$name]; }
<a name="l08960"></a>08960 }
<a name="l08961"></a>08961 
<a name="l08962"></a>08962 function DefHTMLHeaderByName($name,$html) {
<a name="l08963"></a>08963   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08964"></a>08964   <span class="comment">// mPDF 4.0</span>
<a name="l08965"></a>08965   $this-&gt;pageHTMLheaders[$name][<span class="stringliteral">&#39;html&#39;</span>] = $html;
<a name="l08966"></a>08966   $this-&gt;pageHTMLheaders[$name][<span class="charliteral">&#39;h&#39;</span>] = $this-&gt;_gethtmlheight($html);
<a name="l08967"></a>08967 }
<a name="l08968"></a>08968 
<a name="l08969"></a>08969 function DefHTMLFooterByName($name,$html) {
<a name="l08970"></a>08970   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08971"></a>08971   <span class="comment">// mPDF 4.0</span>
<a name="l08972"></a>08972   $this-&gt;pageHTMLfooters[$name][<span class="stringliteral">&#39;html&#39;</span>] = $html;
<a name="l08973"></a>08973   $this-&gt;pageHTMLfooters[$name][<span class="charliteral">&#39;h&#39;</span>] = $this-&gt;_gethtmlheight($html);
<a name="l08974"></a>08974 }
<a name="l08975"></a>08975 
<a name="l08976"></a>08976 function SetHTMLHeaderByName($name,$side=<span class="charliteral">&#39;O&#39;</span>,$write=<span class="keyword">false</span>) {
<a name="l08977"></a>08977   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08978"></a>08978   $this-&gt;SetHTMLHeader($this-&gt;pageHTMLheaders[$name],$side,$write);
<a name="l08979"></a>08979 }
<a name="l08980"></a>08980 
<a name="l08981"></a>08981 function SetHTMLFooterByName($name,$side=<span class="charliteral">&#39;O&#39;</span>) {
<a name="l08982"></a>08982   <span class="keywordflow">if</span> (!$name) { $name = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l08983"></a>08983   $this-&gt;SetHTMLFooter($this-&gt;pageHTMLfooters[$name],$side,$write);
<a name="l08984"></a>08984 }
<a name="l08985"></a>08985 
<a name="l08986"></a>08986 
<a name="l08987"></a>08987 function SetHeader($Harray=array(),$side=<span class="stringliteral">&#39;&#39;</span>,$write=<span class="keyword">false</span>) {
<a name="l08988"></a>08988   <span class="keywordflow">if</span> (is_string($Harray)) {
<a name="l08989"></a>08989     <span class="keywordflow">if</span> (strlen($Harray)==0) {
<a name="l08990"></a>08990   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;O&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); }
<a name="l08991"></a>08991   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); }
<a name="l08992"></a>08992   <span class="keywordflow">else</span> { $this-&gt;headerDetails = array(); }
<a name="l08993"></a>08993    }
<a name="l08994"></a>08994    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strpos($Harray,<span class="charliteral">&#39;|&#39;</span>) || strpos($Harray,<span class="charliteral">&#39;|&#39;</span>)===0) {
<a name="l08995"></a>08995   $hdet = explode(<span class="charliteral">&#39;|&#39;</span>,$Harray);
<a name="l08996"></a>08996   $this-&gt;headerDetails = array (
<a name="l08997"></a>08997       <span class="stringliteral">&#39;odd&#39;</span> =&gt; array (
<a name="l08998"></a>08998   <span class="charliteral">&#39;L&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $hdet[0], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l08999"></a>08999   <span class="charliteral">&#39;C&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $hdet[1], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09000"></a>09000   <span class="charliteral">&#39;R&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $hdet[2], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09001"></a>09001   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultheaderline,
<a name="l09002"></a>09002       ),
<a name="l09003"></a>09003       <span class="stringliteral">&#39;even&#39;</span> =&gt; array (
<a name="l09004"></a>09004   <span class="charliteral">&#39;R&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $hdet[0], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09005"></a>09005   <span class="charliteral">&#39;C&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $hdet[1], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09006"></a>09006   <span class="charliteral">&#39;L&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $hdet[2], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09007"></a>09007   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultheaderline,
<a name="l09008"></a>09008     )
<a name="l09009"></a>09009   );
<a name="l09010"></a>09010     }
<a name="l09011"></a>09011     <span class="keywordflow">else</span> {
<a name="l09012"></a>09012   $this-&gt;headerDetails = array (
<a name="l09013"></a>09013       <span class="stringliteral">&#39;odd&#39;</span> =&gt; array (
<a name="l09014"></a>09014   <span class="charliteral">&#39;R&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $Harray, <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09015"></a>09015   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultheaderline,
<a name="l09016"></a>09016       ),
<a name="l09017"></a>09017       <span class="stringliteral">&#39;even&#39;</span> =&gt; array (
<a name="l09018"></a>09018   <span class="charliteral">&#39;L&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $Harray, <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultheaderfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultheaderfontstyle),
<a name="l09019"></a>09019   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultheaderline,
<a name="l09020"></a>09020     )
<a name="l09021"></a>09021   );
<a name="l09022"></a>09022     }
<a name="l09023"></a>09023   }
<a name="l09024"></a>09024   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_array($Harray)) {
<a name="l09025"></a>09025   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;O&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $Harray; }
<a name="l09026"></a>09026   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $Harray; }
<a name="l09027"></a>09027   <span class="keywordflow">else</span> { $this-&gt;headerDetails = $Harray; }
<a name="l09028"></a>09028   }
<a name="l09029"></a>09029   <span class="comment">// Overwrite any HTML Header previously set</span>
<a name="l09030"></a>09030   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;SetHTMLHeader(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;E&#39;</span>); }
<a name="l09031"></a>09031   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;O&#39;</span>) {  $this-&gt;SetHTMLHeader(<span class="stringliteral">&#39;&#39;</span>); }
<a name="l09032"></a>09032   <span class="keywordflow">else</span> {
<a name="l09033"></a>09033   $this-&gt;SetHTMLHeader(<span class="stringliteral">&#39;&#39;</span>);
<a name="l09034"></a>09034   $this-&gt;SetHTMLHeader(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;E&#39;</span>);
<a name="l09035"></a>09035   }
<a name="l09036"></a>09036 
<a name="l09037"></a>09037   <span class="keywordflow">if</span> ($write) { 
<a name="l09038"></a>09038   $save_y = $this-&gt;y;
<a name="l09039"></a>09039   $this-&gt;Header();
<a name="l09040"></a>09040   $this-&gt;SetY($save_y) ; 
<a name="l09041"></a>09041   }
<a name="l09042"></a>09042 }
<a name="l09043"></a>09043 
<a name="l09044"></a>09044 function SetFooter($Farray=array(),$side=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l09045"></a>09045   <span class="keywordflow">if</span> (is_string($Farray)) {
<a name="l09046"></a>09046     <span class="keywordflow">if</span> (strlen($Farray)==0) {
<a name="l09047"></a>09047   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;O&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); }
<a name="l09048"></a>09048   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); }
<a name="l09049"></a>09049   <span class="keywordflow">else</span> { $this-&gt;footerDetails = array(); }
<a name="l09050"></a>09050     }
<a name="l09051"></a>09051     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strpos($Farray,<span class="charliteral">&#39;|&#39;</span>) || strpos($Farray,<span class="charliteral">&#39;|&#39;</span>)===0) {
<a name="l09052"></a>09052   $fdet = explode(<span class="charliteral">&#39;|&#39;</span>,$Farray);
<a name="l09053"></a>09053   $this-&gt;footerDetails = array (
<a name="l09054"></a>09054     <span class="stringliteral">&#39;odd&#39;</span> =&gt; array (
<a name="l09055"></a>09055   <span class="charliteral">&#39;L&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $fdet[0], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09056"></a>09056   <span class="charliteral">&#39;C&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $fdet[1], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09057"></a>09057   <span class="charliteral">&#39;R&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $fdet[2], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09058"></a>09058   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultfooterline,
<a name="l09059"></a>09059     ),
<a name="l09060"></a>09060     <span class="stringliteral">&#39;even&#39;</span> =&gt; array (
<a name="l09061"></a>09061   <span class="charliteral">&#39;R&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $fdet[0], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09062"></a>09062   <span class="charliteral">&#39;C&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $fdet[1], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09063"></a>09063   <span class="charliteral">&#39;L&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $fdet[2], <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09064"></a>09064   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultfooterline,
<a name="l09065"></a>09065     )
<a name="l09066"></a>09066   );
<a name="l09067"></a>09067     }
<a name="l09068"></a>09068     <span class="keywordflow">else</span> {
<a name="l09069"></a>09069   $this-&gt;footerDetails = array (
<a name="l09070"></a>09070     <span class="stringliteral">&#39;odd&#39;</span> =&gt; array (
<a name="l09071"></a>09071   <span class="charliteral">&#39;R&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $Farray, <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09072"></a>09072   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultfooterline,
<a name="l09073"></a>09073     ),
<a name="l09074"></a>09074     <span class="stringliteral">&#39;even&#39;</span> =&gt; array (
<a name="l09075"></a>09075   <span class="charliteral">&#39;L&#39;</span> =&gt; array (<span class="stringliteral">&#39;content&#39;</span> =&gt; $Farray, <span class="stringliteral">&#39;font-size&#39;</span> =&gt; $this-&gt;defaultfooterfontsize, <span class="stringliteral">&#39;font-style&#39;</span> =&gt; $this-&gt;defaultfooterfontstyle),
<a name="l09076"></a>09076   <span class="stringliteral">&#39;line&#39;</span> =&gt; $this-&gt;defaultfooterline,
<a name="l09077"></a>09077     )
<a name="l09078"></a>09078   );
<a name="l09079"></a>09079     }
<a name="l09080"></a>09080   }
<a name="l09081"></a>09081   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_array($Farray)) {
<a name="l09082"></a>09082   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;O&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $Farray; }
<a name="l09083"></a>09083   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $Farray; }
<a name="l09084"></a>09084   <span class="keywordflow">else</span> { $this-&gt;footerDetails = $Farray; }
<a name="l09085"></a>09085   }
<a name="l09086"></a>09086   <span class="comment">// Overwrite any HTML Footer previously set</span>
<a name="l09087"></a>09087   <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;E&#39;</span>) { $this-&gt;SetHTMLFooter(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;E&#39;</span>); }
<a name="l09088"></a>09088   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side==<span class="charliteral">&#39;O&#39;</span>) {  $this-&gt;SetHTMLFooter(<span class="stringliteral">&#39;&#39;</span>); }
<a name="l09089"></a>09089   <span class="keywordflow">else</span> {
<a name="l09090"></a>09090   $this-&gt;SetHTMLFooter(<span class="stringliteral">&#39;&#39;</span>);
<a name="l09091"></a>09091   $this-&gt;SetHTMLFooter(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;E&#39;</span>);
<a name="l09092"></a>09092   }
<a name="l09093"></a>09093 }
<a name="l09094"></a>09094 
<a name="l09095"></a>09095 function setUnvalidatedText($txt=<span class="stringliteral">&#39;&#39;</span>, $alpha=-1) {
<a name="l09096"></a>09096   <span class="keywordflow">if</span> ($alpha&gt;=0) $this-&gt;watermarkTextAlpha = $alpha;
<a name="l09097"></a>09097   $this-&gt;watermarkText = $txt;
<a name="l09098"></a>09098 }
<a name="l09099"></a>09099 function SetWatermarkText($txt=<span class="stringliteral">&#39;&#39;</span>, $alpha=-1) {
<a name="l09100"></a>09100   <span class="keywordflow">if</span> ($alpha&gt;=0) $this-&gt;watermarkTextAlpha = $alpha;
<a name="l09101"></a>09101   $this-&gt;watermarkText = $txt;
<a name="l09102"></a>09102 }
<a name="l09103"></a>09103 
<a name="l09104"></a>09104 function SetWatermarkImage($src, $alpha=-1, $size=<span class="charliteral">&#39;D&#39;</span>, $pos=<span class="charliteral">&#39;F&#39;</span>) {
<a name="l09105"></a>09105   <span class="keywordflow">if</span> ($alpha&gt;=0) $this-&gt;watermarkImageAlpha = $alpha;
<a name="l09106"></a>09106   $this-&gt;watermarkImage = $src;
<a name="l09107"></a>09107   $this-&gt;watermark_size = $size;
<a name="l09108"></a>09108   $this-&gt;watermark_pos = $pos;
<a name="l09109"></a>09109 }
<a name="l09110"></a>09110 
<a name="l09111"></a>09111 
<a name="l09112"></a>09112 <span class="comment">//Page footer</span>
<a name="l09113"></a>09113 function Footer() {
<a name="l09114"></a>09114   <span class="comment">// PAGED MEDIA - CROP / CROSS MARKS from @PAGE</span>
<a name="l09115"></a>09115   <span class="keywordflow">if</span> ($this-&gt;show_marks == <span class="stringliteral">&#39;CROP&#39;</span>) {
<a name="l09116"></a>09116   <span class="comment">// Show TICK MARKS</span>
<a name="l09117"></a>09117   $this-&gt;SetLineWidth(0.1); <span class="comment">// = 0.1 mm</span>
<a name="l09118"></a>09118   $this-&gt;SetDrawColor(0);
<a name="l09119"></a>09119   $l = 18;  <span class="comment">// Default length in mm of crop line</span>
<a name="l09120"></a>09120   $m = 8; <span class="comment">// Distance of crop mark from margin in mm</span>
<a name="l09121"></a>09121   $b = 8; <span class="comment">// Non-printable border at edge of paper sheet in mm</span>
<a name="l09122"></a>09122   $ax1 = $b;
<a name="l09123"></a>09123   $bx = $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>] - $m;
<a name="l09124"></a>09124   $ax = max($ax1, $bx-$l);
<a name="l09125"></a>09125   $cx1 = $this-&gt;w - $b;
<a name="l09126"></a>09126   $dx = $this-&gt;w - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>] + $m;
<a name="l09127"></a>09127   $cx = min($cx1, $dx+$l);
<a name="l09128"></a>09128   $ay1 = $b;
<a name="l09129"></a>09129   $by = $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>] - $m;
<a name="l09130"></a>09130   $ay = max($ay1, $by-$l);
<a name="l09131"></a>09131   $cy1 = $this-&gt;h - $b;
<a name="l09132"></a>09132   $dy = $this-&gt;h - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>] + $m;
<a name="l09133"></a>09133   $cy = min($cy1, $dy+$l);
<a name="l09134"></a>09134 
<a name="l09135"></a>09135   $this-&gt;Line($ax, $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>], $bx, $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>]);
<a name="l09136"></a>09136   $this-&gt;Line($cx, $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>], $dx, $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>]);
<a name="l09137"></a>09137   $this-&gt;Line($ax, $this-&gt;h - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>], $bx, $this-&gt;h - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>]);
<a name="l09138"></a>09138   $this-&gt;Line($cx, $this-&gt;h - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>], $dx, $this-&gt;h - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>]);
<a name="l09139"></a>09139   $this-&gt;Line($this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $ay, $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $by);
<a name="l09140"></a>09140   $this-&gt;Line($this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $cy, $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $dy);
<a name="l09141"></a>09141   $this-&gt;Line($this-&gt;w - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $ay, $this-&gt;w - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $by);
<a name="l09142"></a>09142   $this-&gt;Line($this-&gt;w - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $cy, $this-&gt;w - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>], $dy);
<a name="l09143"></a>09143   }
<a name="l09144"></a>09144   <span class="keywordflow">if</span> ($this-&gt;show_marks == <span class="stringliteral">&#39;CROSS&#39;</span>) {
<a name="l09145"></a>09145   $this-&gt;SetLineWidth(0.1); <span class="comment">// = 0.1 mm</span>
<a name="l09146"></a>09146   $this-&gt;SetDrawColor(0);
<a name="l09147"></a>09147   $l = 14 /2; <span class="comment">// longer length of the cross line (half)</span>
<a name="l09148"></a>09148   $w = 6 /2;  <span class="comment">// shorter width of the cross line (half)</span>
<a name="l09149"></a>09149   $r = 1.2; <span class="comment">// radius of circle</span>
<a name="l09150"></a>09150   $m = 10;  <span class="comment">// Distance of cross mark from margin in mm</span>
<a name="l09151"></a>09151   $x1 = $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>] - $m;
<a name="l09152"></a>09152   $x2 = $this-&gt;w - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>] + $m;
<a name="l09153"></a>09153   $y1 = $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>] - $m;
<a name="l09154"></a>09154   $y2 = $this-&gt;h - $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>] + $m;
<a name="l09155"></a>09155   <span class="comment">// Left</span>
<a name="l09156"></a>09156   $this-&gt;Circle($x1, $this-&gt;h/2, $r, <span class="charliteral">&#39;S&#39;</span>) ;
<a name="l09157"></a>09157   $this-&gt;Line($x1-$w, $this-&gt;h/2, $x1+$w, $this-&gt;h/2);
<a name="l09158"></a>09158   $this-&gt;Line($x1, $this-&gt;h/2-$l, $x1, $this-&gt;h/2+$l);
<a name="l09159"></a>09159   <span class="comment">// Right</span>
<a name="l09160"></a>09160   $this-&gt;Circle($x2, $this-&gt;h/2, $r, <span class="charliteral">&#39;S&#39;</span>) ;
<a name="l09161"></a>09161   $this-&gt;Line($x2-$w, $this-&gt;h/2, $x2+$w, $this-&gt;h/2);
<a name="l09162"></a>09162   $this-&gt;Line($x2, $this-&gt;h/2-$l, $x2, $this-&gt;h/2+$l);
<a name="l09163"></a>09163   <span class="comment">// Top</span>
<a name="l09164"></a>09164   $this-&gt;Circle($this-&gt;w/2, $y1, $r, <span class="charliteral">&#39;S&#39;</span>) ;
<a name="l09165"></a>09165   $this-&gt;Line($this-&gt;w/2, $y1-$w, $this-&gt;w/2, $y1+$w);
<a name="l09166"></a>09166   $this-&gt;Line($this-&gt;w/2-$l, $y1, $this-&gt;w/2+$l, $y1);
<a name="l09167"></a>09167   <span class="comment">// Bottom</span>
<a name="l09168"></a>09168   $this-&gt;Circle($this-&gt;w/2, $y2, $r, <span class="charliteral">&#39;S&#39;</span>) ;
<a name="l09169"></a>09169   $this-&gt;Line($this-&gt;w/2, $y2-$w, $this-&gt;w/2, $y2+$w);
<a name="l09170"></a>09170   $this-&gt;Line($this-&gt;w/2-$l, $y2, $this-&gt;w/2+$l, $y2);
<a name="l09171"></a>09171   }
<a name="l09172"></a>09172 
<a name="l09173"></a>09173 
<a name="l09174"></a>09174   <span class="comment">// If @page set non-HTML headers/footers named, they were not read until later in the HTML code - so now set them</span>
<a name="l09175"></a>09175   <span class="keywordflow">if</span> ($this-&gt;page==1) {
<a name="l09176"></a>09176     <span class="keywordflow">if</span> ($this-&gt;firstPageBoxHeader) {
<a name="l09177"></a>09177       $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pageheaders[$this-&gt;firstPageBoxHeader]; 
<a name="l09178"></a>09178         $this-&gt;Header();
<a name="l09179"></a>09179     }
<a name="l09180"></a>09180     <span class="keywordflow">if</span> ($this-&gt;firstPageBoxFooter) {
<a name="l09181"></a>09181       $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pagefooters[$this-&gt;firstPageBoxFooter];
<a name="l09182"></a>09182     }
<a name="l09183"></a>09183     $this-&gt;firstPageBoxHeader=<span class="stringliteral">&#39;&#39;</span>;
<a name="l09184"></a>09184     $this-&gt;firstPageBoxFooter=<span class="stringliteral">&#39;&#39;</span>;
<a name="l09185"></a>09185   }
<a name="l09186"></a>09186 
<a name="l09187"></a>09187 
<a name="l09188"></a>09188 
<a name="l09189"></a>09189   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page%2==0) &amp;&amp; $this-&gt;HTMLFooterE) || ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page%2==1) &amp;&amp; $this-&gt;HTMLFooter) || (!$this-&gt;mirrorMargins &amp;&amp; $this-&gt;HTMLFooter)) {
<a name="l09190"></a>09190   $this-&gt;writeHTMLFooters(); 
<a name="l09191"></a>09191     <span class="keywordflow">if</span> (($this-&gt;watermarkText) &amp;&amp; ($this-&gt;showWatermarkText)) {
<a name="l09192"></a>09192     $this-&gt;watermark( $this-&gt;watermarkText, 45, 120, $this-&gt;watermarkTextAlpha);  <span class="comment">// Watermark text</span>
<a name="l09193"></a>09193     }
<a name="l09194"></a>09194   <span class="keywordflow">if</span> (($this-&gt;watermarkImage) &amp;&amp; ($this-&gt;showWatermarkImage)) {
<a name="l09195"></a>09195     $this-&gt;watermarkImg( $this-&gt;watermarkImage, $this-&gt;watermarkImageAlpha);  <span class="comment">// Watermark image</span>
<a name="l09196"></a>09196   }
<a name="l09197"></a>09197   <span class="keywordflow">return</span>;
<a name="l09198"></a>09198   }
<a name="l09199"></a>09199 
<a name="l09200"></a>09200   $this-&gt;processingHeader=<span class="keyword">true</span>;
<a name="l09201"></a>09201   $this-&gt;ResetMargins();  <span class="comment">// necessary after columns</span>
<a name="l09202"></a>09202   $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l09203"></a>09203   <span class="keywordflow">if</span> (($this-&gt;watermarkText) &amp;&amp; ($this-&gt;showWatermarkText)) {
<a name="l09204"></a>09204   $this-&gt;watermark( $this-&gt;watermarkText, 45, 120, $this-&gt;watermarkTextAlpha);  <span class="comment">// Watermark text</span>
<a name="l09205"></a>09205   }
<a name="l09206"></a>09206   <span class="keywordflow">if</span> (($this-&gt;watermarkImage) &amp;&amp; ($this-&gt;showWatermarkImage)) {
<a name="l09207"></a>09207   $this-&gt;watermarkImg( $this-&gt;watermarkImage, $this-&gt;watermarkImageAlpha);  <span class="comment">// Watermark image</span>
<a name="l09208"></a>09208   }
<a name="l09209"></a>09209   $h = $this-&gt;footerDetails;
<a name="l09210"></a>09210   <span class="keywordflow">if</span>(count($h)) {
<a name="l09211"></a>09211 
<a name="l09212"></a>09212   <span class="keywordflow">if</span> ($this-&gt;forcePortraitHeaders &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;CurOrientation!=$this-&gt;DefOrientation) {
<a name="l09213"></a>09213     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;q 0 -1 1 0 0 %.3f cm &#39;</span>,($this-&gt;h*$this-&gt;k)));
<a name="l09214"></a>09214     $headerpgwidth = $this-&gt;h - $this-&gt;orig_lMargin - $this-&gt;orig_rMargin;
<a name="l09215"></a>09215     <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l09216"></a>09216       $headerlmargin = $this-&gt;orig_rMargin;
<a name="l09217"></a>09217     }
<a name="l09218"></a>09218     <span class="keywordflow">else</span> {
<a name="l09219"></a>09219       $headerlmargin = $this-&gt;orig_lMargin;
<a name="l09220"></a>09220     }
<a name="l09221"></a>09221   }
<a name="l09222"></a>09222   <span class="keywordflow">else</span> { 
<a name="l09223"></a>09223     $yadj = 0; 
<a name="l09224"></a>09224     $headerpgwidth = $this-&gt;pgwidth;
<a name="l09225"></a>09225     $headerlmargin = $this-&gt;lMargin;
<a name="l09226"></a>09226   }
<a name="l09227"></a>09227   $this-&gt;SetY(-$this-&gt;margin_footer);
<a name="l09228"></a>09228 
<a name="l09229"></a>09229   $this-&gt;SetTextColor(0);
<a name="l09230"></a>09230       $this-&gt;SUP = <span class="keyword">false</span>;
<a name="l09231"></a>09231   $this-&gt;SUB = <span class="keyword">false</span>;
<a name="l09232"></a>09232   $this-&gt;bullet = <span class="keyword">false</span>;
<a name="l09233"></a>09233 
<a name="l09234"></a>09234   <span class="comment">// only show pagenumber if numbering on</span>
<a name="l09235"></a>09235   <span class="comment">// mPDF 3.0 Add PageNum prefix/suffix</span>
<a name="l09236"></a>09236   $pgno = $this-&gt;docPageNum($this-&gt;page, <span class="keyword">true</span>); 
<a name="l09237"></a>09237 
<a name="l09238"></a>09238   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l09239"></a>09239       $side = <span class="stringliteral">&#39;even&#39;</span>;
<a name="l09240"></a>09240   }
<a name="l09241"></a>09241   <span class="keywordflow">else</span> {  <span class="comment">// ODD  // OR NOT MIRRORING MARGINS/FOOTERS = DEFAULT</span>
<a name="l09242"></a>09242       $side = <span class="stringliteral">&#39;odd&#39;</span>;
<a name="l09243"></a>09243   }
<a name="l09244"></a>09244   $maxfontheight = 0;
<a name="l09245"></a>09245   <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;L&#39;</span>,<span class="charliteral">&#39;C&#39;</span>,<span class="charliteral">&#39;R&#39;</span>) AS $pos) {
<a name="l09246"></a>09246     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) {
<a name="l09247"></a>09247     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) { $hfsz = $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]; }
<a name="l09248"></a>09248     <span class="keywordflow">else</span> { $hfsz = $this-&gt;default_font_size; }
<a name="l09249"></a>09249     $maxfontheight = max($maxfontheight,$hfsz);
<a name="l09250"></a>09250     }
<a name="l09251"></a>09251   }
<a name="l09252"></a>09252   <span class="comment">// LEFT-CENTER-RIGHT</span>
<a name="l09253"></a>09253   <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;L&#39;</span>,<span class="charliteral">&#39;C&#39;</span>,<span class="charliteral">&#39;R&#39;</span>) AS $pos) {
<a name="l09254"></a>09254     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]) {
<a name="l09255"></a>09255     $hd = str_replace(<span class="stringliteral">&#39;{PAGENO}&#39;</span>,$pgno,$h[$side][$pos][<span class="stringliteral">&#39;content&#39;</span>]);
<a name="l09256"></a>09256     <span class="comment">// mPDF 3.0</span>
<a name="l09257"></a>09257     $hd = str_replace($this-&gt;aliasNbPgGp,$this-&gt;nbpgPrefix.$this-&gt;aliasNbPgGp.$this-&gt;nbpgSuffix,$hd); <span class="comment">// {nbpg}</span>
<a name="l09258"></a>09258     $hd = preg_replace(<span class="stringliteral">&#39;/\{DATE\s+(.*?)\}/e&#39;</span>,<span class="stringliteral">&quot;date(&#39;\\1&#39;)&quot;</span>,$hd);
<a name="l09259"></a>09259     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-family&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-family&#39;</span>]) { $hff = $h[$side][$pos][<span class="stringliteral">&#39;font-family&#39;</span>]; }
<a name="l09260"></a>09260     <span class="comment">// mPDF 3.0 original_ in case pagebreak in middle of table</span>
<a name="l09261"></a>09261     <span class="keywordflow">else</span> { $hff = $this-&gt;original_default_font; }
<a name="l09262"></a>09262     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]) { $hfsz = $h[$side][$pos][<span class="stringliteral">&#39;font-size&#39;</span>]; }
<a name="l09263"></a>09263     <span class="comment">// mPDF 3.0 original_ in case pagebreak in middle of table</span>
<a name="l09264"></a>09264     <span class="keywordflow">else</span> { $hfsz = $this-&gt;original_default_font_size; }
<a name="l09265"></a>09265     $maxfontheight = max($maxfontheight,$hfsz);
<a name="l09266"></a>09266     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;font-style&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;font-style&#39;</span>]) { $hfst = $h[$side][$pos][<span class="stringliteral">&#39;font-style&#39;</span>]; }
<a name="l09267"></a>09267     <span class="keywordflow">else</span> { $hfst = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l09268"></a>09268     <span class="keywordflow">if</span> (isset($h[$side][$pos][<span class="stringliteral">&#39;color&#39;</span>]) &amp;&amp; $h[$side][$pos][<span class="stringliteral">&#39;color&#39;</span>]) { 
<a name="l09269"></a>09269       $hfcol = $h[$side][$pos][<span class="stringliteral">&#39;color&#39;</span>]; 
<a name="l09270"></a>09270       $cor = $this-&gt;ConvertColor($hfcol);
<a name="l09271"></a>09271       <span class="keywordflow">if</span> ($cor) { $this-&gt;SetTextColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]); }
<a name="l09272"></a>09272     }
<a name="l09273"></a>09273     <span class="keywordflow">else</span> { $hfcol = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l09274"></a>09274     <span class="comment">// mPDF 3.0 Force output</span>
<a name="l09275"></a>09275     $this-&gt;SetFont($hff,$hfst,$hfsz,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l09276"></a>09276     $this-&gt;x = $headerlmargin ;
<a name="l09277"></a>09277     <span class="comment">// mPDF 4.0</span>
<a name="l09278"></a>09278 <span class="comment">//    $this-&gt;y = $this-&gt;h - $this-&gt;margin_footer - ($maxfontheight/$this-&gt;k * 0.5) - 0.5;</span>
<a name="l09279"></a>09279     $this-&gt;y = $this-&gt;h - $this-&gt;margin_footer - ($maxfontheight/$this-&gt;k);
<a name="l09280"></a>09280     $hd = $this-&gt;purify_utf8_text($hd);
<a name="l09281"></a>09281     <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l09282"></a>09282       $hd = $this-&gt;all_entities_to_utf8($hd);
<a name="l09283"></a>09283     }
<a name="l09284"></a>09284     <span class="comment">// CONVERT CODEPAGE</span>
<a name="l09285"></a>09285     <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $hd = mb_convert_encoding($hd,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l09286"></a>09286     <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l09287"></a>09287     <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l09288"></a>09288     $align = $pos;
<a name="l09289"></a>09289     <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { 
<a name="l09290"></a>09290       <span class="keywordflow">if</span> ($pos == <span class="charliteral">&#39;L&#39;</span>) { $align = <span class="charliteral">&#39;R&#39;</span>; }
<a name="l09291"></a>09291       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($pos == <span class="charliteral">&#39;R&#39;</span>) { $align = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l09292"></a>09292     }
<a name="l09293"></a>09293 
<a name="l09294"></a>09294     <span class="keywordflow">if</span> ($pos!=<span class="charliteral">&#39;L&#39;</span> &amp;&amp; (stripos($hd,$this-&gt;aliasNbPg)!==<span class="keyword">false</span> || stripos($hd,$this-&gt;aliasNbPgGp)!==<span class="keyword">false</span>)) { 
<a name="l09295"></a>09295       <span class="keywordflow">if</span> (stripos($hd,$this-&gt;aliasNbPgGp)!==<span class="keyword">false</span>) { $type= <span class="stringliteral">&#39;nbpggp&#39;</span>; } <span class="keywordflow">else</span> { $type= <span class="stringliteral">&#39;nbpg&#39;</span>; }
<a name="l09296"></a>09296       $this-&gt;_out(<span class="stringliteral">&#39;{mpdfheader&#39;</span>.$type.<span class="charliteral">&#39; &#39;</span>.$pos.<span class="stringliteral">&#39; ff=&#39;</span>.$hff.<span class="stringliteral">&#39; fs=&#39;</span>.$hfst.<span class="stringliteral">&#39; fz=&#39;</span>.$hfsz.<span class="charliteral">&#39;}&#39;</span>); 
<a name="l09297"></a>09297       <span class="comment">// mPDF 4.0</span>
<a name="l09298"></a>09298       $this-&gt;Cell($headerpgwidth ,$maxfontheight/$this-&gt;k ,$hd,0,0,$align,0,<span class="stringliteral">&#39;&#39;</span>,0,0,0,<span class="charliteral">&#39;M&#39;</span>);
<a name="l09299"></a>09299       $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l09300"></a>09300     }
<a name="l09301"></a>09301     <span class="keywordflow">else</span> { 
<a name="l09302"></a>09302       <span class="comment">// mPDF 4.0</span>
<a name="l09303"></a>09303       $this-&gt;Cell($headerpgwidth ,$maxfontheight/$this-&gt;k ,$hd,0,0,$align,0,<span class="stringliteral">&#39;&#39;</span>,0,0,0,<span class="charliteral">&#39;M&#39;</span>);
<a name="l09304"></a>09304     }
<a name="l09305"></a>09305     <span class="keywordflow">if</span> ($hfcol) { $this-&gt;SetTextColor(0); }
<a name="l09306"></a>09306     }
<a name="l09307"></a>09307   }
<a name="l09308"></a>09308   <span class="comment">// Return Font to normal</span>
<a name="l09309"></a>09309   $this-&gt;SetFont($this-&gt;default_font,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;original_default_font_size);
<a name="l09310"></a>09310 
<a name="l09311"></a>09311   <span class="comment">// LINE</span>
<a name="l09312"></a>09312   <span class="comment">// mPDF 4.0</span>
<a name="l09313"></a>09313   <span class="keywordflow">if</span> (isset($h[$side][<span class="stringliteral">&#39;line&#39;</span>]) &amp;&amp; $h[$side][<span class="stringliteral">&#39;line&#39;</span>]) { 
<a name="l09314"></a>09314     $this-&gt;SetLineWidth(0.1);
<a name="l09315"></a>09315     $this-&gt;SetDrawColor(0);
<a name="l09316"></a>09316     <span class="comment">// mPDF 4.0</span>
<a name="l09317"></a>09317     $this-&gt;Line($headerlmargin , $this-&gt;y-($maxfontheight*($this-&gt;footer_line_spacing)/$this-&gt;k), $headerlmargin +$headerpgwidth, $this-&gt;y-($maxfontheight*($this-&gt;footer_line_spacing)/$this-&gt;k));
<a name="l09318"></a>09318   }
<a name="l09319"></a>09319   <span class="keywordflow">if</span> ($this-&gt;forcePortraitHeaders &amp;&amp; $this-&gt;CurOrientation==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;CurOrientation!=$this-&gt;DefOrientation) {
<a name="l09320"></a>09320     $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l09321"></a>09321   }
<a name="l09322"></a>09322   }
<a name="l09323"></a>09323   $this-&gt;processingHeader=<span class="keyword">false</span>;
<a name="l09324"></a>09324 
<a name="l09325"></a>09325 }
<a name="l09326"></a>09326 
<a name="l09327"></a>09327 
<a name="l09328"></a>09328 
<a name="l09329"></a>09329 
<a name="l09333"></a><a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020">09333</a> function <a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html,$sub=0,$init=<span class="keyword">true</span>,$close=<span class="keyword">true</span>) {
<a name="l09334"></a>09334         <span class="comment">// $sub ADDED - 0 = default; 1=headerCSS only; 2=HTML body (parts) only; 3 - HTML parses only</span>
<a name="l09335"></a>09335         <span class="comment">// 4 - writes HTML headers</span>
<a name="l09336"></a>09336         <span class="comment">// $close Leaves buffers etc. in current state, so that it can continue a block etc.</span>
<a name="l09337"></a>09337         <span class="comment">// $init - Clears and sets buffers to Top level block etc.</span>
<a name="l09338"></a>09338 
<a name="l09339"></a>09339   <span class="comment">// mPDF 4.2.018</span>
<a name="l09340"></a>09340   <span class="keywordflow">if</span> ($this-&gt;PDFA) {  <span class="comment">// default font may be set as core when win-1252 and PDFA not set until runtime</span>
<a name="l09341"></a>09341     reset($this-&gt;fonts);
<a name="l09342"></a>09342     $df = key($this-&gt;fonts);
<a name="l09343"></a>09343     <span class="keywordflow">if</span> ($df==<span class="stringliteral">&#39;times&#39;</span> || $df == <span class="stringliteral">&#39;helvetica&#39;</span> || $df == <span class="stringliteral">&#39;courier&#39;</span>) { 
<a name="l09344"></a>09344       unset($this-&gt;fonts[$df]); 
<a name="l09345"></a>09345     }
<a name="l09346"></a>09346   }
<a name="l09347"></a>09347 
<a name="l09348"></a>09348   <span class="comment">// mPDF 4.2</span>
<a name="l09349"></a>09349   <span class="keywordflow">if</span> (empty($html)) { $html = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l09350"></a>09350 
<a name="l09351"></a>09351   <span class="keywordflow">if</span> ($init) {
<a name="l09352"></a>09352     $this-&gt;headerbuffer=<span class="stringliteral">&#39;&#39;</span>;
<a name="l09353"></a>09353     $this-&gt;textbuffer = array();
<a name="l09354"></a>09354     <span class="comment">// mPDF 4.0 Fixed Pos block</span>
<a name="l09355"></a>09355     $this-&gt;fixedPosBlockSave = array();
<a name="l09356"></a>09356   }
<a name="l09357"></a>09357 
<a name="l09358"></a>09358   <span class="keywordflow">if</span> ($sub == 1) { $html = <span class="stringliteral">&#39;&lt;style&gt; &#39;</span>.$html.<span class="stringliteral">&#39; &lt;/style&gt;&#39;</span>; }  <span class="comment">// stylesheet only</span>
<a name="l09359"></a>09359 
<a name="l09360"></a>09360   <span class="keywordflow">if</span> ($this-&gt;allow_charset_conversion) {
<a name="l09361"></a>09361     <span class="keywordflow">if</span> ($sub &lt; 1) { 
<a name="l09362"></a>09362       $this-&gt;ReadCharset($html); 
<a name="l09363"></a>09363     }
<a name="l09364"></a>09364     <span class="keywordflow">if</span> ($this-&gt;charset_in) { 
<a name="l09365"></a>09365       $success = iconv($this-&gt;charset_in,<span class="stringliteral">&#39;UTF-8//TRANSLIT&#39;</span>,$html); 
<a name="l09366"></a>09366       <span class="keywordflow">if</span> ($success) { $html = $success; }
<a name="l09367"></a>09367     }
<a name="l09368"></a>09368   }
<a name="l09369"></a>09369 
<a name="l09370"></a>09370   $html = $this-&gt;purify_utf8($html,<span class="keyword">false</span>);
<a name="l09371"></a>09371   <span class="keywordflow">if</span> ($init) {
<a name="l09372"></a>09372     $this-&gt;blklvl = 0;
<a name="l09373"></a>09373     $this-&gt;lastblocklevelchange = 0;
<a name="l09374"></a>09374     $this-&gt;blk = array();
<a name="l09375"></a>09375     <span class="comment">// mPDF 4.0</span>
<a name="l09376"></a>09376     $this-&gt;initialiseBlock($this-&gt;blk[0]);
<a name="l09377"></a>09377     $this-&gt;blk[0][<span class="stringliteral">&#39;width&#39;</span>] =&amp; $this-&gt;pgwidth;
<a name="l09378"></a>09378     $this-&gt;blk[0][<span class="stringliteral">&#39;inner_width&#39;</span>] =&amp; $this-&gt;pgwidth;
<a name="l09379"></a>09379     <span class="comment">// mPDF 3.0</span>
<a name="l09380"></a>09380     $this-&gt;blk[0][<span class="stringliteral">&#39;blockContext&#39;</span>] = $this-&gt;blockContext;
<a name="l09381"></a>09381   }
<a name="l09382"></a>09382 
<a name="l09383"></a>09383   <span class="keywordflow">if</span> ($sub &lt; 2) { 
<a name="l09384"></a>09384     $this-&gt;ReadMetaTags($html); 
<a name="l09385"></a>09385 
<a name="l09386"></a>09386     <span class="comment">// NB default stylesheet now in mPDF.css - read on initialising class</span>
<a name="l09387"></a>09387     $html = $this-&gt;ReadCSS($html); 
<a name="l09388"></a>09388   }
<a name="l09389"></a>09389 
<a name="l09390"></a>09390   <span class="comment">// SET Blocklevel[0] CSS if defined in &lt;body&gt; or from default</span>
<a name="l09391"></a>09391   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>,<span class="stringliteral">&#39;&#39;</span>);
<a name="l09392"></a>09392 
<a name="l09393"></a>09393   <span class="keywordflow">if</span> ($sub == 1) { $this-&gt;setCSS($properties,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>); <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; }
<a name="l09394"></a>09394 
<a name="l09395"></a>09395   <span class="keywordflow">if</span> ($sub &lt; 2) { 
<a name="l09396"></a>09396     <span class="keywordflow">if</span> ($this-&gt;useLang &amp;&amp; $this-&gt;is_MB &amp;&amp; preg_match(<span class="stringliteral">&#39;/&lt;html [^&gt;]*lang=[\&#39;\&quot;](.*?)[\&#39;\&quot;]/ism&#39;</span>,$html,$m)) { 
<a name="l09397"></a>09397       $html_lang = $m[1]; 
<a name="l09398"></a>09398     }
<a name="l09399"></a>09399 
<a name="l09400"></a>09400     <span class="comment">// allow in-line CSS for body tag to be parsed // Get &lt;body&gt; tag inline CSS</span>
<a name="l09401"></a>09401     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/&lt;body([^&gt;]*)&gt;(.*?)&lt;\/body&gt;/ism&#39;</span>,$html,$m) || preg_match(<span class="stringliteral">&#39;/&lt;body([^&gt;]*)&gt;(.*)$/ism&#39;</span>,$html,$m)) { 
<a name="l09402"></a>09402       $html = $m[2]; 
<a name="l09403"></a>09403       <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l09404"></a>09404       <span class="comment">// Changed to allow style=&quot;background: url(&#39;bg.jpg&#39;)&quot;</span>
<a name="l09405"></a>09405       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/style=[\&quot;](.*?)[\&quot;]/ism&#39;</span>,$m[1],$mm) || preg_match(<span class="stringliteral">&#39;/style=[\&#39;](.*?)[\&#39;]/ism&#39;</span>,$m[1],$mm)) { 
<a name="l09406"></a>09406         $zproperties = $this-&gt;readInlineCSS($mm[1]); 
<a name="l09407"></a>09407         $properties = $this-&gt;array_merge_recursive_unique($properties,$zproperties); 
<a name="l09408"></a>09408       }
<a name="l09409"></a>09409       <span class="keywordflow">if</span> (isset($html_lang) &amp;&amp; $html_lang) { $properties[<span class="stringliteral">&#39;LANG&#39;</span>] = $html_lang; }
<a name="l09410"></a>09410       <span class="keywordflow">if</span> ($this-&gt;useLang &amp;&amp; $this-&gt;is_MB &amp;&amp; preg_match(<span class="stringliteral">&#39;/lang=[\&#39;\&quot;](.*?)[\&#39;\&quot;]/ism&#39;</span>,$m[1],$mm)) { 
<a name="l09411"></a>09411         $properties[<span class="stringliteral">&#39;LANG&#39;</span>] = $mm[1]; 
<a name="l09412"></a>09412       }
<a name="l09413"></a>09413     }
<a name="l09414"></a>09414   }
<a name="l09415"></a>09415   $this-&gt;setCSS($properties,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>); 
<a name="l09416"></a>09416   <span class="keywordflow">if</span> (!isset($this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>])) { $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>] = array(); }
<a name="l09417"></a>09417 
<a name="l09418"></a>09418   <span class="comment">// mPDF 4.0 Not required(?) and messing up text-align for RTL</span>
<a name="l09419"></a>09419 <span class="comment">//  $this-&gt;CSS[&#39;BODY&#39;] = $this-&gt;array_merge_recursive_unique($this-&gt;CSS[&#39;BODY&#39;], $properties); </span>
<a name="l09420"></a>09420 
<a name="l09421"></a>09421   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) {    <span class="comment">// mPDF 4.3.011</span>
<a name="l09422"></a>09422     $file = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>];
<a name="l09423"></a>09423     $sizesarray = $this-&gt;Image($file,0,0,0,0,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);  <span class="comment">// mPDF 4.2.032</span>
<a name="l09424"></a>09424     <span class="keywordflow">if</span> (isset($sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>])) {
<a name="l09425"></a>09425       $image_id = $sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>];
<a name="l09426"></a>09426       $orig_w = $sizesarray[<span class="stringliteral">&#39;WIDTH&#39;</span>]*$this-&gt;k;    <span class="comment">// in user units i.e. mm</span>
<a name="l09427"></a>09427       $orig_h = $sizesarray[<span class="stringliteral">&#39;HEIGHT&#39;</span>]*$this-&gt;k;   <span class="comment">// (using $this-&gt;img_dpi)</span>
<a name="l09428"></a>09428       $x_repeat = <span class="keyword">true</span>;
<a name="l09429"></a>09429       $y_repeat = <span class="keyword">true</span>;
<a name="l09430"></a>09430       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>])) {
<a name="l09431"></a>09431         <span class="keywordflow">if</span> ($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-x&#39;</span>) { $y_repeat = <span class="keyword">false</span>; }
<a name="l09432"></a>09432         <span class="keywordflow">if</span> ($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-y&#39;</span>) { $x_repeat = <span class="keyword">false</span>; }
<a name="l09433"></a>09433       }
<a name="l09434"></a>09434       $x_pos = 0;
<a name="l09435"></a>09435       $y_pos = 0;
<a name="l09436"></a>09436       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>])) { 
<a name="l09437"></a>09437         $ppos = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$properties[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]);
<a name="l09438"></a>09438         $x_pos = $ppos[0];
<a name="l09439"></a>09439         $y_pos = $ppos[1];
<a name="l09440"></a>09440         <span class="keywordflow">if</span> (!stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $x_pos = $this-&gt;ConvertSize($x_pos ,$this-&gt;pgwidth,$this-&gt;FontSize); }
<a name="l09441"></a>09441         <span class="keywordflow">if</span> (!stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $y_pos = $this-&gt;ConvertSize($y_pos ,$this-&gt;pgwidth,$this-&gt;FontSize); }
<a name="l09442"></a>09442       }
<a name="l09443"></a>09443       <span class="comment">// mPDF 4.3.015</span>
<a name="l09444"></a>09444       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>])) { $resize = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>]; }
<a name="l09445"></a>09445       <span class="keywordflow">else</span> { $resize = 0; }
<a name="l09446"></a>09446       <span class="comment">// mPDF 4.3.017</span>
<a name="l09447"></a>09447       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>])) { $opacity = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>]; }
<a name="l09448"></a>09448       <span class="keywordflow">else</span> { $opacity = 1; }
<a name="l09449"></a>09449       $this-&gt;bodyBackgroundImage = array(<span class="stringliteral">&#39;image_id&#39;</span>=&gt;$image_id, <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$x_pos, <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$y_pos, <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat, <span class="stringliteral">&#39;resize&#39;</span>=&gt;$resize, <span class="stringliteral">&#39;opacity&#39;</span>=&gt;$opacity);  <span class="comment">// mPDF 4.3.015  4.3.017</span>
<a name="l09450"></a>09450     }
<a name="l09451"></a>09451   }
<a name="l09452"></a>09452   <span class="comment">// mPDF 4.2</span>
<a name="l09453"></a>09453   <span class="comment">// If page-box is set</span>
<a name="l09454"></a>09454   <span class="keywordflow">if</span> ($this-&gt;state==0 &amp;&amp; $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&#39;</span>]) {
<a name="l09455"></a>09455     $this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l09456"></a>09456     $this-&gt;page_box[<span class="stringliteral">&#39;using&#39;</span>] = <span class="keyword">true</span>;
<a name="l09457"></a>09457     <span class="comment">// mPDF 4.2</span>
<a name="l09458"></a>09458     list($pborientation,$pbmgl,$pbmgr,$pbmgt,$pbmgb,$pbmgh,$pbmgf,$hname,$fname,$bg,$resetpagenum,$pagenumstyle,$suppress,$marks,$newformat) = $this-&gt;SetPagedMediaCSS(<span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="charliteral">&#39;O&#39;</span>);
<a name="l09459"></a>09459     $this-&gt;DefOrientation = $this-&gt;CurOrientation = $pborientation; 
<a name="l09460"></a>09460     $this-&gt;orig_lMargin = $this-&gt;DeflMargin = $pbmgl; 
<a name="l09461"></a>09461     $this-&gt;orig_rMargin = $this-&gt;DefrMargin = $pbmgr; 
<a name="l09462"></a>09462     $this-&gt;orig_tMargin = $this-&gt;tMargin = $pbmgt;
<a name="l09463"></a>09463     $this-&gt;orig_bMargin = $this-&gt;bMargin = $pbmgb;
<a name="l09464"></a>09464     $this-&gt;orig_hMargin = $this-&gt;margin_header = $pbmgh;
<a name="l09465"></a>09465     $this-&gt;orig_fMargin = $this-&gt;margin_footer = $pbmgf;
<a name="l09466"></a>09466     list($pborientation,$pbmgl,$pbmgr,$pbmgt,$pbmgb,$pbmgh,$pbmgf,$hname,$fname,$bg,$resetpagenum,$pagenumstyle,$suppress,$marks,$newformat) = $this-&gt;SetPagedMediaCSS(<span class="stringliteral">&#39;&#39;</span>, <span class="keyword">true</span>, <span class="charliteral">&#39;O&#39;</span>);  <span class="comment">// first page</span>
<a name="l09467"></a>09467     $this-&gt;show_marks = $marks;
<a name="l09468"></a>09468     <span class="keywordflow">if</span> ($hname &amp;&amp; !preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$hname)) $this-&gt;firstPageBoxHeader = $hname;
<a name="l09469"></a>09469     <span class="keywordflow">if</span> ($fname &amp;&amp; !preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$fname)) $this-&gt;firstPageBoxFooter = $fname;
<a name="l09470"></a>09470   }
<a name="l09471"></a>09471 
<a name="l09472"></a>09472 
<a name="l09473"></a>09473   <span class="keywordflow">if</span>($this-&gt;state==0 &amp;&amp; $sub!=1 &amp;&amp; $sub!=3 &amp;&amp; $sub!=4) {
<a name="l09474"></a>09474     $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l09475"></a>09475   }
<a name="l09476"></a>09476 
<a name="l09477"></a>09477   $parseonly = <span class="keyword">false</span>; 
<a name="l09478"></a>09478   $this-&gt;bufferoutput = <span class="keyword">false</span>; 
<a name="l09479"></a>09479   <span class="keywordflow">if</span> ($sub == 3) { 
<a name="l09480"></a>09480     $parseonly = <span class="keyword">true</span>; 
<a name="l09481"></a>09481     <span class="comment">// Close any open block tags</span>
<a name="l09482"></a>09482     <span class="keywordflow">for</span> ($b= $this-&gt;blklvl;$b&gt;0;$b--) { $this-&gt;CloseTag($this-&gt;blk[$b][<span class="stringliteral">&#39;tag&#39;</span>]); }
<a name="l09483"></a>09483     <span class="comment">// Output any text left in buffer</span>
<a name="l09484"></a>09484     <span class="keywordflow">if</span> (count($this-&gt;textbuffer)) { $this-&gt;printbuffer($this-&gt;textbuffer); }
<a name="l09485"></a>09485     $this-&gt;textbuffer=array();
<a name="l09486"></a>09486   } 
<a name="l09487"></a>09487   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($sub == 4) { 
<a name="l09488"></a>09488     <span class="comment">// Close any open block tags</span>
<a name="l09489"></a>09489     <span class="keywordflow">for</span> ($b= $this-&gt;blklvl;$b&gt;0;$b--) { $this-&gt;CloseTag($this-&gt;blk[$b][<span class="stringliteral">&#39;tag&#39;</span>]); }
<a name="l09490"></a>09490     <span class="comment">// Output any text left in buffer</span>
<a name="l09491"></a>09491     <span class="keywordflow">if</span> (count($this-&gt;textbuffer)) { $this-&gt;printbuffer($this-&gt;textbuffer); }
<a name="l09492"></a>09492     $this-&gt;bufferoutput = <span class="keyword">true</span>; 
<a name="l09493"></a>09493     $this-&gt;textbuffer=array();
<a name="l09494"></a>09494     $this-&gt;headerbuffer=<span class="stringliteral">&#39;&#39;</span>;
<a name="l09495"></a>09495     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>,<span class="stringliteral">&#39;&#39;</span>);
<a name="l09496"></a>09496     $this-&gt;setCSS($properties,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>); 
<a name="l09497"></a>09497   } 
<a name="l09498"></a>09498 
<a name="l09499"></a>09499   mb_internal_encoding(<span class="stringliteral">&#39;UTF-8&#39;</span>); 
<a name="l09500"></a>09500 
<a name="l09501"></a>09501   $html = $this-&gt;AdjustHTML($html,$this-&gt;directionality,$this-&gt;usepre, $this-&gt;tabSpaces); <span class="comment">//Try to make HTML look more like XHTML</span>
<a name="l09502"></a>09502 
<a name="l09503"></a>09503   <span class="keywordflow">if</span> ($this-&gt;autoFontGroups) { $html = $this-&gt;AutoFont($html); }
<a name="l09504"></a>09504 
<a name="l09505"></a>09505   preg_match_all(<span class="stringliteral">&#39;/&lt;htmlpageheader([^&gt;]*)&gt;(.*?)&lt;\/htmlpageheader&gt;/si&#39;</span>,$html,$h);
<a name="l09506"></a>09506   <span class="keywordflow">for</span>($i=0;$i&lt;count($h[1]);$i++) {
<a name="l09507"></a>09507     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/name=[\&#39;|\&quot;](.*?)[\&#39;|\&quot;]/&#39;</span>,$h[1][$i],$n)) {
<a name="l09508"></a>09508       <span class="comment">// mPDF 4.0</span>
<a name="l09509"></a>09509       $this-&gt;pageHTMLheaders[$n[1]][<span class="stringliteral">&#39;html&#39;</span>] = $h[2][$i]; 
<a name="l09510"></a>09510       $this-&gt;pageHTMLheaders[$n[1]][<span class="charliteral">&#39;h&#39;</span>] = $this-&gt;_gethtmlheight($h[2][$i]); 
<a name="l09511"></a>09511     }
<a name="l09512"></a>09512   }
<a name="l09513"></a>09513   preg_match_all(<span class="stringliteral">&#39;/&lt;htmlpagefooter([^&gt;]*)&gt;(.*?)&lt;\/htmlpagefooter&gt;/si&#39;</span>,$html,$f);
<a name="l09514"></a>09514   <span class="keywordflow">for</span>($i=0;$i&lt;count($f[1]);$i++) {
<a name="l09515"></a>09515     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/name=[\&#39;|\&quot;](.*?)[\&#39;|\&quot;]/&#39;</span>,$f[1][$i],$n)) {
<a name="l09516"></a>09516       <span class="comment">// mPDF 4.0</span>
<a name="l09517"></a>09517       $this-&gt;pageHTMLfooters[$n[1]][<span class="stringliteral">&#39;html&#39;</span>] = $f[2][$i]; 
<a name="l09518"></a>09518       $this-&gt;pageHTMLfooters[$n[1]][<span class="charliteral">&#39;h&#39;</span>] = $this-&gt;_gethtmlheight($f[2][$i]); 
<a name="l09519"></a>09519     }
<a name="l09520"></a>09520   }
<a name="l09521"></a>09521   $html = preg_replace(<span class="stringliteral">&#39;/&lt;htmlpageheader.*?&lt;\/htmlpageheader&gt;/si&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html);
<a name="l09522"></a>09522   $html = preg_replace(<span class="stringliteral">&#39;/&lt;htmlpagefooter.*?&lt;\/htmlpagefooter&gt;/si&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html);
<a name="l09523"></a>09523 
<a name="l09524"></a>09524 
<a name="l09525"></a>09525   <span class="comment">// mPDF 4.2</span>
<a name="l09526"></a>09526   <span class="keywordflow">if</span> (isset($hname) &amp;&amp; preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$hname,$n)) $this-&gt;SetHTMLHeader($this-&gt;pageHTMLheaders[$n[1]],<span class="charliteral">&#39;O&#39;</span>,<span class="keyword">true</span>);
<a name="l09527"></a>09527   <span class="keywordflow">if</span> (isset($fname) &amp;&amp; preg_match(<span class="stringliteral">&#39;/^html_(.*)$/i&#39;</span>,$fname,$n)) $this-&gt;SetHTMLFooter($this-&gt;pageHTMLfooters[$n[1]],<span class="charliteral">&#39;O&#39;</span>);
<a name="l09528"></a>09528 
<a name="l09529"></a>09529 
<a name="l09530"></a>09530   $html=str_replace(<span class="stringliteral">&#39;&lt;?&#39;</span>,<span class="stringliteral">&#39;&lt; &#39;</span>,$html); <span class="comment">//Fix &#39;&lt;?XML&#39; bug from HTML code generated by MS Word</span>
<a name="l09531"></a>09531   $html = $this-&gt;SubstituteChars($html);
<a name="l09532"></a>09532 
<a name="l09533"></a>09533   <span class="comment">// mPDF 4.0</span>
<a name="l09534"></a>09534 
<a name="l09535"></a>09535   <span class="comment">// Don&#39;t allow non-breaking spaces that are converted to substituted chars or will break anyway and mess up table width calc.</span>
<a name="l09536"></a>09536   $html = str_replace(<span class="stringliteral">&#39;&lt;tta&gt;160&lt;/tta&gt;&#39;</span>,$this-&gt;chrs[32],$html); 
<a name="l09537"></a>09537   $html = str_replace(<span class="stringliteral">&#39;&lt;/tta&gt;&lt;tta&gt;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,$html); 
<a name="l09538"></a>09538   $html = str_replace(<span class="stringliteral">&#39;&lt;/tts&gt;&lt;tts&gt;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,$html); 
<a name="l09539"></a>09539   $html = str_replace(<span class="stringliteral">&#39;&lt;/ttz&gt;&lt;ttz&gt;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,$html); 
<a name="l09540"></a>09540 
<a name="l09541"></a>09541   <span class="comment">//Add new supported tags in the DisableTags function</span>
<a name="l09542"></a>09542   $html=strip_tags($html,$this-&gt;enabledtags); <span class="comment">//remove all unsupported tags, but the ones inside the &#39;enabledtags&#39; string</span>
<a name="l09543"></a>09543 
<a name="l09544"></a>09544   <span class="comment">//Explode the string in order to parse the HTML code</span>
<a name="l09545"></a>09545   $a=preg_split(<span class="stringliteral">&#39;/&lt;(.*?)&gt;/ms&#39;</span>,$html,-1,PREG_SPLIT_DELIM_CAPTURE);
<a name="l09546"></a>09546   <span class="comment">// ? more accurate regexp that allows e.g. &lt;a name=&quot;Silly &lt;name&gt;&quot;&gt;</span>
<a name="l09547"></a>09547   <span class="comment">// if changing - also change in fn.SubstituteChars()</span>
<a name="l09548"></a>09548   <span class="comment">// $a = preg_split (&#39;/&lt;((?:[^&lt;&gt;]+(?:&quot;[^&quot;]*&quot;|\&#39;[^\&#39;]*\&#39;)?)+)&gt;/ms&#39;, $html, -1, PREG_SPLIT_DELIM_CAPTURE);</span>
<a name="l09549"></a>09549 
<a name="l09550"></a>09550   <span class="keywordflow">if</span> ($this-&gt;mb_enc) { 
<a name="l09551"></a>09551     mb_internal_encoding($this-&gt;mb_enc); 
<a name="l09552"></a>09552   }
<a name="l09553"></a>09553 
<a name="l09554"></a>09554   $this-&gt;subPos = 0;
<a name="l09555"></a>09555   $cnt = count($a); <span class="comment">// mPDF 4.2</span>
<a name="l09556"></a>09556   <span class="keywordflow">for</span>($i=0;$i&lt;$cnt; $i++) { <span class="comment">// mPDF 4.2</span>
<a name="l09557"></a>09557     $e = $a[$i];
<a name="l09558"></a>09558     <span class="keywordflow">if</span>($i%2==0) {
<a name="l09559"></a>09559     <span class="comment">//TEXT</span>
<a name="l09560"></a>09560       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;hide&#39;</span>]) { <span class="keywordflow">continue</span>; }
<a name="l09561"></a>09561 
<a name="l09562"></a>09562       <span class="comment">// mPDF 4.0</span>
<a name="l09563"></a>09563       <span class="keywordflow">if</span> ($this-&gt;inFixedPosBlock) { $this-&gt;fixedPosBlock .= $e; <span class="keywordflow">continue</span>; } <span class="comment">// *CSS-POSITION*</span>
<a name="l09564"></a>09564       <span class="keywordflow">if</span> (strlen($e) == 0) { <span class="keywordflow">continue</span>; }
<a name="l09565"></a>09565 
<a name="l09566"></a>09566       $e = strcode2utf($e); 
<a name="l09567"></a>09567       $e = $this-&gt;lesser_entity_decode($e);
<a name="l09568"></a>09568 
<a name="l09569"></a>09569       <span class="comment">// mPDF 4.2</span>
<a name="l09570"></a>09570       <span class="comment">// mPDF 4.3.004 Not specialcontent (textarea / select)</span>
<a name="l09571"></a>09571       <span class="keywordflow">if</span> ($this-&gt;useSubstitutionsMB &amp;&amp; $this-&gt;is_MB &amp;&amp; !$this-&gt;isCJK &amp;&amp; !$this-&gt;usingCoreFont &amp;&amp; $this-&gt;subPos&lt;$i &amp;&amp; !$this-&gt;specialcontent) { 
<a name="l09572"></a>09572         $cnt += $this-&gt;SubstituteCharsMB($a, $i, $e); 
<a name="l09573"></a>09573       }
<a name="l09574"></a>09574 
<a name="l09575"></a>09575         <span class="comment">// mPDF 4.0 Removed rtlAsArabicFarsi</span>
<a name="l09576"></a>09576 
<a name="l09577"></a>09577       <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l09578"></a>09578 
<a name="l09579"></a>09579       <span class="comment">// CONVERT CODEPAGE</span>
<a name="l09580"></a>09580       <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $e = mb_convert_encoding($e,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l09581"></a>09581       <span class="keywordflow">if</span> (($this-&gt;is_MB &amp;&amp; !$this-&gt;isCJK) &amp;&amp; (!$this-&gt;usingCoreFont)) {
<a name="l09582"></a>09582         <span class="keywordflow">if</span> ($this-&gt;toupper) { $e = mb_strtoupper($e,$this-&gt;mb_enc); }
<a name="l09583"></a>09583         <span class="keywordflow">if</span> ($this-&gt;tolower) { $e = mb_strtolower($e,$this-&gt;mb_enc); }
<a name="l09584"></a>09584       }
<a name="l09585"></a>09585       <span class="keywordflow">else</span>
<a name="l09586"></a>09586       <span class="keywordflow">if</span> (!$this-&gt;isCJK) {
<a name="l09587"></a>09587         <span class="keywordflow">if</span> ($this-&gt;toupper) { $e = strtoupper($e); }
<a name="l09588"></a>09588         <span class="keywordflow">if</span> ($this-&gt;tolower) { $e = strtolower($e); }
<a name="l09589"></a>09589       }
<a name="l09590"></a>09590       <span class="keywordflow">if</span> (($this-&gt;tts) || ($this-&gt;ttz) || ($this-&gt;tta)) {
<a name="l09591"></a>09591         $es = explode(<span class="charliteral">&#39;|&#39;</span>,$e);
<a name="l09592"></a>09592         $e = <span class="stringliteral">&#39;&#39;</span>;
<a name="l09593"></a>09593         <span class="keywordflow">foreach</span>($es AS $val) {
<a name="l09594"></a>09594           $e .= $this-&gt;chrs[$val];
<a name="l09595"></a>09595         }
<a name="l09596"></a>09596       }
<a name="l09597"></a>09597       <span class="comment">//Adjust lineheight</span>
<a name="l09598"></a>09598           <span class="comment">//$this-&gt;SetLineHeight($this-&gt;FontSizePt); //should be inside printbuffer? // does nothing</span>
<a name="l09599"></a>09599 
<a name="l09600"></a>09600 
<a name="l09601"></a>09601       <span class="comment">// TABLE</span>
<a name="l09602"></a>09602       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l09603"></a>09603         <span class="keywordflow">if</span> ($this-&gt;tdbegin) {
<a name="l09604"></a>09604                <span class="keywordflow">if</span> (($this-&gt;ignorefollowingspaces) and !$this-&gt;ispre) { $e = ltrim($e); }
<a name="l09605"></a>09605            <span class="keywordflow">if</span> ($e || $e===<span class="charliteral">&#39;0&#39;</span>) {
<a name="l09606"></a>09606           <span class="comment">// mPDF 3.0</span>
<a name="l09607"></a>09607               <span class="keywordflow">if</span> (($this-&gt;blockjustfinished || $this-&gt;listjustfinished) &amp;&amp; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]&gt;0) {
<a name="l09608"></a>09608               $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array(<span class="stringliteral">&quot;\n&quot;</span>,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l09609"></a>09609               $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l09610"></a>09610             <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l09611"></a>09611               $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l09612"></a>09612             }
<a name="l09613"></a>09613             elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l09614"></a>09614               $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>];  
<a name="l09615"></a>09615             }
<a name="l09616"></a>09616             $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0;<span class="comment">// reset</span>
<a name="l09617"></a>09617               }
<a name="l09618"></a>09618           <span class="comment">// mPDF 3.0</span>
<a name="l09619"></a>09619           $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l09620"></a>09620           $this-&gt;listjustfinished=<span class="keyword">false</span>;
<a name="l09621"></a>09621 
<a name="l09622"></a>09622             $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l09623"></a>09623             $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = $e;
<a name="l09624"></a>09624                   <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;R&#39;</span>]) || !$this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;R&#39;</span>]) {
<a name="l09625"></a>09625             <span class="keywordflow">if</span> (isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>])) { 
<a name="l09626"></a>09626               $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] += $this-&gt;GetStringWidth($e); 
<a name="l09627"></a>09627             }
<a name="l09628"></a>09628             <span class="keywordflow">else</span> { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = $this-&gt;GetStringWidth($e); }
<a name="l09629"></a>09629           }
<a name="l09630"></a>09630           <span class="keywordflow">if</span> ($this-&gt;tableLevel==1 &amp;&amp; $this-&gt;useGraphs) { 
<a name="l09631"></a>09631             $this-&gt;graphs[$this-&gt;currentGraphId][<span class="stringliteral">&#39;data&#39;</span>][$this-&gt;row][$this-&gt;col] = $e;
<a name="l09632"></a>09632           }
<a name="l09633"></a>09633           $this-&gt;nestedtablejustfinished = <span class="keyword">false</span>;
<a name="l09634"></a>09634           <span class="comment">// mPDF 3.0</span>
<a name="l09635"></a>09635           $this-&gt;linebreakjustfinished=<span class="keyword">false</span>;
<a name="l09636"></a>09636            }
<a name="l09637"></a>09637         }
<a name="l09638"></a>09638       }
<a name="l09639"></a>09639       <span class="comment">// ALL ELSE</span>
<a name="l09640"></a>09640       <span class="keywordflow">else</span> {
<a name="l09641"></a>09641             <span class="keywordflow">if</span> ($this-&gt;ignorefollowingspaces and !$this-&gt;ispre) { $e = ltrim($e); }
<a name="l09642"></a>09642         <span class="keywordflow">if</span> ($e || $e===<span class="charliteral">&#39;0&#39;</span>) $this-&gt;textbuffer[] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l09643"></a>09643       }
<a name="l09644"></a>09644     }
<a name="l09645"></a>09645 
<a name="l09646"></a>09646 
<a name="l09647"></a>09647     <span class="keywordflow">else</span> { <span class="comment">// TAG **</span>
<a name="l09648"></a>09648        <span class="comment">// mPDF 4.0</span>
<a name="l09649"></a>09649        <span class="keywordflow">if</span>(substr($e,0,1)==<span class="charliteral">&#39;/&#39;</span>) { <span class="comment">// END TAG</span>
<a name="l09650"></a>09650 
<a name="l09651"></a>09651         <span class="comment">// Check for tags where HTML specifies optional end tags,</span>
<a name="l09652"></a>09652             <span class="comment">// and/or does not allow nesting e.g. P inside P, or </span>
<a name="l09653"></a>09653         $endtag = strtoupper(substr($e,1));
<a name="l09654"></a>09654       <span class="comment">// mPDF 4.0</span>
<a name="l09655"></a>09655         <span class="keywordflow">if</span>($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;hide&#39;</span>]) { 
<a name="l09656"></a>09656       <span class="keywordflow">if</span> (in_array($endtag, $this-&gt;outerblocktags) || in_array($endtag, $this-&gt;innerblocktags)) { 
<a name="l09657"></a>09657         unset($this-&gt;blk[$this-&gt;blklvl]);
<a name="l09658"></a>09658         $this-&gt;blklvl--; 
<a name="l09659"></a>09659       }
<a name="l09660"></a>09660       <span class="keywordflow">continue</span>; 
<a name="l09661"></a>09661         }
<a name="l09662"></a>09662 
<a name="l09663"></a>09663         <span class="keywordflow">if</span> ($this-&gt;inFixedPosBlock) { 
<a name="l09664"></a>09664       <span class="keywordflow">if</span> (in_array($endtag, $this-&gt;outerblocktags) || in_array($endtag, $this-&gt;innerblocktags)) { $this-&gt;fixedPosBlockDepth--; }
<a name="l09665"></a>09665       <span class="keywordflow">if</span> ($this-&gt;fixedPosBlockDepth == 0) { 
<a name="l09666"></a>09666         $this-&gt;fixedPosBlockSave[] = array($this-&gt;fixedPosBlock, $this-&gt;fixedPosBlockBBox, $this-&gt;page);
<a name="l09667"></a>09667         $this-&gt;fixedPosBlock = <span class="stringliteral">&#39;&#39;</span>;
<a name="l09668"></a>09668         $this-&gt;inFixedPosBlock = <span class="keyword">false</span>;
<a name="l09669"></a>09669         <span class="keywordflow">continue</span>; 
<a name="l09670"></a>09670       }
<a name="l09671"></a>09671       $this-&gt;fixedPosBlock .= <span class="charliteral">&#39;&lt;&#39;</span>.$e.<span class="charliteral">&#39;&gt;&#39;</span>; 
<a name="l09672"></a>09672       <span class="keywordflow">continue</span>; 
<a name="l09673"></a>09673         }
<a name="l09674"></a>09674         <span class="keywordflow">if</span> ($this-&gt;allow_html_optional_endtags &amp;&amp; !$parseonly) {
<a name="l09675"></a>09675       <span class="keywordflow">if</span> (($endtag == <span class="stringliteral">&#39;DIV&#39;</span> || $endtag ==<span class="stringliteral">&#39;FORM&#39;</span> || $endtag ==<span class="stringliteral">&#39;CENTER&#39;</span>) &amp;&amp; $this-&gt;lastoptionaltag == <span class="charliteral">&#39;P&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09676"></a>09676       <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;LI&#39;</span> &amp;&amp; $endtag == <span class="stringliteral">&#39;OL&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09677"></a>09677       <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;LI&#39;</span> &amp;&amp; $endtag == <span class="stringliteral">&#39;UL&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09678"></a>09678       <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;DD&#39;</span> &amp;&amp; $endtag == <span class="stringliteral">&#39;DL&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09679"></a>09679       <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;DT&#39;</span> &amp;&amp; $endtag == <span class="stringliteral">&#39;DL&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09680"></a>09680       <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;OPTION&#39;</span> &amp;&amp; $endtag == <span class="stringliteral">&#39;SELECT&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09681"></a>09681       <span class="keywordflow">if</span> ($endtag == <span class="stringliteral">&#39;TABLE&#39;</span>) {
<a name="l09682"></a>09682         <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;THEAD&#39;</span> || $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TBODY&#39;</span> || $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TFOOT&#39;</span>) { 
<a name="l09683"></a>09683           $this-&gt;CloseTag($this-&gt;lastoptionaltag);
<a name="l09684"></a>09684         }
<a name="l09685"></a>09685         <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TR&#39;</span>) { $this-&gt;CloseTag(<span class="stringliteral">&#39;TR&#39;</span>); }
<a name="l09686"></a>09686         <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TD&#39;</span> || $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TH&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); $this-&gt;CloseTag(<span class="stringliteral">&#39;TR&#39;</span>); }
<a name="l09687"></a>09687       }
<a name="l09688"></a>09688       <span class="keywordflow">if</span> ($endtag == <span class="stringliteral">&#39;THEAD&#39;</span> || $endtag == <span class="stringliteral">&#39;TBODY&#39;</span> || $endtag == <span class="stringliteral">&#39;TFOOT&#39;</span>) { 
<a name="l09689"></a>09689         <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TR&#39;</span>) { $this-&gt;CloseTag(<span class="stringliteral">&#39;TR&#39;</span>); }
<a name="l09690"></a>09690         <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TD&#39;</span> || $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TH&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); $this-&gt;CloseTag(<span class="stringliteral">&#39;TR&#39;</span>); }
<a name="l09691"></a>09691       }
<a name="l09692"></a>09692       <span class="keywordflow">if</span> ($endtag == <span class="stringliteral">&#39;TR&#39;</span>) {
<a name="l09693"></a>09693         <span class="keywordflow">if</span> ($this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TD&#39;</span> || $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TH&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l09694"></a>09694       }
<a name="l09695"></a>09695         }
<a name="l09696"></a>09696         $this-&gt;CloseTag($endtag); 
<a name="l09697"></a>09697        }
<a name="l09698"></a>09698 
<a name="l09699"></a>09699        <span class="keywordflow">else</span> { <span class="comment">// OPENING TAG</span>
<a name="l09700"></a>09700       <span class="keywordflow">if</span>($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;hide&#39;</span>]) { 
<a name="l09701"></a>09701         <span class="keywordflow">if</span> (strpos($e,<span class="charliteral">&#39; &#39;</span>)) { $te = strtoupper(substr($e,0,strpos($e,<span class="charliteral">&#39; &#39;</span>))); }
<a name="l09702"></a>09702         <span class="keywordflow">else</span> { $te = strtoupper($e); } 
<a name="l09703"></a>09703         <span class="keywordflow">if</span> (in_array($te, $this-&gt;outerblocktags) || in_array($te, $this-&gt;innerblocktags)) { 
<a name="l09704"></a>09704           $this-&gt;blklvl++;  
<a name="l09705"></a>09705           $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;hide&#39;</span>]=<span class="keyword">true</span>;
<a name="l09706"></a>09706         }
<a name="l09707"></a>09707         <span class="keywordflow">continue</span>; 
<a name="l09708"></a>09708       }
<a name="l09709"></a>09709 
<a name="l09710"></a>09710       <span class="keywordflow">if</span> ($this-&gt;inFixedPosBlock) { 
<a name="l09711"></a>09711         <span class="keywordflow">if</span> (strpos($e,<span class="charliteral">&#39; &#39;</span>)) { $te = strtoupper(substr($e,0,strpos($e,<span class="charliteral">&#39; &#39;</span>))); }
<a name="l09712"></a>09712         <span class="keywordflow">else</span> { $te = strtoupper($e); } 
<a name="l09713"></a>09713         $this-&gt;fixedPosBlock .= <span class="charliteral">&#39;&lt;&#39;</span>.$e.<span class="charliteral">&#39;&gt;&#39;</span>; 
<a name="l09714"></a>09714         <span class="keywordflow">if</span> (in_array($te, $this-&gt;outerblocktags) || in_array($te, $this-&gt;innerblocktags)) { $this-&gt;fixedPosBlockDepth++; }
<a name="l09715"></a>09715         <span class="keywordflow">continue</span>; 
<a name="l09716"></a>09716       }
<a name="l09717"></a>09717       $regexp = <span class="stringliteral">&#39;|=\&#39;(.*?)\&#39;|s&#39;</span>; <span class="comment">// eliminate single quotes, if any</span>
<a name="l09718"></a>09718           $e = preg_replace($regexp,<span class="stringliteral">&quot;=\&quot;\$1\&quot;&quot;</span>,$e);
<a name="l09719"></a>09719       <span class="comment">// changes anykey=anyvalue to anykey=&quot;anyvalue&quot; (only do this inside tags)</span>
<a name="l09720"></a>09720       <span class="keywordflow">if</span> (substr($e,0,10)!=<span class="stringliteral">&#39;pageheader&#39;</span> &amp;&amp; substr($e,0,10)!=<span class="stringliteral">&#39;pagefooter&#39;</span>) {
<a name="l09721"></a>09721         $regexp = <span class="stringliteral">&#39;| (\\w+?)=([^\\s&gt;&quot;]+)|si&#39;</span>; 
<a name="l09722"></a>09722             $e = preg_replace($regexp,<span class="stringliteral">&quot; \$1=\&quot;\$2\&quot;&quot;</span>,$e);
<a name="l09723"></a>09723       }
<a name="l09724"></a>09724 
<a name="l09725"></a>09725           <span class="comment">//Fix path values, if needed</span>
<a name="l09726"></a>09726       $orig_srcpath = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// mPDF 4.2.029</span>
<a name="l09727"></a>09727       <span class="keywordflow">if</span> ((stristr($e,<span class="stringliteral">&quot;href=&quot;</span>) !== <span class="keyword">false</span>) or (stristr($e,<span class="stringliteral">&quot;src=&quot;</span>) !== <span class="keyword">false</span>) ) {
<a name="l09728"></a>09728         $regexp = <span class="stringliteral">&#39;/ (href|src)=&quot;(.*?)&quot;/i&#39;</span>;
<a name="l09729"></a>09729         preg_match($regexp,$e,$auxiliararray);
<a name="l09730"></a>09730         <span class="keywordflow">if</span> (isset($auxiliararray[2])) { $path = $auxiliararray[2]; }
<a name="l09731"></a>09731         <span class="keywordflow">else</span> { $path = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l09732"></a>09732         <span class="comment">// mPDF 4.2  Special case for img src=&quot;var:varname&quot; - leave unchanged</span>
<a name="l09733"></a>09733         <span class="comment">// mPDF 3.0</span>
<a name="l09734"></a>09734         <span class="keywordflow">if</span> (trim($path) != <span class="stringliteral">&#39;&#39;</span> &amp;&amp; !(stristr($e,<span class="stringliteral">&quot;src=&quot;</span>) !== <span class="keyword">false</span> &amp;&amp; substr($path,0,4)==<span class="stringliteral">&#39;var:&#39;</span>)) { 
<a name="l09735"></a>09735           $orig_srcpath = $path; <span class="comment">// mPDF 4.2.029</span>
<a name="l09736"></a>09736           $this-&gt;GetFullPath($path); <span class="comment">// mPDF 4.0</span>
<a name="l09737"></a>09737           $regexp = <span class="stringliteral">&#39;/ (href|src)=&quot;(.*?)&quot;/i&#39;</span>;
<a name="l09738"></a>09738           $e = preg_replace($regexp,<span class="stringliteral">&#39; \\1=&quot;&#39;</span>.$path.<span class="charliteral">&#39;&quot;&#39;</span>,$e);
<a name="l09739"></a>09739         }
<a name="l09740"></a>09740       }<span class="comment">//END of Fix path values</span>
<a name="l09741"></a>09741 
<a name="l09742"></a>09742 
<a name="l09743"></a>09743       <span class="comment">//Extract attributes</span>
<a name="l09744"></a>09744       $contents=array();
<a name="l09745"></a>09745       <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l09746"></a>09746       <span class="comment">// Changed to allow style=&quot;background: url(&#39;bg.jpg&#39;)&quot;</span>
<a name="l09747"></a>09747       preg_match_all(<span class="stringliteral">&#39;/\\S*=[&quot;][^&quot;]*[&quot;]/&#39;</span>,$e,$contents1);
<a name="l09748"></a>09748       preg_match_all(<span class="stringliteral">&#39;/\\S*=[\&#39;][^\&#39;]*[\&#39;]/&#39;</span>,$e,$contents2);
<a name="l09749"></a>09749       $contents = array_merge($contents1, $contents2);
<a name="l09750"></a>09750       preg_match(<span class="stringliteral">&#39;/\\S+/&#39;</span>,$e,$a2);
<a name="l09751"></a>09751       $tag=strtoupper($a2[0]);
<a name="l09752"></a>09752       $attr=array();
<a name="l09753"></a>09753       <span class="keywordflow">if</span> ($orig_srcpath) { $attr[<span class="stringliteral">&#39;ORIG_SRC&#39;</span>] = $orig_srcpath; } <span class="comment">// mPDF 4.2.029</span>
<a name="l09754"></a>09754       <span class="keywordflow">if</span> (!empty($contents)) {
<a name="l09755"></a>09755         <span class="keywordflow">foreach</span>($contents[0] as $v) {
<a name="l09756"></a>09756           <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l09757"></a>09757           <span class="comment">// Changed to allow style=&quot;background: url(&#39;bg.jpg&#39;)&quot;</span>
<a name="l09758"></a>09758           <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&#39;/^([^=]*)=[&quot;]?([^&quot;]*)[&quot;]?$/&#39;</span>,$v,$a3) || preg_match(<span class="stringliteral">&#39;/^([^=]*)=[\&#39;]?([^\&#39;]*)[\&#39;]?$/&#39;</span>,$v,$a3)) {
<a name="l09759"></a>09759             <span class="keywordflow">if</span> (strtoupper($a3[1])==<span class="stringliteral">&#39;ID&#39;</span> || strtoupper($a3[1])==<span class="stringliteral">&#39;CLASS&#39;</span>) {  <span class="comment">// 4.2.013 Omits STYLE</span>
<a name="l09760"></a>09760                 $attr[strtoupper($a3[1])]=trim(strtoupper($a3[2]));
<a name="l09761"></a>09761             }
<a name="l09762"></a>09762             <span class="comment">// includes header-style-right etc. used for &lt;pageheader&gt;</span>
<a name="l09763"></a>09763             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(HEADER|FOOTER)-STYLE/i&#39;</span>,$a3[1])) {
<a name="l09764"></a>09764                 $attr[strtoupper($a3[1])]=trim(strtoupper($a3[2]));
<a name="l09765"></a>09765             }
<a name="l09766"></a>09766             <span class="keywordflow">else</span> {
<a name="l09767"></a>09767                   $attr[strtoupper($a3[1])]=trim($a3[2]);
<a name="l09768"></a>09768             }
<a name="l09769"></a>09769               }
<a name="l09770"></a>09770           }
<a name="l09771"></a>09771       }
<a name="l09772"></a>09772       $this-&gt;OpenTag($tag,$attr);
<a name="l09773"></a>09773       <span class="comment">// mPDF 4.0 Fixed Pos block</span>
<a name="l09774"></a>09774       <span class="keywordflow">if</span> ($this-&gt;inFixedPosBlock) { 
<a name="l09775"></a>09775         $this-&gt;fixedPosBlockBBox = array($tag,$attr, $this-&gt;x, $this-&gt;y); 
<a name="l09776"></a>09776         $this-&gt;fixedPosBlock = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l09777"></a>09777         $this-&gt;fixedPosBlockDepth = 1; 
<a name="l09778"></a>09778       }
<a name="l09779"></a>09779        }
<a name="l09780"></a>09780 
<a name="l09781"></a>09781     } <span class="comment">// end TAG</span>
<a name="l09782"></a>09782   } <span class="comment">//end of  foreach($a as $i=&gt;$e)</span>
<a name="l09783"></a>09783 
<a name="l09784"></a>09784   <span class="keywordflow">if</span> ($close) {
<a name="l09785"></a>09785 
<a name="l09786"></a>09786     <span class="comment">// Close any open block tags</span>
<a name="l09787"></a>09787     <span class="keywordflow">for</span> ($b= $this-&gt;blklvl;$b&gt;0;$b--) { $this-&gt;CloseTag($this-&gt;blk[$b][<span class="stringliteral">&#39;tag&#39;</span>]); }
<a name="l09788"></a>09788 
<a name="l09789"></a>09789     <span class="comment">// Output any text left in buffer</span>
<a name="l09790"></a>09790     <span class="keywordflow">if</span> (count($this-&gt;textbuffer) &amp;&amp; !$parseonly) { $this-&gt;printbuffer($this-&gt;textbuffer); }
<a name="l09791"></a>09791     <span class="keywordflow">if</span> (!$parseonly) $this-&gt;textbuffer=array();
<a name="l09792"></a>09792 
<a name="l09793"></a>09793     <span class="comment">// If ended with a float, need to move to end page</span>
<a name="l09794"></a>09794     $currpos = $this-&gt;page*1000 + $this-&gt;y;
<a name="l09795"></a>09795     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>] &gt; $currpos) {
<a name="l09796"></a>09796       $old_page = $this-&gt;page;
<a name="l09797"></a>09797       $new_page = intval($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>] /1000);
<a name="l09798"></a>09798       <span class="keywordflow">if</span> ($old_page != $new_page) {
<a name="l09799"></a>09799         $s = $this-&gt;PrintPageBackgrounds();
<a name="l09800"></a>09800         <span class="comment">// Writes after the marker so not overwritten later by page background etc.</span>
<a name="l09801"></a>09801         $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l09802"></a>09802         $this-&gt;pageBackgrounds = array();
<a name="l09803"></a>09803         $this-&gt;page = $new_page;
<a name="l09804"></a>09804         $this-&gt;ResetMargins();
<a name="l09805"></a>09805         $this-&gt;Reset();
<a name="l09806"></a>09806         $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l09807"></a>09807       }
<a name="l09808"></a>09808       $this-&gt;y = (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>] *1000) % 1000000)/1000;  <span class="comment">// mod changes operands to integers before processing</span>
<a name="l09809"></a>09809     }
<a name="l09810"></a>09810 
<a name="l09811"></a>09811     $this-&gt;printfloatbuffer();
<a name="l09812"></a>09812 
<a name="l09813"></a>09813     <span class="comment">//Create Internal Links, if needed</span>
<a name="l09814"></a>09814     <span class="keywordflow">if</span> (!empty($this-&gt;internallink) ) {
<a name="l09815"></a>09815       <span class="keywordflow">foreach</span>($this-&gt;internallink as $k=&gt;$v) {
<a name="l09816"></a>09816         <span class="keywordflow">if</span> (strpos($k,<span class="stringliteral">&quot;#&quot;</span>) !== <span class="keyword">false</span> ) { <span class="keywordflow">continue</span>; } <span class="comment">//ignore</span>
<a name="l09817"></a>09817         $ypos = $v[<span class="charliteral">&#39;Y&#39;</span>];
<a name="l09818"></a>09818         $pagenum = $v[<span class="stringliteral">&#39;PAGE&#39;</span>];
<a name="l09819"></a>09819         $sharp = <span class="stringliteral">&quot;#&quot;</span>;
<a name="l09820"></a>09820         <span class="keywordflow">while</span> (array_key_exists($sharp.$k,$this-&gt;internallink)) {
<a name="l09821"></a>09821           $internallink = $this-&gt;internallink[$sharp.$k];
<a name="l09822"></a>09822           $this-&gt;SetLink($internallink,$ypos,$pagenum);
<a name="l09823"></a>09823           $sharp .= <span class="stringliteral">&quot;#&quot;</span>;
<a name="l09824"></a>09824         }
<a name="l09825"></a>09825       }
<a name="l09826"></a>09826     }
<a name="l09827"></a>09827 
<a name="l09828"></a>09828     $this-&gt;linemaxfontsize = <span class="stringliteral">&#39;&#39;</span>;
<a name="l09829"></a>09829     $this-&gt;lineheight_correction = $this-&gt;default_lineheight_correction;
<a name="l09830"></a>09830 
<a name="l09831"></a>09831     $this-&gt;bufferoutput = <span class="keyword">false</span>; 
<a name="l09832"></a>09832 
<a name="l09833"></a>09833     <span class="comment">// mPDF 4.0 Fixed Pos block</span>
<a name="l09834"></a>09834     <span class="keywordflow">if</span> (count($this-&gt;fixedPosBlockSave) &amp;&amp; $sub != 4) {
<a name="l09835"></a>09835       <span class="keywordflow">foreach</span>($this-&gt;fixedPosBlockSave AS $fpbs) {
<a name="l09836"></a>09836       $old_page = $this-&gt;page;
<a name="l09837"></a>09837       $this-&gt;page = $fpbs[2];
<a name="l09838"></a>09838       $this-&gt;WriteFixedPosHTML($fpbs[0], 0, 0, 100, 100,<span class="stringliteral">&#39;auto&#39;</span>, $fpbs[1]);  <span class="comment">// 0,0,10,10 are overwritten by bbox</span>
<a name="l09839"></a>09839       $this-&gt;page = $old_page;
<a name="l09840"></a>09840       }
<a name="l09841"></a>09841     }
<a name="l09842"></a>09842 
<a name="l09843"></a>09843   }
<a name="l09844"></a>09844 }
<a name="l09845"></a>09845 
<a name="l09846"></a>09846 <span class="comment">// mPDF 4.0</span>
<a name="l09847"></a>09847 function WriteFixedPosHTML($html=<span class="stringliteral">&#39;&#39;</span>,$x, $y, $w, $h, $overflow=<span class="stringliteral">&#39;visible&#39;</span>, $bounding=array()) {
<a name="l09848"></a>09848   <span class="comment">// $overflow can be &#39;hidden&#39;, &#39;visible&#39; or &#39;auto&#39; - &#39;auto&#39; causes autofit to size</span>
<a name="l09849"></a>09849   <span class="comment">// Annotations disabled</span>
<a name="l09850"></a>09850   <span class="comment">// Links do work</span>
<a name="l09851"></a>09851   <span class="comment">// Will always go on current page (or start Page 1 if required)</span>
<a name="l09852"></a>09852   <span class="comment">// Probably INCOMPATIBLE WITH keep with table, columns etc.</span>
<a name="l09853"></a>09853   <span class="comment">// Called externally or interally via &lt;div style=&quot;position: [fixed|absolute]&quot;&gt;</span>
<a name="l09854"></a>09854   <span class="comment">// When used internally, $x $y $w $h and $overflow are all overridden by $bounding</span>
<a name="l09855"></a>09855 
<a name="l09856"></a>09856   $overflow = strtolower($overflow);
<a name="l09857"></a>09857   <span class="keywordflow">if</span>($this-&gt;state==0) { 
<a name="l09858"></a>09858     $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l09859"></a>09859   }
<a name="l09860"></a>09860   $save_y = $this-&gt;y;
<a name="l09861"></a>09861   $save_x = $this-&gt;x;
<a name="l09862"></a>09862   <span class="comment">// mPDF 4.1   // Allows Image in fixedposdiv to be full height</span>
<a name="l09863"></a>09863   $this-&gt;fullImageHeight = $this-&gt;h;
<a name="l09864"></a>09864   $save_cols = <span class="keyword">false</span>;
<a name="l09865"></a>09865   $this-&gt;writingHTMLheader = <span class="keyword">true</span>;  <span class="comment">// a FIX to stop pagebreaks etc.</span>
<a name="l09866"></a>09866   $this-&gt;writingHTMLfooter = <span class="keyword">true</span>;
<a name="l09867"></a>09867   $this-&gt;InFooter = <span class="keyword">true</span>; <span class="comment">// suppresses autopagebreaks</span>
<a name="l09868"></a>09868   $save_bgs = $this-&gt;pageBackgrounds;
<a name="l09869"></a>09869   $checkinnerhtml = preg_replace(<span class="stringliteral">&#39;/\s/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html);  <span class="comment">// mPDF 4.2</span>
<a name="l09870"></a>09870 
<a name="l09871"></a>09871   <span class="keywordflow">if</span> ($w &gt; $this-&gt;w) { $x = 0; $w = $this-&gt;w; }
<a name="l09872"></a>09872   <span class="keywordflow">if</span> ($h &gt; $this-&gt;h) { $y = 0; $h = $this-&gt;h; }
<a name="l09873"></a>09873   <span class="keywordflow">if</span> ($x &gt; $this-&gt;w) { $x = $this-&gt;w - $w; }
<a name="l09874"></a>09874   <span class="keywordflow">if</span> ($y &gt; $this-&gt;h) { $y = $this-&gt;h - $h; }
<a name="l09875"></a>09875 
<a name="l09876"></a>09876   <span class="keywordflow">if</span> (!empty($bounding)) {  
<a name="l09877"></a>09877     <span class="comment">// $cont_ containing block = full physical page (position: absolute) or page inside margins (position: fixed)</span>
<a name="l09878"></a>09878     <span class="comment">// $bbox_ Bounding box is the &lt;div&gt; which is positioned absolutely/fixed </span>
<a name="l09879"></a>09879     <span class="comment">// top/left/right/bottom/width/height/background*/border*/padding*/margin* are taken from bounding</span>
<a name="l09880"></a>09880     <span class="comment">// font*[family/size/style/weight]/line-height/text*[align/decoration/transform/indent]/color are transferred to $inner</span>
<a name="l09881"></a>09881     <span class="comment">// as an enclosing &lt;div&gt; (after having checked ID/CLASS)</span>
<a name="l09882"></a>09882     <span class="comment">// $x, $y, $w, $h are inside of $bbox_ = containing box for $inner_</span>
<a name="l09883"></a>09883     <span class="comment">// $inner_ InnerHTML is the contents of that block to be output </span>
<a name="l09884"></a>09884     $tag = $bounding[0];
<a name="l09885"></a>09885     $attr = $bounding[1];
<a name="l09886"></a>09886 
<a name="l09887"></a>09887     $orig_x0 = $bounding[2];
<a name="l09888"></a>09888     $orig_y0 = $bounding[3];
<a name="l09889"></a>09889 
<a name="l09890"></a>09890     <span class="comment">// As in WriteHTML() initialising</span>
<a name="l09891"></a>09891     $this-&gt;blklvl = 0;
<a name="l09892"></a>09892     $this-&gt;lastblocklevelchange = 0;
<a name="l09893"></a>09893     $this-&gt;blk = array();
<a name="l09894"></a>09894     $this-&gt;initialiseBlock($this-&gt;blk[0]);
<a name="l09895"></a>09895 
<a name="l09896"></a>09896     $this-&gt;blk[0][<span class="stringliteral">&#39;width&#39;</span>] =&amp; $this-&gt;pgwidth;
<a name="l09897"></a>09897     $this-&gt;blk[0][<span class="stringliteral">&#39;inner_width&#39;</span>] =&amp; $this-&gt;pgwidth;
<a name="l09898"></a>09898 
<a name="l09899"></a>09899     $this-&gt;blk[0][<span class="stringliteral">&#39;blockContext&#39;</span>] = $this-&gt;blockContext;
<a name="l09900"></a>09900 
<a name="l09901"></a>09901     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>,<span class="stringliteral">&#39;&#39;</span>);
<a name="l09902"></a>09902     $this-&gt;setCSS($properties,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>); 
<a name="l09903"></a>09903     $this-&gt;blklvl = 1;
<a name="l09904"></a>09904     $this-&gt;initialiseBlock($this-&gt;blk[1]);
<a name="l09905"></a>09905     $this-&gt;blk[1][<span class="stringliteral">&#39;tag&#39;</span>] = $tag;
<a name="l09906"></a>09906     $this-&gt;blk[1][<span class="stringliteral">&#39;attr&#39;</span>] = $attr;
<a name="l09907"></a>09907 
<a name="l09908"></a>09908     $this-&gt;Reset();
<a name="l09909"></a>09909     $p = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,$tag,$attr);
<a name="l09910"></a>09910     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;OVERFLOW&#39;</span>])) { $overflow = strtolower($p[<span class="stringliteral">&#39;OVERFLOW&#39;</span>]); }
<a name="l09911"></a>09911     <span class="keywordflow">if</span> (strtolower($p[<span class="stringliteral">&#39;POSITION&#39;</span>]) == <span class="stringliteral">&#39;fixed&#39;</span>) {
<a name="l09912"></a>09912       $cont_w = $this-&gt;pgwidth; <span class="comment">// $this-&gt;blk[0][&#39;inner_width&#39;];</span>
<a name="l09913"></a>09913       $cont_h = $this-&gt;h - $this-&gt;tMargin - $this-&gt;bMargin;
<a name="l09914"></a>09914       $cont_x = $this-&gt;lMargin;
<a name="l09915"></a>09915       $cont_y = $this-&gt;tMargin;
<a name="l09916"></a>09916     }
<a name="l09917"></a>09917     <span class="keywordflow">else</span> {
<a name="l09918"></a>09918       $cont_w = $this-&gt;w; <span class="comment">// ABSOLUTE;</span>
<a name="l09919"></a>09919       $cont_h = $this-&gt;h;
<a name="l09920"></a>09920       $cont_x = 0;
<a name="l09921"></a>09921       $cont_y = 0;
<a name="l09922"></a>09922     }
<a name="l09923"></a>09923 
<a name="l09924"></a>09924     <span class="comment">// Pass on in-line properties to the innerhtml</span>
<a name="l09925"></a>09925     $css = <span class="stringliteral">&#39;&#39;</span>;
<a name="l09926"></a>09926     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) { $css .= <span class="stringliteral">&#39;text-align: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09927"></a>09927     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>])) { $css .= <span class="stringliteral">&#39;text-transform: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09928"></a>09928     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;TEXT-INDENT&#39;</span>])) { $css .= <span class="stringliteral">&#39;text-indent: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;TEXT-INDENT&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09929"></a>09929     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;TEXT-DECORATION&#39;</span>])) { $css .= <span class="stringliteral">&#39;text-decoration: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;TEXT-DECORATION&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09930"></a>09930     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) { $css .= <span class="stringliteral">&#39;font-family: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09931"></a>09931     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>])) { $css .= <span class="stringliteral">&#39;font-style: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09932"></a>09932     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>])) { $css .= <span class="stringliteral">&#39;font-weight: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09933"></a>09933     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $css .= <span class="stringliteral">&#39;font-size: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09934"></a>09934     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>])) { $css .= <span class="stringliteral">&#39;line-height: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09935"></a>09935     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;COLOR&#39;</span>])) { $css .= <span class="stringliteral">&#39;color: &#39;</span>.strtolower($p[<span class="stringliteral">&#39;COLOR&#39;</span>]).<span class="stringliteral">&#39;; &#39;</span>; }
<a name="l09936"></a>09936     <span class="keywordflow">if</span> ($css) {
<a name="l09937"></a>09937       $html = <span class="stringliteral">&#39;&lt;div style=&quot;&#39;</span>.$css.<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$html.<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l09938"></a>09938     }
<a name="l09939"></a>09939 
<a name="l09940"></a>09940     <span class="comment">// Copy over (only) the properties to set for border and background</span>
<a name="l09941"></a>09941     $pb = array();
<a name="l09942"></a>09942     $pb[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] = $p[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>]; 
<a name="l09943"></a>09943     $pb[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>] = $p[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]; 
<a name="l09944"></a>09944     $pb[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>] = $p[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>]; 
<a name="l09945"></a>09945     $pb[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>] = $p[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]; 
<a name="l09946"></a>09946     $pb[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>] = $p[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>]; 
<a name="l09947"></a>09947     $pb[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>] = $p[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>]; 
<a name="l09948"></a>09948     $pb[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>] = $p[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>]; 
<a name="l09949"></a>09949     $pb[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>] = $p[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>]; 
<a name="l09950"></a>09950     $pb[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>] = $p[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]; 
<a name="l09951"></a>09951     $pb[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>] = $p[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]; 
<a name="l09952"></a>09952     $pb[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>] = $p[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]; 
<a name="l09953"></a>09953     $pb[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>] = $p[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]; 
<a name="l09954"></a>09954     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>])) { $pb[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]; }
<a name="l09955"></a>09955     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>])) { $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]; }  <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l09956"></a>09956     <span class="comment">// mPDF 4.3.015</span>
<a name="l09957"></a>09957     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>])) { $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>]; } <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l09958"></a>09958     <span class="comment">// mPDF 4.3.017</span>
<a name="l09959"></a>09959     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>])) { $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>]; }  <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l09960"></a>09960     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>])) { $pb[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]; } <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l09961"></a>09961     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>])) { $pb[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]; } <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l09962"></a>09962 
<a name="l09963"></a>09963     $this-&gt;setCSS($pb,<span class="stringliteral">&#39;BLOCK&#39;</span>,$tag);
<a name="l09964"></a>09964     <span class="comment">//================================================================</span>
<a name="l09965"></a>09965     $bbox_dir = $p[<span class="stringliteral">&#39;DIR&#39;</span>]; 
<a name="l09966"></a>09966     $bbox_br = $this-&gt;blk[1][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l09967"></a>09967     $bbox_bl = $this-&gt;blk[1][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l09968"></a>09968     $bbox_bt = $this-&gt;blk[1][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l09969"></a>09969     $bbox_bb = $this-&gt;blk[1][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l09970"></a>09970     $bbox_pr = $this-&gt;blk[1][<span class="stringliteral">&#39;padding_right&#39;</span>];
<a name="l09971"></a>09971     $bbox_pl = $this-&gt;blk[1][<span class="stringliteral">&#39;padding_left&#39;</span>];
<a name="l09972"></a>09972     $bbox_pt = $this-&gt;blk[1][<span class="stringliteral">&#39;padding_top&#39;</span>];
<a name="l09973"></a>09973     $bbox_pb = $this-&gt;blk[1][<span class="stringliteral">&#39;padding_bottom&#39;</span>];
<a name="l09974"></a>09974     $bbox_mr = $this-&gt;blk[1][<span class="stringliteral">&#39;margin_right&#39;</span>];
<a name="l09975"></a>09975     <span class="keywordflow">if</span> (strtolower($p[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mr = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09976"></a>09976     $bbox_ml = $this-&gt;blk[1][<span class="stringliteral">&#39;margin_left&#39;</span>];
<a name="l09977"></a>09977     <span class="keywordflow">if</span> (strtolower($p[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_ml = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09978"></a>09978     $bbox_mt = $this-&gt;blk[1][<span class="stringliteral">&#39;margin_top&#39;</span>];
<a name="l09979"></a>09979     <span class="keywordflow">if</span> (strtolower($p[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mt = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09980"></a>09980     $bbox_mb = $this-&gt;blk[1][<span class="stringliteral">&#39;margin_bottom&#39;</span>];
<a name="l09981"></a>09981     <span class="keywordflow">if</span> (strtolower($p[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mb = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09982"></a>09982     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;LEFT&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;LEFT&#39;</span>])!=<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_left = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;LEFT&#39;</span>], $cont_w, $this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l09983"></a>09983     <span class="keywordflow">else</span> { $bbox_left = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09984"></a>09984     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;TOP&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;TOP&#39;</span>])!=<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_top = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;TOP&#39;</span>], $cont_h, $this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l09985"></a>09985     <span class="keywordflow">else</span> { $bbox_top = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09986"></a>09986     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;RIGHT&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;RIGHT&#39;</span>])!=<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_right = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;RIGHT&#39;</span>], $cont_w, $this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l09987"></a>09987     <span class="keywordflow">else</span> { $bbox_right = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09988"></a>09988     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BOTTOM&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;BOTTOM&#39;</span>])!=<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_bottom = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;BOTTOM&#39;</span>], $cont_h, $this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l09989"></a>09989     <span class="keywordflow">else</span> { $bbox_bottom = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09990"></a>09990     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;WIDTH&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;WIDTH&#39;</span>])!=<span class="stringliteral">&#39;auto&#39;</span>) { $inner_w = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;WIDTH&#39;</span>], $cont_w, $this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l09991"></a>09991     <span class="keywordflow">else</span> { $inner_w = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09992"></a>09992     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;HEIGHT&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;HEIGHT&#39;</span>])!=<span class="stringliteral">&#39;auto&#39;</span>) { $inner_h = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;HEIGHT&#39;</span>], $cont_h, $this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l09993"></a>09993     <span class="keywordflow">else</span> { $inner_h = <span class="stringliteral">&#39;auto&#39;</span>; }
<a name="l09994"></a>09994     <span class="comment">//================================================================</span>
<a name="l09995"></a>09995     <span class="comment">// mPDF 4.2</span>
<a name="l09996"></a>09996     <span class="keywordflow">if</span> ($checkinnerhtml==<span class="stringliteral">&#39;&#39;</span> &amp;&amp; $inner_h===<span class="stringliteral">&#39;auto&#39;</span>) { $inner_h = 0.0001; }
<a name="l09997"></a>09997     <span class="keywordflow">if</span> ($checkinnerhtml==<span class="stringliteral">&#39;&#39;</span> &amp;&amp; $inner_w===<span class="stringliteral">&#39;auto&#39;</span>) { $inner_w = $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>); }
<a name="l09998"></a>09998     <span class="comment">//================================================================</span>
<a name="l09999"></a>09999     <span class="comment">// Algorithm from CSS2.1  See http://www.w3.org/TR/CSS21/visudet.html#abs-non-replaced-height</span>
<a name="l10000"></a>10000     <span class="keywordflow">if</span> ($bbox_top===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_h===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10001"></a>10001       <span class="keywordflow">if</span> ($bbox_mt===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mt = 0; }
<a name="l10002"></a>10002       <span class="keywordflow">if</span> ($bbox_mb===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mb = 0; }
<a name="l10003"></a>10003       $bbox_top = $orig_y0 - $bbox_mt - $cont_y;
<a name="l10004"></a>10004       <span class="comment">// solve for $bbox_bottom when content_h known - $inner_h==&#39;auto&#39; &amp;&amp; $bbox_bottom==&#39;auto&#39;</span>
<a name="l10005"></a>10005     }
<a name="l10006"></a>10006     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_top!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_h!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10007"></a>10007       <span class="keywordflow">if</span> ($bbox_mt===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_mb===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10008"></a>10008         $x = $cont_h - $bbox_top - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_bottom;
<a name="l10009"></a>10009         $bbox_mt = $bbox_mb = ($x/2);
<a name="l10010"></a>10010       }
<a name="l10011"></a>10011       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_mt===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10012"></a>10012         $bbox_mt = $cont_h - $bbox_top - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mb - $bbox_bottom;
<a name="l10013"></a>10013       }
<a name="l10014"></a>10014       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_mb===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10015"></a>10015         $bbox_mb = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_bottom;
<a name="l10016"></a>10016       }
<a name="l10017"></a>10017       <span class="keywordflow">else</span> {
<a name="l10018"></a>10018         $bbox_bottom = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mt;
<a name="l10019"></a>10019       }
<a name="l10020"></a>10020     }
<a name="l10021"></a>10021     <span class="keywordflow">else</span> {
<a name="l10022"></a>10022       <span class="keywordflow">if</span> ($bbox_mt===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mt = 0; }
<a name="l10023"></a>10023       <span class="keywordflow">if</span> ($bbox_mb===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mb = 0; }
<a name="l10024"></a>10024       <span class="keywordflow">if</span> ($bbox_top===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_h===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10025"></a>10025       <span class="comment">// solve for $bbox_top when content_h known - $inner_h==&#39;auto&#39; &amp;&amp; $bbox_top ==&#39;auto&#39;</span>
<a name="l10026"></a>10026       }
<a name="l10027"></a>10027       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_top===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_h!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10028"></a>10028       $bbox_top = $orig_y0 - $bbox_mt - $cont_y;
<a name="l10029"></a>10029       $bbox_bottom = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mt;
<a name="l10030"></a>10030       }
<a name="l10031"></a>10031       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inner_h===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_top!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10032"></a>10032       <span class="comment">// solve for $bbox_bottom when content_h known - $inner_h==&#39;auto&#39; &amp;&amp; $bbox_bottom==&#39;auto&#39;</span>
<a name="l10033"></a>10033       }
<a name="l10034"></a>10034       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_top===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_h!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10035"></a>10035       $bbox_top = $cont_h - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mt - $bbox_bottom;
<a name="l10036"></a>10036       }
<a name="l10037"></a>10037       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inner_h===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_top!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10038"></a>10038       $inner_h = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $bbox_pb - $bbox_bb - $bbox_mt - $bbox_bottom;
<a name="l10039"></a>10039       }
<a name="l10040"></a>10040       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_bottom===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_top!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_h!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10041"></a>10041       $bbox_bottom = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mt;
<a name="l10042"></a>10042       }
<a name="l10043"></a>10043     }
<a name="l10044"></a>10044 
<a name="l10045"></a>10045     <span class="comment">// THEN DO SAME FOR WIDTH</span>
<a name="l10046"></a>10046     <span class="comment">// http://www.w3.org/TR/CSS21/visudet.html#abs-non-replaced-width</span>
<a name="l10047"></a>10047     <span class="keywordflow">if</span> ($bbox_left===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_w===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10048"></a>10048       <span class="keywordflow">if</span> ($bbox_ml===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_ml = 0; }
<a name="l10049"></a>10049       <span class="keywordflow">if</span> ($bbox_mr===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mr = 0; }
<a name="l10050"></a>10050       <span class="comment">// IF containing element RTL, should set $bbox_right</span>
<a name="l10051"></a>10051       $bbox_left = $orig_x0 - $bbox_ml - $cont_x;
<a name="l10052"></a>10052       <span class="comment">// solve for $bbox_right when content_w known - $inner_w==&#39;auto&#39; &amp;&amp; $bbox_right==&#39;auto&#39;</span>
<a name="l10053"></a>10053     }
<a name="l10054"></a>10054     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_left!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_w!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10055"></a>10055       <span class="keywordflow">if</span> ($bbox_ml===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_mr===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10056"></a>10056         $x = $cont_w - $bbox_left - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_right;
<a name="l10057"></a>10057         $bbox_ml = $bbox_mr = ($x/2);
<a name="l10058"></a>10058       }
<a name="l10059"></a>10059       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_ml===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10060"></a>10060         $bbox_ml = $cont_w - $bbox_left - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_mr - $bbox_right;
<a name="l10061"></a>10061       }
<a name="l10062"></a>10062       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_mr===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10063"></a>10063         $bbox_mr = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_right;
<a name="l10064"></a>10064       }
<a name="l10065"></a>10065       <span class="keywordflow">else</span> {
<a name="l10066"></a>10066         $bbox_right = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_ml;
<a name="l10067"></a>10067       }
<a name="l10068"></a>10068     }
<a name="l10069"></a>10069     <span class="keywordflow">else</span> {
<a name="l10070"></a>10070       <span class="keywordflow">if</span> ($bbox_ml===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_ml = 0; }
<a name="l10071"></a>10071       <span class="keywordflow">if</span> ($bbox_mr===<span class="stringliteral">&#39;auto&#39;</span>) { $bbox_mr = 0; }
<a name="l10072"></a>10072       <span class="keywordflow">if</span> ($bbox_left===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_w===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10073"></a>10073       <span class="comment">// solve for $bbox_left when content_w known - $inner_w==&#39;auto&#39; &amp;&amp; $bbox_left ==&#39;auto&#39;</span>
<a name="l10074"></a>10074       }
<a name="l10075"></a>10075       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_left===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_w!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10076"></a>10076       <span class="comment">// IF containing element RTL, should set $bbox_right</span>
<a name="l10077"></a>10077       $bbox_left = $orig_x0 - $bbox_ml - $cont_x;
<a name="l10078"></a>10078       $bbox_right = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_ml;
<a name="l10079"></a>10079       }
<a name="l10080"></a>10080       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inner_w===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_left!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10081"></a>10081       <span class="comment">// solve for $bbox_right when content_w known - $inner_w==&#39;auto&#39; &amp;&amp; $bbox_right==&#39;auto&#39;</span>
<a name="l10082"></a>10082       }
<a name="l10083"></a>10083       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_left===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_w!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10084"></a>10084       $bbox_left = $cont_w - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_ml - $bbox_right;
<a name="l10085"></a>10085       }
<a name="l10086"></a>10086       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inner_w===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_left!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10087"></a>10087       $inner_w = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $bbox_pr - $bbox_br - $bbox_ml - $bbox_right;
<a name="l10088"></a>10088       }
<a name="l10089"></a>10089       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_right===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_left!==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $inner_w!==<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10090"></a>10090       $bbox_right = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_ml;
<a name="l10091"></a>10091       }
<a name="l10092"></a>10092     }
<a name="l10093"></a>10093 
<a name="l10094"></a>10094     <span class="comment">//================================================================</span>
<a name="l10095"></a>10095     <span class="comment">//================================================================</span>
<a name="l10096"></a>10096     <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) &amp;&amp; $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) {  <span class="comment">// mPDF 4.3.011</span>
<a name="l10097"></a>10097       $file = $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>];
<a name="l10098"></a>10098       $sizesarray = $this-&gt;Image($file,0,0,0,0,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);  <span class="comment">// mPDF 4.3.012D</span>
<a name="l10099"></a>10099       <span class="keywordflow">if</span> (isset($sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>])) {
<a name="l10100"></a>10100         $image_id = $sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>];
<a name="l10101"></a>10101         $orig_w = $sizesarray[<span class="stringliteral">&#39;WIDTH&#39;</span>]*$this-&gt;k;    <span class="comment">// in user units i.e. mm</span>
<a name="l10102"></a>10102         $orig_h = $sizesarray[<span class="stringliteral">&#39;HEIGHT&#39;</span>]*$this-&gt;k;   <span class="comment">// (using $this-&gt;img_dpi)</span>
<a name="l10103"></a>10103         $x_repeat = <span class="keyword">true</span>;
<a name="l10104"></a>10104         $y_repeat = <span class="keyword">true</span>;
<a name="l10105"></a>10105         <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>])) {
<a name="l10106"></a>10106           <span class="keywordflow">if</span> ($pb[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $pb[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-x&#39;</span>) { $y_repeat = <span class="keyword">false</span>; }
<a name="l10107"></a>10107           <span class="keywordflow">if</span> ($pb[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $pb[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-y&#39;</span>) { $x_repeat = <span class="keyword">false</span>; }
<a name="l10108"></a>10108         }
<a name="l10109"></a>10109         $x_pos = 0;
<a name="l10110"></a>10110         $y_pos = 0;
<a name="l10111"></a>10111         <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>])) { 
<a name="l10112"></a>10112           $ppos = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$pb[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]);
<a name="l10113"></a>10113           $x_pos = $ppos[0];
<a name="l10114"></a>10114           $y_pos = $ppos[1];
<a name="l10115"></a>10115           <span class="keywordflow">if</span> (!stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $x_pos = $this-&gt;ConvertSize($x_pos ,$this-&gt;blk[1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize); }
<a name="l10116"></a>10116           <span class="keywordflow">if</span> (!stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $y_pos = $this-&gt;ConvertSize($y_pos ,$this-&gt;blk[1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize); }
<a name="l10117"></a>10117         }
<a name="l10118"></a>10118         <span class="comment">// mPDF 4.3.015</span>
<a name="l10119"></a>10119         <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>])) { $resize = $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>]; }
<a name="l10120"></a>10120         <span class="keywordflow">else</span> { $resize = 0; }
<a name="l10121"></a>10121         <span class="comment">// mPDF 4.3.017</span>
<a name="l10122"></a>10122         <span class="keywordflow">if</span> (isset($pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>])) { $opacity = $pb[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>]; }
<a name="l10123"></a>10123         <span class="keywordflow">else</span> { $opacity = 1; }
<a name="l10124"></a>10124         $this-&gt;blk[1][<span class="stringliteral">&#39;background-image&#39;</span>] = array(<span class="stringliteral">&#39;image_id&#39;</span>=&gt;$image_id, <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$x_pos, <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$y_pos, <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat, <span class="stringliteral">&#39;resize&#39;</span>=&gt;$resize, <span class="stringliteral">&#39;opacity&#39;</span>=&gt;$opacity); <span class="comment">// mPDF 4.3.015  4.3.017</span>
<a name="l10125"></a>10125       }
<a name="l10126"></a>10126     }
<a name="l10127"></a>10127 
<a name="l10128"></a>10128     <span class="comment">//================================================================</span>
<a name="l10129"></a>10129     $y = $cont_y + $bbox_top + $bbox_mt + $bbox_bt + $bbox_pt;
<a name="l10130"></a>10130     $h = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $bbox_pb - $bbox_bb - $bbox_mb - $bbox_bottom;
<a name="l10131"></a>10131     $x = $cont_x + $bbox_left + $bbox_ml + $bbox_bl + $bbox_pl;
<a name="l10132"></a>10132     $w = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $bbox_pr - $bbox_br - $bbox_mr - $bbox_right;
<a name="l10133"></a>10133     <span class="comment">// Set (temporary) values for x y w h to do first paint, if values are auto</span>
<a name="l10134"></a>10134     <span class="keywordflow">if</span> ($inner_h===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_top===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10135"></a>10135       $y = $cont_y + $bbox_mt + $bbox_bt + $bbox_pt;
<a name="l10136"></a>10136       $h = $cont_h - ($bbox_bottom + $bbox_mt + $bbox_mb + $bbox_bt + $bbox_bb + $bbox_pt + $bbox_pb);
<a name="l10137"></a>10137     }
<a name="l10138"></a>10138     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inner_h===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_bottom===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10139"></a>10139       $y = $cont_y + $bbox_top + $bbox_mt + $bbox_bt + $bbox_pt;
<a name="l10140"></a>10140       $h = $cont_h - ($bbox_top + $bbox_mt + $bbox_mb + $bbox_bt + $bbox_bb + $bbox_pt + $bbox_pb);
<a name="l10141"></a>10141     }
<a name="l10142"></a>10142     <span class="keywordflow">if</span> ($inner_w===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_left===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10143"></a>10143       $x = $cont_x + $bbox_ml + $bbox_bl + $bbox_pl;
<a name="l10144"></a>10144       $w = $cont_w - ($bbox_right + $bbox_ml + $bbox_mr + $bbox_bl + $bbox_br + $bbox_pl + $bbox_pr);
<a name="l10145"></a>10145     }
<a name="l10146"></a>10146     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inner_w===<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; $bbox_right===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10147"></a>10147       $x = $cont_x + $bbox_left + $bbox_ml + $bbox_bl + $bbox_pl;
<a name="l10148"></a>10148       $w = $cont_w - ($bbox_left + $bbox_ml + $bbox_mr + $bbox_bl + $bbox_br + $bbox_pl + $bbox_pr);
<a name="l10149"></a>10149     }
<a name="l10150"></a>10150     $bbox_y = $cont_y + $bbox_top + $bbox_mt;
<a name="l10151"></a>10151     $bbox_x = $cont_x + $bbox_left + $bbox_ml;
<a name="l10152"></a>10152     $saved_block1 = $this-&gt;blk[1];
<a name="l10153"></a>10153     unset($p);
<a name="l10154"></a>10154     unset($pb);
<a name="l10155"></a>10155     <span class="comment">//================================================================</span>
<a name="l10156"></a>10156     <span class="keywordflow">if</span> ($inner_w===<span class="stringliteral">&#39;auto&#39;</span>) { <span class="comment">// do a first write</span>
<a name="l10157"></a>10157       $this-&gt;lMargin=$x;
<a name="l10158"></a>10158       $this-&gt;rMargin=$this-&gt;w - $w - $x;
<a name="l10159"></a>10159       <span class="comment">// SET POSITION &amp; FONT VALUES</span>
<a name="l10160"></a>10160       $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l10161"></a>10161       $this-&gt;pageoutput[$this-&gt;page]=array();
<a name="l10162"></a>10162       $this-&gt;x = $x;
<a name="l10163"></a>10163       $this-&gt;y = $y;
<a name="l10164"></a>10164       $this-&gt;HTMLheaderPageLinks = array();
<a name="l10165"></a>10165       $this-&gt;pageBackgrounds = array();
<a name="l10166"></a>10166       $this-&gt;maxPosR = 0;
<a name="l10167"></a>10167       $this-&gt;maxPosL = $this-&gt;w;  <span class="comment">// For RTL</span>
<a name="l10168"></a>10168       $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);
<a name="l10169"></a>10169       $inner_w = $this-&gt;maxPosR - $this-&gt;lMargin;
<a name="l10170"></a>10170       <span class="keywordflow">if</span> ($bbox_right===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10171"></a>10171         $bbox_right = $cont_w - $bbox_left - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_ml;
<a name="l10172"></a>10172       }
<a name="l10173"></a>10173       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_left===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10174"></a>10174         $bbox_left = $cont_w - $bbox_ml - $bbox_bl - $bbox_pl - $inner_w - $bbox_pr - $bbox_br - $bbox_ml - $bbox_right;
<a name="l10175"></a>10175         $bbox_x = $cont_x + $bbox_left + $bbox_ml ;
<a name="l10176"></a>10176         $inner_x = $bbox_x + $bbox_bl + $bbox_pl;
<a name="l10177"></a>10177         $x = $inner_x;
<a name="l10178"></a>10178       }
<a name="l10179"></a>10179       $w = $inner_w;
<a name="l10180"></a>10180       $bbox_y = $cont_y + $bbox_top + $bbox_mt;
<a name="l10181"></a>10181       $bbox_x = $cont_x + $bbox_left + $bbox_ml;
<a name="l10182"></a>10182     }
<a name="l10183"></a>10183 
<a name="l10184"></a>10184     <span class="keywordflow">if</span> ($inner_h===<span class="stringliteral">&#39;auto&#39;</span>) { <span class="comment">// do a first write</span>
<a name="l10185"></a>10185       $this-&gt;lMargin=$x;
<a name="l10186"></a>10186       $this-&gt;rMargin=$this-&gt;w - $w - $x;
<a name="l10187"></a>10187       <span class="comment">// SET POSITION &amp; FONT VALUES</span>
<a name="l10188"></a>10188       $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l10189"></a>10189       $this-&gt;pageoutput[$this-&gt;page]=array();
<a name="l10190"></a>10190       $this-&gt;x = $x;
<a name="l10191"></a>10191       $this-&gt;y = $y;
<a name="l10192"></a>10192       $this-&gt;HTMLheaderPageLinks = array();
<a name="l10193"></a>10193       $this-&gt;pageBackgrounds = array();
<a name="l10194"></a>10194       $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);
<a name="l10195"></a>10195       $inner_h = $this-&gt;y - $y;
<a name="l10196"></a>10196       <span class="keywordflow">if</span> ($overflow!=<span class="stringliteral">&#39;hidden&#39;</span> &amp;&amp; $overflow!=<span class="stringliteral">&#39;visible&#39;</span>) {  <span class="comment">// constrained</span>
<a name="l10197"></a>10197         <span class="keywordflow">if</span> (($this-&gt;y + $bbox_pb + $bbox_bb) &gt; ($cont_y + $cont_h)) {
<a name="l10198"></a>10198           $adj = ($this-&gt;y + $bbox_pb + $bbox_bb) - ($cont_y + $cont_h);
<a name="l10199"></a>10199           $inner_h -= $adj;
<a name="l10200"></a>10200         }
<a name="l10201"></a>10201       }
<a name="l10202"></a>10202       <span class="keywordflow">if</span> ($bbox_bottom===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10203"></a>10203         $bbox_bottom = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mb;
<a name="l10204"></a>10204       }
<a name="l10205"></a>10205       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bbox_top===<span class="stringliteral">&#39;auto&#39;</span>) {
<a name="l10206"></a>10206         $bbox_top = $cont_h - $bbox_mt - $bbox_bt - $bbox_pt - $inner_h - $bbox_pb - $bbox_bb - $bbox_mb - $bbox_bottom;
<a name="l10207"></a>10207         <span class="keywordflow">if</span> ($overflow!=<span class="stringliteral">&#39;hidden&#39;</span> &amp;&amp; $overflow!=<span class="stringliteral">&#39;visible&#39;</span>) {  <span class="comment">// constrained</span>
<a name="l10208"></a>10208           <span class="keywordflow">if</span> ($bbox_top &lt; 0) {
<a name="l10209"></a>10209             $bbox_top = 0;
<a name="l10210"></a>10210             $inner_h = $cont_h - $bbox_top - $bbox_mt - $bbox_bt - $bbox_pt - $bbox_pb - $bbox_bb - $bbox_mb - $bbox_bottom;
<a name="l10211"></a>10211           }
<a name="l10212"></a>10212         }
<a name="l10213"></a>10213         $bbox_y = $cont_y + $bbox_top + $bbox_mt;
<a name="l10214"></a>10214         $inner_y = $bbox_y + $bbox_bt + $bbox_pt;
<a name="l10215"></a>10215         $y = $inner_y;
<a name="l10216"></a>10216       }
<a name="l10217"></a>10217       $h = $inner_h;
<a name="l10218"></a>10218       $bbox_y = $cont_y + $bbox_top + $bbox_mt;
<a name="l10219"></a>10219       $bbox_x = $cont_x + $bbox_left + $bbox_ml;
<a name="l10220"></a>10220     }
<a name="l10221"></a>10221     $inner_w = $w;
<a name="l10222"></a>10222     $inner_h = $h;
<a name="l10223"></a>10223 
<a name="l10224"></a>10224   }
<a name="l10225"></a>10225 
<a name="l10226"></a>10226 
<a name="l10227"></a>10227   $this-&gt;lMargin=$x;
<a name="l10228"></a>10228   $this-&gt;rMargin=$this-&gt;w - $w - $x;
<a name="l10229"></a>10229   <span class="comment">// SET POSITION &amp; FONT VALUES</span>
<a name="l10230"></a>10230   $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l10231"></a>10231   $this-&gt;pageoutput[$this-&gt;page]=array();
<a name="l10232"></a>10232   $this-&gt;x = $x;
<a name="l10233"></a>10233   $this-&gt;y = $y;
<a name="l10234"></a>10234   $this-&gt;HTMLheaderPageLinks = array();
<a name="l10235"></a>10235   $this-&gt;pageBackgrounds = array();
<a name="l10236"></a>10236   $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);  <span class="comment">// parameter 4 saves output to $this-&gt;headerbuffer</span>
<a name="l10237"></a>10237   $actual_h = $this-&gt;y - $y;
<a name="l10238"></a>10238   $use_w = $w;
<a name="l10239"></a>10239   $use_h = $h;
<a name="l10240"></a>10240   $ratio = $actual_h / $use_w;
<a name="l10241"></a>10241   <span class="keywordflow">if</span> ($overflow!=<span class="stringliteral">&#39;hidden&#39;</span> &amp;&amp; $overflow!=<span class="stringliteral">&#39;visible&#39;</span>) {
<a name="l10242"></a>10242     $target = $h/$w;
<a name="l10243"></a>10243     <span class="keywordflow">if</span> (($ratio / $target ) &gt; 1) {
<a name="l10244"></a>10244       $nl = CEIL($actual_h / $this-&gt;lineheight);
<a name="l10245"></a>10245       $l = $use_w * $nl;
<a name="l10246"></a>10246       $est_w = sqrt(($l * $this-&gt;lineheight) / $target) * 0.8;
<a name="l10247"></a>10247       $use_w += ($est_w - $use_w) - ($w/100);
<a name="l10248"></a>10248     }
<a name="l10249"></a>10249     <span class="keywordflow">while</span>(($ratio / $target ) &gt; 1) {
<a name="l10250"></a>10250       $this-&gt;x = $x;
<a name="l10251"></a>10251       $this-&gt;y = $y;
<a name="l10252"></a>10252 
<a name="l10253"></a>10253       <span class="comment">// mPDF 4.2</span>
<a name="l10254"></a>10254       <span class="keywordflow">if</span> (($ratio / $target) &gt; 1.5 || ($ratio / $target) &lt; 0.6) {
<a name="l10255"></a>10255         $use_w += ($w/$this-&gt;incrementFPR1);
<a name="l10256"></a>10256       }
<a name="l10257"></a>10257       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($ratio / $target) &gt; 1.2 || ($ratio / $target) &lt; 0.85) {
<a name="l10258"></a>10258         $use_w += ($w/$this-&gt;incrementFPR2);
<a name="l10259"></a>10259       }
<a name="l10260"></a>10260       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($ratio / $target) &gt; 1.1 || ($ratio / $target) &lt; 0.91) {
<a name="l10261"></a>10261         $use_w += ($w/$this-&gt;incrementFPR3);
<a name="l10262"></a>10262       }
<a name="l10263"></a>10263       <span class="keywordflow">else</span> {
<a name="l10264"></a>10264         $use_w += ($w/$this-&gt;incrementFPR4);
<a name="l10265"></a>10265       }
<a name="l10266"></a>10266 
<a name="l10267"></a>10267       $use_h = $use_w * $target ;
<a name="l10268"></a>10268       $this-&gt;rMargin=$this-&gt;w - $use_w - $x;
<a name="l10269"></a>10269       $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l10270"></a>10270       $this-&gt;HTMLheaderPageLinks = array();
<a name="l10271"></a>10271       $this-&gt;pageBackgrounds = array();
<a name="l10272"></a>10272       $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($html , 4);  <span class="comment">// parameter 4 saves output to $this-&gt;headerbuffer</span>
<a name="l10273"></a>10273       $actual_h = $this-&gt;y - $y;
<a name="l10274"></a>10274       $ratio = $actual_h / $use_w;
<a name="l10275"></a>10275     }
<a name="l10276"></a>10276   }
<a name="l10277"></a>10277   $shrink_f = $w/$use_w;
<a name="l10278"></a>10278 
<a name="l10279"></a>10279   <span class="comment">//================================================================</span>
<a name="l10280"></a>10280 
<a name="l10281"></a>10281   $this-&gt;pages[$this-&gt;page] .= <span class="stringliteral">&#39;___BEFORE_BORDERS___&#39;</span>;
<a name="l10282"></a>10282   $block_s = $this-&gt;PrintPageBackgrounds(); <span class="comment">// Save to print later inside clipping path</span>
<a name="l10283"></a>10283   $this-&gt;pageBackgrounds = array();
<a name="l10284"></a>10284 
<a name="l10285"></a>10285   <span class="comment">//================================================================</span>
<a name="l10286"></a>10286   <span class="keywordflow">if</span> (!empty($bounding)) {  
<a name="l10287"></a>10287     <span class="comment">// WHEN HEIGHT // BOTTOM EDGE IS KNOWN and $this-&gt;y is set to the bottom</span>
<a name="l10288"></a>10288     <span class="comment">// Re-instate saved $this-&gt;blk[1]</span>
<a name="l10289"></a>10289     $this-&gt;blk[1] = $saved_block1;
<a name="l10290"></a>10290 
<a name="l10291"></a>10291     <span class="comment">// These are only needed when painting border/background</span>
<a name="l10292"></a>10292     $this-&gt;blk[1][<span class="stringliteral">&#39;width&#39;</span>] = $bbox_w = $cont_w - $bbox_left - $bbox_ml - $bbox_mr - $bbox_right;
<a name="l10293"></a>10293     $this-&gt;blk[1][<span class="stringliteral">&#39;x0&#39;</span>] = $bbox_x;
<a name="l10294"></a>10294     $this-&gt;blk[1][<span class="stringliteral">&#39;y0&#39;</span>] = $bbox_y;
<a name="l10295"></a>10295     $this-&gt;blk[1][<span class="stringliteral">&#39;startpage&#39;</span>] = $this-&gt;page;
<a name="l10296"></a>10296     $this-&gt;blk[1][<span class="stringliteral">&#39;y1&#39;</span>] = $bbox_y + $bbox_bt + $bbox_pt + $inner_h + $bbox_pb + $bbox_bb ;
<a name="l10297"></a>10297     $this-&gt;PaintDivBB(<span class="stringliteral">&#39;&#39;</span>,0,1);  <span class="comment">// Prints borders and sets backgrounds in $this-&gt;pageBackgrounds </span>
<a name="l10298"></a>10298   }
<a name="l10299"></a>10299 
<a name="l10300"></a>10300   $s = $this-&gt;PrintPageBackgrounds();
<a name="l10301"></a>10301   $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/___BEFORE_BORDERS___/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l10302"></a>10302   $this-&gt;pageBackgrounds = array();
<a name="l10303"></a>10303 
<a name="l10304"></a>10304   <span class="comment">// Clipping Output</span>
<a name="l10305"></a>10305   <span class="keywordflow">if</span> ($overflow==<span class="stringliteral">&#39;hidden&#39;</span>) {
<a name="l10306"></a>10306     <span class="comment">//Bounding rectangle to clip</span>
<a name="l10307"></a>10307     $clip_y1 = $this-&gt;y;
<a name="l10308"></a>10308     <span class="keywordflow">if</span> (!empty($bounding) &amp;&amp; ($this-&gt;y + $bbox_pb + $bbox_bb) &gt; ($bbox_y + $bbox_bt + $bbox_pt + $inner_h + $bbox_pb + $bbox_bb )) {
<a name="l10309"></a>10309       $clip_y1 = ($bbox_y + $bbox_bt + $bbox_pt + $inner_h + $bbox_pb + $bbox_bb ) - ($bbox_pb + $bbox_bb);
<a name="l10310"></a>10310     }
<a name="l10311"></a>10311     <span class="comment">//$op = &#39;W* n&#39;; // Clipping</span>
<a name="l10312"></a>10312     $op = <span class="stringliteral">&#39;W n&#39;</span>;  <span class="comment">// Clipping alternative mode</span>
<a name="l10313"></a>10313     $this-&gt;_out(<span class="stringliteral">&quot;q&quot;</span>);
<a name="l10314"></a>10314     $ch = $clip_y1 - $y;
<a name="l10315"></a>10315     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re %s&#39;</span>,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,$w*$this-&gt;k,-$ch*$this-&gt;k,$op));
<a name="l10316"></a>10316     <span class="keywordflow">if</span> (!empty($block_s)) {
<a name="l10317"></a>10317       $tmp = <span class="stringliteral">&quot;q\n&quot;</span>.sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re %s&#39;</span>,$x*$this-&gt;k,($this-&gt;h-$y)*$this-&gt;k,$w*$this-&gt;k,-$ch*$this-&gt;k,$op);
<a name="l10318"></a>10318       $tmp .= <span class="stringliteral">&quot;\n&quot;</span>.$block_s.<span class="stringliteral">&quot;\nQ&quot;</span>;
<a name="l10319"></a>10319       $block_s = $tmp ;
<a name="l10320"></a>10320     }
<a name="l10321"></a>10321   }
<a name="l10322"></a>10322 
<a name="l10323"></a>10323 
<a name="l10324"></a>10324   <span class="keywordflow">if</span> (!empty($block_s)) {
<a name="l10325"></a>10325     <span class="keywordflow">if</span> ($shrink_f != 1) { <span class="comment">// i.e. autofit has resized the box</span>
<a name="l10326"></a>10326       $tmp = <span class="stringliteral">&quot;q\n&quot;</span>.$this-&gt;transformScale(($shrink_f*100),($shrink_f*100), $x, $y, <span class="keyword">true</span>);
<a name="l10327"></a>10327       $tmp .= <span class="stringliteral">&quot;\n&quot;</span>.$block_s.<span class="stringliteral">&quot;\nQ&quot;</span>;
<a name="l10328"></a>10328       $block_s = $tmp ;
<a name="l10329"></a>10329     }
<a name="l10330"></a>10330 
<a name="l10331"></a>10331     $this-&gt;_out($block_s);
<a name="l10332"></a>10332   }
<a name="l10333"></a>10333 
<a name="l10334"></a>10334 
<a name="l10335"></a>10335 
<a name="l10336"></a>10336   <span class="keywordflow">if</span> ($shrink_f != 1) { <span class="comment">// i.e. autofit has resized the box</span>
<a name="l10337"></a>10337     $this-&gt;StartTransform();
<a name="l10338"></a>10338     $this-&gt;transformScale(($shrink_f*100),($shrink_f*100), $x, $y);
<a name="l10339"></a>10339   }
<a name="l10340"></a>10340 
<a name="l10341"></a>10341   $this-&gt;_out($this-&gt;headerbuffer);
<a name="l10342"></a>10342 
<a name="l10343"></a>10343   <span class="keywordflow">if</span> ($shrink_f != 1) { <span class="comment">// i.e. autofit has resized the box</span>
<a name="l10344"></a>10344     $this-&gt;StopTransform();
<a name="l10345"></a>10345   }
<a name="l10346"></a>10346 
<a name="l10347"></a>10347   <span class="keywordflow">if</span> ($overflow==<span class="stringliteral">&#39;hidden&#39;</span>) {
<a name="l10348"></a>10348     <span class="comment">//End clipping</span>
<a name="l10349"></a>10349     $this-&gt;_out(<span class="stringliteral">&quot;Q&quot;</span>);
<a name="l10350"></a>10350   }
<a name="l10351"></a>10351 
<a name="l10352"></a>10352 
<a name="l10353"></a>10353   <span class="comment">// Page Links</span>
<a name="l10354"></a>10354   <span class="keywordflow">foreach</span>($this-&gt;HTMLheaderPageLinks AS $lk) {
<a name="l10355"></a>10355     <span class="keywordflow">if</span> ($shrink_f != 1) {   <span class="comment">// i.e. autofit has resized the box</span>
<a name="l10356"></a>10356       $lx1 = (($lk[0]/$this-&gt;k)-$x);
<a name="l10357"></a>10357       $lx2 = $x + ($lx1 * $shrink_f);
<a name="l10358"></a>10358       $lk[0] = $lx2*$this-&gt;k;
<a name="l10359"></a>10359       $ly1 = (($this-&gt;h-($lk[1]/$this-&gt;k))-$y);
<a name="l10360"></a>10360       $ly2 = $y + ($ly1 * $shrink_f);
<a name="l10361"></a>10361       $lk[1] = ($this-&gt;h-$ly2)*$this-&gt;k;
<a name="l10362"></a>10362       $lk[2] *= $shrink_f;  <span class="comment">// width</span>
<a name="l10363"></a>10363       $lk[3] *= $shrink_f;  <span class="comment">// height</span>
<a name="l10364"></a>10364     }
<a name="l10365"></a>10365     $this-&gt;PageLinks[$this-&gt;page][]=$lk;
<a name="l10366"></a>10366   }
<a name="l10367"></a>10367   <span class="comment">// Restore</span>
<a name="l10368"></a>10368   $this-&gt;headerbuffer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l10369"></a>10369   $this-&gt;HTMLheaderPageLinks = array();
<a name="l10370"></a>10370   $this-&gt;pageBackgrounds = $save_bgs;
<a name="l10371"></a>10371   $this-&gt;writingHTMLheader = <span class="keyword">false</span>;
<a name="l10372"></a>10372   <span class="comment">// mPDF 4.0</span>
<a name="l10373"></a>10373   $this-&gt;writingHTMLfooter = <span class="keyword">false</span>;
<a name="l10374"></a>10374   <span class="comment">// mPDF 4.1</span>
<a name="l10375"></a>10375   $this-&gt;fullImageHeight = <span class="keyword">false</span>;
<a name="l10376"></a>10376   $this-&gt;ResetMargins();
<a name="l10377"></a>10377   $this-&gt;pgwidth = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l10378"></a>10378   $this-&gt;SetXY($save_x,$save_y) ; 
<a name="l10379"></a>10379   $this-&gt;InFooter = <span class="keyword">false</span>;  <span class="comment">// turns back on autopagebreaks</span>
<a name="l10380"></a>10380   $this-&gt;pageoutput[$this-&gt;page]=array();
<a name="l10381"></a>10381   $this-&gt;pageoutput[$this-&gt;page][<span class="stringliteral">&#39;Font&#39;</span>]=<span class="stringliteral">&#39;&#39;</span>;
<a name="l10382"></a>10382 }
<a name="l10383"></a>10383 
<a name="l10384"></a>10384 
<a name="l10385"></a>10385 <span class="comment">// mPDF 4.0</span>
<a name="l10386"></a>10386 function initialiseBlock(&amp;$blk) {
<a name="l10387"></a>10387   $blk[<span class="stringliteral">&#39;margin_top&#39;</span>] = 0;
<a name="l10388"></a>10388   $blk[<span class="stringliteral">&#39;margin_left&#39;</span>] = 0;
<a name="l10389"></a>10389   $blk[<span class="stringliteral">&#39;margin_bottom&#39;</span>] = 0;
<a name="l10390"></a>10390   $blk[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l10391"></a>10391   $blk[<span class="stringliteral">&#39;padding_top&#39;</span>] = 0;
<a name="l10392"></a>10392   $blk[<span class="stringliteral">&#39;padding_left&#39;</span>] = 0;
<a name="l10393"></a>10393   $blk[<span class="stringliteral">&#39;padding_bottom&#39;</span>] = 0;
<a name="l10394"></a>10394   $blk[<span class="stringliteral">&#39;padding_right&#39;</span>] = 0;
<a name="l10395"></a>10395   $blk[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l10396"></a>10396   $blk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l10397"></a>10397   $blk[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l10398"></a>10398   $blk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l10399"></a>10399   $blk[<span class="stringliteral">&#39;hide&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10400"></a>10400   $blk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>] = 0; 
<a name="l10401"></a>10401   $blk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>] = 0; 
<a name="l10402"></a>10402   $blk[<span class="stringliteral">&#39;cascadeCSS&#39;</span>] = array(); 
<a name="l10403"></a>10403   $blk[<span class="stringliteral">&#39;block-align&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10404"></a>10404   $blk[<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10405"></a>10405   $blk[<span class="stringliteral">&#39;page_break_after_avoid&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10406"></a>10406   $blk[<span class="stringliteral">&#39;keep_block_together&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10407"></a>10407   $blk[<span class="stringliteral">&#39;float&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10408"></a>10408   $blk[<span class="stringliteral">&#39;line_height&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l10409"></a>10409   $blk[<span class="stringliteral">&#39;margin_collapse&#39;</span>] = <span class="keyword">false</span>; 
<a name="l10410"></a>10410 }
<a name="l10411"></a>10411 
<a name="l10412"></a>10412 <span class="comment">// mPDF 4.0</span>
<a name="l10413"></a>10413 function border_details($bd) {
<a name="l10414"></a>10414   $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($bd));
<a name="l10415"></a>10415   <span class="comment">// mPDF 4.0</span>
<a name="l10416"></a>10416   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>])) { $refw = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]; }
<a name="l10417"></a>10417   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>])) { $refw = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>]; }
<a name="l10418"></a>10418   <span class="keywordflow">else</span> { $refw = $this-&gt;w; }
<a name="l10419"></a>10419   <span class="keywordflow">if</span> ( count($prop) == 1 ) { 
<a name="l10420"></a>10420     $bsize = $this-&gt;ConvertSize($prop[0],$refw,$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l10421"></a>10421     <span class="keywordflow">if</span> ($bsize &gt; 0) {
<a name="l10422"></a>10422       <span class="keywordflow">return</span> array(<span class="charliteral">&#39;s&#39;</span> =&gt; 1, <span class="charliteral">&#39;w&#39;</span> =&gt; $bsize, <span class="charliteral">&#39;c&#39;</span> =&gt; array(<span class="charliteral">&#39;R&#39;</span>=&gt;0,<span class="charliteral">&#39;G&#39;</span>=&gt;0,<span class="charliteral">&#39;B&#39;</span>=&gt;0), <span class="stringliteral">&#39;style&#39;</span>=&gt;<span class="stringliteral">&#39;solid&#39;</span>);
<a name="l10423"></a>10423     }
<a name="l10424"></a>10424     <span class="keywordflow">else</span> { <span class="keywordflow">return</span> array(<span class="charliteral">&#39;w&#39;</span> =&gt; 0, <span class="charliteral">&#39;s&#39;</span> =&gt; 0); }  <span class="comment">// mPDF 3.0</span>
<a name="l10425"></a>10425   }
<a name="l10426"></a>10426   <span class="comment">// mPDF 4.0</span>
<a name="l10427"></a>10427   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($prop) == 2 ) { 
<a name="l10428"></a>10428     <span class="comment">// 1px solid </span>
<a name="l10429"></a>10429     <span class="keywordflow">if</span> (in_array($prop[1],$this-&gt;borderstyles) || $prop[1] == <span class="stringliteral">&#39;none&#39;</span> || $prop[1] == <span class="stringliteral">&#39;hidden&#39;</span> ) { $prop[2] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l10430"></a>10430     <span class="comment">// solid #000000 </span>
<a name="l10431"></a>10431     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($prop[0],$this-&gt;borderstyles) || $prop[0] == <span class="stringliteral">&#39;none&#39;</span> || $prop[0] == <span class="stringliteral">&#39;hidden&#39;</span> ) { $prop[0] = <span class="stringliteral">&#39;&#39;</span>; $prop[1] = $prop[0]; $prop[2] = $prop[1]; }
<a name="l10432"></a>10432     <span class="comment">// 1px #000000 </span>
<a name="l10433"></a>10433     <span class="keywordflow">else</span> { $prop[1] = <span class="stringliteral">&#39;&#39;</span>; $prop[2] = $prop[1]; }
<a name="l10434"></a>10434   }
<a name="l10435"></a>10435   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( count($prop) == 3 ) {
<a name="l10436"></a>10436     <span class="comment">// Change #000000 1px solid to 1px solid #000000 (proper)</span>
<a name="l10437"></a>10437     <span class="keywordflow">if</span> (substr($prop[0],0,1) == <span class="charliteral">&#39;#&#39;</span>) { $tmp = $prop[0]; $prop[0] = $prop[1]; $prop[1] = $prop[2]; $prop[2] = $tmp; }
<a name="l10438"></a>10438     <span class="comment">// Change solid #000000 1px to 1px solid #000000 (proper)</span>
<a name="l10439"></a>10439     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (substr($prop[0],1,1) == <span class="charliteral">&#39;#&#39;</span>) { $tmp = $prop[1]; $prop[0] = $prop[2]; $prop[1] = $prop[0]; $prop[2] = $tmp; }
<a name="l10440"></a>10440     <span class="comment">// Change solid 1px #000000 to 1px solid #000000 (proper)</span>
<a name="l10441"></a>10441     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($prop[0],$this-&gt;borderstyles) || $prop[0] == <span class="stringliteral">&#39;none&#39;</span> || $prop[0] == <span class="stringliteral">&#39;hidden&#39;</span> ) { 
<a name="l10442"></a>10442       $tmp = $prop[0]; $prop[0] = $prop[1]; $prop[1] = $tmp; 
<a name="l10443"></a>10443     }
<a name="l10444"></a>10444   }
<a name="l10445"></a>10445   <span class="keywordflow">else</span> { <span class="keywordflow">return</span> array(); } 
<a name="l10446"></a>10446   <span class="comment">// Size</span>
<a name="l10447"></a>10447   $bsize = $this-&gt;ConvertSize($prop[0],$refw,$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l10448"></a>10448   <span class="comment">//color</span>
<a name="l10449"></a>10449   $coul = $this-&gt;ConvertColor($prop[2]);  <span class="comment">// returns array</span>
<a name="l10450"></a>10450   <span class="comment">// Style</span>
<a name="l10451"></a>10451   $prop[1] = strtolower($prop[1]);
<a name="l10452"></a>10452   <span class="keywordflow">if</span> (in_array($prop[1],$this-&gt;borderstyles) &amp;&amp; $bsize &gt; 0) { $on = 1; } 
<a name="l10453"></a>10453   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($prop[1] == <span class="stringliteral">&#39;hidden&#39;</span>) { $on = 1; $bsize = 0; $coul = <span class="stringliteral">&#39;&#39;</span>; } 
<a name="l10454"></a>10454   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($prop[1] == <span class="stringliteral">&#39;none&#39;</span>) { $on = 0; $bsize = 0; $coul = <span class="stringliteral">&#39;&#39;</span>; } 
<a name="l10455"></a>10455   <span class="keywordflow">else</span> { $on = 0; $bsize = 0; $coul = <span class="stringliteral">&#39;&#39;</span>; $prop[1] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l10456"></a>10456   <span class="keywordflow">return</span> array(<span class="charliteral">&#39;s&#39;</span> =&gt; $on, <span class="charliteral">&#39;w&#39;</span> =&gt; $bsize, <span class="charliteral">&#39;c&#39;</span> =&gt; $coul, <span class="stringliteral">&#39;style&#39;</span>=&gt; $prop[1] );
<a name="l10457"></a>10457 }
<a name="l10458"></a>10458 
<a name="l10459"></a>10459 <span class="comment">// mPDF 4.0</span>
<a name="l10460"></a>10460 function _fix_borderStr($bd) {
<a name="l10461"></a>10461   $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($bd));
<a name="l10462"></a>10462   $w = <span class="stringliteral">&#39;medium&#39;</span>;  <span class="comment">// mPDF 4.3.010</span>
<a name="l10463"></a>10463   $c = <span class="stringliteral">&#39;#000000&#39;</span>;
<a name="l10464"></a>10464   $s = <span class="stringliteral">&#39;none&#39;</span>;
<a name="l10465"></a>10465 
<a name="l10466"></a>10466   <span class="keywordflow">if</span> ( count($prop) == 1 ) { 
<a name="l10467"></a>10467     <span class="comment">// solid</span>
<a name="l10468"></a>10468     <span class="keywordflow">if</span> (in_array($prop[0],$this-&gt;borderstyles) || $prop[0] == <span class="stringliteral">&#39;none&#39;</span> || $prop[0] == <span class="stringliteral">&#39;hidden&#39;</span> ) { $s = $prop[0]; }
<a name="l10469"></a>10469     <span class="comment">// #000000</span>
<a name="l10470"></a>10470     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_array($this-&gt;ConvertColor($prop[0]))) { $c = $prop[0]; }
<a name="l10471"></a>10471     <span class="comment">// 1px </span>
<a name="l10472"></a>10472     <span class="keywordflow">else</span> { $w = $prop[0]; }
<a name="l10473"></a>10473   }
<a name="l10474"></a>10474   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($prop) == 2 ) { 
<a name="l10475"></a>10475     <span class="comment">// 1px solid </span>
<a name="l10476"></a>10476     <span class="keywordflow">if</span> (in_array($prop[1],$this-&gt;borderstyles) || $prop[1] == <span class="stringliteral">&#39;none&#39;</span> || $prop[1] == <span class="stringliteral">&#39;hidden&#39;</span> ) { $w = $prop[0]; $s = $prop[1]; }
<a name="l10477"></a>10477     <span class="comment">// solid #000000 </span>
<a name="l10478"></a>10478     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($prop[0],$this-&gt;borderstyles) || $prop[0] == <span class="stringliteral">&#39;none&#39;</span> || $prop[0] == <span class="stringliteral">&#39;hidden&#39;</span> ) { $s = $prop[0]; $c = $prop[1]; }
<a name="l10479"></a>10479     <span class="comment">// 1px #000000 </span>
<a name="l10480"></a>10480     <span class="keywordflow">else</span> { $w = $prop[0]; $c = $prop[1]; }
<a name="l10481"></a>10481   }
<a name="l10482"></a>10482   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( count($prop) == 3 ) {
<a name="l10483"></a>10483     <span class="comment">// Change #000000 1px solid to 1px solid #000000 (proper)</span>
<a name="l10484"></a>10484     <span class="keywordflow">if</span> (substr($prop[0],0,1) == <span class="charliteral">&#39;#&#39;</span>) { $c = $prop[0]; $w = $prop[1]; $s = $prop[2]; }
<a name="l10485"></a>10485     <span class="comment">// Change solid #000000 1px to 1px solid #000000 (proper)</span>
<a name="l10486"></a>10486     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (substr($prop[0],1,1) == <span class="charliteral">&#39;#&#39;</span>) { $s = $prop[0]; $c = $prop[1]; $w = $prop[2]; }
<a name="l10487"></a>10487     <span class="comment">// Change solid 1px #000000 to 1px solid #000000 (proper)</span>
<a name="l10488"></a>10488     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($prop[0],$this-&gt;borderstyles) || $prop[0] == <span class="stringliteral">&#39;none&#39;</span> || $prop[0] == <span class="stringliteral">&#39;hidden&#39;</span> ) { 
<a name="l10489"></a>10489       $s = $prop[0]; $w = $prop[1]; $c = $prop[2]; 
<a name="l10490"></a>10490     }
<a name="l10491"></a>10491     <span class="keywordflow">else</span> { $w = $prop[0]; $s = $prop[1]; $c = $prop[2]; }
<a name="l10492"></a>10492   }
<a name="l10493"></a>10493   <span class="keywordflow">else</span> { <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; } 
<a name="l10494"></a>10494   $s = strtolower($s);
<a name="l10495"></a>10495   <span class="keywordflow">return</span> $w.<span class="charliteral">&#39; &#39;</span>.$s.<span class="charliteral">&#39; &#39;</span>.$c;
<a name="l10496"></a>10496 }
<a name="l10497"></a>10497 
<a name="l10498"></a>10498 
<a name="l10499"></a>10499 
<a name="l10500"></a>10500 <span class="comment">// NEW FUNCTION FOR CSS MARGIN or PADDING called from SetCSS</span>
<a name="l10501"></a>10501 function fixCSS($prop) {
<a name="l10502"></a>10502   <span class="keywordflow">if</span> (!is_array($prop) || (count($prop)==0)) <span class="keywordflow">return</span> array(); 
<a name="l10503"></a>10503   $newprop = array(); 
<a name="l10504"></a>10504   <span class="keywordflow">foreach</span>($prop AS $k =&gt; $v) {
<a name="l10505"></a>10505     <span class="comment">// mPDF 4.2.013 Change all CSS properties to lowercase, except those that are case sensitive</span>
<a name="l10506"></a>10506     <span class="keywordflow">if</span> ($k != <span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;BACKGROUND&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;HEADER&#39;</span> &amp;&amp; $k != <span class="stringliteral">&#39;FOOTER&#39;</span>) {
<a name="l10507"></a>10507       $v = strtolower($v);
<a name="l10508"></a>10508     }
<a name="l10509"></a>10509 
<a name="l10510"></a>10510     <span class="comment">// mPDF 4.0 - FONT shorthand</span>
<a name="l10511"></a>10511     <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;FONT&#39;</span>) {
<a name="l10512"></a>10512       $s = trim($v);
<a name="l10513"></a>10513       preg_match_all(<span class="stringliteral">&#39;/\&quot;(.*?)\&quot;/&#39;</span>,$s,$ff);
<a name="l10514"></a>10514       <span class="keywordflow">if</span> (count($ff[1])) {
<a name="l10515"></a>10515         <span class="keywordflow">foreach</span>($ff[1] AS $ffp) { 
<a name="l10516"></a>10516           $w = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$ffp);
<a name="l10517"></a>10517           $s = preg_replace(<span class="stringliteral">&#39;/\&quot;&#39;</span>.$ffp.<span class="stringliteral">&#39;\&quot;/&#39;</span>,$w[0],$s); 
<a name="l10518"></a>10518         }
<a name="l10519"></a>10519       }
<a name="l10520"></a>10520       preg_match_all(<span class="stringliteral">&#39;/\&#39;(.*?)\&#39;/&#39;</span>,$s,$ff);
<a name="l10521"></a>10521       <span class="keywordflow">if</span> (count($ff[1])) {
<a name="l10522"></a>10522         <span class="keywordflow">foreach</span>($ff[1] AS $ffp) { 
<a name="l10523"></a>10523           $w = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$ffp);
<a name="l10524"></a>10524           $s = preg_replace(<span class="stringliteral">&#39;/\&#39;&#39;</span>.$ffp.<span class="charliteral">&#39;\&#39;</span>/<span class="stringliteral">&#39;,$w[0],$s); </span>
<a name="l10525"></a>10525 <span class="stringliteral">        }</span>
<a name="l10526"></a>10526 <span class="stringliteral">      }</span>
<a name="l10527"></a>10527 <span class="stringliteral">      $s = preg_replace(&#39;</span>/\s*,\s*/<span class="charliteral">&#39;,&#39;</span>,<span class="stringliteral">&#39;,$s); </span>
<a name="l10528"></a>10528 <span class="stringliteral">      $bits = preg_split(&#39;</span>/\s+/<span class="stringliteral">&#39;,$s);</span>
<a name="l10529"></a>10529 <span class="stringliteral">      if (count($bits)&gt;1) {</span>
<a name="l10530"></a>10530 <span class="stringliteral">        $k = &#39;</span>FONT-FAMILY<span class="stringliteral">&#39;; $v = $bits[(count($bits)-1)];</span>
<a name="l10531"></a>10531 <span class="stringliteral">        $fs = $bits[(count($bits)-2)];</span>
<a name="l10532"></a>10532 <span class="stringliteral">        if (preg_match(&#39;</span>/(.*?)\/(.*)/<span class="stringliteral">&#39;,$fs, $fsp)) { </span>
<a name="l10533"></a>10533 <span class="stringliteral">          $newprop[&#39;</span>FONT-SIZE<span class="stringliteral">&#39;] = $fsp[1];</span>
<a name="l10534"></a>10534 <span class="stringliteral">          $newprop[&#39;</span>LINE-HEIGHT<span class="stringliteral">&#39;] = $fsp[2];</span>
<a name="l10535"></a>10535 <span class="stringliteral">        }</span>
<a name="l10536"></a>10536 <span class="stringliteral">        else { $newprop[&#39;</span>FONT-SIZE<span class="stringliteral">&#39;] = $fs; } </span>
<a name="l10537"></a>10537 <span class="stringliteral">        if (preg_match(&#39;</span>/(italic|oblique)/i<span class="stringliteral">&#39;,$s)) { $newprop[&#39;</span>FONT-STYLE<span class="stringliteral">&#39;] = &#39;</span>italic<span class="stringliteral">&#39;; }</span>
<a name="l10538"></a>10538 <span class="stringliteral">        else { $newprop[&#39;</span>FONT-STYLE<span class="stringliteral">&#39;] = &#39;</span>normal<span class="stringliteral">&#39;; }</span>
<a name="l10539"></a>10539 <span class="stringliteral">        if (preg_match(&#39;</span>/bold/i<span class="stringliteral">&#39;,$s)) { $newprop[&#39;</span>FONT-WEIGHT<span class="stringliteral">&#39;] = &#39;</span>bold<span class="stringliteral">&#39;; }</span>
<a name="l10540"></a>10540 <span class="stringliteral">        else { $newprop[&#39;</span>FONT-WEIGHT<span class="stringliteral">&#39;] = &#39;</span>normal<span class="stringliteral">&#39;; }</span>
<a name="l10541"></a>10541 <span class="stringliteral">        if (preg_match(&#39;</span>/small-caps/i<span class="stringliteral">&#39;,$s)) { $newprop[&#39;</span>TEXT-TRANSFORM<span class="stringliteral">&#39;] = &#39;</span>uppercase<span class="stringliteral">&#39;; }</span>
<a name="l10542"></a>10542 <span class="stringliteral">      }</span>
<a name="l10543"></a>10543 <span class="stringliteral">    }</span>
<a name="l10544"></a>10544 <span class="stringliteral">    if ($k == &#39;</span>FONT-FAMILY<span class="stringliteral">&#39;) {</span>
<a name="l10545"></a>10545 <span class="stringliteral">      $aux_fontlist = explode(&quot;,&quot;,$v);</span>
<a name="l10546"></a>10546 <span class="stringliteral">      $fonttype = trim($aux_fontlist[0]);</span>
<a name="l10547"></a>10547 <span class="stringliteral">      // mPDF 4.0</span>
<a name="l10548"></a>10548 <span class="stringliteral">      $fonttype = preg_replace(&#39;</span>/[<span class="stringliteral">&quot;\&#39;]*(.*?)[&quot;</span>\<span class="stringliteral">&#39;]*/&#39;</span>,<span class="stringliteral">&#39;\\1&#39;</span>,$fonttype);
<a name="l10549"></a>10549       $aux_fontlist = explode(<span class="stringliteral">&quot; &quot;</span>,$fonttype);
<a name="l10550"></a>10550       $fonttype = $aux_fontlist[0];
<a name="l10551"></a>10551       $v = strtolower(trim($fonttype));
<a name="l10552"></a>10552       <span class="keywordflow">if</span> (($this-&gt;is_MB &amp;&amp; in_array($v,$this-&gt;available_unifonts)) || 
<a name="l10553"></a>10553         (!$this-&gt;is_MB &amp;&amp; in_array($v,$this-&gt;available_fonts)) || in_array($v, array(<span class="stringliteral">&#39;sjis&#39;</span>,<span class="stringliteral">&#39;uhc&#39;</span>,<span class="stringliteral">&#39;big5&#39;</span>,<span class="stringliteral">&#39;gb&#39;</span>)) || 
<a name="l10554"></a>10554         in_array($v,$this-&gt;sans_fonts) || in_array($v,$this-&gt;serif_fonts) || in_array($v,$this-&gt;mono_fonts) ) { 
<a name="l10555"></a>10555         $newprop[$k] = $v; 
<a name="l10556"></a>10556       }
<a name="l10557"></a>10557     }
<a name="l10558"></a>10558     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;MARGIN&#39;</span>) {
<a name="l10559"></a>10559       $tmp =  $this-&gt;expand24($v);
<a name="l10560"></a>10560       $newprop[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] = $tmp[<span class="charliteral">&#39;T&#39;</span>];
<a name="l10561"></a>10561       $newprop[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>] = $tmp[<span class="charliteral">&#39;R&#39;</span>];
<a name="l10562"></a>10562       $newprop[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>] = $tmp[<span class="charliteral">&#39;B&#39;</span>];
<a name="l10563"></a>10563       $newprop[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>] = $tmp[<span class="charliteral">&#39;L&#39;</span>];
<a name="l10564"></a>10564     }
<a name="l10565"></a>10565     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;PADDING&#39;</span>) {
<a name="l10566"></a>10566       $tmp =  $this-&gt;expand24($v);
<a name="l10567"></a>10567       $newprop[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>] = $tmp[<span class="charliteral">&#39;T&#39;</span>];
<a name="l10568"></a>10568       $newprop[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>] = $tmp[<span class="charliteral">&#39;R&#39;</span>];
<a name="l10569"></a>10569       $newprop[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>] = $tmp[<span class="charliteral">&#39;B&#39;</span>];
<a name="l10570"></a>10570       $newprop[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>] = $tmp[<span class="charliteral">&#39;L&#39;</span>];
<a name="l10571"></a>10571     }
<a name="l10572"></a>10572     <span class="comment">// mPDF 4.0</span>
<a name="l10573"></a>10573     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER&#39;</span>) {
<a name="l10574"></a>10574       <span class="keywordflow">if</span> ($v == <span class="charliteral">&#39;1&#39;</span>) { $v = <span class="stringliteral">&#39;1px solid #000000&#39;</span>; }
<a name="l10575"></a>10575       <span class="keywordflow">else</span> { $v = $this-&gt;_fix_borderStr($v); }
<a name="l10576"></a>10576       $newprop[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>] = $v;
<a name="l10577"></a>10577       $newprop[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>] = $v;
<a name="l10578"></a>10578       $newprop[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>] = $v;
<a name="l10579"></a>10579       $newprop[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>] = $v;
<a name="l10580"></a>10580     }
<a name="l10581"></a>10581     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-TOP&#39;</span>) {
<a name="l10582"></a>10582       $newprop[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>] = $this-&gt;_fix_borderStr($v);
<a name="l10583"></a>10583     }
<a name="l10584"></a>10584     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>) {
<a name="l10585"></a>10585       $newprop[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>] = $this-&gt;_fix_borderStr($v);
<a name="l10586"></a>10586     }
<a name="l10587"></a>10587     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>) {
<a name="l10588"></a>10588       $newprop[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>] = $this-&gt;_fix_borderStr($v);
<a name="l10589"></a>10589     }
<a name="l10590"></a>10590     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-LEFT&#39;</span>) {
<a name="l10591"></a>10591       $newprop[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>] = $this-&gt;_fix_borderStr($v);
<a name="l10592"></a>10592     }
<a name="l10593"></a>10593     <span class="comment">// mPDF 4.0</span>
<a name="l10594"></a>10594     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-STYLE&#39;</span>) {
<a name="l10595"></a>10595       $e = $this-&gt;expand24($v);
<a name="l10596"></a>10596       $newprop[<span class="stringliteral">&#39;BORDER-TOP-STYLE&#39;</span>] = $e[<span class="charliteral">&#39;T&#39;</span>];
<a name="l10597"></a>10597       $newprop[<span class="stringliteral">&#39;BORDER-RIGHT-STYLE&#39;</span>] = $e[<span class="charliteral">&#39;R&#39;</span>];
<a name="l10598"></a>10598       $newprop[<span class="stringliteral">&#39;BORDER-BOTTOM-STYLE&#39;</span>] = $e[<span class="charliteral">&#39;B&#39;</span>];
<a name="l10599"></a>10599       $newprop[<span class="stringliteral">&#39;BORDER-LEFT-STYLE&#39;</span>] = $e[<span class="charliteral">&#39;L&#39;</span>];
<a name="l10600"></a>10600     }
<a name="l10601"></a>10601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>) {
<a name="l10602"></a>10602       $e = $this-&gt;expand24($v);
<a name="l10603"></a>10603       $newprop[<span class="stringliteral">&#39;BORDER-TOP-WIDTH&#39;</span>] = $e[<span class="charliteral">&#39;T&#39;</span>];
<a name="l10604"></a>10604       $newprop[<span class="stringliteral">&#39;BORDER-RIGHT-WIDTH&#39;</span>] = $e[<span class="charliteral">&#39;R&#39;</span>];
<a name="l10605"></a>10605       $newprop[<span class="stringliteral">&#39;BORDER-BOTTOM-WIDTH&#39;</span>] = $e[<span class="charliteral">&#39;B&#39;</span>];
<a name="l10606"></a>10606       $newprop[<span class="stringliteral">&#39;BORDER-LEFT-WIDTH&#39;</span>] = $e[<span class="charliteral">&#39;L&#39;</span>];
<a name="l10607"></a>10607     }
<a name="l10608"></a>10608     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-COLOR&#39;</span>) {
<a name="l10609"></a>10609       $e = $this-&gt;expand24($v);
<a name="l10610"></a>10610       $newprop[<span class="stringliteral">&#39;BORDER-TOP-COLOR&#39;</span>] = $e[<span class="charliteral">&#39;T&#39;</span>];
<a name="l10611"></a>10611       $newprop[<span class="stringliteral">&#39;BORDER-RIGHT-COLOR&#39;</span>] = $e[<span class="charliteral">&#39;R&#39;</span>];
<a name="l10612"></a>10612       $newprop[<span class="stringliteral">&#39;BORDER-BOTTOM-COLOR&#39;</span>] = $e[<span class="charliteral">&#39;B&#39;</span>];
<a name="l10613"></a>10613       $newprop[<span class="stringliteral">&#39;BORDER-LEFT-COLOR&#39;</span>] = $e[<span class="charliteral">&#39;L&#39;</span>];
<a name="l10614"></a>10614     }
<a name="l10615"></a>10615 
<a name="l10616"></a>10616     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BORDER-SPACING&#39;</span>) {
<a name="l10617"></a>10617       $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($v));
<a name="l10618"></a>10618       <span class="keywordflow">if</span> (count($prop) == 1 ) { 
<a name="l10619"></a>10619         $newprop[<span class="stringliteral">&#39;BORDER-SPACING-H&#39;</span>] = $prop[0];
<a name="l10620"></a>10620         $newprop[<span class="stringliteral">&#39;BORDER-SPACING-V&#39;</span>] = $prop[0];
<a name="l10621"></a>10621       }
<a name="l10622"></a>10622       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($prop) == 2 ) { 
<a name="l10623"></a>10623         $newprop[<span class="stringliteral">&#39;BORDER-SPACING-H&#39;</span>] = $prop[0];
<a name="l10624"></a>10624         $newprop[<span class="stringliteral">&#39;BORDER-SPACING-V&#39;</span>] = $prop[1];
<a name="l10625"></a>10625       }
<a name="l10626"></a>10626     }
<a name="l10627"></a>10627     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;SIZE&#39;</span>) {
<a name="l10628"></a>10628       $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($v));
<a name="l10629"></a>10629       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(auto|portrait|landscape)/&#39;</span>,$prop[0])) {
<a name="l10630"></a>10630         $newprop[<span class="stringliteral">&#39;SIZE&#39;</span>] = strtoupper($prop[0]);
<a name="l10631"></a>10631       }
<a name="l10632"></a>10632       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($prop) == 1 ) {
<a name="l10633"></a>10633         $newprop[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>] = $this-&gt;ConvertSize($prop[0]);
<a name="l10634"></a>10634         $newprop[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>] = $this-&gt;ConvertSize($prop[0]);
<a name="l10635"></a>10635       }
<a name="l10636"></a>10636       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($prop) == 2 ) {
<a name="l10637"></a>10637         $newprop[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>] = $this-&gt;ConvertSize($prop[0]);
<a name="l10638"></a>10638         $newprop[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>] = $this-&gt;ConvertSize($prop[1]);
<a name="l10639"></a>10639       }
<a name="l10640"></a>10640     }
<a name="l10641"></a>10641     <span class="comment">// mPDF 4.2.024</span>
<a name="l10642"></a>10642     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;SHEET-SIZE&#39;</span>) {
<a name="l10643"></a>10643       $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($v));
<a name="l10644"></a>10644       <span class="keywordflow">if</span> (count($prop) == 2 ) {
<a name="l10645"></a>10645         $newprop[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>] = array($this-&gt;ConvertSize($prop[0]), $this-&gt;ConvertSize($prop[1]));
<a name="l10646"></a>10646       }
<a name="l10647"></a>10647       <span class="keywordflow">else</span> {
<a name="l10648"></a>10648         <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&#39;/([0-9a-zA-Z]*)-L/i&#39;</span>,$v,$m)) { <span class="comment">// e.g. A4-L = A$ landscape</span>
<a name="l10649"></a>10649           $ft = $this-&gt;_getPageFormat($m[1]);
<a name="l10650"></a>10650           $format = array($ft[1],$ft[0]);
<a name="l10651"></a>10651         }
<a name="l10652"></a>10652         <span class="keywordflow">else</span> { $format = $this-&gt;_getPageFormat($v); }
<a name="l10653"></a>10653         <span class="keywordflow">if</span> ($format) { $newprop[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>] = array($format[0]/$this-&gt;k, $format[1]/$this-&gt;k); }
<a name="l10654"></a>10654       }
<a name="l10655"></a>10655     }
<a name="l10656"></a>10656     <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l10657"></a>10657     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BACKGROUND&#39;</span>) {
<a name="l10658"></a>10658       $bg = $this-&gt;parseCSSbackground($v);
<a name="l10659"></a>10659       <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;c&#39;</span>]) { $newprop[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>] = $bg[<span class="charliteral">&#39;c&#39;</span>]; }
<a name="l10660"></a>10660       <span class="comment">// mPDF 4.3.002</span>
<a name="l10661"></a>10661       <span class="keywordflow">else</span> { $newprop[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>] = <span class="stringliteral">&#39;transparent&#39;</span>; }  <span class="comment">// mPDF 4.3.002</span>
<a name="l10662"></a>10662       <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;i&#39;</span>]) { 
<a name="l10663"></a>10663         $newprop[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] = $bg[<span class="charliteral">&#39;i&#39;</span>]; 
<a name="l10664"></a>10664         <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;r&#39;</span>]) { $newprop[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>] = $bg[<span class="charliteral">&#39;r&#39;</span>]; }
<a name="l10665"></a>10665         <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;p&#39;</span>]) { $newprop[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>] = $bg[<span class="charliteral">&#39;p&#39;</span>]; }
<a name="l10666"></a>10666       }
<a name="l10667"></a>10667       <span class="keywordflow">else</span> { $newprop[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; } <span class="comment">// mPDF 4.3.002 / 4.3.011</span>
<a name="l10668"></a>10668 
<a name="l10669"></a>10669     }
<a name="l10670"></a>10670     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>) {
<a name="l10671"></a>10671       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/url\([\&#39;\&quot;]{0,1}(.*?)[\&#39;\&quot;]{0,1}\)/i&#39;</span>,$v,$m)) {  <span class="comment">// 4.2.013</span>
<a name="l10672"></a>10672         $newprop[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] = $m[1];
<a name="l10673"></a>10673       }
<a name="l10674"></a>10674       <span class="comment">// mPDF 4.3.011</span>
<a name="l10675"></a>10675       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtolower($v)==<span class="stringliteral">&#39;none&#39;</span>) { $newprop[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l10676"></a>10676     }
<a name="l10677"></a>10677     <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l10678"></a>10678     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>) {
<a name="l10679"></a>10679       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(repeat-x|repeat-y|no-repeat|repeat)/i&#39;</span>,$v,$m)) { 
<a name="l10680"></a>10680         $newprop[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>] = strtolower($m[1]);
<a name="l10681"></a>10681       }
<a name="l10682"></a>10682     }
<a name="l10683"></a>10683     <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l10684"></a>10684     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($k == <span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>) {
<a name="l10685"></a>10685       $s = $v;
<a name="l10686"></a>10686       $bits = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($s));
<a name="l10687"></a>10687       <span class="comment">// These should be Position x1 or x2</span>
<a name="l10688"></a>10688       <span class="keywordflow">if</span> (count($bits)==1) {
<a name="l10689"></a>10689         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/bottom/&#39;</span>,$bits[0])) { $bg[<span class="charliteral">&#39;p&#39;</span>] = <span class="stringliteral">&#39;50% 100%&#39;</span>; }
<a name="l10690"></a>10690         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/top/&#39;</span>,$bits[0])) { $bg[<span class="charliteral">&#39;p&#39;</span>] = <span class="stringliteral">&#39;50% 0%&#39;</span>; }
<a name="l10691"></a>10691         <span class="keywordflow">else</span> { $bg[<span class="charliteral">&#39;p&#39;</span>] = $bits[0] . <span class="stringliteral">&#39; 50%&#39;</span>; }
<a name="l10692"></a>10692       }
<a name="l10693"></a>10693       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($bits)==2) {
<a name="l10694"></a>10694         <span class="comment">// Can be either right center or center right</span>
<a name="l10695"></a>10695         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(top|bottom)/&#39;</span>,$bits[0]) || preg_match(<span class="stringliteral">&#39;/(left|right)/&#39;</span>,$bits[1])) { 
<a name="l10696"></a>10696           $bg[<span class="charliteral">&#39;p&#39;</span>] = $bits[1] . <span class="charliteral">&#39; &#39;</span>.$bits[0]; 
<a name="l10697"></a>10697         }
<a name="l10698"></a>10698         <span class="keywordflow">else</span> { 
<a name="l10699"></a>10699           $bg[<span class="charliteral">&#39;p&#39;</span>] = $bits[0] . <span class="charliteral">&#39; &#39;</span>.$bits[1]; 
<a name="l10700"></a>10700         }
<a name="l10701"></a>10701       }
<a name="l10702"></a>10702       <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;p&#39;</span>]) {
<a name="l10703"></a>10703         $bg[<span class="charliteral">&#39;p&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/(left|top)/&#39;</span>,<span class="stringliteral">&#39;0%&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l10704"></a>10704         $bg[<span class="charliteral">&#39;p&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/(right|bottom)/&#39;</span>,<span class="stringliteral">&#39;100%&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l10705"></a>10705         $bg[<span class="charliteral">&#39;p&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/(center)/&#39;</span>,<span class="stringliteral">&#39;50%&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l10706"></a>10706         <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;/[\-]{0,1}\d+(in|cm|mm|pt|pc|em|ex|px|%)* [\-]{0,1}\d+(in|cm|mm|pt|pc|em|ex|px|%)*/&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l10707"></a>10707           $bg[<span class="charliteral">&#39;p&#39;</span>] = <span class="keyword">false</span>;
<a name="l10708"></a>10708         }
<a name="l10709"></a>10709       }
<a name="l10710"></a>10710       <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;p&#39;</span>]) { $newprop[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>] = $bg[<span class="charliteral">&#39;p&#39;</span>]; }
<a name="l10711"></a>10711     }
<a name="l10712"></a>10712     <span class="keywordflow">else</span> { 
<a name="l10713"></a>10713       $newprop[$k] = $v; 
<a name="l10714"></a>10714     }
<a name="l10715"></a>10715   }
<a name="l10716"></a>10716   <span class="comment">// mPDF 4.0</span>
<a name="l10717"></a>10717 <span class="comment">//  $this-&gt;_mergeBorders($newprop,$newprop);</span>
<a name="l10718"></a>10718   <span class="keywordflow">return</span> $newprop;
<a name="l10719"></a>10719 }
<a name="l10720"></a>10720 
<a name="l10721"></a>10721 
<a name="l10722"></a>10722 <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l10723"></a>10723 function parseCSSbackground($s) {
<a name="l10724"></a>10724   <span class="comment">// $s = strtolower($s);   // mPDF 4.2.013</span>
<a name="l10725"></a>10725   $bg = array(<span class="charliteral">&#39;c&#39;</span>=&gt;<span class="keyword">false</span>, <span class="charliteral">&#39;i&#39;</span>=&gt;<span class="keyword">false</span>, <span class="charliteral">&#39;r&#39;</span>=&gt;<span class="keyword">false</span>, <span class="charliteral">&#39;p&#39;</span>=&gt;<span class="keyword">false</span>, );
<a name="l10726"></a>10726   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/url\(/i&#39;</span>,$s)) {  <span class="comment">// mPDF 4.2.013</span>
<a name="l10727"></a>10727     <span class="comment">// If color, set and strip it off</span>
<a name="l10728"></a>10728     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^\s*(#[0-9a-fA-F]{3,6}|rgb\(.*?\)|[a-zA-Z]{3,})\s+(url\(.*)/i&#39;</span>,$s,$m)) {   <span class="comment">// mPDF 4.2.013</span>
<a name="l10729"></a>10729       $bg[<span class="charliteral">&#39;c&#39;</span>] = strtolower($m[1]);   <span class="comment">// mPDF 4.2.013</span>
<a name="l10730"></a>10730       $s = $m[2];
<a name="l10731"></a>10731     }
<a name="l10732"></a>10732     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/url\([\&#39;\&quot;]{0,1}(.*?)[\&#39;\&quot;]{0,1}\)\s*(.*)/i&#39;</span>,$s,$m)) {   <span class="comment">// mPDF 4.2.013</span>
<a name="l10733"></a>10733       $bg[<span class="charliteral">&#39;i&#39;</span>] = $m[1];
<a name="l10734"></a>10734       $s = strtolower($m[2]); <span class="comment">// mPDF 4.2.013</span>
<a name="l10735"></a>10735       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(repeat-x|repeat-y|no-repeat|repeat)/&#39;</span>,$s,$m)) { 
<a name="l10736"></a>10736         $bg[<span class="charliteral">&#39;r&#39;</span>] = $m[1];
<a name="l10737"></a>10737       }
<a name="l10738"></a>10738       <span class="comment">// Remove repeat, attachment (discarded) and also any inherit</span>
<a name="l10739"></a>10739       $s = preg_replace(<span class="stringliteral">&#39;/(repeat-x|repeat-y|no-repeat|repeat|scroll|fixed|inherit)/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$s);
<a name="l10740"></a>10740       $bits = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($s));
<a name="l10741"></a>10741       <span class="comment">// These should be Position x1 or x2</span>
<a name="l10742"></a>10742       <span class="keywordflow">if</span> (count($bits)==1) {
<a name="l10743"></a>10743         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/bottom/&#39;</span>,$bits[0])) { $bg[<span class="charliteral">&#39;p&#39;</span>] = <span class="stringliteral">&#39;50% 100%&#39;</span>; }
<a name="l10744"></a>10744         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/top/&#39;</span>,$bits[0])) { $bg[<span class="charliteral">&#39;p&#39;</span>] = <span class="stringliteral">&#39;50% 0%&#39;</span>; }
<a name="l10745"></a>10745         <span class="keywordflow">else</span> { $bg[<span class="charliteral">&#39;p&#39;</span>] = $bits[0] . <span class="stringliteral">&#39; 50%&#39;</span>; }
<a name="l10746"></a>10746       }
<a name="l10747"></a>10747       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($bits)==2) {
<a name="l10748"></a>10748         <span class="comment">// Can be either right center or center right</span>
<a name="l10749"></a>10749         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(top|bottom)/&#39;</span>,$bits[0]) || preg_match(<span class="stringliteral">&#39;/(left|right)/&#39;</span>,$bits[1])) { 
<a name="l10750"></a>10750           $bg[<span class="charliteral">&#39;p&#39;</span>] = $bits[1] . <span class="charliteral">&#39; &#39;</span>.$bits[0]; 
<a name="l10751"></a>10751         }
<a name="l10752"></a>10752         <span class="keywordflow">else</span> { 
<a name="l10753"></a>10753           $bg[<span class="charliteral">&#39;p&#39;</span>] = $bits[0] . <span class="charliteral">&#39; &#39;</span>.$bits[1]; 
<a name="l10754"></a>10754         }
<a name="l10755"></a>10755       }
<a name="l10756"></a>10756       <span class="keywordflow">if</span> ($bg[<span class="charliteral">&#39;p&#39;</span>]) {
<a name="l10757"></a>10757         $bg[<span class="charliteral">&#39;p&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/(left|top)/&#39;</span>,<span class="stringliteral">&#39;0%&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l10758"></a>10758         $bg[<span class="charliteral">&#39;p&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/(right|bottom)/&#39;</span>,<span class="stringliteral">&#39;100%&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l10759"></a>10759         $bg[<span class="charliteral">&#39;p&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/(center)/&#39;</span>,<span class="stringliteral">&#39;50%&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l10760"></a>10760         <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;/[\-]{0,1}\d+(in|cm|mm|pt|pc|em|ex|px|%)* [\-]{0,1}\d+(in|cm|mm|pt|pc|em|ex|px|%)*/&#39;</span>,$bg[<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l10761"></a>10761           $bg[<span class="charliteral">&#39;p&#39;</span>] = <span class="keyword">false</span>;
<a name="l10762"></a>10762         }
<a name="l10763"></a>10763       }
<a name="l10764"></a>10764     }
<a name="l10765"></a>10765   }
<a name="l10766"></a>10766   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^\s*(#[0-9a-fA-F]{3,6}|rgb\(.*?\)|[a-zA-Z]{3,})/i&#39;</span>,$s,$m)) { $bg[<span class="charliteral">&#39;c&#39;</span>] = strtolower($m[1]); }  <span class="comment">// mPDF 4.2.013</span>
<a name="l10767"></a>10767   <span class="keywordflow">return</span> ($bg);
<a name="l10768"></a>10768 }
<a name="l10769"></a>10769 
<a name="l10770"></a>10770 
<a name="l10771"></a>10771 function expand24($mp) {
<a name="l10772"></a>10772   $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($mp));
<a name="l10773"></a>10773   <span class="keywordflow">if</span> (count($prop) == 1 ) { 
<a name="l10774"></a>10774     <span class="keywordflow">return</span> array(<span class="charliteral">&#39;T&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;R&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;B&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;L&#39;</span>=&gt; $prop[0]);
<a name="l10775"></a>10775   }
<a name="l10776"></a>10776   <span class="keywordflow">if</span> (count($prop) == 2 ) { 
<a name="l10777"></a>10777     <span class="keywordflow">return</span> array(<span class="charliteral">&#39;T&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;R&#39;</span> =&gt; $prop[1], <span class="charliteral">&#39;B&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;L&#39;</span>=&gt; $prop[1]);
<a name="l10778"></a>10778   }
<a name="l10779"></a>10779   <span class="comment">// mPDF 4.0</span>
<a name="l10780"></a>10780   <span class="keywordflow">if</span> (count($prop) == 3 ) { 
<a name="l10781"></a>10781     <span class="keywordflow">return</span> array(<span class="charliteral">&#39;T&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;R&#39;</span> =&gt; $prop[1], <span class="charliteral">&#39;B&#39;</span> =&gt; $prop[2], <span class="charliteral">&#39;L&#39;</span>=&gt; $prop[1]);
<a name="l10782"></a>10782   }
<a name="l10783"></a>10783   <span class="keywordflow">if</span> (count($prop) == 4 ) { 
<a name="l10784"></a>10784     <span class="keywordflow">return</span> array(<span class="charliteral">&#39;T&#39;</span> =&gt; $prop[0], <span class="charliteral">&#39;R&#39;</span> =&gt; $prop[1], <span class="charliteral">&#39;B&#39;</span> =&gt; $prop[2], <span class="charliteral">&#39;L&#39;</span>=&gt; $prop[3]);
<a name="l10785"></a>10785   }
<a name="l10786"></a>10786   <span class="keywordflow">return</span> array(); 
<a name="l10787"></a>10787 }
<a name="l10788"></a>10788 
<a name="l10789"></a>10789 
<a name="l10790"></a>10790 <span class="comment">// mPDF 4.2</span>
<a name="l10791"></a>10791 <span class="comment">// Return either a number (factor) - based on current set fontsize (if % or em) - or exact lineheight (with &#39;mm&#39; after it)</span>
<a name="l10792"></a>10792 function fixLineheight($v) {
<a name="l10793"></a>10793   $lh = <span class="keyword">false</span>;
<a name="l10794"></a>10794   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^[0-9\.,]*$/&#39;</span>,$v) &amp;&amp; $v &gt;= 0) { <span class="keywordflow">return</span> ($v + 0); }
<a name="l10795"></a>10795   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($v) == <span class="stringliteral">&#39;NORMAL&#39;</span>) { 
<a name="l10796"></a>10796     <span class="keywordflow">return</span> $this-&gt;normalLineheight; 
<a name="l10797"></a>10797   }
<a name="l10798"></a>10798   <span class="keywordflow">else</span> { 
<a name="l10799"></a>10799     $tlh = $this-&gt;ConvertSize($v,$this-&gt;FontSize,$this-&gt;FontSize,<span class="keyword">true</span>); 
<a name="l10800"></a>10800     <span class="keywordflow">if</span> ($tlh) { <span class="keywordflow">return</span> ($tlh.<span class="stringliteral">&#39;mm&#39;</span>); }
<a name="l10801"></a>10801   }
<a name="l10802"></a>10802   <span class="keywordflow">return</span> $this-&gt;normalLineheight;
<a name="l10803"></a>10803 }
<a name="l10804"></a>10804 
<a name="l10805"></a>10805 
<a name="l10806"></a>10806 
<a name="l10807"></a>10807 function setBorderDominance($prop, $val) {
<a name="l10808"></a>10808   <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]) &amp;&amp; $prop[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]) { $this-&gt;cell_border_dominance_L = $val; }
<a name="l10809"></a>10809   <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]) &amp;&amp; $prop[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]) { $this-&gt;cell_border_dominance_R = $val; }
<a name="l10810"></a>10810   <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]) &amp;&amp; $prop[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]) { $this-&gt;cell_border_dominance_T = $val; }
<a name="l10811"></a>10811   <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]) &amp;&amp; $prop[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]) { $this-&gt;cell_border_dominance_B = $val; }
<a name="l10812"></a>10812 }
<a name="l10813"></a>10813 
<a name="l10814"></a>10814 <span class="comment">// mPDF 4.0</span>
<a name="l10815"></a>10815 function _mergeCSS(&amp;$p, &amp;$t) {
<a name="l10816"></a>10816   <span class="comment">// Save Cascading CSS e.g. &quot;div.topic p&quot; at this block level</span>
<a name="l10817"></a>10817   <span class="keywordflow">if</span> (isset($p) &amp;&amp; $p) {
<a name="l10818"></a>10818     $carry = $p;
<a name="l10819"></a>10819     <span class="keywordflow">if</span> ($t) { 
<a name="l10820"></a>10820       $t = $this-&gt;array_merge_recursive_unique($t, $carry); 
<a name="l10821"></a>10821     }
<a name="l10822"></a>10822       <span class="keywordflow">else</span> { $t = $carry; }
<a name="l10823"></a>10823   }
<a name="l10824"></a>10824 }
<a name="l10825"></a>10825 
<a name="l10826"></a>10826 <span class="comment">// for CSS handling</span>
<a name="l10827"></a>10827 function array_merge_recursive_unique($array1, $array2) {
<a name="l10828"></a>10828     $arrays = func_get_args();
<a name="l10829"></a>10829     $narrays = count($arrays);
<a name="l10830"></a>10830     $ret = $arrays[0];
<a name="l10831"></a>10831     <span class="keywordflow">for</span> ($i = 1; $i &lt; $narrays; $i ++) {
<a name="l10832"></a>10832         <span class="keywordflow">foreach</span> ($arrays[$i] as $key =&gt; $value) {
<a name="l10833"></a>10833             <span class="keywordflow">if</span> (((<span class="keywordtype">string</span>) $key) === ((<span class="keywordtype">string</span>) intval($key))) { <span class="comment">// integer or string as integer key - append</span>
<a name="l10834"></a>10834                 $ret[] = $value;
<a name="l10835"></a>10835             }
<a name="l10836"></a>10836             <span class="keywordflow">else</span> { <span class="comment">// string key - merge</span>
<a name="l10837"></a>10837                 <span class="keywordflow">if</span> (is_array($value) &amp;&amp; isset($ret[$key])) {
<a name="l10838"></a>10838                     $ret[$key] = $this-&gt;array_merge_recursive_unique($ret[$key], $value);
<a name="l10839"></a>10839                 }
<a name="l10840"></a>10840                 <span class="keywordflow">else</span> {
<a name="l10841"></a>10841                     $ret[$key] = $value;
<a name="l10842"></a>10842                 }
<a name="l10843"></a>10843             }
<a name="l10844"></a>10844         }   
<a name="l10845"></a>10845     }
<a name="l10846"></a>10846     <span class="keywordflow">return</span> $ret;
<a name="l10847"></a>10847 }
<a name="l10848"></a>10848 
<a name="l10849"></a>10849 
<a name="l10850"></a>10850 <span class="comment">// mPDF 4.0</span>
<a name="l10851"></a>10851 function _mergeFullCSS(&amp;$p, &amp;$t, $tag, $classes, $id) {
<a name="l10852"></a>10852     $this-&gt;_mergeCSS($p[$tag], $t);
<a name="l10853"></a>10853     <span class="comment">// STYLESHEET CLASS e.g. .smallone{}  .redletter{}</span>
<a name="l10854"></a>10854     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l10855"></a>10855       $this-&gt;_mergeCSS($p[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class], $t);
<a name="l10856"></a>10856     }
<a name="l10857"></a>10857     <span class="comment">// STYLESHEET CLASS e.g. #smallone{}  #redletter{}</span>
<a name="l10858"></a>10858     <span class="keywordflow">if</span> (isset($id)) {
<a name="l10859"></a>10859       $this-&gt;_mergeCSS($p[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$id], $t);
<a name="l10860"></a>10860     }
<a name="l10861"></a>10861     <span class="comment">// STYLESHEET CLASS e.g. .smallone{}  .redletter{}</span>
<a name="l10862"></a>10862     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l10863"></a>10863       $this-&gt;_mergeCSS($p[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class], $t);
<a name="l10864"></a>10864     }
<a name="l10865"></a>10865     <span class="comment">// STYLESHEET CLASS e.g. #smallone{}  #redletter{}</span>
<a name="l10866"></a>10866     <span class="keywordflow">if</span> (isset($id)) {
<a name="l10867"></a>10867       $this-&gt;_mergeCSS($p[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$id], $t);
<a name="l10868"></a>10868     }
<a name="l10869"></a>10869 }
<a name="l10870"></a>10870 
<a name="l10871"></a>10871 <span class="comment">// mPDF 4.0</span>
<a name="l10872"></a>10872 function _set_mergedCSS(&amp;$m, &amp;$p, $d=<span class="keyword">true</span>, $bd=<span class="keyword">false</span>) {
<a name="l10873"></a>10873   <span class="keywordflow">if</span> (isset($m)) {
<a name="l10874"></a>10874     <span class="keywordflow">if</span> ((isset($m[<span class="stringliteral">&#39;depth&#39;</span>]) &amp;&amp; $m[<span class="stringliteral">&#39;depth&#39;</span>]&gt;1) || $d==<span class="keyword">false</span>) {   <span class="comment">// include check for &#39;depth&#39;</span>
<a name="l10875"></a>10875       <span class="keywordflow">if</span> ($bd) { $this-&gt;setBorderDominance($m, $bd); }  <span class="comment">// *TABLES*</span>
<a name="l10876"></a>10876       <span class="keywordflow">if</span> (is_array($m)) { 
<a name="l10877"></a>10877         $p = array_merge($p,$m); 
<a name="l10878"></a>10878         $this-&gt;_mergeBorders($p,$m);  <span class="comment">// mPDF 4.0</span>
<a name="l10879"></a>10879       }
<a name="l10880"></a>10880     }
<a name="l10881"></a>10881   }
<a name="l10882"></a>10882 }
<a name="l10883"></a>10883 
<a name="l10884"></a>10884 <span class="comment">// mPDF 4.0</span>
<a name="l10885"></a>10885 function _mergeBorders(&amp;$b, &amp;$a) {  <span class="comment">// Merges $a[&#39;BORDER-TOP-STYLE&#39;] to $b[&#39;BORDER-TOP&#39;] etc.</span>
<a name="l10886"></a>10886   <span class="keywordflow">foreach</span>(array(<span class="stringliteral">&#39;TOP&#39;</span>,<span class="stringliteral">&#39;RIGHT&#39;</span>,<span class="stringliteral">&#39;BOTTOM&#39;</span>,<span class="stringliteral">&#39;LEFT&#39;</span>) AS $side) {
<a name="l10887"></a>10887     <span class="keywordflow">foreach</span>(array(<span class="stringliteral">&#39;STYLE&#39;</span>,<span class="stringliteral">&#39;WIDTH&#39;</span>,<span class="stringliteral">&#39;COLOR&#39;</span>) AS $el) {
<a name="l10888"></a>10888   <span class="keywordflow">if</span> (isset($a[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side.<span class="charliteral">&#39;-&#39;</span>.$el])) { <span class="comment">// e.g. $b[&#39;BORDER-TOP-STYLE&#39;]</span>
<a name="l10889"></a>10889     $s = trim($a[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side.<span class="charliteral">&#39;-&#39;</span>.$el]);
<a name="l10890"></a>10890     <span class="keywordflow">if</span> (isset($b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side])) { <span class="comment">// e.g. $b[&#39;BORDER-TOP&#39;]</span>
<a name="l10891"></a>10891       $p = trim($b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side]);
<a name="l10892"></a>10892     }
<a name="l10893"></a>10893     <span class="keywordflow">else</span> { $p = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l10894"></a>10894     <span class="keywordflow">if</span> ($el==<span class="stringliteral">&#39;STYLE&#39;</span>) {
<a name="l10895"></a>10895       <span class="keywordflow">if</span> ($p) { $b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side] = preg_replace(<span class="stringliteral">&#39;/(\S+)\s+(\S+)\s+(\S+)/&#39;</span>, <span class="stringliteral">&#39;\\1 &#39;</span>.$s.<span class="stringliteral">&#39; \\3&#39;</span>, $p); }
<a name="l10896"></a>10896       <span class="keywordflow">else</span> { $b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side] = <span class="stringliteral">&#39;0px &#39;</span>.$s.<span class="stringliteral">&#39; #000000&#39;</span>; }
<a name="l10897"></a>10897     }
<a name="l10898"></a>10898     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($el==<span class="stringliteral">&#39;WIDTH&#39;</span>) {
<a name="l10899"></a>10899       <span class="keywordflow">if</span> ($p) { $b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side] = preg_replace(<span class="stringliteral">&#39;/(\S+)\s+(\S+)\s+(\S+)/&#39;</span>, $s.<span class="stringliteral">&#39; \\2 \\3&#39;</span>, $p); }
<a name="l10900"></a>10900       <span class="keywordflow">else</span> { $b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side] = $s.<span class="stringliteral">&#39; none #000000&#39;</span>; }
<a name="l10901"></a>10901     }
<a name="l10902"></a>10902     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($el==<span class="stringliteral">&#39;COLOR&#39;</span>) {
<a name="l10903"></a>10903       <span class="keywordflow">if</span> ($p) { $b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side] = preg_replace(<span class="stringliteral">&#39;/(\S+)\s+(\S+)\s+(\S+)/&#39;</span>, <span class="stringliteral">&#39;\\1 \\2 &#39;</span>.$s, $p); }
<a name="l10904"></a>10904       <span class="keywordflow">else</span> { $b[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side] = <span class="stringliteral">&#39;0px none &#39;</span>.$s; }
<a name="l10905"></a>10905     }
<a name="l10906"></a>10906     unset($a[<span class="stringliteral">&#39;BORDER-&#39;</span>.$side.<span class="charliteral">&#39;-&#39;</span>.$el]);
<a name="l10907"></a>10907   }
<a name="l10908"></a>10908     }
<a name="l10909"></a>10909   }
<a name="l10910"></a>10910 }
<a name="l10911"></a>10911 
<a name="l10912"></a>10912 
<a name="l10913"></a>10913 function MergeCSS($inherit,$tag,$attr) {
<a name="l10914"></a>10914   $p = array();
<a name="l10915"></a>10915   $zp = array(); 
<a name="l10916"></a>10916 
<a name="l10917"></a>10917   $classes = array();
<a name="l10918"></a>10918   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CLASS&#39;</span>])) {
<a name="l10919"></a>10919     $classes = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$attr[<span class="stringliteral">&#39;CLASS&#39;</span>]);
<a name="l10920"></a>10920   }
<a name="l10921"></a>10921   <span class="comment">//===============================================</span>
<a name="l10922"></a>10922   <span class="comment">// Set Inherited properties</span>
<a name="l10923"></a>10923   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPTABLE&#39;</span>) { <span class="comment">// $tag = TABLE</span>
<a name="l10924"></a>10924     <span class="comment">//===============================================</span>
<a name="l10925"></a>10925     <span class="comment">// Save Cascading CSS e.g. &quot;div.topic p&quot; at this block level</span>
<a name="l10926"></a>10926 
<a name="l10927"></a>10927     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>])) {
<a name="l10928"></a>10928       $this-&gt;tablecascadeCSS[0] = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>];
<a name="l10929"></a>10929     }
<a name="l10930"></a>10930     <span class="keywordflow">else</span> {
<a name="l10931"></a>10931       $this-&gt;tablecascadeCSS[0] = $this-&gt;cascadeCSS;
<a name="l10932"></a>10932     }
<a name="l10933"></a>10933   }
<a name="l10934"></a>10934   <span class="comment">//===============================================</span>
<a name="l10935"></a>10935   <span class="comment">// Set Inherited properties</span>
<a name="l10936"></a>10936   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPTABLE&#39;</span> || $inherit == <span class="stringliteral">&#39;TABLE&#39;</span>) {
<a name="l10937"></a>10937     <span class="comment">//Cascade everything from last level that is not an actual property, or defined by current tag/attributes</span>
<a name="l10938"></a>10938     <span class="keywordflow">if</span> (isset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1]) &amp;&amp; is_array($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1])) {
<a name="l10939"></a>10939        <span class="keywordflow">foreach</span>($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1] AS $k=&gt;$v) {
<a name="l10940"></a>10940 <span class="comment">//      if ($k != $tag &amp;&amp; !preg_match(&#39;/^CLASS&gt;&gt;(&#39;.implode(&#39;|&#39;,$classes).&#39;)$/i&#39;,$k) &amp;&amp; !preg_match(&#39;/^&#39;.$tag.&#39;&gt;&gt;CLASS&gt;&gt;(&#39;.implode(&#39;|&#39;,$classes).&#39;)$/i&#39;,$k) &amp;&amp; $k != &#39;ID&gt;&gt;&#39;.$attr[&#39;ID&#39;] &amp;&amp; $k != $tag.&#39;&gt;&gt;ID&gt;&gt;&#39;.$attr[&#39;ID&#39;] &amp;&amp; (preg_match(&#39;/(ID|CLASS)&gt;&gt;/&#39;,$k) || preg_match(&#39;/^(&#39;.$this-&gt;allowedCSStags.&#39;)(&gt;&gt;.*){0,1}$/&#39;,$k))) {</span>
<a name="l10941"></a>10941         $this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl][$k] = $v;
<a name="l10942"></a>10942 <span class="comment">//      }</span>
<a name="l10943"></a>10943        }
<a name="l10944"></a>10944     }
<a name="l10945"></a>10945     <span class="comment">// mPDF 4.0</span>
<a name="l10946"></a>10946     $this-&gt;_mergeFullCSS($this-&gt;cascadeCSS, $this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl], $tag, $classes, $attr[<span class="stringliteral">&#39;ID&#39;</span>]);
<a name="l10947"></a>10947     <span class="comment">//===============================================</span>
<a name="l10948"></a>10948     <span class="comment">// Cascading forward CSS e.g. &quot;table.topic td&quot; for this table in $this-&gt;tablecascadeCSS </span>
<a name="l10949"></a>10949     <span class="comment">//===============================================</span>
<a name="l10950"></a>10950     <span class="comment">// STYLESHEET TAG e.g. table</span>
<a name="l10951"></a>10951     <span class="comment">// mPDF 4.0</span>
<a name="l10952"></a>10952     $this-&gt;_mergeFullCSS($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1], $this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl], $tag, $classes, $attr[<span class="stringliteral">&#39;ID&#39;</span>]);
<a name="l10953"></a>10953     <span class="comment">//===============================================</span>
<a name="l10954"></a>10954   }
<a name="l10955"></a>10955   <span class="comment">//===============================================</span>
<a name="l10956"></a>10956   <span class="comment">// Set Inherited properties</span>
<a name="l10957"></a>10957   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPLIST&#39;</span>) {  <span class="comment">// $tag = UL,OL</span>
<a name="l10958"></a>10958     <span class="comment">//===============================================</span>
<a name="l10959"></a>10959     <span class="comment">// Save Cascading CSS e.g. &quot;div.topic p&quot; at this block level</span>
<a name="l10960"></a>10960     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>])) {
<a name="l10961"></a>10961       $this-&gt;listcascadeCSS[0] = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>];
<a name="l10962"></a>10962     }
<a name="l10963"></a>10963     <span class="keywordflow">else</span> {
<a name="l10964"></a>10964       $this-&gt;listcascadeCSS[0] = $this-&gt;cascadeCSS;
<a name="l10965"></a>10965     }
<a name="l10966"></a>10966   }
<a name="l10967"></a>10967   <span class="comment">//===============================================</span>
<a name="l10968"></a>10968   <span class="comment">// Set Inherited properties</span>
<a name="l10969"></a>10969   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPLIST&#39;</span> || $inherit == <span class="stringliteral">&#39;LIST&#39;</span>) {
<a name="l10970"></a>10970     <span class="comment">//Cascade everything from last level that is not an actual property, or defined by current tag/attributes</span>
<a name="l10971"></a>10971     <span class="keywordflow">if</span> (isset($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1]) &amp;&amp; is_array($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1])) {
<a name="l10972"></a>10972        <span class="keywordflow">foreach</span>($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1] AS $k=&gt;$v) {
<a name="l10973"></a>10973         $this-&gt;listcascadeCSS[$this-&gt;listCSSlvl][$k] = $v;
<a name="l10974"></a>10974        }
<a name="l10975"></a>10975     }
<a name="l10976"></a>10976     <span class="comment">// mPDF 4.0</span>
<a name="l10977"></a>10977     $this-&gt;_mergeFullCSS($this-&gt;cascadeCSS, $this-&gt;listcascadeCSS[$this-&gt;listCSSlvl], $tag, $classes, $attr[<span class="stringliteral">&#39;ID&#39;</span>]);
<a name="l10978"></a>10978     <span class="comment">//===============================================</span>
<a name="l10979"></a>10979     <span class="comment">// Cascading forward CSS e.g. &quot;table.topic td&quot; for this list in $this-&gt;listcascadeCSS </span>
<a name="l10980"></a>10980     <span class="comment">//===============================================</span>
<a name="l10981"></a>10981     <span class="comment">// STYLESHEET TAG e.g. table</span>
<a name="l10982"></a>10982     <span class="comment">// mPDF 4.0</span>
<a name="l10983"></a>10983     $this-&gt;_mergeFullCSS($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1], $this-&gt;listcascadeCSS[$this-&gt;listCSSlvl], $tag, $classes, $attr[<span class="stringliteral">&#39;ID&#39;</span>]);
<a name="l10984"></a>10984     <span class="comment">//===============================================</span>
<a name="l10985"></a>10985   }
<a name="l10986"></a>10986   <span class="comment">//===============================================</span>
<a name="l10987"></a>10987   <span class="comment">// Set Inherited properties</span>
<a name="l10988"></a>10988   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;BLOCK&#39;</span>) {
<a name="l10989"></a>10989     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>]) &amp;&amp; is_array($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>])) {
<a name="l10990"></a>10990        <span class="keywordflow">foreach</span>($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>] AS $k=&gt;$v) {
<a name="l10991"></a>10991 <span class="comment">//      if ($k != $tag &amp;&amp; !preg_match(&#39;/^CLASS&gt;&gt;(&#39;.implode(&#39;|&#39;,$classes).&#39;)$/i&#39;,$k) &amp;&amp; !preg_match(&#39;/^&#39;.$tag.&#39;&gt;&gt;CLASS&gt;&gt;(&#39;.implode(&#39;|&#39;,$classes).&#39;)$/i&#39;,$k) &amp;&amp; $k != &#39;ID&gt;&gt;&#39;.$attr[&#39;ID&#39;] &amp;&amp; $k != $tag.&#39;&gt;&gt;ID&gt;&gt;&#39;.$attr[&#39;ID&#39;] &amp;&amp; (preg_match(&#39;/(ID|CLASS)&gt;&gt;/&#39;,$k) || preg_match(&#39;/^(&#39;.$this-&gt;allowedCSStags.&#39;)(&gt;&gt;.*){0,1}$/&#39;,$k))) {</span>
<a name="l10992"></a>10992         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$k] = $v;
<a name="l10993"></a>10993 <span class="comment">//      }</span>
<a name="l10994"></a>10994 
<a name="l10995"></a>10995        }
<a name="l10996"></a>10996     }
<a name="l10997"></a>10997 
<a name="l10998"></a>10998     <span class="comment">//===============================================</span>
<a name="l10999"></a>10999     <span class="comment">// Save Cascading CSS e.g. &quot;div.topic p&quot; at this block level</span>
<a name="l11000"></a>11000     <span class="comment">// mPDF 4.0</span>
<a name="l11001"></a>11001     $this-&gt;_mergeFullCSS($this-&gt;cascadeCSS, $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>], $tag, $classes, $attr[<span class="stringliteral">&#39;ID&#39;</span>]);
<a name="l11002"></a>11002     <span class="comment">//===============================================</span>
<a name="l11003"></a>11003     <span class="comment">// Cascading forward CSS</span>
<a name="l11004"></a>11004     <span class="comment">//===============================================</span>
<a name="l11005"></a>11005     <span class="comment">// mPDF 4.0</span>
<a name="l11006"></a>11006     $this-&gt;_mergeFullCSS($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>], $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>], $tag, $classes, $attr[<span class="stringliteral">&#39;ID&#39;</span>]);
<a name="l11007"></a>11007     <span class="comment">//===============================================</span>
<a name="l11008"></a>11008       <span class="comment">// Block properties</span>
<a name="l11009"></a>11009       <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;margin_collapse&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;margin_collapse&#39;</span>]) { $p[<span class="stringliteral">&#39;MARGIN-COLLAPSE&#39;</span>] = <span class="stringliteral">&#39;COLLAPSE&#39;</span>; }  <span class="comment">// custom tag, but follows CSS principle that border-collapse is inherited</span>
<a name="l11010"></a>11010       <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;line_height&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;line_height&#39;</span>]) { $p[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>] = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;line_height&#39;</span>]; }  
<a name="l11011"></a>11011       <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;align&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;align&#39;</span>]) { 
<a name="l11012"></a>11012       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;align&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) { $p[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>] = <span class="stringliteral">&#39;left&#39;</span>; } 
<a name="l11013"></a>11013       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;align&#39;</span>] == <span class="charliteral">&#39;J&#39;</span>) { $p[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>] = <span class="stringliteral">&#39;justify&#39;</span>; } 
<a name="l11014"></a>11014       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;align&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) { $p[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>] = <span class="stringliteral">&#39;right&#39;</span>; } 
<a name="l11015"></a>11015       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;align&#39;</span>] == <span class="charliteral">&#39;C&#39;</span>) { $p[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>] = <span class="stringliteral">&#39;center&#39;</span>; } 
<a name="l11016"></a>11016       }
<a name="l11017"></a>11017       <span class="comment">// mPDF 3.0</span>
<a name="l11018"></a>11018       <span class="keywordflow">if</span> ($this-&gt;ColActive || $this-&gt;keep_block_together) { 
<a name="l11019"></a>11019         <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;bgcolor&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;bgcolor&#39;</span>]) { <span class="comment">// Doesn&#39;t officially inherit, but default value is transparent (?=inherited)</span>
<a name="l11020"></a>11020         $cor = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;bgcolorarray&#39;</span> ];
<a name="l11021"></a>11021         $p[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>] = <span class="stringliteral">&#39;RGB(&#39;</span>.$cor[<span class="charliteral">&#39;R&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;G&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;B&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l11022"></a>11022       }
<a name="l11023"></a>11023       }
<a name="l11024"></a>11024 
<a name="l11025"></a>11025     <span class="comment">// mPDF 4.0</span>
<a name="l11026"></a>11026     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;text_indent&#39;</span>]) &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;text_indent&#39;</span>] || $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;text_indent&#39;</span>]===0)) { $p[<span class="stringliteral">&#39;TEXT-INDENT&#39;</span>] = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;text_indent&#39;</span>]; }
<a name="l11027"></a>11027 
<a name="l11028"></a>11028     <span class="comment">// mPDF 4.0</span>
<a name="l11029"></a>11029     $biilp = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;InlineProperties&#39;</span>];
<a name="l11030"></a>11030     <span class="keywordflow">if</span> (isset($biilp[ <span class="stringliteral">&#39;family&#39;</span> ]) &amp;&amp; $biilp[ <span class="stringliteral">&#39;family&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $biilp[ <span class="stringliteral">&#39;family&#39;</span> ]; }
<a name="l11031"></a>11031     <span class="keywordflow">if</span> (isset($biilp[ <span class="charliteral">&#39;I&#39;</span> ]) &amp;&amp; $biilp[ <span class="charliteral">&#39;I&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>] = <span class="stringliteral">&#39;italic&#39;</span>; }
<a name="l11032"></a>11032     <span class="keywordflow">if</span> (isset($biilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ]) &amp;&amp; $biilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $biilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ] . <span class="stringliteral">&#39;pt&#39;</span>; }
<a name="l11033"></a>11033     <span class="keywordflow">if</span> (isset($biilp[ <span class="charliteral">&#39;B&#39;</span> ]) &amp;&amp; $biilp[ <span class="charliteral">&#39;B&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>] = <span class="stringliteral">&#39;bold&#39;</span>; }
<a name="l11034"></a>11034     <span class="keywordflow">if</span> (isset($biilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ]) &amp;&amp; $biilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ]) { 
<a name="l11035"></a>11035       $cor = $biilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ];
<a name="l11036"></a>11036       $p[<span class="stringliteral">&#39;COLOR&#39;</span>] = <span class="stringliteral">&#39;RGB(&#39;</span>.$cor[<span class="charliteral">&#39;R&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;G&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;B&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l11037"></a>11037     }
<a name="l11038"></a>11038     <span class="keywordflow">if</span> (isset($biilp[ <span class="stringliteral">&#39;toupper&#39;</span> ]) &amp;&amp; $biilp[ <span class="stringliteral">&#39;toupper&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>] = <span class="stringliteral">&#39;uppercase&#39;</span>; }
<a name="l11039"></a>11039     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($biilp[ <span class="stringliteral">&#39;tolower&#39;</span> ]) &amp;&amp; $biilp[ <span class="stringliteral">&#39;tolower&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>] = <span class="stringliteral">&#39;lowercase&#39;</span>; }
<a name="l11040"></a>11040       <span class="comment">// CSS says text-decoration is not inherited, but IE7 does?? </span>
<a name="l11041"></a>11041     <span class="keywordflow">if</span> (isset($biilp[ <span class="stringliteral">&#39;underline&#39;</span> ]) &amp;&amp; $biilp[ <span class="stringliteral">&#39;underline&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-DECORATION&#39;</span>] = <span class="stringliteral">&#39;underline&#39;</span>; }
<a name="l11042"></a>11042 
<a name="l11043"></a>11043   }
<a name="l11044"></a>11044   <span class="comment">//===============================================</span>
<a name="l11045"></a>11045   <span class="comment">//===============================================</span>
<a name="l11046"></a>11046   <span class="comment">// Set Inherited properties</span>
<a name="l11047"></a>11047   <span class="comment">// mPDF 4.2</span>
<a name="l11048"></a>11048   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPLIST&#39;</span>) {
<a name="l11049"></a>11049     <span class="keywordflow">if</span> ($this-&gt;listCSSlvl == 1) {
<a name="l11050"></a>11050         $bilp = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>];
<a name="l11051"></a>11051         <span class="keywordflow">if</span> (isset($bilp[ <span class="stringliteral">&#39;family&#39;</span> ]) &amp;&amp; $bilp[ <span class="stringliteral">&#39;family&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $bilp[ <span class="stringliteral">&#39;family&#39;</span> ]; }
<a name="l11052"></a>11052           <span class="keywordflow">if</span> (isset($bilp[ <span class="charliteral">&#39;I&#39;</span> ]) &amp;&amp; $bilp[ <span class="charliteral">&#39;I&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>] = <span class="stringliteral">&#39;italic&#39;</span>; }
<a name="l11053"></a>11053           <span class="keywordflow">if</span> (isset($bilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ]) &amp;&amp; $bilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $bilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ] . <span class="stringliteral">&#39;pt&#39;</span>; }
<a name="l11054"></a>11054           <span class="keywordflow">if</span> (isset($bilp[ <span class="charliteral">&#39;B&#39;</span> ]) &amp;&amp; $bilp[ <span class="charliteral">&#39;B&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>] = <span class="stringliteral">&#39;bold&#39;</span>; }
<a name="l11055"></a>11055           <span class="keywordflow">if</span> (isset($bilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ]) &amp;&amp; $bilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ]) { 
<a name="l11056"></a>11056       $cor = $bilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ];
<a name="l11057"></a>11057       $p[<span class="stringliteral">&#39;COLOR&#39;</span>] = <span class="stringliteral">&#39;RGB(&#39;</span>.$cor[<span class="charliteral">&#39;R&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;G&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;B&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l11058"></a>11058         }
<a name="l11059"></a>11059         <span class="keywordflow">if</span> (isset($bilp[ <span class="stringliteral">&#39;toupper&#39;</span> ]) &amp;&amp; $bilp[ <span class="stringliteral">&#39;toupper&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>] = <span class="stringliteral">&#39;uppercase&#39;</span>; }
<a name="l11060"></a>11060         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($bilp[ <span class="stringliteral">&#39;tolower&#39;</span> ]) &amp;&amp; $bilp[ <span class="stringliteral">&#39;tolower&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>] = <span class="stringliteral">&#39;lowercase&#39;</span>; }
<a name="l11061"></a>11061       <span class="comment">// CSS says text-decoration is not inherited, but IE7 does??</span>
<a name="l11062"></a>11062         <span class="keywordflow">if</span> (isset($bilp[ <span class="stringliteral">&#39;underline&#39;</span> ]) &amp;&amp; $bilp[ <span class="stringliteral">&#39;underline&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-DECORATION&#39;</span>] = <span class="stringliteral">&#39;underline&#39;</span>; }
<a name="l11063"></a>11063         <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;LI&#39;</span>) { 
<a name="l11064"></a>11064       $lilp = $this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$this-&gt;listlvl][$this-&gt;listoccur[$this-&gt;listlvl]];
<a name="l11065"></a>11065       <span class="keywordflow">if</span> (isset($lilp[ <span class="stringliteral">&#39;family&#39;</span> ]) &amp;&amp; $lilp[ <span class="stringliteral">&#39;family&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $lilp[ <span class="stringliteral">&#39;family&#39;</span> ]; }
<a name="l11066"></a>11066         <span class="keywordflow">if</span> (isset($lilp[ <span class="charliteral">&#39;I&#39;</span> ]) &amp;&amp; $lilp[ <span class="charliteral">&#39;I&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>] = <span class="stringliteral">&#39;italic&#39;</span>; }
<a name="l11067"></a>11067         <span class="keywordflow">if</span> (isset($lilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ]) &amp;&amp; $lilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $lilp[ <span class="stringliteral">&#39;sizePt&#39;</span> ] . <span class="stringliteral">&#39;pt&#39;</span>; }
<a name="l11068"></a>11068         <span class="keywordflow">if</span> (isset($lilp[ <span class="charliteral">&#39;B&#39;</span> ]) &amp;&amp; $lilp[ <span class="charliteral">&#39;B&#39;</span> ]) { $p[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>] = <span class="stringliteral">&#39;bold&#39;</span>; }
<a name="l11069"></a>11069         <span class="keywordflow">if</span> (isset($lilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ]) &amp;&amp; $lilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ]) { 
<a name="l11070"></a>11070         $cor = $lilp[ <span class="stringliteral">&#39;colorarray&#39;</span> ];
<a name="l11071"></a>11071         $p[<span class="stringliteral">&#39;COLOR&#39;</span>] = <span class="stringliteral">&#39;RGB(&#39;</span>.$cor[<span class="charliteral">&#39;R&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;G&#39;</span>].<span class="charliteral">&#39;,&#39;</span>.$cor[<span class="charliteral">&#39;B&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l11072"></a>11072       }
<a name="l11073"></a>11073       <span class="keywordflow">if</span> (isset($lilp[ <span class="stringliteral">&#39;toupper&#39;</span> ]) &amp;&amp; $lilp[ <span class="stringliteral">&#39;toupper&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>] = <span class="stringliteral">&#39;uppercase&#39;</span>; }
<a name="l11074"></a>11074       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($lilp[ <span class="stringliteral">&#39;tolower&#39;</span> ]) &amp;&amp; $lilp[ <span class="stringliteral">&#39;tolower&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>] = <span class="stringliteral">&#39;lowercase&#39;</span>; }
<a name="l11075"></a>11075       <span class="comment">// CSS says text-decoration is not inherited, but IE7 does?? </span>
<a name="l11076"></a>11076       <span class="keywordflow">if</span> (isset($lilp[ <span class="stringliteral">&#39;underline&#39;</span> ]) &amp;&amp; $lilp[ <span class="stringliteral">&#39;underline&#39;</span> ]) { $p[<span class="stringliteral">&#39;TEXT-DECORATION&#39;</span>] = <span class="stringliteral">&#39;underline&#39;</span>; }
<a name="l11077"></a>11077         }
<a name="l11078"></a>11078     }
<a name="l11079"></a>11079   }
<a name="l11080"></a>11080   <span class="comment">//===============================================</span>
<a name="l11081"></a>11081   <span class="comment">//===============================================</span>
<a name="l11082"></a>11082   <span class="comment">// DEFAULT for this TAG set in DefaultCSS</span>
<a name="l11083"></a>11083   <span class="keywordflow">if</span> (isset($this-&gt;defaultCSS[$tag])) { 
<a name="l11084"></a>11084       $zp = $this-&gt;fixCSS($this-&gt;defaultCSS[$tag]);
<a name="l11085"></a>11085       <span class="keywordflow">if</span> (is_array($zp)) {  <span class="comment">// Default overwrites Inherited</span>
<a name="l11086"></a>11086         $p = array_merge($p,$zp);   <span class="comment">// !! Note other way round !!</span>
<a name="l11087"></a>11087         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11088"></a>11088       }
<a name="l11089"></a>11089   }
<a name="l11090"></a>11090   <span class="comment">//===============================================</span>
<a name="l11091"></a>11091   <span class="comment">// mPDF 4.0 cellPadding overwrites TD/TH default but not specific CSS set on cell</span>
<a name="l11092"></a>11092   <span class="keywordflow">if</span> (($tag==<span class="stringliteral">&#39;TD&#39;</span> || $tag==<span class="stringliteral">&#39;TH&#39;</span>) &amp;&amp; $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cell_padding&#39;</span>]) { 
<a name="l11093"></a>11093     $p[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>] = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cell_padding&#39;</span>];
<a name="l11094"></a>11094     $p[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>] = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cell_padding&#39;</span>];
<a name="l11095"></a>11095     $p[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>] = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cell_padding&#39;</span>];
<a name="l11096"></a>11096     $p[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>] = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cell_padding&#39;</span>];
<a name="l11097"></a>11097   }
<a name="l11098"></a>11098   <span class="comment">//===============================================</span>
<a name="l11099"></a>11099   <span class="comment">// STYLESHEET TAG e.g. h1  p  div  table</span>
<a name="l11100"></a>11100   <span class="keywordflow">if</span> (isset($this-&gt;CSS[$tag]) &amp;&amp; $this-&gt;CSS[$tag]) { 
<a name="l11101"></a>11101       $zp = $this-&gt;CSS[$tag];
<a name="l11102"></a>11102       <span class="keywordflow">if</span> (is_array($zp)) { 
<a name="l11103"></a>11103         <span class="comment">// mPDF 4.0</span>
<a name="l11104"></a>11104         $p = array_merge($p,$zp); 
<a name="l11105"></a>11105         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11106"></a>11106       }
<a name="l11107"></a>11107   }
<a name="l11108"></a>11108   <span class="comment">//===============================================</span>
<a name="l11109"></a>11109   <span class="comment">// STYLESHEET CLASS e.g. .smallone{}  .redletter{}</span>
<a name="l11110"></a>11110   <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11111"></a>11111       $zp = array();
<a name="l11112"></a>11112       <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class]) &amp;&amp; $this-&gt;CSS[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class]) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class]; }
<a name="l11113"></a>11113       <span class="keywordflow">if</span> (is_array($zp)) { 
<a name="l11114"></a>11114         <span class="comment">// mPDF 4.0</span>
<a name="l11115"></a>11115         $p = array_merge($p,$zp); 
<a name="l11116"></a>11116         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11117"></a>11117       }
<a name="l11118"></a>11118   }
<a name="l11119"></a>11119   <span class="comment">//===============================================</span>
<a name="l11120"></a>11120   <span class="comment">// STYLESHEET ID e.g. #smallone{}  #redletter{}</span>
<a name="l11121"></a>11121   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>]) &amp;&amp; isset($this-&gt;CSS[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]]) &amp;&amp; $this-&gt;CSS[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]]) {
<a name="l11122"></a>11122       $zp = $this-&gt;CSS[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]];
<a name="l11123"></a>11123       <span class="keywordflow">if</span> (is_array($zp)) { 
<a name="l11124"></a>11124         <span class="comment">// mPDF 4.0</span>
<a name="l11125"></a>11125         $p = array_merge($p,$zp); 
<a name="l11126"></a>11126         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11127"></a>11127       }
<a name="l11128"></a>11128   }
<a name="l11129"></a>11129   <span class="comment">//===============================================</span>
<a name="l11130"></a>11130   <span class="comment">// STYLESHEET CLASS e.g. p.smallone{}  div.redletter{}</span>
<a name="l11131"></a>11131   <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11132"></a>11132       $zp = array();
<a name="l11133"></a>11133       <span class="keywordflow">if</span> (isset($this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class]) &amp;&amp; $this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class]) { $zp = $this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class]; }
<a name="l11134"></a>11134       <span class="keywordflow">if</span> (is_array($zp)) { 
<a name="l11135"></a>11135         <span class="comment">// mPDF 4.0</span>
<a name="l11136"></a>11136         $p = array_merge($p,$zp); 
<a name="l11137"></a>11137         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11138"></a>11138       }
<a name="l11139"></a>11139   }
<a name="l11140"></a>11140   <span class="comment">//===============================================</span>
<a name="l11141"></a>11141   <span class="comment">// STYLESHEET CLASS e.g. p#smallone{}  div#redletter{}</span>
<a name="l11142"></a>11142   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>]) &amp;&amp; isset($this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]]) &amp;&amp; $this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]]) {
<a name="l11143"></a>11143       $zp = $this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]];
<a name="l11144"></a>11144       <span class="keywordflow">if</span> (is_array($zp)) { 
<a name="l11145"></a>11145         <span class="comment">// mPDF 4.0</span>
<a name="l11146"></a>11146         $p = array_merge($p,$zp); 
<a name="l11147"></a>11147         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11148"></a>11148       }
<a name="l11149"></a>11149   }
<a name="l11150"></a>11150   <span class="comment">//===============================================</span>
<a name="l11151"></a>11151   <span class="comment">// Cascaded e.g. div.class p only works for block level</span>
<a name="l11152"></a>11152   <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;BLOCK&#39;</span>) {
<a name="l11153"></a>11153     <span class="comment">// mPDF 4.0</span>
<a name="l11154"></a>11154     $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$tag], $p);
<a name="l11155"></a>11155     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11156"></a>11156       $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class], $p);
<a name="l11157"></a>11157     }
<a name="l11158"></a>11158     $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p);
<a name="l11159"></a>11159     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11160"></a>11160       $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class], $p);
<a name="l11161"></a>11161     }
<a name="l11162"></a>11162     $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p);
<a name="l11163"></a>11163   }
<a name="l11164"></a>11164   <span class="comment">// mPDF 4.0</span>
<a name="l11165"></a>11165   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;INLINE&#39;</span>) {
<a name="l11166"></a>11166     <span class="comment">// mPDF 4.0</span>
<a name="l11167"></a>11167     $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$tag], $p);
<a name="l11168"></a>11168     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11169"></a>11169       $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class], $p);
<a name="l11170"></a>11170     }
<a name="l11171"></a>11171     $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p);
<a name="l11172"></a>11172     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11173"></a>11173       $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class], $p);
<a name="l11174"></a>11174     }
<a name="l11175"></a>11175     $this-&gt;_set_mergedCSS($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>][$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p);
<a name="l11176"></a>11176   }
<a name="l11177"></a>11177   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPTABLE&#39;</span> || $inherit == <span class="stringliteral">&#39;TABLE&#39;</span>) { <span class="comment">// NB looks at $this-&gt;tablecascadeCSS-1 for cascading CSS</span>
<a name="l11178"></a>11178     <span class="comment">// false, 9 = don&#39;t check for &#39;depth&#39; and do set border dominance</span>
<a name="l11179"></a>11179     <span class="comment">// mPDF 4.0</span>
<a name="l11180"></a>11180     $this-&gt;_set_mergedCSS($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1][$tag], $p, <span class="keyword">false</span>, 9);
<a name="l11181"></a>11181     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11182"></a>11182       $this-&gt;_set_mergedCSS($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1][<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class], $p, <span class="keyword">false</span>, 9);
<a name="l11183"></a>11183     }
<a name="l11184"></a>11184     $this-&gt;_set_mergedCSS($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1][<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p, <span class="keyword">false</span>, 9);
<a name="l11185"></a>11185     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11186"></a>11186       $this-&gt;_set_mergedCSS($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1][$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class], $p, <span class="keyword">false</span>, 9);
<a name="l11187"></a>11187     }
<a name="l11188"></a>11188     $this-&gt;_set_mergedCSS($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl-1][$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p, <span class="keyword">false</span>, 9);
<a name="l11189"></a>11189   }
<a name="l11190"></a>11190   <span class="comment">//===============================================</span>
<a name="l11191"></a>11191   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($inherit == <span class="stringliteral">&#39;TOPLIST&#39;</span> || $inherit == <span class="stringliteral">&#39;LIST&#39;</span>) { <span class="comment">// NB looks at $this-&gt;listcascadeCSS-1 for cascading CSS</span>
<a name="l11192"></a>11192     <span class="comment">// false = don&#39;t check for &#39;depth&#39; </span>
<a name="l11193"></a>11193     <span class="comment">// mPDF 4.0</span>
<a name="l11194"></a>11194     $this-&gt;_set_mergedCSS($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1][$tag], $p, <span class="keyword">false</span>);
<a name="l11195"></a>11195     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11196"></a>11196       $this-&gt;_set_mergedCSS($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1][<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class], $p, <span class="keyword">false</span>);
<a name="l11197"></a>11197     }
<a name="l11198"></a>11198     $this-&gt;_set_mergedCSS($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1][<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p, <span class="keyword">false</span>);
<a name="l11199"></a>11199     <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11200"></a>11200       $this-&gt;_set_mergedCSS($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1][$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class], $p, <span class="keyword">false</span>);
<a name="l11201"></a>11201     }
<a name="l11202"></a>11202     $this-&gt;_set_mergedCSS($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl-1][$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p, <span class="keyword">false</span>);
<a name="l11203"></a>11203   }
<a name="l11204"></a>11204   <span class="comment">//===============================================</span>
<a name="l11205"></a>11205   <span class="comment">//===============================================</span>
<a name="l11206"></a>11206   <span class="comment">// INLINE STYLE e.g. style=&quot;CSS:property&quot;</span>
<a name="l11207"></a>11207   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;STYLE&#39;</span>])) {
<a name="l11208"></a>11208       $zp = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;STYLE&#39;</span>]);
<a name="l11209"></a>11209       <span class="keywordflow">if</span> (is_array($zp)) { 
<a name="l11210"></a>11210         <span class="comment">// mPDF 4.0</span>
<a name="l11211"></a>11211         $p = array_merge($p,$zp); 
<a name="l11212"></a>11212         $this-&gt;_mergeBorders($p,$zp); <span class="comment">// mPDF 4.0</span>
<a name="l11213"></a>11213       }
<a name="l11214"></a>11214   }
<a name="l11215"></a>11215   <span class="comment">//===============================================</span>
<a name="l11216"></a>11216   <span class="comment">//===============================================</span>
<a name="l11217"></a>11217   <span class="comment">// INLINE ATTRIBUTES e.g. .. ALIGN=&quot;CENTER&quot;&gt;</span>
<a name="l11218"></a>11218   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LANG&#39;</span>]) and $attr[<span class="stringliteral">&#39;LANG&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11219"></a>11219       $p[<span class="stringliteral">&#39;LANG&#39;</span>] = $attr[<span class="stringliteral">&#39;LANG&#39;</span>];
<a name="l11220"></a>11220   }
<a name="l11221"></a>11221   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;COLOR&#39;</span>]) and $attr[<span class="stringliteral">&#39;COLOR&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11222"></a>11222       $p[<span class="stringliteral">&#39;COLOR&#39;</span>] = $attr[<span class="stringliteral">&#39;COLOR&#39;</span>];
<a name="l11223"></a>11223   }
<a name="l11224"></a>11224   <span class="keywordflow">if</span> ($tag != <span class="stringliteral">&#39;INPUT&#39;</span>) {
<a name="l11225"></a>11225     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]) and $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11226"></a>11226       $p[<span class="stringliteral">&#39;WIDTH&#39;</span>] = $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>];
<a name="l11227"></a>11227     }
<a name="l11228"></a>11228     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>]) and $attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11229"></a>11229       $p[<span class="stringliteral">&#39;HEIGHT&#39;</span>] = $attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>];
<a name="l11230"></a>11230     }
<a name="l11231"></a>11231   }
<a name="l11232"></a>11232   <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;FONT&#39;</span>) {
<a name="l11233"></a>11233     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FACE&#39;</span>])) {
<a name="l11234"></a>11234       $p[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $attr[<span class="stringliteral">&#39;FACE&#39;</span>];
<a name="l11235"></a>11235     }
<a name="l11236"></a>11236     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SIZE&#39;</span>]) and $attr[<span class="stringliteral">&#39;SIZE&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11237"></a>11237       $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11238"></a>11238       <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] === <span class="stringliteral">&#39;+1&#39;</span>) { $s = <span class="stringliteral">&#39;120%&#39;</span>; }
<a name="l11239"></a>11239       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] === <span class="stringliteral">&#39;-1&#39;</span>) { $s = <span class="stringliteral">&#39;86%&#39;</span>; }
<a name="l11240"></a>11240       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] === <span class="charliteral">&#39;1&#39;</span>) { $s = <span class="stringliteral">&#39;XX-SMALL&#39;</span>; }
<a name="l11241"></a>11241       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] == <span class="charliteral">&#39;2&#39;</span>) { $s = <span class="stringliteral">&#39;X-SMALL&#39;</span>; }
<a name="l11242"></a>11242       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] == <span class="charliteral">&#39;3&#39;</span>) { $s = <span class="stringliteral">&#39;SMALL&#39;</span>; }
<a name="l11243"></a>11243       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] == <span class="charliteral">&#39;4&#39;</span>) { $s = <span class="stringliteral">&#39;MEDIUM&#39;</span>; }
<a name="l11244"></a>11244       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] == <span class="charliteral">&#39;5&#39;</span>) { $s = <span class="stringliteral">&#39;LARGE&#39;</span>; }
<a name="l11245"></a>11245       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] == <span class="charliteral">&#39;6&#39;</span>) { $s = <span class="stringliteral">&#39;X-LARGE&#39;</span>; }
<a name="l11246"></a>11246       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;SIZE&#39;</span>] == <span class="charliteral">&#39;7&#39;</span>) { $s = <span class="stringliteral">&#39;XX-LARGE&#39;</span>; }
<a name="l11247"></a>11247       <span class="keywordflow">if</span> ($s) $p[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $s;
<a name="l11248"></a>11248     }
<a name="l11249"></a>11249   }
<a name="l11250"></a>11250   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;VALIGN&#39;</span>]) and $attr[<span class="stringliteral">&#39;VALIGN&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11251"></a>11251     $p[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>] = $attr[<span class="stringliteral">&#39;VALIGN&#39;</span>];
<a name="l11252"></a>11252   }
<a name="l11253"></a>11253   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;VSPACE&#39;</span>]) and $attr[<span class="stringliteral">&#39;VSPACE&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11254"></a>11254     $p[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] = $attr[<span class="stringliteral">&#39;VSPACE&#39;</span>];
<a name="l11255"></a>11255     $p[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>] = $attr[<span class="stringliteral">&#39;VSPACE&#39;</span>];
<a name="l11256"></a>11256   }
<a name="l11257"></a>11257   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HSPACE&#39;</span>]) and $attr[<span class="stringliteral">&#39;HSPACE&#39;</span>]!=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11258"></a>11258     $p[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>] = $attr[<span class="stringliteral">&#39;HSPACE&#39;</span>];
<a name="l11259"></a>11259     $p[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>] = $attr[<span class="stringliteral">&#39;HSPACE&#39;</span>];
<a name="l11260"></a>11260   }
<a name="l11261"></a>11261   <span class="comment">//===============================================</span>
<a name="l11262"></a>11262   <span class="keywordflow">return</span> $p;
<a name="l11263"></a>11263 }
<a name="l11264"></a>11264 
<a name="l11265"></a>11265 
<a name="l11266"></a>11266 <span class="comment">// mPDF 4.2</span>
<a name="l11267"></a>11267 function SetPagedMediaCSS($name=<span class="stringliteral">&#39;&#39;</span>, $first, $oddEven) {
<a name="l11268"></a>11268   <span class="keywordflow">if</span> ($oddEven == <span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11269"></a>11269     <span class="keywordflow">if</span> ($this-&gt;directionality==<span class="stringliteral">&#39;rtl&#39;</span>) { $side = <span class="charliteral">&#39;R&#39;</span>; }
<a name="l11270"></a>11270     <span class="keywordflow">else</span> { $side = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l11271"></a>11271   }
<a name="l11272"></a>11272   <span class="keywordflow">else</span>  { 
<a name="l11273"></a>11273     <span class="keywordflow">if</span> ($this-&gt;directionality==<span class="stringliteral">&#39;rtl&#39;</span>) { $side = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l11274"></a>11274     <span class="keywordflow">else</span> { $side = <span class="charliteral">&#39;R&#39;</span>; }
<a name="l11275"></a>11275   }
<a name="l11276"></a>11276   $name = strtoupper($name);
<a name="l11277"></a>11277   $p = array();
<a name="l11278"></a>11278   $p[<span class="stringliteral">&#39;SIZE&#39;</span>] = <span class="stringliteral">&#39;AUTO&#39;</span>;
<a name="l11279"></a>11279 
<a name="l11280"></a>11280   <span class="comment">// Uses mPDF original margins as default</span>
<a name="l11281"></a>11281   $p[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>] = strval($this-&gt;orig_rMargin).<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l11282"></a>11282   $p[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>] = strval($this-&gt;orig_lMargin).<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l11283"></a>11283   $p[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] = strval($this-&gt;orig_tMargin).<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l11284"></a>11284   $p[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>] = strval($this-&gt;orig_bMargin).<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l11285"></a>11285   $p[<span class="stringliteral">&#39;MARGIN-HEADER&#39;</span>] = strval($this-&gt;orig_hMargin).<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l11286"></a>11286   $p[<span class="stringliteral">&#39;MARGIN-FOOTER&#39;</span>] = strval($this-&gt;orig_fMargin).<span class="stringliteral">&#39;mm&#39;</span>;
<a name="l11287"></a>11287 
<a name="l11288"></a>11288   <span class="comment">// Basic page + selector</span>
<a name="l11289"></a>11289   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&#39;</span>])) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&#39;</span>]; }
<a name="l11290"></a>11290   <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11291"></a>11291   <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11292"></a>11292 
<a name="l11293"></a>11293   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]) &amp;&amp; $oddEven==<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11294"></a>11294     $p[<span class="stringliteral">&#39;HEADER&#39;</span>] = $p[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]);
<a name="l11295"></a>11295   }
<a name="l11296"></a>11296   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]) &amp;&amp; $oddEven!=<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11297"></a>11297     $p[<span class="stringliteral">&#39;HEADER&#39;</span>] = $p[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]);
<a name="l11298"></a>11298   }
<a name="l11299"></a>11299   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]) &amp;&amp; $oddEven==<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11300"></a>11300     $p[<span class="stringliteral">&#39;FOOTER&#39;</span>] = $p[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]);
<a name="l11301"></a>11301   }
<a name="l11302"></a>11302   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]) &amp;&amp; $oddEven!=<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11303"></a>11303     $p[<span class="stringliteral">&#39;FOOTER&#39;</span>] = $p[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]);
<a name="l11304"></a>11304   }
<a name="l11305"></a>11305 
<a name="l11306"></a>11306   <span class="comment">// If right/Odd page</span>
<a name="l11307"></a>11307   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;PSEUDO&gt;&gt;RIGHT&#39;</span>]) &amp;&amp; $side==<span class="charliteral">&#39;R&#39;</span>) { 
<a name="l11308"></a>11308     $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;PSEUDO&gt;&gt;RIGHT&#39;</span>]; 
<a name="l11309"></a>11309   }
<a name="l11310"></a>11310   <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11311"></a>11311   <span class="comment">// mPDF 4.2.022 Disallow size or sheet-size on :LEFT or :RIGHT or :FIRST</span>
<a name="l11312"></a>11312   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>]); } 
<a name="l11313"></a>11313   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]); }  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11314"></a>11314   <span class="comment">// Disallow margin-left or -right on :LEFT or :RIGHT</span>
<a name="l11315"></a>11315   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]); } 
<a name="l11316"></a>11316   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]); } 
<a name="l11317"></a>11317   <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11318"></a>11318 
<a name="l11319"></a>11319   <span class="comment">// If left/Even page</span>
<a name="l11320"></a>11320   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;PSEUDO&gt;&gt;LEFT&#39;</span>]) &amp;&amp; $side==<span class="charliteral">&#39;L&#39;</span>) {   <span class="comment">// mPDF 4.2 This had RIGHT in error</span>
<a name="l11321"></a>11321     $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;PSEUDO&gt;&gt;LEFT&#39;</span>]; 
<a name="l11322"></a>11322   }
<a name="l11323"></a>11323   <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11324"></a>11324   <span class="comment">// mPDF 4.2.022 Disallow size or sheet-size on :LEFT or :RIGHT or :FIRST</span>
<a name="l11325"></a>11325   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>]); } 
<a name="l11326"></a>11326   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]); }  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11327"></a>11327   <span class="comment">// Disallow margin-left or -right on :LEFT or :RIGHT</span>
<a name="l11328"></a>11328   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]); } 
<a name="l11329"></a>11329   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]); } 
<a name="l11330"></a>11330   <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp);  }
<a name="l11331"></a>11331 
<a name="l11332"></a>11332   <span class="comment">// If first page</span>
<a name="l11333"></a>11333   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;PSEUDO&gt;&gt;FIRST&#39;</span>]) &amp;&amp; $first) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;PSEUDO&gt;&gt;FIRST&#39;</span>]; }
<a name="l11334"></a>11334   <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11335"></a>11335   <span class="comment">// mPDF 4.2.022 Disallow size or sheet-size on :LEFT or :RIGHT or :FIRST</span>
<a name="l11336"></a>11336   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>]); } 
<a name="l11337"></a>11337   <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]); }  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11338"></a>11338   <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11339"></a>11339 
<a name="l11340"></a>11340   <span class="comment">// If named page</span>
<a name="l11341"></a>11341   <span class="keywordflow">if</span> ($name) {
<a name="l11342"></a>11342     <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name])) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name]; }
<a name="l11343"></a>11343     <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11344"></a>11344     <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11345"></a>11345 
<a name="l11346"></a>11346     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]) &amp;&amp; $oddEven==<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11347"></a>11347       $p[<span class="stringliteral">&#39;HEADER&#39;</span>] = $p[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]);
<a name="l11348"></a>11348     }
<a name="l11349"></a>11349     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]) &amp;&amp; $oddEven!=<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11350"></a>11350       $p[<span class="stringliteral">&#39;HEADER&#39;</span>] = $p[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]);
<a name="l11351"></a>11351     }
<a name="l11352"></a>11352     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]) &amp;&amp; $oddEven==<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11353"></a>11353       $p[<span class="stringliteral">&#39;FOOTER&#39;</span>] = $p[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]);
<a name="l11354"></a>11354     }
<a name="l11355"></a>11355     <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]) &amp;&amp; $oddEven!=<span class="charliteral">&#39;E&#39;</span>) { 
<a name="l11356"></a>11356       $p[<span class="stringliteral">&#39;FOOTER&#39;</span>] = $p[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]; unset($p[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]);
<a name="l11357"></a>11357     }
<a name="l11358"></a>11358 
<a name="l11359"></a>11359     <span class="comment">// If named right/Odd page</span>
<a name="l11360"></a>11360     <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;RIGHT&#39;</span>]) &amp;&amp; $side==<span class="charliteral">&#39;R&#39;</span>) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;RIGHT&#39;</span>]; }
<a name="l11361"></a>11361     <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11362"></a>11362     <span class="comment">// mPDF 4.2.022 Disallow size or sheet-size on :LEFT or :RIGHT or :FIRST</span>
<a name="l11363"></a>11363     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>]); } 
<a name="l11364"></a>11364     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]); }  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11365"></a>11365     <span class="comment">// Disallow margin-left or -right on :LEFT or :RIGHT</span>
<a name="l11366"></a>11366     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]); } 
<a name="l11367"></a>11367     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]); } 
<a name="l11368"></a>11368     <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11369"></a>11369 
<a name="l11370"></a>11370     <span class="comment">// If named left/Even page</span>
<a name="l11371"></a>11371     <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;LEFT&#39;</span>]) &amp;&amp; $side==<span class="charliteral">&#39;L&#39;</span>) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;LEFT&#39;</span>]; }
<a name="l11372"></a>11372     <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11373"></a>11373     <span class="comment">// mPDF 4.2.022 Disallow size or sheet-size on :LEFT or :RIGHT or :FIRST</span>
<a name="l11374"></a>11374     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>]); } 
<a name="l11375"></a>11375     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]); }  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11376"></a>11376     <span class="comment">// Disallow margin-left or -right on :LEFT or :RIGHT</span>
<a name="l11377"></a>11377     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]); } 
<a name="l11378"></a>11378     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]); } 
<a name="l11379"></a>11379     <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11380"></a>11380 
<a name="l11381"></a>11381     <span class="comment">// If named first page</span>
<a name="l11382"></a>11382     <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;FIRST&#39;</span>]) &amp;&amp; $first) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;@PAGE&gt;&gt;NAMED&gt;&gt;&#39;</span>.$name.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;FIRST&#39;</span>]; }
<a name="l11383"></a>11383     <span class="keywordflow">else</span> { $zp = array(); }
<a name="l11384"></a>11384     <span class="comment">// mPDF 4.2.022 Disallow size or sheet-size on :LEFT or :RIGHT or :FIRST</span>
<a name="l11385"></a>11385     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SIZE&#39;</span>]); } 
<a name="l11386"></a>11386     <span class="keywordflow">if</span> (isset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) { unset($zp[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]); }  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11387"></a>11387     <span class="keywordflow">if</span> (is_array($zp) &amp;&amp; !empty($zp)) { $p = array_merge($p,$zp); }
<a name="l11388"></a>11388   }
<a name="l11389"></a>11389 
<a name="l11390"></a>11390   <span class="comment">// mPDF 4.2</span>
<a name="l11391"></a>11391   $orientation = $mgl = $mgr = $mgt = $mgb = $mgh = $mgf = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11392"></a>11392   $header = $footer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11393"></a>11393   $resetpagenum = $pagenumstyle = $suppress = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11394"></a>11394   $marks = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l11395"></a>11395   $bg = array();
<a name="l11396"></a>11396   <span class="comment">// mPDF 4.2.024 </span>
<a name="l11397"></a>11397   $newformat = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11398"></a>11398 
<a name="l11399"></a>11399   <span class="comment">// mPDF 4.2.024 </span>
<a name="l11400"></a>11400   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]) &amp;&amp; is_array($p[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>])) {
<a name="l11401"></a>11401     $newformat = $p[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>];
<a name="l11402"></a>11402     <span class="keywordflow">if</span> ($newformat[0] &gt; $newformat[1]) { <span class="comment">// landscape</span>
<a name="l11403"></a>11403       $newformat = array_reverse($newformat);
<a name="l11404"></a>11404       $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l11405"></a>11405     }
<a name="l11406"></a>11406     <span class="keywordflow">else</span> { $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>] = <span class="charliteral">&#39;P&#39;</span>; }
<a name="l11407"></a>11407     $this-&gt;_setPageSize($newformat, $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]);
<a name="l11408"></a>11408   }
<a name="l11409"></a>11409 
<a name="l11410"></a>11410   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;SIZE&#39;</span>]) &amp;&amp; is_array($p[<span class="stringliteral">&#39;SIZE&#39;</span>]) &amp;&amp; !$newformat) { <span class="comment">// mPDF 4.2.024</span>
<a name="l11411"></a>11411     <span class="keywordflow">if</span> ($p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>] &gt; $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>]) { $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l11412"></a>11412     <span class="keywordflow">else</span> { $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>] = <span class="charliteral">&#39;P&#39;</span>; }
<a name="l11413"></a>11413   }
<a name="l11414"></a>11414   <span class="keywordflow">if</span> (is_array($p[<span class="stringliteral">&#39;SIZE&#39;</span>])) {
<a name="l11415"></a>11415     <span class="keywordflow">if</span> ($p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>] &gt; $this-&gt;fw) { $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>] = $this-&gt;fw; } <span class="comment">// mPD 4.2 use fw not fPt</span>
<a name="l11416"></a>11416     <span class="keywordflow">if</span> ($p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>] &gt; $this-&gt;fh) { $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>] = $this-&gt;fh; }
<a name="l11417"></a>11417     <span class="keywordflow">if</span> (($p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]==$this-&gt;DefOrientation &amp;&amp; !$newformat) || ($newformat &amp;&amp; $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]==<span class="charliteral">&#39;P&#39;</span>)) {  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11418"></a>11418       $outer_width_LR = ($this-&gt;fw - $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>])/2;
<a name="l11419"></a>11419       $outer_width_TB = ($this-&gt;fh - $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>])/2;
<a name="l11420"></a>11420     }
<a name="l11421"></a>11421     <span class="keywordflow">else</span> {
<a name="l11422"></a>11422       $outer_width_LR = ($this-&gt;fh - $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>])/2;
<a name="l11423"></a>11423       $outer_width_TB = ($this-&gt;fw - $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>])/2;
<a name="l11424"></a>11424     }
<a name="l11425"></a>11425     $pgw = $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;W&#39;</span>];
<a name="l11426"></a>11426     $pgh = $p[<span class="stringliteral">&#39;SIZE&#39;</span>][<span class="charliteral">&#39;H&#39;</span>];
<a name="l11427"></a>11427   }
<a name="l11428"></a>11428   <span class="keywordflow">else</span> {  <span class="comment">// AUTO LANDSCAPE PORTRAIT</span>
<a name="l11429"></a>11429     $outer_width_LR = 0;
<a name="l11430"></a>11430     $outer_width_TB = 0;
<a name="l11431"></a>11431     <span class="comment">// mPDF 4.2.024  If new sheet size not specified, set orientation based on page-box</span>
<a name="l11432"></a>11432     <span class="keywordflow">if</span> (!$newformat) {
<a name="l11433"></a>11433       <span class="keywordflow">if</span> (strtoupper($p[<span class="stringliteral">&#39;SIZE&#39;</span>]) == <span class="stringliteral">&#39;AUTO&#39;</span>) { $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]=$this-&gt;DefOrientation; }
<a name="l11434"></a>11434       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($p[<span class="stringliteral">&#39;SIZE&#39;</span>]) == <span class="stringliteral">&#39;LANDSCAPE&#39;</span>) { $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]=<span class="charliteral">&#39;L&#39;</span>; }
<a name="l11435"></a>11435       <span class="keywordflow">else</span> { $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]=<span class="charliteral">&#39;P&#39;</span>; }
<a name="l11436"></a>11436     }
<a name="l11437"></a>11437     <span class="keywordflow">if</span> (($p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]==$this-&gt;DefOrientation &amp;&amp; !$newformat) || ($newformat &amp;&amp; $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]==<span class="charliteral">&#39;P&#39;</span>)) {  <span class="comment">// mPDF 4.2.024 </span>
<a name="l11438"></a>11438       $pgw = $this-&gt;fw;
<a name="l11439"></a>11439       $pgh = $this-&gt;fh;
<a name="l11440"></a>11440     }
<a name="l11441"></a>11441     <span class="keywordflow">else</span> {
<a name="l11442"></a>11442       $pgw = $this-&gt;fh;
<a name="l11443"></a>11443       $pgh = $this-&gt;fw;
<a name="l11444"></a>11444     }
<a name="l11445"></a>11445   }
<a name="l11446"></a>11446 
<a name="l11447"></a>11447   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;HEADER&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;HEADER&#39;</span>]) { $header = $p[<span class="stringliteral">&#39;HEADER&#39;</span>]; }
<a name="l11448"></a>11448   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;FOOTER&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;FOOTER&#39;</span>]) { $footer = $p[<span class="stringliteral">&#39;FOOTER&#39;</span>]; }
<a name="l11449"></a>11449   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]) { $resetpagenum = $p[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]; }
<a name="l11450"></a>11450   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]) { $pagenumstyle = $p[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]; }
<a name="l11451"></a>11451   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]) { $suppress = $p[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]; }
<a name="l11452"></a>11452 
<a name="l11453"></a>11453     <span class="keywordflow">if</span> (strtoupper($p[<span class="stringliteral">&#39;MARKS&#39;</span>]) == <span class="stringliteral">&#39;CROP&#39;</span>) { $marks = <span class="stringliteral">&#39;CROP&#39;</span>; }
<a name="l11454"></a>11454     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($p[<span class="stringliteral">&#39;MARKS&#39;</span>]) == <span class="stringliteral">&#39;CROSS&#39;</span>) { $marks = <span class="stringliteral">&#39;CROSS&#39;</span>; }
<a name="l11455"></a>11455 
<a name="l11456"></a>11456   <span class="comment">// mPDF 3.0</span>
<a name="l11457"></a>11457   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]) { $bg[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]; }
<a name="l11458"></a>11458   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) { $bg[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]; }  <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l11459"></a>11459   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]) { $bg[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]; }  <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l11460"></a>11460   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]) { $bg[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>] = $p[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]; }  <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l11461"></a>11461 
<a name="l11462"></a>11462   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { $mgl = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>],$pgw) + $outer_width_LR; }
<a name="l11463"></a>11463   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { $mgr = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>],$pgw) + $outer_width_LR; }
<a name="l11464"></a>11464   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])) { $mgb = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>],$pgh) + $outer_width_TB; }
<a name="l11465"></a>11465   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])) { $mgt = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$pgh) + $outer_width_TB; }
<a name="l11466"></a>11466   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;MARGIN-HEADER&#39;</span>])) { $mgh = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;MARGIN-HEADER&#39;</span>],$pgh) + $outer_width_TB; }
<a name="l11467"></a>11467   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;MARGIN-FOOTER&#39;</span>])) { $mgf = $this-&gt;ConvertSize($p[<span class="stringliteral">&#39;MARGIN-FOOTER&#39;</span>],$pgh) + $outer_width_TB; }
<a name="l11468"></a>11468 
<a name="l11469"></a>11469   <span class="keywordflow">if</span> (isset($p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]) &amp;&amp; $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]) { $orientation = $p[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]; }
<a name="l11470"></a>11470   $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_LR&#39;</span>] = $outer_width_LR;  <span class="comment">// Used in MARKS:crop etc.</span>
<a name="l11471"></a>11471   $this-&gt;page_box[<span class="stringliteral">&#39;outer_width_TB&#39;</span>] = $outer_width_TB;
<a name="l11472"></a>11472   <span class="comment">// mPDF 4.2</span>
<a name="l11473"></a>11473   <span class="comment">// mPDF 4.2.024 </span>
<a name="l11474"></a>11474   <span class="keywordflow">return</span> array($orientation,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$header,$footer,$bg,$resetpagenum,$pagenumstyle,$suppress,$marks,$newformat);
<a name="l11475"></a>11475 }
<a name="l11476"></a>11476 
<a name="l11477"></a>11477 function PreviewBlockCSS($tag,$attr) {
<a name="l11478"></a>11478   <span class="comment">// Looks ahead from current block level to a new level</span>
<a name="l11479"></a>11479   $p = array();
<a name="l11480"></a>11480   $zp = array(); 
<a name="l11481"></a>11481   $oldcascadeCSS = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;cascadeCSS&#39;</span>];
<a name="l11482"></a>11482   $classes = array();
<a name="l11483"></a>11483   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CLASS&#39;</span>])) { $classes = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$attr[<span class="stringliteral">&#39;CLASS&#39;</span>]); }
<a name="l11484"></a>11484   <span class="comment">//===============================================</span>
<a name="l11485"></a>11485   <span class="comment">// DEFAULT for this TAG set in DefaultCSS</span>
<a name="l11486"></a>11486   <span class="keywordflow">if</span> (isset($this-&gt;defaultCSS[$tag])) { 
<a name="l11487"></a>11487     $zp = $this-&gt;fixCSS($this-&gt;defaultCSS[$tag]);
<a name="l11488"></a>11488     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($zp,$p); }  <span class="comment">// Inherited overwrites default</span>
<a name="l11489"></a>11489   }
<a name="l11490"></a>11490   <span class="comment">// STYLESHEET TAG e.g. h1  p  div  table</span>
<a name="l11491"></a>11491   <span class="keywordflow">if</span> (isset($this-&gt;CSS[$tag])) { 
<a name="l11492"></a>11492     $zp = $this-&gt;CSS[$tag];
<a name="l11493"></a>11493     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($p,$zp); }
<a name="l11494"></a>11494   }
<a name="l11495"></a>11495   <span class="comment">// STYLESHEET CLASS e.g. .smallone{}  .redletter{}</span>
<a name="l11496"></a>11496   <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11497"></a>11497     $zp = array(); 
<a name="l11498"></a>11498     <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class])) { $zp = $this-&gt;CSS[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class]; }
<a name="l11499"></a>11499     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($p,$zp); }
<a name="l11500"></a>11500   }
<a name="l11501"></a>11501   <span class="comment">// STYLESHEET ID e.g. #smallone{}  #redletter{}</span>
<a name="l11502"></a>11502   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>]) &amp;&amp; isset($this-&gt;CSS[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]])) {
<a name="l11503"></a>11503     $zp = $this-&gt;CSS[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]];
<a name="l11504"></a>11504     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($p,$zp); }
<a name="l11505"></a>11505   }
<a name="l11506"></a>11506   <span class="comment">// STYLESHEET CLASS e.g. p.smallone{}  div.redletter{}</span>
<a name="l11507"></a>11507   <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11508"></a>11508     $zp = array(); 
<a name="l11509"></a>11509     <span class="keywordflow">if</span> (isset($this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class])) { $zp = $this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class]; }
<a name="l11510"></a>11510     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($p,$zp); }
<a name="l11511"></a>11511   }
<a name="l11512"></a>11512   <span class="comment">// STYLESHEET CLASS e.g. p#smallone{}  div#redletter{}</span>
<a name="l11513"></a>11513   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>]) &amp;&amp; isset($this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]])) {
<a name="l11514"></a>11514     $zp = $this-&gt;CSS[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]];
<a name="l11515"></a>11515     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($p,$zp); }
<a name="l11516"></a>11516   }
<a name="l11517"></a>11517   <span class="comment">//===============================================</span>
<a name="l11518"></a>11518   <span class="comment">// STYLESHEET TAG e.g. div h1    div p</span>
<a name="l11519"></a>11519   <span class="comment">// mPDF 4.0</span>
<a name="l11520"></a>11520   $this-&gt;_set_mergedCSS($oldcascadeCSS[$tag], $p);
<a name="l11521"></a>11521   <span class="comment">// STYLESHEET CLASS e.g. .smallone{}  .redletter{}</span>
<a name="l11522"></a>11522   <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11523"></a>11523     <span class="comment">// mPDF 4.0</span>
<a name="l11524"></a>11524     $this-&gt;_set_mergedCSS($oldcascadeCSS[<span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$class], $p);
<a name="l11525"></a>11525   }
<a name="l11526"></a>11526   <span class="comment">// STYLESHEET CLASS e.g. #smallone{}  #redletter{}</span>
<a name="l11527"></a>11527   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>])) {
<a name="l11528"></a>11528     <span class="comment">// mPDF 4.0</span>
<a name="l11529"></a>11529     $this-&gt;_set_mergedCSS($oldcascadeCSS[<span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p);
<a name="l11530"></a>11530   }
<a name="l11531"></a>11531   <span class="comment">// STYLESHEET CLASS e.g. div.smallone{}  p.redletter{}</span>
<a name="l11532"></a>11532   <span class="keywordflow">foreach</span>($classes AS $class) {
<a name="l11533"></a>11533     <span class="comment">// mPDF 4.0</span>
<a name="l11534"></a>11534     $this-&gt;_set_mergedCSS($oldcascadeCSS[$tag.<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$class], $p);
<a name="l11535"></a>11535   }
<a name="l11536"></a>11536   <span class="comment">// STYLESHEET CLASS e.g. div#smallone{}  p#redletter{}</span>
<a name="l11537"></a>11537   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>])) {
<a name="l11538"></a>11538     <span class="comment">// mPDF 4.0</span>
<a name="l11539"></a>11539     $this-&gt;_set_mergedCSS($oldcascadeCSS[$tag.<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$attr[<span class="stringliteral">&#39;ID&#39;</span>]], $p);
<a name="l11540"></a>11540   }
<a name="l11541"></a>11541   <span class="comment">//===============================================</span>
<a name="l11542"></a>11542   <span class="comment">// INLINE STYLE e.g. style=&quot;CSS:property&quot;</span>
<a name="l11543"></a>11543   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;STYLE&#39;</span>])) {
<a name="l11544"></a>11544     $zp = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;STYLE&#39;</span>]);
<a name="l11545"></a>11545     <span class="keywordflow">if</span> (is_array($zp)) { $p = array_merge($p,$zp); }
<a name="l11546"></a>11546   }
<a name="l11547"></a>11547   <span class="comment">//===============================================</span>
<a name="l11548"></a>11548   <span class="keywordflow">return</span> $p;
<a name="l11549"></a>11549 }
<a name="l11550"></a>11550 
<a name="l11551"></a>11551 
<a name="l11552"></a>11552 
<a name="l11553"></a>11553 <span class="comment">// Added mPDF 3.0 Float DIV - CLEAR</span>
<a name="l11554"></a>11554 function ClearFloats($clear, $blklvl=0) {
<a name="l11555"></a>11555   list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($blklvl,<span class="keyword">true</span>);
<a name="l11556"></a>11556   $end = $currpos = ($this-&gt;page*1000 + $this-&gt;y);
<a name="l11557"></a>11557   <span class="keywordflow">if</span> ($clear == <span class="stringliteral">&#39;BOTH&#39;</span> &amp;&amp; ($l_exists || $r_exists)) {
<a name="l11558"></a>11558 <span class="comment">// mPDF 4.0   $this-&gt;Reset();</span>
<a name="l11559"></a>11559     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l11560"></a>11560     $end = max($l_max, $r_max, $currpos);
<a name="l11561"></a>11561   }
<a name="l11562"></a>11562   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($clear == <span class="stringliteral">&#39;RIGHT&#39;</span> &amp;&amp; $r_exists) {
<a name="l11563"></a>11563 <span class="comment">// mPDF 4.0   $this-&gt;Reset();</span>
<a name="l11564"></a>11564     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l11565"></a>11565     $end = max($r_max, $currpos);
<a name="l11566"></a>11566   }
<a name="l11567"></a>11567   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($clear == <span class="stringliteral">&#39;LEFT&#39;</span> &amp;&amp; $l_exists ) {
<a name="l11568"></a>11568 <span class="comment">// mPDF 4.0   $this-&gt;Reset();</span>
<a name="l11569"></a>11569     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l11570"></a>11570     $end = max($l_max, $currpos);
<a name="l11571"></a>11571   }
<a name="l11572"></a>11572   <span class="keywordflow">else</span> { <span class="keywordflow">return</span>; }
<a name="l11573"></a>11573   $old_page = $this-&gt;page;
<a name="l11574"></a>11574   $new_page = intval($end/1000);
<a name="l11575"></a>11575   <span class="keywordflow">if</span> ($old_page != $new_page) {
<a name="l11576"></a>11576     $s = $this-&gt;PrintPageBackgrounds();
<a name="l11577"></a>11577     <span class="comment">// Writes after the marker so not overwritten later by page background etc.</span>
<a name="l11578"></a>11578     $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l11579"></a>11579     $this-&gt;pageBackgrounds = array();
<a name="l11580"></a>11580     $this-&gt;page = $new_page;
<a name="l11581"></a>11581   }
<a name="l11582"></a>11582   $this-&gt;ResetMargins();
<a name="l11583"></a>11583 <span class="comment">// mPDF 4.0 $this-&gt;Reset();</span>
<a name="l11584"></a>11584   $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l11585"></a>11585   $this-&gt;y = (($end*1000) % 1000000)/1000;  <span class="comment">// mod changes operands to integers before processing</span>
<a name="l11586"></a>11586 }
<a name="l11587"></a>11587 
<a name="l11588"></a>11588 
<a name="l11589"></a>11589 <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l11590"></a>11590 function GetFloatDivInfo($blklvl=0,$clear=<span class="keyword">false</span>) {
<a name="l11591"></a>11591   <span class="comment">// If blklvl specified, only returns floats at that level - for ClearFloats</span>
<a name="l11592"></a>11592   $l_exists = <span class="keyword">false</span>;
<a name="l11593"></a>11593   $r_exists = <span class="keyword">false</span>;
<a name="l11594"></a>11594   $l_max = 0;
<a name="l11595"></a>11595   $r_max = 0;
<a name="l11596"></a>11596   $l_width = 0;
<a name="l11597"></a>11597   $r_width = 0;
<a name="l11598"></a>11598   <span class="keywordflow">if</span> (count($this-&gt;floatDivs)) {
<a name="l11599"></a>11599     $currpos = ($this-&gt;page*1000 + $this-&gt;y);
<a name="l11600"></a>11600     <span class="keywordflow">foreach</span>($this-&gt;floatDivs AS $f) {
<a name="l11601"></a>11601       <span class="keywordflow">if</span> (($clear &amp;&amp; $f[<span class="stringliteral">&#39;blockContext&#39;</span>] == $this-&gt;blk[$blklvl][<span class="stringliteral">&#39;blockContext&#39;</span>]) || (!$clear &amp;&amp; $currpos &gt;= $f[<span class="stringliteral">&#39;startpos&#39;</span>] &amp;&amp; $currpos &lt; ($f[<span class="stringliteral">&#39;endpos&#39;</span>]-0.001) &amp;&amp; $f[<span class="stringliteral">&#39;blklvl&#39;</span>] &gt; $blklvl &amp;&amp; $f[<span class="stringliteral">&#39;blockContext&#39;</span>] == $this-&gt;blk[$blklvl][<span class="stringliteral">&#39;blockContext&#39;</span>])) {
<a name="l11602"></a>11602     <span class="keywordflow">if</span> ($f[<span class="stringliteral">&#39;side&#39;</span>]==<span class="charliteral">&#39;L&#39;</span>) {
<a name="l11603"></a>11603       $l_exists= <span class="keyword">true</span>;
<a name="l11604"></a>11604       $l_max = max($l_max, $f[<span class="stringliteral">&#39;endpos&#39;</span>]);
<a name="l11605"></a>11605       $l_width = max($l_width , $f[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l11606"></a>11606     }
<a name="l11607"></a>11607     <span class="keywordflow">if</span> ($f[<span class="stringliteral">&#39;side&#39;</span>]==<span class="charliteral">&#39;R&#39;</span>) {
<a name="l11608"></a>11608       $r_exists= <span class="keyword">true</span>;
<a name="l11609"></a>11609       $r_max = max($r_max, $f[<span class="stringliteral">&#39;endpos&#39;</span>]);
<a name="l11610"></a>11610       $r_width = max($r_width , $f[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l11611"></a>11611     }
<a name="l11612"></a>11612       }
<a name="l11613"></a>11613     }
<a name="l11614"></a>11614   }
<a name="l11615"></a>11615   <span class="keywordflow">return</span> array($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width);
<a name="l11616"></a>11616 }
<a name="l11617"></a>11617 
<a name="l11618"></a>11618 
<a name="l11619"></a>11619 
<a name="l11620"></a>11620 
<a name="l11621"></a>11621 function OpenTag($tag,$attr)
<a name="l11622"></a>11622 {
<a name="l11623"></a>11623 
<a name="l11624"></a>11624   <span class="comment">// What this gets: &lt; $tag $attr[&#39;WIDTH&#39;]=&quot;90px&quot; &gt; does not get content here &lt;/closeTag here&gt;</span>
<a name="l11625"></a>11625   <span class="comment">// Correct tags where HTML specifies optional end tags,</span>
<a name="l11626"></a>11626   <span class="comment">// and/or does not allow nesting e.g. P inside P, or </span>
<a name="l11627"></a>11627   <span class="keywordflow">if</span> ($this-&gt;allow_html_optional_endtags) {
<a name="l11628"></a>11628     <span class="keywordflow">if</span> (($tag == <span class="charliteral">&#39;P&#39;</span> || $tag == <span class="stringliteral">&#39;DIV&#39;</span> || $tag == <span class="stringliteral">&#39;H1&#39;</span> || $tag == <span class="stringliteral">&#39;H2&#39;</span> || $tag == <span class="stringliteral">&#39;H3&#39;</span> || $tag == <span class="stringliteral">&#39;H4&#39;</span> || $tag == <span class="stringliteral">&#39;H5&#39;</span> || $tag == <span class="stringliteral">&#39;H6&#39;</span> || $tag == <span class="stringliteral">&#39;UL&#39;</span> || $tag == <span class="stringliteral">&#39;OL&#39;</span> || $tag == <span class="stringliteral">&#39;TABLE&#39;</span> || $tag==<span class="stringliteral">&#39;PRE&#39;</span> || $tag==<span class="stringliteral">&#39;FORM&#39;</span> || $tag==<span class="stringliteral">&#39;ADDRESS&#39;</span> || $tag==<span class="stringliteral">&#39;BLOCKQUOTE&#39;</span> || $tag==<span class="stringliteral">&#39;CENTER&#39;</span> || $tag==<span class="stringliteral">&#39;DL&#39;</span> || $tag == <span class="stringliteral">&#39;HR&#39;</span> ) &amp;&amp; $this-&gt;lastoptionaltag == <span class="charliteral">&#39;P&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11629"></a>11629     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;DD&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;DD&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11630"></a>11630     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;DD&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;DT&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11631"></a>11631     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;DT&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;DD&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11632"></a>11632     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;DT&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;DT&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11633"></a>11633     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;LI&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;LI&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11634"></a>11634     <span class="keywordflow">if</span> (($tag == <span class="stringliteral">&#39;TD&#39;</span> || $tag == <span class="stringliteral">&#39;TH&#39;</span>) &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TD&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); } <span class="comment">// *TABLES*</span>
<a name="l11635"></a>11635     <span class="keywordflow">if</span> (($tag == <span class="stringliteral">&#39;TD&#39;</span> || $tag == <span class="stringliteral">&#39;TH&#39;</span>) &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TH&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); } <span class="comment">// *TABLES*</span>
<a name="l11636"></a>11636     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;TR&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TR&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); } <span class="comment">// *TABLES*</span>
<a name="l11637"></a>11637     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;TR&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TD&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag );  $this-&gt;CloseTag(<span class="stringliteral">&#39;TR&#39;</span>); $this-&gt;CloseTag(<span class="stringliteral">&#39;THEAD&#39;</span>); } <span class="comment">// *TABLES*</span>
<a name="l11638"></a>11638     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;TR&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;TH&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag );  $this-&gt;CloseTag(<span class="stringliteral">&#39;TR&#39;</span>); $this-&gt;CloseTag(<span class="stringliteral">&#39;THEAD&#39;</span>); } <span class="comment">// *TABLES*</span>
<a name="l11639"></a>11639     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;OPTION&#39;</span> &amp;&amp; $this-&gt;lastoptionaltag == <span class="stringliteral">&#39;OPTION&#39;</span>) { $this-&gt;CloseTag($this-&gt;lastoptionaltag ); }
<a name="l11640"></a>11640   }
<a name="l11641"></a>11641 
<a name="l11642"></a>11642   <span class="comment">// mPDF 4.2 Baseline = S</span>
<a name="l11643"></a>11643   $align = array(<span class="stringliteral">&#39;left&#39;</span>=&gt;<span class="charliteral">&#39;L&#39;</span>,<span class="stringliteral">&#39;center&#39;</span>=&gt;<span class="charliteral">&#39;C&#39;</span>,<span class="stringliteral">&#39;right&#39;</span>=&gt;<span class="charliteral">&#39;R&#39;</span>,<span class="stringliteral">&#39;top&#39;</span>=&gt;<span class="charliteral">&#39;T&#39;</span>,<span class="stringliteral">&#39;text-top&#39;</span>=&gt;<span class="stringliteral">&#39;TT&#39;</span>,<span class="stringliteral">&#39;middle&#39;</span>=&gt;<span class="charliteral">&#39;M&#39;</span>,<span class="stringliteral">&#39;baseline&#39;</span>=&gt;<span class="stringliteral">&#39;BS&#39;</span>,<span class="stringliteral">&#39;bottom&#39;</span>=&gt;<span class="charliteral">&#39;B&#39;</span>,<span class="stringliteral">&#39;text-bottom&#39;</span>=&gt;<span class="stringliteral">&#39;TB&#39;</span>,<span class="stringliteral">&#39;justify&#39;</span>=&gt;<span class="charliteral">&#39;J&#39;</span>);
<a name="l11644"></a>11644 
<a name="l11645"></a>11645   $this-&gt;ignorefollowingspaces=<span class="keyword">false</span>;
<a name="l11646"></a>11646 
<a name="l11647"></a>11647   <span class="comment">//Opening tag</span>
<a name="l11648"></a>11648   <span class="keywordflow">switch</span>($tag){
<a name="l11649"></a>11649 
<a name="l11650"></a>11650      <span class="comment">// mPDF 4.2.031</span>
<a name="l11651"></a>11651      <span class="keywordflow">case</span> <span class="stringliteral">&#39;DOTTAB&#39;</span>: 
<a name="l11652"></a>11652   $objattr = array();
<a name="l11653"></a>11653   $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;dottab&#39;</span>;
<a name="l11654"></a>11654   $dots=str_repeat(<span class="charliteral">&#39;.&#39;</span>, 3).<span class="stringliteral">&quot;  &quot;</span>;  <span class="comment">// minimum number of dots</span>
<a name="l11655"></a>11655   $objattr[<span class="stringliteral">&#39;width&#39;</span>] = $this-&gt;GetStringWidth($dots);
<a name="l11656"></a>11656   $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] = 0;
<a name="l11657"></a>11657   $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>] = 0;
<a name="l11658"></a>11658   $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] = 0;
<a name="l11659"></a>11659   $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l11660"></a>11660   $objattr[<span class="stringliteral">&#39;height&#39;</span>] = 0;
<a name="l11661"></a>11661   $objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l11662"></a>11662   $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l11663"></a>11663   $objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l11664"></a>11664   $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l11665"></a>11665   $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=dottab,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l11666"></a>11666   <span class="comment">// Output it to buffers</span>
<a name="l11667"></a>11667   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l11668"></a>11668     <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l11669"></a>11669       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>];
<a name="l11670"></a>11670     }
<a name="l11671"></a>11671     elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l11672"></a>11672       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l11673"></a>11673     }
<a name="l11674"></a>11674     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0 ;<span class="comment">// reset</span>
<a name="l11675"></a>11675     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l11676"></a>11676   }
<a name="l11677"></a>11677   <span class="keywordflow">else</span> {
<a name="l11678"></a>11678     $this-&gt;textbuffer[] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l11679"></a>11679   } <span class="comment">// *TABLES*</span>
<a name="l11680"></a>11680   <span class="keywordflow">break</span>;
<a name="l11681"></a>11681 
<a name="l11682"></a>11682      <span class="keywordflow">case</span> <span class="stringliteral">&#39;PAGEHEADER&#39;</span>: 
<a name="l11683"></a>11683      <span class="keywordflow">case</span> <span class="stringliteral">&#39;PAGEFOOTER&#39;</span>:
<a name="l11684"></a>11684   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l11685"></a>11685   <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) { $pname = $attr[<span class="stringliteral">&#39;NAME&#39;</span>]; }
<a name="l11686"></a>11686   <span class="keywordflow">else</span> { $pname = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l11687"></a>11687 
<a name="l11688"></a>11688     <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;PAGEHEADER&#39;</span>) { $p = &amp;$this-&gt;pageheaders[$pname]; }
<a name="l11689"></a>11689     <span class="keywordflow">else</span> { $p = &amp;$this-&gt;pagefooters[$pname]; }
<a name="l11690"></a>11690 
<a name="l11691"></a>11691     $p[<span class="charliteral">&#39;L&#39;</span>]=array();
<a name="l11692"></a>11692     $p[<span class="charliteral">&#39;C&#39;</span>]=array();
<a name="l11693"></a>11693     $p[<span class="charliteral">&#39;R&#39;</span>]=array();
<a name="l11694"></a>11694     $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l11695"></a>11695     $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l11696"></a>11696     $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l11697"></a>11697 
<a name="l11698"></a>11698     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT-LEFT&#39;</span>])) {
<a name="l11699"></a>11699       $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;content&#39;</span>] = $attr[<span class="stringliteral">&#39;CONTENT-LEFT&#39;</span>];
<a name="l11700"></a>11700     }
<a name="l11701"></a>11701     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT-CENTER&#39;</span>])) {
<a name="l11702"></a>11702       $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;content&#39;</span>] = $attr[<span class="stringliteral">&#39;CONTENT-CENTER&#39;</span>];
<a name="l11703"></a>11703     }
<a name="l11704"></a>11704     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT-RIGHT&#39;</span>])) {
<a name="l11705"></a>11705       $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;content&#39;</span>] = $attr[<span class="stringliteral">&#39;CONTENT-RIGHT&#39;</span>];
<a name="l11706"></a>11706     }
<a name="l11707"></a>11707 
<a name="l11708"></a>11708     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HEADER-STYLE&#39;</span>]) || isset($attr[<span class="stringliteral">&#39;FOOTER-STYLE&#39;</span>])) { <span class="comment">// font-family,size,weight,style,color</span>
<a name="l11709"></a>11709       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;PAGEHEADER&#39;</span>) { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;HEADER-STYLE&#39;</span>]); }
<a name="l11710"></a>11710       <span class="keywordflow">else</span> { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;FOOTER-STYLE&#39;</span>]); }
<a name="l11711"></a>11711       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) { 
<a name="l11712"></a>11712         $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; 
<a name="l11713"></a>11713         $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; 
<a name="l11714"></a>11714         $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; 
<a name="l11715"></a>11715       }
<a name="l11716"></a>11716       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { 
<a name="l11717"></a>11717         $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) * $this-&gt;k; 
<a name="l11718"></a>11718         $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) * $this-&gt;k; 
<a name="l11719"></a>11719         $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) * $this-&gt;k; 
<a name="l11720"></a>11720       }
<a name="l11721"></a>11721       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]==<span class="stringliteral">&#39;BOLD&#39;</span>) { 
<a name="l11722"></a>11722         $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="charliteral">&#39;B&#39;</span>; 
<a name="l11723"></a>11723         $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="charliteral">&#39;B&#39;</span>; 
<a name="l11724"></a>11724         $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="charliteral">&#39;B&#39;</span>; 
<a name="l11725"></a>11725       }
<a name="l11726"></a>11726       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]==<span class="stringliteral">&#39;ITALIC&#39;</span>) { 
<a name="l11727"></a>11727         $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] .= <span class="charliteral">&#39;I&#39;</span>; 
<a name="l11728"></a>11728         $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] .= <span class="charliteral">&#39;I&#39;</span>; 
<a name="l11729"></a>11729         $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] .= <span class="charliteral">&#39;I&#39;</span>; 
<a name="l11730"></a>11730       }
<a name="l11731"></a>11731       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) { 
<a name="l11732"></a>11732         $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>]; 
<a name="l11733"></a>11733         $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>]; 
<a name="l11734"></a>11734         $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>]; 
<a name="l11735"></a>11735       }
<a name="l11736"></a>11736     }
<a name="l11737"></a>11737     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HEADER-STYLE-LEFT&#39;</span>]) || isset($attr[<span class="stringliteral">&#39;FOOTER-STYLE-LEFT&#39;</span>])) {
<a name="l11738"></a>11738       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;PAGEHEADER&#39;</span>) { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;HEADER-STYLE-LEFT&#39;</span>]); }
<a name="l11739"></a>11739       <span class="keywordflow">else</span> { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;FOOTER-STYLE-LEFT&#39;</span>]); }
<a name="l11740"></a>11740       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) { $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; }
<a name="l11741"></a>11741       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) * $this-&gt;k; }
<a name="l11742"></a>11742       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]==<span class="stringliteral">&#39;BOLD&#39;</span>) { $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] =<span class="charliteral">&#39;B&#39;</span>; }
<a name="l11743"></a>11743       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]==<span class="stringliteral">&#39;ITALIC&#39;</span>) { $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] .=<span class="charliteral">&#39;I&#39;</span>; }
<a name="l11744"></a>11744       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) { $p[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>]; }
<a name="l11745"></a>11745     }
<a name="l11746"></a>11746     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HEADER-STYLE-CENTER&#39;</span>]) || isset($attr[<span class="stringliteral">&#39;FOOTER-STYLE-CENTER&#39;</span>])) {
<a name="l11747"></a>11747       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;PAGEHEADER&#39;</span>) { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;HEADER-STYLE-CENTER&#39;</span>]); }
<a name="l11748"></a>11748       <span class="keywordflow">else</span> { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;FOOTER-STYLE-CENTER&#39;</span>]); }
<a name="l11749"></a>11749       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) { $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; }
<a name="l11750"></a>11750       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) * $this-&gt;k; }
<a name="l11751"></a>11751       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]==<span class="stringliteral">&#39;BOLD&#39;</span>) { $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="charliteral">&#39;B&#39;</span>; }
<a name="l11752"></a>11752       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]==<span class="stringliteral">&#39;ITALIC&#39;</span>) { $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] .= <span class="charliteral">&#39;I&#39;</span>; }
<a name="l11753"></a>11753       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) { $p[<span class="charliteral">&#39;C&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>]; }
<a name="l11754"></a>11754     }
<a name="l11755"></a>11755     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HEADER-STYLE-RIGHT&#39;</span>]) || isset($attr[<span class="stringliteral">&#39;FOOTER-STYLE-RIGHT&#39;</span>])) {
<a name="l11756"></a>11756       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;PAGEHEADER&#39;</span>) { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;HEADER-STYLE-RIGHT&#39;</span>]); }
<a name="l11757"></a>11757       <span class="keywordflow">else</span> { $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;FOOTER-STYLE-RIGHT&#39;</span>]); }
<a name="l11758"></a>11758       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) { $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>]; }
<a name="l11759"></a>11759       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) * $this-&gt;k; }
<a name="l11760"></a>11760       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]==<span class="stringliteral">&#39;BOLD&#39;</span>) { $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] = <span class="charliteral">&#39;B&#39;</span>; }
<a name="l11761"></a>11761       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]==<span class="stringliteral">&#39;ITALIC&#39;</span>) { $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>] .= <span class="charliteral">&#39;I&#39;</span>; }
<a name="l11762"></a>11762       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) { $p[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>]; }
<a name="l11763"></a>11763     }
<a name="l11764"></a>11764     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LINE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;LINE&#39;</span>]) {  <span class="comment">// 0|1|on|off</span>
<a name="l11765"></a>11765       <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;LINE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;LINE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>) { $lineset=1; }
<a name="l11766"></a>11766       <span class="keywordflow">else</span> { $lineset=0; }
<a name="l11767"></a>11767       $p[<span class="stringliteral">&#39;line&#39;</span>] = $lineset;
<a name="l11768"></a>11768     }
<a name="l11769"></a>11769   <span class="keywordflow">break</span>;
<a name="l11770"></a>11770 
<a name="l11771"></a>11771 
<a name="l11772"></a>11772      <span class="keywordflow">case</span> <span class="stringliteral">&#39;SETHTMLPAGEHEADER&#39;</span>: 
<a name="l11773"></a>11773      <span class="keywordflow">case</span> <span class="stringliteral">&#39;SETHTMLPAGEFOOTER&#39;</span>:
<a name="l11774"></a>11774   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l11775"></a>11775   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;NAME&#39;</span>]) { $pname = $attr[<span class="stringliteral">&#39;NAME&#39;</span>]; }
<a name="l11776"></a>11776   <span class="keywordflow">else</span> { $pname = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l11777"></a>11777   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;PAGE&#39;</span>]) {  <span class="comment">// O|odd|even|E|ALL|[blank]</span>
<a name="l11778"></a>11778     <span class="keywordflow">if</span> (strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="charliteral">&#39;O&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="stringliteral">&#39;ODD&#39;</span>) { $side=<span class="stringliteral">&#39;odd&#39;</span>; }
<a name="l11779"></a>11779     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="charliteral">&#39;E&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="stringliteral">&#39;EVEN&#39;</span>) { $side=<span class="stringliteral">&#39;even&#39;</span>; }
<a name="l11780"></a>11780     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="stringliteral">&#39;ALL&#39;</span>) { $side=<span class="stringliteral">&#39;both&#39;</span>; }
<a name="l11781"></a>11781     <span class="keywordflow">else</span> { $side=<span class="stringliteral">&#39;odd&#39;</span>; }
<a name="l11782"></a>11782   }
<a name="l11783"></a>11783   <span class="keywordflow">else</span> { $side=<span class="stringliteral">&#39;odd&#39;</span>; }
<a name="l11784"></a>11784   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;VALUE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;VALUE&#39;</span>]) {  <span class="comment">// -1|1|on|off</span>
<a name="l11785"></a>11785     <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>) { $set=1; }
<a name="l11786"></a>11786     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>) { $set=0; }
<a name="l11787"></a>11787     <span class="keywordflow">else</span> { $set=1; }
<a name="l11788"></a>11788   }
<a name="l11789"></a>11789   <span class="keywordflow">else</span> { $set=1; }
<a name="l11790"></a>11790   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SHOW-THIS-PAGE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;SHOW-THIS-PAGE&#39;</span>] &amp;&amp; $tag==<span class="stringliteral">&#39;SETHTMLPAGEHEADER&#39;</span>) { $write = 1; }
<a name="l11791"></a>11791   <span class="keywordflow">else</span> { $write = 0; }
<a name="l11792"></a>11792   <span class="keywordflow">if</span> ($side==<span class="stringliteral">&#39;odd&#39;</span> || $side==<span class="stringliteral">&#39;both&#39;</span>) {
<a name="l11793"></a>11793     <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETHTMLPAGEHEADER&#39;</span>) { $this-&gt;SetHTMLHeader($this-&gt;pageHTMLheaders[$pname],<span class="charliteral">&#39;O&#39;</span>,$write); }
<a name="l11794"></a>11794     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETHTMLPAGEFOOTER&#39;</span>) { $this-&gt;SetHTMLFooter($this-&gt;pageHTMLfooters[$pname],<span class="charliteral">&#39;O&#39;</span>); }
<a name="l11795"></a>11795     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETHTMLPAGEHEADER&#39;</span>) { $this-&gt;SetHTMLHeader(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;O&#39;</span>); }
<a name="l11796"></a>11796     <span class="keywordflow">else</span> { $this-&gt;SetHTMLFooter(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;O&#39;</span>); }
<a name="l11797"></a>11797   }
<a name="l11798"></a>11798   <span class="keywordflow">if</span> ($side==<span class="stringliteral">&#39;even&#39;</span> || $side==<span class="stringliteral">&#39;both&#39;</span>) {
<a name="l11799"></a>11799     <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETHTMLPAGEHEADER&#39;</span>) { $this-&gt;SetHTMLHeader($this-&gt;pageHTMLheaders[$pname],<span class="charliteral">&#39;E&#39;</span>,$write); }
<a name="l11800"></a>11800     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETHTMLPAGEFOOTER&#39;</span>) { $this-&gt;SetHTMLFooter($this-&gt;pageHTMLfooters[$pname],<span class="charliteral">&#39;E&#39;</span>); }
<a name="l11801"></a>11801     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETHTMLPAGEHEADER&#39;</span>) { $this-&gt;SetHTMLHeader(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;E&#39;</span>); }
<a name="l11802"></a>11802     <span class="keywordflow">else</span> { $this-&gt;SetHTMLFooter(<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;E&#39;</span>); }
<a name="l11803"></a>11803   }
<a name="l11804"></a>11804   <span class="keywordflow">break</span>;
<a name="l11805"></a>11805 
<a name="l11806"></a>11806      <span class="keywordflow">case</span> <span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>: 
<a name="l11807"></a>11807      <span class="keywordflow">case</span> <span class="stringliteral">&#39;SETPAGEFOOTER&#39;</span>:
<a name="l11808"></a>11808   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l11809"></a>11809   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;NAME&#39;</span>]) { $pname = $attr[<span class="stringliteral">&#39;NAME&#39;</span>]; }
<a name="l11810"></a>11810   <span class="keywordflow">else</span> { $pname = <span class="stringliteral">&#39;_default&#39;</span>; }
<a name="l11811"></a>11811   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;PAGE&#39;</span>]) {  <span class="comment">// O|odd|even|E|ALL|[blank]</span>
<a name="l11812"></a>11812     <span class="keywordflow">if</span> (strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="charliteral">&#39;O&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="stringliteral">&#39;ODD&#39;</span>) { $side=<span class="stringliteral">&#39;odd&#39;</span>; }
<a name="l11813"></a>11813     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="charliteral">&#39;E&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="stringliteral">&#39;EVEN&#39;</span>) { $side=<span class="stringliteral">&#39;even&#39;</span>; }
<a name="l11814"></a>11814     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($attr[<span class="stringliteral">&#39;PAGE&#39;</span>])==<span class="stringliteral">&#39;ALL&#39;</span>) { $side=<span class="stringliteral">&#39;both&#39;</span>; }
<a name="l11815"></a>11815     <span class="keywordflow">else</span> { $side=<span class="stringliteral">&#39;odd&#39;</span>; }
<a name="l11816"></a>11816   }
<a name="l11817"></a>11817   <span class="keywordflow">else</span> { $side=<span class="stringliteral">&#39;odd&#39;</span>; }
<a name="l11818"></a>11818   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;VALUE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;VALUE&#39;</span>]) {  <span class="comment">// -1|1|on|off</span>
<a name="l11819"></a>11819     <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>) { $set=1; }
<a name="l11820"></a>11820     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>) { $set=0; }
<a name="l11821"></a>11821     <span class="keywordflow">else</span> { $set=1; }
<a name="l11822"></a>11822   }
<a name="l11823"></a>11823   <span class="keywordflow">else</span> { $set=1; }
<a name="l11824"></a>11824   <span class="keywordflow">if</span> ($side==<span class="stringliteral">&#39;odd&#39;</span> || $side==<span class="stringliteral">&#39;both&#39;</span>) {
<a name="l11825"></a>11825     <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pageheaders[$pname]; }
<a name="l11826"></a>11826     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETPAGEFOOTER&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = $this-&gt;pagefooters[$pname]; }
<a name="l11827"></a>11827     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); }
<a name="l11828"></a>11828     <span class="keywordflow">else</span> { $this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>] = array(); }
<a name="l11829"></a>11829     <span class="comment">// mPDF 4.0</span>
<a name="l11830"></a>11830     <span class="keywordflow">if</span> (!$this-&gt;mirrorMargins || ($this-&gt;page)%2!=0) {  <span class="comment">// ODD</span>
<a name="l11831"></a>11831       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) { $this-&gt;_setAutoHeaderHeight($this-&gt;headerDetails[<span class="stringliteral">&#39;odd&#39;</span>],$this-&gt;HTMLHeader); }
<a name="l11832"></a>11832       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETPAGEFOOTER&#39;</span>) { $this-&gt;_setAutoFooterHeight($this-&gt;footerDetails[<span class="stringliteral">&#39;odd&#39;</span>],$this-&gt;HTMLFooter); }
<a name="l11833"></a>11833     }
<a name="l11834"></a>11834   }
<a name="l11835"></a>11835   <span class="keywordflow">if</span> ($side==<span class="stringliteral">&#39;even&#39;</span> || $side==<span class="stringliteral">&#39;both&#39;</span>) {
<a name="l11836"></a>11836     <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $this-&gt;pageheaders[$pname]; }
<a name="l11837"></a>11837     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($set &amp;&amp; $tag==<span class="stringliteral">&#39;SETPAGEFOOTER&#39;</span>) { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = $this-&gt;pagefooters[$pname]; }
<a name="l11838"></a>11838     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) { $this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); }
<a name="l11839"></a>11839     <span class="keywordflow">else</span> { $this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>] = array(); }
<a name="l11840"></a>11840     <span class="comment">// mPDF 4.0</span>
<a name="l11841"></a>11841     <span class="keywordflow">if</span> ($this-&gt;mirrorMargins &amp;&amp; ($this-&gt;page)%2==0) { <span class="comment">// EVEN</span>
<a name="l11842"></a>11842       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) { $this-&gt;_setAutoHeaderHeight($this-&gt;headerDetails[<span class="stringliteral">&#39;even&#39;</span>],$this-&gt;HTMLHeaderE); }
<a name="l11843"></a>11843       <span class="keywordflow">if</span> ($tag==<span class="stringliteral">&#39;SETPAGEFOOTER&#39;</span>) { $this-&gt;_setAutoFooterHeight($this-&gt;footerDetails[<span class="stringliteral">&#39;even&#39;</span>],$this-&gt;HTMLFooterE); }
<a name="l11844"></a>11844     }
<a name="l11845"></a>11845   }
<a name="l11846"></a>11846   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SHOW-THIS-PAGE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;SHOW-THIS-PAGE&#39;</span>] &amp;&amp; $tag==<span class="stringliteral">&#39;SETPAGEHEADER&#39;</span>) {
<a name="l11847"></a>11847     $this-&gt;Header();
<a name="l11848"></a>11848   }
<a name="l11849"></a>11849   <span class="keywordflow">break</span>;
<a name="l11850"></a>11850 
<a name="l11851"></a>11851 
<a name="l11852"></a>11852      <span class="keywordflow">case</span> <span class="stringliteral">&#39;TOC&#39;</span>: <span class="comment">//added custom-tag - set Marker for insertion later of ToC</span>
<a name="l11853"></a>11853   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]) { $tocfontsize = $attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $tocfontsize = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11854"></a>11854   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;FONT&#39;</span>]) { $tocfont = $attr[<span class="stringliteral">&#39;FONT&#39;</span>]; } <span class="keywordflow">else</span> { $tocfont = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11855"></a>11855   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;INDENT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;INDENT&#39;</span>]) { $tocindent = $attr[<span class="stringliteral">&#39;INDENT&#39;</span>]; } <span class="keywordflow">else</span> { $tocindent = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11856"></a>11856   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]) { $resetpagenum = $attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]; } <span class="keywordflow">else</span> { $resetpagenum = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11857"></a>11857   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]) { $pagenumstyle = $attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]; } <span class="keywordflow">else</span> { $pagenumstyle= <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11858"></a>11858   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]) { $suppress = $attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]; } <span class="keywordflow">else</span> { $suppress = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11859"></a>11859   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]) { $toc_orientation = $attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]; } <span class="keywordflow">else</span> { $toc_orientation = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11860"></a>11860   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGING&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;PAGING&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span> || $attr[<span class="stringliteral">&#39;PAGING&#39;</span>]===<span class="charliteral">&#39;0&#39;</span>)) { $paging = <span class="keyword">false</span>; }
<a name="l11861"></a>11861   <span class="keywordflow">else</span> { $paging = <span class="keyword">true</span>; }
<a name="l11862"></a>11862   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LINKS&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;LINKS&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $attr[<span class="stringliteral">&#39;LINKS&#39;</span>]==1)) { $links = <span class="keyword">true</span>; }
<a name="l11863"></a>11863   <span class="keywordflow">else</span> { $links = <span class="keyword">false</span>; }
<a name="l11864"></a>11864   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;NAME&#39;</span>]) { $toc_id = strtolower($attr[<span class="stringliteral">&#39;NAME&#39;</span>]); } <span class="keywordflow">else</span> { $toc_id = 0; }
<a name="l11865"></a>11865   $this-&gt;TOC($tocfont,$tocfontsize,$tocindent,$resetpagenum, $pagenumstyle, $suppress, $toc_orientation, $paging, $links, $toc_id);
<a name="l11866"></a>11866   <span class="keywordflow">break</span>;
<a name="l11867"></a>11867 
<a name="l11868"></a>11868 
<a name="l11869"></a>11869 
<a name="l11870"></a>11870      <span class="keywordflow">case</span> <span class="stringliteral">&#39;TOCPAGEBREAK&#39;</span>: <span class="comment">// custom-tag - set Marker for insertion later of ToC AND adds PAGEBREAK</span>
<a name="l11871"></a>11871   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;NAME&#39;</span>]) { $toc_id = strtolower($attr[<span class="stringliteral">&#39;NAME&#39;</span>]); } <span class="keywordflow">else</span> { $toc_id = 0; }
<a name="l11872"></a>11872   <span class="keywordflow">if</span> ($toc_id) {
<a name="l11873"></a>11873     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfontsize&#39;</span>] = $attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfontsize&#39;</span>] = $this-&gt;default_font_size; }
<a name="l11874"></a>11874     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfont&#39;</span>] = $attr[<span class="stringliteral">&#39;FONT&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfont&#39;</span>] = $this-&gt;default_font; }
<a name="l11875"></a>11875     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;INDENT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;INDENT&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCindent&#39;</span>] = $attr[<span class="stringliteral">&#39;INDENT&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCindent&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11876"></a>11876     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCorientation&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCorientation&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11877"></a>11877     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGING&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;PAGING&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span> || $attr[<span class="stringliteral">&#39;PAGING&#39;</span>]===<span class="charliteral">&#39;0&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCusePaging&#39;</span>] = <span class="keyword">false</span>; }
<a name="l11878"></a>11878     <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCusePaging&#39;</span>] = <span class="keyword">true</span>; }
<a name="l11879"></a>11879     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LINKS&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;LINKS&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $attr[<span class="stringliteral">&#39;LINKS&#39;</span>]==1)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCuseLinking&#39;</span>] = <span class="keyword">true</span>; }
<a name="l11880"></a>11880     <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCuseLinking&#39;</span>] = <span class="keyword">false</span>; }
<a name="l11881"></a>11881 
<a name="l11882"></a>11882     $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_left&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_right&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_top&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_bottom&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_header&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_footer&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11883"></a>11883     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-RIGHT&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_right&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-RIGHT&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11884"></a>11884     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-LEFT&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_left&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-LEFT&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11885"></a>11885     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-TOP&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_top&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-TOP&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11886"></a>11886     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-BOTTOM&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_bottom&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-BOTTOM&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11887"></a>11887     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-HEADER&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_header&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-HEADER&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11888"></a>11888     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-FOOTER&#39;</span>])) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_footer&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-FOOTER&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11889"></a>11889     $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_name&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_name&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_name&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_name&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11890"></a>11890     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-NAME&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_name&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-NAME&#39;</span>]; }
<a name="l11891"></a>11891     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-NAME&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_name&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-NAME&#39;</span>]; }
<a name="l11892"></a>11892     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-NAME&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_name&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-NAME&#39;</span>]; }
<a name="l11893"></a>11893     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-NAME&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_name&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-NAME&#39;</span>]; }
<a name="l11894"></a>11894     $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_value&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_value&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_value&#39;</span>] = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_value&#39;</span>] = 0;
<a name="l11895"></a>11895     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_value&#39;</span>] = 1; }
<a name="l11896"></a>11896     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_value&#39;</span>] = -1; }
<a name="l11897"></a>11897     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_value&#39;</span>] = 1; }
<a name="l11898"></a>11898     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_value&#39;</span>] = -1; }
<a name="l11899"></a>11899     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_value&#39;</span>] = 1; }
<a name="l11900"></a>11900     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_value&#39;</span>] = -1; }
<a name="l11901"></a>11901     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_value&#39;</span>] = 1; }
<a name="l11902"></a>11902     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_value&#39;</span>] = -1; }
<a name="l11903"></a>11903     <span class="comment">// mPDF 4.2</span>
<a name="l11904"></a>11904     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-PAGE-SELECTOR&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-PAGE-SELECTOR&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_page_selector&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-PAGE-SELECTOR&#39;</span>]; }
<a name="l11905"></a>11905     <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_page_selector&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11906"></a>11906     <span class="comment">// mPDF 4.2.04</span>
<a name="l11907"></a>11907     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-SHEET-SIZE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-SHEET-SIZE&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCsheetsize&#39;</span>] = $attr[<span class="stringliteral">&#39;TOC-SHEET-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCsheetsize&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11908"></a>11908 
<a name="l11909"></a>11909 
<a name="l11910"></a>11910     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-PREHTML&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-PREHTML&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpreHTML&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;TOC-PREHTML&#39;</span>],ENT_QUOTES); }
<a name="l11911"></a>11911     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-POSTHTML&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-POSTHTML&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpostHTML&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;TOC-POSTHTML&#39;</span>],ENT_QUOTES); }
<a name="l11912"></a>11912     <span class="comment">// mPDF 3.0</span>
<a name="l11913"></a>11913     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-BOOKMARKTEXT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-BOOKMARKTEXT&#39;</span>]) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCbookmarkText&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;TOC-BOOKMARKTEXT&#39;</span>],ENT_QUOTES); }  <span class="comment">// *BOOKMARKS*</span>
<a name="l11914"></a>11914   }
<a name="l11915"></a>11915   <span class="keywordflow">else</span> {
<a name="l11916"></a>11916     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $this-&gt;TOCfontsize = $attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;TOCfontsize = $this-&gt;default_font_size; }
<a name="l11917"></a>11917     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT&#39;</span>])) { $this-&gt;TOCfont = $attr[<span class="stringliteral">&#39;FONT&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;TOCfont = $this-&gt;default_font; }
<a name="l11918"></a>11918     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;INDENT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;INDENT&#39;</span>]) { $this-&gt;TOCindent = $attr[<span class="stringliteral">&#39;INDENT&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;TOCindent = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11919"></a>11919     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]) { $this-&gt;TOCorientation = $attr[<span class="stringliteral">&#39;TOC-ORIENTATION&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;TOCorientation = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11920"></a>11920     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGING&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;PAGING&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span> || $attr[<span class="stringliteral">&#39;PAGING&#39;</span>]===<span class="charliteral">&#39;0&#39;</span>)) { $this-&gt;TOCusePaging = <span class="keyword">false</span>; }
<a name="l11921"></a>11921     <span class="keywordflow">else</span> { $this-&gt;TOCusePaging = <span class="keyword">true</span>; }
<a name="l11922"></a>11922     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LINKS&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;LINKS&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $attr[<span class="stringliteral">&#39;LINKS&#39;</span>]==1)) { $this-&gt;TOCuseLinking = <span class="keyword">true</span>; }
<a name="l11923"></a>11923     <span class="keywordflow">else</span> { $this-&gt;TOCuseLinking = <span class="keyword">false</span>; }
<a name="l11924"></a>11924 
<a name="l11925"></a>11925     $this-&gt;TOC_margin_left = $this-&gt;TOC_margin_right = $this-&gt;TOC_margin_top = $this-&gt;TOC_margin_bottom = $this-&gt;TOC_margin_header = $this-&gt;TOC_margin_footer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11926"></a>11926     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-RIGHT&#39;</span>])) { $this-&gt;TOC_margin_right = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-RIGHT&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11927"></a>11927     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-LEFT&#39;</span>])) { $this-&gt;TOC_margin_left = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-LEFT&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11928"></a>11928     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-TOP&#39;</span>])) { $this-&gt;TOC_margin_top = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-TOP&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11929"></a>11929     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-BOTTOM&#39;</span>])) { $this-&gt;TOC_margin_bottom = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-BOTTOM&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11930"></a>11930     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-HEADER&#39;</span>])) { $this-&gt;TOC_margin_header = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-HEADER&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11931"></a>11931     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-MARGIN-FOOTER&#39;</span>])) { $this-&gt;TOC_margin_footer = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;TOC-MARGIN-FOOTER&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l11932"></a>11932     $this-&gt;TOC_odd_header_name = $this-&gt;TOC_even_header_name = $this-&gt;TOC_odd_footer_name = $this-&gt;TOC_even_footer_name = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11933"></a>11933     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-NAME&#39;</span>]) { $this-&gt;TOC_odd_header_name = $attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-NAME&#39;</span>]; }
<a name="l11934"></a>11934     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-NAME&#39;</span>]) { $this-&gt;TOC_even_header_name = $attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-NAME&#39;</span>]; }
<a name="l11935"></a>11935     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-NAME&#39;</span>]) { $this-&gt;TOC_odd_footer_name = $attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-NAME&#39;</span>]; }
<a name="l11936"></a>11936     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-NAME&#39;</span>]) { $this-&gt;TOC_even_footer_name = $attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-NAME&#39;</span>]; }
<a name="l11937"></a>11937     $this-&gt;TOC_odd_header_value = $this-&gt;TOC_even_header_value = $this-&gt;TOC_odd_footer_value = $this-&gt;TOC_even_footer_value = 0;
<a name="l11938"></a>11938     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;TOC_odd_header_value = 1; }
<a name="l11939"></a>11939     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;TOC_odd_header_value = -1; }
<a name="l11940"></a>11940     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;TOC_even_header_value = 1; }
<a name="l11941"></a>11941     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;TOC_even_header_value = -1; }
<a name="l11942"></a>11942     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;TOC_odd_footer_value = 1; }
<a name="l11943"></a>11943     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-ODD-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;TOC_odd_footer_value = -1; }
<a name="l11944"></a>11944     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $this-&gt;TOC_even_footer_value = 1; }
<a name="l11945"></a>11945     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;TOC-EVEN-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $this-&gt;TOC_even_footer_value = -1; }
<a name="l11946"></a>11946     <span class="comment">// mPDF 4.2</span>
<a name="l11947"></a>11947     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-PAGE-SELECTOR&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-PAGE-SELECTOR&#39;</span>]) { $this-&gt;TOC_page_selector = $attr[<span class="stringliteral">&#39;TOC-PAGE-SELECTOR&#39;</span>]; }
<a name="l11948"></a>11948     <span class="keywordflow">else</span> { $this-&gt;TOC_page_selector = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11949"></a>11949     <span class="comment">// mPDF 4.2.04</span>
<a name="l11950"></a>11950     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-SHEET-SIZE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-SHEET-SIZE&#39;</span>]) { $this-&gt;TOCsheetsize = $attr[<span class="stringliteral">&#39;TOC-SHEET-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $this-&gt;TOCsheetsize = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l11951"></a>11951 
<a name="l11952"></a>11952 
<a name="l11953"></a>11953     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-PREHTML&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-PREHTML&#39;</span>]) { $this-&gt;TOCpreHTML = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;TOC-PREHTML&#39;</span>],ENT_QUOTES); }
<a name="l11954"></a>11954     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-POSTHTML&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-POSTHTML&#39;</span>]) { $this-&gt;TOCpostHTML = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;TOC-POSTHTML&#39;</span>],ENT_QUOTES); }
<a name="l11955"></a>11955     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TOC-BOOKMARKTEXT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TOC-BOOKMARKTEXT&#39;</span>]) { $this-&gt;TOCbookmarkText = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;TOC-BOOKMARKTEXT&#39;</span>],ENT_QUOTES); }  <span class="comment">// *BOOKMARKS*</span>
<a name="l11956"></a>11956   }
<a name="l11957"></a>11957   <span class="comment">// mPDF 3.0</span>
<a name="l11958"></a>11958   <span class="keywordflow">if</span> ($this-&gt;y == $this-&gt;tMargin &amp;&amp; (!$this-&gt;mirrorMargins ||($this-&gt;mirrorMargins &amp;&amp; $this-&gt;page % 2==1))) { 
<a name="l11959"></a>11959     <span class="keywordflow">if</span> ($toc_id) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCmark&#39;</span>] = $this-&gt;page; }
<a name="l11960"></a>11960     <span class="keywordflow">else</span> { $this-&gt;TOCmark = $this-&gt;page; }
<a name="l11961"></a>11961     <span class="comment">// Don&#39;t add a page</span>
<a name="l11962"></a>11962     <span class="keywordflow">if</span> ($this-&gt;page==1 &amp;&amp; count($this-&gt;PageNumSubstitutions)==0) { 
<a name="l11963"></a>11963       $resetpagenum = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11964"></a>11964       $pagenumstyle = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11965"></a>11965       $suppress = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11966"></a>11966       <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>])) { $resetpagenum = $attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]; }
<a name="l11967"></a>11967       <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>])) { $pagenumstyle = $attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]; }
<a name="l11968"></a>11968       <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>])) { $suppress = $attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]; }
<a name="l11969"></a>11969       <span class="keywordflow">if</span> (!$suppress) { $suppress = <span class="stringliteral">&#39;off&#39;</span>; }
<a name="l11970"></a>11970       <span class="keywordflow">if</span> (!$resetpagenum) { $resetpagenum= 1; }
<a name="l11971"></a>11971       $this-&gt;PageNumSubstitutions[] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;1, <span class="stringliteral">&#39;reset&#39;</span>=&gt; $resetpagenum, <span class="stringliteral">&#39;type&#39;</span>=&gt;$pagenumstyle, <span class="stringliteral">&#39;suppress&#39;</span>=&gt; $suppress);
<a name="l11972"></a>11972     }
<a name="l11973"></a>11973     <span class="keywordflow">break</span>;
<a name="l11974"></a>11974   }
<a name="l11975"></a>11975   <span class="comment">// No break - continues as PAGEBREAK...</span>
<a name="l11976"></a>11976 
<a name="l11977"></a>11977 
<a name="l11978"></a>11978     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PAGE_BREAK&#39;</span>: <span class="comment">//custom-tag</span>
<a name="l11979"></a>11979     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PAGEBREAK&#39;</span>: <span class="comment">//custom-tag</span>
<a name="l11980"></a>11980     <span class="keywordflow">case</span> <span class="stringliteral">&#39;NEWPAGE&#39;</span>: <span class="comment">//custom-tag</span>
<a name="l11981"></a>11981     <span class="keywordflow">case</span> <span class="stringliteral">&#39;FORMFEED&#39;</span>: <span class="comment">//custom-tag</span>
<a name="l11982"></a>11982 
<a name="l11983"></a>11983   $save_blklvl = $this-&gt;blklvl;
<a name="l11984"></a>11984   $save_blk = $this-&gt;blk;
<a name="l11985"></a>11985   $save_silp = $this-&gt;saveInlineProperties();
<a name="l11986"></a>11986   $save_spanlvl = $this-&gt;spanlvl;
<a name="l11987"></a>11987   $save_ilp = $this-&gt;InlineProperties;
<a name="l11988"></a>11988 
<a name="l11989"></a>11989   <span class="comment">// Close any open block tags</span>
<a name="l11990"></a>11990   <span class="keywordflow">for</span> ($b= $this-&gt;blklvl;$b&gt;0;$b--) { $this-&gt;CloseTag($this-&gt;blk[$b][<span class="stringliteral">&#39;tag&#39;</span>]); }
<a name="l11991"></a>11991   <span class="keywordflow">if</span>(!empty($this-&gt;textbuffer))  {  <span class="comment">//Output previously buffered content</span>
<a name="l11992"></a>11992         $this-&gt;printbuffer($this-&gt;textbuffer);
<a name="l11993"></a>11993           $this-&gt;textbuffer=array(); 
<a name="l11994"></a>11994       }
<a name="l11995"></a>11995   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>;
<a name="l11996"></a>11996   $save_cols = <span class="keyword">false</span>;
<a name="l11997"></a>11997 
<a name="l11998"></a>11998   <span class="comment">// mPDF 4.2.024</span>
<a name="l11999"></a>11999   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]) &amp;&amp; $tag != <span class="stringliteral">&#39;FORMFEED&#39;</span> &amp;&amp; !$this-&gt;restoreBlockPageBreaks) { 
<a name="l12000"></a>12000     <span class="comment">// Convert to same types as accepted in initial mPDF() A4, A4-L, or array(w,h)</span>
<a name="l12001"></a>12001     $prop = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($attr[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]));
<a name="l12002"></a>12002     <span class="keywordflow">if</span> (count($prop) == 2 ) {
<a name="l12003"></a>12003       $newformat = array($this-&gt;ConvertSize($prop[0]), $this-&gt;ConvertSize($prop[1]));
<a name="l12004"></a>12004     }
<a name="l12005"></a>12005     <span class="keywordflow">else</span> { $newformat = $attr[<span class="stringliteral">&#39;SHEET-SIZE&#39;</span>]; }
<a name="l12006"></a>12006   }
<a name="l12007"></a>12007   <span class="keywordflow">else</span> { $newformat = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12008"></a>12008 
<a name="l12009"></a>12009 
<a name="l12010"></a>12010   $mgr = $mgl = $mgt = $mgb = $mgh = $mgf = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12011"></a>12011   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { $mgr = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12012"></a>12012   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { $mgl = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12013"></a>12013   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])) { $mgt = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12014"></a>12014   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])) { $mgb = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12015"></a>12015   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;MARGIN-HEADER&#39;</span>])) { $mgh = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;MARGIN-HEADER&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12016"></a>12016   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;MARGIN-FOOTER&#39;</span>])) { $mgf = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;MARGIN-FOOTER&#39;</span>],$this-&gt;w,$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12017"></a>12017   $ohname = $ehname = $ofname = $efname = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12018"></a>12018   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>])) { $ohname = $attr[<span class="stringliteral">&#39;ODD-HEADER-NAME&#39;</span>]; }
<a name="l12019"></a>12019   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>])) { $ehname = $attr[<span class="stringliteral">&#39;EVEN-HEADER-NAME&#39;</span>]; }
<a name="l12020"></a>12020   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>])) { $ofname = $attr[<span class="stringliteral">&#39;ODD-FOOTER-NAME&#39;</span>]; }
<a name="l12021"></a>12021   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>])) { $efname = $attr[<span class="stringliteral">&#39;EVEN-FOOTER-NAME&#39;</span>]; }
<a name="l12022"></a>12022   $ohvalue = $ehvalue = $ofvalue = $efvalue = 0;
<a name="l12023"></a>12023   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ODD-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;ODD-HEADER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;ODD-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $ohvalue = 1; }
<a name="l12024"></a>12024   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ODD-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;ODD-HEADER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;ODD-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $ohvalue = -1; }
<a name="l12025"></a>12025   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;EVEN-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;EVEN-HEADER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;EVEN-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $ehvalue = 1; }
<a name="l12026"></a>12026   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;EVEN-HEADER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;EVEN-HEADER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;EVEN-HEADER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $ehvalue = -1; }
<a name="l12027"></a>12027   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ODD-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;ODD-FOOTER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;ODD-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $ofvalue = 1; }
<a name="l12028"></a>12028   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ODD-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;ODD-FOOTER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;ODD-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $ofvalue = -1; }
<a name="l12029"></a>12029   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;EVEN-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;EVEN-FOOTER-VALUE&#39;</span>]==<span class="charliteral">&#39;1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;EVEN-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span>)) { $efvalue = 1; }
<a name="l12030"></a>12030   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;EVEN-FOOTER-VALUE&#39;</span>]) &amp;&amp; ($attr[<span class="stringliteral">&#39;EVEN-FOOTER-VALUE&#39;</span>]==<span class="stringliteral">&#39;-1&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;EVEN-FOOTER-VALUE&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span>)) { $efvalue = -1; }
<a name="l12031"></a>12031 
<a name="l12032"></a>12032   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;ORIENTATION&#39;</span>])==<span class="charliteral">&#39;L&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;ORIENTATION&#39;</span>])==<span class="stringliteral">&#39;LANDSCAPE&#39;</span>)) { $orient = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l12033"></a>12033   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ORIENTATION&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;ORIENTATION&#39;</span>])==<span class="charliteral">&#39;P&#39;</span> || strtoupper($attr[<span class="stringliteral">&#39;ORIENTATION&#39;</span>])==<span class="stringliteral">&#39;PORTRAIT&#39;</span>)) { $orient = <span class="charliteral">&#39;P&#39;</span>; }
<a name="l12034"></a>12034   <span class="keywordflow">else</span> { $orient = $this-&gt;CurOrientation; }
<a name="l12035"></a>12035 
<a name="l12036"></a>12036   <span class="comment">// mPDF 4.2</span>
<a name="l12037"></a>12037   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGE-SELECTOR&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;PAGE-SELECTOR&#39;</span>]) { $pagesel = $attr[<span class="stringliteral">&#39;PAGE-SELECTOR&#39;</span>]; }
<a name="l12038"></a>12038   <span class="keywordflow">else</span> { $pagesel = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12039"></a>12039 
<a name="l12040"></a>12040   $resetpagenum = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12041"></a>12041   $pagenumstyle = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12042"></a>12042   $suppress = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12043"></a>12043   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>])) { $resetpagenum = $attr[<span class="stringliteral">&#39;RESETPAGENUM&#39;</span>]; }
<a name="l12044"></a>12044   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>])) { $pagenumstyle = $attr[<span class="stringliteral">&#39;PAGENUMSTYLE&#39;</span>]; }
<a name="l12045"></a>12045   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>])) { $suppress = $attr[<span class="stringliteral">&#39;SUPPRESS&#39;</span>]; }
<a name="l12046"></a>12046 
<a name="l12047"></a>12047   <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;TOCPAGEBREAK&#39;</span>) { $type = <span class="stringliteral">&#39;NEXT-ODD&#39;</span>; }
<a name="l12048"></a>12048   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;TYPE&#39;</span>])) { $type = strtoupper($attr[<span class="stringliteral">&#39;TYPE&#39;</span>]); }
<a name="l12049"></a>12049   <span class="keywordflow">else</span> { $type = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12050"></a>12050 
<a name="l12051"></a>12051   <span class="comment">// mPDF 4.2</span>
<a name="l12052"></a>12052   <span class="keywordflow">if</span> ($type == <span class="charliteral">&#39;E&#39;</span> || $type == <span class="stringliteral">&#39;EVEN&#39;</span>) { $this-&gt;AddPage($orient,<span class="charliteral">&#39;E&#39;</span>, $resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$newformat); }
<a name="l12053"></a>12053   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="charliteral">&#39;O&#39;</span> || $type == <span class="stringliteral">&#39;ODD&#39;</span>) { $this-&gt;AddPage($orient,<span class="charliteral">&#39;O&#39;</span>, $resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$newformat); }
<a name="l12054"></a>12054   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;NEXT-ODD&#39;</span>) { $this-&gt;AddPage($orient,<span class="stringliteral">&#39;NEXT-ODD&#39;</span>, $resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$newformat); }
<a name="l12055"></a>12055   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;NEXT-EVEN&#39;</span>) { $this-&gt;AddPage($orient,<span class="stringliteral">&#39;NEXT-EVEN&#39;</span>, $resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$newformat); }
<a name="l12056"></a>12056   <span class="keywordflow">else</span> { $this-&gt;AddPage($orient,<span class="stringliteral">&#39;&#39;</span>, $resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$newformat); }
<a name="l12057"></a>12057 
<a name="l12058"></a>12058   <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;TOCPAGEBREAK&#39;</span>) { 
<a name="l12059"></a>12059     <span class="keywordflow">if</span> ($toc_id) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCmark&#39;</span>] = $this-&gt;page; }
<a name="l12060"></a>12060     <span class="keywordflow">else</span> { $this-&gt;TOCmark = $this-&gt;page; }
<a name="l12061"></a>12061   }
<a name="l12062"></a>12062 
<a name="l12063"></a>12063   <span class="keywordflow">if</span> (($tag == <span class="stringliteral">&#39;FORMFEED&#39;</span> || $this-&gt;restoreBlockPagebreaks) &amp;&amp; !$this-&gt;tableLevel &amp;&amp; !$this-&gt;listlvl) {
<a name="l12064"></a>12064     $this-&gt;blk = $save_blk;
<a name="l12065"></a>12065     <span class="comment">// Re-open block tags</span>
<a name="l12066"></a>12066     $t = $this-&gt;blk[0][<span class="stringliteral">&#39;tag&#39;</span>];
<a name="l12067"></a>12067     $a = $this-&gt;blk[0][<span class="stringliteral">&#39;attr&#39;</span>];
<a name="l12068"></a>12068     $this-&gt;blklvl = 0; 
<a name="l12069"></a>12069     <span class="keywordflow">for</span> ($b=0; $b&lt;=$save_blklvl;$b++) {
<a name="l12070"></a>12070       $tc = $t;
<a name="l12071"></a>12071       $ac = $a;
<a name="l12072"></a>12072       $t = $this-&gt;blk[$b+1][<span class="stringliteral">&#39;tag&#39;</span>];
<a name="l12073"></a>12073       $a = $this-&gt;blk[$b+1][<span class="stringliteral">&#39;attr&#39;</span>];
<a name="l12074"></a>12074       unset($this-&gt;blk[$b+1]);
<a name="l12075"></a>12075       $this-&gt;OpenTag($tc,$ac); 
<a name="l12076"></a>12076     }
<a name="l12077"></a>12077     $this-&gt;spanlvl = $save_spanlvl;
<a name="l12078"></a>12078     $this-&gt;InlineProperties = $save_ilp;
<a name="l12079"></a>12079     $this-&gt;restoreInlineProperties($save_silp);
<a name="l12080"></a>12080   }
<a name="l12081"></a>12081 
<a name="l12082"></a>12082   <span class="keywordflow">break</span>;
<a name="l12083"></a>12083 
<a name="l12084"></a>12084 
<a name="l12085"></a>12085      <span class="keywordflow">case</span> <span class="stringliteral">&#39;TOCENTRY&#39;</span>:
<a name="l12086"></a>12086   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;CONTENT&#39;</span>]) {
<a name="l12087"></a>12087     $objattr = array();
<a name="l12088"></a>12088     $objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>],ENT_QUOTES);
<a name="l12089"></a>12089     $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;toc&#39;</span>;
<a name="l12090"></a>12090     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]) { $objattr[<span class="stringliteral">&#39;toclevel&#39;</span>] = $attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]; } <span class="keywordflow">else</span> { $objattr[<span class="stringliteral">&#39;toclevel&#39;</span>] = 0; }
<a name="l12091"></a>12091     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;NAME&#39;</span>]) { $objattr[<span class="stringliteral">&#39;toc_id&#39;</span>] = $attr[<span class="stringliteral">&#39;NAME&#39;</span>]; } <span class="keywordflow">else</span> { $objattr[<span class="stringliteral">&#39;toc_id&#39;</span>] = 0; }
<a name="l12092"></a>12092     $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=toc,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l12093"></a>12093     <span class="keywordflow">if</span>($this-&gt;tableLevel) { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e); }  <span class="comment">// *TABLES*</span>
<a name="l12094"></a>12094     <span class="keywordflow">else</span>  { <span class="comment">// *TABLES*</span>
<a name="l12095"></a>12095       $this-&gt;textbuffer[] = array($e);
<a name="l12096"></a>12096     } <span class="comment">// *TABLES*</span>
<a name="l12097"></a>12097   }
<a name="l12098"></a>12098   <span class="keywordflow">break</span>;
<a name="l12099"></a>12099 
<a name="l12100"></a>12100      <span class="keywordflow">case</span> <span class="stringliteral">&#39;INDEXENTRY&#39;</span>:
<a name="l12101"></a>12101   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;CONTENT&#39;</span>]) {
<a name="l12102"></a>12102     <span class="comment">// mPDF 3.0</span>
<a name="l12103"></a>12103     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;XREF&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;XREF&#39;</span>]) {
<a name="l12104"></a>12104       $this-&gt;IndexEntry(htmlspecialchars_decode($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>],ENT_QUOTES),$attr[<span class="stringliteral">&#39;XREF&#39;</span>]);
<a name="l12105"></a>12105       <span class="keywordflow">break</span>;
<a name="l12106"></a>12106     }
<a name="l12107"></a>12107     $objattr = array();
<a name="l12108"></a>12108     $objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>],ENT_QUOTES);
<a name="l12109"></a>12109     $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;indexentry&#39;</span>;
<a name="l12110"></a>12110     $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=indexentry,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l12111"></a>12111     <span class="keywordflow">if</span>($this-&gt;tableLevel) { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e); }  <span class="comment">// *TABLES*</span>
<a name="l12112"></a>12112     <span class="keywordflow">else</span>  { <span class="comment">// *TABLES*</span>
<a name="l12113"></a>12113       $this-&gt;textbuffer[] = array($e);
<a name="l12114"></a>12114     } <span class="comment">// *TABLES*</span>
<a name="l12115"></a>12115   }
<a name="l12116"></a>12116   <span class="keywordflow">break</span>;
<a name="l12117"></a>12117 
<a name="l12118"></a>12118      <span class="comment">// mPDF 3.0</span>
<a name="l12119"></a>12119      <span class="keywordflow">case</span> <span class="stringliteral">&#39;INDEXINSERT&#39;</span>:
<a name="l12120"></a>12120   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { $reffontsize = $attr[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $reffontsize = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12121"></a>12121   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LINE-SPACING&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;LINE-SPACING&#39;</span>]) { $linespacing = $attr[<span class="stringliteral">&#39;LINE-SPACING&#39;</span>]; } <span class="keywordflow">else</span> { $linespacing = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12122"></a>12122   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;DIV-FONT-SIZE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;DIV-FONT-SIZE&#39;</span>]) { $divlettfontsize = $attr[<span class="stringliteral">&#39;DIV-FONT-SIZE&#39;</span>]; } <span class="keywordflow">else</span> { $divlettfontsize = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12123"></a>12123   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;FONT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;FONT&#39;</span>]) { $reffont = $attr[<span class="stringliteral">&#39;FONT&#39;</span>]; } <span class="keywordflow">else</span> { $reffont = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12124"></a>12124   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;DIV-FONT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;DIV-FONT&#39;</span>]) { $divlettfont = $attr[<span class="stringliteral">&#39;DIV-FONT&#39;</span>]; } <span class="keywordflow">else</span> { $divlettfont = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12125"></a>12125   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;COLS&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;COLS&#39;</span>]) { $cols = $attr[<span class="stringliteral">&#39;COLS&#39;</span>]; } <span class="keywordflow">else</span> { $cols = 1; }
<a name="l12126"></a>12126   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;OFFSET&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;OFFSET&#39;</span>]) { $offset = $attr[<span class="stringliteral">&#39;OFFSET&#39;</span>]; } <span class="keywordflow">else</span> { $offset = 3; }
<a name="l12127"></a>12127   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;GAP&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;GAP&#39;</span>]) { $gap = $attr[<span class="stringliteral">&#39;GAP&#39;</span>]; } <span class="keywordflow">else</span> { $gap = 5; }
<a name="l12128"></a>12128 
<a name="l12129"></a>12129   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;USEDIVLETTERS&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;USEDIVLETTERS&#39;</span>])==<span class="stringliteral">&#39;OFF&#39;</span> || $attr[<span class="stringliteral">&#39;USEDIVLETTERS&#39;</span>]==-1 || $attr[<span class="stringliteral">&#39;USEDIVLETTERS&#39;</span>]===<span class="charliteral">&#39;0&#39;</span>)) { $usedivletters = 0; }
<a name="l12130"></a>12130   <span class="keywordflow">else</span> { $usedivletters = 1; }
<a name="l12131"></a>12131 
<a name="l12132"></a>12132   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LINKS&#39;</span>]) &amp;&amp; (strtoupper($attr[<span class="stringliteral">&#39;LINKS&#39;</span>])==<span class="stringliteral">&#39;ON&#39;</span> || $attr[<span class="stringliteral">&#39;LINKS&#39;</span>]==1)) { $links = <span class="keyword">true</span>; }
<a name="l12133"></a>12133   <span class="keywordflow">else</span> { $links = <span class="keyword">false</span>; }
<a name="l12134"></a>12134   $this-&gt;CreateIndex($cols, $reffontsize, $linespacing, $offset, $usedivletters, $divlettfontsize, $gap, $reffont,$divlettfont, $links);
<a name="l12135"></a>12135   <span class="keywordflow">break</span>;
<a name="l12136"></a>12136 
<a name="l12137"></a>12137      <span class="comment">// mPDF 3.0</span>
<a name="l12138"></a>12138      <span class="keywordflow">case</span> <span class="stringliteral">&#39;WATERMARKTEXT&#39;</span>:
<a name="l12139"></a>12139   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;CONTENT&#39;</span>]) { $txt = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>],ENT_QUOTES); } <span class="keywordflow">else</span> { $txt = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12140"></a>12140   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ALPHA&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;ALPHA&#39;</span>]&gt;0) { $alpha = $attr[<span class="stringliteral">&#39;ALPHA&#39;</span>]; } <span class="keywordflow">else</span> { $alpha = -1; }
<a name="l12141"></a>12141   $this-&gt;SetWatermarkText($txt, $alpha);
<a name="l12142"></a>12142   <span class="keywordflow">break</span>;
<a name="l12143"></a>12143 
<a name="l12144"></a>12144      <span class="comment">// mPDF 3.0</span>
<a name="l12145"></a>12145      <span class="keywordflow">case</span> <span class="stringliteral">&#39;WATERMARKIMAGE&#39;</span>:
<a name="l12146"></a>12146   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SRC&#39;</span>])) { $src = $attr[<span class="stringliteral">&#39;SRC&#39;</span>]; } <span class="keywordflow">else</span> { $src = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12147"></a>12147   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ALPHA&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;ALPHA&#39;</span>]&gt;0) { $alpha = $attr[<span class="stringliteral">&#39;ALPHA&#39;</span>]; } <span class="keywordflow">else</span> { $alpha = -1; }
<a name="l12148"></a>12148   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;SIZE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;SIZE&#39;</span>]) { 
<a name="l12149"></a>12149     $size = $attr[<span class="stringliteral">&#39;SIZE&#39;</span>]; 
<a name="l12150"></a>12150     <span class="keywordflow">if</span> (strpos($size,<span class="charliteral">&#39;,&#39;</span>)) { $size = explode(<span class="charliteral">&#39;,&#39;</span>,$size); }
<a name="l12151"></a>12151   } 
<a name="l12152"></a>12152   <span class="keywordflow">else</span> { $size = <span class="charliteral">&#39;D&#39;</span>; }
<a name="l12153"></a>12153   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;POS&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;POS&#39;</span>]) { 
<a name="l12154"></a>12154     $pos = $attr[<span class="stringliteral">&#39;POS&#39;</span>]; 
<a name="l12155"></a>12155     <span class="keywordflow">if</span> (strpos($pos,<span class="charliteral">&#39;,&#39;</span>)) { $pos = explode(<span class="charliteral">&#39;,&#39;</span>,$pos); }
<a name="l12156"></a>12156   } 
<a name="l12157"></a>12157   <span class="keywordflow">else</span> { $pos = <span class="charliteral">&#39;P&#39;</span>; }
<a name="l12158"></a>12158   $this-&gt;SetWatermarkImage($src, $alpha, $size, $pos);
<a name="l12159"></a>12159   <span class="keywordflow">break</span>;
<a name="l12160"></a>12160 
<a name="l12161"></a>12161      <span class="keywordflow">case</span> <span class="stringliteral">&#39;BOOKMARK&#39;</span>:
<a name="l12162"></a>12162   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>])) {
<a name="l12163"></a>12163     <span class="comment">// mPDF 3.0</span>
<a name="l12164"></a>12164     $objattr = array();
<a name="l12165"></a>12165     $objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;CONTENT&#39;</span>],ENT_QUOTES);
<a name="l12166"></a>12166     $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;bookmark&#39;</span>;
<a name="l12167"></a>12167     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]) { $objattr[<span class="stringliteral">&#39;bklevel&#39;</span>] = $attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]; } <span class="keywordflow">else</span> { $objattr[<span class="stringliteral">&#39;bklevel&#39;</span>] = 0; }
<a name="l12168"></a>12168     $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=bookmark,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l12169"></a>12169     <span class="keywordflow">if</span>($this-&gt;tableLevel) { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e); }  <span class="comment">// *TABLES*</span>
<a name="l12170"></a>12170     <span class="keywordflow">else</span>  { <span class="comment">// *TABLES*</span>
<a name="l12171"></a>12171       $this-&gt;textbuffer[] = array($e);
<a name="l12172"></a>12172     } <span class="comment">// *TABLES*</span>
<a name="l12173"></a>12173   }
<a name="l12174"></a>12174   <span class="keywordflow">break</span>;
<a name="l12175"></a>12175 
<a name="l12176"></a>12176 
<a name="l12177"></a>12177 
<a name="l12178"></a>12178 
<a name="l12179"></a>12179 
<a name="l12180"></a>12180     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BDO&#39;</span>:
<a name="l12181"></a>12181   $this-&gt;biDirectional = <span class="keyword">true</span>;
<a name="l12182"></a>12182   <span class="keywordflow">break</span>;
<a name="l12183"></a>12183 
<a name="l12184"></a>12184 
<a name="l12185"></a>12185     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TTZ&#39;</span>:
<a name="l12186"></a>12186   $this-&gt;ttz = <span class="keyword">true</span>;
<a name="l12187"></a>12187   $this-&gt;InlineProperties[$tag] = $this-&gt;saveInlineProperties();
<a name="l12188"></a>12188   $this-&gt;setCSS(array(<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>=&gt;<span class="stringliteral">&#39;zapfdingbats&#39;</span>,<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>=&gt;<span class="stringliteral">&#39;normal&#39;</span>,<span class="stringliteral">&#39;FONT-STYLE&#39;</span>=&gt;<span class="stringliteral">&#39;normal&#39;</span>),<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12189"></a>12189   <span class="keywordflow">break</span>;
<a name="l12190"></a>12190 
<a name="l12191"></a>12191     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TTS&#39;</span>:
<a name="l12192"></a>12192   $this-&gt;tts = <span class="keyword">true</span>;
<a name="l12193"></a>12193   $this-&gt;InlineProperties[$tag] = $this-&gt;saveInlineProperties();
<a name="l12194"></a>12194   $this-&gt;setCSS(array(<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>=&gt;<span class="stringliteral">&#39;symbol&#39;</span>,<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>=&gt;<span class="stringliteral">&#39;normal&#39;</span>,<span class="stringliteral">&#39;FONT-STYLE&#39;</span>=&gt;<span class="stringliteral">&#39;normal&#39;</span>),<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12195"></a>12195   <span class="keywordflow">break</span>;
<a name="l12196"></a>12196 
<a name="l12197"></a>12197     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TTA&#39;</span>:
<a name="l12198"></a>12198   $this-&gt;tta = <span class="keyword">true</span>;
<a name="l12199"></a>12199   $this-&gt;InlineProperties[$tag] = $this-&gt;saveInlineProperties();
<a name="l12200"></a>12200   <span class="comment">// mPDF 4.0</span>
<a name="l12201"></a>12201   <span class="keywordflow">if</span> (in_array($this-&gt;FontFamily,$this-&gt;mono_fonts)) {
<a name="l12202"></a>12202     $this-&gt;setCSS(array(<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>=&gt;<span class="stringliteral">&#39;courier-embedded&#39;</span>),<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12203"></a>12203   }
<a name="l12204"></a>12204   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_array($this-&gt;FontFamily,$this-&gt;serif_fonts)) { 
<a name="l12205"></a>12205     $this-&gt;setCSS(array(<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>=&gt;<span class="stringliteral">&#39;times-embedded&#39;</span>),<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12206"></a>12206   }
<a name="l12207"></a>12207   <span class="keywordflow">else</span> {
<a name="l12208"></a>12208     $this-&gt;setCSS(array(<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>=&gt;<span class="stringliteral">&#39;helvetica-embedded&#39;</span>),<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12209"></a>12209   }
<a name="l12210"></a>12210   <span class="keywordflow">break</span>;
<a name="l12211"></a>12211 
<a name="l12212"></a>12212 
<a name="l12213"></a>12213 
<a name="l12214"></a>12214     <span class="comment">// INLINE PHRASES OR STYLES</span>
<a name="l12215"></a>12215     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SUB&#39;</span>:
<a name="l12216"></a>12216     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SUP&#39;</span>:
<a name="l12217"></a>12217     <span class="keywordflow">case</span> <span class="stringliteral">&#39;ACRONYM&#39;</span>:
<a name="l12218"></a>12218     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BIG&#39;</span>:
<a name="l12219"></a>12219     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SMALL&#39;</span>:
<a name="l12220"></a>12220     <span class="keywordflow">case</span> <span class="stringliteral">&#39;INS&#39;</span>:
<a name="l12221"></a>12221     <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:
<a name="l12222"></a>12222     <span class="keywordflow">case</span> <span class="stringliteral">&#39;STRIKE&#39;</span>:
<a name="l12223"></a>12223     <span class="keywordflow">case</span> <span class="stringliteral">&#39;DEL&#39;</span>:
<a name="l12224"></a>12224     <span class="keywordflow">case</span> <span class="stringliteral">&#39;STRONG&#39;</span>:
<a name="l12225"></a>12225     <span class="keywordflow">case</span> <span class="stringliteral">&#39;CITE&#39;</span>:
<a name="l12226"></a>12226     <span class="keywordflow">case</span> <span class="charliteral">&#39;Q&#39;</span>:
<a name="l12227"></a>12227     <span class="keywordflow">case</span> <span class="stringliteral">&#39;EM&#39;</span>:
<a name="l12228"></a>12228     <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:
<a name="l12229"></a>12229     <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:
<a name="l12230"></a>12230     <span class="keywordflow">case</span> <span class="charliteral">&#39;U&#39;</span>:
<a name="l12231"></a>12231     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SAMP&#39;</span>:
<a name="l12232"></a>12232     <span class="keywordflow">case</span> <span class="stringliteral">&#39;CODE&#39;</span>:
<a name="l12233"></a>12233     <span class="keywordflow">case</span> <span class="stringliteral">&#39;KBD&#39;</span>:
<a name="l12234"></a>12234     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TT&#39;</span>:
<a name="l12235"></a>12235     <span class="keywordflow">case</span> <span class="stringliteral">&#39;VAR&#39;</span>:
<a name="l12236"></a>12236     <span class="keywordflow">case</span> <span class="stringliteral">&#39;FONT&#39;</span>:
<a name="l12237"></a>12237     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SPAN&#39;</span>:
<a name="l12238"></a>12238 
<a name="l12239"></a>12239   <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;SPAN&#39;</span>) {
<a name="l12240"></a>12240     $this-&gt;spanlvl++;
<a name="l12241"></a>12241     $this-&gt;InlineProperties[<span class="stringliteral">&#39;SPAN&#39;</span>][$this-&gt;spanlvl] = $this-&gt;saveInlineProperties();
<a name="l12242"></a>12242   }
<a name="l12243"></a>12243   <span class="keywordflow">else</span> { 
<a name="l12244"></a>12244     $this-&gt;InlineProperties[$tag] = $this-&gt;saveInlineProperties(); 
<a name="l12245"></a>12245   }
<a name="l12246"></a>12246   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;INLINE&#39;</span>,$tag,$attr); <span class="comment">// mPDF 4.0</span>
<a name="l12247"></a>12247   <span class="keywordflow">if</span> (!empty($properties)) $this-&gt;setCSS($properties,<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12248"></a>12248   <span class="keywordflow">break</span>;
<a name="l12249"></a>12249 
<a name="l12250"></a>12250 
<a name="l12251"></a>12251     <span class="keywordflow">case</span> <span class="charliteral">&#39;A&#39;</span>:
<a name="l12252"></a>12252   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NAME&#39;</span>]) and $attr[<span class="stringliteral">&#39;NAME&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l12253"></a>12253     <span class="comment">// mPDF 3.0</span>
<a name="l12254"></a>12254     $e = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12255"></a>12255     <span class="keywordflow">if</span> ($this-&gt;anchor2Bookmark) { 
<a name="l12256"></a>12256       $objattr = array();
<a name="l12257"></a>12257       $objattr[<span class="stringliteral">&#39;CONTENT&#39;</span>] = htmlspecialchars_decode($attr[<span class="stringliteral">&#39;NAME&#39;</span>],ENT_QUOTES);
<a name="l12258"></a>12258       $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;bookmark&#39;</span>;
<a name="l12259"></a>12259       <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]) { $objattr[<span class="stringliteral">&#39;bklevel&#39;</span>] = $attr[<span class="stringliteral">&#39;LEVEL&#39;</span>]; } <span class="keywordflow">else</span> { $objattr[<span class="stringliteral">&#39;bklevel&#39;</span>] = 0; }
<a name="l12260"></a>12260       $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=bookmark,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l12261"></a>12261     }
<a name="l12262"></a>12262     <span class="keywordflow">if</span>($this-&gt;tableLevel) { <span class="comment">// *TABLES*</span>
<a name="l12263"></a>12263       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,array(),<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,$attr[<span class="stringliteral">&#39;NAME&#39;</span>]);   <span class="comment">// *TABLES*</span>
<a name="l12264"></a>12264     } <span class="comment">// *TABLES*</span>
<a name="l12265"></a>12265     <span class="keywordflow">else</span>  { <span class="comment">// *TABLES*</span>
<a name="l12266"></a>12266       $this-&gt;textbuffer[] = array($e,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,array(),<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,$attr[<span class="stringliteral">&#39;NAME&#39;</span>]); <span class="comment">//an internal link (adds a space for recognition)</span>
<a name="l12267"></a>12267     } <span class="comment">// *TABLES*</span>
<a name="l12268"></a>12268   }
<a name="l12269"></a>12269   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HREF&#39;</span>])) { 
<a name="l12270"></a>12270     $this-&gt;InlineProperties[<span class="charliteral">&#39;A&#39;</span>] = $this-&gt;saveInlineProperties();
<a name="l12271"></a>12271     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;&#39;</span>,$tag,$attr);
<a name="l12272"></a>12272     <span class="keywordflow">if</span> (!empty($properties)) $this-&gt;setCSS($properties,<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12273"></a>12273     $this-&gt;HREF=$attr[<span class="stringliteral">&#39;HREF&#39;</span>];
<a name="l12274"></a>12274   }
<a name="l12275"></a>12275   <span class="keywordflow">break</span>;
<a name="l12276"></a>12276 
<a name="l12277"></a>12277 
<a name="l12278"></a>12278 
<a name="l12279"></a>12279     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BR&#39;</span>:
<a name="l12280"></a>12280   <span class="comment">// Added mPDF 3.0 Float DIV - CLEAR</span>
<a name="l12281"></a>12281   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;STYLE&#39;</span>])) {
<a name="l12282"></a>12282     $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;STYLE&#39;</span>]);
<a name="l12283"></a>12283     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;CLEAR&#39;</span>])) { $this-&gt;ClearFloats(strtoupper($properties[<span class="stringliteral">&#39;CLEAR&#39;</span>]),$this-&gt;blklvl); }  <span class="comment">// *CSS-FLOAT*</span>
<a name="l12284"></a>12284   }
<a name="l12285"></a>12285 
<a name="l12286"></a>12286 
<a name="l12287"></a>12287   <span class="keywordflow">if</span>($this-&gt;tableLevel) {
<a name="l12288"></a>12288      <span class="comment">// mPDF 3.0</span>
<a name="l12289"></a>12289      <span class="keywordflow">if</span> ($this-&gt;blockjustfinished || $this-&gt;listjustfinished) {
<a name="l12290"></a>12290     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array(<span class="stringliteral">&quot;\n&quot;</span>,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l12291"></a>12291     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l12292"></a>12292      }
<a name="l12293"></a>12293 
<a name="l12294"></a>12294     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array(<span class="stringliteral">&quot;\n&quot;</span>,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l12295"></a>12295     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l12296"></a>12296     <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l12297"></a>12297       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l12298"></a>12298     }
<a name="l12299"></a>12299     elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l12300"></a>12300       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>];  
<a name="l12301"></a>12301     }
<a name="l12302"></a>12302     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0 ;<span class="comment">// reset</span>
<a name="l12303"></a>12303   }
<a name="l12304"></a>12304   <span class="keywordflow">else</span>  {
<a name="l12305"></a>12305     $this-&gt;textbuffer[] = array(<span class="stringliteral">&quot;\n&quot;</span>,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l12306"></a>12306   } <span class="comment">// *TABLES*</span>
<a name="l12307"></a>12307   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l12308"></a>12308   $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l12309"></a>12309   $this-&gt;listjustfinished=<span class="keyword">false</span>;
<a name="l12310"></a>12310   <span class="comment">// mPDF 3.0</span>
<a name="l12311"></a>12311   $this-&gt;linebreakjustfinished=<span class="keyword">true</span>;
<a name="l12312"></a>12312   <span class="keywordflow">break</span>;
<a name="l12313"></a>12313 
<a name="l12314"></a>12314 
<a name="l12315"></a>12315   <span class="comment">// *********** BLOCKS  ********************</span>
<a name="l12316"></a>12316 
<a name="l12317"></a>12317   <span class="comment">//NB $outerblocktags = array(&#39;DIV&#39;,&#39;FORM&#39;,&#39;CENTER&#39;,&#39;DL&#39;);</span>
<a name="l12318"></a>12318   <span class="comment">//NB $innerblocktags = array(&#39;P&#39;,&#39;BLOCKQUOTE&#39;,&#39;ADDRESS&#39;,&#39;PRE&#39;,&#39;&#39;H1&#39;,&#39;H2&#39;,&#39;H3&#39;,&#39;H4&#39;,&#39;H5&#39;,&#39;H6&#39;,&#39;DT&#39;,&#39;DD&#39;);</span>
<a name="l12319"></a>12319 
<a name="l12320"></a>12320     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PRE&#39;</span>:
<a name="l12321"></a>12321   $this-&gt;ispre=<span class="keyword">true</span>;  <span class="comment">// ADDED - Prevents left trim of textbuffer in printbuffer()</span>
<a name="l12322"></a>12322 
<a name="l12323"></a>12323     <span class="keywordflow">case</span> <span class="stringliteral">&#39;DIV&#39;</span>:
<a name="l12324"></a>12324     <span class="keywordflow">case</span> <span class="stringliteral">&#39;FORM&#39;</span>:
<a name="l12325"></a>12325     <span class="keywordflow">case</span> <span class="stringliteral">&#39;CENTER&#39;</span>:
<a name="l12326"></a>12326 
<a name="l12327"></a>12327     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BLOCKQUOTE&#39;</span>:
<a name="l12328"></a>12328     <span class="keywordflow">case</span> <span class="stringliteral">&#39;ADDRESS&#39;</span>: 
<a name="l12329"></a>12329 
<a name="l12330"></a>12330     <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:
<a name="l12331"></a>12331     <span class="keywordflow">case</span> <span class="stringliteral">&#39;H1&#39;</span>:
<a name="l12332"></a>12332     <span class="keywordflow">case</span> <span class="stringliteral">&#39;H2&#39;</span>:
<a name="l12333"></a>12333     <span class="keywordflow">case</span> <span class="stringliteral">&#39;H3&#39;</span>:
<a name="l12334"></a>12334     <span class="keywordflow">case</span> <span class="stringliteral">&#39;H4&#39;</span>:
<a name="l12335"></a>12335     <span class="keywordflow">case</span> <span class="stringliteral">&#39;H5&#39;</span>:
<a name="l12336"></a>12336     <span class="keywordflow">case</span> <span class="stringliteral">&#39;H6&#39;</span>:
<a name="l12337"></a>12337     <span class="keywordflow">case</span> <span class="stringliteral">&#39;DL&#39;</span>:
<a name="l12338"></a>12338     <span class="keywordflow">case</span> <span class="stringliteral">&#39;DT&#39;</span>:
<a name="l12339"></a>12339     <span class="keywordflow">case</span> <span class="stringliteral">&#39;DD&#39;</span>:
<a name="l12340"></a>12340   $p = $this-&gt;PreviewBlockCSS($tag,$attr);
<a name="l12341"></a>12341   <span class="keywordflow">if</span>(isset($p[<span class="stringliteral">&#39;DISPLAY&#39;</span>]) &amp;&amp; strtolower($p[<span class="stringliteral">&#39;DISPLAY&#39;</span>])==<span class="stringliteral">&#39;none&#39;</span>) { 
<a name="l12342"></a>12342     $this-&gt;blklvl++;
<a name="l12343"></a>12343     $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;hide&#39;</span>] = <span class="keyword">true</span>; 
<a name="l12344"></a>12344     <span class="keywordflow">return</span>; 
<a name="l12345"></a>12345   }
<a name="l12346"></a>12346   <span class="comment">// mPDF 4.0</span>
<a name="l12347"></a>12347   <span class="keywordflow">if</span> ((isset($p[<span class="stringliteral">&#39;POSITION&#39;</span>]) &amp;&amp; (strtolower($p[<span class="stringliteral">&#39;POSITION&#39;</span>])==<span class="stringliteral">&#39;fixed&#39;</span> || strtolower($p[<span class="stringliteral">&#39;POSITION&#39;</span>])==<span class="stringliteral">&#39;absolute&#39;</span>)) &amp;&amp; $this-&gt;blklvl==0) { 
<a name="l12348"></a>12348     <span class="keywordflow">if</span> ($this-&gt;inFixedPosBlock) {
<a name="l12349"></a>12349       $this-&gt;Error(<span class="stringliteral">&quot;Cannot nest block with position:fixed or position:absolute&quot;</span>); 
<a name="l12350"></a>12350     }
<a name="l12351"></a>12351     $this-&gt;inFixedPosBlock = <span class="keyword">true</span>;
<a name="l12352"></a>12352     <span class="keywordflow">return</span>;
<a name="l12353"></a>12353   }
<a name="l12354"></a>12354   <span class="comment">// Start Block</span>
<a name="l12355"></a>12355   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l12356"></a>12356   <span class="comment">// mPDF 4.2</span>
<a name="l12357"></a>12357   <span class="keywordflow">if</span> ($this-&gt;blockjustfinished &amp;&amp; !count($this-&gt;textbuffer) &amp;&amp; $this-&gt;y != $this-&gt;tMargin &amp;&amp; $this-&gt;collapseBlockMargins) { $lastbottommargin = $this-&gt;lastblockbottommargin; }
<a name="l12358"></a>12358   <span class="keywordflow">else</span> { $lastbottommargin = 0; }
<a name="l12359"></a>12359   $this-&gt;lastblockbottommargin = 0;
<a name="l12360"></a>12360   $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l12361"></a>12361 
<a name="l12362"></a>12362   <span class="comment">// mPDF 4.0</span>
<a name="l12363"></a>12363   <span class="keywordflow">if</span> ($this-&gt;listlvl&gt;0) { <span class="keywordflow">return</span>; }
<a name="l12364"></a>12364 
<a name="l12365"></a>12365   $this-&gt;InlineProperties = array(); 
<a name="l12366"></a>12366   $this-&gt;spanlvl = 0;
<a name="l12367"></a>12367   $this-&gt;listjustfinished=<span class="keyword">false</span>;
<a name="l12368"></a>12368   $this-&gt;divbegin=<span class="keyword">true</span>;
<a name="l12369"></a>12369   <span class="comment">// mPDF 3.0</span>
<a name="l12370"></a>12370   $this-&gt;linebreakjustfinished=<span class="keyword">false</span>;
<a name="l12371"></a>12371 
<a name="l12372"></a>12372   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l12373"></a>12373      <span class="comment">// mPDF 3.0</span>
<a name="l12374"></a>12374      <span class="comment">// If already something on the line</span>
<a name="l12375"></a>12375      <span class="keywordflow">if</span> ($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] &gt; 0  &amp;&amp; !$this-&gt;nestedtablejustfinished ) {
<a name="l12376"></a>12376     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array(<span class="stringliteral">&quot;\n&quot;</span>,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l12377"></a>12377     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l12378"></a>12378     <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l12379"></a>12379       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>];
<a name="l12380"></a>12380     }
<a name="l12381"></a>12381     elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l12382"></a>12382       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l12383"></a>12383     }
<a name="l12384"></a>12384     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0 ;<span class="comment">// reset</span>
<a name="l12385"></a>12385      }
<a name="l12386"></a>12386      <span class="comment">// Cannot set block properties inside table - use Bold to indicate h1-h6</span>
<a name="l12387"></a>12387      <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;CENTER&#39;</span> &amp;&amp; $this-&gt;tdbegin) { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;a&#39;</span>] = $align[<span class="stringliteral">&#39;center&#39;</span>]; }
<a name="l12388"></a>12388 
<a name="l12389"></a>12389     $this-&gt;InlineProperties[<span class="stringliteral">&#39;BLOCKINTABLE&#39;</span>] = $this-&gt;saveInlineProperties();
<a name="l12390"></a>12390     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;&#39;</span>,$tag,$attr);
<a name="l12391"></a>12391     <span class="keywordflow">if</span> (!empty($properties)) $this-&gt;setCSS($properties,<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l12392"></a>12392 
<a name="l12393"></a>12393 
<a name="l12394"></a>12394      <span class="keywordflow">break</span>;
<a name="l12395"></a>12395   }
<a name="l12396"></a>12396 
<a name="l12397"></a>12397   <span class="keywordflow">if</span> ($tag == <span class="charliteral">&#39;P&#39;</span> || $tag == <span class="stringliteral">&#39;DT&#39;</span> || $tag == <span class="stringliteral">&#39;DD&#39;</span>) { $this-&gt;lastoptionaltag = $tag; } <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l12398"></a>12398   <span class="keywordflow">else</span> { $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l12399"></a>12399 
<a name="l12400"></a>12400   <span class="keywordflow">if</span> ($this-&gt;lastblocklevelchange == 1) { $blockstate = 1; }  <span class="comment">// Top margins/padding only</span>
<a name="l12401"></a>12401   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;lastblocklevelchange &lt; 1) { $blockstate = 0; }  <span class="comment">// NO margins/padding</span>
<a name="l12402"></a>12402   $this-&gt;printbuffer($this-&gt;textbuffer,$blockstate);
<a name="l12403"></a>12403   $this-&gt;textbuffer=array();
<a name="l12404"></a>12404 
<a name="l12405"></a>12405   $this-&gt;blklvl++;
<a name="l12406"></a>12406   <span class="comment">// mPDF 4.0</span>
<a name="l12407"></a>12407   $currblk =&amp; $this-&gt;blk[$this-&gt;blklvl];
<a name="l12408"></a>12408   $this-&gt;initialiseBlock($currblk);
<a name="l12409"></a>12409   $prevblk =&amp; $this-&gt;blk[$this-&gt;blklvl-1];
<a name="l12410"></a>12410 
<a name="l12411"></a>12411   $currblk[<span class="stringliteral">&#39;tag&#39;</span>] = $tag;
<a name="l12412"></a>12412   $currblk[<span class="stringliteral">&#39;attr&#39;</span>] = $attr;
<a name="l12413"></a>12413 
<a name="l12414"></a>12414   $this-&gt;Reset();
<a name="l12415"></a>12415   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,$tag,$attr);
<a name="l12416"></a>12416 
<a name="l12417"></a>12417   $pagesel = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l12418"></a>12418   <span class="comment">// mPDF 4.2</span>
<a name="l12419"></a>12419   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PAGE&#39;</span>])) { $pagesel = $properties[<span class="stringliteral">&#39;PAGE&#39;</span>]; } 
<a name="l12420"></a>12420 
<a name="l12421"></a>12421   <span class="comment">// If page-box has changed AND/OR PAGE-BREAK-BEFORE</span>
<a name="l12422"></a>12422   $save_cols = <span class="keyword">false</span>;
<a name="l12423"></a>12423   <span class="keywordflow">if</span> (($pagesel &amp;&amp; $pagesel != $this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>]) || (isset($properties[<span class="stringliteral">&#39;PAGE-BREAK-BEFORE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;PAGE-BREAK-BEFORE&#39;</span>])) {
<a name="l12424"></a>12424     <span class="keywordflow">if</span> ($this-&gt;blklvl&gt;1) {
<a name="l12425"></a>12425       <span class="comment">// Close any open block tags</span>
<a name="l12426"></a>12426       <span class="keywordflow">for</span> ($b= $this-&gt;blklvl;$b&gt;0;$b--) { $this-&gt;CloseTag($this-&gt;blk[$b][<span class="stringliteral">&#39;tag&#39;</span>]); }
<a name="l12427"></a>12427       <span class="comment">// Output any text left in buffer</span>
<a name="l12428"></a>12428       <span class="keywordflow">if</span> (count($this-&gt;textbuffer)) { $this-&gt;printbuffer($this-&gt;textbuffer); $this-&gt;textbuffer=array(); }
<a name="l12429"></a>12429     }
<a name="l12430"></a>12430 
<a name="l12431"></a>12431 
<a name="l12432"></a>12432     <span class="comment">// Must Add new page if changed page properties</span>
<a name="l12433"></a>12433     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PAGE-BREAK-BEFORE&#39;</span>])) {
<a name="l12434"></a>12434       <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;PAGE-BREAK-BEFORE&#39;</span>]) == <span class="stringliteral">&#39;RIGHT&#39;</span>) { $this-&gt;AddPage($this-&gt;CurOrientation,<span class="stringliteral">&#39;NEXT-ODD&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,0,0,0,0,$pagesel); }
<a name="l12435"></a>12435       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;PAGE-BREAK-BEFORE&#39;</span>]) == <span class="stringliteral">&#39;LEFT&#39;</span>) { $this-&gt;AddPage($this-&gt;CurOrientation,<span class="stringliteral">&#39;NEXT-EVEN&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,0,0,0,0,$pagesel); }
<a name="l12436"></a>12436       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;PAGE-BREAK-BEFORE&#39;</span>]) == <span class="stringliteral">&#39;ALWAYS&#39;</span>) { $this-&gt;AddPage($this-&gt;CurOrientation,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,0,0,0,0,$pagesel); }
<a name="l12437"></a>12437       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>] != $pagesel) { $this-&gt;AddPage($this-&gt;CurOrientation,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,0,0,0,0,$pagesel); }  <span class="comment">// *CSS-PAGE*</span>
<a name="l12438"></a>12438     }
<a name="l12439"></a>12439     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($pagesel != $this-&gt;page_box[<span class="stringliteral">&#39;current&#39;</span>]) { $this-&gt;AddPage($this-&gt;CurOrientation,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,0,0,0,0,$pagesel); }
<a name="l12440"></a>12440 
<a name="l12441"></a>12441     <span class="comment">// if using htmlheaders, the headers need to be rewritten when new page</span>
<a name="l12442"></a>12442     <span class="comment">// done by calling WriteHTML() within resethtmlheaders</span>
<a name="l12443"></a>12443     <span class="comment">// so block is reset to 0 - now we need to resurrect it</span>
<a name="l12444"></a>12444     <span class="comment">// As in WriteHTML() initialising</span>
<a name="l12445"></a>12445     $this-&gt;blklvl = 0;
<a name="l12446"></a>12446     $this-&gt;lastblocklevelchange = 0;
<a name="l12447"></a>12447     $this-&gt;blk = array();
<a name="l12448"></a>12448     <span class="comment">// mPDF 4.0</span>
<a name="l12449"></a>12449     $this-&gt;initialiseBlock($this-&gt;blk[0]);
<a name="l12450"></a>12450     $this-&gt;blk[0][<span class="stringliteral">&#39;width&#39;</span>] =&amp; $this-&gt;pgwidth;
<a name="l12451"></a>12451     $this-&gt;blk[0][<span class="stringliteral">&#39;inner_width&#39;</span>] =&amp; $this-&gt;pgwidth;
<a name="l12452"></a>12452     <span class="comment">// mPDF 3.0</span>
<a name="l12453"></a>12453     $this-&gt;blk[0][<span class="stringliteral">&#39;blockContext&#39;</span>] = $this-&gt;blockContext;
<a name="l12454"></a>12454     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>,<span class="stringliteral">&#39;&#39;</span>);
<a name="l12455"></a>12455     $this-&gt;setCSS($properties,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>); 
<a name="l12456"></a>12456     $this-&gt;blklvl++;
<a name="l12457"></a>12457     <span class="comment">// mPDF 4.0</span>
<a name="l12458"></a>12458     $currblk =&amp; $this-&gt;blk[$this-&gt;blklvl];
<a name="l12459"></a>12459     $prevblk =&amp; $this-&gt;blk[$this-&gt;blklvl-1];
<a name="l12460"></a>12460 
<a name="l12461"></a>12461     $this-&gt;initialiseBlock($currblk);
<a name="l12462"></a>12462     $currblk[<span class="stringliteral">&#39;tag&#39;</span>] = $tag;
<a name="l12463"></a>12463     $currblk[<span class="stringliteral">&#39;attr&#39;</span>] = $attr;
<a name="l12464"></a>12464 
<a name="l12465"></a>12465     $this-&gt;Reset();
<a name="l12466"></a>12466     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;BLOCK&#39;</span>,$tag,$attr);
<a name="l12467"></a>12467   }
<a name="l12468"></a>12468 
<a name="l12469"></a>12469 
<a name="l12470"></a>12470   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PAGE-BREAK-INSIDE&#39;</span>]) &amp;&amp; strtoupper($properties[<span class="stringliteral">&#39;PAGE-BREAK-INSIDE&#39;</span>]) == <span class="stringliteral">&#39;AVOID&#39;</span> &amp;&amp; !$this-&gt;ColActive &amp;&amp; !$this-&gt;keep_block_together) {
<a name="l12471"></a>12471     $currblk[<span class="stringliteral">&#39;keep_block_together&#39;</span>] = 1;
<a name="l12472"></a>12472     $currblk[<span class="stringliteral">&#39;y00&#39;</span>] = $this-&gt;y;
<a name="l12473"></a>12473     $this-&gt;keep_block_together = 1;
<a name="l12474"></a>12474     $this-&gt;divbuffer = array();
<a name="l12475"></a>12475     $this-&gt;ktLinks = array();
<a name="l12476"></a>12476     $this-&gt;ktAnnots = array();
<a name="l12477"></a>12477     $this-&gt;ktBlock = array();
<a name="l12478"></a>12478     $this-&gt;ktReference = array();
<a name="l12479"></a>12479     $this-&gt;ktBMoutlines = array();
<a name="l12480"></a>12480     $this-&gt;_kttoc = array();
<a name="l12481"></a>12481   }
<a name="l12482"></a>12482 
<a name="l12483"></a>12483   <span class="comment">// mPDF 4.2 Collaspe vertical block margins</span>
<a name="l12484"></a>12484   <span class="keywordflow">if</span> ($lastbottommargin &amp;&amp; $properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>]) { $currblk[<span class="stringliteral">&#39;lastbottommargin&#39;</span>] = $lastbottommargin; }
<a name="l12485"></a>12485 
<a name="l12486"></a>12486   $this-&gt;setCSS($properties,<span class="stringliteral">&#39;BLOCK&#39;</span>,$tag); <span class="comment">//name(id/class/style) found in the CSS array!</span>
<a name="l12487"></a>12487   $currblk[<span class="stringliteral">&#39;InlineProperties&#39;</span>] = $this-&gt;saveInlineProperties();
<a name="l12488"></a>12488 
<a name="l12489"></a>12489 
<a name="l12490"></a>12490   <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;ALIGN&#39;</span>]) { $currblk[<span class="stringliteral">&#39;block-align&#39;</span>] = $align[strtolower($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>])]; }
<a name="l12491"></a>12491 
<a name="l12492"></a>12492 
<a name="l12493"></a>12493   <span class="comment">// mPDF 4.0 height</span>
<a name="l12494"></a>12494   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>])) { $currblk[<span class="stringliteral">&#39;css_set_height&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>],($this-&gt;h - $this-&gt;tMargin - $this-&gt;bMargin),$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12495"></a>12495   <span class="keywordflow">else</span> { $currblk[<span class="stringliteral">&#39;css_set_height&#39;</span>] = <span class="keyword">false</span>; }
<a name="l12496"></a>12496 
<a name="l12497"></a>12497 
<a name="l12498"></a>12498   <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l12499"></a>12499   <span class="keywordflow">if</span> (isset($prevblk[<span class="stringliteral">&#39;blockContext&#39;</span>])) { $currblk[<span class="stringliteral">&#39;blockContext&#39;</span>] = $prevblk[<span class="stringliteral">&#39;blockContext&#39;</span>] ; }  <span class="comment">// *CSS-FLOAT*</span>
<a name="l12500"></a>12500 
<a name="l12501"></a>12501   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;CLEAR&#39;</span>])) { $this-&gt;ClearFloats(strtoupper($properties[<span class="stringliteral">&#39;CLEAR&#39;</span>]), $this-&gt;blklvl-1); } <span class="comment">// *CSS-FLOAT*</span>
<a name="l12502"></a>12502 
<a name="l12503"></a>12503   $container_w = $prevblk[<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l12504"></a>12504   $bdr = $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l12505"></a>12505   $bdl = $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l12506"></a>12506   $pdr = $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>];
<a name="l12507"></a>12507   $pdl = $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>];
<a name="l12508"></a>12508 
<a name="l12509"></a>12509   <span class="keywordflow">if</span> (isset($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>])) { $setwidth = $currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>]; }
<a name="l12510"></a>12510   <span class="keywordflow">else</span> { $setwidth = 0; }
<a name="l12511"></a>12511 
<a name="l12512"></a>12512   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) &amp;&amp; strtoupper($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) == <span class="stringliteral">&#39;RIGHT&#39;</span> &amp;&amp; !$this-&gt;ColActive) {
<a name="l12513"></a>12513     <span class="comment">// Cancel Keep-Block-together</span>
<a name="l12514"></a>12514     $currblk[<span class="stringliteral">&#39;keep_block_together&#39;</span>] = <span class="keyword">false</span>;
<a name="l12515"></a>12515     $currblk[<span class="stringliteral">&#39;y00&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12516"></a>12516     $this-&gt;keep_block_together = 0;
<a name="l12517"></a>12517 
<a name="l12518"></a>12518     $this-&gt;blockContext++;
<a name="l12519"></a>12519     $currblk[<span class="stringliteral">&#39;blockContext&#39;</span>] = $this-&gt;blockContext;
<a name="l12520"></a>12520 
<a name="l12521"></a>12521     list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl-1);
<a name="l12522"></a>12522 
<a name="l12523"></a>12523     <span class="comment">// DIV is too narrow for text to fit!</span>
<a name="l12524"></a>12524     $maxw = $container_w - $l_width - $r_width;
<a name="l12525"></a>12525     <span class="keywordflow">if</span> (($setwidth + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &gt; $maxw || ($maxw - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &lt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) { 
<a name="l12526"></a>12526       <span class="comment">// Too narrow to fit - try to move down past L or R float</span>
<a name="l12527"></a>12527       <span class="keywordflow">if</span> ($l_max &lt; $r_max &amp;&amp; ($setwidth + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &lt;= ($container_w - $r_width) &amp;&amp; (($container_w - $r_width) - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l12528"></a>12528         $this-&gt;ClearFloats(<span class="stringliteral">&#39;LEFT&#39;</span>, $this-&gt;blklvl-1); 
<a name="l12529"></a>12529       }
<a name="l12530"></a>12530       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($r_max &lt; $l_max &amp;&amp; ($setwidth + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr)  &lt;= ($container_w - $l_width) &amp;&amp; (($container_w - $l_width) - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l12531"></a>12531         $this-&gt;ClearFloats(<span class="stringliteral">&#39;RIGHT&#39;</span>, $this-&gt;blklvl-1); 
<a name="l12532"></a>12532       }
<a name="l12533"></a>12533       <span class="keywordflow">else</span> { $this-&gt;ClearFloats(<span class="stringliteral">&#39;BOTH&#39;</span>, $this-&gt;blklvl-1); }
<a name="l12534"></a>12534       list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl-1);
<a name="l12535"></a>12535     }
<a name="l12536"></a>12536 
<a name="l12537"></a>12537     <span class="keywordflow">if</span> ($r_exists) { $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] += $r_width; }
<a name="l12538"></a>12538 
<a name="l12539"></a>12539     $currblk[<span class="stringliteral">&#39;float&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l12540"></a>12540     $currblk[<span class="stringliteral">&#39;float_start_y&#39;</span>] = $this-&gt;y;
<a name="l12541"></a>12541     <span class="keywordflow">if</span> ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>]) {
<a name="l12542"></a>12542       $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] = $container_w - ($setwidth + $bdl + $pdl + $bdr + $pdr + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>]);
<a name="l12543"></a>12543       $currblk[<span class="stringliteral">&#39;float_width&#39;</span>] = ($setwidth + $bdl + $pdl + $bdr + $pdr + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>]);
<a name="l12544"></a>12544     }
<a name="l12545"></a>12545     <span class="keywordflow">else</span> {
<a name="l12546"></a>12546       <span class="comment">// *** If no width set - would need to buffer and keep track of max width, then Right-align if not full width</span>
<a name="l12547"></a>12547       <span class="comment">// and do borders and backgrounds - For now - just set to maximum width left</span>
<a name="l12548"></a>12548 
<a name="l12549"></a>12549       <span class="keywordflow">if</span> ($l_exists) { $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] += $l_width; }
<a name="l12550"></a>12550       $currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] = $container_w - ($currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr);
<a name="l12551"></a>12551 
<a name="l12552"></a>12552       $currblk[<span class="stringliteral">&#39;float_width&#39;</span>] = ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] + $bdl + $pdl + $bdr + $pdr + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>]);
<a name="l12553"></a>12553     }
<a name="l12554"></a>12554   }
<a name="l12555"></a>12555   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) &amp;&amp; strtoupper($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) == <span class="stringliteral">&#39;LEFT&#39;</span> &amp;&amp; !$this-&gt;ColActive) {
<a name="l12556"></a>12556     <span class="comment">// Cancel Keep-Block-together</span>
<a name="l12557"></a>12557     $currblk[<span class="stringliteral">&#39;keep_block_together&#39;</span>] = <span class="keyword">false</span>;
<a name="l12558"></a>12558     $currblk[<span class="stringliteral">&#39;y00&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12559"></a>12559     $this-&gt;keep_block_together = 0;
<a name="l12560"></a>12560 
<a name="l12561"></a>12561     $this-&gt;blockContext++;
<a name="l12562"></a>12562     $currblk[<span class="stringliteral">&#39;blockContext&#39;</span>] = $this-&gt;blockContext;
<a name="l12563"></a>12563 
<a name="l12564"></a>12564     list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl-1);
<a name="l12565"></a>12565 
<a name="l12566"></a>12566     <span class="comment">// DIV is too narrow for text to fit!</span>
<a name="l12567"></a>12567     $maxw = $container_w - $l_width - $r_width;
<a name="l12568"></a>12568     <span class="keywordflow">if</span> (($setwidth + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &gt; $maxw || ($maxw - ($currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &lt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) { 
<a name="l12569"></a>12569       <span class="comment">// Too narrow to fit - try to move down past L or R float</span>
<a name="l12570"></a>12570       <span class="keywordflow">if</span> ($l_max &lt; $r_max &amp;&amp; ($setwidth + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &lt;= ($container_w - $r_width) &amp;&amp; (($container_w - $r_width) - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l12571"></a>12571         $this-&gt;ClearFloats(<span class="stringliteral">&#39;LEFT&#39;</span>, $this-&gt;blklvl-1); 
<a name="l12572"></a>12572       }
<a name="l12573"></a>12573       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($r_max &lt; $l_max &amp;&amp; ($setwidth + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &lt;= ($container_w - $l_width) &amp;&amp; (($container_w - $l_width) - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l12574"></a>12574         $this-&gt;ClearFloats(<span class="stringliteral">&#39;RIGHT&#39;</span>, $this-&gt;blklvl-1); 
<a name="l12575"></a>12575       }
<a name="l12576"></a>12576       <span class="keywordflow">else</span> { $this-&gt;ClearFloats(<span class="stringliteral">&#39;BOTH&#39;</span>, $this-&gt;blklvl-1); }
<a name="l12577"></a>12577       list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl-1);
<a name="l12578"></a>12578     }
<a name="l12579"></a>12579 
<a name="l12580"></a>12580     <span class="keywordflow">if</span> ($l_exists) { $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] += $l_width; }
<a name="l12581"></a>12581 
<a name="l12582"></a>12582     $currblk[<span class="stringliteral">&#39;float&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l12583"></a>12583     $currblk[<span class="stringliteral">&#39;float_start_y&#39;</span>] = $this-&gt;y;
<a name="l12584"></a>12584     <span class="keywordflow">if</span> ($setwidth) {
<a name="l12585"></a>12585       $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = $container_w - ($setwidth + $bdl + $pdl + $bdr + $pdr + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>]);
<a name="l12586"></a>12586       $currblk[<span class="stringliteral">&#39;float_width&#39;</span>] = ($setwidth + $bdl + $pdl + $bdr + $pdr + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>]);
<a name="l12587"></a>12587     }
<a name="l12588"></a>12588     <span class="keywordflow">else</span> {
<a name="l12589"></a>12589       <span class="comment">// *** If no width set - would need to buffer and keep track of max width, then Right-align if not full width</span>
<a name="l12590"></a>12590       <span class="comment">// and do borders and backgrounds - For now - just set to maximum width left</span>
<a name="l12591"></a>12591 
<a name="l12592"></a>12592       <span class="keywordflow">if</span> ($r_exists) { $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] += $r_width; }
<a name="l12593"></a>12593       $currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] = $container_w - ($currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr);
<a name="l12594"></a>12594 
<a name="l12595"></a>12595       $currblk[<span class="stringliteral">&#39;float_width&#39;</span>] = ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] + $bdl + $pdl + $bdr + $pdr + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>]);
<a name="l12596"></a>12596     }
<a name="l12597"></a>12597   }
<a name="l12598"></a>12598 
<a name="l12599"></a>12599   <span class="keywordflow">else</span> {
<a name="l12600"></a>12600     <span class="comment">// Don&#39;t allow overlap - if floats present - adjust padding to avoid overlap with Floats</span>
<a name="l12601"></a>12601     list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl-1);
<a name="l12602"></a>12602     $maxw = $container_w - $l_width - $r_width;
<a name="l12603"></a>12603     <span class="keywordflow">if</span> (($setwidth + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &gt; $maxw || ($maxw - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &lt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) { 
<a name="l12604"></a>12604       <span class="comment">// Too narrow to fit - try to move down past L or R float</span>
<a name="l12605"></a>12605       <span class="keywordflow">if</span> ($l_max &lt; $r_max &amp;&amp; ($setwidth + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &lt;= ($container_w - $r_width) &amp;&amp; (($container_w - $r_width) - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l12606"></a>12606         $this-&gt;ClearFloats(<span class="stringliteral">&#39;LEFT&#39;</span>, $this-&gt;blklvl-1); 
<a name="l12607"></a>12607       }
<a name="l12608"></a>12608       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($r_max &lt; $l_max &amp;&amp; ($setwidth + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $bdl + $pdl + $bdr + $pdr) &lt;= ($container_w - $l_width) &amp;&amp; (($container_w - $l_width) - ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $bdl + $pdl + $bdr + $pdr)) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l12609"></a>12609         $this-&gt;ClearFloats(<span class="stringliteral">&#39;RIGHT&#39;</span>, $this-&gt;blklvl-1); 
<a name="l12610"></a>12610       }
<a name="l12611"></a>12611       <span class="keywordflow">else</span> { $this-&gt;ClearFloats(<span class="stringliteral">&#39;BOTH&#39;</span>, $this-&gt;blklvl-1); }
<a name="l12612"></a>12612       list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl-1);
<a name="l12613"></a>12613     }
<a name="l12614"></a>12614     <span class="keywordflow">if</span> ($r_exists) { $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>] = max(($r_width-$currblk[<span class="stringliteral">&#39;margin_right&#39;</span>]-$bdr), $pdr); }
<a name="l12615"></a>12615     <span class="keywordflow">if</span> ($l_exists) { $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] = max(($l_width-$currblk[<span class="stringliteral">&#39;margin_left&#39;</span>]-$bdl), $pdl); }
<a name="l12616"></a>12616   }
<a name="l12617"></a>12617 
<a name="l12618"></a>12618 
<a name="l12619"></a>12619 
<a name="l12620"></a>12620 
<a name="l12621"></a>12621   <span class="comment">// Hanging indent - if negative indent: ensure padding is &gt;= indent</span>
<a name="l12622"></a>12622   <span class="comment">// mPDF 4.0</span>
<a name="l12623"></a>12623   $cbti = $this-&gt;ConvertSize($currblk[<span class="stringliteral">&#39;text_indent&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l12624"></a>12624   <span class="keywordflow">if</span> ($cbti &lt; 0) {
<a name="l12625"></a>12625     $hangind = -($cbti);
<a name="l12626"></a>12626     $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] = max($currblk[<span class="stringliteral">&#39;padding_left&#39;</span>],$hangind);
<a name="l12627"></a>12627   }
<a name="l12628"></a>12628 
<a name="l12629"></a>12629   <span class="keywordflow">if</span> (isset($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>])) {
<a name="l12630"></a>12630     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]) &amp;&amp; isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l12631"></a>12631       <span class="comment">// Try to reduce margins to accomodate - if still too wide, set margin-right/left=0 (reduces width)</span>
<a name="l12632"></a>12632       $anyextra = $prevblk[<span class="stringliteral">&#39;inner_width&#39;</span>] - ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>]);
<a name="l12633"></a>12633       <span class="keywordflow">if</span> ($anyextra&gt;0) {
<a name="l12634"></a>12634       $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] = $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = $anyextra /2;
<a name="l12635"></a>12635       }
<a name="l12636"></a>12636       <span class="keywordflow">else</span> {
<a name="l12637"></a>12637       $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] = $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l12638"></a>12638       }
<a name="l12639"></a>12639     }
<a name="l12640"></a>12640     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l12641"></a>12641       <span class="comment">// Try to reduce margin-left to accomodate - if still too wide, set margin-left=0 (reduces width)</span>
<a name="l12642"></a>12642       $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] = $prevblk[<span class="stringliteral">&#39;inner_width&#39;</span>] - ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>]);
<a name="l12643"></a>12643       <span class="keywordflow">if</span> ($currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] &lt; 0) {
<a name="l12644"></a>12644       $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] = 0;
<a name="l12645"></a>12645       }
<a name="l12646"></a>12646     }
<a name="l12647"></a>12647     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l12648"></a>12648       <span class="comment">// Try to reduce margin-right to accomodate - if still too wide, set margin-right=0 (reduces width)</span>
<a name="l12649"></a>12649       $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = $prevblk[<span class="stringliteral">&#39;inner_width&#39;</span>] - ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>]);
<a name="l12650"></a>12650       <span class="keywordflow">if</span> ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] &lt; 0) {
<a name="l12651"></a>12651       $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l12652"></a>12652       }
<a name="l12653"></a>12653     }
<a name="l12654"></a>12654     <span class="keywordflow">else</span> { 
<a name="l12655"></a>12655     <span class="comment">// Try to reduce margin-left to accomodate - if still too wide, set margin-left=0 (reduces width)</span>
<a name="l12656"></a>12656       <span class="comment">// Try to reduce margin-right to accomodate - if still too wide, set margin-right=0 (reduces width)</span>
<a name="l12657"></a>12657       $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = $prevblk[<span class="stringliteral">&#39;inner_width&#39;</span>] - ($currblk[<span class="stringliteral">&#39;css_set_width&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>]);
<a name="l12658"></a>12658       <span class="keywordflow">if</span> ($currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] &lt; 0) {
<a name="l12659"></a>12659       $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l12660"></a>12660       }
<a name="l12661"></a>12661     }
<a name="l12662"></a>12662   }
<a name="l12663"></a>12663 
<a name="l12664"></a>12664   $currblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>] = $prevblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $prevblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $prevblk[<span class="stringliteral">&#39;padding_left&#39;</span>];
<a name="l12665"></a>12665   $currblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>] = $prevblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>]  + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $prevblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $prevblk[<span class="stringliteral">&#39;padding_right&#39;</span>];
<a name="l12666"></a>12666 
<a name="l12667"></a>12667   $currblk[<span class="stringliteral">&#39;width&#39;</span>] = $this-&gt;pgwidth - ($currblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>] + $currblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>]);
<a name="l12668"></a>12668   $currblk[<span class="stringliteral">&#39;inner_width&#39;</span>] = $currblk[<span class="stringliteral">&#39;width&#39;</span>] - ($currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>]);
<a name="l12669"></a>12669 
<a name="l12670"></a>12670   <span class="comment">// Check DIV is not now too narrow to fit text</span>
<a name="l12671"></a>12671   $mw = $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>);
<a name="l12672"></a>12672   <span class="keywordflow">if</span> ($currblk[<span class="stringliteral">&#39;inner_width&#39;</span>] &lt; $mw) {
<a name="l12673"></a>12673     $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] = 0;
<a name="l12674"></a>12674     $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>] = 0;
<a name="l12675"></a>12675     $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0.2;
<a name="l12676"></a>12676     $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0.2;
<a name="l12677"></a>12677     $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] = 0;
<a name="l12678"></a>12678     $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l12679"></a>12679     $currblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>] = $prevblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $currblk[<span class="stringliteral">&#39;margin_left&#39;</span>] + $prevblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $prevblk[<span class="stringliteral">&#39;padding_left&#39;</span>];
<a name="l12680"></a>12680     $currblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>] = $prevblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>]  + $currblk[<span class="stringliteral">&#39;margin_right&#39;</span>] + $prevblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $prevblk[<span class="stringliteral">&#39;padding_right&#39;</span>];
<a name="l12681"></a>12681     $currblk[<span class="stringliteral">&#39;width&#39;</span>] = $this-&gt;pgwidth - ($currblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>] + $currblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>]);
<a name="l12682"></a>12682     $currblk[<span class="stringliteral">&#39;inner_width&#39;</span>] = $this-&gt;pgwidth - ($currblk[<span class="stringliteral">&#39;outer_right_margin&#39;</span>] + $currblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_left&#39;</span>] + $currblk[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $currblk[<span class="stringliteral">&#39;padding_right&#39;</span>]);
<a name="l12683"></a>12683 <span class="comment">//    if ($currblk[&#39;inner_width&#39;] &lt; $mw) { $this-&gt;Error(&quot;DIV is too narrow for text to fit!&quot;); }</span>
<a name="l12684"></a>12684   }
<a name="l12685"></a>12685 
<a name="l12686"></a>12686   $this-&gt;x = $this-&gt;lMargin + $currblk[<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l12687"></a>12687 
<a name="l12688"></a>12688   <span class="comment">// mPDF 4.3.011</span>
<a name="l12689"></a>12689   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] &amp;&amp; !$this-&gt;kwt &amp;&amp; !$this-&gt;ColActive &amp;&amp; !$this-&gt;keep_block_together) {
<a name="l12690"></a>12690     $file = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>];
<a name="l12691"></a>12691     $sizesarray = $this-&gt;Image($file,0,0,0,0,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);  <span class="comment">// mPDF 4.3.012D</span>
<a name="l12692"></a>12692     <span class="keywordflow">if</span> (isset($sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>])) {
<a name="l12693"></a>12693       $image_id = $sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>];
<a name="l12694"></a>12694       $orig_w = $sizesarray[<span class="stringliteral">&#39;WIDTH&#39;</span>]*$this-&gt;k;    <span class="comment">// in user units i.e. mm</span>
<a name="l12695"></a>12695       $orig_h = $sizesarray[<span class="stringliteral">&#39;HEIGHT&#39;</span>]*$this-&gt;k;   <span class="comment">// (using $this-&gt;img_dpi)</span>
<a name="l12696"></a>12696       $x_repeat = <span class="keyword">true</span>;
<a name="l12697"></a>12697       $y_repeat = <span class="keyword">true</span>;
<a name="l12698"></a>12698       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>])) {
<a name="l12699"></a>12699         <span class="keywordflow">if</span> ($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-x&#39;</span>) { $y_repeat = <span class="keyword">false</span>; }
<a name="l12700"></a>12700         <span class="keywordflow">if</span> ($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-y&#39;</span>) { $x_repeat = <span class="keyword">false</span>; }
<a name="l12701"></a>12701       }
<a name="l12702"></a>12702       $x_pos = 0;
<a name="l12703"></a>12703       $y_pos = 0;
<a name="l12704"></a>12704       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>])) { 
<a name="l12705"></a>12705         $ppos = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$properties[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]);
<a name="l12706"></a>12706         $x_pos = $ppos[0];
<a name="l12707"></a>12707         $y_pos = $ppos[1];
<a name="l12708"></a>12708         <span class="keywordflow">if</span> (!stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $x_pos = $this-&gt;ConvertSize($x_pos ,$currblk[<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize); }
<a name="l12709"></a>12709         <span class="keywordflow">if</span> (!stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $y_pos = $this-&gt;ConvertSize($y_pos ,$currblk[<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize); }
<a name="l12710"></a>12710       }
<a name="l12711"></a>12711       <span class="comment">// mPDF 4.3.015</span>
<a name="l12712"></a>12712       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>])) { $resize = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>]; }
<a name="l12713"></a>12713       <span class="keywordflow">else</span> { $resize = 0; }
<a name="l12714"></a>12714       <span class="comment">// mPDF 4.3.017</span>
<a name="l12715"></a>12715       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>])) { $opacity = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>]; }
<a name="l12716"></a>12716       <span class="keywordflow">else</span> { $opacity = 1; }
<a name="l12717"></a>12717       $currblk[<span class="stringliteral">&#39;background-image&#39;</span>] = array(<span class="stringliteral">&#39;image_id&#39;</span>=&gt;$image_id, <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$x_pos, <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$y_pos, <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat, <span class="stringliteral">&#39;resize&#39;</span>=&gt;$resize, <span class="stringliteral">&#39;opacity&#39;</span>=&gt;$opacity);  <span class="comment">// mPDF 4.3.015  4.3.017</span>
<a name="l12718"></a>12718     }
<a name="l12719"></a>12719   }
<a name="l12720"></a>12720 
<a name="l12721"></a>12721   <span class="keywordflow">if</span> ($this-&gt;use_kwt &amp;&amp; isset($attr[<span class="stringliteral">&#39;KEEP-WITH-TABLE&#39;</span>]) &amp;&amp; !$this-&gt;ColActive &amp;&amp; !$this-&gt;keep_block_together) {
<a name="l12722"></a>12722     $this-&gt;kwt = <span class="keyword">true</span>;
<a name="l12723"></a>12723     $this-&gt;kwt_y0 = $this-&gt;y;
<a name="l12724"></a>12724     $this-&gt;kwt_x0 = $this-&gt;x;
<a name="l12725"></a>12725     $this-&gt;kwt_height = 0;
<a name="l12726"></a>12726     $this-&gt;kwt_buffer = array();
<a name="l12727"></a>12727     $this-&gt;kwt_Links = array();
<a name="l12728"></a>12728     $this-&gt;kwt_Annots = array();
<a name="l12729"></a>12729     $this-&gt;kwt_moved = <span class="keyword">false</span>;
<a name="l12730"></a>12730     $this-&gt;kwt_saved = <span class="keyword">false</span>;
<a name="l12731"></a>12731     <span class="comment">// mPDF 3.0</span>
<a name="l12732"></a>12732     $this-&gt;kwt_Reference = array();
<a name="l12733"></a>12733     $this-&gt;kwt_BMoutlines = array();
<a name="l12734"></a>12734     $this-&gt;kwt_toc = array();
<a name="l12735"></a>12735   }
<a name="l12736"></a>12736   <span class="keywordflow">else</span> { 
<a name="l12737"></a>12737     $this-&gt;kwt = <span class="keyword">false</span>; 
<a name="l12738"></a>12738   } <span class="comment">// *TABLES*</span>
<a name="l12739"></a>12739 
<a name="l12740"></a>12740   <span class="comment">//Save x,y coords in case we need to print borders...</span>
<a name="l12741"></a>12741   $currblk[<span class="stringliteral">&#39;y0&#39;</span>] = $this-&gt;y;
<a name="l12742"></a>12742   $currblk[<span class="stringliteral">&#39;x0&#39;</span>] = $this-&gt;x;
<a name="l12743"></a>12743   $currblk[<span class="stringliteral">&#39;startpage&#39;</span>] = $this-&gt;page;
<a name="l12744"></a>12744   $this-&gt;oldy = $this-&gt;y;
<a name="l12745"></a>12745 
<a name="l12746"></a>12746   $this-&gt;lastblocklevelchange = 1 ;
<a name="l12747"></a>12747 
<a name="l12748"></a>12748   <span class="keywordflow">break</span>;
<a name="l12749"></a>12749 
<a name="l12750"></a>12750     <span class="keywordflow">case</span> <span class="stringliteral">&#39;HR&#39;</span>:
<a name="l12751"></a>12751   <span class="comment">// Added mPDF 3.0 Float DIV - CLEAR</span>
<a name="l12752"></a>12752   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;STYLE&#39;</span>])) {
<a name="l12753"></a>12753     $properties = $this-&gt;readInlineCSS($attr[<span class="stringliteral">&#39;STYLE&#39;</span>]);
<a name="l12754"></a>12754     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;CLEAR&#39;</span>])) { $this-&gt;ClearFloats(strtoupper($properties[<span class="stringliteral">&#39;CLEAR&#39;</span>]),$this-&gt;blklvl); }  <span class="comment">// *CSS-FLOAT*</span>
<a name="l12755"></a>12755   }
<a name="l12756"></a>12756 
<a name="l12757"></a>12757   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l12758"></a>12758 
<a name="l12759"></a>12759   $objattr = array();
<a name="l12760"></a>12760     <span class="comment">// mPDF 3.0</span>
<a name="l12761"></a>12761     $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] = 0;
<a name="l12762"></a>12762     $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>] = 0;
<a name="l12763"></a>12763     $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] = 0;
<a name="l12764"></a>12764     $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l12765"></a>12765     $objattr[<span class="stringliteral">&#39;width&#39;</span>] = 0;
<a name="l12766"></a>12766     $objattr[<span class="stringliteral">&#39;height&#39;</span>] = 0;
<a name="l12767"></a>12767     $objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12768"></a>12768     $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12769"></a>12769     $objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12770"></a>12770     $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12771"></a>12771   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;&#39;</span>,$tag,$attr);
<a name="l12772"></a>12772   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])) { $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12773"></a>12773   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])) { $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12774"></a>12774   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>])) { $objattr[<span class="stringliteral">&#39;width&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]); }
<a name="l12775"></a>12775   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) { $objattr[<span class="stringliteral">&#39;align&#39;</span>] = $align[strtolower($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])]; }
<a name="l12776"></a>12776   <span class="comment">// mPDF 3.0</span>
<a name="l12777"></a>12777   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l12778"></a>12778     $objattr[<span class="stringliteral">&#39;align&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l12779"></a>12779   }
<a name="l12780"></a>12780   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l12781"></a>12781     $objattr[<span class="stringliteral">&#39;align&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l12782"></a>12782     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l12783"></a>12783       $objattr[<span class="stringliteral">&#39;align&#39;</span>] = <span class="charliteral">&#39;C&#39;</span>;
<a name="l12784"></a>12784     }
<a name="l12785"></a>12785   }
<a name="l12786"></a>12786   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) { $objattr[<span class="stringliteral">&#39;color&#39;</span>] = $this-&gt;ConvertColor($properties[<span class="stringliteral">&#39;COLOR&#39;</span>]); }
<a name="l12787"></a>12787   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;linewidth&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12788"></a>12788 
<a name="l12789"></a>12789   <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>) $objattr[<span class="stringliteral">&#39;width&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]);
<a name="l12790"></a>12790   <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;ALIGN&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>) $objattr[<span class="stringliteral">&#39;align&#39;</span>] = $align[strtolower($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>])];
<a name="l12791"></a>12791   <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;COLOR&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;COLOR&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>) $objattr[<span class="stringliteral">&#39;color&#39;</span>] = $this-&gt;ConvertColor($attr[<span class="stringliteral">&#39;COLOR&#39;</span>]);
<a name="l12792"></a>12792 
<a name="l12793"></a>12793   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l12794"></a>12794     $objattr[<span class="stringliteral">&#39;W-PERCENT&#39;</span>] = 100;
<a name="l12795"></a>12795     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>]) &amp;&amp; stristr($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>],<span class="charliteral">&#39;%&#39;</span>)) { 
<a name="l12796"></a>12796       $properties[<span class="stringliteral">&#39;WIDTH&#39;</span>] += 0;  <span class="comment">//make &quot;90%&quot; become simply &quot;90&quot; </span>
<a name="l12797"></a>12797       $objattr[<span class="stringliteral">&#39;W-PERCENT&#39;</span>] = $properties[<span class="stringliteral">&#39;WIDTH&#39;</span>];
<a name="l12798"></a>12798     }
<a name="l12799"></a>12799     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]) &amp;&amp; stristr($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>],<span class="charliteral">&#39;%&#39;</span>)) { 
<a name="l12800"></a>12800       $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>] += 0;  <span class="comment">//make &quot;90%&quot; become simply &quot;90&quot; </span>
<a name="l12801"></a>12801       $objattr[<span class="stringliteral">&#39;W-PERCENT&#39;</span>] = $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>];
<a name="l12802"></a>12802     }
<a name="l12803"></a>12803   }
<a name="l12804"></a>12804 
<a name="l12805"></a>12805   $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;hr&#39;</span>;
<a name="l12806"></a>12806   $objattr[<span class="stringliteral">&#39;height&#39;</span>] = $objattr[<span class="stringliteral">&#39;linewidth&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>];
<a name="l12807"></a>12807   $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=image,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l12808"></a>12808 
<a name="l12809"></a>12809   <span class="comment">// Clear properties - tidy up</span>
<a name="l12810"></a>12810   $properties = array();
<a name="l12811"></a>12811 
<a name="l12812"></a>12812   <span class="comment">// Output it to buffers</span>
<a name="l12813"></a>12813   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l12814"></a>12814     <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l12815"></a>12815       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>];
<a name="l12816"></a>12816     }
<a name="l12817"></a>12817     elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l12818"></a>12818       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l12819"></a>12819     }
<a name="l12820"></a>12820     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0 ;<span class="comment">// reset</span>
<a name="l12821"></a>12821     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l12822"></a>12822   }
<a name="l12823"></a>12823   <span class="keywordflow">else</span> {
<a name="l12824"></a>12824     $this-&gt;textbuffer[] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l12825"></a>12825   } <span class="comment">// *TABLES*</span>
<a name="l12826"></a>12826 
<a name="l12827"></a>12827   <span class="keywordflow">break</span>;
<a name="l12828"></a>12828 
<a name="l12829"></a>12829 
<a name="l12830"></a>12830 
<a name="l12831"></a>12831 
<a name="l12832"></a>12832   <span class="comment">// *********** FORM ELEMENTS ********************</span>
<a name="l12833"></a>12833 
<a name="l12834"></a>12834 
<a name="l12835"></a>12835 
<a name="l12836"></a>12836   <span class="comment">// *********** GRAPH  ********************</span>
<a name="l12837"></a>12837      <span class="keywordflow">case</span> <span class="stringliteral">&#39;JPGRAPH&#39;</span>:
<a name="l12838"></a>12838   <span class="keywordflow">if</span> (!$this-&gt;useGraphs) { <span class="keywordflow">break</span>; }
<a name="l12839"></a>12839   <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;TABLE&#39;</span>]) { $gid = strtoupper($attr[<span class="stringliteral">&#39;TABLE&#39;</span>]); }
<a name="l12840"></a>12840   <span class="keywordflow">else</span> { $gid = <span class="charliteral">&#39;0&#39;</span>; }
<a name="l12841"></a>12841   <span class="keywordflow">if</span> (!is_array($this-&gt;graphs[$gid]) || count($this-&gt;graphs[$gid])==0 ) { <span class="keywordflow">break</span>; }
<a name="l12842"></a>12842   include_once(_MPDF_PATH.<span class="stringliteral">&#39;graph.php&#39;</span>);
<a name="l12843"></a>12843   $this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>] = $attr;
<a name="l12844"></a>12844 
<a name="l12845"></a>12845   <span class="comment">// mPDF 4.0</span>
<a name="l12846"></a>12846   <span class="keywordflow">if</span> (isset($this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;WIDTH&#39;</span>]) &amp;&amp; $this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;WIDTH&#39;</span>]) { 
<a name="l12847"></a>12847     $this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;cWIDTH&#39;</span>]=$this-&gt;ConvertSize($this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;WIDTH&#39;</span>],$pgwidth); 
<a name="l12848"></a>12848   } <span class="comment">// mm</span>
<a name="l12849"></a>12849   <span class="keywordflow">if</span> (isset($this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;HEIGHT&#39;</span>]) &amp;&amp; $this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;HEIGHT&#39;</span>]) { 
<a name="l12850"></a>12850     $this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;cHEIGHT&#39;</span>]=$this-&gt;ConvertSize($this-&gt;graphs[$gid][<span class="stringliteral">&#39;attr&#39;</span>][<span class="stringliteral">&#39;HEIGHT&#39;</span>],$pgwidth); 
<a name="l12851"></a>12851   }
<a name="l12852"></a>12852 
<a name="l12853"></a>12853   $graph_img = print_graph($this-&gt;graphs[$gid],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]);
<a name="l12854"></a>12854   <span class="keywordflow">if</span> ($graph_img) { 
<a name="l12855"></a>12855     <span class="comment">// mPDF 4.3.016</span>
<a name="l12856"></a>12856     <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;ROTATE&#39;</span>])) {
<a name="l12857"></a>12857        <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;ROTATE&#39;</span>]==90 || $attr[<span class="stringliteral">&#39;ROTATE&#39;</span>]==-90) {
<a name="l12858"></a>12858       $tmpw = $graph_img[<span class="charliteral">&#39;w&#39;</span>];
<a name="l12859"></a>12859       $graph_img[<span class="charliteral">&#39;w&#39;</span>]= $graph_img[<span class="charliteral">&#39;h&#39;</span>];
<a name="l12860"></a>12860       $graph_img[<span class="charliteral">&#39;h&#39;</span>]= $tmpw;
<a name="l12861"></a>12861        }
<a name="l12862"></a>12862     }
<a name="l12863"></a>12863     $attr[<span class="stringliteral">&#39;SRC&#39;</span>] = $graph_img[<span class="stringliteral">&#39;file&#39;</span>]; 
<a name="l12864"></a>12864     $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>] = $graph_img[<span class="charliteral">&#39;w&#39;</span>]; 
<a name="l12865"></a>12865     $attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>] = $graph_img[<span class="charliteral">&#39;h&#39;</span>]; 
<a name="l12866"></a>12866   }
<a name="l12867"></a>12867   <span class="keywordflow">else</span> { <span class="keywordflow">break</span>; }
<a name="l12868"></a>12868 
<a name="l12869"></a>12869   <span class="comment">// *********** IMAGE  ********************</span>
<a name="l12870"></a>12870     <span class="keywordflow">case</span> <span class="stringliteral">&#39;IMG&#39;</span>:
<a name="l12871"></a>12871   $objattr = array();
<a name="l12872"></a>12872     $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] = 0;
<a name="l12873"></a>12873     $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>] = 0;
<a name="l12874"></a>12874     $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] = 0;
<a name="l12875"></a>12875     $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>] = 0;
<a name="l12876"></a>12876     <span class="comment">// mPDF 4.0</span>
<a name="l12877"></a>12877     $objattr[<span class="stringliteral">&#39;padding_top&#39;</span>] = 0;
<a name="l12878"></a>12878     $objattr[<span class="stringliteral">&#39;padding_bottom&#39;</span>] = 0;
<a name="l12879"></a>12879     $objattr[<span class="stringliteral">&#39;padding_left&#39;</span>] = 0;
<a name="l12880"></a>12880     $objattr[<span class="stringliteral">&#39;padding_right&#39;</span>] = 0;
<a name="l12881"></a>12881     $objattr[<span class="stringliteral">&#39;width&#39;</span>] = 0;
<a name="l12882"></a>12882     $objattr[<span class="stringliteral">&#39;height&#39;</span>] = 0;
<a name="l12883"></a>12883     $objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12884"></a>12884     $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12885"></a>12885     $objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12886"></a>12886     $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l12887"></a>12887   <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;SRC&#39;</span>])) {
<a name="l12888"></a>12888         $srcpath = $attr[<span class="stringliteral">&#39;SRC&#39;</span>];
<a name="l12889"></a>12889     $orig_srcpath = $attr[<span class="stringliteral">&#39;ORIG_SRC&#39;</span>]; <span class="comment">// mPDF 4.2.029</span>
<a name="l12890"></a>12890     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;&#39;</span>,$tag,$attr);
<a name="l12891"></a>12891     <span class="keywordflow">if</span>(isset($properties [<span class="stringliteral">&#39;DISPLAY&#39;</span>]) &amp;&amp; strtolower($properties [<span class="stringliteral">&#39;DISPLAY&#39;</span>])==<span class="stringliteral">&#39;none&#39;</span>) { 
<a name="l12892"></a>12892       <span class="keywordflow">return</span>; 
<a name="l12893"></a>12893     }
<a name="l12894"></a>12894     <span class="comment">// VSPACE and HSPACE converted to margins in MergeCSS</span>
<a name="l12895"></a>12895     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])) { $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]=$this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12896"></a>12896     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])) { $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12897"></a>12897     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12898"></a>12898     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12899"></a>12899 
<a name="l12900"></a>12900     <span class="comment">// mPDF 4.0</span>
<a name="l12901"></a>12901     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>])) { $objattr[<span class="stringliteral">&#39;padding_top&#39;</span>]=$this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12902"></a>12902     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>])) { $objattr[<span class="stringliteral">&#39;padding_bottom&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12903"></a>12903     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;padding_left&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12904"></a>12904     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;padding_right&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l12905"></a>12905 
<a name="l12906"></a>12906     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>])) { $objattr[<span class="stringliteral">&#39;border_top&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]); }
<a name="l12907"></a>12907     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>])) { $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]); }
<a name="l12908"></a>12908     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;border_left&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]); }
<a name="l12909"></a>12909     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>])) { $objattr[<span class="stringliteral">&#39;border_right&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]); }
<a name="l12910"></a>12910 
<a name="l12911"></a>12911     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])) { $objattr[<span class="stringliteral">&#39;vertical-align&#39;</span>] = $align[strtolower($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])]; }
<a name="l12912"></a>12912     $w = 0;
<a name="l12913"></a>12913     $h = 0;
<a name="l12914"></a>12914     <span class="comment">// mPDF 4.0</span>
<a name="l12915"></a>12915     <span class="keywordflow">if</span>(isset($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>])) $w = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l12916"></a>12916     <span class="keywordflow">if</span>(isset($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>])) $h = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l12917"></a>12917 
<a name="l12918"></a>12918     <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>])) $w = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l12919"></a>12919     <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>])) $h = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l12920"></a>12920     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;OPACITY&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;OPACITY&#39;</span>] &gt; 0 &amp;&amp; $properties[<span class="stringliteral">&#39;OPACITY&#39;</span>] &lt;= 1) { $objattr[<span class="stringliteral">&#39;opacity&#39;</span>] = $properties[<span class="stringliteral">&#39;OPACITY&#39;</span>]; }
<a name="l12921"></a>12921     <span class="keywordflow">if</span> ($this-&gt;HREF) { $objattr[<span class="stringliteral">&#39;link&#39;</span>] = $this-&gt;HREF; }  <span class="comment">// ? this isn&#39;t used</span>
<a name="l12922"></a>12922 
<a name="l12923"></a>12923     <span class="comment">// mPDF 4.0</span>
<a name="l12924"></a>12924     $extraheight = $objattr[<span class="stringliteral">&#39;padding_top&#39;</span>] + $objattr[<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l12925"></a>12925     $extrawidth = $objattr[<span class="stringliteral">&#39;padding_left&#39;</span>] + $objattr[<span class="stringliteral">&#39;padding_right&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l12926"></a>12926     <span class="comment">// Image file</span>
<a name="l12927"></a>12927     $info=$this-&gt;_getImage($srcpath, <span class="keyword">true</span>, <span class="keyword">true</span>, $orig_srcpath); <span class="comment">// mPDF 4.2.029</span>
<a name="l12928"></a>12928     <span class="keywordflow">if</span>(!$info) {
<a name="l12929"></a>12929       $info = $this-&gt;_getImage($this-&gt;noImageFile);
<a name="l12930"></a>12930       <span class="keywordflow">if</span> ($info) { 
<a name="l12931"></a>12931         $srcpath = $this-&gt;noImageFile; 
<a name="l12932"></a>12932         $w = ($info[<span class="charliteral">&#39;w&#39;</span>] * 0.2645);   <span class="comment">// 14 x 16px</span>
<a name="l12933"></a>12933         $h = ($info[<span class="charliteral">&#39;h&#39;</span>] * 0.2645);   <span class="comment">// 14 x 16px</span>
<a name="l12934"></a>12934       }
<a name="l12935"></a>12935     }
<a name="l12936"></a>12936     <span class="keywordflow">if</span>(!$info) <span class="keywordflow">break</span>;
<a name="l12937"></a>12937 
<a name="l12938"></a>12938     <span class="comment">// mPDF 4.3.016</span>
<a name="l12939"></a>12939     <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;ROTATE&#39;</span>])) {
<a name="l12940"></a>12940        <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;ROTATE&#39;</span>]==90 || $attr[<span class="stringliteral">&#39;ROTATE&#39;</span>]==-90) {
<a name="l12941"></a>12941       $tmpw = $info[<span class="charliteral">&#39;w&#39;</span>];
<a name="l12942"></a>12942       $info[<span class="charliteral">&#39;w&#39;</span>] = $info[<span class="charliteral">&#39;h&#39;</span>];
<a name="l12943"></a>12943       $info[<span class="charliteral">&#39;h&#39;</span>] = $tmpw;
<a name="l12944"></a>12944        }
<a name="l12945"></a>12945        $objattr[<span class="stringliteral">&#39;ROTATE&#39;</span>] = $attr[<span class="stringliteral">&#39;ROTATE&#39;</span>];
<a name="l12946"></a>12946     }
<a name="l12947"></a>12947 
<a name="l12948"></a>12948     $objattr[<span class="stringliteral">&#39;file&#39;</span>] = $srcpath;
<a name="l12949"></a>12949     <span class="comment">//Default width and height calculation if needed</span>
<a name="l12950"></a>12950     <span class="keywordflow">if</span>($w==0 and $h==0) {
<a name="l12951"></a>12951       <span class="comment">// mPDF 4.3.013</span>
<a name="l12952"></a>12952               <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;svg&#39;</span>) { 
<a name="l12953"></a>12953         <span class="comment">// SVG units are pixels</span>
<a name="l12954"></a>12954         $w = abs($info[<span class="charliteral">&#39;w&#39;</span>])/$this-&gt;k;
<a name="l12955"></a>12955         $h = abs($info[<span class="charliteral">&#39;h&#39;</span>])/$this-&gt;k;
<a name="l12956"></a>12956       }
<a name="l12957"></a>12957       <span class="keywordflow">else</span> {
<a name="l12958"></a>12958         <span class="comment">//Put image at default dpi</span>
<a name="l12959"></a>12959         $w=($info[<span class="charliteral">&#39;w&#39;</span>]/$this-&gt;k) * (72/$this-&gt;img_dpi);
<a name="l12960"></a>12960         $h=($info[<span class="charliteral">&#39;h&#39;</span>]/$this-&gt;k) * (72/$this-&gt;img_dpi);
<a name="l12961"></a>12961       }
<a name="l12962"></a>12962     }
<a name="l12963"></a>12963     <span class="comment">// IF WIDTH OR HEIGHT SPECIFIED</span>
<a name="l12964"></a>12964     <span class="keywordflow">if</span>($w==0)  $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]); 
<a name="l12965"></a>12965     <span class="keywordflow">if</span>($h==0) $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l12966"></a>12966 
<a name="l12967"></a>12967     <span class="comment">// Resize to maximum dimensions of page</span>
<a name="l12968"></a>12968     $maxWidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l12969"></a>12969       $maxHeight = $this-&gt;h - ($this-&gt;tMargin + $this-&gt;bMargin + 10) ;  <span class="comment">// mPDF 4.1</span>
<a name="l12970"></a>12970     <span class="keywordflow">if</span> ($this-&gt;fullImageHeight) { $maxHeight = $this-&gt;fullImageHeight; }  <span class="comment">// mPDF 4.1</span>
<a name="l12971"></a>12971     <span class="keywordflow">if</span> ($w + $extrawidth &gt; $maxWidth ) {
<a name="l12972"></a>12972       $w = $maxWidth - $extrawidth;
<a name="l12973"></a>12973       $h=abs($w*$info[<span class="charliteral">&#39;h&#39;</span>]/$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l12974"></a>12974     }
<a name="l12975"></a>12975 
<a name="l12976"></a>12976     <span class="keywordflow">if</span> ($h + $extraheight &gt; $maxHeight ) {
<a name="l12977"></a>12977       $h = $maxHeight - $extraheight;
<a name="l12978"></a>12978       $w=abs($h*$info[<span class="charliteral">&#39;w&#39;</span>]/$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l12979"></a>12979     }
<a name="l12980"></a>12980     $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;image&#39;</span>;
<a name="l12981"></a>12981     $objattr[<span class="stringliteral">&#39;itype&#39;</span>] = $info[<span class="stringliteral">&#39;type&#39;</span>];
<a name="l12982"></a>12982     $objattr[<span class="stringliteral">&#39;orig_h&#39;</span>] = $info[<span class="charliteral">&#39;h&#39;</span>];
<a name="l12983"></a>12983     $objattr[<span class="stringliteral">&#39;orig_w&#39;</span>] = $info[<span class="charliteral">&#39;w&#39;</span>];
<a name="l12984"></a>12984     <span class="comment">// mPDF 4.3.013</span>
<a name="l12985"></a>12985     <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;svg&#39;</span>) {
<a name="l12986"></a>12986       $objattr[<span class="stringliteral">&#39;wmf_x&#39;</span>] = $info[<span class="charliteral">&#39;x&#39;</span>];
<a name="l12987"></a>12987       $objattr[<span class="stringliteral">&#39;wmf_y&#39;</span>] = $info[<span class="charliteral">&#39;y&#39;</span>];
<a name="l12988"></a>12988     }
<a name="l12989"></a>12989     $objattr[<span class="stringliteral">&#39;height&#39;</span>] = $h + $extraheight;
<a name="l12990"></a>12990     $objattr[<span class="stringliteral">&#39;width&#39;</span>] = $w + $extrawidth;
<a name="l12991"></a>12991     $objattr[<span class="stringliteral">&#39;image_height&#39;</span>] = $h;
<a name="l12992"></a>12992     $objattr[<span class="stringliteral">&#39;image_width&#39;</span>] = $w;
<a name="l12993"></a>12993     <span class="keywordflow">if</span> (!$this-&gt;ColActive &amp;&amp; !$this-&gt;tableLevel &amp;&amp; !$this-&gt;listlvl &amp;&amp; !$this-&gt;kwt &amp;&amp; !$this-&gt;keep_block_together) {
<a name="l12994"></a>12994       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) &amp;&amp; (strtoupper($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) == <span class="stringliteral">&#39;RIGHT&#39;</span> || strtoupper($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]) == <span class="stringliteral">&#39;LEFT&#39;</span>)) {
<a name="l12995"></a>12995       $objattr[<span class="stringliteral">&#39;float&#39;</span>] = substr(strtoupper($properties[<span class="stringliteral">&#39;FLOAT&#39;</span>]),0,1);
<a name="l12996"></a>12996       }
<a name="l12997"></a>12997     }
<a name="l12998"></a>12998 
<a name="l12999"></a>12999     $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=image,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l13000"></a>13000 
<a name="l13001"></a>13001     <span class="comment">// Clear properties - tidy up</span>
<a name="l13002"></a>13002     $properties = array();
<a name="l13003"></a>13003 
<a name="l13004"></a>13004     <span class="comment">// Output it to buffers</span>
<a name="l13005"></a>13005     <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l13006"></a>13006       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l13007"></a>13007       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] += $objattr[<span class="stringliteral">&#39;width&#39;</span>] ;
<a name="l13008"></a>13008     }
<a name="l13009"></a>13009     <span class="keywordflow">else</span> {
<a name="l13010"></a>13010       $this-&gt;textbuffer[] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l13011"></a>13011 
<a name="l13012"></a>13012     } <span class="comment">// *TABLES*</span>
<a name="l13013"></a>13013   }
<a name="l13014"></a>13014   <span class="keywordflow">break</span>;
<a name="l13015"></a>13015 
<a name="l13016"></a>13016 
<a name="l13017"></a>13017 
<a name="l13018"></a>13018     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TABLE&#39;</span>: <span class="comment">// TABLE-BEGIN</span>
<a name="l13019"></a>13019   $this-&gt;tdbegin = <span class="keyword">false</span>;
<a name="l13020"></a>13020   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13021"></a>13021   <span class="comment">// Disable vertical justification in columns</span>
<a name="l13022"></a>13022   <span class="keywordflow">if</span> ($this-&gt;lastblocklevelchange == 1) { $blockstate = 1; }  <span class="comment">// Top margins/padding only</span>
<a name="l13023"></a>13023   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;lastblocklevelchange &lt; 1) { $blockstate = 0; }  <span class="comment">// NO margins/padding</span>
<a name="l13024"></a>13024   <span class="comment">// called from block after new div e.g. &lt;div&gt; ... &lt;table&gt; ...    Outputs block top margin/border and padding</span>
<a name="l13025"></a>13025   <span class="keywordflow">if</span> (count($this-&gt;textbuffer) == 0 &amp;&amp; $this-&gt;lastblocklevelchange == 1 &amp;&amp; !$this-&gt;tableLevel &amp;&amp; !$this-&gt;kwt) {
<a name="l13026"></a>13026     $this-&gt;newFlowingBlock( $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;width&#39;</span>],$this-&gt;lineheight,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,1,<span class="keyword">true</span>);  <span class="comment">// true = newblock</span>
<a name="l13027"></a>13027     $this-&gt;finishFlowingBlock(<span class="keyword">true</span>);  <span class="comment">// true = END of flowing block</span>
<a name="l13028"></a>13028   }
<a name="l13029"></a>13029   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$this-&gt;tableLevel &amp;&amp; count($this-&gt;textbuffer)) { $this-&gt;printbuffer($this-&gt;textbuffer,$blockstate); }
<a name="l13030"></a>13030   <span class="comment">//else if (!$this-&gt;tableLevel) { $this-&gt;printbuffer($this-&gt;textbuffer,$blockstate); }</span>
<a name="l13031"></a>13031 
<a name="l13032"></a>13032   $this-&gt;textbuffer=array();
<a name="l13033"></a>13033   $this-&gt;lastblocklevelchange = -1;
<a name="l13034"></a>13034   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {  <span class="comment">// i.e. now a nested table coming...</span>
<a name="l13035"></a>13035     <span class="comment">// Save current level table</span>
<a name="l13036"></a>13036     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;baseProperties&#39;</span>]= $this-&gt;base_table_properties;
<a name="l13037"></a>13037   <span class="comment">//  $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][&#39;tablecascadeCSS&#39;] = $this-&gt;tablecascadeCSS;</span>
<a name="l13038"></a>13038     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cells&#39;</span>] = $this-&gt;cell;
<a name="l13039"></a>13039     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;currrow&#39;</span>] = $this-&gt;row;
<a name="l13040"></a>13040     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;currcol&#39;</span>] = $this-&gt;col;
<a name="l13041"></a>13041   }
<a name="l13042"></a>13042   $this-&gt;tableLevel++;
<a name="l13043"></a>13043   $this-&gt;tbCSSlvl++;
<a name="l13044"></a>13044 
<a name="l13045"></a>13045   <span class="comment">// mPDF 3.0</span>
<a name="l13046"></a>13046   <span class="keywordflow">if</span> (isset($this-&gt;tbctr[$this-&gt;tableLevel])) { $this-&gt;tbctr[$this-&gt;tableLevel]++; }
<a name="l13047"></a>13047   <span class="keywordflow">else</span> { $this-&gt;tbctr[$this-&gt;tableLevel] = 1; }
<a name="l13048"></a>13048 
<a name="l13049"></a>13049   $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;level&#39;</span>] = $this-&gt;tableLevel;
<a name="l13050"></a>13050   $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;levelid&#39;</span>] = $this-&gt;tbctr[$this-&gt;tableLevel];
<a name="l13051"></a>13051 
<a name="l13052"></a>13052   <span class="keywordflow">if</span> ($this-&gt;tableLevel &gt; $this-&gt;innermostTableLevel) { $this-&gt;innermostTableLevel = $this-&gt;tableLevel; }
<a name="l13053"></a>13053   <span class="keywordflow">if</span> ($this-&gt;tableLevel &gt; 1) { 
<a name="l13054"></a>13054     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nestedpos&#39;</span>] = array($this-&gt;row,$this-&gt;col,$this-&gt;tbctr[($this-&gt;tableLevel-1)]); 
<a name="l13055"></a>13055   }
<a name="l13056"></a>13056   <span class="comment">//++++++++++++++++++++++++++++</span>
<a name="l13057"></a>13057 
<a name="l13058"></a>13058   $this-&gt;cell = array();
<a name="l13059"></a>13059   $this-&gt;col=-1; <span class="comment">//int</span>
<a name="l13060"></a>13060   $this-&gt;row=-1; <span class="comment">//int</span>
<a name="l13061"></a>13061   $table = &amp;$this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]];
<a name="l13062"></a>13062  
<a name="l13063"></a>13063   <span class="comment">// mPDF 3.0</span>
<a name="l13064"></a>13064   $table[<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>;
<a name="l13065"></a>13065   $table[<span class="stringliteral">&#39;va&#39;</span>] = <span class="keyword">false</span>;
<a name="l13066"></a>13066   $table[<span class="stringliteral">&#39;txta&#39;</span>] = <span class="keyword">false</span>;
<a name="l13067"></a>13067   $table[<span class="stringliteral">&#39;topntail&#39;</span>] = <span class="keyword">false</span>;
<a name="l13068"></a>13068   $table[<span class="stringliteral">&#39;thead-underline&#39;</span>] = <span class="keyword">false</span>;
<a name="l13069"></a>13069   $table[<span class="stringliteral">&#39;border&#39;</span>] = <span class="keyword">false</span>;
<a name="l13070"></a>13070   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13071"></a>13071   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13072"></a>13072   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13073"></a>13073   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13074"></a>13074   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13075"></a>13075   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13076"></a>13076   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13077"></a>13077   $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13078"></a>13078   $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = 0;
<a name="l13079"></a>13079   $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = 0;
<a name="l13080"></a>13080   $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = 0;
<a name="l13081"></a>13081   $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = 0;
<a name="l13082"></a>13082   $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = <span class="keyword">false</span>;
<a name="l13083"></a>13083   $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = <span class="keyword">false</span>;
<a name="l13084"></a>13084   $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = <span class="keyword">false</span>;
<a name="l13085"></a>13085   $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = <span class="keyword">false</span>;
<a name="l13086"></a>13086   $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = <span class="keyword">false</span>;
<a name="l13087"></a>13087   $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = <span class="keyword">false</span>;
<a name="l13088"></a>13088   $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = <span class="keyword">false</span>;
<a name="l13089"></a>13089   $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = <span class="keyword">false</span>;
<a name="l13090"></a>13090   $table[<span class="charliteral">&#39;a&#39;</span>] = <span class="keyword">false</span>;
<a name="l13091"></a>13091   $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] = <span class="keyword">false</span>;
<a name="l13092"></a>13092   $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>] = <span class="keyword">false</span>;
<a name="l13093"></a>13093 
<a name="l13094"></a>13094   $this-&gt;Reset();
<a name="l13095"></a>13095   $this-&gt;InlineProperties = array();
<a name="l13096"></a>13096   $this-&gt;spanlvl = 0;
<a name="l13097"></a>13097   $table[<span class="stringliteral">&#39;nc&#39;</span>] = $table[<span class="stringliteral">&#39;nr&#39;</span>] = 0;
<a name="l13098"></a>13098   $this-&gt;tablethead = 0;
<a name="l13099"></a>13099   $this-&gt;tabletfoot = 0;
<a name="l13100"></a>13100   $this-&gt;tabletheadjustfinished = <span class="keyword">false</span>;
<a name="l13101"></a>13101 
<a name="l13102"></a>13102   <span class="comment">// mPDF 4.2</span>
<a name="l13103"></a>13103   <span class="keywordflow">if</span> ($this-&gt;blockjustfinished &amp;&amp; !count($this-&gt;textbuffer) &amp;&amp; $this-&gt;y != $this-&gt;tMargin &amp;&amp; $this-&gt;collapseBlockMargins &amp;&amp; $this-&gt;tableLevel==1) { $lastbottommargin = $this-&gt;lastblockbottommargin; }
<a name="l13104"></a>13104   <span class="keywordflow">else</span> { $lastbottommargin = 0; }
<a name="l13105"></a>13105   $this-&gt;lastblockbottommargin = 0;
<a name="l13106"></a>13106   $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l13107"></a>13107 
<a name="l13108"></a>13108   <span class="keywordflow">if</span> ($this-&gt;tableLevel==1) { $this-&gt;table_lineheight = $this-&gt;normalLineheight; }  <span class="comment">// mPDF 4.2 </span>
<a name="l13109"></a>13109   <span class="comment">// mPDF 3.0</span>
<a name="l13110"></a>13110   <span class="keywordflow">if</span> ($this-&gt;tableLevel==1) { $this-&gt;tableheadernrows = 0; $this-&gt;tablefooternrows = 0; $this-&gt;usetableheader = <span class="keyword">false</span>; }  <span class="comment">// mPDF 4.0</span>
<a name="l13111"></a>13111 
<a name="l13112"></a>13112   <span class="keywordflow">if</span> ($this-&gt;tableLevel ==1) $this-&gt;base_table_properties = array();
<a name="l13113"></a>13113 
<a name="l13114"></a>13114     <span class="comment">// ADDED CSS FUNCIONS FOR TABLE </span>
<a name="l13115"></a>13115     <span class="keywordflow">if</span> ($this-&gt;tbCSSlvl==1) {
<a name="l13116"></a>13116       $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TOPTABLE&#39;</span>,$tag,$attr);
<a name="l13117"></a>13117     }
<a name="l13118"></a>13118     <span class="keywordflow">else</span> {
<a name="l13119"></a>13119       $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TABLE&#39;</span>,$tag,$attr);
<a name="l13120"></a>13120     }
<a name="l13121"></a>13121     $w = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13122"></a>13122     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>])) { $w = $properties[<span class="stringliteral">&#39;WIDTH&#39;</span>]; }
<a name="l13123"></a>13123 
<a name="l13124"></a>13124     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>])) { $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1] = $properties[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>];  }
<a name="l13125"></a>13125     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND&#39;</span>])) { $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1] = $properties[<span class="stringliteral">&#39;BACKGROUND&#39;</span>]; }
<a name="l13126"></a>13126     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])) { $table[<span class="stringliteral">&#39;va&#39;</span>] = $align[strtolower($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])]; }
<a name="l13127"></a>13127     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) { $table[<span class="stringliteral">&#39;txta&#39;</span>] = $align[strtolower($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])]; }
<a name="l13128"></a>13128     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;AUTOSIZE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;AUTOSIZE&#39;</span>] &amp;&amp; $this-&gt;tableLevel ==1) { 
<a name="l13129"></a>13129       $this-&gt;shrink_this_table_to_fit = $properties[<span class="stringliteral">&#39;AUTOSIZE&#39;</span>]; 
<a name="l13130"></a>13130       <span class="keywordflow">if</span> ($this-&gt;shrink_this_table_to_fit &lt; 1) { $this-&gt;shrink_this_table_to_fit = 0; }
<a name="l13131"></a>13131     }
<a name="l13132"></a>13132     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;ROTATE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;ROTATE&#39;</span>] &amp;&amp; $this-&gt;tableLevel ==1) { 
<a name="l13133"></a>13133       $this-&gt;table_rotate = $properties[<span class="stringliteral">&#39;ROTATE&#39;</span>]; 
<a name="l13134"></a>13134     }
<a name="l13135"></a>13135     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TOPNTAIL&#39;</span>])) { $table[<span class="stringliteral">&#39;topntail&#39;</span>] = $properties[<span class="stringliteral">&#39;TOPNTAIL&#39;</span>]; }
<a name="l13136"></a>13136     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;THEAD-UNDERLINE&#39;</span>])) { $table[<span class="stringliteral">&#39;thead-underline&#39;</span>] = $properties[<span class="stringliteral">&#39;THEAD-UNDERLINE&#39;</span>]; }
<a name="l13137"></a>13137 
<a name="l13138"></a>13138     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER&#39;</span>])) { 
<a name="l13139"></a>13139       $bord = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER&#39;</span>]);
<a name="l13140"></a>13140       <span class="keywordflow">if</span> ($bord[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l13141"></a>13141         $table[<span class="stringliteral">&#39;border&#39;</span>] = _BORDER_ALL;
<a name="l13142"></a>13142         $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bord;
<a name="l13143"></a>13143         $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $bord;
<a name="l13144"></a>13144         $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $bord;
<a name="l13145"></a>13145         $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bord;
<a name="l13146"></a>13146       }
<a name="l13147"></a>13147     }
<a name="l13148"></a>13148     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>])) { 
<a name="l13149"></a>13149       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]);
<a name="l13150"></a>13150       $this-&gt;setBorder($table[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_RIGHT, $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13151"></a>13151     }
<a name="l13152"></a>13152     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>])) { 
<a name="l13153"></a>13153       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]);
<a name="l13154"></a>13154       $this-&gt;setBorder($table[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_LEFT, $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13155"></a>13155     }
<a name="l13156"></a>13156     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>])) { 
<a name="l13157"></a>13157       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]);
<a name="l13158"></a>13158       $this-&gt;setBorder($table[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_BOTTOM, $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13159"></a>13159     }
<a name="l13160"></a>13160     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>])) { 
<a name="l13161"></a>13161       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]);
<a name="l13162"></a>13162       $this-&gt;setBorder($table[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_TOP, $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13163"></a>13163     }
<a name="l13164"></a>13164     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;border&#39;</span>]){  <span class="comment">// mPDF 4.3.007</span>
<a name="l13165"></a>13165         $this-&gt;table_border_css_set = 1;
<a name="l13166"></a>13166     }
<a name="l13167"></a>13167     <span class="keywordflow">else</span> {
<a name="l13168"></a>13168       $this-&gt;table_border_css_set = 0;
<a name="l13169"></a>13169     }
<a name="l13170"></a>13170 
<a name="l13171"></a>13171     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) { 
<a name="l13172"></a>13172        <span class="keywordflow">if</span> (!$this-&gt;isCJK) { 
<a name="l13173"></a>13173       $this-&gt;default_font = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>];
<a name="l13174"></a>13174       $this-&gt;SetFont($this-&gt;default_font,<span class="stringliteral">&#39;&#39;</span>,0,<span class="keyword">false</span>);
<a name="l13175"></a>13175       $this-&gt;base_table_properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>];
<a name="l13176"></a>13176        }
<a name="l13177"></a>13177     }
<a name="l13178"></a>13178     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { 
<a name="l13179"></a>13179        $mmsize = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>],$this-&gt;default_font_size/$this-&gt;k);
<a name="l13180"></a>13180        <span class="keywordflow">if</span> ($mmsize) {
<a name="l13181"></a>13181       $this-&gt;default_font_size = $mmsize*($this-&gt;k);
<a name="l13182"></a>13182         $this-&gt;SetFontSize($this-&gt;default_font_size,<span class="keyword">false</span>);
<a name="l13183"></a>13183       $this-&gt;base_table_properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>] = $properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>];
<a name="l13184"></a>13184        }
<a name="l13185"></a>13185     }
<a name="l13186"></a>13186 
<a name="l13187"></a>13187     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>])) {
<a name="l13188"></a>13188       <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) == <span class="stringliteral">&#39;BOLD&#39;</span>) { $this-&gt;base_table_properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>] = <span class="stringliteral">&#39;BOLD&#39;</span>; }
<a name="l13189"></a>13189     }
<a name="l13190"></a>13190     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>])) {
<a name="l13191"></a>13191       <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) == <span class="stringliteral">&#39;ITALIC&#39;</span>) { $this-&gt;base_table_properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>] = <span class="stringliteral">&#39;ITALIC&#39;</span>; }
<a name="l13192"></a>13192     }
<a name="l13193"></a>13193     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) {
<a name="l13194"></a>13194       $this-&gt;base_table_properties[<span class="stringliteral">&#39;COLOR&#39;</span>] = $properties[<span class="stringliteral">&#39;COLOR&#39;</span>];
<a name="l13195"></a>13195     }
<a name="l13196"></a>13196 
<a name="l13197"></a>13197 
<a name="l13198"></a>13198     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>])) { 
<a name="l13199"></a>13199       $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13200"></a>13200     }
<a name="l13201"></a>13201     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>])) { 
<a name="l13202"></a>13202       $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13203"></a>13203     }
<a name="l13204"></a>13204     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>])) { 
<a name="l13205"></a>13205       $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13206"></a>13206     }
<a name="l13207"></a>13207     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>])) { 
<a name="l13208"></a>13208       $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13209"></a>13209     }
<a name="l13210"></a>13210 
<a name="l13211"></a>13211     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])) { 
<a name="l13212"></a>13212       <span class="comment">// mPDF 4.2 Collaspe vertical block margins</span>
<a name="l13213"></a>13213       <span class="keywordflow">if</span> ($lastbottommargin) { 
<a name="l13214"></a>13214         $tmp = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13215"></a>13215         <span class="keywordflow">if</span> ($tmp &gt; $lastbottommargin) { $properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] -= $lastbottommargin; }
<a name="l13216"></a>13216         <span class="keywordflow">else</span> { $properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] = 0; }
<a name="l13217"></a>13217       }
<a name="l13218"></a>13218       $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13219"></a>13219     }
<a name="l13220"></a>13220 
<a name="l13221"></a>13221     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])) { 
<a name="l13222"></a>13222       $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13223"></a>13223     }
<a name="l13224"></a>13224     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])) { <span class="comment">// mPDF 4.2 Error corrected</span>
<a name="l13225"></a>13225       $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13226"></a>13226     }
<a name="l13227"></a>13227 
<a name="l13228"></a>13228     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])) { <span class="comment">// mPDF 4.2 Error corrected</span>
<a name="l13229"></a>13229       $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13230"></a>13230     }
<a name="l13231"></a>13231     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]) &amp;&amp; isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span> &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l13232"></a>13232       $table[<span class="charliteral">&#39;a&#39;</span>] = <span class="charliteral">&#39;C&#39;</span>; 
<a name="l13233"></a>13233     }
<a name="l13234"></a>13234     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l13235"></a>13235       $table[<span class="charliteral">&#39;a&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>; 
<a name="l13236"></a>13236     }
<a name="l13237"></a>13237     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>]) &amp;&amp; strtolower($properties[<span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>])==<span class="stringliteral">&#39;auto&#39;</span>) { 
<a name="l13238"></a>13238       $table[<span class="charliteral">&#39;a&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>; 
<a name="l13239"></a>13239     }
<a name="l13240"></a>13240 
<a name="l13241"></a>13241     <span class="comment">// mPDF 4.2</span>
<a name="l13242"></a>13242     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>]) &amp;&amp; $this-&gt;tableLevel==1) { 
<a name="l13243"></a>13243       $this-&gt;table_lineheight = $this-&gt;fixLineheight($properties[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>]);
<a name="l13244"></a>13244       <span class="keywordflow">if</span> (!$this-&gt;table_lineheight) { $this-&gt;table_lineheight = $this-&gt;normalLineheight; }
<a name="l13245"></a>13245     }
<a name="l13246"></a>13246 
<a name="l13247"></a>13247     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-COLLAPSE&#39;</span>]) &amp;&amp; strtoupper($properties[<span class="stringliteral">&#39;BORDER-COLLAPSE&#39;</span>])==<span class="stringliteral">&#39;SEPARATE&#39;</span>) { 
<a name="l13248"></a>13248       $table[<span class="stringliteral">&#39;borders_separate&#39;</span>] = <span class="keyword">true</span>; 
<a name="l13249"></a>13249     }
<a name="l13250"></a>13250     <span class="keywordflow">else</span> { 
<a name="l13251"></a>13251       $table[<span class="stringliteral">&#39;borders_separate&#39;</span>] = <span class="keyword">false</span>; 
<a name="l13252"></a>13252     }
<a name="l13253"></a>13253 
<a name="l13254"></a>13254     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-SPACING-H&#39;</span>])) { 
<a name="l13255"></a>13255       $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;BORDER-SPACING-H&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13256"></a>13256     }
<a name="l13257"></a>13257     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-SPACING-V&#39;</span>])) { 
<a name="l13258"></a>13258       $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;BORDER-SPACING-V&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13259"></a>13259     }
<a name="l13260"></a>13260 
<a name="l13261"></a>13261     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;EMPTY-CELLS&#39;</span>])) { 
<a name="l13262"></a>13262       $table[<span class="stringliteral">&#39;empty_cells&#39;</span>] = strtolower($properties[<span class="stringliteral">&#39;EMPTY-CELLS&#39;</span>]);   <span class="comment">// &#39;hide&#39;  or &#39;show&#39;</span>
<a name="l13263"></a>13263     }
<a name="l13264"></a>13264     <span class="keywordflow">else</span> { $table[<span class="stringliteral">&#39;empty_cells&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; } 
<a name="l13265"></a>13265 
<a name="l13266"></a>13266     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PAGE-BREAK-INSIDE&#39;</span>]) &amp;&amp; strtoupper($properties[<span class="stringliteral">&#39;PAGE-BREAK-INSIDE&#39;</span>])==<span class="stringliteral">&#39;AVOID&#39;</span> &amp;&amp; $this-&gt;tableLevel==1) { 
<a name="l13267"></a>13267       $this-&gt;table_keep_together = <span class="keyword">true</span>; 
<a name="l13268"></a>13268     }
<a name="l13269"></a>13269     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;tableLevel==1) { 
<a name="l13270"></a>13270       $this-&gt;table_keep_together = <span class="keyword">false</span>; 
<a name="l13271"></a>13271     }
<a name="l13272"></a>13272 
<a name="l13273"></a>13273   <span class="comment">// mPDF 4.2</span>
<a name="l13274"></a>13274   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;OVERFLOW&#39;</span>])) { 
<a name="l13275"></a>13275     $table[<span class="stringliteral">&#39;overflow&#39;</span>] = strtolower($properties[<span class="stringliteral">&#39;OVERFLOW&#39;</span>]);   <span class="comment">// &#39;hidden&#39; &#39;wrap&#39; or &#39;visible&#39; or &#39;auto&#39;</span>
<a name="l13276"></a>13276   }
<a name="l13277"></a>13277 
<a name="l13278"></a>13278   $properties = array();
<a name="l13279"></a>13279 
<a name="l13280"></a>13280   <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>] = 0; } 
<a name="l13281"></a>13281   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CELLSPACING&#39;</span>])) { 
<a name="l13282"></a>13282     $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;CELLSPACING&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]); 
<a name="l13283"></a>13283   }
<a name="l13284"></a>13284 
<a name="l13285"></a>13285 
<a name="l13286"></a>13286   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;CELLPADDING&#39;</span>])) {
<a name="l13287"></a>13287     $table[<span class="stringliteral">&#39;cell_padding&#39;</span>] = $attr[<span class="stringliteral">&#39;CELLPADDING&#39;</span>];
<a name="l13288"></a>13288   }
<a name="l13289"></a>13289   <span class="keywordflow">else</span> {
<a name="l13290"></a>13290     $table[<span class="stringliteral">&#39;cell_padding&#39;</span>] = <span class="keyword">false</span>;
<a name="l13291"></a>13291   }
<a name="l13292"></a>13292 
<a name="l13293"></a>13293   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;BORDER&#39;</span>])) {
<a name="l13294"></a>13294       $this-&gt;table_border_attr_set = 1;
<a name="l13295"></a>13295     <span class="keywordflow">if</span> ($attr[<span class="stringliteral">&#39;BORDER&#39;</span>]==<span class="charliteral">&#39;1&#39;</span>) {
<a name="l13296"></a>13296        $bord = $this-&gt;border_details(<span class="stringliteral">&#39;#000000 1px solid&#39;</span>);
<a name="l13297"></a>13297        <span class="keywordflow">if</span> ($bord[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l13298"></a>13298       $table[<span class="stringliteral">&#39;border&#39;</span>] = _BORDER_ALL;
<a name="l13299"></a>13299       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bord;
<a name="l13300"></a>13300       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $bord;
<a name="l13301"></a>13301       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $bord;
<a name="l13302"></a>13302       $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bord;
<a name="l13303"></a>13303        }
<a name="l13304"></a>13304     }
<a name="l13305"></a>13305   }
<a name="l13306"></a>13306   <span class="keywordflow">else</span> {
<a name="l13307"></a>13307     $this-&gt;table_border_attr_set = 0;
<a name="l13308"></a>13308   }
<a name="l13309"></a>13309   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;REPEAT_HEADER&#39;</span>]) and $attr[<span class="stringliteral">&#39;REPEAT_HEADER&#39;</span>] == <span class="keyword">true</span>) { $this-&gt;UseTableHeader(<span class="keyword">true</span>); } 
<a name="l13310"></a>13310 
<a name="l13311"></a>13311 
<a name="l13312"></a>13312   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>])) { $table[<span class="charliteral">&#39;a&#39;</span>]  = $align[strtolower($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>])]; }
<a name="l13313"></a>13313   <span class="keywordflow">if</span> (!$table[<span class="charliteral">&#39;a&#39;</span>]) { $table[<span class="charliteral">&#39;a&#39;</span>] = $this-&gt;defaultTableAlign; } <span class="comment">// mPDF 4.0</span>
<a name="l13314"></a>13314   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;BGCOLOR&#39;</span>])) { $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1]  = $attr[<span class="stringliteral">&#39;BGCOLOR&#39;</span>]; }
<a name="l13315"></a>13315   <span class="comment">// mPDF 4.0 This does not work</span>
<a name="l13316"></a>13316   <span class="comment">// if (isset($attr[&#39;HEIGHT&#39;])) { $table[&#39;h&#39;]  = $this-&gt;ConvertSize($attr[&#39;HEIGHT&#39;],$this-&gt;blk[$this-&gt;blklvl][&#39;inner_width&#39;]); }</span>
<a name="l13317"></a>13317 
<a name="l13318"></a>13318   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]) { $w = $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]; }
<a name="l13319"></a>13319   <span class="keywordflow">if</span> ($w) { <span class="comment">// set here or earlier in $properties</span>
<a name="l13320"></a>13320     $maxwidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l13321"></a>13321     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l13322"></a>13322       $tblblw = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2;
<a name="l13323"></a>13323     }
<a name="l13324"></a>13324     <span class="keywordflow">else</span> { 
<a name="l13325"></a>13325       $tblblw = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]/2 + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]/2;
<a name="l13326"></a>13326     }
<a name="l13327"></a>13327     <span class="keywordflow">if</span> (strpos($w,<span class="charliteral">&#39;%&#39;</span>) &amp;&amp; $this-&gt;tableLevel == 1 &amp;&amp; !$this-&gt;ignore_table_percents ) { 
<a name="l13328"></a>13328       <span class="comment">// % needs to be of inner box without table margins etc.</span>
<a name="l13329"></a>13329       $maxwidth -= $tblblw ;
<a name="l13330"></a>13330       $wmm = $this-&gt;ConvertSize($w,$maxwidth,$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13331"></a>13331       $table[<span class="charliteral">&#39;w&#39;</span>] = $wmm + $tblblw ;
<a name="l13332"></a>13332     }
<a name="l13333"></a>13333     <span class="keywordflow">if</span> (strpos($w,<span class="charliteral">&#39;%&#39;</span>) &amp;&amp; $this-&gt;tableLevel &gt; 1 &amp;&amp; !$this-&gt;ignore_table_percents &amp;&amp; $this-&gt;keep_table_proportions) { 
<a name="l13334"></a>13334       $table[<span class="stringliteral">&#39;wpercent&#39;</span>] = $w + 0;  <span class="comment">// makes 80% -&gt; 80</span>
<a name="l13335"></a>13335     }
<a name="l13336"></a>13336     <span class="keywordflow">if</span> (!strpos($w,<span class="charliteral">&#39;%&#39;</span>) &amp;&amp; !$this-&gt;ignore_table_widths ) {
<a name="l13337"></a>13337       $wmm = $this-&gt;ConvertSize($w,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13338"></a>13338       $table[<span class="charliteral">&#39;w&#39;</span>] = $wmm + $tblblw ;
<a name="l13339"></a>13339     }
<a name="l13340"></a>13340     <span class="keywordflow">if</span> (!$this-&gt;keep_table_proportions) {
<a name="l13341"></a>13341       <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] &gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]) { $table[<span class="charliteral">&#39;w&#39;</span>] = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]; }
<a name="l13342"></a>13342     }
<a name="l13343"></a>13343   }
<a name="l13344"></a>13344 
<a name="l13345"></a>13345 
<a name="l13346"></a>13346   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;AUTOSIZE&#39;</span>]) &amp;&amp; $this-&gt;tableLevel==1) { 
<a name="l13347"></a>13347     $this-&gt;shrink_this_table_to_fit = $attr[<span class="stringliteral">&#39;AUTOSIZE&#39;</span>]; 
<a name="l13348"></a>13348     <span class="keywordflow">if</span> ($this-&gt;shrink_this_table_to_fit &lt; 1) { $this-&gt;shrink_this_table_to_fit = 1; }
<a name="l13349"></a>13349   }
<a name="l13350"></a>13350   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ROTATE&#39;</span>]) &amp;&amp; $this-&gt;tableLevel==1) { 
<a name="l13351"></a>13351     $this-&gt;table_rotate = $attr[<span class="stringliteral">&#39;ROTATE&#39;</span>]; 
<a name="l13352"></a>13352   }
<a name="l13353"></a>13353 
<a name="l13354"></a>13354   <span class="comment">//++++++++++++++++++++++++++++</span>
<a name="l13355"></a>13355   <span class="comment">// keeping block together on one page</span>
<a name="l13356"></a>13356   <span class="comment">// Autosize is now forced therefore keep block together disabled</span>
<a name="l13357"></a>13357   <span class="keywordflow">if</span> ($this-&gt;keep_block_together) {
<a name="l13358"></a>13358     $this-&gt;keep_block_together = 0;
<a name="l13359"></a>13359     $this-&gt;printdivbuffer();
<a name="l13360"></a>13360     $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;keep_block_together&#39;</span>] = 0;
<a name="l13361"></a>13361   }
<a name="l13362"></a>13362   <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l13363"></a>13363     $this-&gt;tbrot_Links = array();
<a name="l13364"></a>13364     $this-&gt;tbrot_Annots = array();
<a name="l13365"></a>13365     <span class="comment">// mPDF 3.0</span>
<a name="l13366"></a>13366     $this-&gt;tbrot_Reference = array();
<a name="l13367"></a>13367     $this-&gt;tbrot_BMoutlines = array();
<a name="l13368"></a>13368     $this-&gt;tbrot_toc = array();
<a name="l13369"></a>13369   }
<a name="l13370"></a>13370 
<a name="l13371"></a>13371   <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l13372"></a>13372     <span class="keywordflow">if</span> ($this-&gt;table_rotate) { $this-&gt;table_keep_together = <span class="keyword">true</span>; }
<a name="l13373"></a>13373     $this-&gt;kwt = <span class="keyword">false</span>;
<a name="l13374"></a>13374     $this-&gt;kwt_saved = <span class="keyword">true</span>;
<a name="l13375"></a>13375   }
<a name="l13376"></a>13376 
<a name="l13377"></a>13377   <span class="keywordflow">if</span> ($this-&gt;tableLevel==1 &amp;&amp; $this-&gt;useGraphs) { 
<a name="l13378"></a>13378     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ID&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;ID&#39;</span>]) { $this-&gt;currentGraphId = strtoupper($attr[<span class="stringliteral">&#39;ID&#39;</span>]); }
<a name="l13379"></a>13379     <span class="keywordflow">else</span> { $this-&gt;currentGraphId = <span class="charliteral">&#39;0&#39;</span>; }
<a name="l13380"></a>13380     $this-&gt;graphs[$this-&gt;currentGraphId] = array();
<a name="l13381"></a>13381   }
<a name="l13382"></a>13382 
<a name="l13383"></a>13383   <span class="comment">//++++++++++++++++++++++++++++</span>
<a name="l13384"></a>13384   $this-&gt;plainCell_properties = array();
<a name="l13385"></a>13385 
<a name="l13386"></a>13386 
<a name="l13387"></a>13387   <span class="keywordflow">break</span>;
<a name="l13388"></a>13388 
<a name="l13389"></a>13389 
<a name="l13390"></a>13390 
<a name="l13391"></a>13391     <span class="keywordflow">case</span> <span class="stringliteral">&#39;THEAD&#39;</span>:
<a name="l13392"></a>13392   $this-&gt;lastoptionaltag = $tag; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13393"></a>13393   $this-&gt;tbCSSlvl++;
<a name="l13394"></a>13394   $this-&gt;tablethead = 1;
<a name="l13395"></a>13395   $this-&gt;UseTableHeader(<span class="keyword">true</span>);
<a name="l13396"></a>13396   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TABLE&#39;</span>,$tag,$attr);
<a name="l13397"></a>13397   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>])) {
<a name="l13398"></a>13398     <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) == <span class="stringliteral">&#39;BOLD&#39;</span>) { $this-&gt;thead_font_weight = <span class="charliteral">&#39;B&#39;</span>; }
<a name="l13399"></a>13399     <span class="keywordflow">else</span> { $this-&gt;thead_font_weight = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l13400"></a>13400   }
<a name="l13401"></a>13401 
<a name="l13402"></a>13402   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>])) {
<a name="l13403"></a>13403     <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) == <span class="stringliteral">&#39;ITALIC&#39;</span>) { $this-&gt;thead_font_style = <span class="charliteral">&#39;I&#39;</span>; }
<a name="l13404"></a>13404     <span class="keywordflow">else</span> { $this-&gt;thead_font_style = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l13405"></a>13405   }
<a name="l13406"></a>13406 
<a name="l13407"></a>13407   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])) {
<a name="l13408"></a>13408     $this-&gt;thead_valign_default = $properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>];
<a name="l13409"></a>13409   }
<a name="l13410"></a>13410   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) {
<a name="l13411"></a>13411     $this-&gt;thead_textalign_default = $properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>];
<a name="l13412"></a>13412   }
<a name="l13413"></a>13413   $properties = array();
<a name="l13414"></a>13414   <span class="keywordflow">break</span>;
<a name="l13415"></a>13415 
<a name="l13416"></a>13416 
<a name="l13417"></a>13417     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TFOOT&#39;</span>:
<a name="l13418"></a>13418   $this-&gt;lastoptionaltag = $tag; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13419"></a>13419   $this-&gt;tbCSSlvl++;
<a name="l13420"></a>13420   <span class="comment">// mPDF 4.0</span>
<a name="l13421"></a>13421   $this-&gt;tabletfoot = 1; 
<a name="l13422"></a>13422   <span class="comment">// mPDF 3.0</span>
<a name="l13423"></a>13423   $this-&gt;tablethead = 0;
<a name="l13424"></a>13424   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TABLE&#39;</span>,$tag,$attr);
<a name="l13425"></a>13425   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>])) {
<a name="l13426"></a>13426     <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) == <span class="stringliteral">&#39;BOLD&#39;</span>) { $this-&gt;tfoot_font_weight = <span class="charliteral">&#39;B&#39;</span>; }
<a name="l13427"></a>13427     <span class="keywordflow">else</span> { $this-&gt;tfoot_font_weight = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l13428"></a>13428   }
<a name="l13429"></a>13429 
<a name="l13430"></a>13430   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>])) {
<a name="l13431"></a>13431     <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) == <span class="stringliteral">&#39;ITALIC&#39;</span>) { $this-&gt;tfoot_font_style = <span class="charliteral">&#39;I&#39;</span>; }
<a name="l13432"></a>13432     <span class="keywordflow">else</span> { $this-&gt;tfoot_font_style = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l13433"></a>13433   }
<a name="l13434"></a>13434 
<a name="l13435"></a>13435   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])) {
<a name="l13436"></a>13436     $this-&gt;tfoot_valign_default = $properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>];
<a name="l13437"></a>13437   }
<a name="l13438"></a>13438   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) {
<a name="l13439"></a>13439     $this-&gt;tfoot_textalign_default = $properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>];
<a name="l13440"></a>13440   }
<a name="l13441"></a>13441   $properties = array();
<a name="l13442"></a>13442   <span class="keywordflow">break</span>;
<a name="l13443"></a>13443 
<a name="l13444"></a>13444 
<a name="l13445"></a>13445     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TBODY&#39;</span>:
<a name="l13446"></a>13446   <span class="comment">// mPDF 3.0</span>
<a name="l13447"></a>13447   $this-&gt;tablethead = 0;
<a name="l13448"></a>13448   $this-&gt;tabletfoot = 0;  <span class="comment">// mPDF 4.0</span>
<a name="l13449"></a>13449   $this-&gt;lastoptionaltag = $tag; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13450"></a>13450   $this-&gt;tbCSSlvl++;
<a name="l13451"></a>13451   $this-&gt;MergeCSS(<span class="stringliteral">&#39;TABLE&#39;</span>,$tag,$attr);
<a name="l13452"></a>13452   <span class="keywordflow">break</span>;
<a name="l13453"></a>13453 
<a name="l13454"></a>13454 
<a name="l13455"></a>13455     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TR&#39;</span>:
<a name="l13456"></a>13456   $this-&gt;lastoptionaltag = $tag; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13457"></a>13457   $this-&gt;tbCSSlvl++;
<a name="l13458"></a>13458   $this-&gt;row++;
<a name="l13459"></a>13459   $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nr&#39;</span>]++;
<a name="l13460"></a>13460   $this-&gt;col = -1;
<a name="l13461"></a>13461   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TABLE&#39;</span>,$tag,$attr);
<a name="l13462"></a>13462   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>])) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;bgcolor&#39;</span>][$this-&gt;row] = $properties[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]; }
<a name="l13463"></a>13463   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND&#39;</span>])) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;bgcolor&#39;</span>][$this-&gt;row] = $properties[<span class="stringliteral">&#39;BACKGROUND&#39;</span>]; }
<a name="l13464"></a>13464   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>])) {
<a name="l13465"></a>13465     $this-&gt;trow_text_rotate = $properties[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>];
<a name="l13466"></a>13466   }
<a name="l13467"></a>13467   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>])) $this-&gt;trow_text_rotate = $attr[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>];
<a name="l13468"></a>13468 
<a name="l13469"></a>13469   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;BGCOLOR&#39;</span>])) $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;bgcolor&#39;</span>][$this-&gt;row]  = $attr[<span class="stringliteral">&#39;BGCOLOR&#39;</span>];
<a name="l13470"></a>13470   <span class="keywordflow">if</span> ($this-&gt;tablethead) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_thead&#39;</span>][$this-&gt;row] = <span class="keyword">true</span>; }
<a name="l13471"></a>13471   <span class="comment">// mPDF 4.0</span>
<a name="l13472"></a>13472   <span class="keywordflow">if</span> ($this-&gt;tabletfoot) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>][$this-&gt;row] = <span class="keyword">true</span>; }
<a name="l13473"></a>13473   $properties = array();
<a name="l13474"></a>13474   <span class="keywordflow">break</span>;
<a name="l13475"></a>13475 
<a name="l13476"></a>13476 
<a name="l13477"></a>13477 
<a name="l13478"></a>13478     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TH&#39;</span>:
<a name="l13479"></a>13479     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TD&#39;</span>:
<a name="l13480"></a>13480   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; 
<a name="l13481"></a>13481   $this-&gt;lastoptionaltag = $tag; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13482"></a>13482   $this-&gt;tbCSSlvl++;
<a name="l13483"></a>13483   $this-&gt;InlineProperties = array();
<a name="l13484"></a>13484   $this-&gt;spanlvl = 0;
<a name="l13485"></a>13485   $this-&gt;tdbegin = <span class="keyword">true</span>;
<a name="l13486"></a>13486   $this-&gt;col++;
<a name="l13487"></a>13487   <span class="keywordflow">while</span> (isset($this-&gt;cell[$this-&gt;row][$this-&gt;col])) { $this-&gt;col++; }
<a name="l13488"></a>13488   <span class="comment">//Update number column</span>
<a name="l13489"></a>13489   <span class="keywordflow">if</span> ($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nc&#39;</span>] &lt; $this-&gt;col+1) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nc&#39;</span>] = $this-&gt;col+1; }
<a name="l13490"></a>13490   $this-&gt;cell[$this-&gt;row][$this-&gt;col] = array();
<a name="l13491"></a>13491   $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>] = array();
<a name="l13492"></a>13492   $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0 ;
<a name="l13493"></a>13493 
<a name="l13494"></a>13494   $table = &amp;$this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]];
<a name="l13495"></a>13495   $cell = &amp;$this-&gt;cell[$this-&gt;row][$this-&gt;col];
<a name="l13496"></a>13496 
<a name="l13497"></a>13497   $cell[<span class="charliteral">&#39;a&#39;</span>] = <span class="keyword">false</span>;
<a name="l13498"></a>13498   $cell[<span class="charliteral">&#39;R&#39;</span>] = <span class="keyword">false</span>;
<a name="l13499"></a>13499   $cell[<span class="stringliteral">&#39;nowrap&#39;</span>] = <span class="keyword">false</span>;
<a name="l13500"></a>13500   $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>; <span class="comment">// mPDF 4.3.006</span>
<a name="l13501"></a>13501   $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = <span class="keyword">false</span>;
<a name="l13502"></a>13502   $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = <span class="keyword">false</span>;
<a name="l13503"></a>13503   $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = <span class="keyword">false</span>;
<a name="l13504"></a>13504   $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = <span class="keyword">false</span>;
<a name="l13505"></a>13505   <span class="keywordflow">if</span> ($this-&gt;simpleTables &amp;&amp; $this-&gt;row==0 &amp;&amp; $this-&gt;col==0){ <span class="comment">// mPDF 4.2.017</span>
<a name="l13506"></a>13506     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>] = <span class="keyword">false</span>;
<a name="l13507"></a>13507     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13508"></a>13508     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13509"></a>13509     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13510"></a>13510     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13511"></a>13511     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13512"></a>13512     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13513"></a>13513     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13514"></a>13514     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13515"></a>13515   }
<a name="l13516"></a>13516   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$this-&gt;simpleTables) {
<a name="l13517"></a>13517   $cell[<span class="stringliteral">&#39;border&#39;</span>] = <span class="keyword">false</span>;
<a name="l13518"></a>13518   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13519"></a>13519   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13520"></a>13520   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13521"></a>13521   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = 0;
<a name="l13522"></a>13522   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>] = 0;
<a name="l13523"></a>13523   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>] = 0;
<a name="l13524"></a>13524   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>] = 0;
<a name="l13525"></a>13525   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>] = 0;
<a name="l13526"></a>13526   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>] = 0;
<a name="l13527"></a>13527   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>] = 0;
<a name="l13528"></a>13528   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>] = 0;
<a name="l13529"></a>13529   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>] = 0;
<a name="l13530"></a>13530   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13531"></a>13531   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13532"></a>13532   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13533"></a>13533   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13534"></a>13534   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = 0;
<a name="l13535"></a>13535   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = 0;
<a name="l13536"></a>13536   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = 0;
<a name="l13537"></a>13537   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = 0;
<a name="l13538"></a>13538   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>] = array(<span class="charliteral">&#39;R&#39;</span>=&gt;0, <span class="charliteral">&#39;G&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l13539"></a>13539   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>] = array(<span class="charliteral">&#39;R&#39;</span>=&gt;0, <span class="charliteral">&#39;G&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l13540"></a>13540   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>] = array(<span class="charliteral">&#39;R&#39;</span>=&gt;0, <span class="charliteral">&#39;G&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l13541"></a>13541   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>] = array(<span class="charliteral">&#39;R&#39;</span>=&gt;0, <span class="charliteral">&#39;G&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l13542"></a>13542   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 0;
<a name="l13543"></a>13543   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 0;
<a name="l13544"></a>13544   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 0;
<a name="l13545"></a>13545   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 0;
<a name="l13546"></a>13546   }
<a name="l13547"></a>13547 
<a name="l13548"></a>13548 
<a name="l13549"></a>13549   <span class="comment">// INHERITED TABLE PROPERTIES (or ROW for BGCOLOR)</span>
<a name="l13550"></a>13550   <span class="comment">// If cell bgcolor not set specifically, set to TR row bgcolor (if set)</span>
<a name="l13551"></a>13551   <span class="comment">// mPDF 4.3.006</span>
<a name="l13552"></a>13552   <span class="keywordflow">if</span> ((!$cell[<span class="stringliteral">&#39;bgcolor&#39;</span>]) &amp;&amp; isset($table[<span class="stringliteral">&#39;bgcolor&#39;</span>][$this-&gt;row])) {
<a name="l13553"></a>13553       $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] = $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][$this-&gt;row];
<a name="l13554"></a>13554   }
<a name="l13555"></a>13555   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1])) { 
<a name="l13556"></a>13556       $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] = $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1]; 
<a name="l13557"></a>13557   }
<a name="l13558"></a>13558 
<a name="l13559"></a>13559   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;va&#39;</span>]) { $cell[<span class="stringliteral">&#39;va&#39;</span>] = $table[<span class="stringliteral">&#39;va&#39;</span>]; }
<a name="l13560"></a>13560   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;txta&#39;</span>]) { $cell[<span class="charliteral">&#39;a&#39;</span>] = $table[<span class="stringliteral">&#39;txta&#39;</span>]; }
<a name="l13561"></a>13561   <span class="keywordflow">if</span> ($this-&gt;table_border_attr_set) {
<a name="l13562"></a>13562     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;border_details&#39;</span>]) {
<a name="l13563"></a>13563       <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l13564"></a>13564     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l13565"></a>13565     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l13566"></a>13566     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l13567"></a>13567     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l13568"></a>13568     $cell[<span class="stringliteral">&#39;border&#39;</span>] = $table[<span class="stringliteral">&#39;border&#39;</span>]; 
<a name="l13569"></a>13569     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 1; 
<a name="l13570"></a>13570     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 1; 
<a name="l13571"></a>13571     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 1; 
<a name="l13572"></a>13572     $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = 1; 
<a name="l13573"></a>13573       }
<a name="l13574"></a>13574       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables &amp;&amp; $this-&gt;row==0 &amp;&amp; $this-&gt;col==0){
<a name="l13575"></a>13575     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l13576"></a>13576     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l13577"></a>13577     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l13578"></a>13578     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l13579"></a>13579     $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>] = $table[<span class="stringliteral">&#39;border&#39;</span>]; 
<a name="l13580"></a>13580       }
<a name="l13581"></a>13581     }
<a name="l13582"></a>13582   } 
<a name="l13583"></a>13583   <span class="comment">// INHERITED THEAD CSS Properties</span>
<a name="l13584"></a>13584   <span class="keywordflow">if</span> ($this-&gt;tablethead) { 
<a name="l13585"></a>13585     <span class="keywordflow">if</span> ($this-&gt;thead_valign_default) $cell[<span class="stringliteral">&#39;va&#39;</span>] = $align[strtolower($this-&gt;thead_valign_default)]; 
<a name="l13586"></a>13586     <span class="keywordflow">if</span> ($this-&gt;thead_textalign_default) $cell[<span class="charliteral">&#39;a&#39;</span>] = $align[strtolower($this-&gt;thead_textalign_default)]; 
<a name="l13587"></a>13587     <span class="keywordflow">if</span> ($this-&gt;thead_font_weight == <span class="charliteral">&#39;B&#39;</span>) { $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>); }
<a name="l13588"></a>13588     <span class="keywordflow">if</span> ($this-&gt;thead_font_style == <span class="charliteral">&#39;I&#39;</span>) { $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>); }
<a name="l13589"></a>13589   }
<a name="l13590"></a>13590 
<a name="l13591"></a>13591   <span class="comment">// INHERITED TFOOT CSS Properties</span>
<a name="l13592"></a>13592   <span class="keywordflow">if</span> ($this-&gt;tabletfoot) { 
<a name="l13593"></a>13593     <span class="keywordflow">if</span> ($this-&gt;tfoot_valign_default) $cell[<span class="stringliteral">&#39;va&#39;</span>] = $align[strtolower($this-&gt;tfoot_valign_default)]; 
<a name="l13594"></a>13594     <span class="keywordflow">if</span> ($this-&gt;tfoot_textalign_default) $cell[<span class="charliteral">&#39;a&#39;</span>] = $align[strtolower($this-&gt;tfoot_textalign_default)]; 
<a name="l13595"></a>13595     <span class="keywordflow">if</span> ($this-&gt;tfoot_font_weight == <span class="charliteral">&#39;B&#39;</span>) { $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>); }
<a name="l13596"></a>13596     <span class="keywordflow">if</span> ($this-&gt;tfoot_font_style == <span class="charliteral">&#39;I&#39;</span>) { $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>); }
<a name="l13597"></a>13597   }
<a name="l13598"></a>13598 
<a name="l13599"></a>13599 
<a name="l13600"></a>13600   <span class="keywordflow">if</span> ($this-&gt;trow_text_rotate){ <span class="comment">// mPDF 4.3.006</span>
<a name="l13601"></a>13601     $cell[<span class="charliteral">&#39;R&#39;</span>] = $this-&gt;trow_text_rotate; 
<a name="l13602"></a>13602   }
<a name="l13603"></a>13603 
<a name="l13604"></a>13604     $this-&gt;cell_border_dominance_L = 0; 
<a name="l13605"></a>13605     $this-&gt;cell_border_dominance_R = 0; 
<a name="l13606"></a>13606     $this-&gt;cell_border_dominance_T = 0; 
<a name="l13607"></a>13607     $this-&gt;cell_border_dominance_B = 0; 
<a name="l13608"></a>13608 
<a name="l13609"></a>13609     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TABLE&#39;</span>,$tag,$attr);
<a name="l13610"></a>13610     $properties = $this-&gt;array_merge_recursive_unique($this-&gt;base_table_properties, $properties);
<a name="l13611"></a>13611     <span class="comment">// mPDF 4.3.006</span>
<a name="l13612"></a>13612     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>])) { $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] = $properties[<span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>]; }
<a name="l13613"></a>13613     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND&#39;</span>])) { $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] = $properties[<span class="stringliteral">&#39;BACKGROUND&#39;</span>]; }
<a name="l13614"></a>13614 
<a name="l13615"></a>13615 
<a name="l13616"></a>13616   <span class="comment">// mPDF 4.3.006 / 4.3.011</span>
<a name="l13617"></a>13617   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>] &amp;&amp; !$this-&gt;ColActive &amp;&amp; !$this-&gt;keep_block_together) {
<a name="l13618"></a>13618     $file = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE&#39;</span>];
<a name="l13619"></a>13619     $sizesarray = $this-&gt;Image($file,0,0,0,0,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);  <span class="comment">// mPDF 4.3.012D</span>
<a name="l13620"></a>13620     <span class="keywordflow">if</span> (isset($sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>])) {
<a name="l13621"></a>13621       $image_id = $sizesarray[<span class="stringliteral">&#39;IMAGE_ID&#39;</span>];
<a name="l13622"></a>13622       $orig_w = $sizesarray[<span class="stringliteral">&#39;WIDTH&#39;</span>]*$this-&gt;k;    <span class="comment">// in user units i.e. mm</span>
<a name="l13623"></a>13623       $orig_h = $sizesarray[<span class="stringliteral">&#39;HEIGHT&#39;</span>]*$this-&gt;k;   <span class="comment">// (using $this-&gt;img_dpi)</span>
<a name="l13624"></a>13624       $x_repeat = <span class="keyword">true</span>;
<a name="l13625"></a>13625       $y_repeat = <span class="keyword">true</span>;
<a name="l13626"></a>13626       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>])) {
<a name="l13627"></a>13627         <span class="keywordflow">if</span> ($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-x&#39;</span>) { $y_repeat = <span class="keyword">false</span>; }
<a name="l13628"></a>13628         <span class="keywordflow">if</span> ($properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;no-repeat&#39;</span> || $properties[<span class="stringliteral">&#39;BACKGROUND-REPEAT&#39;</span>]==<span class="stringliteral">&#39;repeat-y&#39;</span>) { $x_repeat = <span class="keyword">false</span>; }
<a name="l13629"></a>13629       }
<a name="l13630"></a>13630       $x_pos = 0;
<a name="l13631"></a>13631       $y_pos = 0;
<a name="l13632"></a>13632       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>])) { 
<a name="l13633"></a>13633         $ppos = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,$properties[<span class="stringliteral">&#39;BACKGROUND-POSITION&#39;</span>]);
<a name="l13634"></a>13634         $x_pos = $ppos[0];
<a name="l13635"></a>13635         $y_pos = $ppos[1];
<a name="l13636"></a>13636         <span class="keywordflow">if</span> (!stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $x_pos = $this-&gt;ConvertSize($x_pos ,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize); }
<a name="l13637"></a>13637         <span class="keywordflow">if</span> (!stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { $y_pos = $this-&gt;ConvertSize($y_pos ,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize); }
<a name="l13638"></a>13638       }
<a name="l13639"></a>13639       <span class="comment">// mPDF 4.3.015</span>
<a name="l13640"></a>13640       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>])) { $resize = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-RESIZE&#39;</span>]; }
<a name="l13641"></a>13641       <span class="keywordflow">else</span> { $resize = 0; }
<a name="l13642"></a>13642       <span class="comment">// mPDF 4.3.017</span>
<a name="l13643"></a>13643       <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>])) { $opacity = $properties[<span class="stringliteral">&#39;BACKGROUND-IMAGE-OPACITY&#39;</span>]; }
<a name="l13644"></a>13644       <span class="keywordflow">else</span> { $opacity = 0; }
<a name="l13645"></a>13645       $cell[<span class="stringliteral">&#39;background-image&#39;</span>] = array(<span class="stringliteral">&#39;image_id&#39;</span>=&gt;$image_id, <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$x_pos, <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$y_pos, <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat, <span class="stringliteral">&#39;resize&#39;</span>=&gt;$resize, <span class="stringliteral">&#39;opacity&#39;</span>=&gt;$opacity); <span class="comment">// mPDF 4.3.015  mPDF 4.3.017</span>
<a name="l13646"></a>13646 
<a name="l13647"></a>13647     }
<a name="l13648"></a>13648   }
<a name="l13649"></a>13649 
<a name="l13650"></a>13650     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])) { $cell[<span class="stringliteral">&#39;va&#39;</span>]=$align[strtolower($properties[<span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>])]; }
<a name="l13651"></a>13651     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) { $cell[<span class="charliteral">&#39;a&#39;</span>] = $align[strtolower($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])]; }
<a name="l13652"></a>13652 
<a name="l13653"></a>13653     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>]){ <span class="comment">// mPDF 4.3.006</span>
<a name="l13654"></a>13654       $cell[<span class="charliteral">&#39;R&#39;</span>] = $properties[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>]; 
<a name="l13655"></a>13655     }
<a name="l13656"></a>13656     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER&#39;</span>])) { 
<a name="l13657"></a>13657       $bord = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER&#39;</span>]);
<a name="l13658"></a>13658       <span class="keywordflow">if</span> ($bord[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l13659"></a>13659          <span class="keywordflow">if</span> (!$this-&gt;simpleTables){ <span class="comment">// mPDF 4.2.017</span>
<a name="l13660"></a>13660         $cell[<span class="stringliteral">&#39;border&#39;</span>] = _BORDER_ALL;
<a name="l13661"></a>13661         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bord;
<a name="l13662"></a>13662         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $bord;
<a name="l13663"></a>13663         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $bord;
<a name="l13664"></a>13664         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bord;
<a name="l13665"></a>13665         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_L; 
<a name="l13666"></a>13666         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_R; 
<a name="l13667"></a>13667         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_T; 
<a name="l13668"></a>13668         $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_B; 
<a name="l13669"></a>13669          }
<a name="l13670"></a>13670          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables &amp;&amp; $this-&gt;row==0 &amp;&amp; $this-&gt;col==0){
<a name="l13671"></a>13671         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>] = _BORDER_ALL;
<a name="l13672"></a>13672         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bord;
<a name="l13673"></a>13673         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $bord;
<a name="l13674"></a>13674         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $bord;
<a name="l13675"></a>13675         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bord;
<a name="l13676"></a>13676          }
<a name="l13677"></a>13677       }
<a name="l13678"></a>13678     }
<a name="l13679"></a>13679 
<a name="l13680"></a>13680     <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l13681"></a>13681        <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]) { 
<a name="l13682"></a>13682       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>]);
<a name="l13683"></a>13683       $this-&gt;setBorder($cell[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_RIGHT, $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13684"></a>13684       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_R; 
<a name="l13685"></a>13685        }
<a name="l13686"></a>13686        <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]) { 
<a name="l13687"></a>13687       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]);
<a name="l13688"></a>13688       $this-&gt;setBorder($cell[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_LEFT, $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13689"></a>13689       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_L; 
<a name="l13690"></a>13690        }
<a name="l13691"></a>13691        <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]) { 
<a name="l13692"></a>13692       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>]);
<a name="l13693"></a>13693       $this-&gt;setBorder($cell[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_BOTTOM, $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13694"></a>13694       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_B; 
<a name="l13695"></a>13695        }
<a name="l13696"></a>13696        <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]) { 
<a name="l13697"></a>13697       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-TOP&#39;</span>]);
<a name="l13698"></a>13698       $this-&gt;setBorder($cell[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_TOP, $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]); 
<a name="l13699"></a>13699       $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $this-&gt;cell_border_dominance_T; 
<a name="l13700"></a>13700        }
<a name="l13701"></a>13701     }
<a name="l13702"></a>13702     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables &amp;&amp; $this-&gt;row==0 &amp;&amp; $this-&gt;col==0){
<a name="l13703"></a>13703        <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]) &amp;&amp; $properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]) { 
<a name="l13704"></a>13704       $bord = $this-&gt;border_details($properties[<span class="stringliteral">&#39;BORDER-LEFT&#39;</span>]);
<a name="l13705"></a>13705         <span class="keywordflow">if</span> ($bord[<span class="charliteral">&#39;s&#39;</span>]) { $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>] = _BORDER_ALL; }
<a name="l13706"></a>13706         <span class="keywordflow">else</span> { $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>] = 0; }
<a name="l13707"></a>13707         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bord;
<a name="l13708"></a>13708         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $bord;
<a name="l13709"></a>13709         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $bord;
<a name="l13710"></a>13710         $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bord;
<a name="l13711"></a>13711        }
<a name="l13712"></a>13712     }
<a name="l13713"></a>13713 
<a name="l13714"></a>13714     <span class="keywordflow">if</span> ($this-&gt;simpleTables &amp;&amp; $this-&gt;row==0 &amp;&amp; $this-&gt;col==0 &amp;&amp; !$table[<span class="stringliteral">&#39;borders_separate&#39;</span>]){  <span class="comment">// mPDF 4.2.017</span>
<a name="l13715"></a>13715       $table[<span class="stringliteral">&#39;border_details&#39;</span>] = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l13716"></a>13716       $table[<span class="stringliteral">&#39;border&#39;</span>] = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>]; 
<a name="l13717"></a>13717     }
<a name="l13718"></a>13718 
<a name="l13719"></a>13719     <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l13720"></a>13720     <span class="keywordflow">if</span> ($this-&gt;packTableData &amp;&amp; !$this-&gt;simpleTables) {
<a name="l13721"></a>13721       $cell[<span class="stringliteral">&#39;borderbin&#39;</span>] = $this-&gt;_packCellBorder($cell);
<a name="l13722"></a>13722       unset($cell[<span class="stringliteral">&#39;border&#39;</span>]);
<a name="l13723"></a>13723       unset($cell[<span class="stringliteral">&#39;border_details&#39;</span>]);
<a name="l13724"></a>13724     }
<a name="l13725"></a>13725 
<a name="l13726"></a>13726     <span class="comment">// mPDF 4.3.006</span>
<a name="l13727"></a>13727     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>])) { 
<a name="l13728"></a>13728       $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-LEFT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13729"></a>13729     }
<a name="l13730"></a>13730     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>])) { 
<a name="l13731"></a>13731       $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13732"></a>13732     }
<a name="l13733"></a>13733     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>])) { 
<a name="l13734"></a>13734       $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13735"></a>13735     }
<a name="l13736"></a>13736     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>])) { 
<a name="l13737"></a>13737       $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;PADDING-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13738"></a>13738     }
<a name="l13739"></a>13739 
<a name="l13740"></a>13740     $w = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13741"></a>13741     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;WIDTH&#39;</span>])) { $w = $properties[<span class="stringliteral">&#39;WIDTH&#39;</span>]; }
<a name="l13742"></a>13742     <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;WIDTH&#39;</span>])) { $w = $attr[<span class="stringliteral">&#39;WIDTH&#39;</span>]; }
<a name="l13743"></a>13743     <span class="keywordflow">if</span> ($w) { 
<a name="l13744"></a>13744       <span class="keywordflow">if</span> (strpos($w,<span class="charliteral">&#39;%&#39;</span>) &amp;&amp; !$this-&gt;ignore_table_percents ) { $cell[<span class="stringliteral">&#39;wpercent&#39;</span>] = $w + 0; } <span class="comment">// makes 80% -&gt; 80</span>
<a name="l13745"></a>13745       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strpos($w,<span class="charliteral">&#39;%&#39;</span>) &amp;&amp; !$this-&gt;ignore_table_widths ) { $cell[<span class="charliteral">&#39;w&#39;</span>] = $this-&gt;ConvertSize($w,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l13746"></a>13746     }
<a name="l13747"></a>13747 
<a name="l13748"></a>13748     <span class="comment">// mPDF 4.0</span>
<a name="l13749"></a>13749     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>])) { $cell[<span class="charliteral">&#39;h&#39;</span>]  = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;HEIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l13750"></a>13750 
<a name="l13751"></a>13751     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;COLOR&#39;</span>])) {
<a name="l13752"></a>13752       $cor = $this-&gt;ConvertColor($properties[<span class="stringliteral">&#39;COLOR&#39;</span>]);
<a name="l13753"></a>13753       <span class="keywordflow">if</span> ($cor) { 
<a name="l13754"></a>13754       $this-&gt;colorarray = $cor;
<a name="l13755"></a>13755       $this-&gt;SetTextColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l13756"></a>13756       $this-&gt;issetcolor=<span class="keyword">true</span>;
<a name="l13757"></a>13757       }
<a name="l13758"></a>13758     }
<a name="l13759"></a>13759     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) {
<a name="l13760"></a>13760        <span class="keywordflow">if</span> (!$this-&gt;isCJK) { 
<a name="l13761"></a>13761       $this-&gt;SetFont($properties[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,0,<span class="keyword">false</span>);
<a name="l13762"></a>13762        }
<a name="l13763"></a>13763     }
<a name="l13764"></a>13764     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) { 
<a name="l13765"></a>13765        $mmsize = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>],$this-&gt;default_font_size/$this-&gt;k);
<a name="l13766"></a>13766        <span class="keywordflow">if</span> ($mmsize) {
<a name="l13767"></a>13767         $this-&gt;SetFontSize($mmsize*($this-&gt;k),<span class="keyword">false</span>);
<a name="l13768"></a>13768        }
<a name="l13769"></a>13769     }
<a name="l13770"></a>13770     <span class="comment">// mPDF 4.2</span>
<a name="l13771"></a>13771     $cell[<span class="stringliteral">&#39;dfs&#39;</span>] = $this-&gt;FontSize; <span class="comment">// Default Font size</span>
<a name="l13772"></a>13772     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>])) {
<a name="l13773"></a>13773       <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]) == <span class="stringliteral">&#39;BOLD&#39;</span>) { $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>); }
<a name="l13774"></a>13774     }
<a name="l13775"></a>13775     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>])) {
<a name="l13776"></a>13776       <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]) == <span class="stringliteral">&#39;ITALIC&#39;</span>) { $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>); }
<a name="l13777"></a>13777     }
<a name="l13778"></a>13778     <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;WHITE-SPACE&#39;</span>])) {
<a name="l13779"></a>13779       <span class="keywordflow">if</span> (strtoupper($properties[<span class="stringliteral">&#39;WHITE-SPACE&#39;</span>]) == <span class="stringliteral">&#39;NOWRAP&#39;</span>) { $cell[<span class="stringliteral">&#39;nowrap&#39;</span>]= 1; }
<a name="l13780"></a>13780     }
<a name="l13781"></a>13781     $properties = array();
<a name="l13782"></a>13782 
<a name="l13783"></a>13783 
<a name="l13784"></a>13784   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>])) $cell[<span class="charliteral">&#39;h&#39;</span>] = $this-&gt;ConvertSize($attr[<span class="stringliteral">&#39;HEIGHT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13785"></a>13785 
<a name="l13786"></a>13786   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>])) $cell[<span class="charliteral">&#39;a&#39;</span>] = $align[strtolower($attr[<span class="stringliteral">&#39;ALIGN&#39;</span>])];
<a name="l13787"></a>13787   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;VALIGN&#39;</span>])) $cell[<span class="stringliteral">&#39;va&#39;</span>] = $align[strtolower($attr[<span class="stringliteral">&#39;VALIGN&#39;</span>])];
<a name="l13788"></a>13788 
<a name="l13789"></a>13789   <span class="comment">// mPDF 4.3.006</span>
<a name="l13790"></a>13790   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;BGCOLOR&#39;</span>])) $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] = $attr[<span class="stringliteral">&#39;BGCOLOR&#39;</span>];
<a name="l13791"></a>13791 
<a name="l13792"></a>13792   $cs = $rs = 1;
<a name="l13793"></a>13793   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;COLSPAN&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;COLSPAN&#39;</span>]&gt;1)  $cs = $cell[<span class="stringliteral">&#39;colspan&#39;</span>]  = $attr[<span class="stringliteral">&#39;COLSPAN&#39;</span>];
<a name="l13794"></a>13794   <span class="keywordflow">if</span> ($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nc&#39;</span>] &lt; $this-&gt;col+$cs) { 
<a name="l13795"></a>13795     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nc&#39;</span>] = $this-&gt;col+$cs; 
<a name="l13796"></a>13796     <span class="keywordflow">for</span>($l=$this-&gt;col; $l &lt; $this-&gt;col+$cs ;$l++) {
<a name="l13797"></a>13797       <span class="keywordflow">if</span> ($l-$this-&gt;col) $this-&gt;cell[$this-&gt;row][$l] = 0;
<a name="l13798"></a>13798     }
<a name="l13799"></a>13799   }
<a name="l13800"></a>13800   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;ROWSPAN&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;ROWSPAN&#39;</span>]&gt;1)  $rs = $cell[<span class="stringliteral">&#39;rowspan&#39;</span>]  = $attr[<span class="stringliteral">&#39;ROWSPAN&#39;</span>];
<a name="l13801"></a>13801   <span class="keywordflow">for</span> ($k=$this-&gt;row ; $k &lt; $this-&gt;row+$rs ;$k++) {
<a name="l13802"></a>13802     <span class="keywordflow">for</span>($l=$this-&gt;col; $l &lt; $this-&gt;col+$cs ;$l++) {
<a name="l13803"></a>13803       <span class="keywordflow">if</span> ($k-$this-&gt;row || $l-$this-&gt;col) $this-&gt;cell[$k][$l] = 0;
<a name="l13804"></a>13804     }
<a name="l13805"></a>13805   }
<a name="l13806"></a>13806   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>])) {  <span class="comment">// mPDF 4.3.006</span>
<a name="l13807"></a>13807     $cell[<span class="charliteral">&#39;R&#39;</span>] = $attr[<span class="stringliteral">&#39;TEXT-ROTATE&#39;</span>]; 
<a name="l13808"></a>13808   }
<a name="l13809"></a>13809   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;NOWRAP&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;NOWRAP&#39;</span>]) $cell[<span class="stringliteral">&#39;nowrap&#39;</span>]= 1;
<a name="l13810"></a>13810   unset($cell );
<a name="l13811"></a>13811   <span class="keywordflow">break</span>;
<a name="l13812"></a>13812 
<a name="l13813"></a>13813 
<a name="l13814"></a>13814 
<a name="l13815"></a>13815     <span class="comment">// *********** LISTS ********************</span>
<a name="l13816"></a>13816 
<a name="l13817"></a>13817     <span class="keywordflow">case</span> <span class="stringliteral">&#39;OL&#39;</span>:
<a name="l13818"></a>13818     <span class="keywordflow">case</span> <span class="stringliteral">&#39;UL&#39;</span>:
<a name="l13819"></a>13819   $this-&gt;listjustfinished = <span class="keyword">false</span>;
<a name="l13820"></a>13820   <span class="comment">// mPDF 4.2</span>
<a name="l13821"></a>13821   <span class="keywordflow">if</span> ($this-&gt;blockjustfinished &amp;&amp; !count($this-&gt;textbuffer) &amp;&amp; $this-&gt;y != $this-&gt;tMargin &amp;&amp; $this-&gt;collapseBlockMargins) { $lastbottommargin = $this-&gt;lastblockbottommargin; }
<a name="l13822"></a>13822   <span class="keywordflow">else</span> { $lastbottommargin = 0; }
<a name="l13823"></a>13823   $this-&gt;lastblockbottommargin = 0;
<a name="l13824"></a>13824   $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l13825"></a>13825   <span class="comment">// mPDF 3.0</span>
<a name="l13826"></a>13826   $this-&gt;linebreakjustfinished=<span class="keyword">false</span>;
<a name="l13827"></a>13827   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13828"></a>13828   $this-&gt;listCSSlvl++;
<a name="l13829"></a>13829   <span class="keywordflow">if</span>((!$this-&gt;tableLevel) &amp;&amp; ($this-&gt;listlvl == 0)) {
<a name="l13830"></a>13830     <span class="comment">// mPDF 4.2</span>
<a name="l13831"></a>13831     $blockstate = 0; 
<a name="l13832"></a>13832     <span class="comment">//if ($this-&gt;lastblocklevelchange == 1) { $blockstate = -1; } // Top margins/padding only</span>
<a name="l13833"></a>13833     <span class="comment">//else if ($this-&gt;lastblocklevelchange &lt; 1) { $blockstate = 0; }  // NO margins/padding</span>
<a name="l13834"></a>13834     <span class="comment">// called from block after new div e.g. &lt;div&gt; ... &lt;ol&gt; ...    Outputs block top margin/border and padding</span>
<a name="l13835"></a>13835     <span class="keywordflow">if</span> (count($this-&gt;textbuffer) == 0 &amp;&amp; $this-&gt;lastblocklevelchange == 1 &amp;&amp; !$this-&gt;tableLevel &amp;&amp; !$this-&gt;kwt) {
<a name="l13836"></a>13836       $this-&gt;newFlowingBlock( $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;width&#39;</span>],$this-&gt;lineheight,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,1,<span class="keyword">true</span>);  <span class="comment">// true = newblock</span>
<a name="l13837"></a>13837       $this-&gt;finishFlowingBlock(<span class="keyword">true</span>);  <span class="comment">// true = END of flowing block</span>
<a name="l13838"></a>13838     }
<a name="l13839"></a>13839     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($this-&gt;textbuffer)) { $this-&gt;printbuffer($this-&gt;textbuffer,$blockstate); }
<a name="l13840"></a>13840     $this-&gt;textbuffer=array();
<a name="l13841"></a>13841     $this-&gt;lastblocklevelchange = -1;
<a name="l13842"></a>13842   }
<a name="l13843"></a>13843   <span class="comment">// ol and ul types are mixed here</span>
<a name="l13844"></a>13844   <span class="keywordflow">if</span> ($this-&gt;listlvl == 0) {
<a name="l13845"></a>13845     $this-&gt;list_indent = array();
<a name="l13846"></a>13846     $this-&gt;list_align = array();
<a name="l13847"></a>13847     $this-&gt;list_lineheight = array();
<a name="l13848"></a>13848     $this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>] = array();
<a name="l13849"></a>13849     $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>] = array();
<a name="l13850"></a>13850   }
<a name="l13851"></a>13851 
<a name="l13852"></a>13852   <span class="comment">// A simple list for inside a table</span>
<a name="l13853"></a>13853   <span class="keywordflow">if</span>($this-&gt;tableLevel) {
<a name="l13854"></a>13854     $this-&gt;list_indent[$this-&gt;listlvl] = 0; <span class="comment">// mm default indent for each level</span>
<a name="l13855"></a>13855     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;OL&#39;</span>) $this-&gt;listtype = <span class="charliteral">&#39;1&#39;</span>;
<a name="l13856"></a>13856     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;UL&#39;</span>) $this-&gt;listtype = <span class="stringliteral">&#39;disc&#39;</span>;
<a name="l13857"></a>13857         <span class="keywordflow">if</span> ($this-&gt;listlvl &gt; 0) {
<a name="l13858"></a>13858       $this-&gt;listlist[$this-&gt;listlvl][<span class="stringliteral">&#39;MAXNUM&#39;</span>] = $this-&gt;listnum; <span class="comment">//save previous lvl&#39;s maxnum</span>
<a name="l13859"></a>13859     }
<a name="l13860"></a>13860     $this-&gt;listlvl++;
<a name="l13861"></a>13861     $this-&gt;listnum = 0; <span class="comment">// reset</span>
<a name="l13862"></a>13862     $this-&gt;listlist[$this-&gt;listlvl] = array(<span class="stringliteral">&#39;TYPE&#39;</span>=&gt;$this-&gt;listtype,<span class="stringliteral">&#39;MAXNUM&#39;</span>=&gt;$this-&gt;listnum);
<a name="l13863"></a>13863     <span class="keywordflow">break</span>;
<a name="l13864"></a>13864   }
<a name="l13865"></a>13865 
<a name="l13866"></a>13866   <span class="comment">// mPDF 4.2.018</span>
<a name="l13867"></a>13867   <span class="keywordflow">if</span> ($this-&gt;PDFA &amp;&amp; $tag == <span class="stringliteral">&#39;UL&#39;</span>) {
<a name="l13868"></a>13868     <span class="keywordflow">if</span> (!$this-&gt;PDFAauto) { $this-&gt;PDFAwarnings[] = <span class="stringliteral">&quot;List bullets cannot use core font Zapfdingbats in PDFA1-b. (Substitute characters from current font used if available, otherwise substitutes hyphen &#39;-&#39;)&quot;</span>; }
<a name="l13869"></a>13869   }
<a name="l13870"></a>13870 
<a name="l13871"></a>13871   <span class="keywordflow">if</span> ($this-&gt;listCSSlvl==1) {
<a name="l13872"></a>13872     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;TOPLIST&#39;</span>,$tag,$attr);
<a name="l13873"></a>13873   }
<a name="l13874"></a>13874   <span class="keywordflow">else</span> {
<a name="l13875"></a>13875     $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;LIST&#39;</span>,$tag,$attr);
<a name="l13876"></a>13876   }
<a name="l13877"></a>13877   <span class="keywordflow">if</span> (!empty($properties)) $this-&gt;setCSS($properties,<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l13878"></a>13878   <span class="comment">// List-type</span>
<a name="l13879"></a>13879   <span class="comment">// mPDF 4.0</span>
<a name="l13880"></a>13880   $this-&gt;listtype = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13881"></a>13881   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TYPE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TYPE&#39;</span>]) { $this-&gt;listtype = $attr[<span class="stringliteral">&#39;TYPE&#39;</span>]; }
<a name="l13882"></a>13882   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;LIST-STYLE-TYPE&#39;</span>])) { 
<a name="l13883"></a>13883     <span class="comment">// mPDF 4.0</span>
<a name="l13884"></a>13884     $this-&gt;listtype = $this-&gt;_getListStyle($properties[<span class="stringliteral">&#39;LIST-STYLE-TYPE&#39;</span>]);
<a name="l13885"></a>13885   }
<a name="l13886"></a>13886   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;LIST-STYLE&#39;</span>])) { 
<a name="l13887"></a>13887     <span class="comment">// mPDF 4.0</span>
<a name="l13888"></a>13888     $this-&gt;listtype = $this-&gt;_getListStyle($properties[<span class="stringliteral">&#39;LIST-STYLE&#39;</span>]);
<a name="l13889"></a>13889   }
<a name="l13890"></a>13890   <span class="keywordflow">if</span> (!$this-&gt;listtype) {
<a name="l13891"></a>13891     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;OL&#39;</span>) $this-&gt;listtype = <span class="charliteral">&#39;1&#39;</span>;
<a name="l13892"></a>13892     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;UL&#39;</span>) {
<a name="l13893"></a>13893       <span class="comment">// mPDF 4.0</span>
<a name="l13894"></a>13894       <span class="keywordflow">if</span> ($this-&gt;listlvl % 3 == 0) $this-&gt;listtype = <span class="stringliteral">&#39;disc&#39;</span>;
<a name="l13895"></a>13895       elseif ($this-&gt;listlvl % 3 == 1) $this-&gt;listtype = &#39;circle&#39;;
<a name="l13896"></a>13896       else $this-&gt;listtype = &#39;square&#39;;
<a name="l13897"></a>13897     }
<a name="l13898"></a>13898   }
<a name="l13899"></a>13899 
<a name="l13900"></a>13900       <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a> ($this-&gt;listlvl == 0) {
<a name="l13901"></a>13901     $this-&gt;inherit_lineheight = 0;
<a name="l13902"></a>13902         $this-&gt;listlvl++; <span class="comment">// first depth level</span>
<a name="l13903"></a>13903         $this-&gt;listnum = 0; <span class="comment">// reset</span>
<a name="l13904"></a>13904         $occur = $this-&gt;listoccur[$this-&gt;listlvl] = 1;
<a name="l13905"></a>13905         $this-&gt;listlist[$this-&gt;listlvl][1] = array(<span class="stringliteral">&#39;TYPE&#39;</span>=&gt;$this-&gt;listtype,<span class="stringliteral">&#39;MAXNUM&#39;</span>=&gt;$this-&gt;listnum);
<a name="l13906"></a>13906       }
<a name="l13907"></a>13907       <span class="keywordflow">else</span> {
<a name="l13908"></a>13908         <span class="keywordflow">if</span> (!empty($this-&gt;textbuffer))
<a name="l13909"></a>13909         {
<a name="l13910"></a>13910     $this-&gt;listitem[] = array($this-&gt;listlvl,$this-&gt;listnum,$this-&gt;textbuffer,$this-&gt;listoccur[$this-&gt;listlvl],$this-&gt;listitemtype);
<a name="l13911"></a>13911     $this-&gt;listnum++;
<a name="l13912"></a>13912         }
<a name="l13913"></a>13913     <span class="comment">// Save current lineheight to inherit</span>
<a name="l13914"></a>13914     $this-&gt;textbuffer = array();
<a name="l13915"></a>13915       $occur = $this-&gt;listoccur[$this-&gt;listlvl];
<a name="l13916"></a>13916         $this-&gt;listlist[$this-&gt;listlvl][$occur][<span class="stringliteral">&#39;MAXNUM&#39;</span>] = $this-&gt;listnum; <span class="comment">//save previous lvl&#39;s maxnum</span>
<a name="l13917"></a>13917         $this-&gt;listlvl++;
<a name="l13918"></a>13918         $this-&gt;listnum = 0; <span class="comment">// reset</span>
<a name="l13919"></a>13919 
<a name="l13920"></a>13920   <span class="comment">// mPDF 3.0</span>
<a name="l13921"></a>13921         <span class="keywordflow">if</span> (!isset($this-&gt;listoccur[$this-&gt;listlvl]) || $this-&gt;listoccur[$this-&gt;listlvl] == 0) $this-&gt;listoccur[$this-&gt;listlvl] = 1;
<a name="l13922"></a>13922         <span class="keywordflow">else</span> $this-&gt;listoccur[$this-&gt;listlvl]++;
<a name="l13923"></a>13923       $occur = $this-&gt;listoccur[$this-&gt;listlvl];
<a name="l13924"></a>13924         $this-&gt;listlist[$this-&gt;listlvl][$occur] = array(<span class="stringliteral">&#39;TYPE&#39;</span>=&gt;$this-&gt;listtype,<span class="stringliteral">&#39;MAXNUM&#39;</span>=&gt;$this-&gt;listnum);
<a name="l13925"></a>13925       }
<a name="l13926"></a>13926 
<a name="l13927"></a>13927 
<a name="l13928"></a>13928   <span class="comment">// TOP LEVEL ONLY</span>
<a name="l13929"></a>13929   <span class="keywordflow">if</span> ($this-&gt;listlvl == 1) {
<a name="l13930"></a>13930      <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>])) { 
<a name="l13931"></a>13931     <span class="comment">// mPDF 4.2 Collaspe vertical block margins</span>
<a name="l13932"></a>13932     <span class="keywordflow">if</span> ($lastbottommargin) { 
<a name="l13933"></a>13933       $tmp = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l13934"></a>13934       <span class="keywordflow">if</span> ($tmp &gt; $lastbottommargin) { $properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] -= $lastbottommargin; }
<a name="l13935"></a>13935       <span class="keywordflow">else</span> { $properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>] = 0; }
<a name="l13936"></a>13936     }
<a name="l13937"></a>13937     $this-&gt;DivLn($this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-TOP&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>),$this-&gt;blklvl,<span class="keyword">true</span>,1);  <span class="comment">// collapsible</span>
<a name="l13938"></a>13938      }
<a name="l13939"></a>13939      <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>])) { 
<a name="l13940"></a>13940     $this-&gt;list_margin_bottom = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l13941"></a>13941      }
<a name="l13942"></a>13942      <span class="comment">// mPDF 4.0</span>
<a name="l13943"></a>13943      <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>])) {
<a name="l13944"></a>13944     $this-&gt;list_lineheight[$this-&gt;listlvl][$occur] = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>];
<a name="l13945"></a>13945      }
<a name="l13946"></a>13946   }
<a name="l13947"></a>13947   $this-&gt;list_indent[$this-&gt;listlvl][$occur] = 5; <span class="comment">// mm default indent for each level</span>
<a name="l13948"></a>13948   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-INDENT&#39;</span>])) { $this-&gt;list_indent[$this-&gt;listlvl][$occur] = $this-&gt;ConvertSize($properties[<span class="stringliteral">&#39;TEXT-INDENT&#39;</span>],$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); }
<a name="l13949"></a>13949   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])) { $this-&gt;list_align[$this-&gt;listlvl][$occur] = $align[strtolower($properties[<span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>])]; }
<a name="l13950"></a>13950 
<a name="l13951"></a>13951   <span class="comment">// mPDF 4.0</span>
<a name="l13952"></a>13952   <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>])) { 
<a name="l13953"></a>13953     $this-&gt;list_lineheight[$this-&gt;listlvl][$occur] = $this-&gt;fixLineheight($properties[<span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>]);
<a name="l13954"></a>13954     
<a name="l13955"></a>13955   }
<a name="l13956"></a>13956   <span class="comment">// mPDF 4.2 Inherit</span>
<a name="l13957"></a>13957   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;listlvl&gt;1 &amp;&amp; isset($this-&gt;list_lineheight[($this-&gt;listlvl - 1)][1])) { 
<a name="l13958"></a>13958     $this-&gt;list_lineheight[$this-&gt;listlvl][$occur] = end($this-&gt;list_lineheight[($this-&gt;listlvl - 1)]);
<a name="l13959"></a>13959   }
<a name="l13960"></a>13960   <span class="keywordflow">if</span> (!isset($this-&gt;list_lineheight[$this-&gt;listlvl][$occur]) || !$this-&gt;list_lineheight[$this-&gt;listlvl][$occur]) { 
<a name="l13961"></a>13961     $this-&gt;list_lineheight[$this-&gt;listlvl][$occur] = $this-&gt;normalLineheight;   <span class="comment">// mPDF 4.2</span>
<a name="l13962"></a>13962   }
<a name="l13963"></a>13963 
<a name="l13964"></a>13964   $this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$this-&gt;listlvl][$occur] = $this-&gt;saveInlineProperties();
<a name="l13965"></a>13965   $properties = array();
<a name="l13966"></a>13966      <span class="keywordflow">break</span>;
<a name="l13967"></a>13967 
<a name="l13968"></a>13968 
<a name="l13969"></a>13969 
<a name="l13970"></a>13970     <span class="keywordflow">case</span> <span class="stringliteral">&#39;LI&#39;</span>:
<a name="l13971"></a>13971   <span class="comment">// Start Block</span>
<a name="l13972"></a>13972   $this-&gt;lastoptionaltag = $tag; <span class="comment">// Save current HTML specified optional endtag</span>
<a name="l13973"></a>13973       $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; <span class="comment">//Eliminate exceeding left-side spaces</span>
<a name="l13974"></a>13974   <span class="comment">// A simple list for inside a table</span>
<a name="l13975"></a>13975   <span class="keywordflow">if</span>($this-&gt;tableLevel) {
<a name="l13976"></a>13976      $this-&gt;blockjustfinished=<span class="keyword">false</span>;
<a name="l13977"></a>13977 
<a name="l13978"></a>13978      <span class="comment">// If already something in the Cell</span>
<a name="l13979"></a>13979      <span class="keywordflow">if</span> ((isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>]) &amp;&amp; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &gt; 0 ) || $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] &gt; 0 ) {
<a name="l13980"></a>13980       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array(<span class="stringliteral">&quot;\n&quot;</span>,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l13981"></a>13981       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l13982"></a>13982       <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l13983"></a>13983         $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>];
<a name="l13984"></a>13984       }
<a name="l13985"></a>13985       elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l13986"></a>13986         $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l13987"></a>13987       }
<a name="l13988"></a>13988       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0 ;
<a name="l13989"></a>13989     }
<a name="l13990"></a>13990     <span class="keywordflow">if</span> ($this-&gt;listlvl == 0) { <span class="comment">//in case of malformed HTML code. Example:(...)&lt;/p&gt;&lt;li&gt;Content&lt;/li&gt;&lt;p&gt;Paragraph1&lt;/p&gt;(...)</span>
<a name="l13991"></a>13991       $this-&gt;listlvl++; <span class="comment">// first depth level</span>
<a name="l13992"></a>13992       $this-&gt;listnum = 0; <span class="comment">// reset</span>
<a name="l13993"></a>13993       $this-&gt;listlist[$this-&gt;listlvl] = array(<span class="stringliteral">&#39;TYPE&#39;</span>=&gt;<span class="stringliteral">&#39;disc&#39;</span>,<span class="stringliteral">&#39;MAXNUM&#39;</span>=&gt;$this-&gt;listnum);
<a name="l13994"></a>13994     }
<a name="l13995"></a>13995     $this-&gt;listnum++;
<a name="l13996"></a>13996     <span class="keywordflow">switch</span>($this-&gt;listlist[$this-&gt;listlvl][<span class="stringliteral">&#39;TYPE&#39;</span>]) {
<a name="l13997"></a>13997     <span class="keywordflow">case</span> <span class="charliteral">&#39;A&#39;</span>:
<a name="l13998"></a>13998       $blt = $this-&gt;dec2alpha($this-&gt;listnum,<span class="keyword">true</span>).$this-&gt;list_number_suffix;
<a name="l13999"></a>13999       <span class="keywordflow">break</span>;
<a name="l14000"></a>14000     <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:
<a name="l14001"></a>14001       $blt = $this-&gt;dec2alpha($this-&gt;listnum,<span class="keyword">false</span>).$this-&gt;list_number_suffix;
<a name="l14002"></a>14002       <span class="keywordflow">break</span>;
<a name="l14003"></a>14003     <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:
<a name="l14004"></a>14004       $blt = $this-&gt;dec2roman($this-&gt;listnum,<span class="keyword">true</span>).$this-&gt;list_number_suffix;
<a name="l14005"></a>14005       <span class="keywordflow">break</span>;
<a name="l14006"></a>14006     <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:
<a name="l14007"></a>14007       $blt = $this-&gt;dec2roman($this-&gt;listnum,<span class="keyword">false</span>).$this-&gt;list_number_suffix;
<a name="l14008"></a>14008       <span class="keywordflow">break</span>;
<a name="l14009"></a>14009     <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:
<a name="l14010"></a>14010       $blt = $this-&gt;listnum.$this-&gt;list_number_suffix;
<a name="l14011"></a>14011               <span class="keywordflow">break</span>;
<a name="l14012"></a>14012     <span class="keywordflow">default</span>:
<a name="l14013"></a>14013       <span class="comment">// mPDF 4.2</span>
<a name="l14014"></a>14014       <span class="keywordflow">if</span> ($this-&gt;listlvl % 3 == 1 &amp;&amp; isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>][8226])) { $blt = <span class="stringliteral">&quot;\xe2\x80\xa2&quot;</span>; }  <span class="comment">// &amp;#8226; </span>
<a name="l14015"></a>14015       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;listlvl % 3 == 2 &amp;&amp; isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>][9900])) { $blt = <span class="stringliteral">&quot;\xe2\x9a\xac&quot;</span>; } <span class="comment">// &amp;#9900; </span>
<a name="l14016"></a>14016       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;listlvl % 3 == 0 &amp;&amp; isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>][9642])) { $blt = <span class="stringliteral">&quot;\xe2\x96\xaa&quot;</span>; } <span class="comment">// &amp;#9642; </span>
<a name="l14017"></a>14017       <span class="keywordflow">else</span> { $blt = <span class="charliteral">&#39;-&#39;</span>; }
<a name="l14018"></a>14018       <span class="keywordflow">break</span>;
<a name="l14019"></a>14019     }
<a name="l14020"></a>14020 
<a name="l14021"></a>14021     <span class="comment">// mPDF 3.0 - change to &amp;nbsp; spaces</span>
<a name="l14022"></a>14022     <span class="keywordflow">if</span> ($this-&gt;is_MB) { 
<a name="l14023"></a>14023       $ls = str_repeat(<span class="stringliteral">&quot;\xc2\xa0\xc2\xa0&quot;</span>,($this-&gt;listlvl-1)*2) . $blt . <span class="charliteral">&#39; &#39;</span>; 
<a name="l14024"></a>14024     }
<a name="l14025"></a>14025     <span class="keywordflow">else</span> {
<a name="l14026"></a>14026       $ls = str_repeat(chr(160).chr(160),($this-&gt;listlvl-1)*2) . $blt . <span class="charliteral">&#39; &#39;</span>; 
<a name="l14027"></a>14027     }
<a name="l14028"></a>14028 
<a name="l14029"></a>14029     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($ls,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l14030"></a>14030     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;text&#39;</span>][] = $ls;
<a name="l14031"></a>14031     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] += $this-&gt;GetStringWidth($ls);
<a name="l14032"></a>14032     <span class="keywordflow">break</span>;
<a name="l14033"></a>14033   }
<a name="l14034"></a>14034   <span class="comment">//Observation: &lt;/LI&gt; is ignored</span>
<a name="l14035"></a>14035   <span class="keywordflow">if</span> ($this-&gt;listlvl == 0) { <span class="comment">//in case of malformed HTML code. Example:(...)&lt;/p&gt;&lt;li&gt;Content&lt;/li&gt;&lt;p&gt;Paragraph1&lt;/p&gt;(...)</span>
<a name="l14036"></a>14036   <span class="comment">//First of all, skip a line</span>
<a name="l14037"></a>14037     $this-&gt;listlvl++; <span class="comment">// first depth level</span>
<a name="l14038"></a>14038     $this-&gt;listnum = 0; <span class="comment">// reset</span>
<a name="l14039"></a>14039     $this-&gt;listoccur[$this-&gt;listlvl] = 1;
<a name="l14040"></a>14040     $this-&gt;listlist[$this-&gt;listlvl][1] = array(<span class="stringliteral">&#39;TYPE&#39;</span>=&gt;<span class="stringliteral">&#39;disc&#39;</span>,<span class="stringliteral">&#39;MAXNUM&#39;</span>=&gt;$this-&gt;listnum);
<a name="l14041"></a>14041   }
<a name="l14042"></a>14042   <span class="keywordflow">if</span> ($this-&gt;listnum == 0) {
<a name="l14043"></a>14043     $this-&gt;listnum++;
<a name="l14044"></a>14044     $this-&gt;textbuffer = array();
<a name="l14045"></a>14045   }
<a name="l14046"></a>14046   <span class="keywordflow">else</span> {
<a name="l14047"></a>14047     <span class="keywordflow">if</span> (!empty($this-&gt;textbuffer)) {
<a name="l14048"></a>14048       $this-&gt;listitem[] = array($this-&gt;listlvl,$this-&gt;listnum,$this-&gt;textbuffer,$this-&gt;listoccur[$this-&gt;listlvl],$this-&gt;listitemtype);
<a name="l14049"></a>14049       $this-&gt;listnum++;
<a name="l14050"></a>14050     }
<a name="l14051"></a>14051     $this-&gt;textbuffer = array();
<a name="l14052"></a>14052       }
<a name="l14053"></a>14053 
<a name="l14054"></a>14054   $this-&gt;listCSSlvl++;
<a name="l14055"></a>14055   $properties = $this-&gt;MergeCSS(<span class="stringliteral">&#39;LIST&#39;</span>,$tag,$attr);
<a name="l14056"></a>14056   <span class="keywordflow">if</span> (!empty($properties)) $this-&gt;setCSS($properties,<span class="stringliteral">&#39;INLINE&#39;</span>);
<a name="l14057"></a>14057   $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$this-&gt;listlvl][$this-&gt;listoccur[$this-&gt;listlvl]][$this-&gt;listnum] = $this-&gt;saveInlineProperties();
<a name="l14058"></a>14058 
<a name="l14059"></a>14059   <span class="comment">// List-type</span>
<a name="l14060"></a>14060   <span class="keywordflow">if</span> (isset($attr[<span class="stringliteral">&#39;TYPE&#39;</span>]) &amp;&amp; $attr[<span class="stringliteral">&#39;TYPE&#39;</span>]) { $this-&gt;listitemtype = $attr[<span class="stringliteral">&#39;TYPE&#39;</span>]; }
<a name="l14061"></a>14061   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;LIST-STYLE-TYPE&#39;</span>])) { 
<a name="l14062"></a>14062     <span class="comment">// mPDF 4.0</span>
<a name="l14063"></a>14063     $this-&gt;listitemtype = $this-&gt;_getListStyle($properties[<span class="stringliteral">&#39;LIST-STYLE-TYPE&#39;</span>]);
<a name="l14064"></a>14064   }
<a name="l14065"></a>14065   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($properties[<span class="stringliteral">&#39;LIST-STYLE&#39;</span>])) { 
<a name="l14066"></a>14066     <span class="comment">// mPDF 4.0</span>
<a name="l14067"></a>14067     $this-&gt;listitemtype = $this-&gt;_getListStyle($properties[<span class="stringliteral">&#39;LIST-STYLE&#39;</span>]);
<a name="l14068"></a>14068   }
<a name="l14069"></a>14069   <span class="keywordflow">else</span> $this-&gt;listitemtype = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14070"></a>14070 
<a name="l14071"></a>14071       <span class="keywordflow">break</span>;
<a name="l14072"></a>14072 
<a name="l14073"></a>14073   }<span class="comment">//end of switch</span>
<a name="l14074"></a>14074 }
<a name="l14075"></a>14075 
<a name="l14076"></a>14076 <span class="comment">// mPDF 4.0</span>
<a name="l14077"></a>14077 function _getListStyle($ls) {
<a name="l14078"></a>14078   <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;disc&#39;</span>)) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;disc&#39;</span>; }
<a name="l14079"></a>14079   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;circle&#39;</span>)) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;circle&#39;</span>; }
<a name="l14080"></a>14080   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;square&#39;</span>)) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;square&#39;</span>; }
<a name="l14081"></a>14081   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;decimal&#39;</span>)) { <span class="keywordflow">return</span> <span class="charliteral">&#39;1&#39;</span>; }
<a name="l14082"></a>14082   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;lower-roman&#39;</span>)) { <span class="keywordflow">return</span> <span class="charliteral">&#39;i&#39;</span>; }
<a name="l14083"></a>14083   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;upper-roman&#39;</span>)) { <span class="keywordflow">return</span> <span class="charliteral">&#39;I&#39;</span>; }
<a name="l14084"></a>14084   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;lower-latin&#39;</span>)|| stristr($ls,<span class="stringliteral">&#39;lower-alpha&#39;</span>)) { <span class="keywordflow">return</span> <span class="charliteral">&#39;a&#39;</span>; }
<a name="l14085"></a>14085   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;upper-latin&#39;</span>) || stristr($ls,<span class="stringliteral">&#39;upper-alpha&#39;</span>)) { <span class="keywordflow">return</span> <span class="charliteral">&#39;A&#39;</span>; }
<a name="l14086"></a>14086   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($ls,<span class="stringliteral">&#39;none&#39;</span>)) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;none&#39;</span>; }
<a name="l14087"></a>14087   <span class="keywordflow">else</span> { <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; }
<a name="l14088"></a>14088 }
<a name="l14089"></a>14089 
<a name="l14090"></a>14090 
<a name="l14091"></a>14091 
<a name="l14092"></a>14092 function CloseTag($tag)
<a name="l14093"></a>14093 {
<a name="l14094"></a>14094   $this-&gt;ignorefollowingspaces = <span class="keyword">false</span>; <span class="comment">//Eliminate exceeding left-side spaces</span>
<a name="l14095"></a>14095     <span class="comment">//Closing tag</span>
<a name="l14096"></a>14096     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;OPTION&#39;</span>) { $this-&gt;selectoption[<span class="stringliteral">&#39;ACTIVE&#39;</span>] = <span class="keyword">false</span>;   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l14097"></a>14097 
<a name="l14098"></a>14098     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;TTS&#39;</span> or $tag==<span class="stringliteral">&#39;TTA&#39;</span> or $tag==<span class="stringliteral">&#39;TTZ&#39;</span>) {
<a name="l14099"></a>14099   <span class="keywordflow">if</span> ($this-&gt;InlineProperties[$tag]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[$tag]); }
<a name="l14100"></a>14100   unset($this-&gt;InlineProperties[$tag]);
<a name="l14101"></a>14101   $ltag = strtolower($tag);
<a name="l14102"></a>14102   $this-&gt;$ltag = <span class="keyword">false</span>;
<a name="l14103"></a>14103     }
<a name="l14104"></a>14104 
<a name="l14105"></a>14105 
<a name="l14106"></a>14106     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;FONT&#39;</span> || $tag==<span class="stringliteral">&#39;SPAN&#39;</span> || $tag==<span class="stringliteral">&#39;CODE&#39;</span> || $tag==<span class="stringliteral">&#39;KBD&#39;</span> || $tag==<span class="stringliteral">&#39;SAMP&#39;</span> || $tag==<span class="stringliteral">&#39;TT&#39;</span> || $tag==<span class="stringliteral">&#39;VAR&#39;</span> 
<a name="l14107"></a>14107   || $tag==<span class="stringliteral">&#39;INS&#39;</span> || $tag==<span class="stringliteral">&#39;STRONG&#39;</span> || $tag==<span class="stringliteral">&#39;CITE&#39;</span> || $tag==<span class="stringliteral">&#39;SUB&#39;</span> || $tag==<span class="stringliteral">&#39;SUP&#39;</span> || $tag==<span class="charliteral">&#39;S&#39;</span> || $tag==<span class="stringliteral">&#39;STRIKE&#39;</span> || $tag==<span class="stringliteral">&#39;DEL&#39;</span>
<a name="l14108"></a>14108   || $tag==<span class="charliteral">&#39;Q&#39;</span> || $tag==<span class="stringliteral">&#39;EM&#39;</span> || $tag==<span class="charliteral">&#39;B&#39;</span> || $tag==<span class="charliteral">&#39;I&#39;</span> || $tag==<span class="charliteral">&#39;U&#39;</span> | $tag==<span class="stringliteral">&#39;SMALL&#39;</span> || $tag==<span class="stringliteral">&#39;BIG&#39;</span> || $tag==<span class="stringliteral">&#39;ACRONYM&#39;</span>) {
<a name="l14109"></a>14109 
<a name="l14110"></a>14110   <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;SPAN&#39;</span>) {
<a name="l14111"></a>14111     <span class="keywordflow">if</span> (isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;SPAN&#39;</span>][$this-&gt;spanlvl]) &amp;&amp; $this-&gt;InlineProperties[<span class="stringliteral">&#39;SPAN&#39;</span>][$this-&gt;spanlvl]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;SPAN&#39;</span>][$this-&gt;spanlvl]); }
<a name="l14112"></a>14112     unset($this-&gt;InlineProperties[<span class="stringliteral">&#39;SPAN&#39;</span>][$this-&gt;spanlvl]);
<a name="l14113"></a>14113     $this-&gt;spanlvl--;
<a name="l14114"></a>14114   }
<a name="l14115"></a>14115   <span class="keywordflow">else</span> { 
<a name="l14116"></a>14116     <span class="keywordflow">if</span> (isset($this-&gt;InlineProperties[$tag]) &amp;&amp; $this-&gt;InlineProperties[$tag]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[$tag]); }
<a name="l14117"></a>14117     unset($this-&gt;InlineProperties[$tag]);
<a name="l14118"></a>14118   }
<a name="l14119"></a>14119     }
<a name="l14120"></a>14120 
<a name="l14121"></a>14121 
<a name="l14122"></a>14122     <span class="keywordflow">if</span>($tag==<span class="charliteral">&#39;A&#39;</span>) {
<a name="l14123"></a>14123   $this-&gt;HREF=<span class="stringliteral">&#39;&#39;</span>; 
<a name="l14124"></a>14124   <span class="keywordflow">if</span> (isset($this-&gt;InlineProperties[<span class="charliteral">&#39;A&#39;</span>])) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="charliteral">&#39;A&#39;</span>]); }
<a name="l14125"></a>14125   unset($this-&gt;InlineProperties[<span class="charliteral">&#39;A&#39;</span>]);
<a name="l14126"></a>14126     }
<a name="l14127"></a>14127 
<a name="l14128"></a>14128 
<a name="l14129"></a>14129 
<a name="l14130"></a>14130 
<a name="l14131"></a>14131 
<a name="l14132"></a>14132   <span class="comment">// *********** BLOCKS ********************</span>
<a name="l14133"></a>14133 
<a name="l14134"></a>14134     <span class="keywordflow">if</span>($tag==<span class="charliteral">&#39;P&#39;</span> || $tag==<span class="stringliteral">&#39;DIV&#39;</span> || $tag==<span class="stringliteral">&#39;H1&#39;</span> || $tag==<span class="stringliteral">&#39;H2&#39;</span> || $tag==<span class="stringliteral">&#39;H3&#39;</span> || $tag==<span class="stringliteral">&#39;H4&#39;</span> || $tag==<span class="stringliteral">&#39;H5&#39;</span> || $tag==<span class="stringliteral">&#39;H6&#39;</span> || $tag==<span class="stringliteral">&#39;PRE&#39;</span> 
<a name="l14135"></a>14135    || $tag==<span class="stringliteral">&#39;FORM&#39;</span> || $tag==<span class="stringliteral">&#39;ADDRESS&#39;</span> || $tag==<span class="stringliteral">&#39;BLOCKQUOTE&#39;</span> || $tag==<span class="stringliteral">&#39;CENTER&#39;</span> || $tag==<span class="stringliteral">&#39;DT&#39;</span>  || $tag==<span class="stringliteral">&#39;DD&#39;</span>  || $tag==<span class="stringliteral">&#39;DL&#39;</span> ) { 
<a name="l14136"></a>14136 
<a name="l14137"></a>14137   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; <span class="comment">//Eliminate exceeding left-side spaces</span>
<a name="l14138"></a>14138   $this-&gt;blockjustfinished=<span class="keyword">true</span>;
<a name="l14139"></a>14139   <span class="comment">// mPDF 4.2</span>
<a name="l14140"></a>14140   $this-&gt;lastblockbottommargin = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_bottom&#39;</span>];
<a name="l14141"></a>14141 
<a name="l14142"></a>14142   <span class="comment">// mPDF 4.0</span>
<a name="l14143"></a>14143   <span class="keywordflow">if</span> ($this-&gt;listlvl&gt;0) { <span class="keywordflow">return</span>; }
<a name="l14144"></a>14144 
<a name="l14145"></a>14145   <span class="keywordflow">if</span>($this-&gt;tableLevel) {
<a name="l14146"></a>14146     <span class="comment">// mPDF 3.0</span>
<a name="l14147"></a>14147     <span class="keywordflow">if</span> ($this-&gt;linebreakjustfinished) { $this-&gt;blockjustfinished=<span class="keyword">false</span>; }
<a name="l14148"></a>14148     <span class="comment">// mPDF 4.0</span>
<a name="l14149"></a>14149     <span class="keywordflow">if</span> (isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;BLOCKINTABLE&#39;</span>])) { 
<a name="l14150"></a>14150       <span class="keywordflow">if</span> ($this-&gt;InlineProperties[<span class="stringliteral">&#39;BLOCKINTABLE&#39;</span>]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;BLOCKINTABLE&#39;</span>]); }
<a name="l14151"></a>14151       unset($this-&gt;InlineProperties[<span class="stringliteral">&#39;BLOCKINTABLE&#39;</span>]);
<a name="l14152"></a>14152     }
<a name="l14153"></a>14153     <span class="keywordflow">return</span>;
<a name="l14154"></a>14154   }
<a name="l14155"></a>14155   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14156"></a>14156   $this-&gt;divbegin=<span class="keyword">false</span>;
<a name="l14157"></a>14157   <span class="comment">// mPDF 3.0</span>
<a name="l14158"></a>14158   $this-&gt;linebreakjustfinished=<span class="keyword">false</span>;
<a name="l14159"></a>14159 
<a name="l14160"></a>14160   $this-&gt;x = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l14161"></a>14161 
<a name="l14162"></a>14162   <span class="comment">// If float contained in a float, need to extend bottom to allow for it</span>
<a name="l14163"></a>14163   $currpos = $this-&gt;page*1000 + $this-&gt;y;
<a name="l14164"></a>14164   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>] &gt; $currpos) {
<a name="l14165"></a>14165     $old_page = $this-&gt;page;
<a name="l14166"></a>14166     $new_page = intval($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>] /1000);
<a name="l14167"></a>14167     <span class="keywordflow">if</span> ($old_page != $new_page) {
<a name="l14168"></a>14168       $s = $this-&gt;PrintPageBackgrounds();
<a name="l14169"></a>14169       <span class="comment">// Writes after the marker so not overwritten later by page background etc.</span>
<a name="l14170"></a>14170       $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l14171"></a>14171       $this-&gt;pageBackgrounds = array();
<a name="l14172"></a>14172       $this-&gt;page = $new_page;
<a name="l14173"></a>14173       $this-&gt;ResetMargins();
<a name="l14174"></a>14174       $this-&gt;Reset();
<a name="l14175"></a>14175       $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l14176"></a>14176     }
<a name="l14177"></a>14177     $this-&gt;y = (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_endpos&#39;</span>] *1000) % 1000000)/1000;  <span class="comment">// mod changes operands to integers before processing</span>
<a name="l14178"></a>14178   }
<a name="l14179"></a>14179 
<a name="l14180"></a>14180   <span class="comment">//Print content</span>
<a name="l14181"></a>14181   <span class="keywordflow">if</span> ($this-&gt;lastblocklevelchange == 1) { $blockstate = 3; }  <span class="comment">// Top &amp; bottom margins/padding</span>
<a name="l14182"></a>14182   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;lastblocklevelchange == -1) { $blockstate = 2; }  <span class="comment">// Bottom margins/padding only</span>
<a name="l14183"></a>14183   <span class="keywordflow">else</span> { $blockstate = 0; } <span class="comment">// mPDF 3.0</span>
<a name="l14184"></a>14184   <span class="comment">// called from after e.g. &lt;/table&gt; &lt;/div&gt; &lt;/div&gt; ...    Outputs block margin/border and padding</span>
<a name="l14185"></a>14185   <span class="keywordflow">if</span> (count($this-&gt;textbuffer) &amp;&amp; $this-&gt;textbuffer[count($this-&gt;textbuffer)-1]) {
<a name="l14186"></a>14186     <span class="comment">// mPDF 3.0 ...as long as not special content</span>
<a name="l14187"></a>14187     <span class="keywordflow">if</span> (substr($this-&gt;textbuffer[count($this-&gt;textbuffer)-1][0],0,3) != <span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>) { <span class="comment">// not special content</span>
<a name="l14188"></a>14188      <span class="keywordflow">if</span> ($this-&gt;is_MB) {  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l14189"></a>14189     $this-&gt;textbuffer[count($this-&gt;textbuffer)-1][0] = preg_replace(<span class="stringliteral">&#39;/[ ]+$/u&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $this-&gt;textbuffer[count($this-&gt;textbuffer)-1][0]);  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l14190"></a>14190      }  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l14191"></a>14191      <span class="keywordflow">else</span> { <span class="comment">// *UNICODE-FONTS*</span>
<a name="l14192"></a>14192     $this-&gt;textbuffer[count($this-&gt;textbuffer)-1][0] = preg_replace(<span class="stringliteral">&#39;/[ ]+$/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $this-&gt;textbuffer[count($this-&gt;textbuffer)-1][0]);
<a name="l14193"></a>14193      }  <span class="comment">// *UNICODE-FONTS*</span>
<a name="l14194"></a>14194     }
<a name="l14195"></a>14195   }
<a name="l14196"></a>14196   <span class="keywordflow">if</span> (count($this-&gt;textbuffer) == 0 &amp;&amp; $this-&gt;lastblocklevelchange != 0) {
<a name="l14197"></a>14197     $this-&gt;newFlowingBlock( $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;width&#39;</span>],$this-&gt;lineheight,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,2,<span class="keyword">true</span>);  <span class="comment">// true = newblock</span>
<a name="l14198"></a>14198     $this-&gt;finishFlowingBlock(<span class="keyword">true</span>);  <span class="comment">// true = END of flowing block</span>
<a name="l14199"></a>14199     $this-&gt;PaintDivBB(<span class="stringliteral">&#39;&#39;</span>,$blockstate);
<a name="l14200"></a>14200   }
<a name="l14201"></a>14201   <span class="keywordflow">else</span> {
<a name="l14202"></a>14202     $this-&gt;printbuffer($this-&gt;textbuffer,$blockstate); 
<a name="l14203"></a>14203   }
<a name="l14204"></a>14204 
<a name="l14205"></a>14205 
<a name="l14206"></a>14206   $this-&gt;textbuffer=array();
<a name="l14207"></a>14207 
<a name="l14208"></a>14208   <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;keep_block_together&#39;</span>]) {
<a name="l14209"></a>14209     $this-&gt;printdivbuffer(); 
<a name="l14210"></a>14210   }
<a name="l14211"></a>14211 
<a name="l14212"></a>14212   <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l14213"></a>14213     $this-&gt;kwt_height = $this-&gt;y - $this-&gt;kwt_y0;
<a name="l14214"></a>14214   }
<a name="l14215"></a>14215 
<a name="l14216"></a>14216   $this-&gt;printfloatbuffer();
<a name="l14217"></a>14217 
<a name="l14218"></a>14218   <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;PRE&#39;</span>) { $this-&gt;ispre=<span class="keyword">false</span>; }
<a name="l14219"></a>14219 
<a name="l14220"></a>14220   <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l14221"></a>14221     <span class="comment">// If width not set, here would need to adjust and output buffer</span>
<a name="l14222"></a>14222     $s = $this-&gt;PrintPageBackgrounds();
<a name="l14223"></a>14223     <span class="comment">// Writes after the marker so not overwritten later by page background etc.</span>
<a name="l14224"></a>14224     $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l14225"></a>14225     $this-&gt;pageBackgrounds = array();
<a name="l14226"></a>14226     $this-&gt;Reset();
<a name="l14227"></a>14227     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l14228"></a>14228 
<a name="l14229"></a>14229     <span class="keywordflow">for</span>($i=($this-&gt;blklvl-1); $i &gt;= 0; $i--) {
<a name="l14230"></a>14230       <span class="keywordflow">if</span> (isset($this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>])) { $this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>] = max($this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>], ($this-&gt;page*1000 + $this-&gt;y)); }
<a name="l14231"></a>14231       <span class="keywordflow">else</span> { $this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>] = $this-&gt;page*1000 + $this-&gt;y; }
<a name="l14232"></a>14232     }
<a name="l14233"></a>14233 
<a name="l14234"></a>14234     $this-&gt;floatDivs[] = array(
<a name="l14235"></a>14235       <span class="stringliteral">&#39;side&#39;</span>=&gt;<span class="charliteral">&#39;R&#39;</span>,
<a name="l14236"></a>14236       <span class="stringliteral">&#39;startpage&#39;</span>=&gt;$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] ,
<a name="l14237"></a>14237       <span class="stringliteral">&#39;y0&#39;</span>=&gt;$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_start_y&#39;</span>] ,
<a name="l14238"></a>14238       <span class="stringliteral">&#39;startpos&#39;</span>=&gt; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]*1000 + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_start_y&#39;</span>]),
<a name="l14239"></a>14239       <span class="stringliteral">&#39;endpage&#39;</span>=&gt;$this-&gt;page ,
<a name="l14240"></a>14240       <span class="stringliteral">&#39;y1&#39;</span>=&gt;$this-&gt;y ,
<a name="l14241"></a>14241       <span class="stringliteral">&#39;endpos&#39;</span>=&gt; ($this-&gt;page*1000 + $this-&gt;y),
<a name="l14242"></a>14242       <span class="charliteral">&#39;w&#39;</span>=&gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_width&#39;</span>],
<a name="l14243"></a>14243       <span class="stringliteral">&#39;blklvl&#39;</span>=&gt;$this-&gt;blklvl,
<a name="l14244"></a>14244       <span class="stringliteral">&#39;blockContext&#39;</span> =&gt; $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;blockContext&#39;</span>]
<a name="l14245"></a>14245     );
<a name="l14246"></a>14246 
<a name="l14247"></a>14247     $this-&gt;y = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_start_y&#39;</span>] ;
<a name="l14248"></a>14248     $this-&gt;page = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] ;
<a name="l14249"></a>14249     $this-&gt;ResetMargins();
<a name="l14250"></a>14250     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l14251"></a>14251   }
<a name="l14252"></a>14252   <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l14253"></a>14253     <span class="comment">// If width not set, here would need to adjust and output buffer</span>
<a name="l14254"></a>14254     $s = $this-&gt;PrintPageBackgrounds();
<a name="l14255"></a>14255     <span class="comment">// Writes after the marker so not overwritten later by page background etc.</span>
<a name="l14256"></a>14256     $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&#39;\\1&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l14257"></a>14257     $this-&gt;pageBackgrounds = array();
<a name="l14258"></a>14258     $this-&gt;Reset();
<a name="l14259"></a>14259     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l14260"></a>14260 
<a name="l14261"></a>14261     <span class="keywordflow">for</span>($i=($this-&gt;blklvl-1); $i &gt;= 0; $i--) {
<a name="l14262"></a>14262       <span class="keywordflow">if</span> (isset($this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>])) { $this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>] = max($this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>], ($this-&gt;page*1000 + $this-&gt;y)); }
<a name="l14263"></a>14263       <span class="keywordflow">else</span> { $this-&gt;blk[$i][<span class="stringliteral">&#39;float_endpos&#39;</span>] = $this-&gt;page*1000 + $this-&gt;y; }
<a name="l14264"></a>14264     }
<a name="l14265"></a>14265 
<a name="l14266"></a>14266     $this-&gt;floatDivs[] = array(
<a name="l14267"></a>14267       <span class="stringliteral">&#39;side&#39;</span>=&gt;<span class="charliteral">&#39;L&#39;</span>,
<a name="l14268"></a>14268       <span class="stringliteral">&#39;startpage&#39;</span>=&gt;$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] ,
<a name="l14269"></a>14269       <span class="stringliteral">&#39;y0&#39;</span>=&gt;$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_start_y&#39;</span>] ,
<a name="l14270"></a>14270       <span class="stringliteral">&#39;startpos&#39;</span>=&gt; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]*1000 + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_start_y&#39;</span>]),
<a name="l14271"></a>14271       <span class="stringliteral">&#39;endpage&#39;</span>=&gt;$this-&gt;page ,
<a name="l14272"></a>14272       <span class="stringliteral">&#39;y1&#39;</span>=&gt;$this-&gt;y ,
<a name="l14273"></a>14273       <span class="stringliteral">&#39;endpos&#39;</span>=&gt; ($this-&gt;page*1000 + $this-&gt;y),
<a name="l14274"></a>14274       <span class="charliteral">&#39;w&#39;</span>=&gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_width&#39;</span>],
<a name="l14275"></a>14275       <span class="stringliteral">&#39;blklvl&#39;</span>=&gt;$this-&gt;blklvl,
<a name="l14276"></a>14276       <span class="stringliteral">&#39;blockContext&#39;</span> =&gt; $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;blockContext&#39;</span>]
<a name="l14277"></a>14277     );
<a name="l14278"></a>14278 
<a name="l14279"></a>14279     $this-&gt;y = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;float_start_y&#39;</span>] ;
<a name="l14280"></a>14280     $this-&gt;page = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] ;
<a name="l14281"></a>14281     $this-&gt;ResetMargins();
<a name="l14282"></a>14282     $this-&gt;pageoutput[$this-&gt;page] = array();
<a name="l14283"></a>14283   }
<a name="l14284"></a>14284 
<a name="l14285"></a>14285   <span class="comment">//Reset values</span>
<a name="l14286"></a>14286   $this-&gt;Reset();
<a name="l14287"></a>14287 
<a name="l14288"></a>14288   <span class="keywordflow">if</span> ($this-&gt;blklvl &gt; 0) {  <span class="comment">// ==0 SHOULDN&#39;T HAPPEN - NOT XHTML </span>
<a name="l14289"></a>14289      <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;tag&#39;</span>] == $tag) {
<a name="l14290"></a>14290     unset($this-&gt;blk[$this-&gt;blklvl]);
<a name="l14291"></a>14291     $this-&gt;blklvl--;
<a name="l14292"></a>14292      }
<a name="l14293"></a>14293      <span class="comment">//else { echo $tag; exit; }  // debug - forces error if incorrectly nested html tags</span>
<a name="l14294"></a>14294   }
<a name="l14295"></a>14295 
<a name="l14296"></a>14296   $this-&gt;lastblocklevelchange = -1 ;
<a name="l14297"></a>14297   <span class="comment">// Reset Inline-type properties</span>
<a name="l14298"></a>14298   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>])) { $this-&gt;restoreInlineProperties($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>]); }
<a name="l14299"></a>14299 
<a name="l14300"></a>14300   $this-&gt;x = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l14301"></a>14301 
<a name="l14302"></a>14302     }
<a name="l14303"></a>14303 
<a name="l14304"></a>14304 
<a name="l14305"></a>14305 
<a name="l14306"></a>14306     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;TH&#39;</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l14307"></a>14307 
<a name="l14308"></a>14308     <span class="keywordflow">if</span>(($tag==<span class="stringliteral">&#39;TH&#39;</span> or $tag==<span class="stringliteral">&#39;TD&#39;</span>) &amp;&amp; $this-&gt;tableLevel) {
<a name="l14309"></a>14309   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;TR&#39;</span>;
<a name="l14310"></a>14310   unset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl]);
<a name="l14311"></a>14311   $this-&gt;tbCSSlvl--;
<a name="l14312"></a>14312   $this-&gt;tdbegin = <span class="keyword">false</span>;
<a name="l14313"></a>14313 
<a name="l14314"></a>14314   <span class="comment">// Added for correct calculation of cell column width - otherwise misses the last line if not end &lt;/p&gt; etc.</span>
<a name="l14315"></a>14315   <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l14316"></a>14316     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l14317"></a>14317   }
<a name="l14318"></a>14318   elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l14319"></a>14319     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l14320"></a>14320   }
<a name="l14321"></a>14321 
<a name="l14322"></a>14322   <span class="comment">// Remove last &lt;br&gt; if at end of cell</span>
<a name="l14323"></a>14323   <span class="keywordflow">if</span> (isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>])) { $ntb = count($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>]); }
<a name="l14324"></a>14324   <span class="keywordflow">else</span> { $ntb = 0; }
<a name="l14325"></a>14325   <span class="comment">// mPDF 3.0 ... but only the last one</span>
<a name="l14326"></a>14326   <span class="keywordflow">if</span> ($ntb&gt;1 &amp;&amp; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][$ntb-1][0] == <span class="stringliteral">&quot;\n&quot;</span>) {
<a name="l14327"></a>14327     unset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][$ntb-1]);
<a name="l14328"></a>14328   }
<a name="l14329"></a>14329 
<a name="l14330"></a>14330   <span class="keywordflow">if</span> ($this-&gt;tablethead) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_thead&#39;</span>][$this-&gt;row] = <span class="keyword">true</span>; }
<a name="l14331"></a>14331   <span class="comment">// mPDF 3.0</span>
<a name="l14332"></a>14332   <span class="keywordflow">if</span> ($this-&gt;usetableheader &amp;&amp; ($this-&gt;row == 0  || $this-&gt;tablethead) &amp;&amp; $this-&gt;tableLevel==1) {
<a name="l14333"></a>14333     $this-&gt;tableheadernrows = max($this-&gt;tableheadernrows, ($this-&gt;row+1));
<a name="l14334"></a>14334   }
<a name="l14335"></a>14335   <span class="comment">// mPDF 4.0</span>
<a name="l14336"></a>14336   <span class="keywordflow">if</span> ($this-&gt;tabletfoot) { $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>][$this-&gt;row] = <span class="keyword">true</span>; }
<a name="l14337"></a>14337   <span class="keywordflow">if</span> ($this-&gt;tabletfoot &amp;&amp; $this-&gt;tableLevel==1) {
<a name="l14338"></a>14338     $this-&gt;tablefooternrows = max($this-&gt;tablefooternrows, ($this-&gt;row+1 - $this-&gt;tableheadernrows));
<a name="l14339"></a>14339   }
<a name="l14340"></a>14340   $this-&gt;Reset();
<a name="l14341"></a>14341     }
<a name="l14342"></a>14342 
<a name="l14343"></a>14343     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;TR&#39;</span> &amp;&amp; $this-&gt;tableLevel) {
<a name="l14344"></a>14344   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14345"></a>14345   unset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl]);
<a name="l14346"></a>14346   $this-&gt;tbCSSlvl--;
<a name="l14347"></a>14347   $this-&gt;trow_text_rotate = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14348"></a>14348   $this-&gt;tabletheadjustfinished = <span class="keyword">false</span>;
<a name="l14349"></a>14349    }
<a name="l14350"></a>14350 
<a name="l14351"></a>14351     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;TBODY&#39;</span>) {
<a name="l14352"></a>14352   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14353"></a>14353   unset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl]);
<a name="l14354"></a>14354   $this-&gt;tbCSSlvl--;
<a name="l14355"></a>14355     }
<a name="l14356"></a>14356 
<a name="l14357"></a>14357     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;THEAD&#39;</span>) {
<a name="l14358"></a>14358   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14359"></a>14359   unset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl]);
<a name="l14360"></a>14360   $this-&gt;tbCSSlvl--;
<a name="l14361"></a>14361   $this-&gt;tablethead = 0;
<a name="l14362"></a>14362   $this-&gt;tabletheadjustfinished = <span class="keyword">true</span>;
<a name="l14363"></a>14363   $this-&gt;thead_font_weight = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14364"></a>14364   $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l14365"></a>14365   $this-&gt;thead_font_style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14366"></a>14366   $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l14367"></a>14367 
<a name="l14368"></a>14368   $this-&gt;thead_valign_default = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14369"></a>14369   $this-&gt;thead_textalign_default = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14370"></a>14370     }
<a name="l14371"></a>14371 
<a name="l14372"></a>14372     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;TFOOT&#39;</span>) {
<a name="l14373"></a>14373   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14374"></a>14374   unset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl]);
<a name="l14375"></a>14375   $this-&gt;tbCSSlvl--;
<a name="l14376"></a>14376   $this-&gt;tabletfoot = 0;  <span class="comment">// mPDF 4.0</span>
<a name="l14377"></a>14377   $this-&gt;tfoot_font_weight = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14378"></a>14378   $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l14379"></a>14379   $this-&gt;tfoot_font_style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14380"></a>14380   $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l14381"></a>14381 
<a name="l14382"></a>14382   $this-&gt;tfoot_valign_default = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14383"></a>14383   $this-&gt;tfoot_textalign_default = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14384"></a>14384     }
<a name="l14385"></a>14385 
<a name="l14386"></a>14386 
<a name="l14387"></a>14387 
<a name="l14388"></a>14388     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;TABLE&#39;</span>) { <span class="comment">// TABLE-END (</span>
<a name="l14389"></a>14389   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14390"></a>14390   unset($this-&gt;tablecascadeCSS[$this-&gt;tbCSSlvl]);
<a name="l14391"></a>14391   $this-&gt;tbCSSlvl--;
<a name="l14392"></a>14392   $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; <span class="comment">//Eliminate exceeding left-side spaces</span>
<a name="l14393"></a>14393   $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cells&#39;</span>] = $this-&gt;cell;
<a name="l14394"></a>14394   $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;wc&#39;</span>] = array_pad(array(),$this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nc&#39;</span>],array(<span class="stringliteral">&#39;miw&#39;</span>=&gt;0,<span class="stringliteral">&#39;maw&#39;</span>=&gt;0));
<a name="l14395"></a>14395   $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;hr&#39;</span>] = array_pad(array(),$this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;nr&#39;</span>],0);
<a name="l14396"></a>14396 
<a name="l14397"></a>14397   <span class="comment">// mPDF 4.0  Move TABLE FOOTER TFOOT to end of table </span>
<a name="l14398"></a>14398   <span class="keywordflow">if</span> (isset($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>]) &amp;&amp; count($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>])) {
<a name="l14399"></a>14399     $tfrows = array();
<a name="l14400"></a>14400     <span class="keywordflow">foreach</span>($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>] AS $r=&gt;$val) {
<a name="l14401"></a>14401       <span class="keywordflow">if</span> ($val) { $tfrows[] = $r; }
<a name="l14402"></a>14402     }
<a name="l14403"></a>14403     $temp = array();
<a name="l14404"></a>14404     $temptf = array();
<a name="l14405"></a>14405     <span class="keywordflow">foreach</span>($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cells&#39;</span>] AS $k=&gt;$row) {
<a name="l14406"></a>14406       <span class="keywordflow">if</span> (in_array($k,$tfrows)) {
<a name="l14407"></a>14407         $temptf[] = $row;
<a name="l14408"></a>14408       }
<a name="l14409"></a>14409       <span class="keywordflow">else</span> {
<a name="l14410"></a>14410         $temp[] = $row;
<a name="l14411"></a>14411       }
<a name="l14412"></a>14412     }
<a name="l14413"></a>14413     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>] = array();
<a name="l14414"></a>14414     <span class="keywordflow">for</span>($i=count($temp) ; $i&lt;(count($temp)+count($temptf)); $i++) {
<a name="l14415"></a>14415       $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;is_tfoot&#39;</span>][$i] = <span class="keyword">true</span>;
<a name="l14416"></a>14416     }
<a name="l14417"></a>14417     <span class="comment">// Update nestedpos row references</span>
<a name="l14418"></a>14418     <span class="keywordflow">if</span> (count($this-&gt;table[($this-&gt;tableLevel+1)])) {
<a name="l14419"></a>14419       <span class="keywordflow">foreach</span>($this-&gt;table[($this-&gt;tableLevel+1)] AS $nid=&gt;$nested) {
<a name="l14420"></a>14420       $this-&gt;table[($this-&gt;tableLevel+1)][$nid][<span class="stringliteral">&#39;nestedpos&#39;</span>][0] -= count($temptf);
<a name="l14421"></a>14421       }
<a name="l14422"></a>14422     } 
<a name="l14423"></a>14423     $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cells&#39;</span>] = array_merge($temp, $temptf);
<a name="l14424"></a>14424   }
<a name="l14425"></a>14425 
<a name="l14426"></a>14426   <span class="comment">// Fix Borders *********************************************</span>
<a name="l14427"></a>14427   $this-&gt;_fixTableBorders($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]]);
<a name="l14428"></a>14428 
<a name="l14429"></a>14429 
<a name="l14430"></a>14430   <span class="keywordflow">if</span> ($this-&gt;table_rotate &lt;&gt; 0) {
<a name="l14431"></a>14431     $this-&gt;tablebuffer = array();
<a name="l14432"></a>14432     <span class="comment">// Max width for rotated table</span>
<a name="l14433"></a>14433     $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5);
<a name="l14434"></a>14434     $this-&gt;tbrot_maxh = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>] ;    <span class="comment">// Max width for rotated table</span>
<a name="l14435"></a>14435     $this-&gt;tbrot_align = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="charliteral">&#39;a&#39;</span>] ;
<a name="l14436"></a>14436   }
<a name="l14437"></a>14437   $this-&gt;shrin_k = 1;
<a name="l14438"></a>14438 
<a name="l14439"></a>14439   <span class="comment">// mPDF 4.2</span>
<a name="l14440"></a>14440   <span class="keywordflow">if</span> ($this-&gt;shrink_tables_to_fit &lt; 1) { $this-&gt;shrink_tables_to_fit = 1; }
<a name="l14441"></a>14441   <span class="keywordflow">if</span> (!$this-&gt;shrink_this_table_to_fit) { $this-&gt;shrink_this_table_to_fit = $this-&gt;shrink_tables_to_fit; }
<a name="l14442"></a>14442 
<a name="l14443"></a>14443   <span class="keywordflow">if</span> ($this-&gt;tableLevel&gt;1) {
<a name="l14444"></a>14444     <span class="comment">// deal with nested table</span>
<a name="l14445"></a>14445 
<a name="l14446"></a>14446     $this-&gt;_tableColumnWidth($this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]],<span class="keyword">true</span>);
<a name="l14447"></a>14447 
<a name="l14448"></a>14448     $tmiw = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l14449"></a>14449     $tmaw = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l14450"></a>14450     $tl = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;tl&#39;</span>];
<a name="l14451"></a>14451 
<a name="l14452"></a>14452     <span class="comment">// Go down to lower table level</span>
<a name="l14453"></a>14453     $this-&gt;tableLevel--;
<a name="l14454"></a>14454 
<a name="l14455"></a>14455     <span class="comment">// Reset lower level table</span>
<a name="l14456"></a>14456     $this-&gt;base_table_properties = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;baseProperties&#39;</span>];
<a name="l14457"></a>14457     $this-&gt;cell = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;cells&#39;</span>];
<a name="l14458"></a>14458     $this-&gt;row = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;currrow&#39;</span>];
<a name="l14459"></a>14459     $this-&gt;col = $this-&gt;table[$this-&gt;tableLevel][$this-&gt;tbctr[$this-&gt;tableLevel]][<span class="stringliteral">&#39;currcol&#39;</span>];
<a name="l14460"></a>14460 
<a name="l14461"></a>14461     $objattr[<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;nestedtable&#39;</span>;
<a name="l14462"></a>14462     $objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>] = $this-&gt;tbctr[($this-&gt;tableLevel+1)];
<a name="l14463"></a>14463     $objattr[<span class="stringliteral">&#39;table&#39;</span>] = $this-&gt;tbctr[$this-&gt;tableLevel];
<a name="l14464"></a>14464     $objattr[<span class="stringliteral">&#39;row&#39;</span>] = $this-&gt;row;
<a name="l14465"></a>14465     $objattr[<span class="stringliteral">&#39;col&#39;</span>] = $this-&gt;col;
<a name="l14466"></a>14466     $objattr[<span class="stringliteral">&#39;level&#39;</span>] = $this-&gt;tableLevel;
<a name="l14467"></a>14467     $e = <span class="stringliteral">&quot;\xbb\xa4\xactype=nestedtable,objattr=&quot;</span>.serialize($objattr).<span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>;
<a name="l14468"></a>14468     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;textbuffer&#39;</span>][] = array($e,$this-&gt;HREF,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l14469"></a>14469     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] += $tl ;
<a name="l14470"></a>14470     <span class="keywordflow">if</span> (!isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>])) {
<a name="l14471"></a>14471       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l14472"></a>14472     }
<a name="l14473"></a>14473     elseif($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] &lt; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l14474"></a>14474       $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;maxs&#39;</span>] = $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>]; 
<a name="l14475"></a>14475     }
<a name="l14476"></a>14476     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="charliteral">&#39;s&#39;</span>] = 0;<span class="comment">// reset</span>
<a name="l14477"></a>14477     <span class="keywordflow">if</span> ((isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmaw&#39;</span>]) &amp;&amp; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmaw&#39;</span>] &lt; $tmaw) || !isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmaw&#39;</span>])) { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmaw&#39;</span>] = $tmaw ; }
<a name="l14478"></a>14478     <span class="keywordflow">if</span> ((isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmiw&#39;</span>]) &amp;&amp; $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmiw&#39;</span>] &lt; $tmiw) || !isset($this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmiw&#39;</span>])) { $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedmiw&#39;</span>] = $tmiw ; }
<a name="l14479"></a>14479     $this-&gt;cell[$this-&gt;row][$this-&gt;col][<span class="stringliteral">&#39;nestedcontent&#39;</span>][] = $this-&gt;tbctr[($this-&gt;tableLevel+1)];
<a name="l14480"></a>14480     $this-&gt;tdbegin = <span class="keyword">true</span>;
<a name="l14481"></a>14481     $this-&gt;nestedtablejustfinished = <span class="keyword">true</span>;
<a name="l14482"></a>14482     $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>;
<a name="l14483"></a>14483     <span class="keywordflow">return</span>;
<a name="l14484"></a>14484   }
<a name="l14485"></a>14485   $this-&gt;cMarginL = 0;
<a name="l14486"></a>14486   $this-&gt;cMarginR = 0;
<a name="l14487"></a>14487   $this-&gt;cMarginT = 0;
<a name="l14488"></a>14488   $this-&gt;cMarginB = 0;
<a name="l14489"></a>14489   $this-&gt;cellPaddingL = 0;
<a name="l14490"></a>14490   $this-&gt;cellPaddingR = 0;
<a name="l14491"></a>14491   $this-&gt;cellPaddingT = 0;
<a name="l14492"></a>14492   $this-&gt;cellPaddingB = 0;
<a name="l14493"></a>14493 
<a name="l14494"></a>14494   <span class="keywordflow">if</span> (!$this-&gt;kwt_saved) { $this-&gt;kwt_height = 0; }
<a name="l14495"></a>14495 
<a name="l14496"></a>14496   list($check,$tablemiw) = $this-&gt;_tableColumnWidth($this-&gt;table[1][1],<span class="keyword">true</span>);
<a name="l14497"></a>14497   $save_table = $this-&gt;table;
<a name="l14498"></a>14498   $reset_to_minimum_width = <span class="keyword">false</span>;
<a name="l14499"></a>14499   $added_page = <span class="keyword">false</span>;
<a name="l14500"></a>14500 
<a name="l14501"></a>14501   <span class="keywordflow">if</span> ($check &gt; 1) { 
<a name="l14502"></a>14502     <span class="keywordflow">if</span> ($check &gt; $this-&gt;shrink_this_table_to_fit &amp;&amp; $this-&gt;table_rotate) { 
<a name="l14503"></a>14503         $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l14504"></a>14504         $added_page = <span class="keyword">true</span>;
<a name="l14505"></a>14505         $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14506"></a>14506         $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14507"></a>14507         <span class="comment">// mPDF 3.0</span>
<a name="l14508"></a>14508         <span class="comment">//$check = $tablemiw/$this-&gt;tbrot_maxw;   // undo any shrink</span>
<a name="l14509"></a>14509         $check = 1;   <span class="comment">// undo any shrink</span>
<a name="l14510"></a>14510     }
<a name="l14511"></a>14511     $reset_to_minimum_width = <span class="keyword">true</span>;
<a name="l14512"></a>14512   }
<a name="l14513"></a>14513 
<a name="l14514"></a>14514   <span class="keywordflow">if</span> ($reset_to_minimum_width) {
<a name="l14515"></a>14515 
<a name="l14516"></a>14516     $this-&gt;shrin_k = $check;
<a name="l14517"></a>14517 
<a name="l14518"></a>14518     $this-&gt;default_font_size /= $this-&gt;shrin_k;
<a name="l14519"></a>14519     $this-&gt;SetFontSize($this-&gt;default_font_size, <span class="keyword">false</span> );
<a name="l14520"></a>14520 
<a name="l14521"></a>14521     $this-&gt;shrinkTable($this-&gt;table[1][1],$this-&gt;shrin_k);
<a name="l14522"></a>14522 
<a name="l14523"></a>14523     $this-&gt;_tableColumnWidth($this-&gt;table[1][1],<span class="keyword">false</span>); <span class="comment">// repeat</span>
<a name="l14524"></a>14524 
<a name="l14525"></a>14525     <span class="comment">// Starting at $this-&gt;innermostTableLevel</span>
<a name="l14526"></a>14526     <span class="comment">// Shrink table values - and redo columnWidth</span>
<a name="l14527"></a>14527     <span class="keywordflow">for</span>($lvl=2;$lvl&lt;=$this-&gt;innermostTableLevel;$lvl++) {
<a name="l14528"></a>14528       <span class="keywordflow">for</span> ($nid=1; $nid&lt;=$this-&gt;tbctr[$lvl]; $nid++) {
<a name="l14529"></a>14529         $this-&gt;shrinkTable($this-&gt;table[$lvl][$nid],$this-&gt;shrin_k);
<a name="l14530"></a>14530         $this-&gt;_tableColumnWidth($this-&gt;table[$lvl][$nid],<span class="keyword">false</span>);
<a name="l14531"></a>14531       }
<a name="l14532"></a>14532     }
<a name="l14533"></a>14533   }
<a name="l14534"></a>14534 
<a name="l14535"></a>14535 
<a name="l14536"></a>14536   <span class="comment">// Set table cell widths for top level table</span>
<a name="l14537"></a>14537   <span class="comment">// Use $shrin_k to resize but don&#39;t change again</span>
<a name="l14538"></a>14538   $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;table_lineheight);
<a name="l14539"></a>14539 
<a name="l14540"></a>14540   <span class="comment">// Top level table</span>
<a name="l14541"></a>14541   $this-&gt;_tableWidth($this-&gt;table[1][1]);
<a name="l14542"></a>14542 
<a name="l14543"></a>14543   <span class="comment">// Now work through any nested tables setting child table[w&#39;] = parent cell[&#39;w&#39;]</span>
<a name="l14544"></a>14544   <span class="comment">// Now do nested tables _tableWidth</span>
<a name="l14545"></a>14545   <span class="keywordflow">for</span>($lvl=2;$lvl&lt;=$this-&gt;innermostTableLevel;$lvl++) {
<a name="l14546"></a>14546     <span class="keywordflow">for</span> ($nid=1; $nid&lt;=$this-&gt;tbctr[$lvl]; $nid++) {
<a name="l14547"></a>14547       <span class="comment">// HERE set child table width = cell width</span>
<a name="l14548"></a>14548 
<a name="l14549"></a>14549       list($parentrow, $parentcol, $parentnid) = $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;nestedpos&#39;</span>];
<a name="l14550"></a>14550       <span class="keywordflow">if</span> (isset($this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;colspan&#39;</span>]&gt; 1) {
<a name="l14551"></a>14551          $parentwidth = 0;
<a name="l14552"></a>14552          <span class="keywordflow">for</span>($cs=0;$cs&lt;$this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;colspan&#39;</span>] ; $cs++) {
<a name="l14553"></a>14553         $parentwidth += $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;wc&#39;</span>][$parentcol+$cs]; 
<a name="l14554"></a>14554          }
<a name="l14555"></a>14555       }
<a name="l14556"></a>14556       <span class="keywordflow">else</span> { $parentwidth = $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;wc&#39;</span>][$parentcol]; }
<a name="l14557"></a>14557 
<a name="l14558"></a>14558 
<a name="l14559"></a>14559       <span class="comment">//$parentwidth -= ALLOW FOR PADDING ETC.in parent cell</span>
<a name="l14560"></a>14560       <span class="comment">// mPDF 4.3.006</span>
<a name="l14561"></a>14561       <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l14562"></a>14562        <span class="comment">// mPDF 4.3.009</span>
<a name="l14563"></a>14563        <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l14564"></a>14564         list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l14565"></a>14565        }
<a name="l14566"></a>14566        <span class="keywordflow">else</span> { 
<a name="l14567"></a>14567         $br = $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l14568"></a>14568         $bl = $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l14569"></a>14569        }
<a name="l14570"></a>14570        <span class="keywordflow">if</span> ($this-&gt;table[$lvl-1][$parentnid][<span class="stringliteral">&#39;borders_separate&#39;</span>]) {
<a name="l14571"></a>14571         $parentwidth -= $br + $bl
<a name="l14572"></a>14572         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14573"></a>14573         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]
<a name="l14574"></a>14574         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l14575"></a>14575        }
<a name="l14576"></a>14576        <span class="keywordflow">else</span> {
<a name="l14577"></a>14577         $parentwidth -= $br/2 + $bl/2
<a name="l14578"></a>14578         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14579"></a>14579         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l14580"></a>14580        }
<a name="l14581"></a>14581       }
<a name="l14582"></a>14582       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l14583"></a>14583        <span class="keywordflow">if</span> ($this-&gt;table[$lvl-1][$parentnid][<span class="stringliteral">&#39;borders_separate&#39;</span>]) {
<a name="l14584"></a>14584         $parentwidth -= $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]
<a name="l14585"></a>14585         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]
<a name="l14586"></a>14586         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14587"></a>14587         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]
<a name="l14588"></a>14588         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l14589"></a>14589        }
<a name="l14590"></a>14590        <span class="keywordflow">else</span> {
<a name="l14591"></a>14591         $parentwidth -= $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2
<a name="l14592"></a>14592         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2
<a name="l14593"></a>14593         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14594"></a>14594         + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l14595"></a>14595        }
<a name="l14596"></a>14596       }
<a name="l14597"></a>14597       <span class="keywordflow">if</span> (isset($this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;wpercent&#39;</span>] &amp;&amp; $lvl&gt;1) {
<a name="l14598"></a>14598         $this-&gt;table[$lvl][$nid][<span class="charliteral">&#39;w&#39;</span>] = $parentwidth;
<a name="l14599"></a>14599       }
<a name="l14600"></a>14600       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($parentwidth &gt; $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;maw&#39;</span>]) {
<a name="l14601"></a>14601         $this-&gt;table[$lvl][$nid][<span class="charliteral">&#39;w&#39;</span>] = $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l14602"></a>14602       }
<a name="l14603"></a>14603       <span class="keywordflow">else</span> {
<a name="l14604"></a>14604         $this-&gt;table[$lvl][$nid][<span class="charliteral">&#39;w&#39;</span>] = $parentwidth;
<a name="l14605"></a>14605       }
<a name="l14606"></a>14606 
<a name="l14607"></a>14607       $this-&gt;_tableWidth($this-&gt;table[$lvl][$nid]);
<a name="l14608"></a>14608     }
<a name="l14609"></a>14609   }
<a name="l14610"></a>14610 
<a name="l14611"></a>14611   <span class="comment">// Starting at $this-&gt;innermostTableLevel</span>
<a name="l14612"></a>14612   <span class="comment">// Cascade back up nested tables: setting heights back up the tree</span>
<a name="l14613"></a>14613   <span class="keywordflow">for</span>($lvl=$this-&gt;innermostTableLevel;$lvl&gt;0;$lvl--) {
<a name="l14614"></a>14614     <span class="keywordflow">for</span> ($nid=1; $nid&lt;=$this-&gt;tbctr[$lvl]; $nid++) {
<a name="l14615"></a>14615       list($tableheight,$maxrowheight,$fullpage,$remainingpage) = $this-&gt;_tableHeight($this-&gt;table[$lvl][$nid]);
<a name="l14616"></a>14616     }
<a name="l14617"></a>14617   }
<a name="l14618"></a>14618 
<a name="l14619"></a>14619   $recalculate = 1;
<a name="l14620"></a>14620   $forcerecalc = <span class="keyword">false</span>; <span class="comment">// mPDF 4.2.005</span>
<a name="l14621"></a>14621   <span class="comment">// RESIZING ALGORITHM</span>
<a name="l14622"></a>14622   <span class="keywordflow">if</span> ($maxrowheight &gt; $fullpage) { 
<a name="l14623"></a>14623     $recalculate = $this-&gt;tbsqrt($maxrowheight / $fullpage, 1); 
<a name="l14624"></a>14624     $forcerecalc = <span class="keyword">true</span>; <span class="comment">// mPDF 4.2.005</span>
<a name="l14625"></a>14625   }
<a name="l14626"></a>14626   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) { <span class="comment">// NB $remainingpage == $fullpage == the width of the page</span>
<a name="l14627"></a>14627     <span class="keywordflow">if</span> ($tableheight &gt; $remainingpage) { 
<a name="l14628"></a>14628       <span class="comment">// If can fit on remainder of page whilst respecting autsize value..</span>
<a name="l14629"></a>14629       <span class="keywordflow">if</span> (($this-&gt;shrin_k * $this-&gt;tbsqrt($tableheight / $remainingpage, 1)) &lt;= $this-&gt;shrink_this_table_to_fit) {
<a name="l14630"></a>14630         $recalculate = $this-&gt;tbsqrt($tableheight / $remainingpage, 1); 
<a name="l14631"></a>14631       }
<a name="l14632"></a>14632       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$added_page) {
<a name="l14633"></a>14633         $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l14634"></a>14634         $added_page = <span class="keyword">true</span>;
<a name="l14635"></a>14635         $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14636"></a>14636         $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14637"></a>14637         <span class="comment">// mPDF 3.0 added 0.001 to force it to recalculate</span>
<a name="l14638"></a>14638         $recalculate = (1 / $this-&gt;shrin_k) + 0.001;  <span class="comment">// undo any shrink</span>
<a name="l14639"></a>14639       }
<a name="l14640"></a>14640     }
<a name="l14641"></a>14641   }
<a name="l14642"></a>14642   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_keep_together) {
<a name="l14643"></a>14643     <span class="keywordflow">if</span> ($tableheight &gt; $fullpage) { 
<a name="l14644"></a>14644       <span class="keywordflow">if</span> (($this-&gt;shrin_k * $this-&gt;tbsqrt($tableheight / $fullpage, 1)) &lt;= $this-&gt;shrink_this_table_to_fit) {
<a name="l14645"></a>14645         $recalculate = $this-&gt;tbsqrt($tableheight / $fullpage, 1); 
<a name="l14646"></a>14646       }
<a name="l14647"></a>14647       <span class="keywordflow">else</span> {
<a name="l14648"></a>14648         $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l14649"></a>14649         $added_page = <span class="keyword">true</span>;
<a name="l14650"></a>14650         $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14651"></a>14651         $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14652"></a>14652         $recalculate = $this-&gt;tbsqrt($tableheight / $fullpage, 1); 
<a name="l14653"></a>14653       }
<a name="l14654"></a>14654     }
<a name="l14655"></a>14655     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tableheight &gt; $remainingpage) { 
<a name="l14656"></a>14656       <span class="comment">// If can fit on remainder of page whilst respecting autsize value..</span>
<a name="l14657"></a>14657       <span class="keywordflow">if</span> (($this-&gt;shrin_k * $this-&gt;tbsqrt($tableheight / $remainingpage, 1)) &lt;= $this-&gt;shrink_this_table_to_fit) {
<a name="l14658"></a>14658         $recalculate = $this-&gt;tbsqrt($tableheight / $remainingpage, 1); 
<a name="l14659"></a>14659       }
<a name="l14660"></a>14660       <span class="keywordflow">else</span> {
<a name="l14661"></a>14661         $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l14662"></a>14662         $added_page = <span class="keyword">true</span>;
<a name="l14663"></a>14663         $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14664"></a>14664         $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14665"></a>14665         <span class="comment">// mPDF 3.0 added 0.001 to force it to recalculate</span>
<a name="l14666"></a>14666         $recalculate = (1 / $this-&gt;shrin_k) + 0.001;  <span class="comment">// undo any shrink</span>
<a name="l14667"></a>14667       }
<a name="l14668"></a>14668     }
<a name="l14669"></a>14669   }
<a name="l14670"></a>14670   <span class="keywordflow">else</span> { $recalculate = 1; }
<a name="l14671"></a>14671 
<a name="l14672"></a>14672   <span class="keywordflow">if</span> ($recalculate &gt; $this-&gt;shrink_this_table_to_fit &amp;&amp; !$forcerecalc) { $recalculate = $this-&gt;shrink_this_table_to_fit; } <span class="comment">// mPDF 4.2.005</span>
<a name="l14673"></a>14673 
<a name="l14674"></a>14674   $iteration = 2;
<a name="l14675"></a>14675 
<a name="l14676"></a>14676   <span class="comment">// RECALCULATE</span>
<a name="l14677"></a>14677   <span class="keywordflow">while</span>($recalculate &lt;&gt; 1) {
<a name="l14678"></a>14678     $this-&gt;shrin_k1 = $recalculate ;
<a name="l14679"></a>14679     $this-&gt;shrin_k *= $recalculate ;
<a name="l14680"></a>14680     $this-&gt;default_font_size /= ($this-&gt;shrin_k1) ;
<a name="l14681"></a>14681     $this-&gt;SetFontSize($this-&gt;default_font_size, <span class="keyword">false</span> );
<a name="l14682"></a>14682     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;table_lineheight);
<a name="l14683"></a>14683     $this-&gt;table = $save_table;
<a name="l14684"></a>14684     <span class="keywordflow">if</span> ($this-&gt;shrin_k &lt;&gt; 1) { $this-&gt;shrinkTable($this-&gt;table[1][1],$this-&gt;shrin_k); }
<a name="l14685"></a>14685     $this-&gt;_tableColumnWidth($this-&gt;table[1][1],<span class="keyword">false</span>); <span class="comment">// repeat</span>
<a name="l14686"></a>14686 
<a name="l14687"></a>14687     <span class="comment">// Starting at $this-&gt;innermostTableLevel</span>
<a name="l14688"></a>14688     <span class="comment">// Shrink table values - and redo columnWidth</span>
<a name="l14689"></a>14689     <span class="keywordflow">for</span>($lvl=2;$lvl&lt;=$this-&gt;innermostTableLevel;$lvl++) {
<a name="l14690"></a>14690       <span class="keywordflow">for</span> ($nid=1; $nid&lt;=$this-&gt;tbctr[$lvl]; $nid++) {
<a name="l14691"></a>14691         <span class="keywordflow">if</span> ($this-&gt;shrin_k &lt;&gt; 1) { $this-&gt;shrinkTable($this-&gt;table[$lvl][$nid],$this-&gt;shrin_k); }
<a name="l14692"></a>14692         $this-&gt;_tableColumnWidth($this-&gt;table[$lvl][$nid],<span class="keyword">false</span>);
<a name="l14693"></a>14693       }
<a name="l14694"></a>14694     }
<a name="l14695"></a>14695     <span class="comment">// Set table cell widths for top level table</span>
<a name="l14696"></a>14696 
<a name="l14697"></a>14697     <span class="comment">// Top level table</span>
<a name="l14698"></a>14698     $this-&gt;_tableWidth($this-&gt;table[1][1]);
<a name="l14699"></a>14699 
<a name="l14700"></a>14700     <span class="comment">// Now work through any nested tables setting child table[w&#39;] = parent cell[&#39;w&#39;]</span>
<a name="l14701"></a>14701     <span class="comment">// Now do nested tables _tableWidth</span>
<a name="l14702"></a>14702     <span class="keywordflow">for</span>($lvl=2;$lvl&lt;=$this-&gt;innermostTableLevel;$lvl++) {
<a name="l14703"></a>14703       <span class="keywordflow">for</span> ($nid=1; $nid&lt;=$this-&gt;tbctr[$lvl]; $nid++) {
<a name="l14704"></a>14704         <span class="comment">// HERE set child table width = cell width</span>
<a name="l14705"></a>14705 
<a name="l14706"></a>14706         list($parentrow, $parentcol, $parentnid) = $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;nestedpos&#39;</span>];
<a name="l14707"></a>14707         <span class="keywordflow">if</span> (isset($this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;colspan&#39;</span>]&gt; 1) {
<a name="l14708"></a>14708            $parentwidth = 0;
<a name="l14709"></a>14709            <span class="keywordflow">for</span>($cs=0;$cs&lt;$this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;colspan&#39;</span>] ; $cs++) {
<a name="l14710"></a>14710           $parentwidth += $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;wc&#39;</span>][$parentcol+$cs]; 
<a name="l14711"></a>14711            }
<a name="l14712"></a>14712         }
<a name="l14713"></a>14713         <span class="keywordflow">else</span> { $parentwidth = $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;wc&#39;</span>][$parentcol]; }
<a name="l14714"></a>14714 
<a name="l14715"></a>14715         <span class="comment">//$parentwidth -= ALLOW FOR PADDING ETC.in parent cell</span>
<a name="l14716"></a>14716         <span class="comment">// mPDF 4.3.006</span>
<a name="l14717"></a>14717         <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l14718"></a>14718          <span class="comment">// mPDF 4.3.009</span>
<a name="l14719"></a>14719          <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l14720"></a>14720           list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l14721"></a>14721          }
<a name="l14722"></a>14722          <span class="keywordflow">else</span> { 
<a name="l14723"></a>14723           $br = $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l14724"></a>14724           $bl = $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l14725"></a>14725          }
<a name="l14726"></a>14726          <span class="keywordflow">if</span> ($this-&gt;table[$lvl-1][$parentnid][<span class="stringliteral">&#39;borders_separate&#39;</span>]) {
<a name="l14727"></a>14727           $parentwidth -= $br + $bl
<a name="l14728"></a>14728           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14729"></a>14729           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]
<a name="l14730"></a>14730           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l14731"></a>14731          }
<a name="l14732"></a>14732          <span class="keywordflow">else</span> {
<a name="l14733"></a>14733           $parentwidth -= $br/2 + $bl/2
<a name="l14734"></a>14734           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14735"></a>14735           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l14736"></a>14736          }
<a name="l14737"></a>14737         }
<a name="l14738"></a>14738         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l14739"></a>14739          <span class="keywordflow">if</span> ($this-&gt;table[$lvl-1][$parentnid][<span class="stringliteral">&#39;borders_separate&#39;</span>]) {
<a name="l14740"></a>14740           $parentwidth -= $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]
<a name="l14741"></a>14741           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]
<a name="l14742"></a>14742           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14743"></a>14743           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]
<a name="l14744"></a>14744           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l14745"></a>14745          }
<a name="l14746"></a>14746          <span class="keywordflow">else</span> {
<a name="l14747"></a>14747           $parentwidth -= ($this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]
<a name="l14748"></a>14748           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) /2
<a name="l14749"></a>14749           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]
<a name="l14750"></a>14750           + $this-&gt;table[($lvl-1)][$parentnid][<span class="stringliteral">&#39;cells&#39;</span>][$parentrow][$parentcol][<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l14751"></a>14751          }
<a name="l14752"></a>14752         }
<a name="l14753"></a>14753   
<a name="l14754"></a>14754         <span class="keywordflow">if</span> (isset($this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;wpercent&#39;</span>] &amp;&amp; $lvl&gt;1) {
<a name="l14755"></a>14755           $this-&gt;table[$lvl][$nid][<span class="charliteral">&#39;w&#39;</span>] = $parentwidth;
<a name="l14756"></a>14756         }
<a name="l14757"></a>14757         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($parentwidth &gt; $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;maw&#39;</span>]) {
<a name="l14758"></a>14758           $this-&gt;table[$lvl][$nid][<span class="charliteral">&#39;w&#39;</span>] = $this-&gt;table[$lvl][$nid][<span class="stringliteral">&#39;maw&#39;</span>] ;
<a name="l14759"></a>14759         }
<a name="l14760"></a>14760         <span class="keywordflow">else</span> {
<a name="l14761"></a>14761           $this-&gt;table[$lvl][$nid][<span class="charliteral">&#39;w&#39;</span>] = $parentwidth;
<a name="l14762"></a>14762         }
<a name="l14763"></a>14763         $this-&gt;_tableWidth($this-&gt;table[$lvl][$nid]);
<a name="l14764"></a>14764       }
<a name="l14765"></a>14765     }
<a name="l14766"></a>14766   
<a name="l14767"></a>14767 
<a name="l14768"></a>14768     <span class="comment">// Starting at $this-&gt;innermostTableLevel</span>
<a name="l14769"></a>14769     <span class="comment">// Cascade back up nested tables: setting heights back up the tree</span>
<a name="l14770"></a>14770     <span class="keywordflow">for</span>($lvl=$this-&gt;innermostTableLevel;$lvl&gt;0;$lvl--) {
<a name="l14771"></a>14771       <span class="keywordflow">for</span> ($nid=1; $nid&lt;=$this-&gt;tbctr[$lvl]; $nid++) {
<a name="l14772"></a>14772         list($tableheight,$maxrowheight,$fullpage,$remainingpage) = $this-&gt;_tableHeight($this-&gt;table[$lvl][$nid]);
<a name="l14773"></a>14773       }
<a name="l14774"></a>14774     }
<a name="l14775"></a>14775 
<a name="l14776"></a>14776     <span class="comment">// RESIZING ALGORITHM</span>
<a name="l14777"></a>14777 
<a name="l14778"></a>14778     <span class="keywordflow">if</span> ($maxrowheight &gt; $fullpage) { $recalculate = $this-&gt;tbsqrt($maxrowheight / $fullpage, $iteration); $iteration++; }
<a name="l14779"></a>14779     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate &amp;&amp; $tableheight &gt; $remainingpage &amp;&amp; !$added_page) { 
<a name="l14780"></a>14780       <span class="comment">// If can fit on remainder of page whilst respecting autosize value..</span>
<a name="l14781"></a>14781       <span class="keywordflow">if</span> (($this-&gt;shrin_k * $this-&gt;tbsqrt($tableheight / $remainingpage, $iteration)) &lt;= $this-&gt;shrink_this_table_to_fit) {
<a name="l14782"></a>14782         $recalculate = $this-&gt;tbsqrt($tableheight / $remainingpage, $iteration); $iteration++; 
<a name="l14783"></a>14783       }
<a name="l14784"></a>14784       <span class="keywordflow">else</span> {
<a name="l14785"></a>14785         <span class="keywordflow">if</span> (!$added_page) { 
<a name="l14786"></a>14786           $this-&gt;AddPage($this-&gt;CurOrientation); 
<a name="l14787"></a>14787           $added_page = <span class="keyword">true</span>;
<a name="l14788"></a>14788           $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14789"></a>14789           $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14790"></a>14790         }
<a name="l14791"></a>14791         <span class="comment">// mPDF 3.0 added 0.001 to force it to recalculate</span>
<a name="l14792"></a>14792         $recalculate = (1 / $this-&gt;shrin_k) + 0.001;  <span class="comment">// undo any shrink</span>
<a name="l14793"></a>14793       }
<a name="l14794"></a>14794     }
<a name="l14795"></a>14795     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_keep_together) {
<a name="l14796"></a>14796       <span class="keywordflow">if</span> ($tableheight &gt; $fullpage) { 
<a name="l14797"></a>14797         <span class="keywordflow">if</span> (($this-&gt;shrin_k * $this-&gt;tbsqrt($tableheight / $fullpage, $iteration)) &lt;= $this-&gt;shrink_this_table_to_fit) {
<a name="l14798"></a>14798           $recalculate = $this-&gt;tbsqrt($tableheight / $fullpage, $iteration); $iteration++; 
<a name="l14799"></a>14799         }
<a name="l14800"></a>14800         <span class="keywordflow">else</span> {
<a name="l14801"></a>14801            <span class="keywordflow">if</span> (!$added_page) { 
<a name="l14802"></a>14802           $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l14803"></a>14803           $added_page = <span class="keyword">true</span>;
<a name="l14804"></a>14804           $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14805"></a>14805           $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14806"></a>14806            }
<a name="l14807"></a>14807            $recalculate = $this-&gt;tbsqrt($tableheight / $fullpage, $iteration); $iteration++; 
<a name="l14808"></a>14808         }
<a name="l14809"></a>14809       }
<a name="l14810"></a>14810       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tableheight &gt; $remainingpage) { 
<a name="l14811"></a>14811         <span class="comment">// If can fit on remainder of page whilst respecting autosize value..</span>
<a name="l14812"></a>14812         <span class="keywordflow">if</span> (($this-&gt;shrin_k * $this-&gt;tbsqrt($tableheight / $remainingpage, $iteration)) &lt;= $this-&gt;shrink_this_table_to_fit) {
<a name="l14813"></a>14813           $recalculate = $this-&gt;tbsqrt($tableheight / $remainingpage, $iteration);  $iteration++; 
<a name="l14814"></a>14814         }
<a name="l14815"></a>14815         <span class="keywordflow">else</span> {
<a name="l14816"></a>14816           <span class="keywordflow">if</span> (!$added_page) { 
<a name="l14817"></a>14817             $this-&gt;AddPage($this-&gt;CurOrientation); 
<a name="l14818"></a>14818             $added_page = <span class="keyword">true</span>;
<a name="l14819"></a>14819             $this-&gt;kwt_moved = <span class="keyword">true</span>; 
<a name="l14820"></a>14820             $this-&gt;tbrot_maxw = $this-&gt;h - ($this-&gt;y + $this-&gt;bMargin + 5) - $this-&gt;kwt_height;
<a name="l14821"></a>14821           }
<a name="l14822"></a>14822           <span class="comment">// mPDF 4.0 </span>
<a name="l14823"></a>14823           <span class="comment">//$recalculate = $this-&gt;tbsqrt($tableheight / $fullpage, $iteration); $iteration++; </span>
<a name="l14824"></a>14824           $recalculate = (1 / $this-&gt;shrin_k) + 0.001;  <span class="comment">// undo any shrink</span>
<a name="l14825"></a>14825         }
<a name="l14826"></a>14826       }
<a name="l14827"></a>14827       <span class="keywordflow">else</span> { $recalculate = 1; }
<a name="l14828"></a>14828     }
<a name="l14829"></a>14829     <span class="keywordflow">else</span> { $recalculate = 1; }
<a name="l14830"></a>14830   }
<a name="l14831"></a>14831 
<a name="l14832"></a>14832   <span class="comment">// keep-with-table: if page has advanced, print out buffer now, else done in fn. _Tablewrite()</span>
<a name="l14833"></a>14833   <span class="keywordflow">if</span> ($this-&gt;kwt_saved &amp;&amp; $this-&gt;kwt_moved) {
<a name="l14834"></a>14834     $this-&gt;printkwtbuffer();
<a name="l14835"></a>14835     $this-&gt;kwt_moved = <span class="keyword">false</span>;
<a name="l14836"></a>14836     $this-&gt;kwt_saved = <span class="keyword">false</span>;
<a name="l14837"></a>14837   }
<a name="l14838"></a>14838 
<a name="l14839"></a>14839   <span class="comment">// Recursively writes all tables starting at top level</span>
<a name="l14840"></a>14840   $this-&gt;_tableWrite($this-&gt;table[1][1]);
<a name="l14841"></a>14841 
<a name="l14842"></a>14842   <span class="keywordflow">if</span> ($this-&gt;table_rotate &amp;&amp; count($this-&gt;tablebuffer)) {
<a name="l14843"></a>14843     $this-&gt;PageBreakTrigger=$this-&gt;h-$this-&gt;bMargin;
<a name="l14844"></a>14844     $save_tr = $this-&gt;table_rotate;
<a name="l14845"></a>14845     $save_y = $this-&gt;y;
<a name="l14846"></a>14846     $this-&gt;table_rotate = 0;
<a name="l14847"></a>14847     $this-&gt;y = $this-&gt;tbrot_y0;
<a name="l14848"></a>14848     $h =  $this-&gt;tbrot_w;
<a name="l14849"></a>14849     $this-&gt;DivLn($h,$this-&gt;blklvl,<span class="keyword">true</span>);
<a name="l14850"></a>14850 
<a name="l14851"></a>14851     $this-&gt;table_rotate = $save_tr;
<a name="l14852"></a>14852     $this-&gt;y = $save_y;
<a name="l14853"></a>14853 
<a name="l14854"></a>14854     $this-&gt;printtablebuffer();
<a name="l14855"></a>14855   }
<a name="l14856"></a>14856 
<a name="l14857"></a>14857   $this-&gt;table_rotate = 0;  <span class="comment">// flag used for table rotation</span>
<a name="l14858"></a>14858 
<a name="l14859"></a>14859   $this-&gt;x = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l14860"></a>14860 
<a name="l14861"></a>14861   <span class="comment">// mPDF 4.2</span>
<a name="l14862"></a>14862   $this-&gt;blockjustfinished=<span class="keyword">true</span>;
<a name="l14863"></a>14863   $this-&gt;lastblockbottommargin = $this-&gt;table[1][1][<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l14864"></a>14864   <span class="comment">//Reset values</span>
<a name="l14865"></a>14865 
<a name="l14866"></a>14866   <span class="comment">// Keep-with-table</span>
<a name="l14867"></a>14867   $this-&gt;kwt = <span class="keyword">false</span>;
<a name="l14868"></a>14868   $this-&gt;kwt_y0 = 0;
<a name="l14869"></a>14869   $this-&gt;kwt_x0 = 0;
<a name="l14870"></a>14870   $this-&gt;kwt_height = 0;
<a name="l14871"></a>14871   $this-&gt;kwt_buffer = array();
<a name="l14872"></a>14872   $this-&gt;kwt_Links = array();
<a name="l14873"></a>14873   $this-&gt;kwt_Annots = array();
<a name="l14874"></a>14874   $this-&gt;kwt_moved = <span class="keyword">false</span>;
<a name="l14875"></a>14875   $this-&gt;kwt_saved = <span class="keyword">false</span>;
<a name="l14876"></a>14876   <span class="comment">// mPDF 3.0</span>
<a name="l14877"></a>14877   $this-&gt;kwt_Reference = array();
<a name="l14878"></a>14878   $this-&gt;kwt_BMoutlines = array();
<a name="l14879"></a>14879   $this-&gt;kwt_toc = array();
<a name="l14880"></a>14880 
<a name="l14881"></a>14881   $this-&gt;shrin_k = 1;
<a name="l14882"></a>14882   $this-&gt;shrink_this_table_to_fit = 0;
<a name="l14883"></a>14883 
<a name="l14884"></a>14884   unset($this-&gt;table);
<a name="l14885"></a>14885   $this-&gt;table=array(); <span class="comment">//array </span>
<a name="l14886"></a>14886   $this-&gt;tableLevel=0;
<a name="l14887"></a>14887   $this-&gt;tbctr=array();
<a name="l14888"></a>14888   $this-&gt;innermostTableLevel=0;
<a name="l14889"></a>14889   $this-&gt;tbCSSlvl = 0;
<a name="l14890"></a>14890   $this-&gt;tablecascadeCSS = array();
<a name="l14891"></a>14891 
<a name="l14892"></a>14892   unset($this-&gt;cell);
<a name="l14893"></a>14893   $this-&gt;cell=array(); <span class="comment">//array </span>
<a name="l14894"></a>14894 
<a name="l14895"></a>14895   $this-&gt;col=-1; <span class="comment">//int</span>
<a name="l14896"></a>14896   $this-&gt;row=-1; <span class="comment">//int</span>
<a name="l14897"></a>14897   $this-&gt;Reset();
<a name="l14898"></a>14898 
<a name="l14899"></a>14899   $this-&gt;cellPaddingL = 0;
<a name="l14900"></a>14900   $this-&gt;cellPaddingT = 0;
<a name="l14901"></a>14901   $this-&gt;cellPaddingR = 0;
<a name="l14902"></a>14902   $this-&gt;cellPaddingB = 0;
<a name="l14903"></a>14903   $this-&gt;cMarginL = 0;
<a name="l14904"></a>14904   $this-&gt;cMarginT = 0;
<a name="l14905"></a>14905   $this-&gt;cMarginR = 0;
<a name="l14906"></a>14906   $this-&gt;cMarginB = 0;
<a name="l14907"></a>14907   $this-&gt;default_font_size = $this-&gt;original_default_font_size;
<a name="l14908"></a>14908   $this-&gt;default_font = $this-&gt;original_default_font;
<a name="l14909"></a>14909     $this-&gt;SetFontSize($this-&gt;default_font_size, <span class="keyword">false</span>);
<a name="l14910"></a>14910   $this-&gt;SetFont($this-&gt;default_font,<span class="stringliteral">&#39;&#39;</span>,0,<span class="keyword">false</span>);
<a name="l14911"></a>14911   $this-&gt;SetLineHeight();
<a name="l14912"></a>14912   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>])) { $this-&gt;restoreInlineProperties($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>]);}
<a name="l14913"></a>14913 
<a name="l14914"></a>14914     }
<a name="l14915"></a>14915 
<a name="l14916"></a>14916 
<a name="l14917"></a>14917   <span class="comment">// *********** LISTS ********************</span>
<a name="l14918"></a>14918 
<a name="l14919"></a>14919     <span class="keywordflow">if</span>($tag==<span class="stringliteral">&#39;LI&#39;</span>) { 
<a name="l14920"></a>14920   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>; 
<a name="l14921"></a>14921   unset($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl]);
<a name="l14922"></a>14922   $this-&gt;listCSSlvl--;
<a name="l14923"></a>14923   <span class="keywordflow">if</span> (isset($this-&gt;listoccur[$this-&gt;listlvl]) &amp;&amp; isset($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$this-&gt;listlvl][$this-&gt;listoccur[$this-&gt;listlvl]])) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$this-&gt;listlvl][$this-&gt;listoccur[$this-&gt;listlvl]]); } 
<a name="l14924"></a>14924     }
<a name="l14925"></a>14925 
<a name="l14926"></a>14926 
<a name="l14927"></a>14927     <span class="keywordflow">if</span>(($tag==<span class="stringliteral">&#39;UL&#39;</span>) or ($tag==<span class="stringliteral">&#39;OL&#39;</span>)) {
<a name="l14928"></a>14928       $this-&gt;ignorefollowingspaces = <span class="keyword">true</span>; <span class="comment">//Eliminate exceeding left-side spaces</span>
<a name="l14929"></a>14929   unset($this-&gt;listcascadeCSS[$this-&gt;listCSSlvl]);
<a name="l14930"></a>14930   $this-&gt;listCSSlvl--;
<a name="l14931"></a>14931 
<a name="l14932"></a>14932   $this-&gt;lastoptionaltag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14933"></a>14933   <span class="comment">// A simple list for inside a table</span>
<a name="l14934"></a>14934   <span class="keywordflow">if</span>($this-&gt;tableLevel) {
<a name="l14935"></a>14935     $this-&gt;listlist[$this-&gt;listlvl][<span class="stringliteral">&#39;MAXNUM&#39;</span>] = $this-&gt;listnum; <span class="comment">//save previous lvl&#39;s maxnum</span>
<a name="l14936"></a>14936     unset($this-&gt;listlist[$this-&gt;listlvl]);
<a name="l14937"></a>14937     $this-&gt;listlvl--;
<a name="l14938"></a>14938     <span class="keywordflow">if</span> (isset($this-&gt;listlist[$this-&gt;listlvl][<span class="stringliteral">&#39;MAXNUM&#39;</span>])) { $this-&gt;listnum = $this-&gt;listlist[$this-&gt;listlvl][<span class="stringliteral">&#39;MAXNUM&#39;</span>]; } <span class="comment">// restore previous levels</span>
<a name="l14939"></a>14939     <span class="keywordflow">if</span> ($this-&gt;listlvl == 0) { $this-&gt;listjustfinished = <span class="keyword">true</span>; }
<a name="l14940"></a>14940     <span class="keywordflow">return</span>;
<a name="l14941"></a>14941   }
<a name="l14942"></a>14942 
<a name="l14943"></a>14943   <span class="keywordflow">if</span> ($this-&gt;listlvl &gt; 1) { <span class="comment">// returning one level</span>
<a name="l14944"></a>14944     $this-&gt;listjustfinished=<span class="keyword">true</span>;
<a name="l14945"></a>14945     <span class="keywordflow">if</span> (!empty($this-&gt;textbuffer)) { 
<a name="l14946"></a>14946       $this-&gt;listitem[] = array($this-&gt;listlvl,$this-&gt;listnum,$this-&gt;textbuffer,$this-&gt;listoccur[$this-&gt;listlvl],$this-&gt;listitemtype);
<a name="l14947"></a>14947     }
<a name="l14948"></a>14948     <span class="comment">// mPDF 3.0</span>
<a name="l14949"></a>14949     <span class="keywordflow">else</span> { 
<a name="l14950"></a>14950       $this-&gt;listnum--;
<a name="l14951"></a>14951     }
<a name="l14952"></a>14952 
<a name="l14953"></a>14953     $this-&gt;textbuffer = array();
<a name="l14954"></a>14954     $occur = $this-&gt;listoccur[$this-&gt;listlvl]; 
<a name="l14955"></a>14955     $this-&gt;listlist[$this-&gt;listlvl][$occur][<span class="stringliteral">&#39;MAXNUM&#39;</span>] = $this-&gt;listnum; <span class="comment">//save previous lvl&#39;s maxnum</span>
<a name="l14956"></a>14956     $this-&gt;listlvl--;
<a name="l14957"></a>14957     $occur = $this-&gt;listoccur[$this-&gt;listlvl];
<a name="l14958"></a>14958     $this-&gt;listnum = $this-&gt;listlist[$this-&gt;listlvl][$occur][<span class="stringliteral">&#39;MAXNUM&#39;</span>]; <span class="comment">// recover previous level&#39;s number</span>
<a name="l14959"></a>14959     $this-&gt;listtype = $this-&gt;listlist[$this-&gt;listlvl][$occur][<span class="stringliteral">&#39;TYPE&#39;</span>]; <span class="comment">// recover previous level&#39;s type</span>
<a name="l14960"></a>14960     <span class="keywordflow">if</span> ($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$this-&gt;listlvl][$occur]) { $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$this-&gt;listlvl][$occur]); }
<a name="l14961"></a>14961 
<a name="l14962"></a>14962   }
<a name="l14963"></a>14963   <span class="keywordflow">else</span> { <span class="comment">// We are closing the last OL/UL tag</span>
<a name="l14964"></a>14964     <span class="keywordflow">if</span> (!empty($this-&gt;textbuffer)) {
<a name="l14965"></a>14965       $this-&gt;listitem[] = array($this-&gt;listlvl,$this-&gt;listnum,$this-&gt;textbuffer,$this-&gt;listoccur[$this-&gt;listlvl],$this-&gt;listitemtype);
<a name="l14966"></a>14966     }
<a name="l14967"></a>14967     <span class="comment">// mPDF 3.0</span>
<a name="l14968"></a>14968     <span class="keywordflow">else</span> { 
<a name="l14969"></a>14969       $this-&gt;listnum--;
<a name="l14970"></a>14970     }
<a name="l14971"></a>14971 
<a name="l14972"></a>14972     $occur = $this-&gt;listoccur[$this-&gt;listlvl]; 
<a name="l14973"></a>14973     $this-&gt;listlist[$this-&gt;listlvl][$occur][<span class="stringliteral">&#39;MAXNUM&#39;</span>] = $this-&gt;listnum;
<a name="l14974"></a>14974     $this-&gt;textbuffer = array();
<a name="l14975"></a>14975     $this-&gt;listlvl--;
<a name="l14976"></a>14976 
<a name="l14977"></a>14977     $this-&gt;printlistbuffer();
<a name="l14978"></a>14978     unset($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>]);
<a name="l14979"></a>14979     <span class="comment">// SPACING AFTER LIST (Top level only)</span>
<a name="l14980"></a>14980     $this-&gt;Ln(0);
<a name="l14981"></a>14981     <span class="keywordflow">if</span> ($this-&gt;list_margin_bottom) {
<a name="l14982"></a>14982       $this-&gt;DivLn($this-&gt;list_margin_bottom,$this-&gt;blklvl,<span class="keyword">true</span>,1);   <span class="comment">// collapsible</span>
<a name="l14983"></a>14983     }
<a name="l14984"></a>14984     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>])) { $this-&gt;restoreInlineProperties($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;InlineProperties&#39;</span>]);}
<a name="l14985"></a>14985     $this-&gt;listjustfinished = <span class="keyword">true</span>; 
<a name="l14986"></a>14986     $this-&gt;listCSSlvl = 0;
<a name="l14987"></a>14987     $this-&gt;listcascadeCSS = array();
<a name="l14988"></a>14988     <span class="comment">// mPDF 4.2</span>
<a name="l14989"></a>14989     $this-&gt;blockjustfinished=<span class="keyword">true</span>;
<a name="l14990"></a>14990     $this-&gt;lastblockbottommargin = $this-&gt;list_margin_bottom;
<a name="l14991"></a>14991   }
<a name="l14992"></a>14992     }
<a name="l14993"></a>14993 
<a name="l14994"></a>14994 
<a name="l14995"></a>14995 }
<a name="l14996"></a>14996 
<a name="l14997"></a>14997 
<a name="l14998"></a>14998 <span class="comment">// This function determines the shrink factor when resizing tables</span>
<a name="l14999"></a>14999 <span class="comment">// val is the table_height / page_height_available</span>
<a name="l15000"></a>15000 <span class="comment">// returns a scaling factor used as $shrin_k to resize the table</span>
<a name="l15001"></a>15001 <span class="comment">// Overcompensating will be quicker but may unnecessarily shrink table too much</span>
<a name="l15002"></a>15002 <span class="comment">// Undercompensating means it will reiterate more times (taking more processing time)</span>
<a name="l15003"></a>15003 function tbsqrt($val, $iteration=3) {
<a name="l15004"></a>15004   $k = 4; <span class="comment">// Alters number of iterations until it returns $val itself - Must be &gt; 2</span>
<a name="l15005"></a>15005   <span class="comment">// Probably best guess and most accurate</span>
<a name="l15006"></a>15006   <span class="keywordflow">if</span> ($iteration==1) <span class="keywordflow">return</span> sqrt($val);
<a name="l15007"></a>15007   <span class="comment">// Faster than using sqrt (because it won&#39;t undercompensate), and gives reasonable results</span>
<a name="l15008"></a>15008   <span class="comment">//return 1+(($val-1)/2);</span>
<a name="l15009"></a>15009   <span class="keywordflow">if</span> (2-(($iteration-2)/($k-2)) == 0) { <span class="keywordflow">return</span> $val; }
<a name="l15010"></a>15010   <span class="keywordflow">return</span> 1+(($val-1)/(2-(($iteration-2)/($k-2))));
<a name="l15011"></a>15011 }
<a name="l15012"></a>15012 
<a name="l15013"></a>15013 
<a name="l15014"></a>15014 function printlistbuffer() {
<a name="l15015"></a>15015     <span class="comment">//Save x coordinate</span>
<a name="l15016"></a>15016     $x = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l15017"></a>15017     $this-&gt;cMarginL = 0;
<a name="l15018"></a>15018     $this-&gt;cMarginR = 0;
<a name="l15019"></a>15019     $currIndentLvl = -1;
<a name="l15020"></a>15020     $lastIndent = array();
<a name="l15021"></a>15021     $bak_page = $this-&gt;page;
<a name="l15022"></a>15022     $indent = 0;  <span class="comment">// mPDF 3.0</span>
<a name="l15023"></a>15023     <span class="keywordflow">foreach</span>($this-&gt;listitem as $item)
<a name="l15024"></a>15024     {
<a name="l15025"></a>15025   <span class="comment">// COLS</span>
<a name="l15026"></a>15026   $oldcolumn = $this-&gt;CurrCol;
<a name="l15027"></a>15027 
<a name="l15028"></a>15028     $this-&gt;bulletarray = array();
<a name="l15029"></a>15029         <span class="comment">//Get list&#39;s buffered data</span>
<a name="l15030"></a>15030         $this-&gt;listlvl = $lvl = $item[0];
<a name="l15031"></a>15031         $num = $item[1];
<a name="l15032"></a>15032         $this-&gt;textbuffer = $item[2];
<a name="l15033"></a>15033         $occur = $item[3];
<a name="l15034"></a>15034     <span class="keywordflow">if</span> ($item[4]) { $type = $item[4]; } <span class="comment">// listitemtype</span>
<a name="l15035"></a>15035     <span class="keywordflow">else</span> { $type = $this-&gt;listlist[$lvl][$occur][<span class="stringliteral">&#39;TYPE&#39;</span>]; }
<a name="l15036"></a>15036         $maxnum = $this-&gt;listlist[$lvl][$occur][<span class="stringliteral">&#39;MAXNUM&#39;</span>];
<a name="l15037"></a>15037     $this-&gt;restoreInlineProperties($this-&gt;InlineProperties[<span class="stringliteral">&#39;LIST&#39;</span>][$lvl][$occur]);
<a name="l15038"></a>15038     $this-&gt;SetFont($this-&gt;FontFamily,$this-&gt;FontStyle,$this-&gt;FontSizePt,<span class="keyword">true</span>,<span class="keyword">true</span>); <span class="comment">// force to write</span>
<a name="l15039"></a>15039     $clh = $this-&gt;FontSize;
<a name="l15040"></a>15040 
<a name="l15041"></a>15041     <span class="comment">// mPDF 4.2</span>
<a name="l15042"></a>15042     $this-&gt;SetLineHeight($this-&gt;FontSizePt,$this-&gt;list_lineheight[$lvl][$occur]);
<a name="l15043"></a>15043     $this-&gt;listOcc = $occur; 
<a name="l15044"></a>15044     $this-&gt;listnum = $num; 
<a name="l15045"></a>15045 
<a name="l15046"></a>15046     <span class="comment">// Set the bullet fontsize</span>
<a name="l15047"></a>15047     $bullfs = $this-&gt;InlineProperties[<span class="stringliteral">&#39;LISTITEM&#39;</span>][$lvl][$occur][$num][<span class="stringliteral">&#39;size&#39;</span>];
<a name="l15048"></a>15048 
<a name="l15049"></a>15049         $space_width = $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>) * 1.5;
<a name="l15050"></a>15050 
<a name="l15051"></a>15051         <span class="comment">//Set default width &amp; height values</span>
<a name="l15052"></a>15052         $this-&gt;divwidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l15053"></a>15053         $this-&gt;divheight = $this-&gt;lineheight;
<a name="l15054"></a>15054     $typefont = $this-&gt;FontFamily;
<a name="l15055"></a>15055         <span class="keywordflow">switch</span>($type) <span class="comment">//Format type</span>
<a name="l15056"></a>15056         {
<a name="l15057"></a>15057           <span class="keywordflow">case</span> <span class="stringliteral">&#39;none&#39;</span>:
<a name="l15058"></a>15058       $type = <span class="stringliteral">&#39;&#39;</span>;
<a name="l15059"></a>15059             $blt_width = 0;
<a name="l15060"></a>15060              <span class="keywordflow">break</span>;
<a name="l15061"></a>15061           <span class="keywordflow">case</span> <span class="charliteral">&#39;A&#39;</span>:
<a name="l15062"></a>15062               $anum = $this-&gt;dec2alpha($num,<span class="keyword">true</span>);
<a name="l15063"></a>15063               $maxnum = $this-&gt;dec2alpha($maxnum,<span class="keyword">true</span>);
<a name="l15064"></a>15064       <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $type = $this-&gt;list_number_suffix . $anum; }
<a name="l15065"></a>15065       <span class="keywordflow">else</span> { $type = $anum . $this-&gt;list_number_suffix; }
<a name="l15066"></a>15066             $blt_width = $this-&gt;GetStringWidth(str_repeat(<span class="charliteral">&#39;W&#39;</span>,strlen($maxnum)).$this-&gt;list_number_suffix);
<a name="l15067"></a>15067              <span class="keywordflow">break</span>;
<a name="l15068"></a>15068           <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:
<a name="l15069"></a>15069               $anum = $this-&gt;dec2alpha($num,<span class="keyword">false</span>);
<a name="l15070"></a>15070               $maxnum = $this-&gt;dec2alpha($maxnum,<span class="keyword">false</span>);
<a name="l15071"></a>15071       <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $type = $this-&gt;list_number_suffix . $anum; }
<a name="l15072"></a>15072       <span class="keywordflow">else</span> { $type = $anum . $this-&gt;list_number_suffix; }
<a name="l15073"></a>15073           $blt_width = $this-&gt;GetStringWidth(str_repeat(<span class="charliteral">&#39;m&#39;</span>,strlen($maxnum)).$this-&gt;list_number_suffix);
<a name="l15074"></a>15074              <span class="keywordflow">break</span>;
<a name="l15075"></a>15075           <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:
<a name="l15076"></a>15076               $anum = $this-&gt;dec2roman($num,<span class="keyword">true</span>);
<a name="l15077"></a>15077       <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $type = $this-&gt;list_number_suffix . $anum; }
<a name="l15078"></a>15078       <span class="keywordflow">else</span> { $type = $anum . $this-&gt;list_number_suffix; }
<a name="l15079"></a>15079       <span class="comment">// mPDF 4.0</span>
<a name="l15080"></a>15080       <span class="keywordflow">if</span> ($maxnum&gt;87) { $bbit = 87; }
<a name="l15081"></a>15081       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;86) { $bbit = 86; }
<a name="l15082"></a>15082       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;37) { $bbit = 38; }
<a name="l15083"></a>15083       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;36) { $bbit = 37; }
<a name="l15084"></a>15084       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;27) { $bbit = 28; }
<a name="l15085"></a>15085       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;26) { $bbit = 27; }
<a name="l15086"></a>15086       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;17) { $bbit = 18; }
<a name="l15087"></a>15087       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;16) { $bbit = 17; }
<a name="l15088"></a>15088       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;7) { $bbit = 8; }
<a name="l15089"></a>15089       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;6) { $bbit = 7; }
<a name="l15090"></a>15090       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;3) { $bbit = 4; }
<a name="l15091"></a>15091       <span class="keywordflow">else</span> { $bbit = $maxnum; }
<a name="l15092"></a>15092               $maxlnum = $this-&gt;dec2roman($bbit,<span class="keyword">true</span>);
<a name="l15093"></a>15093           $blt_width = $this-&gt;GetStringWidth($maxlnum.$this-&gt;list_number_suffix);
<a name="l15094"></a>15094               <span class="keywordflow">break</span>;
<a name="l15095"></a>15095           <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:
<a name="l15096"></a>15096               $anum = $this-&gt;dec2roman($num,<span class="keyword">false</span>);
<a name="l15097"></a>15097       <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $type = $this-&gt;list_number_suffix . $anum; }
<a name="l15098"></a>15098       <span class="keywordflow">else</span> { $type = $anum . $this-&gt;list_number_suffix; }
<a name="l15099"></a>15099       <span class="comment">// mPDF 4.0</span>
<a name="l15100"></a>15100       <span class="keywordflow">if</span> ($maxnum&gt;87) { $bbit = 87; }
<a name="l15101"></a>15101       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;86) { $bbit = 86; }
<a name="l15102"></a>15102       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;37) { $bbit = 38; }
<a name="l15103"></a>15103       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;36) { $bbit = 37; }
<a name="l15104"></a>15104       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;27) { $bbit = 28; }
<a name="l15105"></a>15105       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;26) { $bbit = 27; }
<a name="l15106"></a>15106       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;17) { $bbit = 18; }
<a name="l15107"></a>15107       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;16) { $bbit = 17; }
<a name="l15108"></a>15108       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;7) { $bbit = 8; }
<a name="l15109"></a>15109       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;6) { $bbit = 7; }
<a name="l15110"></a>15110       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($maxnum&gt;3) { $bbit = 4; }
<a name="l15111"></a>15111       <span class="keywordflow">else</span> { $bbit = $maxnum; }
<a name="l15112"></a>15112               $maxlnum = $this-&gt;dec2roman($bbit,<span class="keyword">false</span>);
<a name="l15113"></a>15113       <span class="comment">// mPDF 4.0</span>
<a name="l15114"></a>15114           $blt_width = $this-&gt;GetStringWidth($maxlnum.$this-&gt;list_number_suffix);
<a name="l15115"></a>15115               <span class="keywordflow">break</span>;
<a name="l15116"></a>15116           <span class="keywordflow">case</span> <span class="stringliteral">&#39;disc&#39;</span>:
<a name="l15117"></a>15117       <span class="comment">// mPDF 4.2.018</span>
<a name="l15118"></a>15118       <span class="keywordflow">if</span> ($this-&gt;PDFA) {
<a name="l15119"></a>15119       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>][8226])) { $type = <span class="stringliteral">&quot;\xe2\x80\xa2&quot;</span>; }  <span class="comment">// &amp;#8226; </span>
<a name="l15120"></a>15120       <span class="keywordflow">else</span> { $type = <span class="charliteral">&#39;-&#39;</span>; }
<a name="l15121"></a>15121         $blt_width = $this-&gt;GetStringWidth($type);
<a name="l15122"></a>15122       <span class="keywordflow">break</span>;
<a name="l15123"></a>15123       }
<a name="l15124"></a>15124               $type = $this-&gt;chrs[108]; <span class="comment">// bullet disc in Zapfdingbats  &#39;l&#39;</span>
<a name="l15125"></a>15125       $typefont = <span class="stringliteral">&#39;zapfdingbats&#39;</span>;
<a name="l15126"></a>15126       $blt_width = (0.791 * $this-&gt;FontSize/2.5); 
<a name="l15127"></a>15127               <span class="keywordflow">break</span>;
<a name="l15128"></a>15128           <span class="keywordflow">case</span> <span class="stringliteral">&#39;circle&#39;</span>:
<a name="l15129"></a>15129       <span class="comment">// mPDF 4.2.018</span>
<a name="l15130"></a>15130       <span class="keywordflow">if</span> ($this-&gt;PDFA) {
<a name="l15131"></a>15131       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>][9900])) { $type = <span class="stringliteral">&quot;\xe2\x9a\xac&quot;</span>; } <span class="comment">// &amp;#9900; </span>
<a name="l15132"></a>15132       <span class="keywordflow">else</span> { $type = <span class="charliteral">&#39;-&#39;</span>; }
<a name="l15133"></a>15133         $blt_width = $this-&gt;GetStringWidth($type);
<a name="l15134"></a>15134       <span class="keywordflow">break</span>;
<a name="l15135"></a>15135       }
<a name="l15136"></a>15136               $type = $this-&gt;chrs[109]; <span class="comment">// circle in Zapfdingbats   &#39;m&#39;</span>
<a name="l15137"></a>15137       $typefont = <span class="stringliteral">&#39;zapfdingbats&#39;</span>;
<a name="l15138"></a>15138       $blt_width = (0.873 * $this-&gt;FontSize/2.5); 
<a name="l15139"></a>15139               <span class="keywordflow">break</span>;
<a name="l15140"></a>15140           <span class="keywordflow">case</span> <span class="stringliteral">&#39;square&#39;</span>:
<a name="l15141"></a>15141       <span class="comment">// mPDF 4.2.018</span>
<a name="l15142"></a>15142       <span class="keywordflow">if</span> ($this-&gt;PDFA) {
<a name="l15143"></a>15143       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>][9642])) { $type = <span class="stringliteral">&quot;\xe2\x96\xaa&quot;</span>; } <span class="comment">// &amp;#9642; </span>
<a name="l15144"></a>15144       <span class="keywordflow">else</span> { $type = <span class="charliteral">&#39;-&#39;</span>; }
<a name="l15145"></a>15145         $blt_width = $this-&gt;GetStringWidth($type);
<a name="l15146"></a>15146       <span class="keywordflow">break</span>;
<a name="l15147"></a>15147       }
<a name="l15148"></a>15148               $type = $this-&gt;chrs[110]; <span class="comment">//black square in Zapfdingbats font   &#39;n&#39;</span>
<a name="l15149"></a>15149       $typefont = <span class="stringliteral">&#39;zapfdingbats&#39;</span>;
<a name="l15150"></a>15150       $blt_width = (0.761 * $this-&gt;FontSize/2.5); 
<a name="l15151"></a>15151               <span class="keywordflow">break</span>;
<a name="l15152"></a>15152           <span class="keywordflow">case</span> <span class="charliteral">&#39;1&#39;</span>:
<a name="l15153"></a>15153       <span class="keywordflow">default</span>:
<a name="l15154"></a>15154       <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $type = $this-&gt;list_number_suffix . $num; }
<a name="l15155"></a>15155       <span class="keywordflow">else</span> { $type = $num . $this-&gt;list_number_suffix; }
<a name="l15156"></a>15156           $blt_width = $this-&gt;GetStringWidth(str_repeat(<span class="charliteral">&#39;5&#39;</span>,strlen($maxnum)).$this-&gt;list_number_suffix);
<a name="l15157"></a>15157               <span class="keywordflow">break</span>;
<a name="l15158"></a>15158         }
<a name="l15159"></a>15159   <span class="keywordflow">if</span> ($currIndentLvl &lt; $lvl) {
<a name="l15160"></a>15160     <span class="keywordflow">if</span> ($lvl &gt; 1 || $this-&gt;list_indent_first_level) { 
<a name="l15161"></a>15161       $indent += $this-&gt;list_indent[$lvl][$occur]; 
<a name="l15162"></a>15162       $lastIndent[$lvl] = $this-&gt;list_indent[$lvl][$occur];
<a name="l15163"></a>15163     }
<a name="l15164"></a>15164   }
<a name="l15165"></a>15165   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($currIndentLvl &gt; $lvl) {
<a name="l15166"></a>15166     <span class="keywordflow">while</span> ($currIndentLvl &gt; $lvl) {
<a name="l15167"></a>15167     $indent -= $lastIndent[$currIndentLvl];
<a name="l15168"></a>15168     $currIndentLvl--;
<a name="l15169"></a>15169     }
<a name="l15170"></a>15170   }
<a name="l15171"></a>15171   $currIndentLvl = $lvl;
<a name="l15172"></a>15172 
<a name="l15173"></a>15173   <span class="comment">// mPDF 3.0</span>
<a name="l15174"></a>15174   <span class="keywordflow">if</span> (isset($this-&gt;list_align[$this-&gt;listlvl][$occur])) { $this-&gt;divalign = $this-&gt;list_align[$this-&gt;listlvl][$occur]; }
<a name="l15175"></a>15175   <span class="keywordflow">else</span> { $this-&gt;divalign = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l15176"></a>15176 
<a name="l15177"></a>15177     <span class="comment">// mPDF 4.0</span>
<a name="l15178"></a>15178     <span class="keywordflow">if</span> ($this-&gt;list_align_style == <span class="charliteral">&#39;L&#39;</span>) { $lalign = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l15179"></a>15179     <span class="keywordflow">else</span> { $lalign = <span class="charliteral">&#39;R&#39;</span>;  }
<a name="l15180"></a>15180         $this-&gt;divwidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;width&#39;</span>] - ($indent + $blt_width + $space_width) ;
<a name="l15181"></a>15181     $xb =  $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] - $blt_width - $space_width; 
<a name="l15182"></a>15182         <span class="comment">//Output bullet</span>
<a name="l15183"></a>15183     $this-&gt;bulletarray = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$blt_width,<span class="charliteral">&#39;h&#39;</span>=&gt;$clh,<span class="stringliteral">&#39;txt&#39;</span>=&gt;$type,<span class="charliteral">&#39;x&#39;</span>=&gt;$xb,<span class="stringliteral">&#39;align&#39;</span>=&gt;$lalign,<span class="stringliteral">&#39;font&#39;</span>=&gt;$typefont,<span class="stringliteral">&#39;level&#39;</span>=&gt;$lvl, <span class="stringliteral">&#39;occur&#39;</span>=&gt;$occur, <span class="stringliteral">&#39;num&#39;</span>=&gt;$num, <span class="stringliteral">&#39;fontsize&#39;</span>=&gt;$bullfs );
<a name="l15184"></a>15184     $this-&gt;x = $x + $indent + $blt_width + $space_width;
<a name="l15185"></a>15185 
<a name="l15186"></a>15186       <span class="comment">//Print content</span>
<a name="l15187"></a>15187     $this-&gt;printbuffer($this-&gt;textbuffer,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>,<span class="keyword">true</span>);
<a name="l15188"></a>15188       $this-&gt;textbuffer=array();
<a name="l15189"></a>15189 
<a name="l15190"></a>15190   <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l15191"></a>15191     <span class="keywordflow">if</span>  ($this-&gt;page != $bak_page) {
<a name="l15192"></a>15192     <span class="keywordflow">if</span> (($this-&gt;page-$bak_page) % 2 == 1) { <span class="comment">// mPDF 4.2.022</span>
<a name="l15193"></a>15193       $x += $this-&gt;MarginCorrection;
<a name="l15194"></a>15194     }
<a name="l15195"></a>15195     $bak_page = $this-&gt;page;
<a name="l15196"></a>15196   }
<a name="l15197"></a>15197 
<a name="l15198"></a>15198     }
<a name="l15199"></a>15199 
<a name="l15200"></a>15200     <span class="comment">//Reset all used values</span>
<a name="l15201"></a>15201     $this-&gt;listoccur = array();
<a name="l15202"></a>15202     $this-&gt;listitem = array();
<a name="l15203"></a>15203     $this-&gt;listlist = array();
<a name="l15204"></a>15204     $this-&gt;listlvl = 0;
<a name="l15205"></a>15205     $this-&gt;listnum = 0;
<a name="l15206"></a>15206     $this-&gt;listtype = <span class="stringliteral">&#39;&#39;</span>;
<a name="l15207"></a>15207     $this-&gt;textbuffer = array();
<a name="l15208"></a>15208     $this-&gt;divwidth = 0;
<a name="l15209"></a>15209     $this-&gt;divheight = 0;
<a name="l15210"></a>15210     $this-&gt;x = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>];
<a name="l15211"></a>15211 }
<a name="l15212"></a>15212 
<a name="l15213"></a>15213 
<a name="l15214"></a>15214 function printbuffer($arrayaux,$blockstate=0,$is_table=<span class="keyword">false</span>,$is_list=<span class="keyword">false</span>)
<a name="l15215"></a>15215 {
<a name="l15216"></a>15216 <span class="comment">// $blockstate = 0; // NO margins/padding</span>
<a name="l15217"></a>15217 <span class="comment">// $blockstate = 1; // Top margins/padding only</span>
<a name="l15218"></a>15218 <span class="comment">// $blockstate = 2; // Bottom margins/padding only</span>
<a name="l15219"></a>15219 <span class="comment">// $blockstate = 3; // Top &amp; bottom margins/padding</span>
<a name="l15220"></a>15220   $this-&gt;spanbgcolorarray = array();
<a name="l15221"></a>15221   $this-&gt;spanbgcolor = <span class="keyword">false</span>;
<a name="l15222"></a>15222   $paint_ht_corr = 0;
<a name="l15223"></a>15223 
<a name="l15224"></a>15224   <span class="keywordflow">if</span> (count($this-&gt;floatDivs)) {
<a name="l15225"></a>15225     list($l_exists, $r_exists, $l_max, $r_max, $l_width, $r_width) = $this-&gt;GetFloatDivInfo($this-&gt;blklvl);
<a name="l15226"></a>15226     <span class="keywordflow">if</span> (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]-$l_width-$r_width) &lt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l15227"></a>15227       <span class="comment">// Too narrow to fit - try to move down past L or R float</span>
<a name="l15228"></a>15228       <span class="keywordflow">if</span> ($l_max &lt; $r_max &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]-$r_width) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l15229"></a>15229         $this-&gt;ClearFloats(<span class="stringliteral">&#39;LEFT&#39;</span>, $this-&gt;blklvl); 
<a name="l15230"></a>15230       }
<a name="l15231"></a>15231       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($r_max &lt; $l_max &amp;&amp; ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]-$l_width) &gt; $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>)) {
<a name="l15232"></a>15232         $this-&gt;ClearFloats(<span class="stringliteral">&#39;RIGHT&#39;</span>, $this-&gt;blklvl); 
<a name="l15233"></a>15233       }
<a name="l15234"></a>15234       <span class="keywordflow">else</span> { $this-&gt;ClearFloats(<span class="stringliteral">&#39;BOTH&#39;</span>, $this-&gt;blklvl); }
<a name="l15235"></a>15235     }
<a name="l15236"></a>15236   }
<a name="l15237"></a>15237       $bak_y = $this-&gt;y;
<a name="l15238"></a>15238   $bak_x = $this-&gt;x;
<a name="l15239"></a>15239   $align = <span class="stringliteral">&#39;&#39;</span>;
<a name="l15240"></a>15240   <span class="keywordflow">if</span> (!$is_table &amp;&amp; !$is_list) {
<a name="l15241"></a>15241     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]) { $align = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]; }
<a name="l15242"></a>15242     <span class="comment">// Block-align is set by e.g. &lt;.. align=&quot;center&quot;&gt; Takes priority for this block but not inherited</span>
<a name="l15243"></a>15243     <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;block-align&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;block-align&#39;</span>]) { $align = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;block-align&#39;</span>]; }
<a name="l15244"></a>15244     $this-&gt;divwidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l15245"></a>15245   }
<a name="l15246"></a>15246   <span class="keywordflow">else</span> {
<a name="l15247"></a>15247     $align = $this-&gt;divalign;
<a name="l15248"></a>15248   }
<a name="l15249"></a>15249   $oldpage = $this-&gt;page;
<a name="l15250"></a>15250 
<a name="l15251"></a>15251   <span class="comment">// ADDED for Out of Block now done as Flowing Block</span>
<a name="l15252"></a>15252   <span class="keywordflow">if</span> ($this-&gt;divwidth == 0) { 
<a name="l15253"></a>15253     $this-&gt;divwidth = $this-&gt;pgwidth; 
<a name="l15254"></a>15254   }
<a name="l15255"></a>15255 
<a name="l15256"></a>15256   <span class="keywordflow">if</span> (!$is_table &amp;&amp; !$is_list) { $this-&gt;SetLineHeight($this-&gt;FontSizePt,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]); }
<a name="l15257"></a>15257   $this-&gt;divheight = $this-&gt;lineheight;
<a name="l15258"></a>15258   $old_height = $this-&gt;divheight;
<a name="l15259"></a>15259 
<a name="l15260"></a>15260     <span class="comment">// As a failsafe - if font has been set but not output to page</span>
<a name="l15261"></a>15261     $this-&gt;SetFont($this-&gt;default_font,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;default_font_size,<span class="keyword">true</span>,<span class="keyword">true</span>);  <span class="comment">// force output to page</span>
<a name="l15262"></a>15262 
<a name="l15263"></a>15263     $array_size = count($arrayaux);
<a name="l15264"></a>15264     $this-&gt;newFlowingBlock( $this-&gt;divwidth,$this-&gt;divheight,$align,$is_table,$is_list,$blockstate,<span class="keyword">true</span>); <span class="comment">// true = newblock</span>
<a name="l15265"></a>15265 
<a name="l15266"></a>15266   <span class="comment">// Added - Otherwise &lt;div&gt;&lt;div&gt;&lt;p&gt; did not output top margins/padding for 1st/2nd div</span>
<a name="l15267"></a>15267     <span class="keywordflow">if</span> ($array_size == 0) { $this-&gt;finishFlowingBlock(<span class="keyword">true</span>); }  <span class="comment">// true = END of flowing block</span>
<a name="l15268"></a>15268 
<a name="l15269"></a>15269     <span class="keywordflow">for</span>($i=0;$i &lt; $array_size; $i++)
<a name="l15270"></a>15270     {
<a name="l15271"></a>15271 
<a name="l15272"></a>15272   <span class="comment">// COLS</span>
<a name="l15273"></a>15273   $oldcolumn = $this-&gt;CurrCol;
<a name="l15274"></a>15274 
<a name="l15275"></a>15275       $vetor = $arrayaux[$i];
<a name="l15276"></a>15276       <span class="keywordflow">if</span> ($i == 0 and $vetor[0] != <span class="stringliteral">&quot;\n&quot;</span> and !$this-&gt;ispre) {
<a name="l15277"></a>15277     $vetor[0] = ltrim($vetor[0]);
<a name="l15278"></a>15278   }
<a name="l15279"></a>15279 
<a name="l15280"></a>15280   <span class="comment">// FIXED TO ALLOW IT TO SHOW &#39;0&#39; </span>
<a name="l15281"></a>15281       <span class="keywordflow">if</span> (empty($vetor[0]) &amp;&amp; !($vetor[0]===<span class="charliteral">&#39;0&#39;</span>) &amp;&amp; empty($vetor[7])) { <span class="comment">//Ignore empty text and not carrying an internal link</span>
<a name="l15282"></a>15282     <span class="comment">//Check if it is the last element. If so then finish printing the block</span>
<a name="l15283"></a>15283         <span class="keywordflow">if</span> ($i == ($array_size-1)) { $this-&gt;finishFlowingBlock(<span class="keyword">true</span>); } <span class="comment">// true = END of flowing block</span>
<a name="l15284"></a>15284     <span class="keywordflow">continue</span>;
<a name="l15285"></a>15285   }
<a name="l15286"></a>15286 
<a name="l15287"></a>15287 
<a name="l15288"></a>15288       <span class="comment">//Activating buffer properties</span>
<a name="l15289"></a>15289       <span class="keywordflow">if</span>(isset($vetor[11]) and $vetor[11] != <span class="stringliteral">&#39;&#39;</span>) {   <span class="comment">// Font Size</span>
<a name="l15290"></a>15290     <span class="keywordflow">if</span> ($is_table &amp;&amp; $this-&gt;shrin_k) {
<a name="l15291"></a>15291       $this-&gt;SetFontSize($vetor[11]/$this-&gt;shrin_k,<span class="keyword">false</span>); 
<a name="l15292"></a>15292     }
<a name="l15293"></a>15293     <span class="keywordflow">else</span> {
<a name="l15294"></a>15294       $this-&gt;SetFontSize($vetor[11],<span class="keyword">false</span>); 
<a name="l15295"></a>15295     }
<a name="l15296"></a>15296   }
<a name="l15297"></a>15297       <span class="keywordflow">if</span>(isset($vetor[10]) and !empty($vetor[10])) <span class="comment">//Background color</span>
<a name="l15298"></a>15298       {
<a name="l15299"></a>15299     $this-&gt;spanbgcolorarray = $vetor[10];
<a name="l15300"></a>15300     $this-&gt;spanbgcolor = <span class="keyword">true</span>;
<a name="l15301"></a>15301       }
<a name="l15302"></a>15302       <span class="keywordflow">if</span>(isset($vetor[9]) and !empty($vetor[9])) <span class="comment">// Outline parameters</span>
<a name="l15303"></a>15303       {
<a name="l15304"></a>15304           $cor = $vetor[9][<span class="stringliteral">&#39;COLOR&#39;</span>];
<a name="l15305"></a>15305           $outlinewidth = $vetor[9][<span class="stringliteral">&#39;WIDTH&#39;</span>];
<a name="l15306"></a>15306           $this-&gt;SetTextOutline($outlinewidth,$cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l15307"></a>15307           $this-&gt;outline_on = <span class="keyword">true</span>;
<a name="l15308"></a>15308       }
<a name="l15309"></a>15309       <span class="keywordflow">if</span>(isset($vetor[8]) and $vetor[8] === <span class="keyword">true</span>) <span class="comment">// strike-through the text</span>
<a name="l15310"></a>15310       {
<a name="l15311"></a>15311           $this-&gt;strike = <span class="keyword">true</span>;
<a name="l15312"></a>15312       }
<a name="l15313"></a>15313       <span class="keywordflow">if</span>(isset($vetor[7]) and $vetor[7] != <span class="stringliteral">&#39;&#39;</span>) <span class="comment">// internal link: &lt;a name=&quot;anyvalue&quot;&gt;</span>
<a name="l15314"></a>15314       {
<a name="l15315"></a>15315     <span class="keywordflow">if</span> ($this-&gt;ColActive) { $ily = $this-&gt;y0; } <span class="keywordflow">else</span> { $ily = $this-&gt;y; } <span class="comment">// use top of columns</span>
<a name="l15316"></a>15316         $this-&gt;internallink[$vetor[7]] = array(<span class="stringliteral">&quot;Y&quot;</span>=&gt;$ily,<span class="stringliteral">&quot;PAGE&quot;</span>=&gt;$this-&gt;page );
<a name="l15317"></a>15317         <span class="keywordflow">if</span> (empty($vetor[0])) { <span class="comment">//Ignore empty text</span>
<a name="l15318"></a>15318     <span class="comment">//Check if it is the last element. If so then finish printing the block</span>
<a name="l15319"></a>15319         <span class="keywordflow">if</span> ($i == ($array_size-1)) { $this-&gt;finishFlowingBlock(<span class="keyword">true</span>); } <span class="comment">// true = END of flowing block</span>
<a name="l15320"></a>15320     <span class="keywordflow">continue</span>;
<a name="l15321"></a>15321     }
<a name="l15322"></a>15322       }
<a name="l15323"></a>15323       <span class="keywordflow">if</span>(isset($vetor[6]) and $vetor[6] === <span class="keyword">true</span>) <span class="comment">// Subscript </span>
<a name="l15324"></a>15324       {
<a name="l15325"></a>15325       $this-&gt;SUB = <span class="keyword">true</span>;
<a name="l15326"></a>15326       }
<a name="l15327"></a>15327       <span class="keywordflow">if</span>(isset($vetor[5]) and $vetor[5] === <span class="keyword">true</span>) <span class="comment">// Superscript</span>
<a name="l15328"></a>15328       {
<a name="l15329"></a>15329     $this-&gt;SUP = <span class="keyword">true</span>;
<a name="l15330"></a>15330       }
<a name="l15331"></a>15331       <span class="keywordflow">if</span>(isset($vetor[4]) and $vetor[4] != <span class="stringliteral">&#39;&#39;</span>) {  <span class="comment">// Font Family</span>
<a name="l15332"></a>15332     $font = $this-&gt;SetFont($vetor[4],$this-&gt;FontStyle,0,<span class="keyword">false</span>); 
<a name="l15333"></a>15333   }
<a name="l15334"></a>15334       <span class="keywordflow">if</span> (!empty($vetor[3])) <span class="comment">//Font Color</span>
<a name="l15335"></a>15335       {
<a name="l15336"></a>15336     $cor = $vetor[3];
<a name="l15337"></a>15337     $this-&gt;SetTextColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l15338"></a>15338       }
<a name="l15339"></a>15339       <span class="keywordflow">if</span>(isset($vetor[2]) and $vetor[2] != <span class="stringliteral">&#39;&#39;</span>) <span class="comment">//Bold,Italic,Underline styles</span>
<a name="l15340"></a>15340       {
<a name="l15341"></a>15341           <span class="keywordflow">if</span> (strpos($vetor[2],<span class="stringliteral">&quot;B&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>);
<a name="l15342"></a>15342           <span class="keywordflow">if</span> (strpos($vetor[2],<span class="stringliteral">&quot;I&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>);
<a name="l15343"></a>15343           <span class="keywordflow">if</span> (strpos($vetor[2],<span class="stringliteral">&quot;U&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;U&#39;</span>,<span class="keyword">true</span>); 
<a name="l15344"></a>15344       }
<a name="l15345"></a>15345   <span class="comment">// mPDF 4.2</span>
<a name="l15346"></a>15346       <span class="keywordflow">if</span>(isset($vetor[12]) and $vetor[12] != <span class="stringliteral">&#39;&#39;</span>) { <span class="comment">//Requested Bold,Italic,Underline</span>
<a name="l15347"></a>15347     $this-&gt;ReqFontStyle = $vetor[12];
<a name="l15348"></a>15348       }
<a name="l15349"></a>15349       <span class="keywordflow">if</span>(isset($vetor[1]) and $vetor[1] != <span class="stringliteral">&#39;&#39;</span>) <span class="comment">//LINK</span>
<a name="l15350"></a>15350       {
<a name="l15351"></a>15351     <span class="comment">// mPDF 3.0</span>
<a name="l15352"></a>15352         <span class="keywordflow">if</span> (strpos($vetor[1],<span class="stringliteral">&quot;.&quot;</span>) === <span class="keyword">false</span> &amp;&amp; strpos($vetor[1],<span class="stringliteral">&quot;@&quot;</span>) !== 0) <span class="comment">//assuming every external link has a dot indicating extension (e.g: .html .txt .zip www.somewhere.com etc.) </span>
<a name="l15353"></a>15353         {
<a name="l15354"></a>15354           <span class="comment">//Repeated reference to same anchor?</span>
<a name="l15355"></a>15355           <span class="keywordflow">while</span>(array_key_exists($vetor[1],$this-&gt;internallink)) $vetor[1]=<span class="stringliteral">&quot;#&quot;</span>.$vetor[1];
<a name="l15356"></a>15356           $this-&gt;internallink[$vetor[1]] = $this-&gt;AddLink();
<a name="l15357"></a>15357           $vetor[1] = $this-&gt;internallink[$vetor[1]];
<a name="l15358"></a>15358         }
<a name="l15359"></a>15359         $this-&gt;HREF = $vetor[1];          <span class="comment">// HREF link style set here ******</span>
<a name="l15360"></a>15360       }
<a name="l15361"></a>15361 
<a name="l15362"></a>15362   <span class="comment">// SPECIAL CONTENT - IMAGES &amp; FORM OBJECTS</span>
<a name="l15363"></a>15363       <span class="comment">//Print-out special content</span>
<a name="l15364"></a>15364   <span class="comment">// mPDF 3.0</span>
<a name="l15365"></a>15365       <span class="keywordflow">if</span> (substr($vetor[0],0,3) == <span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>) { <span class="comment">//identifier has been identified!</span>
<a name="l15366"></a>15366     <span class="comment">// mPDF 4.0</span>
<a name="l15367"></a>15367     $objattr = $this-&gt;_getObjAttr($vetor[0]);
<a name="l15368"></a>15368 
<a name="l15369"></a>15369     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;nestedtable&#39;</span>) {
<a name="l15370"></a>15370     $level = $objattr[<span class="stringliteral">&#39;level&#39;</span>];
<a name="l15371"></a>15371     $table = &amp;$this-&gt;table[$level][$objattr[<span class="stringliteral">&#39;table&#39;</span>]];
<a name="l15372"></a>15372     $cell = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>][$objattr[<span class="stringliteral">&#39;row&#39;</span>]][$objattr[<span class="stringliteral">&#39;col&#39;</span>]];
<a name="l15373"></a>15373     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>]) {
<a name="l15374"></a>15374               $this-&gt;finishFlowingBlock(<span class="keyword">false</span>,<span class="stringliteral">&#39;nestedtable&#39;</span>); <span class="comment">// mPDF 4.3.003</span>
<a name="l15375"></a>15375       $save_dw = $this-&gt;divwidth ;
<a name="l15376"></a>15376       $save_buffer = $this-&gt;cellBorderBuffer;
<a name="l15377"></a>15377       $this-&gt;cellBorderBuffer = array();
<a name="l15378"></a>15378       $ncx = $this-&gt;x;
<a name="l15379"></a>15379 
<a name="l15380"></a>15380       <span class="comment">//$w = $cell[&#39;w&#39;];  // parent cell width  // mPDF 3.0 ? not needed</span>
<a name="l15381"></a>15381 
<a name="l15382"></a>15382       list($dummyx,$w) = $this-&gt;_tableGetWidth($table, $objattr[<span class="stringliteral">&#39;row&#39;</span>], $objattr[<span class="stringliteral">&#39;col&#39;</span>]);
<a name="l15383"></a>15383       $ntw = $this-&gt;table[($level+1)][$objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>]][<span class="charliteral">&#39;w&#39;</span>];  <span class="comment">// nested table width</span>
<a name="l15384"></a>15384       <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l15385"></a>15385         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l15386"></a>15386           $innerw = $w - $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] - $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] - $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l15387"></a>15387         }
<a name="l15388"></a>15388         <span class="keywordflow">else</span> {
<a name="l15389"></a>15389           $innerw = $w - $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 - $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l15390"></a>15390         }
<a name="l15391"></a>15391       }
<a name="l15392"></a>15392       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l15393"></a>15393         <span class="comment">// mPDF 4.3.006</span>
<a name="l15394"></a>15394         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l15395"></a>15395           $innerw = $w - $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] - $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] - $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l15396"></a>15396         }
<a name="l15397"></a>15397         <span class="keywordflow">else</span> {
<a name="l15398"></a>15398           $innerw = $w - $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 - $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] - $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l15399"></a>15399         }
<a name="l15400"></a>15400       }
<a name="l15401"></a>15401       <span class="keywordflow">if</span> ($cell[<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;C&#39;</span> || $this-&gt;table[($level+1)][$objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>]][<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;C&#39;</span>) { 
<a name="l15402"></a>15402         $ncx += ($innerw-$ntw)/2; 
<a name="l15403"></a>15403       }
<a name="l15404"></a>15404       elseif ($cell[<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;R&#39;</span> || $this-&gt;table[($level+1)][$objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>]][<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;R&#39;</span>) {
<a name="l15405"></a>15405         $ncx += $innerw- $ntw; 
<a name="l15406"></a>15406       } 
<a name="l15407"></a>15407       $this-&gt;x = $ncx ;
<a name="l15408"></a>15408 
<a name="l15409"></a>15409       $this-&gt;_tableWrite($this-&gt;table[($level+1)][$objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>]]);
<a name="l15410"></a>15410       $this-&gt;cellBorderBuffer = $save_buffer;
<a name="l15411"></a>15411       $this-&gt;x = $bak_x ;
<a name="l15412"></a>15412       $this-&gt;divwidth  = $save_dw;
<a name="l15413"></a>15413       $this-&gt;newFlowingBlock( $this-&gt;divwidth,$this-&gt;divheight,$align,$is_table,$is_list,$blockstate,<span class="keyword">false</span>); 
<a name="l15414"></a>15414     }
<a name="l15415"></a>15415     }
<a name="l15416"></a>15416     <span class="keywordflow">else</span> {
<a name="l15417"></a>15417     <span class="keywordflow">if</span> ($is_table) {  <span class="comment">// *TABLES*</span>
<a name="l15418"></a>15418       $maxWidth = $this-&gt;divwidth;  <span class="comment">// *TABLES*</span>
<a name="l15419"></a>15419     } <span class="comment">// *TABLES*</span>
<a name="l15420"></a>15420     <span class="keywordflow">else</span> {  <span class="comment">// *TABLES*</span>
<a name="l15421"></a>15421       $maxWidth = $this-&gt;divwidth - ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_right&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l15422"></a>15422     } <span class="comment">// *TABLES*</span>
<a name="l15423"></a>15423 
<a name="l15424"></a>15424     <span class="comment">// If float (already) exists at this level</span>
<a name="l15425"></a>15425     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $this-&gt;y &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $this-&gt;y &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>]) { $maxWidth -= $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l15426"></a>15426     <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>]) &amp;&amp; $this-&gt;y &lt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &amp;&amp; $this-&gt;y &gt;= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>]) { $maxWidth -= $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l15427"></a>15427 
<a name="l15428"></a>15428     list($skipln) = $this-&gt;inlineObject($objattr[<span class="stringliteral">&#39;type&#39;</span>], <span class="stringliteral">&#39;&#39;</span>, $this-&gt;y, $objattr,$this-&gt;lMargin, ($this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;contentWidth&#39;</span>]/$this-&gt;k), $maxWidth, $this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;height&#39;</span>], <span class="keyword">false</span>, $is_table);
<a name="l15429"></a>15429     <span class="comment">//  1 -&gt; New line needed because of width</span>
<a name="l15430"></a>15430     <span class="comment">// -1 -&gt; Will fit width on line but NEW PAGE REQUIRED because of height</span>
<a name="l15431"></a>15431     <span class="comment">// -2 -&gt; Will not fit on line therefore needs new line but thus NEW PAGE REQUIRED</span>
<a name="l15432"></a>15432     $iby = $this-&gt;y;
<a name="l15433"></a>15433     $oldpage = $this-&gt;page;
<a name="l15434"></a>15434     $oldcol = $this-&gt;CurrCol; <span class="comment">// mPDF 4.2</span>
<a name="l15435"></a>15435     <span class="keywordflow">if</span> (($skipln == 1 || $skipln == -2) &amp;&amp; !isset($objattr[<span class="stringliteral">&#39;float&#39;</span>])) {
<a name="l15436"></a>15436               $this-&gt;finishFlowingBlock(<span class="keyword">false</span>,$objattr[<span class="stringliteral">&#39;type&#39;</span>]);  <span class="comment">// mPDF 4.3.003</span>
<a name="l15437"></a>15437               $this-&gt;newFlowingBlock( $this-&gt;divwidth,$this-&gt;divheight,$align,$is_table,$is_list,$blockstate,<span class="keyword">false</span>); <span class="comment">//false=newblock</span>
<a name="l15438"></a>15438     }
<a name="l15439"></a>15439     $thispage = $this-&gt;page;
<a name="l15440"></a>15440     <span class="keywordflow">if</span> ($this-&gt;CurrCol!=$oldcol) { $changedcol = <span class="keyword">true</span>; }  <span class="comment">// mPDF 4.2</span>
<a name="l15441"></a>15441     <span class="keywordflow">else</span> { $changedcol=<span class="keyword">false</span>; }
<a name="l15442"></a>15442 
<a name="l15443"></a>15443     <span class="comment">// mPDF 4.2 Don&#39;t if column already changed (in finishFlowingblock)</span>
<a name="l15444"></a>15444     <span class="comment">// the previous lines can already have triggered page break or column change</span>
<a name="l15445"></a>15445     <span class="keywordflow">if</span> (!$changedcol &amp;&amp; $skipln &lt;0 &amp;&amp; $this-&gt;AcceptPageBreak() &amp;&amp; $thispage==$oldpage) {
<a name="l15446"></a>15446 
<a name="l15447"></a>15447       $this-&gt;AddPage($this-&gt;CurOrientation); 
<a name="l15448"></a>15448 
<a name="l15449"></a>15449         <span class="comment">// Added to correct Images already set on line before page advanced</span>
<a name="l15450"></a>15450       <span class="comment">// i.e. if second inline image on line is higher than first and forces new page</span>
<a name="l15451"></a>15451       <span class="keywordflow">if</span> (count($this-&gt;objectbuffer)) {
<a name="l15452"></a>15452         $yadj = $iby - $this-&gt;y;
<a name="l15453"></a>15453         <span class="keywordflow">foreach</span>($this-&gt;objectbuffer AS $ib=&gt;$val) {
<a name="l15454"></a>15454           <span class="keywordflow">if</span> ($this-&gt;objectbuffer[$ib][<span class="stringliteral">&#39;OUTER-Y&#39;</span>] ) $this-&gt;objectbuffer[$ib][<span class="stringliteral">&#39;OUTER-Y&#39;</span>] -= $yadj;
<a name="l15455"></a>15455           <span class="keywordflow">if</span> ($this-&gt;objectbuffer[$ib][<span class="stringliteral">&#39;BORDER-Y&#39;</span>]) $this-&gt;objectbuffer[$ib][<span class="stringliteral">&#39;BORDER-Y&#39;</span>] -= $yadj;
<a name="l15456"></a>15456           <span class="keywordflow">if</span> ($this-&gt;objectbuffer[$ib][<span class="stringliteral">&#39;INNER-Y&#39;</span>]) $this-&gt;objectbuffer[$ib][<span class="stringliteral">&#39;INNER-Y&#39;</span>] -= $yadj;
<a name="l15457"></a>15457         }
<a name="l15458"></a>15458       }
<a name="l15459"></a>15459     }
<a name="l15460"></a>15460 
<a name="l15461"></a>15461 
<a name="l15462"></a>15462       <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l15463"></a>15463         <span class="keywordflow">if</span>  ($this-&gt;page != $oldpage) {
<a name="l15464"></a>15464       <span class="keywordflow">if</span> (($this-&gt;page-$oldpage) % 2 == 1) { <span class="comment">// mPDF 4.2.022</span>
<a name="l15465"></a>15465         $bak_x += $this-&gt;MarginCorrection;
<a name="l15466"></a>15466       }
<a name="l15467"></a>15467       $oldpage = $this-&gt;page;
<a name="l15468"></a>15468         $y = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15469"></a>15469         $this-&gt;oldy = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15470"></a>15470         $old_height = 0;
<a name="l15471"></a>15471     }
<a name="l15472"></a>15472     $this-&gt;x = $bak_x;
<a name="l15473"></a>15473 
<a name="l15474"></a>15474     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;image&#39;</span> &amp;&amp; isset($objattr[<span class="stringliteral">&#39;float&#39;</span>])) { 
<a name="l15475"></a>15475       $fy = $this-&gt;y;
<a name="l15476"></a>15476 
<a name="l15477"></a>15477       <span class="comment">// DIV TOP MARGIN/BORDER/PADDING</span>
<a name="l15478"></a>15478       <span class="keywordflow">if</span> ($this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;newblock&#39;</span>] &amp;&amp; ($this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;blockstate&#39;</span>]==1 || $this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;blockstate&#39;</span>]==3) &amp;&amp; $this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;lineCount&#39;</span>]== 0) { 
<a name="l15479"></a>15479       $fy += $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l15480"></a>15480       }
<a name="l15481"></a>15481 
<a name="l15482"></a>15482       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;float&#39;</span>]==<span class="charliteral">&#39;R&#39;</span>) {
<a name="l15483"></a>15483       $fx = $this-&gt;w - $this-&gt;rMargin - $objattr[<span class="stringliteral">&#39;width&#39;</span>] - ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_right_margin&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_right&#39;</span>]);
<a name="l15484"></a>15484 
<a name="l15485"></a>15485 
<a name="l15486"></a>15486       }
<a name="l15487"></a>15487       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;float&#39;</span>]==<span class="charliteral">&#39;L&#39;</span>) {
<a name="l15488"></a>15488       $fx = $this-&gt;lMargin + ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>]);
<a name="l15489"></a>15489       }
<a name="l15490"></a>15490       $w = $objattr[<span class="stringliteral">&#39;width&#39;</span>];
<a name="l15491"></a>15491       $h = abs($objattr[<span class="stringliteral">&#39;height&#39;</span>]); 
<a name="l15492"></a>15492 
<a name="l15493"></a>15493       $widthLeft = $maxWidth - ($this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;contentWidth&#39;</span>]/$this-&gt;k);
<a name="l15494"></a>15494       $maxHeight = $this-&gt;h - ($this-&gt;tMargin + $this-&gt;margin_header + $this-&gt;bMargin + 10) ;
<a name="l15495"></a>15495       <span class="comment">// For Images</span>
<a name="l15496"></a>15496       $extraWidth = ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>]+ $objattr[<span class="stringliteral">&#39;margin_right&#39;</span>]);
<a name="l15497"></a>15497       $extraHeight = ($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>]+ $objattr[<span class="stringliteral">&#39;margin_bottom&#39;</span>]);
<a name="l15498"></a>15498 
<a name="l15499"></a>15499     <span class="comment">// mPDF 4.3.013 SVG files</span>
<a name="l15500"></a>15500       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;itype&#39;</span>] == <span class="stringliteral">&#39;wmf&#39;</span> || $objattr[<span class="stringliteral">&#39;itype&#39;</span>] == <span class="stringliteral">&#39;svg&#39;</span>) {
<a name="l15501"></a>15501         $file = $objattr[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l15502"></a>15502         $info=$this-&gt;formobjects[$file];
<a name="l15503"></a>15503       }
<a name="l15504"></a>15504       <span class="keywordflow">else</span> {
<a name="l15505"></a>15505         $file = $objattr[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l15506"></a>15506         $info=$this-&gt;images[$file];
<a name="l15507"></a>15507       }
<a name="l15508"></a>15508       <span class="comment">// Automatically resize to width remaining - ********** If &gt; maxWidth *******</span>
<a name="l15509"></a>15509 <span class="comment">//      if ($w &gt; $widthLeft) {</span>
<a name="l15510"></a>15510 <span class="comment">//        $w = $widthLeft ;</span>
<a name="l15511"></a>15511 <span class="comment">//        $h=abs($w*$info[&#39;h&#39;]/$info[&#39;w&#39;]);</span>
<a name="l15512"></a>15512 <span class="comment">//      }</span>
<a name="l15513"></a>15513       $img_w = $w - $extraWidth ;
<a name="l15514"></a>15514       $img_h = $h - $extraHeight ;
<a name="l15515"></a>15515       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l15516"></a>15516         $objattr[<span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>] = $img_w + (($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2) ;
<a name="l15517"></a>15517         $objattr[<span class="stringliteral">&#39;BORDER-HEIGHT&#39;</span>] = $img_h + (($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2) ;
<a name="l15518"></a>15518         $objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>] = $fx + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] + (($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2) ;
<a name="l15519"></a>15519         $objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>] = $fy + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] + (($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2) ;
<a name="l15520"></a>15520       }
<a name="l15521"></a>15521       $objattr[<span class="stringliteral">&#39;INNER-WIDTH&#39;</span>] = $img_w;
<a name="l15522"></a>15522       $objattr[<span class="stringliteral">&#39;INNER-HEIGHT&#39;</span>] = $img_h;
<a name="l15523"></a>15523       $objattr[<span class="stringliteral">&#39;INNER-X&#39;</span>] = $fx + $objattr[<span class="stringliteral">&#39;margin_left&#39;</span>] + ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]);
<a name="l15524"></a>15524       $objattr[<span class="stringliteral">&#39;INNER-Y&#39;</span>] = $fy + $objattr[<span class="stringliteral">&#39;margin_top&#39;</span>] + ($objattr[<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) ;
<a name="l15525"></a>15525       $objattr[<span class="stringliteral">&#39;ID&#39;</span>] = $info[<span class="charliteral">&#39;i&#39;</span>];
<a name="l15526"></a>15526       $objattr[<span class="stringliteral">&#39;OUTER-WIDTH&#39;</span>] = $w;
<a name="l15527"></a>15527       $objattr[<span class="stringliteral">&#39;OUTER-HEIGHT&#39;</span>] = $h;
<a name="l15528"></a>15528       $objattr[<span class="stringliteral">&#39;OUTER-X&#39;</span>] = $fx;
<a name="l15529"></a>15529       $objattr[<span class="stringliteral">&#39;OUTER-Y&#39;</span>] = $fy;
<a name="l15530"></a>15530       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;float&#39;</span>]==<span class="charliteral">&#39;R&#39;</span>) {
<a name="l15531"></a>15531       <span class="comment">// If R float already exists at this level</span>
<a name="l15532"></a>15532       $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;  <span class="comment">// mPDF 3.0</span>
<a name="l15533"></a>15533       <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &gt; 0 &amp;&amp; $fy &lt; $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) {
<a name="l15534"></a>15534         $this-&gt;WriteFlowingBlock($vetor[0]); 
<a name="l15535"></a>15535       }
<a name="l15536"></a>15536       <span class="comment">// If L float already exists at this level</span>
<a name="l15537"></a>15537       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &gt; 0 &amp;&amp; $fy &lt; $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) {
<a name="l15538"></a>15538         <span class="comment">// Final check distance between floats is not now too narrow to fit text</span>
<a name="l15539"></a>15539         $mw = $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>);
<a name="l15540"></a>15540         <span class="keywordflow">if</span> (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>] - $w - $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) &lt; $mw) {
<a name="l15541"></a>15541           $this-&gt;WriteFlowingBlock($vetor[0]); 
<a name="l15542"></a>15542         }
<a name="l15543"></a>15543         <span class="keywordflow">else</span> {
<a name="l15544"></a>15544             $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;x&#39;</span>] = $fx;
<a name="l15545"></a>15545             $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l15546"></a>15546             $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] = $fy;
<a name="l15547"></a>15547             $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] = $fy + $h;
<a name="l15548"></a>15548           <span class="keywordflow">if</span> ($skipln == 1) {
<a name="l15549"></a>15549             $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15550"></a>15550             $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = count($this-&gt;floatbuffer)+0;
<a name="l15551"></a>15551             $objattr[<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15552"></a>15552           }
<a name="l15553"></a>15553           $this-&gt;floatbuffer[] = $objattr;
<a name="l15554"></a>15554         }
<a name="l15555"></a>15555       }
<a name="l15556"></a>15556       <span class="keywordflow">else</span> {
<a name="l15557"></a>15557           $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;x&#39;</span>] = $fx;
<a name="l15558"></a>15558           $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l15559"></a>15559           $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] = $fy;
<a name="l15560"></a>15560           $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] = $fy + $h;
<a name="l15561"></a>15561         <span class="keywordflow">if</span> ($skipln == 1) {
<a name="l15562"></a>15562           $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15563"></a>15563           $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = count($this-&gt;floatbuffer)+0;
<a name="l15564"></a>15564           $objattr[<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15565"></a>15565         }
<a name="l15566"></a>15566         $this-&gt;floatbuffer[] = $objattr;
<a name="l15567"></a>15567       }
<a name="l15568"></a>15568       }
<a name="l15569"></a>15569       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;float&#39;</span>]==<span class="charliteral">&#39;L&#39;</span>) {
<a name="l15570"></a>15570       <span class="comment">// If L float already exists at this level</span>
<a name="l15571"></a>15571       $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;  <span class="comment">// mPDF 3.0</span>
<a name="l15572"></a>15572       <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &gt; 0 &amp;&amp; $fy &lt; $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) {
<a name="l15573"></a>15573         $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">false</span>;  <span class="comment">// mPDF 3.0</span>
<a name="l15574"></a>15574         $this-&gt;WriteFlowingBlock($vetor[0]); 
<a name="l15575"></a>15575       }
<a name="l15576"></a>15576       <span class="comment">// If R float already exists at this level</span>
<a name="l15577"></a>15577       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) &amp;&amp; $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] &gt; 0 &amp;&amp; $fy &lt; $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>]) {
<a name="l15578"></a>15578         <span class="comment">// Final check distance between floats is not now too narrow to fit text</span>
<a name="l15579"></a>15579         $mw = $this-&gt;GetStringWidth(<span class="stringliteral">&#39;WW&#39;</span>);
<a name="l15580"></a>15580         <span class="keywordflow">if</span> (($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>] - $w - $this-&gt;floatmargins[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) &lt; $mw) {
<a name="l15581"></a>15581           $this-&gt;WriteFlowingBlock($vetor[0]); 
<a name="l15582"></a>15582         }
<a name="l15583"></a>15583         <span class="keywordflow">else</span> {
<a name="l15584"></a>15584             $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;x&#39;</span>] = $fx + $w;
<a name="l15585"></a>15585             $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l15586"></a>15586             $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] = $fy;
<a name="l15587"></a>15587             $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] = $fy + $h;
<a name="l15588"></a>15588           <span class="keywordflow">if</span> ($skipln == 1) {
<a name="l15589"></a>15589             $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15590"></a>15590             $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = count($this-&gt;floatbuffer)+0;
<a name="l15591"></a>15591             $objattr[<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15592"></a>15592           }
<a name="l15593"></a>15593           $this-&gt;floatbuffer[] = $objattr;
<a name="l15594"></a>15594         }
<a name="l15595"></a>15595       }
<a name="l15596"></a>15596       <span class="keywordflow">else</span> {
<a name="l15597"></a>15597           $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;x&#39;</span>] = $fx + $w;
<a name="l15598"></a>15598           $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l15599"></a>15599           $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y0&#39;</span>] = $fy;
<a name="l15600"></a>15600           $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;y1&#39;</span>] = $fy + $h;
<a name="l15601"></a>15601         <span class="keywordflow">if</span> ($skipln == 1) {
<a name="l15602"></a>15602           $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15603"></a>15603           $this-&gt;floatmargins[<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = count($this-&gt;floatbuffer)+0;
<a name="l15604"></a>15604           $objattr[<span class="stringliteral">&#39;skipline&#39;</span>] = <span class="keyword">true</span>;
<a name="l15605"></a>15605         }
<a name="l15606"></a>15606         $this-&gt;floatbuffer[] = $objattr;
<a name="l15607"></a>15607       }
<a name="l15608"></a>15608       }
<a name="l15609"></a>15609     }
<a name="l15610"></a>15610     <span class="keywordflow">else</span> {
<a name="l15611"></a>15611       $this-&gt;WriteFlowingBlock($vetor[0]); 
<a name="l15612"></a>15612     }
<a name="l15613"></a>15613     } <span class="comment">// *TABLES*</span>
<a name="l15614"></a>15614 
<a name="l15615"></a>15615       } <span class="comment">// END If special content</span>
<a name="l15616"></a>15616 
<a name="l15617"></a>15617       <span class="keywordflow">else</span> { <span class="comment">//THE text</span>
<a name="l15618"></a>15618     <span class="keywordflow">if</span> ($this-&gt;tableLevel) { $paint_ht_corr = 0; }  <span class="comment">// To move the y up when new column/page started if div border needed</span>
<a name="l15619"></a>15619     <span class="keywordflow">else</span> { $paint_ht_corr = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l15620"></a>15620 
<a name="l15621"></a>15621         <span class="keywordflow">if</span> ($vetor[0] == <span class="stringliteral">&quot;\n&quot;</span>) { <span class="comment">//We are reading a &lt;BR&gt; now turned into newline (&quot;\n&quot;)</span>
<a name="l15622"></a>15622     <span class="keywordflow">if</span> ($this-&gt;flowingBlockAttr[<span class="stringliteral">&#39;content&#39;</span>]) {
<a name="l15623"></a>15623       $this-&gt;finishFlowingBlock(<span class="keyword">false</span>,<span class="stringliteral">&#39;br&#39;</span>);  <span class="comment">// mPDF 4.3.003</span>
<a name="l15624"></a>15624     }
<a name="l15625"></a>15625     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($is_table) {
<a name="l15626"></a>15626       $this-&gt;y+= $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l15627"></a>15627     }
<a name="l15628"></a>15628     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$is_table) {
<a name="l15629"></a>15629       $this-&gt;DivLn($this-&gt;lineheight); 
<a name="l15630"></a>15630     }
<a name="l15631"></a>15631       <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l15632"></a>15632         <span class="keywordflow">if</span>  ($this-&gt;page != $oldpage) {
<a name="l15633"></a>15633       <span class="keywordflow">if</span> (($this-&gt;page-$oldpage) % 2 == 1) { <span class="comment">// mPDF 4.2.022</span>
<a name="l15634"></a>15634         $bak_x += $this-&gt;MarginCorrection;
<a name="l15635"></a>15635       }
<a name="l15636"></a>15636       $oldpage = $this-&gt;page;
<a name="l15637"></a>15637         $y = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15638"></a>15638         $this-&gt;oldy = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15639"></a>15639         $old_height = 0;
<a name="l15640"></a>15640     }
<a name="l15641"></a>15641     $this-&gt;x = $bak_x;
<a name="l15642"></a>15642     $this-&gt;newFlowingBlock( $this-&gt;divwidth,$this-&gt;divheight,$align,$is_table,$is_list,$blockstate,<span class="keyword">false</span>);  <span class="comment">// false = newblock</span>
<a name="l15643"></a>15643          }
<a name="l15644"></a>15644           <span class="keywordflow">else</span> {
<a name="l15645"></a>15645     $this-&gt;WriteFlowingBlock( $vetor[0]);
<a name="l15646"></a>15646 
<a name="l15647"></a>15647       <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l15648"></a>15648         <span class="keywordflow">if</span>  ($this-&gt;page != $oldpage) {
<a name="l15649"></a>15649       <span class="keywordflow">if</span> (($this-&gt;page-$oldpage) % 2 == 1) { <span class="comment">// mPDF 4.2.022</span>
<a name="l15650"></a>15650         $bak_x += $this-&gt;MarginCorrection;
<a name="l15651"></a>15651         $this-&gt;x = $bak_x;
<a name="l15652"></a>15652       }
<a name="l15653"></a>15653       $oldpage = $this-&gt;page;
<a name="l15654"></a>15654         $y = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15655"></a>15655         $this-&gt;oldy = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15656"></a>15656         $old_height = 0;
<a name="l15657"></a>15657       }
<a name="l15658"></a>15658       }
<a name="l15659"></a>15659 
<a name="l15660"></a>15660 
<a name="l15661"></a>15661       }
<a name="l15662"></a>15662 
<a name="l15663"></a>15663       <span class="comment">//Check if it is the last element. If so then finish printing the block</span>
<a name="l15664"></a>15664       <span class="keywordflow">if</span> ($i == ($array_size-1)) {
<a name="l15665"></a>15665     $this-&gt;finishFlowingBlock(<span class="keyword">true</span>);  <span class="comment">// true = END of flowing block</span>
<a name="l15666"></a>15666       <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l15667"></a>15667         <span class="keywordflow">if</span>  ($this-&gt;page != $oldpage) {
<a name="l15668"></a>15668       <span class="keywordflow">if</span> (($this-&gt;page-$oldpage) % 2 == 1) { <span class="comment">// mPDF 4.2.022</span>
<a name="l15669"></a>15669         $bak_x += $this-&gt;MarginCorrection;
<a name="l15670"></a>15670         $this-&gt;x = $bak_x;
<a name="l15671"></a>15671       }
<a name="l15672"></a>15672       $oldpage = $this-&gt;page;
<a name="l15673"></a>15673         $y = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15674"></a>15674         $this-&gt;oldy = $this-&gt;tMargin - $paint_ht_corr ;
<a name="l15675"></a>15675         $old_height = 0;
<a name="l15676"></a>15676       }
<a name="l15677"></a>15677 
<a name="l15678"></a>15678 
<a name="l15679"></a>15679   }
<a name="l15680"></a>15680 
<a name="l15681"></a>15681 
<a name="l15682"></a>15682   <span class="comment">// RESETTING VALUES</span>
<a name="l15683"></a>15683   $this-&gt;SetTextColor(0);
<a name="l15684"></a>15684   $this-&gt;SetDrawColor(0);
<a name="l15685"></a>15685   $this-&gt;SetFillColor(255);
<a name="l15686"></a>15686   $this-&gt;colorarray = array();
<a name="l15687"></a>15687   $this-&gt;spanbgcolorarray = array();
<a name="l15688"></a>15688   $this-&gt;spanbgcolor = <span class="keyword">false</span>;
<a name="l15689"></a>15689   $this-&gt;issetcolor = <span class="keyword">false</span>;
<a name="l15690"></a>15690   $this-&gt;HREF = <span class="stringliteral">&#39;&#39;</span>;
<a name="l15691"></a>15691   $this-&gt;outlineparam = array();
<a name="l15692"></a>15692   $this-&gt;SetTextOutline(<span class="keyword">false</span>);
<a name="l15693"></a>15693       $this-&gt;outline_on = <span class="keyword">false</span>;
<a name="l15694"></a>15694   $this-&gt;SUP = <span class="keyword">false</span>;
<a name="l15695"></a>15695   $this-&gt;SUB = <span class="keyword">false</span>;
<a name="l15696"></a>15696 
<a name="l15697"></a>15697   $this-&gt;strike = <span class="keyword">false</span>;
<a name="l15698"></a>15698 
<a name="l15699"></a>15699   $this-&gt;currentfontfamily = <span class="stringliteral">&#39;&#39;</span>;  
<a name="l15700"></a>15700   $this-&gt;currentfontsize = <span class="stringliteral">&#39;&#39;</span>;  
<a name="l15701"></a>15701   $this-&gt;currentfontstyle = <span class="stringliteral">&#39;&#39;</span>;  
<a name="l15702"></a>15702   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l15703"></a>15703     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;table_lineheight); <span class="comment">// *TABLES*</span>
<a name="l15704"></a>15704   }
<a name="l15705"></a>15705   <span class="keywordflow">else</span>
<a name="l15706"></a>15706   <span class="keywordflow">if</span> ($is_list &amp;&amp; $this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;bulletarray[<span class="stringliteral">&#39;occur&#39;</span>]]) {
<a name="l15707"></a>15707     <span class="comment">//$this-&gt;SetLineHeight(&#39;&#39;,$this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;bulletarray[&#39;occur&#39;]]); // sets default line height</span>
<a name="l15708"></a>15708     <span class="comment">// mPDF 4.2</span>
<a name="l15709"></a>15709     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;listOcc]);  <span class="comment">// sets default line height</span>
<a name="l15710"></a>15710   }
<a name="l15711"></a>15711   <span class="keywordflow">else</span>
<a name="l15712"></a>15712   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) {
<a name="l15713"></a>15713     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]);  <span class="comment">// sets default line height</span>
<a name="l15714"></a>15714   }
<a name="l15715"></a>15715   $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l15716"></a>15716   $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l15717"></a>15717   $this-&gt;SetStyle(<span class="charliteral">&#39;U&#39;</span>,<span class="keyword">false</span>);
<a name="l15718"></a>15718   $this-&gt;toupper = <span class="keyword">false</span>;
<a name="l15719"></a>15719   $this-&gt;tolower = <span class="keyword">false</span>;
<a name="l15720"></a>15720   $this-&gt;SetDash(); <span class="comment">//restore to no dash</span>
<a name="l15721"></a>15721   $this-&gt;dash_on = <span class="keyword">false</span>;
<a name="l15722"></a>15722   $this-&gt;dotted_on = <span class="keyword">false</span>;
<a name="l15723"></a>15723 
<a name="l15724"></a>15724     }<span class="comment">//end of for(i=0;i&lt;arraysize;i++)</span>
<a name="l15725"></a>15725 
<a name="l15726"></a>15726 
<a name="l15727"></a>15727     <span class="comment">// PAINT DIV BORDER // DISABLED IN COLUMNS AS DOESN&#39;T WORK WHEN BROKEN ACROSS COLS??</span>
<a name="l15728"></a>15728     <span class="comment">// mPDF 3.0 Border OR background</span>
<a name="l15729"></a>15729     <span class="keywordflow">if</span> ((isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border&#39;</span>]) || isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolor&#39;</span>])) &amp;&amp; $blockstate  &amp;&amp; ($this-&gt;y != $this-&gt;oldy)) {
<a name="l15730"></a>15730   $bottom_y = $this-&gt;y; <span class="comment">// Does not include Bottom Margin</span>
<a name="l15731"></a>15731   <span class="comment">// mPDF 4.2 Added blockstate</span>
<a name="l15732"></a>15732   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] != $this-&gt;page &amp;&amp; $blockstate != 1) {
<a name="l15733"></a>15733     $this-&gt;PaintDivBB(<span class="stringliteral">&#39;pagetop&#39;</span>,$blockstate);
<a name="l15734"></a>15734   }
<a name="l15735"></a>15735   <span class="comment">// mPDF 3.0</span>
<a name="l15736"></a>15736   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($blockstate != 1) {
<a name="l15737"></a>15737     $this-&gt;PaintDivBB(<span class="stringliteral">&#39;&#39;</span>,$blockstate);
<a name="l15738"></a>15738   }
<a name="l15739"></a>15739   $this-&gt;y = $bottom_y; 
<a name="l15740"></a>15740   $this-&gt;x = $bak_x;
<a name="l15741"></a>15741     }
<a name="l15742"></a>15742 
<a name="l15743"></a>15743     <span class="comment">// Reset Font</span>
<a name="l15744"></a>15744     $this-&gt;SetFontSize($this-&gt;default_font_size,<span class="keyword">false</span>); 
<a name="l15745"></a>15745 
<a name="l15746"></a>15746 
<a name="l15747"></a>15747 }
<a name="l15748"></a>15748 
<a name="l15749"></a>15749 <span class="comment">// mPDF 4.0</span>
<a name="l15750"></a>15750 function _setDashBorder($style, $div, $cp, $side) {
<a name="l15751"></a>15751   <span class="keywordflow">if</span> ($style == <span class="stringliteral">&#39;dashed&#39;</span> &amp;&amp; (($side==<span class="charliteral">&#39;L&#39;</span> || $side==<span class="charliteral">&#39;R&#39;</span>) || ($side==<span class="charliteral">&#39;T&#39;</span> &amp;&amp; $div != <span class="stringliteral">&#39;pagetop&#39;</span> &amp;&amp; !$cp) || ($side==<span class="charliteral">&#39;B&#39;</span> &amp;&amp; $div!=<span class="stringliteral">&#39;pagebottom&#39;</span>) )) {
<a name="l15752"></a>15752     $dashsize = 2;  <span class="comment">// final dash will be this + 1*linewidth</span>
<a name="l15753"></a>15753     $dashsizek = 1.5; <span class="comment">// ratio of Dash/Blank</span>
<a name="l15754"></a>15754     $this-&gt;SetDash($dashsize,($dashsize/$dashsizek)+($this-&gt;LineWidth*2));
<a name="l15755"></a>15755   }
<a name="l15756"></a>15756   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($style == <span class="stringliteral">&#39;dotted&#39;</span> || ($side==<span class="charliteral">&#39;T&#39;</span> &amp;&amp; ($div == <span class="stringliteral">&#39;pagetop&#39;</span> || $cp)) || ($side==<span class="charliteral">&#39;B&#39;</span> &amp;&amp; $div == <span class="stringliteral">&#39;pagebottom&#39;</span>)) {
<a name="l15757"></a>15757       <span class="comment">//Round join and cap</span>
<a name="l15758"></a>15758       $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;1 J&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;1 j&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l15759"></a>15759     $this-&gt;SetDash(0.001,($this-&gt;LineWidth*3));
<a name="l15760"></a>15760   }
<a name="l15761"></a>15761 }
<a name="l15762"></a>15762 
<a name="l15763"></a>15763 <span class="comment">// mPDF 4.0</span>
<a name="l15764"></a>15764 function _setBorderLine($b, $k=1) {
<a name="l15765"></a>15765   $this-&gt;SetLineWidth($b[<span class="charliteral">&#39;w&#39;</span>]/$k);
<a name="l15766"></a>15766   $this-&gt;SetDrawColor($b[<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],$b[<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],$b[<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l15767"></a>15767 }
<a name="l15768"></a>15768 
<a name="l15769"></a>15769 <span class="comment">// mPDF 3.0 Borders &amp; Background</span>
<a name="l15770"></a>15770 function PaintDivBB($divider=<span class="stringliteral">&#39;&#39;</span>,$blockstate=0,$blvl=0) {
<a name="l15771"></a>15771   <span class="comment">// Borders &amp; backgrounds are done elsewhere for columns - messes up the repositioning in printcolumnbuffer</span>
<a name="l15772"></a>15772   $save_y = $this-&gt;y;
<a name="l15773"></a>15773   <span class="keywordflow">if</span> (!$blvl) { $blvl = $this-&gt;blklvl; }
<a name="l15774"></a>15774 
<a name="l15775"></a>15775   $x0 = $x1 = $y0 = $y1 = 0; 
<a name="l15776"></a>15776 
<a name="l15777"></a>15777   <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l15778"></a>15778   <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;bb_painted&#39;</span>][$this-&gt;page]) &amp;&amp; $this-&gt;blk[$blvl][<span class="stringliteral">&#39;bb_painted&#39;</span>][$this-&gt;page]) { <span class="keywordflow">return</span>; }  <span class="comment">// *CSS-FLOAT*</span>
<a name="l15779"></a>15779 
<a name="l15780"></a>15780   <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;x0&#39;</span>])) { $x0 = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;x0&#39;</span>]; }  <span class="comment">// left</span>
<a name="l15781"></a>15781   <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;y1&#39;</span>])) { $y1 = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;y1&#39;</span>]; }  <span class="comment">// bottom</span>
<a name="l15782"></a>15782 
<a name="l15783"></a>15783   <span class="comment">// Added mPDF 3.0 Float DIV - ensures backgrounds/borders are drawn to bottom of page</span>
<a name="l15784"></a>15784   <span class="keywordflow">if</span> ($y1==0) { 
<a name="l15785"></a>15785     <span class="keywordflow">if</span> ($divider==<span class="stringliteral">&#39;pagebottom&#39;</span>) { $y1 = $this-&gt;h-$this-&gt;bMargin; }
<a name="l15786"></a>15786     <span class="keywordflow">else</span> { $y1 = $this-&gt;y; }
<a name="l15787"></a>15787   }
<a name="l15788"></a>15788 
<a name="l15789"></a>15789   <span class="comment">// mPDF 3.0</span>
<a name="l15790"></a>15790   <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;startpage&#39;</span>]) &amp;&amp; $this-&gt;blk[$blvl][<span class="stringliteral">&#39;startpage&#39;</span>] != $this-&gt;page) { $continuingpage = <span class="keyword">true</span>; } <span class="keywordflow">else</span> { $continuingpage = <span class="keyword">false</span>; } 
<a name="l15791"></a>15791 
<a name="l15792"></a>15792   <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;y0&#39;</span>])) { $y0 = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;y0&#39;</span>]; }
<a name="l15793"></a>15793   $h = $y1 - $y0;
<a name="l15794"></a>15794   $w = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l15795"></a>15795   $x1 = $x0 + $w;
<a name="l15796"></a>15796 
<a name="l15797"></a>15797   <span class="comment">// Set border-widths as used here</span>
<a name="l15798"></a>15798   $border_top = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l15799"></a>15799   $border_bottom = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l15800"></a>15800   $border_left = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l15801"></a>15801   $border_right = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l15802"></a>15802   <span class="keywordflow">if</span> (!$this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>] || $divider == <span class="stringliteral">&#39;pagetop&#39;</span> || $continuingpage) {
<a name="l15803"></a>15803     $border_top = 0;
<a name="l15804"></a>15804   }
<a name="l15805"></a>15805   <span class="keywordflow">if</span> (!$this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>] || $blockstate == 1 || $divider == <span class="stringliteral">&#39;pagebottom&#39;</span>) { 
<a name="l15806"></a>15806     $border_bottom = 0;
<a name="l15807"></a>15807   }
<a name="l15808"></a>15808 
<a name="l15809"></a>15809     $brTL_H = 0;
<a name="l15810"></a>15810     $brTL_V = 0;
<a name="l15811"></a>15811     $brTR_H = 0;
<a name="l15812"></a>15812     $brTR_V = 0;
<a name="l15813"></a>15813     $brBL_H = 0;
<a name="l15814"></a>15814     $brBL_V = 0;
<a name="l15815"></a>15815     $brBR_H = 0;
<a name="l15816"></a>15816     $brBR_V = 0;
<a name="l15817"></a>15817   <span class="comment">// mPDF 4.2</span>
<a name="l15818"></a>15818   $brset = <span class="keyword">false</span>; 
<a name="l15819"></a>15819 
<a name="l15820"></a>15820     <span class="comment">// BORDERS</span>
<a name="l15821"></a>15821     <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;y0&#39;</span>]) &amp;&amp; $this-&gt;blk[$blvl][<span class="stringliteral">&#39;y0&#39;</span>]) { $y0 = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;y0&#39;</span>]; }
<a name="l15822"></a>15822     $h = $y1 - $y0;
<a name="l15823"></a>15823     $w = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l15824"></a>15824 
<a name="l15825"></a>15825     <span class="comment">//if ($this-&gt;blk[$blvl][&#39;border_top&#39;]) {</span>
<a name="l15826"></a>15826     <span class="comment">// Reinstate line above for dotted line divider when block border crosses a page</span>
<a name="l15827"></a>15827     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>] &amp;&amp; $divider != <span class="stringliteral">&#39;pagetop&#39;</span> &amp;&amp; !$continuingpage) {
<a name="l15828"></a>15828       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>];
<a name="l15829"></a>15829       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15830"></a>15830         <span class="comment">// mPDF 4.0</span>
<a name="l15831"></a>15831         $this-&gt;_setBorderLine($tbd);
<a name="l15832"></a>15832         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],$divider,$continuingpage,<span class="charliteral">&#39;T&#39;</span>); }
<a name="l15833"></a>15833           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m &#39;</span>,($x0 + $w - ($border_top/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_top/2)))*$this-&gt;k));
<a name="l15834"></a>15834           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>,($x0 + ($border_top/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_top/2)))*$this-&gt;k));
<a name="l15835"></a>15835         $this-&gt;_out(<span class="charliteral">&#39;S&#39;</span>);
<a name="l15836"></a>15836 
<a name="l15837"></a>15837         <span class="comment">// Reset Corners and Dash off</span>
<a name="l15838"></a>15838           $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 J&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 j&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l15839"></a>15839         $this-&gt;SetDash(); 
<a name="l15840"></a>15840       }
<a name="l15841"></a>15841     }
<a name="l15842"></a>15842     <span class="comment">//if ($this-&gt;blk[$blvl][&#39;border_bottom&#39;] &amp;&amp; $blockstate != 1) { </span>
<a name="l15843"></a>15843     <span class="comment">// Reinstate line above for dotted line divider when block border crosses a page</span>
<a name="l15844"></a>15844     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>] &amp;&amp; $blockstate != 1 &amp;&amp; $divider != <span class="stringliteral">&#39;pagebottom&#39;</span>) { 
<a name="l15845"></a>15845       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>];
<a name="l15846"></a>15846       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15847"></a>15847         <span class="comment">// mPDF 4.0</span>
<a name="l15848"></a>15848         $this-&gt;_setBorderLine($tbd);
<a name="l15849"></a>15849         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],$divider,$continuingpage,<span class="charliteral">&#39;B&#39;</span>); }
<a name="l15850"></a>15850           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m &#39;</span>,($x0 + ($border_bottom/2))*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_bottom/2)))*$this-&gt;k));
<a name="l15851"></a>15851           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>,($x0 + $w - ($border_bottom/2) )*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_bottom/2)))*$this-&gt;k));
<a name="l15852"></a>15852         $this-&gt;_out(<span class="charliteral">&#39;S&#39;</span>);
<a name="l15853"></a>15853 
<a name="l15854"></a>15854         <span class="comment">// Reset Corners and Dash off</span>
<a name="l15855"></a>15855           $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 J&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 j&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l15856"></a>15856         $this-&gt;SetDash(); 
<a name="l15857"></a>15857       }
<a name="l15858"></a>15858     }
<a name="l15859"></a>15859     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>]) { 
<a name="l15860"></a>15860       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>];
<a name="l15861"></a>15861       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15862"></a>15862         <span class="comment">// mPDF 4.0</span>
<a name="l15863"></a>15863         $this-&gt;_setBorderLine($tbd);
<a name="l15864"></a>15864         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],$divider,$continuingpage,<span class="charliteral">&#39;L&#39;</span>); }
<a name="l15865"></a>15865           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m &#39;</span>,($x0 + ($border_left/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_left/2)))*$this-&gt;k));
<a name="l15866"></a>15866           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>,($x0 + ($border_left/2))*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_left/2)) )*$this-&gt;k));
<a name="l15867"></a>15867         $this-&gt;_out(<span class="charliteral">&#39;S&#39;</span>);
<a name="l15868"></a>15868 
<a name="l15869"></a>15869         <span class="comment">// Reset Corners and Dash off</span>
<a name="l15870"></a>15870           $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 J&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 j&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l15871"></a>15871         $this-&gt;SetDash(); 
<a name="l15872"></a>15872       }
<a name="l15873"></a>15873     }
<a name="l15874"></a>15874     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>]) { 
<a name="l15875"></a>15875       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>];
<a name="l15876"></a>15876       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15877"></a>15877         <span class="comment">// mPDF 4.0</span>
<a name="l15878"></a>15878         $this-&gt;_setBorderLine($tbd);
<a name="l15879"></a>15879         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],$divider,$continuingpage,<span class="charliteral">&#39;R&#39;</span>); }
<a name="l15880"></a>15880           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m &#39;</span>,($x0 + $w - ($border_right/2))*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_right/2)))*$this-&gt;k));
<a name="l15881"></a>15881           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>,($x0 + $w - ($border_right/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_right/2)) )*$this-&gt;k));
<a name="l15882"></a>15882         $this-&gt;_out(<span class="charliteral">&#39;S&#39;</span>);
<a name="l15883"></a>15883 
<a name="l15884"></a>15884         <span class="comment">// Reset Corners and Dash off</span>
<a name="l15885"></a>15885           $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 J&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;2 j&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l15886"></a>15886         $this-&gt;SetDash(); 
<a name="l15887"></a>15887       }
<a name="l15888"></a>15888     }
<a name="l15889"></a>15889 
<a name="l15890"></a>15890     <span class="comment">// mPDF 4.2 DOUBLE Border</span>
<a name="l15891"></a>15891     <span class="keywordflow">if</span> (!$brset) {  <span class="comment">// not if border-radius used</span>
<a name="l15892"></a>15892       $tbcol = array(255,255,255);
<a name="l15893"></a>15893       <span class="keywordflow">for</span>($l=0; $l &lt;= $blvl; $l++) {
<a name="l15894"></a>15894         <span class="keywordflow">if</span> ($this-&gt;blk[$l][<span class="stringliteral">&#39;bgcolor&#39;</span>]) {
<a name="l15895"></a>15895           $tbcol = array($this-&gt;blk[$l][<span class="stringliteral">&#39;bgcolorarray&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],$this-&gt;blk[$l][<span class="stringliteral">&#39;bgcolorarray&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],$this-&gt;blk[$l][<span class="stringliteral">&#39;bgcolorarray&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l15896"></a>15896         }
<a name="l15897"></a>15897       }
<a name="l15898"></a>15898     }
<a name="l15899"></a>15899     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>] &amp;&amp; $divider != <span class="stringliteral">&#39;pagetop&#39;</span> &amp;&amp; !$continuingpage) {
<a name="l15900"></a>15900       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>];
<a name="l15901"></a>15901       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15902"></a>15902         <span class="keywordflow">if</span> (!$brset &amp;&amp; $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;double&#39;</span>) {
<a name="l15903"></a>15903           $this-&gt;SetLineWidth($tbd[<span class="charliteral">&#39;w&#39;</span>]/3);
<a name="l15904"></a>15904           $this-&gt;SetDrawColor($tbcol[0],$tbcol[1],$tbcol[2]);
<a name="l15905"></a>15905           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S&#39;</span>, ($x0 + $w - ($border_top/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_top/2)))*$this-&gt;k, ($x0 + ($border_top/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_top/2)))*$this-&gt;k ));
<a name="l15906"></a>15906         }
<a name="l15907"></a>15907       }
<a name="l15908"></a>15908     }
<a name="l15909"></a>15909     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>] &amp;&amp; $blockstate != 1 &amp;&amp; $divider != <span class="stringliteral">&#39;pagebottom&#39;</span>) { 
<a name="l15910"></a>15910       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>];
<a name="l15911"></a>15911       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15912"></a>15912         <span class="keywordflow">if</span> (!$brset &amp;&amp; $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;double&#39;</span>) {
<a name="l15913"></a>15913           $this-&gt;SetLineWidth($tbd[<span class="charliteral">&#39;w&#39;</span>]/3);
<a name="l15914"></a>15914           $this-&gt;SetDrawColor($tbcol[0],$tbcol[1],$tbcol[2]);
<a name="l15915"></a>15915           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S&#39;</span>, ($x0 + ($border_bottom/2))*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_bottom/2)))*$this-&gt;k, ($x0 + $w - ($border_bottom/2) )*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_bottom/2)))*$this-&gt;k ));
<a name="l15916"></a>15916         }
<a name="l15917"></a>15917       }
<a name="l15918"></a>15918     }
<a name="l15919"></a>15919     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>]) { 
<a name="l15920"></a>15920       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>];
<a name="l15921"></a>15921       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15922"></a>15922         <span class="keywordflow">if</span> (!$brset &amp;&amp; $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;double&#39;</span>) {
<a name="l15923"></a>15923           $this-&gt;SetLineWidth($tbd[<span class="charliteral">&#39;w&#39;</span>]/3);
<a name="l15924"></a>15924           $this-&gt;SetDrawColor($tbcol[0],$tbcol[1],$tbcol[2]);
<a name="l15925"></a>15925           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S&#39;</span>, ($x0 + ($border_left/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_left/2)))*$this-&gt;k, ($x0 + ($border_left/2))*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_left/2)) )*$this-&gt;k));
<a name="l15926"></a>15926         }
<a name="l15927"></a>15927       }
<a name="l15928"></a>15928     }
<a name="l15929"></a>15929     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>]) { 
<a name="l15930"></a>15930       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>];
<a name="l15931"></a>15931       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l15932"></a>15932         <span class="keywordflow">if</span> (!$brset &amp;&amp; $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;double&#39;</span>) {
<a name="l15933"></a>15933           $this-&gt;SetLineWidth($tbd[<span class="charliteral">&#39;w&#39;</span>]/3);
<a name="l15934"></a>15934           $this-&gt;SetDrawColor($tbcol[0],$tbcol[1],$tbcol[2]);
<a name="l15935"></a>15935           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f l S&#39;</span>, ($x0 + $w - ($border_right/2))*$this-&gt;k, ($this-&gt;h-($y0 + $h - ($border_right/2)))*$this-&gt;k, ($x0 + $w - ($border_right/2))*$this-&gt;k, ($this-&gt;h-($y0 + ($border_right/2)) )*$this-&gt;k));
<a name="l15936"></a>15936         }
<a name="l15937"></a>15937       }
<a name="l15938"></a>15938     }
<a name="l15939"></a>15939 
<a name="l15940"></a>15940 
<a name="l15941"></a>15941     $this-&gt;SetDash(); 
<a name="l15942"></a>15942   $this-&gt;y = $save_y; 
<a name="l15943"></a>15943 
<a name="l15944"></a>15944 
<a name="l15945"></a>15945   <span class="comment">// BACKGROUNDS are disabled in columns/kbt/headers - messes up the repositioning in printcolumnbuffer</span>
<a name="l15946"></a>15946   <span class="comment">// mPDF 4.0 Added kwt</span>
<a name="l15947"></a>15947   <span class="keywordflow">if</span> ($this-&gt;ColActive || $this-&gt;kwt || $this-&gt;keep_block_together) { return ; }
<a name="l15948"></a>15948 
<a name="l15949"></a>15949   $bgx0 = $x0;
<a name="l15950"></a>15950   $bgx1 = $x1;
<a name="l15951"></a>15951   $bgy0 = $y0;
<a name="l15952"></a>15952   $bgy1 = $y1;
<a name="l15953"></a>15953 
<a name="l15954"></a>15954     $brbgTL_H = $brTL_H;
<a name="l15955"></a>15955     $brbgTL_V = $brTL_V;
<a name="l15956"></a>15956     $brbgTR_H = $brTR_H;
<a name="l15957"></a>15957     $brbgTR_V = $brTR_V;
<a name="l15958"></a>15958     $brbgBL_H = $brBL_H;
<a name="l15959"></a>15959     $brbgBL_V = $brBL_V;
<a name="l15960"></a>15960     $brbgBR_H = $brBR_H;
<a name="l15961"></a>15961     $brbgBR_V = $brBR_V;
<a name="l15962"></a>15962 
<a name="l15963"></a>15963   <span class="comment">// Set clipping path</span>
<a name="l15964"></a>15964   $s = <span class="stringliteral">&#39; q 0 w &#39;</span>; <span class="comment">// Line width=0</span>
<a name="l15965"></a>15965   $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f m &#39;</span>, ($bgx0+$brbgTL_H )*$this-&gt;k, ($this-&gt;h-$bgy0)*$this-&gt;k);  <span class="comment">// start point TL before the arc</span>
<a name="l15966"></a>15966   $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>, ($bgx0)*$this-&gt;k, ($this-&gt;h-($bgy1-$brbgBL_V ))*$this-&gt;k);  <span class="comment">// line to BL</span>
<a name="l15967"></a>15967   $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>, ($bgx1-$brbgBR_H )*$this-&gt;k, ($this-&gt;h-($bgy1))*$this-&gt;k);  <span class="comment">// line to BR</span>
<a name="l15968"></a>15968   $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>, ($bgx1)*$this-&gt;k, ($this-&gt;h-($bgy0+$brbgTR_V))*$this-&gt;k); <span class="comment">// line to TR</span>
<a name="l15969"></a>15969   $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f l &#39;</span>, ($bgx0+$brbgTL_H )*$this-&gt;k, ($this-&gt;h-$bgy0)*$this-&gt;k);  <span class="comment">// line to TL</span>
<a name="l15970"></a>15970   $s .= <span class="stringliteral">&#39; W n &#39;</span>;  <span class="comment">// Ends path no-op &amp; Sets the clipping path</span>
<a name="l15971"></a>15971 
<a name="l15972"></a>15972   <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;bgcolor&#39;</span>]) { 
<a name="l15973"></a>15973     $this-&gt;pageBackgrounds[$blvl][] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;$x0, <span class="charliteral">&#39;y&#39;</span>=&gt;$y0, <span class="charliteral">&#39;w&#39;</span>=&gt;$w, <span class="charliteral">&#39;h&#39;</span>=&gt;$h, <span class="stringliteral">&#39;col&#39;</span>=&gt;$this-&gt;blk[$blvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>], <span class="stringliteral">&#39;clippath&#39;</span>=&gt;$s);
<a name="l15974"></a>15974   }
<a name="l15975"></a>15975 
<a name="l15976"></a>15976   <span class="keywordflow">if</span> (isset($this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>])) { 
<a name="l15977"></a>15977     $image_id = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;image_id&#39;</span>];
<a name="l15978"></a>15978     $orig_w = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;orig_w&#39;</span>];
<a name="l15979"></a>15979     $orig_h = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;orig_h&#39;</span>];
<a name="l15980"></a>15980     $x_pos = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;x_pos&#39;</span>];
<a name="l15981"></a>15981     $y_pos = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;y_pos&#39;</span>];
<a name="l15982"></a>15982     $x_repeat = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;x_repeat&#39;</span>];
<a name="l15983"></a>15983     $y_repeat = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;y_repeat&#39;</span>];
<a name="l15984"></a>15984     $resize = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;resize&#39;</span>];  <span class="comment">// mPDF 4.3.015</span>
<a name="l15985"></a>15985     $opacity = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>];  <span class="comment">// mPDF 4.3.017</span>
<a name="l15986"></a>15986     $this-&gt;pageBackgrounds[$blvl][] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;$x0, <span class="charliteral">&#39;y&#39;</span>=&gt;$y0, <span class="charliteral">&#39;w&#39;</span>=&gt;$w, <span class="charliteral">&#39;h&#39;</span>=&gt;$h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$image_id, <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$x_pos, <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$y_pos, <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat, <span class="stringliteral">&#39;clippath&#39;</span>=&gt;$s, <span class="stringliteral">&#39;resize&#39;</span>=&gt;$resize, <span class="stringliteral">&#39;opacity&#39;</span>=&gt;$opacity); <span class="comment">// mPDF 4.3.015  4.3.017</span>
<a name="l15987"></a>15987   }
<a name="l15988"></a>15988 
<a name="l15989"></a>15989   <span class="comment">// Added mPDF 3.0 Float DIV</span>
<a name="l15990"></a>15990   $this-&gt;blk[$blvl][<span class="stringliteral">&#39;bb_painted&#39;</span>][$this-&gt;page] = <span class="keyword">true</span>;
<a name="l15991"></a>15991 
<a name="l15992"></a>15992 }
<a name="l15993"></a>15993 
<a name="l15994"></a>15994 
<a name="l15995"></a>15995 
<a name="l15996"></a>15996 
<a name="l15997"></a>15997 function PaintDivLnBorder($state=0,$blvl=0,$h) {
<a name="l15998"></a>15998   <span class="comment">// $state = 0 normal; 1 top; 2 bottom; 3 top and bottom</span>
<a name="l15999"></a>15999 
<a name="l16000"></a>16000   $this-&gt;ColDetails[$this-&gt;CurrCol][<span class="stringliteral">&#39;bottom_margin&#39;</span>] = $this-&gt;y + $h; 
<a name="l16001"></a>16001 
<a name="l16002"></a>16002   $save_y = $this-&gt;y;
<a name="l16003"></a>16003 
<a name="l16004"></a>16004   $w = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l16005"></a>16005   $x0 = $this-&gt;x;       <span class="comment">// left</span>
<a name="l16006"></a>16006   $y0 = $this-&gt;y;       <span class="comment">// top</span>
<a name="l16007"></a>16007   $x1 = $this-&gt;x + $w;      <span class="comment">// bottom</span>
<a name="l16008"></a>16008   $y1 = $this-&gt;y + $h;      <span class="comment">// bottom</span>
<a name="l16009"></a>16009 
<a name="l16010"></a>16010     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>] &amp;&amp; ($state==1 || $state==3)) {
<a name="l16011"></a>16011       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_top&#39;</span>];
<a name="l16012"></a>16012       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16013"></a>16013         <span class="comment">// mPDF 4.0</span>
<a name="l16014"></a>16014         $this-&gt;_setBorderLine($tbd);
<a name="l16015"></a>16015         $this-&gt;y = $y0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l16016"></a>16016         <span class="comment">// mPDF 4.0</span>
<a name="l16017"></a>16017         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,$continuingpage,<span class="charliteral">&#39;T&#39;</span>); }
<a name="l16018"></a>16018         $this-&gt;Line($x0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2) , $this-&gt;y , $x0 + $w - ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2), $this-&gt;y);
<a name="l16019"></a>16019         $this-&gt;y += $tbd[<span class="charliteral">&#39;w&#39;</span>];
<a name="l16020"></a>16020         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16021"></a>16021           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16022"></a>16022         $this-&gt;SetDash(); 
<a name="l16023"></a>16023 
<a name="l16024"></a>16024       }
<a name="l16025"></a>16025     }
<a name="l16026"></a>16026 
<a name="l16027"></a>16027     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>]) { 
<a name="l16028"></a>16028       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_left&#39;</span>];
<a name="l16029"></a>16029       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16030"></a>16030         <span class="comment">// mPDF 4.0</span>
<a name="l16031"></a>16031         $this-&gt;_setBorderLine($tbd);
<a name="l16032"></a>16032         $this-&gt;y = $y0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l16033"></a>16033         <span class="comment">// mPDF 4.0</span>
<a name="l16034"></a>16034         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,$continuingpage,<span class="charliteral">&#39;L&#39;</span>); }
<a name="l16035"></a>16035         $this-&gt;Line($x0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2), $this-&gt;y, $x0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2), $y0 + $h -($tbd[<span class="charliteral">&#39;w&#39;</span>]/2));
<a name="l16036"></a>16036         $this-&gt;y += $tbd[<span class="charliteral">&#39;w&#39;</span>];
<a name="l16037"></a>16037         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16038"></a>16038           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16039"></a>16039         $this-&gt;SetDash(); 
<a name="l16040"></a>16040 
<a name="l16041"></a>16041       }
<a name="l16042"></a>16042     }
<a name="l16043"></a>16043     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>]) { 
<a name="l16044"></a>16044       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_right&#39;</span>];
<a name="l16045"></a>16045       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16046"></a>16046         <span class="comment">// mPDF 4.0</span>
<a name="l16047"></a>16047         $this-&gt;_setBorderLine($tbd);
<a name="l16048"></a>16048         $this-&gt;y = $y0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l16049"></a>16049         <span class="comment">// mPDF 4.0</span>
<a name="l16050"></a>16050         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,$continuingpage,<span class="charliteral">&#39;R&#39;</span>); }
<a name="l16051"></a>16051         $this-&gt;Line($x0 + $w - ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2), $this-&gt;y, $x0 + $w - ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2), $y0 + $h - ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2));
<a name="l16052"></a>16052         $this-&gt;y += $tbd[<span class="charliteral">&#39;w&#39;</span>];
<a name="l16053"></a>16053         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16054"></a>16054           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16055"></a>16055         $this-&gt;SetDash(); 
<a name="l16056"></a>16056 
<a name="l16057"></a>16057       }
<a name="l16058"></a>16058     }
<a name="l16059"></a>16059     <span class="keywordflow">if</span> ($this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>] &amp;&amp; $state &gt; 1) { 
<a name="l16060"></a>16060       $tbd = $this-&gt;blk[$blvl][<span class="stringliteral">&#39;border_bottom&#39;</span>];
<a name="l16061"></a>16061       <span class="keywordflow">if</span> (isset($tbd[<span class="charliteral">&#39;s&#39;</span>]) &amp;&amp; $tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16062"></a>16062         <span class="comment">// mPDF 4.0</span>
<a name="l16063"></a>16063         $this-&gt;_setBorderLine($tbd);
<a name="l16064"></a>16064         $this-&gt;y = $y0 + $h - ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l16065"></a>16065         <span class="comment">// mPDF 4.0</span>
<a name="l16066"></a>16066         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,$continuingpage,<span class="charliteral">&#39;B&#39;</span>); }
<a name="l16067"></a>16067         $this-&gt;Line($x0 + ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2) , $this-&gt;y, $x0 + $w - ($tbd[<span class="charliteral">&#39;w&#39;</span>]/2), $this-&gt;y);
<a name="l16068"></a>16068         $this-&gt;y += $tbd[<span class="charliteral">&#39;w&#39;</span>];
<a name="l16069"></a>16069         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16070"></a>16070           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16071"></a>16071         $this-&gt;SetDash(); 
<a name="l16072"></a>16072 
<a name="l16073"></a>16073       }
<a name="l16074"></a>16074     }
<a name="l16075"></a>16075     $this-&gt;SetDash(); 
<a name="l16076"></a>16076 
<a name="l16077"></a>16077 
<a name="l16078"></a>16078   $this-&gt;y = $save_y; 
<a name="l16079"></a>16079 }
<a name="l16080"></a>16080 
<a name="l16081"></a>16081 
<a name="l16082"></a>16082 function PaintImgBorder($objattr,$is_table) {
<a name="l16083"></a>16083   <span class="comment">// Borders are disabled in columns - messes up the repositioning in printcolumnbuffer</span>
<a name="l16084"></a>16084   <span class="keywordflow">if</span> ($is_table) { $k = $this-&gt;shrin_k; } <span class="keywordflow">else</span> { $k = 1; }
<a name="l16085"></a>16085     $h = $objattr[<span class="stringliteral">&#39;BORDER-HEIGHT&#39;</span>];
<a name="l16086"></a>16086     $w = $objattr[<span class="stringliteral">&#39;BORDER-WIDTH&#39;</span>];
<a name="l16087"></a>16087     $x0 = $objattr[<span class="stringliteral">&#39;BORDER-X&#39;</span>];
<a name="l16088"></a>16088     $y0 = $objattr[<span class="stringliteral">&#39;BORDER-Y&#39;</span>];
<a name="l16089"></a>16089 
<a name="l16090"></a>16090     <span class="comment">// BORDERS</span>
<a name="l16091"></a>16091     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;border_top&#39;</span>]) { 
<a name="l16092"></a>16092       $tbd = $objattr[<span class="stringliteral">&#39;border_top&#39;</span>];
<a name="l16093"></a>16093       <span class="keywordflow">if</span> ($tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16094"></a>16094         <span class="comment">// mPDF 4.0</span>
<a name="l16095"></a>16095         $this-&gt;_setBorderLine($tbd,$k);
<a name="l16096"></a>16096         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;T&#39;</span>); }
<a name="l16097"></a>16097         $this-&gt;Line($x0, $y0, $x0 + $w, $y0);
<a name="l16098"></a>16098         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16099"></a>16099           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16100"></a>16100         $this-&gt;SetDash(); 
<a name="l16101"></a>16101 
<a name="l16102"></a>16102       }
<a name="l16103"></a>16103     }
<a name="l16104"></a>16104     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;border_left&#39;</span>]) { 
<a name="l16105"></a>16105       $tbd = $objattr[<span class="stringliteral">&#39;border_left&#39;</span>];
<a name="l16106"></a>16106       <span class="keywordflow">if</span> ($tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16107"></a>16107         <span class="comment">// mPDF 4.0</span>
<a name="l16108"></a>16108         $this-&gt;_setBorderLine($tbd,$k);
<a name="l16109"></a>16109         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;L&#39;</span>); }
<a name="l16110"></a>16110         $this-&gt;Line($x0, $y0, $x0, $y0 + $h);
<a name="l16111"></a>16111         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16112"></a>16112           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16113"></a>16113         $this-&gt;SetDash(); 
<a name="l16114"></a>16114 
<a name="l16115"></a>16115       }
<a name="l16116"></a>16116     }
<a name="l16117"></a>16117     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;border_right&#39;</span>]) { 
<a name="l16118"></a>16118       $tbd = $objattr[<span class="stringliteral">&#39;border_right&#39;</span>];
<a name="l16119"></a>16119       <span class="keywordflow">if</span> ($tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16120"></a>16120         <span class="comment">// mPDF 4.0</span>
<a name="l16121"></a>16121         $this-&gt;_setBorderLine($tbd,$k);
<a name="l16122"></a>16122         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;R&#39;</span>); }
<a name="l16123"></a>16123         $this-&gt;Line($x0 + $w, $y0, $x0 + $w, $y0 + $h);
<a name="l16124"></a>16124         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16125"></a>16125           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16126"></a>16126         $this-&gt;SetDash(); 
<a name="l16127"></a>16127 
<a name="l16128"></a>16128       }
<a name="l16129"></a>16129     }
<a name="l16130"></a>16130     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>]) { 
<a name="l16131"></a>16131       $tbd = $objattr[<span class="stringliteral">&#39;border_bottom&#39;</span>];
<a name="l16132"></a>16132       <span class="keywordflow">if</span> ($tbd[<span class="charliteral">&#39;s&#39;</span>]) {
<a name="l16133"></a>16133         <span class="comment">// mPDF 4.0</span>
<a name="l16134"></a>16134         $this-&gt;_setBorderLine($tbd,$k);
<a name="l16135"></a>16135         <span class="keywordflow">if</span> ($tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dotted&#39;</span> || $tbd[<span class="stringliteral">&#39;style&#39;</span>]==<span class="stringliteral">&#39;dashed&#39;</span>) { $this-&gt;_setDashBorder($tbd[<span class="stringliteral">&#39;style&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;B&#39;</span>); }
<a name="l16136"></a>16136         $this-&gt;Line($x0, $y0 + $h, $x0 + $w, $y0 + $h);
<a name="l16137"></a>16137         <span class="comment">// Reset Corners and Dash off</span>
<a name="l16138"></a>16138           $this-&gt;_out(<span class="stringliteral">&#39;2 J 2 j&#39;</span>);
<a name="l16139"></a>16139         $this-&gt;SetDash(); 
<a name="l16140"></a>16140 
<a name="l16141"></a>16141       }
<a name="l16142"></a>16142     }
<a name="l16143"></a>16143     $this-&gt;SetDash(); 
<a name="l16144"></a>16144 
<a name="l16145"></a>16145 }
<a name="l16146"></a>16146 
<a name="l16147"></a>16147 
<a name="l16148"></a>16148 
<a name="l16149"></a>16149 
<a name="l16150"></a>16150 
<a name="l16151"></a>16151 function Reset()
<a name="l16152"></a>16152 {
<a name="l16153"></a>16153   $this-&gt;SetTextColor(0);
<a name="l16154"></a>16154   $this-&gt;colorarray = array();
<a name="l16155"></a>16155   $this-&gt;issetcolor = <span class="keyword">false</span>;
<a name="l16156"></a>16156 
<a name="l16157"></a>16157   $this-&gt;SetDrawColor(0);
<a name="l16158"></a>16158 
<a name="l16159"></a>16159   $this-&gt;SetFillColor(255);
<a name="l16160"></a>16160   $this-&gt;spanbgcolorarray = array();
<a name="l16161"></a>16161   $this-&gt;spanbgcolor = <span class="keyword">false</span>;
<a name="l16162"></a>16162 
<a name="l16163"></a>16163   $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l16164"></a>16164   $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l16165"></a>16165   $this-&gt;SetStyle(<span class="charliteral">&#39;U&#39;</span>,<span class="keyword">false</span>);
<a name="l16166"></a>16166 
<a name="l16167"></a>16167   $this-&gt;HREF = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16168"></a>16168   $this-&gt;outlineparam = array();
<a name="l16169"></a>16169       $this-&gt;outline_on = <span class="keyword">false</span>;
<a name="l16170"></a>16170   $this-&gt;SetTextOutline(<span class="keyword">false</span>);
<a name="l16171"></a>16171 
<a name="l16172"></a>16172   $this-&gt;SUP = <span class="keyword">false</span>;
<a name="l16173"></a>16173   $this-&gt;SUB = <span class="keyword">false</span>;
<a name="l16174"></a>16174   $this-&gt;strike = <span class="keyword">false</span>;
<a name="l16175"></a>16175 
<a name="l16176"></a>16176   $this-&gt;SetFont($this-&gt;default_font,<span class="stringliteral">&#39;&#39;</span>,0,<span class="keyword">false</span>);
<a name="l16177"></a>16177   $this-&gt;SetFontSize($this-&gt;default_font_size,<span class="keyword">false</span>);
<a name="l16178"></a>16178 
<a name="l16179"></a>16179   $this-&gt;currentfontfamily = <span class="stringliteral">&#39;&#39;</span>;  
<a name="l16180"></a>16180   $this-&gt;currentfontsize = <span class="stringliteral">&#39;&#39;</span>;  
<a name="l16181"></a>16181 
<a name="l16182"></a>16182   <span class="keywordflow">if</span> ($this-&gt;tableLevel) {
<a name="l16183"></a>16183     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;table_lineheight); <span class="comment">// *TABLES*</span>
<a name="l16184"></a>16184   }
<a name="l16185"></a>16185   <span class="keywordflow">else</span>
<a name="l16186"></a>16186   <span class="comment">// mPDF 4.2</span>
<a name="l16187"></a>16187   <span class="keywordflow">if</span> ($this-&gt;listlvl &amp;&amp; $this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;bulletarray[<span class="stringliteral">&#39;occur&#39;</span>]]) {
<a name="l16188"></a>16188     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;list_lineheight[$this-&gt;listlvl][$this-&gt;bulletarray[<span class="stringliteral">&#39;occur&#39;</span>]]); <span class="comment">// sets default line height</span>
<a name="l16189"></a>16189   }
<a name="l16190"></a>16190   <span class="keywordflow">else</span>
<a name="l16191"></a>16191   <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]) {
<a name="l16192"></a>16192     $this-&gt;SetLineHeight(<span class="stringliteral">&#39;&#39;</span>,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>]);  <span class="comment">// sets default line height</span>
<a name="l16193"></a>16193   }
<a name="l16194"></a>16194 
<a name="l16195"></a>16195   $this-&gt;toupper = <span class="keyword">false</span>;
<a name="l16196"></a>16196   $this-&gt;tolower = <span class="keyword">false</span>;
<a name="l16197"></a>16197   $this-&gt;SetDash(); <span class="comment">//restore to no dash</span>
<a name="l16198"></a>16198   $this-&gt;dash_on = <span class="keyword">false</span>;
<a name="l16199"></a>16199   $this-&gt;dotted_on = <span class="keyword">false</span>;
<a name="l16200"></a>16200   $this-&gt;divwidth = 0;
<a name="l16201"></a>16201   $this-&gt;divheight = 0;
<a name="l16202"></a>16202   $this-&gt;divalign = $this-&gt;defaultAlign;
<a name="l16203"></a>16203   $this-&gt;divrevert = <span class="keyword">false</span>;
<a name="l16204"></a>16204   $this-&gt;oldy = -1;
<a name="l16205"></a>16205 
<a name="l16206"></a>16206   $bodystyle = array();
<a name="l16207"></a>16207   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-STYLE&#39;</span>])) { $bodystyle[<span class="stringliteral">&#39;FONT-STYLE&#39;</span>] = $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-STYLE&#39;</span>]; }
<a name="l16208"></a>16208   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>])) { $bodystyle[<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>] = $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>]; }
<a name="l16209"></a>16209   <span class="keywordflow">if</span> (isset($this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;COLOR&#39;</span>])) { $bodystyle[<span class="stringliteral">&#39;COLOR&#39;</span>] = $this-&gt;CSS[<span class="stringliteral">&#39;BODY&#39;</span>][<span class="stringliteral">&#39;COLOR&#39;</span>]; }
<a name="l16210"></a>16210   <span class="keywordflow">if</span> (isset($bodystyle)) { $this-&gt;setCSS($bodystyle,<span class="stringliteral">&#39;BLOCK&#39;</span>,<span class="stringliteral">&#39;BODY&#39;</span>); }
<a name="l16211"></a>16211 
<a name="l16212"></a>16212 }
<a name="l16213"></a>16213 
<a name="l16214"></a>16214 function ReadMetaTags($html)
<a name="l16215"></a>16215 {
<a name="l16216"></a>16216   <span class="comment">// changes anykey=anyvalue to anykey=&quot;anyvalue&quot; (only do this when this happens inside tags)</span>
<a name="l16217"></a>16217   $regexp = <span class="stringliteral">&#39;/ (\\w+?)=([^\\s&gt;&quot;]+)/si&#39;</span>; 
<a name="l16218"></a>16218   $html = preg_replace($regexp,<span class="stringliteral">&quot; \$1=\&quot;\$2\&quot;&quot;</span>,$html);
<a name="l16219"></a>16219 
<a name="l16220"></a>16220   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/&lt;title&gt;(.*?)&lt;\/title&gt;/si&#39;</span>,$html,$m)) {
<a name="l16221"></a>16221     $this-&gt;SetTitle($m[1]); 
<a name="l16222"></a>16222   }
<a name="l16223"></a>16223 
<a name="l16224"></a>16224   preg_match_all(<span class="stringliteral">&#39;/&lt;meta [^&gt;]*?(name|content)=&quot;([^&gt;]*?)&quot; [^&gt;]*?(name|content)=&quot;([^&gt;]*?)&quot;.*?&gt;/si&#39;</span>,$html,$aux);
<a name="l16225"></a>16225   $firstattr = $aux[1];
<a name="l16226"></a>16226   $secondattr = $aux[3];
<a name="l16227"></a>16227   <span class="keywordflow">for</span>( $i = 0 ; $i &lt; count($aux[0]) ; $i++)
<a name="l16228"></a>16228   {
<a name="l16229"></a>16229 
<a name="l16230"></a>16230      $name = ( strtoupper($firstattr[$i]) == <span class="stringliteral">&quot;NAME&quot;</span> )? strtoupper($aux[2][$i]) : strtoupper($aux[4][$i]);
<a name="l16231"></a>16231      $content = ( strtoupper($firstattr[$i]) == <span class="stringliteral">&quot;CONTENT&quot;</span> )? $aux[2][$i] : $aux[4][$i];
<a name="l16232"></a>16232      <span class="keywordflow">switch</span>($name)
<a name="l16233"></a>16233      {
<a name="l16234"></a>16234        <span class="keywordflow">case</span> <span class="stringliteral">&quot;KEYWORDS&quot;</span>: $this-&gt;SetKeywords($content); <span class="keywordflow">break</span>;
<a name="l16235"></a>16235        <span class="keywordflow">case</span> <span class="stringliteral">&quot;AUTHOR&quot;</span>: $this-&gt;SetAuthor($content); <span class="keywordflow">break</span>;
<a name="l16236"></a>16236        <span class="keywordflow">case</span> <span class="stringliteral">&quot;DESCRIPTION&quot;</span>: $this-&gt;SetSubject($content); <span class="keywordflow">break</span>;
<a name="l16237"></a>16237      }
<a name="l16238"></a>16238   }
<a name="l16239"></a>16239 }
<a name="l16240"></a>16240 
<a name="l16241"></a>16241 
<a name="l16242"></a>16242 function ReadCharset($html)
<a name="l16243"></a>16243 {
<a name="l16244"></a>16244   <span class="comment">// Charset conversion</span>
<a name="l16245"></a>16245   <span class="keywordflow">if</span> ($this-&gt;allow_charset_conversion) {
<a name="l16246"></a>16246      <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/&lt;head.*charset=([^\&#39;\&quot;\s]*).*&lt;\/head&gt;/si&#39;</span>,$html,$m)) {
<a name="l16247"></a>16247     <span class="keywordflow">if</span> (strtoupper($m[1]) != <span class="stringliteral">&#39;UTF-8&#39;</span>) {
<a name="l16248"></a>16248       $this-&gt;charset_in = strtoupper($m[1]); 
<a name="l16249"></a>16249     }
<a name="l16250"></a>16250      }
<a name="l16251"></a>16251   }
<a name="l16252"></a>16252 
<a name="l16253"></a>16253 }
<a name="l16254"></a>16254 
<a name="l16264"></a>16264 
<a name="l16265"></a><a class="code" href="classmPDF.html#a20d1475a1efa2a8b85e8716e8bb57af8">16265</a> function <a class="code" href="classmPDF.html#a20d1475a1efa2a8b85e8716e8bb57af8" title="CSS parser ///.">ReadDefaultCSS</a>($CSSstr) {
<a name="l16266"></a>16266     $CSS = array();
<a name="l16267"></a>16267     $CSSstr = preg_replace(<span class="stringliteral">&#39;|/\*.*?\*/|s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16268"></a>16268     $CSSstr = preg_replace(<span class="stringliteral">&#39;/[\s\n\r\t\f]/s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16269"></a>16269 
<a name="l16270"></a>16270     $CSSstr = preg_replace(<span class="stringliteral">&#39;/(&lt;\!\-\-|\-\-&gt;)/s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16271"></a>16271     <span class="keywordflow">if</span> ($CSSstr ) {
<a name="l16272"></a>16272   preg_match_all(<span class="stringliteral">&#39;/(.*?)\{(.*?)\}/&#39;</span>,$CSSstr,$styles);
<a name="l16273"></a>16273   <span class="keywordflow">for</span>($i=0; $i &lt; count($styles[1]) ; $i++)  {
<a name="l16274"></a>16274     $stylestr= trim($styles[2][$i]);
<a name="l16275"></a>16275     $stylearr = explode(<span class="charliteral">&#39;;&#39;</span>,$stylestr);
<a name="l16276"></a>16276     <span class="keywordflow">foreach</span>($stylearr AS $sta) {
<a name="l16277"></a>16277        <span class="keywordflow">if</span> (trim($sta)) {
<a name="l16278"></a>16278       <span class="comment">// mPDF 3.0</span>
<a name="l16279"></a>16279       <span class="comment">// Changed to allow style=&quot;background: url(&#39;http://www.bpm1.com/bg.jpg&#39;)&quot;</span>
<a name="l16280"></a>16280       list($property,$value) = explode(<span class="charliteral">&#39;:&#39;</span>,$sta,2);
<a name="l16281"></a>16281       $property = trim($property);
<a name="l16282"></a>16282       $value = preg_replace(<span class="stringliteral">&#39;/\s*!important/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$value);
<a name="l16283"></a>16283       $value = trim($value);
<a name="l16284"></a>16284       <span class="keywordflow">if</span> ($property &amp;&amp; ($value || $value===<span class="charliteral">&#39;0&#39;</span>)) {
<a name="l16285"></a>16285           $classproperties[strtoupper($property)] = $value;
<a name="l16286"></a>16286       }
<a name="l16287"></a>16287        }
<a name="l16288"></a>16288     }
<a name="l16289"></a>16289     $classproperties = $this-&gt;fixCSS($classproperties);
<a name="l16290"></a>16290     $tagstr = strtoupper(trim($styles[1][$i]));
<a name="l16291"></a>16291     $tagarr = explode(<span class="charliteral">&#39;,&#39;</span>,$tagstr);
<a name="l16292"></a>16292     <span class="keywordflow">foreach</span>($tagarr AS $tg) {
<a name="l16293"></a>16293       $tags = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($tg));
<a name="l16294"></a>16294       $level = count($tags);
<a name="l16295"></a>16295       <span class="keywordflow">if</span> ($level == 1) {    <span class="comment">// e.g. p or .class or #id or p.class or p#id</span>
<a name="l16296"></a>16296          $t = trim($tags[0]);
<a name="l16297"></a>16297          <span class="keywordflow">if</span> ($t) {
<a name="l16298"></a>16298       $tag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16299"></a>16299       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)$/&#39;</span>,$t)) { $tag= $t; }
<a name="l16300"></a>16300       <span class="keywordflow">if</span> ($this-&gt;CSS[$tag] &amp;&amp; $tag) { $CSS[$tag] = $this-&gt;array_merge_recursive_unique($CSS[$tag], $classproperties); }
<a name="l16301"></a>16301       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag) { $CSS[$tag] = $classproperties; }
<a name="l16302"></a>16302          }
<a name="l16303"></a>16303       }
<a name="l16304"></a>16304     }
<a name="l16305"></a>16305       $properties = array();
<a name="l16306"></a>16306       $values = array();
<a name="l16307"></a>16307       $classproperties = array();
<a name="l16308"></a>16308   }
<a name="l16309"></a>16309 
<a name="l16310"></a>16310     } <span class="comment">// end of if</span>
<a name="l16311"></a>16311     <span class="keywordflow">return</span> $CSS;
<a name="l16312"></a>16312 }
<a name="l16313"></a>16313 
<a name="l16314"></a>16314 
<a name="l16315"></a>16315 
<a name="l16316"></a>16316 
<a name="l16317"></a>16317 function ReadCSS($html) {
<a name="l16318"></a>16318 <span class="comment">//</span>
<a name="l16319"></a>16319 <span class="comment">// This supports:  .class {...} / #id { .... }</span>
<a name="l16320"></a>16320 <span class="comment">// p {...}  h1[-h6] {...}  a {...}  table {...}   thead {...}  th {...}  td {...}  hr {...}</span>
<a name="l16321"></a>16321 <span class="comment">// body {...} sets default font and fontsize</span>
<a name="l16322"></a>16322 <span class="comment">// It supports some cascaded CSS e.g. div.topic table.type1 td</span>
<a name="l16323"></a>16323 <span class="comment">// Does not support non-block level e.g. a#hover { ... }</span>
<a name="l16324"></a>16324 
<a name="l16325"></a>16325   <span class="comment">// mPDF 4.3.001</span>
<a name="l16326"></a>16326   preg_match_all(<span class="stringliteral">&#39;/&lt;style[^&gt;]*media=[&quot;\&#39;]([^&quot;\&#39;&gt;]*)[&quot;\&#39;].*?&lt;\/style&gt;/is&#39;</span>,$html,$m);
<a name="l16327"></a>16327   <span class="keywordflow">for</span>($i=0; $i&lt;count($m[0]); $i++) {
<a name="l16328"></a>16328     <span class="keywordflow">if</span> ($this-&gt;CSSselectMedia &amp;&amp; !preg_match(<span class="stringliteral">&#39;/(&#39;</span>.trim($this-&gt;CSSselectMedia).<span class="stringliteral">&#39;|all)/i&#39;</span>,$m[1][$i])) { 
<a name="l16329"></a>16329       $html = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($m[0][$i],<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html);
<a name="l16330"></a>16330     }
<a name="l16331"></a>16331   }
<a name="l16332"></a>16332   preg_match_all(<span class="stringliteral">&#39;/&lt;link[^&gt;]*media=[&quot;\&#39;]([^&quot;\&#39;&gt;]*)[&quot;\&#39;].*?&gt;/is&#39;</span>,$html,$m);
<a name="l16333"></a>16333   <span class="keywordflow">for</span>($i=0; $i&lt;count($m[0]); $i++) {
<a name="l16334"></a>16334     <span class="keywordflow">if</span> ($this-&gt;CSSselectMedia &amp;&amp; !preg_match(<span class="stringliteral">&#39;/(&#39;</span>.trim($this-&gt;CSSselectMedia).<span class="stringliteral">&#39;|all)/i&#39;</span>,$m[1][$i])) { 
<a name="l16335"></a>16335       $html = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($m[0][$i],<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html);
<a name="l16336"></a>16336     }
<a name="l16337"></a>16337   }
<a name="l16338"></a>16338 
<a name="l16339"></a>16339   <span class="comment">// mPDF 4.0</span>
<a name="l16340"></a>16340   <span class="comment">// Remove Comment tags &lt;!--  --&gt; inside CSS as &lt;style&gt; in HTML document</span>
<a name="l16341"></a>16341   preg_match_all(<span class="stringliteral">&#39;/&lt;style.*?&gt;(.*?)&lt;\/style&gt;/si&#39;</span>,$html,$m);
<a name="l16342"></a>16342   <span class="keywordflow">if</span> (count($m[1])) { 
<a name="l16343"></a>16343     <span class="keywordflow">for</span>($i=0;$i&lt;count($m[1]);$i++) {
<a name="l16344"></a>16344       <span class="comment">// Remove comment tags </span>
<a name="l16345"></a>16345       $sub = preg_replace(<span class="stringliteral">&#39;/(&lt;\!\-\-|\-\-&gt;)/s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$m[1][$i]);
<a name="l16346"></a>16346       $html = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($m[1][$i], <span class="charliteral">&#39;/&#39;</span>).<span class="stringliteral">&#39;/si&#39;</span>, $sub, $html); 
<a name="l16347"></a>16347     }
<a name="l16348"></a>16348   }
<a name="l16349"></a>16349   <span class="comment">// mPDF 4.0</span>
<a name="l16350"></a>16350   $html = preg_replace(<span class="stringliteral">&#39;/&lt;!--mpdf/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l16351"></a>16351   $html = preg_replace(<span class="stringliteral">&#39;/mpdf--&gt;/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l16352"></a>16352   $html = preg_replace(<span class="stringliteral">&#39;/&lt;\!\-\-.*?\-\-&gt;/s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$html);
<a name="l16353"></a>16353 
<a name="l16354"></a>16354   $match = 0; <span class="comment">// no match for instance</span>
<a name="l16355"></a>16355   $regexp = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// This helps debugging: showing what is the REAL string being processed</span>
<a name="l16356"></a>16356   $CSSext = array(); 
<a name="l16357"></a>16357 
<a name="l16358"></a>16358   <span class="comment">//CSS inside external files</span>
<a name="l16359"></a>16359   <span class="comment">// mPDF 3.0 Allow single or double quotes</span>
<a name="l16360"></a>16360   <span class="comment">// mPDF 4.0 Allow &gt;1 space or extra text after link</span>
<a name="l16361"></a>16361   $regexp = <span class="stringliteral">&#39;/&lt;link[^&gt;]*rel=[&quot;\&#39;]stylesheet[&quot;\&#39;][^&gt;]*href=[&quot;\&#39;]([^&gt;&quot;\&#39;]*)[&quot;\&#39;].*?&gt;/si&#39;</span>; <span class="comment">// EDIT mPDF 4.0</span>
<a name="l16362"></a>16362   $x = preg_match_all($regexp,$html,$cxt);
<a name="l16363"></a>16363   <span class="keywordflow">if</span> ($x) { 
<a name="l16364"></a>16364     $match += $x; 
<a name="l16365"></a>16365     $CSSext = $cxt[1];
<a name="l16366"></a>16366   }
<a name="l16367"></a>16367 
<a name="l16368"></a>16368   <span class="comment">// mPDF 3.0 Allow single or double quotes</span>
<a name="l16369"></a>16369   $regexp = <span class="stringliteral">&#39;/&lt;link[^&gt;]*href=[&quot;\&#39;]([^&gt;&quot;\&#39;]*)[&quot;\&#39;][^&gt;]*?rel=[&quot;\&#39;]stylesheet[&quot;\&#39;].*?&gt;/si&#39;</span>;  <span class="comment">// EDIT mPDF 4.0</span>
<a name="l16370"></a>16370   $x = preg_match_all($regexp,$html,$cxt);
<a name="l16371"></a>16371   <span class="keywordflow">if</span> ($x) { 
<a name="l16372"></a>16372     $match += $x; 
<a name="l16373"></a>16373     $CSSext = array_merge($CSSext,$cxt[1]);
<a name="l16374"></a>16374   }
<a name="l16375"></a>16375 
<a name="l16376"></a>16376   <span class="comment">// look for @import stylesheets</span>
<a name="l16377"></a>16377   $regexp = <span class="stringliteral">&#39;/@import url\([\&#39;\&quot;]{0,1}([^\)]*?\.css)[\&#39;\&quot;]{0,1}\)/si&#39;</span>; <span class="comment">// EDIT mPDF 4.0</span>
<a name="l16378"></a>16378   $x = preg_match_all($regexp,$html,$cxt);
<a name="l16379"></a>16379   <span class="keywordflow">if</span> ($x) { 
<a name="l16380"></a>16380     $match += $x; 
<a name="l16381"></a>16381     $CSSext = array_merge($CSSext,$cxt[1]);
<a name="l16382"></a>16382   }
<a name="l16383"></a>16383   <span class="comment">// mPDF 4.0</span>
<a name="l16384"></a>16384   <span class="comment">// look for @import without the url()</span>
<a name="l16385"></a>16385   $regexp = <span class="stringliteral">&#39;/@import [\&#39;\&quot;]{0,1}([^;]*?\.css)[\&#39;\&quot;]{0,1}/si&#39;</span>;
<a name="l16386"></a>16386   $x = preg_match_all($regexp,$html,$cxt);
<a name="l16387"></a>16387   <span class="keywordflow">if</span> ($x) { 
<a name="l16388"></a>16388     $match += $x; 
<a name="l16389"></a>16389     $CSSext = array_merge($CSSext,$cxt[1]);
<a name="l16390"></a>16390   }
<a name="l16391"></a>16391 
<a name="l16392"></a>16392   $ind = 0;
<a name="l16393"></a>16393   $CSSstr = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16394"></a>16394 
<a name="l16395"></a>16395   <span class="comment">// Edited mPDF v1.4</span>
<a name="l16396"></a>16396   <span class="keywordflow">if</span> (!is_array($this-&gt;cascadeCSS)) $this-&gt;cascadeCSS = array();
<a name="l16397"></a>16397 
<a name="l16398"></a>16398     <span class="keywordflow">while</span>($match){
<a name="l16399"></a>16399   $path = $CSSext[$ind];
<a name="l16400"></a>16400   $this-&gt;GetFullPath($path); <span class="comment">// mPDF 4.0</span>
<a name="l16401"></a>16401   $CSSextblock = $this-&gt;_get_file($path);
<a name="l16402"></a>16402   <span class="keywordflow">if</span> ($CSSextblock) {
<a name="l16403"></a>16403     <span class="comment">// mPDF 4.0</span>
<a name="l16404"></a>16404     <span class="comment">// look for embedded @import stylesheets in other stylesheets</span>
<a name="l16405"></a>16405     <span class="comment">// and fix url paths (including background-images) relative to stylesheet</span>
<a name="l16406"></a>16406     $regexpem = <span class="stringliteral">&#39;/@import url\([\&#39;\&quot;]{0,1}(.*?\.css)[\&#39;\&quot;]{0,1}\)/si&#39;</span>;
<a name="l16407"></a>16407     $xem = preg_match_all($regexpem,$CSSextblock,$cxtem);
<a name="l16408"></a>16408     $cssBasePath = preg_replace(<span class="stringliteral">&#39;/\/[^\/]*$/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$path) . <span class="charliteral">&#39;/&#39;</span>;
<a name="l16409"></a>16409     <span class="keywordflow">if</span> ($xem) { 
<a name="l16410"></a>16410        <span class="keywordflow">foreach</span>($cxtem[1] AS $cxtembedded) {
<a name="l16411"></a>16411       <span class="comment">// path is relative to original stlyesheet!!</span>
<a name="l16412"></a>16412       $this-&gt;GetFullPath($cxtembedded, $cssBasePath );
<a name="l16413"></a>16413       $match++; 
<a name="l16414"></a>16414       $CSSext[] = $cxtembedded;
<a name="l16415"></a>16415        }
<a name="l16416"></a>16416     }
<a name="l16417"></a>16417     $regexpem = <span class="stringliteral">&#39;/(background[^;]*url\s*\(\s*[\&#39;\&quot;]{0,1})([^\)\&#39;\&quot;]*)([\&#39;\&quot;]{0,1}\s*\))/si&#39;</span>;
<a name="l16418"></a>16418     $xem = preg_match_all($regexpem,$CSSextblock,$cxtem);
<a name="l16419"></a>16419     <span class="keywordflow">if</span> ($xem) { 
<a name="l16420"></a>16420        <span class="keywordflow">for</span> ($i=0;$i&lt;count($cxtem[0]);$i++) {
<a name="l16421"></a>16421       <span class="comment">// path is relative to original stlyesheet!!</span>
<a name="l16422"></a>16422       $embedded = $cxtem[2][$i];
<a name="l16423"></a>16423       $this-&gt;GetFullPath($embedded, $cssBasePath );
<a name="l16424"></a>16424       $CSSextblock = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($cxtem[0][$i],<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>, ($cxtem[1][$i].$embedded.$cxtem[3][$i]), $CSSextblock);
<a name="l16425"></a>16425        }
<a name="l16426"></a>16426     }
<a name="l16427"></a>16427     $CSSstr .= <span class="charliteral">&#39; &#39;</span>.$CSSextblock;
<a name="l16428"></a>16428   } 
<a name="l16429"></a>16429 
<a name="l16430"></a>16430   $match--;
<a name="l16431"></a>16431   $ind++;
<a name="l16432"></a>16432     } <span class="comment">//end of match</span>
<a name="l16433"></a>16433     $match = 0; <span class="comment">// reset value, if needed</span>
<a name="l16434"></a>16434   <span class="comment">// CSS as &lt;style&gt; in HTML document</span>
<a name="l16435"></a>16435     $regexp = <span class="stringliteral">&#39;/&lt;style.*?&gt;(.*?)&lt;\/style&gt;/si&#39;</span>; 
<a name="l16436"></a>16436     $match = preg_match_all($regexp,$html,$CSSblock);
<a name="l16437"></a>16437     <span class="keywordflow">if</span> ($match) {
<a name="l16438"></a>16438     <span class="comment">// mPDF 4.0</span>
<a name="l16439"></a>16439     $tmpCSSstr = implode(<span class="charliteral">&#39; &#39;</span>,$CSSblock[1]);
<a name="l16440"></a>16440     $regexpem = <span class="stringliteral">&#39;/(background[^;]*url\s*\(\s*[\&#39;\&quot;]{0,1})([^\)\&#39;\&quot;]*)([\&#39;\&quot;]{0,1}\s*\))/si&#39;</span>;
<a name="l16441"></a>16441     $xem = preg_match_all($regexpem,$tmpCSSstr ,$cxtem);
<a name="l16442"></a>16442     <span class="keywordflow">if</span> ($xem) { 
<a name="l16443"></a>16443        <span class="keywordflow">for</span> ($i=0;$i&lt;count($cxtem[0]);$i++) {
<a name="l16444"></a>16444       $embedded = $cxtem[2][$i];
<a name="l16445"></a>16445       $this-&gt;GetFullPath($embedded);
<a name="l16446"></a>16446       $tmpCSSstr = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($cxtem[0][$i],<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>, ($cxtem[1][$i].$embedded.$cxtem[3][$i]), $tmpCSSstr );
<a name="l16447"></a>16447        }
<a name="l16448"></a>16448     }
<a name="l16449"></a>16449     $CSSstr .= <span class="charliteral">&#39; &#39;</span>.$tmpCSSstr;
<a name="l16450"></a>16450     }
<a name="l16451"></a>16451     <span class="comment">// Remove comments</span>
<a name="l16452"></a>16452     $CSSstr = preg_replace(<span class="stringliteral">&#39;|/\*.*?\*/|s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16453"></a>16453     $CSSstr = preg_replace(<span class="stringliteral">&#39;/[\s\n\r\t\f]/s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16454"></a>16454 
<a name="l16455"></a>16455     <span class="comment">// mPDF 4.3.001</span>
<a name="l16456"></a>16456     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/@media/&#39;</span>,$CSSstr)) { 
<a name="l16457"></a>16457   preg_match_all(<span class="stringliteral">&#39;/@media(.*?)\{(([^\{\}]*\{[^\{\}]*\})+)\s*\}/is&#39;</span>,$CSSstr,$m);
<a name="l16458"></a>16458   <span class="keywordflow">for</span>($i=0; $i&lt;count($m[0]); $i++) {
<a name="l16459"></a>16459     <span class="keywordflow">if</span> ($this-&gt;CSSselectMedia &amp;&amp; !preg_match(<span class="stringliteral">&#39;/(&#39;</span>.trim($this-&gt;CSSselectMedia).<span class="stringliteral">&#39;|all)/i&#39;</span>,$m[1][$i])) { 
<a name="l16460"></a>16460       $CSSstr = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($m[0][$i],<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$CSSstr);
<a name="l16461"></a>16461     }
<a name="l16462"></a>16462     <span class="keywordflow">else</span> {
<a name="l16463"></a>16463       $CSSstr = preg_replace(<span class="charliteral">&#39;/&#39;</span>.preg_quote($m[0][$i],<span class="charliteral">&#39;/&#39;</span>).<span class="charliteral">&#39;/&#39;</span>,<span class="charliteral">&#39; &#39;</span>.$m[2][$i].<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16464"></a>16464     }
<a name="l16465"></a>16465   }
<a name="l16466"></a>16466     }
<a name="l16467"></a>16467 
<a name="l16468"></a>16468     $CSSstr = preg_replace(<span class="stringliteral">&#39;/(&lt;\!\-\-|\-\-&gt;)/s&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$CSSstr);
<a name="l16469"></a>16469     <span class="keywordflow">if</span> ($CSSstr ) {
<a name="l16470"></a>16470   preg_match_all(<span class="stringliteral">&#39;/(.*?)\{(.*?)\}/&#39;</span>,$CSSstr,$styles);
<a name="l16471"></a>16471   <span class="keywordflow">for</span>($i=0; $i &lt; count($styles[1]) ; $i++)  {
<a name="l16472"></a>16472     <span class="comment">// SET array e.g. $classproperties[&#39;COLOR&#39;] = &#39;#ffffff&#39;;</span>
<a name="l16473"></a>16473     $stylestr= trim($styles[2][$i]);
<a name="l16474"></a>16474     $stylearr = explode(<span class="charliteral">&#39;;&#39;</span>,$stylestr);
<a name="l16475"></a>16475     <span class="keywordflow">foreach</span>($stylearr AS $sta) {
<a name="l16476"></a>16476        <span class="keywordflow">if</span> (trim($sta)) { 
<a name="l16477"></a>16477       <span class="comment">// mPDF 3.0</span>
<a name="l16478"></a>16478       <span class="comment">// Changed to allow style=&quot;background: url(&#39;http://www.bpm1.com/bg.jpg&#39;)&quot;</span>
<a name="l16479"></a>16479       list($property,$value) = explode(<span class="charliteral">&#39;:&#39;</span>,$sta,2);
<a name="l16480"></a>16480       $property = trim($property);
<a name="l16481"></a>16481       $value = preg_replace(<span class="stringliteral">&#39;/\s*!important/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$value);
<a name="l16482"></a>16482       $value = trim($value);
<a name="l16483"></a>16483       <span class="keywordflow">if</span> ($property &amp;&amp; ($value || $value===<span class="charliteral">&#39;0&#39;</span>)) {
<a name="l16484"></a>16484           $classproperties[strtoupper($property)] = $value;
<a name="l16485"></a>16485       }
<a name="l16486"></a>16486        }
<a name="l16487"></a>16487     }
<a name="l16488"></a>16488     $classproperties = $this-&gt;fixCSS($classproperties);
<a name="l16489"></a>16489     $tagstr = strtoupper(trim($styles[1][$i]));
<a name="l16490"></a>16490     $tagarr = explode(<span class="charliteral">&#39;,&#39;</span>,$tagstr);
<a name="l16491"></a>16491     $pageselectors = <span class="keyword">false</span>; <span class="comment">// used to turn on $this-&gt;mirrorMargins</span>
<a name="l16492"></a>16492     <span class="keywordflow">foreach</span>($tagarr AS $tg) {
<a name="l16493"></a>16493       $tags = preg_split(<span class="stringliteral">&#39;/\s+/&#39;</span>,trim($tg));
<a name="l16494"></a>16494       $level = count($tags);
<a name="l16495"></a>16495       $t = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16496"></a>16496       $t2 = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16497"></a>16497       $t3 = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16498"></a>16498       <span class="keywordflow">if</span> (trim($tags[0])==<span class="stringliteral">&#39;@PAGE&#39;</span>) {
<a name="l16499"></a>16499       <span class="keywordflow">if</span> (isset($tags[0])) { $t = trim($tags[0]); }
<a name="l16500"></a>16500       <span class="keywordflow">if</span> (isset($tags[1])) { $t2 = trim($tags[1]); }
<a name="l16501"></a>16501       <span class="keywordflow">if</span> (isset($tags[2])) { $t3 = trim($tags[2]); }
<a name="l16502"></a>16502       $tag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16503"></a>16503       <span class="keywordflow">if</span> ($level==1) { $tag = $t; }
<a name="l16504"></a>16504       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($level==2 &amp;&amp; preg_match(<span class="stringliteral">&#39;/^[:](.*)$/&#39;</span>,$t2,$m)) { 
<a name="l16505"></a>16505         $tag = $t.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;&#39;</span>.$m[1]; 
<a name="l16506"></a>16506         <span class="keywordflow">if</span> ($m[1]==<span class="stringliteral">&#39;LEFT&#39;</span> || $m[1]==<span class="stringliteral">&#39;RIGHT&#39;</span>) { $pageselectors = <span class="keyword">true</span>; } <span class="comment">// used to turn on $this-&gt;mirrorMargins </span>
<a name="l16507"></a>16507       }
<a name="l16508"></a>16508       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($level==2) { $tag = $t.<span class="stringliteral">&#39;&gt;&gt;NAMED&gt;&gt;&#39;</span>.$t2; }
<a name="l16509"></a>16509       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($level==3 &amp;&amp; preg_match(<span class="stringliteral">&#39;/^[:](.*)$/&#39;</span>,$t3,$m)) { 
<a name="l16510"></a>16510         $tag = $t.<span class="stringliteral">&#39;&gt;&gt;NAMED&gt;&gt;&#39;</span>.$t2.<span class="stringliteral">&#39;&gt;&gt;PSEUDO&gt;&gt;&#39;</span>.$m[1]; 
<a name="l16511"></a>16511         <span class="keywordflow">if</span> ($m[1]==<span class="stringliteral">&#39;LEFT&#39;</span> || $m[1]==<span class="stringliteral">&#39;RIGHT&#39;</span>) { $pageselectors = <span class="keyword">true</span>; } <span class="comment">// used to turn on $this-&gt;mirrorMargins</span>
<a name="l16512"></a>16512       }
<a name="l16513"></a>16513       <span class="keywordflow">if</span> (isset($this-&gt;CSS[$tag]) &amp;&amp; $tag) { $this-&gt;CSS[$tag] = $this-&gt;array_merge_recursive_unique($this-&gt;CSS[$tag], $classproperties); }
<a name="l16514"></a>16514       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag) { $this-&gt;CSS[$tag] = $classproperties; }
<a name="l16515"></a>16515       }
<a name="l16516"></a>16516 
<a name="l16517"></a>16517       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($level == 1) {   <span class="comment">// e.g. p or .class or #id or p.class or p#id</span>
<a name="l16518"></a>16518          <span class="keywordflow">if</span> (isset($tags[0])) { $t = trim($tags[0]); }
<a name="l16519"></a>16519          <span class="keywordflow">if</span> ($t) {
<a name="l16520"></a>16520       $tag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16521"></a>16521       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^[.](.*)$/&#39;</span>,$t,$m)) { $tag = <span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$m[1]; }
<a name="l16522"></a>16522       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^[#](.*)$/&#39;</span>,$t,$m)) { $tag = <span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$m[1]; }
<a name="l16523"></a>16523       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)[.](.*)$/&#39;</span>,$t,$m)) { $tag = $m[1].<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$m[2]; }
<a name="l16524"></a>16524       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)[#](.*)$/&#39;</span>,$t,$m)) { $tag = $m[1].<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$m[2]; }
<a name="l16525"></a>16525       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)$/&#39;</span>,$t)) { $tag= $t; }
<a name="l16526"></a>16526 
<a name="l16527"></a>16527       <span class="keywordflow">if</span> (isset($this-&gt;CSS[$tag]) &amp;&amp; $tag) { $this-&gt;CSS[$tag] = $this-&gt;array_merge_recursive_unique($this-&gt;CSS[$tag], $classproperties); }
<a name="l16528"></a>16528       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tag) { $this-&gt;CSS[$tag] = $classproperties; }
<a name="l16529"></a>16529          }
<a name="l16530"></a>16530       }
<a name="l16531"></a>16531       <span class="keywordflow">else</span> {
<a name="l16532"></a>16532        $tmp = array();
<a name="l16533"></a>16533        <span class="keywordflow">for</span>($n=0;$n&lt;$level;$n++) {
<a name="l16534"></a>16534          <span class="keywordflow">if</span> (isset($tags[$n])) { $t = trim($tags[$n]); }
<a name="l16535"></a>16535          <span class="keywordflow">else</span> { $t = <span class="stringliteral">&#39;&#39;</span>; }  <span class="comment">// mPDF 4.0</span>
<a name="l16536"></a>16536          <span class="keywordflow">if</span> ($t) {
<a name="l16537"></a>16537       $tag = <span class="stringliteral">&#39;&#39;</span>;
<a name="l16538"></a>16538       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^[.](.*)$/&#39;</span>,$t,$m)) { $tag = <span class="stringliteral">&#39;CLASS&gt;&gt;&#39;</span>.$m[1]; }
<a name="l16539"></a>16539       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^[#](.*)$/&#39;</span>,$t,$m)) { $tag = <span class="stringliteral">&#39;ID&gt;&gt;&#39;</span>.$m[1]; }
<a name="l16540"></a>16540       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)[.](.*)$/&#39;</span>,$t,$m)) { $tag = $m[1].<span class="stringliteral">&#39;&gt;&gt;CLASS&gt;&gt;&#39;</span>.$m[2]; }
<a name="l16541"></a>16541       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)[#](.*)$/&#39;</span>,$t,$m)) { $tag = $m[1].<span class="stringliteral">&#39;&gt;&gt;ID&gt;&gt;&#39;</span>.$m[2]; }
<a name="l16542"></a>16542       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(&#39;</span>.$this-&gt;allowedCSStags.<span class="stringliteral">&#39;)$/&#39;</span>,$t)) { $tag= $t; }
<a name="l16543"></a>16543 
<a name="l16544"></a>16544       <span class="keywordflow">if</span> ($tag) $tmp[] = $tag;
<a name="l16545"></a>16545       <span class="comment">// mPDF 4.0</span>
<a name="l16546"></a>16546       <span class="keywordflow">else</span> { <span class="keywordflow">break</span>; }
<a name="l16547"></a>16547         }
<a name="l16548"></a>16548        }
<a name="l16549"></a>16549        <span class="comment">// mPDF 4.0</span>
<a name="l16550"></a>16550        <span class="keywordflow">if</span> ($tag) {
<a name="l16551"></a>16551          $x = &amp;$this-&gt;cascadeCSS; 
<a name="l16552"></a>16552          <span class="keywordflow">foreach</span>($tmp AS $tp) { $x = &amp;$x[$tp]; }
<a name="l16553"></a>16553          $x = $this-&gt;array_merge_recursive_unique($x, $classproperties); 
<a name="l16554"></a>16554          $x[<span class="stringliteral">&#39;depth&#39;</span>] = $level;
<a name="l16555"></a>16555        }
<a name="l16556"></a>16556       }
<a name="l16557"></a>16557     }
<a name="l16558"></a>16558     <span class="keywordflow">if</span> ($pageselectors) { $this-&gt;mirrorMargins = <span class="keyword">true</span>; }
<a name="l16559"></a>16559       $properties = array();
<a name="l16560"></a>16560       $values = array();
<a name="l16561"></a>16561       $classproperties = array();
<a name="l16562"></a>16562   }
<a name="l16563"></a>16563 
<a name="l16564"></a>16564     } <span class="comment">// end of if</span>
<a name="l16565"></a>16565     <span class="comment">//Remove CSS (tags and content), if any</span>
<a name="l16566"></a>16566     $regexp = <span class="stringliteral">&#39;/&lt;style.*?&gt;(.*?)&lt;\/style&gt;/si&#39;</span>; <span class="comment">// it can be &lt;style&gt; or &lt;style type=&quot;txt/css&quot;&gt; </span>
<a name="l16567"></a>16567     $html = preg_replace($regexp,<span class="stringliteral">&#39;&#39;</span>,$html);
<a name="l16568"></a>16568 <span class="comment">//print_r($this-&gt;CSS); exit;</span>
<a name="l16569"></a>16569 <span class="comment">//print_r($this-&gt;cascadeCSS); exit;</span>
<a name="l16570"></a>16570     <span class="keywordflow">return</span> $html;
<a name="l16571"></a>16571 }
<a name="l16572"></a>16572 
<a name="l16573"></a>16573 function readInlineCSS($html)
<a name="l16574"></a>16574 {
<a name="l16575"></a>16575   <span class="comment">//Fix incomplete CSS code</span>
<a name="l16576"></a>16576   $size = strlen($html)-1;
<a name="l16577"></a>16577   <span class="keywordflow">if</span> (substr($html,$size,1) != <span class="charliteral">&#39;;&#39;</span>) $html .= <span class="charliteral">&#39;;&#39;</span>;
<a name="l16578"></a>16578   <span class="comment">//Make CSS[Name-of-the-class] = array(key =&gt; value)</span>
<a name="l16579"></a>16579   $regexp = <span class="stringliteral">&#39;|\\s*?(\\S+?):(.+?);|i&#39;</span>;
<a name="l16580"></a>16580   preg_match_all( $regexp, $html, $styleinfo);
<a name="l16581"></a>16581   $properties = $styleinfo[1];
<a name="l16582"></a>16582   $values = $styleinfo[2];
<a name="l16583"></a>16583   <span class="comment">//Array-properties and Array-values must have the SAME SIZE!</span>
<a name="l16584"></a>16584   $classproperties = array();
<a name="l16585"></a>16585   <span class="keywordflow">for</span>($i = 0; $i &lt; count($properties) ; $i++) $classproperties[strtoupper($properties[$i])] = trim($values[$i]);
<a name="l16586"></a>16586   <span class="keywordflow">return</span> $this-&gt;fixCSS($classproperties);
<a name="l16587"></a>16587 }
<a name="l16588"></a>16588 
<a name="l16589"></a>16589 
<a name="l16590"></a>16590 
<a name="l16591"></a>16591 function setCSS($arrayaux,$type=<span class="stringliteral">&#39;&#39;</span>,$tag=<span class="stringliteral">&#39;&#39;</span>) <span class="comment">// type= INLINE | BLOCK // tag= BODY</span>
<a name="l16592"></a>16592 {
<a name="l16593"></a>16593   <span class="keywordflow">if</span> (!is_array($arrayaux)) <span class="keywordflow">return</span>; <span class="comment">//Removes PHP Warning</span>
<a name="l16594"></a>16594   <span class="comment">// Set font size first so that e.g. MARGIN 0.83em works on font size for this element</span>
<a name="l16595"></a>16595   <span class="keywordflow">if</span> (isset($arrayaux[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>])) {
<a name="l16596"></a>16596     $v = $arrayaux[<span class="stringliteral">&#39;FONT-SIZE&#39;</span>];
<a name="l16597"></a>16597     <span class="keywordflow">if</span>(is_numeric(substr($v,0,1))) {
<a name="l16598"></a>16598       $mmsize = $this-&gt;ConvertSize($v,$this-&gt;FontSize);
<a name="l16599"></a>16599       $this-&gt;SetFontSize( $mmsize*($this-&gt;k),<span class="keyword">false</span> ); <span class="comment">//Get size in points (pt)</span>
<a name="l16600"></a>16600     }
<a name="l16601"></a>16601     <span class="keywordflow">else</span>{
<a name="l16602"></a>16602         $v = strtoupper($v);
<a name="l16603"></a>16603       <span class="comment">// mPDF 4.0</span>
<a name="l16604"></a>16604       <span class="keywordflow">if</span> (isset($this-&gt;fontsizes[$v])) { 
<a name="l16605"></a>16605         $this-&gt;SetFontSize( $this-&gt;fontsizes[$v]* $this-&gt;default_font_size,<span class="keyword">false</span>);
<a name="l16606"></a>16606       }
<a name="l16607"></a>16607     }
<a name="l16608"></a>16608     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;BODY&#39;</span>) { $this-&gt;SetDefaultFontSize($this-&gt;FontSizePt); }
<a name="l16609"></a>16609   }
<a name="l16610"></a>16610 
<a name="l16611"></a>16611   <span class="keywordflow">if</span> (isset($arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>]) &amp;&amp; $this-&gt;useLang &amp;&amp; $arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>] &amp;&amp; $this-&gt;is_MB &amp;&amp; $arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>] != $this-&gt;default_lang &amp;&amp; ((strlen($arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>]) == 5 &amp;&amp; $arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>] != <span class="stringliteral">&#39;UTF-8&#39;</span>) || strlen($arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>]) == 2)) {
<a name="l16612"></a>16612     list ($codepage,$mpdf_pdf_unifonts,$mpdf_directionality,$mpdf_jSpacing) = GetCodepage($arrayaux[<span class="stringliteral">&#39;LANG&#39;</span>]);
<a name="l16613"></a>16613     <span class="keywordflow">if</span> ($mpdf_pdf_unifonts) { $this-&gt;RestrictUnicodeFonts($mpdf_pdf_unifonts); }
<a name="l16614"></a>16614     <span class="keywordflow">else</span> { $this-&gt;RestrictUnicodeFonts($this-&gt;default_available_fonts ); }
<a name="l16615"></a>16615     <span class="keywordflow">if</span> ($mpdf_directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $this-&gt;biDirectional = <span class="keyword">true</span>; }
<a name="l16616"></a>16616     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;BODY&#39;</span>) {
<a name="l16617"></a>16617       $this-&gt;jSpacing = $mpdf_jSpacing;
<a name="l16618"></a>16618       $this-&gt;SetDirectionality($mpdf_directionality);
<a name="l16619"></a>16619       $this-&gt;currentLang = $codepage;
<a name="l16620"></a>16620       $this-&gt;default_lang = $codepage;
<a name="l16621"></a>16621       $this-&gt;default_jSpacing = $mpdf_jSpacing;
<a name="l16622"></a>16622       <span class="keywordflow">if</span> ($mpdf_pdf_unifonts) { $this-&gt;default_available_fonts = $mpdf_pdf_unifonts; }
<a name="l16623"></a>16623       $this-&gt;default_dir = $mpdf_directionality;
<a name="l16624"></a>16624     }
<a name="l16625"></a>16625     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;BLOCK&#39;</span>) {
<a name="l16626"></a>16626       $this-&gt;jSpacing = $mpdf_jSpacing;
<a name="l16627"></a>16627     }
<a name="l16628"></a>16628     <span class="keywordflow">else</span> {  <span class="comment">// INLINE</span>
<a name="l16629"></a>16629       <span class="keywordflow">if</span> ($this-&gt;disableMultilingualJustify &amp;&amp; $mpdf_jSpacing != $this-&gt;jSpacing &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]==<span class="stringliteral">&quot;J&quot;</span>) {
<a name="l16630"></a>16630                 $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l16631"></a>16631       }
<a name="l16632"></a>16632     }
<a name="l16633"></a>16633   }
<a name="l16634"></a>16634   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;useLang &amp;&amp; $this-&gt;is_MB ) { 
<a name="l16635"></a>16635     $this-&gt;RestrictUnicodeFonts($this-&gt;default_available_fonts ); 
<a name="l16636"></a>16636     $this-&gt;jSpacing = $this-&gt;default_jSpacing;
<a name="l16637"></a>16637   }
<a name="l16638"></a>16638 
<a name="l16639"></a>16639 
<a name="l16640"></a>16640   <span class="comment">// FOR INLINE and BLOCK OR &#39;BODY&#39;</span>
<a name="l16641"></a>16641   <span class="keywordflow">if</span> (isset($arrayaux[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>])) {
<a name="l16642"></a>16642     $v = $arrayaux[<span class="stringliteral">&#39;FONT-FAMILY&#39;</span>];
<a name="l16643"></a>16643     <span class="comment">//If it is a font list, get all font types</span>
<a name="l16644"></a>16644     $aux_fontlist = explode(<span class="stringliteral">&quot;,&quot;</span>,$v);
<a name="l16645"></a>16645     $fonttype = $aux_fontlist[0];
<a name="l16646"></a>16646     $fonttype = strtolower(trim($fonttype));
<a name="l16647"></a>16647     <span class="keywordflow">if</span>(($fonttype == <span class="stringliteral">&#39;helvetica&#39;</span>) || ($fonttype == <span class="stringliteral">&#39;arial&#39;</span>)) { $fonttype = <span class="stringliteral">&#39;sans-serif&#39;</span>; }
<a name="l16648"></a>16648     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($fonttype == <span class="stringliteral">&#39;helvetica-embedded&#39;</span>)  { $fonttype = <span class="stringliteral">&#39;helvetica&#39;</span>; }
<a name="l16649"></a>16649     <span class="comment">// mPDF 4.0</span>
<a name="l16650"></a>16650     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($fonttype == <span class="stringliteral">&#39;courier-embedded&#39;</span>)  { $fonttype = <span class="stringliteral">&#39;courier&#39;</span>; }
<a name="l16651"></a>16651     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($fonttype == <span class="stringliteral">&#39;times-embedded&#39;</span>)  { $fonttype = <span class="stringliteral">&#39;times&#39;</span>; }
<a name="l16652"></a>16652     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($fonttype == <span class="stringliteral">&#39;times&#39;</span>)  { $fonttype = <span class="stringliteral">&#39;serif&#39;</span>; }
<a name="l16653"></a>16653     <span class="keywordflow">else</span> <span class="keywordflow">if</span>($fonttype == <span class="stringliteral">&#39;courier&#39;</span>)  { $fonttype = <span class="stringliteral">&#39;monospace&#39;</span>; }
<a name="l16654"></a>16654     <span class="keywordflow">if</span> ($tag == <span class="stringliteral">&#39;BODY&#39;</span>) { 
<a name="l16655"></a>16655       $this-&gt;SetDefaultFont($fonttype); 
<a name="l16656"></a>16656     }
<a name="l16657"></a>16657     $this-&gt;SetFont($fonttype,$this-&gt;currentfontstyle,0,<span class="keyword">false</span>);
<a name="l16658"></a>16658   }
<a name="l16659"></a>16659   <span class="keywordflow">else</span> { 
<a name="l16660"></a>16660     $this-&gt;SetFont($this-&gt;currentfontfamily,$this-&gt;currentfontstyle,0,<span class="keyword">false</span>); 
<a name="l16661"></a>16661   }
<a name="l16662"></a>16662 
<a name="l16663"></a>16663    <span class="keywordflow">foreach</span>($arrayaux as $k =&gt; $v) {
<a name="l16664"></a>16664   <span class="keywordflow">if</span> ($type != <span class="stringliteral">&#39;INLINE&#39;</span> &amp;&amp; $tag != <span class="stringliteral">&#39;BODY&#39;</span>) {
<a name="l16665"></a>16665     <span class="keywordflow">switch</span>($k){
<a name="l16666"></a>16666     <span class="comment">// BORDERS</span>
<a name="l16667"></a>16667     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BORDER-TOP&#39;</span>:
<a name="l16668"></a>16668       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>] = $this-&gt;border_details($v);
<a name="l16669"></a>16669       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_top&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border&#39;</span>] = 1; }
<a name="l16670"></a>16670       <span class="keywordflow">break</span>;
<a name="l16671"></a>16671     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BORDER-BOTTOM&#39;</span>:
<a name="l16672"></a>16672       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>] = $this-&gt;border_details($v);
<a name="l16673"></a>16673       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border&#39;</span>] = 1; }
<a name="l16674"></a>16674       <span class="keywordflow">break</span>;
<a name="l16675"></a>16675     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BORDER-LEFT&#39;</span>:
<a name="l16676"></a>16676       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>] = $this-&gt;border_details($v);
<a name="l16677"></a>16677       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border&#39;</span>] = 1; }
<a name="l16678"></a>16678       <span class="keywordflow">break</span>;
<a name="l16679"></a>16679     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BORDER-RIGHT&#39;</span>:
<a name="l16680"></a>16680       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>] = $this-&gt;border_details($v);
<a name="l16681"></a>16681       <span class="keywordflow">if</span> ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_right&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border&#39;</span>] = 1; }
<a name="l16682"></a>16682       <span class="keywordflow">break</span>;
<a name="l16683"></a>16683 
<a name="l16684"></a>16684     <span class="comment">// PADDING</span>
<a name="l16685"></a>16685     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PADDING-TOP&#39;</span>:
<a name="l16686"></a>16686       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_top&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16687"></a>16687       <span class="keywordflow">break</span>;
<a name="l16688"></a>16688     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PADDING-BOTTOM&#39;</span>:
<a name="l16689"></a>16689       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16690"></a>16690       <span class="keywordflow">break</span>;
<a name="l16691"></a>16691     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PADDING-LEFT&#39;</span>:
<a name="l16692"></a>16692       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16693"></a>16693       <span class="keywordflow">break</span>;
<a name="l16694"></a>16694     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PADDING-RIGHT&#39;</span>:
<a name="l16695"></a>16695       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_right&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16696"></a>16696       <span class="keywordflow">break</span>;
<a name="l16697"></a>16697 
<a name="l16698"></a>16698     <span class="comment">// MARGINS</span>
<a name="l16699"></a>16699     <span class="keywordflow">case</span> <span class="stringliteral">&#39;MARGIN-TOP&#39;</span>:
<a name="l16700"></a>16700       <span class="comment">// mPDF 4.2 Collaspe vertical block margins</span>
<a name="l16701"></a>16701       $tmp = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16702"></a>16702       <span class="keywordflow">if</span> (isset($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;lastbottommargin&#39;</span>])) {
<a name="l16703"></a>16703         <span class="keywordflow">if</span> ($tmp &gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;lastbottommargin&#39;</span>]) {
<a name="l16704"></a>16704           $tmp -= $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;lastbottommargin&#39;</span>];
<a name="l16705"></a>16705         }
<a name="l16706"></a>16706         <span class="keywordflow">else</span> { 
<a name="l16707"></a>16707           $tmp = 0;
<a name="l16708"></a>16708         }
<a name="l16709"></a>16709       }
<a name="l16710"></a>16710       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_top&#39;</span>] = $tmp;
<a name="l16711"></a>16711       <span class="keywordflow">break</span>;
<a name="l16712"></a>16712     <span class="keywordflow">case</span> <span class="stringliteral">&#39;MARGIN-BOTTOM&#39;</span>:
<a name="l16713"></a>16713       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_bottom&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16714"></a>16714       <span class="keywordflow">break</span>;
<a name="l16715"></a>16715     <span class="keywordflow">case</span> <span class="stringliteral">&#39;MARGIN-LEFT&#39;</span>:
<a name="l16716"></a>16716       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_left&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16717"></a>16717       <span class="keywordflow">break</span>;
<a name="l16718"></a>16718     <span class="keywordflow">case</span> <span class="stringliteral">&#39;MARGIN-RIGHT&#39;</span>:
<a name="l16719"></a>16719       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_right&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>);
<a name="l16720"></a>16720       <span class="keywordflow">break</span>;
<a name="l16721"></a>16721 
<a name="l16722"></a>16722 
<a name="l16723"></a>16723     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BACKGROUND-CLIP&#39;</span>:
<a name="l16724"></a>16724       <span class="keywordflow">if</span> (strtoupper($v) == <span class="stringliteral">&#39;PADDING-BOX&#39;</span>) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;background_clip&#39;</span>] = <span class="stringliteral">&#39;padding-box&#39;</span>; }
<a name="l16725"></a>16725       <span class="keywordflow">break</span>;
<a name="l16726"></a>16726 
<a name="l16727"></a>16727     <span class="keywordflow">case</span> <span class="stringliteral">&#39;PAGE-BREAK-AFTER&#39;</span>:
<a name="l16728"></a>16728       <span class="keywordflow">if</span> (strtoupper($v) == <span class="stringliteral">&#39;AVOID&#39;</span>) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;page_break_after_avoid&#39;</span>] = <span class="keyword">true</span>; }
<a name="l16729"></a>16729       <span class="keywordflow">break</span>;
<a name="l16730"></a>16730 
<a name="l16731"></a>16731     <span class="keywordflow">case</span> <span class="stringliteral">&#39;WIDTH&#39;</span>:
<a name="l16732"></a>16732       <span class="comment">// mPDF 4.0 Allow em support and avoid &#39;auto&#39;</span>
<a name="l16733"></a>16733       <span class="keywordflow">if</span> (strtoupper($v) != <span class="stringliteral">&#39;AUTO&#39;</span>) { 
<a name="l16734"></a>16734         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;css_set_width&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize,<span class="keyword">false</span>); 
<a name="l16735"></a>16735       }
<a name="l16736"></a>16736       <span class="keywordflow">break</span>;
<a name="l16737"></a>16737 
<a name="l16738"></a>16738     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TEXT-INDENT&#39;</span>:
<a name="l16739"></a>16739       <span class="comment">// mPDF 4.0 Left as raw value (may include 1% or 2em)</span>
<a name="l16740"></a>16740       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;text_indent&#39;</span>] = $v;
<a name="l16741"></a>16741       <span class="keywordflow">break</span>;
<a name="l16742"></a>16742 
<a name="l16743"></a>16743     }<span class="comment">//end of switch($k)</span>
<a name="l16744"></a>16744   }
<a name="l16745"></a>16745 
<a name="l16746"></a>16746 
<a name="l16747"></a>16747   <span class="keywordflow">if</span> ($type != <span class="stringliteral">&#39;INLINE&#39;</span>) {  <span class="comment">// includes BODY tag</span>
<a name="l16748"></a>16748     <span class="keywordflow">switch</span>($k){
<a name="l16749"></a>16749 
<a name="l16750"></a>16750     <span class="keywordflow">case</span> <span class="stringliteral">&#39;MARGIN-COLLAPSE&#39;</span>: <span class="comment">// Custom tag to collapse margins at top and bottom of page</span>
<a name="l16751"></a>16751       <span class="keywordflow">if</span> (strtoupper($v) == <span class="stringliteral">&#39;COLLAPSE&#39;</span>) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;margin_collapse&#39;</span>] = <span class="keyword">true</span>; }
<a name="l16752"></a>16752       <span class="keywordflow">break</span>;
<a name="l16753"></a>16753 
<a name="l16754"></a>16754     <span class="keywordflow">case</span> <span class="stringliteral">&#39;LINE-HEIGHT&#39;</span>: 
<a name="l16755"></a>16755       <span class="comment">// mPDF 4.2</span>
<a name="l16756"></a>16756       $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>] = $this-&gt;fixLineheight($v);
<a name="l16757"></a>16757       <span class="keywordflow">if</span> (!$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>] ) { $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;line_height&#39;</span>] = $this-&gt;normalLineheight; }
<a name="l16758"></a>16758       <span class="keywordflow">break</span>;
<a name="l16759"></a>16759 
<a name="l16760"></a>16760     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>: <span class="comment">//left right center justify</span>
<a name="l16761"></a>16761       <span class="keywordflow">switch</span> (strtoupper($v)) {
<a name="l16762"></a>16762         <span class="keywordflow">case</span> <span class="stringliteral">&#39;LEFT&#39;</span>: 
<a name="l16763"></a>16763                         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]=<span class="stringliteral">&quot;L&quot;</span>;
<a name="l16764"></a>16764                         <span class="keywordflow">break</span>;
<a name="l16765"></a>16765         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CENTER&#39;</span>: 
<a name="l16766"></a>16766                         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]=<span class="stringliteral">&quot;C&quot;</span>;
<a name="l16767"></a>16767                         <span class="keywordflow">break</span>;
<a name="l16768"></a>16768         <span class="keywordflow">case</span> <span class="stringliteral">&#39;RIGHT&#39;</span>: 
<a name="l16769"></a>16769                         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]=<span class="stringliteral">&quot;R&quot;</span>;
<a name="l16770"></a>16770                         <span class="keywordflow">break</span>;
<a name="l16771"></a>16771         <span class="keywordflow">case</span> <span class="stringliteral">&#39;JUSTIFY&#39;</span>: 
<a name="l16772"></a>16772                         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]=<span class="stringliteral">&quot;J&quot;</span>;
<a name="l16773"></a>16773                         <span class="keywordflow">break</span>;
<a name="l16774"></a>16774       }
<a name="l16775"></a>16775       <span class="keywordflow">break</span>;
<a name="l16776"></a>16776 
<a name="l16777"></a>16777     }<span class="comment">//end of switch($k)</span>
<a name="l16778"></a>16778   }
<a name="l16779"></a>16779 
<a name="l16780"></a>16780 
<a name="l16781"></a>16781   <span class="comment">// FOR INLINE and BLOCK</span>
<a name="l16782"></a>16782     <span class="keywordflow">switch</span>($k){
<a name="l16783"></a>16783     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TEXT-ALIGN&#39;</span>: <span class="comment">//left right center justify</span>
<a name="l16784"></a>16784       <span class="keywordflow">if</span> (strtoupper($v) == <span class="stringliteral">&#39;NOJUSTIFY&#39;</span> &amp;&amp; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]==<span class="stringliteral">&quot;J&quot;</span>) {
<a name="l16785"></a>16785                         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;align&#39;</span>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l16786"></a>16786       }
<a name="l16787"></a>16787       <span class="keywordflow">break</span>;
<a name="l16788"></a>16788     <span class="comment">// bgcolor only - to stay consistent with original html2fpdf</span>
<a name="l16789"></a>16789     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BACKGROUND&#39;</span>: 
<a name="l16790"></a>16790     <span class="keywordflow">case</span> <span class="stringliteral">&#39;BACKGROUND-COLOR&#39;</span>: 
<a name="l16791"></a>16791       $cor = $this-&gt;ConvertColor($v);
<a name="l16792"></a>16792       <span class="keywordflow">if</span> ($cor) { 
<a name="l16793"></a>16793          <span class="comment">// mPDF 3.0</span>
<a name="l16794"></a>16794          <span class="keywordflow">if</span> ($tag  == <span class="stringliteral">&#39;BODY&#39;</span>) {
<a name="l16795"></a>16795         $this-&gt;bodyBackgroundColor = $cor;
<a name="l16796"></a>16796          }
<a name="l16797"></a>16797          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;INLINE&#39;</span>) {
<a name="l16798"></a>16798         $this-&gt;spanbgcolorarray = $cor;
<a name="l16799"></a>16799         $this-&gt;spanbgcolor = <span class="keyword">true</span>;
<a name="l16800"></a>16800          }
<a name="l16801"></a>16801          <span class="keywordflow">else</span> {
<a name="l16802"></a>16802         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>] = $cor;
<a name="l16803"></a>16803         $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">true</span>;
<a name="l16804"></a>16804          }
<a name="l16805"></a>16805       }
<a name="l16806"></a>16806       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type != <span class="stringliteral">&#39;INLINE&#39;</span>) {
<a name="l16807"></a>16807           <span class="comment">// mPDF 3.0</span>
<a name="l16808"></a>16808           <span class="keywordflow">if</span> ($this-&gt;ColActive || $this-&gt;keep_block_together) { 
<a name="l16809"></a>16809           $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolorarray&#39;</span>] = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;bgcolorarray&#39;</span>] ;
<a name="l16810"></a>16810           $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $this-&gt;blk[$this-&gt;blklvl-1][<span class="stringliteral">&#39;bgcolor&#39;</span>] ;
<a name="l16811"></a>16811         }
<a name="l16812"></a>16812       }
<a name="l16813"></a>16813       <span class="keywordflow">break</span>;
<a name="l16814"></a>16814 
<a name="l16815"></a>16815 
<a name="l16816"></a>16816 
<a name="l16817"></a>16817     <span class="keywordflow">case</span> <span class="stringliteral">&#39;FONT-STYLE&#39;</span>: <span class="comment">// italic normal oblique</span>
<a name="l16818"></a>16818       <span class="keywordflow">switch</span> (strtoupper($v)) {
<a name="l16819"></a>16819         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ITALIC&#39;</span>: 
<a name="l16820"></a>16820         <span class="keywordflow">case</span> <span class="stringliteral">&#39;OBLIQUE&#39;</span>: 
<a name="l16821"></a>16821                   $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>);
<a name="l16822"></a>16822           <span class="keywordflow">break</span>;
<a name="l16823"></a>16823         <span class="keywordflow">case</span> <span class="stringliteral">&#39;NORMAL&#39;</span>: 
<a name="l16824"></a>16824                   $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l16825"></a>16825           <span class="keywordflow">break</span>;
<a name="l16826"></a>16826       }
<a name="l16827"></a>16827       <span class="keywordflow">break</span>;
<a name="l16828"></a>16828 
<a name="l16829"></a>16829     <span class="keywordflow">case</span> <span class="stringliteral">&#39;FONT-WEIGHT&#39;</span>: <span class="comment">// normal bold //Does not support: bolder, lighter, 100..900(step value=100)</span>
<a name="l16830"></a>16830       <span class="keywordflow">switch</span> (strtoupper($v)) {
<a name="l16831"></a>16831         <span class="keywordflow">case</span> <span class="stringliteral">&#39;BOLD&#39;</span>: 
<a name="l16832"></a>16832                   $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>);
<a name="l16833"></a>16833           <span class="keywordflow">break</span>;
<a name="l16834"></a>16834         <span class="keywordflow">case</span> <span class="stringliteral">&#39;NORMAL&#39;</span>: 
<a name="l16835"></a>16835                   $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l16836"></a>16836           <span class="keywordflow">break</span>;
<a name="l16837"></a>16837       }
<a name="l16838"></a>16838       <span class="keywordflow">break</span>;
<a name="l16839"></a>16839 
<a name="l16840"></a>16840     <span class="keywordflow">case</span> <span class="stringliteral">&#39;VERTICAL-ALIGN&#39;</span>: <span class="comment">//super and sub only dealt with here e.g. &lt;SUB&gt; and &lt;SUP&gt;</span>
<a name="l16841"></a>16841       <span class="keywordflow">switch</span> (strtoupper($v)) {
<a name="l16842"></a>16842         <span class="keywordflow">case</span> <span class="stringliteral">&#39;SUPER&#39;</span>: 
<a name="l16843"></a>16843                         $this-&gt;SUP=<span class="keyword">true</span>;
<a name="l16844"></a>16844                         <span class="keywordflow">break</span>;
<a name="l16845"></a>16845         <span class="keywordflow">case</span> <span class="stringliteral">&#39;SUB&#39;</span>: 
<a name="l16846"></a>16846                         $this-&gt;SUB=<span class="keyword">true</span>;
<a name="l16847"></a>16847                         <span class="keywordflow">break</span>;
<a name="l16848"></a>16848       }
<a name="l16849"></a>16849       <span class="keywordflow">break</span>;
<a name="l16850"></a>16850 
<a name="l16851"></a>16851     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TEXT-DECORATION&#39;</span>: <span class="comment">// none underline line-through (strikeout) //Does not support: overline, blink</span>
<a name="l16852"></a>16852       <span class="keywordflow">if</span> (stristr($v,<span class="stringliteral">&#39;LINE-THROUGH&#39;</span>)) {
<a name="l16853"></a>16853           $this-&gt;strike = <span class="keyword">true</span>;
<a name="l16854"></a>16854       }
<a name="l16855"></a>16855       <span class="keywordflow">if</span> (stristr($v,<span class="stringliteral">&#39;UNDERLINE&#39;</span>)) {
<a name="l16856"></a>16856                   $this-&gt;SetStyle(<span class="charliteral">&#39;U&#39;</span>,<span class="keyword">true</span>);
<a name="l16857"></a>16857       }
<a name="l16858"></a>16858       <span class="keywordflow">break</span>;
<a name="l16859"></a>16859 
<a name="l16860"></a>16860     <span class="keywordflow">case</span> <span class="stringliteral">&#39;TEXT-TRANSFORM&#39;</span>: <span class="comment">// none uppercase lowercase //Does not support: capitalize</span>
<a name="l16861"></a>16861       <span class="keywordflow">switch</span> (strtoupper($v)) { <span class="comment">//Not working 100%</span>
<a name="l16862"></a>16862         <span class="keywordflow">case</span> <span class="stringliteral">&#39;UPPERCASE&#39;</span>:
<a name="l16863"></a>16863           $this-&gt;toupper=<span class="keyword">true</span>;
<a name="l16864"></a>16864           <span class="keywordflow">break</span>;
<a name="l16865"></a>16865         <span class="keywordflow">case</span> <span class="stringliteral">&#39;LOWERCASE&#39;</span>:
<a name="l16866"></a>16866           $this-&gt;tolower=<span class="keyword">true</span>;
<a name="l16867"></a>16867           <span class="keywordflow">break</span>;
<a name="l16868"></a>16868         <span class="keywordflow">case</span> <span class="stringliteral">&#39;NONE&#39;</span>: <span class="keywordflow">break</span>;
<a name="l16869"></a>16869       }
<a name="l16870"></a>16870       <span class="keywordflow">break</span>;
<a name="l16871"></a>16871 
<a name="l16872"></a>16872     <span class="keywordflow">case</span> <span class="stringliteral">&#39;OUTLINE-WIDTH&#39;</span>: 
<a name="l16873"></a>16873       <span class="keywordflow">switch</span>(strtoupper($v)) {
<a name="l16874"></a>16874         <span class="keywordflow">case</span> <span class="stringliteral">&#39;THIN&#39;</span>: $v = <span class="stringliteral">&#39;0.03em&#39;</span>; <span class="keywordflow">break</span>;
<a name="l16875"></a>16875         <span class="keywordflow">case</span> <span class="stringliteral">&#39;MEDIUM&#39;</span>: $v = <span class="stringliteral">&#39;0.05em&#39;</span>; <span class="keywordflow">break</span>;
<a name="l16876"></a>16876         <span class="keywordflow">case</span> <span class="stringliteral">&#39;THICK&#39;</span>: $v = <span class="stringliteral">&#39;0.07em&#39;</span>; <span class="keywordflow">break</span>;
<a name="l16877"></a>16877       }
<a name="l16878"></a>16878       $this-&gt;outlineparam[<span class="stringliteral">&#39;WIDTH&#39;</span>] = $this-&gt;ConvertSize($v,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>],$this-&gt;FontSize);
<a name="l16879"></a>16879       <span class="keywordflow">break</span>;
<a name="l16880"></a>16880 
<a name="l16881"></a>16881     <span class="keywordflow">case</span> <span class="stringliteral">&#39;OUTLINE-COLOR&#39;</span>: 
<a name="l16882"></a>16882       <span class="keywordflow">if</span> (strtoupper($v) == <span class="stringliteral">&#39;INVERT&#39;</span>) {
<a name="l16883"></a>16883          <span class="keywordflow">if</span> ($this-&gt;colorarray) {
<a name="l16884"></a>16884         $cor = $this-&gt;colorarray;
<a name="l16885"></a>16885         $this-&gt;outlineparam[<span class="stringliteral">&#39;COLOR&#39;</span>] = array(<span class="charliteral">&#39;R&#39;</span>=&gt; (255-$cor[<span class="charliteral">&#39;R&#39;</span>]), <span class="charliteral">&#39;G&#39;</span>=&gt; (255-$cor[<span class="charliteral">&#39;G&#39;</span>]), <span class="charliteral">&#39;B&#39;</span>=&gt; (255-$cor[<span class="charliteral">&#39;B&#39;</span>]));
<a name="l16886"></a>16886          }
<a name="l16887"></a>16887          <span class="keywordflow">else</span> {
<a name="l16888"></a>16888         $this-&gt;outlineparam[<span class="stringliteral">&#39;COLOR&#39;</span>] = array(<span class="charliteral">&#39;R&#39;</span>=&gt; 255, <span class="charliteral">&#39;G&#39;</span>=&gt; 255, <span class="charliteral">&#39;B&#39;</span>=&gt; 255);
<a name="l16889"></a>16889          }
<a name="l16890"></a>16890       }
<a name="l16891"></a>16891       <span class="keywordflow">else</span> { 
<a name="l16892"></a>16892           $cor = $this-&gt;ConvertColor($v);
<a name="l16893"></a>16893         <span class="keywordflow">if</span> ($cor) { $this-&gt;outlineparam[<span class="stringliteral">&#39;COLOR&#39;</span>] = $cor ; }   
<a name="l16894"></a>16894       }
<a name="l16895"></a>16895       <span class="keywordflow">break</span>;
<a name="l16896"></a>16896 
<a name="l16897"></a>16897     <span class="keywordflow">case</span> <span class="stringliteral">&#39;COLOR&#39;</span>: <span class="comment">// font color</span>
<a name="l16898"></a>16898       $cor = $this-&gt;ConvertColor($v);
<a name="l16899"></a>16899       <span class="keywordflow">if</span> ($cor) { 
<a name="l16900"></a>16900         $this-&gt;colorarray = $cor;
<a name="l16901"></a>16901         $this-&gt;SetTextColor($cor[<span class="charliteral">&#39;R&#39;</span>],$cor[<span class="charliteral">&#39;G&#39;</span>],$cor[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l16902"></a>16902         $this-&gt;issetcolor = <span class="keyword">true</span>;
<a name="l16903"></a>16903       }
<a name="l16904"></a>16904       <span class="keywordflow">break</span>;
<a name="l16905"></a>16905 
<a name="l16906"></a>16906     <span class="keywordflow">case</span> <span class="stringliteral">&#39;DIR&#39;</span>: 
<a name="l16907"></a>16907       $this-&gt;biDirectional = <span class="keyword">true</span>;
<a name="l16908"></a>16908       <span class="keywordflow">break</span>;
<a name="l16909"></a>16909 
<a name="l16910"></a>16910     }<span class="comment">//end of switch($k)</span>
<a name="l16911"></a>16911 
<a name="l16912"></a>16912 
<a name="l16913"></a>16913    }<span class="comment">//end of foreach</span>
<a name="l16914"></a>16914 }
<a name="l16915"></a>16915 
<a name="l16916"></a>16916 function SetStyle($tag,$enable)
<a name="l16917"></a>16917 {
<a name="l16918"></a>16918   <span class="comment">//Modify style and select corresponding font</span>
<a name="l16919"></a>16919   $this-&gt;$tag+=($enable ? 1 : -1);
<a name="l16920"></a>16920   $style=<span class="stringliteral">&#39;&#39;</span>;
<a name="l16921"></a>16921   <span class="comment">//Fix some SetStyle misuse</span>
<a name="l16922"></a>16922   <span class="keywordflow">if</span> ($this-&gt;$tag &lt; 0) $this-&gt;$tag = 0;
<a name="l16923"></a>16923   <span class="keywordflow">if</span> ($this-&gt;$tag &gt; 1) $this-&gt;$tag = 1;
<a name="l16924"></a>16924   <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;B&#39;</span>,<span class="charliteral">&#39;I&#39;</span>,<span class="charliteral">&#39;U&#39;</span>) as $s) {
<a name="l16925"></a>16925     <span class="keywordflow">if</span>($this-&gt;$s&gt;0) {
<a name="l16926"></a>16926       $style.=$s;
<a name="l16927"></a>16927     }
<a name="l16928"></a>16928   }
<a name="l16929"></a>16929   $this-&gt;currentfontstyle=$style;
<a name="l16930"></a>16930   $this-&gt;SetFont(<span class="stringliteral">&#39;&#39;</span>,$style,0,<span class="keyword">false</span>);
<a name="l16931"></a>16931 }
<a name="l16932"></a>16932 
<a name="l16933"></a>16933 function GetStyle()
<a name="l16934"></a>16934 {
<a name="l16935"></a>16935   $style=<span class="stringliteral">&#39;&#39;</span>;
<a name="l16936"></a>16936   <span class="keywordflow">foreach</span>(array(<span class="charliteral">&#39;B&#39;</span>,<span class="charliteral">&#39;I&#39;</span>,<span class="charliteral">&#39;U&#39;</span>) as $s) {
<a name="l16937"></a>16937     <span class="keywordflow">if</span>($this-&gt;$s&gt;0) {
<a name="l16938"></a>16938       $style.=$s;
<a name="l16939"></a>16939     }
<a name="l16940"></a>16940   }
<a name="l16941"></a>16941   <span class="keywordflow">return</span>($style);
<a name="l16942"></a>16942 }
<a name="l16943"></a>16943 
<a name="l16944"></a>16944 
<a name="l16945"></a>16945 function DisableTags($str=<span class="stringliteral">&#39;&#39;</span>)
<a name="l16946"></a>16946 {
<a name="l16947"></a>16947   <span class="keywordflow">if</span> ($str == <span class="stringliteral">&#39;&#39;</span>) <span class="comment">//enable all tags</span>
<a name="l16948"></a>16948   {
<a name="l16949"></a>16949     <span class="comment">//Insert new supported tags in the long string below.</span>
<a name="l16951"></a>16951 <span class="comment"></span>  <span class="comment">// Added custom tags &lt;indexentry&gt;</span>
<a name="l16952"></a>16952     $this-&gt;enabledtags = <span class="stringliteral">&quot;&lt;span&gt;&lt;s&gt;&lt;strike&gt;&lt;del&gt;&lt;bdo&gt;&lt;big&gt;&lt;small&gt;&lt;ins&gt;&lt;cite&gt;&lt;acronym&gt;&lt;font&gt;&lt;sup&gt;&lt;sub&gt;&lt;b&gt;&lt;u&gt;&lt;i&gt;&lt;a&gt;&lt;strong&gt;&lt;em&gt;&lt;code&gt;&lt;samp&gt;&lt;tt&gt;&lt;kbd&gt;&lt;var&gt;&lt;q&gt;&lt;table&gt;&lt;thead&gt;&lt;tfoot&gt;&lt;tbody&gt;&lt;tr&gt;&lt;th&gt;&lt;td&gt;&lt;ol&gt;&lt;ul&gt;&lt;li&gt;&lt;dl&gt;&lt;dt&gt;&lt;dd&gt;&lt;form&gt;&lt;input&gt;&lt;select&gt;&lt;textarea&gt;&lt;option&gt;&lt;div&gt;&lt;p&gt;&lt;h1&gt;&lt;h2&gt;&lt;h3&gt;&lt;h4&gt;&lt;h5&gt;&lt;h6&gt;&lt;pre&gt;&lt;center&gt;&lt;blockquote&gt;&lt;address&gt;&lt;hr&gt;&lt;img&gt;&lt;br&gt;&lt;indexentry&gt;&lt;indexinsert&gt;&lt;bookmark&gt;&lt;watermarktext&gt;&lt;watermarkimage&gt;&lt;tts&gt;&lt;ttz&gt;&lt;tta&gt;&lt;column_break&gt;&lt;columnbreak&gt;&lt;newcolumn&gt;&lt;newpage&gt;&lt;page_break&gt;&lt;pagebreak&gt;&lt;formfeed&gt;&lt;columns&gt;&lt;toc&gt;&lt;tocentry&gt;&lt;tocpagebreak&gt;&lt;pageheader&gt;&lt;pagefooter&gt;&lt;setpageheader&gt;&lt;setpagefooter&gt;&lt;sethtmlpageheader&gt;&lt;sethtmlpagefooter&gt;&lt;annotation&gt;&lt;template&gt;&lt;jpgraph&gt;&lt;barcode&gt;&lt;dottab&gt;&quot;</span>;
<a name="l16953"></a>16953   }
<a name="l16954"></a>16954   <span class="keywordflow">else</span>
<a name="l16955"></a>16955   {
<a name="l16956"></a>16956     $str = explode(<span class="stringliteral">&quot;,&quot;</span>,$str);
<a name="l16957"></a>16957     <span class="keywordflow">foreach</span>($str as $v) $this-&gt;enabledtags = str_replace(trim($v),<span class="stringliteral">&#39;&#39;</span>,$this-&gt;enabledtags);
<a name="l16958"></a>16958   }
<a name="l16959"></a>16959 }
<a name="l16960"></a>16960 
<a name="l16961"></a>16961 
<a name="l16962"></a>16962 
<a name="l16963"></a>16963 <span class="comment">// mPDF 4.2.015</span>
<a name="l16964"></a>16964 function finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight) {
<a name="l16965"></a>16965   $af = 0;  <span class="comment">// Above font</span>
<a name="l16966"></a>16966   $bf = 0;  <span class="comment">// Below font</span>
<a name="l16967"></a>16967   $mta = 0; <span class="comment">// Maximum top-aligned </span>
<a name="l16968"></a>16968   $mba = 0; <span class="comment">// Maximum bottom-aligned </span>
<a name="l16969"></a>16969   <span class="keywordflow">if</span> ($lhxt[<span class="stringliteral">&#39;BS&#39;</span>]) {
<a name="l16970"></a>16970     $af = max($af, ($lhxt[<span class="stringliteral">&#39;BS&#39;</span>] - ($maxfontsize * (0.5 + $this-&gt;baselineC))));
<a name="l16971"></a>16971   }
<a name="l16972"></a>16972   <span class="keywordflow">if</span> ($lhxt[<span class="charliteral">&#39;M&#39;</span>]) { 
<a name="l16973"></a>16973     $af = max($af, ($lhxt[<span class="charliteral">&#39;M&#39;</span>] - $maxfontsize)/2);
<a name="l16974"></a>16974     $bf = max($bf, ($lhxt[<span class="charliteral">&#39;M&#39;</span>] - $maxfontsize)/2);
<a name="l16975"></a>16975   }
<a name="l16976"></a>16976   <span class="keywordflow">if</span> ($lhxt[<span class="stringliteral">&#39;TT&#39;</span>]) { 
<a name="l16977"></a>16977     $bf = max($bf, ($lhxt[<span class="stringliteral">&#39;TT&#39;</span>] - $maxfontsize));
<a name="l16978"></a>16978   }
<a name="l16979"></a>16979   <span class="keywordflow">if</span> ($lhxt[<span class="stringliteral">&#39;TB&#39;</span>]) { 
<a name="l16980"></a>16980     $af = max($af, ($lhxt[<span class="stringliteral">&#39;TB&#39;</span>] - $maxfontsize));
<a name="l16981"></a>16981   }
<a name="l16982"></a>16982   <span class="keywordflow">if</span> ($lhxt[<span class="charliteral">&#39;T&#39;</span>]) { 
<a name="l16983"></a>16983     $mta = max($mta, $lhxt[<span class="charliteral">&#39;T&#39;</span>]);
<a name="l16984"></a>16984   }
<a name="l16985"></a>16985   <span class="keywordflow">if</span> ($lhxt[<span class="charliteral">&#39;B&#39;</span>]) { 
<a name="l16986"></a>16986     $mba = max($mba, $lhxt[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l16987"></a>16987   }
<a name="l16988"></a>16988   <span class="keywordflow">if</span> ((!$lhfixed || !$forceExactLineheight) &amp;&amp; ($af &gt; (($maxlineHeight - $maxfontsize)/2) || $bf &gt; (($maxlineHeight - $maxfontsize)/2))) {
<a name="l16989"></a>16989     $maxlineHeight = $maxfontsize + $af + $bf;
<a name="l16990"></a>16990   }
<a name="l16991"></a>16991   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$lhfixed) { $af = $bf = ($maxlineHeight - $maxfontsize)/2; }
<a name="l16992"></a>16992   <span class="keywordflow">if</span> ($mta &gt; $maxlineHeight) { 
<a name="l16993"></a>16993     $bf += ($mta - $maxlineHeight);
<a name="l16994"></a>16994     $maxlineHeight = $mta;
<a name="l16995"></a>16995   }
<a name="l16996"></a>16996   <span class="keywordflow">if</span> ($mba &gt; $maxlineHeight) { 
<a name="l16997"></a>16997     $af += ($mba - $maxlineHeight);
<a name="l16998"></a>16998     $maxlineHeight = $mba;
<a name="l16999"></a>16999   }
<a name="l17000"></a>17000   <span class="keywordflow">return</span> $maxlineHeight; 
<a name="l17001"></a>17001 }
<a name="l17002"></a>17002 
<a name="l17003"></a>17003 <span class="comment">// mPDF 4.2.015</span>
<a name="l17004"></a>17004 function TableWordWrap($maxwidth, $forcewrap = 0, $textbuffer = <span class="stringliteral">&#39;&#39;</span>, $def_fontsize, $returnarray=<span class="keyword">false</span>) {  <span class="comment">// NB ** returnarray used in flowchart</span>
<a name="l17005"></a>17005    $biggestword=0;
<a name="l17006"></a>17006    $toonarrow=<span class="keyword">false</span>;
<a name="l17007"></a>17007 
<a name="l17008"></a>17008    $curlyquote = mb_convert_encoding(<span class="stringliteral">&quot;\xe2\x80\x9e&quot;</span>,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l17009"></a>17009    $curlylowquote = mb_convert_encoding(<span class="stringliteral">&quot;\xe2\x80\x9d&quot;</span>,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l17010"></a>17010 
<a name="l17011"></a>17011    <span class="comment">// mPDF 3.0 Don&#39;t use ltrim as this gets rid of \n - new line from &lt;br&gt;</span>
<a name="l17012"></a>17012    <span class="comment">//$textbuffer[0][0] = ltrim($textbuffer[0][0]);</span>
<a name="l17013"></a>17013    $textbuffer[0][0] = preg_replace(<span class="stringliteral">&#39;/^[ ]*/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$textbuffer[0][0]);
<a name="l17014"></a>17014 
<a name="l17015"></a>17015    <span class="keywordflow">if</span> ((count($textbuffer) == 0) or ((count($textbuffer) == 1) &amp;&amp; ($textbuffer[0][0] == <span class="stringliteral">&#39;&#39;</span>))) { <span class="keywordflow">return</span> 0; }
<a name="l17016"></a>17016 
<a name="l17017"></a>17017    $text = <span class="stringliteral">&#39;&#39;</span>;
<a name="l17018"></a>17018    $lhfixed = <span class="keyword">false</span>; 
<a name="l17019"></a>17019    <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/([0-9.,]+)mm/&#39;</span>,$this-&gt;table_lineheight)) { $lhfixed = <span class="keyword">true</span>; }
<a name="l17020"></a>17020    <span class="keywordflow">if</span> ($lhfixed) { $def_lineheight = $this-&gt;_computeLineheight($this-&gt;table_lineheight, $def_fontsize);}
<a name="l17021"></a>17021    <span class="keywordflow">else</span> { $def_lineheight = 0; }
<a name="l17022"></a>17022    <span class="comment">// START OF NEW LINE</span>
<a name="l17023"></a>17023    <span class="comment">// Initialise lineheight variables</span>
<a name="l17024"></a>17024    $maxfontsize = 0;
<a name="l17025"></a>17025    $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17026"></a>17026    $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17027"></a>17027    $maxlineHeight = $def_lineheight ;
<a name="l17028"></a>17028 
<a name="l17029"></a>17029    $ch = 0;
<a name="l17030"></a>17030    $width = 0;
<a name="l17031"></a>17031    $ln = 1; <span class="comment">// Counts line number</span>
<a name="l17032"></a>17032    $mxw = $this-&gt;GetStringWidth(<span class="charliteral">&#39;W&#39;</span>); <span class="comment">// Keep tabs on Maxwidth of actual text</span>
<a name="l17033"></a>17033    <span class="keywordflow">foreach</span> ($textbuffer as $cctr=&gt;$chunk) {
<a name="l17034"></a>17034   $line = $chunk[0];
<a name="l17035"></a>17035 
<a name="l17036"></a>17036   <span class="comment">//IMAGE</span>
<a name="l17037"></a>17037       <span class="keywordflow">if</span> (substr($line,0,3) == <span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>) { <span class="comment">//identifier has been identified!</span>
<a name="l17038"></a>17038     <span class="comment">// mPDF 4.0</span>
<a name="l17039"></a>17039     $objattr = $this-&gt;_getObjAttr($line);
<a name="l17040"></a>17040     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;nestedtable&#39;</span>) {
<a name="l17041"></a>17041       <span class="comment">// END OF LINE</span>
<a name="l17042"></a>17042       <span class="comment">// Finalise &amp; add lineheight</span>
<a name="l17043"></a>17043       $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17044"></a>17044       $level = $objattr[<span class="stringliteral">&#39;level&#39;</span>];
<a name="l17045"></a>17045       $ih = $this-&gt;table[($level+1)][$objattr[<span class="stringliteral">&#39;nestedcontent&#39;</span>]][<span class="charliteral">&#39;h&#39;</span>]; <span class="comment">// nested table width</span>
<a name="l17046"></a>17046       $ch += $ih;
<a name="l17047"></a>17047       <span class="comment">// START OF NEW LINE</span>
<a name="l17048"></a>17048       <span class="comment">// Initialise lineheight variables</span>
<a name="l17049"></a>17049       $ln++;
<a name="l17050"></a>17050       $maxfontsize = 0;
<a name="l17051"></a>17051       $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17052"></a>17052       $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17053"></a>17053       $maxlineHeight = $def_lineheight ;
<a name="l17054"></a>17054       $width = 0;
<a name="l17055"></a>17055       $text = <span class="stringliteral">&quot;&quot;</span>;
<a name="l17056"></a>17056       <span class="keywordflow">continue</span>;
<a name="l17057"></a>17057     }
<a name="l17058"></a>17058 
<a name="l17059"></a>17059     list($skipln,$iw,$ih) = $this-&gt;inlineObject($specialcontent[<span class="stringliteral">&#39;type&#39;</span>],0,0, $objattr, $this-&gt;lMargin,$width,$maxwidth,$maxlineHeight,<span class="keyword">false</span>,<span class="keyword">true</span>);
<a name="l17060"></a>17060     <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;hr&#39;</span>) {
<a name="l17061"></a>17061       <span class="comment">// END OF LINE</span>
<a name="l17062"></a>17062       <span class="comment">// Finalise &amp; add lineheight </span>
<a name="l17063"></a>17063       $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17064"></a>17064       <span class="comment">// Add HR height</span>
<a name="l17065"></a>17065       $ch += $ih;
<a name="l17066"></a>17066       <span class="comment">// START OF NEW LINE</span>
<a name="l17067"></a>17067       <span class="comment">// Initialise lineheight variables</span>
<a name="l17068"></a>17068       $ln++;
<a name="l17069"></a>17069       $maxfontsize = 0;
<a name="l17070"></a>17070       $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17071"></a>17071       $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17072"></a>17072       $maxlineHeight = $def_lineheight ;
<a name="l17073"></a>17073       $width = 0;
<a name="l17074"></a>17074       $text = <span class="stringliteral">&quot;&quot;</span>;
<a name="l17075"></a>17075       <span class="keywordflow">continue</span>;
<a name="l17076"></a>17076     }
<a name="l17077"></a>17077 
<a name="l17078"></a>17078     <span class="keywordflow">if</span> ($skipln==1 || $skipln==-2) {
<a name="l17079"></a>17079       <span class="comment">// Finish last line</span>
<a name="l17080"></a>17080       <span class="comment">// END OF LINE</span>
<a name="l17081"></a>17081       <span class="comment">// Finalise &amp; add lineheight </span>
<a name="l17082"></a>17082       $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17083"></a>17083       <span class="comment">// START OF NEW LINE</span>
<a name="l17084"></a>17084       <span class="comment">// Initialise lineheight variables</span>
<a name="l17085"></a>17085       $maxfontsize = 0;
<a name="l17086"></a>17086       $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17087"></a>17087       $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17088"></a>17088       $maxlineHeight = $def_lineheight ;
<a name="l17089"></a>17089       $ln++;
<a name="l17090"></a>17090       $width = 0;
<a name="l17091"></a>17091       $text = <span class="stringliteral">&quot;&quot;</span>;
<a name="l17092"></a>17092     }
<a name="l17093"></a>17093     $va = $objattr[<span class="stringliteral">&#39;vertical-align&#39;</span>]; 
<a name="l17094"></a>17094     <span class="keywordflow">if</span> ($va) {
<a name="l17095"></a>17095       $lhxt[$va] = max($lhxt[$va], $ih);
<a name="l17096"></a>17096     }
<a name="l17097"></a>17097     <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $ih &gt; $def_fontsize) { $forceExactLineheight = <span class="keyword">false</span>; }
<a name="l17098"></a>17098     $maxlineHeight = max($maxlineHeight ,$ih);
<a name="l17099"></a>17099     $width += $iw;
<a name="l17100"></a>17100     <span class="keywordflow">continue</span>;
<a name="l17101"></a>17101   }
<a name="l17102"></a>17102 
<a name="l17103"></a>17103   <span class="comment">// SET FONT SIZE/STYLE from $chunk[n]</span>
<a name="l17104"></a>17104   <span class="comment">// FONTSIZE</span>
<a name="l17105"></a>17105   <span class="keywordflow">if</span>(isset($chunk[11]) and $chunk[11] != <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l17106"></a>17106      <span class="keywordflow">if</span> ($this-&gt;shrin_k) {
<a name="l17107"></a>17107     $this-&gt;SetFontSize($chunk[11]/$this-&gt;shrin_k,<span class="keyword">false</span>); 
<a name="l17108"></a>17108      }
<a name="l17109"></a>17109      <span class="keywordflow">else</span> {
<a name="l17110"></a>17110     $this-&gt;SetFontSize($chunk[11],<span class="keyword">false</span>); 
<a name="l17111"></a>17111      }
<a name="l17112"></a>17112   }
<a name="l17113"></a>17113 
<a name="l17114"></a>17114   <span class="comment">// mPDF 3.0 Moved to after set FontSize</span>
<a name="l17115"></a>17115   <span class="keywordflow">if</span> ($line == <span class="stringliteral">&quot;\n&quot;</span>) {
<a name="l17116"></a>17116     <span class="comment">// END OF LINE</span>
<a name="l17117"></a>17117     $maxfontsize = max($maxfontsize,$this-&gt;FontSize); 
<a name="l17118"></a>17118     $fh = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17119"></a>17119     <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $this-&gt;FontSize &gt; $def_fontsize) {
<a name="l17120"></a>17120       $fh = $this-&gt;FontSize;
<a name="l17121"></a>17121       $forceExactLineheight = <span class="keyword">false</span>; 
<a name="l17122"></a>17122     }
<a name="l17123"></a>17123     $maxlineHeight = max($maxlineHeight,$fh); 
<a name="l17124"></a>17124 
<a name="l17125"></a>17125     <span class="comment">// Finalise &amp; add lineheight </span>
<a name="l17126"></a>17126     $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17127"></a>17127     <span class="comment">// START OF NEW LINE</span>
<a name="l17128"></a>17128     <span class="comment">// Initialise lineheight variables</span>
<a name="l17129"></a>17129     $maxfontsize = 0;
<a name="l17130"></a>17130     $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17131"></a>17131     $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17132"></a>17132     $maxlineHeight = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17133"></a>17133     $ln++;
<a name="l17134"></a>17134     $text = <span class="stringliteral">&quot;&quot;</span>;
<a name="l17135"></a>17135     $width = 0;
<a name="l17136"></a>17136     <span class="comment">// mPDF 3.0 Reset FontSize</span>
<a name="l17137"></a>17137     <span class="keywordflow">if</span>(isset($chunk[11]) and $chunk[11] != <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l17138"></a>17138       $this-&gt;SetFontSize($this-&gt;default_font_size,<span class="keyword">false</span>);
<a name="l17139"></a>17139     }
<a name="l17140"></a>17140     <span class="keywordflow">continue</span>;
<a name="l17141"></a>17141   }
<a name="l17142"></a>17142 
<a name="l17143"></a>17143   <span class="comment">// FONTFAMILY</span>
<a name="l17144"></a>17144   <span class="keywordflow">if</span>(isset($chunk[4]) and $chunk[4] != <span class="stringliteral">&#39;&#39;</span>) { $font = $this-&gt;SetFont($chunk[4],$this-&gt;FontStyle,0,<span class="keyword">false</span>); }
<a name="l17145"></a>17145 
<a name="l17146"></a>17146   <span class="comment">// FONT STYLE B I U</span>
<a name="l17147"></a>17147   <span class="keywordflow">if</span>(isset($chunk[2]) and $chunk[2] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l17148"></a>17148     <span class="keywordflow">if</span> (strpos($chunk[2],<span class="stringliteral">&quot;B&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>); 
<a name="l17149"></a>17149         <span class="keywordflow">if</span> (strpos($chunk[2],<span class="stringliteral">&quot;I&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>); 
<a name="l17150"></a>17150   }
<a name="l17151"></a>17151 
<a name="l17152"></a>17152   $space = $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>);
<a name="l17153"></a>17153 
<a name="l17154"></a>17154   <span class="keywordflow">if</span> (mb_substr($line,0,1,$this-&gt;mb_enc ) == <span class="charliteral">&#39; &#39;</span>) {   <span class="comment">// line (chunk) starts with a space</span>
<a name="l17155"></a>17155     $width += $space;
<a name="l17156"></a>17156     $text .= <span class="charliteral">&#39; &#39;</span>;
<a name="l17157"></a>17157   }
<a name="l17158"></a>17158 
<a name="l17159"></a>17159   <span class="keywordflow">if</span> (mb_substr($line,(mb_strlen($line,$this-&gt;mb_enc )-1),1,$this-&gt;mb_enc ) == <span class="charliteral">&#39; &#39;</span>) { $lsend = <span class="keyword">true</span>; }  <span class="comment">// line (chunk) ends with a space</span>
<a name="l17160"></a>17160   <span class="keywordflow">else</span> { $lsend = <span class="keyword">false</span>; }
<a name="l17161"></a>17161   $line= ltrim($line);
<a name="l17162"></a>17162   $line= $this-&gt;mb_rtrim($line, $this-&gt;mb_enc);
<a name="l17163"></a>17163   <span class="keywordflow">if</span> ($line == <span class="stringliteral">&#39;&#39;</span>) { <span class="keywordflow">continue</span>; }
<a name="l17164"></a>17164 
<a name="l17165"></a>17165   <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l17166"></a>17166     $words = mb_split(<span class="charliteral">&#39; &#39;</span>, $line);
<a name="l17167"></a>17167   }
<a name="l17168"></a>17168   <span class="keywordflow">else</span> {
<a name="l17169"></a>17169     $words = explode(<span class="charliteral">&#39; &#39;</span>, $line);
<a name="l17170"></a>17170   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l17171"></a>17171 
<a name="l17172"></a>17172   <span class="keywordflow">foreach</span> ($words as $word) {
<a name="l17173"></a>17173     $word = $this-&gt;mb_rtrim($word, $this-&gt;mb_enc);
<a name="l17174"></a>17174     $word = ltrim($word);
<a name="l17175"></a>17175     $wordwidth = $this-&gt;GetStringWidth($word);
<a name="l17176"></a>17176 
<a name="l17177"></a>17177 
<a name="l17178"></a>17178     <span class="comment">//maxwidth is insufficient for one word</span>
<a name="l17179"></a>17179     <span class="keywordflow">if</span> ($wordwidth &gt; $maxwidth + 0.0001) {
<a name="l17180"></a>17180       $firstchunk=<span class="keyword">true</span>;
<a name="l17181"></a>17181       <span class="keywordflow">while</span>($wordwidth &gt; $maxwidth + 0.0001) {
<a name="l17182"></a>17182         $chw = 0; <span class="comment">// check width</span>
<a name="l17183"></a>17183         <span class="keywordflow">for</span> ( $i = 0; $i &lt; mb_strlen($word, $this-&gt;mb_enc ); $i++ ) {
<a name="l17184"></a>17184           $chw = $this-&gt;GetStringWidth(mb_substr($word,0,$i+1,$this-&gt;mb_enc ));
<a name="l17185"></a>17185           <span class="keywordflow">if</span> ($chw &gt; $maxwidth) {
<a name="l17186"></a>17186             <span class="keywordflow">if</span> ($text &amp;&amp; $firstchunk) {
<a name="l17187"></a>17187               <span class="comment">// END OF LINE</span>
<a name="l17188"></a>17188               <span class="comment">// Finalise &amp; add lineheight </span>
<a name="l17189"></a>17189               $maxfontsize = max($maxfontsize,$this-&gt;FontSize); 
<a name="l17190"></a>17190               $fh = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17191"></a>17191               <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $this-&gt;FontSize &gt; $def_fontsize) {
<a name="l17192"></a>17192                 $fh = $this-&gt;FontSize;
<a name="l17193"></a>17193                 $forceExactLineheight = <span class="keyword">false</span>; 
<a name="l17194"></a>17194               }
<a name="l17195"></a>17195               $maxlineHeight = max($maxlineHeight,$fh); 
<a name="l17196"></a>17196               $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17197"></a>17197               <span class="comment">// START OF NEW LINE</span>
<a name="l17198"></a>17198               <span class="comment">// Initialise lineheight variables</span>
<a name="l17199"></a>17199               $maxfontsize = $this-&gt;FontSize;
<a name="l17200"></a>17200               $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17201"></a>17201               $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17202"></a>17202               $maxlineHeight = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17203"></a>17203               $ln++;
<a name="l17204"></a>17204             }
<a name="l17205"></a>17205             <span class="comment">// END OF LINE</span>
<a name="l17206"></a>17206             <span class="comment">// Finalise &amp; add lineheight </span>
<a name="l17207"></a>17207             $maxfontsize = max($maxfontsize,$this-&gt;FontSize); 
<a name="l17208"></a>17208             $fh = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17209"></a>17209             <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $this-&gt;FontSize &gt; $def_fontsize) {
<a name="l17210"></a>17210               $fh = $this-&gt;FontSize;
<a name="l17211"></a>17211               $forceExactLineheight = <span class="keyword">false</span>; 
<a name="l17212"></a>17212             }
<a name="l17213"></a>17213             $maxlineHeight = max($maxlineHeight,$fh); 
<a name="l17214"></a>17214             $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17215"></a>17215             <span class="comment">// START OF NEW LINE</span>
<a name="l17216"></a>17216             <span class="comment">// Initialise lineheight variables</span>
<a name="l17217"></a>17217             $maxfontsize = $this-&gt;FontSize;
<a name="l17218"></a>17218             $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17219"></a>17219             $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17220"></a>17220             $maxlineHeight = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17221"></a>17221             $ln++;
<a name="l17222"></a>17222             $mxw = $maxwidth;
<a name="l17223"></a>17223             $text = mb_substr($word,0,$i,$this-&gt;mb_enc );
<a name="l17224"></a>17224             $word = mb_substr($word,$i,mb_strlen($word, $this-&gt;mb_enc )-$i,$this-&gt;mb_enc );
<a name="l17225"></a>17225             $wordwidth = $this-&gt;GetStringWidth($word);
<a name="l17226"></a>17226             $width = 0; 
<a name="l17227"></a>17227             $firstchunk=<span class="keyword">false</span>;
<a name="l17228"></a>17228             <span class="keywordflow">break</span>;
<a name="l17229"></a>17229           }
<a name="l17230"></a>17230         }
<a name="l17231"></a>17231         <span class="comment">// mPDF 4.2.015 to catch errors - added $i==0</span>
<a name="l17232"></a>17232         <span class="keywordflow">if</span> (mb_strlen($word, $this-&gt;mb_enc )&lt;2 || $i==0) { 
<a name="l17233"></a>17233           $wordwidth = $maxwidth - 0.0001;
<a name="l17234"></a>17234           <span class="keywordflow">if</span> ($this-&gt;debug) { $this-&gt;Error(<span class="stringliteral">&quot;Table cell width calculated less than that needed for single character!&quot;</span>); }
<a name="l17235"></a>17235         }
<a name="l17236"></a>17236         $firstchunk=<span class="keyword">false</span>;
<a name="l17237"></a>17237       }
<a name="l17238"></a>17238     }
<a name="l17239"></a>17239     <span class="comment">// Word fits on line...</span>
<a name="l17240"></a>17240     <span class="keywordflow">if</span> ($width + $wordwidth  &lt; $maxwidth + 0.0001) {
<a name="l17241"></a>17241       $mxw = max($mxw, ($width+$wordwidth));
<a name="l17242"></a>17242       $width += $wordwidth + $space;
<a name="l17243"></a>17243       $text .= $word.<span class="charliteral">&#39; &#39;</span>;
<a name="l17244"></a>17244     }
<a name="l17245"></a>17245     <span class="comment">// Word does not fit on line...</span>
<a name="l17246"></a>17246     <span class="keywordflow">else</span> {
<a name="l17247"></a>17247       $alloworphans = <span class="keyword">false</span>;
<a name="l17248"></a>17248       <span class="comment">// In case of orphan punctuation or SUB/SUP</span>
<a name="l17249"></a>17249       <span class="comment">// Strip end punctuation</span>
<a name="l17250"></a>17250       <span class="comment">// mPDF 4.2 Only allow 1 orphan character {1}</span>
<a name="l17251"></a>17251       $tmp = preg_replace(<span class="stringliteral">&#39;/[\.),;:!?&quot;&#39;</span>.$curlyquote . $curlylowquote .<span class="stringliteral">&quot;\xef\xbc\x8c\xe3\x80\x82&quot;</span>.<span class="stringliteral">&#39;]{1}$/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$word);
<a name="l17252"></a>17252       <span class="keywordflow">if</span> ($tmp !== $word) {
<a name="l17253"></a>17253         $tmpwidth = $this-&gt;GetStringWidth($tmp);
<a name="l17254"></a>17254         <span class="keywordflow">if</span> ($width + $tmpwidth  &lt; $maxwidth + 0.0001) { $alloworphans = <span class="keyword">true</span>; }
<a name="l17255"></a>17255       }
<a name="l17256"></a>17256       <span class="comment">// If line = SUB/SUP to max of orphansallowed ( $this-&gt;SUP || $this-&gt;SUB ) // mPDF 3.0</span>
<a name="l17257"></a>17257       <span class="keywordflow">if</span>(( (isset($chunk[5]) and $chunk[5]) || (isset($chunk[6]) and $chunk[6])) &amp;&amp; strlen($word) &lt;= $this-&gt;orphansAllowed) {
<a name="l17258"></a>17258         $alloworphans = <span class="keyword">true</span>;
<a name="l17259"></a>17259       }
<a name="l17260"></a>17260 
<a name="l17261"></a>17261 
<a name="l17262"></a>17262       <span class="comment">// if [stripped] word fits</span>
<a name="l17263"></a>17263       <span class="keywordflow">if</span> ($alloworphans) {
<a name="l17264"></a>17264         $mxw = $maxwidth;
<a name="l17265"></a>17265         $width += $wordwidth + $space;
<a name="l17266"></a>17266         $text .= $word.<span class="charliteral">&#39; &#39;</span>;
<a name="l17267"></a>17267       }
<a name="l17268"></a>17268       <span class="keywordflow">else</span> {
<a name="l17269"></a>17269         <span class="comment">// END OF LINE</span>
<a name="l17270"></a>17270         <span class="comment">// Finalise &amp; add lineheight </span>
<a name="l17271"></a>17271         $maxfontsize = max($maxfontsize,$this-&gt;FontSize); 
<a name="l17272"></a>17272         $fh = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17273"></a>17273         <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $this-&gt;FontSize &gt; $def_fontsize) {
<a name="l17274"></a>17274           $fh = $this-&gt;FontSize;
<a name="l17275"></a>17275           $forceExactLineheight = <span class="keyword">false</span>; 
<a name="l17276"></a>17276         }
<a name="l17277"></a>17277         $maxlineHeight = max($maxlineHeight,$fh); 
<a name="l17278"></a>17278         $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17279"></a>17279         $mxw = $maxwidth;
<a name="l17280"></a>17280         <span class="comment">// START OF NEW LINE</span>
<a name="l17281"></a>17281         <span class="comment">// Initialise lineheight variables</span>
<a name="l17282"></a>17282         $maxfontsize = $this-&gt;FontSize;
<a name="l17283"></a>17283         $forceExactLineheight = <span class="keyword">true</span>;
<a name="l17284"></a>17284         $lhxt = array(<span class="stringliteral">&#39;BS&#39;</span>=&gt;0, <span class="charliteral">&#39;M&#39;</span>=&gt;0, <span class="stringliteral">&#39;TT&#39;</span>=&gt;0, <span class="stringliteral">&#39;TB&#39;</span>=&gt;0, <span class="charliteral">&#39;T&#39;</span>=&gt;0, <span class="charliteral">&#39;B&#39;</span>=&gt;0);
<a name="l17285"></a>17285         $maxlineHeight = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17286"></a>17286         $ln++;
<a name="l17287"></a>17287         $width = $wordwidth + $space;
<a name="l17288"></a>17288         $text = $word.<span class="charliteral">&#39; &#39;</span>;
<a name="l17289"></a>17289       }
<a name="l17290"></a>17290             }
<a name="l17291"></a>17291     $maxfontsize = max($maxfontsize,$this-&gt;FontSize); 
<a name="l17292"></a>17292     $fh = $this-&gt;_computeLineheight($this-&gt;table_lineheight);
<a name="l17293"></a>17293     <span class="keywordflow">if</span> ($lhfixed &amp;&amp; $this-&gt;FontSize &gt; $def_fontsize) {
<a name="l17294"></a>17294       $fh = $this-&gt;FontSize;
<a name="l17295"></a>17295       $forceExactLineheight = <span class="keyword">false</span>; 
<a name="l17296"></a>17296     }
<a name="l17297"></a>17297     $maxlineHeight = max($maxlineHeight,$fh); 
<a name="l17298"></a>17298   }
<a name="l17299"></a>17299 
<a name="l17300"></a>17300   <span class="comment">// End of textbuffer chunk</span>
<a name="l17301"></a>17301   <span class="keywordflow">if</span> (!$lsend) {
<a name="l17302"></a>17302     $width -= $space;
<a name="l17303"></a>17303     $text = $this-&gt;mb_rtrim($text , $this-&gt;mb_enc);
<a name="l17304"></a>17304   }
<a name="l17305"></a>17305 
<a name="l17306"></a>17306   <span class="comment">// RESET FONT SIZE/STYLE</span>
<a name="l17307"></a>17307   <span class="comment">// RESETTING VALUES</span>
<a name="l17308"></a>17308   <span class="comment">//Now we must deactivate what we have used</span>
<a name="l17309"></a>17309   <span class="keywordflow">if</span>(isset($chunk[2]) and $chunk[2] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l17310"></a>17310     $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l17311"></a>17311     $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l17312"></a>17312   }
<a name="l17313"></a>17313   <span class="keywordflow">if</span>(isset($chunk[4]) and $chunk[4] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l17314"></a>17314     $this-&gt;SetFont($this-&gt;default_font,$this-&gt;FontStyle,0,<span class="keyword">false</span>);
<a name="l17315"></a>17315   }
<a name="l17316"></a>17316   <span class="keywordflow">if</span>(isset($chunk[11]) and $chunk[11] != <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l17317"></a>17317     $this-&gt;SetFontSize($this-&gt;default_font_size,<span class="keyword">false</span>);
<a name="l17318"></a>17318   }
<a name="l17319"></a>17319    }
<a name="l17320"></a>17320    <span class="comment">// Finalise lineheight if something output on line and add</span>
<a name="l17321"></a>17321    <span class="keywordflow">if</span> ($width) {
<a name="l17322"></a>17322   $ch += $this-&gt;finaliseCellLineHeight($lhxt, $maxfontsize, $maxlineHeight, $lhfixed, $forceExactLineheight);
<a name="l17323"></a>17323    }
<a name="l17324"></a>17324    <span class="keywordflow">if</span> ($returnarray) { <span class="keywordflow">return</span> array($ch,$ln,$mxw); }
<a name="l17325"></a>17325    <span class="keywordflow">else</span> { <span class="keywordflow">return</span> $ch; }
<a name="l17326"></a>17326 
<a name="l17327"></a>17327 }
<a name="l17328"></a>17328 
<a name="l17329"></a>17329 
<a name="l17330"></a>17330 function TableCheckMinWidth(&amp;$text, $maxwidth, $forcewrap = 0, $textbuffer = <span class="stringliteral">&#39;&#39;</span>)
<a name="l17331"></a>17331 {
<a name="l17332"></a>17332     $biggestword=0;
<a name="l17333"></a>17333     $toonarrow=<span class="keyword">false</span>;
<a name="l17334"></a>17334   <span class="keywordflow">if</span> ((count($textbuffer) == 0) or ((count($textbuffer) == 1) &amp;&amp; ($textbuffer[0][0] == <span class="stringliteral">&#39;&#39;</span>))) { <span class="keywordflow">return</span> 0; }
<a name="l17335"></a>17335 
<a name="l17336"></a>17336     <span class="keywordflow">foreach</span> ($textbuffer as $chunk) {
<a name="l17337"></a>17337 
<a name="l17338"></a>17338     $line = $chunk[0];
<a name="l17339"></a>17339 
<a name="l17340"></a>17340     <span class="comment">// IMAGES &amp; FORM ELEMENTS</span>
<a name="l17341"></a>17341         <span class="keywordflow">if</span> (substr($line,0,3) == <span class="stringliteral">&quot;\xbb\xa4\xac&quot;</span>) { <span class="comment">//inline object - FORM element or IMAGE!</span>
<a name="l17342"></a>17342       <span class="comment">// mPDF 4.0</span>
<a name="l17343"></a>17343       $objattr = $this-&gt;_getObjAttr($line);
<a name="l17344"></a>17344       <span class="keywordflow">if</span> ($objattr[<span class="stringliteral">&#39;type&#39;</span>]!=<span class="stringliteral">&#39;hr&#39;</span> &amp;&amp; isset($objattr[<span class="stringliteral">&#39;width&#39;</span>]) &amp;&amp; ($objattr[<span class="stringliteral">&#39;width&#39;</span>]/$this-&gt;shrin_k) &gt; ($maxwidth + 0.0001) ) { 
<a name="l17345"></a>17345         <span class="keywordflow">if</span> (($objattr[<span class="stringliteral">&#39;width&#39;</span>]/$this-&gt;shrin_k) &gt; $biggestword) { $biggestword = ($objattr[<span class="stringliteral">&#39;width&#39;</span>]/$this-&gt;shrin_k); }
<a name="l17346"></a>17346         $toonarrow=<span class="keyword">true</span>;
<a name="l17347"></a>17347       }
<a name="l17348"></a>17348       <span class="keywordflow">continue</span>;
<a name="l17349"></a>17349     }
<a name="l17350"></a>17350 
<a name="l17351"></a>17351     <span class="keywordflow">if</span> ($line == <span class="stringliteral">&quot;\n&quot;</span>) {
<a name="l17352"></a>17352       <span class="keywordflow">continue</span>;
<a name="l17353"></a>17353     }
<a name="l17354"></a>17354         $line = ltrim($line );
<a name="l17355"></a>17355         $line = $this-&gt;mb_rtrim($line , $this-&gt;mb_enc);
<a name="l17356"></a>17356     <span class="comment">// SET FONT SIZE/STYLE from $chunk[n]</span>
<a name="l17357"></a>17357 
<a name="l17358"></a>17358     <span class="comment">// FONTSIZE</span>
<a name="l17359"></a>17359         <span class="keywordflow">if</span>(isset($chunk[11]) and $chunk[11] != <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l17360"></a>17360        <span class="keywordflow">if</span> ($this-&gt;shrin_k) {
<a name="l17361"></a>17361       $this-&gt;SetFontSize($chunk[11]/$this-&gt;shrin_k,<span class="keyword">false</span>); 
<a name="l17362"></a>17362        }
<a name="l17363"></a>17363        <span class="keywordflow">else</span> {
<a name="l17364"></a>17364       $this-&gt;SetFontSize($chunk[11],<span class="keyword">false</span>); 
<a name="l17365"></a>17365        }
<a name="l17366"></a>17366     }
<a name="l17367"></a>17367     <span class="comment">// FONTFAMILY</span>
<a name="l17368"></a>17368         <span class="keywordflow">if</span>(isset($chunk[4]) and $chunk[4] != <span class="stringliteral">&#39;&#39;</span>) { $font = $this-&gt;SetFont($chunk[4],$this-&gt;FontStyle,0,<span class="keyword">false</span>); }
<a name="l17369"></a>17369     <span class="comment">// B I U</span>
<a name="l17370"></a>17370         <span class="keywordflow">if</span>(isset($chunk[2]) and $chunk[2] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l17371"></a>17371             <span class="keywordflow">if</span> (strpos($chunk[2],<span class="stringliteral">&quot;B&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">true</span>);
<a name="l17372"></a>17372             <span class="keywordflow">if</span> (strpos($chunk[2],<span class="stringliteral">&quot;I&quot;</span>) !== <span class="keyword">false</span>) $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">true</span>);
<a name="l17373"></a>17373         }
<a name="l17374"></a>17374 
<a name="l17375"></a>17375   <span class="keywordflow">if</span> ($this-&gt;is_MB &amp;&amp; !$this-&gt;usingCoreFont) {
<a name="l17376"></a>17376     $words = mb_split(<span class="charliteral">&#39; &#39;</span>, $line);
<a name="l17377"></a>17377   }
<a name="l17378"></a>17378   <span class="keywordflow">else</span> {
<a name="l17379"></a>17379     $words = explode(<span class="charliteral">&#39; &#39;</span>, $line);
<a name="l17380"></a>17380   } <span class="comment">// *UNICODE-FONTS*</span>
<a name="l17381"></a>17381   <span class="keywordflow">foreach</span> ($words as $word) {
<a name="l17382"></a>17382     $word = $this-&gt;mb_rtrim($word, $this-&gt;mb_enc);
<a name="l17383"></a>17383     $word = ltrim($word);
<a name="l17384"></a>17384     $wordwidth = $this-&gt;GetStringWidth($word);
<a name="l17385"></a>17385 
<a name="l17386"></a>17386     <span class="comment">//EDITEI</span>
<a name="l17387"></a>17387     <span class="comment">//Warn user that maxwidth is insufficient</span>
<a name="l17388"></a>17388     <span class="keywordflow">if</span> ($wordwidth &gt; $maxwidth + 0.0001) {
<a name="l17389"></a>17389       <span class="keywordflow">if</span> ($wordwidth &gt; $biggestword) { $biggestword = $wordwidth; }
<a name="l17390"></a>17390       $toonarrow=<span class="keyword">true</span>;
<a name="l17391"></a>17391     }
<a name="l17392"></a>17392 
<a name="l17393"></a>17393   }
<a name="l17394"></a>17394 
<a name="l17395"></a>17395   <span class="comment">// RESET FONT SIZE/STYLE</span>
<a name="l17396"></a>17396   <span class="comment">// RESETTING VALUES</span>
<a name="l17397"></a>17397   <span class="comment">//Now we must deactivate what we have used</span>
<a name="l17398"></a>17398   <span class="keywordflow">if</span>(isset($chunk[2]) and $chunk[2] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l17399"></a>17399          $this-&gt;SetStyle(<span class="charliteral">&#39;B&#39;</span>,<span class="keyword">false</span>);
<a name="l17400"></a>17400          $this-&gt;SetStyle(<span class="charliteral">&#39;I&#39;</span>,<span class="keyword">false</span>);
<a name="l17401"></a>17401   }
<a name="l17402"></a>17402   <span class="keywordflow">if</span>(isset($chunk[4]) and $chunk[4] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l17403"></a>17403     $this-&gt;SetFont($this-&gt;default_font,$this-&gt;FontStyle,0,<span class="keyword">false</span>);
<a name="l17404"></a>17404   }
<a name="l17405"></a>17405   <span class="keywordflow">if</span>(isset($chunk[11]) and $chunk[11] != <span class="stringliteral">&#39;&#39;</span>) { 
<a name="l17406"></a>17406     $this-&gt;SetFontSize($this-&gt;default_font_size,<span class="keyword">false</span>);
<a name="l17407"></a>17407   }
<a name="l17408"></a>17408     }
<a name="l17409"></a>17409 
<a name="l17410"></a>17410     <span class="comment">//Return -(wordsize) if word is bigger than maxwidth </span>
<a name="l17411"></a>17411   <span class="comment">// ADDED</span>
<a name="l17412"></a>17412       <span class="keywordflow">if</span> (($toonarrow) &amp;&amp; ($this-&gt;table_error_report)) {
<a name="l17413"></a>17413     $this-&gt;Error(<span class="stringliteral">&quot;Word is too long to fit in table - &quot;</span>.$this-&gt;table_error_report_param); 
<a name="l17414"></a>17414   }
<a name="l17415"></a>17415     <span class="keywordflow">if</span> ($toonarrow) <span class="keywordflow">return</span> -$biggestword;
<a name="l17416"></a>17416     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 1;
<a name="l17417"></a>17417 }
<a name="l17418"></a>17418 
<a name="l17419"></a>17419 function shrinkTable(&amp;$table,$k) {
<a name="l17420"></a>17420     $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] /= $k;
<a name="l17421"></a>17421     $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>] /= $k;
<a name="l17422"></a>17422 
<a name="l17423"></a>17423     $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] /= $k;
<a name="l17424"></a>17424     $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] /= $k;
<a name="l17425"></a>17425     $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] /= $k;
<a name="l17426"></a>17426     $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] /= $k;
<a name="l17427"></a>17427 
<a name="l17428"></a>17428     $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] /= $k;
<a name="l17429"></a>17429     $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] /= $k;
<a name="l17430"></a>17430     $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] /= $k;
<a name="l17431"></a>17431     $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] /= $k;
<a name="l17432"></a>17432 
<a name="l17433"></a>17433     $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17434"></a>17434     $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17435"></a>17435     $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17436"></a>17436     $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17437"></a>17437 
<a name="l17438"></a>17438     <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>])) $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] /= $k;
<a name="l17439"></a>17439     <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>])) $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] /= $k;
<a name="l17440"></a>17440     <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>])) $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] /= $k;
<a name="l17441"></a>17441     <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>])) $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] /= $k;
<a name="l17442"></a>17442 
<a name="l17443"></a>17443     <span class="keywordflow">if</span> ($this-&gt;simpleTables){ <span class="comment">// mPDF 4.2.017</span>
<a name="l17444"></a>17444       $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17445"></a>17445       $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17446"></a>17446       $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17447"></a>17447       $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17448"></a>17448       <span class="comment">// mPDF 4.3.006 removed padding</span>
<a name="l17449"></a>17449     }
<a name="l17450"></a>17450 
<a name="l17451"></a>17451     $table[<span class="stringliteral">&#39;miw&#39;</span>] /= $k;
<a name="l17452"></a>17452     $table[<span class="stringliteral">&#39;maw&#39;</span>] /= $k;
<a name="l17453"></a>17453 
<a name="l17454"></a>17454   <span class="comment">//  unset($table[&#39;miw&#39;]);</span>
<a name="l17455"></a>17455   <span class="comment">//  unset($table[&#39;maw&#39;]);</span>
<a name="l17456"></a>17456   <span class="comment">//  $table[&#39;wc&#39;] = array_pad(array(),$table[&#39;nc&#39;],array(&#39;miw&#39;=&gt;0,&#39;maw&#39;=&gt;0));</span>
<a name="l17457"></a>17457 
<a name="l17458"></a>17458     <span class="keywordflow">for</span>($j = 0 ; $j &lt; $table[<span class="stringliteral">&#39;nc&#39;</span>] ; $j++ ) { <span class="comment">//columns</span>
<a name="l17459"></a>17459 
<a name="l17460"></a>17460        $table[<span class="stringliteral">&#39;wc&#39;</span>][$j][<span class="stringliteral">&#39;miw&#39;</span>] /= $k;
<a name="l17461"></a>17461        $table[<span class="stringliteral">&#39;wc&#39;</span>][$j][<span class="stringliteral">&#39;maw&#39;</span>] /= $k;
<a name="l17462"></a>17462 
<a name="l17463"></a>17463        <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$j][<span class="stringliteral">&#39;absmiw&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;wc&#39;</span>][$j][<span class="stringliteral">&#39;absmiw&#39;</span>] ) $table[<span class="stringliteral">&#39;wc&#39;</span>][$j][<span class="stringliteral">&#39;absmiw&#39;</span>] /= $k;
<a name="l17464"></a>17464 
<a name="l17465"></a>17465        <span class="keywordflow">for</span>($i = 0 ; $i &lt; $table[<span class="stringliteral">&#39;nr&#39;</span>]; $i++ ) { <span class="comment">//rows</span>
<a name="l17466"></a>17466       $c = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>][$i][$j];
<a name="l17467"></a>17467       <span class="keywordflow">if</span> (isset($c) &amp;&amp; $c)  {
<a name="l17468"></a>17468         <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l17469"></a>17469           <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l17470"></a>17470           <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l17471"></a>17471           $cell = $this-&gt;_unpackCellBorder($c[<span class="stringliteral">&#39;borderbin&#39;</span>] );
<a name="l17472"></a>17472           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17473"></a>17473           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17474"></a>17474           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17475"></a>17475           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17476"></a>17476           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>] /= $k;
<a name="l17477"></a>17477           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>] /= $k;
<a name="l17478"></a>17478           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>] /= $k;
<a name="l17479"></a>17479           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>] /= $k;
<a name="l17480"></a>17480           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>] /= $k;
<a name="l17481"></a>17481           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>] /= $k;
<a name="l17482"></a>17482           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>] /= $k;
<a name="l17483"></a>17483           $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>] /= $k;
<a name="l17484"></a>17484           <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l17485"></a>17485           $c[<span class="stringliteral">&#39;borderbin&#39;</span>] = $this-&gt;_packCellBorder($cell);
<a name="l17486"></a>17486           }
<a name="l17487"></a>17487           <span class="keywordflow">else</span> {
<a name="l17488"></a>17488           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17489"></a>17489           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17490"></a>17490           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17491"></a>17491           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $k;
<a name="l17492"></a>17492           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>] /= $k;
<a name="l17493"></a>17493           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>] /= $k;
<a name="l17494"></a>17494           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>] /= $k;
<a name="l17495"></a>17495           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>] /= $k;
<a name="l17496"></a>17496           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>] /= $k;
<a name="l17497"></a>17497           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>] /= $k;
<a name="l17498"></a>17498           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>] /= $k;
<a name="l17499"></a>17499           $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>] /= $k;
<a name="l17500"></a>17500           }
<a name="l17501"></a>17501         }
<a name="l17502"></a>17502         $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] /= $k;
<a name="l17503"></a>17503         $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] /= $k;
<a name="l17504"></a>17504         $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] /= $k;
<a name="l17505"></a>17505         $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] /= $k;
<a name="l17506"></a>17506         $c[<span class="stringliteral">&#39;maxs&#39;</span>] /= $k;
<a name="l17507"></a>17507         <span class="keywordflow">if</span> (isset($c[<span class="charliteral">&#39;w&#39;</span>])) { $c[<span class="charliteral">&#39;w&#39;</span>] /= $k; }
<a name="l17508"></a>17508         $c[<span class="charliteral">&#39;s&#39;</span>] /= $k;
<a name="l17509"></a>17509         $c[<span class="stringliteral">&#39;maw&#39;</span>] /= $k;
<a name="l17510"></a>17510         $c[<span class="stringliteral">&#39;miw&#39;</span>] /= $k;
<a name="l17511"></a>17511         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;absmiw&#39;</span>])) $c[<span class="stringliteral">&#39;absmiw&#39;</span>] /= $k;
<a name="l17512"></a>17512         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nestedmaw&#39;</span>])) $c[<span class="stringliteral">&#39;nestedmaw&#39;</span>] /= $k;
<a name="l17513"></a>17513         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nestedmiw&#39;</span>])) $c[<span class="stringliteral">&#39;nestedmiw&#39;</span>] /= $k;
<a name="l17514"></a>17514       }
<a name="l17515"></a>17515        }<span class="comment">//rows</span>
<a name="l17516"></a>17516     }<span class="comment">//columns</span>
<a name="l17517"></a>17517     unset($c);
<a name="l17518"></a>17518 }
<a name="l17519"></a>17519 
<a name="l17520"></a>17520 <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l17521"></a>17521 function _packCellBorder($cell) {
<a name="l17522"></a>17522   <span class="keywordflow">if</span> (!is_array($cell) || !isset($cell)) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; }
<a name="l17523"></a>17523 
<a name="l17524"></a>17524   <span class="keywordflow">if</span> (!$this-&gt;packTableData) { <span class="keywordflow">return</span> $cell; }
<a name="l17525"></a>17525 
<a name="l17526"></a>17526   $bindata = pack(<span class="stringliteral">&quot;nndnnnA10nndnnnA10nndnnnA10nndnnnA10nd9&quot;</span>,
<a name="l17527"></a>17527   $cell[<span class="stringliteral">&#39;border&#39;</span>],
<a name="l17528"></a>17528   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;s&#39;</span>],
<a name="l17529"></a>17529   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>],
<a name="l17530"></a>17530   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],
<a name="l17531"></a>17531   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],
<a name="l17532"></a>17532   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],
<a name="l17533"></a>17533   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>],
<a name="l17534"></a>17534   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>],
<a name="l17535"></a>17535 
<a name="l17536"></a>17536   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;s&#39;</span>],
<a name="l17537"></a>17537   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>],
<a name="l17538"></a>17538   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],
<a name="l17539"></a>17539   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],
<a name="l17540"></a>17540   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],
<a name="l17541"></a>17541   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>],
<a name="l17542"></a>17542   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>],
<a name="l17543"></a>17543 
<a name="l17544"></a>17544   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;s&#39;</span>],
<a name="l17545"></a>17545   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>],
<a name="l17546"></a>17546   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],
<a name="l17547"></a>17547   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],
<a name="l17548"></a>17548   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],
<a name="l17549"></a>17549   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>],
<a name="l17550"></a>17550   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>],
<a name="l17551"></a>17551 
<a name="l17552"></a>17552   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;s&#39;</span>],
<a name="l17553"></a>17553   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>],
<a name="l17554"></a>17554   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],
<a name="l17555"></a>17555   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],
<a name="l17556"></a>17556   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],
<a name="l17557"></a>17557   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>],
<a name="l17558"></a>17558   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>],
<a name="l17559"></a>17559 
<a name="l17560"></a>17560   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>],
<a name="l17561"></a>17561   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>],
<a name="l17562"></a>17562   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>],
<a name="l17563"></a>17563   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>],
<a name="l17564"></a>17564   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>],
<a name="l17565"></a>17565   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>],
<a name="l17566"></a>17566   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>],
<a name="l17567"></a>17567   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>],
<a name="l17568"></a>17568 
<a name="l17569"></a>17569   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;cellposdom&#39;</span>]
<a name="l17570"></a>17570   );
<a name="l17571"></a>17571   <span class="keywordflow">return</span> $bindata;
<a name="l17572"></a>17572 }
<a name="l17573"></a>17573 
<a name="l17574"></a>17574 
<a name="l17575"></a>17575 
<a name="l17576"></a>17576 <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l17577"></a>17577 function _getBorderWidths($bindata) {
<a name="l17578"></a>17578   <span class="keywordflow">if</span> (!$bindata) { <span class="keywordflow">return</span> array(0,0,0,0); }
<a name="l17579"></a>17579 
<a name="l17580"></a>17580   <span class="keywordflow">if</span> (!$this-&gt;packTableData) { <span class="keywordflow">return</span> array($bindata[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>], $bindata[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>], $bindata[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>], $bindata[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); }
<a name="l17581"></a>17581 
<a name="l17582"></a>17582   $bd = unpack(<span class="stringliteral">&quot;nbord/nrs/drw/nrcr/nrcg/nrcb/A10rst/nrd/nls/dlw/nlcr/nlcg/nlcb/A10lst/nld/nts/dtw/ntcr/ntcg/ntcb/A10tst/ntd/nbs/dbw/nbcr/nbcg/nbcb/A10bst/nbd/dmbl/dmbr/dmrt/dmrb/dmtl/dmtr/dmlt/dmlb/dcpd&quot;</span>, $bindata);
<a name="l17583"></a>17583   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;rw&#39;</span>];
<a name="l17584"></a>17584   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;lw&#39;</span>];
<a name="l17585"></a>17585   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;tw&#39;</span>];
<a name="l17586"></a>17586   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;bw&#39;</span>];
<a name="l17587"></a>17587   <span class="keywordflow">return</span> array($bd[<span class="stringliteral">&#39;tw&#39;</span>], $bd[<span class="stringliteral">&#39;rw&#39;</span>], $bd[<span class="stringliteral">&#39;bw&#39;</span>], $bd[<span class="stringliteral">&#39;lw&#39;</span>]);
<a name="l17588"></a>17588 }
<a name="l17589"></a>17589 
<a name="l17590"></a>17590 
<a name="l17591"></a>17591 <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l17592"></a>17592 function _unpackCellBorder($bindata) {
<a name="l17593"></a>17593   <span class="keywordflow">if</span> (!$bindata) { <span class="keywordflow">return</span> array(); }
<a name="l17594"></a>17594 
<a name="l17595"></a>17595   <span class="keywordflow">if</span> (!$this-&gt;packTableData) { <span class="keywordflow">return</span> $bindata; }
<a name="l17596"></a>17596 
<a name="l17597"></a>17597   $bd = unpack(<span class="stringliteral">&quot;nbord/nrs/drw/nrcr/nrcg/nrcb/A10rst/nrd/nls/dlw/nlcr/nlcg/nlcb/A10lst/nld/nts/dtw/ntcr/ntcg/ntcb/A10tst/ntd/nbs/dbw/nbcr/nbcg/nbcb/A10bst/nbd/dmbl/dmbr/dmrt/dmrb/dmtl/dmtr/dmlt/dmlb/dcpd/&quot;</span>, $bindata);
<a name="l17598"></a>17598   $cell[<span class="stringliteral">&#39;border&#39;</span>] = $bd[<span class="stringliteral">&#39;bord&#39;</span>];
<a name="l17599"></a>17599   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = $bd[<span class="stringliteral">&#39;rs&#39;</span>];
<a name="l17600"></a>17600   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;rw&#39;</span>];
<a name="l17601"></a>17601   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bd[<span class="stringliteral">&#39;rcr&#39;</span>];
<a name="l17602"></a>17602   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>] = $bd[<span class="stringliteral">&#39;rcg&#39;</span>];
<a name="l17603"></a>17603   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bd[<span class="stringliteral">&#39;rcb&#39;</span>];
<a name="l17604"></a>17604   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = trim($bd[<span class="stringliteral">&#39;rst&#39;</span>]);
<a name="l17605"></a>17605   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $bd[<span class="stringliteral">&#39;rd&#39;</span>];
<a name="l17606"></a>17606 
<a name="l17607"></a>17607   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = $bd[<span class="stringliteral">&#39;ls&#39;</span>];
<a name="l17608"></a>17608   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;lw&#39;</span>];
<a name="l17609"></a>17609   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bd[<span class="stringliteral">&#39;lcr&#39;</span>];
<a name="l17610"></a>17610   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>] = $bd[<span class="stringliteral">&#39;lcg&#39;</span>];
<a name="l17611"></a>17611   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bd[<span class="stringliteral">&#39;lcb&#39;</span>];
<a name="l17612"></a>17612   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = trim($bd[<span class="stringliteral">&#39;lst&#39;</span>]);
<a name="l17613"></a>17613   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $bd[<span class="stringliteral">&#39;ld&#39;</span>];
<a name="l17614"></a>17614 
<a name="l17615"></a>17615   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = $bd[<span class="stringliteral">&#39;ts&#39;</span>];
<a name="l17616"></a>17616   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;tw&#39;</span>];
<a name="l17617"></a>17617   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bd[<span class="stringliteral">&#39;tcr&#39;</span>];
<a name="l17618"></a>17618   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>] = $bd[<span class="stringliteral">&#39;tcg&#39;</span>];
<a name="l17619"></a>17619   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bd[<span class="stringliteral">&#39;tcb&#39;</span>];
<a name="l17620"></a>17620   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = trim($bd[<span class="stringliteral">&#39;tst&#39;</span>]);
<a name="l17621"></a>17621   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $bd[<span class="stringliteral">&#39;td&#39;</span>];
<a name="l17622"></a>17622 
<a name="l17623"></a>17623   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = $bd[<span class="stringliteral">&#39;bs&#39;</span>];
<a name="l17624"></a>17624   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] = $bd[<span class="stringliteral">&#39;bw&#39;</span>];
<a name="l17625"></a>17625   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $bd[<span class="stringliteral">&#39;bcr&#39;</span>];
<a name="l17626"></a>17626   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>] = $bd[<span class="stringliteral">&#39;bcg&#39;</span>];
<a name="l17627"></a>17627   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $bd[<span class="stringliteral">&#39;bcb&#39;</span>];
<a name="l17628"></a>17628   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = trim($bd[<span class="stringliteral">&#39;bst&#39;</span>]);
<a name="l17629"></a>17629   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="stringliteral">&#39;dom&#39;</span>] = $bd[<span class="stringliteral">&#39;bd&#39;</span>];
<a name="l17630"></a>17630 
<a name="l17631"></a>17631   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>] = $bd[<span class="stringliteral">&#39;mbl&#39;</span>];
<a name="l17632"></a>17632   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>] = $bd[<span class="stringliteral">&#39;mbr&#39;</span>];
<a name="l17633"></a>17633   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>] = $bd[<span class="stringliteral">&#39;mrt&#39;</span>];
<a name="l17634"></a>17634   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>] = $bd[<span class="stringliteral">&#39;mrb&#39;</span>];
<a name="l17635"></a>17635   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>] = $bd[<span class="stringliteral">&#39;mtl&#39;</span>];
<a name="l17636"></a>17636   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>] = $bd[<span class="stringliteral">&#39;mtr&#39;</span>];
<a name="l17637"></a>17637   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>] = $bd[<span class="stringliteral">&#39;mlt&#39;</span>];
<a name="l17638"></a>17638   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>] = $bd[<span class="stringliteral">&#39;mlb&#39;</span>];
<a name="l17639"></a>17639   $cell[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;cellposdom&#39;</span>] = $bd[<span class="stringliteral">&#39;cpd&#39;</span>];
<a name="l17640"></a>17640 
<a name="l17641"></a>17641   <span class="keywordflow">return</span>($cell);
<a name="l17642"></a>17642 }
<a name="l17643"></a>17643 
<a name="l17644"></a>17644 
<a name="l17648"></a>17648 <span class="comment">//table   Array of (w, h, bc, nr, wc, hr, cells)</span>
<a name="l17649"></a>17649 <span class="comment">//w     Width of table</span>
<a name="l17650"></a>17650 <span class="comment">//h     Height of table</span>
<a name="l17651"></a>17651 <span class="comment">//nc      Number column</span>
<a name="l17652"></a>17652 <span class="comment">//nr      Number row</span>
<a name="l17653"></a>17653 <span class="comment">//hr      List of height of each row</span>
<a name="l17654"></a>17654 <span class="comment">//wc      List of width of each column</span>
<a name="l17655"></a>17655 <span class="comment">//cells   List of cells of each rows, cells[i][j] is a cell in the table</span>
<a name="l17656"></a>17656 function _tableColumnWidth(&amp;$table,$firstpass=<span class="keyword">false</span>){
<a name="l17657"></a>17657   $cs = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>];
<a name="l17658"></a>17658 
<a name="l17659"></a>17659   $nc = $table[<span class="stringliteral">&#39;nc&#39;</span>];
<a name="l17660"></a>17660   $nr = $table[<span class="stringliteral">&#39;nr&#39;</span>];
<a name="l17661"></a>17661   $listspan = array();
<a name="l17662"></a>17662 
<a name="l17663"></a>17663   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l17664"></a>17664     $tblbw = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] +  $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l17665"></a>17665   }
<a name="l17666"></a>17666   <span class="keywordflow">else</span> { $tblbw = $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]/2 + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]/2 + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]; }
<a name="l17667"></a>17667 
<a name="l17668"></a>17668   <span class="comment">// mPDF 4.2</span>
<a name="l17669"></a>17669   $longCJK = <span class="keyword">false</span>;
<a name="l17670"></a>17670 
<a name="l17671"></a>17671   <span class="comment">// ADDED table[&#39;l&#39;][colno] </span>
<a name="l17672"></a>17672   <span class="comment">// = total length of text approx (using $c[&#39;s&#39;]) in that column - used to approximately distribute col widths in _tableWidth</span>
<a name="l17673"></a>17673   <span class="comment">//</span>
<a name="l17674"></a>17674   <span class="keywordflow">for</span>($j = 0 ; $j &lt; $nc ; $j++ ) { <span class="comment">//columns</span>
<a name="l17675"></a>17675     $wc = &amp;$table[<span class="stringliteral">&#39;wc&#39;</span>][$j];
<a name="l17676"></a>17676     <span class="keywordflow">for</span>($i = 0 ; $i &lt; $nr ; $i++ ) { <span class="comment">//rows</span>
<a name="l17677"></a>17677       <span class="keywordflow">if</span> (isset($cs[$i][$j]) &amp;&amp; $cs[$i][$j])  {
<a name="l17678"></a>17678         $c = &amp;$cs[$i][$j];
<a name="l17679"></a>17679 
<a name="l17680"></a>17680         <span class="comment">// mPDF 4.3.006</span>
<a name="l17681"></a>17681         <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l17682"></a>17682              <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {  <span class="comment">// NB twice border width</span>
<a name="l17683"></a>17683             $extrcw = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l17684"></a>17684              }
<a name="l17685"></a>17685              <span class="keywordflow">else</span> {
<a name="l17686"></a>17686             $extrcw = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l17687"></a>17687              }
<a name="l17688"></a>17688         }
<a name="l17689"></a>17689         <span class="keywordflow">else</span> {
<a name="l17690"></a>17690            <span class="comment">// mPDF 4.3.009</span>
<a name="l17691"></a>17691            <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l17692"></a>17692             list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($c[<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l17693"></a>17693            }
<a name="l17694"></a>17694            <span class="keywordflow">else</span> { 
<a name="l17695"></a>17695           $br = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l17696"></a>17696           $bl = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l17697"></a>17697            }
<a name="l17698"></a>17698            <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {  <span class="comment">// NB twice border width</span>
<a name="l17699"></a>17699           $extrcw = $bl + $br + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l17700"></a>17700            }
<a name="l17701"></a>17701            <span class="keywordflow">else</span> {
<a name="l17702"></a>17702           $extrcw = $bl/2 + $br/2 + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l17703"></a>17703            }
<a name="l17704"></a>17704         }
<a name="l17705"></a>17705 
<a name="l17706"></a>17706         <span class="comment">// mPDF 3.0</span>
<a name="l17707"></a>17707         <span class="comment">//$mw = $this-&gt;GetStringWidth(&#39;W&#39;) + $extrcw ;</span>
<a name="l17708"></a>17708         $mw = 0;
<a name="l17709"></a>17709 
<a name="l17710"></a>17710         $c[<span class="stringliteral">&#39;absmiw&#39;</span>] = $mw;
<a name="l17711"></a>17711 
<a name="l17712"></a>17712         <span class="keywordflow">if</span> (isset($c[<span class="charliteral">&#39;R&#39;</span>]) &amp;&amp; $c[<span class="charliteral">&#39;R&#39;</span>]) {
<a name="l17713"></a>17713           $c[<span class="stringliteral">&#39;maw&#39;</span>] = $c[<span class="stringliteral">&#39;miw&#39;</span>] = $this-&gt;FontSize + $extrcw ;
<a name="l17714"></a>17714           <span class="keywordflow">if</span> (isset($c[<span class="charliteral">&#39;w&#39;</span>])) { <span class="comment">// If cell width is specified</span>
<a name="l17715"></a>17715             <span class="keywordflow">if</span> ($c[<span class="stringliteral">&#39;miw&#39;</span>] &lt;$c[<span class="charliteral">&#39;w&#39;</span>]) { $c[<span class="stringliteral">&#39;miw&#39;</span>] = $c[<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l17716"></a>17716           }
<a name="l17717"></a>17717           <span class="keywordflow">if</span> (!isset($c[<span class="stringliteral">&#39;colspan&#39;</span>])) {
<a name="l17718"></a>17718             <span class="keywordflow">if</span> ($wc[<span class="stringliteral">&#39;miw&#39;</span>] &lt; $c[<span class="stringliteral">&#39;miw&#39;</span>]) { $wc[<span class="stringliteral">&#39;miw&#39;</span>]  = $c[<span class="stringliteral">&#39;miw&#39;</span>]; }
<a name="l17719"></a>17719             <span class="keywordflow">if</span> ($wc[<span class="stringliteral">&#39;maw&#39;</span>] &lt; $c[<span class="stringliteral">&#39;maw&#39;</span>]) { $wc[<span class="stringliteral">&#39;maw&#39;</span>]  = $c[<span class="stringliteral">&#39;maw&#39;</span>]; }
<a name="l17720"></a>17720 
<a name="l17721"></a>17721             <span class="keywordflow">if</span> ($firstpass) { 
<a name="l17722"></a>17722                <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;l&#39;</span>][$j]) ) { 
<a name="l17723"></a>17723               $table[<span class="charliteral">&#39;l&#39;</span>][$j] += $c[<span class="stringliteral">&#39;miw&#39;</span>] ;
<a name="l17724"></a>17724                }
<a name="l17725"></a>17725                <span class="keywordflow">else</span> {
<a name="l17726"></a>17726               $table[<span class="charliteral">&#39;l&#39;</span>][$j] = $c[<span class="stringliteral">&#39;miw&#39;</span>] ;
<a name="l17727"></a>17727                }
<a name="l17728"></a>17728             }
<a name="l17729"></a>17729           }
<a name="l17730"></a>17730           <span class="keywordflow">if</span> ($c[<span class="stringliteral">&#39;miw&#39;</span>] &gt; $wc[<span class="stringliteral">&#39;miw&#39;</span>]) { $wc[<span class="stringliteral">&#39;miw&#39;</span>] = $c[<span class="stringliteral">&#39;miw&#39;</span>]; } 
<a name="l17731"></a>17731                 <span class="keywordflow">if</span> ($wc[<span class="stringliteral">&#39;miw&#39;</span>] &gt; $wc[<span class="stringliteral">&#39;maw&#39;</span>]) { $wc[<span class="stringliteral">&#39;maw&#39;</span>] = $wc[<span class="stringliteral">&#39;miw&#39;</span>]; }
<a name="l17732"></a>17732           <span class="keywordflow">continue</span>;
<a name="l17733"></a>17733         }
<a name="l17734"></a>17734 
<a name="l17735"></a>17735         <span class="keywordflow">if</span> ($firstpass) {
<a name="l17736"></a>17736           <span class="keywordflow">if</span> (isset($c[<span class="charliteral">&#39;s&#39;</span>])) { $c[<span class="charliteral">&#39;s&#39;</span>] += $extrcw; }
<a name="l17737"></a>17737           <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;maxs&#39;</span>])) { $c[<span class="stringliteral">&#39;maxs&#39;</span>] += $extrcw; }
<a name="l17738"></a>17738           <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nestedmiw&#39;</span>])) { $c[<span class="stringliteral">&#39;nestedmiw&#39;</span>] += $extrcw; }
<a name="l17739"></a>17739           <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nestedmaw&#39;</span>])) { $c[<span class="stringliteral">&#39;nestedmaw&#39;</span>] += $extrcw; }
<a name="l17740"></a>17740         }
<a name="l17741"></a>17741 
<a name="l17742"></a>17742 
<a name="l17743"></a>17743         <span class="comment">// If minimum width has already been set by a nested table or inline object (image/form), use it</span>
<a name="l17744"></a>17744         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nestedmiw&#39;</span>])) { $miw = $c[<span class="stringliteral">&#39;nestedmiw&#39;</span>]; }
<a name="l17745"></a>17745         <span class="keywordflow">else</span>  { $miw = $mw; }
<a name="l17746"></a>17746 
<a name="l17747"></a>17747         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;maxs&#39;</span>]) &amp;&amp; $c[<span class="stringliteral">&#39;maxs&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>) { $c[<span class="charliteral">&#39;s&#39;</span>] = $c[<span class="stringliteral">&#39;maxs&#39;</span>]; }
<a name="l17748"></a>17748 
<a name="l17749"></a>17749         <span class="comment">// If maximum width has already been set by a nested table, use it</span>
<a name="l17750"></a>17750         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nestedmaw&#39;</span>])) { $c[<span class="stringliteral">&#39;maw&#39;</span>] = $c[<span class="stringliteral">&#39;nestedmaw&#39;</span>]; }
<a name="l17751"></a>17751         <span class="keywordflow">else</span> $c[<span class="stringliteral">&#39;maw&#39;</span>] = $c[<span class="charliteral">&#39;s&#39;</span>];
<a name="l17752"></a>17752 
<a name="l17753"></a>17753         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;nowrap&#39;</span>]) &amp;&amp; $c[<span class="stringliteral">&#39;nowrap&#39;</span>]) { $miw = $c[<span class="stringliteral">&#39;maw&#39;</span>]; }
<a name="l17754"></a>17754 
<a name="l17755"></a>17755         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $firstpass) {
<a name="l17756"></a>17756           <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;colspan&#39;</span>])) { <span class="comment">// Not perfect - but % set on colspan is shared equally on cols.</span>
<a name="l17757"></a>17757              <span class="keywordflow">for</span>($k=0;$k&lt;$c[<span class="stringliteral">&#39;colspan&#39;</span>];$k++) {
<a name="l17758"></a>17758             $table[<span class="stringliteral">&#39;wc&#39;</span>][($j+$k)][<span class="stringliteral">&#39;wpercent&#39;</span>] = $c[<span class="stringliteral">&#39;wpercent&#39;</span>] / $c[<span class="stringliteral">&#39;colspan&#39;</span>];
<a name="l17759"></a>17759              }
<a name="l17760"></a>17760           }
<a name="l17761"></a>17761           <span class="keywordflow">else</span> {
<a name="l17762"></a>17762             <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>]) { $c[<span class="charliteral">&#39;w&#39;</span>] = $c[<span class="stringliteral">&#39;wpercent&#39;</span>]/100 * ($table[<span class="charliteral">&#39;w&#39;</span>] - $tblbw ); }
<a name="l17763"></a>17763             $wc[<span class="stringliteral">&#39;wpercent&#39;</span>] = $c[<span class="stringliteral">&#39;wpercent&#39;</span>];
<a name="l17764"></a>17764           }
<a name="l17765"></a>17765         }
<a name="l17766"></a>17766 
<a name="l17767"></a>17767 
<a name="l17768"></a>17768         <span class="keywordflow">if</span> (isset($c[<span class="charliteral">&#39;w&#39;</span>])) { <span class="comment">// If cell width is specified</span>
<a name="l17769"></a>17769           <span class="keywordflow">if</span> ($miw&lt;$c[<span class="charliteral">&#39;w&#39;</span>]) { $c[<span class="stringliteral">&#39;miw&#39;</span>] = $c[<span class="charliteral">&#39;w&#39;</span>]; }  <span class="comment">// Cell min width = that specified</span>
<a name="l17770"></a>17770           <span class="keywordflow">if</span> ($miw&gt;$c[<span class="charliteral">&#39;w&#39;</span>]) { $c[<span class="stringliteral">&#39;miw&#39;</span>] = $c[<span class="charliteral">&#39;w&#39;</span>] = $miw; } <span class="comment">// If width specified is less than minimum allowed (W) increase it</span>
<a name="l17771"></a>17771           <span class="keywordflow">if</span> (!isset($wc[<span class="charliteral">&#39;w&#39;</span>])) { $wc[<span class="charliteral">&#39;w&#39;</span>] = 1; }   <span class="comment">// If the Col width is not specified = set it to 1</span>
<a name="l17772"></a>17772 
<a name="l17773"></a>17773         }
<a name="l17774"></a>17774         <span class="keywordflow">else</span> { $c[<span class="stringliteral">&#39;miw&#39;</span>] = $miw; }  <span class="comment">// If cell width not specified -&gt; set Cell min width it to minimum allowed (W)</span>
<a name="l17775"></a>17775 
<a name="l17776"></a>17776         <span class="keywordflow">if</span> ($c[<span class="stringliteral">&#39;maw&#39;</span>]  &lt; $c[<span class="stringliteral">&#39;miw&#39;</span>]) { $c[<span class="stringliteral">&#39;maw&#39;</span>] = $c[<span class="stringliteral">&#39;miw&#39;</span>]; }  <span class="comment">// If Cell max width &lt; Minwidth - increase it to =</span>
<a name="l17777"></a>17777         <span class="keywordflow">if</span> (!isset($c[<span class="stringliteral">&#39;colspan&#39;</span>])) {
<a name="l17778"></a>17778           <span class="keywordflow">if</span> ($wc[<span class="stringliteral">&#39;miw&#39;</span>] &lt; $c[<span class="stringliteral">&#39;miw&#39;</span>]) { $wc[<span class="stringliteral">&#39;miw&#39;</span>]  = $c[<span class="stringliteral">&#39;miw&#39;</span>]; }  <span class="comment">// Update Col Minimum and maximum widths</span>
<a name="l17779"></a>17779           <span class="keywordflow">if</span> ($wc[<span class="stringliteral">&#39;maw&#39;</span>] &lt; $c[<span class="stringliteral">&#39;maw&#39;</span>]) { $wc[<span class="stringliteral">&#39;maw&#39;</span>]  = $c[<span class="stringliteral">&#39;maw&#39;</span>]; }
<a name="l17780"></a>17780           <span class="keywordflow">if</span> ((isset($wc[<span class="stringliteral">&#39;absmiw&#39;</span>]) &amp;&amp; $wc[<span class="stringliteral">&#39;absmiw&#39;</span>] &lt; $c[<span class="stringliteral">&#39;absmiw&#39;</span>]) || !isset($wc[<span class="stringliteral">&#39;absmiw&#39;</span>])) { $wc[<span class="stringliteral">&#39;absmiw&#39;</span>] = $c[<span class="stringliteral">&#39;absmiw&#39;</span>]; }  <span class="comment">// Update Col Minimum and maximum widths</span>
<a name="l17781"></a>17781 
<a name="l17782"></a>17782           <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;l&#39;</span>][$j]) ) { 
<a name="l17783"></a>17783             $table[<span class="charliteral">&#39;l&#39;</span>][$j] += $c[<span class="charliteral">&#39;s&#39;</span>];
<a name="l17784"></a>17784   
<a name="l17785"></a>17785           }
<a name="l17786"></a>17786           <span class="keywordflow">else</span> {
<a name="l17787"></a>17787             $table[<span class="charliteral">&#39;l&#39;</span>][$j] = $c[<span class="charliteral">&#39;s&#39;</span>];
<a name="l17788"></a>17788           }
<a name="l17789"></a>17789 
<a name="l17790"></a>17790         }
<a name="l17791"></a>17791         <span class="keywordflow">else</span> { 
<a name="l17792"></a>17792           $listspan[] = array($i,$j);
<a name="l17793"></a>17793         }
<a name="l17794"></a>17794 
<a name="l17795"></a>17795       <span class="comment">//Check if minimum width of the whole column is big enough for largest word to fit</span>
<a name="l17796"></a>17796               $auxtext = implode(<span class="stringliteral">&quot;&quot;</span>,$c[<span class="stringliteral">&#39;text&#39;</span>]);
<a name="l17797"></a>17797         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;textbuffer&#39;</span>])) {
<a name="l17798"></a>17798                 $minwidth = $this-&gt;TableCheckMinWidth($auxtext,$wc[<span class="stringliteral">&#39;miw&#39;</span>]- $extrcw ,0,$c[<span class="stringliteral">&#39;textbuffer&#39;</span>]); 
<a name="l17799"></a>17799         }
<a name="l17800"></a>17800         <span class="keywordflow">else</span> { $minwidth = 0; }
<a name="l17801"></a>17801               <span class="keywordflow">if</span> ($minwidth &lt; 0) { 
<a name="l17802"></a>17802           <span class="comment">// mPDF 4.2</span>
<a name="l17803"></a>17803           <span class="keywordflow">if</span>(preg_match(<span class="stringliteral">&quot;/[&quot;</span>.$this-&gt;pregCJKchars.<span class="stringliteral">&quot;]{10,}/u&quot;</span>,$auxtext)) { $longCJK = <span class="keyword">true</span>; }
<a name="l17804"></a>17804           <span class="comment">//increase minimum width</span>
<a name="l17805"></a>17805           <span class="keywordflow">if</span> (!isset($c[<span class="stringliteral">&#39;colspan&#39;</span>])) {
<a name="l17806"></a>17806             $wc[<span class="stringliteral">&#39;miw&#39;</span>] = max($wc[<span class="stringliteral">&#39;miw&#39;</span>],((-$minwidth) + $extrcw) );  
<a name="l17807"></a>17807           }
<a name="l17808"></a>17808         }
<a name="l17809"></a>17809         <span class="keywordflow">if</span> (!isset($c[<span class="stringliteral">&#39;colspan&#39;</span>])) {
<a name="l17810"></a>17810                 <span class="keywordflow">if</span> ($wc[<span class="stringliteral">&#39;miw&#39;</span>] &gt; $wc[<span class="stringliteral">&#39;maw&#39;</span>]) { $wc[<span class="stringliteral">&#39;maw&#39;</span>] = $wc[<span class="stringliteral">&#39;miw&#39;</span>]; } <span class="comment">//update maximum width, if needed</span>
<a name="l17811"></a>17811         }
<a name="l17812"></a>17812       }
<a name="l17813"></a>17813       unset($c);
<a name="l17814"></a>17814     }<span class="comment">//rows</span>
<a name="l17815"></a>17815   }<span class="comment">//columns</span>
<a name="l17816"></a>17816 
<a name="l17817"></a>17817 
<a name="l17818"></a>17818   <span class="comment">// COLUMN SPANS</span>
<a name="l17819"></a>17819   $wc = &amp;$table[<span class="stringliteral">&#39;wc&#39;</span>];
<a name="l17820"></a>17820   <span class="keywordflow">foreach</span> ($listspan as $span) {
<a name="l17821"></a>17821     list($i,$j) = $span;
<a name="l17822"></a>17822     $c = &amp;$cs[$i][$j];
<a name="l17823"></a>17823     $lc = $j + $c[<span class="stringliteral">&#39;colspan&#39;</span>];
<a name="l17824"></a>17824     <span class="keywordflow">if</span> ($lc &gt; $nc) { $lc = $nc; }
<a name="l17825"></a>17825     
<a name="l17826"></a>17826     $wis = $wisa = 0;
<a name="l17827"></a>17827     $was = $wasa = 0;
<a name="l17828"></a>17828     $list = array();
<a name="l17829"></a>17829     <span class="keywordflow">for</span>($k=$j;$k&lt;$lc;$k++) {
<a name="l17830"></a>17830       <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;l&#39;</span>][$k]) ) { 
<a name="l17831"></a>17831         <span class="keywordflow">if</span> ($c[<span class="charliteral">&#39;R&#39;</span>]) { $table[<span class="charliteral">&#39;l&#39;</span>][$k] += $c[<span class="stringliteral">&#39;miw&#39;</span>]/$c[<span class="stringliteral">&#39;colspan&#39;</span>] ; }
<a name="l17832"></a>17832         <span class="keywordflow">else</span> { $table[<span class="charliteral">&#39;l&#39;</span>][$k] += $c[<span class="charliteral">&#39;s&#39;</span>]/$c[<span class="stringliteral">&#39;colspan&#39;</span>]; }
<a name="l17833"></a>17833       }
<a name="l17834"></a>17834       <span class="keywordflow">else</span> {
<a name="l17835"></a>17835         <span class="keywordflow">if</span> ($c[<span class="charliteral">&#39;R&#39;</span>]) { $table[<span class="charliteral">&#39;l&#39;</span>][$k] = $c[<span class="stringliteral">&#39;miw&#39;</span>]/$c[<span class="stringliteral">&#39;colspan&#39;</span>] ; }
<a name="l17836"></a>17836         <span class="keywordflow">else</span> { $table[<span class="charliteral">&#39;l&#39;</span>][$k] = $c[<span class="charliteral">&#39;s&#39;</span>]/$c[<span class="stringliteral">&#39;colspan&#39;</span>]; }
<a name="l17837"></a>17837       }
<a name="l17838"></a>17838       $wis += $wc[$k][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l17839"></a>17839       $was += $wc[$k][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l17840"></a>17840       <span class="keywordflow">if</span> (!isset($c[<span class="charliteral">&#39;w&#39;</span>])) {
<a name="l17841"></a>17841         $list[] = $k;
<a name="l17842"></a>17842         $wisa += $wc[$k][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l17843"></a>17843         $wasa += $wc[$k][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l17844"></a>17844       }
<a name="l17845"></a>17845     }
<a name="l17846"></a>17846     <span class="keywordflow">if</span> ($c[<span class="stringliteral">&#39;miw&#39;</span>] &gt; $wis) {
<a name="l17847"></a>17847       <span class="keywordflow">if</span> (!$wis) {
<a name="l17848"></a>17848         <span class="keywordflow">for</span>($k=$j;$k&lt;$lc;$k++) { $wc[$k][<span class="stringliteral">&#39;miw&#39;</span>] = $c[<span class="stringliteral">&#39;miw&#39;</span>]/$c[<span class="stringliteral">&#39;colspan&#39;</span>]; }
<a name="l17849"></a>17849       }
<a name="l17850"></a>17850       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!count($list)) {
<a name="l17851"></a>17851         $wi = $c[<span class="stringliteral">&#39;miw&#39;</span>] - $wis;
<a name="l17852"></a>17852         <span class="keywordflow">for</span>($k=$j;$k&lt;$lc;$k++) { $wc[$k][<span class="stringliteral">&#39;miw&#39;</span>] += ($wc[$k][<span class="stringliteral">&#39;miw&#39;</span>]/$wis)*$wi; }
<a name="l17853"></a>17853       }
<a name="l17854"></a>17854       <span class="keywordflow">else</span> {
<a name="l17855"></a>17855         $wi = $c[<span class="stringliteral">&#39;miw&#39;</span>] - $wis;
<a name="l17856"></a>17856         <span class="keywordflow">foreach</span> ($list as $k) { $wc[$k][<span class="stringliteral">&#39;miw&#39;</span>] += ($wc[$k][<span class="stringliteral">&#39;miw&#39;</span>]/$wisa)*$wi; }
<a name="l17857"></a>17857       }
<a name="l17858"></a>17858     }
<a name="l17859"></a>17859     <span class="keywordflow">if</span> ($c[<span class="stringliteral">&#39;maw&#39;</span>] &gt; $was) {
<a name="l17860"></a>17860       <span class="keywordflow">if</span> (!$wis) {
<a name="l17861"></a>17861         <span class="keywordflow">for</span>($k=$j;$k&lt;$lc;$k++) { $wc[$k][<span class="stringliteral">&#39;maw&#39;</span>] = $c[<span class="stringliteral">&#39;maw&#39;</span>]/$c[<span class="stringliteral">&#39;colspan&#39;</span>]; }
<a name="l17862"></a>17862       }
<a name="l17863"></a>17863       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!count($list)) {
<a name="l17864"></a>17864         $wi = $c[<span class="stringliteral">&#39;maw&#39;</span>] - $was;
<a name="l17865"></a>17865         <span class="keywordflow">for</span>($k=$j;$k&lt;$lc;$k++) { $wc[$k][<span class="stringliteral">&#39;maw&#39;</span>] += ($wc[$k][<span class="stringliteral">&#39;maw&#39;</span>]/$was)*$wi; }
<a name="l17866"></a>17866       }
<a name="l17867"></a>17867       <span class="keywordflow">else</span> {
<a name="l17868"></a>17868         $wi = $c[<span class="stringliteral">&#39;maw&#39;</span>] - $was;
<a name="l17869"></a>17869         <span class="keywordflow">foreach</span> ($list as $k) { $wc[$k][<span class="stringliteral">&#39;maw&#39;</span>] += ($wc[$k][<span class="stringliteral">&#39;maw&#39;</span>]/$wasa)*$wi; }
<a name="l17870"></a>17870       }
<a name="l17871"></a>17871     }
<a name="l17872"></a>17872     unset($c);
<a name="l17873"></a>17873   }
<a name="l17874"></a>17874 
<a name="l17875"></a>17875 
<a name="l17876"></a>17876   $checkminwidth = 0;
<a name="l17877"></a>17877   $checkmaxwidth = 0;
<a name="l17878"></a>17878   $totallength = 0;
<a name="l17879"></a>17879 
<a name="l17880"></a>17880   <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $nc ; $i++ ) {
<a name="l17881"></a>17881     $checkminwidth += $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l17882"></a>17882     $checkmaxwidth += $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l17883"></a>17883     $totallength += $table[<span class="charliteral">&#39;l&#39;</span>][$i];
<a name="l17884"></a>17884   }
<a name="l17885"></a>17885 
<a name="l17886"></a>17886   <span class="keywordflow">if</span> (!isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $firstpass) {
<a name="l17887"></a>17887      $sumpc = 0;
<a name="l17888"></a>17888      <span class="comment">// mPDF 3.2</span>
<a name="l17889"></a>17889      $notset = 0;
<a name="l17890"></a>17890      <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $nc ; $i++ ) {
<a name="l17891"></a>17891       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) {
<a name="l17892"></a>17892       $sumpc += $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>];
<a name="l17893"></a>17893       }
<a name="l17894"></a>17894       <span class="comment">// mPDF 3.2</span>
<a name="l17895"></a>17895       <span class="keywordflow">else</span> { $notset++; }
<a name="l17896"></a>17896      }
<a name="l17897"></a>17897 
<a name="l17898"></a>17898      <span class="comment">// mPDF 3.2   If sum of widths as %  &gt;= 100% and not all columns are set</span>
<a name="l17899"></a>17899     <span class="comment">// Set a nominal width of 1% for unset columns</span>
<a name="l17900"></a>17900      <span class="keywordflow">if</span> ($sumpc &gt;= 100 &amp;&amp; $notset) {
<a name="l17901"></a>17901       <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $nc ; $i++ ) {
<a name="l17902"></a>17902       <span class="keywordflow">if</span> ((!isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) || !$table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp;
<a name="l17903"></a>17903       (!isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>]) || !$table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>])) {
<a name="l17904"></a>17904       $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>] = 1;
<a name="l17905"></a>17905       }
<a name="l17906"></a>17906       }
<a name="l17907"></a>17907      }
<a name="l17908"></a>17908 
<a name="l17909"></a>17909 
<a name="l17910"></a>17910      <span class="keywordflow">if</span> ($sumpc) {  <span class="comment">// if any percents are set</span>
<a name="l17911"></a>17911     <span class="comment">// mPDF 4.0</span>
<a name="l17912"></a>17912     $sumnonpc = (100 - $sumpc);
<a name="l17913"></a>17913     $sumpc = max($sumpc,100);
<a name="l17914"></a>17914         $miwleft = 0;
<a name="l17915"></a>17915     $miwleftcount = 0;
<a name="l17916"></a>17916     $miwsurplusnonpc = 0;
<a name="l17917"></a>17917     $maxcalcmiw  = 0;
<a name="l17918"></a>17918         $mawleft = 0;
<a name="l17919"></a>17919     $mawleftcount = 0;
<a name="l17920"></a>17920     $mawsurplusnonpc = 0;
<a name="l17921"></a>17921     $maxcalcmaw  = 0;
<a name="l17922"></a>17922     <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $nc ; $i++ ) {
<a name="l17923"></a>17923       <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>])) {
<a name="l17924"></a>17924       $maxcalcmiw = max($maxcalcmiw, ($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>] * $sumpc /$table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) );
<a name="l17925"></a>17925       $maxcalcmaw = max($maxcalcmaw, ($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>] * $sumpc /$table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) );
<a name="l17926"></a>17926       }
<a name="l17927"></a>17927       <span class="keywordflow">else</span> {
<a name="l17928"></a>17928       $miwleft += $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l17929"></a>17929       $mawleft += $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l17930"></a>17930         <span class="keywordflow">if</span> (!isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>])) { $miwleftcount++; $mawleftcount++; }
<a name="l17931"></a>17931       }
<a name="l17932"></a>17932     }
<a name="l17933"></a>17933     <span class="keywordflow">if</span> ($miwleft &amp;&amp; $sumnonpc &gt; 0) { $miwnon = $miwleft * 100 / $sumnonpc; }
<a name="l17934"></a>17934     <span class="keywordflow">if</span> ($mawleft &amp;&amp; $sumnonpc &gt; 0) { $mawnon = $mawleft * 100 / $sumnonpc; }
<a name="l17935"></a>17935     <span class="keywordflow">if</span> (($miwnon &gt; $checkminwidth || $maxcalcmiw &gt; $checkminwidth) &amp;&amp; $this-&gt;keep_table_proportions) {
<a name="l17936"></a>17936       <span class="keywordflow">if</span> ($miwnon &gt; $maxcalcmiw) { 
<a name="l17937"></a>17937         $miwsurplusnonpc = round((($miwnon * $sumnonpc / 100) - $miwleft),3); 
<a name="l17938"></a>17938         $checkminwidth = $miwnon; 
<a name="l17939"></a>17939       }
<a name="l17940"></a>17940       <span class="keywordflow">else</span> { $checkminwidth = $maxcalcmiw; }
<a name="l17941"></a>17941       <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $nc ; $i++ ) {
<a name="l17942"></a>17942         <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>])) {
<a name="l17943"></a>17943         $newmiw = $checkminwidth * $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]/100;
<a name="l17944"></a>17944         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>] &lt; $newmiw) {
<a name="l17945"></a>17945           $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>] = $newmiw;
<a name="l17946"></a>17946         }
<a name="l17947"></a>17947         $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>] = 1;
<a name="l17948"></a>17948         }
<a name="l17949"></a>17949         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($miwsurplusnonpc &amp;&amp; !$table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l17950"></a>17950         $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>] +=  $miwsurplusnonpc / $miwleftcount;
<a name="l17951"></a>17951         }
<a name="l17952"></a>17952       }
<a name="l17953"></a>17953     }
<a name="l17954"></a>17954     <span class="keywordflow">if</span> (($mawnon &gt; $checkmaxwidth || $maxcalcmaw &gt; $checkmaxwidth )) {
<a name="l17955"></a>17955       <span class="keywordflow">if</span> ($mawnon &gt; $maxcalcmaw) { 
<a name="l17956"></a>17956         $mawsurplusnonpc = round((($mawnon * $sumnonpc / 100) - $mawleft),3); 
<a name="l17957"></a>17957         $checkmaxwidth = $mawnon; 
<a name="l17958"></a>17958       }
<a name="l17959"></a>17959       <span class="keywordflow">else</span> { $checkmaxwidth = $maxcalcmaw; }
<a name="l17960"></a>17960       <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $nc ; $i++ ) {
<a name="l17961"></a>17961         <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>])) {
<a name="l17962"></a>17962         $newmaw = $checkmaxwidth * $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;wpercent&#39;</span>]/100;
<a name="l17963"></a>17963         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>] &lt; $newmaw) {
<a name="l17964"></a>17964           $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>] = $newmaw;
<a name="l17965"></a>17965         }
<a name="l17966"></a>17966         $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>] = 1;
<a name="l17967"></a>17967         }
<a name="l17968"></a>17968         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($mawsurplusnonpc &amp;&amp; !$table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l17969"></a>17969         $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>] +=  $mawsurplusnonpc / $mawleftcount;
<a name="l17970"></a>17970         }
<a name="l17971"></a>17971         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>] &lt; $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>]) { $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;maw&#39;</span>] = $table[<span class="stringliteral">&#39;wc&#39;</span>][$i][<span class="stringliteral">&#39;miw&#39;</span>]; }
<a name="l17972"></a>17972       }
<a name="l17973"></a>17973     }
<a name="l17974"></a>17974     <span class="keywordflow">if</span> ($checkminwidth &gt; $checkmaxwidth) { $checkmaxwidth = $checkminwidth; }
<a name="l17975"></a>17975      }
<a name="l17976"></a>17976   }
<a name="l17977"></a>17977 
<a name="l17978"></a>17978   <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;wpercent&#39;</span>]) {
<a name="l17979"></a>17979     $checkminwidth *= (100 / $table[<span class="stringliteral">&#39;wpercent&#39;</span>]);
<a name="l17980"></a>17980     $checkmaxwidth *= (100 / $table[<span class="stringliteral">&#39;wpercent&#39;</span>]);
<a name="l17981"></a>17981   }
<a name="l17982"></a>17982 
<a name="l17983"></a>17983 
<a name="l17984"></a>17984   $checkminwidth += $tblbw ;
<a name="l17985"></a>17985   $checkmaxwidth += $tblbw ;
<a name="l17986"></a>17986 
<a name="l17987"></a>17987   <span class="comment">// Table[&#39;miw&#39;] set by percent in first pass may be larger than sum of column miw</span>
<a name="l17988"></a>17988   <span class="keywordflow">if</span> ((isset($table[<span class="stringliteral">&#39;miw&#39;</span>]) &amp;&amp; $checkminwidth &gt; $table[<span class="stringliteral">&#39;miw&#39;</span>]) || !isset($table[<span class="stringliteral">&#39;miw&#39;</span>])) {  $table[<span class="stringliteral">&#39;miw&#39;</span>] = $checkminwidth; }
<a name="l17989"></a>17989   <span class="keywordflow">if</span> ((isset($table[<span class="stringliteral">&#39;maw&#39;</span>]) &amp;&amp; $checkmaxwidth &gt; $table[<span class="stringliteral">&#39;maw&#39;</span>]) || !isset($table[<span class="stringliteral">&#39;maw&#39;</span>])) { $table[<span class="stringliteral">&#39;maw&#39;</span>] = $checkmaxwidth; }
<a name="l17990"></a>17990   $table[<span class="stringliteral">&#39;tl&#39;</span>] = $totallength ;
<a name="l17991"></a>17991 
<a name="l17992"></a>17992   <span class="comment">// mPDF 4.2</span>
<a name="l17993"></a>17993   <span class="keywordflow">if</span> (!$this-&gt;isCJK &amp;&amp; !$longCJK) {
<a name="l17994"></a>17994     <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l17995"></a>17995       $mxw = $this-&gt;tbrot_maxw;
<a name="l17996"></a>17996     }
<a name="l17997"></a>17997     <span class="keywordflow">else</span> {
<a name="l17998"></a>17998       $mxw = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l17999"></a>17999     }
<a name="l18000"></a>18000 
<a name="l18001"></a>18001     <span class="keywordflow">if</span> (($table[<span class="stringliteral">&#39;overflow&#39;</span>]==<span class="stringliteral">&#39;visible&#39;</span> || $table[<span class="stringliteral">&#39;overflow&#39;</span>]==<span class="stringliteral">&#39;hidden&#39;</span>) &amp;&amp; !$this-&gt;table_rotate &amp;&amp; !$this-&gt;ColActive &amp;&amp; $checkminwidth &gt; $mxw) { 
<a name="l18002"></a>18002       $table[<span class="charliteral">&#39;w&#39;</span>] = $table[<span class="stringliteral">&#39;miw&#39;</span>]; 
<a name="l18003"></a>18003       <span class="keywordflow">return</span> array(0,0);
<a name="l18004"></a>18004     }
<a name="l18005"></a>18005     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;overflow&#39;</span>]==<span class="stringliteral">&#39;wrap&#39;</span>) { <span class="keywordflow">return</span> array(0,0); }
<a name="l18006"></a>18006 
<a name="l18007"></a>18007     <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] ) {
<a name="l18008"></a>18008       <span class="keywordflow">if</span> ($table[<span class="charliteral">&#39;w&#39;</span>] &gt;= $checkminwidth &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] &lt;= $mxw) { $table[<span class="stringliteral">&#39;maw&#39;</span>] = $mxw = $table[<span class="charliteral">&#39;w&#39;</span>]; } <span class="comment">// mPDF 4.0</span>
<a name="l18009"></a>18009       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($table[<span class="charliteral">&#39;w&#39;</span>] &gt;= $checkminwidth &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] &gt; $mxw &amp;&amp; $this-&gt;keep_table_proportions) { $checkminwidth = $table[<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l18010"></a>18010       <span class="keywordflow">else</span> {  
<a name="l18011"></a>18011         unset($table[<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l18012"></a>18012       }
<a name="l18013"></a>18013     }
<a name="l18014"></a>18014     $ratio = $checkminwidth/$mxw;
<a name="l18015"></a>18015     <span class="keywordflow">if</span> ($checkminwidth &gt; $mxw) { <span class="keywordflow">return</span> array(($ratio +0.001),$checkminwidth); }  <span class="comment">// 0.001 to allow for rounded numbers when resizing</span>
<a name="l18016"></a>18016   }
<a name="l18017"></a>18017   <span class="keywordflow">return</span> array(0,0);
<a name="l18018"></a>18018 }
<a name="l18019"></a>18019 
<a name="l18020"></a>18020 
<a name="l18021"></a>18021 
<a name="l18022"></a>18022 function _tableWidth(&amp;$table){
<a name="l18023"></a>18023   $widthcols = &amp;$table[<span class="stringliteral">&#39;wc&#39;</span>];
<a name="l18024"></a>18024   $numcols = $table[<span class="stringliteral">&#39;nc&#39;</span>];
<a name="l18025"></a>18025   $tablewidth = 0;
<a name="l18026"></a>18026   <span class="comment">// Added mPDF1.4 - table border width if separate</span>
<a name="l18027"></a>18027   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l18028"></a>18028     $tblbw = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] +  $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l18029"></a>18029   }
<a name="l18030"></a>18030   <span class="keywordflow">else</span> { $tblbw = $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]/2 + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]/2 + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]; }
<a name="l18031"></a>18031 
<a name="l18032"></a>18032 
<a name="l18033"></a>18033   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;level&#39;</span>]&gt;1 &amp;&amp; isset($table[<span class="charliteral">&#39;w&#39;</span>])) { 
<a name="l18034"></a>18034     <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;wpercent&#39;</span>]) { 
<a name="l18035"></a>18035       $table[<span class="charliteral">&#39;w&#39;</span>] = $temppgwidth = (($table[<span class="charliteral">&#39;w&#39;</span>]-$tblbw) * $table[<span class="stringliteral">&#39;wpercent&#39;</span>] / 100) + $tblbw ;  
<a name="l18036"></a>18036     }
<a name="l18037"></a>18037     <span class="keywordflow">else</span> { 
<a name="l18038"></a>18038       $temppgwidth = $table[<span class="charliteral">&#39;w&#39;</span>] ;  
<a name="l18039"></a>18039     }
<a name="l18040"></a>18040   }
<a name="l18041"></a>18041   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l18042"></a>18042     $temppgwidth = $this-&gt;tbrot_maxw;
<a name="l18043"></a>18043     <span class="comment">// If it is less than 1/20th of the remaining page height to finish the DIV (i.e. DIV padding + table bottom margin)</span>
<a name="l18044"></a>18044     <span class="comment">// then allow for this</span>
<a name="l18045"></a>18045     $enddiv = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18046"></a>18046     <span class="keywordflow">if</span> ($enddiv/$temppgwidth &lt;0.05) { $temppgwidth -= $enddiv; }
<a name="l18047"></a>18047   }
<a name="l18048"></a>18048   <span class="keywordflow">else</span> {
<a name="l18049"></a>18049     <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>]&lt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]) { 
<a name="l18050"></a>18050       $notfullwidth = 1;
<a name="l18051"></a>18051       $temppgwidth = $table[<span class="charliteral">&#39;w&#39;</span>] ;  
<a name="l18052"></a>18052     }
<a name="l18053"></a>18053     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($table[<span class="stringliteral">&#39;overflow&#39;</span>]==<span class="stringliteral">&#39;visible&#39;</span> || $table[<span class="stringliteral">&#39;overflow&#39;</span>]==<span class="stringliteral">&#39;hidden&#39;</span>) &amp;&amp; !$this-&gt;ColActive &amp;&amp; isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] &gt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>] &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>]==$table[<span class="stringliteral">&#39;miw&#39;</span>]) { 
<a name="l18054"></a>18054       $temppgwidth = $table[<span class="charliteral">&#39;w&#39;</span>] ;  
<a name="l18055"></a>18055     }
<a name="l18056"></a>18056     <span class="keywordflow">else</span> { $temppgwidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]; }
<a name="l18057"></a>18057   }
<a name="l18058"></a>18058 
<a name="l18059"></a>18059 
<a name="l18060"></a>18060   $totaltextlength = 0; <span class="comment">// Added - to sum $table[&#39;l&#39;][colno]</span>
<a name="l18061"></a>18061   $totalatextlength = 0;  <span class="comment">// Added - to sum $table[&#39;l&#39;][colno] for those columns where width not set</span>
<a name="l18062"></a>18062   $percentages_set = 0; 
<a name="l18063"></a>18063   <span class="keywordflow">for</span> ( $i = 0 ; $i &lt; $numcols ; $i++ ) {
<a name="l18064"></a>18064     <span class="keywordflow">if</span> (isset($widthcols[$i][<span class="stringliteral">&#39;wpercent&#39;</span>]))  { $tablewidth += $widthcols[$i][<span class="stringliteral">&#39;maw&#39;</span>]; $percentages_set = 1; }
<a name="l18065"></a>18065     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($widthcols[$i][<span class="charliteral">&#39;w&#39;</span>]))  { $tablewidth += $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>]; }
<a name="l18066"></a>18066     <span class="keywordflow">else</span> { $tablewidth += $widthcols[$i][<span class="stringliteral">&#39;maw&#39;</span>]; }
<a name="l18067"></a>18067     $totaltextlength += $table[<span class="charliteral">&#39;l&#39;</span>][$i];
<a name="l18068"></a>18068   }
<a name="l18069"></a>18069   <span class="keywordflow">if</span> (!$totaltextlength) { $totaltextlength =1; }
<a name="l18070"></a>18070   $tablewidth += $tblbw;  <span class="comment">// Outer half of table borders</span>
<a name="l18071"></a>18071 
<a name="l18072"></a>18072   <span class="keywordflow">if</span> ($tablewidth &gt; $temppgwidth) { 
<a name="l18073"></a>18073     $table[<span class="charliteral">&#39;w&#39;</span>] = $temppgwidth; 
<a name="l18074"></a>18074   }
<a name="l18075"></a>18075   <span class="comment">// if any widths set as percentages and max width fits &lt; page width</span>
<a name="l18076"></a>18076   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tablewidth &lt; $temppgwidth &amp;&amp; !isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $percentages_set) {
<a name="l18077"></a>18077     $table[<span class="charliteral">&#39;w&#39;</span>] = $table[<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l18078"></a>18078   }
<a name="l18079"></a>18079   <span class="comment">// if table width is set and is &gt; allowed width</span>
<a name="l18080"></a>18080   <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;w&#39;</span>]) &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] &gt; $temppgwidth) { $table[<span class="charliteral">&#39;w&#39;</span>] = $temppgwidth; }
<a name="l18081"></a>18081   <span class="comment">// IF the table width is now set - Need to distribute columns widths</span>
<a name="l18082"></a>18082   <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;w&#39;</span>])) {
<a name="l18083"></a>18083     $wis = $wisa = 0;
<a name="l18084"></a>18084     $list = array();
<a name="l18085"></a>18085     $notsetlist = array();
<a name="l18086"></a>18086     <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $numcols ; $i++ ) {
<a name="l18087"></a>18087       $wis += $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l18088"></a>18088       <span class="keywordflow">if</span> (!isset($widthcols[$i][<span class="charliteral">&#39;w&#39;</span>]) || ($widthcols[$i][<span class="charliteral">&#39;w&#39;</span>] &amp;&amp; $table[<span class="charliteral">&#39;w&#39;</span>] &gt; $temppgwidth &amp;&amp; !$this-&gt;keep_table_proportions &amp;&amp; !$notfullwidth )){ 
<a name="l18089"></a>18089         $list[] = $i;  
<a name="l18090"></a>18090         $wisa += $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l18091"></a>18091         $totalatextlength += $table[<span class="charliteral">&#39;l&#39;</span>][$i];
<a name="l18092"></a>18092       }
<a name="l18093"></a>18093     }
<a name="l18094"></a>18094     <span class="keywordflow">if</span> (!$totalatextlength) { $totalatextlength =1; }
<a name="l18095"></a>18095 
<a name="l18096"></a>18096     <span class="comment">// Allocate spare (more than col&#39;s minimum width) across the cols according to their approx total text length</span>
<a name="l18097"></a>18097     <span class="comment">// Do it by setting minimum width here</span>
<a name="l18098"></a>18098     <span class="keywordflow">if</span> ($table[<span class="charliteral">&#39;w&#39;</span>] &gt; $wis + $tblbw) {
<a name="l18099"></a>18099       <span class="comment">// First set any cell widths set as percentages</span>
<a name="l18100"></a>18100       <span class="keywordflow">if</span> ($table[<span class="charliteral">&#39;w&#39;</span>] &lt; $temppgwidth || $this-&gt;keep_table_proportions) {
<a name="l18101"></a>18101         <span class="keywordflow">for</span>($k=0;$k&lt;$numcols;$k++) {
<a name="l18102"></a>18102           <span class="keywordflow">if</span> (isset($widthcols[$k][<span class="stringliteral">&#39;wpercent&#39;</span>])) {
<a name="l18103"></a>18103             $curr = $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l18104"></a>18104             $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] = ($table[<span class="charliteral">&#39;w&#39;</span>]-$tblbw) * $widthcols[$k][<span class="stringliteral">&#39;wpercent&#39;</span>]/100;
<a name="l18105"></a>18105             $wis += $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] - $curr;
<a name="l18106"></a>18106             $wisa += $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] - $curr;
<a name="l18107"></a>18107           }
<a name="l18108"></a>18108         }
<a name="l18109"></a>18109       }
<a name="l18110"></a>18110       <span class="comment">// Now allocate surplus up to maximum width of each column</span>
<a name="l18111"></a>18111       $surplus = 0;  $ttl = 0;  <span class="comment">// number of surplus columns</span>
<a name="l18112"></a>18112       <span class="keywordflow">if</span> (!count($list)) {
<a name="l18113"></a>18113         $wi = ($table[<span class="charliteral">&#39;w&#39;</span>]-($wis + $tblbw));  <span class="comment">//  i.e. extra space to distribute</span>
<a name="l18114"></a>18114         <span class="keywordflow">for</span>($k=0;$k&lt;$numcols;$k++) {
<a name="l18115"></a>18115           $spareratio = ($table[<span class="charliteral">&#39;l&#39;</span>][$k] / $totaltextlength); <span class="comment">//  gives ratio to divide up free space</span>
<a name="l18116"></a>18116           <span class="comment">// Don&#39;t allocate more than Maximum required width - save rest in surplus</span>
<a name="l18117"></a>18117           <span class="keywordflow">if</span> ($widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] + ($wi * $spareratio) &gt; $widthcols[$k][<span class="stringliteral">&#39;maw&#39;</span>]) {
<a name="l18118"></a>18118             $surplus += ($wi * $spareratio) - ($widthcols[$k][<span class="stringliteral">&#39;maw&#39;</span>]-$widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>]);
<a name="l18119"></a>18119             $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] = $widthcols[$k][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l18120"></a>18120           }
<a name="l18121"></a>18121           <span class="keywordflow">else</span> { 
<a name="l18122"></a>18122             $notsetlist[] = $k;  
<a name="l18123"></a>18123             $ttl += $table[<span class="charliteral">&#39;l&#39;</span>][$k];
<a name="l18124"></a>18124             $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] += ($wi * $spareratio); 
<a name="l18125"></a>18125           }
<a name="l18126"></a>18126 
<a name="l18127"></a>18127         }
<a name="l18128"></a>18128       }
<a name="l18129"></a>18129       <span class="keywordflow">else</span> {
<a name="l18130"></a>18130         $wi = ($table[<span class="charliteral">&#39;w&#39;</span>] - ($wis + $tblbw));  <span class="comment">//  i.e. extra space to distribute</span>
<a name="l18131"></a>18131         <span class="keywordflow">foreach</span> ($list as $k) {
<a name="l18132"></a>18132           $spareratio = ($table[<span class="charliteral">&#39;l&#39;</span>][$k] / $totalatextlength); <span class="comment">//  gives ratio to divide up free space</span>
<a name="l18133"></a>18133           <span class="comment">// Don&#39;t allocate more than Maximum required width - save rest in surplus</span>
<a name="l18134"></a>18134           <span class="keywordflow">if</span> ($widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] + ($wi * $spareratio) &gt; $widthcols[$k][<span class="stringliteral">&#39;maw&#39;</span>]) {
<a name="l18135"></a>18135             $surplus += ($wi * $spareratio) - ($widthcols[$k][<span class="stringliteral">&#39;maw&#39;</span>]-$widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>]);
<a name="l18136"></a>18136             $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] = $widthcols[$k][<span class="stringliteral">&#39;maw&#39;</span>];
<a name="l18137"></a>18137           }
<a name="l18138"></a>18138           <span class="keywordflow">else</span> { 
<a name="l18139"></a>18139             $notsetlist[] = $k;  
<a name="l18140"></a>18140             $ttl += $table[<span class="charliteral">&#39;l&#39;</span>][$k];
<a name="l18141"></a>18141             $widthcols[$k][<span class="stringliteral">&#39;miw&#39;</span>] += ($wi * $spareratio); 
<a name="l18142"></a>18142           }
<a name="l18143"></a>18143         }
<a name="l18144"></a>18144       }
<a name="l18145"></a>18145       <span class="comment">// If surplus still left over apportion it across columns</span>
<a name="l18146"></a>18146       <span class="keywordflow">if</span> ($surplus) { 
<a name="l18147"></a>18147          <span class="comment">// if some are set only add to remaining - otherwise add to all of them</span>
<a name="l18148"></a>18148          <span class="keywordflow">if</span> (count($notsetlist) &amp;&amp; count($notsetlist) &lt; $numcols) {
<a name="l18149"></a>18149         <span class="keywordflow">foreach</span> ($notsetlist AS $i) {
<a name="l18150"></a>18150           <span class="keywordflow">if</span> ($ttl) $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>] += $surplus * $table[<span class="charliteral">&#39;l&#39;</span>][$i] / $ttl ;
<a name="l18151"></a>18151         }
<a name="l18152"></a>18152          }
<a name="l18153"></a>18153          <span class="comment">// If some widths are defined, and others have been added up to their maxmum</span>
<a name="l18154"></a>18154          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count($list) &amp;&amp; count($list) &lt; $numcols) {
<a name="l18155"></a>18155         <span class="keywordflow">foreach</span> ($list AS $i) {
<a name="l18156"></a>18156           $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>] += $surplus / count($list) ;
<a name="l18157"></a>18157         }
<a name="l18158"></a>18158          }
<a name="l18159"></a>18159          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($numcols) { <span class="comment">// If all columns</span>
<a name="l18160"></a>18160         $ttl = array_sum($table[<span class="charliteral">&#39;l&#39;</span>]);
<a name="l18161"></a>18161         <span class="keywordflow">for</span> ($i=0;$i&lt;$numcols;$i++) {
<a name="l18162"></a>18162           $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>] += $surplus * $table[<span class="charliteral">&#39;l&#39;</span>][$i] / $ttl;
<a name="l18163"></a>18163         }
<a name="l18164"></a>18164          }
<a name="l18165"></a>18165       }
<a name="l18166"></a>18166 
<a name="l18167"></a>18167     }
<a name="l18168"></a>18168 
<a name="l18169"></a>18169     <span class="comment">// This sets the columns all to minimum width (which has been increased above if appropriate)</span>
<a name="l18170"></a>18170     <span class="keywordflow">for</span> ($i=0;$i&lt;$numcols;$i++) {
<a name="l18171"></a>18171       $widthcols[$i] = $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>];
<a name="l18172"></a>18172     }
<a name="l18173"></a>18173 
<a name="l18174"></a>18174     <span class="comment">// TABLE NOT WIDE ENOUGH EVEN FOR MINIMUM CONTENT WIDTH</span>
<a name="l18175"></a>18175     <span class="comment">// If sum of column widths set are too wide for table</span>
<a name="l18176"></a>18176     $checktablewidth = 0;
<a name="l18177"></a>18177     <span class="keywordflow">for</span> ( $i = 0 ; $i &lt; $numcols ; $i++ ) {
<a name="l18178"></a>18178       $checktablewidth += $widthcols[$i];
<a name="l18179"></a>18179     }
<a name="l18180"></a>18180     <span class="keywordflow">if</span> ($checktablewidth &gt; ($temppgwidth + 0.001 - $tblbw)) { 
<a name="l18181"></a>18181        $usedup = 0; $numleft = 0;
<a name="l18182"></a>18182        <span class="keywordflow">for</span> ($i=0;$i&lt;$numcols;$i++) {
<a name="l18183"></a>18183       <span class="keywordflow">if</span> ((isset($widthcols[$i]) &amp;&amp; $widthcols[$i] &gt; (($temppgwidth - $tblbw) / $numcols)) &amp;&amp; (!isset($widthcols[$i][<span class="charliteral">&#39;w&#39;</span>]))) { 
<a name="l18184"></a>18184         $numleft++; 
<a name="l18185"></a>18185         unset($widthcols[$i]); 
<a name="l18186"></a>18186       }
<a name="l18187"></a>18187       <span class="keywordflow">else</span> { $usedup += $widthcols[$i]; }
<a name="l18188"></a>18188        }
<a name="l18189"></a>18189        <span class="keywordflow">for</span> ($i=0;$i&lt;$numcols;$i++) {
<a name="l18190"></a>18190       <span class="keywordflow">if</span> (!isset($widthcols[$i]) || !$widthcols[$i]) { 
<a name="l18191"></a>18191         $widthcols[$i] = ((($temppgwidth - $tblbw) - $usedup)/ ($numleft)); 
<a name="l18192"></a>18192       }
<a name="l18193"></a>18193        }
<a name="l18194"></a>18194     }
<a name="l18195"></a>18195 
<a name="l18196"></a>18196   }
<a name="l18197"></a>18197   <span class="keywordflow">else</span> { <span class="comment">//table has no width defined</span>
<a name="l18198"></a>18198     $table[<span class="charliteral">&#39;w&#39;</span>] = $tablewidth;  
<a name="l18199"></a>18199     <span class="keywordflow">for</span> ( $i = 0 ; $i &lt; $numcols ; $i++) {
<a name="l18200"></a>18200       <span class="keywordflow">if</span> (isset($widthcols[$i][<span class="stringliteral">&#39;wpercent&#39;</span>]) &amp;&amp; $this-&gt;keep_table_proportions)  { $colwidth = $widthcols[$i][<span class="stringliteral">&#39;maw&#39;</span>]; }
<a name="l18201"></a>18201       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($widthcols[$i][<span class="charliteral">&#39;w&#39;</span>]))  { $colwidth = $widthcols[$i][<span class="stringliteral">&#39;miw&#39;</span>]; }
<a name="l18202"></a>18202       <span class="keywordflow">else</span> { $colwidth = $widthcols[$i][<span class="stringliteral">&#39;maw&#39;</span>]; }
<a name="l18203"></a>18203       unset($widthcols[$i]);
<a name="l18204"></a>18204       $widthcols[$i] = $colwidth;
<a name="l18205"></a>18205     }
<a name="l18206"></a>18206   }
<a name="l18207"></a>18207 }
<a name="l18208"></a>18208   
<a name="l18209"></a>18209 function _tableHeight(&amp;$table){
<a name="l18210"></a>18210   $level = $table[<span class="stringliteral">&#39;level&#39;</span>];
<a name="l18211"></a>18211   $levelid = $table[<span class="stringliteral">&#39;levelid&#39;</span>];
<a name="l18212"></a>18212   $cells = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>];
<a name="l18213"></a>18213   $numcols = $table[<span class="stringliteral">&#39;nc&#39;</span>];
<a name="l18214"></a>18214   $numrows = $table[<span class="stringliteral">&#39;nr&#39;</span>];
<a name="l18215"></a>18215   $listspan = array();
<a name="l18216"></a>18216   $checkmaxheight = 0;
<a name="l18217"></a>18217   $headerrowheight = 0;
<a name="l18218"></a>18218   $checkmaxheightplus = 0;
<a name="l18219"></a>18219   $headerrowheightplus = 0;
<a name="l18220"></a>18220   <span class="comment">// mPDF 4.0</span>
<a name="l18221"></a>18221   $footerrowheight = 0;
<a name="l18222"></a>18222   $footerrowheightplus = 0;
<a name="l18223"></a>18223   <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l18224"></a>18224     $temppgheight = $this-&gt;tbrot_maxh;
<a name="l18225"></a>18225     $remainingpage = $this-&gt;tbrot_maxh;
<a name="l18226"></a>18226   }
<a name="l18227"></a>18227   <span class="keywordflow">else</span> {
<a name="l18228"></a>18228     $temppgheight = ($this-&gt;h - $this-&gt;bMargin - $this-&gt;tMargin) - $this-&gt;kwt_height;
<a name="l18229"></a>18229     $remainingpage = ($this-&gt;h - $this-&gt;bMargin - $this-&gt;y) - $this-&gt;kwt_height;
<a name="l18230"></a>18230 
<a name="l18231"></a>18231     <span class="comment">// If it is less than 1/20th of the remaining page height to finish the DIV (i.e. DIV padding + table bottom margin)</span>
<a name="l18232"></a>18232     <span class="comment">// then allow for this</span>
<a name="l18233"></a>18233     $enddiv = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_bottom&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_bottom&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l18234"></a>18234     <span class="comment">// mPDF 4.0 bug fix: if remaining page == 0 get error</span>
<a name="l18235"></a>18235     <span class="keywordflow">if</span> ($remainingpage &gt; $enddiv &amp;&amp; $enddiv/$remainingpage &lt;0.05) { $remainingpage -= $enddiv; }
<a name="l18236"></a>18236     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($remainingpage == 0) { $remainingpage = 0.001; }
<a name="l18237"></a>18237     <span class="keywordflow">if</span> ($temppgheight &gt; $enddiv &amp;&amp; $enddiv/$temppgheight &lt;0.05) { $temppgheight -= $enddiv; }
<a name="l18238"></a>18238     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($temppgheight == 0) { $temppgheight = 0.001; }
<a name="l18239"></a>18239   }
<a name="l18240"></a>18240 
<a name="l18241"></a>18241 
<a name="l18242"></a>18242   <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $numrows ; $i++ ) { <span class="comment">//rows</span>
<a name="l18243"></a>18243     $heightrow = &amp;$table[<span class="stringliteral">&#39;hr&#39;</span>][$i];
<a name="l18244"></a>18244     <span class="keywordflow">for</span>( $j = 0 ; $j &lt; $numcols ; $j++ ) { <span class="comment">//columns</span>
<a name="l18245"></a>18245       <span class="keywordflow">if</span> (isset($cells[$i][$j]) &amp;&amp; $cells[$i][$j]) {
<a name="l18246"></a>18246         $c = &amp;$cells[$i][$j];
<a name="l18247"></a>18247 
<a name="l18248"></a>18248         <span class="comment">// mPDF 4.3.006</span>
<a name="l18249"></a>18249         <span class="keywordflow">if</span> ($this-&gt;simpleTables){ <span class="comment">// mPDF 4.2.017</span>
<a name="l18250"></a>18250            <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {  <span class="comment">// NB twice border width</span>
<a name="l18251"></a>18251           $extraWLR = ($table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) + ($c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]+$c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>])+$table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l18252"></a>18252           $extrh = ($table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) + ($c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]+$c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>])+$table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>];
<a name="l18253"></a>18253            }
<a name="l18254"></a>18254            <span class="keywordflow">else</span> {
<a name="l18255"></a>18255           $extraWLR = ($table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2 + ($c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]+$c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]);
<a name="l18256"></a>18256           $extrh = ($table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]+$table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2 + ($c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]+$c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l18257"></a>18257            }
<a name="l18258"></a>18258         }
<a name="l18259"></a>18259         <span class="keywordflow">else</span>  {
<a name="l18260"></a>18260            <span class="comment">// mPDF 4.3.009</span>
<a name="l18261"></a>18261            <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l18262"></a>18262             list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($c[<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l18263"></a>18263            }
<a name="l18264"></a>18264            <span class="keywordflow">else</span> { 
<a name="l18265"></a>18265           <span class="comment">// mPDF 4.3.012E</span>
<a name="l18266"></a>18266           $bt = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18267"></a>18267           $bb = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18268"></a>18268           $br = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18269"></a>18269           $bl = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18270"></a>18270            }
<a name="l18271"></a>18271            <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {  <span class="comment">// NB twice border width</span>
<a name="l18272"></a>18272           $extraWLR = $bl + $br + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l18273"></a>18273           $extrh = $bt + $bb + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>];
<a name="l18274"></a>18274            }
<a name="l18275"></a>18275            <span class="keywordflow">else</span> {
<a name="l18276"></a>18276           $extraWLR = $bl/2 + $br/2 + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l18277"></a>18277           $extrh = $bt/2 + $bb/2 + $c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]+$c[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l18278"></a>18278            }
<a name="l18279"></a>18279         }
<a name="l18280"></a>18280 
<a name="l18281"></a>18281         list($x,$cw) = $this-&gt;_tableGetWidth($table, $i,$j);
<a name="l18282"></a>18282         <span class="comment">//Check whether width is enough for this cells&#39; text</span>
<a name="l18283"></a>18283         $auxtext = implode(<span class="stringliteral">&quot;&quot;</span>,$c[<span class="stringliteral">&#39;text&#39;</span>]);
<a name="l18284"></a>18284         $auxtext2 = $auxtext; <span class="comment">//in case we have text with styles</span>
<a name="l18285"></a>18285 
<a name="l18286"></a>18286         $aux3 = $auxtext; <span class="comment">//in case we have text with styles</span>
<a name="l18287"></a>18287 
<a name="l18288"></a>18288         <span class="comment">// Get CELL HEIGHT </span>
<a name="l18289"></a>18289         <span class="comment">// ++ extra parameter forces wrap to break word</span>
<a name="l18290"></a>18290         <span class="keywordflow">if</span> ($c[<span class="charliteral">&#39;R&#39;</span>]) {
<a name="l18291"></a>18291           $aux4 = implode(<span class="stringliteral">&quot; &quot;</span>,$c[<span class="stringliteral">&#39;text&#39;</span>]);
<a name="l18292"></a>18292           $s_fs = $this-&gt;FontSizePt;
<a name="l18293"></a>18293           $s_f = $this-&gt;FontFamily; <span class="comment">// mPDF 3.0</span>
<a name="l18294"></a>18294           $s_st = $this-&gt;FontStyle; <span class="comment">// mPDF 3.0</span>
<a name="l18295"></a>18295           $this-&gt;SetFont($c[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][4],$c[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][2],$c[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][11] / $this-&gt;shrin_k,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l18296"></a>18296           $aux4 = ltrim($aux4);
<a name="l18297"></a>18297           $aux4= $this-&gt;mb_rtrim($aux4,$this-&gt;mb_enc);
<a name="l18298"></a>18298               $tempch = $this-&gt;GetStringWidth($aux4);
<a name="l18299"></a>18299           <span class="keywordflow">if</span> ($c[<span class="charliteral">&#39;R&#39;</span>] &gt;= 45 &amp;&amp; $c[<span class="charliteral">&#39;R&#39;</span>] &lt; 90) {
<a name="l18300"></a>18300             $tempch = ((sin(deg2rad($c[<span class="charliteral">&#39;R&#39;</span>]))) * $tempch ) + ((sin(deg2rad($c[<span class="charliteral">&#39;R&#39;</span>]))) * (($c[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][11]/$this-&gt;k) / $this-&gt;shrin_k));
<a name="l18301"></a>18301           } 
<a name="l18302"></a>18302           $this-&gt;SetFont($s_f,$s_st,$s_fs,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l18303"></a>18303           $ch = ($tempch ) + $extrh ;  
<a name="l18304"></a>18304         }
<a name="l18305"></a>18305         <span class="keywordflow">else</span> {
<a name="l18306"></a>18306            <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;textbuffer&#39;</span>])) {
<a name="l18307"></a>18307           $tempch = $this-&gt;TableWordWrap(($cw-$extraWLR),1,$c[<span class="stringliteral">&#39;textbuffer&#39;</span>], $c[<span class="stringliteral">&#39;dfs&#39;</span>]);  <span class="comment">// mPDF 4.2</span>
<a name="l18308"></a>18308            }
<a name="l18309"></a>18309            <span class="keywordflow">else</span> { $tempch = 0; }
<a name="l18310"></a>18310 
<a name="l18311"></a>18311           <span class="comment">// Added cellpadding top and bottom. (Lineheight already adjusted to table_lineheight)</span>
<a name="l18312"></a>18312           $ch = $tempch + $extrh ;
<a name="l18313"></a>18313         }
<a name="l18314"></a>18314 
<a name="l18315"></a>18315         <span class="comment">//If height is defined and it is bigger than calculated $ch then update values</span>
<a name="l18316"></a>18316         <span class="keywordflow">if</span> (isset($c[<span class="charliteral">&#39;h&#39;</span>]) &amp;&amp; $c[<span class="charliteral">&#39;h&#39;</span>] &gt; $ch) {
<a name="l18317"></a>18317           $c[<span class="stringliteral">&#39;mih&#39;</span>] = $ch; <span class="comment">//in order to keep valign working</span>
<a name="l18318"></a>18318           $ch = $c[<span class="charliteral">&#39;h&#39;</span>];
<a name="l18319"></a>18319         }
<a name="l18320"></a>18320         <span class="keywordflow">else</span> $c[<span class="stringliteral">&#39;mih&#39;</span>] = $ch;
<a name="l18321"></a>18321         <span class="keywordflow">if</span> (isset($c[<span class="stringliteral">&#39;rowspan&#39;</span>])) $listspan[] = array($i,$j);
<a name="l18322"></a>18322         elseif ($heightrow &lt; $ch) $heightrow = $ch;
<a name="l18323"></a>18323   
<a name="l18324"></a>18324         <span class="comment">// this is the extra used in _tableWrite to determine whether to trigger a page change</span>
<a name="l18325"></a>18325         <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a> ($table[&#39;borders_separate&#39;]) { 
<a name="l18326"></a>18326           <span class="comment">// mPDF 3.0 - bug fix</span>
<a name="l18327"></a>18327           <span class="comment">//if ($i == ($numrows-1) || ($i+$cell[&#39;rowspan&#39;]) == ($numrows) ) {</span>
<a name="l18328"></a>18328           <span class="keywordflow">if</span> ($i == ($numrows-1) || (isset($c[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+$c[<span class="stringliteral">&#39;rowspan&#39;</span>]) == ($numrows)) ) {
<a name="l18329"></a>18329           $extra = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l18330"></a>18330           }
<a name="l18331"></a>18331           <span class="keywordflow">else</span> {
<a name="l18332"></a>18332           $extra = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l18333"></a>18333           }
<a name="l18334"></a>18334         }
<a name="l18335"></a>18335           <span class="keywordflow">else</span> { 
<a name="l18336"></a>18336           <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l18337"></a>18337               <span class="comment">// mPDF 4.3.009</span>
<a name="l18338"></a>18338             $extra = $bb/2; 
<a name="l18339"></a>18339           }
<a name="l18340"></a>18340           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l18341"></a>18341             $extra = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2; 
<a name="l18342"></a>18342           }
<a name="l18343"></a>18343         }
<a name="l18344"></a>18344 
<a name="l18345"></a>18345         <span class="comment">// mPDF 3.0</span>
<a name="l18346"></a>18346         <span class="keywordflow">if</span> ($i &lt;$this-&gt;tableheadernrows &amp;&amp; $this-&gt;usetableheader) {
<a name="l18347"></a>18347           $headerrowheight = max($headerrowheight,$ch);
<a name="l18348"></a>18348           $headerrowheightplus = max($headerrowheightplus,$ch+$extra);
<a name="l18349"></a>18349         }
<a name="l18350"></a>18350         <span class="comment">// mPDF 4.0</span>
<a name="l18351"></a>18351         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;is_tfoot&#39;</span>][$i]) {
<a name="l18352"></a>18352           $footerrowheight = max($footerrowheight,$ch);
<a name="l18353"></a>18353           $footerrowheightplus = max($footerrowheightplus,$ch+$extra);
<a name="l18354"></a>18354         }
<a name="l18355"></a>18355         <span class="keywordflow">else</span> {
<a name="l18356"></a>18356           $checkmaxheight = max($checkmaxheight,$ch);
<a name="l18357"></a>18357           $checkmaxheightplus = max($checkmaxheightplus,$ch+$extra);
<a name="l18358"></a>18358         }
<a name="l18359"></a>18359 
<a name="l18360"></a>18360 
<a name="l18361"></a>18361         unset($c);
<a name="l18362"></a>18362       }
<a name="l18363"></a>18363     }<span class="comment">//end of columns</span>
<a name="l18364"></a>18364   }<span class="comment">//end of rows</span>
<a name="l18365"></a>18365   $heightrow = &amp;$table[<span class="stringliteral">&#39;hr&#39;</span>];
<a name="l18366"></a>18366   <span class="keywordflow">foreach</span> ($listspan as $span) {
<a name="l18367"></a>18367     list($i,$j) = $span;
<a name="l18368"></a>18368     $c = &amp;$cells[$i][$j];
<a name="l18369"></a>18369     $lr = $i + $c[<span class="stringliteral">&#39;rowspan&#39;</span>];
<a name="l18370"></a>18370     <span class="keywordflow">if</span> ($lr &gt; $numrows) $lr = $numrows;
<a name="l18371"></a>18371     $hs = $hsa = 0;
<a name="l18372"></a>18372     $list = array();
<a name="l18373"></a>18373     <span class="keywordflow">for</span>($k=$i;$k&lt;$lr;$k++) {
<a name="l18374"></a>18374       $hs += $heightrow[$k];
<a name="l18375"></a>18375       <span class="keywordflow">if</span> (!isset($c[<span class="charliteral">&#39;h&#39;</span>])) {
<a name="l18376"></a>18376         $list[] = $k;
<a name="l18377"></a>18377         $hsa += $heightrow[$k];
<a name="l18378"></a>18378       }
<a name="l18379"></a>18379     }
<a name="l18380"></a>18380     <span class="comment">// mPDF 3.0 </span>
<a name="l18381"></a>18381     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l18382"></a>18382       <span class="keywordflow">if</span> ($i == ($numrows-1) || ($i+$c[<span class="stringliteral">&#39;rowspan&#39;</span>]) == ($numrows) ) {
<a name="l18383"></a>18383       $extra = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l18384"></a>18384       }
<a name="l18385"></a>18385       <span class="keywordflow">else</span> {
<a name="l18386"></a>18386       $extra = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l18387"></a>18387       }
<a name="l18388"></a>18388     }
<a name="l18389"></a>18389       <span class="keywordflow">else</span> { 
<a name="l18390"></a>18390       <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l18391"></a>18391         <span class="comment">// mPDF 4.3.009</span>
<a name="l18392"></a>18392         <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l18393"></a>18393           list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($c[<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l18394"></a>18394         }
<a name="l18395"></a>18395         <span class="keywordflow">else</span> { 
<a name="l18396"></a>18396           <span class="comment">// mPDF 4.3.012E</span>
<a name="l18397"></a>18397           $bb = $c[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18398"></a>18398         }
<a name="l18399"></a>18399         $extra = $bb/2; 
<a name="l18400"></a>18400       }
<a name="l18401"></a>18401       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l18402"></a>18402         $extra = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2; 
<a name="l18403"></a>18403       }
<a name="l18404"></a>18404     }
<a name="l18405"></a>18405     <span class="keywordflow">if</span> ($i &lt;$this-&gt;tableheadernrows &amp;&amp; $this-&gt;usetableheader) {
<a name="l18406"></a>18406       $headerrowheight = max($headerrowheight,$hs);
<a name="l18407"></a>18407       $headerrowheightplus = max($headerrowheightplus,$hs+$extra);
<a name="l18408"></a>18408     }
<a name="l18409"></a>18409     <span class="comment">// mPDF 4.0</span>
<a name="l18410"></a>18410     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;is_tfoot&#39;</span>][$i]) {
<a name="l18411"></a>18411       $footerrowheight = max($footerrowheight,$hs);
<a name="l18412"></a>18412       $footerrowheightplus = max($footerrowheightplus,$hs+$extra);
<a name="l18413"></a>18413     }
<a name="l18414"></a>18414     <span class="keywordflow">else</span> {
<a name="l18415"></a>18415       $checkmaxheight = max($checkmaxheight,$hs);
<a name="l18416"></a>18416       $checkmaxheightplus = max($checkmaxheightplus,$hs+$extra);
<a name="l18417"></a>18417     }
<a name="l18418"></a>18418 
<a name="l18419"></a>18419     <span class="keywordflow">if</span> ($c[<span class="stringliteral">&#39;mih&#39;</span>] &gt; $hs) {
<a name="l18420"></a>18420       <span class="keywordflow">if</span> (!$hs) {
<a name="l18421"></a>18421         <span class="keywordflow">for</span>($k=$i;$k&lt;$lr;$k++) $heightrow[$k] = $c[<span class="stringliteral">&#39;mih&#39;</span>]/$c[<span class="stringliteral">&#39;rowspan&#39;</span>];
<a name="l18422"></a>18422       }
<a name="l18423"></a>18423       elseif (!count($list)) {
<a name="l18424"></a>18424         $hi = $c[<span class="stringliteral">&#39;mih&#39;</span>] - $hs;
<a name="l18425"></a>18425         <span class="keywordflow">for</span>($k=$i;$k&lt;$lr;$k++) $heightrow[$k] += ($heightrow[$k]/$hs)*$hi;
<a name="l18426"></a>18426       }
<a name="l18427"></a>18427       <span class="keywordflow">else</span> {
<a name="l18428"></a>18428         $hi = $c[<span class="stringliteral">&#39;mih&#39;</span>] - $hsa;
<a name="l18429"></a>18429         <span class="keywordflow">foreach</span> ($list as $k) $heightrow[$k] += ($heightrow[$k]/$hsa)*$hi;
<a name="l18430"></a>18430       }
<a name="l18431"></a>18431     }
<a name="l18432"></a>18432     unset($c);
<a name="l18433"></a>18433   }
<a name="l18434"></a>18434 
<a name="l18435"></a>18435   $table[<span class="charliteral">&#39;h&#39;</span>] = array_sum($table[<span class="stringliteral">&#39;hr&#39;</span>]);
<a name="l18436"></a>18436 
<a name="l18437"></a>18437   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l18438"></a>18438     $table[<span class="charliteral">&#39;h&#39;</span>] += $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] +  $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l18439"></a>18439   }
<a name="l18440"></a>18440   <span class="keywordflow">else</span> { 
<a name="l18441"></a>18441     $table[<span class="charliteral">&#39;h&#39;</span>] += $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]/2 + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]/2;
<a name="l18442"></a>18442   }
<a name="l18443"></a>18443 
<a name="l18444"></a>18444   <span class="comment">// mPDF 4.0</span>
<a name="l18445"></a>18445   $maxrowheight = $checkmaxheightplus + $headerrowheightplus + $footerrowheightplus;
<a name="l18446"></a>18446   <span class="keywordflow">return</span> array($table[<span class="charliteral">&#39;h&#39;</span>],$maxrowheight,$temppgheight,$remainingpage);
<a name="l18447"></a>18447 }
<a name="l18448"></a>18448 
<a name="l18449"></a>18449 function _tableGetWidth(&amp;$table, $i,$j){
<a name="l18450"></a>18450   $cell = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>][$i][$j];
<a name="l18451"></a>18451   <span class="keywordflow">if</span> ($cell) {
<a name="l18452"></a>18452     <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;x0&#39;</span>])) <span class="keywordflow">return</span> array($cell[<span class="stringliteral">&#39;x0&#39;</span>], $cell[<span class="stringliteral">&#39;w0&#39;</span>]);
<a name="l18453"></a>18453     $x = 0;
<a name="l18454"></a>18454     $widthcols = &amp;$table[<span class="stringliteral">&#39;wc&#39;</span>];
<a name="l18455"></a>18455     <span class="keywordflow">for</span>( $k = 0 ; $k &lt; $j ; $k++ ) $x += $widthcols[$k];
<a name="l18456"></a>18456     $w = $widthcols[$j];
<a name="l18457"></a>18457     <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>])) {
<a name="l18458"></a>18458        <span class="keywordflow">for</span> ( $k = $j+$cell[<span class="stringliteral">&#39;colspan&#39;</span>]-1 ; $k &gt; $j ; $k-- )  $w += $widthcols[$k];
<a name="l18459"></a>18459     }
<a name="l18460"></a>18460     $cell[<span class="stringliteral">&#39;x0&#39;</span>] = $x;
<a name="l18461"></a>18461     $cell[<span class="stringliteral">&#39;w0&#39;</span>] = $w;
<a name="l18462"></a>18462     <span class="keywordflow">return</span> array($x, $w);
<a name="l18463"></a>18463   }
<a name="l18464"></a>18464   <span class="keywordflow">return</span> array(0,0);
<a name="l18465"></a>18465 }
<a name="l18466"></a>18466 
<a name="l18467"></a>18467 function _tableGetHeight(&amp;$table, $i,$j){
<a name="l18468"></a>18468   $cell = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>][$i][$j];
<a name="l18469"></a>18469   <span class="keywordflow">if</span> ($cell){
<a name="l18470"></a>18470     <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;y0&#39;</span>])) <span class="keywordflow">return</span> array($cell[<span class="stringliteral">&#39;y0&#39;</span>], $cell[<span class="stringliteral">&#39;h0&#39;</span>]);
<a name="l18471"></a>18471     $y = 0;
<a name="l18472"></a>18472     $heightrow = &amp;$table[<span class="stringliteral">&#39;hr&#39;</span>];
<a name="l18473"></a>18473     <span class="keywordflow">for</span> ($k=0;$k&lt;$i;$k++) $y += $heightrow[$k];
<a name="l18474"></a>18474     $h = $heightrow[$i];
<a name="l18475"></a>18475     <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>])){
<a name="l18476"></a>18476       <span class="keywordflow">for</span> ($k=$i+$cell[<span class="stringliteral">&#39;rowspan&#39;</span>]-1;$k&gt;$i;$k--)
<a name="l18477"></a>18477         $h += $heightrow[$k];
<a name="l18478"></a>18478     }
<a name="l18479"></a>18479     $cell[<span class="stringliteral">&#39;y0&#39;</span>] = $y;
<a name="l18480"></a>18480     $cell[<span class="stringliteral">&#39;h0&#39;</span>] = $h;
<a name="l18481"></a>18481     <span class="keywordflow">return</span> array($y, $h);
<a name="l18482"></a>18482   }
<a name="l18483"></a>18483   <span class="keywordflow">return</span> array(0,0);
<a name="l18484"></a>18484 }
<a name="l18485"></a>18485 
<a name="l18486"></a>18486 
<a name="l18487"></a>18487 <span class="comment">// CHANGED TO ALLOW TABLE BORDER TO BE SPECIFIED CORRECTLY - added border_details</span>
<a name="l18488"></a>18488 <span class="comment">// mPDF 3.0 Table borders need additional parameters - either corner (TLBR) and/or border-spacing-H or -V ($bsh/$bsv)</span>
<a name="l18489"></a>18489 function _tableRect($x, $y, $w, $h, $bord=-1, $details=array(), $buffer=<span class="keyword">false</span>, $bSeparate=<span class="keyword">false</span>, $cort=<span class="stringliteral">&#39;cell&#39;</span>, $tablecorner=<span class="stringliteral">&#39;&#39;</span>, $bsv=0, $bsh=0) {
<a name="l18490"></a>18490   <span class="comment">// mPDF 3.0 Disabled again - buffer is printed at end of each table row - in fn. _tablewrite()</span>
<a name="l18491"></a>18491 <span class="comment">//  if ($this-&gt;ColActive) { $buffer = false; }</span>
<a name="l18492"></a>18492 
<a name="l18493"></a>18493   <span class="comment">// mPDF 3.0</span>
<a name="l18494"></a>18494   $cellBorderOverlay = array();
<a name="l18495"></a>18495 
<a name="l18496"></a>18496   <span class="keywordflow">if</span> ($bord==-1) { $this-&gt;Rect($x, $y, $w, $h); }
<a name="l18497"></a>18497   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables &amp;&amp; ($cort==<span class="stringliteral">&#39;cell&#39;</span>)) {  <span class="comment">// mPDF 4.2.017</span>
<a name="l18498"></a>18498     $this-&gt;SetLineWidth($details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]);
<a name="l18499"></a>18499     <span class="keywordflow">if</span> ($details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>]) { 
<a name="l18500"></a>18500       $this-&gt;SetDrawColor($details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],$details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],$details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l18501"></a>18501     }
<a name="l18502"></a>18502     <span class="keywordflow">else</span> { $this-&gt;SetDrawColor(0); }
<a name="l18503"></a>18503       $this-&gt;_out(<span class="stringliteral">&#39;0 j&#39;</span>);
<a name="l18504"></a>18504     $this-&gt;Rect($x, $y, $w, $h); 
<a name="l18505"></a>18505   }
<a name="l18506"></a>18506   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($bord){
<a name="l18507"></a>18507      <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $buffer) {
<a name="l18508"></a>18508     $priority = <span class="stringliteral">&#39;LRTB&#39;</span>;
<a name="l18509"></a>18509     <span class="keywordflow">for</span>($p=0;$p&lt;strlen($priority);$p++) {
<a name="l18510"></a>18510       $side = substr($priority,$p,1);
<a name="l18511"></a>18511       $details[<span class="charliteral">&#39;p&#39;</span>] = $side ;
<a name="l18512"></a>18512 
<a name="l18513"></a>18513       $dom = 0;
<a name="l18514"></a>18514       <span class="keywordflow">if</span> (isset($details[$side][<span class="charliteral">&#39;w&#39;</span>])) { $dom += ($details[$side][<span class="charliteral">&#39;w&#39;</span>] * 100000); }
<a name="l18515"></a>18515       <span class="keywordflow">if</span> (isset($details[$side][<span class="stringliteral">&#39;style&#39;</span>])) { $dom += (array_search($details[$side][<span class="stringliteral">&#39;style&#39;</span>],$this-&gt;borderstyles)*100) ; }
<a name="l18516"></a>18516       <span class="keywordflow">if</span> (isset($details[$side][<span class="stringliteral">&#39;dom&#39;</span>])) { $dom += ($details[$side][<span class="stringliteral">&#39;dom&#39;</span>]*10); }
<a name="l18517"></a>18517 
<a name="l18518"></a>18518       <span class="comment">// mPDF 3.0 Precedence to darker colours at joins</span>
<a name="l18519"></a>18519       $coldom = 0;
<a name="l18520"></a>18520       <span class="keywordflow">if</span> (isset($details[$side][<span class="charliteral">&#39;c&#39;</span>]) &amp;&amp; is_array($details[$side][<span class="charliteral">&#39;c&#39;</span>])) { 
<a name="l18521"></a>18521         $coldom = 10-((($details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>]*1.00)+($details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>]*1.00)+($details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]*1.00))/76.5); 
<a name="l18522"></a>18522       } <span class="comment">// 10 black - 0 white</span>
<a name="l18523"></a>18523       <span class="keywordflow">if</span> ($coldom) { $dom += $coldom; }
<a name="l18524"></a>18524       
<a name="l18525"></a>18525       <span class="comment">// mPDF 3.0 Lastly precedence to RIGHT and BOTTOM cells at joins</span>
<a name="l18526"></a>18526       <span class="keywordflow">if</span> (isset($details[<span class="stringliteral">&#39;cellposdom&#39;</span>])) { $dom += $details[<span class="stringliteral">&#39;cellposdom&#39;</span>]; } 
<a name="l18527"></a>18527 
<a name="l18528"></a>18528       $save = <span class="keyword">false</span>;
<a name="l18529"></a>18529       <span class="comment">// mPDF 3.0</span>
<a name="l18530"></a>18530       <span class="keywordflow">if</span> ($side == <span class="charliteral">&#39;T&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_TOP)) { $cbord = _BORDER_TOP; $save = <span class="keyword">true</span>; }
<a name="l18531"></a>18531       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side == <span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_LEFT)) { $cbord = _BORDER_LEFT; $save = <span class="keyword">true</span>; }
<a name="l18532"></a>18532       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side == <span class="charliteral">&#39;R&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_RIGHT)) { $cbord = _BORDER_RIGHT; $save = <span class="keyword">true</span>; }
<a name="l18533"></a>18533       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($side == <span class="charliteral">&#39;B&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_BOTTOM)) { $cbord = _BORDER_BOTTOM; $save = <span class="keyword">true</span>; }
<a name="l18534"></a>18534 
<a name="l18535"></a>18535       <span class="keywordflow">if</span> ($save) {
<a name="l18536"></a>18536         <span class="comment">// mPDF 4.3.008 4.3.014</span>
<a name="l18537"></a>18537         $this-&gt;cellBorderBuffer[] = pack(<span class="stringliteral">&quot;A16nCndnnnA10d14&quot;</span>,
<a name="l18538"></a>18538           str_pad(sprintf(<span class="stringliteral">&quot;%08.7f&quot;</span>, $dom),16,<span class="stringliteral">&quot;0&quot;</span>,STR_PAD_LEFT),
<a name="l18539"></a>18539           $cbord,
<a name="l18540"></a>18540           ord($side),
<a name="l18541"></a>18541           $details[$side][<span class="charliteral">&#39;s&#39;</span>],
<a name="l18542"></a>18542           $details[$side][<span class="charliteral">&#39;w&#39;</span>],
<a name="l18543"></a>18543           $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],
<a name="l18544"></a>18544           $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],
<a name="l18545"></a>18545           $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],
<a name="l18546"></a>18546           $details[$side][<span class="stringliteral">&#39;style&#39;</span>], 
<a name="l18547"></a>18547           $x, $y, $w, $h,
<a name="l18548"></a>18548           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>],
<a name="l18549"></a>18549           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>],
<a name="l18550"></a>18550           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>],
<a name="l18551"></a>18551           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>],
<a name="l18552"></a>18552           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>],
<a name="l18553"></a>18553           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>],
<a name="l18554"></a>18554           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>],
<a name="l18555"></a>18555           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>],
<a name="l18556"></a>18556           $details[<span class="stringliteral">&#39;cellposdom&#39;</span>],
<a name="l18557"></a>18557           0
<a name="l18558"></a>18558         );
<a name="l18559"></a>18559          <span class="keywordflow">if</span> ($details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;ridge&#39;</span> || $details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;groove&#39;</span> || $details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;inset&#39;</span> || $details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;outset&#39;</span> || $details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;double&#39;</span> ) {
<a name="l18560"></a>18560         $details[$side][<span class="stringliteral">&#39;overlay&#39;</span>] = <span class="keyword">true</span>;
<a name="l18561"></a>18561         <span class="comment">// mPDF 4.3.008 4.3.014</span>
<a name="l18562"></a>18562         $this-&gt;cellBorderBuffer[] = pack(<span class="stringliteral">&quot;A16nCndnnnA10d14&quot;</span>,
<a name="l18563"></a>18563           str_pad(sprintf(<span class="stringliteral">&quot;%08.7f&quot;</span>, ($dom+4)),16,<span class="stringliteral">&quot;0&quot;</span>,STR_PAD_LEFT), <span class="comment">/* mPDF 4.3.019 */</span>
<a name="l18564"></a>18564           $cbord,
<a name="l18565"></a>18565           ord($side),
<a name="l18566"></a>18566           $details[$side][<span class="charliteral">&#39;s&#39;</span>],
<a name="l18567"></a>18567           $details[$side][<span class="charliteral">&#39;w&#39;</span>],
<a name="l18568"></a>18568           $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],
<a name="l18569"></a>18569           $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],
<a name="l18570"></a>18570           $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],
<a name="l18571"></a>18571           $details[$side][<span class="stringliteral">&#39;style&#39;</span>], 
<a name="l18572"></a>18572           $x, $y, $w, $h,
<a name="l18573"></a>18573           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>],
<a name="l18574"></a>18574           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>],
<a name="l18575"></a>18575           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>],
<a name="l18576"></a>18576           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>],
<a name="l18577"></a>18577           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>],
<a name="l18578"></a>18578           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>],
<a name="l18579"></a>18579           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>],
<a name="l18580"></a>18580           $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>],
<a name="l18581"></a>18581           $details[<span class="stringliteral">&#39;cellposdom&#39;</span>],
<a name="l18582"></a>18582           1
<a name="l18583"></a>18583         );
<a name="l18584"></a>18584          }
<a name="l18585"></a>18585       }
<a name="l18586"></a>18586     }
<a name="l18587"></a>18587     <span class="keywordflow">return</span>;
<a name="l18588"></a>18588      }
<a name="l18589"></a>18589 
<a name="l18590"></a>18590      <span class="keywordflow">if</span> (isset($details[<span class="charliteral">&#39;p&#39;</span>]) &amp;&amp; strlen($details[<span class="charliteral">&#39;p&#39;</span>])&gt;1) { $priority = $details[<span class="charliteral">&#39;p&#39;</span>]; }
<a name="l18591"></a>18591      <span class="keywordflow">else</span> { $priority=<span class="stringliteral">&#39;LTRB&#39;</span>; }
<a name="l18592"></a>18592      $Tw = 0; 
<a name="l18593"></a>18593      $Rw = 0; 
<a name="l18594"></a>18594      $Bw = 0; 
<a name="l18595"></a>18595      $Lw = 0; 
<a name="l18596"></a>18596     <span class="keywordflow">if</span> (isset($details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])) { $Tw = $details[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l18597"></a>18597     <span class="keywordflow">if</span> (isset($details[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])) { $Rw = $details[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l18598"></a>18598     <span class="keywordflow">if</span> (isset($details[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])) { $Bw = $details[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l18599"></a>18599     <span class="keywordflow">if</span> (isset($details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])) { $Lw = $details[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l18600"></a>18600 
<a name="l18601"></a>18601      $x2 = $x + $w; $y2 = $y + $h;
<a name="l18602"></a>18602      $oldlinewidth = $this-&gt;LineWidth;
<a name="l18603"></a>18603 
<a name="l18604"></a>18604      <span class="keywordflow">for</span>($p=0;$p&lt;strlen($priority);$p++) {
<a name="l18605"></a>18605     $side = substr($priority,$p,1);
<a name="l18606"></a>18606     $xadj = 0;
<a name="l18607"></a>18607     $xadj2 = 0;
<a name="l18608"></a>18608     $yadj = 0;
<a name="l18609"></a>18609     $yadj2 = 0;
<a name="l18610"></a>18610     $print = <span class="keyword">false</span>;
<a name="l18611"></a>18611     <span class="keywordflow">if</span> ($Tw &amp;&amp; $side==<span class="charliteral">&#39;T&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_TOP)) {  <span class="comment">// TOP</span>
<a name="l18612"></a>18612       $ly1 = $y;
<a name="l18613"></a>18613       $ly2 = $y;
<a name="l18614"></a>18614       $lx1 = $x;
<a name="l18615"></a>18615       $lx2 = $x2;
<a name="l18616"></a>18616       $this-&gt;SetLineWidth($Tw);
<a name="l18617"></a>18617       <span class="comment">// mPDF 3.0</span>
<a name="l18618"></a>18618       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;L&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18619"></a>18619         <span class="keywordflow">if</span> ($Tw &gt; $Lw) $xadj = ($Tw - $Lw)/2;
<a name="l18620"></a>18620         <span class="keywordflow">if</span> ($Tw &lt; $Lw) $xadj = ($Tw + $Lw)/2;
<a name="l18621"></a>18621       }
<a name="l18622"></a>18622       <span class="keywordflow">else</span> { $xadj = $Tw/2 - $bsh/2; }
<a name="l18623"></a>18623       <span class="comment">// mPDF 3.0</span>
<a name="l18624"></a>18624       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;R&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18625"></a>18625         <span class="keywordflow">if</span> ($Tw &gt; $Rw) $xadj2 = ($Tw - $Rw)/2;
<a name="l18626"></a>18626         <span class="keywordflow">if</span> ($Tw &lt; $Rw) $xadj2 = ($Tw + $Rw)/2;
<a name="l18627"></a>18627       }
<a name="l18628"></a>18628       <span class="keywordflow">else</span> { $xadj2 = $Tw/2 - $bsh/2; }
<a name="l18629"></a>18629       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>]) {
<a name="l18630"></a>18630         $xadj = ($Tw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>])/2 ;
<a name="l18631"></a>18631       }
<a name="l18632"></a>18632       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>]) {
<a name="l18633"></a>18633         $xadj2 = ($Tw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>])/2;
<a name="l18634"></a>18634       }
<a name="l18635"></a>18635       $print = <span class="keyword">true</span>;
<a name="l18636"></a>18636     }
<a name="l18637"></a>18637     <span class="keywordflow">if</span> ($Lw &amp;&amp; $side==<span class="charliteral">&#39;L&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_LEFT)) { <span class="comment">// LEFT</span>
<a name="l18638"></a>18638       $ly1 = $y;
<a name="l18639"></a>18639       $ly2 = $y2;
<a name="l18640"></a>18640       $lx1 = $x;
<a name="l18641"></a>18641       $lx2 = $x;
<a name="l18642"></a>18642       $this-&gt;SetLineWidth($Lw);
<a name="l18643"></a>18643       <span class="comment">// mPDF 3.0</span>
<a name="l18644"></a>18644       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;T&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18645"></a>18645         <span class="keywordflow">if</span> ($Lw &gt; $Tw) $yadj = ($Lw - $Tw)/2;
<a name="l18646"></a>18646         <span class="keywordflow">if</span> ($Lw &lt; $Tw) $yadj = ($Lw + $Tw)/2;
<a name="l18647"></a>18647       }
<a name="l18648"></a>18648       <span class="keywordflow">else</span> { $yadj = $Lw/2 - $bsv/2; }
<a name="l18649"></a>18649       <span class="comment">// mPDF 3.0</span>
<a name="l18650"></a>18650       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;B&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18651"></a>18651         <span class="keywordflow">if</span> ($Lw &gt; $Bw) $yadj2 = ($Lw - $Bw)/2;
<a name="l18652"></a>18652         <span class="keywordflow">if</span> ($Lw &lt; $Bw) $yadj2 = ($Lw + $Bw)/2;
<a name="l18653"></a>18653       }
<a name="l18654"></a>18654       <span class="keywordflow">else</span> { $yadj2 = $Lw/2 - $bsv/2; }
<a name="l18655"></a>18655       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>]) {
<a name="l18656"></a>18656         $yadj = ($Lw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>])/2;
<a name="l18657"></a>18657       }
<a name="l18658"></a>18658       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>]) {
<a name="l18659"></a>18659         $yadj2 = ($Lw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>])/2;
<a name="l18660"></a>18660       }
<a name="l18661"></a>18661       $print = <span class="keyword">true</span>;
<a name="l18662"></a>18662     }
<a name="l18663"></a>18663     <span class="keywordflow">if</span> ($Rw &amp;&amp; $side==<span class="charliteral">&#39;R&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_RIGHT)) {  <span class="comment">// RIGHT</span>
<a name="l18664"></a>18664       $ly1 = $y;
<a name="l18665"></a>18665       $ly2 = $y2;
<a name="l18666"></a>18666       $lx1 = $x2;
<a name="l18667"></a>18667       $lx2 = $x2;
<a name="l18668"></a>18668       $this-&gt;SetLineWidth($Rw);
<a name="l18669"></a>18669       <span class="comment">// mPDF 3.0</span>
<a name="l18670"></a>18670       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;T&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18671"></a>18671         <span class="keywordflow">if</span> ($Rw &lt; $Tw) $yadj = ($Rw + $Tw)/2;
<a name="l18672"></a>18672         <span class="keywordflow">if</span> ($Rw &gt; $Tw) $yadj = ($Rw - $Tw)/2;
<a name="l18673"></a>18673       }
<a name="l18674"></a>18674       <span class="keywordflow">else</span> { $yadj = $Rw/2 - $bsv/2; }
<a name="l18675"></a>18675 
<a name="l18676"></a>18676       <span class="comment">// mPDF 3.0</span>
<a name="l18677"></a>18677       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;B&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18678"></a>18678         <span class="keywordflow">if</span> ($Rw &gt; $Bw) $yadj2 = ($Rw - $Bw)/2;
<a name="l18679"></a>18679         <span class="keywordflow">if</span> ($Rw &lt; $Bw) $yadj2 = ($Rw + $Bw)/2;
<a name="l18680"></a>18680       }
<a name="l18681"></a>18681       <span class="keywordflow">else</span> { $yadj2 = $Rw/2 - $bsv/2; }
<a name="l18682"></a>18682 
<a name="l18683"></a>18683       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>]) {
<a name="l18684"></a>18684         $yadj = ($Rw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>])/2;
<a name="l18685"></a>18685       }
<a name="l18686"></a>18686       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>]) {
<a name="l18687"></a>18687         $yadj2 = ($Rw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>])/2;
<a name="l18688"></a>18688       }
<a name="l18689"></a>18689       $print = <span class="keyword">true</span>;
<a name="l18690"></a>18690     }
<a name="l18691"></a>18691     <span class="keywordflow">if</span> ($Bw &amp;&amp; $side==<span class="charliteral">&#39;B&#39;</span> &amp;&amp; $this-&gt;issetBorder($bord, _BORDER_BOTTOM)) { <span class="comment">// BOTTOM</span>
<a name="l18692"></a>18692       $ly1 = $y2;
<a name="l18693"></a>18693       $ly2 = $y2;
<a name="l18694"></a>18694       $lx1 = $x;
<a name="l18695"></a>18695       $lx2 = $x2;
<a name="l18696"></a>18696       $this-&gt;SetLineWidth($Bw);
<a name="l18697"></a>18697       <span class="comment">// mPDF 3.0</span>
<a name="l18698"></a>18698       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;L&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18699"></a>18699         <span class="keywordflow">if</span> ($Bw &gt; $Lw) $xadj = ($Bw - $Lw)/2;
<a name="l18700"></a>18700         <span class="keywordflow">if</span> ($Bw &lt; $Lw) $xadj = ($Bw + $Lw)/2;
<a name="l18701"></a>18701       }
<a name="l18702"></a>18702       <span class="keywordflow">else</span> { $xadj = $Bw/2 - $bsh/2; }
<a name="l18703"></a>18703       <span class="comment">// mPDF 3.0</span>
<a name="l18704"></a>18704       <span class="keywordflow">if</span> ($cort == <span class="stringliteral">&#39;cell&#39;</span> || strpos($tablecorner,<span class="charliteral">&#39;R&#39;</span>)!==<span class="keyword">false</span>) {
<a name="l18705"></a>18705         <span class="keywordflow">if</span> ($Bw &gt; $Rw) $xadj2 = ($Bw - $Rw)/2;
<a name="l18706"></a>18706         <span class="keywordflow">if</span> ($Bw &lt; $Rw) $xadj2 = ($Bw + $Rw)/2;
<a name="l18707"></a>18707       }
<a name="l18708"></a>18708       <span class="keywordflow">else</span> { $xadj2 = $Bw/2 - $bsh/2; }
<a name="l18709"></a>18709       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>]) {
<a name="l18710"></a>18710         $xadj = ($Bw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>])/2;
<a name="l18711"></a>18711       }
<a name="l18712"></a>18712       <span class="keywordflow">if</span> (!$bSeparate &amp;&amp; $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>]) {
<a name="l18713"></a>18713         $xadj2 = ($Bw - $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>])/2;
<a name="l18714"></a>18714       }
<a name="l18715"></a>18715       $print = <span class="keyword">true</span>;
<a name="l18716"></a>18716     }
<a name="l18717"></a>18717 
<a name="l18718"></a>18718     <span class="comment">// Now draw line</span>
<a name="l18719"></a>18719     <span class="keywordflow">if</span> ($print) {
<a name="l18720"></a>18720        <span class="keywordflow">if</span> ($details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;dashed&#39;</span>) {
<a name="l18721"></a>18721       $dashsize = 2;  <span class="comment">// final dash will be this + 1*linewidth</span>
<a name="l18722"></a>18722       $dashsizek = 1.5; <span class="comment">// ratio of Dash/Blank</span>
<a name="l18723"></a>18723       $this-&gt;SetDash($dashsize,($dashsize/$dashsizek)+($this-&gt;LineWidth*2));
<a name="l18724"></a>18724        }
<a name="l18725"></a>18725        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($details[$side][<span class="stringliteral">&#39;style&#39;</span>] == <span class="stringliteral">&#39;dotted&#39;</span>) {
<a name="l18726"></a>18726         $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;1 J&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;1 j&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l18727"></a>18727       $this-&gt;SetDash(0.001,($this-&gt;LineWidth*2));
<a name="l18728"></a>18728        }
<a name="l18729"></a>18729        <span class="keywordflow">if</span> ($details[$side][<span class="charliteral">&#39;c&#39;</span>]) { 
<a name="l18730"></a>18730       $this-&gt;SetDrawColor($details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>],$details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>],$details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l18731"></a>18731        }
<a name="l18732"></a>18732        <span class="keywordflow">else</span> { $this-&gt;SetDrawColor(0); }
<a name="l18733"></a>18733        $this-&gt;Line($lx1 + $xadj, $ly1 + $yadj, $lx2 - $xadj2, $ly2 - $yadj2);
<a name="l18734"></a>18734 
<a name="l18735"></a>18735         <span class="comment">// Reset Corners</span>
<a name="l18736"></a>18736         $this-&gt;SetDash(); 
<a name="l18737"></a>18737         <span class="comment">//BUTT style line cap</span>
<a name="l18738"></a>18738         $this-&gt;_out(<span class="stringliteral">&#39;2 J&#39;</span>);
<a name="l18739"></a>18739     }
<a name="l18740"></a>18740      }
<a name="l18741"></a>18741 
<a name="l18742"></a>18742      <span class="keywordflow">if</span> ($bSeparate &amp;&amp; count($cellBorderOverlay)) {
<a name="l18743"></a>18743     <span class="keywordflow">foreach</span>($cellBorderOverlay AS $cbo) {
<a name="l18744"></a>18744       $this-&gt;SetLineWidth($cbo[<span class="stringliteral">&#39;lw&#39;</span>]);
<a name="l18745"></a>18745       $this-&gt;SetDrawColor($cbo[<span class="stringliteral">&#39;col&#39;</span>][0],$cbo[<span class="stringliteral">&#39;col&#39;</span>][1],$cbo[<span class="stringliteral">&#39;col&#39;</span>][2]); 
<a name="l18746"></a>18746       $this-&gt;Line($cbo[<span class="charliteral">&#39;x&#39;</span>], $cbo[<span class="charliteral">&#39;y&#39;</span>], $cbo[<span class="stringliteral">&#39;x2&#39;</span>], $cbo[<span class="stringliteral">&#39;y2&#39;</span>]);
<a name="l18747"></a>18747     }
<a name="l18748"></a>18748      }
<a name="l18749"></a>18749 
<a name="l18750"></a>18750      $this-&gt;SetLineWidth($oldlinewidth);
<a name="l18751"></a>18751      $this-&gt;SetDrawColor(0);
<a name="l18752"></a>18752   }
<a name="l18753"></a>18753 }
<a name="l18754"></a>18754 
<a name="l18755"></a>18755 
<a name="l18756"></a>18756 
<a name="l18757"></a>18757 
<a name="l18758"></a>18758 
<a name="l18759"></a>18759 function setBorder(&amp;$var, $flag, $set = <span class="keyword">true</span>) {
<a name="l18760"></a>18760   $flag = intval($flag);
<a name="l18761"></a>18761   <span class="keywordflow">if</span> ($set) { $set = <span class="keyword">true</span>; }
<a name="l18762"></a>18762   $var = intval($var);
<a name="l18763"></a>18763   $var = $set ? ($var | $flag) : ($var &amp; ~$flag);
<a name="l18764"></a>18764 }
<a name="l18765"></a>18765 function issetBorder($var, $flag) {
<a name="l18766"></a>18766   $flag = intval($flag);
<a name="l18767"></a>18767   $var = intval($var);
<a name="l18768"></a>18768   <span class="keywordflow">return</span> (($var &amp; $flag) == $flag);
<a name="l18769"></a>18769 }
<a name="l18770"></a>18770 
<a name="l18771"></a>18771 <span class="comment">// mPDF 4.0</span>
<a name="l18772"></a>18772 function _table2cellBorder(&amp;$tableb, &amp;$cbdb, &amp;$cellb, $bval) {
<a name="l18773"></a>18773   <span class="keywordflow">if</span> ($tableb &amp;&amp; $tableb[<span class="charliteral">&#39;w&#39;</span>] &gt; $cbdb[<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l18774"></a>18774     $cbdb = $tableb;
<a name="l18775"></a>18775     $this-&gt;setBorder($cellb, $bval); 
<a name="l18776"></a>18776   }
<a name="l18777"></a>18777   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tableb &amp;&amp; $tableb[<span class="charliteral">&#39;w&#39;</span>] == $cbdb[<span class="charliteral">&#39;w&#39;</span>] 
<a name="l18778"></a>18778     &amp;&amp; array_search($tableb[<span class="stringliteral">&#39;style&#39;</span>],$this-&gt;borderstyles) &gt; array_search($cbdb[<span class="stringliteral">&#39;style&#39;</span>],$this-&gt;borderstyles)) {
<a name="l18779"></a>18779     $cbdb = $tableb;
<a name="l18780"></a>18780     $this-&gt;setBorder($cellb, $bval); 
<a name="l18781"></a>18781   }
<a name="l18782"></a>18782 }
<a name="l18783"></a>18783 
<a name="l18784"></a>18784 <span class="comment">// FIX BORDERS ********************************************</span>
<a name="l18785"></a>18785 function _fixTableBorders(&amp;$table){
<a name="l18786"></a>18786 
<a name="l18787"></a>18787   <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l18788"></a>18788     $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; 
<a name="l18789"></a>18789   } 
<a name="l18790"></a>18790   <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l18791"></a>18791     $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; 
<a name="l18792"></a>18792   } 
<a name="l18793"></a>18793   <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l18794"></a>18794     $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; 
<a name="l18795"></a>18795   } 
<a name="l18796"></a>18796   <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]) {
<a name="l18797"></a>18797     $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]; 
<a name="l18798"></a>18798   } 
<a name="l18799"></a>18799   <span class="keywordflow">if</span> ($this-&gt;simpleTables) { <span class="keywordflow">return</span>; }  <span class="comment">// mPDF 4.2.017</span>
<a name="l18800"></a>18800   $cells = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>];
<a name="l18801"></a>18801   $numcols = $table[<span class="stringliteral">&#39;nc&#39;</span>];
<a name="l18802"></a>18802   $numrows = $table[<span class="stringliteral">&#39;nr&#39;</span>];
<a name="l18803"></a>18803 
<a name="l18804"></a>18804   <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $numrows ; $i++ ) { <span class="comment">//Rows</span>
<a name="l18805"></a>18805     <span class="keywordflow">for</span>( $j = 0 ; $j &lt; $numcols ; $j++ ) { <span class="comment">//Columns</span>
<a name="l18806"></a>18806     <span class="keywordflow">if</span> (isset($cells[$i][$j]) &amp;&amp; $cells[$i][$j]) {
<a name="l18807"></a>18807       $cell = &amp;$cells[$i][$j];
<a name="l18808"></a>18808       <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l18809"></a>18809       <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l18810"></a>18810         $cbord = $this-&gt;_unpackCellBorder($cell[<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l18811"></a>18811       }
<a name="l18812"></a>18812       <span class="keywordflow">else</span> {
<a name="l18813"></a>18813         $cbord = &amp;$cells[$i][$j];
<a name="l18814"></a>18814       }
<a name="l18815"></a>18815 
<a name="l18816"></a>18816       <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l18817"></a>18817         <span class="keywordflow">if</span> (!$cbord[<span class="stringliteral">&#39;border&#39;</span>] &amp;&amp; isset($table[<span class="stringliteral">&#39;border&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;border&#39;</span>] &amp;&amp; $this-&gt;table_border_attr_set) {
<a name="l18818"></a>18818         $cbord[<span class="stringliteral">&#39;border&#39;</span>] = $table[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l18819"></a>18819         $cbord[<span class="stringliteral">&#39;border_details&#39;</span>] = $table[<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l18820"></a>18820       }
<a name="l18821"></a>18821 
<a name="l18822"></a>18822       <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;colspan&#39;</span>]&gt;1) { $ccolsp = $cell[<span class="stringliteral">&#39;colspan&#39;</span>]; }
<a name="l18823"></a>18823       <span class="keywordflow">else</span> { $ccolsp = 1; }
<a name="l18824"></a>18824       <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;rowspan&#39;</span>]&gt;1) { $crowsp = $cell[<span class="stringliteral">&#39;rowspan&#39;</span>]; }
<a name="l18825"></a>18825       <span class="keywordflow">else</span> { $crowsp = 1; }
<a name="l18826"></a>18826 
<a name="l18827"></a>18827       <span class="comment">// mPDF 3.0</span>
<a name="l18828"></a>18828       $cbord[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="stringliteral">&#39;cellposdom&#39;</span>] = ((($i+1)/$numrows) / 10000 ) + ((($j+1)/$numcols) / 10 );
<a name="l18829"></a>18829       <span class="comment">// Inherit Cell border from Table border</span>
<a name="l18830"></a>18830       <span class="keywordflow">if</span> ($this-&gt;table_border_css_set &amp;&amp; !$table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {
<a name="l18831"></a>18831         <span class="keywordflow">if</span> ($i == 0) {
<a name="l18832"></a>18832           $this-&gt;_table2cellBorder($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>], $cbord[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>], $cbord[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_TOP);  <span class="comment">// mPDF 4.3.009</span>
<a name="l18833"></a>18833         }
<a name="l18834"></a>18834         <span class="keywordflow">if</span> ($i == ($numrows-1) || ($i+$crowsp) == ($numrows) ) {
<a name="l18835"></a>18835           $this-&gt;_table2cellBorder($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>], $cbord[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>], $cbord[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_BOTTOM); <span class="comment">// mPDF 4.3.009</span>
<a name="l18836"></a>18836         }
<a name="l18837"></a>18837         <span class="keywordflow">if</span> ($j == 0) {
<a name="l18838"></a>18838           $this-&gt;_table2cellBorder($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>], $cbord[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>], $cbord[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_LEFT); <span class="comment">// mPDF 4.3.009</span>
<a name="l18839"></a>18839         }
<a name="l18840"></a>18840         <span class="keywordflow">if</span> ($j == ($numcols-1) || ($j+$ccolsp) == ($numcols) ) {
<a name="l18841"></a>18841           $this-&gt;_table2cellBorder($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>], $cbord[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>], $cbord[<span class="stringliteral">&#39;border&#39;</span>], _BORDER_RIGHT);  <span class="comment">// mPDF 4.3.009</span>
<a name="l18842"></a>18842         }
<a name="l18843"></a>18843       }
<a name="l18844"></a>18844 
<a name="l18845"></a>18845 
<a name="l18846"></a>18846       <span class="comment">// mPDF 4.3.009 Binary packed data</span>
<a name="l18847"></a>18847       <span class="keywordflow">if</span> ($this-&gt;packTableData) { $cell[<span class="stringliteral">&#39;borderbin&#39;</span>] = $this-&gt;_packCellBorder($cbord); }
<a name="l18848"></a>18848       unset($cbord );
<a name="l18849"></a>18849       unset($cell );
<a name="l18850"></a>18850     }
<a name="l18851"></a>18851     }
<a name="l18852"></a>18852   }
<a name="l18853"></a>18853   unset($cell );
<a name="l18854"></a>18854 }
<a name="l18855"></a>18855 <span class="comment">// END FIX BORDERS ************************************************************************************</span>
<a name="l18856"></a>18856 
<a name="l18857"></a>18857 function _tableWrite(&amp;$table){
<a name="l18858"></a>18858   $level = $table[<span class="stringliteral">&#39;level&#39;</span>];
<a name="l18859"></a>18859   $levelid = $table[<span class="stringliteral">&#39;levelid&#39;</span>];
<a name="l18860"></a>18860 
<a name="l18861"></a>18861   $cells = &amp;$table[<span class="stringliteral">&#39;cells&#39;</span>];
<a name="l18862"></a>18862   $numcols = $table[<span class="stringliteral">&#39;nc&#39;</span>];
<a name="l18863"></a>18863   $numrows = $table[<span class="stringliteral">&#39;nr&#39;</span>];
<a name="l18864"></a>18864 
<a name="l18865"></a>18865 
<a name="l18866"></a>18866   <span class="comment">// TABLE TOP MARGIN</span>
<a name="l18867"></a>18867   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]) {
<a name="l18868"></a>18868      <span class="keywordflow">if</span> (!$this-&gt;table_rotate &amp;&amp; $level==1) {
<a name="l18869"></a>18869     $this-&gt;DivLn($table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>],$this-&gt;blklvl,<span class="keyword">true</span>,1);   <span class="comment">// collapsible</span>
<a name="l18870"></a>18870      }
<a name="l18871"></a>18871      <span class="keywordflow">else</span> {
<a name="l18872"></a>18872     $this-&gt;y += ($table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]);
<a name="l18873"></a>18873      }
<a name="l18874"></a>18874   }
<a name="l18875"></a>18875 
<a name="l18876"></a>18876   <span class="comment">// Advance down page by half width of top border</span>
<a name="l18877"></a>18877   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l18878"></a>18878     $adv = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l18879"></a>18879   }
<a name="l18880"></a>18880   <span class="keywordflow">else</span> { 
<a name="l18881"></a>18881     $adv = $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]/2; 
<a name="l18882"></a>18882   }
<a name="l18883"></a>18883   <span class="keywordflow">if</span> (!$this-&gt;table_rotate &amp;&amp; $level==1) { $this-&gt;DivLn($adv); }
<a name="l18884"></a>18884   <span class="keywordflow">else</span> { $this-&gt;y += $adv; }
<a name="l18885"></a>18885 
<a name="l18886"></a>18886 
<a name="l18887"></a>18887   <span class="keywordflow">if</span> ($level==1) {
<a name="l18888"></a>18888     $this-&gt;x = $this-&gt;lMargin  + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l18889"></a>18889     $x0 = $this-&gt;x; 
<a name="l18890"></a>18890     $y0 = $this-&gt;y;
<a name="l18891"></a>18891     $right = $x0 + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l18892"></a>18892     $outerfilled = $this-&gt;y;  <span class="comment">// Keep track of how far down the outer DIV bgcolor is painted (NB rowspans)</span>
<a name="l18893"></a>18893     $this-&gt;outerfilled = $this-&gt;y;
<a name="l18894"></a>18894   }
<a name="l18895"></a>18895   <span class="keywordflow">else</span> {
<a name="l18896"></a>18896     $x0 = $this-&gt;x; 
<a name="l18897"></a>18897     $y0 = $this-&gt;y;
<a name="l18898"></a>18898     $right = $x0 + $table[<span class="charliteral">&#39;w&#39;</span>];   <span class="comment">// ????</span>
<a name="l18899"></a>18899     <span class="comment">// $outerfilled = $this-&gt;y; // Keep track of how far down the outer DIV bgcolor is painted (NB rowspans)</span>
<a name="l18900"></a>18900   }
<a name="l18901"></a>18901 
<a name="l18902"></a>18902   <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l18903"></a>18903     $temppgwidth = $this-&gt;tbrot_maxw;
<a name="l18904"></a>18904     $this-&gt;PageBreakTrigger = $pagetrigger = $y0 + ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]);
<a name="l18905"></a>18905      <span class="keywordflow">if</span> ($level==1) {
<a name="l18906"></a>18906     $this-&gt;tbrot_y0 = $this-&gt;y - $adv - $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] ;
<a name="l18907"></a>18907     $this-&gt;tbrot_x0 = $this-&gt;x;
<a name="l18908"></a>18908     $this-&gt;tbrot_w = $table[<span class="charliteral">&#39;w&#39;</span>];
<a name="l18909"></a>18909     <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $this-&gt;tbrot_h = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; }
<a name="l18910"></a>18910     <span class="keywordflow">else</span> { $this-&gt;tbrot_h = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>]; }
<a name="l18911"></a>18911      }
<a name="l18912"></a>18912   }
<a name="l18913"></a>18913   <span class="keywordflow">else</span> {
<a name="l18914"></a>18914     $this-&gt;PageBreakTrigger = $pagetrigger = ($this-&gt;h - $this-&gt;bMargin);
<a name="l18915"></a>18915       <span class="keywordflow">if</span> ($level==1) {
<a name="l18916"></a>18916       $temppgwidth = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l18917"></a>18917         <span class="keywordflow">if</span> (isset($table[<span class="charliteral">&#39;a&#39;</span>]) and ($table[<span class="charliteral">&#39;w&#39;</span>] &lt; $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>])) {
<a name="l18918"></a>18918         <span class="keywordflow">if</span> ($table[<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;C&#39;</span>) { $x0 += ((($right-$x0) - $table[<span class="charliteral">&#39;w&#39;</span>])/2); }
<a name="l18919"></a>18919         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($table[<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;R&#39;</span>) { $x0 = $right - $table[<span class="charliteral">&#39;w&#39;</span>]; }
<a name="l18920"></a>18920       }
<a name="l18921"></a>18921       }
<a name="l18922"></a>18922     <span class="keywordflow">else</span> {
<a name="l18923"></a>18923       $temppgwidth = $table[<span class="charliteral">&#39;w&#39;</span>];
<a name="l18924"></a>18924     }
<a name="l18925"></a>18925   }
<a name="l18926"></a>18926 
<a name="l18927"></a>18927   <span class="comment">// mPDF 4.2 Clipping Output</span>
<a name="l18928"></a>18928   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;overflow&#39;</span>]==<span class="stringliteral">&#39;hidden&#39;</span> &amp;&amp; $level==1 &amp;&amp; !$this-&gt;table_rotate &amp;&amp; !$this-&gt;ColActive) {
<a name="l18929"></a>18929     <span class="comment">//Bounding rectangle to clip</span>
<a name="l18930"></a>18930     $this-&gt;tableClipPath = sprintf(<span class="stringliteral">&#39;q %.3f %.3f %.3f %.3f re W n&#39;</span>,$x0*$this-&gt;k,$this-&gt;h*$this-&gt;k,$this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]*$this-&gt;k,-$this-&gt;h*$this-&gt;k);
<a name="l18931"></a>18931     $this-&gt;_out($this-&gt;tableClipPath);
<a name="l18932"></a>18932   }
<a name="l18933"></a>18933   <span class="keywordflow">else</span> { $this-&gt;tableClipPath = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l18934"></a>18934 
<a name="l18935"></a>18935 
<a name="l18936"></a>18936   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $indent = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2; }
<a name="l18937"></a>18937   <span class="keywordflow">else</span> { $indent = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;L&#39;</span>]/2; }
<a name="l18938"></a>18938   $x0 += $indent;
<a name="l18939"></a>18939 
<a name="l18940"></a>18940   $returny = 0;
<a name="l18941"></a>18941   $tableheader = array();
<a name="l18942"></a>18942   $tablefooter = array(); <span class="comment">// mPDF 4.0</span>
<a name="l18943"></a>18943   $tablefooterrowheight = 0;
<a name="l18944"></a>18944   $footery = 0;
<a name="l18945"></a>18945 
<a name="l18946"></a>18946   <span class="comment">// mPD 3.0 Set the Page &amp; Column where table starts</span>
<a name="l18947"></a>18947   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l18948"></a>18948     $tablestartpage = <span class="stringliteral">&#39;EVEN&#39;</span>; 
<a name="l18949"></a>18949   }
<a name="l18950"></a>18950   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==1)) {  <span class="comment">// ODD</span>
<a name="l18951"></a>18951     $tablestartpage = <span class="stringliteral">&#39;ODD&#39;</span>; 
<a name="l18952"></a>18952   }
<a name="l18953"></a>18953   <span class="keywordflow">else</span> { $tablestartpage = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l18954"></a>18954   <span class="keywordflow">if</span> ($this-&gt;ColActive) { $tablestartcolumn = $this-&gt;CurrCol; }
<a name="l18955"></a>18955   <span class="keywordflow">else</span> { $tablestartcolumn = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l18956"></a>18956 
<a name="l18957"></a>18957   <span class="comment">// mPDF 4.0 Initialise variable</span>
<a name="l18958"></a>18958   $y = $h = 0;
<a name="l18959"></a>18959 
<a name="l18960"></a>18960   <span class="comment">// mPDF 4.0 Table Footer</span>
<a name="l18961"></a>18961   <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $numrows ; $i++ ) { <span class="comment">//Rows</span>
<a name="l18962"></a>18962     <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;is_tfoot&#39;</span>][$i]) &amp;&amp; $table[<span class="stringliteral">&#39;is_tfoot&#39;</span>][$i] &amp;&amp; $level==1) { 
<a name="l18963"></a>18963     $tablefooterrowheight += $table[<span class="stringliteral">&#39;hr&#39;</span>][$i]; 
<a name="l18964"></a>18964       <span class="keywordflow">for</span>( $j = 0 ; $j &lt; $numcols ; $j++ ) { <span class="comment">//Columns</span>
<a name="l18965"></a>18965       <span class="keywordflow">if</span> (isset($cells[$i][$j]) &amp;&amp; $cells[$i][$j]) {
<a name="l18966"></a>18966         $cell = &amp;$cells[$i][$j];
<a name="l18967"></a>18967         list($x,$w) = $this-&gt;_tableGetWidth($table, $i, $j);
<a name="l18968"></a>18968         list($y,$h) = $this-&gt;_tableGetHeight($table, $i, $j);  
<a name="l18969"></a>18969         $x += $x0;
<a name="l18970"></a>18970         $y += $y0;
<a name="l18971"></a>18971 
<a name="l18972"></a>18972         <span class="comment">//Get info of tfoot ==&gt;&gt; table footer</span>
<a name="l18973"></a>18973         $tablefooter[$i][$j][<span class="charliteral">&#39;x&#39;</span>] = $x;
<a name="l18974"></a>18974         $tablefooter[$i][$j][<span class="charliteral">&#39;y&#39;</span>] = $y;
<a name="l18975"></a>18975         $tablefooter[$i][$j][<span class="charliteral">&#39;h&#39;</span>] = $h;
<a name="l18976"></a>18976         $tablefooter[$i][$j][<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l18977"></a>18977         $tablefooter[$i][$j][<span class="stringliteral">&#39;text&#39;</span>] = $cell[<span class="stringliteral">&#39;text&#39;</span>];
<a name="l18978"></a>18978         <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;textbuffer&#39;</span>])) { $tablefooter[$i][$j][<span class="stringliteral">&#39;textbuffer&#39;</span>] = $cell[<span class="stringliteral">&#39;textbuffer&#39;</span>]; }
<a name="l18979"></a>18979         <span class="keywordflow">else</span> { $tablefooter[$i][$j][<span class="stringliteral">&#39;textbuffer&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l18980"></a>18980         $tablefooter[$i][$j][<span class="charliteral">&#39;a&#39;</span>] = $cell[<span class="charliteral">&#39;a&#39;</span>];
<a name="l18981"></a>18981         $tablefooter[$i][$j][<span class="charliteral">&#39;R&#39;</span>] = $cell[<span class="charliteral">&#39;R&#39;</span>];
<a name="l18982"></a>18982         $tablefooter[$i][$j][<span class="stringliteral">&#39;va&#39;</span>] = $cell[<span class="stringliteral">&#39;va&#39;</span>];
<a name="l18983"></a>18983         $tablefooter[$i][$j][<span class="stringliteral">&#39;mih&#39;</span>] = $cell[<span class="stringliteral">&#39;mih&#39;</span>];
<a name="l18984"></a>18984         $tablefooter[$i][$j][<span class="stringliteral">&#39;background-image&#39;</span>] = $cell[<span class="stringliteral">&#39;background-image&#39;</span>]; <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l18985"></a>18985         <span class="comment">//CELL FILL BGCOLOR</span>
<a name="l18986"></a>18986         <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l18987"></a>18987           <span class="comment">// mPDF 4.3.009</span>
<a name="l18988"></a>18988           <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l18989"></a>18989             $c = $this-&gt;_unpackCellBorder($cell[<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l18990"></a>18990             $tablefooter[$i][$j][<span class="stringliteral">&#39;border&#39;</span>] = $c[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l18991"></a>18991             $tablefooter[$i][$j][<span class="stringliteral">&#39;border_details&#39;</span>] = $c[<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l18992"></a>18992           }
<a name="l18993"></a>18993           <span class="keywordflow">else</span> {
<a name="l18994"></a>18994             $tablefooter[$i][$j][<span class="stringliteral">&#39;border&#39;</span>] = $cell[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l18995"></a>18995             $tablefooter[$i][$j][<span class="stringliteral">&#39;border_details&#39;</span>] = $cell[<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l18996"></a>18996           }
<a name="l18997"></a>18997         }
<a name="l18998"></a>18998         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l18999"></a>18999           $tablefooter[$i][$j][<span class="stringliteral">&#39;border&#39;</span>] = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>];
<a name="l19000"></a>19000           $tablefooter[$i][$j][<span class="stringliteral">&#39;border_details&#39;</span>] = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l19001"></a>19001         }
<a name="l19002"></a>19002         <span class="comment">// mPDF 4.3.006</span>
<a name="l19003"></a>19003         $fill = isset($cell[<span class="stringliteral">&#39;bgcolor&#39;</span>]) ? $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] : 0;
<a name="l19004"></a>19004         $tablefooter[$i][$j][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $fill;
<a name="l19005"></a>19005         $tablefooter[$i][$j][<span class="stringliteral">&#39;padding&#39;</span>] = $cell[<span class="stringliteral">&#39;padding&#39;</span>];
<a name="l19006"></a>19006         $tablefooter[$i][$j][<span class="stringliteral">&#39;rowspan&#39;</span>] = $cell[<span class="stringliteral">&#39;rowspan&#39;</span>];
<a name="l19007"></a>19007         $tablefooter[$i][$j][<span class="stringliteral">&#39;colspan&#39;</span>] = $cell[<span class="stringliteral">&#39;colspan&#39;</span>];
<a name="l19008"></a>19008       }
<a name="l19009"></a>19009     }
<a name="l19010"></a>19010     }
<a name="l19011"></a>19011   }
<a name="l19012"></a>19012 
<a name="l19013"></a>19013   <span class="comment">//Draw Table Contents and Borders</span>
<a name="l19014"></a>19014   <span class="keywordflow">for</span>( $i = 0 ; $i &lt; $numrows ; $i++ ) { <span class="comment">//Rows</span>
<a name="l19015"></a>19015 
<a name="l19016"></a>19016     <span class="comment">// Get Maximum row/cell height in row - including rowspan&gt;1 + 1 overlapping</span>
<a name="l19017"></a>19017     $maxrowheight = 0;
<a name="l19018"></a>19018     <span class="keywordflow">for</span>( $j = 0 ; $j &lt; $numcols ; $j++ ) { <span class="comment">//Columns</span>
<a name="l19019"></a>19019     list($y,$h) = $this-&gt;_tableGetHeight($table, $i, $j);
<a name="l19020"></a>19020     $maxrowheight = max($maxrowheight,$h);
<a name="l19021"></a>19021     }
<a name="l19022"></a>19022 
<a name="l19023"></a>19023     $skippage = <span class="keyword">false</span>;
<a name="l19024"></a>19024     $newpagestarted = <span class="keyword">false</span>;
<a name="l19025"></a>19025     <span class="keywordflow">for</span>( $j = 0 ; $j &lt; $numcols ; $j++ ) { <span class="comment">//Columns</span>
<a name="l19026"></a>19026     <span class="keywordflow">if</span> (isset($cells[$i][$j]) &amp;&amp; $cells[$i][$j]) {
<a name="l19027"></a>19027       $cell = &amp;$cells[$i][$j];
<a name="l19028"></a>19028 
<a name="l19029"></a>19029       list($x,$w) = $this-&gt;_tableGetWidth($table, $i, $j);
<a name="l19030"></a>19030       list($y,$h) = $this-&gt;_tableGetHeight($table, $i, $j);
<a name="l19031"></a>19031       $x += $x0;
<a name="l19032"></a>19032       $y += $y0;
<a name="l19033"></a>19033       $y -= $returny;
<a name="l19034"></a>19034       <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l19035"></a>19035         <span class="comment">// mPDF 3.0</span>
<a name="l19036"></a>19036         <span class="keywordflow">if</span> (!empty($tablefooter) || $i == ($numrows-1) || (isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+$cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) == $numrows)  || (!isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+1) == $numrows) ) {
<a name="l19037"></a>19037         $extra = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l19038"></a>19038         <span class="comment">//$extra = $table[&#39;margin&#39;][&#39;B&#39;] + $table[&#39;padding&#39;][&#39;B&#39;] + $table[&#39;border_details&#39;][&#39;B&#39;][&#39;w&#39;] + $table[&#39;border_spacing_V&#39;]/2; </span>
<a name="l19039"></a>19039         }
<a name="l19040"></a>19040         <span class="keywordflow">else</span> {
<a name="l19041"></a>19041         $extra = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; 
<a name="l19042"></a>19042         }
<a name="l19043"></a>19043       }
<a name="l19044"></a>19044         <span class="keywordflow">else</span> { $extra = $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]/2; }
<a name="l19045"></a>19045 
<a name="l19046"></a>19046       <span class="comment">// mPDF 4.2</span>
<a name="l19047"></a>19047       <span class="keywordflow">if</span> ($j==0 &amp;&amp; ((($y + $maxrowheight + $extra ) &gt; $pagetrigger) || (!$this-&gt;ColActive &amp;&amp; !empty($tablefooter) &amp;&amp; ($y + $maxrowheight + $tablefooterrowheight + $extra) &gt; $pagetrigger) &amp;&amp; ($i &lt; ($numrows - $this-&gt;tableheadernrows))) &amp;&amp; ($y0 &gt;0 || $x0 &gt; 0) &amp;&amp; !$this-&gt;InFooter) {
<a name="l19048"></a>19048         <span class="keywordflow">if</span> (!$skippage) {
<a name="l19049"></a>19049           <span class="comment">// mPDF 4.0</span>
<a name="l19050"></a>19050               <span class="keywordflow">if</span> (!$this-&gt;ColActive &amp;&amp; !empty($tablefooter) &amp;&amp; $i &gt; 0 ) { 
<a name="l19051"></a>19051             $this-&gt;y = $y;
<a name="l19052"></a>19052             $ya = $this-&gt;y;
<a name="l19053"></a>19053             $this-&gt;TableHeaderFooter($tablefooter,$tablestartpage,$tablestartcolumn,<span class="charliteral">&#39;F&#39;</span>);
<a name="l19054"></a>19054             <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l19055"></a>19055               $this-&gt;tbrot_h += $this-&gt;y - $ya ;
<a name="l19056"></a>19056             }
<a name="l19057"></a>19057           }
<a name="l19058"></a>19058           $y -= $y0;
<a name="l19059"></a>19059           $returny += $y;
<a name="l19060"></a>19060 
<a name="l19061"></a>19061           $oldcolumn = $this-&gt;CurrCol;
<a name="l19062"></a>19062           <span class="keywordflow">if</span> ($this-&gt;AcceptPageBreak()) {
<a name="l19063"></a>19063               $newpagestarted = <span class="keyword">true</span>;
<a name="l19064"></a>19064             $this-&gt;y = $y + $y0;
<a name="l19065"></a>19065 
<a name="l19066"></a>19066             <span class="comment">// mPDF 3.0 - Move down to account for border-spacing or </span>
<a name="l19067"></a>19067             <span class="comment">// extra half border width in case page breaks in middle</span>
<a name="l19068"></a>19068             <span class="keywordflow">if</span>($i&gt;0 &amp;&amp; !$this-&gt;table_rotate &amp;&amp; $level==1 &amp;&amp; !$this-&gt;ColActive) {
<a name="l19069"></a>19069               <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $adv = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; }
<a name="l19070"></a>19070               <span class="keywordflow">else</span> { 
<a name="l19071"></a>19071                 $maxbwbottom = 0;
<a name="l19072"></a>19072                 <span class="keywordflow">for</span>( $ctj = 0 ; $ctj &lt; $numcols ; $ctj++ ) {
<a name="l19073"></a>19073                   <span class="keywordflow">if</span> (isset($cells[$i][$ctj]) &amp;&amp; $cells[$i][$ctj]) {
<a name="l19074"></a>19074                     <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l19075"></a>19075                       <span class="comment">// mPDF 4.3.009</span>
<a name="l19076"></a>19076                       <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l19077"></a>19077                           list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($cells[$i][$ctj][<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l19078"></a>19078                       }
<a name="l19079"></a>19079                       <span class="keywordflow">else</span> {
<a name="l19080"></a>19080                         $bt = $cells[$i][$ctj][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l19081"></a>19081                       }
<a name="l19082"></a>19082                       $maxbwbottom = max($maxbwbottom , $bt); 
<a name="l19083"></a>19083                     }
<a name="l19084"></a>19084                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l19085"></a>19085                       $maxbwbottom = max($maxbwbottom , $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l19086"></a>19086                     }
<a name="l19087"></a>19087                   }
<a name="l19088"></a>19088                 }
<a name="l19089"></a>19089                 $adv = $maxbwbottom /2;
<a name="l19090"></a>19090               }
<a name="l19091"></a>19091               $this-&gt;y += $adv;
<a name="l19092"></a>19092             }
<a name="l19093"></a>19093 
<a name="l19094"></a>19094             <span class="comment">// mPDF 3.0 Rotated table split over pages - needs this-&gt;y for borders/backgrounds</span>
<a name="l19095"></a>19095             <span class="keywordflow">if</span>($i&gt;0 &amp;&amp; $this-&gt;table_rotate &amp;&amp; $level==1) {
<a name="l19096"></a>19096               $this-&gt;y = $y0 + $this-&gt;tbrot_w;
<a name="l19097"></a>19097             }
<a name="l19098"></a>19098 
<a name="l19099"></a>19099             <span class="comment">// mPDF 4.2 </span>
<a name="l19100"></a>19100             <span class="keywordflow">if</span> ($this-&gt;tableClipPath ) { $this-&gt;_out(<span class="stringliteral">&quot;Q&quot;</span>); }
<a name="l19101"></a>19101 
<a name="l19102"></a>19102             $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l19103"></a>19103 
<a name="l19104"></a>19104             <span class="comment">// mPDF 4.2 </span>
<a name="l19105"></a>19105             <span class="keywordflow">if</span> ($this-&gt;tableClipPath ) { $this-&gt;_out($this-&gt;tableClipPath); }
<a name="l19106"></a>19106 
<a name="l19107"></a>19107             <span class="comment">// Added to correct for OddEven Margins</span>
<a name="l19108"></a>19108             $x=$x +$this-&gt;MarginCorrection;
<a name="l19109"></a>19109             $x0=$x0 +$this-&gt;MarginCorrection;
<a name="l19110"></a>19110 
<a name="l19111"></a>19111 
<a name="l19112"></a>19112             <span class="comment">// mPDF 3.0 - Move down to account for half of top border-spacing or </span>
<a name="l19113"></a>19113             <span class="comment">// extra half border width in case page was broken in middle</span>
<a name="l19114"></a>19114             <span class="keywordflow">if</span>($i&gt;0 &amp;&amp; !$this-&gt;table_rotate &amp;&amp; $level==1 &amp;&amp; !$this-&gt;usetableheader) {
<a name="l19115"></a>19115               <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $adv = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; }
<a name="l19116"></a>19116               <span class="keywordflow">else</span> { 
<a name="l19117"></a>19117                 $maxbwtop = 0;
<a name="l19118"></a>19118                 <span class="keywordflow">for</span>( $ctj = 0 ; $ctj &lt; $numcols ; $ctj++ ) {
<a name="l19119"></a>19119                   <span class="keywordflow">if</span> (isset($cells[$i][$ctj]) &amp;&amp; $cells[$i][$ctj]) {
<a name="l19120"></a>19120                     <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l19121"></a>19121                       <span class="comment">// mPDF 4.3.009</span>
<a name="l19122"></a>19122                       <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l19123"></a>19123                           list($bt,$br,$bb,$bl) = $this-&gt;_getBorderWidths($cells[$i][$ctj][<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l19124"></a>19124                       }
<a name="l19125"></a>19125                       <span class="keywordflow">else</span> {
<a name="l19126"></a>19126                         $bt = $cells[$i][$ctj][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l19127"></a>19127                       }
<a name="l19128"></a>19128                       $maxbwtop = max($maxbwtop, $bt); 
<a name="l19129"></a>19129                     }
<a name="l19130"></a>19130                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l19131"></a>19131                       $maxbwtop = max($maxbwtop, $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]); 
<a name="l19132"></a>19132                     }
<a name="l19133"></a>19133                   }
<a name="l19134"></a>19134                 }
<a name="l19135"></a>19135                 $adv = $maxbwtop /2;
<a name="l19136"></a>19136               }
<a name="l19137"></a>19137               $this-&gt;y += $adv;
<a name="l19138"></a>19138             }
<a name="l19139"></a>19139 
<a name="l19140"></a>19140 
<a name="l19141"></a>19141             <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l19142"></a>19142               <span class="comment">// mPDF 3.0 Rotated table</span>
<a name="l19143"></a>19143               <span class="comment">//$this-&gt;tbrot_x0 = $x0;</span>
<a name="l19144"></a>19144               $this-&gt;tbrot_x0 = $this-&gt;lMargin  + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>];
<a name="l19145"></a>19145               <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $this-&gt;tbrot_h = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; }
<a name="l19146"></a>19146               <span class="keywordflow">else</span> { $this-&gt;tbrot_h = $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] ; }
<a name="l19147"></a>19147               $this-&gt;tbrot_y0 = $this-&gt;y;
<a name="l19148"></a>19148               $pagetrigger = $y0 + ($this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>]);
<a name="l19149"></a>19149             }
<a name="l19150"></a>19150             <span class="keywordflow">else</span> {
<a name="l19151"></a>19151               $pagetrigger = $this-&gt;PageBreakTrigger;
<a name="l19152"></a>19152             }
<a name="l19153"></a>19153 
<a name="l19154"></a>19154             <span class="keywordflow">if</span> ($this-&gt;kwt_saved &amp;&amp; $level==1) {
<a name="l19155"></a>19155               $this-&gt;kwt_moved = <span class="keyword">true</span>;
<a name="l19156"></a>19156             }
<a name="l19157"></a>19157 
<a name="l19158"></a>19158             <span class="comment">// Disable Table header repeat if Keep Block together</span>
<a name="l19159"></a>19159                     <span class="keywordflow">if</span> ($this-&gt;usetableheader &amp;&amp; !$this-&gt;keep_block_together &amp;&amp; !empty($tableheader)) { 
<a name="l19160"></a>19160               $ya = $this-&gt;y;
<a name="l19161"></a>19161               $this-&gt;TableHeaderFooter($tableheader,$tablestartpage,$tablestartcolumn,<span class="charliteral">&#39;H&#39;</span>);  <span class="comment">// mPDF 4.0</span>
<a name="l19162"></a>19162               <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l19163"></a>19163                 $this-&gt;tbrot_h = $this-&gt;y - $ya ;
<a name="l19164"></a>19164               }
<a name="l19165"></a>19165             }
<a name="l19166"></a>19166 
<a name="l19167"></a>19167             <span class="comment">// mPDF 3.0</span>
<a name="l19168"></a>19168             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($i==0 &amp;&amp; !$this-&gt;keep_block_together &amp;&amp; !$this-&gt;table_rotate &amp;&amp; $level==1 &amp;&amp; !$this-&gt;ColActive) {
<a name="l19169"></a>19169               <span class="comment">// Advance down page</span>
<a name="l19170"></a>19170               <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $adv = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2 + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];  }
<a name="l19171"></a>19171               <span class="keywordflow">else</span> { $adv = $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] /2 ; }
<a name="l19172"></a>19172               <span class="keywordflow">if</span> ($adv) { 
<a name="l19173"></a>19173                  <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l19174"></a>19174                 $this-&gt;y += ($adv);
<a name="l19175"></a>19175                  }
<a name="l19176"></a>19176                  <span class="keywordflow">else</span> {
<a name="l19177"></a>19177                 $this-&gt;DivLn($adv,$this-&gt;blklvl,<span class="keyword">true</span>); 
<a name="l19178"></a>19178                  }
<a name="l19179"></a>19179               }
<a name="l19180"></a>19180             }
<a name="l19181"></a>19181 
<a name="l19182"></a>19182             $outerfilled = 0;
<a name="l19183"></a>19183             $y0 = $this-&gt;y; 
<a name="l19184"></a>19184             $y = $y0;
<a name="l19185"></a>19185           }
<a name="l19186"></a>19186         }
<a name="l19187"></a>19187         $skippage = <span class="keyword">true</span>;
<a name="l19188"></a>19188       }
<a name="l19189"></a>19189 
<a name="l19190"></a>19190       $this-&gt;x = $x; 
<a name="l19191"></a>19191       $this-&gt;y = $y;
<a name="l19192"></a>19192 
<a name="l19193"></a>19193       <span class="keywordflow">if</span> ($this-&gt;kwt_saved &amp;&amp; $level==1) {
<a name="l19194"></a>19194         $this-&gt;printkwtbuffer();
<a name="l19195"></a>19195         $x0 = $x = $this-&gt;x; 
<a name="l19196"></a>19196         $y0 = $y = $this-&gt;y;
<a name="l19197"></a>19197         $this-&gt;kwt_moved = <span class="keyword">false</span>;
<a name="l19198"></a>19198         $this-&gt;kwt_saved = <span class="keyword">false</span>;
<a name="l19199"></a>19199       }
<a name="l19200"></a>19200 
<a name="l19201"></a>19201 
<a name="l19202"></a>19202       <span class="comment">// Set the Page &amp; Column where table starts</span>
<a name="l19203"></a>19203       <span class="keywordflow">if</span> ($i==0 &amp;&amp; $j==0 &amp;&amp; $level==1) {
<a name="l19204"></a>19204         <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) {       <span class="comment">// EVEN</span>
<a name="l19205"></a>19205           $tablestartpage = <span class="stringliteral">&#39;EVEN&#39;</span>; 
<a name="l19206"></a>19206         }
<a name="l19207"></a>19207         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==1)) {        <span class="comment">// ODD</span>
<a name="l19208"></a>19208           $tablestartpage = <span class="stringliteral">&#39;ODD&#39;</span>; 
<a name="l19209"></a>19209         }
<a name="l19210"></a>19210         <span class="keywordflow">else</span> { $tablestartpage = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l19211"></a>19211       }
<a name="l19212"></a>19212 
<a name="l19213"></a>19213 
<a name="l19214"></a>19214       <span class="comment">//ALIGN</span>
<a name="l19215"></a>19215       $align = $cell[<span class="charliteral">&#39;a&#39;</span>];
<a name="l19216"></a>19216 
<a name="l19217"></a>19217 
<a name="l19218"></a>19218 
<a name="l19219"></a>19219 
<a name="l19220"></a>19220       <span class="comment">//TABLE BACKGROUND FILL BGCOLOR - for cellSpacing</span>
<a name="l19221"></a>19221       <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l19222"></a>19222          $fill = isset($table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1]) ? $table[<span class="stringliteral">&#39;bgcolor&#39;</span>][-1] : 0;  <span class="comment">// mPDF 4.3.005</span>
<a name="l19223"></a>19223          <span class="keywordflow">if</span> ($fill) {
<a name="l19224"></a>19224           $color = $this-&gt;ConvertColor($fill);
<a name="l19225"></a>19225           <span class="keywordflow">if</span> ($color) $this-&gt;SetFillColor($color[<span class="charliteral">&#39;R&#39;</span>],$color[<span class="charliteral">&#39;G&#39;</span>],$color[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l19226"></a>19226         $xadj = ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19227"></a>19227         $yadj = ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l19228"></a>19228         $wadj = $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l19229"></a>19229         $hadj = $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>];
<a name="l19230"></a>19230           <span class="keywordflow">if</span> ($i == 0) {    <span class="comment">// Top</span>
<a name="l19231"></a>19231           $yadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l19232"></a>19232           $hadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l19233"></a>19233           }
<a name="l19234"></a>19234           <span class="keywordflow">if</span> ($j == 0) {    <span class="comment">// Left</span>
<a name="l19235"></a>19235           $xadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l19236"></a>19236           $wadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l19237"></a>19237           }
<a name="l19238"></a>19238           <span class="keywordflow">if</span> ($i == ($numrows-1) || (isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+$cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) == $numrows)  || (!isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+1) == $numrows)) {  <span class="comment">// Bottom</span>
<a name="l19239"></a>19239           $hadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>];
<a name="l19240"></a>19240           }
<a name="l19241"></a>19241           <span class="keywordflow">if</span> ($j == ($numcols-1) || (isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; ($j+$cell[<span class="stringliteral">&#39;colspan&#39;</span>]) == $numcols)  || (!isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; ($j+1) == $numcols)) {  <span class="comment">// Right</span>
<a name="l19242"></a>19242           $wadj += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l19243"></a>19243           }
<a name="l19244"></a>19244         $this-&gt;Rect($x - $xadj, $y - $yadj, $w + $wadj, $h + $hadj, <span class="charliteral">&#39;F&#39;</span>);
<a name="l19245"></a>19245          }
<a name="l19246"></a>19246       }
<a name="l19247"></a>19247 
<a name="l19248"></a>19248       <span class="comment">// TABLE BORDER - if separate</span>
<a name="l19249"></a>19249       <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $table[<span class="stringliteral">&#39;border&#39;</span>]) { 
<a name="l19250"></a>19250          $halfspaceL = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19251"></a>19251          $halfspaceR = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19252"></a>19252          $halfspaceT = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l19253"></a>19253          $halfspaceB = $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l19254"></a>19254          $tbx = $x;
<a name="l19255"></a>19255          $tby = $y;
<a name="l19256"></a>19256          $tbw = $w;
<a name="l19257"></a>19257          $tbh = $h;
<a name="l19258"></a>19258          $tab_bord = 0;
<a name="l19259"></a>19259          <span class="comment">// mPDF 3.0</span>
<a name="l19260"></a>19260          $corner = <span class="stringliteral">&#39;&#39;</span>;
<a name="l19261"></a>19261          <span class="keywordflow">if</span> ($i == 0) {   <span class="comment">// Top</span>
<a name="l19262"></a>19262         $tby -= $halfspaceT + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l19263"></a>19263         $tbh += $halfspaceT + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l19264"></a>19264         $this-&gt;setBorder($tab_bord , _BORDER_TOP); 
<a name="l19265"></a>19265         $corner .= <span class="charliteral">&#39;T&#39;</span>;
<a name="l19266"></a>19266          }
<a name="l19267"></a>19267          <span class="keywordflow">if</span> ($i == ($numrows-1) || (isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+$cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) == $numrows)  || (!isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; ($i+1) == $numrows) ) {  <span class="comment">// Bottom</span>
<a name="l19268"></a>19268         $tbh += $halfspaceB + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l19269"></a>19269         $this-&gt;setBorder($tab_bord , _BORDER_BOTTOM); 
<a name="l19270"></a>19270         $corner .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l19271"></a>19271          }
<a name="l19272"></a>19272          <span class="keywordflow">if</span> ($j == 0) {   <span class="comment">// Left</span>
<a name="l19273"></a>19273         $tbx -= $halfspaceL + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l19274"></a>19274         $tbw += $halfspaceL + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l19275"></a>19275         $this-&gt;setBorder($tab_bord , _BORDER_LEFT); 
<a name="l19276"></a>19276         $corner .= <span class="charliteral">&#39;L&#39;</span>;
<a name="l19277"></a>19277          }
<a name="l19278"></a>19278          <span class="keywordflow">if</span> ($j == ($numcols-1) || (isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; ($j+$cell[<span class="stringliteral">&#39;colspan&#39;</span>]) == $numcols)  || (!isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; ($j+1) == $numcols)) { <span class="comment">// Right</span>
<a name="l19279"></a>19279         $tbw += $halfspaceR + ($table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2);
<a name="l19280"></a>19280         $this-&gt;setBorder($tab_bord , _BORDER_RIGHT); 
<a name="l19281"></a>19281         $corner .= <span class="charliteral">&#39;R&#39;</span>;
<a name="l19282"></a>19282          }
<a name="l19283"></a>19283          $this-&gt;_tableRect($tbx, $tby, $tbw, $tbh, $tab_bord , $table[<span class="stringliteral">&#39;border_details&#39;</span>], <span class="keyword">false</span>, $table[<span class="stringliteral">&#39;borders_separate&#39;</span>], <span class="stringliteral">&#39;table&#39;</span>, $corner, $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>], $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>] );
<a name="l19284"></a>19284       }
<a name="l19285"></a>19285 
<a name="l19286"></a>19286       <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;empty_cells&#39;</span>]!=<span class="stringliteral">&#39;hide&#39;</span> || !empty($cell[<span class="stringliteral">&#39;textbuffer&#39;</span>]) || (isset($cell[<span class="stringliteral">&#39;nestedcontent&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;nestedcontent&#39;</span>]) || !$table[<span class="stringliteral">&#39;borders_separate&#39;</span>]  ) { $paintcell = <span class="keyword">true</span>; }
<a name="l19287"></a>19287       <span class="keywordflow">else</span> { $paintcell = <span class="keyword">false</span>; } 
<a name="l19288"></a>19288 
<a name="l19289"></a>19289       <span class="comment">//Set Borders</span>
<a name="l19290"></a>19290       $bord = 0; 
<a name="l19291"></a>19291       $bord_det = array();
<a name="l19292"></a>19292 
<a name="l19293"></a>19293       <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l19294"></a>19294         <span class="comment">// mPDF 4.3.009</span>
<a name="l19295"></a>19295         <span class="keywordflow">if</span> ($this-&gt;packTableData) {
<a name="l19296"></a>19296              <span class="keywordflow">if</span> ($cell[<span class="stringliteral">&#39;borderbin&#39;</span>]) {
<a name="l19297"></a>19297           $c = $this-&gt;_unpackCellBorder($cell[<span class="stringliteral">&#39;borderbin&#39;</span>]);
<a name="l19298"></a>19298           $bord = $c[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l19299"></a>19299           $bord_det = $c[<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l19300"></a>19300            }
<a name="l19301"></a>19301         }
<a name="l19302"></a>19302         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($cell[<span class="stringliteral">&#39;border&#39;</span>]) {
<a name="l19303"></a>19303           $bord = $cell[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l19304"></a>19304           $bord_det = $cell[<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l19305"></a>19305         }
<a name="l19306"></a>19306       }
<a name="l19307"></a>19307       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l19308"></a>19308           <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>]) {
<a name="l19309"></a>19309           $bord = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>];
<a name="l19310"></a>19310           $bord_det = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l19311"></a>19311         }
<a name="l19312"></a>19312       }
<a name="l19313"></a>19313 
<a name="l19314"></a>19314       <span class="comment">// mPDF 4.3.006</span>
<a name="l19315"></a>19315       <span class="comment">//CELL FILL BGCOLOR</span>
<a name="l19316"></a>19316       $fill = isset($cell[<span class="stringliteral">&#39;bgcolor&#39;</span>]) ? $cell[<span class="stringliteral">&#39;bgcolor&#39;</span>] : 0;
<a name="l19317"></a>19317 
<a name="l19318"></a>19318       <span class="keywordflow">if</span> ($fill &amp;&amp; $paintcell) {
<a name="l19319"></a>19319           $color = $this-&gt;ConvertColor($fill);
<a name="l19320"></a>19320           <span class="keywordflow">if</span> ($color) $this-&gt;SetFillColor($color[<span class="charliteral">&#39;R&#39;</span>],$color[<span class="charliteral">&#39;G&#39;</span>],$color[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l19321"></a>19321         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l19322"></a>19322           $this-&gt;Rect($x+ ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2), $y+ ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2), $w- $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>], $h- $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>], <span class="charliteral">&#39;F&#39;</span>);
<a name="l19323"></a>19323         }
<a name="l19324"></a>19324         <span class="keywordflow">else</span> { 
<a name="l19325"></a>19325           $this-&gt;Rect($x, $y, $w, $h, <span class="charliteral">&#39;F&#39;</span>);
<a name="l19326"></a>19326         }
<a name="l19327"></a>19327       }
<a name="l19328"></a>19328 
<a name="l19329"></a>19329 
<a name="l19330"></a>19330       <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;background-image&#39;</span>]) &amp;&amp; $paintcell) { <span class="comment">// mPDF 4.3.006</span>
<a name="l19331"></a>19331         <span class="keywordflow">if</span> ($cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;image_id&#39;</span>]) {  <span class="comment">// Background pattern</span>
<a name="l19332"></a>19332         $n = count($this-&gt;patterns)+1;
<a name="l19333"></a>19333         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l19334"></a>19334           $px = $x+ ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19335"></a>19335           $py = $y+ ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2);
<a name="l19336"></a>19336           $pw = $w- $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l19337"></a>19337           $ph = $h- $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>];
<a name="l19338"></a>19338         }
<a name="l19339"></a>19339         <span class="keywordflow">else</span> {
<a name="l19340"></a>19340           $px = $x;
<a name="l19341"></a>19341           $py = $y;
<a name="l19342"></a>19342           $pw = $w;
<a name="l19343"></a>19343           $ph = $h;
<a name="l19344"></a>19344         }
<a name="l19345"></a>19345         <span class="comment">// mPDF 4.3.015</span>
<a name="l19346"></a>19346         list($orig_w, $orig_h, $x_repeat, $y_repeat) = $this-&gt;_resizeBackgroundImage($cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;orig_w&#39;</span>], $cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;orig_h&#39;</span>], $pw, $ph, $cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;resize&#39;</span>], $cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;x_repeat&#39;</span>], $cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;y_repeat&#39;</span>]);
<a name="l19347"></a>19347         $this-&gt;patterns[$n] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;$px, <span class="charliteral">&#39;y&#39;</span>=&gt;$py, <span class="charliteral">&#39;w&#39;</span>=&gt;$pw, <span class="charliteral">&#39;h&#39;</span>=&gt;$ph, <span class="stringliteral">&#39;pgh&#39;</span>=&gt;$this-&gt;h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;image_id&#39;</span>], <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;x_pos&#39;</span>] , <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;y_pos&#39;</span>] , <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat);  <span class="comment">// mPDF 4.3.015</span>
<a name="l19348"></a>19348         <span class="comment">// mPDF 4.3.017</span>
<a name="l19349"></a>19349         <span class="keywordflow">if</span> ($cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($cell[<span class="stringliteral">&#39;background-image&#39;</span>][<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l19350"></a>19350         <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l19351"></a>19351         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;q /Pattern cs /P%d scn %s %.3f %.3f %.3f %.3f re f Q&#39;</span>, $n, $opac, $px*$this-&gt;k, ($this-&gt;h-$py)*$this-&gt;k, $pw*$this-&gt;k, -$ph*$this-&gt;k));
<a name="l19352"></a>19352         }
<a name="l19353"></a>19353       }
<a name="l19354"></a>19354 
<a name="l19355"></a>19355        <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;colspan&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;colspan&#39;</span>]&gt;1) { $ccolsp = $cell[<span class="stringliteral">&#39;colspan&#39;</span>]; }
<a name="l19356"></a>19356        <span class="keywordflow">else</span> { $ccolsp = 1; }
<a name="l19357"></a>19357        <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;rowspan&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;rowspan&#39;</span>]&gt;1) { $crowsp = $cell[<span class="stringliteral">&#39;rowspan&#39;</span>]; }
<a name="l19358"></a>19358        <span class="keywordflow">else</span> { $crowsp = 1; }
<a name="l19359"></a>19359 
<a name="l19360"></a>19360 
<a name="l19361"></a>19361       <span class="comment">// but still need to do this for repeated headers...</span>
<a name="l19362"></a>19362       <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $this-&gt;tabletheadjustfinished &amp;&amp; !$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l19363"></a>19363         <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;topntail&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;topntail&#39;</span>]) {
<a name="l19364"></a>19364           $bord_det[<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;border_details($table[<span class="stringliteral">&#39;topntail&#39;</span>]);
<a name="l19365"></a>19365           $bord_det[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $this-&gt;shrin_k;
<a name="l19366"></a>19366           $this-&gt;setBorder($bord, _BORDER_TOP); 
<a name="l19367"></a>19367         }
<a name="l19368"></a>19368         <span class="keywordflow">if</span> (isset($table[<span class="stringliteral">&#39;thead-underline&#39;</span>]) &amp;&amp; $table[<span class="stringliteral">&#39;thead-underline&#39;</span>]) {
<a name="l19369"></a>19369           $bord_det[<span class="charliteral">&#39;T&#39;</span>] = $this-&gt;border_details($table[<span class="stringliteral">&#39;thead-underline&#39;</span>]);
<a name="l19370"></a>19370           $bord_det[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /= $this-&gt;shrin_k;
<a name="l19371"></a>19371           $this-&gt;setBorder($bord, _BORDER_TOP); 
<a name="l19372"></a>19372         }
<a name="l19373"></a>19373       }
<a name="l19374"></a>19374 
<a name="l19375"></a>19375 
<a name="l19376"></a>19376 
<a name="l19377"></a>19377       <span class="comment">//Get info of first row ==&gt;&gt; table header</span>
<a name="l19378"></a>19378       <span class="comment">//Use &gt; 1 row if THEAD</span>
<a name="l19379"></a>19379       <span class="keywordflow">if</span> ($this-&gt;usetableheader &amp;&amp; ($i == 0  || (isset($table[<span class="stringliteral">&#39;is_thead&#39;</span>][$i]) &amp;&amp; $table[<span class="stringliteral">&#39;is_thead&#39;</span>][$i])) &amp;&amp; $level==1) {
<a name="l19380"></a>19380         $tableheader[$i][$j][<span class="charliteral">&#39;x&#39;</span>] = $x;
<a name="l19381"></a>19381         $tableheader[$i][$j][<span class="charliteral">&#39;y&#39;</span>] = $y;
<a name="l19382"></a>19382         $tableheader[$i][$j][<span class="charliteral">&#39;h&#39;</span>] = $h;
<a name="l19383"></a>19383         $tableheader[$i][$j][<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l19384"></a>19384         $tableheader[$i][$j][<span class="stringliteral">&#39;text&#39;</span>] = $cell[<span class="stringliteral">&#39;text&#39;</span>];
<a name="l19385"></a>19385         <span class="keywordflow">if</span> (isset($cell[<span class="stringliteral">&#39;textbuffer&#39;</span>])) { $tableheader[$i][$j][<span class="stringliteral">&#39;textbuffer&#39;</span>] = $cell[<span class="stringliteral">&#39;textbuffer&#39;</span>]; }
<a name="l19386"></a>19386         <span class="keywordflow">else</span> { $tableheader[$i][$j][<span class="stringliteral">&#39;textbuffer&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l19387"></a>19387         $tableheader[$i][$j][<span class="charliteral">&#39;a&#39;</span>] = $cell[<span class="charliteral">&#39;a&#39;</span>];
<a name="l19388"></a>19388         $tableheader[$i][$j][<span class="charliteral">&#39;R&#39;</span>] = $cell[<span class="charliteral">&#39;R&#39;</span>];
<a name="l19389"></a>19389 
<a name="l19390"></a>19390         $tableheader[$i][$j][<span class="stringliteral">&#39;va&#39;</span>] = $cell[<span class="stringliteral">&#39;va&#39;</span>];
<a name="l19391"></a>19391         $tableheader[$i][$j][<span class="stringliteral">&#39;mih&#39;</span>] = $cell[<span class="stringliteral">&#39;mih&#39;</span>];
<a name="l19392"></a>19392         <span class="comment">// mPDF 3.1</span>
<a name="l19393"></a>19393         $tableheader[$i][$j][<span class="stringliteral">&#39;background-image&#39;</span>] = $cell[<span class="stringliteral">&#39;background-image&#39;</span>]; <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l19394"></a>19394         <span class="comment">// mPDF 4.0</span>
<a name="l19395"></a>19395         $tableheader[$i][$j][<span class="stringliteral">&#39;rowspan&#39;</span>] = $cell[<span class="stringliteral">&#39;rowspan&#39;</span>];
<a name="l19396"></a>19396         $tableheader[$i][$j][<span class="stringliteral">&#39;colspan&#39;</span>] = $cell[<span class="stringliteral">&#39;colspan&#39;</span>];
<a name="l19397"></a>19397         $tableheader[$i][$j][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $fill;
<a name="l19398"></a>19398 
<a name="l19399"></a>19399         <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l19400"></a>19400           <span class="comment">// mPDF 4.3.009</span>
<a name="l19401"></a>19401           $tableheader[$i][$j][<span class="stringliteral">&#39;border&#39;</span>] = $bord;
<a name="l19402"></a>19402           $tableheader[$i][$j][<span class="stringliteral">&#39;border_details&#39;</span>] = $bord_det;
<a name="l19403"></a>19403         }
<a name="l19404"></a>19404         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l19405"></a>19405           $tableheader[$i][$j][<span class="stringliteral">&#39;border&#39;</span>] = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>];
<a name="l19406"></a>19406           $tableheader[$i][$j][<span class="stringliteral">&#39;border_details&#39;</span>] = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>];
<a name="l19407"></a>19407         }
<a name="l19408"></a>19408         <span class="comment">// mPDF 4.3.006</span>
<a name="l19409"></a>19409         $tableheader[$i][$j][<span class="stringliteral">&#39;padding&#39;</span>] = $cell[<span class="stringliteral">&#39;padding&#39;</span>];
<a name="l19410"></a>19410         <span class="comment">// mPDF 3.0 moved as needed earlier</span>
<a name="l19411"></a>19411         <span class="comment">//$this-&gt;tableheadernrows = max($this-&gt;tableheadernrows, ($i+1));</span>
<a name="l19412"></a>19412       }
<a name="l19413"></a>19413 
<a name="l19414"></a>19414       <span class="comment">// CELL BORDER</span>
<a name="l19415"></a>19415       <span class="keywordflow">if</span> ($bord || $bord_det) { 
<a name="l19416"></a>19416         <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $paintcell) {
<a name="l19417"></a>19417           $this-&gt;_tableRect($x + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2)+($bord_det[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2), $y+ ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)+($bord_det[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2), $w-$table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]-($bord_det[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2)-($bord_det[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2), $h- $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]-($bord_det[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] /2)-($bord_det[<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2), $bord, $bord_det, <span class="keyword">false</span>, $table[<span class="stringliteral">&#39;borders_separate&#39;</span>]);
<a name="l19418"></a>19418         }
<a name="l19419"></a>19419         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { 
<a name="l19420"></a>19420           $this-&gt;_tableRect($x, $y, $w, $h, $bord, $bord_det, <span class="keyword">true</span>, $table[<span class="stringliteral">&#39;borders_separate&#39;</span>]);  <span class="comment">// true causes buffer</span>
<a name="l19421"></a>19421         }
<a name="l19422"></a>19422 
<a name="l19423"></a>19423       }
<a name="l19424"></a>19424 
<a name="l19425"></a>19425       <span class="comment">//VERTICAL ALIGN</span>
<a name="l19426"></a>19426       <span class="keywordflow">if</span> ($cell[<span class="charliteral">&#39;R&#39;</span>] &amp;&amp; INTVAL($cell[<span class="charliteral">&#39;R&#39;</span>]) &gt; 0 &amp;&amp; INTVAL($cell[<span class="charliteral">&#39;R&#39;</span>]) &lt; 90 &amp;&amp; isset($cell[<span class="stringliteral">&#39;va&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;va&#39;</span>]!=<span class="charliteral">&#39;B&#39;</span>) { $cell[<span class="stringliteral">&#39;va&#39;</span>]=<span class="charliteral">&#39;B&#39;</span>;}
<a name="l19427"></a>19427       <span class="keywordflow">if</span> (!isset($cell[<span class="stringliteral">&#39;va&#39;</span>]) || $cell[<span class="stringliteral">&#39;va&#39;</span>]==<span class="charliteral">&#39;M&#39;</span>) $this-&gt;y += ($h-$cell[<span class="stringliteral">&#39;mih&#39;</span>])/2;
<a name="l19428"></a>19428       elseif (isset($cell[<span class="stringliteral">&#39;va&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;va&#39;</span>]==<span class="charliteral">&#39;B&#39;</span>) $this-&gt;y += $h-$cell[&#39;mih&#39;];
<a name="l19429"></a>19429 
<a name="l19430"></a>19430       <span class="comment">// NESTED CONTENT </span>
<a name="l19431"></a>19431 
<a name="l19432"></a>19432       <span class="comment">// TEXT (and nested tables)</span>
<a name="l19433"></a>19433       $this-&gt;divalign=$align;
<a name="l19434"></a>19434 
<a name="l19435"></a>19435       $this-&gt;divwidth=$w;
<a name="l19436"></a>19436       <a class="code" href="categoryif.html" title="PHPExcel root directory.">if</a> (!empty($cell[&#39;textbuffer&#39;])) {
<a name="l19437"></a>19437         $opy = $this-&gt;y;
<a name="l19438"></a>19438         <span class="keywordflow">if</span> ($cell[<span class="charliteral">&#39;R&#39;</span>]) {
<a name="l19439"></a>19439           $cellPtSize = $cell[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][11] / $this-&gt;shrin_k;
<a name="l19440"></a>19440           <span class="keywordflow">if</span> (!$cellPtSize) { $cellPtSize = $this-&gt;default_font_size; }
<a name="l19441"></a>19441           $cellFontHeight = ($cellPtSize/$this-&gt;k);
<a name="l19442"></a>19442           $opx = $this-&gt;x;
<a name="l19443"></a>19443           $angle = INTVAL($cell[<span class="charliteral">&#39;R&#39;</span>]);
<a name="l19444"></a>19444           <span class="comment">// Only allow 45 to 89 degrees (when bottom-aligned) or exactly 90 or -90</span>
<a name="l19445"></a>19445           <span class="keywordflow">if</span> ($angle &gt; 90) { $angle = 90; }
<a name="l19446"></a>19446           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &gt; 0 &amp;&amp; $angle &lt;45) { $angle = 45; }
<a name="l19447"></a>19447           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $angle = -90; }
<a name="l19448"></a>19448           $offset = ((sin(deg2rad($angle))) * 0.37 * $cellFontHeight);
<a name="l19449"></a>19449           <span class="keywordflow">if</span> (isset($cell[<span class="charliteral">&#39;a&#39;</span>]) &amp;&amp; $cell[<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;R&#39;</span>) { 
<a name="l19450"></a>19450             $this-&gt;x += ($w) + ($offset) - ($cellFontHeight/3) - ($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2)); 
<a name="l19451"></a>19451           }
<a name="l19452"></a>19452           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!isset($cell[<span class="charliteral">&#39;a&#39;</span>]) || $cell[<span class="charliteral">&#39;a&#39;</span>]==<span class="charliteral">&#39;C&#39;</span>) { 
<a name="l19453"></a>19453             $this-&gt;x += ($w/2) + ($offset); 
<a name="l19454"></a>19454           }
<a name="l19455"></a>19455           <span class="keywordflow">else</span> { 
<a name="l19456"></a>19456             $this-&gt;x += ($offset) + ($cellFontHeight/3)+($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] +($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2)); 
<a name="l19457"></a>19457           }
<a name="l19458"></a>19458           $str = ltrim(implode(<span class="charliteral">&#39; &#39;</span>,$cell[<span class="stringliteral">&#39;text&#39;</span>]));
<a name="l19459"></a>19459           $str = $this-&gt;mb_rtrim($str,$this-&gt;mb_enc);
<a name="l19460"></a>19460           <span class="keywordflow">if</span> (!isset($cell[<span class="stringliteral">&#39;va&#39;</span>]) || $cell[<span class="stringliteral">&#39;va&#39;</span>]==<span class="charliteral">&#39;M&#39;</span>) { 
<a name="l19461"></a>19461             $this-&gt;y -= ($h-$cell[<span class="stringliteral">&#39;mih&#39;</span>])/2; <span class="comment">//Undo what was added earlier VERTICAL ALIGN</span>
<a name="l19462"></a>19462             <span class="keywordflow">if</span> ($angle &gt; 0) { $this-&gt;y += (($h-$cell[<span class="stringliteral">&#39;mih&#39;</span>])/2) + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($cell[<span class="stringliteral">&#39;mih&#39;</span>]-($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>])); }
<a name="l19463"></a>19463             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $this-&gt;y += (($h-$cell[<span class="stringliteral">&#39;mih&#39;</span>])/2)+ ($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)); }
<a name="l19464"></a>19464           }
<a name="l19465"></a>19465           elseif (isset($cell[<span class="stringliteral">&#39;va&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;va&#39;</span>]==<span class="charliteral">&#39;B&#39;</span>) { 
<a name="l19466"></a>19466             $this-&gt;y -= $h-$cell[<span class="stringliteral">&#39;mih&#39;</span>]; <span class="comment">//Undo what was added earlier VERTICAL ALIGN</span>
<a name="l19467"></a>19467             <span class="keywordflow">if</span> ($angle &gt; 0) { $this-&gt;y += $h-($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)); }
<a name="l19468"></a>19468             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $this-&gt;y += $h-$cell[<span class="stringliteral">&#39;mih&#39;</span>] + ($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)); }
<a name="l19469"></a>19469           }
<a name="l19470"></a>19470           elseif (isset($cell[<span class="stringliteral">&#39;va&#39;</span>]) &amp;&amp; $cell[<span class="stringliteral">&#39;va&#39;</span>]==<span class="charliteral">&#39;T&#39;</span>) { 
<a name="l19471"></a>19471             <span class="keywordflow">if</span> ($angle &gt; 0) { $this-&gt;y += $cell[<span class="stringliteral">&#39;mih&#39;</span>]-($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)); }
<a name="l19472"></a>19472             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($angle &lt; 0) { $this-&gt;y += ($cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2)); }
<a name="l19473"></a>19473           }
<a name="l19474"></a>19474           $this-&gt;Rotate($angle,$this-&gt;x,$this-&gt;y);
<a name="l19475"></a>19475           $s_fs = $this-&gt;FontSizePt;
<a name="l19476"></a>19476           $s_f = $this-&gt;FontFamily; <span class="comment">// mPDF 3.0</span>
<a name="l19477"></a>19477           $s_st = $this-&gt;FontStyle; <span class="comment">// mPDF 3.0</span>
<a name="l19478"></a>19478           $this-&gt;SetFont($cell[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][4],$cell[<span class="stringliteral">&#39;textbuffer&#39;</span>][0][2],$cellPtSize,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l19479"></a>19479           $this-&gt;Text($this-&gt;x,$this-&gt;y,$str);
<a name="l19480"></a>19480           $this-&gt;Rotate(0);
<a name="l19481"></a>19481           $this-&gt;SetFont($s_f,$s_st,$s_fs,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l19482"></a>19482           $this-&gt;x = $opx;
<a name="l19483"></a>19483         }
<a name="l19484"></a>19484         <span class="keywordflow">else</span> {
<a name="l19485"></a>19485 
<a name="l19486"></a>19486           <span class="keywordflow">if</span> (!$this-&gt;simpleTables){  <span class="comment">// mPDF 4.2.017</span>
<a name="l19487"></a>19487              <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {  <span class="comment">// NB twice border width</span>
<a name="l19488"></a>19488             <span class="comment">// mPDF 4.3.009</span>
<a name="l19489"></a>19489             $xadj = $bord_det[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] +($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19490"></a>19490             $wadj = $bord_det[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $bord_det[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] +$cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l19491"></a>19491             $yadj = $bord_det[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19492"></a>19492              }
<a name="l19493"></a>19493              <span class="keywordflow">else</span> {
<a name="l19494"></a>19494             $xadj = $bord_det[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l19495"></a>19495             $wadj = ($bord_det[<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $bord_det[<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2 + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l19496"></a>19496             $yadj = $bord_det[<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l19497"></a>19497              }
<a name="l19498"></a>19498           }
<a name="l19499"></a>19499           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;simpleTables){
<a name="l19500"></a>19500           <span class="comment">// mPDF 4.3.006</span>
<a name="l19501"></a>19501              <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) {  <span class="comment">// NB twice border width</span>
<a name="l19502"></a>19502             $xadj = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] +($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19503"></a>19503             $wadj = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] +$cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>];
<a name="l19504"></a>19504             $yadj = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>] + ($table[<span class="stringliteral">&#39;border_spacing_H&#39;</span>]/2);
<a name="l19505"></a>19505              }
<a name="l19506"></a>19506              <span class="keywordflow">else</span> {
<a name="l19507"></a>19507             $xadj = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>];
<a name="l19508"></a>19508             $wadj = ($table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;L&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;R&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])/2 + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;L&#39;</span>] + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;R&#39;</span>];
<a name="l19509"></a>19509             $yadj = $table[<span class="stringliteral">&#39;simple&#39;</span>][<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;T&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]/2 + $cell[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;T&#39;</span>];
<a name="l19510"></a>19510              }
<a name="l19511"></a>19511           }
<a name="l19512"></a>19512 
<a name="l19513"></a>19513           $this-&gt;divwidth=$w-$wadj;
<a name="l19514"></a>19514           <span class="keywordflow">if</span> ($this-&gt;divwidth == 0) { $this-&gt;divwidth = 0.0001; }
<a name="l19515"></a>19515           $this-&gt;x += $xadj;
<a name="l19516"></a>19516           $this-&gt;y += $yadj;
<a name="l19517"></a>19517           $this-&gt;printbuffer($cell[<span class="stringliteral">&#39;textbuffer&#39;</span>],<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">true</span>);
<a name="l19518"></a>19518         }
<a name="l19519"></a>19519         $this-&gt;y = $opy;
<a name="l19520"></a>19520       }
<a name="l19521"></a>19521       unset($cell );
<a name="l19522"></a>19522       <span class="comment">//Reset values</span>
<a name="l19523"></a>19523       $this-&gt;Reset();
<a name="l19524"></a>19524     }<span class="comment">//end of (if isset(cells)...)</span>
<a name="l19525"></a>19525     }<span class="comment">// end of columns</span>
<a name="l19526"></a>19526 
<a name="l19527"></a>19527     $newpagestarted = <span class="keyword">false</span>;
<a name="l19528"></a>19528     $this-&gt;tabletheadjustfinished = <span class="keyword">false</span>;
<a name="l19529"></a>19529 
<a name="l19530"></a>19530 
<a name="l19531"></a>19531 
<a name="l19532"></a>19532 
<a name="l19533"></a>19533     <span class="keywordflow">if</span> ($i == $numrows-1) { $this-&gt;y = $y + $h; } <span class="comment">//last row jump (update this-&gt;y position)</span>
<a name="l19534"></a>19534     <span class="keywordflow">if</span> ($this-&gt;table_rotate &amp;&amp; $level==1) {
<a name="l19535"></a>19535     $this-&gt;tbrot_h += $h;
<a name="l19536"></a>19536     }
<a name="l19537"></a>19537 
<a name="l19538"></a>19538   }<span class="comment">// end of rows</span>
<a name="l19539"></a>19539 
<a name="l19540"></a>19540 
<a name="l19541"></a>19541   <span class="keywordflow">if</span> (count($this-&gt;cellBorderBuffer)) { $this-&gt;printcellbuffer(); }
<a name="l19542"></a>19542 
<a name="l19543"></a>19543   <span class="comment">// mPDF 4.2 </span>
<a name="l19544"></a>19544   <span class="keywordflow">if</span> ($this-&gt;tableClipPath ) { $this-&gt;_out(<span class="stringliteral">&quot;Q&quot;</span>); }
<a name="l19545"></a>19545   $this-&gt;tableClipPath = <span class="stringliteral">&#39;&#39;</span>;
<a name="l19546"></a>19546 
<a name="l19547"></a>19547   <span class="comment">// Advance down page by half width of bottom border</span>
<a name="l19548"></a>19548   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>]) { $this-&gt;y += $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; }
<a name="l19549"></a>19549   <span class="keywordflow">else</span> { $this-&gt;y += $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]/2; }
<a name="l19550"></a>19550 
<a name="l19551"></a>19551   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;borders_separate&#39;</span>] &amp;&amp; $level==1) { $this-&gt;tbrot_h += $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;padding&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;border_details&#39;</span>][<span class="charliteral">&#39;B&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $table[<span class="stringliteral">&#39;border_spacing_V&#39;</span>]/2; }
<a name="l19552"></a>19552   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($level==1) { $this-&gt;tbrot_h += $table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] + $table[<span class="stringliteral">&#39;max_cell_border_width&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]/2; }
<a name="l19553"></a>19553 
<a name="l19554"></a>19554 
<a name="l19555"></a>19555   <span class="comment">// TABLE BOTTOM MARGIN</span>
<a name="l19556"></a>19556   <span class="keywordflow">if</span> ($table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]) {
<a name="l19557"></a>19557     <span class="keywordflow">if</span> (!$this-&gt;table_rotate &amp;&amp; $level==1) {
<a name="l19558"></a>19558     $this-&gt;DivLn($table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>],$this-&gt;blklvl,<span class="keyword">true</span>);   <span class="comment">// collapsible</span>
<a name="l19559"></a>19559     }
<a name="l19560"></a>19560     <span class="keywordflow">else</span> {
<a name="l19561"></a>19561     $this-&gt;y += ($table[<span class="stringliteral">&#39;margin&#39;</span>][<span class="charliteral">&#39;B&#39;</span>]);
<a name="l19562"></a>19562     }
<a name="l19563"></a>19563   }
<a name="l19564"></a>19564 
<a name="l19565"></a>19565 
<a name="l19566"></a>19566 }<span class="comment">//END OF FUNCTION _tableWrite()</span>
<a name="l19567"></a>19567 
<a name="l19568"></a>19568 
<a name="l19570"></a>19570 
<a name="l19571"></a>19571 
<a name="l19572"></a>19572 function _putextgstates() {
<a name="l19573"></a>19573   <span class="keywordflow">for</span> ($i = 1; $i &lt;= count($this-&gt;extgstates); $i++) {
<a name="l19574"></a>19574             $this-&gt;_newobj();
<a name="l19575"></a>19575             $this-&gt;extgstates[$i][<span class="charliteral">&#39;n&#39;</span>] = $this-&gt;n;
<a name="l19576"></a>19576             $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /ExtGState&#39;</span>);
<a name="l19577"></a>19577             <span class="keywordflow">foreach</span> ($this-&gt;extgstates[$i][<span class="stringliteral">&#39;parms&#39;</span>] as $k=&gt;$v)
<a name="l19578"></a>19578                 $this-&gt;_out(<span class="charliteral">&#39;/&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$v);
<a name="l19579"></a>19579             $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19580"></a>19580             $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l19581"></a>19581   }
<a name="l19582"></a>19582 }
<a name="l19583"></a>19583 
<a name="l19584"></a>19584 
<a name="l19585"></a>19585 
<a name="l19586"></a>19586 
<a name="l19587"></a>19587 
<a name="l19588"></a>19588 
<a name="l19589"></a>19589 
<a name="l19590"></a>19590 
<a name="l19591"></a>19591 
<a name="l19592"></a>19592 function _putpatterns() {
<a name="l19593"></a>19593   <span class="keywordflow">for</span> ($i = 1; $i &lt;= count($this-&gt;patterns); $i++) {
<a name="l19594"></a>19594     $x = $this-&gt;patterns[$i][<span class="charliteral">&#39;x&#39;</span>];
<a name="l19595"></a>19595     $y = $this-&gt;patterns[$i][<span class="charliteral">&#39;y&#39;</span>]; 
<a name="l19596"></a>19596     $w = $this-&gt;patterns[$i][<span class="charliteral">&#39;w&#39;</span>];
<a name="l19597"></a>19597     $h = $this-&gt;patterns[$i][<span class="charliteral">&#39;h&#39;</span>]; 
<a name="l19598"></a>19598     <span class="comment">// mPDF 4.0 Uses saved page height</span>
<a name="l19599"></a>19599     $pgh = $this-&gt;patterns[$i][<span class="stringliteral">&#39;pgh&#39;</span>]; 
<a name="l19600"></a>19600     $orig_w = $this-&gt;patterns[$i][<span class="stringliteral">&#39;orig_w&#39;</span>];
<a name="l19601"></a>19601     $orig_h = $this-&gt;patterns[$i][<span class="stringliteral">&#39;orig_h&#39;</span>]; 
<a name="l19602"></a>19602     $image_id = $this-&gt;patterns[$i][<span class="stringliteral">&#39;image_id&#39;</span>];
<a name="l19603"></a>19603     <span class="keywordflow">if</span> ($this-&gt;patterns[$i][<span class="stringliteral">&#39;x_repeat&#39;</span>]) { $x_repeat = <span class="keyword">true</span>; } 
<a name="l19604"></a>19604     <span class="keywordflow">else</span> { $x_repeat = <span class="keyword">false</span>; }
<a name="l19605"></a>19605     <span class="keywordflow">if</span> ($this-&gt;patterns[$i][<span class="stringliteral">&#39;y_repeat&#39;</span>]) { $y_repeat = <span class="keyword">true</span>; }
<a name="l19606"></a>19606     <span class="keywordflow">else</span> { $y_repeat = <span class="keyword">false</span>; }
<a name="l19607"></a>19607     $x_pos = $this-&gt;patterns[$i][<span class="stringliteral">&#39;x_pos&#39;</span>];
<a name="l19608"></a>19608     <span class="keywordflow">if</span> (stristr($x_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { 
<a name="l19609"></a>19609       $x_pos += 0; 
<a name="l19610"></a>19610       $x_pos /= 100; 
<a name="l19611"></a>19611       $x_pos = ($w * $x_pos) - ($orig_w/$this-&gt;k * $x_pos);
<a name="l19612"></a>19612     }
<a name="l19613"></a>19613     $y_pos = $this-&gt;patterns[$i][<span class="stringliteral">&#39;y_pos&#39;</span>];
<a name="l19614"></a>19614     <span class="keywordflow">if</span> (stristr($y_pos ,<span class="charliteral">&#39;%&#39;</span>) ) { 
<a name="l19615"></a>19615       $y_pos += 0; 
<a name="l19616"></a>19616       $y_pos /= 100; 
<a name="l19617"></a>19617       $y_pos = ($h * $y_pos) - ($orig_h/$this-&gt;k * $y_pos);
<a name="l19618"></a>19618     }
<a name="l19619"></a>19619     $adj_x = ($x_pos + $x) *$this-&gt;k;
<a name="l19620"></a>19620     <span class="comment">// mPDF 4.0 Uses saved page height</span>
<a name="l19621"></a>19621     $adj_y = (($pgh - $y_pos - $y)*$this-&gt;k) - $orig_h ;
<a name="l19622"></a>19622     $img_obj = <span class="keyword">false</span>;
<a name="l19623"></a>19623     <span class="keywordflow">foreach</span>($this-&gt;images AS $img) {
<a name="l19624"></a>19624       <span class="keywordflow">if</span> ($img[<span class="charliteral">&#39;i&#39;</span>] == $image_id) { $img_obj = $img[<span class="charliteral">&#39;n&#39;</span>]; <span class="keywordflow">break</span>; }
<a name="l19625"></a>19625     }
<a name="l19626"></a>19626     <span class="keywordflow">if</span> (!$img_obj ) { echo <span class="stringliteral">&quot;Problem: Image object not found for background pattern &quot;</span>.$img[<span class="charliteral">&#39;i&#39;</span>]; exit; }
<a name="l19627"></a>19627 
<a name="l19628"></a>19628             $this-&gt;_newobj();
<a name="l19629"></a>19629             $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&#39;</span>);
<a name="l19630"></a>19630             $this-&gt;_out(<span class="stringliteral">&#39;/XObject &lt;&lt;/I&#39;</span>.$image_id.<span class="charliteral">&#39; &#39;</span>.$img_obj.<span class="stringliteral">&#39; 0 R &gt;&gt;&#39;</span>);
<a name="l19631"></a>19631             $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19632"></a>19632             $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l19633"></a>19633 
<a name="l19634"></a>19634     $this-&gt;_newobj();
<a name="l19635"></a>19635     $this-&gt;patterns[$i][<span class="charliteral">&#39;n&#39;</span>] = $this-&gt;n;
<a name="l19636"></a>19636     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt; /Type /Pattern /PatternType 1 /PaintType 1 /TilingType 2&#39;</span>);
<a name="l19637"></a>19637     $this-&gt;_out(<span class="stringliteral">&#39;/Resources &#39;</span>. ($this-&gt;n-1) .<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19638"></a>19638 
<a name="l19639"></a>19639     <span class="comment">// mPDF 4.3.015 %.2f to %.3F precision, and increase step 99999 to disable</span>
<a name="l19640"></a>19640     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/BBox [0 0 %.3f %.3f]&#39;</span>,$orig_w,$orig_h));
<a name="l19641"></a>19641     <span class="keywordflow">if</span> ($x_repeat) { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/XStep %.3f&#39;</span>,$orig_w)); }
<a name="l19642"></a>19642     <span class="keywordflow">else</span> { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/XStep %d&#39;</span>,99999)); }
<a name="l19643"></a>19643     <span class="keywordflow">if</span> ($y_repeat) { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/YStep %.3f&#39;</span>,$orig_h)); }
<a name="l19644"></a>19644     <span class="keywordflow">else</span> { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/YStep %d&#39;</span>,99999)); }
<a name="l19645"></a>19645 
<a name="l19646"></a>19646     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/Matrix [1 0 0 1 %.3f %.3f]&#39;</span>,$adj_x,$adj_y));
<a name="l19647"></a>19647 
<a name="l19648"></a>19648     $s = sprintf(<span class="stringliteral">&quot;q %.3f 0 0 %.3f 0 0 cm /I%d Do Q&quot;</span>,$orig_w,$orig_h,$image_id);
<a name="l19649"></a>19649 
<a name="l19650"></a>19650             <span class="keywordflow">if</span> ($this-&gt;compress) {
<a name="l19651"></a>19651       $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l19652"></a>19652       $s = gzcompress($s);
<a name="l19653"></a>19653     }
<a name="l19654"></a>19654     $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($s).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19655"></a>19655     $this-&gt;_putstream($s);
<a name="l19656"></a>19656     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l19657"></a>19657   }
<a name="l19658"></a>19658 }
<a name="l19659"></a>19659   <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l19660"></a>19660 
<a name="l19661"></a>19661 
<a name="l19662"></a>19662 
<a name="l19663"></a>19663 function _putresources() {
<a name="l19664"></a>19664   $this-&gt;_putextgstates();
<a name="l19665"></a>19665   $this-&gt;<a class="code" href="classmPDF.html#abc862900d0692ae1d96c31d68799d44a">_putfonts</a>();
<a name="l19666"></a>19666   $this-&gt;_putimages();
<a name="l19667"></a>19667   $this-&gt;_putformobjects(); <span class="comment">// *IMAGES-CORE*</span>
<a name="l19668"></a>19668 
<a name="l19669"></a>19669 
<a name="l19670"></a>19670   $this-&gt;_putpatterns();  <span class="comment">// *BACKGROUND-IMAGES*</span>
<a name="l19671"></a>19671   <span class="comment">//Resource dictionary</span>
<a name="l19672"></a>19672   $this-&gt;offsets[2]=strlen($this-&gt;buffer);
<a name="l19673"></a>19673   $this-&gt;_out(<span class="stringliteral">&#39;2 0 obj&#39;</span>);
<a name="l19674"></a>19674   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&#39;</span>);
<a name="l19675"></a>19675   $this-&gt;_out(<span class="stringliteral">&#39;/Font &lt;&lt;&#39;</span>);
<a name="l19676"></a>19676   <span class="comment">// mPDF 4.0</span>
<a name="l19677"></a>19677   <span class="keywordflow">foreach</span>($this-&gt;fonts as $font) {
<a name="l19678"></a>19678     <span class="comment">// mPDF 4.0</span>
<a name="l19679"></a>19679     <span class="keywordflow">if</span> (!$font[<span class="stringliteral">&#39;used&#39;</span>] &amp;&amp; $font[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) { <span class="keywordflow">continue</span>; }
<a name="l19680"></a>19680     <span class="keywordflow">if</span> ($font[<span class="stringliteral">&#39;type&#39;</span>]==<span class="stringliteral">&#39;Type1subset&#39;</span>) {
<a name="l19681"></a>19681       <span class="keywordflow">foreach</span>($font[<span class="charliteral">&#39;n&#39;</span>] AS $k =&gt; $fid) {
<a name="l19682"></a>19682         $this-&gt;_out(<span class="stringliteral">&#39;/F&#39;</span>.$font[<span class="stringliteral">&#39;subsetfontids&#39;</span>][$k].<span class="charliteral">&#39; &#39;</span>.$font[<span class="charliteral">&#39;n&#39;</span>][$k].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19683"></a>19683       }
<a name="l19684"></a>19684     }
<a name="l19685"></a>19685     <span class="keywordflow">else</span> { 
<a name="l19686"></a>19686       $this-&gt;_out(<span class="stringliteral">&#39;/F&#39;</span>.$font[<span class="charliteral">&#39;i&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$font[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19687"></a>19687     }
<a name="l19688"></a>19688   }
<a name="l19689"></a>19689   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19690"></a>19690   <span class="keywordflow">if</span> (count($this-&gt;extgstates)) {
<a name="l19691"></a>19691     $this-&gt;_out(<span class="stringliteral">&#39;/ExtGState &lt;&lt;&#39;</span>);
<a name="l19692"></a>19692     <span class="keywordflow">foreach</span>($this-&gt;extgstates as $k=&gt;$extgstate)
<a name="l19693"></a>19693       $this-&gt;_out(<span class="stringliteral">&#39;/GS&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$extgstate[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19694"></a>19694     $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19695"></a>19695   }
<a name="l19696"></a>19696 
<a name="l19697"></a>19697 
<a name="l19698"></a>19698   <span class="keywordflow">if</span>(count($this-&gt;images) || count($this-&gt;formobjects) || ($this-&gt;enableImports &amp;&amp; count($this-&gt;tpls))) { <span class="comment">// mPDF 4.2.006</span>
<a name="l19699"></a>19699     $this-&gt;_out(<span class="stringliteral">&#39;/XObject &lt;&lt;&#39;</span>);
<a name="l19700"></a>19700     <span class="keywordflow">foreach</span>($this-&gt;images as $image)
<a name="l19701"></a>19701       $this-&gt;_out(<span class="stringliteral">&#39;/I&#39;</span>.$image[<span class="charliteral">&#39;i&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$image[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19702"></a>19702             <span class="keywordflow">foreach</span>($this-&gt;formobjects as $formobject)
<a name="l19703"></a>19703                 $this-&gt;_out(<span class="stringliteral">&#39;/FO&#39;</span>.$formobject[<span class="charliteral">&#39;i&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$formobject[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19704"></a>19704     $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19705"></a>19705   }
<a name="l19706"></a>19706 
<a name="l19707"></a>19707   <span class="comment">// mPDF 3.0 - Tiling Patterns</span>
<a name="l19708"></a>19708   <span class="keywordflow">if</span> (count($this-&gt;patterns)) {
<a name="l19709"></a>19709     $this-&gt;_out(<span class="stringliteral">&#39;/Pattern &lt;&lt;&#39;</span>);
<a name="l19710"></a>19710     <span class="keywordflow">foreach</span>($this-&gt;patterns as $k=&gt;$patterns)
<a name="l19711"></a>19711       $this-&gt;_out(<span class="stringliteral">&#39;/P&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$patterns[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19712"></a>19712     $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19713"></a>19713   }
<a name="l19714"></a>19714 
<a name="l19715"></a>19715   $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l19716"></a>19716   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);  <span class="comment">// end resource dictionary</span>
<a name="l19717"></a>19717 
<a name="l19718"></a>19718   $this-&gt;_putbookmarks();   <span class="comment">// *BOOKMARKS*</span>
<a name="l19719"></a>19719 
<a name="l19720"></a>19720 }
<a name="l19721"></a>19721 
<a name="l19722"></a>19722 
<a name="l19723"></a>19723   function _puttrailer()
<a name="l19724"></a>19724   {
<a name="l19725"></a>19725     $this-&gt;_out(<span class="stringliteral">&#39;/Size &#39;</span>.($this-&gt;n+1));
<a name="l19726"></a>19726     $this-&gt;_out(<span class="stringliteral">&#39;/Root &#39;</span>.$this-&gt;n.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19727"></a>19727     $this-&gt;_out(<span class="stringliteral">&#39;/Info &#39;</span>.$this-&gt;InfoRoot.<span class="stringliteral">&#39; 0 R&#39;</span>); <span class="comment">// mPDF 4.2.018</span>
<a name="l19728"></a>19728       $uniqid = md5(time() .  $this-&gt;buffer);
<a name="l19729"></a>19729       $this-&gt;_out(<span class="stringliteral">&#39;/ID [&lt;&#39;</span>.$uniqid.<span class="stringliteral">&#39;&gt; &lt;&#39;</span>.$uniqid.<span class="stringliteral">&#39;&gt;]&#39;</span>);
<a name="l19730"></a>19730   }
<a name="l19731"></a>19731 
<a name="l19732"></a>19732 
<a name="l19733"></a>19733 <span class="comment">//=========================================</span>
<a name="l19734"></a>19734 <span class="comment">// FROM class PDF_Bookmark</span>
<a name="l19735"></a>19735 
<a name="l19736"></a>19736 function Bookmark($txt,$level=0,$y=0)
<a name="l19737"></a>19737 {
<a name="l19738"></a>19738   $txt = $this-&gt;purify_utf8_text($txt);
<a name="l19739"></a>19739   <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l19740"></a>19740     $txt = $this-&gt;all_entities_to_utf8($txt);
<a name="l19741"></a>19741   }
<a name="l19742"></a>19742   <span class="keywordflow">if</span>($y==-1) {
<a name="l19743"></a>19743     <span class="keywordflow">if</span> (!$this-&gt;ColActive){ $y=$this-&gt;y; }
<a name="l19744"></a>19744     <span class="keywordflow">else</span> { $y = $this-&gt;y0; }  <span class="comment">// If columns are on - mark top of columns</span>
<a name="l19745"></a>19745   }
<a name="l19746"></a>19746   <span class="comment">// else y is used as set, or =0 i.e. top of page</span>
<a name="l19747"></a>19747   <span class="comment">// DIRECTIONALITY RTL</span>
<a name="l19748"></a>19748   <span class="comment">// mPDF 3.0</span>
<a name="l19749"></a>19749   <span class="keywordflow">if</span> ($this-&gt;keep_block_together) {
<a name="l19750"></a>19750     $this-&gt;ktBMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;y&#39;</span>=&gt;$y,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page);
<a name="l19751"></a>19751   }
<a name="l19752"></a>19752   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l19753"></a>19753     $this-&gt;tbrot_BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;y&#39;</span>=&gt;$y,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page);
<a name="l19754"></a>19754   }
<a name="l19755"></a>19755   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l19756"></a>19756     $this-&gt;kwt_BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;y&#39;</span>=&gt;$y,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page);
<a name="l19757"></a>19757   }
<a name="l19758"></a>19758   <span class="keywordflow">else</span> {
<a name="l19759"></a>19759     $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;y&#39;</span>=&gt;$y,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page);
<a name="l19760"></a>19760   }
<a name="l19761"></a>19761 }
<a name="l19762"></a>19762 
<a name="l19763"></a>19763 
<a name="l19764"></a>19764 function _putbookmarks()
<a name="l19765"></a>19765 {
<a name="l19766"></a>19766   $nb=count($this-&gt;BMoutlines);
<a name="l19767"></a>19767   <span class="keywordflow">if</span>($nb==0)
<a name="l19768"></a>19768     <span class="keywordflow">return</span>;
<a name="l19769"></a>19769   $lru=array();
<a name="l19770"></a>19770   $level=0;
<a name="l19771"></a>19771   <span class="keywordflow">foreach</span>($this-&gt;BMoutlines as $i=&gt;$o)
<a name="l19772"></a>19772   {
<a name="l19773"></a>19773     <span class="keywordflow">if</span>($o[<span class="charliteral">&#39;l&#39;</span>]&gt;0)
<a name="l19774"></a>19774     {
<a name="l19775"></a>19775       $parent=$lru[$o[<span class="charliteral">&#39;l&#39;</span>]-1];
<a name="l19776"></a>19776       <span class="comment">//Set parent and last pointers</span>
<a name="l19777"></a>19777       $this-&gt;BMoutlines[$i][<span class="stringliteral">&#39;parent&#39;</span>]=$parent;
<a name="l19778"></a>19778       $this-&gt;BMoutlines[$parent][<span class="stringliteral">&#39;last&#39;</span>]=$i;
<a name="l19779"></a>19779       <span class="keywordflow">if</span>($o[<span class="charliteral">&#39;l&#39;</span>]&gt;$level)
<a name="l19780"></a>19780       {
<a name="l19781"></a>19781         <span class="comment">//Level increasing: set first pointer</span>
<a name="l19782"></a>19782         $this-&gt;BMoutlines[$parent][<span class="stringliteral">&#39;first&#39;</span>]=$i;
<a name="l19783"></a>19783       }
<a name="l19784"></a>19784     }
<a name="l19785"></a>19785     <span class="keywordflow">else</span>
<a name="l19786"></a>19786       $this-&gt;BMoutlines[$i][<span class="stringliteral">&#39;parent&#39;</span>]=$nb;
<a name="l19787"></a>19787     <span class="keywordflow">if</span>($o[<span class="charliteral">&#39;l&#39;</span>]&lt;=$level and $i&gt;0)
<a name="l19788"></a>19788     {
<a name="l19789"></a>19789       <span class="comment">//Set prev and next pointers</span>
<a name="l19790"></a>19790       $prev=$lru[$o[<span class="charliteral">&#39;l&#39;</span>]];
<a name="l19791"></a>19791       $this-&gt;BMoutlines[$prev][<span class="stringliteral">&#39;next&#39;</span>]=$i;
<a name="l19792"></a>19792       $this-&gt;BMoutlines[$i][<span class="stringliteral">&#39;prev&#39;</span>]=$prev;
<a name="l19793"></a>19793     }
<a name="l19794"></a>19794     $lru[$o[<span class="charliteral">&#39;l&#39;</span>]]=$i;
<a name="l19795"></a>19795     $level=$o[<span class="charliteral">&#39;l&#39;</span>];
<a name="l19796"></a>19796   }
<a name="l19797"></a>19797   <span class="comment">//Outline items</span>
<a name="l19798"></a>19798   $n=$this-&gt;n+1;
<a name="l19799"></a>19799   <span class="keywordflow">foreach</span>($this-&gt;BMoutlines as $i=&gt;$o)
<a name="l19800"></a>19800   {
<a name="l19801"></a>19801     $this-&gt;_newobj();
<a name="l19802"></a>19802     $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Title &#39;</span>.$this-&gt;_UTF16BEtextstring($o[<span class="charliteral">&#39;t&#39;</span>]));
<a name="l19803"></a>19803     $this-&gt;_out(<span class="stringliteral">&#39;/Parent &#39;</span>.($n+$o[<span class="stringliteral">&#39;parent&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19804"></a>19804     <span class="keywordflow">if</span>(isset($o[<span class="stringliteral">&#39;prev&#39;</span>]))
<a name="l19805"></a>19805       $this-&gt;_out(<span class="stringliteral">&#39;/Prev &#39;</span>.($n+$o[<span class="stringliteral">&#39;prev&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19806"></a>19806     <span class="keywordflow">if</span>(isset($o[<span class="stringliteral">&#39;next&#39;</span>]))
<a name="l19807"></a>19807       $this-&gt;_out(<span class="stringliteral">&#39;/Next &#39;</span>.($n+$o[<span class="stringliteral">&#39;next&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19808"></a>19808     <span class="keywordflow">if</span>(isset($o[<span class="stringliteral">&#39;first&#39;</span>]))
<a name="l19809"></a>19809       $this-&gt;_out(<span class="stringliteral">&#39;/First &#39;</span>.($n+$o[<span class="stringliteral">&#39;first&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19810"></a>19810     <span class="keywordflow">if</span>(isset($o[<span class="stringliteral">&#39;last&#39;</span>]))
<a name="l19811"></a>19811       $this-&gt;_out(<span class="stringliteral">&#39;/Last &#39;</span>.($n+$o[<span class="stringliteral">&#39;last&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19812"></a>19812 
<a name="l19813"></a>19813 
<a name="l19814"></a>19814     <span class="comment">// mPDF 3.0 Page orientation</span>
<a name="l19815"></a>19815     <span class="keywordflow">if</span> (isset($this-&gt;pageDim[$o[<span class="charliteral">&#39;p&#39;</span>]][<span class="charliteral">&#39;h&#39;</span>])) { $h=$this-&gt;pageDim[$o[<span class="charliteral">&#39;p&#39;</span>]][<span class="charliteral">&#39;h&#39;</span>]; }
<a name="l19816"></a>19816     <span class="keywordflow">else</span> { $h = 0; }
<a name="l19817"></a>19817 
<a name="l19818"></a>19818     $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/Dest [%d 0 R /XYZ 0 %.3f null]&#39;</span>,1+2*($o[<span class="charliteral">&#39;p&#39;</span>]),($h-$o[<span class="charliteral">&#39;y&#39;</span>])*$this-&gt;k));
<a name="l19819"></a>19819 
<a name="l19820"></a>19820     $this-&gt;_out(<span class="stringliteral">&#39;/Count 0&gt;&gt;&#39;</span>);
<a name="l19821"></a>19821     $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l19822"></a>19822   }
<a name="l19823"></a>19823   <span class="comment">//Outline root</span>
<a name="l19824"></a>19824   $this-&gt;_newobj();
<a name="l19825"></a>19825   $this-&gt;OutlineRoot=$this-&gt;n;
<a name="l19826"></a>19826   $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /BMoutlines /First &#39;</span>.$n.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l19827"></a>19827   $this-&gt;_out(<span class="stringliteral">&#39;/Last &#39;</span>.($n+$lru[0]).<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l19828"></a>19828   $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l19829"></a>19829 }
<a name="l19830"></a>19830   <span class="comment">// *BOOKMARKS*</span>
<a name="l19831"></a>19831 
<a name="l19832"></a>19832 
<a name="l19833"></a>19833 
<a name="l19834"></a>19834 <span class="comment">//======================================================</span>
<a name="l19835"></a>19835 
<a name="l19836"></a>19836 
<a name="l19837"></a>19837 <span class="comment">// DEPRACATED but included for backwards compatability</span>
<a name="l19838"></a>19838 function startPageNums() {
<a name="l19839"></a>19839 }
<a name="l19840"></a>19840 
<a name="l19841"></a>19841 <span class="comment">//======================================================</span>
<a name="l19842"></a>19842 <span class="comment">// ToC TABLE OF CONTENTS</span>
<a name="l19843"></a>19843 
<a name="l19844"></a>19844 <span class="comment">// Initiate, and Mark a place for the Table of Contents to be inserted</span>
<a name="l19845"></a>19845 function TOC($tocfont=<span class="stringliteral">&#39;&#39;</span>, $tocfontsize=8, $tocindent=5, $resetpagenum=<span class="stringliteral">&#39;&#39;</span>, $pagenumstyle=<span class="stringliteral">&#39;&#39;</span>, $suppress=<span class="stringliteral">&#39;&#39;</span>, $toc_orientation=<span class="stringliteral">&#39;&#39;</span>, $TOCusePaging=<span class="keyword">true</span>, $TOCuseLinking=<span class="keyword">false</span>, $toc_id=0) {
<a name="l19846"></a>19846     <span class="keywordflow">if</span> (strtoupper($toc_id)==<span class="stringliteral">&#39;ALL&#39;</span>) { $toc_id = <span class="stringliteral">&#39;_mpdf_all&#39;</span>; }
<a name="l19847"></a>19847     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$toc_id) { $toc_id = 0; }
<a name="l19848"></a>19848     <span class="keywordflow">else</span> { $toc_id = strtolower($toc_id); }
<a name="l19849"></a>19849     <span class="comment">// To use odd and even pages</span>
<a name="l19850"></a>19850     <span class="comment">// Cannot start table of contents on an even page</span>
<a name="l19851"></a>19851     <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==0)) { <span class="comment">// EVEN</span>
<a name="l19852"></a>19852       $this-&gt;AddPage($this-&gt;CurOrientation,<span class="stringliteral">&#39;&#39;</span>,$resetpagenum, $pagenumstyle, $suppress);
<a name="l19853"></a>19853     }
<a name="l19854"></a>19854     <span class="keywordflow">else</span> { 
<a name="l19855"></a>19855       $this-&gt;PageNumSubstitutions[] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;$this-&gt;page, <span class="stringliteral">&#39;reset&#39;</span>=&gt; $resetpagenum, <span class="stringliteral">&#39;type&#39;</span>=&gt;$pagenumstyle, <span class="stringliteral">&#39;suppress&#39;</span>=&gt;$suppress);
<a name="l19856"></a>19856     }
<a name="l19857"></a>19857     <span class="keywordflow">if</span> (!$tocfont) { $tocfont = $this-&gt;default_font; }
<a name="l19858"></a>19858     <span class="keywordflow">if</span> (!$tocfontsize) { $tocfontsize = $this-&gt;default_font_size; }
<a name="l19859"></a>19859     <span class="keywordflow">if</span> ($toc_id) {
<a name="l19860"></a>19860       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCmark&#39;</span>] = $this-&gt;page; 
<a name="l19861"></a>19861       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfont&#39;</span>] = $tocfont;
<a name="l19862"></a>19862       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfontsize&#39;</span>] = $tocfontsize;
<a name="l19863"></a>19863       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCindent&#39;</span>] = $tocindent;
<a name="l19864"></a>19864       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCorientation&#39;</span>] = $toc_orientation;
<a name="l19865"></a>19865       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCuseLinking&#39;</span>] = $TOCuseLinking;
<a name="l19866"></a>19866       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCusePaging&#39;</span>] = $TOCusePaging;
<a name="l19867"></a>19867     }
<a name="l19868"></a>19868     <span class="keywordflow">else</span> {
<a name="l19869"></a>19869       $this-&gt;TOCmark = $this-&gt;page; 
<a name="l19870"></a>19870       $this-&gt;TOCfont = $tocfont;
<a name="l19871"></a>19871       $this-&gt;TOCfontsize = $tocfontsize;
<a name="l19872"></a>19872       $this-&gt;TOCindent = $tocindent;
<a name="l19873"></a>19873       $this-&gt;TOCorientation = $toc_orientation;
<a name="l19874"></a>19874       $this-&gt;TOCuseLinking = $TOCuseLinking;
<a name="l19875"></a>19875       $this-&gt;TOCusePaging = $TOCusePaging;
<a name="l19876"></a>19876     }
<a name="l19877"></a>19877 }
<a name="l19878"></a>19878 
<a name="l19879"></a>19879 <span class="comment">// mPDF 4.2 Added $pagesel</span>
<a name="l19880"></a>19880 <span class="comment">// mPDF 4.2.024</span>
<a name="l19881"></a>19881 function TOCpagebreak($tocfont=<span class="stringliteral">&#39;&#39;</span>, $tocfontsize=<span class="stringliteral">&#39;&#39;</span>, $tocindent=<span class="stringliteral">&#39;&#39;</span>, $TOCusePaging=<span class="keyword">true</span>, $TOCuseLinking=<span class="stringliteral">&#39;&#39;</span>, $toc_orientation=<span class="stringliteral">&#39;&#39;</span>, $toc_mgl=<span class="stringliteral">&#39;&#39;</span>,$toc_mgr=<span class="stringliteral">&#39;&#39;</span>,$toc_mgt=<span class="stringliteral">&#39;&#39;</span>,$toc_mgb=<span class="stringliteral">&#39;&#39;</span>,$toc_mgh=<span class="stringliteral">&#39;&#39;</span>,$toc_mgf=<span class="stringliteral">&#39;&#39;</span>,$toc_ohname=<span class="stringliteral">&#39;&#39;</span>,$toc_ehname=<span class="stringliteral">&#39;&#39;</span>,$toc_ofname=<span class="stringliteral">&#39;&#39;</span>,$toc_efname=<span class="stringliteral">&#39;&#39;</span>,$toc_ohvalue=0,$toc_ehvalue=0,$toc_ofvalue=0,$toc_efvalue=0, $toc_preHTML=<span class="stringliteral">&#39;&#39;</span>, $toc_postHTML=<span class="stringliteral">&#39;&#39;</span>, $toc_bookmarkText=<span class="stringliteral">&#39;&#39;</span>, $resetpagenum=<span class="stringliteral">&#39;&#39;</span>, $pagenumstyle=<span class="stringliteral">&#39;&#39;</span>, $suppress=<span class="stringliteral">&#39;&#39;</span>, $orientation=<span class="stringliteral">&#39;&#39;</span>, $mgl=<span class="stringliteral">&#39;&#39;</span>,$mgr=<span class="stringliteral">&#39;&#39;</span>,$mgt=<span class="stringliteral">&#39;&#39;</span>,$mgb=<span class="stringliteral">&#39;&#39;</span>,$mgh=<span class="stringliteral">&#39;&#39;</span>,$mgf=<span class="stringliteral">&#39;&#39;</span>,$ohname=<span class="stringliteral">&#39;&#39;</span>,$ehname=<span class="stringliteral">&#39;&#39;</span>,$ofname=<span class="stringliteral">&#39;&#39;</span>,$efname=<span class="stringliteral">&#39;&#39;</span>,$ohvalue=0,$ehvalue=0,$ofvalue=0,$efvalue=0, $toc_id=0, $pagesel=<span class="stringliteral">&#39;&#39;</span>, $toc_pagesel=<span class="stringliteral">&#39;&#39;</span>, $sheetsize=<span class="stringliteral">&#39;&#39;</span>, $toc_sheetsize=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l19882"></a>19882     <span class="keywordflow">if</span> (strtoupper($toc_id)==<span class="stringliteral">&#39;ALL&#39;</span>) { $toc_id = <span class="stringliteral">&#39;_mpdf_all&#39;</span>; }
<a name="l19883"></a>19883     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$toc_id) { $toc_id = 0; }
<a name="l19884"></a>19884     <span class="keywordflow">else</span> { $toc_id = strtolower($toc_id); }
<a name="l19885"></a>19885 
<a name="l19886"></a>19886     <span class="comment">// mPDF 3.0</span>
<a name="l19887"></a>19887     <span class="comment">//Start a new page</span>
<a name="l19888"></a>19888     <span class="keywordflow">if</span>($this-&gt;state==0) $this-&gt;AddPage();
<a name="l19889"></a>19889     <span class="keywordflow">if</span> ($this-&gt;y == $this-&gt;tMargin &amp;&amp; (!$this-&gt;mirrorMargins ||($this-&gt;mirrorMargins &amp;&amp; $this-&gt;page % 2==1))) {
<a name="l19890"></a>19890       <span class="comment">// Don&#39;t add a page</span>
<a name="l19891"></a>19891       <span class="keywordflow">if</span> ($this-&gt;page==1 &amp;&amp; count($this-&gt;PageNumSubstitutions)==0) { 
<a name="l19892"></a>19892         <span class="keywordflow">if</span> (!$suppress) { $suppress = <span class="stringliteral">&#39;off&#39;</span>; }
<a name="l19893"></a>19893         <span class="keywordflow">if</span> (!$resetpagenum) { $resetpagenum= 1; }
<a name="l19894"></a>19894         $this-&gt;PageNumSubstitutions[] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;1, <span class="stringliteral">&#39;reset&#39;</span>=&gt; $resetpagenum, <span class="stringliteral">&#39;type&#39;</span>=&gt;$pagenumstyle, <span class="stringliteral">&#39;suppress&#39;</span>=&gt; $suppress);
<a name="l19895"></a>19895       }
<a name="l19896"></a>19896     }
<a name="l19897"></a>19897     <span class="keywordflow">else</span> {
<a name="l19898"></a>19898       $this-&gt;AddPage($orientation,<span class="stringliteral">&#39;NEXT-ODD&#39;</span>, $resetpagenum, $pagenumstyle, $suppress,$mgl,$mgr,$mgt,$mgb,$mgh,$mgf,$ohname,$ehname,$ofname,$efname,$ohvalue,$ehvalue,$ofvalue,$efvalue,$pagesel,$sheetsize);   <span class="comment">// mPDF 4.2.024</span>
<a name="l19899"></a>19899     }
<a name="l19900"></a>19900 
<a name="l19901"></a>19901     <span class="keywordflow">if</span> (!$tocfont) { $tocfont = $this-&gt;default_font; }
<a name="l19902"></a>19902     <span class="keywordflow">if</span> (!$tocfontsize) { $tocfontsize = $this-&gt;default_font_size; }
<a name="l19903"></a>19903     <span class="keywordflow">if</span> (!$tocindent &amp;&amp; $tocindent !== 0) { $tocindent = 5; }
<a name="l19904"></a>19904     <span class="comment">// mPDF 3.0</span>
<a name="l19905"></a>19905     <span class="keywordflow">if</span> ($TOCusePaging === <span class="keyword">false</span> || strtolower($TOCusePaging) == <span class="stringliteral">&quot;off&quot;</span> || $TOCusePaging === 0 || $TOCusePaging === <span class="stringliteral">&quot;0&quot;</span> || $TOCusePaging === <span class="stringliteral">&quot;&quot;</span>) { $TOCusePaging = <span class="keyword">false</span>; }
<a name="l19906"></a>19906     <span class="keywordflow">else</span> { $TOCusePaging = <span class="keyword">true</span>; }
<a name="l19907"></a>19907     <span class="keywordflow">if</span> (!$TOCuseLinking) { $TOCuseLinking = <span class="keyword">false</span>; }
<a name="l19908"></a>19908     <span class="keywordflow">if</span> ($toc_id) {
<a name="l19909"></a>19909       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCmark&#39;</span>] = $this-&gt;page; 
<a name="l19910"></a>19910       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfont&#39;</span>] = $tocfont;
<a name="l19911"></a>19911       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfontsize&#39;</span>] = $tocfontsize;
<a name="l19912"></a>19912       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCindent&#39;</span>] = $tocindent;
<a name="l19913"></a>19913       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCorientation&#39;</span>] = $toc_orientation;
<a name="l19914"></a>19914       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCuseLinking&#39;</span>] = $TOCuseLinking;
<a name="l19915"></a>19915       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCusePaging&#39;</span>] = $TOCusePaging;
<a name="l19916"></a>19916 
<a name="l19917"></a>19917       <span class="keywordflow">if</span> ($toc_preHTML) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpreHTML&#39;</span>] = $toc_preHTML; }
<a name="l19918"></a>19918       <span class="keywordflow">if</span> ($toc_postHTML) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpostHTML&#39;</span>] = $toc_postHTML; }
<a name="l19919"></a>19919       <span class="keywordflow">if</span> ($toc_bookmarkText) { $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCbookmarkText&#39;</span>] = $toc_bookmarkText; }  <span class="comment">// *BOOKMARKS*</span>
<a name="l19920"></a>19920 
<a name="l19921"></a>19921       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_left&#39;</span>] = $toc_mgl;
<a name="l19922"></a>19922       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_right&#39;</span>] = $toc_mgr;
<a name="l19923"></a>19923       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_top&#39;</span>] = $toc_mgt;
<a name="l19924"></a>19924       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_bottom&#39;</span>] = $toc_mgb;
<a name="l19925"></a>19925       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_header&#39;</span>] = $toc_mgh;
<a name="l19926"></a>19926       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_footer&#39;</span>] = $toc_mgf;
<a name="l19927"></a>19927       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_name&#39;</span>] = $toc_ohname;
<a name="l19928"></a>19928       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_name&#39;</span>] = $toc_ehname;
<a name="l19929"></a>19929       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_name&#39;</span>] = $toc_ofname;
<a name="l19930"></a>19930       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_name&#39;</span>] = $toc_efname;
<a name="l19931"></a>19931       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_value&#39;</span>] = $toc_ohvalue;
<a name="l19932"></a>19932       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_value&#39;</span>] = $toc_ehvalue;
<a name="l19933"></a>19933       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_value&#39;</span>] = $toc_ofvalue;
<a name="l19934"></a>19934       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_value&#39;</span>] = $toc_efvalue;
<a name="l19935"></a>19935       <span class="comment">// mPDF 4.2.024</span>
<a name="l19936"></a>19936       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_page_selector&#39;</span>] = $toc_pagesel;
<a name="l19937"></a>19937       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCsheetsize&#39;</span>] = $toc_sheetsize;
<a name="l19938"></a>19938     }
<a name="l19939"></a>19939     <span class="keywordflow">else</span> {
<a name="l19940"></a>19940       $this-&gt;TOCmark = $this-&gt;page; 
<a name="l19941"></a>19941       $this-&gt;TOCfont = $tocfont;
<a name="l19942"></a>19942       $this-&gt;TOCfontsize = $tocfontsize;
<a name="l19943"></a>19943       $this-&gt;TOCindent = $tocindent;
<a name="l19944"></a>19944       $this-&gt;TOCorientation = $toc_orientation;
<a name="l19945"></a>19945       $this-&gt;TOCuseLinking = $TOCuseLinking;
<a name="l19946"></a>19946       $this-&gt;TOCusePaging = $TOCusePaging;
<a name="l19947"></a>19947 
<a name="l19948"></a>19948       <span class="keywordflow">if</span> ($toc_preHTML) { $this-&gt;TOCpreHTML = $toc_preHTML; }
<a name="l19949"></a>19949       <span class="keywordflow">if</span> ($toc_postHTML) { $this-&gt;TOCpostHTML = $toc_postHTML; }
<a name="l19950"></a>19950       <span class="keywordflow">if</span> ($toc_bookmarkText) { $this-&gt;TOCbookmarkText = $toc_bookmarkText; }  <span class="comment">// *BOOKMARKS*</span>
<a name="l19951"></a>19951 
<a name="l19952"></a>19952       $this-&gt;TOC_margin_left = $toc_mgl;
<a name="l19953"></a>19953       $this-&gt;TOC_margin_right = $toc_mgr;
<a name="l19954"></a>19954       $this-&gt;TOC_margin_top = $toc_mgt;
<a name="l19955"></a>19955       $this-&gt;TOC_margin_bottom = $toc_mgb;
<a name="l19956"></a>19956       $this-&gt;TOC_margin_header = $toc_mgh;
<a name="l19957"></a>19957       $this-&gt;TOC_margin_footer = $toc_mgf;
<a name="l19958"></a>19958       $this-&gt;TOC_odd_header_name = $toc_ohname;
<a name="l19959"></a>19959       $this-&gt;TOC_even_header_name = $toc_ehname;
<a name="l19960"></a>19960       $this-&gt;TOC_odd_footer_name = $toc_ofname;
<a name="l19961"></a>19961       $this-&gt;TOC_even_footer_name = $toc_efname;
<a name="l19962"></a>19962       $this-&gt;TOC_odd_header_value = $toc_ohvalue;
<a name="l19963"></a>19963       $this-&gt;TOC_even_header_value = $toc_ehvalue;
<a name="l19964"></a>19964       $this-&gt;TOC_odd_footer_value = $toc_ofvalue;
<a name="l19965"></a>19965       $this-&gt;TOC_even_footer_value = $toc_efvalue;
<a name="l19966"></a>19966       <span class="comment">// mPDF 4.2.024</span>
<a name="l19967"></a>19967       $this-&gt;TOC_page_selector = $toc_pagesel;
<a name="l19968"></a>19968       $this-&gt;TOCsheetsize = $toc_sheetsize;
<a name="l19969"></a>19969     }
<a name="l19970"></a>19970 }
<a name="l19971"></a>19971 
<a name="l19972"></a>19972 function TOC_Entry($txt, $level=0, $toc_id=0) {
<a name="l19973"></a>19973     $txt = $this-&gt;purify_utf8_text($txt);
<a name="l19974"></a>19974     <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l19975"></a>19975       $txt = $this-&gt;all_entities_to_utf8($txt);
<a name="l19976"></a>19976     }
<a name="l19977"></a>19977     <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $txt = mb_convert_encoding($txt,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l19978"></a>19978       <span class="keywordflow">if</span> ($this-&gt;ColActive) { $ily = $this-&gt;y0; } <span class="keywordflow">else</span> { $ily = $this-&gt;y; } <span class="comment">// use top of columns</span>
<a name="l19979"></a>19979     $linkn = $this-&gt;AddLink(); 
<a name="l19980"></a>19980     $this-&gt;SetLink($linkn,$ily,$this-&gt;page);
<a name="l19981"></a>19981     <span class="keywordflow">if</span> (strtoupper($toc_id)==<span class="stringliteral">&#39;ALL&#39;</span>) { $toc_id = <span class="stringliteral">&#39;_mpdf_all&#39;</span>; }
<a name="l19982"></a>19982     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$toc_id) { $toc_id = 0; }
<a name="l19983"></a>19983     <span class="keywordflow">else</span> { $toc_id = strtolower($toc_id); }
<a name="l19984"></a>19984     <span class="keywordflow">if</span> ($this-&gt;keep_block_together) {
<a name="l19985"></a>19985       $this-&gt;_kttoc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page, <span class="stringliteral">&#39;link&#39;</span>=&gt;$linkn, <span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$toc_id);
<a name="l19986"></a>19986     }
<a name="l19987"></a>19987     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l19988"></a>19988       $this-&gt;tbrot_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page, <span class="stringliteral">&#39;link&#39;</span>=&gt;$linkn, <span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$toc_id);
<a name="l19989"></a>19989     }
<a name="l19990"></a>19990     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l19991"></a>19991       $this-&gt;kwt_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page, <span class="stringliteral">&#39;link&#39;</span>=&gt;$linkn, <span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$toc_id);
<a name="l19992"></a>19992     }
<a name="l19993"></a>19993     <span class="keywordflow">else</span> {
<a name="l19994"></a>19994       $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;$level,<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page, <span class="stringliteral">&#39;link&#39;</span>=&gt;$linkn, <span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$toc_id);
<a name="l19995"></a>19995     }
<a name="l19996"></a>19996 }
<a name="l19997"></a>19997 
<a name="l19998"></a>19998 function insertTOC() {
<a name="l19999"></a>19999   $notocs = 0;
<a name="l20000"></a>20000   <span class="keywordflow">if</span> ($this-&gt;TOCmark) { $notocs = 1; }
<a name="l20001"></a>20001   $notocs += count($this-&gt;m_TOC);
<a name="l20002"></a>20002 
<a name="l20003"></a>20003   <span class="keywordflow">if</span> ($notocs==0) { <span class="keywordflow">return</span>; }
<a name="l20004"></a>20004 
<a name="l20005"></a>20005   <span class="keywordflow">if</span> (count($this-&gt;m_TOC)) { reset($this-&gt;m_TOC); }
<a name="l20006"></a>20006   $added_toc_pages = 0;
<a name="l20007"></a>20007 
<a name="l20008"></a>20008   <span class="keywordflow">if</span> (($this-&gt;mirrorMargins) &amp;&amp; (($this-&gt;page)%2==1)) { <span class="comment">// ODD</span>
<a name="l20009"></a>20009     $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l20010"></a>20010     $extrapage = <span class="keyword">true</span>;
<a name="l20011"></a>20011   }
<a name="l20012"></a>20012   <span class="keywordflow">else</span> { $extrapage = <span class="keyword">false</span>; }
<a name="l20013"></a>20013 
<a name="l20014"></a>20014   <span class="keywordflow">for</span> ($toci = 0; $toci&lt;$notocs; $toci++) {
<a name="l20015"></a>20015     <span class="keywordflow">if</span> ($toci==0 &amp;&amp; $this-&gt;TOCmark) {
<a name="l20016"></a>20016       $toc_id = 0;
<a name="l20017"></a>20017       $toc_page = $this-&gt;TOCmark; 
<a name="l20018"></a>20018       $tocfont = $this-&gt;TOCfont;
<a name="l20019"></a>20019       $tocfontsize = $this-&gt;TOCfontsize;
<a name="l20020"></a>20020       $tocindent = $this-&gt;TOCindent;
<a name="l20021"></a>20021       $toc_orientation = $this-&gt;TOCorientation;
<a name="l20022"></a>20022       $TOCuseLinking = $this-&gt;TOCuseLinking;
<a name="l20023"></a>20023       $TOCusePaging = $this-&gt;TOCusePaging;
<a name="l20024"></a>20024       $toc_preHTML = $this-&gt;TOCpreHTML;
<a name="l20025"></a>20025       $toc_postHTML = $this-&gt;TOCpostHTML;
<a name="l20026"></a>20026       $toc_bookmarkText = $this-&gt;TOCbookmarkText; <span class="comment">// *BOOKMARKS*</span>
<a name="l20027"></a>20027       $toc_mgl = $this-&gt;TOC_margin_left;
<a name="l20028"></a>20028       $toc_mgr = $this-&gt;TOC_margin_right;
<a name="l20029"></a>20029       $toc_mgt = $this-&gt;TOC_margin_top;
<a name="l20030"></a>20030       $toc_mgb = $this-&gt;TOC_margin_bottom;
<a name="l20031"></a>20031       $toc_mgh = $this-&gt;TOC_margin_header;
<a name="l20032"></a>20032       $toc_mgf = $this-&gt;TOC_margin_footer;
<a name="l20033"></a>20033       $toc_ohname = $this-&gt;TOC_odd_header_name;
<a name="l20034"></a>20034       $toc_ehname = $this-&gt;TOC_even_header_name;
<a name="l20035"></a>20035       $toc_ofname = $this-&gt;TOC_odd_footer_name;
<a name="l20036"></a>20036       $toc_efname = $this-&gt;TOC_even_footer_name;
<a name="l20037"></a>20037       $toc_ohvalue = $this-&gt;TOC_odd_header_value;
<a name="l20038"></a>20038       $toc_ehvalue = $this-&gt;TOC_even_header_value;
<a name="l20039"></a>20039       $toc_ofvalue = $this-&gt;TOC_odd_footer_value;
<a name="l20040"></a>20040       $toc_efvalue = $this-&gt;TOC_even_footer_value;
<a name="l20041"></a>20041       <span class="comment">// mPDF 4.2</span>
<a name="l20042"></a>20042       $toc_page_selector = $this-&gt;TOC_page_selector;
<a name="l20043"></a>20043       $toc_sheet_size = $this-&gt;TOCsheetsize;  <span class="comment">// mPDF 4.2.024</span>
<a name="l20044"></a>20044     }
<a name="l20045"></a>20045     <span class="keywordflow">else</span> {
<a name="l20046"></a>20046       $arr = current($this-&gt;m_TOC);
<a name="l20047"></a>20047 
<a name="l20048"></a>20048       $toc_id = key($this-&gt;m_TOC);
<a name="l20049"></a>20049       $toc_page = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCmark&#39;</span>];
<a name="l20050"></a>20050       $tocfont = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfont&#39;</span>];
<a name="l20051"></a>20051       $tocfontsize = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCfontsize&#39;</span>];
<a name="l20052"></a>20052       $tocindent = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCindent&#39;</span>];
<a name="l20053"></a>20053       $toc_orientation = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCorientation&#39;</span>];
<a name="l20054"></a>20054       $TOCuseLinking = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCuseLinking&#39;</span>];
<a name="l20055"></a>20055       $TOCusePaging = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCusePaging&#39;</span>];
<a name="l20056"></a>20056       <span class="keywordflow">if</span> (isset($this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpreHTML&#39;</span>])) { $toc_preHTML = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpreHTML&#39;</span>]; }
<a name="l20057"></a>20057       <span class="keywordflow">else</span> { $toc_preHTML = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20058"></a>20058       <span class="keywordflow">if</span> (isset($this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpostHTML&#39;</span>])) { $toc_postHTML = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCpostHTML&#39;</span>]; }
<a name="l20059"></a>20059       <span class="keywordflow">else</span> { $toc_postHTML = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20060"></a>20060       <span class="keywordflow">if</span> (isset($this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCbookmarkText&#39;</span>])) { $toc_bookmarkText = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCbookmarkText&#39;</span>]; }  <span class="comment">// *BOOKMARKS*</span>
<a name="l20061"></a>20061       <span class="keywordflow">else</span> { $toc_bookmarkText = <span class="stringliteral">&#39;&#39;</span>; }  <span class="comment">// *BOOKMARKS*</span>
<a name="l20062"></a>20062       $toc_mgl = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_left&#39;</span>];
<a name="l20063"></a>20063       $toc_mgr = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_right&#39;</span>];
<a name="l20064"></a>20064       $toc_mgt = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_top&#39;</span>];
<a name="l20065"></a>20065       $toc_mgb = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_bottom&#39;</span>];
<a name="l20066"></a>20066       $toc_mgh = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_header&#39;</span>];
<a name="l20067"></a>20067       $toc_mgf = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_margin_footer&#39;</span>];
<a name="l20068"></a>20068       $toc_ohname = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_name&#39;</span>];
<a name="l20069"></a>20069       $toc_ehname = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_name&#39;</span>];
<a name="l20070"></a>20070       $toc_ofname = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_name&#39;</span>];
<a name="l20071"></a>20071       $toc_efname = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_name&#39;</span>];
<a name="l20072"></a>20072       $toc_ohvalue = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_header_value&#39;</span>];
<a name="l20073"></a>20073       $toc_ehvalue = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_header_value&#39;</span>];
<a name="l20074"></a>20074       $toc_ofvalue = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_odd_footer_value&#39;</span>];
<a name="l20075"></a>20075       $toc_efvalue = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_even_footer_value&#39;</span>];
<a name="l20076"></a>20076       <span class="comment">// mPDF 4.2</span>
<a name="l20077"></a>20077       $toc_page_selector = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOC_page_selector&#39;</span>];
<a name="l20078"></a>20078       $toc_sheet_size = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCsheetsize&#39;</span>];  <span class="comment">// mPDF 4.2.024</span>
<a name="l20079"></a>20079       next($this-&gt;m_TOC);
<a name="l20080"></a>20080     }
<a name="l20081"></a>20081     <span class="keywordflow">if</span> ($this-&gt;TOCheader) { $this-&gt;SetHeader($this-&gt;TOCheader); }
<a name="l20082"></a>20082     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;TOCheader !== <span class="keyword">false</span>) { $this-&gt;SetHeader(); }
<a name="l20083"></a>20083 
<a name="l20084"></a>20084     <span class="comment">// mPDF 3.0</span>
<a name="l20085"></a>20085     <span class="keywordflow">if</span> (!$tocindent &amp;&amp; $tocindent !== 0) { $tocindent = 5; }
<a name="l20086"></a>20086     <span class="keywordflow">if</span> (!$toc_orientation) { $toc_orientation= $this-&gt;DefOrientation; }
<a name="l20087"></a>20087     <span class="comment">// mPDF 3.0</span>
<a name="l20088"></a>20088     <span class="comment">// mPDF 4.2</span>
<a name="l20089"></a>20089     $this-&gt;AddPage($toc_orientation, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&quot;on&quot;</span>, $toc_mgl, $toc_mgr, $toc_mgt, $toc_mgb, $toc_mgh, $toc_mgf, $toc_ohname, $toc_ehname, $toc_ofname, $toc_efname, $toc_ohvalue, $toc_ehvalue, $toc_ofvalue, $toc_efvalue, $toc_page_selector, $toc_sheet_size ); <span class="comment">// mPDF 4.2.024</span>
<a name="l20090"></a>20090 
<a name="l20091"></a>20091     <span class="keywordflow">if</span> ($this-&gt;TOCfooter) { $this-&gt;SetFooter($this-&gt;TOCfooter); }
<a name="l20092"></a>20092     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;TOCfooter !== <span class="keyword">false</span>) { $this-&gt;SetFooter(); }
<a name="l20093"></a>20093 
<a name="l20094"></a>20094     $tocstart=count($this-&gt;pages);
<a name="l20095"></a>20095     <span class="keywordflow">if</span> ($toc_preHTML) { $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($toc_preHTML); }
<a name="l20096"></a>20096 
<a name="l20097"></a>20097     <span class="keywordflow">foreach</span>($this-&gt;_toc as $t) {
<a name="l20098"></a>20098      <span class="keywordflow">if</span> ($t[<span class="stringliteral">&#39;toc_id&#39;</span>]===<span class="stringliteral">&#39;_mpdf_all&#39;</span> || $t[<span class="stringliteral">&#39;toc_id&#39;</span>]===$toc_id ) {
<a name="l20099"></a>20099        <span class="comment">// mPDF 3.0</span>
<a name="l20100"></a>20100        $tpgno = $this-&gt;docPageNum($t[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l20101"></a>20101        $lineheightcorr = 2-$t[<span class="charliteral">&#39;l&#39;</span>];
<a name="l20102"></a>20102        <span class="comment">//Offset</span>
<a name="l20103"></a>20103        $level=$t[<span class="charliteral">&#39;l&#39;</span>];
<a name="l20104"></a>20104 
<a name="l20105"></a>20105        <span class="keywordflow">if</span> ($TOCuseLinking) { $tlink = $t[<span class="stringliteral">&#39;link&#39;</span>]; }
<a name="l20106"></a>20106        <span class="keywordflow">else</span>  { $tlink = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20107"></a>20107 
<a name="l20108"></a>20108 
<a name="l20109"></a>20109       <span class="comment">// Text</span>
<a name="l20110"></a>20110       $weight=<span class="stringliteral">&#39;&#39;</span>;
<a name="l20111"></a>20111       <span class="keywordflow">if</span>($level==0)
<a name="l20112"></a>20112         $weight=<span class="charliteral">&#39;B&#39;</span>;
<a name="l20113"></a>20113       $str=$t[<span class="charliteral">&#39;t&#39;</span>];
<a name="l20114"></a>20114       <span class="comment">// mPDF 4.0</span>
<a name="l20115"></a>20115       $fullstr = $str;
<a name="l20116"></a>20116       $this-&gt;SetFont($tocfont,$weight,$tocfontsize,<span class="keyword">true</span>,<span class="keyword">true</span>);
<a name="l20117"></a>20117       <span class="keywordflow">if</span>($level&gt;0 &amp;&amp; $tocindent) { $this-&gt;Cell($level*$tocindent,$this-&gt;FontSize+$lineheightcorr); }
<a name="l20118"></a>20118 
<a name="l20119"></a>20119       <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l20120"></a>20120 
<a name="l20121"></a>20121       $PageCellSize=$this-&gt;GetStringWidth($tpgno )+2;
<a name="l20122"></a>20122       $strsize=$this-&gt;GetStringWidth($str);
<a name="l20123"></a>20123 
<a name="l20124"></a>20124       <span class="comment">// mPDF 3.0 Cut to only one line</span>
<a name="l20125"></a>20125       $cw = count(explode(<span class="charliteral">&#39; &#39;</span>,$str));
<a name="l20126"></a>20126       <span class="keywordflow">while</span> (($strsize + $this-&gt;GetStringWidth(str_repeat(<span class="charliteral">&#39;.&#39;</span>,5))+4+ $PageCellSize + ($level*$tocindent)) &gt; $this-&gt;pgwidth &amp;&amp; $cw&gt;1) {
<a name="l20127"></a>20127         $str = implode(<span class="charliteral">&#39; &#39;</span>,explode(<span class="charliteral">&#39; &#39;</span>,$str,-1));
<a name="l20128"></a>20128         $strsize=$this-&gt;GetStringWidth($str);
<a name="l20129"></a>20129         $cw = count(explode(<span class="charliteral">&#39; &#39;</span>,$str));
<a name="l20130"></a>20130       }
<a name="l20131"></a>20131       $sl = strlen($str);
<a name="l20132"></a>20132       <span class="comment">// mPDF 4.0</span>
<a name="l20133"></a>20133       $rem = substr($fullstr, ($sl+1));
<a name="l20134"></a>20134 
<a name="l20135"></a>20135       <span class="keywordflow">if</span> ($TOCusePaging) {
<a name="l20136"></a>20136         <span class="comment">// Text</span>
<a name="l20137"></a>20137         $this-&gt;Cell($strsize+2,$this-&gt;FontSize+$lineheightcorr,$str,0,0,<span class="stringliteral">&#39;&#39;</span>,0,$tlink);
<a name="l20138"></a>20138 
<a name="l20139"></a>20139         <span class="comment">//Filling dots</span>
<a name="l20140"></a>20140         $this-&gt;SetFont($tocfont,<span class="stringliteral">&#39;&#39;</span>,$tocfontsize);
<a name="l20141"></a>20141         $w=$this-&gt;w-$this-&gt;lMargin-$this-&gt;rMargin-$PageCellSize-($level*$tocindent)-($strsize+2);
<a name="l20142"></a>20142         $nb=intval($w/$this-&gt;GetStringWidth(<span class="charliteral">&#39;.&#39;</span>));
<a name="l20143"></a>20143         <span class="keywordflow">if</span> ($nb&gt;0) { $dots=str_repeat(<span class="charliteral">&#39;.&#39;</span>,$nb); }
<a name="l20144"></a>20144         <span class="keywordflow">else</span> { $this-&gt;y += $this-&gt;lineheight; $dots=str_repeat(<span class="charliteral">&#39;.&#39;</span>,5); }  <span class="comment">// ..... 5 dots?</span>
<a name="l20145"></a>20145         $this-&gt;Cell($w,$this-&gt;FontSize+$lineheightcorr,$dots,0,0,<span class="charliteral">&#39;R&#39;</span>);
<a name="l20146"></a>20146 
<a name="l20147"></a>20147         <span class="comment">//Page number</span>
<a name="l20148"></a>20148         $this-&gt;Cell($PageCellSize,$this-&gt;FontSize+$lineheightcorr,$tpgno ,0,1,<span class="charliteral">&#39;R&#39;</span>,0,$tlink);
<a name="l20149"></a>20149       }
<a name="l20150"></a>20150       <span class="keywordflow">else</span> {
<a name="l20151"></a>20151         <span class="comment">// Text only</span>
<a name="l20152"></a>20152         $this-&gt;Cell($strsize+2,$this-&gt;FontSize+$lineheightcorr,$str,0,1,<span class="stringliteral">&#39;&#39;</span>,0,$tlink); <span class="comment">// forces new line</span>
<a name="l20153"></a>20153       }
<a name="l20154"></a>20154       <span class="comment">// mPDF 3.0</span>
<a name="l20155"></a>20155       <span class="keywordflow">if</span> ($rem) {
<a name="l20156"></a>20156         $this-&gt;x +=  5 + $PageCellSize + ($level*$tocindent);
<a name="l20157"></a>20157         <span class="comment">// mPDF 4.0 Added true last parameter</span>
<a name="l20158"></a>20158         $this-&gt;MultiCell($strsize+2,$this-&gt;FontSize+$lineheightcorr,$rem,0,L,0,$tlink,<span class="stringliteral">&#39;ltr&#39;</span>,<span class="keyword">true</span>); 
<a name="l20159"></a>20159       }
<a name="l20160"></a>20160      } 
<a name="l20161"></a>20161     }
<a name="l20162"></a>20162 
<a name="l20163"></a>20163     <span class="keywordflow">if</span> ($toc_postHTML) { $this-&gt;<a class="code" href="classmPDF.html#a399521a4ab38536f9d26e46aa6ab3020" title="HTML parser ///.">WriteHTML</a>($toc_postHTML); }
<a name="l20164"></a>20164     $this-&gt;AddPage($toc_orientation,<span class="charliteral">&#39;E&#39;</span>);
<a name="l20165"></a>20165 
<a name="l20166"></a>20166     $n_toc = $this-&gt;page - $tocstart + 1;
<a name="l20167"></a>20167 
<a name="l20168"></a>20168     <span class="keywordflow">if</span> ($toci==0 &amp;&amp; $this-&gt;TOCmark) {
<a name="l20169"></a>20169       $this-&gt;TOC_start = $tocstart ;
<a name="l20170"></a>20170       $this-&gt;TOC_end = $this-&gt;page;
<a name="l20171"></a>20171       $this-&gt;TOC_npages = $n_toc;
<a name="l20172"></a>20172     }
<a name="l20173"></a>20173     <span class="keywordflow">else</span> {
<a name="l20174"></a>20174       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;start&#39;</span>] = $tocstart ;
<a name="l20175"></a>20175       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;end&#39;</span>] = $this-&gt;page;
<a name="l20176"></a>20176       $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;npages&#39;</span>] = $n_toc;
<a name="l20177"></a>20177     }
<a name="l20178"></a>20178   }
<a name="l20179"></a>20179 
<a name="l20180"></a>20180   <span class="comment">// mPDF 4.2.023</span>
<a name="l20181"></a>20181   $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l20182"></a>20182   $bby = $this-&gt;h;
<a name="l20183"></a>20183   $bbw = $this-&gt;w;
<a name="l20184"></a>20184   $bbh = $this-&gt;h;
<a name="l20185"></a>20185   <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundColor) {
<a name="l20186"></a>20186     $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f rg&#39;</span>,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;R&#39;</span>]/255,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;G&#39;</span>]/255,$this-&gt;bodyBackgroundColor[<span class="charliteral">&#39;B&#39;</span>]/255).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20187"></a>20187     $s .= sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f re f&#39;</span>,0,$bby*$this-&gt;k,$bbw*$this-&gt;k,-$bbh*$this-&gt;k).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20188"></a>20188   }
<a name="l20189"></a>20189   <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage) {
<a name="l20190"></a>20190       <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;image_id&#39;</span>]) { <span class="comment">// Background pattern</span>
<a name="l20191"></a>20191       $n = count($this-&gt;patterns)+1;
<a name="l20192"></a>20192       <span class="comment">// mPDF 4.3.015</span>
<a name="l20193"></a>20193       list($orig_w, $orig_h, $x_repeat, $y_repeat) = $this-&gt;_resizeBackgroundImage($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;orig_w&#39;</span>], $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;orig_h&#39;</span>], $bbw, $bbh, $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;resize&#39;</span>],$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;x_repeat&#39;</span>],$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;y_repeat&#39;</span>]);
<a name="l20194"></a>20194       <span class="comment">// mPDF 3.1 $bbx = 0, &#39;y&#39;=&gt;0</span>
<a name="l20195"></a>20195       $this-&gt;patterns[$n] = array(<span class="charliteral">&#39;x&#39;</span>=&gt;0, <span class="charliteral">&#39;y&#39;</span>=&gt;0, <span class="charliteral">&#39;w&#39;</span>=&gt;$bbw, <span class="charliteral">&#39;h&#39;</span>=&gt;$bbh, <span class="stringliteral">&#39;pgh&#39;</span>=&gt;$this-&gt;h, <span class="stringliteral">&#39;image_id&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;image_id&#39;</span>], <span class="stringliteral">&#39;orig_w&#39;</span>=&gt;$orig_w, <span class="stringliteral">&#39;orig_h&#39;</span>=&gt;$orig_h, <span class="stringliteral">&#39;x_pos&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;x_pos&#39;</span>], <span class="stringliteral">&#39;y_pos&#39;</span>=&gt;$this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;y_pos&#39;</span>], <span class="stringliteral">&#39;x_repeat&#39;</span>=&gt;$x_repeat, <span class="stringliteral">&#39;y_repeat&#39;</span>=&gt;$y_repeat); <span class="comment">// mPDF 4.3.015</span>
<a name="l20196"></a>20196       <span class="comment">// mPDF 4.3.017</span>
<a name="l20197"></a>20197       <span class="keywordflow">if</span> ($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>]&gt;0 &amp;&amp; $this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>]&lt;1) { $opac = $this-&gt;SetAlpha($this-&gt;bodyBackgroundImage[<span class="stringliteral">&#39;opacity&#39;</span>],<span class="stringliteral">&#39;Normal&#39;</span>,<span class="keyword">true</span>); }
<a name="l20198"></a>20198       <span class="keywordflow">else</span> { $opac = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20199"></a>20199       $s .= sprintf(<span class="stringliteral">&#39;q /Pattern cs /P%d scn %s %.3f %.3f %.3f %.3f re f Q&#39;</span>, $n, $opac, 0,$bby*$this-&gt;k,$bbw*$this-&gt;k,-$bbh*$this-&gt;k) .<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20200"></a>20200       }
<a name="l20201"></a>20201   }
<a name="l20202"></a>20202 
<a name="l20203"></a>20203   $s .= $this-&gt;PrintPageBackgrounds();
<a name="l20204"></a>20204   $this-&gt;pages[$this-&gt;page] = preg_replace(<span class="stringliteral">&#39;/(___BACKGROUND___PATTERNS&#39;</span>.date(<span class="stringliteral">&#39;jY&#39;</span>).<span class="stringliteral">&#39;)/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>.$s.<span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;\\1&#39;</span>, $this-&gt;pages[$this-&gt;page]);
<a name="l20205"></a>20205   $this-&gt;pageBackgrounds = array();
<a name="l20206"></a>20206 
<a name="l20207"></a>20207   <span class="comment">//Page footer</span>
<a name="l20208"></a>20208   $this-&gt;InFooter=<span class="keyword">true</span>;
<a name="l20209"></a>20209   $this-&gt;Footer();
<a name="l20210"></a>20210   $this-&gt;InFooter=<span class="keyword">false</span>;
<a name="l20211"></a>20211 
<a name="l20212"></a>20212   <span class="comment">// 2nd time through to move pages etc.</span>
<a name="l20213"></a>20213   $added_toc_pages = 0;
<a name="l20214"></a>20214   <span class="keywordflow">if</span> (count($this-&gt;m_TOC)) { reset($this-&gt;m_TOC); }
<a name="l20215"></a>20215 
<a name="l20216"></a>20216   <span class="keywordflow">for</span> ($toci = 0; $toci&lt;$notocs; $toci++) {
<a name="l20217"></a>20217     <span class="keywordflow">if</span> ($toci==0 &amp;&amp; $this-&gt;TOCmark) {
<a name="l20218"></a>20218       $toc_id = 0;
<a name="l20219"></a>20219       $toc_page = $this-&gt;TOCmark + $added_toc_pages; 
<a name="l20220"></a>20220       $toc_orientation = $this-&gt;TOCorientation;
<a name="l20221"></a>20221       $TOCuseLinking = $this-&gt;TOCuseLinking;
<a name="l20222"></a>20222       $TOCusePaging = $this-&gt;TOCusePaging;
<a name="l20223"></a>20223       $toc_bookmarkText = $this-&gt;TOCbookmarkText; <span class="comment">// *BOOKMARKS*</span>
<a name="l20224"></a>20224 
<a name="l20225"></a>20225       $tocstart = $this-&gt;TOC_start ;
<a name="l20226"></a>20226       $tocend = $n = $this-&gt;TOC_end;
<a name="l20227"></a>20227       $n_toc = $this-&gt;TOC_npages;
<a name="l20228"></a>20228     }
<a name="l20229"></a>20229     <span class="keywordflow">else</span> {
<a name="l20230"></a>20230       $arr = current($this-&gt;m_TOC);
<a name="l20231"></a>20231 
<a name="l20232"></a>20232       $toc_id = key($this-&gt;m_TOC);
<a name="l20233"></a>20233       $toc_page = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCmark&#39;</span>] + $added_toc_pages;
<a name="l20234"></a>20234       $toc_orientation = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCorientation&#39;</span>];
<a name="l20235"></a>20235       $TOCuseLinking = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCuseLinking&#39;</span>];
<a name="l20236"></a>20236       $TOCusePaging = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCusePaging&#39;</span>];
<a name="l20237"></a>20237       $toc_bookmarkText = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;TOCbookmarkText&#39;</span>]; <span class="comment">// *BOOKMARKS*</span>
<a name="l20238"></a>20238 
<a name="l20239"></a>20239       $tocstart = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;start&#39;</span>] ;
<a name="l20240"></a>20240       $tocend = $n = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;end&#39;</span>] ;
<a name="l20241"></a>20241       $n_toc = $this-&gt;m_TOC[$toc_id][<span class="stringliteral">&#39;npages&#39;</span>] ;
<a name="l20242"></a>20242 
<a name="l20243"></a>20243       next($this-&gt;m_TOC);
<a name="l20244"></a>20244     }
<a name="l20245"></a>20245 
<a name="l20246"></a>20246     <span class="comment">// Now pages moved</span>
<a name="l20247"></a>20247     $added_toc_pages += $n_toc;
<a name="l20248"></a>20248 
<a name="l20249"></a>20249     $this-&gt;MovePages($toc_page, $tocstart, $tocend) ;
<a name="l20250"></a>20250     <span class="comment">// mPDF 4.2.020</span>
<a name="l20251"></a>20251     $this-&gt;pgsIns[$toc_page] = $tocend - $tocstart + 1;
<a name="l20252"></a>20252 
<a name="l20253"></a>20253     <span class="comment">// Insert new Bookmark for Bookmark</span>
<a name="l20254"></a>20254     <span class="keywordflow">if</span> ($toc_bookmarkText) {
<a name="l20255"></a>20255       $insert = -1;
<a name="l20256"></a>20256       <span class="keywordflow">foreach</span>($this-&gt;BMoutlines as $i=&gt;$o) {
<a name="l20257"></a>20257         <span class="keywordflow">if</span>($o[<span class="charliteral">&#39;p&#39;</span>]&lt;$toc_page) { <span class="comment">// i.e. before point of insertion</span>
<a name="l20258"></a>20258           $insert = $i;
<a name="l20259"></a>20259         }
<a name="l20260"></a>20260       }
<a name="l20261"></a>20261       $txt = $this-&gt;purify_utf8_text($toc_bookmarkText);
<a name="l20262"></a>20262       <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l20263"></a>20263         $txt = $this-&gt;all_entities_to_utf8($txt);
<a name="l20264"></a>20264       }
<a name="l20265"></a>20265       $newBookmark[0] = array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;l&#39;</span>=&gt;0,<span class="charliteral">&#39;y&#39;</span>=&gt;0,<span class="charliteral">&#39;p&#39;</span>=&gt;$toc_page ); 
<a name="l20266"></a>20266       array_splice($this-&gt;BMoutlines,($insert+1),0,$newBookmark);
<a name="l20267"></a>20267     }
<a name="l20268"></a>20268 
<a name="l20269"></a>20269   }
<a name="l20270"></a>20270 
<a name="l20271"></a>20271   <span class="comment">// Delete empty page that was inserted earlier</span>
<a name="l20272"></a>20272   <span class="keywordflow">if</span> ($extrapage) {
<a name="l20273"></a>20273     unset($this-&gt;pages[count($this-&gt;pages)]);
<a name="l20274"></a>20274     $this-&gt;page--;  <span class="comment">// Reset page pointer</span>
<a name="l20275"></a>20275   }
<a name="l20276"></a>20276 
<a name="l20277"></a>20277 }
<a name="l20278"></a>20278 
<a name="l20279"></a>20279 <span class="comment">//======================================================</span>
<a name="l20280"></a>20280 function MovePages($target_page, $start_page, $end_page=-1) {
<a name="l20281"></a>20281   <span class="comment">// move a page/pages EARLIER in the document</span>
<a name="l20282"></a>20282     <span class="keywordflow">if</span> ($end_page&lt;1) { $end_page = $start_page; }
<a name="l20283"></a>20283     $n_toc = $end_page - $start_page + 1;
<a name="l20284"></a>20284 
<a name="l20285"></a>20285     <span class="comment">// Set/Update PageNumSubstitutions changes before moving anything</span>
<a name="l20286"></a>20286     <span class="keywordflow">if</span> (count($this-&gt;PageNumSubstitutions)) {
<a name="l20287"></a>20287       $tp_present = <span class="keyword">false</span>;
<a name="l20288"></a>20288       $sp_present = <span class="keyword">false</span>;
<a name="l20289"></a>20289       $ep_present = <span class="keyword">false</span>;
<a name="l20290"></a>20290       <span class="keywordflow">foreach</span>($this-&gt;PageNumSubstitutions AS $k=&gt;$v) {
<a name="l20291"></a>20291         <span class="keywordflow">if</span> ($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]==$target_page) {
<a name="l20292"></a>20292         $tp_present = <span class="keyword">true</span>;
<a name="l20293"></a>20293         <span class="keywordflow">if</span> ($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]!=<span class="stringliteral">&#39;on&#39;</span> &amp;&amp; $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]!=1) { 
<a name="l20294"></a>20294           $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]=<span class="stringliteral">&#39;off&#39;</span>;
<a name="l20295"></a>20295         }
<a name="l20296"></a>20296         }
<a name="l20297"></a>20297         <span class="keywordflow">if</span> ($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]==$start_page) {
<a name="l20298"></a>20298         $sp_present = <span class="keyword">true</span>;
<a name="l20299"></a>20299         <span class="keywordflow">if</span> ($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]!=<span class="stringliteral">&#39;on&#39;</span> &amp;&amp; $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]!=1) { 
<a name="l20300"></a>20300           $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]=<span class="stringliteral">&#39;off&#39;</span>;
<a name="l20301"></a>20301         }
<a name="l20302"></a>20302         }
<a name="l20303"></a>20303         <span class="keywordflow">if</span> ($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]==($end_page+1)) {
<a name="l20304"></a>20304         $ep_present = <span class="keyword">true</span>;
<a name="l20305"></a>20305         <span class="keywordflow">if</span> ($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]!=<span class="stringliteral">&#39;on&#39;</span> &amp;&amp; $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]!=1) { 
<a name="l20306"></a>20306           $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;suppress&#39;</span>]=<span class="stringliteral">&#39;off&#39;</span>;
<a name="l20307"></a>20307         }
<a name="l20308"></a>20308         }
<a name="l20309"></a>20309       }
<a name="l20310"></a>20310 
<a name="l20311"></a>20311       <span class="keywordflow">if</span> (!$tp_present) { 
<a name="l20312"></a>20312         list($tp_type, $tp_suppress, $tp_reset) = $this-&gt;docPageSettings($target_page);
<a name="l20313"></a>20313       }
<a name="l20314"></a>20314       <span class="keywordflow">if</span> (!$sp_present) { 
<a name="l20315"></a>20315         list($sp_type, $sp_suppress, $sp_reset) = $this-&gt;docPageSettings($start_page);
<a name="l20316"></a>20316       }
<a name="l20317"></a>20317       <span class="keywordflow">if</span> (!$ep_present) { 
<a name="l20318"></a>20318         list($ep_type, $ep_suppress, $ep_reset) = $this-&gt;docPageSettings($start_page-1);
<a name="l20319"></a>20319       }
<a name="l20320"></a>20320 
<a name="l20321"></a>20321     }
<a name="l20322"></a>20322 
<a name="l20323"></a>20323     $last = array();
<a name="l20324"></a>20324     <span class="comment">//store pages</span>
<a name="l20325"></a>20325     <span class="keywordflow">for</span>($i = $start_page;$i &lt;= $end_page ;$i++)
<a name="l20326"></a>20326       $last[]=$this-&gt;pages[$i];
<a name="l20327"></a>20327     <span class="comment">//move pages</span>
<a name="l20328"></a>20328     <span class="keywordflow">for</span>($i=$start_page - 1;$i&gt;=($target_page);$i--) { <span class="comment">// mPDF 3.0</span>
<a name="l20329"></a>20329       $this-&gt;pages[$i+$n_toc]=$this-&gt;pages[$i];
<a name="l20330"></a>20330     }
<a name="l20331"></a>20331     <span class="comment">//Put toc pages at insert point</span>
<a name="l20332"></a>20332     <span class="keywordflow">for</span>($i = 0;$i &lt; $n_toc;$i++) {
<a name="l20333"></a>20333       $this-&gt;pages[$target_page + $i]=$last[$i];
<a name="l20334"></a>20334     }
<a name="l20335"></a>20335 
<a name="l20336"></a>20336     <span class="comment">// Update Bookmarks</span>
<a name="l20337"></a>20337     <span class="keywordflow">foreach</span>($this-&gt;BMoutlines as $i=&gt;$o) {
<a name="l20338"></a>20338       <span class="keywordflow">if</span>($o[<span class="charliteral">&#39;p&#39;</span>]&gt;=$target_page) {
<a name="l20339"></a>20339         $this-&gt;BMoutlines[$i][<span class="charliteral">&#39;p&#39;</span>] += $n_toc;
<a name="l20340"></a>20340       }
<a name="l20341"></a>20341     }
<a name="l20342"></a>20342 
<a name="l20343"></a>20343     <span class="comment">// Update Page Links</span>
<a name="l20344"></a>20344     <span class="keywordflow">if</span> (count($this-&gt;PageLinks)) {
<a name="l20345"></a>20345        $newarr = array();
<a name="l20346"></a>20346        <span class="keywordflow">foreach</span>($this-&gt;PageLinks as $i=&gt;$o) {
<a name="l20347"></a>20347       <span class="comment">// mPDF 3.0 - Change links to page numbers (@) used by Index</span>
<a name="l20348"></a>20348       <span class="keywordflow">foreach</span>($this-&gt;PageLinks[$i] as $key =&gt; $pl) {
<a name="l20349"></a>20349         <span class="keywordflow">if</span> (strpos($pl[4],<span class="charliteral">&#39;@&#39;</span>)===0) {
<a name="l20350"></a>20350           $p=substr($pl[4],1);
<a name="l20351"></a>20351           <span class="keywordflow">if</span>($p&gt;=$start_page &amp;&amp; $p&lt;=$end_page) {
<a name="l20352"></a>20352             $this-&gt;PageLinks[$i][$key][4] = <span class="charliteral">&#39;@&#39;</span>.($p + ($target_page - $start_page));
<a name="l20353"></a>20353           }
<a name="l20354"></a>20354           <span class="keywordflow">else</span> <span class="keywordflow">if</span>($p&gt;=$target_page &amp;&amp; $p&lt;$start_page) {
<a name="l20355"></a>20355             $this-&gt;PageLinks[$i][$key][4] = <span class="charliteral">&#39;@&#39;</span>.($p+$n_toc);
<a name="l20356"></a>20356           }
<a name="l20357"></a>20357         }
<a name="l20358"></a>20358       }
<a name="l20359"></a>20359       <span class="keywordflow">if</span>($i&gt;=$start_page &amp;&amp; $i&lt;=$end_page) {
<a name="l20360"></a>20360         $newarr[($i + ($target_page - $start_page))] = $this-&gt;PageLinks[$i];
<a name="l20361"></a>20361       }
<a name="l20362"></a>20362       <span class="keywordflow">else</span> <span class="keywordflow">if</span>($i&gt;=$target_page &amp;&amp; $i&lt;$start_page) {
<a name="l20363"></a>20363         $newarr[($i + $n_toc)] = $this-&gt;PageLinks[$i];
<a name="l20364"></a>20364       }
<a name="l20365"></a>20365       <span class="keywordflow">else</span> {
<a name="l20366"></a>20366         $newarr[$i] = $this-&gt;PageLinks[$i];
<a name="l20367"></a>20367       }
<a name="l20368"></a>20368        }
<a name="l20369"></a>20369        $this-&gt;PageLinks = $newarr;
<a name="l20370"></a>20370     }
<a name="l20371"></a>20371 
<a name="l20372"></a>20372     <span class="comment">// OrientationChanges</span>
<a name="l20373"></a>20373     <span class="keywordflow">if</span> (count($this-&gt;OrientationChanges)) {
<a name="l20374"></a>20374       $newarr = array();
<a name="l20375"></a>20375       <span class="keywordflow">foreach</span>($this-&gt;OrientationChanges AS $p=&gt;$v) {
<a name="l20376"></a>20376         <span class="keywordflow">if</span>($p&gt;=$start_page &amp;&amp; $p&lt;=$end_page) { $newarr[($p + ($target_page - $start_page))] = $this-&gt;OrientationChanges[$p]; }
<a name="l20377"></a>20377         <span class="keywordflow">else</span> <span class="keywordflow">if</span>($p&gt;=$target_page &amp;&amp; $p&lt;$start_page) { $newarr[$p+$n_toc] = $this-&gt;OrientationChanges[$p]; }
<a name="l20378"></a>20378         <span class="keywordflow">else</span> { $newarr[$p] = $this-&gt;OrientationChanges[$p]; }
<a name="l20379"></a>20379       }
<a name="l20380"></a>20380       ksort($newarr);
<a name="l20381"></a>20381       $this-&gt;OrientationChanges = $newarr;
<a name="l20382"></a>20382     }
<a name="l20383"></a>20383 
<a name="l20384"></a>20384     <span class="comment">// Page Dimensions</span>
<a name="l20385"></a>20385     <span class="keywordflow">if</span> (count($this-&gt;pageDim)) {
<a name="l20386"></a>20386       $newarr = array();
<a name="l20387"></a>20387       <span class="keywordflow">foreach</span>($this-&gt;pageDim AS $p=&gt;$v) {
<a name="l20388"></a>20388         <span class="keywordflow">if</span>($p&gt;=$start_page &amp;&amp; $p&lt;=$end_page) { $newarr[($p + ($target_page - $start_page))] = $this-&gt;pageDim[$p]; }
<a name="l20389"></a>20389         <span class="keywordflow">else</span> <span class="keywordflow">if</span>($p&gt;=$target_page &amp;&amp; $p&lt;$start_page) { $newarr[$p+$n_toc] = $this-&gt;pageDim[$p]; }
<a name="l20390"></a>20390         <span class="keywordflow">else</span> { $newarr[$p] = $this-&gt;pageDim[$p]; }
<a name="l20391"></a>20391       }
<a name="l20392"></a>20392       ksort($newarr);
<a name="l20393"></a>20393       $this-&gt;pageDim = $newarr;
<a name="l20394"></a>20394     }
<a name="l20395"></a>20395 
<a name="l20396"></a>20396     <span class="comment">// mPDF 4.0</span>
<a name="l20397"></a>20397     <span class="comment">// HTML Headers &amp; Footers</span>
<a name="l20398"></a>20398     <span class="keywordflow">if</span> (count($this-&gt;saveHTMLHeader)) {
<a name="l20399"></a>20399       $newarr = array();
<a name="l20400"></a>20400       <span class="keywordflow">foreach</span>($this-&gt;saveHTMLHeader AS $p=&gt;$v) {
<a name="l20401"></a>20401         <span class="keywordflow">if</span>($p&gt;=$start_page &amp;&amp; $p&lt;=$end_page) { $newarr[($p + ($target_page - $start_page))] = $this-&gt;saveHTMLHeader[$p]; }
<a name="l20402"></a>20402         <span class="keywordflow">else</span> <span class="keywordflow">if</span>($p&gt;=$target_page &amp;&amp; $p&lt;$start_page) { $newarr[$p+$n_toc] = $this-&gt;saveHTMLHeader[$p]; }
<a name="l20403"></a>20403         <span class="keywordflow">else</span> { $newarr[$p] = $this-&gt;saveHTMLHeader[$p]; }
<a name="l20404"></a>20404       }
<a name="l20405"></a>20405       ksort($newarr);
<a name="l20406"></a>20406       $this-&gt;saveHTMLHeader = $newarr;
<a name="l20407"></a>20407     }
<a name="l20408"></a>20408     <span class="keywordflow">if</span> (count($this-&gt;saveHTMLFooter)) {
<a name="l20409"></a>20409       $newarr = array();
<a name="l20410"></a>20410       <span class="keywordflow">foreach</span>($this-&gt;saveHTMLFooter AS $p=&gt;$v) {
<a name="l20411"></a>20411         <span class="keywordflow">if</span>($p&gt;=$start_page &amp;&amp; $p&lt;=$end_page) { $newarr[($p + ($target_page - $start_page))] = $this-&gt;saveHTMLFooter[$p]; }
<a name="l20412"></a>20412         <span class="keywordflow">else</span> <span class="keywordflow">if</span>($p&gt;=$target_page &amp;&amp; $p&lt;$start_page) { $newarr[$p+$n_toc] = $this-&gt;saveHTMLFooter[$p]; }
<a name="l20413"></a>20413         <span class="keywordflow">else</span> { $newarr[$p] = $this-&gt;saveHTMLFooter[$p]; }
<a name="l20414"></a>20414       }
<a name="l20415"></a>20415       ksort($newarr);
<a name="l20416"></a>20416       $this-&gt;saveHTMLFooter = $newarr;
<a name="l20417"></a>20417     }
<a name="l20418"></a>20418 
<a name="l20419"></a>20419     <span class="comment">// Update Internal Links</span>
<a name="l20420"></a>20420     <span class="keywordflow">if</span> (count($this-&gt;internallink)) {
<a name="l20421"></a>20421        <span class="keywordflow">foreach</span>($this-&gt;internallink as $key=&gt;$o) {
<a name="l20422"></a>20422       <span class="keywordflow">if</span>($o[<span class="stringliteral">&#39;PAGE&#39;</span>]&gt;=$start_page &amp;&amp; $o[<span class="stringliteral">&#39;PAGE&#39;</span>]&lt;=$end_page) {
<a name="l20423"></a>20423         $this-&gt;internallink[$key][<span class="stringliteral">&#39;PAGE&#39;</span>] += ($target_page - $start_page);
<a name="l20424"></a>20424       }
<a name="l20425"></a>20425       <span class="keywordflow">else</span> <span class="keywordflow">if</span>($o[<span class="stringliteral">&#39;PAGE&#39;</span>]&gt;=$target_page &amp;&amp; $o[<span class="stringliteral">&#39;PAGE&#39;</span>]&lt;$start_page) {
<a name="l20426"></a>20426         $this-&gt;internallink[$key][<span class="stringliteral">&#39;PAGE&#39;</span>] += $n_toc;
<a name="l20427"></a>20427       }
<a name="l20428"></a>20428        }
<a name="l20429"></a>20429     }
<a name="l20430"></a>20430 
<a name="l20431"></a>20431     <span class="comment">// Update Links</span>
<a name="l20432"></a>20432     <span class="keywordflow">if</span> (count($this-&gt;links)) {
<a name="l20433"></a>20433        <span class="keywordflow">foreach</span>($this-&gt;links as $key=&gt;$o) {
<a name="l20434"></a>20434       <span class="keywordflow">if</span>($o[0]&gt;=$start_page &amp;&amp; $o[0]&lt;=$end_page) {
<a name="l20435"></a>20435         $this-&gt;links[$key][0] += ($target_page - $start_page);
<a name="l20436"></a>20436       }
<a name="l20437"></a>20437       <span class="keywordflow">if</span>($o[0]&gt;=$target_page &amp;&amp; $o[0]&lt;$start_page) {
<a name="l20438"></a>20438         $this-&gt;links[$key][0] += $n_toc;
<a name="l20439"></a>20439       }
<a name="l20440"></a>20440        }
<a name="l20441"></a>20441     }
<a name="l20442"></a>20442 
<a name="l20443"></a>20443 
<a name="l20444"></a>20444     <span class="comment">// Update PageNumSubstitutions</span>
<a name="l20445"></a>20445     <span class="keywordflow">if</span> (count($this-&gt;PageNumSubstitutions)) {
<a name="l20446"></a>20446       $newarr = array();
<a name="l20447"></a>20447       <span class="keywordflow">foreach</span>($this-&gt;PageNumSubstitutions AS $k=&gt;$v) {
<a name="l20448"></a>20448         <span class="keywordflow">if</span>($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]&gt;=$start_page &amp;&amp; $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]&lt;=$end_page) { 
<a name="l20449"></a>20449           $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>] += ($target_page - $start_page); 
<a name="l20450"></a>20450           $newarr[$this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]] = $this-&gt;PageNumSubstitutions[$k]; 
<a name="l20451"></a>20451         }
<a name="l20452"></a>20452         <span class="keywordflow">else</span> <span class="keywordflow">if</span>($this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]&gt;=$target_page &amp;&amp; $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]&lt;$start_page) {
<a name="l20453"></a>20453           $this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>] += $n_toc;
<a name="l20454"></a>20454           $newarr[$this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]] = $this-&gt;PageNumSubstitutions[$k]; 
<a name="l20455"></a>20455         }
<a name="l20456"></a>20456         <span class="keywordflow">else</span> {
<a name="l20457"></a>20457           $newarr[$this-&gt;PageNumSubstitutions[$k][<span class="stringliteral">&#39;from&#39;</span>]] = $this-&gt;PageNumSubstitutions[$k]; 
<a name="l20458"></a>20458         }
<a name="l20459"></a>20459       }
<a name="l20460"></a>20460 
<a name="l20461"></a>20461       <span class="keywordflow">if</span> (!$sp_present) {
<a name="l20462"></a>20462           $newarr[$target_page] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;$target_page, <span class="stringliteral">&#39;suppress&#39;</span>=&gt;$sp_suppress, <span class="stringliteral">&#39;reset&#39;</span>=&gt;$sp_reset, <span class="stringliteral">&#39;type&#39;</span>=&gt;$sp_type); 
<a name="l20463"></a>20463       }
<a name="l20464"></a>20464       <span class="keywordflow">if</span> (!$tp_present) {
<a name="l20465"></a>20465           $newarr[($target_page + $n_toc)] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;($target_page+$n_toc), <span class="stringliteral">&#39;suppress&#39;</span>=&gt;$tp_suppress, <span class="stringliteral">&#39;reset&#39;</span>=&gt;$tp_reset, <span class="stringliteral">&#39;type&#39;</span>=&gt;$tp_type); 
<a name="l20466"></a>20466       }
<a name="l20467"></a>20467       <span class="keywordflow">if</span> (!$ep_present &amp;&amp; $end_page&gt;count($this-&gt;pages)) {
<a name="l20468"></a>20468           $newarr[($end_page+1)] = array(<span class="stringliteral">&#39;from&#39;</span>=&gt;($end_page+1), <span class="stringliteral">&#39;suppress&#39;</span>=&gt;$ep_suppress, <span class="stringliteral">&#39;reset&#39;</span>=&gt;$ep_reset, <span class="stringliteral">&#39;type&#39;</span>=&gt;$ep_type); 
<a name="l20469"></a>20469       }
<a name="l20470"></a>20470       ksort($newarr);
<a name="l20471"></a>20471       $this-&gt;PageNumSubstitutions = array();
<a name="l20472"></a>20472       <span class="keywordflow">foreach</span>($newarr as $v) {
<a name="l20473"></a>20473         $this-&gt;PageNumSubstitutions[] = $v;
<a name="l20474"></a>20474       }
<a name="l20475"></a>20475     }
<a name="l20476"></a>20476 }
<a name="l20477"></a>20477 
<a name="l20478"></a>20478 
<a name="l20479"></a>20479 
<a name="l20480"></a>20480 
<a name="l20481"></a>20481 <span class="comment">//======================================================</span>
<a name="l20482"></a>20482 <span class="comment">// FROM class PDF_Ref == INDEX</span>
<a name="l20483"></a>20483 
<a name="l20484"></a>20484 function <a class="code" href="classReference.html">Reference</a>($txt) {
<a name="l20485"></a>20485   $this-&gt;IndexEntry($txt);
<a name="l20486"></a>20486 }
<a name="l20487"></a>20487 
<a name="l20488"></a>20488 <span class="comment">// mPDF 3.0</span>
<a name="l20489"></a>20489 function IndexEntry($txt, $xref=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l20490"></a>20490   <span class="keywordflow">if</span> ($xref) { 
<a name="l20491"></a>20491     $this-&gt;IndexEntrySee($txt,$xref);
<a name="l20492"></a>20492     <span class="keywordflow">return</span>;
<a name="l20493"></a>20493   }
<a name="l20494"></a>20494   $txt = strip_tags($txt);
<a name="l20495"></a>20495   $txt = $this-&gt;purify_utf8_text($txt);
<a name="l20496"></a>20496   <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l20497"></a>20497     $txt = $this-&gt;all_entities_to_utf8($txt);
<a name="l20498"></a>20498   }
<a name="l20499"></a>20499   <span class="keywordflow">if</span> (!$this-&gt;is_MB) { $txt = mb_convert_encoding($txt,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); }
<a name="l20500"></a>20500 
<a name="l20501"></a>20501   $Present=0;
<a name="l20502"></a>20502   $size=<span class="keyword">sizeof</span>($this-&gt;<a class="code" href="classReference.html">Reference</a>);
<a name="l20503"></a>20503 
<a name="l20504"></a>20504     $txt = str_replace(<span class="charliteral">&#39;:&#39;</span>,<span class="stringliteral">&#39;, &#39;</span>,$txt);
<a name="l20505"></a>20505 
<a name="l20506"></a>20506 
<a name="l20507"></a>20507   <span class="comment">//Search the reference (AND Ref/PageNo) in the array</span>
<a name="l20508"></a>20508   <span class="keywordflow">for</span> ($i=0;$i&lt;$size;$i++){
<a name="l20509"></a>20509     <span class="keywordflow">if</span> ($this-&gt;keep_block_together) {
<a name="l20510"></a>20510       <span class="keywordflow">if</span> (isset($this-&gt;ktReference[$i][<span class="charliteral">&#39;t&#39;</span>]) &amp;&amp; $this-&gt;ktReference[$i][<span class="charliteral">&#39;t&#39;</span>]==$txt){
<a name="l20511"></a>20511         $Present=1;
<a name="l20512"></a>20512         <span class="keywordflow">if</span> (!in_array($this-&gt;page,$this-&gt;ktReference[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20513"></a>20513           $this-&gt;ktReference[$i][<span class="stringliteral">&#39;op&#39;</span>] = $this-&gt;page;
<a name="l20514"></a>20514         }
<a name="l20515"></a>20515       }
<a name="l20516"></a>20516     }
<a name="l20517"></a>20517     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l20518"></a>20518       <span class="keywordflow">if</span> (isset($this-&gt;tbrot_Reference[$i][<span class="charliteral">&#39;t&#39;</span>]) &amp;&amp; $this-&gt;tbrot_Reference[$i][<span class="charliteral">&#39;t&#39;</span>]==$txt){
<a name="l20519"></a>20519         $Present=1;
<a name="l20520"></a>20520         <span class="keywordflow">if</span> (!in_array($this-&gt;page,$this-&gt;tbrot_Reference[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20521"></a>20521           $this-&gt;tbrot_Reference[$i][<span class="stringliteral">&#39;op&#39;</span>] = $this-&gt;page;
<a name="l20522"></a>20522         }
<a name="l20523"></a>20523       }
<a name="l20524"></a>20524     }
<a name="l20525"></a>20525     <span class="comment">// mPDF 3.0</span>
<a name="l20526"></a>20526     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l20527"></a>20527       <span class="keywordflow">if</span> (isset($this-&gt;kwt_Reference[$i][<span class="charliteral">&#39;t&#39;</span>]) &amp;&amp; $this-&gt;kwt_Reference[$i][<span class="charliteral">&#39;t&#39;</span>]==$txt){
<a name="l20528"></a>20528         $Present=1;
<a name="l20529"></a>20529         <span class="keywordflow">if</span> (!in_array($this-&gt;page,$this-&gt;kwt_Reference[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20530"></a>20530           $this-&gt;kwt_Reference[$i][<span class="stringliteral">&#39;op&#39;</span>] = $this-&gt;page;
<a name="l20531"></a>20531         }
<a name="l20532"></a>20532       }
<a name="l20533"></a>20533     }
<a name="l20534"></a>20534     <span class="keywordflow">else</span> {
<a name="l20535"></a>20535       <span class="keywordflow">if</span> (isset($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]) &amp;&amp; $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$txt){
<a name="l20536"></a>20536         $Present=1;
<a name="l20537"></a>20537         <span class="keywordflow">if</span> (!in_array($this-&gt;page,$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20538"></a>20538           $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $this-&gt;page;
<a name="l20539"></a>20539         }
<a name="l20540"></a>20540       }
<a name="l20541"></a>20541     }
<a name="l20542"></a>20542   }
<a name="l20543"></a>20543   <span class="comment">//If not found, add it</span>
<a name="l20544"></a>20544   <span class="keywordflow">if</span> ($Present==0) {
<a name="l20545"></a>20545     <span class="keywordflow">if</span> ($this-&gt;keep_block_together) {
<a name="l20546"></a>20546       $this-&gt;ktReference[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt, <span class="stringliteral">&#39;op&#39;</span>=&gt;$this-&gt;page);
<a name="l20547"></a>20547     }
<a name="l20548"></a>20548     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l20549"></a>20549       $this-&gt;tbrot_Reference[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt, <span class="stringliteral">&#39;op&#39;</span>=&gt;$this-&gt;page);
<a name="l20550"></a>20550     }
<a name="l20551"></a>20551     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;kwt) {
<a name="l20552"></a>20552       $this-&gt;kwt_Reference[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt, <span class="stringliteral">&#39;op&#39;</span>=&gt;$this-&gt;page);
<a name="l20553"></a>20553     }
<a name="l20554"></a>20554     <span class="keywordflow">else</span> {
<a name="l20555"></a>20555       $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txt,<span class="charliteral">&#39;p&#39;</span>=&gt;array($this-&gt;page));
<a name="l20556"></a>20556     }
<a name="l20557"></a>20557   }
<a name="l20558"></a>20558 }
<a name="l20559"></a>20559 
<a name="l20560"></a>20560 <span class="comment">// Added function to add a reference &quot;Elephants. See Chickens&quot;</span>
<a name="l20561"></a>20561 function ReferenceSee($txta,$txtb) {
<a name="l20562"></a>20562   $this-&gt;IndexEntrySee($txta,$txtb);
<a name="l20563"></a>20563 }
<a name="l20564"></a>20564 
<a name="l20565"></a>20565 function IndexEntrySee($txta,$txtb) {
<a name="l20566"></a>20566   $txta = strip_tags($txta);
<a name="l20567"></a>20567   $txtb = strip_tags($txtb);
<a name="l20568"></a>20568   $txta = $this-&gt;purify_utf8_text($txta);
<a name="l20569"></a>20569   $txtb = $this-&gt;purify_utf8_text($txtb);
<a name="l20570"></a>20570   <span class="keywordflow">if</span> ($this-&gt;text_input_as_HTML) {
<a name="l20571"></a>20571     $txta = $this-&gt;all_entities_to_utf8($txta);
<a name="l20572"></a>20572     $txtb = $this-&gt;all_entities_to_utf8($txtb);
<a name="l20573"></a>20573   }
<a name="l20574"></a>20574   <span class="keywordflow">if</span> (!$this-&gt;is_MB) { 
<a name="l20575"></a>20575     $txta = mb_convert_encoding($txta,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); 
<a name="l20576"></a>20576     $txtb = mb_convert_encoding($txtb,$this-&gt;mb_enc,<span class="stringliteral">&#39;UTF-8&#39;</span>); 
<a name="l20577"></a>20577   }
<a name="l20578"></a>20578     $txta = str_replace(<span class="charliteral">&#39;:&#39;</span>,<span class="stringliteral">&#39;, &#39;</span>,$txta);
<a name="l20579"></a>20579     $txtb = str_replace(<span class="charliteral">&#39;:&#39;</span>,<span class="stringliteral">&#39;, &#39;</span>,$txtb);
<a name="l20580"></a>20580   $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$txta.<span class="stringliteral">&#39; - see &#39;</span>.$txtb,<span class="charliteral">&#39;p&#39;</span>=&gt;array());  <span class="comment">// mPDF 3.0</span>
<a name="l20581"></a>20581 }
<a name="l20582"></a>20582 
<a name="l20583"></a>20583 function CreateReference($NbCol=1, $reffontsize=<span class="stringliteral">&#39;&#39;</span>, $linespacing=<span class="stringliteral">&#39;&#39;</span>, $offset=3, $usedivletters=1, $divlettfontsize=<span class="stringliteral">&#39;&#39;</span>, $gap=5, $reffont=<span class="stringliteral">&#39;&#39;</span>,$divlettfont=<span class="stringliteral">&#39;&#39;</span>, $useLinking=<span class="keyword">false</span>) {
<a name="l20584"></a>20584   $this-&gt;CreateIndex($NbCol, $reffontsize, $linespacing, $offset, $usedivletters, $divlettfontsize, $gap, $reffont, $divlettfont, $useLinking);
<a name="l20585"></a>20585 }
<a name="l20586"></a>20586 
<a name="l20587"></a>20587 function CreateIndex($NbCol=1, $reffontsize=<span class="stringliteral">&#39;&#39;</span>, $linespacing=<span class="stringliteral">&#39;&#39;</span>, $offset=3, $usedivletters=1, $divlettfontsize=<span class="stringliteral">&#39;&#39;</span>, $gap=5, $reffont=<span class="stringliteral">&#39;&#39;</span>,$divlettfont=<span class="stringliteral">&#39;&#39;</span>, $useLinking=<span class="keyword">false</span>) {
<a name="l20588"></a>20588   <span class="keywordflow">if</span> (!$reffontsize) { $reffontsize = $this-&gt;default_font_size; }
<a name="l20589"></a>20589   <span class="keywordflow">if</span> (!$divlettfontsize) { $divlettfontsize = ($this-&gt;default_font_size * 1.8); }
<a name="l20590"></a>20590   <span class="keywordflow">if</span> (!$reffont) { $reffont = $this-&gt;default_font; }
<a name="l20591"></a>20591   <span class="keywordflow">if</span> (!$divlettfont) { $divlettfont = $reffont; }
<a name="l20592"></a>20592   <span class="keywordflow">if</span> (!$linespacing) { $linespacing= $this-&gt;default_lineheight_correction; }  <span class="comment">// mPDF 3.0</span>
<a name="l20593"></a>20593   $size=<span class="keyword">sizeof</span>($this-&gt;<a class="code" href="classReference.html">Reference</a>);
<a name="l20594"></a>20594   <span class="keywordflow">if</span> ($size == 0) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l20595"></a>20595 
<a name="l20596"></a>20596 
<a name="l20597"></a>20597   <span class="keywordflow">if</span> ($NbCol&lt;2) { 
<a name="l20598"></a>20598     $NbCol = 1; 
<a name="l20599"></a>20599     $colWidth = $this-&gt;pgwidth;
<a name="l20600"></a>20600   }
<a name="l20601"></a>20601   <span class="keywordflow">else</span> { 
<a name="l20602"></a>20602     $this-&gt;SetColumns($NbCol,<span class="stringliteral">&#39;&#39;</span>,$gap); 
<a name="l20603"></a>20603     $colWidth = $this-&gt;ColWidth;
<a name="l20604"></a>20604   }
<a name="l20605"></a>20605   <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $align = <span class="charliteral">&#39;R&#39;</span>; }
<a name="l20606"></a>20606   <span class="keywordflow">else</span> { $align = <span class="charliteral">&#39;L&#39;</span>; }
<a name="l20607"></a>20607   $lett = <span class="stringliteral">&#39;&#39;</span>;
<a name="l20608"></a>20608   function cmp ($a, $b) {
<a name="l20609"></a>20609       <span class="keywordflow">return</span> strnatcmp(strtolower($a[<span class="charliteral">&#39;t&#39;</span>]), strtolower($b[<span class="charliteral">&#39;t&#39;</span>]));
<a name="l20610"></a>20610   }
<a name="l20611"></a>20611   <span class="comment">//Alphabetic sort of the references</span>
<a name="l20612"></a>20612   usort($this-&gt;<a class="code" href="classReference.html">Reference</a>, <span class="stringliteral">&#39;cmp&#39;</span>);
<a name="l20613"></a>20613   $size=<span class="keyword">sizeof</span>($this-&gt;<a class="code" href="classReference.html">Reference</a>);
<a name="l20614"></a>20614 
<a name="l20615"></a>20615   <span class="comment">// mPDF 3.0 - Prevent break after Dividing letter</span>
<a name="l20616"></a>20616   $divlettjuststarted = <span class="keyword">false</span>;
<a name="l20617"></a>20617 
<a name="l20618"></a>20618   <span class="comment">// mPDF 3.0</span>
<a name="l20619"></a>20619   $this-&gt;OpenTag(<span class="stringliteral">&#39;DIV&#39;</span>,array(<span class="stringliteral">&#39;STYLE&#39;</span>=&gt;<span class="stringliteral">&#39;line-height: &#39;</span>.$linespacing.<span class="stringliteral">&#39;; font-family: &#39;</span>.$reffont.<span class="stringliteral">&#39;; font-size: &#39;</span>.$reffontsize.<span class="stringliteral">&#39;pt; &#39;</span>));
<a name="l20620"></a>20620 
<a name="l20621"></a>20621   <span class="comment">// mPDF 3.0</span>
<a name="l20622"></a>20622   $last_lett = <span class="stringliteral">&#39;&#39;</span>;
<a name="l20623"></a>20623   <span class="keywordflow">for</span> ($i=0;$i&lt;$size;$i++){
<a name="l20624"></a>20624       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]) { 
<a name="l20625"></a>20625       <span class="keywordflow">if</span> ($usedivletters) {
<a name="l20626"></a>20626          <span class="comment">// mPDF 4.0</span>
<a name="l20627"></a>20627          $lett = mb_strtoupper(mb_substr($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>],0,1,$this-&gt;mb_enc ),$this-&gt;mb_enc );
<a name="l20628"></a>20628          <span class="keywordflow">if</span> ($lett != $last_lett) {
<a name="l20629"></a>20629 
<a name="l20630"></a>20630         <span class="comment">// mPDF 3.0 - Prevent break after Dividing letter</span>
<a name="l20631"></a>20631         $divlettjuststarted = <span class="keyword">true</span>;
<a name="l20632"></a>20632 
<a name="l20633"></a>20633         <span class="keywordflow">if</span> ($i&gt;0) { 
<a name="l20634"></a>20634           $this-&gt;OpenTag(<span class="stringliteral">&#39;DIV&#39;</span>,array(<span class="stringliteral">&#39;STYLE&#39;</span>=&gt;<span class="stringliteral">&#39;line-height: &#39;</span>.$linespacing.<span class="stringliteral">&#39;; font-family: &#39;</span>.$divlettfont.<span class="stringliteral">&#39;; font-size: &#39;</span>.$divlettfontsize.<span class="stringliteral">&#39;pt; font-weight: bold; page-break-after: avoid; margin-top: 0.5em; margin-collapse: collapse; &#39;</span>));
<a name="l20635"></a>20635         }
<a name="l20636"></a>20636         <span class="keywordflow">else</span> { 
<a name="l20637"></a>20637           $this-&gt;OpenTag(<span class="stringliteral">&#39;DIV&#39;</span>,array(<span class="stringliteral">&#39;STYLE&#39;</span>=&gt;<span class="stringliteral">&#39;line-height: &#39;</span>.$linespacing.<span class="stringliteral">&#39;; font-family: &#39;</span>.$divlettfont.<span class="stringliteral">&#39;; font-size: &#39;</span>.$divlettfontsize.<span class="stringliteral">&#39;pt; font-weight: bold; page-break-after: avoid; &#39;</span>));
<a name="l20638"></a>20638         }
<a name="l20639"></a>20639         $this-&gt;textbuffer[] = array($lett,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l20640"></a>20640         $this-&gt;CloseTag(<span class="stringliteral">&#39;DIV&#39;</span>);
<a name="l20641"></a>20641          }
<a name="l20642"></a>20642       }
<a name="l20643"></a>20643 
<a name="l20644"></a>20644       $this-&gt;OpenTag(<span class="stringliteral">&#39;DIV&#39;</span>,array(<span class="stringliteral">&#39;STYLE&#39;</span>=&gt;<span class="stringliteral">&#39;text-indent: -&#39;</span>.$offset.<span class="stringliteral">&#39;mm; line-height: &#39;</span>.$linespacing.<span class="stringliteral">&#39;; font-family: &#39;</span>.$reffont.<span class="stringliteral">&#39;; font-size: &#39;</span>.$reffontsize.<span class="stringliteral">&#39;pt; &#39;</span>));
<a name="l20645"></a>20645 
<a name="l20646"></a>20646 
<a name="l20647"></a>20647       <span class="comment">// mPDF 4.0 Font-specific ligature substitution for Indic fonts</span>
<a name="l20648"></a>20648 
<a name="l20649"></a>20649       $this-&gt;textbuffer[] = array($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>], <span class="stringliteral">&#39;&#39;</span>,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l20650"></a>20650       $ppp = $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>]; <span class="comment">// = array of page numbers to point to</span>
<a name="l20651"></a>20651       <span class="keywordflow">if</span> (count($ppp)) { 
<a name="l20652"></a>20652        sort($ppp);
<a name="l20653"></a>20653        $newarr = array();
<a name="l20654"></a>20654        $range_start = $ppp[0];
<a name="l20655"></a>20655        $range_end = 0;
<a name="l20656"></a>20656 
<a name="l20657"></a>20657        <span class="keywordflow">if</span> ($this-&gt;is_MB) { $spacer = <span class="stringliteral">&quot;\xc2\xa0 &quot;</span>; }
<a name="l20658"></a>20658        <span class="keywordflow">else</span> { $spacer = chr(160).<span class="charliteral">&#39; &#39;</span>; }
<a name="l20659"></a>20659        $this-&gt;textbuffer[] = array($spacer, <span class="stringliteral">&#39;&#39;</span>,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l20660"></a>20660        <span class="keywordflow">if</span> ($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { $sep = <span class="charliteral">&#39;.&#39;</span>; $joiner = <span class="charliteral">&#39;-&#39;</span>; }
<a name="l20661"></a>20661        <span class="keywordflow">else</span> { $sep = <span class="stringliteral">&#39;, &#39;</span>; $joiner = <span class="charliteral">&#39;-&#39;</span>; }
<a name="l20662"></a>20662        <span class="keywordflow">for</span> ($zi=1;$zi&lt;count($ppp);$zi++) {
<a name="l20663"></a>20663         <span class="comment">// RTL - Each number separately </span>
<a name="l20664"></a>20664           <span class="keywordflow">if</span> (($this-&gt;directionality == <span class="stringliteral">&#39;rtl&#39;</span>) || (($this-&gt;directionality == <span class="stringliteral">&#39;ltr&#39;</span>) &amp;&amp; ($this-&gt;biDirectional)))  { 
<a name="l20665"></a>20665         }
<a name="l20666"></a>20666 
<a name="l20667"></a>20667         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($ppp[$zi] == ($ppp[($zi-1)]+1)) {
<a name="l20668"></a>20668         $range_end = $ppp[$zi];
<a name="l20669"></a>20669         }
<a name="l20670"></a>20670         <span class="keywordflow">else</span> {
<a name="l20671"></a>20671         <span class="keywordflow">if</span> ($range_end) {
<a name="l20672"></a>20672           <span class="keywordflow">if</span> ($range_end == $range_start+1) { 
<a name="l20673"></a>20673             <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$range_start; } 
<a name="l20674"></a>20674             <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20675"></a>20675             $txt = $this-&gt;docPageNum($range_start) . $sep;
<a name="l20676"></a>20676             $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l20677"></a>20677             <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$ppp[$zi-1]; } 
<a name="l20678"></a>20678             <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20679"></a>20679             $txt = $this-&gt;docPageNum($ppp[$zi-1]) . $sep;
<a name="l20680"></a>20680             $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l20681"></a>20681           }
<a name="l20682"></a>20682           <span class="keywordflow">else</span> { 
<a name="l20683"></a>20683             <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$range_start; } 
<a name="l20684"></a>20684             <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20685"></a>20685           }
<a name="l20686"></a>20686         }
<a name="l20687"></a>20687         <span class="keywordflow">else</span> {
<a name="l20688"></a>20688           <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$ppp[$zi-1]; } 
<a name="l20689"></a>20689           <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20690"></a>20690           $txt = $this-&gt;docPageNum($ppp[$zi-1]) . $sep;
<a name="l20691"></a>20691           $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l20692"></a>20692         }
<a name="l20693"></a>20693         $range_start = $ppp[$zi];
<a name="l20694"></a>20694         $range_end = 0;
<a name="l20695"></a>20695         }
<a name="l20696"></a>20696        }
<a name="l20697"></a>20697 
<a name="l20698"></a>20698        <span class="keywordflow">if</span> ($range_end) {
<a name="l20699"></a>20699         <span class="keywordflow">if</span> ($range_end == $range_start+1) { 
<a name="l20700"></a>20700           <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$range_start; } 
<a name="l20701"></a>20701           <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20702"></a>20702           $txt = $this-&gt;docPageNum($range_start) . $sep;
<a name="l20703"></a>20703           $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l20704"></a>20704           <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$range_end; } 
<a name="l20705"></a>20705           <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20706"></a>20706           $txt = $this-&gt;docPageNum($range_end);
<a name="l20707"></a>20707           $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l20708"></a>20708         }
<a name="l20709"></a>20709         <span class="keywordflow">else</span> {
<a name="l20710"></a>20710           <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$range_start; } 
<a name="l20711"></a>20711           <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20712"></a>20712           $txt = $this-&gt;docPageNum($range_start) . $joiner;
<a name="l20713"></a>20713           $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l20714"></a>20714           <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$range_end; } 
<a name="l20715"></a>20715           <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20716"></a>20716           $txt = $this-&gt;docPageNum($range_end);
<a name="l20717"></a>20717           $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle); 
<a name="l20718"></a>20718         }
<a name="l20719"></a>20719        }
<a name="l20720"></a>20720        <span class="keywordflow">else</span> {
<a name="l20721"></a>20721         <span class="keywordflow">if</span> ($useLinking) { $href = <span class="charliteral">&#39;@&#39;</span>.$ppp[(count($ppp)-1)]; } 
<a name="l20722"></a>20722         <span class="keywordflow">else</span> { $href = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l20723"></a>20723         $txt = $this-&gt;docPageNum($ppp[(count($ppp)-1)]);
<a name="l20724"></a>20724         $this-&gt;textbuffer[] = array($txt, $href,$this-&gt;currentfontstyle,$this-&gt;colorarray,$this-&gt;currentfontfamily,$this-&gt;SUP,$this-&gt;SUB,<span class="stringliteral">&#39;&#39;</span>,$this-&gt;strike,$this-&gt;outlineparam,$this-&gt;spanbgcolorarray,$this-&gt;currentfontsize,$this-&gt;ReqFontStyle);
<a name="l20725"></a>20725        }
<a name="l20726"></a>20726       }
<a name="l20727"></a>20727     }
<a name="l20728"></a>20728     $this-&gt;CloseTag(<span class="stringliteral">&#39;DIV&#39;</span>);
<a name="l20729"></a>20729 
<a name="l20730"></a>20730     $divlettjuststarted = <span class="keyword">false</span>;
<a name="l20731"></a>20731 
<a name="l20732"></a>20732     $last_lett = $lett;
<a name="l20733"></a>20733   }
<a name="l20734"></a>20734   $this-&gt;CloseTag(<span class="stringliteral">&#39;DIV&#39;</span>);
<a name="l20735"></a>20735 }
<a name="l20736"></a>20736 
<a name="l20737"></a>20737 
<a name="l20738"></a>20738 function AcceptPageBreak() {
<a name="l20739"></a>20739   <span class="keywordflow">if</span> (count($this-&gt;cellBorderBuffer)) { $this-&gt;printcellbuffer(); } <span class="comment">// *TABLES*</span>
<a name="l20740"></a>20740   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;table_rotate) {
<a name="l20741"></a>20741     <span class="keywordflow">if</span> (count($this-&gt;tablebuffer)) { $this-&gt;printtablebuffer(); }
<a name="l20742"></a>20742     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l20743"></a>20743   }
<a name="l20744"></a>20744           $this-&gt;ChangeColumn=0;
<a name="l20745"></a>20745     <span class="keywordflow">return</span> $this-&gt;autoPageBreak;  <span class="comment">// mPDF 3.0</span>
<a name="l20746"></a>20746   <span class="keywordflow">return</span> $this-&gt;autoPageBreak;  <span class="comment">// mPDF 3.0</span>
<a name="l20747"></a>20747 }
<a name="l20748"></a>20748 
<a name="l20749"></a>20749 
<a name="l20750"></a>20750 <span class="comment">//----------- COLUMNS ---------------------</span>
<a name="l20751"></a>20751 
<a name="l20752"></a>20752 
<a name="l20753"></a>20753 <span class="comment">//==================================================================</span>
<a name="l20754"></a>20754 function printcellbuffer() {
<a name="l20755"></a>20755   <span class="keywordflow">if</span> (count($this-&gt;cellBorderBuffer )) {
<a name="l20756"></a>20756     <span class="comment">// usort( $this-&gt;cellBorderBuffer , array($this, &quot;_cmpdom&quot;)); </span>
<a name="l20757"></a>20757     <span class="comment">// mPDF 4.3.008  4.3.014</span>
<a name="l20758"></a>20758     sort($this-&gt;cellBorderBuffer);
<a name="l20759"></a>20759     <span class="keywordflow">foreach</span>($this-&gt;cellBorderBuffer AS $cbb) {
<a name="l20760"></a>20760       $cba = unpack(<span class="stringliteral">&quot;A16dom/nbord/A1side/ns/dbw/ncr/ncg/ncb/A10style/dx/dy/dw/dh/dmbl/dmbr/dmrt/dmrb/dmtl/dmtr/dmlt/dmlb/dcpd/dover/&quot;</span>, $cbb);
<a name="l20761"></a>20761       $side = $cba[<span class="stringliteral">&#39;side&#39;</span>];
<a name="l20762"></a>20762       $details = array();
<a name="l20763"></a>20763       $details[$side][<span class="stringliteral">&#39;dom&#39;</span>] = (float) $cba[<span class="stringliteral">&#39;dom&#39;</span>];
<a name="l20764"></a>20764       $details[$side][<span class="charliteral">&#39;s&#39;</span>] = $cba[<span class="charliteral">&#39;s&#39;</span>];
<a name="l20765"></a>20765       $details[$side][<span class="charliteral">&#39;w&#39;</span>] = $cba[<span class="stringliteral">&#39;bw&#39;</span>];
<a name="l20766"></a>20766       $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;R&#39;</span>] = $cba[<span class="stringliteral">&#39;cr&#39;</span>];
<a name="l20767"></a>20767       $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;G&#39;</span>] = $cba[<span class="stringliteral">&#39;cg&#39;</span>];
<a name="l20768"></a>20768       $details[$side][<span class="charliteral">&#39;c&#39;</span>][<span class="charliteral">&#39;B&#39;</span>] = $cba[<span class="stringliteral">&#39;cb&#39;</span>];
<a name="l20769"></a>20769       $details[$side][<span class="stringliteral">&#39;style&#39;</span>] = trim($cba[<span class="stringliteral">&#39;style&#39;</span>]);
<a name="l20770"></a>20770       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BL&#39;</span>] = $cba[<span class="stringliteral">&#39;mbl&#39;</span>];
<a name="l20771"></a>20771       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;BR&#39;</span>] = $cba[<span class="stringliteral">&#39;mbr&#39;</span>];
<a name="l20772"></a>20772       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RT&#39;</span>] = $cba[<span class="stringliteral">&#39;mrt&#39;</span>];
<a name="l20773"></a>20773       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;RB&#39;</span>] = $cba[<span class="stringliteral">&#39;mrb&#39;</span>];
<a name="l20774"></a>20774       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TL&#39;</span>] = $cba[<span class="stringliteral">&#39;mtl&#39;</span>];
<a name="l20775"></a>20775       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;TR&#39;</span>] = $cba[<span class="stringliteral">&#39;mtr&#39;</span>];
<a name="l20776"></a>20776       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LT&#39;</span>] = $cba[<span class="stringliteral">&#39;mlt&#39;</span>];
<a name="l20777"></a>20777       $details[<span class="stringliteral">&#39;mbw&#39;</span>][<span class="stringliteral">&#39;LB&#39;</span>] = $cba[<span class="stringliteral">&#39;mlb&#39;</span>];
<a name="l20778"></a>20778       $details[<span class="stringliteral">&#39;cellposdom&#39;</span>] = $cba[<span class="stringliteral">&#39;cpd&#39;</span>];
<a name="l20779"></a>20779       $details[<span class="charliteral">&#39;p&#39;</span>] = $side;
<a name="l20780"></a>20780       <span class="keywordflow">if</span> ($cba[<span class="stringliteral">&#39;over&#39;</span>]==1) { $details[$side][<span class="stringliteral">&#39;overlay&#39;</span>] = <span class="keyword">true</span>;  }
<a name="l20781"></a>20781       <span class="keywordflow">else</span> { $details[$side][<span class="stringliteral">&#39;overlay&#39;</span>] = <span class="keyword">false</span>; }
<a name="l20782"></a>20782       $this-&gt;_tableRect($cba[<span class="charliteral">&#39;x&#39;</span>],$cba[<span class="charliteral">&#39;y&#39;</span>],$cba[<span class="charliteral">&#39;w&#39;</span>],$cba[<span class="charliteral">&#39;h&#39;</span>],$cba[<span class="stringliteral">&#39;bord&#39;</span>],$details, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l20783"></a>20783 
<a name="l20784"></a>20784     }
<a name="l20785"></a>20785     $this-&gt;cellBorderBuffer = array();
<a name="l20786"></a>20786   }
<a name="l20787"></a>20787 }
<a name="l20788"></a>20788 <span class="comment">//==================================================================</span>
<a name="l20789"></a>20789 function printtablebuffer() {
<a name="l20790"></a>20790 
<a name="l20791"></a>20791   <span class="keywordflow">if</span> (!$this-&gt;table_rotate) { 
<a name="l20792"></a>20792     <span class="keywordflow">foreach</span>($this-&gt;tablebuffer AS $s) { $this-&gt;pages[$this-&gt;page] .= $s[<span class="charliteral">&#39;s&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l20793"></a>20793     <span class="keywordflow">foreach</span>($this-&gt;tbrot_Links AS $p =&gt; $l) {
<a name="l20794"></a>20794        <span class="keywordflow">foreach</span>($l AS $v) {
<a name="l20795"></a>20795       $this-&gt;PageLinks[$p][] = $v;
<a name="l20796"></a>20796        }
<a name="l20797"></a>20797     }
<a name="l20798"></a>20798     $this-&gt;tbrot_Links = array();
<a name="l20799"></a>20799 
<a name="l20800"></a>20800     <span class="comment">// mPDF 3.0</span>
<a name="l20801"></a>20801         <span class="comment">// Output Reference (index)</span>
<a name="l20802"></a>20802         <span class="keywordflow">foreach</span>($this-&gt;tbrot_Reference AS $v) {
<a name="l20803"></a>20803       $Present=0;
<a name="l20804"></a>20804       <span class="keywordflow">for</span> ($i=0;$i&lt;count($this-&gt;<a class="code" href="classReference.html">Reference</a>);$i++){
<a name="l20805"></a>20805         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$v[<span class="charliteral">&#39;t&#39;</span>]){
<a name="l20806"></a>20806           $Present=1;
<a name="l20807"></a>20807           <span class="keywordflow">if</span> (!in_array($v[<span class="stringliteral">&#39;op&#39;</span>],$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20808"></a>20808             $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $v[<span class="stringliteral">&#39;op&#39;</span>];
<a name="l20809"></a>20809           }
<a name="l20810"></a>20810         }
<a name="l20811"></a>20811       }
<a name="l20812"></a>20812       <span class="keywordflow">if</span> ($Present==0) {
<a name="l20813"></a>20813         $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;array($v[<span class="stringliteral">&#39;op&#39;</span>]));
<a name="l20814"></a>20814       }
<a name="l20815"></a>20815         }
<a name="l20816"></a>20816     $this-&gt;tbrot_Reference = array();
<a name="l20817"></a>20817 
<a name="l20818"></a>20818         <span class="comment">// Output Bookmarks</span>
<a name="l20819"></a>20819         <span class="keywordflow">foreach</span>($this-&gt;tbrot_BMoutlines AS $v) {
<a name="l20820"></a>20820       $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;y&#39;</span>=&gt;$v[<span class="charliteral">&#39;y&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$v[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l20821"></a>20821         }
<a name="l20822"></a>20822     $this-&gt;tbrot_BMoutlines = array();
<a name="l20823"></a>20823 
<a name="l20824"></a>20824         <span class="comment">// Output ToC</span>
<a name="l20825"></a>20825         <span class="keywordflow">foreach</span>($this-&gt;tbrot_toc AS $v) {
<a name="l20826"></a>20826       $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$v[<span class="charliteral">&#39;p&#39;</span>],<span class="stringliteral">&#39;link&#39;</span>=&gt;$v[<span class="stringliteral">&#39;link&#39;</span>],<span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$v[<span class="stringliteral">&#39;toc_id&#39;</span>]);
<a name="l20827"></a>20827         }
<a name="l20828"></a>20828     $this-&gt;tbrot_toc = array();
<a name="l20829"></a>20829 
<a name="l20830"></a>20830     <span class="keywordflow">return</span>; 
<a name="l20831"></a>20831   }
<a name="l20832"></a>20832 
<a name="l20833"></a>20833   <span class="comment">// else if rotated</span>
<a name="l20834"></a>20834   $lm = $this-&gt;lMargin + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;outer_left_margin&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;border_left&#39;</span>][<span class="charliteral">&#39;w&#39;</span>] + $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;padding_left&#39;</span>];
<a name="l20835"></a>20835   $pw = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;inner_width&#39;</span>];
<a name="l20836"></a>20836   <span class="comment">//Start Transformation</span>
<a name="l20837"></a>20837   $this-&gt;pages[$this-&gt;page] .= $this-&gt;StartTransform(<span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20838"></a>20838 
<a name="l20839"></a>20839   <span class="keywordflow">if</span> ($this-&gt;table_rotate &gt; 1) {  <span class="comment">// clockwise</span>
<a name="l20840"></a>20840      <span class="keywordflow">if</span> ($this-&gt;tbrot_align == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l20841"></a>20841     $xadj = $this-&gt;tbrot_h ;  <span class="comment">// align L (as is)</span>
<a name="l20842"></a>20842      }
<a name="l20843"></a>20843      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;tbrot_align == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l20844"></a>20844     $xadj = $lm-$this-&gt;tbrot_x0+($pw) ; <span class="comment">// align R</span>
<a name="l20845"></a>20845      }
<a name="l20846"></a>20846      <span class="keywordflow">else</span> {
<a name="l20847"></a>20847     $xadj = $lm-$this-&gt;tbrot_x0+(($pw + $this-&gt;tbrot_h)/2) ;  <span class="comment">// align C</span>
<a name="l20848"></a>20848      }
<a name="l20849"></a>20849      $yadj = 0;
<a name="l20850"></a>20850   }
<a name="l20851"></a>20851   <span class="keywordflow">else</span> {  <span class="comment">// anti-clockwise</span>
<a name="l20852"></a>20852      <span class="keywordflow">if</span> ($this-&gt;tbrot_align == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l20853"></a>20853     $xadj = 0 ; <span class="comment">// align L (as is)</span>
<a name="l20854"></a>20854      }
<a name="l20855"></a>20855      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;tbrot_align == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l20856"></a>20856     $xadj = $lm-$this-&gt;tbrot_x0+($pw - $this-&gt;tbrot_h) ;  <span class="comment">// align R</span>
<a name="l20857"></a>20857      }
<a name="l20858"></a>20858      <span class="keywordflow">else</span> {
<a name="l20859"></a>20859     $xadj = $lm-$this-&gt;tbrot_x0+(($pw - $this-&gt;tbrot_h)/2) ;  <span class="comment">// align C</span>
<a name="l20860"></a>20860      }
<a name="l20861"></a>20861      $yadj = $this-&gt;tbrot_w;
<a name="l20862"></a>20862   }
<a name="l20863"></a>20863 
<a name="l20864"></a>20864 
<a name="l20865"></a>20865   $this-&gt;pages[$this-&gt;page] .= $this-&gt;transformTranslate($xadj, $yadj , <span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20866"></a>20866   $this-&gt;pages[$this-&gt;page] .= $this-&gt;transformRotate($this-&gt;table_rotate, $this-&gt;tbrot_x0 , $this-&gt;tbrot_y0 , <span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20867"></a>20867 
<a name="l20868"></a>20868   <span class="comment">// Now output the adjusted values</span>
<a name="l20869"></a>20869   <span class="keywordflow">foreach</span>($this-&gt;tablebuffer AS $s) { $this-&gt;pages[$this-&gt;page] .= $s[<span class="charliteral">&#39;s&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l20870"></a>20870 
<a name="l20871"></a>20871 
<a name="l20872"></a>20872   <span class="keywordflow">foreach</span>($this-&gt;tbrot_Links AS $p =&gt; $l) {
<a name="l20873"></a>20873       <span class="keywordflow">foreach</span>($l AS $v) {
<a name="l20874"></a>20874     $w = $v[2]/$this-&gt;k;
<a name="l20875"></a>20875     $h = $v[3]/$this-&gt;k;
<a name="l20876"></a>20876     $ax = ($v[0]/$this-&gt;k) - $this-&gt;tbrot_x0;
<a name="l20877"></a>20877     $ay = (($this-&gt;hPt-$v[1])/$this-&gt;k) - $this-&gt;tbrot_y0;
<a name="l20878"></a>20878     <span class="keywordflow">if</span> ($this-&gt;table_rotate &gt; 1) {  <span class="comment">// clockwise</span>
<a name="l20879"></a>20879       $bx = $this-&gt;tbrot_x0+$xadj-$ay-$h;
<a name="l20880"></a>20880       $by = $this-&gt;tbrot_y0+$yadj+$ax;
<a name="l20881"></a>20881     }
<a name="l20882"></a>20882     <span class="keywordflow">else</span> {
<a name="l20883"></a>20883       $bx = $this-&gt;tbrot_x0+$xadj+$ay;
<a name="l20884"></a>20884       $by = $this-&gt;tbrot_y0+$yadj-$ax-$w;
<a name="l20885"></a>20885     }
<a name="l20886"></a>20886     $v[0] = $bx*$this-&gt;k;
<a name="l20887"></a>20887     $v[1] = ($this-&gt;h-$by)*$this-&gt;k;
<a name="l20888"></a>20888     $v[2] = $h*$this-&gt;k;  <span class="comment">// swap width and height</span>
<a name="l20889"></a>20889     $v[3] = $w*$this-&gt;k;
<a name="l20890"></a>20890     $this-&gt;PageLinks[$p][] = $v;
<a name="l20891"></a>20891       }
<a name="l20892"></a>20892   }
<a name="l20893"></a>20893   $this-&gt;tbrot_Links = array();
<a name="l20894"></a>20894 
<a name="l20895"></a>20895 
<a name="l20896"></a>20896   <span class="comment">// mPDF 3.0</span>
<a name="l20897"></a>20897   <span class="comment">// Adjust Bookmarks</span>
<a name="l20898"></a>20898   <span class="keywordflow">foreach</span>($this-&gt;tbrot_BMoutlines AS $v) {
<a name="l20899"></a>20899     $v[<span class="charliteral">&#39;y&#39;</span>] = $this-&gt;tbrot_y0;
<a name="l20900"></a>20900     $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;y&#39;</span>=&gt;$v[<span class="charliteral">&#39;y&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page);
<a name="l20901"></a>20901   }
<a name="l20902"></a>20902 
<a name="l20903"></a>20903   <span class="comment">// mPDF 3.0</span>
<a name="l20904"></a>20904   <span class="comment">// Adjust Reference (index)</span>
<a name="l20905"></a>20905   <span class="keywordflow">foreach</span>($this-&gt;tbrot_Reference AS $v) {
<a name="l20906"></a>20906     $Present=0;
<a name="l20907"></a>20907     <span class="comment">//Search the reference (AND Ref/PageNo) in the array</span>
<a name="l20908"></a>20908     <span class="keywordflow">for</span> ($i=0;$i&lt;count($this-&gt;<a class="code" href="classReference.html">Reference</a>);$i++){
<a name="l20909"></a>20909       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$v[<span class="charliteral">&#39;t&#39;</span>]){
<a name="l20910"></a>20910         $Present=1;
<a name="l20911"></a>20911         <span class="keywordflow">if</span> (!in_array($this-&gt;page,$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20912"></a>20912           $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $this-&gt;page;
<a name="l20913"></a>20913         }
<a name="l20914"></a>20914       }
<a name="l20915"></a>20915     }
<a name="l20916"></a>20916     <span class="keywordflow">if</span> ($Present==0) {
<a name="l20917"></a>20917       $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;array($this-&gt;page));
<a name="l20918"></a>20918     }
<a name="l20919"></a>20919   }
<a name="l20920"></a>20920 
<a name="l20921"></a>20921   <span class="comment">// mPDF 3.0</span>
<a name="l20922"></a>20922   <span class="comment">// Adjust ToC - uses document page number</span>
<a name="l20923"></a>20923   <span class="keywordflow">foreach</span>($this-&gt;tbrot_toc AS $v) {
<a name="l20924"></a>20924     $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page,<span class="stringliteral">&#39;link&#39;</span>=&gt;$v[<span class="stringliteral">&#39;link&#39;</span>],<span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$v[<span class="stringliteral">&#39;toc_id&#39;</span>]);
<a name="l20925"></a>20925     $this-&gt;links[$v[<span class="stringliteral">&#39;link&#39;</span>]][1] = $this-&gt;tbrot_y0; 
<a name="l20926"></a>20926   }
<a name="l20927"></a>20927 
<a name="l20928"></a>20928 
<a name="l20929"></a>20929   <span class="comment">// mPDF 3.0</span>
<a name="l20930"></a>20930   $this-&gt;tbrot_Reference = array();
<a name="l20931"></a>20931   $this-&gt;tbrot_BMoutlines = array();
<a name="l20932"></a>20932   $this-&gt;tbrot_toc = array();
<a name="l20933"></a>20933 
<a name="l20934"></a>20934   <span class="comment">//Stop Transformation</span>
<a name="l20935"></a>20935   $this-&gt;pages[$this-&gt;page] .= $this-&gt;StopTransform(<span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20936"></a>20936 
<a name="l20937"></a>20937 
<a name="l20938"></a>20938   $this-&gt;y = $this-&gt;tbrot_y0 + $this-&gt;tbrot_w;
<a name="l20939"></a>20939   $this-&gt;x = $this-&gt;lMargin;
<a name="l20940"></a>20940 
<a name="l20941"></a>20941   $this-&gt;tablebuffer = array();
<a name="l20942"></a>20942 }
<a name="l20943"></a>20943 
<a name="l20944"></a>20944 <span class="comment">//==================================================================</span>
<a name="l20945"></a>20945 <span class="comment">// Keep-with-table This buffers contents of h1-6 to keep on page with table</span>
<a name="l20946"></a>20946 function printkwtbuffer() {
<a name="l20947"></a>20947   <span class="keywordflow">if</span> (!$this-&gt;kwt_moved) { 
<a name="l20948"></a>20948     <span class="keywordflow">foreach</span>($this-&gt;kwt_buffer AS $s) { $this-&gt;pages[$this-&gt;page] .= $s[<span class="charliteral">&#39;s&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l20949"></a>20949     <span class="keywordflow">foreach</span>($this-&gt;kwt_Links AS $p =&gt; $l) {
<a name="l20950"></a>20950        <span class="keywordflow">foreach</span>($l AS $v) {
<a name="l20951"></a>20951       $this-&gt;PageLinks[$p][] = $v;
<a name="l20952"></a>20952        }
<a name="l20953"></a>20953     }
<a name="l20954"></a>20954     $this-&gt;kwt_Links = array();
<a name="l20955"></a>20955 
<a name="l20956"></a>20956     <span class="comment">// mPDF 3.0</span>
<a name="l20957"></a>20957         <span class="comment">// Output Reference (index)</span>
<a name="l20958"></a>20958         <span class="keywordflow">foreach</span>($this-&gt;kwt_Reference AS $v) {
<a name="l20959"></a>20959       $Present=0;
<a name="l20960"></a>20960       <span class="keywordflow">for</span> ($i=0;$i&lt;count($this-&gt;<a class="code" href="classReference.html">Reference</a>);$i++){
<a name="l20961"></a>20961         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$v[<span class="charliteral">&#39;t&#39;</span>]){
<a name="l20962"></a>20962           $Present=1;
<a name="l20963"></a>20963           <span class="keywordflow">if</span> (!in_array($v[<span class="stringliteral">&#39;op&#39;</span>],$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l20964"></a>20964             $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $v[<span class="stringliteral">&#39;op&#39;</span>];
<a name="l20965"></a>20965           }
<a name="l20966"></a>20966         }
<a name="l20967"></a>20967       }
<a name="l20968"></a>20968       <span class="keywordflow">if</span> ($Present==0) {
<a name="l20969"></a>20969         $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;array($v[<span class="stringliteral">&#39;op&#39;</span>]));
<a name="l20970"></a>20970       }
<a name="l20971"></a>20971         }
<a name="l20972"></a>20972     $this-&gt;kwt_Reference = array();
<a name="l20973"></a>20973 
<a name="l20974"></a>20974         <span class="comment">// Output Bookmarks</span>
<a name="l20975"></a>20975         <span class="keywordflow">foreach</span>($this-&gt;kwt_BMoutlines AS $v) {
<a name="l20976"></a>20976       $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;y&#39;</span>=&gt;$v[<span class="charliteral">&#39;y&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$v[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l20977"></a>20977         }
<a name="l20978"></a>20978     $this-&gt;kwt_BMoutlines = array();
<a name="l20979"></a>20979 
<a name="l20980"></a>20980         <span class="comment">// Output ToC</span>
<a name="l20981"></a>20981         <span class="keywordflow">foreach</span>($this-&gt;kwt_toc AS $v) {
<a name="l20982"></a>20982       $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$v[<span class="charliteral">&#39;p&#39;</span>],<span class="stringliteral">&#39;link&#39;</span>=&gt;$v[<span class="stringliteral">&#39;link&#39;</span>],<span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$v[<span class="stringliteral">&#39;toc_id&#39;</span>]);
<a name="l20983"></a>20983         }
<a name="l20984"></a>20984     $this-&gt;kwt_toc = array();
<a name="l20985"></a>20985 
<a name="l20986"></a>20986     <span class="keywordflow">return</span>; 
<a name="l20987"></a>20987   }
<a name="l20988"></a>20988 
<a name="l20989"></a>20989   <span class="comment">//Start Transformation</span>
<a name="l20990"></a>20990   $this-&gt;pages[$this-&gt;page] .= $this-&gt;StartTransform(<span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20991"></a>20991   $xadj = $this-&gt;lMargin - $this-&gt;kwt_x0 ;
<a name="l20992"></a>20992   <span class="comment">//$yadj = $this-&gt;y - $this-&gt;kwt_y0 ;</span>
<a name="l20993"></a>20993   $yadj = $this-&gt;tMargin - $this-&gt;kwt_y0 ;
<a name="l20994"></a>20994 
<a name="l20995"></a>20995   $this-&gt;pages[$this-&gt;page] .= $this-&gt;transformTranslate($xadj, $yadj , <span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l20996"></a>20996 
<a name="l20997"></a>20997   <span class="comment">// Now output the adjusted values</span>
<a name="l20998"></a>20998   <span class="keywordflow">foreach</span>($this-&gt;kwt_buffer AS $s) { $this-&gt;pages[$this-&gt;page] .= $s[<span class="charliteral">&#39;s&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l20999"></a>20999 
<a name="l21000"></a>21000   <span class="comment">// Adjust hyperLinks</span>
<a name="l21001"></a>21001   <span class="keywordflow">foreach</span>($this-&gt;kwt_Links AS $p =&gt; $l) {
<a name="l21002"></a>21002       <span class="keywordflow">foreach</span>($l AS $v) {
<a name="l21003"></a>21003     $bx = $this-&gt;kwt_x0+$xadj;
<a name="l21004"></a>21004     $by = $this-&gt;kwt_y0+$yadj;
<a name="l21005"></a>21005     $v[0] = $bx*$this-&gt;k;
<a name="l21006"></a>21006     $v[1] = ($this-&gt;h-$by)*$this-&gt;k;
<a name="l21007"></a>21007     $this-&gt;PageLinks[$p][] = $v;
<a name="l21008"></a>21008       }
<a name="l21009"></a>21009   }
<a name="l21010"></a>21010 
<a name="l21011"></a>21011   <span class="comment">// mPDF 3.0</span>
<a name="l21012"></a>21012   <span class="comment">// Adjust Bookmarks</span>
<a name="l21013"></a>21013   <span class="keywordflow">foreach</span>($this-&gt;kwt_BMoutlines AS $v) {
<a name="l21014"></a>21014     <span class="keywordflow">if</span> ($v[<span class="charliteral">&#39;y&#39;</span>] != 0) { $v[<span class="charliteral">&#39;y&#39;</span>] += $yadj; }
<a name="l21015"></a>21015     $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;y&#39;</span>=&gt;$v[<span class="charliteral">&#39;y&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page);
<a name="l21016"></a>21016   }
<a name="l21017"></a>21017 
<a name="l21018"></a>21018   <span class="comment">// mPDF 3.0</span>
<a name="l21019"></a>21019   <span class="comment">// Adjust Reference (index)</span>
<a name="l21020"></a>21020   <span class="keywordflow">foreach</span>($this-&gt;kwt_Reference AS $v) {
<a name="l21021"></a>21021     $Present=0;
<a name="l21022"></a>21022     <span class="comment">//Search the reference (AND Ref/PageNo) in the array</span>
<a name="l21023"></a>21023     <span class="keywordflow">for</span> ($i=0;$i&lt;count($this-&gt;<a class="code" href="classReference.html">Reference</a>);$i++){
<a name="l21024"></a>21024       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$v[<span class="charliteral">&#39;t&#39;</span>]){
<a name="l21025"></a>21025         $Present=1;
<a name="l21026"></a>21026         <span class="keywordflow">if</span> (!in_array($this-&gt;page,$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l21027"></a>21027           $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $this-&gt;page;
<a name="l21028"></a>21028         }
<a name="l21029"></a>21029       }
<a name="l21030"></a>21030     }
<a name="l21031"></a>21031     <span class="keywordflow">if</span> ($Present==0) {
<a name="l21032"></a>21032       $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;array($this-&gt;page));
<a name="l21033"></a>21033     }
<a name="l21034"></a>21034   }
<a name="l21035"></a>21035 
<a name="l21036"></a>21036   <span class="comment">// mPDF 3.0</span>
<a name="l21037"></a>21037   <span class="comment">// Adjust ToC</span>
<a name="l21038"></a>21038   <span class="keywordflow">foreach</span>($this-&gt;kwt_toc AS $v) {
<a name="l21039"></a>21039     $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$this-&gt;page,<span class="stringliteral">&#39;link&#39;</span>=&gt;$v[<span class="stringliteral">&#39;link&#39;</span>],<span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$v[<span class="stringliteral">&#39;toc_id&#39;</span>]);
<a name="l21040"></a>21040     $this-&gt;links[$v[<span class="stringliteral">&#39;link&#39;</span>]][0] = $this-&gt;page;
<a name="l21041"></a>21041     $this-&gt;links[$v[<span class="stringliteral">&#39;link&#39;</span>]][1] += $yadj;
<a name="l21042"></a>21042   }
<a name="l21043"></a>21043 
<a name="l21044"></a>21044 
<a name="l21045"></a>21045   $this-&gt;kwt_Links = array();
<a name="l21046"></a>21046   $this-&gt;kwt_Annots = array();
<a name="l21047"></a>21047   <span class="comment">// mPDF 3.0</span>
<a name="l21048"></a>21048   $this-&gt;kwt_Reference = array();
<a name="l21049"></a>21049   $this-&gt;kwt_BMoutlines = array();
<a name="l21050"></a>21050   $this-&gt;kwt_toc = array();
<a name="l21051"></a>21051   <span class="comment">//Stop Transformation</span>
<a name="l21052"></a>21052   $this-&gt;pages[$this-&gt;page] .= $this-&gt;StopTransform(<span class="keyword">true</span>).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l21053"></a>21053 
<a name="l21054"></a>21054   $this-&gt;kwt_buffer = array();
<a name="l21055"></a>21055 
<a name="l21056"></a>21056   $this-&gt;y += $this-&gt;kwt_height;
<a name="l21057"></a>21057 }
<a name="l21058"></a>21058 
<a name="l21059"></a>21059 
<a name="l21060"></a>21060 
<a name="l21061"></a>21061 <span class="comment">//==================================================================</span>
<a name="l21062"></a>21062 <span class="comment">// mPDF 4.0</span>
<a name="l21063"></a>21063 function printfloatbuffer() {
<a name="l21064"></a>21064   <span class="keywordflow">if</span> (count($this-&gt;floatbuffer)) {
<a name="l21065"></a>21065     $this-&gt;objectbuffer = $this-&gt;floatbuffer;
<a name="l21066"></a>21066     $this-&gt;printobjectbuffer(<span class="keyword">false</span>);
<a name="l21067"></a>21067     $this-&gt;objectbuffer = array();
<a name="l21068"></a>21068     $this-&gt;floatbuffer = array();
<a name="l21069"></a>21069     $this-&gt;floatmargins = array();
<a name="l21070"></a>21070   }
<a name="l21071"></a>21071 }
<a name="l21072"></a>21072 <span class="comment">//==================================================================</span>
<a name="l21073"></a>21073 
<a name="l21074"></a>21074 function printdivbuffer() {
<a name="l21075"></a>21075   $k = $this-&gt;k;
<a name="l21076"></a>21076   $p1 = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>];
<a name="l21077"></a>21077   $p2 = $this-&gt;page;
<a name="l21078"></a>21078   $bottom[$p1] = $this-&gt;ktBlock[$p1][<span class="stringliteral">&#39;bottom_margin&#39;</span>];
<a name="l21079"></a>21079   $bottom[$p2] = $this-&gt;y;  <span class="comment">// $this-&gt;ktBlock[$p2][&#39;bottom_margin&#39;];</span>
<a name="l21080"></a>21080   $top[$p1] = $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;y00&#39;</span>];
<a name="l21081"></a>21081   $top2 = $this-&gt;h;
<a name="l21082"></a>21082   <span class="keywordflow">foreach</span>($this-&gt;divbuffer AS $key=&gt;$s) { 
<a name="l21083"></a>21083     <span class="keywordflow">if</span> ($s[<span class="stringliteral">&#39;page&#39;</span>] == $p2) {
<a name="l21084"></a>21084       $top2 = MIN($s[<span class="charliteral">&#39;y&#39;</span>], $top2);
<a name="l21085"></a>21085     }
<a name="l21086"></a>21086   }
<a name="l21087"></a>21087   $top[$p2] = $top2;
<a name="l21088"></a>21088   $height[$p1] = ($bottom[$p1] - $top[$p1]);
<a name="l21089"></a>21089   $height[$p2] = ($bottom[$p2] - $top[$p2]);
<a name="l21090"></a>21090   $xadj[$p1] = $this-&gt;MarginCorrection;
<a name="l21091"></a>21091   $yadj[$p1] = -($top[$p1] - $top[$p2]);
<a name="l21092"></a>21092   $xadj[$p2] = 0;
<a name="l21093"></a>21093   $yadj[$p2] = $height[$p1];
<a name="l21094"></a>21094 
<a name="l21095"></a>21095   <span class="keywordflow">if</span> ($this-&gt;ColActive || !$this-&gt;keep_block_together || $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>] == $this-&gt;page || ($this-&gt;page - $this-&gt;blk[$this-&gt;blklvl][<span class="stringliteral">&#39;startpage&#39;</span>]) &gt; 1 || ($height[$p1]+$height[$p2]) &gt; $this-&gt;h) { 
<a name="l21096"></a>21096     <span class="keywordflow">foreach</span>($this-&gt;divbuffer AS $s) { $this-&gt;pages[$s[<span class="stringliteral">&#39;page&#39;</span>]] .= $s[<span class="charliteral">&#39;s&#39;</span>].<span class="stringliteral">&quot;\n&quot;</span>; }
<a name="l21097"></a>21097     <span class="keywordflow">foreach</span>($this-&gt;ktLinks AS $p =&gt; $l) {
<a name="l21098"></a>21098        <span class="keywordflow">foreach</span>($l AS $v) {
<a name="l21099"></a>21099       $this-&gt;PageLinks[$p][] = $v;
<a name="l21100"></a>21100        }
<a name="l21101"></a>21101     }
<a name="l21102"></a>21102         <span class="comment">// Adjust Reference (index)</span>
<a name="l21103"></a>21103         <span class="keywordflow">foreach</span>($this-&gt;ktReference AS $v) {
<a name="l21104"></a>21104       <span class="comment">// mPDF 3.0</span>
<a name="l21105"></a>21105       $Present=0;
<a name="l21106"></a>21106       <span class="comment">//Search the reference (AND Ref/PageNo) in the array</span>
<a name="l21107"></a>21107       <span class="keywordflow">for</span> ($i=0;$i&lt;count($this-&gt;<a class="code" href="classReference.html">Reference</a>);$i++){
<a name="l21108"></a>21108         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$v[<span class="charliteral">&#39;t&#39;</span>]){
<a name="l21109"></a>21109           $Present=1;
<a name="l21110"></a>21110           <span class="keywordflow">if</span> (!in_array($p2,$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l21111"></a>21111             $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $p2;
<a name="l21112"></a>21112           }
<a name="l21113"></a>21113         }
<a name="l21114"></a>21114       }
<a name="l21115"></a>21115       <span class="comment">//If not found, add it</span>
<a name="l21116"></a>21116       <span class="keywordflow">if</span> ($Present==0) {
<a name="l21117"></a>21117         $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;array($p2));
<a name="l21118"></a>21118       }
<a name="l21119"></a>21119         }
<a name="l21120"></a>21120 
<a name="l21121"></a>21121         <span class="comment">// Adjust Bookmarks</span>
<a name="l21122"></a>21122         <span class="keywordflow">foreach</span>($this-&gt;ktBMoutlines AS $v) {
<a name="l21123"></a>21123       $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;y&#39;</span>=&gt;$v[<span class="charliteral">&#39;y&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$v[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l21124"></a>21124         }
<a name="l21125"></a>21125 
<a name="l21126"></a>21126         <span class="comment">// Adjust ToC</span>
<a name="l21127"></a>21127         <span class="keywordflow">foreach</span>($this-&gt;_kttoc AS $v) {
<a name="l21128"></a>21128       $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$v[<span class="charliteral">&#39;p&#39;</span>],<span class="stringliteral">&#39;link&#39;</span>=&gt;$v[<span class="stringliteral">&#39;link&#39;</span>],<span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$v[<span class="stringliteral">&#39;toc_id&#39;</span>]);
<a name="l21129"></a>21129         }
<a name="l21130"></a>21130 
<a name="l21131"></a>21131     $this-&gt;divbuffer = array();
<a name="l21132"></a>21132     $this-&gt;ktLinks = array();
<a name="l21133"></a>21133     $this-&gt;ktAnnots = array();
<a name="l21134"></a>21134     $this-&gt;ktBlock = array();
<a name="l21135"></a>21135     $this-&gt;ktReference = array();
<a name="l21136"></a>21136     $this-&gt;ktBMoutlines = array();
<a name="l21137"></a>21137     $this-&gt;_kttoc = array();
<a name="l21138"></a>21138     $this-&gt;keep_block_together = 0;
<a name="l21139"></a>21139     <span class="keywordflow">return</span>; 
<a name="l21140"></a>21140   }
<a name="l21141"></a>21141   <span class="keywordflow">else</span> {
<a name="l21142"></a>21142      <span class="keywordflow">foreach</span>($this-&gt;divbuffer AS $key=&gt;$s) { 
<a name="l21143"></a>21143     <span class="comment">// callback function in htmltoolkit</span>
<a name="l21144"></a>21144     $t = $s[<span class="charliteral">&#39;s&#39;</span>];
<a name="l21145"></a>21145     $p = $s[<span class="stringliteral">&#39;page&#39;</span>];
<a name="l21146"></a>21146     $t = preg_replace(<span class="stringliteral">&#39;/BT (\d+\.\d\d+) (\d+\.\d\d+) Td/e&#39;</span>,<span class="stringliteral">&quot;\$this-&gt;blockAdjust(&#39;Td&#39;,$k,$xadj[$p],$yadj[$p],&#39;\\1&#39;,&#39;\\2&#39;)&quot;</span>,$t);
<a name="l21147"></a>21147     $t = preg_replace(<span class="stringliteral">&#39;/(\d+\.\d\d+) (\d+\.\d\d+) (\d+\.\d\d+) ([\-]{0,1}\d+\.\d\d+) re/e&#39;</span>,<span class="stringliteral">&quot;\$this-&gt;blockAdjust(&#39;re&#39;,$k,$xadj[$p],$yadj[$p],&#39;\\1&#39;,&#39;\\2&#39;,&#39;\\3&#39;,&#39;\\4&#39;)&quot;</span>,$t);
<a name="l21148"></a>21148     $t = preg_replace(<span class="stringliteral">&#39;/(\d+\.\d\d+) (\d+\.\d\d+) l/e&#39;</span>,<span class="stringliteral">&quot;\$this-&gt;blockAdjust(&#39;l&#39;,$k,$xadj[$p],$yadj[$p],&#39;\\1&#39;,&#39;\\2&#39;)&quot;</span>,$t);
<a name="l21149"></a>21149     $t = preg_replace(<span class="stringliteral">&#39;/q (\d+\.\d\d+) 0 0 (\d+\.\d\d+) (\d+\.\d\d+) (\d+\.\d\d+) cm \/I/e&#39;</span>,<span class="stringliteral">&quot;\$this-&gt;blockAdjust(&#39;img&#39;,$k,$xadj[$p],$yadj[$p],&#39;\\1&#39;,&#39;\\2&#39;,&#39;\\3&#39;,&#39;\\4&#39;)&quot;</span>,$t);
<a name="l21150"></a>21150     $t = preg_replace(<span class="stringliteral">&#39;/(\d+\.\d\d+) (\d+\.\d\d+) m/e&#39;</span>,<span class="stringliteral">&quot;\$this-&gt;blockAdjust(&#39;draw&#39;,$k,$xadj[$p],$yadj[$p],&#39;\\1&#39;,&#39;\\2&#39;)&quot;</span>,$t);
<a name="l21151"></a>21151     $t = preg_replace(<span class="stringliteral">&#39;/(\d+\.\d\d+) (\d+\.\d\d+) (\d+\.\d\d+) (\d+\.\d\d+) (\d+\.\d\d+) (\d+\.\d\d+) c/e&#39;</span>,<span class="stringliteral">&quot;\$this-&gt;blockAdjust(&#39;bezier&#39;,$k,$xadj[$p],$yadj[$p],&#39;\\1&#39;,&#39;\\2&#39;,&#39;\\3&#39;,&#39;\\4&#39;,&#39;\\5&#39;,&#39;\\6&#39;)&quot;</span>,$t);
<a name="l21152"></a>21152 
<a name="l21153"></a>21153     $this-&gt;pages[$this-&gt;page] .= $t.<span class="stringliteral">&quot;\n&quot;</span>; 
<a name="l21154"></a>21154      }
<a name="l21155"></a>21155      <span class="comment">// Adjust hyperLinks</span>
<a name="l21156"></a>21156      <span class="keywordflow">foreach</span>($this-&gt;ktLinks AS $p =&gt; $l) {
<a name="l21157"></a>21157       <span class="keywordflow">foreach</span>($l AS $v) {
<a name="l21158"></a>21158     $v[0] += ($xadj[$p]*$k);
<a name="l21159"></a>21159     $v[1] -= ($yadj[$p]*$k);
<a name="l21160"></a>21160     $this-&gt;PageLinks[$p2][] = $v;
<a name="l21161"></a>21161       }
<a name="l21162"></a>21162      }
<a name="l21163"></a>21163 
<a name="l21164"></a>21164      <span class="comment">// Adjust Bookmarks</span>
<a name="l21165"></a>21165      <span class="keywordflow">foreach</span>($this-&gt;ktBMoutlines AS $v) {
<a name="l21166"></a>21166     <span class="keywordflow">if</span> ($v[<span class="charliteral">&#39;y&#39;</span>] != 0) { $v[<span class="charliteral">&#39;y&#39;</span>] += ($yadj[$v[<span class="charliteral">&#39;p&#39;</span>]]); }
<a name="l21167"></a>21167     $this-&gt;BMoutlines[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;y&#39;</span>=&gt;$v[<span class="charliteral">&#39;y&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$p2);
<a name="l21168"></a>21168      }
<a name="l21169"></a>21169 
<a name="l21170"></a>21170      <span class="comment">// Adjust Reference (index)</span>
<a name="l21171"></a>21171      <span class="keywordflow">foreach</span>($this-&gt;ktReference AS $v) {
<a name="l21172"></a>21172     <span class="comment">// mPDF 3.0</span>
<a name="l21173"></a>21173     $Present=0;
<a name="l21174"></a>21174     <span class="comment">//Search the reference (AND Ref/PageNo) in the array</span>
<a name="l21175"></a>21175     <span class="keywordflow">for</span> ($i=0;$i&lt;count($this-&gt;<a class="code" href="classReference.html">Reference</a>);$i++){
<a name="l21176"></a>21176       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;t&#39;</span>]==$v[<span class="charliteral">&#39;t&#39;</span>]){
<a name="l21177"></a>21177         $Present=1;
<a name="l21178"></a>21178         <span class="keywordflow">if</span> (!in_array($p2,$this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>])) {
<a name="l21179"></a>21179           $this-&gt;<a class="code" href="classReference.html">Reference</a>[$i][<span class="charliteral">&#39;p&#39;</span>][] = $p2;
<a name="l21180"></a>21180         }
<a name="l21181"></a>21181       }
<a name="l21182"></a>21182     }
<a name="l21183"></a>21183     <span class="comment">//If not found, add it</span>
<a name="l21184"></a>21184     <span class="keywordflow">if</span> ($Present==0) {
<a name="l21185"></a>21185       $this-&gt;<a class="code" href="classReference.html">Reference</a>[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;array($p2));
<a name="l21186"></a>21186     }
<a name="l21187"></a>21187      }
<a name="l21188"></a>21188 
<a name="l21189"></a>21189      <span class="comment">// Adjust ToC</span>
<a name="l21190"></a>21190      <span class="keywordflow">foreach</span>($this-&gt;_kttoc AS $v) {
<a name="l21191"></a>21191     $this-&gt;_toc[]=array(<span class="charliteral">&#39;t&#39;</span>=&gt;$v[<span class="charliteral">&#39;t&#39;</span>],<span class="charliteral">&#39;l&#39;</span>=&gt;$v[<span class="charliteral">&#39;l&#39;</span>],<span class="charliteral">&#39;p&#39;</span>=&gt;$p2,<span class="stringliteral">&#39;link&#39;</span>=&gt;$v[<span class="stringliteral">&#39;link&#39;</span>],<span class="stringliteral">&#39;toc_id&#39;</span>=&gt;$v[<span class="stringliteral">&#39;toc_id&#39;</span>]);
<a name="l21192"></a>21192     <span class="comment">// mPDF 3.0</span>
<a name="l21193"></a>21193     $this-&gt;links[$v[<span class="stringliteral">&#39;link&#39;</span>]][0] = $p2;
<a name="l21194"></a>21194     $this-&gt;links[$v[<span class="stringliteral">&#39;link&#39;</span>]][1] += $yadj[$p];
<a name="l21195"></a>21195      }
<a name="l21196"></a>21196 
<a name="l21197"></a>21197      $this-&gt;y = $top[$p2] + $height[$p1] + $height[$p2];
<a name="l21198"></a>21198      $this-&gt;x = $this-&gt;lMargin;
<a name="l21199"></a>21199 
<a name="l21200"></a>21200      $this-&gt;divbuffer = array();
<a name="l21201"></a>21201      $this-&gt;ktLinks = array();
<a name="l21202"></a>21202      $this-&gt;ktAnnots = array();
<a name="l21203"></a>21203      $this-&gt;ktBlock = array();
<a name="l21204"></a>21204      $this-&gt;ktReference = array();
<a name="l21205"></a>21205      $this-&gt;ktBMoutlines = array();
<a name="l21206"></a>21206      $this-&gt;_kttoc = array();
<a name="l21207"></a>21207      $this-&gt;keep_block_together = 0;
<a name="l21208"></a>21208   }
<a name="l21209"></a>21209 }
<a name="l21210"></a>21210 
<a name="l21211"></a>21211 
<a name="l21212"></a>21212 <span class="comment">//==================================================================</span>
<a name="l21213"></a>21213 <span class="comment">// Added ELLIPSES and CIRCLES</span>
<a name="l21214"></a>21214 function Circle($x,$y,$r,$style=<span class="charliteral">&#39;S&#39;</span>) {
<a name="l21215"></a>21215   $this-&gt;Ellipse($x,$y,$r,$r,$style);
<a name="l21216"></a>21216 }
<a name="l21217"></a>21217 
<a name="l21218"></a>21218 function Ellipse($x,$y,$rx,$ry,$style=<span class="charliteral">&#39;S&#39;</span>) {
<a name="l21219"></a>21219   <span class="keywordflow">if</span>($style==<span class="charliteral">&#39;F&#39;</span>) { $op=<span class="charliteral">&#39;f&#39;</span>; }
<a name="l21220"></a>21220   elseif($style==<span class="stringliteral">&#39;FD&#39;</span> or $style==<span class="stringliteral">&#39;DF&#39;</span>) { $op=<span class="charliteral">&#39;B&#39;</span>; }
<a name="l21221"></a>21221   <span class="keywordflow">else</span> { $op=<span class="charliteral">&#39;S&#39;</span>; }
<a name="l21222"></a>21222   $lx=4/3*(M_SQRT2-1)*$rx;
<a name="l21223"></a>21223   $ly=4/3*(M_SQRT2-1)*$ry;
<a name="l21224"></a>21224   $k=$this-&gt;k;
<a name="l21225"></a>21225   $h=$this-&gt;h;
<a name="l21226"></a>21226   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f m %.3f %.3f %.3f %.3f %.3f %.3f c&#39;</span>, ($x+$rx)*$k,($h-$y)*$k, ($x+$rx)*$k,($h-($y-$ly))*$k, ($x+$lx)*$k,($h-($y-$ry))*$k, $x*$k,($h-($y-$ry))*$k));
<a name="l21227"></a>21227   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f c&#39;</span>, ($x-$lx)*$k,($h-($y-$ry))*$k,  ($x-$rx)*$k,($h-($y-$ly))*$k,   ($x-$rx)*$k,($h-$y)*$k)); 
<a name="l21228"></a>21228   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f c&#39;</span>, ($x-$rx)*$k,($h-($y+$ly))*$k, ($x-$lx)*$k,($h-($y+$ry))*$k, $x*$k,($h-($y+$ry))*$k)); 
<a name="l21229"></a>21229   $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f c %s&#39;</span>, ($x+$lx)*$k,($h-($y+$ry))*$k, ($x+$rx)*$k,($h-($y+$ly))*$k, ($x+$rx)*$k,($h-$y)*$k, $op));
<a name="l21230"></a>21230 }
<a name="l21231"></a>21231 
<a name="l21232"></a>21232 
<a name="l21233"></a>21233 
<a name="l21234"></a>21234 
<a name="l21235"></a>21235 
<a name="l21236"></a>21236 
<a name="l21237"></a>21237 <span class="comment">// ====================================================</span>
<a name="l21238"></a>21238 <span class="comment">// ====================================================</span>
<a name="l21239"></a>21239 
<a name="l21240"></a>21240 <span class="comment">// </span>
<a name="l21241"></a>21241 <span class="comment">// ****************************</span>
<a name="l21242"></a>21242 <span class="comment">// ****************************</span>
<a name="l21243"></a>21243 
<a name="l21244"></a>21244 
<a name="l21245"></a>21245 <span class="comment">// mPDF 4.0</span>
<a name="l21246"></a>21246 function SetSubstitutions($dummy=array()) { <span class="comment">// parameter only for backward compatability</span>
<a name="l21247"></a>21247   $subsarray = array();
<a name="l21248"></a>21248   @include(_MPDF_PATH.<span class="stringliteral">&#39;includes/subs_&#39;</span>.strtolower($this-&gt;codepage).<span class="stringliteral">&#39;.php&#39;</span>);
<a name="l21249"></a>21249   $this-&gt;substitute = array();
<a name="l21250"></a>21250   <span class="keywordflow">foreach</span>($subsarray AS $key =&gt; $val) {
<a name="l21251"></a>21251     $this-&gt;substitute[code2utf($key)] = $val;
<a name="l21252"></a>21252   }
<a name="l21253"></a>21253 }
<a name="l21254"></a>21254 
<a name="l21255"></a>21255 
<a name="l21256"></a>21256 function SubstituteChars($html) {
<a name="l21257"></a>21257   <span class="comment">// mPDF 4.2.018</span>
<a name="l21258"></a>21258   <span class="keywordflow">if</span> ($this-&gt;PDFA &amp;&amp; $this-&gt;useSubstitutions) { 
<a name="l21259"></a>21259     <span class="keywordflow">if</span> (!$this-&gt;PDFAauto) { $this-&gt;PDFAwarnings[] = <span class="stringliteral">&quot;Core Adobe fonts [Helvetica, Times, Symbol etc] cannot be embedded with mPDF, which is required for PDFA1-b (Character substitution [useSubstitutions] disabled)&quot;</span>; }
<a name="l21260"></a>21260     $this-&gt;useSubstitutions = <span class="keyword">false</span>;
<a name="l21261"></a>21261   }
<a name="l21262"></a>21262   <span class="comment">// only substitute characters between tags</span>
<a name="l21263"></a>21263   <span class="keywordflow">if</span> ($this-&gt;useSubstitutions &amp;&amp; count($this-&gt;substitute)) {  
<a name="l21264"></a>21264     $a=preg_split(<span class="stringliteral">&#39;/(&lt;.*?&gt;)/ms&#39;</span>,$html,-1,PREG_SPLIT_DELIM_CAPTURE);
<a name="l21265"></a>21265     $html = <span class="stringliteral">&#39;&#39;</span>;
<a name="l21266"></a>21266     <span class="keywordflow">foreach</span>($a as $i =&gt; $e) {
<a name="l21267"></a>21267       <span class="keywordflow">if</span>($i%2==0) {
<a name="l21268"></a>21268          $e = strtr($e, $this-&gt;substitute);
<a name="l21269"></a>21269       }
<a name="l21270"></a>21270       $html .= $e;
<a name="l21271"></a>21271     }
<a name="l21272"></a>21272   }
<a name="l21273"></a>21273   <span class="keywordflow">return</span> $html;
<a name="l21274"></a>21274 }
<a name="l21275"></a>21275 
<a name="l21276"></a>21276 <span class="comment">// mPDF 4.2</span>
<a name="l21277"></a>21277 function SubstituteCharsMB(&amp;$writehtml_a, &amp;$writehtml_i, &amp;$writehtml_e) {
<a name="l21278"></a>21278   <span class="comment">// mPDF 4.2.018</span>
<a name="l21279"></a>21279   <span class="keywordflow">if</span> ($this-&gt;PDFA) { 
<a name="l21280"></a>21280     <span class="keywordflow">if</span> (!$this-&gt;PDFAauto) { $this-&gt;PDFAwarnings[] = <span class="stringliteral">&quot;Core Adobe fonts [Helvetica, Times, Symbol etc] cannot be embedded with mPDF, which is required for PDFA1-b (Character substitution [useSubstitutionsMB] disabled)&quot;</span>; }
<a name="l21281"></a>21281     $this-&gt;useSubstitutionsMB = <span class="keyword">false</span>;
<a name="l21282"></a>21282     <span class="keywordflow">return</span> 0;
<a name="l21283"></a>21283   }
<a name="l21284"></a>21284   $cw = &amp;$this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l21285"></a>21285   $unicode = $this-&gt;UTF8StringToArray($writehtml_e);
<a name="l21286"></a>21286   $start = -1;
<a name="l21287"></a>21287   $end = 0;
<a name="l21288"></a>21288   $flag = 0;
<a name="l21289"></a>21289   $ftype = <span class="stringliteral">&#39;&#39;</span>;
<a name="l21290"></a>21290   $u = array();
<a name="l21291"></a>21291   <span class="keywordflow">foreach</span>($unicode AS $c =&gt; $char) {
<a name="l21292"></a>21292     <span class="keywordflow">if</span> ($char != 173 &amp;&amp; !isset($cw[$char]) &amp;&amp; (!isset($this-&gt;chrs[$char]) || !isset($cw[$this-&gt;chrs[$char]])) &amp;&amp;
<a name="l21293"></a>21293       ($char&lt;1423 || ($char&gt;3583 &amp;&amp; $char &lt; 11263))) { 
<a name="l21294"></a>21294       <span class="keywordflow">if</span> ($flag==0) { $start=$c; }
<a name="l21295"></a>21295       $flag=1; 
<a name="l21296"></a>21296       $u[] = $char;
<a name="l21297"></a>21297     }
<a name="l21298"></a>21298     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($flag==1) { $end=$c-1; <span class="keywordflow">break</span>; }
<a name="l21299"></a>21299   }
<a name="l21300"></a>21300   <span class="keywordflow">if</span> ($flag==1 &amp;&amp; !$end) { $end=count($unicode)-1; }
<a name="l21301"></a>21301   <span class="keywordflow">if</span> ($start==-1) { <span class="keywordflow">return</span> 0; }
<a name="l21302"></a>21302 
<a name="l21303"></a>21303   <span class="keywordflow">if</span> (!$this-&gt;subArrMB) { 
<a name="l21304"></a>21304     include(_MPDF_PATH.<span class="stringliteral">&#39;includes/subs_core.php&#39;</span>); 
<a name="l21305"></a>21305     $this-&gt;subArrMB[<span class="charliteral">&#39;a&#39;</span>] = $aarr;
<a name="l21306"></a>21306     $this-&gt;subArrMB[<span class="charliteral">&#39;s&#39;</span>] = $sarr;
<a name="l21307"></a>21307     $this-&gt;subArrMB[<span class="charliteral">&#39;z&#39;</span>] = $zarr;
<a name="l21308"></a>21308   }
<a name="l21309"></a>21309   <span class="comment">// TRY CORE FONTS FIRST</span>
<a name="l21310"></a>21310   <span class="keywordflow">if</span> (isset($this-&gt;subArrMB[<span class="charliteral">&#39;a&#39;</span>][$u[0]])) { 
<a name="l21311"></a>21311     $font = <span class="stringliteral">&#39;tta&#39;</span>; $ftype = <span class="charliteral">&#39;C&#39;</span>; 
<a name="l21312"></a>21312     <span class="keywordflow">foreach</span>($u AS $char) {
<a name="l21313"></a>21313       <span class="keywordflow">if</span> ($this-&gt;subArrMB[<span class="charliteral">&#39;a&#39;</span>][$char]) { $repl[] = $this-&gt;subArrMB[<span class="charliteral">&#39;a&#39;</span>][$char]; }
<a name="l21314"></a>21314       <span class="keywordflow">else</span> { <span class="keywordflow">break</span>; }
<a name="l21315"></a>21315     }
<a name="l21316"></a>21316   }
<a name="l21317"></a>21317   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;subArrMB[<span class="charliteral">&#39;z&#39;</span>][$u[0]])) { 
<a name="l21318"></a>21318     $font = <span class="stringliteral">&#39;ttz&#39;</span>; $ftype = <span class="charliteral">&#39;C&#39;</span>; 
<a name="l21319"></a>21319     <span class="keywordflow">foreach</span>($u AS $char) {
<a name="l21320"></a>21320       <span class="keywordflow">if</span> ($this-&gt;subArrMB[<span class="charliteral">&#39;z&#39;</span>][$char]) { $repl[] = $this-&gt;subArrMB[<span class="charliteral">&#39;z&#39;</span>][$char]; }
<a name="l21321"></a>21321       <span class="keywordflow">else</span> { <span class="keywordflow">break</span>; }
<a name="l21322"></a>21322     }
<a name="l21323"></a>21323   }
<a name="l21324"></a>21324   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($this-&gt;subArrMB[<span class="charliteral">&#39;s&#39;</span>][$u[0]])) { 
<a name="l21325"></a>21325     $font = <span class="stringliteral">&#39;tts&#39;</span>; $ftype = <span class="charliteral">&#39;C&#39;</span>; 
<a name="l21326"></a>21326     <span class="keywordflow">foreach</span>($u AS $char) {
<a name="l21327"></a>21327       <span class="keywordflow">if</span> ($this-&gt;subArrMB[<span class="charliteral">&#39;s&#39;</span>][$char]) { $repl[] = $this-&gt;subArrMB[<span class="charliteral">&#39;s&#39;</span>][$char]; }
<a name="l21328"></a>21328       <span class="keywordflow">else</span> { <span class="keywordflow">break</span>; }
<a name="l21329"></a>21329     }
<a name="l21330"></a>21330   }
<a name="l21331"></a>21331   <span class="keywordflow">if</span> ($ftype==<span class="charliteral">&#39;C&#39;</span>) {
<a name="l21332"></a>21332     $patt = mb_substr($writehtml_e, $start, count($repl));
<a name="l21333"></a>21333     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&quot;/(.*?)(&quot;</span>.preg_quote($patt,<span class="charliteral">&#39;/&#39;</span>).<span class="stringliteral">&quot;)(.*)/u&quot;</span>, $writehtml_e, $m)) {
<a name="l21334"></a>21334       $writehtml_e = $m[1];
<a name="l21335"></a>21335       array_splice($writehtml_a, $writehtml_i+1, 0, array($font, implode(<span class="charliteral">&#39;|&#39;</span>, $repl), <span class="charliteral">&#39;/&#39;</span>.$font, $m[3])); <span class="comment">// e.g. &lt;tts&gt;</span>
<a name="l21336"></a>21336       $this-&gt;subPos = $writehtml_i+3;
<a name="l21337"></a>21337       <span class="keywordflow">return</span> 4;
<a name="l21338"></a>21338     }
<a name="l21339"></a>21339     <span class="keywordflow">return</span> 0;
<a name="l21340"></a>21340   }
<a name="l21341"></a>21341   <span class="comment">// ELSE FIND IN DEFAULT FONT</span>
<a name="l21342"></a>21342   <span class="keywordflow">if</span> (strtolower($this-&gt;CurrentFont[<span class="stringliteral">&#39;name&#39;</span>]) != $this-&gt;default_font) { $font = $this-&gt;default_font; }
<a name="l21343"></a>21343 
<a name="l21344"></a>21344   <span class="keywordflow">else</span> { unset($cw); <span class="keywordflow">return</span> 0; }  
<a name="l21345"></a>21345 
<a name="l21346"></a>21346   <span class="keywordflow">if</span> (isset($this-&gt;fonts[$font])) { $cw = &amp;$this-&gt;fonts[$font][<span class="stringliteral">&#39;cw&#39;</span>]; }
<a name="l21347"></a>21347   <span class="keywordflow">else</span> { @include(_MPDF_PATH.<span class="stringliteral">&#39;unifont/&#39;</span>.$font.<span class="stringliteral">&#39;.php&#39;</span>); }
<a name="l21348"></a>21348   <span class="keywordflow">if</span> (!$cw) { <span class="keywordflow">return</span> 0; }
<a name="l21349"></a>21349   $l = 0;
<a name="l21350"></a>21350   <span class="keywordflow">foreach</span>($u AS $char) {
<a name="l21351"></a>21351     <span class="keywordflow">if</span> ($char == 173 || isset($cw[$char]) || (isset($this-&gt;chrs[$char]) &amp;&amp; isset($cw[$this-&gt;chrs[$char]])) ||
<a name="l21352"></a>21352     ($char&gt;1422 &amp;&amp; $char&lt;3584) || $char &gt; 11262) { 
<a name="l21353"></a>21353       $l++;
<a name="l21354"></a>21354     }
<a name="l21355"></a>21355     <span class="keywordflow">else</span> { <span class="keywordflow">break</span>; }
<a name="l21356"></a>21356   }
<a name="l21357"></a>21357   $patt = mb_substr($writehtml_e, $start, $l);
<a name="l21358"></a>21358   <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&quot;/(.*?)(&quot;</span>.preg_quote($patt,<span class="charliteral">&#39;/&#39;</span>).<span class="stringliteral">&quot;)(.*)/u&quot;</span>, $writehtml_e, $m)) {
<a name="l21359"></a>21359     $writehtml_e = $m[1];
<a name="l21360"></a>21360     array_splice($writehtml_a, $writehtml_i+1, 0, array(<span class="stringliteral">&#39;span style=&quot;font-family: &#39;</span>.$font.<span class="charliteral">&#39;&quot;&#39;</span>, $m[2], <span class="stringliteral">&#39;/span&#39;</span>, $m[3]));
<a name="l21361"></a>21361     $this-&gt;subPos = $writehtml_i+3;
<a name="l21362"></a>21362     <span class="keywordflow">return</span> 4;
<a name="l21363"></a>21363   }
<a name="l21364"></a>21364   <span class="keywordflow">return</span> 0;
<a name="l21365"></a>21365 }
<a name="l21366"></a>21366 
<a name="l21367"></a>21367 function setHiEntitySubstitutions() {
<a name="l21368"></a>21368   $entarr = array (
<a name="l21369"></a>21369   <span class="stringliteral">&#39;nbsp&#39;</span> =&gt; <span class="stringliteral">&#39;160&#39;</span>,  <span class="stringliteral">&#39;iexcl&#39;</span> =&gt; <span class="stringliteral">&#39;161&#39;</span>,  <span class="stringliteral">&#39;cent&#39;</span> =&gt; <span class="stringliteral">&#39;162&#39;</span>,  <span class="stringliteral">&#39;pound&#39;</span> =&gt; <span class="stringliteral">&#39;163&#39;</span>,  <span class="stringliteral">&#39;curren&#39;</span> =&gt; <span class="stringliteral">&#39;164&#39;</span>,  <span class="stringliteral">&#39;yen&#39;</span> =&gt; <span class="stringliteral">&#39;165&#39;</span>,  <span class="stringliteral">&#39;brvbar&#39;</span> =&gt; <span class="stringliteral">&#39;166&#39;</span>,  <span class="stringliteral">&#39;sect&#39;</span> =&gt; <span class="stringliteral">&#39;167&#39;</span>,
<a name="l21370"></a>21370   <span class="stringliteral">&#39;uml&#39;</span> =&gt; <span class="stringliteral">&#39;168&#39;</span>,  <span class="stringliteral">&#39;copy&#39;</span> =&gt; <span class="stringliteral">&#39;169&#39;</span>,  <span class="stringliteral">&#39;ordf&#39;</span> =&gt; <span class="stringliteral">&#39;170&#39;</span>,  <span class="stringliteral">&#39;laquo&#39;</span> =&gt; <span class="stringliteral">&#39;171&#39;</span>,  <span class="stringliteral">&#39;not&#39;</span> =&gt; <span class="stringliteral">&#39;172&#39;</span>,  <span class="stringliteral">&#39;shy&#39;</span> =&gt; <span class="stringliteral">&#39;173&#39;</span>,  <span class="stringliteral">&#39;reg&#39;</span> =&gt; <span class="stringliteral">&#39;174&#39;</span>,  <span class="stringliteral">&#39;macr&#39;</span> =&gt; <span class="stringliteral">&#39;175&#39;</span>,
<a name="l21371"></a>21371   <span class="stringliteral">&#39;deg&#39;</span> =&gt; <span class="stringliteral">&#39;176&#39;</span>,  <span class="stringliteral">&#39;plusmn&#39;</span> =&gt; <span class="stringliteral">&#39;177&#39;</span>,  <span class="stringliteral">&#39;sup2&#39;</span> =&gt; <span class="stringliteral">&#39;178&#39;</span>,  <span class="stringliteral">&#39;sup3&#39;</span> =&gt; <span class="stringliteral">&#39;179&#39;</span>,  <span class="stringliteral">&#39;acute&#39;</span> =&gt; <span class="stringliteral">&#39;180&#39;</span>,  <span class="stringliteral">&#39;micro&#39;</span> =&gt; <span class="stringliteral">&#39;181&#39;</span>,  <span class="stringliteral">&#39;para&#39;</span> =&gt; <span class="stringliteral">&#39;182&#39;</span>,  <span class="stringliteral">&#39;middot&#39;</span> =&gt; <span class="stringliteral">&#39;183&#39;</span>,
<a name="l21372"></a>21372   <span class="stringliteral">&#39;cedil&#39;</span> =&gt; <span class="stringliteral">&#39;184&#39;</span>,  <span class="stringliteral">&#39;sup1&#39;</span> =&gt; <span class="stringliteral">&#39;185&#39;</span>,  <span class="stringliteral">&#39;ordm&#39;</span> =&gt; <span class="stringliteral">&#39;186&#39;</span>,  <span class="stringliteral">&#39;raquo&#39;</span> =&gt; <span class="stringliteral">&#39;187&#39;</span>,  <span class="stringliteral">&#39;frac14&#39;</span> =&gt; <span class="stringliteral">&#39;188&#39;</span>,  <span class="stringliteral">&#39;frac12&#39;</span> =&gt; <span class="stringliteral">&#39;189&#39;</span>,  <span class="stringliteral">&#39;frac34&#39;</span> =&gt; <span class="stringliteral">&#39;190&#39;</span>,
<a name="l21373"></a>21373   <span class="stringliteral">&#39;iquest&#39;</span> =&gt; <span class="stringliteral">&#39;191&#39;</span>,  <span class="stringliteral">&#39;Agrave&#39;</span> =&gt; <span class="stringliteral">&#39;192&#39;</span>,  <span class="stringliteral">&#39;Aacute&#39;</span> =&gt; <span class="stringliteral">&#39;193&#39;</span>,  <span class="stringliteral">&#39;Acirc&#39;</span> =&gt; <span class="stringliteral">&#39;194&#39;</span>,  <span class="stringliteral">&#39;Atilde&#39;</span> =&gt; <span class="stringliteral">&#39;195&#39;</span>,  <span class="stringliteral">&#39;Auml&#39;</span> =&gt; <span class="stringliteral">&#39;196&#39;</span>,  <span class="stringliteral">&#39;Aring&#39;</span> =&gt; <span class="stringliteral">&#39;197&#39;</span>,
<a name="l21374"></a>21374   <span class="stringliteral">&#39;AElig&#39;</span> =&gt; <span class="stringliteral">&#39;198&#39;</span>,  <span class="stringliteral">&#39;Ccedil&#39;</span> =&gt; <span class="stringliteral">&#39;199&#39;</span>,  <span class="stringliteral">&#39;Egrave&#39;</span> =&gt; <span class="stringliteral">&#39;200&#39;</span>,  <span class="stringliteral">&#39;Eacute&#39;</span> =&gt; <span class="stringliteral">&#39;201&#39;</span>,  <span class="stringliteral">&#39;Ecirc&#39;</span> =&gt; <span class="stringliteral">&#39;202&#39;</span>,  <span class="stringliteral">&#39;Euml&#39;</span> =&gt; <span class="stringliteral">&#39;203&#39;</span>,  <span class="stringliteral">&#39;Igrave&#39;</span> =&gt; <span class="stringliteral">&#39;204&#39;</span>,
<a name="l21375"></a>21375   <span class="stringliteral">&#39;Iacute&#39;</span> =&gt; <span class="stringliteral">&#39;205&#39;</span>,  <span class="stringliteral">&#39;Icirc&#39;</span> =&gt; <span class="stringliteral">&#39;206&#39;</span>,  <span class="stringliteral">&#39;Iuml&#39;</span> =&gt; <span class="stringliteral">&#39;207&#39;</span>,  <span class="stringliteral">&#39;ETH&#39;</span> =&gt; <span class="stringliteral">&#39;208&#39;</span>,  <span class="stringliteral">&#39;Ntilde&#39;</span> =&gt; <span class="stringliteral">&#39;209&#39;</span>,  <span class="stringliteral">&#39;Ograve&#39;</span> =&gt; <span class="stringliteral">&#39;210&#39;</span>,  <span class="stringliteral">&#39;Oacute&#39;</span> =&gt; <span class="stringliteral">&#39;211&#39;</span>,
<a name="l21376"></a>21376   <span class="stringliteral">&#39;Ocirc&#39;</span> =&gt; <span class="stringliteral">&#39;212&#39;</span>,  <span class="stringliteral">&#39;Otilde&#39;</span> =&gt; <span class="stringliteral">&#39;213&#39;</span>,  <span class="stringliteral">&#39;Ouml&#39;</span> =&gt; <span class="stringliteral">&#39;214&#39;</span>,  <span class="stringliteral">&#39;times&#39;</span> =&gt; <span class="stringliteral">&#39;215&#39;</span>,  <span class="stringliteral">&#39;Oslash&#39;</span> =&gt; <span class="stringliteral">&#39;216&#39;</span>,  <span class="stringliteral">&#39;Ugrave&#39;</span> =&gt; <span class="stringliteral">&#39;217&#39;</span>,  <span class="stringliteral">&#39;Uacute&#39;</span> =&gt; <span class="stringliteral">&#39;218&#39;</span>,
<a name="l21377"></a>21377   <span class="stringliteral">&#39;Ucirc&#39;</span> =&gt; <span class="stringliteral">&#39;219&#39;</span>,  <span class="stringliteral">&#39;Uuml&#39;</span> =&gt; <span class="stringliteral">&#39;220&#39;</span>,  <span class="stringliteral">&#39;Yacute&#39;</span> =&gt; <span class="stringliteral">&#39;221&#39;</span>,  <span class="stringliteral">&#39;THORN&#39;</span> =&gt; <span class="stringliteral">&#39;222&#39;</span>,  <span class="stringliteral">&#39;szlig&#39;</span> =&gt; <span class="stringliteral">&#39;223&#39;</span>,  <span class="stringliteral">&#39;agrave&#39;</span> =&gt; <span class="stringliteral">&#39;224&#39;</span>,  <span class="stringliteral">&#39;aacute&#39;</span> =&gt; <span class="stringliteral">&#39;225&#39;</span>,
<a name="l21378"></a>21378   <span class="stringliteral">&#39;acirc&#39;</span> =&gt; <span class="stringliteral">&#39;226&#39;</span>,  <span class="stringliteral">&#39;atilde&#39;</span> =&gt; <span class="stringliteral">&#39;227&#39;</span>,  <span class="stringliteral">&#39;auml&#39;</span> =&gt; <span class="stringliteral">&#39;228&#39;</span>,  <span class="stringliteral">&#39;aring&#39;</span> =&gt; <span class="stringliteral">&#39;229&#39;</span>,  <span class="stringliteral">&#39;aelig&#39;</span> =&gt; <span class="stringliteral">&#39;230&#39;</span>,  <span class="stringliteral">&#39;ccedil&#39;</span> =&gt; <span class="stringliteral">&#39;231&#39;</span>,  <span class="stringliteral">&#39;egrave&#39;</span> =&gt; <span class="stringliteral">&#39;232&#39;</span>,
<a name="l21379"></a>21379   <span class="stringliteral">&#39;eacute&#39;</span> =&gt; <span class="stringliteral">&#39;233&#39;</span>,  <span class="stringliteral">&#39;ecirc&#39;</span> =&gt; <span class="stringliteral">&#39;234&#39;</span>,  <span class="stringliteral">&#39;euml&#39;</span> =&gt; <span class="stringliteral">&#39;235&#39;</span>,  <span class="stringliteral">&#39;igrave&#39;</span> =&gt; <span class="stringliteral">&#39;236&#39;</span>,  <span class="stringliteral">&#39;iacute&#39;</span> =&gt; <span class="stringliteral">&#39;237&#39;</span>,  <span class="stringliteral">&#39;icirc&#39;</span> =&gt; <span class="stringliteral">&#39;238&#39;</span>,  <span class="stringliteral">&#39;iuml&#39;</span> =&gt; <span class="stringliteral">&#39;239&#39;</span>,
<a name="l21380"></a>21380   <span class="stringliteral">&#39;eth&#39;</span> =&gt; <span class="stringliteral">&#39;240&#39;</span>,  <span class="stringliteral">&#39;ntilde&#39;</span> =&gt; <span class="stringliteral">&#39;241&#39;</span>,  <span class="stringliteral">&#39;ograve&#39;</span> =&gt; <span class="stringliteral">&#39;242&#39;</span>,  <span class="stringliteral">&#39;oacute&#39;</span> =&gt; <span class="stringliteral">&#39;243&#39;</span>,  <span class="stringliteral">&#39;ocirc&#39;</span> =&gt; <span class="stringliteral">&#39;244&#39;</span>,  <span class="stringliteral">&#39;otilde&#39;</span> =&gt; <span class="stringliteral">&#39;245&#39;</span>,  <span class="stringliteral">&#39;ouml&#39;</span> =&gt; <span class="stringliteral">&#39;246&#39;</span>,
<a name="l21381"></a>21381   <span class="stringliteral">&#39;divide&#39;</span> =&gt; <span class="stringliteral">&#39;247&#39;</span>,  <span class="stringliteral">&#39;oslash&#39;</span> =&gt; <span class="stringliteral">&#39;248&#39;</span>,  <span class="stringliteral">&#39;ugrave&#39;</span> =&gt; <span class="stringliteral">&#39;249&#39;</span>,  <span class="stringliteral">&#39;uacute&#39;</span> =&gt; <span class="stringliteral">&#39;250&#39;</span>,  <span class="stringliteral">&#39;ucirc&#39;</span> =&gt; <span class="stringliteral">&#39;251&#39;</span>,  <span class="stringliteral">&#39;uuml&#39;</span> =&gt; <span class="stringliteral">&#39;252&#39;</span>,  <span class="stringliteral">&#39;yacute&#39;</span> =&gt; <span class="stringliteral">&#39;253&#39;</span>,
<a name="l21382"></a>21382   <span class="stringliteral">&#39;thorn&#39;</span> =&gt; <span class="stringliteral">&#39;254&#39;</span>,  <span class="stringliteral">&#39;yuml&#39;</span> =&gt; <span class="stringliteral">&#39;255&#39;</span>,  <span class="stringliteral">&#39;OElig&#39;</span> =&gt; <span class="stringliteral">&#39;338&#39;</span>,  <span class="stringliteral">&#39;oelig&#39;</span> =&gt; <span class="stringliteral">&#39;339&#39;</span>,  <span class="stringliteral">&#39;Scaron&#39;</span> =&gt; <span class="stringliteral">&#39;352&#39;</span>,  <span class="stringliteral">&#39;scaron&#39;</span> =&gt; <span class="stringliteral">&#39;353&#39;</span>,  <span class="stringliteral">&#39;Yuml&#39;</span> =&gt; <span class="stringliteral">&#39;376&#39;</span>,
<a name="l21383"></a>21383   <span class="stringliteral">&#39;fnof&#39;</span> =&gt; <span class="stringliteral">&#39;402&#39;</span>,  <span class="stringliteral">&#39;circ&#39;</span> =&gt; <span class="stringliteral">&#39;710&#39;</span>,  <span class="stringliteral">&#39;tilde&#39;</span> =&gt; <span class="stringliteral">&#39;732&#39;</span>,  <span class="stringliteral">&#39;Alpha&#39;</span> =&gt; <span class="stringliteral">&#39;913&#39;</span>,  <span class="stringliteral">&#39;Beta&#39;</span> =&gt; <span class="stringliteral">&#39;914&#39;</span>,  <span class="stringliteral">&#39;Gamma&#39;</span> =&gt; <span class="stringliteral">&#39;915&#39;</span>,  <span class="stringliteral">&#39;Delta&#39;</span> =&gt; <span class="stringliteral">&#39;916&#39;</span>,
<a name="l21384"></a>21384   <span class="stringliteral">&#39;Epsilon&#39;</span> =&gt; <span class="stringliteral">&#39;917&#39;</span>,  <span class="stringliteral">&#39;Zeta&#39;</span> =&gt; <span class="stringliteral">&#39;918&#39;</span>,  <span class="stringliteral">&#39;Eta&#39;</span> =&gt; <span class="stringliteral">&#39;919&#39;</span>,  <span class="stringliteral">&#39;Theta&#39;</span> =&gt; <span class="stringliteral">&#39;920&#39;</span>,  <span class="stringliteral">&#39;Iota&#39;</span> =&gt; <span class="stringliteral">&#39;921&#39;</span>,  <span class="stringliteral">&#39;Kappa&#39;</span> =&gt; <span class="stringliteral">&#39;922&#39;</span>,  <span class="stringliteral">&#39;Lambda&#39;</span> =&gt; <span class="stringliteral">&#39;923&#39;</span>,
<a name="l21385"></a>21385   <span class="stringliteral">&#39;Mu&#39;</span> =&gt; <span class="stringliteral">&#39;924&#39;</span>,  <span class="stringliteral">&#39;Nu&#39;</span> =&gt; <span class="stringliteral">&#39;925&#39;</span>,  <span class="stringliteral">&#39;Xi&#39;</span> =&gt; <span class="stringliteral">&#39;926&#39;</span>,  <span class="stringliteral">&#39;Omicron&#39;</span> =&gt; <span class="stringliteral">&#39;927&#39;</span>,  <span class="stringliteral">&#39;Pi&#39;</span> =&gt; <span class="stringliteral">&#39;928&#39;</span>,  <span class="stringliteral">&#39;Rho&#39;</span> =&gt; <span class="stringliteral">&#39;929&#39;</span>,  <span class="stringliteral">&#39;Sigma&#39;</span> =&gt; <span class="stringliteral">&#39;931&#39;</span>,  <span class="stringliteral">&#39;Tau&#39;</span> =&gt; <span class="stringliteral">&#39;932&#39;</span>,
<a name="l21386"></a>21386   <span class="stringliteral">&#39;Upsilon&#39;</span> =&gt; <span class="stringliteral">&#39;933&#39;</span>,  <span class="stringliteral">&#39;Phi&#39;</span> =&gt; <span class="stringliteral">&#39;934&#39;</span>,  <span class="stringliteral">&#39;Chi&#39;</span> =&gt; <span class="stringliteral">&#39;935&#39;</span>,  <span class="stringliteral">&#39;Psi&#39;</span> =&gt; <span class="stringliteral">&#39;936&#39;</span>,  <span class="stringliteral">&#39;Omega&#39;</span> =&gt; <span class="stringliteral">&#39;937&#39;</span>,  <span class="stringliteral">&#39;alpha&#39;</span> =&gt; <span class="stringliteral">&#39;945&#39;</span>,  <span class="stringliteral">&#39;beta&#39;</span> =&gt; <span class="stringliteral">&#39;946&#39;</span>,  <span class="stringliteral">&#39;gamma&#39;</span> =&gt; <span class="stringliteral">&#39;947&#39;</span>,
<a name="l21387"></a>21387   <span class="stringliteral">&#39;delta&#39;</span> =&gt; <span class="stringliteral">&#39;948&#39;</span>,  <span class="stringliteral">&#39;epsilon&#39;</span> =&gt; <span class="stringliteral">&#39;949&#39;</span>,  <span class="stringliteral">&#39;zeta&#39;</span> =&gt; <span class="stringliteral">&#39;950&#39;</span>,  <span class="stringliteral">&#39;eta&#39;</span> =&gt; <span class="stringliteral">&#39;951&#39;</span>,  <span class="stringliteral">&#39;theta&#39;</span> =&gt; <span class="stringliteral">&#39;952&#39;</span>,  <span class="stringliteral">&#39;iota&#39;</span> =&gt; <span class="stringliteral">&#39;953&#39;</span>,  <span class="stringliteral">&#39;kappa&#39;</span> =&gt; <span class="stringliteral">&#39;954&#39;</span>,
<a name="l21388"></a>21388   <span class="stringliteral">&#39;lambda&#39;</span> =&gt; <span class="stringliteral">&#39;955&#39;</span>,  <span class="stringliteral">&#39;mu&#39;</span> =&gt; <span class="stringliteral">&#39;956&#39;</span>,  <span class="stringliteral">&#39;nu&#39;</span> =&gt; <span class="stringliteral">&#39;957&#39;</span>,  <span class="stringliteral">&#39;xi&#39;</span> =&gt; <span class="stringliteral">&#39;958&#39;</span>,  <span class="stringliteral">&#39;omicron&#39;</span> =&gt; <span class="stringliteral">&#39;959&#39;</span>,  <span class="stringliteral">&#39;pi&#39;</span> =&gt; <span class="stringliteral">&#39;960&#39;</span>,  <span class="stringliteral">&#39;rho&#39;</span> =&gt; <span class="stringliteral">&#39;961&#39;</span>,  <span class="stringliteral">&#39;sigmaf&#39;</span> =&gt; <span class="stringliteral">&#39;962&#39;</span>,
<a name="l21389"></a>21389   <span class="stringliteral">&#39;sigma&#39;</span> =&gt; <span class="stringliteral">&#39;963&#39;</span>,  <span class="stringliteral">&#39;tau&#39;</span> =&gt; <span class="stringliteral">&#39;964&#39;</span>,  <span class="stringliteral">&#39;upsilon&#39;</span> =&gt; <span class="stringliteral">&#39;965&#39;</span>,  <span class="stringliteral">&#39;phi&#39;</span> =&gt; <span class="stringliteral">&#39;966&#39;</span>,  <span class="stringliteral">&#39;chi&#39;</span> =&gt; <span class="stringliteral">&#39;967&#39;</span>,  <span class="stringliteral">&#39;psi&#39;</span> =&gt; <span class="stringliteral">&#39;968&#39;</span>,  <span class="stringliteral">&#39;omega&#39;</span> =&gt; <span class="stringliteral">&#39;969&#39;</span>,
<a name="l21390"></a>21390   <span class="stringliteral">&#39;thetasym&#39;</span> =&gt; <span class="stringliteral">&#39;977&#39;</span>,  <span class="stringliteral">&#39;upsih&#39;</span> =&gt; <span class="stringliteral">&#39;978&#39;</span>,  <span class="stringliteral">&#39;piv&#39;</span> =&gt; <span class="stringliteral">&#39;982&#39;</span>,  <span class="stringliteral">&#39;ensp&#39;</span> =&gt; <span class="stringliteral">&#39;8194&#39;</span>,  <span class="stringliteral">&#39;emsp&#39;</span> =&gt; <span class="stringliteral">&#39;8195&#39;</span>,  <span class="stringliteral">&#39;thinsp&#39;</span> =&gt; <span class="stringliteral">&#39;8201&#39;</span>,  <span class="stringliteral">&#39;zwnj&#39;</span> =&gt; <span class="stringliteral">&#39;8204&#39;</span>,
<a name="l21391"></a>21391   <span class="stringliteral">&#39;zwj&#39;</span> =&gt; <span class="stringliteral">&#39;8205&#39;</span>,  <span class="stringliteral">&#39;lrm&#39;</span> =&gt; <span class="stringliteral">&#39;8206&#39;</span>,  <span class="stringliteral">&#39;rlm&#39;</span> =&gt; <span class="stringliteral">&#39;8207&#39;</span>,  <span class="stringliteral">&#39;ndash&#39;</span> =&gt; <span class="stringliteral">&#39;8211&#39;</span>,  <span class="stringliteral">&#39;mdash&#39;</span> =&gt; <span class="stringliteral">&#39;8212&#39;</span>,  <span class="stringliteral">&#39;lsquo&#39;</span> =&gt; <span class="stringliteral">&#39;8216&#39;</span>,  <span class="stringliteral">&#39;rsquo&#39;</span> =&gt; <span class="stringliteral">&#39;8217&#39;</span>,
<a name="l21392"></a>21392   <span class="stringliteral">&#39;sbquo&#39;</span> =&gt; <span class="stringliteral">&#39;8218&#39;</span>,  <span class="stringliteral">&#39;ldquo&#39;</span> =&gt; <span class="stringliteral">&#39;8220&#39;</span>,  <span class="stringliteral">&#39;rdquo&#39;</span> =&gt; <span class="stringliteral">&#39;8221&#39;</span>,  <span class="stringliteral">&#39;bdquo&#39;</span> =&gt; <span class="stringliteral">&#39;8222&#39;</span>,  <span class="stringliteral">&#39;dagger&#39;</span> =&gt; <span class="stringliteral">&#39;8224&#39;</span>,  <span class="stringliteral">&#39;Dagger&#39;</span> =&gt; <span class="stringliteral">&#39;8225&#39;</span>,  <span class="stringliteral">&#39;bull&#39;</span> =&gt; <span class="stringliteral">&#39;8226&#39;</span>,
<a name="l21393"></a>21393   <span class="stringliteral">&#39;hellip&#39;</span> =&gt; <span class="stringliteral">&#39;8230&#39;</span>,  <span class="stringliteral">&#39;permil&#39;</span> =&gt; <span class="stringliteral">&#39;8240&#39;</span>,  <span class="stringliteral">&#39;prime&#39;</span> =&gt; <span class="stringliteral">&#39;8242&#39;</span>,  <span class="stringliteral">&#39;Prime&#39;</span> =&gt; <span class="stringliteral">&#39;8243&#39;</span>,  <span class="stringliteral">&#39;lsaquo&#39;</span> =&gt; <span class="stringliteral">&#39;8249&#39;</span>,  <span class="stringliteral">&#39;rsaquo&#39;</span> =&gt; <span class="stringliteral">&#39;8250&#39;</span>,  <span class="stringliteral">&#39;oline&#39;</span> =&gt; <span class="stringliteral">&#39;8254&#39;</span>,
<a name="l21394"></a>21394   <span class="stringliteral">&#39;frasl&#39;</span> =&gt; <span class="stringliteral">&#39;8260&#39;</span>,  <span class="stringliteral">&#39;euro&#39;</span> =&gt; <span class="stringliteral">&#39;8364&#39;</span>,  <span class="stringliteral">&#39;image&#39;</span> =&gt; <span class="stringliteral">&#39;8465&#39;</span>,  <span class="stringliteral">&#39;weierp&#39;</span> =&gt; <span class="stringliteral">&#39;8472&#39;</span>,  <span class="stringliteral">&#39;real&#39;</span> =&gt; <span class="stringliteral">&#39;8476&#39;</span>,  <span class="stringliteral">&#39;trade&#39;</span> =&gt; <span class="stringliteral">&#39;8482&#39;</span>,  <span class="stringliteral">&#39;alefsym&#39;</span> =&gt; <span class="stringliteral">&#39;8501&#39;</span>,
<a name="l21395"></a>21395   <span class="stringliteral">&#39;larr&#39;</span> =&gt; <span class="stringliteral">&#39;8592&#39;</span>,  <span class="stringliteral">&#39;uarr&#39;</span> =&gt; <span class="stringliteral">&#39;8593&#39;</span>,  <span class="stringliteral">&#39;rarr&#39;</span> =&gt; <span class="stringliteral">&#39;8594&#39;</span>,  <span class="stringliteral">&#39;darr&#39;</span> =&gt; <span class="stringliteral">&#39;8595&#39;</span>,  <span class="stringliteral">&#39;harr&#39;</span> =&gt; <span class="stringliteral">&#39;8596&#39;</span>,  <span class="stringliteral">&#39;crarr&#39;</span> =&gt; <span class="stringliteral">&#39;8629&#39;</span>,  <span class="stringliteral">&#39;lArr&#39;</span> =&gt; <span class="stringliteral">&#39;8656&#39;</span>,
<a name="l21396"></a>21396   <span class="stringliteral">&#39;uArr&#39;</span> =&gt; <span class="stringliteral">&#39;8657&#39;</span>,  <span class="stringliteral">&#39;rArr&#39;</span> =&gt; <span class="stringliteral">&#39;8658&#39;</span>,  <span class="stringliteral">&#39;dArr&#39;</span> =&gt; <span class="stringliteral">&#39;8659&#39;</span>,  <span class="stringliteral">&#39;hArr&#39;</span> =&gt; <span class="stringliteral">&#39;8660&#39;</span>,  <span class="stringliteral">&#39;forall&#39;</span> =&gt; <span class="stringliteral">&#39;8704&#39;</span>,  <span class="stringliteral">&#39;part&#39;</span> =&gt; <span class="stringliteral">&#39;8706&#39;</span>,  <span class="stringliteral">&#39;exist&#39;</span> =&gt; <span class="stringliteral">&#39;8707&#39;</span>,
<a name="l21397"></a>21397   <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="stringliteral">&#39;8709&#39;</span>,  <span class="stringliteral">&#39;nabla&#39;</span> =&gt; <span class="stringliteral">&#39;8711&#39;</span>,  <span class="stringliteral">&#39;isin&#39;</span> =&gt; <span class="stringliteral">&#39;8712&#39;</span>,  <span class="stringliteral">&#39;notin&#39;</span> =&gt; <span class="stringliteral">&#39;8713&#39;</span>,  <span class="stringliteral">&#39;ni&#39;</span> =&gt; <span class="stringliteral">&#39;8715&#39;</span>,  <span class="stringliteral">&#39;prod&#39;</span> =&gt; <span class="stringliteral">&#39;8719&#39;</span>,  <span class="stringliteral">&#39;sum&#39;</span> =&gt; <span class="stringliteral">&#39;8721&#39;</span>,
<a name="l21398"></a>21398   <span class="stringliteral">&#39;minus&#39;</span> =&gt; <span class="stringliteral">&#39;8722&#39;</span>,  <span class="stringliteral">&#39;lowast&#39;</span> =&gt; <span class="stringliteral">&#39;8727&#39;</span>,  <span class="stringliteral">&#39;radic&#39;</span> =&gt; <span class="stringliteral">&#39;8730&#39;</span>,  <span class="stringliteral">&#39;prop&#39;</span> =&gt; <span class="stringliteral">&#39;8733&#39;</span>,  <span class="stringliteral">&#39;infin&#39;</span> =&gt; <span class="stringliteral">&#39;8734&#39;</span>,  <span class="stringliteral">&#39;ang&#39;</span> =&gt; <span class="stringliteral">&#39;8736&#39;</span>,  <span class="stringliteral">&#39;and&#39;</span> =&gt; <span class="stringliteral">&#39;8743&#39;</span>,
<a name="l21399"></a>21399   <span class="stringliteral">&#39;or&#39;</span> =&gt; <span class="stringliteral">&#39;8744&#39;</span>,  <span class="stringliteral">&#39;cap&#39;</span> =&gt; <span class="stringliteral">&#39;8745&#39;</span>,  <span class="stringliteral">&#39;cup&#39;</span> =&gt; <span class="stringliteral">&#39;8746&#39;</span>,  <span class="stringliteral">&#39;int&#39;</span> =&gt; <span class="stringliteral">&#39;8747&#39;</span>,  <span class="stringliteral">&#39;there4&#39;</span> =&gt; <span class="stringliteral">&#39;8756&#39;</span>,  <span class="stringliteral">&#39;sim&#39;</span> =&gt; <span class="stringliteral">&#39;8764&#39;</span>,  <span class="stringliteral">&#39;cong&#39;</span> =&gt; <span class="stringliteral">&#39;8773&#39;</span>,
<a name="l21400"></a>21400   <span class="stringliteral">&#39;asymp&#39;</span> =&gt; <span class="stringliteral">&#39;8776&#39;</span>,  <span class="stringliteral">&#39;ne&#39;</span> =&gt; <span class="stringliteral">&#39;8800&#39;</span>,  <span class="stringliteral">&#39;equiv&#39;</span> =&gt; <span class="stringliteral">&#39;8801&#39;</span>,  <span class="stringliteral">&#39;le&#39;</span> =&gt; <span class="stringliteral">&#39;8804&#39;</span>,  <span class="stringliteral">&#39;ge&#39;</span> =&gt; <span class="stringliteral">&#39;8805&#39;</span>,  <span class="stringliteral">&#39;sub&#39;</span> =&gt; <span class="stringliteral">&#39;8834&#39;</span>,  <span class="stringliteral">&#39;sup&#39;</span> =&gt; <span class="stringliteral">&#39;8835&#39;</span>,  <span class="stringliteral">&#39;nsub&#39;</span> =&gt; <span class="stringliteral">&#39;8836&#39;</span>,
<a name="l21401"></a>21401   <span class="stringliteral">&#39;sube&#39;</span> =&gt; <span class="stringliteral">&#39;8838&#39;</span>,  <span class="stringliteral">&#39;supe&#39;</span> =&gt; <span class="stringliteral">&#39;8839&#39;</span>,  <span class="stringliteral">&#39;oplus&#39;</span> =&gt; <span class="stringliteral">&#39;8853&#39;</span>,  <span class="stringliteral">&#39;otimes&#39;</span> =&gt; <span class="stringliteral">&#39;8855&#39;</span>,  <span class="stringliteral">&#39;perp&#39;</span> =&gt; <span class="stringliteral">&#39;8869&#39;</span>,  <span class="stringliteral">&#39;sdot&#39;</span> =&gt; <span class="stringliteral">&#39;8901&#39;</span>,  <span class="stringliteral">&#39;lceil&#39;</span> =&gt; <span class="stringliteral">&#39;8968&#39;</span>,
<a name="l21402"></a>21402   <span class="stringliteral">&#39;rceil&#39;</span> =&gt; <span class="stringliteral">&#39;8969&#39;</span>,  <span class="stringliteral">&#39;lfloor&#39;</span> =&gt; <span class="stringliteral">&#39;8970&#39;</span>,  <span class="stringliteral">&#39;rfloor&#39;</span> =&gt; <span class="stringliteral">&#39;8971&#39;</span>,  <span class="stringliteral">&#39;lang&#39;</span> =&gt; <span class="stringliteral">&#39;9001&#39;</span>,  <span class="stringliteral">&#39;rang&#39;</span> =&gt; <span class="stringliteral">&#39;9002&#39;</span>,  <span class="stringliteral">&#39;loz&#39;</span> =&gt; <span class="stringliteral">&#39;9674&#39;</span>,  <span class="stringliteral">&#39;spades&#39;</span> =&gt; <span class="stringliteral">&#39;9824&#39;</span>,
<a name="l21403"></a>21403   <span class="stringliteral">&#39;clubs&#39;</span> =&gt; <span class="stringliteral">&#39;9827&#39;</span>,  <span class="stringliteral">&#39;hearts&#39;</span> =&gt; <span class="stringliteral">&#39;9829&#39;</span>,  <span class="stringliteral">&#39;diams&#39;</span> =&gt; <span class="stringliteral">&#39;9830&#39;</span>,
<a name="l21404"></a>21404  );
<a name="l21405"></a>21405   <span class="keywordflow">foreach</span>($entarr AS $key =&gt; $val) {
<a name="l21406"></a>21406     $this-&gt;entsearch[] = <span class="charliteral">&#39;&amp;&#39;</span>.$key.<span class="charliteral">&#39;;&#39;</span>;
<a name="l21407"></a>21407     $this-&gt;entsubstitute[] = code2utf($val);
<a name="l21408"></a>21408   }
<a name="l21409"></a>21409 }
<a name="l21410"></a>21410 
<a name="l21411"></a>21411 function SubstituteHiEntities($html) {
<a name="l21412"></a>21412   <span class="comment">// converts html_entities &gt; ASCII 127 to unicode (defined in includes/pdf/config.php</span>
<a name="l21413"></a>21413   <span class="comment">// Leaves in particular &amp;lt; to distinguish from tag marker</span>
<a name="l21414"></a>21414   <span class="keywordflow">if</span> (count($this-&gt;entsearch)) {
<a name="l21415"></a>21415     $html = str_replace($this-&gt;entsearch,$this-&gt;entsubstitute,$html);
<a name="l21416"></a>21416   }
<a name="l21417"></a>21417   <span class="keywordflow">return</span> $html;
<a name="l21418"></a>21418 }
<a name="l21419"></a>21419 
<a name="l21420"></a>21420 
<a name="l21421"></a>21421 <span class="comment">// Edited v1.2 Pass by reference; option to continue if invalid UTF-8 chars</span>
<a name="l21422"></a>21422 function is_utf8(&amp;$string) {
<a name="l21423"></a>21423   <span class="keywordflow">if</span> ($string === mb_convert_encoding(mb_convert_encoding($string, <span class="stringliteral">&quot;UTF-32&quot;</span>, <span class="stringliteral">&quot;UTF-8&quot;</span>), <span class="stringliteral">&quot;UTF-8&quot;</span>, <span class="stringliteral">&quot;UTF-32&quot;</span>)) {
<a name="l21424"></a>21424     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l21425"></a>21425   } 
<a name="l21426"></a>21426   <span class="keywordflow">else</span> {
<a name="l21427"></a>21427     <span class="keywordflow">if</span> ($this-&gt;ignore_invalid_utf8) {
<a name="l21428"></a>21428     $string = mb_convert_encoding(mb_convert_encoding($string, <span class="stringliteral">&quot;UTF-32&quot;</span>, <span class="stringliteral">&quot;UTF-8&quot;</span>), <span class="stringliteral">&quot;UTF-8&quot;</span>, <span class="stringliteral">&quot;UTF-32&quot;</span>) ;
<a name="l21429"></a>21429     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l21430"></a>21430     }
<a name="l21431"></a>21431     <span class="keywordflow">else</span> {
<a name="l21432"></a>21432     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l21433"></a>21433     }
<a name="l21434"></a>21434   }
<a name="l21435"></a>21435 } 
<a name="l21436"></a>21436 
<a name="l21437"></a>21437 
<a name="l21438"></a>21438 function purify_utf8($html,$lo=<span class="keyword">true</span>) {
<a name="l21439"></a>21439   <span class="comment">// For HTML</span>
<a name="l21440"></a>21440   <span class="comment">// Checks string is valid UTF-8 encoded</span>
<a name="l21441"></a>21441   <span class="comment">// converts html_entities &gt; ASCII 127 to UTF-8</span>
<a name="l21442"></a>21442   <span class="comment">// Only exception - leaves low ASCII entities e.g. &amp;lt; &amp;amp; etc.</span>
<a name="l21443"></a>21443   <span class="comment">// Leaves in particular &amp;lt; to distinguish from tag marker</span>
<a name="l21444"></a>21444   <span class="keywordflow">if</span> (!$this-&gt;is_utf8($html)) { $this-&gt;Error(<span class="stringliteral">&quot;HTML contains invalid UTF-8 character(s)&quot;</span>); }
<a name="l21445"></a>21445   $html = preg_replace(<span class="stringliteral">&quot;/\r/&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, $html );
<a name="l21446"></a>21446 
<a name="l21447"></a>21447   <span class="comment">// converts html_entities &gt; ASCII 127 to UTF-8 </span>
<a name="l21448"></a>21448   <span class="comment">// Leaves in particular &amp;lt; to distinguish from tag marker</span>
<a name="l21449"></a>21449   $html = $this-&gt;SubstituteHiEntities($html);
<a name="l21450"></a>21450 
<a name="l21451"></a>21451   <span class="comment">// converts all &amp;#nnn; or &amp;#xHHH; to UTF-8 multibyte</span>
<a name="l21452"></a>21452   <span class="comment">// If $lo==true then includes ASCII &lt; 128</span>
<a name="l21453"></a>21453   $html = strcode2utf($html,$lo); 
<a name="l21454"></a>21454 
<a name="l21455"></a>21455 
<a name="l21456"></a>21456   <span class="keywordflow">return</span> ($html);
<a name="l21457"></a>21457 }
<a name="l21458"></a>21458 
<a name="l21459"></a>21459 function purify_utf8_text($txt) {
<a name="l21460"></a>21460   <span class="comment">// For TEXT</span>
<a name="l21461"></a>21461   <span class="comment">// Make sure UTF-8 string of characters</span>
<a name="l21462"></a>21462   <span class="keywordflow">if</span> (!$this-&gt;is_utf8($txt)) { $this-&gt;Error(<span class="stringliteral">&quot;Text contains invalid UTF-8 character(s)&quot;</span>); }
<a name="l21463"></a>21463 
<a name="l21464"></a>21464   $txt = preg_replace(<span class="stringliteral">&quot;/\r/&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, $txt );
<a name="l21465"></a>21465 
<a name="l21466"></a>21466 
<a name="l21467"></a>21467   <span class="keywordflow">return</span> ($txt);
<a name="l21468"></a>21468 }
<a name="l21469"></a>21469 function all_entities_to_utf8($txt) {
<a name="l21470"></a>21470   <span class="comment">// converts txt_entities &gt; ASCII 127 to UTF-8 </span>
<a name="l21471"></a>21471   <span class="comment">// Leaves in particular &amp;lt; to distinguish from tag marker</span>
<a name="l21472"></a>21472   $txt = $this-&gt;SubstituteHiEntities($txt);
<a name="l21473"></a>21473 
<a name="l21474"></a>21474   <span class="comment">// converts all &amp;#nnn; or &amp;#xHHH; to UTF-8 multibyte</span>
<a name="l21475"></a>21475   $txt = strcode2utf($txt); 
<a name="l21476"></a>21476 
<a name="l21477"></a>21477 
<a name="l21478"></a>21478   $txt = $this-&gt;lesser_entity_decode($txt);
<a name="l21479"></a>21479   <span class="keywordflow">return</span> ($txt);
<a name="l21480"></a>21480 }
<a name="l21481"></a>21481 
<a name="l21482"></a>21482     
<a name="l21483"></a>21483 
<a name="l21484"></a>21484 <span class="comment">// ====================================================</span>
<a name="l21485"></a>21485 
<a name="l21486"></a>21486 <span class="comment">// ====================================================</span>
<a name="l21487"></a>21487 <span class="comment">// ====================================================</span>
<a name="l21488"></a>21488 
<a name="l21489"></a>21489     <span class="comment">// START TRANSFORMATIONS SECTION -----------------------</span>
<a name="l21490"></a>21490     <span class="comment">// authors: Moritz Wagner, Andreas Wurmser, Nicola Asuni</span>
<a name="l21491"></a>21491     <span class="comment">// From TCPDF</span>
<a name="l21492"></a>21492     <span class="comment">// Starts a 2D tranformation saving current graphic state.</span>
<a name="l21493"></a>21493     function StartTransform($returnstring=<span class="keyword">false</span>) {
<a name="l21494"></a>21494       <span class="keywordflow">if</span> ($returnstring) { <span class="keywordflow">return</span>(<span class="charliteral">&#39;q&#39;</span>); }
<a name="l21495"></a>21495       <span class="keywordflow">else</span> { $this-&gt;_out(<span class="charliteral">&#39;q&#39;</span>); }
<a name="l21496"></a>21496     }
<a name="l21497"></a>21497     
<a name="l21498"></a>21498     function StopTransform($returnstring=<span class="keyword">false</span>) {
<a name="l21499"></a>21499       <span class="keywordflow">if</span> ($returnstring) { <span class="keywordflow">return</span>(<span class="charliteral">&#39;Q&#39;</span>); }
<a name="l21500"></a>21500       <span class="keywordflow">else</span> { $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>); }
<a name="l21501"></a>21501     }
<a name="l21502"></a>21502     
<a name="l21503"></a>21503     <span class="comment">// Vertical and horizontal non-proportional Scaling.</span>
<a name="l21504"></a>21504     function transformScale($s_x, $s_y, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $returnstring=<span class="keyword">false</span>) {
<a name="l21505"></a>21505       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l21506"></a>21506         $x=$this-&gt;x;
<a name="l21507"></a>21507       }
<a name="l21508"></a>21508       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l21509"></a>21509         $y=$this-&gt;y;
<a name="l21510"></a>21510       }
<a name="l21511"></a>21511       <span class="keywordflow">if</span> (($s_x == 0) OR ($s_y == 0)) {
<a name="l21512"></a>21512         $this-&gt;Error(<span class="stringliteral">&#39;Please do not use values equal to zero for scaling&#39;</span>);
<a name="l21513"></a>21513       }
<a name="l21514"></a>21514       $y = ($this-&gt;h - $y) * $this-&gt;k;
<a name="l21515"></a>21515       $x *= $this-&gt;k;
<a name="l21516"></a>21516       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l21517"></a>21517       $s_x /= 100;
<a name="l21518"></a>21518       $s_y /= 100;
<a name="l21519"></a>21519       $tm[0] = $s_x;
<a name="l21520"></a>21520       $tm[1] = 0;
<a name="l21521"></a>21521       $tm[2] = 0;
<a name="l21522"></a>21522       $tm[3] = $s_y;
<a name="l21523"></a>21523       $tm[4] = $x * (1 - $s_x);
<a name="l21524"></a>21524       $tm[5] = $y * (1 - $s_y);
<a name="l21525"></a>21525       <span class="comment">//scale the coordinate system</span>
<a name="l21526"></a>21526       <span class="keywordflow">if</span> ($returnstring) { <span class="keywordflow">return</span>($this-&gt;_transform($tm, <span class="keyword">true</span>)); }
<a name="l21527"></a>21527       <span class="keywordflow">else</span> { $this-&gt;_transform($tm); }
<a name="l21528"></a>21528     }
<a name="l21529"></a>21529     
<a name="l21530"></a>21530     
<a name="l21531"></a>21531     <span class="comment">// Translate graphic object horizontally and vertically.</span>
<a name="l21532"></a>21532     function transformTranslate($t_x, $t_y, $returnstring=<span class="keyword">false</span>) {
<a name="l21533"></a>21533       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l21534"></a>21534       $tm[0] = 1;
<a name="l21535"></a>21535       $tm[1] = 0;
<a name="l21536"></a>21536       $tm[2] = 0;
<a name="l21537"></a>21537       $tm[3] = 1;
<a name="l21538"></a>21538       $tm[4] = $t_x * $this-&gt;k;
<a name="l21539"></a>21539       $tm[5] = -$t_y * $this-&gt;k;
<a name="l21540"></a>21540       <span class="comment">//translate the coordinate system</span>
<a name="l21541"></a>21541       <span class="keywordflow">if</span> ($returnstring) { <span class="keywordflow">return</span>($this-&gt;_transform($tm, <span class="keyword">true</span>)); }
<a name="l21542"></a>21542       <span class="keywordflow">else</span> { $this-&gt;_transform($tm); }
<a name="l21543"></a>21543     }
<a name="l21544"></a>21544     
<a name="l21545"></a>21545     <span class="comment">// Rotate object.</span>
<a name="l21546"></a>21546     function transformRotate($angle, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $returnstring=<span class="keyword">false</span>) {
<a name="l21547"></a>21547       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l21548"></a>21548         $x=$this-&gt;x;
<a name="l21549"></a>21549       }
<a name="l21550"></a>21550       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l21551"></a>21551         $y=$this-&gt;y;
<a name="l21552"></a>21552       }
<a name="l21553"></a>21553       $angle = -$angle;
<a name="l21554"></a>21554       $y = ($this-&gt;h - $y) * $this-&gt;k;
<a name="l21555"></a>21555       $x *= $this-&gt;k;
<a name="l21556"></a>21556       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l21557"></a>21557       $tm[0] = cos(deg2rad($angle));
<a name="l21558"></a>21558       $tm[1] = sin(deg2rad($angle));
<a name="l21559"></a>21559       $tm[2] = -$tm[1];
<a name="l21560"></a>21560       $tm[3] = $tm[0];
<a name="l21561"></a>21561       $tm[4] = $x + $tm[1] * $y - $tm[0] * $x;
<a name="l21562"></a>21562       $tm[5] = $y - $tm[0] * $y - $tm[1] * $x;
<a name="l21563"></a>21563       <span class="comment">//rotate the coordinate system around ($x,$y)</span>
<a name="l21564"></a>21564       <span class="keywordflow">if</span> ($returnstring) { <span class="keywordflow">return</span>($this-&gt;_transform($tm, <span class="keyword">true</span>)); }
<a name="l21565"></a>21565       <span class="keywordflow">else</span> { $this-&gt;_transform($tm); }
<a name="l21566"></a>21566     }
<a name="l21567"></a>21567     
<a name="l21568"></a>21568     
<a name="l21569"></a>21569     function _transform($tm, $returnstring=<span class="keyword">false</span>) {
<a name="l21570"></a>21570       <span class="keywordflow">if</span> ($returnstring) { <span class="keywordflow">return</span>(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f cm&#39;</span>, $tm[0], $tm[1], $tm[2], $tm[3], $tm[4], $tm[5])); }
<a name="l21571"></a>21571       <span class="keywordflow">else</span> { $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f cm&#39;</span>, $tm[0], $tm[1], $tm[2], $tm[3], $tm[4], $tm[5])); }
<a name="l21572"></a>21572     }
<a name="l21573"></a>21573     
<a name="l21574"></a>21574     <span class="comment">// END TRANSFORMATIONS SECTION -------------------------</span>
<a name="l21575"></a>21575 
<a name="l21576"></a>21576 
<a name="l21577"></a>21577 
<a name="l21578"></a>21578 
<a name="l21579"></a>21579 <span class="comment">// AUTOFONT =========================</span>
<a name="l21580"></a>21580 function AutoFont($html) {
<a name="l21581"></a>21581   <span class="keywordflow">if</span> ( !$this-&gt;is_MB ) { <span class="keywordflow">return</span> $html; }
<a name="l21582"></a>21582   $this-&gt;useLang = <span class="keyword">true</span>;
<a name="l21583"></a>21583   <span class="keywordflow">if</span> ($this-&gt;autoFontGroupSize == 1) { $extra = $this-&gt;pregASCIIchars1; }
<a name="l21584"></a>21584   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;autoFontGroupSize == 3) { $extra = $this-&gt;pregASCIIchars3; }
<a name="l21585"></a>21585   <span class="keywordflow">else</span> {  $extra = $this-&gt;pregASCIIchars2; }
<a name="l21586"></a>21586   $n = <span class="stringliteral">&#39;&#39;</span>;
<a name="l21587"></a>21587   $a=preg_split(<span class="stringliteral">&#39;/&lt;(.*?)&gt;/ms&#39;</span>,$html,-1,PREG_SPLIT_DELIM_CAPTURE);
<a name="l21588"></a>21588   <span class="keywordflow">foreach</span>($a as $i =&gt; $e) {
<a name="l21589"></a>21589      <span class="keywordflow">if</span>($i%2==0) {
<a name="l21590"></a>21590     <span class="comment">// mPDF 3.0 </span>
<a name="l21591"></a>21591     $e = strcode2utf($e); 
<a name="l21592"></a>21592     $e = $this-&gt;lesser_entity_decode($e);
<a name="l21593"></a>21593 
<a name="l21594"></a>21594     <span class="comment">// mPDF 4.0 Use U=FFF0 and U+FFF1 to mark start and end of span tags to prevent nesting occurring</span>
<a name="l21595"></a>21595     <span class="comment">// &quot;\xef\xbf\xb0&quot; ##lthtmltag## &quot;\xef\xbf\xb1&quot; ##gthtmltag##</span>
<a name="l21596"></a>21596 
<a name="l21597"></a>21597 
<a name="l21598"></a>21598 
<a name="l21599"></a>21599 
<a name="l21600"></a>21600 
<a name="l21601"></a>21601     <span class="comment">// mPDF 4.0 Moved so Vietnamese detection better</span>
<a name="l21602"></a>21602     <span class="keywordflow">if</span> ($this-&gt;autoFontGroups &amp; AUTOFONT_THAIVIET) {
<a name="l21603"></a>21603       <span class="comment">// THAI</span>
<a name="l21604"></a>21604       $e = preg_replace(<span class="stringliteral">&quot;/([\x{0E00}-\x{0E7F}&quot;</span>.$extra.<span class="stringliteral">&quot;]*[\x{0E00}-\x{0E7F}][\x{0E00}-\x{0E7F}&quot;</span>.$extra.<span class="stringliteral">&quot;]*)/u&quot;</span>, <span class="stringliteral">&quot;\xef\xbf\xb0span lang=\&quot;th\&quot;\xef\xbf\xb1\\1\xef\xbf\xb0/span\xef\xbf\xb1&quot;</span>, $e);
<a name="l21605"></a>21605       <span class="comment">// Vietnamese</span>
<a name="l21606"></a>21606       $e = preg_replace(<span class="stringliteral">&quot;/([&quot;</span>.$this-&gt;pregVIETchars .$this-&gt;pregVIETPluschars .<span class="stringliteral">&quot;]*[&quot;</span>.$this-&gt;pregVIETchars .<span class="stringliteral">&quot;][&quot;</span>.$this-&gt;pregVIETchars .$this-&gt;pregVIETPluschars .<span class="stringliteral">&quot;]*)/u&quot;</span>, <span class="stringliteral">&quot;\xef\xbf\xb0span lang=\&quot;vi\&quot;\xef\xbf\xb1\\1\xef\xbf\xb0/span\xef\xbf\xb1&quot;</span>, $e);  
<a name="l21607"></a>21607     }
<a name="l21608"></a>21608 
<a name="l21609"></a>21609     <span class="comment">// mPDF 3.0 </span>
<a name="l21610"></a>21610     $e = preg_replace(<span class="stringliteral">&#39;/[&amp;]/u&#39;</span>,<span class="stringliteral">&#39;&amp;amp;&#39;</span>,$e);
<a name="l21611"></a>21611     $e = preg_replace(<span class="stringliteral">&#39;/[&lt;]/u&#39;</span>,<span class="stringliteral">&#39;&amp;lt;&#39;</span>,$e);
<a name="l21612"></a>21612     $e = preg_replace(<span class="stringliteral">&#39;/[&gt;]/u&#39;</span>,<span class="stringliteral">&#39;&amp;gt;&#39;</span>,$e);
<a name="l21613"></a>21613     <span class="comment">// mPDF 4.0</span>
<a name="l21614"></a>21614     $e = preg_replace(<span class="stringliteral">&quot;/(\xef\xbf\xb0span lang=\&quot;([a-z\-A-Z]{2,5})\&quot;\xef\xbf\xb1)\s+/&quot;</span>,<span class="stringliteral">&#39; \\1&#39;</span>,$e);
<a name="l21615"></a>21615     $e = preg_replace(<span class="stringliteral">&quot;/[ ]+(\xef\xbf\xb0\/span\xef\xbf\xb1)/&quot;</span>,<span class="stringliteral">&#39;\\1 &#39;</span>,$e);  <span class="comment">// mPDF 4.3.012C</span>
<a name="l21616"></a>21616 
<a name="l21617"></a>21617     $e = preg_replace(<span class="stringliteral">&quot;/\xef\xbf\xb0span lang=\&quot;([a-z\-A-Z]{2,5})\&quot;\xef\xbf\xb1/&quot;</span>,<span class="stringliteral">&quot;\xef\xbf\xb0span lang=\&quot;\\1\&quot; class=\&quot;lang_\\1\&quot;\xef\xbf\xb1&quot;</span>,$e);
<a name="l21618"></a>21618 
<a name="l21619"></a>21619     $e = preg_replace(<span class="stringliteral">&quot;/\xef\xbf\xb0/&quot;</span>,<span class="charliteral">&#39;&lt;&#39;</span>,$e);
<a name="l21620"></a>21620     $e = preg_replace(<span class="stringliteral">&quot;/\xef\xbf\xb1/&quot;</span>,<span class="charliteral">&#39;&gt;&#39;</span>,$e);
<a name="l21621"></a>21621 
<a name="l21622"></a>21622     $a[$i] = $e;
<a name="l21623"></a>21623      }
<a name="l21624"></a>21624      <span class="keywordflow">else</span> {
<a name="l21625"></a>21625     $a[$i] = <span class="charliteral">&#39;&lt;&#39;</span>.$e.<span class="charliteral">&#39;&gt;&#39;</span>; 
<a name="l21626"></a>21626      }
<a name="l21627"></a>21627   }
<a name="l21628"></a>21628   $n = implode(<span class="stringliteral">&#39;&#39;</span>,$a);
<a name="l21629"></a>21629   <span class="keywordflow">return</span> $n;
<a name="l21630"></a>21630 }
<a name="l21631"></a>21631 
<a name="l21632"></a>21632 
<a name="l21633"></a>21633 
<a name="l21634"></a>21634 
<a name="l21635"></a>21635 
<a name="l21636"></a>21636 
<a name="l21637"></a>21637 <span class="comment">//===========================</span>
<a name="l21638"></a>21638 <span class="comment">// Functions originally in htmltoolkit - moved mPDF 4.0</span>
<a name="l21639"></a>21639 
<a name="l21640"></a>21640 <span class="comment">// Call-back function Used for usort in fn _tableWrite</span>
<a name="l21641"></a>21641 
<a name="l21642"></a>21642 function _cmpdom($a, $b) {
<a name="l21643"></a>21643     <span class="keywordflow">return</span> ($a[<span class="stringliteral">&quot;dom&quot;</span>] &lt; $b[<span class="stringliteral">&quot;dom&quot;</span>]) ? -1 : 1;
<a name="l21644"></a>21644 }
<a name="l21645"></a>21645 
<a name="l21646"></a>21646 function mb_rtrim($str, $enc = <span class="stringliteral">&#39;utf-8&#39;</span>){
<a name="l21647"></a>21647   <span class="keywordflow">if</span> ($str == <span class="charliteral">&#39; &#39;</span> || $str == <span class="stringliteral">&quot;\n&quot;</span> || $str == <span class="stringliteral">&quot;\t&quot;</span>) { <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; }
<a name="l21648"></a>21648   $end = mb_strlen($str,$enc);
<a name="l21649"></a>21649   <span class="keywordflow">for</span>($i=$end;$i&gt;0;$i--) {
<a name="l21650"></a>21650     $last = mb_substr($str,$i-1,1,$enc);
<a name="l21651"></a>21651     <span class="keywordflow">if</span> (($last != <span class="charliteral">&#39; &#39;</span>) &amp;&amp; ($last != <span class="stringliteral">&quot;\n&quot;</span>) &amp;&amp; ($last != <span class="stringliteral">&quot;\r&quot;</span>) &amp;&amp; ($last != <span class="stringliteral">&quot;\t&quot;</span>)) { <span class="keywordflow">return</span> mb_substr($str,0,$i,$enc); }
<a name="l21652"></a>21652   }
<a name="l21653"></a>21653   <span class="keywordflow">return</span> $str;
<a name="l21654"></a>21654 }
<a name="l21655"></a>21655 
<a name="l21656"></a>21656 function mb_strrev($str, $enc = <span class="stringliteral">&#39;utf-8&#39;</span>){
<a name="l21657"></a>21657   $ch = array();
<a name="l21658"></a>21658   <span class="keywordflow">for</span>($i=0;$i&lt;mb_strlen($str,$enc);$i++) {
<a name="l21659"></a>21659     $ch[] = mb_substr($str,$i,1,$enc);
<a name="l21660"></a>21660   }
<a name="l21661"></a>21661   $revch = array_reverse($ch);
<a name="l21662"></a>21662   <span class="keywordflow">return</span> implode(<span class="stringliteral">&#39;&#39;</span>,$revch);
<a name="l21663"></a>21663 }
<a name="l21664"></a>21664 
<a name="l21665"></a>21665 
<a name="l21666"></a>21666 <span class="comment">// Callback function from function printdivbuffer in mpdf - keeping block together on one page</span>
<a name="l21667"></a>21667 function blockAdjust($type,$k,$xadj,$yadj,$a,$b,$c=0,$d=0,$e=0,$f=0) {
<a name="l21668"></a>21668    <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;Td&#39;</span>) {   <span class="comment">// xpos,ypos</span>
<a name="l21669"></a>21669   $a += ($xadj * $k);
<a name="l21670"></a>21670   $b -= ($yadj * $k);
<a name="l21671"></a>21671   <span class="keywordflow">return</span> <span class="stringliteral">&#39;BT &#39;</span>.sprintf(<span class="stringliteral">&#39;%.3f %.3f&#39;</span>,$a,$b).<span class="stringliteral">&#39; Td&#39;</span>; 
<a name="l21672"></a>21672    }
<a name="l21673"></a>21673    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;re&#39;</span>) {  <span class="comment">// xpos,ypos,width,height</span>
<a name="l21674"></a>21674   $a += ($xadj * $k);
<a name="l21675"></a>21675   $b -= ($yadj * $k);
<a name="l21676"></a>21676   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f&#39;</span>,$a,$b,$c,$d).<span class="stringliteral">&#39; re&#39;</span>; 
<a name="l21677"></a>21677    }
<a name="l21678"></a>21678    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="charliteral">&#39;l&#39;</span>) {   <span class="comment">// xpos,ypos,x2pos,y2pos</span>
<a name="l21679"></a>21679   $a += ($xadj * $k);
<a name="l21680"></a>21680   $b -= ($yadj * $k);
<a name="l21681"></a>21681   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.3f %.3f l&#39;</span>,$a,$b); 
<a name="l21682"></a>21682    }
<a name="l21683"></a>21683    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;img&#39;</span>) {   <span class="comment">// width,height,xpos,ypos</span>
<a name="l21684"></a>21684   $c += ($xadj * $k);
<a name="l21685"></a>21685   $d -= ($yadj * $k);
<a name="l21686"></a>21686   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;q %.3f 0 0 %.3f %.3f %.3f&#39;</span>,$a,$b,$c,$d).<span class="stringliteral">&#39; cm /I&#39;</span>; 
<a name="l21687"></a>21687    }
<a name="l21688"></a>21688    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;draw&#39;</span>) {  <span class="comment">// xpos,ypos</span>
<a name="l21689"></a>21689   $a += ($xadj * $k);
<a name="l21690"></a>21690   $b -= ($yadj * $k);
<a name="l21691"></a>21691   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.3f %.3f m&#39;</span>,$a,$b); 
<a name="l21692"></a>21692    }
<a name="l21693"></a>21693    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;bezier&#39;</span>) {  <span class="comment">// xpos,ypos,x2pos,y2pos,x3pos,y3pos</span>
<a name="l21694"></a>21694   $a += ($xadj * $k);
<a name="l21695"></a>21695   $b -= ($yadj * $k);
<a name="l21696"></a>21696   $c += ($xadj * $k);
<a name="l21697"></a>21697   $d -= ($yadj * $k);
<a name="l21698"></a>21698   $e += ($xadj * $k);
<a name="l21699"></a>21699   $f -= ($yadj * $k);
<a name="l21700"></a>21700   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.3f %.3f %.3f %.3f %.3f %.3f&#39;</span>,$a,$b,$c,$d,$e,$f).<span class="stringliteral">&#39; c&#39;</span>; 
<a name="l21701"></a>21701    }
<a name="l21702"></a>21702 }
<a name="l21703"></a>21703 
<a name="l21704"></a>21704 function ConvertColor($color=<span class="stringliteral">&quot;#000000&quot;</span>){
<a name="l21705"></a>21705   <span class="comment">//returns an associative array (keys: R,G,B) from html code (e.g. #3FE5AA)</span>
<a name="l21706"></a>21706   <span class="comment">//All color names array</span>
<a name="l21707"></a>21707   <span class="keyword">static</span> $common_colors = array(<span class="stringliteral">&#39;antiquewhite&#39;</span>=&gt;<span class="stringliteral">&#39;#FAEBD7&#39;</span>,<span class="stringliteral">&#39;aqua&#39;</span>=&gt;<span class="stringliteral">&#39;#00FFFF&#39;</span>,<span class="stringliteral">&#39;aquamarine&#39;</span>=&gt;<span class="stringliteral">&#39;#7FFFD4&#39;</span>,<span class="stringliteral">&#39;beige&#39;</span>=&gt;<span class="stringliteral">&#39;#F5F5DC&#39;</span>,<span class="stringliteral">&#39;black&#39;</span>=&gt;<span class="stringliteral">&#39;#000000&#39;</span>,
<a name="l21708"></a>21708 <span class="stringliteral">&#39;blue&#39;</span>=&gt;<span class="stringliteral">&#39;#0000FF&#39;</span>,<span class="stringliteral">&#39;brown&#39;</span>=&gt;<span class="stringliteral">&#39;#A52A2A&#39;</span>,<span class="stringliteral">&#39;cadetblue&#39;</span>=&gt;<span class="stringliteral">&#39;#5F9EA0&#39;</span>,<span class="stringliteral">&#39;chocolate&#39;</span>=&gt;<span class="stringliteral">&#39;#D2691E&#39;</span>,<span class="stringliteral">&#39;cornflowerblue&#39;</span>=&gt;<span class="stringliteral">&#39;#6495ED&#39;</span>,<span class="stringliteral">&#39;crimson&#39;</span>=&gt;<span class="stringliteral">&#39;#DC143C&#39;</span>,
<a name="l21709"></a>21709 <span class="stringliteral">&#39;darkblue&#39;</span>=&gt;<span class="stringliteral">&#39;#00008B&#39;</span>,<span class="stringliteral">&#39;darkgoldenrod&#39;</span>=&gt;<span class="stringliteral">&#39;#B8860B&#39;</span>,<span class="stringliteral">&#39;darkgreen&#39;</span>=&gt;<span class="stringliteral">&#39;#006400&#39;</span>,<span class="stringliteral">&#39;darkmagenta&#39;</span>=&gt;<span class="stringliteral">&#39;#8B008B&#39;</span>,<span class="stringliteral">&#39;darkorange&#39;</span>=&gt;<span class="stringliteral">&#39;#FF8C00&#39;</span>,
<a name="l21710"></a>21710 <span class="stringliteral">&#39;darkred&#39;</span>=&gt;<span class="stringliteral">&#39;#8B0000&#39;</span>,<span class="stringliteral">&#39;darkseagreen&#39;</span>=&gt;<span class="stringliteral">&#39;#8FBC8F&#39;</span>,<span class="stringliteral">&#39;darkslategray&#39;</span>=&gt;<span class="stringliteral">&#39;#2F4F4F&#39;</span>,<span class="stringliteral">&#39;darkviolet&#39;</span>=&gt;<span class="stringliteral">&#39;#9400D3&#39;</span>,<span class="stringliteral">&#39;deepskyblue&#39;</span>=&gt;<span class="stringliteral">&#39;#00BFFF&#39;</span>,
<a name="l21711"></a>21711 <span class="stringliteral">&#39;dodgerblue&#39;</span>=&gt;<span class="stringliteral">&#39;#1E90FF&#39;</span>,<span class="stringliteral">&#39;firebrick&#39;</span>=&gt;<span class="stringliteral">&#39;#B22222&#39;</span>,<span class="stringliteral">&#39;forestgreen&#39;</span>=&gt;<span class="stringliteral">&#39;#228B22&#39;</span>,<span class="stringliteral">&#39;fuchsia&#39;</span>=&gt;<span class="stringliteral">&#39;#FF00FF&#39;</span>,<span class="stringliteral">&#39;gainsboro&#39;</span>=&gt;<span class="stringliteral">&#39;#DCDCDC&#39;</span>,<span class="stringliteral">&#39;gold&#39;</span>=&gt;<span class="stringliteral">&#39;#FFD700&#39;</span>,
<a name="l21712"></a>21712 <span class="stringliteral">&#39;gray&#39;</span>=&gt;<span class="stringliteral">&#39;#808080&#39;</span>,<span class="stringliteral">&#39;green&#39;</span>=&gt;<span class="stringliteral">&#39;#008000&#39;</span>,<span class="stringliteral">&#39;greenyellow&#39;</span>=&gt;<span class="stringliteral">&#39;#ADFF2F&#39;</span>,<span class="stringliteral">&#39;hotpink&#39;</span>=&gt;<span class="stringliteral">&#39;#FF69B4&#39;</span>,<span class="stringliteral">&#39;indigo&#39;</span>=&gt;<span class="stringliteral">&#39;#4B0082&#39;</span>,<span class="stringliteral">&#39;khaki&#39;</span>=&gt;<span class="stringliteral">&#39;#F0E68C&#39;</span>,
<a name="l21713"></a>21713 <span class="stringliteral">&#39;lavenderblush&#39;</span>=&gt;<span class="stringliteral">&#39;#FFF0F5&#39;</span>,<span class="stringliteral">&#39;lemonchiffon&#39;</span>=&gt;<span class="stringliteral">&#39;#FFFACD&#39;</span>,<span class="stringliteral">&#39;lightcoral&#39;</span>=&gt;<span class="stringliteral">&#39;#F08080&#39;</span>,<span class="stringliteral">&#39;lightgoldenrodyellow&#39;</span>=&gt;<span class="stringliteral">&#39;#FAFAD2&#39;</span>,<span class="stringliteral">&#39;lightgreen&#39;</span>=&gt;<span class="stringliteral">&#39;#90EE90&#39;</span>,
<a name="l21714"></a>21714 <span class="stringliteral">&#39;lightsalmon&#39;</span>=&gt;<span class="stringliteral">&#39;#FFA07A&#39;</span>,<span class="stringliteral">&#39;lightskyblue&#39;</span>=&gt;<span class="stringliteral">&#39;#87CEFA&#39;</span>,<span class="stringliteral">&#39;lightslategray&#39;</span>=&gt;<span class="stringliteral">&#39;#778899&#39;</span>,<span class="stringliteral">&#39;lightyellow&#39;</span>=&gt;<span class="stringliteral">&#39;#FFFFE0&#39;</span>,<span class="stringliteral">&#39;lime&#39;</span>=&gt;<span class="stringliteral">&#39;#00FF00&#39;</span>,<span class="stringliteral">&#39;limegreen&#39;</span>=&gt;<span class="stringliteral">&#39;#32CD32&#39;</span>,
<a name="l21715"></a>21715 <span class="stringliteral">&#39;magenta&#39;</span>=&gt;<span class="stringliteral">&#39;#FF00FF&#39;</span>,<span class="stringliteral">&#39;maroon&#39;</span>=&gt;<span class="stringliteral">&#39;#800000&#39;</span>,<span class="stringliteral">&#39;mediumaquamarine&#39;</span>=&gt;<span class="stringliteral">&#39;#66CDAA&#39;</span>,<span class="stringliteral">&#39;mediumorchid&#39;</span>=&gt;<span class="stringliteral">&#39;#BA55D3&#39;</span>,<span class="stringliteral">&#39;mediumseagreen&#39;</span>=&gt;<span class="stringliteral">&#39;#3CB371&#39;</span>,
<a name="l21716"></a>21716 <span class="stringliteral">&#39;mediumspringgreen&#39;</span>=&gt;<span class="stringliteral">&#39;#00FA9A&#39;</span>,<span class="stringliteral">&#39;mediumvioletred&#39;</span>=&gt;<span class="stringliteral">&#39;#C71585&#39;</span>,<span class="stringliteral">&#39;midnightblue&#39;</span>=&gt;<span class="stringliteral">&#39;#191970&#39;</span>,<span class="stringliteral">&#39;mintcream&#39;</span>=&gt;<span class="stringliteral">&#39;#F5FFFA&#39;</span>,<span class="stringliteral">&#39;moccasin&#39;</span>=&gt;<span class="stringliteral">&#39;#FFE4B5&#39;</span>,<span class="stringliteral">&#39;navy&#39;</span>=&gt;<span class="stringliteral">&#39;#000080&#39;</span>,
<a name="l21717"></a>21717 <span class="stringliteral">&#39;olive&#39;</span>=&gt;<span class="stringliteral">&#39;#808000&#39;</span>,<span class="stringliteral">&#39;orange&#39;</span>=&gt;<span class="stringliteral">&#39;#FFA500&#39;</span>,<span class="stringliteral">&#39;orchid&#39;</span>=&gt;<span class="stringliteral">&#39;#DA70D6&#39;</span>,<span class="stringliteral">&#39;palegreen&#39;</span>=&gt;<span class="stringliteral">&#39;#98FB98&#39;</span>,
<a name="l21718"></a>21718 <span class="stringliteral">&#39;palevioletred&#39;</span>=&gt;<span class="stringliteral">&#39;#D87093&#39;</span>,<span class="stringliteral">&#39;peachpuff&#39;</span>=&gt;<span class="stringliteral">&#39;#FFDAB9&#39;</span>,<span class="stringliteral">&#39;pink&#39;</span>=&gt;<span class="stringliteral">&#39;#FFC0CB&#39;</span>,<span class="stringliteral">&#39;powderblue&#39;</span>=&gt;<span class="stringliteral">&#39;#B0E0E6&#39;</span>,<span class="stringliteral">&#39;purple&#39;</span>=&gt;<span class="stringliteral">&#39;#800080&#39;</span>,
<a name="l21719"></a>21719 <span class="stringliteral">&#39;red&#39;</span>=&gt;<span class="stringliteral">&#39;#FF0000&#39;</span>,<span class="stringliteral">&#39;royalblue&#39;</span>=&gt;<span class="stringliteral">&#39;#4169E1&#39;</span>,<span class="stringliteral">&#39;salmon&#39;</span>=&gt;<span class="stringliteral">&#39;#FA8072&#39;</span>,<span class="stringliteral">&#39;seagreen&#39;</span>=&gt;<span class="stringliteral">&#39;#2E8B57&#39;</span>,<span class="stringliteral">&#39;sienna&#39;</span>=&gt;<span class="stringliteral">&#39;#A0522D&#39;</span>,<span class="stringliteral">&#39;silver&#39;</span>=&gt;<span class="stringliteral">&#39;#C0C0C0&#39;</span>,<span class="stringliteral">&#39;skyblue&#39;</span>=&gt;<span class="stringliteral">&#39;#87CEEB&#39;</span>,
<a name="l21720"></a>21720 <span class="stringliteral">&#39;slategray&#39;</span>=&gt;<span class="stringliteral">&#39;#708090&#39;</span>,<span class="stringliteral">&#39;springgreen&#39;</span>=&gt;<span class="stringliteral">&#39;#00FF7F&#39;</span>,<span class="stringliteral">&#39;steelblue&#39;</span>=&gt;<span class="stringliteral">&#39;#4682B4&#39;</span>,<span class="stringliteral">&#39;tan&#39;</span>=&gt;<span class="stringliteral">&#39;#D2B48C&#39;</span>,<span class="stringliteral">&#39;teal&#39;</span>=&gt;<span class="stringliteral">&#39;#008080&#39;</span>,<span class="stringliteral">&#39;thistle&#39;</span>=&gt;<span class="stringliteral">&#39;#D8BFD8&#39;</span>,<span class="stringliteral">&#39;turquoise&#39;</span>=&gt;<span class="stringliteral">&#39;#40E0D0&#39;</span>,
<a name="l21721"></a>21721 <span class="stringliteral">&#39;violetred&#39;</span>=&gt;<span class="stringliteral">&#39;#D02090&#39;</span>,<span class="stringliteral">&#39;white&#39;</span>=&gt;<span class="stringliteral">&#39;#FFFFFF&#39;</span>,<span class="stringliteral">&#39;yellow&#39;</span>=&gt;<span class="stringliteral">&#39;#FFFF00&#39;</span>, 
<a name="l21722"></a>21722 <span class="stringliteral">&#39;aliceblue&#39;</span>=&gt;<span class="stringliteral">&#39;#f0f8ff&#39;</span>, <span class="stringliteral">&#39;azure&#39;</span>=&gt;<span class="stringliteral">&#39;#f0ffff&#39;</span>, <span class="stringliteral">&#39;bisque&#39;</span>=&gt;<span class="stringliteral">&#39;#ffe4c4&#39;</span>, <span class="stringliteral">&#39;blanchedalmond&#39;</span>=&gt;<span class="stringliteral">&#39;#ffebcd&#39;</span>, <span class="stringliteral">&#39;blueviolet&#39;</span>=&gt;<span class="stringliteral">&#39;#8a2be2&#39;</span>, <span class="stringliteral">&#39;burlywood&#39;</span>=&gt;<span class="stringliteral">&#39;#deb887&#39;</span>, 
<a name="l21723"></a>21723 <span class="stringliteral">&#39;chartreuse&#39;</span>=&gt;<span class="stringliteral">&#39;#7fff00&#39;</span>, <span class="stringliteral">&#39;coral&#39;</span>=&gt;<span class="stringliteral">&#39;#ff7f50&#39;</span>, <span class="stringliteral">&#39;cornsilk&#39;</span>=&gt;<span class="stringliteral">&#39;#fff8dc&#39;</span>, <span class="stringliteral">&#39;cyan&#39;</span>=&gt;<span class="stringliteral">&#39;#00ffff&#39;</span>, <span class="stringliteral">&#39;darkcyan&#39;</span>=&gt;<span class="stringliteral">&#39;#008b8b&#39;</span>, <span class="stringliteral">&#39;darkgray&#39;</span>=&gt;<span class="stringliteral">&#39;#a9a9a9&#39;</span>, 
<a name="l21724"></a>21724 <span class="stringliteral">&#39;darkgrey&#39;</span>=&gt;<span class="stringliteral">&#39;#a9a9a9&#39;</span>, <span class="stringliteral">&#39;darkkhaki&#39;</span>=&gt;<span class="stringliteral">&#39;#bdb76b&#39;</span>, <span class="stringliteral">&#39;darkolivegreen&#39;</span>=&gt;<span class="stringliteral">&#39;#556b2f&#39;</span>, <span class="stringliteral">&#39;darkorchid&#39;</span>=&gt;<span class="stringliteral">&#39;#9932cc&#39;</span>, <span class="stringliteral">&#39;darksalmon&#39;</span>=&gt;<span class="stringliteral">&#39;#e9967a&#39;</span>, 
<a name="l21725"></a>21725 <span class="stringliteral">&#39;darkslateblue&#39;</span>=&gt;<span class="stringliteral">&#39;#483d8b&#39;</span>, <span class="stringliteral">&#39;darkslategrey&#39;</span>=&gt;<span class="stringliteral">&#39;#2f4f4f&#39;</span>, <span class="stringliteral">&#39;darkturquoise&#39;</span>=&gt;<span class="stringliteral">&#39;#00ced1&#39;</span>, <span class="stringliteral">&#39;deeppink&#39;</span>=&gt;<span class="stringliteral">&#39;#ff1493&#39;</span>, <span class="stringliteral">&#39;dimgray&#39;</span>=&gt;<span class="stringliteral">&#39;#696969&#39;</span>, 
<a name="l21726"></a>21726 <span class="stringliteral">&#39;dimgrey&#39;</span>=&gt;<span class="stringliteral">&#39;#696969&#39;</span>, <span class="stringliteral">&#39;floralwhite&#39;</span>=&gt;<span class="stringliteral">&#39;#fffaf0&#39;</span>, <span class="stringliteral">&#39;ghostwhite&#39;</span>=&gt;<span class="stringliteral">&#39;#f8f8ff&#39;</span>, <span class="stringliteral">&#39;goldenrod&#39;</span>=&gt;<span class="stringliteral">&#39;#daa520&#39;</span>, <span class="stringliteral">&#39;grey&#39;</span>=&gt;<span class="stringliteral">&#39;#808080&#39;</span>, <span class="stringliteral">&#39;honeydew&#39;</span>=&gt;<span class="stringliteral">&#39;#f0fff0&#39;</span>, 
<a name="l21727"></a>21727 <span class="stringliteral">&#39;indianred&#39;</span>=&gt;<span class="stringliteral">&#39;#cd5c5c&#39;</span>, <span class="stringliteral">&#39;ivory&#39;</span>=&gt;<span class="stringliteral">&#39;#fffff0&#39;</span>, <span class="stringliteral">&#39;lavender&#39;</span>=&gt;<span class="stringliteral">&#39;#e6e6fa&#39;</span>, <span class="stringliteral">&#39;lawngreen&#39;</span>=&gt;<span class="stringliteral">&#39;#7cfc00&#39;</span>, <span class="stringliteral">&#39;lightblue&#39;</span>=&gt;<span class="stringliteral">&#39;#add8e6&#39;</span>, <span class="stringliteral">&#39;lightcyan&#39;</span>=&gt;<span class="stringliteral">&#39;#e0ffff&#39;</span>, 
<a name="l21728"></a>21728 <span class="stringliteral">&#39;lightgray&#39;</span>=&gt;<span class="stringliteral">&#39;#d3d3d3&#39;</span>, <span class="stringliteral">&#39;lightgrey&#39;</span>=&gt;<span class="stringliteral">&#39;#d3d3d3&#39;</span>, <span class="stringliteral">&#39;lightpink&#39;</span>=&gt;<span class="stringliteral">&#39;#ffb6c1&#39;</span>, <span class="stringliteral">&#39;lightseagreen&#39;</span>=&gt;<span class="stringliteral">&#39;#20b2aa&#39;</span>, <span class="stringliteral">&#39;lightslategrey&#39;</span>=&gt;<span class="stringliteral">&#39;#778899&#39;</span>, 
<a name="l21729"></a>21729 <span class="stringliteral">&#39;lightsteelblue&#39;</span>=&gt;<span class="stringliteral">&#39;#b0c4de&#39;</span>, <span class="stringliteral">&#39;linen&#39;</span>=&gt;<span class="stringliteral">&#39;#faf0e6&#39;</span>, <span class="stringliteral">&#39;mediumblue&#39;</span>=&gt;<span class="stringliteral">&#39;#0000cd&#39;</span>, <span class="stringliteral">&#39;mediumpurple&#39;</span>=&gt;<span class="stringliteral">&#39;#9370db&#39;</span>, <span class="stringliteral">&#39;mediumslateblue&#39;</span>=&gt;<span class="stringliteral">&#39;#7b68ee&#39;</span>, 
<a name="l21730"></a>21730 <span class="stringliteral">&#39;mediumturquoise&#39;</span>=&gt;<span class="stringliteral">&#39;#48d1cc&#39;</span>, <span class="stringliteral">&#39;mistyrose&#39;</span>=&gt;<span class="stringliteral">&#39;#ffe4e1&#39;</span>, <span class="stringliteral">&#39;navajowhite&#39;</span>=&gt;<span class="stringliteral">&#39;#ffdead&#39;</span>, <span class="stringliteral">&#39;oldlace&#39;</span>=&gt;<span class="stringliteral">&#39;#fdf5e6&#39;</span>, <span class="stringliteral">&#39;olivedrab&#39;</span>=&gt;<span class="stringliteral">&#39;#6b8e23&#39;</span>, <span class="stringliteral">&#39;orangered&#39;</span>=&gt;<span class="stringliteral">&#39;#ff4500&#39;</span>, 
<a name="l21731"></a>21731 <span class="stringliteral">&#39;palegoldenrod&#39;</span>=&gt;<span class="stringliteral">&#39;#eee8aa&#39;</span>, <span class="stringliteral">&#39;paleturquoise&#39;</span>=&gt;<span class="stringliteral">&#39;#afeeee&#39;</span>, <span class="stringliteral">&#39;papayawhip&#39;</span>=&gt;<span class="stringliteral">&#39;#ffefd5&#39;</span>, <span class="stringliteral">&#39;peru&#39;</span>=&gt;<span class="stringliteral">&#39;#cd853f&#39;</span>, <span class="stringliteral">&#39;plum&#39;</span>=&gt;<span class="stringliteral">&#39;#dda0dd&#39;</span>, <span class="stringliteral">&#39;rosybrown&#39;</span>=&gt;<span class="stringliteral">&#39;#bc8f8f&#39;</span>, 
<a name="l21732"></a>21732 <span class="stringliteral">&#39;saddlebrown&#39;</span>=&gt;<span class="stringliteral">&#39;#8b4513&#39;</span>, <span class="stringliteral">&#39;sandybrown&#39;</span>=&gt;<span class="stringliteral">&#39;#f4a460&#39;</span>, <span class="stringliteral">&#39;seashell&#39;</span>=&gt;<span class="stringliteral">&#39;#fff5ee&#39;</span>, <span class="stringliteral">&#39;slateblue&#39;</span>=&gt;<span class="stringliteral">&#39;#6a5acd&#39;</span>, <span class="stringliteral">&#39;slategrey&#39;</span>=&gt;<span class="stringliteral">&#39;#708090&#39;</span>, <span class="stringliteral">&#39;snow&#39;</span>=&gt;<span class="stringliteral">&#39;#fffafa&#39;</span>, 
<a name="l21733"></a>21733 <span class="stringliteral">&#39;tomato&#39;</span>=&gt;<span class="stringliteral">&#39;#ff6347&#39;</span>, <span class="stringliteral">&#39;violet&#39;</span>=&gt;<span class="stringliteral">&#39;#ee82ee&#39;</span>, <span class="stringliteral">&#39;wheat&#39;</span>=&gt;<span class="stringliteral">&#39;#f5deb3&#39;</span>, <span class="stringliteral">&#39;whitesmoke&#39;</span>=&gt;<span class="stringliteral">&#39;#f5f5f5&#39;</span>, <span class="stringliteral">&#39;yellowgreen&#39;</span>=&gt;<span class="stringliteral">&#39;#9acd32&#39;</span>);
<a name="l21734"></a>21734   <span class="comment">//http://www.w3schools.com/css/css_colornames.asp</span>
<a name="l21735"></a>21735   <span class="keywordflow">if</span> (strtoupper($color)==<span class="stringliteral">&#39;TRANSPARENT&#39;</span>) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l21736"></a>21736   <span class="keywordflow">if</span> (strtoupper($color)==<span class="stringliteral">&#39;INHERIT&#39;</span>) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l21737"></a>21737 
<a name="l21738"></a>21738   <span class="keywordflow">if</span> (isset($common_colors[strtolower($color)])) $color = $common_colors[strtolower($color)];
<a name="l21739"></a>21739 
<a name="l21740"></a>21740   <span class="keywordflow">if</span> ($color{0} == <span class="charliteral">&#39;#&#39;</span>) <span class="comment">//case of #nnnnnn or #nnn</span>
<a name="l21741"></a>21741   {
<a name="l21742"></a>21742     $cor = strtoupper($color);
<a name="l21743"></a>21743   $cor = preg_replace(<span class="stringliteral">&#39;/\s+.*/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$cor); <span class="comment">// in case of Background: #CCC url() x-repeat etc.</span>
<a name="l21744"></a>21744     <span class="keywordflow">if</span> (strlen($cor) == 4) { <span class="comment">// Turn #RGB into #RRGGBB</span>
<a name="l21745"></a>21745       $cor = <span class="stringliteral">&quot;#&quot;</span> . $cor{1} . $cor{1} . $cor{2} . $cor{2} . $cor{3} . $cor{3};
<a name="l21746"></a>21746   }  
<a name="l21747"></a>21747   $R = substr($cor, 1, 2);
<a name="l21748"></a>21748   $vermelho = hexdec($R);
<a name="l21749"></a>21749   $V = substr($cor, 3, 2);
<a name="l21750"></a>21750   $verde = hexdec($V);
<a name="l21751"></a>21751   $B = substr($cor, 5, 2);
<a name="l21752"></a>21752   $azul = hexdec($B);
<a name="l21753"></a>21753   $color = array();
<a name="l21754"></a>21754   $color[<span class="charliteral">&#39;R&#39;</span>]=$vermelho;
<a name="l21755"></a>21755   $color[<span class="charliteral">&#39;G&#39;</span>]=$verde;
<a name="l21756"></a>21756   $color[<span class="charliteral">&#39;B&#39;</span>]=$azul;
<a name="l21757"></a>21757   }
<a name="l21758"></a>21758   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($color,<span class="stringliteral">&#39;cmyk(&#39;</span>)) { <span class="comment">//case of CMYK(c,m,y,k)</span>
<a name="l21759"></a>21759   $color = str_replace(<span class="stringliteral">&quot;cmyk(&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$color); <span class="comment">//remove rgb(</span>
<a name="l21760"></a>21760   $color = str_replace(<span class="stringliteral">&quot;CMYK(&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$color); <span class="comment">//remove RGB( </span>
<a name="l21761"></a>21761   $color = str_replace(<span class="stringliteral">&quot;)&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$color); <span class="comment">//remove )</span>
<a name="l21762"></a>21762   $cores = explode(<span class="stringliteral">&quot;,&quot;</span>, $color);
<a name="l21763"></a>21763   $color = array();
<a name="l21764"></a>21764   $color[<span class="charliteral">&#39;R&#39;</span>]=$cores[0];
<a name="l21765"></a>21765   $color[<span class="charliteral">&#39;G&#39;</span>]=$cores[1];
<a name="l21766"></a>21766   $color[<span class="charliteral">&#39;B&#39;</span>]=$cores[2];
<a name="l21767"></a>21767   $color[<span class="charliteral">&#39;K&#39;</span>]=$cores[3];
<a name="l21768"></a>21768   }
<a name="l21769"></a>21769   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stristr($color,<span class="stringliteral">&#39;rgb(&#39;</span>)) <span class="comment">//case of RGB(r,g,b)</span>
<a name="l21770"></a>21770   {
<a name="l21771"></a>21771   $color = str_replace(<span class="stringliteral">&quot;rgb(&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$color); <span class="comment">//remove rgb(</span>
<a name="l21772"></a>21772   $color = str_replace(<span class="stringliteral">&quot;RGB(&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$color); <span class="comment">//remove RGB( -- PHP &lt; 5 does not have str_ireplace</span>
<a name="l21773"></a>21773   $color = str_replace(<span class="stringliteral">&quot;)&quot;</span>,<span class="stringliteral">&#39;&#39;</span>,$color); <span class="comment">//remove )</span>
<a name="l21774"></a>21774   $cores = explode(<span class="stringliteral">&quot;,&quot;</span>, $color);
<a name="l21775"></a>21775   $color = array();
<a name="l21776"></a>21776   $color[<span class="charliteral">&#39;R&#39;</span>]=$cores[0];
<a name="l21777"></a>21777   $color[<span class="charliteral">&#39;G&#39;</span>]=$cores[1];
<a name="l21778"></a>21778   $color[<span class="charliteral">&#39;B&#39;</span>]=$cores[2];
<a name="l21779"></a>21779   }
<a name="l21780"></a>21780   <span class="keywordflow">else</span> { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l21781"></a>21781   <span class="keywordflow">if</span> (empty($color)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l21782"></a>21782   <span class="keywordflow">else</span> <span class="keywordflow">return</span> $color; <span class="comment">// array[&#39;R&#39;][&#39;G&#39;][&#39;B&#39;]</span>
<a name="l21783"></a>21783 }
<a name="l21784"></a>21784 
<a name="l21785"></a>21785 function ConvertSize($size=5,$maxsize=0,$fontsize=<span class="keyword">false</span>,$usefontsize=<span class="keyword">true</span>){
<a name="l21786"></a>21786 <span class="comment">// usefontsize - setfalse for e.g. margins - will ignore fontsize for % values</span>
<a name="l21787"></a>21787 <span class="comment">// Depends of maxsize value to make % work properly. Usually maxsize == pagewidth</span>
<a name="l21788"></a>21788 <span class="comment">// For text $maxsize = Fontsize</span>
<a name="l21789"></a>21789 <span class="comment">// Setting e.g. margin % will use maxsize (pagewidth) and em will use fontsize</span>
<a name="l21790"></a>21790   <span class="comment">//Identify size (remember: we are using &#39;mm&#39; units here)</span>
<a name="l21791"></a>21791   <span class="keywordflow">if</span> ( strtolower($size) == <span class="stringliteral">&#39;thin&#39;</span> ) $size = 1*0.2645; <span class="comment">//1 pixel width for table borders</span>
<a name="l21792"></a>21792   elseif ( strtolower($size) == <span class="stringliteral">&#39;medium&#39;</span> ) $size = 3*0.2645; <span class="comment">//3 pixel width for table borders</span>
<a name="l21793"></a>21793   elseif ( strtolower($size) == &#39;thick&#39; ) $size = 5*0.2645; <span class="comment">//5 pixel width for table borders</span>
<a name="l21794"></a>21794   elseif ( stristr($size,&#39;px&#39;) ) $size *= 0.2645; <span class="comment">//pixels</span>
<a name="l21795"></a>21795   elseif ( stristr($size,&#39;cm&#39;) ) $size *= 10; <span class="comment">//centimeters</span>
<a name="l21796"></a>21796   elseif ( stristr($size,&#39;mm&#39;) ) $size += 0; <span class="comment">//millimeters</span>
<a name="l21797"></a>21797   elseif ( stristr($size,&#39;in&#39;) ) $size *= 25.4; <span class="comment">//inches </span>
<a name="l21798"></a>21798   elseif ( stristr($size,&#39;pc&#39;) ) $size *= 38.1/9; <span class="comment">//PostScript picas </span>
<a name="l21799"></a>21799   elseif ( stristr($size,&#39;pt&#39;) ) $size *= 25.4/72; <span class="comment">//72dpi</span>
<a name="l21800"></a>21800   elseif ( stristr($size,&#39;em&#39;) ) {
<a name="l21801"></a>21801     $size += 0; <span class="comment">//make &quot;0.83em&quot; become simply &quot;0.83&quot; </span>
<a name="l21802"></a>21802   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize; }
<a name="l21803"></a>21803   <span class="keywordflow">else</span> { $size *= $maxsize; }
<a name="l21804"></a>21804   }
<a name="l21805"></a>21805   elseif ( stristr($size,<span class="charliteral">&#39;%&#39;</span>) ) {
<a name="l21806"></a>21806     $size += 0; <span class="comment">//make &quot;90%&quot; become simply &quot;90&quot; </span>
<a name="l21807"></a>21807   <span class="keywordflow">if</span> ($fontsize &amp;&amp; $usefontsize) { $size *= $fontsize/100; }
<a name="l21808"></a>21808   <span class="keywordflow">else</span> { $size *= $maxsize/100; }
<a name="l21809"></a>21809   }
<a name="l21810"></a>21810   <span class="comment">// mPDF 2.3</span>
<a name="l21811"></a>21811   elseif (strtoupper($size) == <span class="stringliteral">&#39;XX-SMALL&#39;</span>) {
<a name="l21812"></a>21812   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize*0.7; }
<a name="l21813"></a>21813   <span class="keywordflow">else</span> { $size *= $maxsize*0.7; }
<a name="l21814"></a>21814   }
<a name="l21815"></a>21815   elseif (strtoupper($size) == <span class="stringliteral">&#39;X-SMALL&#39;</span>) {
<a name="l21816"></a>21816   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize*0.77; }
<a name="l21817"></a>21817   <span class="keywordflow">else</span> { $size *= $maxsize*0.77; }
<a name="l21818"></a>21818   }
<a name="l21819"></a>21819   elseif (strtoupper($size) == <span class="stringliteral">&#39;SMALL&#39;</span>) {
<a name="l21820"></a>21820   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize*0.86; }
<a name="l21821"></a>21821   <span class="keywordflow">else</span> { $size *= $maxsize*0.86; }
<a name="l21822"></a>21822   }
<a name="l21823"></a>21823   elseif (strtoupper($size) == <span class="stringliteral">&#39;MEDIUM&#39;</span>) {
<a name="l21824"></a>21824   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize; }
<a name="l21825"></a>21825   <span class="keywordflow">else</span> { $size *= $maxsize; }
<a name="l21826"></a>21826   }
<a name="l21827"></a>21827   elseif (strtoupper($size) == <span class="stringliteral">&#39;LARGE&#39;</span>) {
<a name="l21828"></a>21828   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize*1.2; }
<a name="l21829"></a>21829   <span class="keywordflow">else</span> { $size *= $maxsize*1.2; }
<a name="l21830"></a>21830   }
<a name="l21831"></a>21831   elseif (strtoupper($size) == <span class="stringliteral">&#39;X-LARGE&#39;</span>) {
<a name="l21832"></a>21832   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize*1.5; }
<a name="l21833"></a>21833   <span class="keywordflow">else</span> { $size *= $maxsize*1.5; }
<a name="l21834"></a>21834   }
<a name="l21835"></a>21835   elseif (strtoupper($size) == <span class="stringliteral">&#39;XX-LARGE&#39;</span>) {
<a name="l21836"></a>21836   <span class="keywordflow">if</span> ($fontsize) { $size *= $fontsize*2; }
<a name="l21837"></a>21837   <span class="keywordflow">else</span> { $size *= $maxsize*2; }
<a name="l21838"></a>21838   }
<a name="l21839"></a>21839   <span class="keywordflow">else</span> $size *= 0.2645; <span class="comment">//nothing == px</span>
<a name="l21840"></a>21840   
<a name="l21841"></a>21841   <span class="keywordflow">return</span> $size;
<a name="l21842"></a>21842 }
<a name="l21843"></a>21843 
<a name="l21844"></a>21844 
<a name="l21845"></a>21845 function lesser_entity_decode($html) {
<a name="l21846"></a>21846   <span class="comment">//supports the most used entity codes (only does ascii safe characters)</span>
<a name="l21847"></a>21847   $html = str_replace(<span class="stringliteral">&quot;&amp;nbsp;&quot;</span>,<span class="stringliteral">&quot; &quot;</span>,$html);
<a name="l21848"></a>21848   $html = str_replace(<span class="stringliteral">&quot;&amp;lt;&quot;</span>,<span class="stringliteral">&quot;&lt;&quot;</span>,$html);
<a name="l21849"></a>21849   $html = str_replace(<span class="stringliteral">&quot;&amp;gt;&quot;</span>,<span class="stringliteral">&quot;&gt;&quot;</span>,$html);
<a name="l21850"></a>21850 
<a name="l21851"></a>21851   $html = str_replace(<span class="stringliteral">&quot;&amp;apos;&quot;</span>,<span class="stringliteral">&quot;&#39;&quot;</span>,$html);
<a name="l21852"></a>21852   $html = str_replace(<span class="stringliteral">&quot;&amp;quot;&quot;</span>,<span class="charliteral">&#39;&quot;&#39;</span>,$html);
<a name="l21853"></a>21853   $html = str_replace(<span class="stringliteral">&quot;&amp;amp;&quot;</span>,<span class="stringliteral">&quot;&amp;&quot;</span>,$html);
<a name="l21854"></a>21854   <span class="keywordflow">return</span> $html;
<a name="l21855"></a>21855 }
<a name="l21856"></a>21856 
<a name="l21857"></a>21857 function AdjustHTML($html,$directionality=<span class="stringliteral">&#39;ltr&#39;</span>,$usepre=<span class="keyword">true</span>, $tabSpaces=8) {
<a name="l21858"></a>21858   <span class="comment">//Try to make the html text more manageable (turning it into XHTML)</span>
<a name="l21859"></a>21859 
<a name="l21860"></a>21860   <span class="comment">//Remove javascript code from HTML (should not appear in the PDF file)</span>
<a name="l21861"></a>21861   $html = preg_replace(<span class="stringliteral">&#39;/&lt;script.*?&lt;\/script&gt;/is&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21862"></a>21862 
<a name="l21863"></a>21863   <span class="comment">//Remove special comments</span>
<a name="l21864"></a>21864   $html = preg_replace(<span class="stringliteral">&#39;/&lt;!--mpdf/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21865"></a>21865   $html = preg_replace(<span class="stringliteral">&#39;/mpdf--&gt;/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21866"></a>21866 
<a name="l21867"></a>21867   <span class="comment">//Remove comments from HTML (should not appear in the PDF file)</span>
<a name="l21868"></a>21868   $html = preg_replace(<span class="stringliteral">&#39;/&lt;!--.*?--&gt;/s&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21869"></a>21869 
<a name="l21870"></a>21870   $html = preg_replace(<span class="stringliteral">&#39;/\f/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">//replace formfeed by nothing // mPDF 3.0 changed from ereg_</span>
<a name="l21871"></a>21871   $html = preg_replace(<span class="stringliteral">&#39;/\r/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">//replace carriage return by nothing // mPDF 3.0 changed from ereg_</span>
<a name="l21872"></a>21872 
<a name="l21873"></a>21873   <span class="comment">// Well formed XHTML end tags</span>
<a name="l21874"></a>21874   $html = preg_replace(<span class="stringliteral">&#39;/&lt;(br|hr)\/&gt;/i&#39;</span>,<span class="stringliteral">&quot;&lt;\\1 /&gt;&quot;</span>,$html); 
<a name="l21875"></a>21875 
<a name="l21876"></a>21876   <span class="comment">// Get rid of empty &lt;thead&gt;&lt;/thead&gt;</span>
<a name="l21877"></a>21877   $html = preg_replace(<span class="stringliteral">&#39;/&lt;thead&gt;\s*&lt;\/thead&gt;/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21878"></a>21878   $html = preg_replace(<span class="stringliteral">&#39;/&lt;tfoot&gt;\s*&lt;\/tfoot&gt;/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.2</span>
<a name="l21879"></a>21879   $html = preg_replace(<span class="stringliteral">&#39;/&lt;table[^&gt;]*&gt;\s*&lt;\/table&gt;/i&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$html); <span class="comment">// mPDF 3.2</span>
<a name="l21880"></a>21880 
<a name="l21881"></a>21881   <span class="comment">// Remove spaces at end of table cells</span>
<a name="l21882"></a>21882   $html = preg_replace(<span class="stringliteral">&quot;/[ ]+&lt;\/t(d|h)/&quot;</span>,<span class="stringliteral">&#39;&lt;/t\\1&#39;</span>,$html);
<a name="l21883"></a>21883 
<a name="l21884"></a>21884   <span class="comment">// Transposes Table Cells When RTL direction</span>
<a name="l21885"></a>21885   <span class="keywordflow">if</span> ($directionality == <span class="stringliteral">&#39;rtl&#39;</span>) { 
<a name="l21886"></a>21886     preg_match_all(<span class="stringliteral">&#39;/&lt;table(.*?)&gt;(.*?)&lt;\/table&gt;/is&#39;</span>,$html,$matches);
<a name="l21887"></a>21887     <span class="keywordflow">for</span>($i=0;$i&lt;count($matches[0]);$i++) {
<a name="l21888"></a>21888       $pre = <span class="stringliteral">&#39;&lt;table&#39;</span> . $matches[1][$i] . <span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l21889"></a>21889       $post = <span class="stringliteral">&#39;&lt;/table&gt;&#39;</span>;
<a name="l21890"></a>21890       <span class="comment">// mPDF 3.2 Don&#39;t change if nested tables</span>
<a name="l21891"></a>21891       <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;/&lt;table/is&#39;</span>,$matches[2][$i]) &amp;&amp; !preg_match(<span class="stringliteral">&#39;/&lt;\/table/is&#39;</span>,$matches[2][$i]) ) {
<a name="l21892"></a>21892         $table = $matches[0][$i];
<a name="l21893"></a>21893         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/(&lt;thead[^&gt;]*&gt;)/is&#39;</span>,$table,$m)) { $thead = $m[0]; } <span class="keywordflow">else</span> { $thead = <span class="stringliteral">&#39;&#39;</span>; }
<a name="l21894"></a>21894         preg_match_all(<span class="stringliteral">&#39;/&lt;tr(.*?)&gt;(.*?)&lt;\/tr&gt;/is&#39;</span>,$table,$tmatches);
<a name="l21895"></a>21895         $newrows = array();
<a name="l21896"></a>21896         <span class="keywordflow">for</span>($j=0;$j&lt;count($tmatches[0]);$j++) {
<a name="l21897"></a>21897       $rpre = <span class="stringliteral">&#39;&lt;tr&#39;</span> . $tmatches[1][$j] . <span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l21898"></a>21898       $rpost = <span class="stringliteral">&#39;&lt;/tr&gt;&#39;</span>;
<a name="l21899"></a>21899       $row = $tmatches[0][$j];
<a name="l21900"></a>21900       preg_match_all(<span class="stringliteral">&#39;/&lt;t[hd].*?&gt;.*?&lt;\/t[hd]&gt;/is&#39;</span>,$row,$rmatches);
<a name="l21901"></a>21901       $cells = array();
<a name="l21902"></a>21902       <span class="keywordflow">for</span>($k=0;$k&lt;count($rmatches[0]);$k++) { $cells[] = $rmatches[0][$k]; }
<a name="l21903"></a>21903       $cells = array_reverse($cells);
<a name="l21904"></a>21904       <span class="keywordflow">if</span> (($thead) &amp;&amp; ($j == 0)) {  <span class="comment">// First row</span>
<a name="l21905"></a>21905         $newrows[] = $thead . $rpre . implode(<span class="stringliteral">&#39;&#39;</span>,$cells) . $rpost . <span class="stringliteral">&#39;&lt;/thead&gt;&lt;tbody&gt;&#39;</span>;
<a name="l21906"></a>21906       }
<a name="l21907"></a>21907       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($thead) &amp;&amp; ($j == (count($tmatches[0]) - 1))) { <span class="comment">// last row adds &lt;/tbody&gt;</span>
<a name="l21908"></a>21908         $newrows[] = $rpre . implode(<span class="stringliteral">&#39;&#39;</span>,$cells) . $rpost . <span class="stringliteral">&#39;&lt;/tbody&gt;&#39;</span>;
<a name="l21909"></a>21909       }
<a name="l21910"></a>21910       <span class="keywordflow">else</span> {
<a name="l21911"></a>21911         $newrows[] = $rpre . implode(<span class="stringliteral">&#39;&#39;</span>,$cells) . $rpost;
<a name="l21912"></a>21912       }
<a name="l21913"></a>21913         }
<a name="l21914"></a>21914         $newtable = $pre . implode(<span class="stringliteral">&#39;&#39;</span>,$newrows) . $post;
<a name="l21915"></a>21915         $html = str_replace($table,$newtable,$html);
<a name="l21916"></a>21916       }
<a name="l21917"></a>21917     }
<a name="l21918"></a>21918   }
<a name="l21919"></a>21919 
<a name="l21920"></a>21920   <span class="comment">// mPDF 4.2.031 &lt;dottab&gt;</span>
<a name="l21921"></a>21921   $html = preg_replace(<span class="stringliteral">&quot;/[ ]*&lt;dottab\s*[\/]*&gt;[ ]*/&quot;</span>,<span class="stringliteral">&#39;&lt;dottab /&gt;&#39;</span>,$html);
<a name="l21922"></a>21922 
<a name="l21923"></a>21923   <span class="comment">// Concatenates any Substitute characters from symbols/dingbats</span>
<a name="l21924"></a>21924   $html = str_replace(<span class="stringliteral">&#39;&lt;/tts&gt;&lt;tts&gt;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,$html);
<a name="l21925"></a>21925   $html = str_replace(<span class="stringliteral">&#39;&lt;/ttz&gt;&lt;ttz&gt;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,$html);
<a name="l21926"></a>21926   $html = str_replace(<span class="stringliteral">&#39;&lt;/tta&gt;&lt;tta&gt;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,$html);
<a name="l21927"></a>21927 
<a name="l21928"></a>21928   $html = mb_eregi_replace(<span class="stringliteral">&#39;/&lt;br \/&gt;\s*/is&#39;</span>,<span class="stringliteral">&quot;&lt;br /&gt;&quot;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21929"></a>21929   <span class="keywordflow">if</span> ($usepre) <span class="comment">//used to keep \n on content inside &lt;pre&gt; and inside &lt;textarea&gt;</span>
<a name="l21930"></a>21930   {
<a name="l21931"></a>21931     <span class="comment">// Preserve &#39;\n&#39;s in content between the tags &lt;pre&gt; and &lt;/pre&gt;</span>
<a name="l21932"></a>21932     $thereispre = preg_match_all(<span class="stringliteral">&#39;#&lt;pre(.*?)&gt;(.*?)&lt;/pre&gt;#si&#39;</span>,$html,$temp);
<a name="l21933"></a>21933     <span class="comment">// Preserve &#39;\n&#39;s in content between the tags &lt;textarea&gt; and &lt;/textarea&gt;</span>
<a name="l21934"></a>21934     $thereistextarea = preg_match_all(<span class="stringliteral">&#39;#&lt;textarea(.*?)&gt;(.*?)&lt;/textarea&gt;#si&#39;</span>,$html,$temp2);
<a name="l21935"></a>21935     $html = preg_replace(<span class="stringliteral">&#39;/[\n]/&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$html); <span class="comment">//replace linefeed by spaces // mPDF 3.0 changed from ereg_</span>
<a name="l21936"></a>21936     $html = preg_replace(<span class="stringliteral">&#39;/[\t]/&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$html); <span class="comment">//replace tabs by spaces // mPDF 3.0 changed from ereg_</span>
<a name="l21937"></a>21937 
<a name="l21938"></a>21938     <span class="comment">// mPDF 2.3 - moved</span>
<a name="l21939"></a>21939     <span class="comment">// Converts &lt; to &amp;lt; when not a tag</span>
<a name="l21940"></a>21940     $html = preg_replace(<span class="stringliteral">&#39;/&lt;([^!\/a-zA-Z])/i&#39;</span>,<span class="stringliteral">&#39;&amp;lt;\\1&#39;</span>,$html); 
<a name="l21941"></a>21941 
<a name="l21942"></a>21942     <span class="comment">// mPDF changed to prevent &amp;nbsp; chars replaced</span>
<a name="l21943"></a>21943     $html = preg_replace(<span class="stringliteral">&quot;/[ ]+/&quot;</span>,<span class="charliteral">&#39; &#39;</span>,$html);
<a name="l21944"></a>21944 
<a name="l21945"></a>21945     $html = preg_replace(<span class="stringliteral">&#39;/\/li&gt;\s+&lt;\/(u|o)l/i&#39;</span>,<span class="stringliteral">&#39;/li&gt;&lt;/\\1l&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21946"></a>21946     $html = preg_replace(<span class="stringliteral">&#39;/\/(u|o)l&gt;\s+&lt;\/li/i&#39;</span>,<span class="stringliteral">&#39;/\\1l&gt;&lt;/li&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21947"></a>21947     $html = preg_replace(<span class="stringliteral">&#39;/\/li&gt;\s+&lt;\/(u|o)l/i&#39;</span>,<span class="stringliteral">&#39;/li&gt;&lt;/\\1l&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21948"></a>21948     $html = preg_replace(<span class="stringliteral">&#39;/\/li&gt;\s+&lt;li/i&#39;</span>,<span class="stringliteral">&#39;/li&gt;&lt;li&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21949"></a>21949     $html = preg_replace(<span class="stringliteral">&#39;/&lt;(u|o)l([^&gt;]*)&gt;[ ]+/i&#39;</span>,<span class="stringliteral">&#39;&lt;\\1l\\2&gt;&#39;</span>,$html);
<a name="l21950"></a>21950     $html = preg_replace(<span class="stringliteral">&#39;/[ ]+&lt;(u|o)l/i&#39;</span>,<span class="stringliteral">&#39;&lt;\\1l&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21951"></a>21951 
<a name="l21952"></a>21952     $iterator = 0;
<a name="l21953"></a>21953     <span class="keywordflow">while</span>($thereispre) <span class="comment">//Recover &lt;pre attributes&gt;content&lt;/pre&gt;</span>
<a name="l21954"></a>21954     {
<a name="l21955"></a>21955       <span class="comment">// mPDF 2.4 </span>
<a name="l21956"></a>21956       $temp[2][$iterator] = str_replace(<span class="stringliteral">&quot;&lt;||@mpdf@||pre&quot;</span>, <span class="stringliteral">&quot;&lt;pre&quot;</span>, $temp[2][$iterator] );
<a name="l21957"></a>21957       $temp[2][$iterator] = str_replace(<span class="stringliteral">&quot;&lt;||@mpdf@||/pre&quot;</span>, <span class="stringliteral">&quot;&lt;/pre&quot;</span>, $temp[2][$iterator] );
<a name="l21958"></a>21958       <span class="comment">// mPDF 2.4 (moved) / mPDF 2.3</span>
<a name="l21959"></a>21959       $temp[2][$iterator] = preg_replace(<span class="stringliteral">&quot;/^([^\n\t]*?)\t/me&quot;</span>, <span class="stringliteral">&quot;stripslashes(&#39;\\1&#39;) . str_repeat(&#39; &#39;,  ( $tabSpaces - (mb_strlen(stripslashes(&#39;\\1&#39;)) % $tabSpaces))  )&quot;</span>,$temp[2][$iterator]);
<a name="l21960"></a>21960 
<a name="l21961"></a>21961       $temp[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/&amp;/&#39;</span>,<span class="stringliteral">&quot;&amp;amp;&quot;</span>,$temp[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21962"></a>21962       $temp[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/&lt;/&#39;</span>,<span class="stringliteral">&quot;&amp;lt;&quot;</span>,$temp[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21963"></a>21963 
<a name="l21964"></a>21964       $temp[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/\t/&#39;</span>,str_repeat(<span class="stringliteral">&quot; &quot;</span>,$tabSpaces),$temp[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21965"></a>21965 
<a name="l21966"></a>21966       $temp[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/\n/&#39;</span>,<span class="stringliteral">&quot;&lt;br /&gt;&quot;</span>,$temp[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21967"></a>21967       <span class="comment">// mPDF 1.3 Edited to fix bug with empty pre</span>
<a name="l21968"></a>21968       <span class="comment">// mPDF 2.4 Removed /u as not needed to be Unicode and causing bugs with annotations</span>
<a name="l21969"></a>21969       $html = preg_replace(<span class="stringliteral">&#39;#&lt;pre(.*?)&gt;(.*?)&lt;/pre&gt;#si&#39;</span>,<span class="stringliteral">&#39;&lt;erp&#39;</span>.$temp[1][$iterator].<span class="charliteral">&#39;&gt;&#39;</span>.$temp[2][$iterator].<span class="stringliteral">&#39;&lt;/erp&gt;&#39;</span>,$html,1);
<a name="l21970"></a>21970       $thereispre--;
<a name="l21971"></a>21971       $iterator++;
<a name="l21972"></a>21972     }
<a name="l21973"></a>21973     $iterator = 0;
<a name="l21974"></a>21974     <span class="keywordflow">while</span>($thereistextarea) <span class="comment">//Recover &lt;textarea attributes&gt;content&lt;/textarea&gt;</span>
<a name="l21975"></a>21975     {
<a name="l21976"></a>21976       $temp2[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/&amp;/&#39;</span>,<span class="stringliteral">&quot;&amp;amp;&quot;</span>,$temp2[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21977"></a>21977       $temp2[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/&lt;/&#39;</span>,<span class="stringliteral">&quot;&amp;lt;&quot;</span>,$temp2[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21978"></a>21978 
<a name="l21979"></a>21979       $temp2[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/\t/&#39;</span>,str_repeat(<span class="stringliteral">&quot; &quot;</span>,$tabSpaces),$temp2[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21980"></a>21980       $temp2[2][$iterator] = preg_replace(<span class="stringliteral">&#39;/[ ]/&#39;</span>,<span class="stringliteral">&quot;&amp;nbsp;&quot;</span>,$temp2[2][$iterator]); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l21981"></a>21981       <span class="comment">// mPDF 4.1 /u modifier removed - not required and causing problems if annotation special chars</span>
<a name="l21982"></a>21982       $html = preg_replace(<span class="stringliteral">&#39;#&lt;textarea(.*?)&gt;(.*?)&lt;/textarea&gt;#si&#39;</span>,<span class="stringliteral">&#39;&lt;aeratxet&#39;</span>.$temp2[1][$iterator].<span class="charliteral">&#39;&gt;&#39;</span>.trim($temp2[2][$iterator]) .<span class="stringliteral">&#39;&lt;/aeratxet&gt;&#39;</span>,$html,1);
<a name="l21983"></a>21983       $thereistextarea--;
<a name="l21984"></a>21984       $iterator++;
<a name="l21985"></a>21985     }
<a name="l21986"></a>21986     <span class="comment">//Restore original tag names</span>
<a name="l21987"></a>21987     $html = str_replace(<span class="stringliteral">&quot;&lt;erp&quot;</span>,<span class="stringliteral">&quot;&lt;pre&quot;</span>,$html);
<a name="l21988"></a>21988     $html = str_replace(<span class="stringliteral">&quot;&lt;/erp&gt;&quot;</span>,<span class="stringliteral">&quot;&lt;/pre&gt;&quot;</span>,$html);
<a name="l21989"></a>21989     $html = str_replace(<span class="stringliteral">&quot;&lt;aeratxet&quot;</span>,<span class="stringliteral">&quot;&lt;textarea&quot;</span>,$html);
<a name="l21990"></a>21990     $html = str_replace(<span class="stringliteral">&quot;&lt;/aeratxet&gt;&quot;</span>,<span class="stringliteral">&quot;&lt;/textarea&gt;&quot;</span>,$html);
<a name="l21991"></a>21991     <span class="comment">// (the code above might slowdown overall performance?)</span>
<a name="l21992"></a>21992   } <span class="comment">//end of if($usepre)</span>
<a name="l21993"></a>21993   <span class="keywordflow">else</span>
<a name="l21994"></a>21994   {
<a name="l21995"></a>21995     $html = preg_replace(<span class="stringliteral">&#39;/\n/&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$html); <span class="comment">//replace linefeed by spaces // mPDF 3.0 changed from ereg_</span>
<a name="l21996"></a>21996     $html = preg_replace(<span class="stringliteral">&#39;/\t/&#39;</span>,<span class="charliteral">&#39; &#39;</span>,$html); <span class="comment">//replace tabs by spaces // mPDF 3.0 changed from ereg_</span>
<a name="l21997"></a>21997 
<a name="l21998"></a>21998     <span class="comment">// Converts &lt; to &amp;lt; when not a tag</span>
<a name="l21999"></a>21999     $html = preg_replace(<span class="stringliteral">&#39;/&lt;([^!\/a-zA-Z])/i&#39;</span>,<span class="stringliteral">&#39;&amp;lt;\\1&#39;</span>,$html); 
<a name="l22000"></a>22000 
<a name="l22001"></a>22001     <span class="comment">// mPDF changed to prevent &amp;nbsp; chars replaced</span>
<a name="l22002"></a>22002     $html = preg_replace(<span class="stringliteral">&quot;/[ ]+/u&quot;</span>,<span class="charliteral">&#39; &#39;</span>,$html);
<a name="l22003"></a>22003 
<a name="l22004"></a>22004     $html = preg_replace(<span class="stringliteral">&#39;/\/li&gt;\s+&lt;\/(u|o)l/i&#39;</span>,<span class="stringliteral">&#39;/li&gt;&lt;/\\1l&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l22005"></a>22005     $html = preg_replace(<span class="stringliteral">&#39;/\/(u|o)l&gt;\s+&lt;\/li/i&#39;</span>,<span class="stringliteral">&#39;/\\1l&gt;&lt;/li&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l22006"></a>22006     $html = preg_replace(<span class="stringliteral">&#39;/\/li&gt;\s+&lt;\/(u|o)l/i&#39;</span>,<span class="stringliteral">&#39;/li&gt;&lt;/\\1l&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l22007"></a>22007     $html = preg_replace(<span class="stringliteral">&#39;/\/li&gt;\s+&lt;li/i&#39;</span>,<span class="stringliteral">&#39;/li&gt;&lt;li&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l22008"></a>22008     $html = preg_replace(<span class="stringliteral">&#39;/&lt;(u|o)l([^&gt;]*)&gt;[ ]+/i&#39;</span>,<span class="stringliteral">&#39;&lt;\\1l\\2&gt;&#39;</span>,$html);
<a name="l22009"></a>22009     $html = preg_replace(<span class="stringliteral">&#39;/[ ]+&lt;(u|o)l/i&#39;</span>,<span class="stringliteral">&#39;&lt;\\1l&#39;</span>,$html); <span class="comment">// mPDF 3.0 changed from ereg_</span>
<a name="l22010"></a>22010 
<a name="l22011"></a>22011   }
<a name="l22012"></a>22012   $html = preg_replace(<span class="stringliteral">&#39;/&lt;textarea([^&gt;]*)&gt;&lt;\/textarea&gt;/si&#39;</span>,<span class="stringliteral">&#39;&lt;textarea\\1&gt; &lt;/textarea&gt;&#39;</span>,$html);
<a name="l22013"></a>22013   $html = preg_replace(<span class="stringliteral">&#39;/&lt;(h[1-6])([^&gt;]*)(&gt;(?:(?!h[1-6]).)*&lt;\/\\1&gt;\s*&lt;table)/si&#39;</span>,<span class="stringliteral">&#39;&lt;\\1\\2 keep-with-table=&quot;1&quot;\\3&#39;</span>,$html); <span class="comment">// *TABLES*</span>
<a name="l22014"></a>22014   $html = preg_replace(<span class="stringliteral">&quot;/\xbb\xa4\xac/&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $html);
<a name="l22015"></a>22015   <span class="keywordflow">return</span> $html;
<a name="l22016"></a>22016 }
<a name="l22017"></a>22017 
<a name="l22018"></a>22018 function dec2alpha($valor,$toupper=<span class="stringliteral">&quot;true&quot;</span>){
<a name="l22019"></a>22019 <span class="comment">// returns a string from A-Z to AA-ZZ to AAA-ZZZ</span>
<a name="l22020"></a>22020 <span class="comment">// OBS: A = 65 ASCII TABLE VALUE</span>
<a name="l22021"></a>22021   <span class="keywordflow">if</span> (($valor &lt; 1)  || ($valor &gt; 18278)) <span class="keywordflow">return</span> <span class="stringliteral">&quot;?&quot;</span>; <span class="comment">//supports &#39;only&#39; up to 18278</span>
<a name="l22022"></a>22022   $c1 = $c2 = $c3 = <span class="stringliteral">&#39;&#39;</span>;
<a name="l22023"></a>22023   <span class="keywordflow">if</span> ($valor &gt; 702) <span class="comment">// 3 letters (up to 18278)</span>
<a name="l22024"></a>22024     {
<a name="l22025"></a>22025       $c1 = 65 + floor(($valor-703)/676);
<a name="l22026"></a>22026       $c2 = 65 + floor((($valor-703)%676)/26);
<a name="l22027"></a>22027       $c3 = 65 + floor((($valor-703)%676)%26);
<a name="l22028"></a>22028     }
<a name="l22029"></a>22029   elseif ($valor &gt; 26) <span class="comment">// 2 letters (up to 702)</span>
<a name="l22030"></a>22030   {
<a name="l22031"></a>22031       $c1 = (64 + (int)(($valor-1) / 26));
<a name="l22032"></a>22032       $c2 = (64 + (int)($valor % 26));
<a name="l22033"></a>22033       <span class="keywordflow">if</span> ($c2 == 64) $c2 += 26;
<a name="l22034"></a>22034   }
<a name="l22035"></a>22035   <span class="keywordflow">else</span> <span class="comment">// 1 letter (up to 26)</span>
<a name="l22036"></a>22036   {
<a name="l22037"></a>22037       $c1 = (64 + $valor);
<a name="l22038"></a>22038   }
<a name="l22039"></a>22039   $alpha = chr($c1);
<a name="l22040"></a>22040   <span class="keywordflow">if</span> ($c2 != <span class="stringliteral">&#39;&#39;</span>) $alpha .= chr($c2);
<a name="l22041"></a>22041   <span class="keywordflow">if</span> ($c3 != <span class="stringliteral">&#39;&#39;</span>) $alpha .= chr($c3);
<a name="l22042"></a>22042   <span class="keywordflow">if</span> (!$toupper) $alpha = strtolower($alpha);
<a name="l22043"></a>22043   <span class="keywordflow">return</span> $alpha;
<a name="l22044"></a>22044 }
<a name="l22045"></a>22045 
<a name="l22046"></a>22046 
<a name="l22047"></a>22047 function dec2roman($valor,$toupper=<span class="keyword">true</span>){
<a name="l22048"></a>22048  <span class="comment">//returns a string as a roman numeral</span>
<a name="l22049"></a>22049   $r1=$r2=$r3=$r4=<span class="stringliteral">&#39;&#39;</span>;
<a name="l22050"></a>22050   <span class="keywordflow">if</span> (($valor &gt;= 5000) || ($valor &lt; 1)) <span class="keywordflow">return</span> <span class="stringliteral">&quot;?&quot;</span>; <span class="comment">//supports &#39;only&#39; up to 4999</span>
<a name="l22051"></a>22051   $aux = (int)($valor/1000);
<a name="l22052"></a>22052   <span class="keywordflow">if</span> ($aux!==0)
<a name="l22053"></a>22053   {
<a name="l22054"></a>22054     $valor %= 1000;
<a name="l22055"></a>22055     <span class="keywordflow">while</span>($aux!==0)
<a name="l22056"></a>22056     {
<a name="l22057"></a>22057       $r1 .= <span class="stringliteral">&quot;M&quot;</span>;
<a name="l22058"></a>22058       $aux--;
<a name="l22059"></a>22059     }
<a name="l22060"></a>22060   }
<a name="l22061"></a>22061   $aux = (int)($valor/100);
<a name="l22062"></a>22062   <span class="keywordflow">if</span> ($aux!==0)
<a name="l22063"></a>22063   {
<a name="l22064"></a>22064     $valor %= 100;
<a name="l22065"></a>22065     <span class="keywordflow">switch</span>($aux){
<a name="l22066"></a>22066       <span class="keywordflow">case</span> 3: $r2=<span class="stringliteral">&quot;C&quot;</span>;
<a name="l22067"></a>22067       <span class="keywordflow">case</span> 2: $r2.=<span class="stringliteral">&quot;C&quot;</span>;
<a name="l22068"></a>22068       <span class="keywordflow">case</span> 1: $r2.=<span class="stringliteral">&quot;C&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22069"></a>22069       <span class="keywordflow">case</span> 9: $r2=<span class="stringliteral">&quot;CM&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22070"></a>22070       <span class="keywordflow">case</span> 8: $r2=<span class="stringliteral">&quot;C&quot;</span>;
<a name="l22071"></a>22071       <span class="keywordflow">case</span> 7: $r2.=<span class="stringliteral">&quot;C&quot;</span>;
<a name="l22072"></a>22072       <span class="keywordflow">case</span> 6: $r2.=<span class="stringliteral">&quot;C&quot;</span>;
<a name="l22073"></a>22073       <span class="keywordflow">case</span> 5: $r2=<span class="stringliteral">&quot;D&quot;</span>.$r2; <span class="keywordflow">break</span>;
<a name="l22074"></a>22074       <span class="keywordflow">case</span> 4: $r2=<span class="stringliteral">&quot;CD&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22075"></a>22075       <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l22076"></a>22076     }
<a name="l22077"></a>22077   }
<a name="l22078"></a>22078   $aux = (int)($valor/10);
<a name="l22079"></a>22079   <span class="keywordflow">if</span> ($aux!==0)
<a name="l22080"></a>22080   {
<a name="l22081"></a>22081     $valor %= 10;
<a name="l22082"></a>22082     <span class="keywordflow">switch</span>($aux){
<a name="l22083"></a>22083       <span class="keywordflow">case</span> 3: $r3=<span class="stringliteral">&quot;X&quot;</span>;
<a name="l22084"></a>22084       <span class="keywordflow">case</span> 2: $r3.=<span class="stringliteral">&quot;X&quot;</span>;
<a name="l22085"></a>22085       <span class="keywordflow">case</span> 1: $r3.=<span class="stringliteral">&quot;X&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22086"></a>22086       <span class="keywordflow">case</span> 9: $r3=<span class="stringliteral">&quot;XC&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22087"></a>22087       <span class="keywordflow">case</span> 8: $r3=<span class="stringliteral">&quot;X&quot;</span>;
<a name="l22088"></a>22088       <span class="keywordflow">case</span> 7: $r3.=<span class="stringliteral">&quot;X&quot;</span>;
<a name="l22089"></a>22089       <span class="keywordflow">case</span> 6: $r3.=<span class="stringliteral">&quot;X&quot;</span>;
<a name="l22090"></a>22090       <span class="keywordflow">case</span> 5: $r3=<span class="stringliteral">&quot;L&quot;</span>.$r3; <span class="keywordflow">break</span>;
<a name="l22091"></a>22091       <span class="keywordflow">case</span> 4: $r3=<span class="stringliteral">&quot;XL&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22092"></a>22092       <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l22093"></a>22093     }
<a name="l22094"></a>22094   }
<a name="l22095"></a>22095   <span class="keywordflow">switch</span>($valor){
<a name="l22096"></a>22096     <span class="keywordflow">case</span> 3: $r4=<span class="stringliteral">&quot;I&quot;</span>;
<a name="l22097"></a>22097     <span class="keywordflow">case</span> 2: $r4.=<span class="stringliteral">&quot;I&quot;</span>;
<a name="l22098"></a>22098     <span class="keywordflow">case</span> 1: $r4.=<span class="stringliteral">&quot;I&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22099"></a>22099     <span class="keywordflow">case</span> 9: $r4=<span class="stringliteral">&quot;IX&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22100"></a>22100     <span class="keywordflow">case</span> 8: $r4=<span class="stringliteral">&quot;I&quot;</span>;
<a name="l22101"></a>22101     <span class="keywordflow">case</span> 7: $r4.=<span class="stringliteral">&quot;I&quot;</span>;
<a name="l22102"></a>22102     <span class="keywordflow">case</span> 6: $r4.=<span class="stringliteral">&quot;I&quot;</span>;
<a name="l22103"></a>22103     <span class="keywordflow">case</span> 5: $r4=<span class="stringliteral">&quot;V&quot;</span>.$r4; <span class="keywordflow">break</span>;
<a name="l22104"></a>22104     <span class="keywordflow">case</span> 4: $r4=<span class="stringliteral">&quot;IV&quot;</span>; <span class="keywordflow">break</span>;
<a name="l22105"></a>22105     <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l22106"></a>22106   }
<a name="l22107"></a>22107   $roman = $r1.$r2.$r3.$r4;
<a name="l22108"></a>22108   <span class="keywordflow">if</span> (!$toupper) $roman = strtolower($roman);
<a name="l22109"></a>22109   <span class="keywordflow">return</span> $roman;
<a name="l22110"></a>22110 }
<a name="l22111"></a>22111 
<a name="l22112"></a>22112 
<a name="l22113"></a>22113 <span class="comment">//===========================</span>
<a name="l22114"></a>22114   
<a name="l22115"></a>22115 
<a name="l22116"></a>22116 
<a name="l22117"></a>22117 }<span class="comment">//end of Class</span>
<a name="l22118"></a>22118 
<a name="l22119"></a>22119 
<a name="l22120"></a>22120 
<a name="l22121"></a>22121 
<a name="l22122"></a>22122 ?&gt;
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
