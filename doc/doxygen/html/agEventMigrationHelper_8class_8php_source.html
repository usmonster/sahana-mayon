<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/lib/packages/agEventPackage/lib/agEventMigrationHelper.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/lib/packages/agEventPackage/lib/agEventMigrationHelper.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00017"></a><a class="code" href="classagEventMigrationHelper.html">00017</a> <span class="keyword">class </span><a class="code" href="classagEventMigrationHelper.html" title="provides event facility management functions">agEventMigrationHelper</a>
<a name="l00018"></a>00018 {
<a name="l00019"></a>00019   <span class="keyword">const</span>     CONN_MIGRATION_WRITE = <span class="stringliteral">&#39;CONN_MIGRATION_WRITE&#39;</span>;
<a name="l00020"></a>00020   <span class="keyword">protected</span> $evFacGrps = 0,
<a name="l00021"></a>00021             $evFacRscs = 0,
<a name="l00022"></a>00022             $evShifts = 0,
<a name="l00023"></a>00023             $evStfRscs = 0,
<a name="l00024"></a>00024             $err = FALSE,
<a name="l00025"></a>00025             $conn,
<a name="l00026"></a>00026             $scenarioId,
<a name="l00027"></a>00027             $eventId,
<a name="l00028"></a>00028             $zeroHour,
<a name="l00029"></a>00029             $recTimestamp,
<a name="l00030"></a>00030             $startTime,
<a name="l00031"></a>00031             $endTime,
<a name="l00032"></a>00032             $batchSize,
<a name="l00033"></a>00033             $batchTime;
<a name="l00034"></a>00034 
<a name="l00035"></a>00035   <span class="keyword">public</span> function __construct() {
<a name="l00036"></a>00036     $this-&gt;batchSize = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_batch_size&#39;</span>);
<a name="l00037"></a>00037     $this-&gt;batchTime = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;bulk_operation_max_batch_time&#39;</span>);
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="comment">// all of this jazz helps us keep a low memory profile</span>
<a name="l00040"></a>00040     $dm = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l00041"></a>00041     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00042"></a>00042     $adapter = $dm-&gt;getCurrentConnection()-&gt;getDbh();
<a name="l00043"></a>00043     $this-&gt;conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>($adapter, self::CONN_MIGRATION_WRITE);
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     <span class="comment">// this will disable re-use of query objects but keeps the connection memory profile low</span>
<a name="l00046"></a>00046     $this-&gt;conn-&gt;setAttribute(Doctrine_Core::ATTR_AUTO_FREE_QUERY_OBJECTS, TRUE);
<a name="l00047"></a>00047     $this-&gt;conn-&gt;setAttribute(<a class="code" href="classDoctrine__Core.html#a91839462e9d627a6b20ed0629a98b77d" title="ATTRIBUTE CONSTANTS.">Doctrine_Core::ATTR_AUTOCOMMIT</a>, FALSE);
<a name="l00048"></a>00048     $this-&gt;conn-&gt;setAttribute(Doctrine_Core::ATTR_USE_DQL_CALLBACKS, FALSE);
<a name="l00049"></a>00049     $this-&gt;conn-&gt;setAttribute(Doctrine_Core::ATTR_AUTOLOAD_TABLE_CLASSES, FALSE);
<a name="l00050"></a>00050     $this-&gt;conn-&gt;setAttribute(Doctrine_Core::ATTR_VALIDATE, FALSE);
<a name="l00051"></a>00051     $this-&gt;conn-&gt;setAttribute(Doctrine_Core::ATTR_CASCADE_SAVES, FALSE);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     <span class="comment">// return back to our &#39;normal&#39; doctrine connection before moving further</span>
<a name="l00054"></a>00054     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00055"></a>00055   }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057   <span class="keyword">public</span> function __destruct() {
<a name="l00058"></a>00058     <span class="comment">// all of this jazz helps us keep a low memory profile</span>
<a name="l00059"></a>00059     $dm = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l00060"></a>00060     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     $dm-&gt;closeConnection($this-&gt;conn);
<a name="l00063"></a>00063   }
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00071"></a><a class="code" href="classagEventMigrationHelper.html#a4edaa9e79fff58f541e2165bbc1b9748">00071</a>   <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="classagEventMigrationHelper.html#a4edaa9e79fff58f541e2165bbc1b9748" title="Provides check information (count of empty facility groups) for this scenario.">facilityGroupCheck</a>($scenario_id)
<a name="l00072"></a>00072   {
<a name="l00073"></a>00073     $facilityGroupQuery = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00074"></a>00074         -&gt;select(<span class="stringliteral">&#39;aFG.id&#39;</span>)
<a name="l00075"></a>00075         -&gt;addSelect(<span class="stringliteral">&#39;aFG.scenario_facility_group&#39;</span>)
<a name="l00076"></a>00076         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup aFG&#39;</span>)
<a name="l00077"></a>00077         -&gt;leftJoin(<span class="stringliteral">&#39;aFG.agScenarioFacilityResource aFR&#39;</span>)
<a name="l00078"></a>00078         -&gt;where(<span class="stringliteral">&#39;aFR.id is NULL&#39;</span>)
<a name="l00079"></a>00079         -&gt;andWhere(<span class="stringliteral">&#39;aFG.scenario_id = ?&#39;</span>, $scenario_id);
<a name="l00080"></a>00080     $returnvalue = $facilityGroupQuery-&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00081"></a>00081     $facilityGroupQuery-&gt;free();
<a name="l00082"></a>00082     <span class="keywordflow">return</span> $returnvalue;
<a name="l00083"></a>00083   }
<a name="l00084"></a>00084 
<a name="l00090"></a><a class="code" href="classagEventMigrationHelper.html#a24876456bf35f0e9beea8d830f286320">00090</a>   <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="classagEventMigrationHelper.html#a24876456bf35f0e9beea8d830f286320" title="Provides check information (count of undefined facility and staff shifts) for this...">undefinedShiftCheck</a>($scenario_id)
<a name="l00091"></a>00091   {
<a name="l00092"></a>00092     $undefinedFacilityShiftQuery = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00093"></a>00093         -&gt;select(<span class="stringliteral">&#39;aFR.id&#39;</span>)
<a name="l00094"></a>00094         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityResource aFR&#39;</span>)
<a name="l00095"></a>00095         -&gt;innerJoin(<span class="stringliteral">&#39;aFR.agScenarioFacilityGroup aFG&#39;</span>)
<a name="l00096"></a>00096         -&gt;leftJoin(<span class="stringliteral">&#39;aFR.agScenarioShift aSS&#39;</span>)
<a name="l00097"></a>00097         -&gt;where(<span class="stringliteral">&#39;aSS.id is NULL&#39;</span>)
<a name="l00098"></a>00098         -&gt;andWhere(<span class="stringliteral">&#39;aFG.scenario_id =?&#39;</span>, $scenario_id); <span class="comment">//returns the facility resources without shift</span>
<a name="l00099"></a>00099     $facilityShiftReturn = $undefinedFacilityShiftQuery-&gt;execute(array(), agDoctrineQuery::HYDRATE_SINGLE_VALUE_ARRAY);
<a name="l00100"></a>00100     $undefinedFacilityShiftQuery-&gt;free();
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">return</span> $facilityShiftReturn;
<a name="l00103"></a>00103   }
<a name="l00104"></a>00104 
<a name="l00110"></a><a class="code" href="classagEventMigrationHelper.html#acefedf0fd375746e113d7e305c50b511">00110</a>   <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="classagEventMigrationHelper.html#acefedf0fd375746e113d7e305c50b511" title="Provides check information (count of staff resources) available for this scenario...">staffPoolCheck</a>($scenario_id)
<a name="l00111"></a>00111   {
<a name="l00112"></a>00112     $staffPoolCount = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00113"></a>00113         -&gt;select(<span class="stringliteral">&#39;COUNT(*)&#39;</span>)
<a name="l00114"></a>00114         -&gt;from(<span class="stringliteral">&#39;agScenarioStaffResource&#39;</span>)
<a name="l00115"></a>00115         -&gt;where(<span class="stringliteral">&#39;scenario_id =?&#39;</span>, $scenario_id)
<a name="l00116"></a>00116         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00117"></a>00117     <span class="keywordflow">return</span> $staffPoolCount;
<a name="l00118"></a>00118   }
<a name="l00119"></a>00119 
<a name="l00126"></a><a class="code" href="classagEventMigrationHelper.html#a5f355acea732667a4a5694fdb21b6237">00126</a>   <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="classagEventMigrationHelper.html#a5f355acea732667a4a5694fdb21b6237" title="Performs checks to see if a scenario is ready for deployment.">preMigrationCheck</a>($scenario_id)
<a name="l00127"></a>00127   {
<a name="l00128"></a>00128     <span class="comment">// 0. Pre check: check event status (only proceed if event status is pre-deploy), clean event related tables in pre-deploy state, empty facility group, undefined staff pool rules making sure pools not empty, undefined shifts for staff/facility resource.</span>
<a name="l00129"></a>00129     $facilityGroupCheck = <a class="code" href="classagEventMigrationHelper.html#a4edaa9e79fff58f541e2165bbc1b9748" title="Provides check information (count of empty facility groups) for this scenario.">self::facilityGroupCheck</a>($scenario_id);
<a name="l00130"></a>00130     $staffPoolCheck = <a class="code" href="classagEventMigrationHelper.html#acefedf0fd375746e113d7e305c50b511" title="Provides check information (count of staff resources) available for this scenario...">self::staffPoolCheck</a>($scenario_id);
<a name="l00131"></a>00131     $undefinedFacilityShifts = <a class="code" href="classagEventMigrationHelper.html#a24876456bf35f0e9beea8d830f286320" title="Provides check information (count of undefined facility and staff shifts) for this...">self::undefinedShiftCheck</a>($scenario_id);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;Empty facility groups&#39;</span> =&gt; $facilityGroupCheck, <span class="stringliteral">&#39;Staff pool count&#39;</span> =&gt; $staffPoolCheck, <span class="stringliteral">&#39;Undefined facility shifts&#39;</span> =&gt; $undefinedFacilityShifts);
<a name="l00134"></a>00134   }
<a name="l00135"></a>00135 
<a name="l00142"></a><a class="code" href="classagEventMigrationHelper.html#a7ce2c7246ba4ab83b99949cfe7a9b2e0">00142</a>   <span class="keyword">public</span> function <a class="code" href="classagEventMigrationHelper.html#a7ce2c7246ba4ab83b99949cfe7a9b2e0" title="Method to migrate a scenario data to an event.">migrateScenarioToEvent</a>($scenarioId, $eventId) {
<a name="l00143"></a>00143     <span class="comment">// re-set this at the start</span>
<a name="l00144"></a>00144     $this-&gt;err = FALSE;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <span class="comment">// first set some static declarations</span>
<a name="l00147"></a>00147     $this-&gt;startTime = microtime(TRUE);
<a name="l00148"></a>00148     $this-&gt;recTimestamp = date(<span class="stringliteral">&#39;Y-m-d H:i:s&#39;</span>, time());
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">// set our mirgration scenario / event</span>
<a name="l00151"></a>00151     $this-&gt;scenarioId = $scenarioId;
<a name="l00152"></a>00152     $this-&gt;eventId = $eventId;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="comment">// pick up the event zero hour now</span>
<a name="l00155"></a>00155     $this-&gt;zeroHour = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00156"></a>00156       -&gt;select(<span class="stringliteral">&#39;ae.zero_hour&#39;</span>)
<a name="l00157"></a>00157         -&gt;from(<span class="stringliteral">&#39;agEvent ae&#39;</span>)
<a name="l00158"></a>00158         -&gt;where(<span class="stringliteral">&#39;ae.id = ?&#39;</span>, $this-&gt;eventId)
<a name="l00159"></a>00159         -&gt;useResultCache(TRUE, 1800)
<a name="l00160"></a>00160         -&gt;execute(array(),<a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     $staffedAllocationStatus = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00163"></a>00163       -&gt;select(<span class="stringliteral">&#39;afras.id&#39;</span>)
<a name="l00164"></a>00164         -&gt;from(<span class="stringliteral">&#39;agFacilityResourceAllocationStatus afras&#39;</span>)
<a name="l00165"></a>00165         -&gt;where(<span class="stringliteral">&#39;afras.staffed = ?&#39;</span>, TRUE)
<a name="l00166"></a>00166         -&gt;useResultCache(TRUE, 3600)
<a name="l00167"></a>00167         -&gt;execute(array(),agDoctrineQuery::HYDRATE_SINGLE_VALUE_ARRAY);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">// yay, transactions = data integrity</span>
<a name="l00170"></a>00170     $this-&gt;conn-&gt;beginTransaction();
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment">// start by re-generating our staff pool</span>
<a name="l00173"></a>00173     set_time_limit($this-&gt;batchTime);
<a name="l00174"></a>00174     <span class="keywordflow">try</span> {
<a name="l00175"></a>00175       <a class="code" href="classagStaffGeneratorHelper.html#a975722e34edaa4f747bb8b394ee4f2d5" title="Method to generate a scenario staff pool using searches stored in the staff generator...">agStaffGeneratorHelper::generateStaffPool</a>($this-&gt;scenarioId, FALSE, $this-&gt;conn);
<a name="l00176"></a>00176     } <span class="keywordflow">catch</span>(Exception $e) {
<a name="l00177"></a>00177       $this-&gt;err = TRUE;
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     $this-&gt;conn-&gt;evictTables();
<a name="l00180"></a>00180     $this-&gt;conn-&gt;clear();
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     <span class="comment">// since we have staff on our mind, we might as well use them</span>
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (!$this-&gt;err) {
<a name="l00184"></a>00184       set_time_limit($this-&gt;batchTime);
<a name="l00185"></a>00185       <span class="keywordflow">try</span> {
<a name="l00186"></a>00186         $this-&gt;<a class="code" href="classagEventMigrationHelper.html#a0cec4769d024bd77bf861f21d7084c48" title="Method to migrate scenario staff to event staff.">migrateStaff</a>();
<a name="l00187"></a>00187       } <span class="keywordflow">catch</span>(Exception $e) {
<a name="l00188"></a>00188         $this-&gt;err = TRUE;
<a name="l00189"></a>00189       }
<a name="l00190"></a>00190       $this-&gt;conn-&gt;evictTables();
<a name="l00191"></a>00191       $this-&gt;conn-&gt;clear();
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="comment">// next we create our event facility groups</span>
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (!$this-&gt;err) {
<a name="l00196"></a>00196       set_time_limit($this-&gt;batchTime);
<a name="l00197"></a>00197       <span class="keywordflow">try</span> {
<a name="l00198"></a>00198         $evFacGrpStatusColl = $this-&gt;<a class="code" href="classagEventMigrationHelper.html#a6108d5ff01cbb4fe4aed55359357846d" title="Method to migrate facility groups to an event.">migrateFacilityGroups</a>();
<a name="l00199"></a>00199       } <span class="keywordflow">catch</span>(Exception $e) {
<a name="l00200"></a>00200         $this-&gt;err = TRUE;
<a name="l00201"></a>00201       }
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="comment">// then we create our facility resources</span>
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (!$this-&gt;err) {
<a name="l00206"></a>00206       set_time_limit($this-&gt;batchTime);
<a name="l00207"></a>00207       <span class="keywordflow">try</span> {
<a name="l00208"></a>00208         $scFacRscMap = $this-&gt;<a class="code" href="classagEventMigrationHelper.html#af91c8b38e0f4482770d5e34e672fd1f2" title="Method to migrate facility resources.">migrateFacilityResources</a>($evFacGrpStatusColl);
<a name="l00209"></a>00209       } <span class="keywordflow">catch</span>(Exception $e) {
<a name="l00210"></a>00210         $this-&gt;err = TRUE;
<a name="l00211"></a>00211       }
<a name="l00212"></a>00212       unset($evFacGrpStatusColl);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">// finally we create our shifts</span>
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (!$this-&gt;err) {
<a name="l00217"></a>00217       set_time_limit($this-&gt;batchTime);
<a name="l00218"></a>00218       <span class="keywordflow">try</span> {
<a name="l00219"></a>00219         $this-&gt;<a class="code" href="classagEventMigrationHelper.html#a834e77a7d9e211a4002ee630fefe679b" title="Method to migrate event shifts.">migrateShifts</a>($scFacRscMap);
<a name="l00220"></a>00220       } <span class="keywordflow">catch</span>(Exception $e) {
<a name="l00221"></a>00221         $this-&gt;err = TRUE;
<a name="l00222"></a>00222       }
<a name="l00223"></a>00223       unset($scFacRscMap);
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">// commit or rollback</span>
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (!$this-&gt;err) {
<a name="l00228"></a>00228       <span class="keywordflow">try</span> {
<a name="l00229"></a>00229         $this-&gt;conn-&gt;commit();
<a name="l00230"></a>00230       } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00231"></a>00231         $err = TRUE;
<a name="l00232"></a>00232       }
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="keywordflow">if</span> ($this-&gt;err) {
<a name="l00236"></a>00236       $this-&gt;conn-&gt;rollBack();
<a name="l00237"></a>00237       <span class="keywordflow">throw</span> $e;
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     $this-&gt;endTime = microtime(TRUE);
<a name="l00241"></a>00241     $duration = $this-&gt;endTime - $this-&gt;startTime;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     $results = array();
<a name="l00244"></a>00244     $results[<span class="stringliteral">&#39;Facility Groups&#39;</span>] = $this-&gt;evFacGrps;
<a name="l00245"></a>00245     $results[<span class="stringliteral">&#39;Facility Resources&#39;</span>] = $this-&gt;evFacRscs;
<a name="l00246"></a>00246     $results[<span class="stringliteral">&#39;Shifts&#39;</span>] = $this-&gt;evShifts;
<a name="l00247"></a>00247     $results[<span class="stringliteral">&#39;Staffs&#39;</span>] = $this-&gt;evStfRscs;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="keywordflow">return</span> $results;
<a name="l00250"></a>00250   }
<a name="l00251"></a>00251 
<a name="l00255"></a><a class="code" href="classagEventMigrationHelper.html#a0cec4769d024bd77bf861f21d7084c48">00255</a>   <span class="keyword">protected</span> function <a class="code" href="classagEventMigrationHelper.html#a0cec4769d024bd77bf861f21d7084c48" title="Method to migrate scenario staff to event staff.">migrateStaff</a>() {
<a name="l00256"></a>00256     <span class="comment">// this will be default staff status applied to all new event staff</span>
<a name="l00257"></a>00257     $unAllocatedStaffStatus = <a class="code" href="classagEventStaffHelper.html#a012970b5aec75d4650eac76615a9397d" title="method to retrieve the default event staff status for new staff">agEventStaffHelper::returnDefaultEventStaffStatus</a>();
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">// pretty standard object instantiation</span>
<a name="l00260"></a>00260     $eventStaffTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventStaffBulkLoad&#39;</span>);
<a name="l00261"></a>00261     $eventStaffStatusTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventStaffStatus&#39;</span>);
<a name="l00262"></a>00262     $evStaffColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventStaffBulkLoad&#39;</span>);
<a name="l00263"></a>00263     $evStaffStatusColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventStaffStatus&#39;</span>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="comment">// get our scenario staff</span>
<a name="l00266"></a>00266     $existingScenarioStaff = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00267"></a>00267       -&gt;select(<span class="stringliteral">&#39;ssr.*&#39;</span>)
<a name="l00268"></a>00268         -&gt;from(<span class="stringliteral">&#39;agScenarioStaffResource ssr&#39;</span>)
<a name="l00269"></a>00269         -&gt;where(<span class="stringliteral">&#39;scenario_id = ?&#39;</span>, $this-&gt;scenarioId)
<a name="l00270"></a>00270         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a60ede861db6c2521d7e74124fdb3b9c1" title="HYDRATE_ON_DEMAND.">Doctrine_Core::HYDRATE_ON_DEMAND</a>);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     $this-&gt;evStfRscs = 0;
<a name="l00273"></a>00273     <span class="keywordflow">foreach</span> ($existingScenarioStaff AS $scenStfPool) {
<a name="l00274"></a>00274       <span class="comment">// start by iterating our iterator</span>
<a name="l00275"></a>00275       $this-&gt;evStfRscs++;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277       <span class="comment">// create an agEventStaff record</span>
<a name="l00278"></a>00278       $eventStaff = <span class="keyword">new</span> <a class="code" href="classagEventStaffBulkLoad.html" title="agEventStaffBulkLoad is an extension of base class agEventStaff">agEventStaffBulkLoad</a>($eventStaffTable, TRUE);
<a name="l00279"></a>00279       $eventStaff[<span class="stringliteral">&#39;event_id&#39;</span>] = $this-&gt;eventId;
<a name="l00280"></a>00280       $eventStaff[<span class="stringliteral">&#39;staff_resource_id&#39;</span>] = $scenStfPool[<span class="stringliteral">&#39;staff_resource_id&#39;</span>];
<a name="l00281"></a>00281       $eventStaff[<span class="stringliteral">&#39;deployment_weight&#39;</span>] = $scenStfPool[<span class="stringliteral">&#39;deployment_weight&#39;</span>];
<a name="l00282"></a>00282       $evStaffColl-&gt;add($eventStaff);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284       <span class="keywordflow">if</span> (($this-&gt;evStfRscs % $this-&gt;batchSize) == 0) {
<a name="l00285"></a>00285         $evStaffColl-&gt;save($this-&gt;conn);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="comment">// create the staff status records in a batch</span>
<a name="l00288"></a>00288         <span class="keywordflow">foreach</span> ($evStaffColl as $evStaff) {
<a name="l00289"></a>00289           $eventStaffStatus = <span class="keyword">new</span> <a class="code" href="classagEventStaffStatus.html">agEventStaffStatus</a>($eventStaffStatusTable, TRUE);
<a name="l00290"></a>00290           $eventStaffStatus[<span class="stringliteral">&#39;event_staff_id&#39;</span>] = $evStaff[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00291"></a>00291           $eventStaffStatus[<span class="stringliteral">&#39;time_stamp&#39;</span>] = $this-&gt;recTimestamp;
<a name="l00292"></a>00292           $eventStaffStatus[<span class="stringliteral">&#39;staff_allocation_status_id&#39;</span>] = $unAllocatedStaffStatus;
<a name="l00293"></a>00293           $evStaffStatusColl-&gt;add($eventStaffStatus);
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         $evStaffStatusColl-&gt;save($this-&gt;conn);
<a name="l00297"></a>00297         $evStaffColl-&gt;free(TRUE);
<a name="l00298"></a>00298         $evStaffStatusColl-&gt;free(TRUE);
<a name="l00299"></a>00299         $evStaffColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventStaffBulkLoad&#39;</span>);
<a name="l00300"></a>00300         $evStaffStatusColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventStaffStatus&#39;</span>);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         set_time_limit($this-&gt;batchTime);
<a name="l00303"></a>00303       }
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="comment">// now we sweep all the leftovers that weren&#39;t caught in a batch process</span>
<a name="l00307"></a>00307     <span class="keywordflow">if</span> ($evStaffColl-&gt;isModified()) {
<a name="l00308"></a>00308       $evStaffColl-&gt;save($this-&gt;conn);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310       <span class="comment">// create the staff status record</span>
<a name="l00311"></a>00311       <span class="keywordflow">foreach</span> ($evStaffColl as $evStaff) {
<a name="l00312"></a>00312         $eventStaffStatus = <span class="keyword">new</span> <a class="code" href="classagEventStaffStatus.html">agEventStaffStatus</a>($eventStaffStatusTable, TRUE);
<a name="l00313"></a>00313         $eventStaffStatus[<span class="stringliteral">&#39;event_staff_id&#39;</span>] = $evStaff[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00314"></a>00314         $eventStaffStatus[<span class="stringliteral">&#39;time_stamp&#39;</span>] = $this-&gt;recTimestamp;
<a name="l00315"></a>00315         $eventStaffStatus[<span class="stringliteral">&#39;staff_allocation_status_id&#39;</span>] = $unAllocatedStaffStatus;
<a name="l00316"></a>00316         $evStaffStatusColl-&gt;add($eventStaffStatus);
<a name="l00317"></a>00317       }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319       $evStaffStatusColl-&gt;save($this-&gt;conn);
<a name="l00320"></a>00320       $evStaffColl-&gt;free(TRUE);
<a name="l00321"></a>00321       $evStaffStatusColl-&gt;free(TRUE);
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323   }
<a name="l00328"></a><a class="code" href="classagEventMigrationHelper.html#a6108d5ff01cbb4fe4aed55359357846d">00328</a>   <span class="keyword">protected</span> function <a class="code" href="classagEventMigrationHelper.html#a6108d5ff01cbb4fe4aed55359357846d" title="Method to migrate facility groups to an event.">migrateFacilityGroups</a>() {
<a name="l00329"></a>00329     <span class="comment">// pretty standard collections pre-config</span>
<a name="l00330"></a>00330     $evFacGrpTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventFacilityGroup&#39;</span>);
<a name="l00331"></a>00331     $evFacGrpStatusTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventFacilityGroupStatus&#39;</span>);
<a name="l00332"></a>00332     $evFacGrpColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventFacilityGroup&#39;</span>);
<a name="l00333"></a>00333     $evFacGrpStatusColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventFacilityGroupStatus&#39;</span>);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     $scenarioFacilityGroups = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00336"></a>00336       -&gt;select(<span class="stringliteral">&#39;sfg.id&#39;</span>)
<a name="l00337"></a>00337         -&gt;addSelect(<span class="stringliteral">&#39;sfg.scenario_facility_group&#39;</span>)
<a name="l00338"></a>00338         -&gt;addSelect(<span class="stringliteral">&#39;sfg.facility_group_type_id&#39;</span>)
<a name="l00339"></a>00339         -&gt;addSelect(<span class="stringliteral">&#39;sfg.facility_group_allocation_status_id&#39;</span>)
<a name="l00340"></a>00340         -&gt;addSelect(<span class="stringliteral">&#39;sfg.activation_sequence&#39;</span>)
<a name="l00341"></a>00341         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityGroup sfg INDEXBY sfg.id&#39;</span>)
<a name="l00342"></a>00342         -&gt;where(<span class="stringliteral">&#39;sfg.scenario_id = ?&#39;</span>, $this-&gt;scenarioId)
<a name="l00343"></a>00343         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#aa98a2c96d8437e185eccacf15c81604c" title="HYDRATE_ARRAY.">Doctrine_Core::HYDRATE_ARRAY</a>);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="comment">// always set this back to zero in case it&#39;s being called again</span>
<a name="l00346"></a>00346     $this-&gt;evFacGrps = 0;
<a name="l00347"></a>00347     <span class="keywordflow">foreach</span> ($scenarioFacilityGroups as $scenFacGrpId =&gt; $scenFacGrp) {
<a name="l00348"></a>00348       $evFacGrp = <span class="keyword">new</span> <a class="code" href="classagEventFacilityGroup.html">agEventFacilityGroup</a>($evFacGrpTable, TRUE);
<a name="l00349"></a>00349       $evFacGrp[<span class="stringliteral">&#39;event_id&#39;</span>] = $this-&gt;eventId;
<a name="l00350"></a>00350       $evFacGrp[<span class="stringliteral">&#39;event_facility_group&#39;</span>] = $scenFacGrp[<span class="stringliteral">&#39;scenario_facility_group&#39;</span>];
<a name="l00351"></a>00351       $evFacGrp[<span class="stringliteral">&#39;facility_group_type_id&#39;</span>] = $scenFacGrp[<span class="stringliteral">&#39;facility_group_type_id&#39;</span>];
<a name="l00352"></a>00352       $evFacGrp[<span class="stringliteral">&#39;activation_sequence&#39;</span>] = $scenFacGrp[<span class="stringliteral">&#39;activation_sequence&#39;</span>];
<a name="l00353"></a>00353 
<a name="l00354"></a>00354       $evFacGrpColl-&gt;add($evFacGrp, $scenFacGrpId);
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     $evFacGrpColl-&gt;save($this-&gt;conn);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="keywordflow">foreach</span> ($evFacGrpColl as $scenFacGrpId =&gt; $evFacGrp) {
<a name="l00360"></a>00360       $evFacGrpStatus = <span class="keyword">new</span> <a class="code" href="classagEventFacilityGroupStatus.html">agEventFacilityGroupStatus</a>($evFacGrpStatusTable, TRUE);
<a name="l00361"></a>00361       $evFacGrpStatus[<span class="stringliteral">&#39;event_facility_group_id&#39;</span>] = $evFacGrp[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00362"></a>00362       $evFacGrpStatus[<span class="stringliteral">&#39;time_stamp&#39;</span>] = $this-&gt;recTimestamp;
<a name="l00363"></a>00363       $evFacGrpStatus[<span class="stringliteral">&#39;facility_group_allocation_status_id&#39;</span>] = $scenarioFacilityGroups[$scenFacGrpId][<span class="stringliteral">&#39;facility_group_allocation_status_id&#39;</span>];
<a name="l00364"></a>00364       $evFacGrpStatusColl-&gt;add($evFacGrpStatus, $scenFacGrpId);
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     $evFacGrpStatusColl-&gt;save($this-&gt;conn);
<a name="l00368"></a>00368     $evFacGrpColl-&gt;free(TRUE);
<a name="l00369"></a>00369     unset($evFacGrpColl);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     <span class="keywordflow">return</span> $evFacGrpStatusColl;
<a name="l00372"></a>00372   }
<a name="l00373"></a>00373 
<a name="l00379"></a><a class="code" href="classagEventMigrationHelper.html#af91c8b38e0f4482770d5e34e672fd1f2">00379</a>   <span class="keyword">protected</span> function <a class="code" href="classagEventMigrationHelper.html#af91c8b38e0f4482770d5e34e672fd1f2" title="Method to migrate facility resources.">migrateFacilityResources</a>(<a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a> $evFacGrpStatusColl) {
<a name="l00380"></a>00380     <span class="comment">// use some explicit declarations at the top</span>
<a name="l00381"></a>00381     $scFacRscMap = (object) array();
<a name="l00382"></a>00382     $activeGrpScFacRsc = array();
<a name="l00383"></a>00383     $evFacRscTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventFacilityResource&#39;</span>);
<a name="l00384"></a>00384     $evFacRscStatusTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventFacilityResourceStatusBulkLoad&#39;</span>);
<a name="l00385"></a>00385     $evFacRscActivationTable = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventFacilityResourceActivationTime&#39;</span>);
<a name="l00386"></a>00386     $evFacRscColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventFacilityResource&#39;</span>);
<a name="l00387"></a>00387     $evFacRscStatusColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventFacilityResourceStatusBulkLoad&#39;</span>);
<a name="l00388"></a>00388     $evFacRscActivationColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventFacilityResourceActivationTime&#39;</span>);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="comment">// get our allocation status</span>
<a name="l00391"></a>00391     $staffedResourceAllocationStatus = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00392"></a>00392       -&gt;select(<span class="stringliteral">&#39;afras.id&#39;</span>)
<a name="l00393"></a>00393         -&gt;addSelect(<span class="stringliteral">&#39;afras.staffed&#39;</span>)
<a name="l00394"></a>00394       -&gt;from(<span class="stringliteral">&#39;agFacilityResourceAllocationStatus afras&#39;</span>)
<a name="l00395"></a>00395       -&gt;where(<span class="stringliteral">&#39;afras.staffed = ?&#39;</span>, TRUE)
<a name="l00396"></a>00396       -&gt;useResultCache(TRUE, 3600)
<a name="l00397"></a>00397       -&gt;execute(array(),agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     $activeGroupAllocationStatus = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00400"></a>00400       -&gt;select(<span class="stringliteral">&#39;afgas.id&#39;</span>)
<a name="l00401"></a>00401         -&gt;addSelect(<span class="stringliteral">&#39;afgas.active&#39;</span>)
<a name="l00402"></a>00402         -&gt;from(<span class="stringliteral">&#39;agFacilityGroupAllocationStatus afgas&#39;</span>)
<a name="l00403"></a>00403         -&gt;where(<span class="stringliteral">&#39;active = ?&#39;</span>, TRUE)
<a name="l00404"></a>00404         -&gt;useResultCache(TRUE,3600)
<a name="l00405"></a>00405         -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="comment">// instantiate our fac resource iterator</span>
<a name="l00408"></a>00408     $scenarioFacilityResources = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00409"></a>00409       -&gt;select(<span class="stringliteral">&#39;sfr.*&#39;</span>)
<a name="l00410"></a>00410         -&gt;from(<span class="stringliteral">&#39;agScenarioFacilityResource sfr INDEXBY sfr.id&#39;</span>)
<a name="l00411"></a>00411         -&gt;whereIn(<span class="stringliteral">&#39;sfr.scenario_facility_group_id&#39;</span>, $evFacGrpStatusColl-&gt;<a class="code" href="classDoctrine__Collection.html#a0eae1b5c7f95c6d405b89f944854a3b2" title="Get all keys of the data in the collection.">getKeys</a>())
<a name="l00412"></a>00412         -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#aa98a2c96d8437e185eccacf15c81604c" title="HYDRATE_ARRAY.">Doctrine_Core::HYDRATE_ARRAY</a>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     $this-&gt;evFacRscs = 0;
<a name="l00415"></a>00415     <span class="keywordflow">foreach</span> ($scenarioFacilityResources as $scFacRscId =&gt; $scFacRsc) {
<a name="l00416"></a>00416       $this-&gt;evFacRscs++;
<a name="l00417"></a>00417       $evFacGrp = $evFacGrpStatusColl[$scFacRsc[<span class="stringliteral">&#39;scenario_facility_group_id&#39;</span>]];
<a name="l00418"></a>00418 
<a name="l00419"></a>00419       $evFacRsc = <span class="keyword">new</span> <a class="code" href="classagEventFacilityResource.html">agEventFacilityResource</a>($evFacRscTable, TRUE);
<a name="l00420"></a>00420       $evFacRsc[<span class="stringliteral">&#39;event_facility_group_id&#39;</span>] = $evFacGrp[<span class="stringliteral">&#39;event_facility_group_id&#39;</span>];
<a name="l00421"></a>00421       $evFacRsc[<span class="stringliteral">&#39;facility_resource_id&#39;</span>] = $scFacRsc[<span class="stringliteral">&#39;facility_resource_id&#39;</span>];
<a name="l00422"></a>00422       $evFacRsc[<span class="stringliteral">&#39;activation_sequence&#39;</span>] = $scFacRsc[<span class="stringliteral">&#39;activation_sequence&#39;</span>];
<a name="l00423"></a>00423       $evFacRscColl-&gt;add($evFacRsc, $scFacRscId);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       <span class="comment">// we hold onto the group allocation status for activation time setting</span>
<a name="l00426"></a>00426       <span class="keywordflow">if</span> (isset($activeGroupAllocationStatus[$evFacGrp[<span class="stringliteral">&#39;facility_group_allocation_status_id&#39;</span>]])) {
<a name="l00427"></a>00427         $activeGrpScFacRsc[$scFacRscId] = TRUE;
<a name="l00428"></a>00428       }
<a name="l00429"></a>00429     }
<a name="l00430"></a>00430     
<a name="l00431"></a>00431     <span class="comment">// release a little memory</span>
<a name="l00432"></a>00432     $evFacGrpStatusColl-&gt;<a class="code" href="classDoctrine__Collection.html#a0f1ae718fee4f64c4da8304c51ea6e96" title="Frees the resources used by the collection.">free</a>(TRUE);
<a name="l00433"></a>00433     unset($evFacGrpStatusColl);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">// save the collection to get the new ids, now iterate and create status records</span>
<a name="l00436"></a>00436     $evFacRscColl-&gt;save($this-&gt;conn);
<a name="l00437"></a>00437     <span class="keywordflow">foreach</span> ($evFacRscColl as $scFacRscId =&gt; $evFacRsc) {
<a name="l00438"></a>00438       $evFacRscStatus = <span class="keyword">new</span> <a class="code" href="classagEventFacilityResourceStatusBulkLoad.html" title="agEventFacilityResourceStatusBulkLoad is used for bulk-load initial operations and...">agEventFacilityResourceStatusBulkLoad</a>($evFacRscStatusTable, TRUE);
<a name="l00439"></a>00439       $evFacRscStatus[<span class="stringliteral">&#39;event_facility_resource_id&#39;</span>] = $evFacRsc[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00440"></a>00440       $evFacRscStatus[<span class="stringliteral">&#39;time_stamp&#39;</span>] = $this-&gt;recTimestamp;
<a name="l00441"></a>00441       $evFacRscStatus[<span class="stringliteral">&#39;facility_resource_allocation_status_id&#39;</span>] = $scenarioFacilityResources[$scFacRscId][<span class="stringliteral">&#39;facility_resource_allocation_status_id&#39;</span>];
<a name="l00442"></a>00442       $evFacRscStatusColl-&gt;add($evFacRscStatus, $scFacRscId);
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="comment">// free a little memory</span>
<a name="l00446"></a>00446     unset($evFacRsc);
<a name="l00447"></a>00447     $evFacRscColl-&gt;free(TRUE);
<a name="l00448"></a>00448     unset($evFacRscColl);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="comment">// save and check whether or not we need to add an activation time</span>
<a name="l00451"></a>00451     $evFacRscStatusColl-&gt;save($this-&gt;conn);
<a name="l00452"></a>00452     <span class="keywordflow">foreach</span>($evFacRscStatusColl as $scFacRscId =&gt; $evFacRscStatus) {
<a name="l00453"></a>00453       <span class="comment">// going to use this twice, might as well only pay for it once</span>
<a name="l00454"></a>00454       $evFacRscId = $evFacRscStatus[<span class="stringliteral">&#39;event_facility_resource_id&#39;</span>];
<a name="l00455"></a>00455 
<a name="l00456"></a>00456       <span class="comment">// build this map for pass-through to the next series of methods</span>
<a name="l00457"></a>00457       $scFacRscMap-&gt;$scFacRscId = $evFacRscId;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459       <span class="comment">// check for conditions that indicate a new activation time record</span>
<a name="l00460"></a>00460       <span class="keywordflow">if</span>(isset($staffedResourceAllocationStatus[$evFacRscStatus[<span class="stringliteral">&#39;facility_resource_allocation_status_id&#39;</span>]]) &amp;&amp;
<a name="l00461"></a>00461         isset($activeGrpScFacRsc[$scFacRscId])) {
<a name="l00462"></a>00462         $evFacRscActivation = <span class="keyword">new</span> <a class="code" href="classagEventFacilityResourceActivationTime.html">agEventFacilityResourceActivationTime</a>($evFacRscActivationTable, TRUE);
<a name="l00463"></a>00463         $evFacRscActivation[<span class="stringliteral">&#39;event_facility_resource_id&#39;</span>] = $evFacRscId;
<a name="l00464"></a>00464         $evFacRscActivation[<span class="stringliteral">&#39;activation_time&#39;</span>] = $this-&gt;zeroHour;
<a name="l00465"></a>00465         $evFacRscActivationColl-&gt;add($evFacRscActivation);
<a name="l00466"></a>00466       }
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468     unset($evFacRscStatus);
<a name="l00469"></a>00469     $evFacRscStatusColl-&gt;free(TRUE);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     $evFacRscActivationColl-&gt;save($this-&gt;conn);
<a name="l00472"></a>00472     $evFacRscActivationColl-&gt;free(TRUE);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keywordflow">return</span> $scFacRscMap;
<a name="l00475"></a>00475   }
<a name="l00476"></a>00476 
<a name="l00482"></a><a class="code" href="classagEventMigrationHelper.html#a834e77a7d9e211a4002ee630fefe679b">00482</a>   <span class="keyword">protected</span> function <a class="code" href="classagEventMigrationHelper.html#a834e77a7d9e211a4002ee630fefe679b" title="Method to migrate event shifts.">migrateShifts</a>(stdClass $scFacRscMap)
<a name="l00483"></a>00483   {
<a name="l00484"></a>00484     <span class="comment">// we only need to do this once</span>
<a name="l00485"></a>00485     $table = $this-&gt;conn-&gt;getTable(<span class="stringliteral">&#39;agEventShift&#39;</span>);
<a name="l00486"></a>00486     $this-&gt;evShifts = 0;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">// iterate each facility resource</span>
<a name="l00489"></a>00489     <span class="keywordflow">foreach</span> ($scFacRscMap as $scenarioFacilityResourceId =&gt; $eventFacilityResourceId) {
<a name="l00490"></a>00490       <span class="comment">// reset our timer</span>
<a name="l00491"></a>00491       set_time_limit($this-&gt;batchTime);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493       <span class="comment">// create a new collection</span>
<a name="l00494"></a>00494       $coll = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agEventShift&#39;</span>);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496       <span class="comment">// query for the shifts associated with this facility resource</span>
<a name="l00497"></a>00497       $scenarioShifts = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>($this-&gt;conn)
<a name="l00498"></a>00498         -&gt;select(<span class="stringliteral">&#39;ss.*&#39;</span>)
<a name="l00499"></a>00499           -&gt;from(<span class="stringliteral">&#39;agScenarioShift ss&#39;</span>)
<a name="l00500"></a>00500           -&gt;where(<span class="stringliteral">&#39;ss.scenario_facility_resource_id = ?&#39;</span>, $scenarioFacilityResourceId)
<a name="l00501"></a>00501           -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#aa98a2c96d8437e185eccacf15c81604c" title="HYDRATE_ARRAY.">Doctrine_Core::HYDRATE_ARRAY</a>);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503       <span class="comment">// add the shifts to the collection</span>
<a name="l00504"></a>00504       <span class="keywordflow">foreach</span> ($scenarioShifts as $scenShift) {
<a name="l00505"></a>00505         $this-&gt;evShifts++;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="comment">// create a new shift record</span>
<a name="l00508"></a>00508         $eventShift = <span class="keyword">new</span> <a class="code" href="classagEventShift.html">agEventShift</a>($table, TRUE);
<a name="l00509"></a>00509         $eventShift[<span class="stringliteral">&#39;event_facility_resource_id&#39;</span>] = $eventFacilityResourceId;
<a name="l00510"></a>00510         $eventShift[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>] = $scenShift[<span class="stringliteral">&#39;staff_resource_type_id&#39;</span>];
<a name="l00511"></a>00511         $eventShift[<span class="stringliteral">&#39;minimum_staff&#39;</span>] = $scenShift[<span class="stringliteral">&#39;minimum_staff&#39;</span>];
<a name="l00512"></a>00512         $eventShift[<span class="stringliteral">&#39;maximum_staff&#39;</span>] = $scenShift[<span class="stringliteral">&#39;maximum_staff&#39;</span>];
<a name="l00513"></a>00513         $eventShift[<span class="stringliteral">&#39;minutes_start_to_facility_activation&#39;</span>] = $scenShift[<span class="stringliteral">&#39;minutes_start_to_facility_activation&#39;</span>];
<a name="l00514"></a>00514         $eventShift[<span class="stringliteral">&#39;task_length_minutes&#39;</span>] = $scenShift[<span class="stringliteral">&#39;task_length_minutes&#39;</span>];
<a name="l00515"></a>00515         $eventShift[<span class="stringliteral">&#39;break_length_minutes&#39;</span>] = $scenShift[<span class="stringliteral">&#39;break_length_minutes&#39;</span>];
<a name="l00516"></a>00516         $eventShift[<span class="stringliteral">&#39;task_id&#39;</span>] = $scenShift[<span class="stringliteral">&#39;task_id&#39;</span>];
<a name="l00517"></a>00517         $eventShift[<span class="stringliteral">&#39;shift_status_id&#39;</span>] = $scenShift[<span class="stringliteral">&#39;shift_status_id&#39;</span>];
<a name="l00518"></a>00518         $eventShift[<span class="stringliteral">&#39;staff_wave&#39;</span>] = $scenShift[<span class="stringliteral">&#39;staff_wave&#39;</span>];
<a name="l00519"></a>00519         $eventShift[<span class="stringliteral">&#39;deployment_algorithm_id&#39;</span>] = $scenShift[<span class="stringliteral">&#39;deployment_algorithm_id&#39;</span>];
<a name="l00520"></a>00520         $eventShift[<span class="stringliteral">&#39;originator_id&#39;</span>] = $scenShift[<span class="stringliteral">&#39;originator_id&#39;</span>];
<a name="l00521"></a>00521 
<a name="l00522"></a>00522         <span class="comment">// add the record to our collection</span>
<a name="l00523"></a>00523         $coll-&gt;add($eventShift);
<a name="l00524"></a>00524       }
<a name="l00525"></a>00525 
<a name="l00526"></a>00526       <span class="comment">// save the collection and release circular references</span>
<a name="l00527"></a>00527       $coll-&gt;save($this-&gt;conn);
<a name="l00528"></a>00528       $coll-&gt;free(TRUE);
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530   }
<a name="l00531"></a>00531 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
