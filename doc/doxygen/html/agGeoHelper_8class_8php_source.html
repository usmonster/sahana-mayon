<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/lib/util/agGeoHelper.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/lib/util/agGeoHelper.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00015"></a><a class="code" href="classagGeoHelper.html">00015</a> <span class="keyword">class </span><a class="code" href="classagGeoHelper.html" title="Provides bulk-address manipulation methods.">agGeoHelper</a> <span class="keyword">extends</span> <a class="code" href="classagBulkRecordHelper.html" title="Abstract class to provide bulk-address manipulation methods.">agBulkRecordHelper</a>
<a name="l00016"></a>00016 {
<a name="l00017"></a>00017   <span class="keyword">public</span>    $enforceGeoType = TRUE ;
<a name="l00018"></a>00018 
<a name="l00019"></a>00019   <span class="keyword">protected</span> $_globalDefaultAddressGeoType = <span class="stringliteral">&#39;default_address_geo_type&#39;</span>,
<a name="l00020"></a>00020             $_globalDefaultGeoMatchScore = <span class="stringliteral">&#39;default_geo_match_score&#39;</span>,
<a name="l00021"></a>00021             $_agGeoTypeData,
<a name="l00022"></a>00022             $_addressGeoTypeId,
<a name="l00023"></a>00023             $_defaultGeoMatchScoreId;
<a name="l00024"></a>00024 
<a name="l00034"></a><a class="code" href="classagGeoHelper.html#a2e9b38fc07ad93bec0c86473d84ec091">00034</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#a2e9b38fc07ad93bec0c86473d84ec091" title="Minimalist helper function to return the _agGeoTypeData property and lazy-load its...">getAgGeoTypeData</a>($geoTypeId)
<a name="l00035"></a>00035   {
<a name="l00036"></a>00036     <span class="keywordflow">if</span> (! isset($this-&gt;_agGeoTypeData)) { $this-&gt;<a class="code" href="classagGeoHelper.html#a2a20ea0dd4eb1852cbe84aa83d58f8c1" title="Minimalist helper function to load agGeoTypeData with data from the agGeoType table...">setAgGeoTypeData</a>() ; }
<a name="l00037"></a>00037     <span class="keywordflow">return</span> $this-&gt;_agGeoTypeData[$geoTypeId] ;
<a name="l00038"></a>00038   }
<a name="l00039"></a>00039 
<a name="l00043"></a><a class="code" href="classagGeoHelper.html#a2a20ea0dd4eb1852cbe84aa83d58f8c1">00043</a>   <span class="keyword">protected</span> function <a class="code" href="classagGeoHelper.html#a2a20ea0dd4eb1852cbe84aa83d58f8c1" title="Minimalist helper function to load agGeoTypeData with data from the agGeoType table...">setAgGeoTypeData</a>()
<a name="l00044"></a>00044   {
<a name="l00045"></a>00045     <span class="comment">// create our query object</span>
<a name="l00046"></a>00046     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00047"></a>00047       -&gt;select(<span class="stringliteral">&#39;gt.id&#39;</span>)
<a name="l00048"></a>00048           -&gt;addSelect(<span class="stringliteral">&#39;minimum_coordinate_points&#39;</span>)
<a name="l00049"></a>00049           -&gt;addSelect(<span class="stringliteral">&#39;maximum_coordinate_points&#39;</span>)
<a name="l00050"></a>00050         -&gt;from(<span class="stringliteral">&#39;agGeoType gt&#39;</span>) ;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052     <span class="comment">// execute and set our property</span>
<a name="l00053"></a>00053     $this-&gt;_agGeoTypeData = $q-&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_ARRAY) ;
<a name="l00054"></a>00054   }
<a name="l00055"></a>00055 
<a name="l00060"></a><a class="code" href="classagGeoHelper.html#aee50e0cd87f6ff0b79c0238876638bcc">00060</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#aee50e0cd87f6ff0b79c0238876638bcc" title="Small getter to lazily load and return the default address geo-type id.">getAddressGeoTypeId</a>()
<a name="l00061"></a>00061   {
<a name="l00062"></a>00062     <span class="keywordflow">if</span> (! isset($this-&gt;_addressGeoTypeId)) { $this-&gt;<a class="code" href="classagGeoHelper.html#aa390030f2ecfaf156af7861873030f73" title="Minimalist helper function to load the default geo-type for addresses.">setAddressGeoTypeId</a>() ; }
<a name="l00063"></a>00063     <span class="keywordflow">return</span> $this-&gt;_addressGeoTypeId ;
<a name="l00064"></a>00064   }
<a name="l00065"></a>00065 
<a name="l00069"></a><a class="code" href="classagGeoHelper.html#aa390030f2ecfaf156af7861873030f73">00069</a>   <span class="keyword">protected</span> function <a class="code" href="classagGeoHelper.html#aa390030f2ecfaf156af7861873030f73" title="Minimalist helper function to load the default geo-type for addresses.">setAddressGeoTypeId</a>()
<a name="l00070"></a>00070   {
<a name="l00071"></a>00071     $geoType = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>($this-&gt;_globalDefaultAddressGeoType) ;
<a name="l00072"></a>00072     $geoTypeId = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00073"></a>00073       -&gt;select(<span class="stringliteral">&#39;gt.id&#39;</span>)
<a name="l00074"></a>00074         -&gt;from(<span class="stringliteral">&#39;agGeoType gt&#39;</span>)
<a name="l00075"></a>00075         -&gt;where(<span class="stringliteral">&#39;gt.geo_type = ?&#39;</span>, $geoType)
<a name="l00076"></a>00076         -&gt;execute(array(),DOCTRINE_CORE::HYDRATE_SINGLE_SCALAR) ;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     $this-&gt;_addressGeoTypeId = $geoTypeId ;
<a name="l00079"></a>00079   }
<a name="l00080"></a>00080 
<a name="l00085"></a><a class="code" href="classagGeoHelper.html#ae2ae8ae27f1db8617c8e0ba089fba250">00085</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#ae2ae8ae27f1db8617c8e0ba089fba250" title="Small getter to lazily load and return the default geoMatchScoreId.">getDefaultGeoMatchScoreId</a>()
<a name="l00086"></a>00086   {
<a name="l00087"></a>00087     <span class="keywordflow">if</span> (! isset($this-&gt;_defaultGeoMatchScoreId)) { $this-&gt;<a class="code" href="classagGeoHelper.html#a5bc15cab4654dfdaee8415369c4ad2a5" title="Minimalist function to load and set the _defaultGeoMatchScoreId class property.">setDefaultGeoMatchScoreId</a>() ; }
<a name="l00088"></a>00088     <span class="keywordflow">return</span> $this-&gt;_defaultGeoMatchScoreId ;
<a name="l00089"></a>00089   }
<a name="l00090"></a>00090 
<a name="l00094"></a><a class="code" href="classagGeoHelper.html#a5bc15cab4654dfdaee8415369c4ad2a5">00094</a>   <span class="keyword">protected</span> function <a class="code" href="classagGeoHelper.html#a5bc15cab4654dfdaee8415369c4ad2a5" title="Minimalist function to load and set the _defaultGeoMatchScoreId class property.">setDefaultGeoMatchScoreId</a>()
<a name="l00095"></a>00095   {
<a name="l00096"></a>00096     $geoMatchScore = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>($this-&gt;_globalDefaultGeoMatchScore) ;
<a name="l00097"></a>00097     $geoMatchScoreId = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00098"></a>00098       -&gt;select(<span class="stringliteral">&#39;gms.id&#39;</span>)
<a name="l00099"></a>00099         -&gt;from(<span class="stringliteral">&#39;agGeoMatchScore gms&#39;</span>)
<a name="l00100"></a>00100         -&gt;where(<span class="stringliteral">&#39;gms.geo_match_score = ?&#39;</span>, $geoMatchScore)
<a name="l00101"></a>00101         -&gt;execute(array(),DOCTRINE_CORE::HYDRATE_SINGLE_SCALAR) ;
<a name="l00102"></a>00102     <span class="comment">// This wasn&#39;t actually being set, so I added it. Don&#39;t think it will break</span>
<a name="l00103"></a>00103     <span class="comment">// anything, as this seems like what the function was intended for. --nils</span>
<a name="l00104"></a>00104     $this-&gt;_defaultGeoMatchScoreId = $geoMatchScoreId;
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106 
<a name="l00113"></a><a class="code" href="classagGeoHelper.html#aa419fa072079dc6cf0b93775be27cea1">00113</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#aa419fa072079dc6cf0b93775be27cea1" title="Method to test whether a geoFeature has the correct number of coordinate points.">isValidGeoFeature</a>($geoTypeId, array $geoCoordinates)
<a name="l00114"></a>00114   {
<a name="l00115"></a>00115    
<a name="l00116"></a>00116     <span class="comment">// grab our coordinate counts and our requirements</span>
<a name="l00117"></a>00117     $gcCount = count($geoCoordinates) ;
<a name="l00118"></a>00118     $gcReqs = $this-&gt;<a class="code" href="classagGeoHelper.html#a2e9b38fc07ad93bec0c86473d84ec091" title="Minimalist helper function to return the _agGeoTypeData property and lazy-load its...">getAgGeoTypeData</a>($geoTypeId) ;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <span class="comment">// do our comparison and return results</span>
<a name="l00121"></a>00121     <span class="keywordflow">if</span> (($gcReqs[0] != -1 &amp;&amp; $gcCount &lt; $gcReqs[0]) || ($gcReqs[1] != -1 &amp;&amp; $gcCount &gt; $gcReqs[1]))
<a name="l00122"></a>00122     {
<a name="l00123"></a>00123       <span class="keywordflow">return</span> FALSE ;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">return</span> TRUE ;
<a name="l00127"></a>00127   }
<a name="l00128"></a>00128 
<a name="l00148"></a><a class="code" href="classagGeoHelper.html#a7ff9d1cfc7cde573fb8cfd5ceae444e3">00148</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#a7ff9d1cfc7cde573fb8cfd5ceae444e3" title="A method uniquely reduce the $geoCoordinate array before passing it to _setGeo.">setGeo</a>( array $geoCoordinates,
<a name="l00149"></a>00149                           $geoTypeId,
<a name="l00150"></a>00150                           $geoSourceId,
<a name="l00151"></a>00151                           $throwOnError = NULL,
<a name="l00152"></a>00152                           <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn = NULL)
<a name="l00153"></a>00153   {
<a name="l00154"></a>00154     <span class="comment">// this array will store our uniq coordinates (so we don&#39;t over-process)</span>
<a name="l00155"></a>00155     $uniqCoordinates = array() ;
<a name="l00156"></a>00156     $geoIds = array() ;
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     <span class="comment">// loop through the coordinate array and make our unique coordinate array</span>
<a name="l00159"></a>00159     <span class="keywordflow">foreach</span> ($geoCoordinates as $index =&gt; $coordinateArray)
<a name="l00160"></a>00160     {
<a name="l00161"></a>00161       $uniqIndex = array_search($coordinateArray, $uniqCoordinates, TRUE) ;
<a name="l00162"></a>00162      
<a name="l00163"></a>00163       <span class="comment">// if the coordinate array doesn&#39;t exist yet, add it</span>
<a name="l00164"></a>00164       <span class="keywordflow">if</span> ($uniqIndex === FALSE)
<a name="l00165"></a>00165       {
<a name="l00166"></a>00166         $uniqCoordinates[] = $coordinateArray ;
<a name="l00167"></a>00167         $uniqIndex = max(array_keys($uniqCoordinates)) ;
<a name="l00168"></a>00168       }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170       <span class="comment">// either way, return the new unique index to the geoCoordinates array to map back later</span>
<a name="l00171"></a>00171       $geoCoordinates[$index] = $uniqIndex ;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">// s/get unique geo values</span>
<a name="l00175"></a>00175     $geoIds = $this-&gt;<a class="code" href="classagGeoHelper.html#a5e0430332762f9ad6d4667ffe6f3d00d" title="A method set and/or retrieve geoIds based on their coordinate values or the hash...">_setGeo</a>($uniqCoordinates, $geoTypeId, $geoSourceId, $throwOnError, $conn) ;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177    <span class="comment">// loop through the coordinates outer array and attach the new, unique coordinates</span>
<a name="l00178"></a>00178    <span class="keywordflow">foreach</span>($geoCoordinates as $index =&gt; &amp;$uniqIndex)
<a name="l00179"></a>00179    {
<a name="l00180"></a>00180      <span class="keywordflow">if</span> (array_key_exists($uniqIndex, $geoIds))
<a name="l00181"></a>00181      {
<a name="l00182"></a>00182        $uniqIndex = $geoIds[$uniqIndex] ;
<a name="l00183"></a>00183      }
<a name="l00184"></a>00184      <span class="keywordflow">else</span>
<a name="l00185"></a>00185      {
<a name="l00186"></a>00186        <span class="comment">// we can&#39;t return broken / unsettable coordinates so we&#39;ll unset them</span>
<a name="l00187"></a>00187        unset($geoIds[$uniqIndex]) ;
<a name="l00188"></a>00188      }
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191    <span class="keywordflow">return</span> $geoCoordinates ;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193   }
<a name="l00194"></a>00194   
<a name="l00215"></a><a class="code" href="classagGeoHelper.html#a5e0430332762f9ad6d4667ffe6f3d00d">00215</a>   <span class="keyword">protected</span> function <a class="code" href="classagGeoHelper.html#a5e0430332762f9ad6d4667ffe6f3d00d" title="A method set and/or retrieve geoIds based on their coordinate values or the hash...">_setGeo</a>( array $geoCoordinates,
<a name="l00216"></a>00216                               $geoTypeId,
<a name="l00217"></a>00217                               $geoSourceId,
<a name="l00218"></a>00218                               $throwOnError = NULL,
<a name="l00219"></a>00219                               <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn = NULL)
<a name="l00220"></a>00220   {
<a name="l00221"></a>00221     <span class="comment">// explicit declarations of our interim and results arrays</span>
<a name="l00222"></a>00222     $geoIds = array() ;
<a name="l00223"></a>00223     $geoHashIds = array() ;
<a name="l00224"></a>00224     $gcHashes = array() ;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">// determine whether or not we&#39;ll explicitly throw exceptions on error</span>
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (is_null($throwOnError)) { $throwOnError = $this-&gt;throwOnError ; }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="keywordflow">foreach</span>($geoCoordinates as $index =&gt; $gc)
<a name="l00230"></a>00230     {
<a name="l00231"></a>00231       <span class="comment">// if we&#39;re enforcing types, do the check now and remove unsettable coordinates</span>
<a name="l00232"></a>00232       <span class="keywordflow">if</span> ($this-&gt;enforceGeoType &amp;&amp; ! $this-&gt;<a class="code" href="classagGeoHelper.html#aa419fa072079dc6cf0b93775be27cea1" title="Method to test whether a geoFeature has the correct number of coordinate points.">isValidGeoFeature</a>($geoTypeId, $gc))
<a name="l00233"></a>00233       {
<a name="l00234"></a>00234         <span class="comment">// prepare our error message</span>
<a name="l00235"></a>00235         $geoTypeMsg = sprintf(<span class="stringliteral">&#39;The coordinates, %s, are invalid for geo type %s and could not be set.&#39;</span>,
<a name="l00236"></a>00236             json_encode($gc), $geoTypeId );
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <span class="keywordflow">if</span> ($throwOnError)
<a name="l00239"></a>00239         {
<a name="l00240"></a>00240           <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($geoTypeMsg) ;
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242         <span class="keywordflow">else</span>
<a name="l00243"></a>00243         {
<a name="l00244"></a>00244           sfContext::getInstance()-&gt;getLogger()-&gt;warning($geoTypeMsg) ;
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         unset($geoCoordinates[$index]) ;
<a name="l00248"></a>00248         continue ;
<a name="l00249"></a>00249       }
<a name="l00250"></a>00250       
<a name="l00251"></a>00251       <span class="comment">// calculate our coordinate hashes</span>
<a name="l00252"></a>00252       $gcHashes[$index] = <a class="code" href="classagBulkRecordHelper.html#a896fb5f270d55d3b002776ecd3486439" title="Method to take a record component array and return a json encoded, md5sum&amp;#39;ed...">agBulkRecordHelper::getRecordComponentsHash</a>($gc, TRUE);
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="comment">// grab any existing ids from the db</span>
<a name="l00256"></a>00256     $geoHashIds = $this-&gt;<a class="code" href="classagGeoHelper.html#ae694e788f4f0b06bc8f7eb7add2da2ce" title="Method to return a geoId based on a coordinate hash.">getGeoIdsByHash</a>(array_values($gcHashes)) ;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <span class="comment">// loop through our returned results and separate the existing from the non-</span>
<a name="l00259"></a>00259     <span class="keywordflow">foreach</span> ($geoCoordinates as $index =&gt; &amp;$gc)
<a name="l00260"></a>00260     {
<a name="l00261"></a>00261       $gcHash = $gcHashes[$index] ;
<a name="l00262"></a>00262       <span class="keywordflow">if</span> (array_key_exists($gcHash, $geoHashIds))
<a name="l00263"></a>00263       {
<a name="l00264"></a>00264         <span class="comment">// add it to our final results array and release our resource</span>
<a name="l00265"></a>00265         $geoIds[$index] = $geoHashIds[$gcHash] ;
<a name="l00266"></a>00266         unset($gcHashes[$index]) ;
<a name="l00267"></a>00267         unset($geoCoordinates[$index]) ;
<a name="l00268"></a>00268       }
<a name="l00269"></a>00269       <span class="keywordflow">else</span>
<a name="l00270"></a>00270       {
<a name="l00271"></a>00271         <span class="comment">// if it wasn&#39;t set, let&#39;s reconfigure our coordinates values so we can pass them forward</span>
<a name="l00272"></a>00272         $gc = array($gc, $gcHash) ;
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274         <span class="comment">// either way, we don&#39;t need this resource anymore</span>
<a name="l00275"></a>00275         unset($geoHashIds[$gcHash]) ;
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <span class="comment">// set up our transaction</span>
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (is_null($conn)) { $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>() ; }
<a name="l00280"></a>00280     $useSavepoint = ($conn-&gt;getTransactionLevel() &gt; 0) ? TRUE : FALSE ;
<a name="l00281"></a>00281     <span class="keywordflow">if</span> ($useSavepoint)
<a name="l00282"></a>00282     {
<a name="l00283"></a>00283       $conn-&gt;beginTransaction(__FUNCTION__) ;
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285     <span class="keywordflow">else</span>
<a name="l00286"></a>00286     {
<a name="l00287"></a>00287       $conn-&gt;beginTransaction() ;
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">// set our new geo data</span>
<a name="l00291"></a>00291     <span class="keywordflow">try</span>
<a name="l00292"></a>00292     {
<a name="l00293"></a>00293       $geoIds = $geoIds + $this-&gt;<a class="code" href="classagGeoHelper.html#afe138cb6802a8ea35f2e46cecb50a275" title="A method to set new geoIds based on a set of geo coordinate data.">setNewGeo</a>($geoCoordinates, $geoTypeId, $geoSourceId,
<a name="l00294"></a>00294           $throwOnError, $conn) ;
<a name="l00295"></a>00295       <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;commit(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;commit() ; }
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     <span class="keywordflow">catch</span>(Exception $e)
<a name="l00298"></a>00298     {
<a name="l00299"></a>00299       <span class="comment">// log our error and rollback</span>
<a name="l00300"></a>00300       $errMsg = <span class="stringliteral">&#39;Could not set all geo coordinates. Rolling back the batch!&#39;</span> ;
<a name="l00301"></a>00301       sfContext::getInstance()-&gt;getLogger()-&gt;err($errMsg) ;
<a name="l00302"></a>00302       <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;rollback(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;rollback() ; }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304       <span class="comment">// throw if directed to do so</span>
<a name="l00305"></a>00305       <span class="keywordflow">if</span> ($throwOnError) { <span class="keywordflow">throw</span> $e ; }
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307         
<a name="l00308"></a>00308     <span class="keywordflow">return</span> $geoIds ;
<a name="l00309"></a>00309   }
<a name="l00310"></a>00310 
<a name="l00331"></a><a class="code" href="classagGeoHelper.html#afe138cb6802a8ea35f2e46cecb50a275">00331</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#afe138cb6802a8ea35f2e46cecb50a275" title="A method to set new geoIds based on a set of geo coordinate data.">setNewGeo</a>(array $geoCoordinates,
<a name="l00332"></a>00332                             $geoTypeId,
<a name="l00333"></a>00333                             $geoSourceId,
<a name="l00334"></a>00334                             $throwOnError = NULL,
<a name="l00335"></a>00335                             <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn = NULL)
<a name="l00336"></a>00336   {
<a name="l00337"></a>00337     <span class="comment">// set up some explict vars for later use</span>
<a name="l00338"></a>00338     $geoIds = array() ;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="comment">// pick up the default connection and error throw prerogative if one is not passed</span>
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (is_null($conn)) { $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>() ; }
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (is_null($throwOnError)) { $throwOnError = $this-&gt;throwOnError ; }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="comment">// loop through all the coordinate data</span>
<a name="l00345"></a>00345     <span class="keywordflow">foreach</span> ($geoCoordinates as $index =&gt; $geoValues)
<a name="l00346"></a>00346     {
<a name="l00347"></a>00347       $err = NULL ;
<a name="l00348"></a>00348       $errMsg = <span class="stringliteral">&#39;This is a generic error message for setNewGeo. You should never receive this</span>
<a name="l00349"></a>00349 <span class="stringliteral">        message. If you are recieving this error, there is a problem in your error-handling code.&#39;</span> ;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351       <span class="comment">// here we check our current transaction scope and create a transaction or savepoint</span>
<a name="l00352"></a>00352       $useSavepoint = ($conn-&gt;getTransactionLevel() &gt; 0) ? TRUE : FALSE ;
<a name="l00353"></a>00353       <span class="keywordflow">if</span> ($useSavepoint)
<a name="l00354"></a>00354       {
<a name="l00355"></a>00355         $conn-&gt;beginTransaction(__FUNCTION__) ;
<a name="l00356"></a>00356       }
<a name="l00357"></a>00357       <span class="keywordflow">else</span>
<a name="l00358"></a>00358       {
<a name="l00359"></a>00359         $conn-&gt;beginTransaction() ;
<a name="l00360"></a>00360       }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362       <span class="comment">// first create a new geoId that we can later use when setting coordinates</span>
<a name="l00363"></a>00363       $geoTbl = $conn-&gt;getTable(<span class="stringliteral">&#39;agGeo&#39;</span>);
<a name="l00364"></a>00364       $gObj = <span class="keyword">new</span> <a class="code" href="classagGeo.html">agGeo</a>($geoTbl, TRUE) ;
<a name="l00365"></a>00365       $gObj[<span class="stringliteral">&#39;geo_coordinate_hash&#39;</span>] = $geoValues[1] ;
<a name="l00366"></a>00366       $gObj[<span class="stringliteral">&#39;geo_type_id&#39;</span>] = $geoTypeId ;
<a name="l00367"></a>00367       $gObj[<span class="stringliteral">&#39;geo_source_id&#39;</span>] = $geoSourceId ;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369       <span class="comment">// while we&#39;re at it, let&#39;s create our collection for geoFeature</span>
<a name="l00370"></a>00370       $gfColl = <span class="keyword">new</span> <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>(<span class="stringliteral">&#39;agGeoFeature&#39;</span>) ;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372       <span class="comment">// save and/or catch issues</span>
<a name="l00373"></a>00373       <span class="keywordflow">try</span>
<a name="l00374"></a>00374       {
<a name="l00375"></a>00375         $gObj-&gt;save($conn) ;
<a name="l00376"></a>00376         $gId = $gObj-&gt;getId() ;
<a name="l00377"></a>00377       }
<a name="l00378"></a>00378       <span class="keywordflow">catch</span>(Exception $e)
<a name="l00379"></a>00379       {
<a name="l00380"></a>00380         $err = $e ;
<a name="l00381"></a>00381         $errMsg = sprintf(<span class="stringliteral">&#39;Unable to create new geoId identified by hash %s&#39;</span>, $geoValues[1]) ;
<a name="l00382"></a>00382       }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       <span class="keywordflow">if</span> (is_null($err))
<a name="l00385"></a>00385       {
<a name="l00386"></a>00386         <span class="comment">// loop through each individual coordinate pair</span>
<a name="l00387"></a>00387         <span class="keywordflow">foreach</span>($geoValues[0] as $order =&gt; $coordinates)
<a name="l00388"></a>00388         {
<a name="l00389"></a>00389           $gcId = $this-&gt;<a class="code" href="classagGeoHelper.html#a7f090bef8c5c9eeaa0facbeb7a3a5314" title="Method to return geo coordinate id&amp;#39;s.">getGeoCoordinateId</a>($coordinates[0], $coordinates[1]) ;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391           <span class="comment">// if we didn&#39;t get a value, we need to create one</span>
<a name="l00392"></a>00392           <span class="keywordflow">if</span> (empty($gcId))
<a name="l00393"></a>00393           {
<a name="l00394"></a>00394             <span class="comment">// set up our new geo-coordinate object</span>
<a name="l00395"></a>00395             $geoCoorTbl = $conn-&gt;getTable(<span class="stringliteral">&#39;agGeoCoordinate&#39;</span>);
<a name="l00396"></a>00396             $gcObj = <span class="keyword">new</span> <a class="code" href="classagGeoCoordinate.html">agGeoCoordinate</a>($geoCoorTbl, TRUE) ;
<a name="l00397"></a>00397             $gcObj[<span class="stringliteral">&#39;latitude&#39;</span>] = $coordinates[0] ;
<a name="l00398"></a>00398             $gcObj[<span class="stringliteral">&#39;longitude&#39;</span>] = $coordinates[1] ;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400             <span class="comment">// save and/or catch issues</span>
<a name="l00401"></a>00401             <span class="keywordflow">try</span>
<a name="l00402"></a>00402             {
<a name="l00403"></a>00403               $gcObj-&gt;save($conn) ;
<a name="l00404"></a>00404               $gcId = $gcObj-&gt;getId() ;
<a name="l00405"></a>00405             }
<a name="l00406"></a>00406             <span class="keywordflow">catch</span>(Exception $e)
<a name="l00407"></a>00407             {
<a name="l00408"></a>00408               $err = $e ;
<a name="l00409"></a>00409               $errMsg = sprintf(<span class="stringliteral">&#39;Unable to create new coordinate pair identified by %s&#39;</span>,
<a name="l00410"></a>00410                 json_encode($coordinates)) ;
<a name="l00411"></a>00411               break ;
<a name="l00412"></a>00412             }
<a name="l00413"></a>00413           }
<a name="l00414"></a>00414           <span class="comment">// now, let&#39;s create a geo feature record</span>
<a name="l00415"></a>00415           $geoFeatureTbl = $conn-&gt;getTable(<span class="stringliteral">&#39;agGeoFeature&#39;</span>);
<a name="l00416"></a>00416           $gfObj = <span class="keyword">new</span> <a class="code" href="classagGeoFeature.html">agGeoFeature</a>($geoFeatureTbl, TRUE) ;
<a name="l00417"></a>00417           $gfObj[<span class="stringliteral">&#39;geo_id&#39;</span>] = $gId ;
<a name="l00418"></a>00418           $gfObj[<span class="stringliteral">&#39;geo_coordinate_id&#39;</span>] = $gcId ;
<a name="l00419"></a>00419           $gfObj[<span class="stringliteral">&#39;geo_coordinate_order&#39;</span>] = $order ;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421           <span class="comment">// and add it to our geoFeature collection, then continue the loop (without saving)</span>
<a name="l00422"></a>00422           $gfColl-&gt;add($gfObj) ;
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424       }
<a name="l00425"></a>00425       <span class="comment">// alright, now that geoFeature is complete, let&#39;s save geoFeature and try a commit</span>
<a name="l00426"></a>00426       <span class="keywordflow">if</span> (is_null($err))
<a name="l00427"></a>00427       {
<a name="l00428"></a>00428         <span class="keywordflow">try</span>
<a name="l00429"></a>00429         {
<a name="l00430"></a>00430           $gfColl-&gt;save($conn) ;
<a name="l00431"></a>00431           <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;commit(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;commit() ; }
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433         <span class="keywordflow">catch</span>(Exception $e)
<a name="l00434"></a>00434         {
<a name="l00435"></a>00435           $err = $e ;
<a name="l00436"></a>00436           $errMsg = sprintf(<span class="stringliteral">&#39;Unable to create new geoFeature identified by hash %s&#39;</span>, $geoValues[1]);
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438       }
<a name="l00439"></a>00439       <span class="comment">// if it all went well, we add geoId to our results and if not, we rollback</span>
<a name="l00440"></a>00440       <span class="keywordflow">if</span> (is_null($err))
<a name="l00441"></a>00441       {
<a name="l00442"></a>00442         $geoIds[$index] = $gId ;
<a name="l00443"></a>00443         unset($geoCoordinates[$index]) ;
<a name="l00444"></a>00444       }
<a name="l00445"></a>00445       <span class="keywordflow">else</span>
<a name="l00446"></a>00446       {
<a name="l00447"></a>00447         sfContext::getInstance()-&gt;getLogger()-&gt;err($errMsg) ;
<a name="l00448"></a>00448         <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;rollback(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;rollback() ; }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="comment">// throw if directed to do so</span>
<a name="l00451"></a>00451         <span class="keywordflow">if</span> ($throwOnError) { <span class="keywordflow">throw</span> $err ; }
<a name="l00452"></a>00452       }
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     <span class="comment">// nothing fancy here, just the end of the function and a chance to return our values</span>
<a name="l00455"></a>00455     <span class="keywordflow">return</span> $geoIds ;
<a name="l00456"></a>00456   }
<a name="l00457"></a>00457 
<a name="l00465"></a><a class="code" href="classagGeoHelper.html#ae694e788f4f0b06bc8f7eb7add2da2ce">00465</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#ae694e788f4f0b06bc8f7eb7add2da2ce" title="Method to return a geoId based on a coordinate hash.">getGeoIdsByHash</a>($gcHashes)
<a name="l00466"></a>00466   {
<a name="l00467"></a>00467     $results = array();
<a name="l00468"></a>00468     $cacheDriver = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>()-&gt;getAttribute(Doctrine_Core::ATTR_RESULT_CACHE);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00471"></a>00471       -&gt;select(<span class="stringliteral">&#39;g.id&#39;</span>)
<a name="l00472"></a>00472         -&gt;from(<span class="stringliteral">&#39;agGeo g&#39;</span>)
<a name="l00473"></a>00473       -&gt;useResultCache(TRUE, 1800);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <span class="keywordflow">foreach</span> ($gcHashes as $index =&gt; $hash)
<a name="l00476"></a>00476     {
<a name="l00477"></a>00477       $q-&gt;where(<span class="stringliteral">&#39;g.geo_coordinate_hash = ?&#39;</span>, $hash);
<a name="l00478"></a>00478       $gId = $q-&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480       <span class="keywordflow">if</span> (empty($gId))
<a name="l00481"></a>00481       {
<a name="l00482"></a>00482         $cacheDriver-&gt;delete($q-&gt;getResultCacheHash());
<a name="l00483"></a>00483       }
<a name="l00484"></a>00484       <span class="keywordflow">else</span>
<a name="l00485"></a>00485       {
<a name="l00486"></a>00486         $results[$hash] = $gId;
<a name="l00487"></a>00487       }
<a name="l00488"></a>00488       unset($gcHashes[$index]);
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490  
<a name="l00491"></a>00491     <span class="keywordflow">return</span> $results;
<a name="l00492"></a>00492   }
<a name="l00493"></a>00493 
<a name="l00500"></a><a class="code" href="classagGeoHelper.html#a7f090bef8c5c9eeaa0facbeb7a3a5314">00500</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#a7f090bef8c5c9eeaa0facbeb7a3a5314" title="Method to return geo coordinate id&amp;#39;s.">getGeoCoordinateId</a>($latitude, $longitude)
<a name="l00501"></a>00501   {
<a name="l00502"></a>00502     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00503"></a>00503       -&gt;select(<span class="stringliteral">&#39;gc.id&#39;</span>)
<a name="l00504"></a>00504         -&gt;from(<span class="stringliteral">&#39;agGeoCoordinate gc&#39;</span>)
<a name="l00505"></a>00505         -&gt;where(<span class="stringliteral">&#39;gc.latitude = ?&#39;</span>, $latitude)
<a name="l00506"></a>00506           -&gt;andWhere(<span class="stringliteral">&#39;gc.longitude = ?&#39;</span>, $longitude)
<a name="l00507"></a>00507       -&gt;useResultCache(TRUE, 1800);
<a name="l00508"></a>00508     
<a name="l00509"></a>00509     $result = $q-&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00510"></a>00510     
<a name="l00511"></a>00511     <span class="keywordflow">if</span> (empty($result) || is_null($result))
<a name="l00512"></a>00512     {
<a name="l00513"></a>00513       $cacheDriver = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>()-&gt;getAttribute(Doctrine_Core::ATTR_RESULT_CACHE);
<a name="l00514"></a>00514       $cacheDriver-&gt;delete($q-&gt;getResultCacheHash());
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="keywordflow">return</span> $result;
<a name="l00518"></a>00518   }
<a name="l00519"></a>00519 
<a name="l00525"></a><a class="code" href="classagGeoHelper.html#a3322aaafde26c0e94a69855d59d2a7fb">00525</a>   <span class="keyword">protected</span> function <a class="code" href="classagGeoHelper.html#a3322aaafde26c0e94a69855d59d2a7fb" title="Method to update all geo hashes in the database.">updateGeoHashes</a>()
<a name="l00526"></a>00526   {
<a name="l00527"></a>00527     $coordinateData = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00528"></a>00528       -&gt;select(<span class="stringliteral">&#39;gf.geo_id&#39;</span>)
<a name="l00529"></a>00529           -&gt;addSelect(<span class="stringliteral">&#39;gc.latitude&#39;</span>)
<a name="l00530"></a>00530           -&gt;addSelect(<span class="stringliteral">&#39;gc.longitude&#39;</span>)
<a name="l00531"></a>00531         -&gt;from(<span class="stringliteral">&#39;agGeoFeature gf&#39;</span>)
<a name="l00532"></a>00532           -&gt;innerJoin(<span class="stringliteral">&#39;gf.agGeoCoordinate gc&#39;</span>)
<a name="l00533"></a>00533         -&gt;orderBy(<span class="stringliteral">&#39;gf.geo_coordinate_order&#39;</span>)
<a name="l00534"></a>00534       -&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a36531882557012215d8b9024373239fa" title="HYDRATE_NONE.">Doctrine_Core::HYDRATE_NONE</a>);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     $groupedData = array() ;
<a name="l00537"></a>00537     <span class="keywordflow">foreach</span> ($coordinateData as $data)
<a name="l00538"></a>00538     {
<a name="l00539"></a>00539       $groupedData[$data[0]][] = array($data[1], $data[2]) ;
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">foreach</span> ($groupedData as $geoId =&gt; $data)
<a name="l00543"></a>00543     {
<a name="l00544"></a>00544       $hash = <a class="code" href="classagBulkRecordHelper.html#a896fb5f270d55d3b002776ecd3486439" title="Method to take a record component array and return a json encoded, md5sum&amp;#39;ed...">agBulkRecordHelper::getRecordComponentsHash</a>($data, TRUE);
<a name="l00545"></a>00545       $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00546"></a>00546         -&gt;update(<span class="stringliteral">&#39;agGeo&#39;</span>)
<a name="l00547"></a>00547           -&gt;set(<span class="stringliteral">&#39;geo_coordinate_hash&#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span>.$hash.<span class="stringliteral">&quot;&#39;&quot;</span>)
<a name="l00548"></a>00548           -&gt;where(<span class="stringliteral">&#39;id = ?&#39;</span>, $geoId) ;
<a name="l00549"></a>00549       $results = $q-&gt;execute() ;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keywordflow">return</span> $results ;
<a name="l00553"></a>00553   }
<a name="l00554"></a>00554 
<a name="l00575"></a><a class="code" href="classagGeoHelper.html#a6111a5825397101ec22aa8eb882f11aa">00575</a>   <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#a6111a5825397101ec22aa8eb882f11aa" title="A method to set address geo many-to-many table based on the set of address id and...">setAddressGeo</a>(array $addrCoordinates,
<a name="l00576"></a>00576                                 $geoSourceId,
<a name="l00577"></a>00577                                 $geoTypeId = NULL,
<a name="l00578"></a>00578                                 $throwOnError = NULL,
<a name="l00579"></a>00579                                 <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn = NULL)
<a name="l00580"></a>00580   {
<a name="l00581"></a>00581     <span class="comment">// array($addrId =&gt; array(array(array($latitude, $longitude), ...), $matchScoreId), ...)</span>
<a name="l00582"></a>00582     <span class="comment">// set up some important buckets</span>
<a name="l00583"></a>00583     $addrMatchScores = array() ;
<a name="l00584"></a>00584     $err = NULL ;
<a name="l00585"></a>00585     $results = 0 ;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="comment">// pick up global defaults if not passed parameters</span>
<a name="l00588"></a>00588     $defaultMatchScoreId = $this-&gt;<a class="code" href="classagGeoHelper.html#ae2ae8ae27f1db8617c8e0ba089fba250" title="Small getter to lazily load and return the default geoMatchScoreId.">getDefaultGeoMatchScoreId</a>() ;
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (is_null($geoTypeId)) { $geoTypeId = $this-&gt;<a class="code" href="classagGeoHelper.html#aee50e0cd87f6ff0b79c0238876638bcc" title="Small getter to lazily load and return the default address geo-type id.">getAddressGeoTypeId</a>() ; }
<a name="l00590"></a>00590     <span class="keywordflow">if</span> (is_null($throwOnError)) { $throwOnError = $this-&gt;throwOnError ; }
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (is_null($conn)) { $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>() ; }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="comment">// fire up our savepoint</span>
<a name="l00594"></a>00594     $useSavepoint = ($conn-&gt;getTransactionLevel() &gt; 0) ? TRUE : FALSE ;
<a name="l00595"></a>00595     <span class="keywordflow">if</span> ($useSavepoint)
<a name="l00596"></a>00596     {
<a name="l00597"></a>00597       $conn-&gt;beginTransaction(__FUNCTION__) ;
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599     <span class="keywordflow">else</span>
<a name="l00600"></a>00600     {
<a name="l00601"></a>00601       $conn-&gt;beginTransaction() ;
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="comment">// reduce the complexity of our addrCoordinates array and separate match scores</span>
<a name="l00605"></a>00605     <span class="keywordflow">foreach</span> ($addrCoordinates as $addrId =&gt; &amp;$coordinates)
<a name="l00606"></a>00606     {
<a name="l00607"></a>00607       <span class="keywordflow">if</span> (array_key_exists(1, $coordinates))
<a name="l00608"></a>00608       {
<a name="l00609"></a>00609         $addrMatchScores[$addrId] = $coordinates[1] ;
<a name="l00610"></a>00610       }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612       $coordinates = $coordinates[0] ;
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">try</span>
<a name="l00616"></a>00616     {
<a name="l00617"></a>00617       $addrCoordinates = $this-&gt;<a class="code" href="classagGeoHelper.html#a7ff9d1cfc7cde573fb8cfd5ceae444e3" title="A method uniquely reduce the $geoCoordinate array before passing it to _setGeo.">setGeo</a>($addrCoordinates, $geoTypeId, $geoSourceId,
<a name="l00618"></a>00618         $throwOnError, $conn) ;
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620     <span class="keywordflow">catch</span>(Exception $e)
<a name="l00621"></a>00621     {
<a name="l00622"></a>00622       $err = $e ;
<a name="l00623"></a>00623       $errMsg = sprintf(<span class="stringliteral">&#39;Failed to execute setGeo in %s.&#39;</span>, __FUNCTION__) ;
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (is_null($err))
<a name="l00628"></a>00628     {
<a name="l00629"></a>00629       $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>($conn)
<a name="l00630"></a>00630         -&gt;select(<span class="stringliteral">&#39;ag.*&#39;</span>)
<a name="l00631"></a>00631           -&gt;from(<span class="stringliteral">&#39;agAddressGeo ag INDEXBY ag.address_id&#39;</span>)
<a name="l00632"></a>00632           -&gt;whereIn(<span class="stringliteral">&#39;ag.address_id&#39;</span>, array_keys($addrCoordinates));
<a name="l00633"></a>00633       $coll = $q-&gt;execute() ;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635       <span class="comment">// loop through the collection first, updating match score and geo_id</span>
<a name="l00636"></a>00636       <span class="keywordflow">foreach</span> ($coll as $addrId =&gt; &amp;$agRec)
<a name="l00637"></a>00637       {
<a name="l00638"></a>00638         <span class="comment">// deal with match scores first since differences in old/new geo need to be detected</span>
<a name="l00639"></a>00639         <span class="keywordflow">if</span> (array_key_exists($addrId, $addrMatchScores))
<a name="l00640"></a>00640         {
<a name="l00641"></a>00641           <span class="comment">// if we were originally passed a match score for this geo, set it</span>
<a name="l00642"></a>00642           $agRec[<span class="stringliteral">&#39;geo_match_score_id&#39;</span>] = $addrMatchScores[$addrId] ;
<a name="l00643"></a>00643           unset($addrMatchScores[$addrId]) ;
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645         <span class="keywordflow">else</span>
<a name="l00646"></a>00646         {
<a name="l00647"></a>00647           <span class="comment">// otherwise, only set the default of geoId&#39;s are not equal (eg, new)</span>
<a name="l00648"></a>00648           <span class="keywordflow">if</span> ($agRec[<span class="stringliteral">&#39;geo_id&#39;</span>] != $addrCoordinates[$addrId])
<a name="l00649"></a>00649           {
<a name="l00650"></a>00650             $agRec[<span class="stringliteral">&#39;geo_match_score_id&#39;</span>] = $defaultMatchScoreId ;
<a name="l00651"></a>00651           }
<a name="l00652"></a>00652         }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         <span class="comment">// set our geo and release these resources from our coordinate / final arrays</span>
<a name="l00655"></a>00655         $agRec[<span class="stringliteral">&#39;geo_id&#39;</span>] = $addrCoordinates[$addrId] ;
<a name="l00656"></a>00656         unset($addrCoordinates[$addrId]) ;
<a name="l00657"></a>00657       }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659       <span class="comment">// loop through the remaining $addrGeoIds and make new entries</span>
<a name="l00660"></a>00660       <span class="keywordflow">foreach</span> ($addrCoordinates as $addrId =&gt; $geoId)
<a name="l00661"></a>00661       {
<a name="l00662"></a>00662         $addressGeoTbl = $conn-&gt;getTable(<span class="stringliteral">&#39;agAddressGeo&#39;</span>);
<a name="l00663"></a>00663         $newRec = <span class="keyword">new</span> <a class="code" href="classagAddressGeo.html">agAddressGeo</a>($addressGeoTbl, TRUE) ;
<a name="l00664"></a>00664         $newRec[<span class="stringliteral">&#39;address_id&#39;</span>] = $addrId ;
<a name="l00665"></a>00665         $newRec[<span class="stringliteral">&#39;geo_id&#39;</span>] = $geoId ;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="keywordflow">if</span> (array_key_exists($addrId, $addrMatchScores))
<a name="l00668"></a>00668         {
<a name="l00669"></a>00669           <span class="comment">// if we were originally passed a match score for this geo, set it</span>
<a name="l00670"></a>00670           $newRec[<span class="stringliteral">&#39;geo_match_score_id&#39;</span>] = $addrMatchScores[$addrId] ;
<a name="l00671"></a>00671           unset($addrMatchScores[$addrId]) ;
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673         <span class="keywordflow">else</span>
<a name="l00674"></a>00674         {
<a name="l00675"></a>00675           <span class="comment">// otherwise we&#39;ll use the default match score</span>
<a name="l00676"></a>00676           $newRec[<span class="stringliteral">&#39;geo_match_score_id&#39;</span>] = $defaultMatchScoreId ;
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678         <span class="comment">// add the new record to our collection and release the resource</span>
<a name="l00679"></a>00679         $coll-&gt;add($newRec) ;
<a name="l00680"></a>00680         unset($addrCoordinates[$addrId]) ;
<a name="l00681"></a>00681       }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683       <span class="keywordflow">try</span>
<a name="l00684"></a>00684       {
<a name="l00685"></a>00685         $coll-&gt;save($conn) ;
<a name="l00686"></a>00686         <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;commit(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;commit() ; }
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688       <span class="keywordflow">catch</span>(Exception $e)
<a name="l00689"></a>00689       {
<a name="l00690"></a>00690         $err = $e ;
<a name="l00691"></a>00691         $errMsg = sprintf(<span class="stringliteral">&#39;Failed to upsert into table agAddressGeo in function %s.&#39;</span>, __FUNCTION__);
<a name="l00692"></a>00692       }
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="comment">// if nothing is awry, let&#39;s count how many objects are in our collection, otherwise deal</span>
<a name="l00696"></a>00696     <span class="comment">// with our errors</span>
<a name="l00697"></a>00697     <span class="keywordflow">if</span> (is_null($err))
<a name="l00698"></a>00698     {
<a name="l00699"></a>00699       $results = count($coll) ;
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     <span class="keywordflow">else</span>
<a name="l00702"></a>00702     {
<a name="l00703"></a>00703       <span class="comment">// log our error</span>
<a name="l00704"></a>00704       sfContext::getInstance()-&gt;getLogger()-&gt;err($errMsg) ;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706       <span class="comment">// rollback</span>
<a name="l00707"></a>00707       <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;rollback(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;rollback() ; }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709       <span class="comment">// ALWAYS throw an error, it&#39;s like stepping on a crack if you don&#39;t</span>
<a name="l00710"></a>00710       <span class="keywordflow">if</span> ($throwOnError) { <span class="keywordflow">throw</span> $err ; }
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <span class="comment">// many happy returns</span>
<a name="l00714"></a>00714     <span class="keywordflow">return</span> $results ;
<a name="l00715"></a>00715   }
<a name="l00716"></a>00716 
<a name="l00722"></a><a class="code" href="classagGeoHelper.html#a16acd80afb50fed6121c2d722f7bbde3">00722</a>   <span class="keyword">static</span> <span class="keyword">public</span> function <a class="code" href="classagGeoHelper.html#a16acd80afb50fed6121c2d722f7bbde3" title="Method to return geo match score ids from geo match score values.">getGeoMatchScoreIds</a>(array $geoMatchScores)
<a name="l00723"></a>00723   {
<a name="l00724"></a>00724     <span class="keywordflow">return</span> <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00725"></a>00725       -&gt;select(<span class="stringliteral">&#39;gms.geo_match_score&#39;</span>)
<a name="l00726"></a>00726           -&gt;addSelect(<span class="stringliteral">&#39;gms.id&#39;</span>)
<a name="l00727"></a>00727         -&gt;from(<span class="stringliteral">&#39;agGeoMatchScore gms&#39;</span>)
<a name="l00728"></a>00728         -&gt;whereIn(<span class="stringliteral">&#39;gms.geo_match_score&#39;</span>, $geoMatchScores)
<a name="l00729"></a>00729       -&gt;useResultCache(TRUE, 3600)
<a name="l00730"></a>00730       -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00731"></a>00731   }
<a name="l00732"></a>00732 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
