<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: lib/vendor/symfony/lib/plugins/sfDoctrinePlugin/lib/vendor/doctrine/Doctrine/Query.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>lib/vendor/symfony/lib/plugins/sfDoctrinePlugin/lib/vendor/doctrine/Doctrine/Query.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">/*</span>
<a name="l00003"></a>00003 <span class="comment"> *  $Id: Query.php 7674 2010-06-08 22:59:01Z jwage $</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00006"></a>00006 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00007"></a>00007 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00008"></a>00008 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00009"></a>00009 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00010"></a>00010 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00011"></a>00011 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00012"></a>00012 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00013"></a>00013 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00014"></a>00014 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00015"></a>00015 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This software consists of voluntary contributions made by many individuals</span>
<a name="l00018"></a>00018 <span class="comment"> * and is licensed under the LGPL. For more information, see</span>
<a name="l00019"></a>00019 <span class="comment"> * &lt;http://www.doctrine-project.org&gt;.</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 
<a name="l00059"></a><a class="code" href="classDoctrine__Query.html">00059</a> <span class="keyword">class </span><a class="code" href="classDoctrine__Query.html">Doctrine_Query</a> <span class="keyword">extends</span> <a class="code" href="classDoctrine__Query__Abstract.html">Doctrine_Query_Abstract</a> implements Countable
<a name="l00060"></a>00060 {
<a name="l00064"></a>00064     <span class="keyword">protected</span> <span class="keyword">static</span> $_keywords  = array(<span class="stringliteral">&#39;ALL&#39;</span>,
<a name="l00065"></a>00065                                          <span class="stringliteral">&#39;AND&#39;</span>,
<a name="l00066"></a>00066                                          <span class="stringliteral">&#39;ANY&#39;</span>,
<a name="l00067"></a>00067                                          <span class="stringliteral">&#39;AS&#39;</span>,
<a name="l00068"></a>00068                                          <span class="stringliteral">&#39;ASC&#39;</span>,
<a name="l00069"></a>00069                                          <span class="stringliteral">&#39;AVG&#39;</span>,
<a name="l00070"></a>00070                                          <span class="stringliteral">&#39;BETWEEN&#39;</span>,
<a name="l00071"></a>00071                                          <span class="stringliteral">&#39;BIT_LENGTH&#39;</span>,
<a name="l00072"></a>00072                                          <span class="stringliteral">&#39;BY&#39;</span>,
<a name="l00073"></a>00073                                          <span class="stringliteral">&#39;CHARACTER_LENGTH&#39;</span>,
<a name="l00074"></a>00074                                          <span class="stringliteral">&#39;CHAR_LENGTH&#39;</span>,
<a name="l00075"></a>00075                                          <span class="stringliteral">&#39;CURRENT_DATE&#39;</span>,
<a name="l00076"></a>00076                                          <span class="stringliteral">&#39;CURRENT_TIME&#39;</span>,
<a name="l00077"></a>00077                                          <span class="stringliteral">&#39;CURRENT_TIMESTAMP&#39;</span>,
<a name="l00078"></a>00078                                          <span class="stringliteral">&#39;DELETE&#39;</span>,
<a name="l00079"></a>00079                                          <span class="stringliteral">&#39;DESC&#39;</span>,
<a name="l00080"></a>00080                                          <span class="stringliteral">&#39;DISTINCT&#39;</span>,
<a name="l00081"></a>00081                                          <span class="stringliteral">&#39;EMPTY&#39;</span>,
<a name="l00082"></a>00082                                          <span class="stringliteral">&#39;EXISTS&#39;</span>,
<a name="l00083"></a>00083                                          <span class="stringliteral">&#39;FALSE&#39;</span>,
<a name="l00084"></a>00084                                          <span class="stringliteral">&#39;FETCH&#39;</span>,
<a name="l00085"></a>00085                                          <span class="stringliteral">&#39;FROM&#39;</span>,
<a name="l00086"></a>00086                                          <span class="stringliteral">&#39;GROUP&#39;</span>,
<a name="l00087"></a>00087                                          <span class="stringliteral">&#39;HAVING&#39;</span>,
<a name="l00088"></a>00088                                          <span class="stringliteral">&#39;IN&#39;</span>,
<a name="l00089"></a>00089                                          <span class="stringliteral">&#39;INDEXBY&#39;</span>,
<a name="l00090"></a>00090                                          <span class="stringliteral">&#39;INNER&#39;</span>,
<a name="l00091"></a>00091                                          <span class="stringliteral">&#39;IS&#39;</span>,
<a name="l00092"></a>00092                                          <span class="stringliteral">&#39;JOIN&#39;</span>,
<a name="l00093"></a>00093                                          <span class="stringliteral">&#39;LEFT&#39;</span>,
<a name="l00094"></a>00094                                          <span class="stringliteral">&#39;LIKE&#39;</span>,
<a name="l00095"></a>00095                                          <span class="stringliteral">&#39;LOWER&#39;</span>,
<a name="l00096"></a>00096                                          <span class="stringliteral">&#39;MEMBER&#39;</span>,
<a name="l00097"></a>00097                                          <span class="stringliteral">&#39;MOD&#39;</span>,
<a name="l00098"></a>00098                                          <span class="stringliteral">&#39;NEW&#39;</span>,
<a name="l00099"></a>00099                                          <span class="stringliteral">&#39;NOT&#39;</span>,
<a name="l00100"></a>00100                                          <span class="stringliteral">&#39;NULL&#39;</span>,
<a name="l00101"></a>00101                                          <span class="stringliteral">&#39;OBJECT&#39;</span>,
<a name="l00102"></a>00102                                          <span class="stringliteral">&#39;OF&#39;</span>,
<a name="l00103"></a>00103                                          <span class="stringliteral">&#39;OR&#39;</span>,
<a name="l00104"></a>00104                                          <span class="stringliteral">&#39;ORDER&#39;</span>,
<a name="l00105"></a>00105                                          <span class="stringliteral">&#39;OUTER&#39;</span>,
<a name="l00106"></a>00106                                          <span class="stringliteral">&#39;POSITION&#39;</span>,
<a name="l00107"></a>00107                                          <span class="stringliteral">&#39;SELECT&#39;</span>,
<a name="l00108"></a>00108                                          <span class="stringliteral">&#39;SOME&#39;</span>,
<a name="l00109"></a>00109                                          <span class="stringliteral">&#39;TRIM&#39;</span>,
<a name="l00110"></a>00110                                          <span class="stringliteral">&#39;TRUE&#39;</span>,
<a name="l00111"></a>00111                                          <span class="stringliteral">&#39;UNKNOWN&#39;</span>,
<a name="l00112"></a>00112                                          <span class="stringliteral">&#39;UPDATE&#39;</span>,
<a name="l00113"></a>00113                                          <span class="stringliteral">&#39;WHERE&#39;</span>);
<a name="l00114"></a>00114 
<a name="l00118"></a>00118     <span class="keyword">protected</span> $_subqueryAliases = array();
<a name="l00119"></a>00119 
<a name="l00124"></a>00124     <span class="keyword">protected</span> $_aggregateAliasMap      = array();
<a name="l00125"></a>00125 
<a name="l00129"></a>00129     <span class="keyword">protected</span> $_pendingAggregates = array();
<a name="l00130"></a>00130 
<a name="l00134"></a><a class="code" href="classDoctrine__Query.html#ab8a3db492514302ce073b753ffadd39d">00134</a>     <span class="keyword">protected</span> <a class="code" href="classDoctrine__Query.html#ab8a3db492514302ce073b753ffadd39d">$_needsSubquery</a> = <span class="keyword">false</span>;
<a name="l00135"></a>00135 
<a name="l00140"></a><a class="code" href="classDoctrine__Query.html#a254013ff4f9af15fbd90ca1ff6234eeb">00140</a>     <span class="keyword">protected</span> <a class="code" href="classDoctrine__Query.html#a254013ff4f9af15fbd90ca1ff6234eeb">$_isSubquery</a>;
<a name="l00141"></a>00141 
<a name="l00145"></a>00145     <span class="keyword">protected</span> $_neededTables = array();
<a name="l00146"></a>00146 
<a name="l00151"></a>00151     <span class="keyword">protected</span> $_pendingSubqueries = array();
<a name="l00152"></a>00152 
<a name="l00156"></a>00156     <span class="keyword">protected</span> $_pendingFields = array();
<a name="l00157"></a>00157 
<a name="l00161"></a>00161     <span class="keyword">protected</span> $_parsers = array();
<a name="l00162"></a>00162 
<a name="l00166"></a>00166     <span class="keyword">protected</span> $_pendingJoinConditions = array();
<a name="l00167"></a>00167 
<a name="l00171"></a>00171     <span class="keyword">protected</span> $_expressionMap = array();
<a name="l00172"></a>00172 
<a name="l00176"></a>00176     <span class="keyword">protected</span> $_sql;
<a name="l00177"></a>00177 
<a name="l00186"></a><a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14">00186</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">create</a>($conn = null, $class = null)
<a name="l00187"></a>00187     {
<a name="l00188"></a>00188         <span class="keywordflow">if</span> ( ! $class) {
<a name="l00189"></a>00189             $class = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>()
<a name="l00190"></a>00190                 -&gt;getAttribute(Doctrine_Core::ATTR_QUERY_CLASS);
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192         <span class="keywordflow">return</span> <span class="keyword">new</span> $class($conn);
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00198"></a><a class="code" href="classDoctrine__Query.html#a753f7480eae0f24bf76d33187df24af3">00198</a>     <span class="keyword">protected</span> function <a class="code" href="classDoctrine__Query.html#a753f7480eae0f24bf76d33187df24af3" title="Clears all the sql parts.">clear</a>()
<a name="l00199"></a>00199     {
<a name="l00200"></a>00200         $this-&gt;_preQueried = <span class="keyword">false</span>;
<a name="l00201"></a>00201         $this-&gt;_pendingJoinConditions = array();
<a name="l00202"></a>00202         $this-&gt;_state = self::STATE_DIRTY;
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204 
<a name="l00208"></a><a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9">00208</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>()
<a name="l00209"></a>00209     {
<a name="l00210"></a>00210         $this-&gt;_subqueryAliases = array();
<a name="l00211"></a>00211         $this-&gt;_aggregateAliasMap = array();
<a name="l00212"></a>00212         $this-&gt;_pendingAggregates = array();
<a name="l00213"></a>00213         $this-&gt;_pendingSubqueries = array();
<a name="l00214"></a>00214         $this-&gt;_pendingFields = array();
<a name="l00215"></a>00215         $this-&gt;_neededTables = array();
<a name="l00216"></a>00216         $this-&gt;_expressionMap = array();
<a name="l00217"></a>00217         $this-&gt;_subqueryAliases = array();
<a name="l00218"></a>00218         $this-&gt;_needsSubquery = <span class="keyword">false</span>;
<a name="l00219"></a>00219         $this-&gt;_isLimitSubqueryUsed = <span class="keyword">false</span>;
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221 
<a name="l00228"></a><a class="code" href="classDoctrine__Query.html#ae529b84d7578a712ced160f723e9a195">00228</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ae529b84d7578a712ced160f723e9a195" title="createSubquery creates a subquery">createSubquery</a>()
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230         $class = get_class($this);
<a name="l00231"></a>00231         $obj   = <span class="keyword">new</span> $class();
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <span class="comment">// copy the aliases to the subquery</span>
<a name="l00234"></a>00234         $obj-&gt;copySubqueryInfo($this);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="comment">// this prevents the &#39;id&#39; being selected, re ticket #307</span>
<a name="l00237"></a>00237         $obj-&gt;isSubquery(<span class="keyword">true</span>);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         <span class="keywordflow">return</span> $obj;
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00249"></a><a class="code" href="classDoctrine__Query.html#a1921bef04c6606489283bb9d8fd992c6">00249</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a1921bef04c6606489283bb9d8fd992c6" title="addPendingJoinCondition">addPendingJoinCondition</a>($componentAlias, $joinCondition)
<a name="l00250"></a>00250     {
<a name="l00251"></a>00251         <span class="keywordflow">if</span> ( ! isset($this-&gt;_pendingJoinConditions[$componentAlias])) {
<a name="l00252"></a>00252             $this-&gt;_pendingJoinConditions[$componentAlias] = array();
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         $this-&gt;_pendingJoinConditions[$componentAlias][] = $joinCondition;
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257 
<a name="l00265"></a><a class="code" href="classDoctrine__Query.html#ae457196735563ebabef27c68ec25ea0b">00265</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ae457196735563ebabef27c68ec25ea0b" title="fetchArray Convenience method to execute using array fetching as hydration mode.">fetchArray</a>($params = array())
<a name="l00266"></a>00266     {
<a name="l00267"></a>00267         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a17243067d561323fe00413bbadb6e71c" title="execute executes the query and populates the data set">execute</a>($params, <a class="code" href="classDoctrine__Core.html#aa98a2c96d8437e185eccacf15c81604c" title="HYDRATE_ARRAY.">Doctrine_Core::HYDRATE_ARRAY</a>);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269 
<a name="l00279"></a><a class="code" href="classDoctrine__Query.html#a9d303659c97f170e6b68b999744843ef">00279</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a9d303659c97f170e6b68b999744843ef" title="fetchOne Convenience method to execute the query and return the first item of the...">fetchOne</a>($params = array(), $hydrationMode = null)
<a name="l00280"></a>00280     {
<a name="l00281"></a>00281         $collection = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a17243067d561323fe00413bbadb6e71c" title="execute executes the query and populates the data set">execute</a>($params, $hydrationMode);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (is_scalar($collection)) {
<a name="l00284"></a>00284             <span class="keywordflow">return</span> $collection;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($collection) === 0) {
<a name="l00288"></a>00288             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         <span class="keywordflow">if</span> ($collection instanceof <a class="code" href="classDoctrine__Collection.html">Doctrine_Collection</a>) {
<a name="l00292"></a>00292             <span class="keywordflow">return</span> $collection-&gt;getFirst();
<a name="l00293"></a>00293         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_array($collection)) {
<a name="l00294"></a>00294             <span class="keywordflow">return</span> array_shift($collection);
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299 
<a name="l00313"></a><a class="code" href="classDoctrine__Query.html#a001b8e28352d1ee3d30ee74123c7623e">00313</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a001b8e28352d1ee3d30ee74123c7623e" title="isSubquery if $bool parameter is set this method sets the value of Doctrine_Query::$isSubquery...">isSubquery</a>($bool = null)
<a name="l00314"></a>00314     {
<a name="l00315"></a>00315         <span class="keywordflow">if</span> ($bool === null) {
<a name="l00316"></a>00316             <span class="keywordflow">return</span> $this-&gt;_isSubquery;
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         $this-&gt;_isSubquery = (bool) $bool;
<a name="l00320"></a>00320         <span class="keywordflow">return</span> $this;
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00329"></a><a class="code" href="classDoctrine__Query.html#a882cc9f1399e9887654a0113f542df27">00329</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a882cc9f1399e9887654a0113f542df27" title="getSqlAggregateAlias">getSqlAggregateAlias</a>($dqlAlias)
<a name="l00330"></a>00330     {
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (isset($this-&gt;_aggregateAliasMap[$dqlAlias])) {
<a name="l00332"></a>00332             <span class="comment">// mark the expression as used</span>
<a name="l00333"></a>00333             $this-&gt;_expressionMap[$dqlAlias][1] = <span class="keyword">true</span>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335             <span class="keywordflow">return</span> $this-&gt;_aggregateAliasMap[$dqlAlias];
<a name="l00336"></a>00336         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! empty($this-&gt;_pendingAggregates)) {
<a name="l00337"></a>00337             $this-&gt;<a class="code" href="classDoctrine__Query.html#ada89e67c99b9ac642031203a0f11e6dc" title="processPendingAggregates processes pending aggregate values for given component alias...">processPendingAggregates</a>();
<a name="l00338"></a>00338 
<a name="l00339"></a>00339             <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classDoctrine__Query.html#a882cc9f1399e9887654a0113f542df27" title="getSqlAggregateAlias">getSqlAggregateAlias</a>($dqlAlias);
<a name="l00340"></a>00340         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ! ($this-&gt;_conn-&gt;getAttribute(Doctrine_Core::ATTR_PORTABILITY) &amp; <a class="code" href="classDoctrine__Core.html#a360438b3bbf360206bf32b73e65ebae4" title="Portability: makes Doctrine_Expression throw exception for unportable RDBMS expressions...">Doctrine_Core::PORTABILITY_EXPR</a>)){
<a name="l00341"></a>00341             <span class="keywordflow">return</span> $dqlAlias;
<a name="l00342"></a>00342         } <span class="keywordflow">else</span> {
<a name="l00343"></a>00343             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown aggregate alias: &#39;</span> . $dqlAlias);
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 
<a name="l00353"></a><a class="code" href="classDoctrine__Query.html#a46cd8c82820b25a01d9416af684c1aa3">00353</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a46cd8c82820b25a01d9416af684c1aa3" title="Check if a dql alias has a sql aggregate alias.">hasSqlAggregateAlias</a>($dqlAlias)
<a name="l00354"></a>00354     {
<a name="l00355"></a>00355         <span class="keywordflow">try</span> {
<a name="l00356"></a>00356             $this-&gt;<a class="code" href="classDoctrine__Query.html#a882cc9f1399e9887654a0113f542df27" title="getSqlAggregateAlias">getSqlAggregateAlias</a>($dqlAlias);
<a name="l00357"></a>00357             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00358"></a>00358         } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00359"></a>00359             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00367"></a><a class="code" href="classDoctrine__Query.html#ae8975f17fb31a8e39bb0e6a534aa5230">00367</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ae8975f17fb31a8e39bb0e6a534aa5230" title="Adjust the processed param index for &amp;quot;foo.bar IN ?&amp;quot; support.">adjustProcessedParam</a>($index)
<a name="l00368"></a>00368     {
<a name="l00369"></a>00369         <span class="comment">// Retrieve all params</span>
<a name="l00370"></a>00370         $params = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a69bac20bfc56df1c7a5dc105205fc968" title="getInternalParams">getInternalParams</a>();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="comment">// Retrieve already processed values</span>
<a name="l00373"></a>00373         $first = array_slice($params, 0, $index);
<a name="l00374"></a>00374         $last = array_slice($params, $index, <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($params) - $index);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         <span class="comment">// Include array as values splicing the params array</span>
<a name="l00377"></a>00377         array_splice($last, 0, 1, $last[0]);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379         <span class="comment">// Put all param values into a single index</span>
<a name="l00380"></a>00380         $this-&gt;_execParams = array_merge($first, $last);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00405"></a><a class="code" href="classDoctrine__Query.html#a643ca35a129a9a069acd98ecf4d3cbee">00405</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a643ca35a129a9a069acd98ecf4d3cbee" title="Retrieves a specific DQL query part.">getDqlPart</a>($queryPart)
<a name="l00406"></a>00406     {
<a name="l00407"></a>00407         <span class="keywordflow">if</span> ( ! isset($this-&gt;_dqlParts[$queryPart])) {
<a name="l00408"></a>00408            <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown query part &#39;</span> . $queryPart);
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <span class="keywordflow">return</span> $this-&gt;_dqlParts[$queryPart];
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413 
<a name="l00422"></a><a class="code" href="classDoctrine__Query.html#ab3b93417f0857a79662345ed4169ac83">00422</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ab3b93417f0857a79662345ed4169ac83" title="contains">contains</a>($dql)
<a name="l00423"></a>00423     {
<a name="l00424"></a>00424       <span class="keywordflow">return</span> stripos($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#afab62ca7b2fd4f605de4caadfa072f53" title="getDql returns the DQL query that is represented by this query object.">getDql</a>(), $dql) === <span class="keyword">false</span> ? <span class="keyword">false</span> : <span class="keyword">true</span>;
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 
<a name="l00440"></a><a class="code" href="classDoctrine__Query.html#a7ffebe61b24c4cf9b622c528f9234c9b">00440</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a7ffebe61b24c4cf9b622c528f9234c9b" title="processPendingFields the fields in SELECT clause cannot be parsed until the components...">processPendingFields</a>($componentAlias)
<a name="l00441"></a>00441     {
<a name="l00442"></a>00442         $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00443"></a>00443         $table = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="keywordflow">if</span> ( ! isset($this-&gt;_pendingFields[$componentAlias])) {
<a name="l00446"></a>00446             <span class="keywordflow">if</span> ($this-&gt;_hydrator-&gt;getHydrationMode() != <a class="code" href="classDoctrine__Core.html#a36531882557012215d8b9024373239fa" title="HYDRATE_NONE.">Doctrine_Core::HYDRATE_NONE</a>) {
<a name="l00447"></a>00447                 <span class="keywordflow">if</span> ( ! $this-&gt;_isSubquery &amp;&amp; $componentAlias == $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>()) {
<a name="l00448"></a>00448                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&quot;The root class of the query (alias $componentAlias) &quot;</span>
<a name="l00449"></a>00449                             . <span class="stringliteral">&quot; must have at least one field selected.&quot;</span>);
<a name="l00450"></a>00450                 }
<a name="l00451"></a>00451             }
<a name="l00452"></a>00452             <span class="keywordflow">return</span>;
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455         <span class="comment">// At this point we know the component is FETCHED (either it&#39;s the base class of</span>
<a name="l00456"></a>00456         <span class="comment">// the query (FROM xyz) or its a &quot;fetch join&quot;).</span>
<a name="l00457"></a>00457 
<a name="l00458"></a>00458         <span class="comment">// Check that the parent join (if there is one), is a &quot;fetch join&quot;, too.</span>
<a name="l00459"></a>00459         <span class="keywordflow">if</span> ( ! $this-&gt;<a class="code" href="classDoctrine__Query.html#a001b8e28352d1ee3d30ee74123c7623e" title="isSubquery if $bool parameter is set this method sets the value of Doctrine_Query::$isSubquery...">isSubquery</a>() &amp;&amp; isset($this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;parent&#39;</span>])) {
<a name="l00460"></a>00460             $parentAlias = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;parent&#39;</span>];
<a name="l00461"></a>00461             <span class="keywordflow">if</span> (is_string($parentAlias) &amp;&amp; ! isset($this-&gt;_pendingFields[$parentAlias])
<a name="l00462"></a>00462                     &amp;&amp; $this-&gt;_hydrator-&gt;getHydrationMode() != <a class="code" href="classDoctrine__Core.html#a36531882557012215d8b9024373239fa" title="HYDRATE_NONE.">Doctrine_Core::HYDRATE_NONE</a>
<a name="l00463"></a>00463                     &amp;&amp; $this-&gt;_hydrator-&gt;getHydrationMode() != <a class="code" href="classDoctrine__Core.html#ae2b6a2cec56a4a8443298e473813116f" title="HYDRATE_SCALAR.">Doctrine_Core::HYDRATE_SCALAR</a>
<a name="l00464"></a>00464                     &amp;&amp; $this-&gt;_hydrator-&gt;getHydrationMode() != <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>) {
<a name="l00465"></a>00465                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&quot;The left side of the join between &quot;</span>
<a name="l00466"></a>00466                         . <span class="stringliteral">&quot;the aliases &#39;$parentAlias&#39; and &#39;$componentAlias&#39; must have at least&quot;</span>
<a name="l00467"></a>00467                         . <span class="stringliteral">&quot; the primary key field(s) selected.&quot;</span>);
<a name="l00468"></a>00468             }
<a name="l00469"></a>00469         }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         $fields = $this-&gt;_pendingFields[$componentAlias];
<a name="l00472"></a>00472 
<a name="l00473"></a>00473         <span class="comment">// check for wildcards</span>
<a name="l00474"></a>00474         <span class="keywordflow">if</span> (in_array(<span class="charliteral">&#39;*&#39;</span>, $fields)) {
<a name="l00475"></a>00475             $fields = $table-&gt;getFieldNames();
<a name="l00476"></a>00476         } <span class="keywordflow">else</span> {
<a name="l00477"></a>00477             $driverClassName = $this-&gt;_hydrator-&gt;getHydratorDriverClassName();
<a name="l00478"></a>00478             <span class="comment">// only auto-add the primary key fields if this query object is not</span>
<a name="l00479"></a>00479             <span class="comment">// a subquery of another query object or we&#39;re using a child of the Object Graph</span>
<a name="l00480"></a>00480             <span class="comment">// hydrator</span>
<a name="l00481"></a>00481             <span class="keywordflow">if</span> ( ! $this-&gt;_isSubquery &amp;&amp; is_subclass_of($driverClassName, <span class="stringliteral">&#39;Doctrine_Hydrator_Graph&#39;</span>)) {
<a name="l00482"></a>00482                 $fields = array_unique(array_merge((array) $table-&gt;getIdentifier(), $fields));
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         $sql = array();
<a name="l00487"></a>00487         <span class="keywordflow">foreach</span> ($fields as $fieldAlias =&gt; $fieldName) {
<a name="l00488"></a>00488             $columnName = $table-&gt;getColumnName($fieldName);
<a name="l00489"></a>00489             <span class="keywordflow">if</span> (($owner = $table-&gt;getColumnOwner($columnName)) !== null &amp;&amp;
<a name="l00490"></a>00490                     $owner !== $table-&gt;getComponentName()) {
<a name="l00491"></a>00491 
<a name="l00492"></a>00492                 $parent = $this-&gt;_conn-&gt;getTable($owner);
<a name="l00493"></a>00493                 $columnName = $parent-&gt;getColumnName($fieldName);
<a name="l00494"></a>00494                 $parentAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias . <span class="charliteral">&#39;.&#39;</span> . $parent-&gt;getComponentName());
<a name="l00495"></a>00495                 $sql[] = $this-&gt;_conn-&gt;quoteIdentifier($parentAlias) . <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($columnName)
<a name="l00496"></a>00496                        . <span class="stringliteral">&#39; AS &#39;</span>
<a name="l00497"></a>00497                        . $this-&gt;_conn-&gt;quoteIdentifier($tableAlias . <span class="stringliteral">&#39;__&#39;</span> . $columnName);
<a name="l00498"></a>00498             } <span class="keywordflow">else</span> {
<a name="l00499"></a>00499                 <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-585</span>
<a name="l00500"></a>00500                 <span class="comment">// Take the field alias if available</span>
<a name="l00501"></a>00501                 <span class="keywordflow">if</span> (isset($this-&gt;_aggregateAliasMap[$fieldAlias])) {
<a name="l00502"></a>00502                     $aliasSql = $this-&gt;_aggregateAliasMap[$fieldAlias];
<a name="l00503"></a>00503                 } <span class="keywordflow">else</span> {
<a name="l00504"></a>00504                     $columnName = $table-&gt;getColumnName($fieldName);
<a name="l00505"></a>00505                     $aliasSql = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias . <span class="stringliteral">&#39;__&#39;</span> . $columnName);
<a name="l00506"></a>00506                 }
<a name="l00507"></a>00507                 $sql[] = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias) . <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($columnName)
<a name="l00508"></a>00508                        . <span class="stringliteral">&#39; AS &#39;</span>
<a name="l00509"></a>00509                        . $aliasSql;
<a name="l00510"></a>00510             }
<a name="l00511"></a>00511         }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         $this-&gt;_neededTables[] = $tableAlias;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515         <span class="keywordflow">return</span> implode(<span class="stringliteral">&#39;, &#39;</span>, $sql);
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517 
<a name="l00531"></a><a class="code" href="classDoctrine__Query.html#a202a3e732debd089b796fa8f34c83649">00531</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a202a3e732debd089b796fa8f34c83649" title="Parses a nested field  $q-&amp;gt;parseSelectField(&amp;#39;u.Phonenumber.value&amp;#39;); ">parseSelectField</a>($field)
<a name="l00532"></a>00532     {
<a name="l00533"></a>00533         $terms = explode(<span class="charliteral">&#39;.&#39;</span>, $field);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="keywordflow">if</span> (isset($terms[1])) {
<a name="l00536"></a>00536             $componentAlias = $terms[0];
<a name="l00537"></a>00537             $field = $terms[1];
<a name="l00538"></a>00538         } <span class="keywordflow">else</span> {
<a name="l00539"></a>00539             <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>($this-&gt;_queryComponents);
<a name="l00540"></a>00540             $componentAlias = key($this-&gt;_queryComponents);
<a name="l00541"></a>00541             $fields = $terms[0];
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00545"></a>00545         $table      = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         <span class="comment">// check for wildcards</span>
<a name="l00549"></a>00549         <span class="keywordflow">if</span> ($field === <span class="charliteral">&#39;*&#39;</span>) {
<a name="l00550"></a>00550             $sql = array();
<a name="l00551"></a>00551 
<a name="l00552"></a>00552             <span class="keywordflow">foreach</span> ($table-&gt;getColumnNames() as $field) {
<a name="l00553"></a>00553                 $sql[] = $this-&gt;<a class="code" href="classDoctrine__Query.html#a202a3e732debd089b796fa8f34c83649" title="Parses a nested field  $q-&amp;gt;parseSelectField(&amp;#39;u.Phonenumber.value&amp;#39;); ">parseSelectField</a>($componentAlias . <span class="charliteral">&#39;.&#39;</span> . $field);
<a name="l00554"></a>00554             }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556             <span class="keywordflow">return</span> implode(<span class="stringliteral">&#39;, &#39;</span>, $sql);
<a name="l00557"></a>00557         } <span class="keywordflow">else</span> {
<a name="l00558"></a>00558             $name = $table-&gt;getColumnName($field);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560             $this-&gt;_neededTables[] = $tableAlias;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562             <span class="keywordflow">return</span> $this-&gt;_conn-&gt;quoteIdentifier($tableAlias . <span class="charliteral">&#39;.&#39;</span> . $name)
<a name="l00563"></a>00563                    . <span class="stringliteral">&#39; AS &#39;</span>
<a name="l00564"></a>00564                    . $this-&gt;_conn-&gt;quoteIdentifier($tableAlias . <span class="stringliteral">&#39;__&#39;</span> . $name);
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00577"></a><a class="code" href="classDoctrine__Query.html#a940f473c51a5d5f49dd78713a281d98c">00577</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a940f473c51a5d5f49dd78713a281d98c" title="getExpressionOwner returns the component alias for owner of given expression">getExpressionOwner</a>($expr)
<a name="l00578"></a>00578     {
<a name="l00579"></a>00579         <span class="keywordflow">if</span> (strtoupper(substr(trim($expr, <span class="stringliteral">&#39;( &#39;</span>), 0, 6)) !== <span class="stringliteral">&#39;SELECT&#39;</span>) {
<a name="l00580"></a>00580             <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-754</span>
<a name="l00581"></a>00581             $expr = preg_replace(<span class="stringliteral">&#39;/([\&#39;\&quot;])[^\1]*\1/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $expr);
<a name="l00582"></a>00582             preg_match_all(<span class="stringliteral">&quot;/[a-z_][a-z0-9_]*\.[a-z_][a-z0-9_]*[\.[a-z0-9]+]*/i&quot;</span>, $expr, $matches);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584             $match = current($matches);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586             <span class="keywordflow">if</span> (isset($match[0])) {
<a name="l00587"></a>00587                 $terms = explode(<span class="charliteral">&#39;.&#39;</span>, $match[0]);
<a name="l00588"></a>00588 
<a name="l00589"></a>00589                 <span class="keywordflow">return</span> $terms[0];
<a name="l00590"></a>00590             }
<a name="l00591"></a>00591         }
<a name="l00592"></a>00592         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>();
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 
<a name="l00604"></a><a class="code" href="classDoctrine__Query.html#a9f9a74eeefff4aaf66704ebf507743da">00604</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a9f9a74eeefff4aaf66704ebf507743da" title="parseSelect parses the query select part and adds selected fields to pendingFields...">parseSelect</a>($dql)
<a name="l00605"></a>00605     {
<a name="l00606"></a>00606         $refs = $this-&gt;_tokenizer-&gt;sqlExplode($dql, <span class="charliteral">&#39;,&#39;</span>);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         $pos   = strpos(trim($refs[0]), <span class="charliteral">&#39; &#39;</span>);
<a name="l00609"></a>00609         $first = substr($refs[0], 0, $pos);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611         <span class="comment">// check for DISTINCT keyword</span>
<a name="l00612"></a>00612         <span class="keywordflow">if</span> ($first === <span class="stringliteral">&#39;DISTINCT&#39;</span>) {
<a name="l00613"></a>00613             $this-&gt;_sqlParts[<span class="stringliteral">&#39;distinct&#39;</span>] = <span class="keyword">true</span>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615             $refs[0] = substr($refs[0], ++$pos);
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         $parsedComponents = array();
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="keywordflow">foreach</span> ($refs as $reference) {
<a name="l00621"></a>00621             $reference = trim($reference);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623             <span class="keywordflow">if</span> (empty($reference)) {
<a name="l00624"></a>00624                 <span class="keywordflow">continue</span>;
<a name="l00625"></a>00625             }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627             $terms = $this-&gt;_tokenizer-&gt;sqlExplode($reference, <span class="charliteral">&#39; &#39;</span>);
<a name="l00628"></a>00628             $pos   = strpos($terms[0], <span class="charliteral">&#39;(&#39;</span>);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630             <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($terms) &gt; 1 || $pos !== <span class="keyword">false</span>) {
<a name="l00631"></a>00631                 $expression = array_shift($terms);
<a name="l00632"></a>00632                 $alias = array_pop($terms);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634                 <span class="keywordflow">if</span> ( ! $alias) {
<a name="l00635"></a>00635                     $alias = substr($expression, 0, $pos);
<a name="l00636"></a>00636                 }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638                 <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-706</span>
<a name="l00639"></a>00639                 <span class="keywordflow">if</span> ($pos !== <span class="keyword">false</span> &amp;&amp; substr($expression, 0, 1) !== <span class="stringliteral">&quot;&#39;&quot;</span> &amp;&amp; substr($expression, 0, $pos) == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00640"></a>00640                     $_queryComponents = $this-&gt;_queryComponents;
<a name="l00641"></a>00641                     <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>($_queryComponents);
<a name="l00642"></a>00642                     $componentAlias = key($_queryComponents);
<a name="l00643"></a>00643                 } <span class="keywordflow">else</span> {
<a name="l00644"></a>00644                     $componentAlias = $this-&gt;<a class="code" href="classDoctrine__Query.html#a940f473c51a5d5f49dd78713a281d98c" title="getExpressionOwner returns the component alias for owner of given expression">getExpressionOwner</a>($expression);
<a name="l00645"></a>00645                 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647                 $expression = $this-&gt;<a class="code" href="classDoctrine__Query.html#a915a99fce83b252d1f28e2655a5585e1" title="parseClause parses given DQL clause">parseClause</a>($expression);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649                 $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651                 $index    = <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_aggregateAliasMap);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                 $sqlAlias = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias . <span class="stringliteral">&#39;__&#39;</span> . $index);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655                 $this-&gt;_sqlParts[<span class="stringliteral">&#39;select&#39;</span>][] = $expression . <span class="stringliteral">&#39; AS &#39;</span> . $sqlAlias;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657                 $this-&gt;_aggregateAliasMap[$alias] = $sqlAlias;
<a name="l00658"></a>00658                 $this-&gt;_expressionMap[$alias][0] = $expression;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660                 $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;agg&#39;</span>][$index] = $alias;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662                 $this-&gt;_neededTables[] = $tableAlias;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                 <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-585</span>
<a name="l00665"></a>00665                 <span class="comment">// Add selected columns to pending fields</span>
<a name="l00666"></a>00666                 <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^([^\(]+)\.(\&#39;?)(.*?)(\&#39;?)$/&#39;</span>, $expression, $field)) {
<a name="l00667"></a>00667                     $this-&gt;_pendingFields[$componentAlias][$alias] = $field[3];
<a name="l00668"></a>00668                 }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670             } <span class="keywordflow">else</span> {
<a name="l00671"></a>00671                 $e = explode(<span class="charliteral">&#39;.&#39;</span>, $terms[0]);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673                 <span class="keywordflow">if</span> (isset($e[1])) {
<a name="l00674"></a>00674                     $componentAlias = $e[0];
<a name="l00675"></a>00675                     $field = $e[1];
<a name="l00676"></a>00676                 } <span class="keywordflow">else</span> {
<a name="l00677"></a>00677                     <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>($this-&gt;_queryComponents);
<a name="l00678"></a>00678                     $componentAlias = key($this-&gt;_queryComponents);
<a name="l00679"></a>00679                     $field = $e[0];
<a name="l00680"></a>00680                 }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682                 $this-&gt;_pendingFields[$componentAlias][] = $field;
<a name="l00683"></a>00683             }
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686 
<a name="l00703"></a><a class="code" href="classDoctrine__Query.html#a915a99fce83b252d1f28e2655a5585e1">00703</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a915a99fce83b252d1f28e2655a5585e1" title="parseClause parses given DQL clause">parseClause</a>($clause)
<a name="l00704"></a>00704     {
<a name="l00705"></a>00705         $clause = $this-&gt;_conn-&gt;dataDict-&gt;parseBoolean(trim($clause));
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <span class="keywordflow">if</span> (is_numeric($clause)) {
<a name="l00708"></a>00708            <span class="keywordflow">return</span> $clause;
<a name="l00709"></a>00709         }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         $terms = $this-&gt;_tokenizer-&gt;clauseExplode($clause, array(<span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;+&#39;</span>, <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, <span class="charliteral">&#39;&lt;&#39;</span>, <span class="charliteral">&#39;&gt;&#39;</span>, <span class="charliteral">&#39;=&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>, <span class="stringliteral">&#39;&lt;=&#39;</span>, <span class="charliteral">&#39;&amp;&#39;</span>, <span class="charliteral">&#39;|&#39;</span>));
<a name="l00712"></a>00712         $str = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         <span class="keywordflow">foreach</span> ($terms as $term) {
<a name="l00715"></a>00715             $pos = strpos($term[0], <span class="charliteral">&#39;(&#39;</span>);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717             <span class="keywordflow">if</span> ($pos !== <span class="keyword">false</span> &amp;&amp; substr($term[0], 0, 1) !== <span class="stringliteral">&quot;&#39;&quot;</span>) {
<a name="l00718"></a>00718                 $name = substr($term[0], 0, $pos);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720                 $term[0] = $this-&gt;parseFunctionExpression($term[0]);
<a name="l00721"></a>00721             } <span class="keywordflow">else</span> {
<a name="l00722"></a>00722                 <span class="keywordflow">if</span> (substr($term[0], 0, 1) !== <span class="stringliteral">&quot;&#39;&quot;</span> &amp;&amp; substr($term[0], -1) !== <span class="stringliteral">&quot;&#39;&quot;</span>) {
<a name="l00723"></a>00723                     <span class="keywordflow">if</span> (strpos($term[0], <span class="charliteral">&#39;.&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l00724"></a>00724                         <span class="keywordflow">if</span> ( ! is_numeric($term[0])) {
<a name="l00725"></a>00725                             $e = explode(<span class="charliteral">&#39;.&#39;</span>, $term[0]);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727                             $field = array_pop($e);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729                             <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a11c4680cf7b99465280b132cdb2b20b4" title="getType">getType</a>() === <a class="code" href="classDoctrine__Query__Abstract.html#a374f84bab2c519f3f025d06c681351d1" title="QUERY TYPE CONSTANTS.">Doctrine_Query::SELECT</a>) {
<a name="l00730"></a>00730                                 $componentAlias = implode(<span class="charliteral">&#39;.&#39;</span>, $e);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732                                 <span class="keywordflow">if</span> (empty($componentAlias)) {
<a name="l00733"></a>00733                                     $componentAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>();
<a name="l00734"></a>00734                                 }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736                                 $this-&gt;<a class="code" href="classDoctrine__Query.html#a4974d0734e2ac66c5699b40355a73559">load</a>($componentAlias);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738                                 <span class="comment">// check the existence of the component alias</span>
<a name="l00739"></a>00739                                 <span class="keywordflow">if</span> ( ! isset($this-&gt;_queryComponents[$componentAlias])) {
<a name="l00740"></a>00740                                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown component alias &#39;</span> . $componentAlias);
<a name="l00741"></a>00741                                 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743                                 $table = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l00744"></a>00744 
<a name="l00745"></a>00745                                 $def = $table-&gt;getDefinitionOf($field);
<a name="l00746"></a>00746 
<a name="l00747"></a>00747                                 <span class="comment">// get the actual field name from alias</span>
<a name="l00748"></a>00748                                 $field = $table-&gt;getColumnName($field);
<a name="l00749"></a>00749 
<a name="l00750"></a>00750                                 <span class="comment">// check column existence</span>
<a name="l00751"></a>00751                                 <span class="keywordflow">if</span> ( ! $def) {
<a name="l00752"></a>00752                                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown column &#39;</span> . $field);
<a name="l00753"></a>00753                                 }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755                                 <span class="keywordflow">if</span> (isset($def[<span class="stringliteral">&#39;owner&#39;</span>])) {
<a name="l00756"></a>00756                                     $componentAlias = $componentAlias . <span class="charliteral">&#39;.&#39;</span> . $def[<span class="stringliteral">&#39;owner&#39;</span>];
<a name="l00757"></a>00757                                 }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759                                 $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761                                 <span class="comment">// build sql expression</span>
<a name="l00762"></a>00762                                 $term[0] = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias)
<a name="l00763"></a>00763                                          . <span class="charliteral">&#39;.&#39;</span>
<a name="l00764"></a>00764                                          . $this-&gt;_conn-&gt;quoteIdentifier($field);
<a name="l00765"></a>00765                             } <span class="keywordflow">else</span> {
<a name="l00766"></a>00766                                 <span class="comment">// build sql expression</span>
<a name="l00767"></a>00767                                 $field = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a7934020d389d94694e8bc5ffac36d30c" title="getRoot returns the root component for this object">getRoot</a>()-&gt;getColumnName($field);
<a name="l00768"></a>00768                                 $term[0] = $this-&gt;_conn-&gt;quoteIdentifier($field);
<a name="l00769"></a>00769                             }
<a name="l00770"></a>00770                         }
<a name="l00771"></a>00771                     } <span class="keywordflow">else</span> {
<a name="l00772"></a>00772                         <span class="keywordflow">if</span> ( ! empty($term[0]) &amp;&amp; ! in_array(strtoupper($term[0]), self::$_keywords) &amp;&amp;
<a name="l00773"></a>00773                              ! is_numeric($term[0]) &amp;&amp; $term[0] !== <span class="charliteral">&#39;?&#39;</span> &amp;&amp; substr($term[0], 0, 1) !== <span class="charliteral">&#39;:&#39;</span>) {
<a name="l00774"></a>00774 
<a name="l00775"></a>00775                             $componentAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>();
<a name="l00776"></a>00776 
<a name="l00777"></a>00777                             $found = <span class="keyword">false</span>;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779                             <span class="keywordflow">if</span> ($componentAlias !== <span class="keyword">false</span> &amp;&amp; $componentAlias !== null) {
<a name="l00780"></a>00780                                 $table = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l00781"></a>00781 
<a name="l00782"></a>00782                                 <span class="comment">// check column existence</span>
<a name="l00783"></a>00783                                 <span class="keywordflow">if</span> ($table-&gt;hasField($term[0])) {
<a name="l00784"></a>00784                                     $found = <span class="keyword">true</span>;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786                                     $def = $table-&gt;getDefinitionOf($term[0]);
<a name="l00787"></a>00787 
<a name="l00788"></a>00788                                     <span class="comment">// get the actual column name from field name</span>
<a name="l00789"></a>00789                                     $term[0] = $table-&gt;getColumnName($term[0]);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 
<a name="l00792"></a>00792                                     <span class="keywordflow">if</span> (isset($def[<span class="stringliteral">&#39;owner&#39;</span>])) {
<a name="l00793"></a>00793                                         $componentAlias = $componentAlias . <span class="charliteral">&#39;.&#39;</span> . $def[<span class="stringliteral">&#39;owner&#39;</span>];
<a name="l00794"></a>00794                                     }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796                                     $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00797"></a>00797 
<a name="l00798"></a>00798                                     <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a11c4680cf7b99465280b132cdb2b20b4" title="getType">getType</a>() === <a class="code" href="classDoctrine__Query__Abstract.html#a374f84bab2c519f3f025d06c681351d1" title="QUERY TYPE CONSTANTS.">Doctrine_Query::SELECT</a>) {
<a name="l00799"></a>00799                                         <span class="comment">// build sql expression</span>
<a name="l00800"></a>00800                                         $term[0] = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias)
<a name="l00801"></a>00801                                                  . <span class="charliteral">&#39;.&#39;</span>
<a name="l00802"></a>00802                                                  . $this-&gt;_conn-&gt;quoteIdentifier($term[0]);
<a name="l00803"></a>00803                                     } <span class="keywordflow">else</span> {
<a name="l00804"></a>00804                                         <span class="comment">// build sql expression</span>
<a name="l00805"></a>00805                                         $term[0] = $this-&gt;_conn-&gt;quoteIdentifier($term[0]);
<a name="l00806"></a>00806                                     }
<a name="l00807"></a>00807                                 } <span class="keywordflow">else</span> {
<a name="l00808"></a>00808                                     $found = <span class="keyword">false</span>;
<a name="l00809"></a>00809                                 }
<a name="l00810"></a>00810                             }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812                             <span class="keywordflow">if</span> ( ! $found) {
<a name="l00813"></a>00813                                 $term[0] = $this-&gt;<a class="code" href="classDoctrine__Query.html#a882cc9f1399e9887654a0113f542df27" title="getSqlAggregateAlias">getSqlAggregateAlias</a>($term[0]);
<a name="l00814"></a>00814                             }
<a name="l00815"></a>00815                         }
<a name="l00816"></a>00816                     }
<a name="l00817"></a>00817                 }
<a name="l00818"></a>00818             }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820             $str .= $term[0] . $term[1];
<a name="l00821"></a>00821         }
<a name="l00822"></a>00822         <span class="keywordflow">return</span> $str;
<a name="l00823"></a>00823     }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     <span class="keyword">public</span> function parseIdentifierReference($expr)
<a name="l00826"></a>00826     {
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="keyword">public</span> function parseFunctionExpression($expr, $parseCallback = null)
<a name="l00831"></a>00831     {
<a name="l00832"></a>00832         $pos = strpos($expr, <span class="charliteral">&#39;(&#39;</span>);
<a name="l00833"></a>00833         $name = substr($expr, 0, $pos);
<a name="l00834"></a>00834 
<a name="l00835"></a>00835         <span class="keywordflow">if</span> ($name === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00836"></a>00836             <span class="keywordflow">return</span> $this-&gt;parseSubquery($expr);
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839         $argStr = substr($expr, ($pos + 1), -1);
<a name="l00840"></a>00840         $args   = array();
<a name="l00841"></a>00841         <span class="comment">// parse args</span>
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <span class="keywordflow">foreach</span> ($this-&gt;_tokenizer-&gt;sqlExplode($argStr, <span class="charliteral">&#39;,&#39;</span>) as $arg) {
<a name="l00844"></a>00844            $args[] = $parseCallback ? call_user_func_array($parseCallback, array($arg)) : $this-&gt;<a class="code" href="classDoctrine__Query.html#a915a99fce83b252d1f28e2655a5585e1" title="parseClause parses given DQL clause">parseClause</a>($arg);
<a name="l00845"></a>00845         }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         <span class="comment">// convert DQL function to its RDBMS specific equivalent</span>
<a name="l00848"></a>00848         <span class="keywordflow">try</span> {
<a name="l00849"></a>00849             $expr = call_user_func_array(array($this-&gt;_conn-&gt;expression, $name), $args);
<a name="l00850"></a>00850         } <span class="keywordflow">catch</span> (<a class="code" href="classDoctrine__Expression__Exception.html">Doctrine_Expression_Exception</a> $e) {
<a name="l00851"></a>00851             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown function &#39;</span> . $name . <span class="charliteral">&#39;.&#39;</span>);
<a name="l00852"></a>00852         }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         <span class="keywordflow">return</span> $expr;
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keyword">public</span> function parseSubquery($subquery)
<a name="l00859"></a>00859     {
<a name="l00860"></a>00860         $trimmed = trim($this-&gt;_tokenizer-&gt;bracketTrim($subquery));
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         <span class="comment">// check for possible subqueries</span>
<a name="l00863"></a>00863         <span class="keywordflow">if</span> (substr($trimmed, 0, 4) == <span class="stringliteral">&#39;FROM&#39;</span> || substr($trimmed, 0, 6) == <span class="stringliteral">&#39;SELECT&#39;</span>) {
<a name="l00864"></a>00864             <span class="comment">// parse subquery</span>
<a name="l00865"></a>00865             $q = $this-&gt;<a class="code" href="classDoctrine__Query.html#ae529b84d7578a712ced160f723e9a195" title="createSubquery creates a subquery">createSubquery</a>()-&gt;parseDqlQuery($trimmed);
<a name="l00866"></a>00866             $trimmed = $q-&gt;getSqlQuery();
<a name="l00867"></a>00867             $q-&gt;free();
<a name="l00868"></a>00868         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (substr($trimmed, 0, 4) == <span class="stringliteral">&#39;SQL:&#39;</span>) {
<a name="l00869"></a>00869             $trimmed = substr($trimmed, 4);
<a name="l00870"></a>00870         } <span class="keywordflow">else</span> {
<a name="l00871"></a>00871             $e = $this-&gt;_tokenizer-&gt;sqlExplode($trimmed, <span class="charliteral">&#39;,&#39;</span>);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873             $value = array();
<a name="l00874"></a>00874             $index = <span class="keyword">false</span>;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876             <span class="keywordflow">foreach</span> ($e as $part) {
<a name="l00877"></a>00877                 $value[] = $this-&gt;<a class="code" href="classDoctrine__Query.html#a915a99fce83b252d1f28e2655a5585e1" title="parseClause parses given DQL clause">parseClause</a>($part);
<a name="l00878"></a>00878             }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880             $trimmed = implode(<span class="stringliteral">&#39;, &#39;</span>, $value);
<a name="l00881"></a>00881         }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         <span class="keywordflow">return</span> <span class="charliteral">&#39;(&#39;</span> . $trimmed . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00884"></a>00884     }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886 
<a name="l00898"></a><a class="code" href="classDoctrine__Query.html#a8a3713d708a81c2f9d58faa8892dc40a">00898</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a8a3713d708a81c2f9d58faa8892dc40a" title="processPendingSubqueries processes pending subqueries">processPendingSubqueries</a>()
<a name="l00899"></a>00899     {
<a name="l00900"></a>00900         <span class="keywordflow">foreach</span> ($this-&gt;_pendingSubqueries as $value) {
<a name="l00901"></a>00901             list($dql, $alias) = $value;
<a name="l00902"></a>00902 
<a name="l00903"></a>00903             $subquery = $this-&gt;<a class="code" href="classDoctrine__Query.html#ae529b84d7578a712ced160f723e9a195" title="createSubquery creates a subquery">createSubquery</a>();
<a name="l00904"></a>00904 
<a name="l00905"></a>00905             $sql = $subquery-&gt;parseDqlQuery($dql, <span class="keyword">false</span>)-&gt;getQuery();
<a name="l00906"></a>00906             $subquery-&gt;free();
<a name="l00907"></a>00907 
<a name="l00908"></a>00908             <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>($this-&gt;_queryComponents);
<a name="l00909"></a>00909             $componentAlias = key($this-&gt;_queryComponents);
<a name="l00910"></a>00910             $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912             $sqlAlias = $tableAlias . <span class="stringliteral">&#39;__&#39;</span> . <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_aggregateAliasMap);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914             $this-&gt;_sqlParts[<span class="stringliteral">&#39;select&#39;</span>][] = <span class="charliteral">&#39;(&#39;</span> . $sql . <span class="stringliteral">&#39;) AS &#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($sqlAlias);
<a name="l00915"></a>00915 
<a name="l00916"></a>00916             $this-&gt;_aggregateAliasMap[$alias] = $sqlAlias;
<a name="l00917"></a>00917             $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;agg&#39;</span>][] = $alias;
<a name="l00918"></a>00918         }
<a name="l00919"></a>00919         $this-&gt;_pendingSubqueries = array();
<a name="l00920"></a>00920     }
<a name="l00921"></a>00921 
<a name="l00929"></a><a class="code" href="classDoctrine__Query.html#ada89e67c99b9ac642031203a0f11e6dc">00929</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ada89e67c99b9ac642031203a0f11e6dc" title="processPendingAggregates processes pending aggregate values for given component alias...">processPendingAggregates</a>()
<a name="l00930"></a>00930     {
<a name="l00931"></a>00931         <span class="comment">// iterate trhough all aggregates</span>
<a name="l00932"></a>00932         <span class="keywordflow">foreach</span> ($this-&gt;_pendingAggregates as $aggregate) {
<a name="l00933"></a>00933             list ($expression, $components, $alias) = $aggregate;
<a name="l00934"></a>00934 
<a name="l00935"></a>00935             $tableAliases = array();
<a name="l00936"></a>00936 
<a name="l00937"></a>00937             <span class="comment">// iterate through the component references within the aggregate function</span>
<a name="l00938"></a>00938             <span class="keywordflow">if</span> ( ! empty ($components)) {
<a name="l00939"></a>00939                 <span class="keywordflow">foreach</span> ($components as $component) {
<a name="l00940"></a>00940 
<a name="l00941"></a>00941                     <span class="keywordflow">if</span> (is_numeric($component)) {
<a name="l00942"></a>00942                         <span class="keywordflow">continue</span>;
<a name="l00943"></a>00943                     }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945                     $e = explode(<span class="charliteral">&#39;.&#39;</span>, $component);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947                     $field = array_pop($e);
<a name="l00948"></a>00948                     $componentAlias = implode(<span class="charliteral">&#39;.&#39;</span>, $e);
<a name="l00949"></a>00949 
<a name="l00950"></a>00950                     <span class="comment">// check the existence of the component alias</span>
<a name="l00951"></a>00951                     <span class="keywordflow">if</span> ( ! isset($this-&gt;_queryComponents[$componentAlias])) {
<a name="l00952"></a>00952                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown component alias &#39;</span> . $componentAlias);
<a name="l00953"></a>00953                     }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955                     $table = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l00956"></a>00956 
<a name="l00957"></a>00957                     $field = $table-&gt;getColumnName($field);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959                     <span class="comment">// check column existence</span>
<a name="l00960"></a>00960                     <span class="keywordflow">if</span> ( ! $table-&gt;hasColumn($field)) {
<a name="l00961"></a>00961                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&#39;Unknown column &#39;</span> . $field);
<a name="l00962"></a>00962                     }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964                     $sqlTableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l00965"></a>00965 
<a name="l00966"></a>00966                     $tableAliases[$sqlTableAlias] = <span class="keyword">true</span>;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968                     <span class="comment">// build sql expression</span>
<a name="l00969"></a>00969 
<a name="l00970"></a>00970                     $identifier = $this-&gt;_conn-&gt;quoteIdentifier($sqlTableAlias . <span class="charliteral">&#39;.&#39;</span> . $field);
<a name="l00971"></a>00971                     $expression = str_replace($component, $identifier, $expression);
<a name="l00972"></a>00972                 }
<a name="l00973"></a>00973             }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975             <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($tableAliases) !== 1) {
<a name="l00976"></a>00976                 $componentAlias = <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>($this-&gt;_tableAliasMap);
<a name="l00977"></a>00977                 $tableAlias = key($this-&gt;_tableAliasMap);
<a name="l00978"></a>00978             }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980             $index    = <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_aggregateAliasMap);
<a name="l00981"></a>00981             $sqlAlias = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias . <span class="stringliteral">&#39;__&#39;</span> . $index);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983             $this-&gt;_sqlParts[<span class="stringliteral">&#39;select&#39;</span>][] = $expression . <span class="stringliteral">&#39; AS &#39;</span> . $sqlAlias;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985             $this-&gt;_aggregateAliasMap[$alias] = $sqlAlias;
<a name="l00986"></a>00986             $this-&gt;_expressionMap[$alias][0] = $expression;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988             $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;agg&#39;</span>][$index] = $alias;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990             $this-&gt;_neededTables[] = $tableAlias;
<a name="l00991"></a>00991         }
<a name="l00992"></a>00992         <span class="comment">// reset the state</span>
<a name="l00993"></a>00993         $this-&gt;_pendingAggregates = array();
<a name="l00994"></a>00994     }
<a name="l00995"></a>00995 
<a name="l01004"></a><a class="code" href="classDoctrine__Query.html#a41032f28eda5b3bd48bea4169430c08b">01004</a>     <span class="keyword">protected</span> function <a class="code" href="classDoctrine__Query.html#a41032f28eda5b3bd48bea4169430c08b" title="_buildSqlQueryBase returns the base of the generated sql query On mysql driver special...">_buildSqlQueryBase</a>()
<a name="l01005"></a>01005     {
<a name="l01006"></a>01006         <span class="keywordflow">switch</span> ($this-&gt;_type) {
<a name="l01007"></a>01007             <span class="keywordflow">case</span> self::DELETE:
<a name="l01008"></a>01008                 $q = <span class="stringliteral">&#39;DELETE FROM &#39;</span>;
<a name="l01009"></a>01009             <span class="keywordflow">break</span>;
<a name="l01010"></a>01010             <span class="keywordflow">case</span> self::UPDATE:
<a name="l01011"></a>01011                 $q = <span class="stringliteral">&#39;UPDATE &#39;</span>;
<a name="l01012"></a>01012             <span class="keywordflow">break</span>;
<a name="l01013"></a>01013             <span class="keywordflow">case</span> self::SELECT:
<a name="l01014"></a>01014                 $distinct = ($this-&gt;_sqlParts[<span class="stringliteral">&#39;distinct&#39;</span>]) ? <span class="stringliteral">&#39;DISTINCT &#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01015"></a>01015                 $q = <span class="stringliteral">&#39;SELECT &#39;</span> . $distinct . implode(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;select&#39;</span>]) . <span class="stringliteral">&#39; FROM &#39;</span>;
<a name="l01016"></a>01016             <span class="keywordflow">break</span>;
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018         <span class="keywordflow">return</span> $q;
<a name="l01019"></a>01019     }
<a name="l01020"></a>01020 
<a name="l01027"></a><a class="code" href="classDoctrine__Query.html#aca9f8c2087df83b67746e8cc75f080fe">01027</a>     <span class="keyword">protected</span> function <a class="code" href="classDoctrine__Query.html#aca9f8c2087df83b67746e8cc75f080fe" title="_buildSqlFromPart builds the from part of the query and returns it">_buildSqlFromPart</a>($ignorePending = <span class="keyword">false</span>)
<a name="l01028"></a>01028     {
<a name="l01029"></a>01029         $q = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031         <span class="keywordflow">foreach</span> ($this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>] as $k =&gt; $part) {
<a name="l01032"></a>01032             $e = explode(<span class="charliteral">&#39; &#39;</span>, $part);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034             <span class="keywordflow">if</span> ($k === 0) {
<a name="l01035"></a>01035                 <span class="keywordflow">if</span> ( ! $ignorePending &amp;&amp; $this-&gt;_type == self::SELECT) {
<a name="l01036"></a>01036                     <span class="comment">// We may still have pending conditions</span>
<a name="l01037"></a>01037                     $alias = <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($e) &gt; 1
<a name="l01038"></a>01038                         ? $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a0e3c92621557181179cb878cd03d77de" title="getComponentAlias get component alias associated with given table alias">getComponentAlias</a>($e[1])
<a name="l01039"></a>01039                         : null;
<a name="l01040"></a>01040                     $where = $this-&gt;<a class="code" href="classDoctrine__Query.html#a5d974e1d562031595c5cbcbd7f0a09ec" title="Processes the pending join conditions, used for dynamically add conditions to root...">_processPendingJoinConditions</a>($alias);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042                     <span class="comment">// apply inheritance to WHERE part</span>
<a name="l01043"></a>01043                     <span class="keywordflow">if</span> ( ! empty($where)) {
<a name="l01044"></a>01044                         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]) &gt; 0) {
<a name="l01045"></a>01045                             $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>][] = <span class="stringliteral">&#39;AND&#39;</span>;
<a name="l01046"></a>01046                         }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048                         <span class="keywordflow">if</span> (substr($where, 0, 1) === <span class="charliteral">&#39;(&#39;</span> &amp;&amp; substr($where, -1) === <span class="charliteral">&#39;)&#39;</span>) {
<a name="l01049"></a>01049                             $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>][] = $where;
<a name="l01050"></a>01050                         } <span class="keywordflow">else</span> {
<a name="l01051"></a>01051                             $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>][] = <span class="charliteral">&#39;(&#39;</span> . $where . <span class="charliteral">&#39;)&#39;</span>;
<a name="l01052"></a>01052                         }
<a name="l01053"></a>01053                     }
<a name="l01054"></a>01054                 }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056                 $q .= $part;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058                 <span class="keywordflow">continue</span>;
<a name="l01059"></a>01059             }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061             <span class="comment">// preserve LEFT JOINs only if needed</span>
<a name="l01062"></a>01062             <span class="comment">// Check if it&#39;s JOIN, if not add a comma separator instead of space</span>
<a name="l01063"></a>01063             <span class="keywordflow">if</span> ( ! preg_match(<span class="stringliteral">&#39;/\bJOIN\b/i&#39;</span>, $part) &amp;&amp; ! isset($this-&gt;_pendingJoinConditions[$k])) {
<a name="l01064"></a>01064                 $q .= <span class="stringliteral">&#39;, &#39;</span> . $part;
<a name="l01065"></a>01065             } <span class="keywordflow">else</span> {
<a name="l01066"></a>01066                 <span class="keywordflow">if</span> (substr($part, 0, 9) === <span class="stringliteral">&#39;LEFT JOIN&#39;</span>) {
<a name="l01067"></a>01067                     $aliases = array_merge($this-&gt;_subqueryAliases,
<a name="l01068"></a>01068                                 array_keys($this-&gt;_neededTables));
<a name="l01069"></a>01069 
<a name="l01070"></a>01070                     <span class="keywordflow">if</span> ( ! in_array($e[3], $aliases) &amp;&amp; ! in_array($e[2], $aliases) &amp;&amp; ! empty($this-&gt;_pendingFields)) {
<a name="l01071"></a>01071                         <span class="keywordflow">continue</span>;
<a name="l01072"></a>01072                     }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074                 }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076                 <span class="keywordflow">if</span> ( ! $ignorePending &amp;&amp; isset($this-&gt;_pendingJoinConditions[$k])) {
<a name="l01077"></a>01077                     <span class="keywordflow">if</span> (strpos($part, <span class="stringliteral">&#39; ON &#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01078"></a>01078                         $part .= <span class="stringliteral">&#39; AND &#39;</span>;
<a name="l01079"></a>01079                     } <span class="keywordflow">else</span> {
<a name="l01080"></a>01080                         $part .= <span class="stringliteral">&#39; ON &#39;</span>;
<a name="l01081"></a>01081                     }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083                     $part .= $this-&gt;<a class="code" href="classDoctrine__Query.html#a5d974e1d562031595c5cbcbd7f0a09ec" title="Processes the pending join conditions, used for dynamically add conditions to root...">_processPendingJoinConditions</a>($k);
<a name="l01084"></a>01084                 }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086                 $componentAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a0e3c92621557181179cb878cd03d77de" title="getComponentAlias get component alias associated with given table alias">getComponentAlias</a>($e[3]);
<a name="l01087"></a>01087                 $string = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#adf86c632e10028a4c934ec8fc008b3bf" title="Returns the inheritance condition for the passed componentAlias If no component alias...">getInheritanceCondition</a>($componentAlias);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089                 <span class="keywordflow">if</span> ($string) {
<a name="l01090"></a>01090                     $part = $part . <span class="stringliteral">&#39; AND &#39;</span> . $string;
<a name="l01091"></a>01091                 }
<a name="l01092"></a>01092                 $q .= <span class="charliteral">&#39; &#39;</span> . $part;
<a name="l01093"></a>01093             }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095             $this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>][$k] = $part;
<a name="l01096"></a>01096         }
<a name="l01097"></a>01097         <span class="keywordflow">return</span> $q;
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099 
<a name="l01108"></a><a class="code" href="classDoctrine__Query.html#a5d974e1d562031595c5cbcbd7f0a09ec">01108</a>     <span class="keyword">protected</span> function <a class="code" href="classDoctrine__Query.html#a5d974e1d562031595c5cbcbd7f0a09ec" title="Processes the pending join conditions, used for dynamically add conditions to root...">_processPendingJoinConditions</a>($alias)
<a name="l01109"></a>01109     {
<a name="l01110"></a>01110         $parts = array();
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         <span class="keywordflow">if</span> ($alias !== null &amp;&amp; isset($this-&gt;_pendingJoinConditions[$alias])) {
<a name="l01113"></a>01113             $parser = <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__JoinCondition.html">Doctrine_Query_JoinCondition</a>($this, $this-&gt;_tokenizer);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115             <span class="keywordflow">foreach</span> ($this-&gt;_pendingJoinConditions[$alias] as $joinCondition) {
<a name="l01116"></a>01116                 $parts[] = $parser-&gt;parse($joinCondition);
<a name="l01117"></a>01117             }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119             <span class="comment">// FIX #1860 and #1876: Cannot unset them, otherwise query cannot be reused later</span>
<a name="l01120"></a>01120             <span class="comment">//unset($this-&gt;_pendingJoinConditions[$alias]);</span>
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         <span class="keywordflow">return</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($parts) &gt; 0 ? <span class="charliteral">&#39;(&#39;</span> . implode(<span class="stringliteral">&#39;) AND (&#39;</span>, $parts) . <span class="charliteral">&#39;)&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125 
<a name="l01135"></a><a class="code" href="classDoctrine__Query.html#a0314dc8431c1dc2b24e01cab3260cc1b">01135</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a0314dc8431c1dc2b24e01cab3260cc1b" title="builds the sql query from the given parameters and applies things such as column...">getSqlQuery</a>($params = array(), $limitSubquery = <span class="keyword">true</span>)
<a name="l01136"></a>01136     {
<a name="l01137"></a>01137         <span class="comment">// Assign building/execution specific params</span>
<a name="l01138"></a>01138         $this-&gt;_params[<span class="stringliteral">&#39;exec&#39;</span>] = $params;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140         <span class="comment">// Initialize prepared parameters array</span>
<a name="l01141"></a>01141         $this-&gt;_execParams = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#aae571f5a486c271f70a7cd14c1309387" title="Get flattened array of parameters for query.">getFlattenedParams</a>();
<a name="l01142"></a>01142 
<a name="l01143"></a>01143         <span class="keywordflow">if</span> ($this-&gt;_state !== self::STATE_DIRTY) {
<a name="l01144"></a>01144             $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a51ce05daab0bd7f7f61783348a843ced">fixArrayParameterValues</a>($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a69bac20bfc56df1c7a5dc105205fc968" title="getInternalParams">getInternalParams</a>());
<a name="l01145"></a>01145 
<a name="l01146"></a>01146             <span class="comment">// Return compiled SQL</span>
<a name="l01147"></a>01147             <span class="keywordflow">return</span> $this-&gt;_sql;
<a name="l01148"></a>01148         }
<a name="l01149"></a>01149         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classDoctrine__Query.html#a0d1fdd6abb7c2e1ab1d682cd81eef4c1" title="Build the SQL query from the DQL.">buildSqlQuery</a>($limitSubquery);
<a name="l01150"></a>01150     }
<a name="l01151"></a>01151 
<a name="l01158"></a><a class="code" href="classDoctrine__Query.html#a0d1fdd6abb7c2e1ab1d682cd81eef4c1">01158</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a0d1fdd6abb7c2e1ab1d682cd81eef4c1" title="Build the SQL query from the DQL.">buildSqlQuery</a>($limitSubquery = <span class="keyword">true</span>)
<a name="l01159"></a>01159     {
<a name="l01160"></a>01160         <span class="comment">// reset the state</span>
<a name="l01161"></a>01161         <span class="keywordflow">if</span> ( ! $this-&gt;<a class="code" href="classDoctrine__Query.html#a001b8e28352d1ee3d30ee74123c7623e" title="isSubquery if $bool parameter is set this method sets the value of Doctrine_Query::$isSubquery...">isSubquery</a>()) {
<a name="l01162"></a>01162             $this-&gt;_queryComponents = array();
<a name="l01163"></a>01163             $this-&gt;_pendingAggregates = array();
<a name="l01164"></a>01164             $this-&gt;_aggregateAliasMap = array();
<a name="l01165"></a>01165         }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167         $this-&gt;<a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>();
<a name="l01168"></a>01168 
<a name="l01169"></a>01169         <span class="comment">// invoke the preQuery hook</span>
<a name="l01170"></a>01170         $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a0ce43da6f066e274a0d01ee20a03f021" title="Pre query method which invokes the pre*Query() methods on the model instance or any...">_preQuery</a>();
<a name="l01171"></a>01171 
<a name="l01172"></a>01172         <span class="comment">// process the DQL parts =&gt; generate the SQL parts.</span>
<a name="l01173"></a>01173         <span class="comment">// this will also populate the $_queryComponents.</span>
<a name="l01174"></a>01174         <span class="keywordflow">foreach</span> ($this-&gt;_dqlParts as $queryPartName =&gt; $queryParts) {
<a name="l01175"></a>01175             <span class="comment">// If we are parsing FROM clause, we&#39;ll need to diff the queryComponents later</span>
<a name="l01176"></a>01176             <span class="keywordflow">if</span> ($queryPartName == <span class="stringliteral">&#39;from&#39;</span>) {
<a name="l01177"></a>01177                 <span class="comment">// Pick queryComponents before processing</span>
<a name="l01178"></a>01178                 $queryComponentsBefore = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#aa8573d794b04605a10fd891d21ad8cfc" title="Gets the components of this query.">getQueryComponents</a>();
<a name="l01179"></a>01179             }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181             <span class="comment">// FIX #1667: _sqlParts are cleaned inside _processDqlQueryPart.</span>
<a name="l01182"></a>01182             <span class="keywordflow">if</span> ($queryPartName != <span class="stringliteral">&#39;forUpdate&#39;</span>) {
<a name="l01183"></a>01183                 $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a4f4206a55ec5ed1de682f10f2d14bf40" title="_processDqlQueryPart parses given query part">_processDqlQueryPart</a>($queryPartName, $queryParts);
<a name="l01184"></a>01184             }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186             <span class="comment">// We need to define the root alias</span>
<a name="l01187"></a>01187             <span class="keywordflow">if</span> ($queryPartName == <span class="stringliteral">&#39;from&#39;</span>) {
<a name="l01188"></a>01188                 <span class="comment">// Pick queryComponents aftr processing</span>
<a name="l01189"></a>01189                 $queryComponentsAfter = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#aa8573d794b04605a10fd891d21ad8cfc" title="Gets the components of this query.">getQueryComponents</a>();
<a name="l01190"></a>01190 
<a name="l01191"></a>01191                 <span class="comment">// Root alias is the key of difference of query components</span>
<a name="l01192"></a>01192                 $diffQueryComponents = array_diff_key($queryComponentsAfter, $queryComponentsBefore);
<a name="l01193"></a>01193                 $this-&gt;_rootAlias = key($diffQueryComponents);
<a name="l01194"></a>01194             }
<a name="l01195"></a>01195         }
<a name="l01196"></a>01196         $this-&gt;_state = self::STATE_CLEAN;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         <span class="comment">// Proceed with the generated SQL</span>
<a name="l01199"></a>01199         <span class="keywordflow">if</span> (empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>])) {
<a name="l01200"></a>01200             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01201"></a>01201         }
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         $needsSubQuery = <span class="keyword">false</span>;
<a name="l01204"></a>01204         $subquery = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01205"></a>01205         $map = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a82bcfeafae635387057c74deac108ca1" title="getRootDeclaration returns the root declaration">getRootDeclaration</a>();
<a name="l01206"></a>01206         $table = $map[<span class="stringliteral">&#39;table&#39;</span>];
<a name="l01207"></a>01207         $rootAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>();
<a name="l01208"></a>01208 
<a name="l01209"></a>01209         <span class="keywordflow">if</span> ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;limit&#39;</span>]) &amp;&amp; $this-&gt;_needsSubquery &amp;&amp;
<a name="l01210"></a>01210                 $table-&gt;getAttribute(Doctrine_Core::ATTR_QUERY_LIMIT) == <a class="code" href="classDoctrine__Core.html#a963e760d01506495ff475bedaa61e992" title="constant for record limiting">Doctrine_Core::LIMIT_RECORDS</a>) {
<a name="l01211"></a>01211             <span class="comment">// We do not need a limit-subquery if DISTINCT is used</span>
<a name="l01212"></a>01212             <span class="comment">// and the selected fields are either from the root component or from a localKey relation (hasOne)</span>
<a name="l01213"></a>01213             <span class="comment">// (i.e. DQL: SELECT DISTINCT u.id FROM User u LEFT JOIN u.phonenumbers LIMIT 5).</span>
<a name="l01214"></a>01214             <span class="keywordflow">if</span>(!$this-&gt;_sqlParts[<span class="stringliteral">&#39;distinct&#39;</span>]) {
<a name="l01215"></a>01215                 $this-&gt;_isLimitSubqueryUsed = <span class="keyword">true</span>;
<a name="l01216"></a>01216                 $needsSubQuery = <span class="keyword">true</span>;
<a name="l01217"></a>01217             } <span class="keywordflow">else</span> {
<a name="l01218"></a>01218                 <span class="keywordflow">foreach</span>( array_keys($this-&gt;_pendingFields) as $alias){
<a name="l01219"></a>01219                     <span class="comment">//no subquery for root fields</span>
<a name="l01220"></a>01220                     <span class="keywordflow">if</span>($alias == $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>()){
<a name="l01221"></a>01221                         <span class="keywordflow">continue</span>;
<a name="l01222"></a>01222                     }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224                     <span class="comment">//no subquery for ONE relations</span>
<a name="l01225"></a>01225                     <span class="keywordflow">if</span>(isset($this-&gt;_queryComponents[$alias][<span class="stringliteral">&#39;relation&#39;</span>]) &amp;&amp;
<a name="l01226"></a>01226                         $this-&gt;_queryComponents[$alias][<span class="stringliteral">&#39;relation&#39;</span>]-&gt;getType() == <a class="code" href="classDoctrine__Relation.html#ad1d58e954205119e9796bec18d516970" title="RELATION CONSTANTS.">Doctrine_Relation::ONE</a>){
<a name="l01227"></a>01227                         <span class="keywordflow">continue</span>;
<a name="l01228"></a>01228                     }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230                     $this-&gt;_isLimitSubqueryUsed = <span class="keyword">true</span>;
<a name="l01231"></a>01231                     $needsSubQuery = <span class="keyword">true</span>;
<a name="l01232"></a>01232                 }
<a name="l01233"></a>01233             }
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236         $sql = array();
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         <span class="keywordflow">if</span> ( ! empty($this-&gt;_pendingFields)) {
<a name="l01239"></a>01239             <span class="keywordflow">foreach</span> ($this-&gt;_queryComponents as $alias =&gt; $map) {
<a name="l01240"></a>01240                 $fieldSql = $this-&gt;<a class="code" href="classDoctrine__Query.html#a7ffebe61b24c4cf9b622c528f9234c9b" title="processPendingFields the fields in SELECT clause cannot be parsed until the components...">processPendingFields</a>($alias);
<a name="l01241"></a>01241                 <span class="keywordflow">if</span> ( ! empty($fieldSql)) {
<a name="l01242"></a>01242                     $sql[] = $fieldSql;
<a name="l01243"></a>01243                 }
<a name="l01244"></a>01244             }
<a name="l01245"></a>01245         }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247         <span class="keywordflow">if</span> ( ! empty($sql)) {
<a name="l01248"></a>01248             array_unshift($this-&gt;_sqlParts[<span class="stringliteral">&#39;select&#39;</span>], implode(<span class="stringliteral">&#39;, &#39;</span>, $sql));
<a name="l01249"></a>01249         }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251         $this-&gt;_pendingFields = array();
<a name="l01252"></a>01252 
<a name="l01253"></a>01253         <span class="comment">// build the basic query</span>
<a name="l01254"></a>01254         $q  = $this-&gt;<a class="code" href="classDoctrine__Query.html#a41032f28eda5b3bd48bea4169430c08b" title="_buildSqlQueryBase returns the base of the generated sql query On mysql driver special...">_buildSqlQueryBase</a>();
<a name="l01255"></a>01255         $q .= $this-&gt;<a class="code" href="classDoctrine__Query.html#aca9f8c2087df83b67746e8cc75f080fe" title="_buildSqlFromPart builds the from part of the query and returns it">_buildSqlFromPart</a>();
<a name="l01256"></a>01256 
<a name="l01257"></a>01257         <span class="keywordflow">if</span> ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;set&#39;</span>])) {
<a name="l01258"></a>01258             $q .= <span class="stringliteral">&#39; SET &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;set&#39;</span>]);
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261         $string = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#adf86c632e10028a4c934ec8fc008b3bf" title="Returns the inheritance condition for the passed componentAlias If no component alias...">getInheritanceCondition</a>($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>());
<a name="l01262"></a>01262 
<a name="l01263"></a>01263         <span class="comment">// apply inheritance to WHERE part</span>
<a name="l01264"></a>01264         <span class="keywordflow">if</span> ( ! empty($string)) {
<a name="l01265"></a>01265             <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]) &gt; 0) {
<a name="l01266"></a>01266                 $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>][] = <span class="stringliteral">&#39;AND&#39;</span>;
<a name="l01267"></a>01267             }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269             <span class="keywordflow">if</span> (substr($string, 0, 1) === <span class="charliteral">&#39;(&#39;</span> &amp;&amp; substr($string, -1) === <span class="charliteral">&#39;)&#39;</span>) {
<a name="l01270"></a>01270                 $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>][] = $string;
<a name="l01271"></a>01271             } <span class="keywordflow">else</span> {
<a name="l01272"></a>01272                 $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>][] = <span class="charliteral">&#39;(&#39;</span> . $string . <span class="charliteral">&#39;)&#39;</span>;
<a name="l01273"></a>01273             }
<a name="l01274"></a>01274         }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276         $modifyLimit = <span class="keyword">true</span>;
<a name="l01277"></a>01277         $limitSubquerySql = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279         <span class="keywordflow">if</span> ( ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;limit&#39;</span>]) || ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;offset&#39;</span>])) &amp;&amp; $needsSubQuery &amp;&amp; $limitSubquery) {
<a name="l01280"></a>01280             $subquery = $this-&gt;<a class="code" href="classDoctrine__Query.html#ab852eb05371ea686d8e5e847ed4781b7" title="getLimitSubquery this is method is used by the record limit algorithm">getLimitSubquery</a>();
<a name="l01281"></a>01281 
<a name="l01282"></a>01282             <span class="comment">// what about composite keys?</span>
<a name="l01283"></a>01283             $idColumnName = $table-&gt;getColumnName($table-&gt;getIdentifier());
<a name="l01284"></a>01284 
<a name="l01285"></a>01285             <span class="keywordflow">switch</span> (strtolower($this-&gt;_conn-&gt;getDriverName())) {
<a name="l01286"></a>01286                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;mysql&#39;</span>:
<a name="l01287"></a>01287                     $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a0ef267754385e282aabc06800b0700b8" title="useQueryCache">useQueryCache</a>(<span class="keyword">false</span>);
<a name="l01288"></a>01288 
<a name="l01289"></a>01289                     <span class="comment">// mysql doesn&#39;t support LIMIT in subqueries</span>
<a name="l01290"></a>01290                     $list = $this-&gt;_conn-&gt;execute($subquery, $this-&gt;_execParams)-&gt;fetchAll(Doctrine_Core::FETCH_COLUMN);
<a name="l01291"></a>01291                     $subquery = implode(<span class="stringliteral">&#39;, &#39;</span>, array_map(array($this-&gt;_conn, <span class="stringliteral">&#39;quote&#39;</span>), $list));
<a name="l01292"></a>01292 
<a name="l01293"></a>01293                     <span class="keywordflow">break</span>;
<a name="l01294"></a>01294 
<a name="l01295"></a>01295                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;pgsql&#39;</span>:
<a name="l01296"></a>01296                     $subqueryAlias = $this-&gt;_conn-&gt;quoteIdentifier(<span class="stringliteral">&#39;doctrine_subquery_alias&#39;</span>);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298                     <span class="comment">// pgsql needs special nested LIMIT subquery</span>
<a name="l01299"></a>01299                     $subquery = <span class="stringliteral">&#39;SELECT &#39;</span> . $subqueryAlias . <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($idColumnName)
<a name="l01300"></a>01300                             . <span class="stringliteral">&#39; FROM (&#39;</span> . $subquery . <span class="stringliteral">&#39;) AS &#39;</span> . $subqueryAlias;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302                     <span class="keywordflow">break</span>;
<a name="l01303"></a>01303             }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305             $field = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($rootAlias) . <span class="charliteral">&#39;.&#39;</span> . $idColumnName;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307             <span class="comment">// FIX #1868: If not ID under MySQL is found to be restricted, restrict pk column for null</span>
<a name="l01308"></a>01308             <span class="comment">//            (which will lead to a return of 0 items)</span>
<a name="l01309"></a>01309             $limitSubquerySql = $this-&gt;_conn-&gt;quoteIdentifier($field)
<a name="l01310"></a>01310                               . (( ! empty($subquery)) ? <span class="stringliteral">&#39; IN (&#39;</span> . $subquery . <span class="charliteral">&#39;)&#39;</span> : <span class="stringliteral">&#39; IS NULL&#39;</span>)
<a name="l01311"></a>01311                               . ((<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]) &gt; 0) ? <span class="stringliteral">&#39; AND &#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01312"></a>01312 
<a name="l01313"></a>01313             $modifyLimit = <span class="keyword">false</span>;
<a name="l01314"></a>01314         }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316         <span class="comment">// FIX #DC-26: Include limitSubquerySql as major relevance in conditions</span>
<a name="l01317"></a>01317         $emptyWhere = empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319         <span class="keywordflow">if</span> ( ! ($emptyWhere &amp;&amp; $limitSubquerySql == <span class="stringliteral">&#39;&#39;</span>)) {
<a name="l01320"></a>01320             $where = implode(<span class="charliteral">&#39; &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]);
<a name="l01321"></a>01321             $where = ($where == <span class="stringliteral">&#39;&#39;</span> || (substr($where, 0, 1) === <span class="charliteral">&#39;(&#39;</span> &amp;&amp; substr($where, -1) === <span class="charliteral">&#39;)&#39;</span>))
<a name="l01322"></a>01322                 ? $where : <span class="charliteral">&#39;(&#39;</span> . $where . <span class="charliteral">&#39;)&#39;</span>;
<a name="l01323"></a>01323 
<a name="l01324"></a>01324             $q .= <span class="stringliteral">&#39; WHERE &#39;</span> . $limitSubquerySql . $where;
<a name="l01325"></a>01325             <span class="comment">//   .  (($limitSubquerySql == &#39;&#39; &amp;&amp; count($this-&gt;_sqlParts[&#39;where&#39;]) == 1) ? substr($where, 1, -1) : $where);</span>
<a name="l01326"></a>01326         }
<a name="l01327"></a>01327 
<a name="l01328"></a>01328         <span class="comment">// Fix the orderbys so we only have one orderby per value</span>
<a name="l01329"></a>01329         <span class="keywordflow">foreach</span> ($this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>] as $k =&gt; $orderBy) {
<a name="l01330"></a>01330             $e = explode(<span class="stringliteral">&#39;, &#39;</span>, $orderBy);
<a name="l01331"></a>01331             unset($this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>][$k]);
<a name="l01332"></a>01332             <span class="keywordflow">foreach</span> ($e as $v) {
<a name="l01333"></a>01333                 $this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>][] = $v;
<a name="l01334"></a>01334             }
<a name="l01335"></a>01335         }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337         <span class="comment">// Add the default orderBy statements defined in the relationships and table classes</span>
<a name="l01338"></a>01338         <span class="comment">// Only do this for SELECT queries</span>
<a name="l01339"></a>01339         <span class="keywordflow">if</span> ($this-&gt;_type === self::SELECT) {
<a name="l01340"></a>01340             <span class="keywordflow">foreach</span> ($this-&gt;_queryComponents as $alias =&gt; $map) {
<a name="l01341"></a>01341                 $sqlAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($alias);
<a name="l01342"></a>01342                 <span class="keywordflow">if</span> (isset($map[<span class="stringliteral">&#39;relation&#39;</span>])) {
<a name="l01343"></a>01343                     $orderBy = $map[<span class="stringliteral">&#39;relation&#39;</span>]-&gt;getOrderByStatement($sqlAlias, <span class="keyword">true</span>);
<a name="l01344"></a>01344                     <span class="keywordflow">if</span> ($orderBy == $map[<span class="stringliteral">&#39;relation&#39;</span>][<span class="stringliteral">&#39;orderBy&#39;</span>]) {
<a name="l01345"></a>01345                         <span class="keywordflow">if</span> (isset($map[<span class="stringliteral">&#39;ref&#39;</span>])) {
<a name="l01346"></a>01346                             $orderBy = $map[<span class="stringliteral">&#39;relation&#39;</span>][<span class="stringliteral">&#39;refTable&#39;</span>]-&gt;processOrderBy($sqlAlias, $map[<span class="stringliteral">&#39;relation&#39;</span>][<span class="stringliteral">&#39;orderBy&#39;</span>], <span class="keyword">true</span>);
<a name="l01347"></a>01347                         } <span class="keywordflow">else</span> {
<a name="l01348"></a>01348                             $orderBy = null;
<a name="l01349"></a>01349                         }
<a name="l01350"></a>01350                     }
<a name="l01351"></a>01351                 } <span class="keywordflow">else</span> {
<a name="l01352"></a>01352                     $orderBy = $map[<span class="stringliteral">&#39;table&#39;</span>]-&gt;getOrderByStatement($sqlAlias, <span class="keyword">true</span>);
<a name="l01353"></a>01353                 }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355                 <span class="keywordflow">if</span> ($orderBy) {
<a name="l01356"></a>01356                     $e = explode(<span class="charliteral">&#39;,&#39;</span>, $orderBy);
<a name="l01357"></a>01357                     $e = array_map(<span class="stringliteral">&#39;trim&#39;</span>, $e);
<a name="l01358"></a>01358                     <span class="keywordflow">foreach</span> ($e as $v) {
<a name="l01359"></a>01359                         <span class="keywordflow">if</span> ( ! in_array($v, $this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>])) {
<a name="l01360"></a>01360                             $this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>][] = $v;
<a name="l01361"></a>01361                         }
<a name="l01362"></a>01362                     }
<a name="l01363"></a>01363                 }
<a name="l01364"></a>01364             }
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367         $q .= ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;groupby&#39;</span>])) ? <span class="stringliteral">&#39; GROUP BY &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;groupby&#39;</span>])  : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01368"></a>01368         $q .= ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;having&#39;</span>])) ?  <span class="stringliteral">&#39; HAVING &#39;</span>   . implode(<span class="stringliteral">&#39; AND &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;having&#39;</span>]): <span class="stringliteral">&#39;&#39;</span>;
<a name="l01369"></a>01369         $q .= ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>])) ? <span class="stringliteral">&#39; ORDER BY &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>])  : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371         <span class="keywordflow">if</span> ($modifyLimit) {
<a name="l01372"></a>01372             $q = $this-&gt;_conn-&gt;modifyLimitQuery($q, $this-&gt;_sqlParts[<span class="stringliteral">&#39;limit&#39;</span>], $this-&gt;_sqlParts[<span class="stringliteral">&#39;offset&#39;</span>], <span class="keyword">false</span>, <span class="keyword">false</span>, $this);
<a name="l01373"></a>01373         }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375         $q .= $this-&gt;_sqlParts[<span class="stringliteral">&#39;forUpdate&#39;</span>] === <span class="keyword">true</span> ? <span class="stringliteral">&#39; FOR UPDATE &#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377         $this-&gt;_sql = $q;
<a name="l01378"></a>01378 
<a name="l01379"></a>01379         $this-&gt;<a class="code" href="classDoctrine__Query.html#a753f7480eae0f24bf76d33187df24af3" title="Clears all the sql parts.">clear</a>();
<a name="l01380"></a>01380 
<a name="l01381"></a>01381         <span class="keywordflow">return</span> $q;
<a name="l01382"></a>01382     }
<a name="l01383"></a>01383 
<a name="l01395"></a><a class="code" href="classDoctrine__Query.html#ab852eb05371ea686d8e5e847ed4781b7">01395</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ab852eb05371ea686d8e5e847ed4781b7" title="getLimitSubquery this is method is used by the record limit algorithm">getLimitSubquery</a>()
<a name="l01396"></a>01396     {
<a name="l01397"></a>01397         $map = <a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>($this-&gt;_queryComponents);
<a name="l01398"></a>01398         $table = $map[<span class="stringliteral">&#39;table&#39;</span>];
<a name="l01399"></a>01399         $componentAlias = key($this-&gt;_queryComponents);
<a name="l01400"></a>01400 
<a name="l01401"></a>01401         <span class="comment">// get short alias</span>
<a name="l01402"></a>01402         $alias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l01403"></a>01403         <span class="comment">// what about composite keys?</span>
<a name="l01404"></a>01404         $primaryKey = $alias . <span class="charliteral">&#39;.&#39;</span> . $table-&gt;getColumnName($table-&gt;getIdentifier());
<a name="l01405"></a>01405 
<a name="l01406"></a>01406         $driverName = $this-&gt;_conn-&gt;getAttribute(Doctrine_Core::ATTR_DRIVER_NAME);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         <span class="comment">// initialize the base of the subquery</span>
<a name="l01409"></a>01409         <span class="keywordflow">if</span> (($driverName == <span class="stringliteral">&#39;oracle&#39;</span> || $driverName == <span class="stringliteral">&#39;oci&#39;</span>) &amp;&amp; $this-&gt;_isOrderedByJoinedColumn()) {
<a name="l01410"></a>01410             $subquery = <span class="stringliteral">&#39;SELECT &#39;</span>;
<a name="l01411"></a>01411         } <span class="keywordflow">else</span> {
<a name="l01412"></a>01412             $subquery = <span class="stringliteral">&#39;SELECT DISTINCT &#39;</span>;
<a name="l01413"></a>01413         }
<a name="l01414"></a>01414         $subquery .= $this-&gt;_conn-&gt;quoteIdentifier($primaryKey);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416         <span class="comment">// pgsql &amp; oracle need the order by fields to be preserved in select clause</span>
<a name="l01417"></a>01417         <span class="keywordflow">if</span> ($driverName == <span class="stringliteral">&#39;pgsql&#39;</span> || $driverName == <span class="stringliteral">&#39;oracle&#39;</span> || $driverName == <span class="stringliteral">&#39;oci&#39;</span> || $driverName == <span class="stringliteral">&#39;mssql&#39;</span> || $driverName == <span class="stringliteral">&#39;odbc&#39;</span>) {
<a name="l01418"></a>01418             <span class="keywordflow">foreach</span> ($this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>] as $part) {
<a name="l01419"></a>01419                 <span class="comment">// Remove identifier quoting if it exists</span>
<a name="l01420"></a>01420                 $e = $this-&gt;_tokenizer-&gt;bracketExplode($part, <span class="charliteral">&#39; &#39;</span>);
<a name="l01421"></a>01421                 <span class="keywordflow">foreach</span> ($e as $f) {
<a name="l01422"></a>01422                     <span class="keywordflow">if</span> ($f == 0 || $f % 2 == 0) {
<a name="l01423"></a>01423                         $partOriginal = str_replace(<span class="charliteral">&#39;,&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, trim($f));
<a name="l01424"></a>01424                         $callback = create_function(<span class="stringliteral">&#39;$e&#39;</span>, <span class="stringliteral">&#39;return trim($e, \&#39;[]`&quot;\&#39;);&#39;</span>);
<a name="l01425"></a>01425                         $part = trim(implode(<span class="charliteral">&#39;.&#39;</span>, array_map($callback, explode(<span class="charliteral">&#39;.&#39;</span>, $partOriginal))));
<a name="l01426"></a>01426 
<a name="l01427"></a>01427                         <span class="keywordflow">if</span> (strpos($part, <span class="charliteral">&#39;.&#39;</span>) === <span class="keyword">false</span>) {
<a name="l01428"></a>01428                             <span class="keywordflow">continue</span>;
<a name="l01429"></a>01429                         }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431                         <span class="comment">// don&#39;t add functions</span>
<a name="l01432"></a>01432                         <span class="keywordflow">if</span> (strpos($part, <span class="charliteral">&#39;(&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01433"></a>01433                             <span class="keywordflow">continue</span>;
<a name="l01434"></a>01434                         }
<a name="l01435"></a>01435 
<a name="l01436"></a>01436                         <span class="comment">// don&#39;t add primarykey column (its already in the select clause)</span>
<a name="l01437"></a>01437                         <span class="keywordflow">if</span> ($part !== $primaryKey) {
<a name="l01438"></a>01438                             $subquery .= <span class="stringliteral">&#39;, &#39;</span> . $partOriginal;
<a name="l01439"></a>01439                         }
<a name="l01440"></a>01440                     }
<a name="l01441"></a>01441                 }
<a name="l01442"></a>01442             }
<a name="l01443"></a>01443         }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445         $orderby = $this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>];
<a name="l01446"></a>01446         $having = $this-&gt;_sqlParts[<span class="stringliteral">&#39;having&#39;</span>];
<a name="l01447"></a>01447         <span class="keywordflow">if</span> ($driverName == <span class="stringliteral">&#39;mysql&#39;</span> || $driverName == <span class="stringliteral">&#39;pgsql&#39;</span>) {
<a name="l01448"></a>01448             <span class="keywordflow">foreach</span> ($this-&gt;_expressionMap as $dqlAlias =&gt; $expr) {
<a name="l01449"></a>01449                 <span class="keywordflow">if</span> (isset($expr[1])) {
<a name="l01450"></a>01450                     $subquery .= <span class="stringliteral">&#39;, &#39;</span> . $expr[0] . <span class="stringliteral">&#39; AS &#39;</span> . $this-&gt;_aggregateAliasMap[$dqlAlias];
<a name="l01451"></a>01451                 }
<a name="l01452"></a>01452             }
<a name="l01453"></a>01453         } <span class="keywordflow">else</span> {
<a name="l01454"></a>01454             <span class="keywordflow">foreach</span> ($this-&gt;_expressionMap as $dqlAlias =&gt; $expr) {
<a name="l01455"></a>01455                 <span class="keywordflow">if</span> (isset($expr[1])) {
<a name="l01456"></a>01456                     <span class="keywordflow">foreach</span> ($having as $k =&gt; $v) {
<a name="l01457"></a>01457                         $having[$k] = str_replace($this-&gt;_aggregateAliasMap[$dqlAlias], $expr[0], $v);
<a name="l01458"></a>01458                     }
<a name="l01459"></a>01459                     <span class="keywordflow">foreach</span> ($orderby as $k =&gt; $v) {
<a name="l01460"></a>01460                         $e = explode(<span class="charliteral">&#39; &#39;</span>, $v);
<a name="l01461"></a>01461                         <span class="keywordflow">if</span> ($e[0] == $this-&gt;_aggregateAliasMap[$dqlAlias]) {
<a name="l01462"></a>01462                             $orderby[$k] = $expr[0];
<a name="l01463"></a>01463                         }
<a name="l01464"></a>01464                     }
<a name="l01465"></a>01465                 }
<a name="l01466"></a>01466             }
<a name="l01467"></a>01467         }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469         <span class="comment">// Add having fields that got stripped out of select</span>
<a name="l01470"></a>01470         preg_match_all(<span class="stringliteral">&#39;/`[a-z0-9_]+`\.`[a-z0-9_]+`/i&#39;</span>, implode(<span class="charliteral">&#39; &#39;</span>, $having), $matches, PREG_PATTERN_ORDER);
<a name="l01471"></a>01471         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($matches[0]) &gt; 0) {
<a name="l01472"></a>01472             $subquery .= <span class="stringliteral">&#39;, &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, array_unique($matches[0]));
<a name="l01473"></a>01473         }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475         $subquery .= <span class="stringliteral">&#39; FROM&#39;</span>;
<a name="l01476"></a>01476 
<a name="l01477"></a>01477         <span class="keywordflow">foreach</span> ($this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>] as $part) {
<a name="l01478"></a>01478             <span class="comment">// preserve LEFT JOINs only if needed</span>
<a name="l01479"></a>01479             <span class="keywordflow">if</span> (substr($part, 0, 9) === <span class="stringliteral">&#39;LEFT JOIN&#39;</span>) {
<a name="l01480"></a>01480                 $e = explode(<span class="charliteral">&#39; &#39;</span>, $part);
<a name="l01481"></a>01481                 <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-706</span>
<a name="l01482"></a>01482                 <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-594</span>
<a name="l01483"></a>01483                 <span class="keywordflow">if</span> (empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>]) &amp;&amp; empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]) &amp;&amp; empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;having&#39;</span>]) &amp;&amp; empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;groupby&#39;</span>])) {
<a name="l01484"></a>01484                     <span class="keywordflow">continue</span>;
<a name="l01485"></a>01485                 }
<a name="l01486"></a>01486             }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488             $subquery .= <span class="charliteral">&#39; &#39;</span> . $part;
<a name="l01489"></a>01489         }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491         <span class="comment">// all conditions must be preserved in subquery</span>
<a name="l01492"></a>01492         $subquery .= ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>]))?   <span class="stringliteral">&#39; WHERE &#39;</span>    . implode(<span class="charliteral">&#39; &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>])  : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01493"></a>01493         $subquery .= ( ! empty($this-&gt;_sqlParts[<span class="stringliteral">&#39;groupby&#39;</span>]))? <span class="stringliteral">&#39; GROUP BY &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;_sqlParts[<span class="stringliteral">&#39;groupby&#39;</span>])   : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01494"></a>01494         $subquery .= ( ! empty($having))?  <span class="stringliteral">&#39; HAVING &#39;</span>   . implode(<span class="stringliteral">&#39; AND &#39;</span>, $having) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01495"></a>01495         $subquery .= ( ! empty($orderby))? <span class="stringliteral">&#39; ORDER BY &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $orderby)  : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497         <span class="keywordflow">if</span> (($driverName == <span class="stringliteral">&#39;oracle&#39;</span> || $driverName == <span class="stringliteral">&#39;oci&#39;</span>) &amp;&amp; $this-&gt;_isOrderedByJoinedColumn()) {
<a name="l01498"></a>01498             <span class="comment">// When using &quot;ORDER BY x.foo&quot; where x.foo is a column of a joined table,</span>
<a name="l01499"></a>01499             <span class="comment">// we may get duplicate primary keys because all columns in ORDER BY must appear</span>
<a name="l01500"></a>01500             <span class="comment">// in the SELECT list when using DISTINCT. Hence we need to filter out the</span>
<a name="l01501"></a>01501             <span class="comment">// primary keys with an additional DISTINCT subquery.</span>
<a name="l01502"></a>01502             <span class="comment">// #1038</span>
<a name="l01503"></a>01503             $quotedIdentifierColumnName = $this-&gt;_conn-&gt;quoteIdentifier($table-&gt;getColumnName($table-&gt;getIdentifier()));
<a name="l01504"></a>01504             $subquery = <span class="stringliteral">&#39;SELECT doctrine_subquery_alias.&#39;</span> . $quotedIdentifierColumnName
<a name="l01505"></a>01505                     . <span class="stringliteral">&#39; FROM (&#39;</span> . $subquery . <span class="stringliteral">&#39;) doctrine_subquery_alias&#39;</span>
<a name="l01506"></a>01506                     . <span class="stringliteral">&#39; GROUP BY doctrine_subquery_alias.&#39;</span> . $quotedIdentifierColumnName
<a name="l01507"></a>01507                     . <span class="stringliteral">&#39; ORDER BY MIN(ROWNUM)&#39;</span>;
<a name="l01508"></a>01508         }
<a name="l01509"></a>01509 
<a name="l01510"></a>01510         <span class="comment">// add driver specific limit clause</span>
<a name="l01511"></a>01511         $subquery = $this-&gt;_conn-&gt;modifyLimitSubquery($table, $subquery, $this-&gt;_sqlParts[<span class="stringliteral">&#39;limit&#39;</span>], $this-&gt;_sqlParts[<span class="stringliteral">&#39;offset&#39;</span>]);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         $parts = $this-&gt;_tokenizer-&gt;quoteExplode($subquery, <span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l01514"></a>01514 
<a name="l01515"></a>01515         <span class="keywordflow">foreach</span> ($parts as $k =&gt; $part) {
<a name="l01516"></a>01516             <span class="keywordflow">if</span> (strpos($part, <span class="charliteral">&#39; &#39;</span>) !== <span class="keyword">false</span>) {
<a name="l01517"></a>01517                 <span class="keywordflow">continue</span>;
<a name="l01518"></a>01518             }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520             $part = str_replace(array(<span class="charliteral">&#39;&quot;&#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span>, <span class="charliteral">&#39;`&#39;</span>), <span class="stringliteral">&quot;&quot;</span>, $part);
<a name="l01521"></a>01521 
<a name="l01522"></a>01522             <span class="comment">// Fix DC-645, Table aliases ending with &#39;)&#39; where not replaced properly</span>
<a name="l01523"></a>01523             preg_match(<span class="stringliteral">&#39;/^(\(?)(.*?)(\)?)$/&#39;</span>, $part, $matches);
<a name="l01524"></a>01524             <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a31db2e131aedae0169cbbd351854d3ed" title="hasSqlTableAlias whether or not this object has given tableAlias">hasSqlTableAlias</a>($matches[2])) {
<a name="l01525"></a>01525                 $parts[$k] = $matches[1].$this-&gt;_conn-&gt;quoteIdentifier($this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#aefee677f7563161fc022ae6578ac100d" title="generateNewSqlTableAlias generates a new alias from given table alias">generateNewSqlTableAlias</a>($matches[2])).$matches[3];
<a name="l01526"></a>01526                 <span class="keywordflow">continue</span>;
<a name="l01527"></a>01527             }
<a name="l01528"></a>01528 
<a name="l01529"></a>01529             <span class="keywordflow">if</span> (strpos($part, <span class="charliteral">&#39;.&#39;</span>) === <span class="keyword">false</span>) {
<a name="l01530"></a>01530                 <span class="keywordflow">continue</span>;
<a name="l01531"></a>01531             }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533             preg_match_all(<span class="stringliteral">&quot;/[a-zA-Z0-9_]+\.[a-z0-9_]+/i&quot;</span>, $part, $m);
<a name="l01534"></a>01534 
<a name="l01535"></a>01535             <span class="keywordflow">foreach</span> ($m[0] as $match) {
<a name="l01536"></a>01536                 $e = explode(<span class="charliteral">&#39;.&#39;</span>, $match);
<a name="l01537"></a>01537 
<a name="l01538"></a>01538                 <span class="comment">// Rebuild the original part without the newly generate alias and with quoting reapplied</span>
<a name="l01539"></a>01539                 $e2 = array();
<a name="l01540"></a>01540                 <span class="keywordflow">foreach</span> ($e as $k2 =&gt; $v2) {
<a name="l01541"></a>01541                   $e2[$k2] = $this-&gt;_conn-&gt;quoteIdentifier($v2);
<a name="l01542"></a>01542                 }
<a name="l01543"></a>01543                 $match = implode(<span class="charliteral">&#39;.&#39;</span>, $e2);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545                 <span class="comment">// Generate new table alias</span>
<a name="l01546"></a>01546                 $e[0] = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#aefee677f7563161fc022ae6578ac100d" title="generateNewSqlTableAlias generates a new alias from given table alias">generateNewSqlTableAlias</a>($e[0]);
<a name="l01547"></a>01547 
<a name="l01548"></a>01548                 <span class="comment">// Requote the part with the newly generated alias</span>
<a name="l01549"></a>01549                 <span class="keywordflow">foreach</span> ($e as $k2 =&gt; $v2) {
<a name="l01550"></a>01550                   $e[$k2] = $this-&gt;_conn-&gt;quoteIdentifier($v2);
<a name="l01551"></a>01551                 }
<a name="l01552"></a>01552 
<a name="l01553"></a>01553                 $replace = implode(<span class="charliteral">&#39;.&#39;</span> , $e);
<a name="l01554"></a>01554 
<a name="l01555"></a>01555                 <span class="comment">// Replace the original part with the new part with new sql table alias</span>
<a name="l01556"></a>01556                 $parts[$k] = str_replace($match, $replace, $parts[$k]);
<a name="l01557"></a>01557             }
<a name="l01558"></a>01558         }
<a name="l01559"></a>01559 
<a name="l01560"></a>01560         <span class="keywordflow">if</span> ($driverName == <span class="stringliteral">&#39;mysql&#39;</span> || $driverName == <span class="stringliteral">&#39;pgsql&#39;</span>) {
<a name="l01561"></a>01561             <span class="keywordflow">foreach</span> ($parts as $k =&gt; $part) {
<a name="l01562"></a>01562                 <span class="keywordflow">if</span> (strpos($part, <span class="stringliteral">&quot;&#39;&quot;</span>) !== <span class="keyword">false</span>) {
<a name="l01563"></a>01563                     <span class="keywordflow">continue</span>;
<a name="l01564"></a>01564                 }
<a name="l01565"></a>01565                 <span class="keywordflow">if</span> (strpos($part, <span class="stringliteral">&#39;__&#39;</span>) == <span class="keyword">false</span>) {
<a name="l01566"></a>01566                     <span class="keywordflow">continue</span>;
<a name="l01567"></a>01567                 }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569                 preg_match_all(<span class="stringliteral">&quot;/[a-zA-Z0-9_]+\_\_[a-z0-9_]+/i&quot;</span>, $part, $m);
<a name="l01570"></a>01570 
<a name="l01571"></a>01571                 <span class="keywordflow">foreach</span> ($m[0] as $match) {
<a name="l01572"></a>01572                     $e = explode(<span class="stringliteral">&#39;__&#39;</span>, $match);
<a name="l01573"></a>01573                     $e[0] = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#aefee677f7563161fc022ae6578ac100d" title="generateNewSqlTableAlias generates a new alias from given table alias">generateNewSqlTableAlias</a>($e[0]);
<a name="l01574"></a>01574 
<a name="l01575"></a>01575                     $parts[$k] = str_replace($match, implode(<span class="stringliteral">&#39;__&#39;</span>, $e), $parts[$k]);
<a name="l01576"></a>01576                 }
<a name="l01577"></a>01577             }
<a name="l01578"></a>01578         }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580         $subquery = implode(<span class="charliteral">&#39; &#39;</span>, $parts);
<a name="l01581"></a>01581         <span class="keywordflow">return</span> $subquery;
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583 
<a name="l01591"></a>01591     <span class="keyword">private</span> function _isOrderedByJoinedColumn() {
<a name="l01592"></a>01592         <span class="keywordflow">if</span> ( ! $this-&gt;_queryComponents) {
<a name="l01593"></a>01593             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&quot;The query is in an invalid state for this &quot;</span>
<a name="l01594"></a>01594                     . <span class="stringliteral">&quot;operation. It must have been fully parsed first.&quot;</span>);
<a name="l01595"></a>01595         }
<a name="l01596"></a>01596         $componentAlias = key($this-&gt;_queryComponents);
<a name="l01597"></a>01597         $mainTableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias);
<a name="l01598"></a>01598         <span class="keywordflow">foreach</span> ($this-&gt;_sqlParts[<span class="stringliteral">&#39;orderby&#39;</span>] as $part) {
<a name="l01599"></a>01599             $part = trim($part);
<a name="l01600"></a>01600             $e = $this-&gt;_tokenizer-&gt;bracketExplode($part, <span class="charliteral">&#39; &#39;</span>);
<a name="l01601"></a>01601             $part = trim($e[0]);
<a name="l01602"></a>01602             <span class="keywordflow">if</span> (strpos($part, <span class="charliteral">&#39;.&#39;</span>) === <span class="keyword">false</span>) {
<a name="l01603"></a>01603                 <span class="keywordflow">continue</span>;
<a name="l01604"></a>01604             }
<a name="l01605"></a>01605             list($tableAlias, $columnName) = explode(<span class="charliteral">&#39;.&#39;</span>, $part);
<a name="l01606"></a>01606             <span class="keywordflow">if</span> ($tableAlias != $mainTableAlias) {
<a name="l01607"></a>01607                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01608"></a>01608             }
<a name="l01609"></a>01609         }
<a name="l01610"></a>01610         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 
<a name="l01624"></a><a class="code" href="classDoctrine__Query.html#a68476f918dc1f9fd7773ca8de93cd162">01624</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a68476f918dc1f9fd7773ca8de93cd162" title="DQL PARSER parses a DQL query first splits the query in parts and then uses individual...">parseDqlQuery</a>($query, $clear = <span class="keyword">true</span>)
<a name="l01625"></a>01625     {
<a name="l01626"></a>01626         <span class="keywordflow">if</span> ($clear) {
<a name="l01627"></a>01627             $this-&gt;<a class="code" href="classDoctrine__Query.html#a753f7480eae0f24bf76d33187df24af3" title="Clears all the sql parts.">clear</a>();
<a name="l01628"></a>01628         }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630         $query = trim($query);
<a name="l01631"></a>01631         $query = str_replace(<span class="stringliteral">&quot;\r&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, str_replace(<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $query));
<a name="l01632"></a>01632         $query = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="charliteral">&#39; &#39;</span>, $query);
<a name="l01633"></a>01633 
<a name="l01634"></a>01634         $parts = $this-&gt;_tokenizer-&gt;tokenizeQuery($query);
<a name="l01635"></a>01635 
<a name="l01636"></a>01636         <span class="keywordflow">foreach</span> ($parts as $partName =&gt; $subParts) {
<a name="l01637"></a>01637             $subParts = trim($subParts);
<a name="l01638"></a>01638             $partName = strtolower($partName);
<a name="l01639"></a>01639             <span class="keywordflow">switch</span> ($partName) {
<a name="l01640"></a>01640                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;create&#39;</span>:
<a name="l01641"></a>01641                     $this-&gt;_type = self::CREATE;
<a name="l01642"></a>01642                 <span class="keywordflow">break</span>;
<a name="l01643"></a>01643                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;insert&#39;</span>:
<a name="l01644"></a>01644                     $this-&gt;_type = self::INSERT;
<a name="l01645"></a>01645                 <span class="keywordflow">break</span>;
<a name="l01646"></a>01646                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;delete&#39;</span>:
<a name="l01647"></a>01647                     $this-&gt;_type = self::DELETE;
<a name="l01648"></a>01648                 <span class="keywordflow">break</span>;
<a name="l01649"></a>01649                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;select&#39;</span>:
<a name="l01650"></a>01650                     $this-&gt;_type = self::SELECT;
<a name="l01651"></a>01651                     $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ae3565d86e92f59a3ed473d04860ba7f6" title="Adds a DQL part to the internal parts collection.">_addDqlQueryPart</a>($partName, $subParts);
<a name="l01652"></a>01652                 <span class="keywordflow">break</span>;
<a name="l01653"></a>01653                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;update&#39;</span>:
<a name="l01654"></a>01654                     $this-&gt;_type = self::UPDATE;
<a name="l01655"></a>01655                     $partName = <span class="stringliteral">&#39;from&#39;</span>;
<a name="l01656"></a>01656                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;from&#39;</span>:
<a name="l01657"></a>01657                     $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ae3565d86e92f59a3ed473d04860ba7f6" title="Adds a DQL part to the internal parts collection.">_addDqlQueryPart</a>($partName, $subParts);
<a name="l01658"></a>01658                 <span class="keywordflow">break</span>;
<a name="l01659"></a>01659                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;set&#39;</span>:
<a name="l01660"></a>01660                     $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ae3565d86e92f59a3ed473d04860ba7f6" title="Adds a DQL part to the internal parts collection.">_addDqlQueryPart</a>($partName, $subParts, <span class="keyword">true</span>);
<a name="l01661"></a>01661                 <span class="keywordflow">break</span>;
<a name="l01662"></a>01662                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;group&#39;</span>:
<a name="l01663"></a>01663                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;order&#39;</span>:
<a name="l01664"></a>01664                     $partName .= <span class="stringliteral">&#39;by&#39;</span>;
<a name="l01665"></a>01665                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;where&#39;</span>:
<a name="l01666"></a>01666                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;having&#39;</span>:
<a name="l01667"></a>01667                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;limit&#39;</span>:
<a name="l01668"></a>01668                 <span class="keywordflow">case</span> <span class="stringliteral">&#39;offset&#39;</span>:
<a name="l01669"></a>01669                     $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ae3565d86e92f59a3ed473d04860ba7f6" title="Adds a DQL part to the internal parts collection.">_addDqlQueryPart</a>($partName, $subParts);
<a name="l01670"></a>01670                 <span class="keywordflow">break</span>;
<a name="l01671"></a>01671             }
<a name="l01672"></a>01672         }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674         <span class="keywordflow">return</span> $this;
<a name="l01675"></a>01675     }
<a name="l01676"></a>01676 
<a name="l01682"></a><a class="code" href="classDoctrine__Query.html#a4974d0734e2ac66c5699b40355a73559">01682</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a4974d0734e2ac66c5699b40355a73559">load</a>($path, $loadFields = <span class="keyword">true</span>)
<a name="l01683"></a>01683     {
<a name="l01684"></a>01684         <span class="keywordflow">if</span> (isset($this-&gt;_queryComponents[$path])) {
<a name="l01685"></a>01685             <span class="keywordflow">return</span> $this-&gt;_queryComponents[$path];
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688         $e = $this-&gt;_tokenizer-&gt;quoteExplode($path, <span class="stringliteral">&#39; INDEXBY &#39;</span>);
<a name="l01689"></a>01689 
<a name="l01690"></a>01690         $mapWith = null;
<a name="l01691"></a>01691         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($e) &gt; 1) {
<a name="l01692"></a>01692             $mapWith = trim($e[1]);
<a name="l01693"></a>01693 
<a name="l01694"></a>01694             $path = $e[0];
<a name="l01695"></a>01695         }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         <span class="comment">// parse custom join conditions</span>
<a name="l01698"></a>01698         $e = explode(<span class="stringliteral">&#39; ON &#39;</span>, str_ireplace(<span class="stringliteral">&#39; on &#39;</span>, <span class="stringliteral">&#39; ON &#39;</span>, $path));
<a name="l01699"></a>01699 
<a name="l01700"></a>01700         $joinCondition = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01701"></a>01701 
<a name="l01702"></a>01702         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($e) &gt; 1) {
<a name="l01703"></a>01703             $joinCondition = substr($path, strlen($e[0]) + 4, strlen($e[1]));
<a name="l01704"></a>01704             $path = substr($path, 0, strlen($e[0]));
<a name="l01705"></a>01705 
<a name="l01706"></a>01706             $overrideJoin = <span class="keyword">true</span>;
<a name="l01707"></a>01707         } <span class="keywordflow">else</span> {
<a name="l01708"></a>01708             $e = explode(<span class="stringliteral">&#39; WITH &#39;</span>, str_ireplace(<span class="stringliteral">&#39; with &#39;</span>, <span class="stringliteral">&#39; WITH &#39;</span>, $path));
<a name="l01709"></a>01709 
<a name="l01710"></a>01710             <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($e) &gt; 1) {
<a name="l01711"></a>01711                 $joinCondition = substr($path, strlen($e[0]) + 6, strlen($e[1]));
<a name="l01712"></a>01712                 $path = substr($path, 0, strlen($e[0]));
<a name="l01713"></a>01713             }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715             $overrideJoin = <span class="keyword">false</span>;
<a name="l01716"></a>01716         }
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         $tmp            = explode(<span class="charliteral">&#39; &#39;</span>, $path);
<a name="l01719"></a>01719         $componentAlias = $originalAlias = (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($tmp) &gt; 1) ? end($tmp) : null;
<a name="l01720"></a>01720 
<a name="l01721"></a>01721         $e = preg_split(<span class="stringliteral">&quot;/[.:]/&quot;</span>, $tmp[0], -1);
<a name="l01722"></a>01722 
<a name="l01723"></a>01723         $fullPath = $tmp[0];
<a name="l01724"></a>01724         $prevPath = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01725"></a>01725         $fullLength = strlen($fullPath);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727         <span class="keywordflow">if</span> (isset($this-&gt;_queryComponents[$e[0]])) {
<a name="l01728"></a>01728             $table = $this-&gt;_queryComponents[$e[0]][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l01729"></a>01729             $componentAlias = $e[0];
<a name="l01730"></a>01730 
<a name="l01731"></a>01731             $prevPath = $parent = array_shift($e);
<a name="l01732"></a>01732         }
<a name="l01733"></a>01733 
<a name="l01734"></a>01734         <span class="keywordflow">foreach</span> ($e as $key =&gt; $name) {
<a name="l01735"></a>01735             <span class="comment">// get length of the previous path</span>
<a name="l01736"></a>01736             $length = strlen($prevPath);
<a name="l01737"></a>01737 
<a name="l01738"></a>01738             <span class="comment">// build the current component path</span>
<a name="l01739"></a>01739             $prevPath = ($prevPath) ? $prevPath . <span class="charliteral">&#39;.&#39;</span> . $name : $name;
<a name="l01740"></a>01740 
<a name="l01741"></a>01741             $delimeter = substr($fullPath, $length, 1);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743             <span class="comment">// if an alias is not given use the current path as an alias identifier</span>
<a name="l01744"></a>01744             <span class="keywordflow">if</span> (strlen($prevPath) === $fullLength &amp;&amp; isset($originalAlias)) {
<a name="l01745"></a>01745                 $componentAlias = $originalAlias;
<a name="l01746"></a>01746             } <span class="keywordflow">else</span> {
<a name="l01747"></a>01747                 $componentAlias = $prevPath;
<a name="l01748"></a>01748             }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750             <span class="comment">// if the current alias already exists, skip it</span>
<a name="l01751"></a>01751             <span class="keywordflow">if</span> (isset($this-&gt;_queryComponents[$componentAlias])) {
<a name="l01752"></a>01752                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&quot;Duplicate alias &#39;$componentAlias&#39; in query.&quot;</span>);
<a name="l01753"></a>01753             }
<a name="l01754"></a>01754 
<a name="l01755"></a>01755             <span class="keywordflow">if</span> ( ! isset($table)) {
<a name="l01756"></a>01756                 <span class="comment">// process the root of the path</span>
<a name="l01757"></a>01757 
<a name="l01758"></a>01758                 $table = $this-&gt;<a class="code" href="classDoctrine__Query.html#afa17836f0a0afedcfc0329a9e09cba54" title="loadRoot">loadRoot</a>($name, $componentAlias);
<a name="l01759"></a>01759             } <span class="keywordflow">else</span> {
<a name="l01760"></a>01760                 $join = ($delimeter == <span class="charliteral">&#39;:&#39;</span>) ? <span class="stringliteral">&#39;INNER JOIN &#39;</span> : <span class="stringliteral">&#39;LEFT JOIN &#39;</span>;
<a name="l01761"></a>01761 
<a name="l01762"></a>01762                 $relation = $table-&gt;getRelation($name);
<a name="l01763"></a>01763                 $localTable = $table;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765                 $table = $relation-&gt;getTable();
<a name="l01766"></a>01766                 $this-&gt;_queryComponents[$componentAlias] = array(<span class="stringliteral">&#39;table&#39;</span> =&gt; $table,
<a name="l01767"></a>01767                                                                  <span class="stringliteral">&#39;parent&#39;</span>   =&gt; $parent,
<a name="l01768"></a>01768                                                                  <span class="stringliteral">&#39;relation&#39;</span> =&gt; $relation,
<a name="l01769"></a>01769                                                                  <span class="stringliteral">&#39;map&#39;</span>      =&gt; null);
<a name="l01770"></a>01770                 <span class="comment">// Fix for http://www.doctrine-project.org/jira/browse/DC-701</span>
<a name="l01771"></a>01771                 <span class="keywordflow">if</span> ( ! $relation-&gt;isOneToOne() &amp;&amp; ! $this-&gt;disableLimitSubquery) {
<a name="l01772"></a>01772                     $this-&gt;_needsSubquery = <span class="keyword">true</span>;
<a name="l01773"></a>01773                 }
<a name="l01774"></a>01774 
<a name="l01775"></a>01775                 $localAlias   = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($parent, $localTable-&gt;getTableName());
<a name="l01776"></a>01776                 $foreignAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias, $relation-&gt;getTable()-&gt;getTableName());
<a name="l01777"></a>01777 
<a name="l01778"></a>01778                 $foreignSql   = $this-&gt;_conn-&gt;quoteIdentifier($relation-&gt;getTable()-&gt;getTableName())
<a name="l01779"></a>01779                               . <span class="charliteral">&#39; &#39;</span>
<a name="l01780"></a>01780                               . $this-&gt;_conn-&gt;quoteIdentifier($foreignAlias);
<a name="l01781"></a>01781 
<a name="l01782"></a>01782                 $map = $relation-&gt;getTable()-&gt;inheritanceMap;
<a name="l01783"></a>01783 
<a name="l01784"></a>01784                 <span class="keywordflow">if</span> ( ! $loadFields || ! empty($map) || $joinCondition) {
<a name="l01785"></a>01785                     $this-&gt;_subqueryAliases[] = $foreignAlias;
<a name="l01786"></a>01786                 }
<a name="l01787"></a>01787 
<a name="l01788"></a>01788                 <span class="keywordflow">if</span> ($relation instanceof <a class="code" href="classDoctrine__Relation__Association.html">Doctrine_Relation_Association</a>) {
<a name="l01789"></a>01789                     $asf = $relation-&gt;getAssociationTable();
<a name="l01790"></a>01790 
<a name="l01791"></a>01791                     $assocTableName = $asf-&gt;getTableName();
<a name="l01792"></a>01792 
<a name="l01793"></a>01793                     <span class="keywordflow">if</span> ( ! $loadFields || ! empty($map) || $joinCondition) {
<a name="l01794"></a>01794                         $this-&gt;_subqueryAliases[] = $assocTableName;
<a name="l01795"></a>01795                     }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797                     $assocPath = $prevPath . <span class="charliteral">&#39;.&#39;</span> . $asf-&gt;getComponentName() . <span class="charliteral">&#39; &#39;</span> . $componentAlias;
<a name="l01798"></a>01798 
<a name="l01799"></a>01799                     $this-&gt;_queryComponents[$assocPath] = array(
<a name="l01800"></a>01800                         <span class="stringliteral">&#39;parent&#39;</span> =&gt; $prevPath,
<a name="l01801"></a>01801                         <span class="stringliteral">&#39;relation&#39;</span> =&gt; $relation,
<a name="l01802"></a>01802                         <span class="stringliteral">&#39;table&#39;</span> =&gt; $asf,
<a name="l01803"></a>01803                         <span class="stringliteral">&#39;ref&#39;</span> =&gt; <span class="keyword">true</span>);
<a name="l01804"></a>01804 
<a name="l01805"></a>01805                     $assocAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($assocPath, $asf-&gt;getTableName());
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                     $queryPart = $join
<a name="l01808"></a>01808                             . $this-&gt;_conn-&gt;quoteIdentifier($assocTableName)
<a name="l01809"></a>01809                             . <span class="charliteral">&#39; &#39;</span>
<a name="l01810"></a>01810                             . $this-&gt;_conn-&gt;quoteIdentifier($assocAlias);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812                     $queryPart .= <span class="stringliteral">&#39; ON (&#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($localAlias
<a name="l01813"></a>01813                                 . <span class="charliteral">&#39;.&#39;</span>
<a name="l01814"></a>01814                                 . $localTable-&gt;getColumnName($localTable-&gt;getIdentifier())) <span class="comment">// what about composite keys?</span>
<a name="l01815"></a>01815                                 . <span class="stringliteral">&#39; = &#39;</span>
<a name="l01816"></a>01816                                 . $this-&gt;_conn-&gt;quoteIdentifier($assocAlias . <span class="charliteral">&#39;.&#39;</span> . $relation-&gt;getLocalRefColumnName());
<a name="l01817"></a>01817 
<a name="l01818"></a>01818                     <span class="keywordflow">if</span> ($relation-&gt;isEqual()) {
<a name="l01819"></a>01819                         <span class="comment">// equal nest relation needs additional condition</span>
<a name="l01820"></a>01820                         $queryPart .= <span class="stringliteral">&#39; OR &#39;</span>
<a name="l01821"></a>01821                                     . $this-&gt;_conn-&gt;quoteIdentifier($localAlias
<a name="l01822"></a>01822                                     . <span class="charliteral">&#39;.&#39;</span>
<a name="l01823"></a>01823                                     . $table-&gt;getColumnName($table-&gt;getIdentifier()))
<a name="l01824"></a>01824                                     . <span class="stringliteral">&#39; = &#39;</span>
<a name="l01825"></a>01825                                     . $this-&gt;_conn-&gt;quoteIdentifier($assocAlias . <span class="charliteral">&#39;.&#39;</span> . $relation-&gt;getForeignRefColumnName());
<a name="l01826"></a>01826                     }
<a name="l01827"></a>01827 
<a name="l01828"></a>01828                     $queryPart .= <span class="charliteral">&#39;)&#39;</span>;
<a name="l01829"></a>01829 
<a name="l01830"></a>01830                     $this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>][] = $queryPart;
<a name="l01831"></a>01831 
<a name="l01832"></a>01832                     $queryPart = $join . $foreignSql;
<a name="l01833"></a>01833 
<a name="l01834"></a>01834                     <span class="keywordflow">if</span> ( ! $overrideJoin) {
<a name="l01835"></a>01835                         $queryPart .= $this-&gt;buildAssociativeRelationSql($relation, $assocAlias, $foreignAlias, $localAlias);
<a name="l01836"></a>01836                     }
<a name="l01837"></a>01837                 } <span class="keywordflow">else</span> {
<a name="l01838"></a>01838                     $queryPart = $this-&gt;buildSimpleRelationSql($relation, $foreignAlias, $localAlias, $overrideJoin, $join);
<a name="l01839"></a>01839                 }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841                 $queryPart .= $this-&gt;<a class="code" href="classDoctrine__Query.html#a9b0744390943d6f0310c593cb93730c2">buildInheritanceJoinSql</a>($table-&gt;getComponentName(), $componentAlias);
<a name="l01842"></a>01842                 $this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>][$componentAlias] = $queryPart;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844                 <span class="keywordflow">if</span> ( ! empty($joinCondition)) {
<a name="l01845"></a>01845                     $this-&gt;<a class="code" href="classDoctrine__Query.html#a1921bef04c6606489283bb9d8fd992c6" title="addPendingJoinCondition">addPendingJoinCondition</a>($componentAlias, $joinCondition);
<a name="l01846"></a>01846                 }
<a name="l01847"></a>01847             }
<a name="l01848"></a>01848 
<a name="l01849"></a>01849             <span class="keywordflow">if</span> ($loadFields) {
<a name="l01850"></a>01850                 $restoreState = <span class="keyword">false</span>;
<a name="l01851"></a>01851 
<a name="l01852"></a>01852                 <span class="comment">// load fields if necessary</span>
<a name="l01853"></a>01853                 <span class="keywordflow">if</span> ($loadFields &amp;&amp; empty($this-&gt;_dqlParts[<span class="stringliteral">&#39;select&#39;</span>])) {
<a name="l01854"></a>01854                     $this-&gt;_pendingFields[$componentAlias] = array(<span class="charliteral">&#39;*&#39;</span>);
<a name="l01855"></a>01855                 }
<a name="l01856"></a>01856             }
<a name="l01857"></a>01857 
<a name="l01858"></a>01858             $parent = $prevPath;
<a name="l01859"></a>01859         }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861         $table = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l01862"></a>01862 
<a name="l01863"></a>01863         <span class="keywordflow">return</span> $this-&gt;buildIndexBy($componentAlias, $mapWith);
<a name="l01864"></a>01864     }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866     <span class="keyword">protected</span> function buildSimpleRelationSql(<a class="code" href="classDoctrine__Relation.html">Doctrine_Relation</a> $relation, $foreignAlias, $localAlias, $overrideJoin, $join)
<a name="l01867"></a>01867     {
<a name="l01868"></a>01868         $queryPart = $join . $this-&gt;_conn-&gt;quoteIdentifier($relation-&gt;<a class="code" href="classDoctrine__Relation.html#ac11fe0622565011f6a8f54eefbd3bc48" title="getTable returns the foreign table object">getTable</a>()-&gt;getTableName())
<a name="l01869"></a>01869                            . <span class="charliteral">&#39; &#39;</span>
<a name="l01870"></a>01870                            . $this-&gt;_conn-&gt;quoteIdentifier($foreignAlias);
<a name="l01871"></a>01871 
<a name="l01872"></a>01872         <span class="keywordflow">if</span> ( ! $overrideJoin) {
<a name="l01873"></a>01873             $queryPart .= <span class="stringliteral">&#39; ON &#39;</span>
<a name="l01874"></a>01874                        . $this-&gt;_conn-&gt;quoteIdentifier($localAlias . <span class="charliteral">&#39;.&#39;</span> . $relation-&gt;<a class="code" href="classDoctrine__Relation.html#ab55457896cf8db2378710b140c52f4d6" title="getLocalColumnName returns the column name of the local column">getLocalColumnName</a>())
<a name="l01875"></a>01875                        . <span class="stringliteral">&#39; = &#39;</span>
<a name="l01876"></a>01876                        . $this-&gt;_conn-&gt;quoteIdentifier($foreignAlias . <span class="charliteral">&#39;.&#39;</span> . $relation-&gt;<a class="code" href="classDoctrine__Relation.html#aad381e2eb27f8c8f2763bb0d41363be5" title="getForeignColumnName returns the column name of the foreign column">getForeignColumnName</a>());
<a name="l01877"></a>01877         }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879         <span class="keywordflow">return</span> $queryPart;
<a name="l01880"></a>01880     }
<a name="l01881"></a>01881 
<a name="l01882"></a>01882     <span class="keyword">protected</span> function buildIndexBy($componentAlias, $mapWith = null)
<a name="l01883"></a>01883     {
<a name="l01884"></a>01884         $table = $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;table&#39;</span>];
<a name="l01885"></a>01885 
<a name="l01886"></a>01886         $indexBy = null;
<a name="l01887"></a>01887         $column = <span class="keyword">false</span>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889         <span class="keywordflow">if</span> (isset($mapWith)) {
<a name="l01890"></a>01890             $terms = explode(<span class="charliteral">&#39;.&#39;</span>, $mapWith);
<a name="l01891"></a>01891 
<a name="l01892"></a>01892             <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($terms) == 1) {
<a name="l01893"></a>01893                 $indexBy = $terms[0];
<a name="l01894"></a>01894             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($terms) == 2) {
<a name="l01895"></a>01895                 $column = <span class="keyword">true</span>;
<a name="l01896"></a>01896                 $indexBy = $terms[1];
<a name="l01897"></a>01897             }
<a name="l01898"></a>01898         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($table-&gt;getBoundQueryPart(<span class="stringliteral">&#39;indexBy&#39;</span>) !== null) {
<a name="l01899"></a>01899             $indexBy = $table-&gt;getBoundQueryPart(<span class="stringliteral">&#39;indexBy&#39;</span>);
<a name="l01900"></a>01900         }
<a name="l01901"></a>01901 
<a name="l01902"></a>01902         <span class="keywordflow">if</span> ($indexBy !== null) {
<a name="l01903"></a>01903             <span class="keywordflow">if</span> ( $column &amp;&amp; ! $table-&gt;hasColumn($table-&gt;getColumnName($indexBy))) {
<a name="l01904"></a>01904                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classDoctrine__Query__Exception.html">Doctrine_Query_Exception</a>(<span class="stringliteral">&quot;Couldn&#39;t use key mapping. Column &quot;</span> . $indexBy . <span class="stringliteral">&quot; does not exist.&quot;</span>);
<a name="l01905"></a>01905             }
<a name="l01906"></a>01906 
<a name="l01907"></a>01907             $this-&gt;_queryComponents[$componentAlias][<span class="stringliteral">&#39;map&#39;</span>] = $indexBy;
<a name="l01908"></a>01908         }
<a name="l01909"></a>01909 
<a name="l01910"></a>01910         <span class="keywordflow">return</span> $this-&gt;_queryComponents[$componentAlias];
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913 
<a name="l01914"></a>01914     <span class="keyword">protected</span> function buildAssociativeRelationSql(<a class="code" href="classDoctrine__Relation.html">Doctrine_Relation</a> $relation, $assocAlias, $foreignAlias, $localAlias)
<a name="l01915"></a>01915     {
<a name="l01916"></a>01916         $table = $relation-&gt;<a class="code" href="classDoctrine__Relation.html#ac11fe0622565011f6a8f54eefbd3bc48" title="getTable returns the foreign table object">getTable</a>();
<a name="l01917"></a>01917 
<a name="l01918"></a>01918         $queryPart = <span class="stringliteral">&#39; ON &#39;</span>;
<a name="l01919"></a>01919 
<a name="l01920"></a>01920         <span class="keywordflow">if</span> ($relation-&gt;isEqual()) {
<a name="l01921"></a>01921             $queryPart .= <span class="charliteral">&#39;(&#39;</span>;
<a name="l01922"></a>01922         }
<a name="l01923"></a>01923 
<a name="l01924"></a>01924         $localIdentifier = $table-&gt;getColumnName($table-&gt;getIdentifier());
<a name="l01925"></a>01925 
<a name="l01926"></a>01926         $queryPart .= $this-&gt;_conn-&gt;quoteIdentifier($foreignAlias . <span class="charliteral">&#39;.&#39;</span> . $localIdentifier)
<a name="l01927"></a>01927                     . <span class="stringliteral">&#39; = &#39;</span>
<a name="l01928"></a>01928                     . $this-&gt;_conn-&gt;quoteIdentifier($assocAlias . <span class="charliteral">&#39;.&#39;</span> . $relation-&gt;getForeignRefColumnName());
<a name="l01929"></a>01929 
<a name="l01930"></a>01930         <span class="keywordflow">if</span> ($relation-&gt;isEqual()) {
<a name="l01931"></a>01931             $queryPart .= <span class="stringliteral">&#39; OR &#39;</span>
<a name="l01932"></a>01932                         . $this-&gt;_conn-&gt;quoteIdentifier($foreignAlias . <span class="charliteral">&#39;.&#39;</span> . $localIdentifier)
<a name="l01933"></a>01933                         . <span class="stringliteral">&#39; = &#39;</span>
<a name="l01934"></a>01934                         . $this-&gt;_conn-&gt;quoteIdentifier($assocAlias . <span class="charliteral">&#39;.&#39;</span> . $relation-&gt;getLocalRefColumnName())
<a name="l01935"></a>01935                         . <span class="stringliteral">&#39;) AND &#39;</span>
<a name="l01936"></a>01936                         . $this-&gt;_conn-&gt;quoteIdentifier($foreignAlias . <span class="charliteral">&#39;.&#39;</span> . $localIdentifier)
<a name="l01937"></a>01937                         . <span class="stringliteral">&#39; != &#39;</span>
<a name="l01938"></a>01938                         . $this-&gt;_conn-&gt;quoteIdentifier($localAlias . <span class="charliteral">&#39;.&#39;</span> . $localIdentifier);
<a name="l01939"></a>01939         }
<a name="l01940"></a>01940 
<a name="l01941"></a>01941         <span class="keywordflow">return</span> $queryPart;
<a name="l01942"></a>01942     }
<a name="l01943"></a>01943 
<a name="l01953"></a><a class="code" href="classDoctrine__Query.html#afa17836f0a0afedcfc0329a9e09cba54">01953</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#afa17836f0a0afedcfc0329a9e09cba54" title="loadRoot">loadRoot</a>($name, $componentAlias)
<a name="l01954"></a>01954     {
<a name="l01955"></a>01955         <span class="comment">// get the connection for the component</span>
<a name="l01956"></a>01956         $manager = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l01957"></a>01957         <span class="keywordflow">if</span> ( ! $this-&gt;_passedConn &amp;&amp; $manager-&gt;hasConnectionForComponent($name)) {
<a name="l01958"></a>01958             $this-&gt;_conn = $manager-&gt;getConnectionForComponent($name);
<a name="l01959"></a>01959         }
<a name="l01960"></a>01960 
<a name="l01961"></a>01961         $table = $this-&gt;_conn-&gt;getTable($name);
<a name="l01962"></a>01962         $tableName = $table-&gt;getTableName();
<a name="l01963"></a>01963 
<a name="l01964"></a>01964         <span class="comment">// get the short alias for this table</span>
<a name="l01965"></a>01965         $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias, $tableName);
<a name="l01966"></a>01966         <span class="comment">// quote table name</span>
<a name="l01967"></a>01967         $queryPart = $this-&gt;_conn-&gt;quoteIdentifier($tableName);
<a name="l01968"></a>01968 
<a name="l01969"></a>01969         <span class="keywordflow">if</span> ($this-&gt;_type === self::SELECT) {
<a name="l01970"></a>01970             $queryPart .= <span class="charliteral">&#39; &#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($tableAlias);
<a name="l01971"></a>01971         }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973         $this-&gt;_tableAliasMap[$tableAlias] = $componentAlias;
<a name="l01974"></a>01974 
<a name="l01975"></a>01975         $queryPart .= $this-&gt;<a class="code" href="classDoctrine__Query.html#a9b0744390943d6f0310c593cb93730c2">buildInheritanceJoinSql</a>($name, $componentAlias);
<a name="l01976"></a>01976 
<a name="l01977"></a>01977         $this-&gt;_sqlParts[<span class="stringliteral">&#39;from&#39;</span>][] = $queryPart;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979         $this-&gt;_queryComponents[$componentAlias] = array(<span class="stringliteral">&#39;table&#39;</span> =&gt; $table, <span class="stringliteral">&#39;map&#39;</span> =&gt; null);
<a name="l01980"></a>01980 
<a name="l01981"></a>01981         <span class="keywordflow">return</span> $table;
<a name="l01982"></a>01982     }
<a name="l01983"></a>01983 
<a name="l01990"></a><a class="code" href="classDoctrine__Query.html#a9b0744390943d6f0310c593cb93730c2">01990</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a9b0744390943d6f0310c593cb93730c2">buildInheritanceJoinSql</a>($name, $componentAlias)
<a name="l01991"></a>01991     {
<a name="l01992"></a>01992         <span class="comment">// get the connection for the component</span>
<a name="l01993"></a>01993         $manager = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l01994"></a>01994         <span class="keywordflow">if</span> ( ! $this-&gt;_passedConn &amp;&amp; $manager-&gt;hasConnectionForComponent($name)) {
<a name="l01995"></a>01995             $this-&gt;_conn = $manager-&gt;getConnectionForComponent($name);
<a name="l01996"></a>01996         }
<a name="l01997"></a>01997 
<a name="l01998"></a>01998         $table = $this-&gt;_conn-&gt;getTable($name);
<a name="l01999"></a>01999         $tableName = $table-&gt;getTableName();
<a name="l02000"></a>02000 
<a name="l02001"></a>02001         <span class="comment">// get the short alias for this table</span>
<a name="l02002"></a>02002         $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($componentAlias, $tableName);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004         $queryPart = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02005"></a>02005 
<a name="l02006"></a>02006         <span class="keywordflow">foreach</span> ($table-&gt;getOption(<span class="stringliteral">&#39;joinedParents&#39;</span>) as $parent) {
<a name="l02007"></a>02007             $parentTable = $this-&gt;_conn-&gt;getTable($parent);
<a name="l02008"></a>02008 
<a name="l02009"></a>02009             $parentAlias = $componentAlias . <span class="charliteral">&#39;.&#39;</span> . $parent;
<a name="l02010"></a>02010 
<a name="l02011"></a>02011             <span class="comment">// get the short alias for the parent table</span>
<a name="l02012"></a>02012             $parentTableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($parentAlias, $parentTable-&gt;getTableName());
<a name="l02013"></a>02013 
<a name="l02014"></a>02014             $queryPart .= <span class="stringliteral">&#39; LEFT JOIN &#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($parentTable-&gt;getTableName())
<a name="l02015"></a>02015                         . <span class="charliteral">&#39; &#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($parentTableAlias) . <span class="stringliteral">&#39; ON &#39;</span>;
<a name="l02016"></a>02016 
<a name="l02017"></a>02017             <span class="comment">//Doctrine_Core::dump($table-&gt;getIdentifier());</span>
<a name="l02018"></a>02018             <span class="keywordflow">foreach</span> ((array) $table-&gt;getIdentifier() as $identifier) {
<a name="l02019"></a>02019                 $column = $table-&gt;getColumnName($identifier);
<a name="l02020"></a>02020 
<a name="l02021"></a>02021                 $queryPart .= $this-&gt;_conn-&gt;quoteIdentifier($tableAlias)
<a name="l02022"></a>02022                             . <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($column)
<a name="l02023"></a>02023                             . <span class="stringliteral">&#39; = &#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($parentTableAlias)
<a name="l02024"></a>02024                             . <span class="charliteral">&#39;.&#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier($column);
<a name="l02025"></a>02025             }
<a name="l02026"></a>02026         }
<a name="l02027"></a>02027 
<a name="l02028"></a>02028         <span class="keywordflow">return</span> $queryPart;
<a name="l02029"></a>02029     }
<a name="l02030"></a>02030 
<a name="l02039"></a><a class="code" href="classDoctrine__Query.html#a59dae003fbaefcad26621e188dbfe78f">02039</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a59dae003fbaefcad26621e188dbfe78f" title="Get count sql query for this Doctrine_Query instance.">getCountSqlQuery</a>()
<a name="l02040"></a>02040     {
<a name="l02041"></a>02041         <span class="comment">// triggers dql parsing/processing</span>
<a name="l02042"></a>02042         $this-&gt;<a class="code" href="classDoctrine__Query.html#a0314dc8431c1dc2b24e01cab3260cc1b" title="builds the sql query from the given parameters and applies things such as column...">getSqlQuery</a>(array(), <span class="keyword">false</span>); <span class="comment">// this is ugly</span>
<a name="l02043"></a>02043 
<a name="l02044"></a>02044         <span class="comment">// initialize temporary variables</span>
<a name="l02045"></a>02045         $where   = $this-&gt;_sqlParts[<span class="stringliteral">&#39;where&#39;</span>];
<a name="l02046"></a>02046         $having  = $this-&gt;_sqlParts[<span class="stringliteral">&#39;having&#39;</span>];
<a name="l02047"></a>02047         $groupby = $this-&gt;_sqlParts[<span class="stringliteral">&#39;groupby&#39;</span>];
<a name="l02048"></a>02048 
<a name="l02049"></a>02049         $rootAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a1d38cc19315d608f118852e835879dee" title="getRootAlias returns the alias of the root component">getRootAlias</a>();
<a name="l02050"></a>02050         $tableAlias = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ac4a458f62a7d9366059d8c6818dfaae8" title="getSqlTableAlias some database such as Oracle need the identifier lengths to be &amp;lt;...">getSqlTableAlias</a>($rootAlias);
<a name="l02051"></a>02051 
<a name="l02052"></a>02052         <span class="comment">// Build the query base</span>
<a name="l02053"></a>02053         $q = <span class="stringliteral">&#39;SELECT COUNT(*) AS &#39;</span> . $this-&gt;_conn-&gt;quoteIdentifier(<span class="stringliteral">&#39;num_results&#39;</span>) . <span class="stringliteral">&#39; FROM &#39;</span>;
<a name="l02054"></a>02054 
<a name="l02055"></a>02055         <span class="comment">// Build the from clause</span>
<a name="l02056"></a>02056         $from = $this-&gt;<a class="code" href="classDoctrine__Query.html#aca9f8c2087df83b67746e8cc75f080fe" title="_buildSqlFromPart builds the from part of the query and returns it">_buildSqlFromPart</a>(<span class="keyword">true</span>);
<a name="l02057"></a>02057 
<a name="l02058"></a>02058         <span class="comment">// Build the where clause</span>
<a name="l02059"></a>02059         $where = ( ! empty($where)) ? <span class="stringliteral">&#39; WHERE &#39;</span> . implode(<span class="charliteral">&#39; &#39;</span>, $where) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061         <span class="comment">// Build the group by clause</span>
<a name="l02062"></a>02062         $groupby = ( ! empty($groupby)) ? <span class="stringliteral">&#39; GROUP BY &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, $groupby) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02063"></a>02063 
<a name="l02064"></a>02064         <span class="comment">// Build the having clause</span>
<a name="l02065"></a>02065         $having = ( ! empty($having)) ? <span class="stringliteral">&#39; HAVING &#39;</span> . implode(<span class="stringliteral">&#39; AND &#39;</span>, $having) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02066"></a>02066 
<a name="l02067"></a>02067         <span class="comment">// Building the from clause and finishing query</span>
<a name="l02068"></a>02068         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($this-&gt;_queryComponents) == 1 &amp;&amp; empty($having)) {
<a name="l02069"></a>02069             $q .= $from . $where . $groupby . $having;
<a name="l02070"></a>02070         } <span class="keywordflow">else</span> {
<a name="l02071"></a>02071             <span class="comment">// Subselect fields will contain only the pk of root entity</span>
<a name="l02072"></a>02072             $ta = $this-&gt;_conn-&gt;quoteIdentifier($tableAlias);
<a name="l02073"></a>02073 
<a name="l02074"></a>02074             $map = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a82bcfeafae635387057c74deac108ca1" title="getRootDeclaration returns the root declaration">getRootDeclaration</a>();
<a name="l02075"></a>02075             $idColumnNames = $map[<span class="stringliteral">&#39;table&#39;</span>]-&gt;getIdentifierColumnNames();
<a name="l02076"></a>02076 
<a name="l02077"></a>02077             $pkFields = $ta . <span class="charliteral">&#39;.&#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span> . $ta . <span class="charliteral">&#39;.&#39;</span>, $this-&gt;_conn-&gt;quoteMultipleIdentifier($idColumnNames));
<a name="l02078"></a>02078 
<a name="l02079"></a>02079             <span class="comment">// We need to do some magic in select fields if the query contain anything in having clause</span>
<a name="l02080"></a>02080             $selectFields = $pkFields;
<a name="l02081"></a>02081 
<a name="l02082"></a>02082             <span class="keywordflow">if</span> ( ! empty($having)) {
<a name="l02083"></a>02083                 <span class="comment">// For each field defined in select clause</span>
<a name="l02084"></a>02084                 <span class="keywordflow">foreach</span> ($this-&gt;_sqlParts[<span class="stringliteral">&#39;select&#39;</span>] as $field) {
<a name="l02085"></a>02085                     <span class="comment">// We only include aggregate expressions to count query</span>
<a name="l02086"></a>02086                     <span class="comment">// This is needed because HAVING clause will use field aliases</span>
<a name="l02087"></a>02087                     <span class="keywordflow">if</span> (strpos($field, <span class="charliteral">&#39;(&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l02088"></a>02088                         $selectFields .= <span class="stringliteral">&#39;, &#39;</span> . $field;
<a name="l02089"></a>02089                     }
<a name="l02090"></a>02090                 }
<a name="l02091"></a>02091                 <span class="comment">// Add having fields that got stripped out of select</span>
<a name="l02092"></a>02092                 preg_match_all(<span class="stringliteral">&#39;/`[a-z0-9_]+`\.`[a-z0-9_]+`/i&#39;</span>, $having, $matches, PREG_PATTERN_ORDER);
<a name="l02093"></a>02093                 <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($matches[0]) &gt; 0) {
<a name="l02094"></a>02094                     $selectFields .= <span class="stringliteral">&#39;, &#39;</span> . implode(<span class="stringliteral">&#39;, &#39;</span>, array_unique($matches[0]));
<a name="l02095"></a>02095                 }
<a name="l02096"></a>02096             }
<a name="l02097"></a>02097 
<a name="l02098"></a>02098             <span class="comment">// If we do not have a custom group by, apply the default one</span>
<a name="l02099"></a>02099             <span class="keywordflow">if</span> (empty($groupby)) {
<a name="l02100"></a>02100                 $groupby = <span class="stringliteral">&#39; GROUP BY &#39;</span> . $pkFields;
<a name="l02101"></a>02101             }
<a name="l02102"></a>02102 
<a name="l02103"></a>02103             $q .= <span class="stringliteral">&#39;(SELECT &#39;</span> . $selectFields . <span class="stringliteral">&#39; FROM &#39;</span> . $from . $where . $groupby . $having . <span class="stringliteral">&#39;) &#39;</span>
<a name="l02104"></a>02104                 . $this-&gt;_conn-&gt;quoteIdentifier(<span class="stringliteral">&#39;dctrn_count_query&#39;</span>);
<a name="l02105"></a>02105         }
<a name="l02106"></a>02106 
<a name="l02107"></a>02107         <span class="keywordflow">return</span> $q;
<a name="l02108"></a>02108     }
<a name="l02109"></a>02109 
<a name="l02130"></a><a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6">02130</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($params = array())
<a name="l02131"></a>02131     {
<a name="l02132"></a>02132         $q = $this-&gt;<a class="code" href="classDoctrine__Query.html#a59dae003fbaefcad26621e188dbfe78f" title="Get count sql query for this Doctrine_Query instance.">getCountSqlQuery</a>();
<a name="l02133"></a>02133         $params = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a27e462833789ddd102dd878ddbd26be3" title="getCountQueryParams Retrieves the parameters for count query">getCountQueryParams</a>($params);
<a name="l02134"></a>02134         $params = $this-&gt;_conn-&gt;convertBooleans($params);
<a name="l02135"></a>02135 
<a name="l02136"></a>02136         <span class="keywordflow">if</span> ($this-&gt;_resultCache) {
<a name="l02137"></a>02137             $conn = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ab08c6b21e634cdbca5f45f7e81a99231" title="getConnection">getConnection</a>();
<a name="l02138"></a>02138             $cacheDriver = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#af6b80376c526255744b0da891bf9a0b8" title="getResultCacheDriver returns the cache driver used for caching result sets">getResultCacheDriver</a>();
<a name="l02139"></a>02139             $hash = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a7bce266181f43183b4eb3a99f3cfde3b" title="Get the result cache hash/key.">getResultCacheHash</a>($params).<span class="stringliteral">&#39;_count&#39;</span>;
<a name="l02140"></a>02140             $cached = ($this-&gt;_expireResultCache) ? <span class="keyword">false</span> : $cacheDriver-&gt;fetch($hash);
<a name="l02141"></a>02141 
<a name="l02142"></a>02142             <span class="keywordflow">if</span> ($cached === <span class="keyword">false</span>) {
<a name="l02143"></a>02143                 <span class="comment">// cache miss</span>
<a name="l02144"></a>02144                 $results = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ab08c6b21e634cdbca5f45f7e81a99231" title="getConnection">getConnection</a>()-&gt;fetchAll($q, $params);
<a name="l02145"></a>02145                 $cacheDriver-&gt;save($hash, serialize($results), $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a40a132109b30fe2196e3e077945d6016" title="Gets the life span of the result cache in seconds.">getResultCacheLifeSpan</a>());
<a name="l02146"></a>02146             } <span class="keywordflow">else</span> {
<a name="l02147"></a>02147                 $results = unserialize($cached);
<a name="l02148"></a>02148             }
<a name="l02149"></a>02149         } <span class="keywordflow">else</span> {
<a name="l02150"></a>02150             $results = $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#ab08c6b21e634cdbca5f45f7e81a99231" title="getConnection">getConnection</a>()-&gt;fetchAll($q, $params);
<a name="l02151"></a>02151         }
<a name="l02152"></a>02152 
<a name="l02153"></a>02153         <span class="keywordflow">if</span> (<a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($results) &gt; 1) {
<a name="l02154"></a>02154             $count = <a class="code" href="classDoctrine__Query.html#a9ac5995b61c0ffbdf4778317bb6f42a6" title="Fetches the count of the query.">count</a>($results);
<a name="l02155"></a>02155         } <span class="keywordflow">else</span> {
<a name="l02156"></a>02156             <span class="keywordflow">if</span> (isset($results[0])) {
<a name="l02157"></a>02157                 $results[0] = array_change_key_case($results[0], CASE_LOWER);
<a name="l02158"></a>02158                 $count = $results[0][<span class="stringliteral">&#39;num_results&#39;</span>];
<a name="l02159"></a>02159             } <span class="keywordflow">else</span> {
<a name="l02160"></a>02160                 $count = 0;
<a name="l02161"></a>02161             }
<a name="l02162"></a>02162         }
<a name="l02163"></a>02163 
<a name="l02164"></a>02164         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) $count;
<a name="l02165"></a>02165     }
<a name="l02166"></a>02166 
<a name="l02178"></a><a class="code" href="classDoctrine__Query.html#aba9788acb3d980493ce56df793828d28">02178</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#aba9788acb3d980493ce56df793828d28" title="Queries the database with DQL (Doctrine Query Language).">query</a>($query, $params = array(), $hydrationMode = null)
<a name="l02179"></a>02179     {
<a name="l02180"></a>02180         $this-&gt;<a class="code" href="classDoctrine__Query.html#a68476f918dc1f9fd7773ca8de93cd162" title="DQL PARSER parses a DQL query first splits the query in parts and then uses individual...">parseDqlQuery</a>($query);
<a name="l02181"></a>02181         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classDoctrine__Query__Abstract.html#a17243067d561323fe00413bbadb6e71c" title="execute executes the query and populates the data set">execute</a>($params, $hydrationMode);
<a name="l02182"></a>02182     }
<a name="l02183"></a>02183 
<a name="l02189"></a><a class="code" href="classDoctrine__Query.html#abc79f2b9896c4a2ab1a98eeba14660d7">02189</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#abc79f2b9896c4a2ab1a98eeba14660d7" title="Copies a Doctrine_Query object.">copy</a>(<a class="code" href="classDoctrine__Query.html">Doctrine_Query</a> $query = null)
<a name="l02190"></a>02190     {
<a name="l02191"></a>02191         <span class="keywordflow">if</span> ( ! $query) {
<a name="l02192"></a>02192             $query = $this;
<a name="l02193"></a>02193         }
<a name="l02194"></a>02194 
<a name="l02195"></a>02195         $new = clone $query;
<a name="l02196"></a>02196 
<a name="l02197"></a>02197         <span class="keywordflow">return</span> $new;
<a name="l02198"></a>02198     }
<a name="l02199"></a>02199 
<a name="l02205"></a><a class="code" href="classDoctrine__Query.html#ab62eb29f6e18999b48a6ca6cba3d34a6">02205</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ab62eb29f6e18999b48a6ca6cba3d34a6" title="Magic method called after cloning process.">__clone</a>()
<a name="l02206"></a>02206     {
<a name="l02207"></a>02207         $this-&gt;_parsers = array();
<a name="l02208"></a>02208         $this-&gt;_hydrator = clone $this-&gt;_hydrator;
<a name="l02209"></a>02209 
<a name="l02210"></a>02210         <span class="comment">// Subqueries share some information from the parent so it can intermingle</span>
<a name="l02211"></a>02211         <span class="comment">// with the dql of the main query. So when a subquery is cloned we need to</span>
<a name="l02212"></a>02212         <span class="comment">// kill those references or it causes problems</span>
<a name="l02213"></a>02213         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classDoctrine__Query.html#a001b8e28352d1ee3d30ee74123c7623e" title="isSubquery if $bool parameter is set this method sets the value of Doctrine_Query::$isSubquery...">isSubquery</a>()) {
<a name="l02214"></a>02214             $this-&gt;<a class="code" href="classDoctrine__Query.html#a2a1015b5453755d33b7d574f219272f3" title="Kill the reference for the passed class property.">_killReference</a>(<span class="stringliteral">&#39;_params&#39;</span>);
<a name="l02215"></a>02215             $this-&gt;<a class="code" href="classDoctrine__Query.html#a2a1015b5453755d33b7d574f219272f3" title="Kill the reference for the passed class property.">_killReference</a>(<span class="stringliteral">&#39;_tableAliasMap&#39;</span>);
<a name="l02216"></a>02216             $this-&gt;<a class="code" href="classDoctrine__Query.html#a2a1015b5453755d33b7d574f219272f3" title="Kill the reference for the passed class property.">_killReference</a>(<span class="stringliteral">&#39;_queryComponents&#39;</span>);
<a name="l02217"></a>02217         }
<a name="l02218"></a>02218     }
<a name="l02219"></a>02219 
<a name="l02227"></a><a class="code" href="classDoctrine__Query.html#a2a1015b5453755d33b7d574f219272f3">02227</a>     <span class="keyword">protected</span> function <a class="code" href="classDoctrine__Query.html#a2a1015b5453755d33b7d574f219272f3" title="Kill the reference for the passed class property.">_killReference</a>($key)
<a name="l02228"></a>02228     {
<a name="l02229"></a>02229         $tmp = $this-&gt;$key;
<a name="l02230"></a>02230         unset($this-&gt;$key);
<a name="l02231"></a>02231         $this-&gt;$key = $tmp;
<a name="l02232"></a>02232     }
<a name="l02233"></a>02233 
<a name="l02243"></a><a class="code" href="classDoctrine__Query.html#ad350c43c36ac0a0fc243ffacd4eceb1b">02243</a>     <span class="keyword">public</span> function <a class="code" href="classDoctrine__Query.html#ad350c43c36ac0a0fc243ffacd4eceb1b" title="Frees the resources used by the query object.">free</a>()
<a name="l02244"></a>02244     {
<a name="l02245"></a>02245         $this-&gt;<a class="code" href="classDoctrine__Query.html#ab13f98c56ff5eaadb09993cc0469c4b9" title="Resets the query to the state just after it has been instantiated.">reset</a>();
<a name="l02246"></a>02246         $this-&gt;_parsers = array();
<a name="l02247"></a>02247         $this-&gt;_dqlParts = array();
<a name="l02248"></a>02248     }
<a name="l02249"></a>02249 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
