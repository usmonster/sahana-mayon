<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/lib/util/agImportNormalization.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/lib/util/agImportNormalization.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00017"></a><a class="code" href="classagImportNormalization.html">00017</a> <span class="keyword">abstract</span> <span class="keyword">class </span><a class="code" href="classagImportNormalization.html" title="Normalizing import data.">agImportNormalization</a> <span class="keyword">extends</span> <a class="code" href="classagImportHelper.html" title="Abstract class to provide import helper methods.">agImportHelper</a>
<a name="l00018"></a>00018 {
<a name="l00019"></a>00019   <span class="keyword">const</span> CONN_NORMALIZE_READ = <span class="stringliteral">&#39;import_normalize_read&#39;</span>;
<a name="l00020"></a>00020   <span class="keyword">const</span> CONN_NORMALIZE_WRITE = <span class="stringliteral">&#39;import_normalize_write&#39;</span>;
<a name="l00021"></a>00021 
<a name="l00022"></a>00022   <span class="keyword">protected</span> $helperObjects = array(),
<a name="l00023"></a>00023   $tempToRawQueryName = <span class="stringliteral">&#39;import_temp_to_raw&#39;</span>,
<a name="l00024"></a>00024   <span class="comment">// array( [order] =&gt; array(componentName =&gt; component name, helperName =&gt; Name of the helper object, throwOnError =&gt; boolean, methodName =&gt; method name) )</span>
<a name="l00025"></a>00025   $importComponents = array(),
<a name="l00026"></a>00026   <span class="comment">//array( [importRowId] =&gt; array( _rawData =&gt; array(fetched data), primaryKeys =&gt; array(keyName =&gt; keyValue))</span>
<a name="l00027"></a>00027   $importData = array(),
<a name="l00028"></a>00028   $importCount = 0,
<a name="l00029"></a>00029   $unprocessedXLS = FALSE,
<a name="l00030"></a>00030   $unprocessedBaseName,
<a name="l00031"></a>00031   $XlsMaxExportSize;
<a name="l00032"></a>00032 
<a name="l00036"></a><a class="code" href="classagImportNormalization.html#aa1396d1c0626df977b4f75821709dfd0">00036</a>   <span class="keyword">public</span> function <a class="code" href="classagImportNormalization.html#aa1396d1c0626df977b4f75821709dfd0" title="This classes&amp;#39; destructor.">__destruct</a>()
<a name="l00037"></a>00037   {
<a name="l00038"></a>00038     <a class="code" href="classagImportNormalization.html#aa1396d1c0626df977b4f75821709dfd0" title="This classes&amp;#39; destructor.">parent::__destruct</a>();
<a name="l00039"></a>00039   }
<a name="l00040"></a>00040 
<a name="l00046"></a><a class="code" href="classagImportNormalization.html#af5a4b5b04d93c31b2b178e162079641f">00046</a>   <span class="keyword">public</span> function <a class="code" href="classagImportNormalization.html#af5a4b5b04d93c31b2b178e162079641f" title="Method to initialize this class.">__init</a>($tempTable = NULL, $logEventLevel = NULL)
<a name="l00047"></a>00047   {
<a name="l00048"></a>00048     <span class="comment">// DO NOT REMOVE</span>
<a name="l00049"></a>00049     <a class="code" href="classagImportNormalization.html#af5a4b5b04d93c31b2b178e162079641f" title="Method to initialize this class.">parent::__init</a>($tempTable, $logEventLevel);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051     $this-&gt;<a class="code" href="classagImportNormalization.html#a66c44bfaa5f9e92e5a717220a5f8f129" title="Method to set the unprocessed records basename.">setUnprocessedBaseName</a>();
<a name="l00052"></a>00052     $this-&gt;XlsMaxExportSize = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;xls_max_export_size&#39;</span>);
<a name="l00053"></a>00053   }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00060"></a>00060   <span class="keyword">abstract</span> <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a4d78d23895eb09d0a996af145bf6822d" title="Method to dynamically build a (mostly) static tempSelectQuery.">buildTempSelectQuery</a>();
<a name="l00061"></a>00061 
<a name="l00065"></a>00065   <span class="keyword">abstract</span> <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a66c44bfaa5f9e92e5a717220a5f8f129" title="Method to set the unprocessed records basename.">setUnprocessedBaseName</a>();
<a name="l00066"></a>00066 
<a name="l00070"></a><a class="code" href="classagImportNormalization.html#a5e1694ad55b007aa7ee31edd8cb1f315">00070</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a5e1694ad55b007aa7ee31edd8cb1f315" title="Method to reset ALL iter data.">resetIterData</a>()
<a name="l00071"></a>00071   {
<a name="l00072"></a>00072     <span class="comment">// execute the parent&#39;s reset</span>
<a name="l00073"></a>00073     <a class="code" href="classagImportNormalization.html#a5e1694ad55b007aa7ee31edd8cb1f315" title="Method to reset ALL iter data.">parent::resetIterData</a>();
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="comment">// now reset this data</span>
<a name="l00076"></a>00076     $this-&gt;<a class="code" href="classagImportNormalization.html#a8daf31a76fbf22b249a042c474629ba2" title="Method to reset the iterator data (used in the initial call of an import and at construction)...">resetRawIterData</a>();
<a name="l00077"></a>00077   }
<a name="l00078"></a>00078 
<a name="l00082"></a><a class="code" href="classagImportNormalization.html#a8daf31a76fbf22b249a042c474629ba2">00082</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a8daf31a76fbf22b249a042c474629ba2" title="Method to reset the iterator data (used in the initial call of an import and at construction)...">resetRawIterData</a>()
<a name="l00083"></a>00083   {
<a name="l00084"></a>00084     <span class="comment">// add additional iter members</span>
<a name="l00085"></a>00085     <span class="comment">//TODO: really figure out these bounds. -UA</span>
<a name="l00086"></a>00086     $this-&gt;iterData[<span class="stringliteral">&#39;fetchPosition&#39;</span>] = 0;
<a name="l00087"></a>00087     $this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>] = 0;
<a name="l00088"></a>00088     $this-&gt;iterData[<span class="stringliteral">&#39;batchStart&#39;</span>] = 0;
<a name="l00089"></a>00089     $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>] = 0;
<a name="l00090"></a>00090     $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>] = 0;
<a name="l00091"></a>00091     $this-&gt;iterData[<span class="stringliteral">&#39;batchSize&#39;</span>] = intval(<a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>(<span class="stringliteral">&#39;default_batch_size&#39;</span>));
<a name="l00092"></a>00092     $this-&gt;iterData[<span class="stringliteral">&#39;processedSuccessful&#39;</span>] = 0;
<a name="l00093"></a>00093     $this-&gt;iterData[<span class="stringliteral">&#39;processedFailed&#39;</span>] = 0;
<a name="l00094"></a>00094     $this-&gt;iterData[<span class="stringliteral">&#39;unprocessed&#39;</span>] = 0;
<a name="l00095"></a>00095   }
<a name="l00096"></a>00096 
<a name="l00100"></a><a class="code" href="classagImportNormalization.html#a6a017630e87cf11b49a051c7b769a151">00100</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a6a017630e87cf11b49a051c7b769a151" title="Method to reset the import data array.">resetImportData</a>()
<a name="l00101"></a>00101   {
<a name="l00102"></a>00102     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Removing existing pre-normalization import data.&#39;</span>);
<a name="l00103"></a>00103     $this-&gt;importData = array();
<a name="l00104"></a>00104   }
<a name="l00105"></a>00105 
<a name="l00110"></a><a class="code" href="classagImportNormalization.html#af5f824cb76f84d801a92574cd4a6b776">00110</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#af5f824cb76f84d801a92574cd4a6b776" title="Method to set connection objects.">setConnections</a>()
<a name="l00111"></a>00111   {
<a name="l00112"></a>00112     <a class="code" href="classagImportNormalization.html#af5f824cb76f84d801a92574cd4a6b776" title="Method to set connection objects.">parent::setConnections</a>();
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     <span class="comment">// we do this little one explicitly.</span>
<a name="l00115"></a>00115     $this-&gt;<a class="code" href="classagImportNormalization.html#aabed5a715c8916fb6607df9cb1347d36" title="Method to return the import normalize write connection.">getImportWrite</a>();
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     $dm = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l00118"></a>00118     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00119"></a>00119     $adapter = $dm-&gt;getCurrentConnection()-&gt;getDbh();
<a name="l00120"></a>00120     $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>($adapter, self::CONN_NORMALIZE_READ);
<a name="l00121"></a>00121     $dm-&gt;setCurrentConnection(self::CONN_NORMALIZE_READ);
<a name="l00122"></a>00122     $this-&gt;_conn[self::CONN_NORMALIZE_READ] = $conn;
<a name="l00123"></a>00123   }
<a name="l00124"></a>00124 
<a name="l00130"></a><a class="code" href="classagImportNormalization.html#aabed5a715c8916fb6607df9cb1347d36">00130</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#aabed5a715c8916fb6607df9cb1347d36" title="Method to return the import normalize write connection.">getImportWrite</a>($new = TRUE) {
<a name="l00131"></a>00131     <span class="keywordflow">if</span> ($conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_NORMALIZE_WRITE)) {
<a name="l00132"></a>00132       <span class="keywordflow">if</span> (!$new) {
<a name="l00133"></a>00133         <span class="keywordflow">return</span> $conn;
<a name="l00134"></a>00134       } <span class="keywordflow">else</span> {
<a name="l00135"></a>00135        $this-&gt;<a class="code" href="classagPdoHelper.html#ae82afc4df33468def2018d44d55b039c" title="Method to close a doctrine connection safely.">closeConnection</a>($conn);
<a name="l00136"></a>00136       }
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">// need this guy for all the heavy lifting</span>
<a name="l00140"></a>00140     $dm = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>();
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="comment">// save for re-setting</span>
<a name="l00143"></a>00143     $currConn = $dm-&gt;getCurrentConnection();
<a name="l00144"></a>00144     $currConnName = $dm-&gt;getConnectionName($currConn);
<a name="l00145"></a>00145     $adapter = $currConn-&gt;getDbh();
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="comment">// always re-parent properly</span>
<a name="l00148"></a>00148     $dm-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>($adapter, self::CONN_NORMALIZE_WRITE);
<a name="l00151"></a>00151     $conn-&gt;setAttribute(Doctrine_Core::ATTR_AUTO_FREE_QUERY_OBJECTS, TRUE);
<a name="l00152"></a>00152     $conn-&gt;setAttribute(<a class="code" href="classDoctrine__Core.html#a91839462e9d627a6b20ed0629a98b77d" title="ATTRIBUTE CONSTANTS.">Doctrine_Core::ATTR_AUTOCOMMIT</a>, FALSE);
<a name="l00153"></a>00153     $conn-&gt;setAttribute(Doctrine_Core::ATTR_USE_DQL_CALLBACKS, TRUE);
<a name="l00154"></a>00154     $conn-&gt;setAttribute(Doctrine_Core::ATTR_AUTOLOAD_TABLE_CLASSES, FALSE);
<a name="l00155"></a>00155     $conn-&gt;setAttribute(Doctrine_Core::ATTR_LOAD_REFERENCES, FALSE);
<a name="l00156"></a>00156     $conn-&gt;setAttribute(Doctrine_Core::ATTR_VALIDATE, FALSE);
<a name="l00157"></a>00157     $conn-&gt;setAttribute(Doctrine_Core::ATTR_CASCADE_SAVES, FALSE);
<a name="l00158"></a>00158     $this-&gt;_conn[self::CONN_NORMALIZE_WRITE] = $conn;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     $dm-&gt;setCurrentConnection($currConnName);
<a name="l00161"></a>00161     <span class="keywordflow">return</span> $conn;
<a name="l00162"></a>00162   }
<a name="l00163"></a>00163 
<a name="l00168"></a><a class="code" href="classagImportNormalization.html#a78f259342c190eab8141771a4f086e6d">00168</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a78f259342c190eab8141771a4f086e6d" title="Method to lazily load helper objects used during data normalization.">loadHelperObject</a>($helperClassName)
<a name="l00169"></a>00169   {
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (!array_key_exists($helperClassName, $this-&gt;helperObjects)) {
<a name="l00171"></a>00171       $this-&gt;helperObjects[$helperClassName] = <span class="keyword">new</span> $helperClassName;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173   }
<a name="l00174"></a>00174 
<a name="l00179"></a><a class="code" href="classagImportNormalization.html#a84af94028c5b366067148773d6775874">00179</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a84af94028c5b366067148773d6775874" title="Method to update the temp table and mark this batch as successful or failed print(&amp;quot;Import...">updateTempSuccess</a>($success)
<a name="l00180"></a>00180   {
<a name="l00181"></a>00181     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&quot;Updating temp with batch success data&quot;</span>);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="comment">// grab our connection object</span>
<a name="l00184"></a>00184     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_WRITE);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     $dataSize = count($this-&gt;importData);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="comment">// create our query statement</span>
<a name="l00189"></a>00189     $q = <span class="stringliteral">&#39;UPDATE &#39;</span> . $this-&gt;tempTable .
<a name="l00190"></a>00190         <span class="stringliteral">&#39; SET &#39;</span> . $this-&gt;successColumn . <span class="stringliteral">&#39;=?&#39;</span> .
<a name="l00191"></a>00191         <span class="stringliteral">&#39; WHERE &#39;</span> . $this-&gt;idColumn .
<a name="l00192"></a>00192         <span class="stringliteral">&#39; IN(&#39;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, array_fill(0, $dataSize, <span class="charliteral">&#39;?&#39;</span>)) . <span class="stringliteral">&#39;);&#39;</span>;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="comment">// create our parameter array</span>
<a name="l00195"></a>00195     $qParam = array_merge(array(intval($success)), array_keys($this-&gt;importData));
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="comment">// mark this batch accordingly</span>
<a name="l00198"></a>00198     $this-&gt;<a class="code" href="classagPdoHelper.html#a6096b5f6d180e4d13e1547755dffea81" title="Method to execute a PDO query and optionally bind it to the class parameter.">executePdoQuery</a>($conn, $q, $qParam);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">if</span> ($success)
<a name="l00201"></a>00201     {
<a name="l00202"></a>00202       $this-&gt;iterData[<span class="stringliteral">&#39;processedSuccessful&#39;</span>] += $dataSize;
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204     <span class="keywordflow">else</span>
<a name="l00205"></a>00205     {
<a name="l00206"></a>00206       $this-&gt;iterData[<span class="stringliteral">&#39;processedFailed&#39;</span>] += $dataSize;
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     $this-&gt;iterData[<span class="stringliteral">&#39;unprocessed&#39;</span>] -= $dataSize;
<a name="l00210"></a>00210     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&quot;Temp table successfully updated with batch success data&quot;</span>);
<a name="l00211"></a>00211   }
<a name="l00212"></a>00212 
<a name="l00217"></a><a class="code" href="classagImportNormalization.html#afc2a2cb71cb2205f15a9322a82060e8c">00217</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#afc2a2cb71cb2205f15a9322a82060e8c" title="Method to remove the successes from our data table so we can return just the unprocessed...">removeTempSuccesses</a>()
<a name="l00218"></a>00218   {
<a name="l00219"></a>00219     <span class="comment">// grab our connection object</span>
<a name="l00220"></a>00220     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_WRITE);
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment">// create our query statement</span>
<a name="l00223"></a>00223     $q = sprintf(<span class="stringliteral">&#39;DELETE FROM %s WHERE %s = 1;&#39;</span>, $this-&gt;tempTable, $this-&gt;successColumn);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="comment">// remove the successes from our data table so we can return just the unprocessed and failed</span>
<a name="l00226"></a>00226     $this-&gt;<a class="code" href="classagPdoHelper.html#a6096b5f6d180e4d13e1547755dffea81" title="Method to execute a PDO query and optionally bind it to the class parameter.">executePdoQuery</a>($conn, $query);
<a name="l00227"></a>00227   }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229   <span class="keyword">public</span> function getImportDataDump()
<a name="l00230"></a>00230   {
<a name="l00231"></a>00231     <span class="keywordflow">return</span> $this-&gt;importData;
<a name="l00232"></a>00232   }
<a name="l00233"></a>00233 
<a name="l00238"></a><a class="code" href="classagImportNormalization.html#abe2e82dbbda2295f2e972349501145ff">00238</a>   <span class="keyword">public</span> function <a class="code" href="classagImportNormalization.html#abe2e82dbbda2295f2e972349501145ff" title="Method to return all import events as an array.">getImportEvents</a>()
<a name="l00239"></a>00239   {
<a name="l00240"></a>00240     <span class="keywordflow">return</span> $this-&gt;eh-&gt;getEvents(agEventHandler::EVENT_SORT_TS);
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242 
<a name="l00246"></a><a class="code" href="classagImportNormalization.html#a1798d029f3f5fd958e577a24ddba7c1f">00246</a>   <span class="keyword">public</span> function <a class="code" href="classagImportNormalization.html#a1798d029f3f5fd958e577a24ddba7c1f" title="Method to close out an import procedure.">concludeImport</a>()
<a name="l00247"></a>00247   {
<a name="l00248"></a>00248     <span class="comment">// now, close any unnecessary connections to release as much memory as possible</span>
<a name="l00249"></a>00249     <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>()-&gt;setCurrentConnection(<span class="stringliteral">&#39;doctrine&#39;</span>);
<a name="l00250"></a>00250     $this-&gt;<a class="code" href="classagPdoHelper.html#ae82afc4df33468def2018d44d55b039c" title="Method to close a doctrine connection safely.">closeConnection</a>($this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_WRITE));
<a name="l00251"></a>00251     $this-&gt;<a class="code" href="classagPdoHelper.html#ae82afc4df33468def2018d44d55b039c" title="Method to close a doctrine connection safely.">closeConnection</a>($this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_NORMALIZE_READ));
<a name="l00252"></a>00252     $this-&gt;<a class="code" href="classagPdoHelper.html#ae82afc4df33468def2018d44d55b039c" title="Method to close a doctrine connection safely.">closeConnection</a>($this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_NORMALIZE_WRITE));
<a name="l00253"></a>00253     
<a name="l00254"></a>00254     <span class="comment">// build our unprocessed XLS file</span>
<a name="l00255"></a>00255     $this-&gt;unprocessedXLS = $this-&gt;<a class="code" href="classagImportNormalization.html#aa4228e5486c67bae69e24aa048d7ddd8" title="Method to construct an XLS file of unprocessed records returns the path of the XLS...">setUnprocessedXLS</a>();
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="comment">// now release all remaining connections</span>
<a name="l00258"></a>00258     $this-&gt;<a class="code" href="classagPdoHelper.html#ae82afc4df33468def2018d44d55b039c" title="Method to close a doctrine connection safely.">closeConnection</a>($this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_READ));
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260 
<a name="l00265"></a><a class="code" href="classagImportNormalization.html#af809141cf862399f5628addd666973aa">00265</a>   <span class="keyword">public</span> function <a class="code" href="classagImportNormalization.html#af809141cf862399f5628addd666973aa" title="Method to return an array pointing to.">getUnprocessedXLS</a>()
<a name="l00266"></a>00266   {
<a name="l00267"></a>00267     <span class="keywordflow">return</span> $this-&gt;unprocessedXLS;
<a name="l00268"></a>00268   }
<a name="l00269"></a>00269 
<a name="l00275"></a><a class="code" href="classagImportNormalization.html#aa4228e5486c67bae69e24aa048d7ddd8">00275</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#aa4228e5486c67bae69e24aa048d7ddd8" title="Method to construct an XLS file of unprocessed records returns the path of the XLS...">setUnprocessedXLS</a>()
<a name="l00276"></a>00276   {
<a name="l00277"></a>00277     <span class="comment">// return false if there are no records to process</span>
<a name="l00278"></a>00278     $totalUnprocessed = $this-&gt;iterData[<span class="stringliteral">&#39;unprocessed&#39;</span>] + $this-&gt;iterData[<span class="stringliteral">&#39;processedFailed&#39;</span>];
<a name="l00279"></a>00279     <span class="keywordflow">if</span> ($totalUnprocessed == 0 &amp;&amp; $this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>] &gt; 0)
<a name="l00280"></a>00280     {
<a name="l00281"></a>00281       $eventMsg = <span class="stringliteral">&#39;All records were successfully processed.&#39;</span>;
<a name="l00282"></a>00282       $this-&gt;eh-&gt;logNotice($eventMsg);
<a name="l00283"></a>00283       <span class="keywordflow">return</span> FALSE;
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// log a message and continue</span>
<a name="l00287"></a>00287     $eventMsg = <span class="stringliteral">&#39;All records could not be successfully processed.&#39;</span>;
<a name="l00288"></a>00288     $this-&gt;eh-&gt;logWarning($eventMsg);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">// first search our directory for existing unprocessed files and remove</span>
<a name="l00291"></a>00291     $pathBase = realpath(sys_get_temp_dir()) . DIRECTORY_SEPARATOR . $this-&gt;unprocessedBaseName;
<a name="l00292"></a>00292     <span class="keywordflow">foreach</span>(glob(($pathBase . <span class="charliteral">&#39;*&#39;</span>)) as $filename) {
<a name="l00293"></a>00293       $eventMsg = <span class="stringliteral">&#39;Removing old export file &#39;</span> . $filename . <span class="charliteral">&#39;.&#39;</span>;
<a name="l00294"></a>00294       $this-&gt;eh-&gt;logDebug($eventMsg);
<a name="l00295"></a>00295       unlink($filename);
<a name="l00296"></a>00296       $eventMsg = <span class="stringliteral">&#39;Successfully removed old export file &#39;</span> . $filename . <span class="charliteral">&#39;.&#39;</span>;
<a name="l00297"></a>00297       $this-&gt;eh-&gt;logInfo($eventMsg);
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="comment">// rinse and repeat</span>
<a name="l00301"></a>00301     $pathBase = sfConfig::get(<span class="stringliteral">&#39;sf_download_dir&#39;</span>) . DIRECTORY_SEPARATOR . $this-&gt;unprocessedBaseName;
<a name="l00302"></a>00302     <span class="keywordflow">foreach</span>(glob(($pathBase . <span class="charliteral">&#39;*&#39;</span>)) as $filename) {
<a name="l00303"></a>00303       $eventMsg = <span class="stringliteral">&#39;Removing old export file &#39;</span> . $filename . <span class="charliteral">&#39;.&#39;</span>;
<a name="l00304"></a>00304       $this-&gt;eh-&gt;logDebug($eventMsg);
<a name="l00305"></a>00305       unlink($filename);
<a name="l00306"></a>00306       $eventMsg = <span class="stringliteral">&#39;Successfully removed old export file &#39;</span> . $filename . <span class="charliteral">&#39;.&#39;</span>;
<a name="l00307"></a>00307       $this-&gt;eh-&gt;logInfo($eventMsg);
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="comment">// set some smart variables</span>
<a name="l00311"></a>00311     $date = date(<span class="stringliteral">&#39;Ymd_His&#39;</span>);
<a name="l00312"></a>00312     $downloadFile = $this-&gt;unprocessedBaseName . <span class="charliteral">&#39;_&#39;</span> . $date . <span class="stringliteral">&#39;.zip&#39;</span>;
<a name="l00313"></a>00313     $zipPath = realpath(sys_get_temp_dir()) . DIRECTORY_SEPARATOR . $downloadFile;
<a name="l00314"></a>00314     $exportFiles = array();
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">// Create zip file</span>
<a name="l00317"></a>00317     $zipFile = <span class="keyword">new</span> ZipArchive();
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keywordflow">if</span> ($zipFile-&gt;open($zipPath, ZIPARCHIVE::CREATE) !== TRUE) {
<a name="l00320"></a>00320       $this-&gt;eh-&gt;err(<span class="stringliteral">&#39;Could not create the output zip file&#39;</span> .  $zipPath .
<a name="l00321"></a>00321         <span class="stringliteral">&#39;. Check your permissions to make sure you have write access.&#39;</span>);
<a name="l00322"></a>00322     } <span class="keywordflow">else</span> {
<a name="l00323"></a>00323       $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Successfully created&#39;</span> .  $zipPath . <span class="charliteral">&#39;.&#39;</span>);
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325     
<a name="l00326"></a>00326     <span class="comment">// get our temporary table read connection</span>
<a name="l00327"></a>00327     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_READ);
<a name="l00328"></a>00328     $columnHeaders = array_keys($this-&gt;importSpec);
<a name="l00329"></a>00329     $selectCols = <span class="stringliteral">&#39;t.&#39;</span> . implode(<span class="stringliteral">&#39;, t.&#39;</span>, $columnHeaders);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">// build our query statement</span>
<a name="l00332"></a>00332     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Establishing fetch from the database.&#39;</span>);
<a name="l00333"></a>00333     $q = <span class="stringliteral">&#39;SELECT &#39;</span> . $selectCols . <span class="stringliteral">&#39; FROM &#39;</span> . $this-&gt;tempTable . <span class="stringliteral">&#39; AS t WHERE t.&#39;</span> .
<a name="l00334"></a>00334       $this-&gt;successColumn . <span class="stringliteral">&#39; != ? OR &#39;</span> . $this-&gt;successColumn . <span class="stringliteral">&#39; IS NULL;&#39;</span>;
<a name="l00335"></a>00335     $pdo = $this-&gt;<a class="code" href="classagPdoHelper.html#a6096b5f6d180e4d13e1547755dffea81" title="Method to execute a PDO query and optionally bind it to the class parameter.">executePdoQuery</a>($conn, $q, array(TRUE));
<a name="l00336"></a>00336     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;PDO object successfully created.&#39;</span>);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">// set counters</span>
<a name="l00339"></a>00339     $i = 1;
<a name="l00340"></a>00340     $fetchPosition = 0;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="comment">// begin fetching from the database, starting with our first record</span>
<a name="l00343"></a>00343     <span class="keywordflow">while</span> ($row = $pdo-&gt;fetch()) {
<a name="l00344"></a>00344       <span class="comment">// keeps up from potentially ending up in a neverending loop</span>
<a name="l00345"></a>00345       set_time_limit($this-&gt;maxBatchTime);
<a name="l00346"></a>00346       
<a name="l00347"></a>00347       <span class="comment">// start by incrementing our fetch position</span>
<a name="l00348"></a>00348       $fetchPosition++;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       <span class="comment">// reset our exportData array and add our first row to it</span>
<a name="l00351"></a>00351       $exportData = array();
<a name="l00352"></a>00352       $exportData[] = $row;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354       <span class="comment">// continue fetching until we either run out of records or hit our batch limit</span>
<a name="l00355"></a>00355       <span class="keywordflow">while</span> (($fetchPosition % $this-&gt;XlsMaxExportSize != 0) &amp;&amp; ($row = $pdo-&gt;fetch())) {
<a name="l00356"></a>00356         <span class="comment">// always increment fetch position immediately</span>
<a name="l00357"></a>00357         $fetchPosition++;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="comment">// add the row to our $rows array</span>
<a name="l00360"></a>00360         $exportData[] = $row;
<a name="l00361"></a>00361       }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363       <span class="comment">// set our xlsname and pass it and our export data to the buildXls method</span>
<a name="l00364"></a>00364       $xlsName = $this-&gt;unprocessedBaseName . <span class="charliteral">&#39;_&#39;</span> . $date . <span class="charliteral">&#39;_&#39;</span> . $i . <span class="stringliteral">&#39;.xls&#39;</span>;
<a name="l00365"></a>00365       $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Fetched &#39;</span> . count($row) . <span class="stringliteral">&#39; records from the database into &#39;</span> .
<a name="l00366"></a>00366         <span class="stringliteral">&#39;batch &#39;</span> . $i . <span class="stringliteral">&#39;. Now adding records to &#39;</span> . $xlsName . <span class="charliteral">&#39;.&#39;</span>);
<a name="l00367"></a>00367       $xlsPath = realpath(sys_get_temp_dir()) . DIRECTORY_SEPARATOR . $xlsName;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369       <span class="comment">// check for successful creation of the xlsfile (both soft and hard)</span>
<a name="l00370"></a>00370       <span class="keywordflow">try</span> {
<a name="l00371"></a>00371         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classagImportNormalization.html#ab4d3e817dd99b31a6061c8b45f10c820" title="Method to create an xls import file and return TRUE if successful.">buildXls</a>($xlsPath, $exportData)) {
<a name="l00372"></a>00372           <span class="keywordflow">break</span>;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374       } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00375"></a>00375         $this-&gt;eh-&gt;logErr($e-&gt;getMessage());
<a name="l00376"></a>00376         <span class="keywordflow">break</span>;
<a name="l00377"></a>00377       }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379       <span class="comment">// if all went well, add it to the exportFiles array</span>
<a name="l00380"></a>00380       $exportFiles[$i] = array($xlsPath, $xlsName);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382       <span class="comment">// iterate our batch counter</span>
<a name="l00383"></a>00383       $i++;
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">// we do this to check if any records were processed at all</span>
<a name="l00387"></a>00387     <span class="keywordflow">if</span> ($fetchPosition == 0 || count($exportFiles) == 0) {
<a name="l00388"></a>00388 
<a name="l00389"></a>00389       <span class="comment">// if none were, log a warning</span>
<a name="l00390"></a>00390       $this-&gt;eh-&gt;logWarning(<span class="stringliteral">&#39;No unprocessed records could be retrieved. Could not create &#39;</span> .
<a name="l00391"></a>00391         <span class="stringliteral">&#39;unprocessed records export.&#39;</span>);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393       <span class="comment">// close out and remove our zipfile</span>
<a name="l00394"></a>00394       $zipFile-&gt;close();
<a name="l00395"></a>00395       unlink($zipPath);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397       <span class="comment">// then return false</span>
<a name="l00398"></a>00398       <span class="keywordflow">return</span> FALSE;
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">// otherwise, add our xls files to the zip</span>
<a name="l00402"></a>00402     <span class="keywordflow">foreach</span> ($exportFiles as $xlsFileInfo) {
<a name="l00403"></a>00403       $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Adding &#39;</span> . $xlsFileInfo[1] . <span class="stringliteral">&#39; to zip file.&#39;</span>);
<a name="l00404"></a>00404       $zipFile-&gt;addFile($xlsFileInfo[0], $xlsFileInfo[1]);
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully added &#39;</span> . count($exportFiles) .
<a name="l00407"></a>00407       <span class="stringliteral">&#39; xls files to zip file.&#39;</span>);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="comment">// close the zip</span>
<a name="l00410"></a>00410     $zipFile-&gt;close();
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">// remove the individual xls files</span>
<a name="l00413"></a>00413     <span class="keywordflow">foreach</span> ($exportFiles as $xlsFileInfo) {
<a name="l00414"></a>00414       $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Removing &#39;</span> . $xlsFileInfo[1] . <span class="stringliteral">&#39; from the temp directory.&#39;</span>);
<a name="l00415"></a>00415       unlink($xlsFileInfo[0]);
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&#39;Successfully removed xls files from the temp directory.&#39;</span>);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="comment">// finally, move the zip file to its final web-accessible location</span>
<a name="l00420"></a>00420     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Moving &#39;</span> . $downloadFile . <span class="stringliteral">&#39; to user-accesible directory.&#39;</span>);
<a name="l00421"></a>00421     $downloadPath = sfConfig::get(<span class="stringliteral">&#39;sf_download_dir&#39;</span>) . DIRECTORY_SEPARATOR . $downloadFile;
<a name="l00422"></a>00422     <span class="keywordflow">if</span> (! rename($zipPath, $downloadPath)) {
<a name="l00423"></a>00423       $this-&gt;eh-&gt;logErr(<span class="stringliteral">&#39;Unable to move &#39;</span> . $downloadFile . <span class="stringliteral">&#39; to the specified upload &#39;</span> .
<a name="l00424"></a>00424         <span class="stringliteral">&#39;directory. Check your sf_upload_dir configuration to ensure you have write permissions.&#39;</span>);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     $eventMsg = <span class="stringliteral">&quot;Successfully created export file of unprocessed records.&quot;</span>;
<a name="l00428"></a>00428     $this-&gt;eh-&gt;logNotice($eventMsg);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="keywordflow">return</span> $downloadFile;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   }
<a name="l00434"></a>00434 
<a name="l00441"></a><a class="code" href="classagImportNormalization.html#ab4d3e817dd99b31a6061c8b45f10c820">00441</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#ab4d3e817dd99b31a6061c8b45f10c820" title="Method to create an xls import file and return TRUE if successful.">buildXls</a>($xlsPath, array $exportData)
<a name="l00442"></a>00442   {
<a name="l00443"></a>00443     <span class="comment">// load the Excel writer object</span>
<a name="l00444"></a>00444     $sheet = <span class="keyword">new</span> <a class="code" href="classagExcel2003ExportHelper.html" title="Provides entity phone helper functions and inherits several methods and properties...">agExcel2003ExportHelper</a>($this-&gt;unprocessedBaseName);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="comment">// Write the column headers</span>
<a name="l00447"></a>00447     <span class="keywordflow">foreach</span> (array_keys($exportData[0]) as $columnHeader) {
<a name="l00448"></a>00448       $sheet-&gt;label($columnHeader);
<a name="l00449"></a>00449       $sheet-&gt;right();
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordflow">foreach</span> ($exportData as $exportRowData) {
<a name="l00453"></a>00453       $sheet-&gt;down();
<a name="l00454"></a>00454       $sheet-&gt;home();
<a name="l00455"></a>00455 
<a name="l00456"></a>00456       <span class="comment">// Write values</span>
<a name="l00457"></a>00457       <span class="keywordflow">foreach</span> ($exportRowData as $value) {
<a name="l00458"></a>00458         $sheet-&gt;label($value);
<a name="l00459"></a>00459         $sheet-&gt;right();
<a name="l00460"></a>00460       }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       <span class="comment">// Capture peak memory</span>
<a name="l00463"></a>00463       $currentMemoryUsage = memory_get_usage();
<a name="l00464"></a>00464       <span class="keywordflow">if</span> ($currentMemoryUsage &gt; $this-&gt;peakMemory) {
<a name="l00465"></a>00465         $this-&gt;peakMemory = memory_get_usage();
<a name="l00466"></a>00466       }
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     $sheet-&gt;save($xlsPath);
<a name="l00470"></a>00470     <span class="keywordflow">return</span> TRUE;
<a name="l00471"></a>00471   }
<a name="l00472"></a>00472 
<a name="l00477"></a><a class="code" href="classagImportNormalization.html#aa4fe6b8e81ab57534b9f9f6dade09eb1">00477</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#aa4fe6b8e81ab57534b9f9f6dade09eb1" title="Basically everything that can be wiped about this object.">clearImport</a>($resetEvents = FALSE)
<a name="l00478"></a>00478   {
<a name="l00479"></a>00479     $this-&gt;<a class="code" href="classagImportNormalization.html#a6a017630e87cf11b49a051c7b769a151" title="Method to reset the import data array.">resetImportData</a>();
<a name="l00480"></a>00480     $this-&gt;<a class="code" href="classagImportNormalization.html#a5e1694ad55b007aa7ee31edd8cb1f315" title="Method to reset ALL iter data.">resetIterData</a>();
<a name="l00481"></a>00481     $this-&gt;<a class="code" href="classagPdoHelper.html#abe87b8a85cc0200f3d8321932a765295" title="Method to clear all connections.">clearConnections</a>();
<a name="l00482"></a>00482     <span class="keywordflow">if</span> ($resetEvents) { $this-&gt;eh-&gt;resetEvents(); }
<a name="l00483"></a>00483   }
<a name="l00484"></a>00484 
<a name="l00489"></a><a class="code" href="classagImportNormalization.html#a595c792502dc5a55abf0212f57f4d768">00489</a>   <span class="keyword">public</span> function <a class="code" href="classagImportNormalization.html#a595c792502dc5a55abf0212f57f4d768" title="Method to load and process a batch of records.">processBatch</a>()
<a name="l00490"></a>00490   {
<a name="l00491"></a>00491     <span class="comment">// keeps us from potentially ending up in a neverending loop</span>
<a name="l00492"></a>00492     set_time_limit($this-&gt;maxBatchTime);
<a name="l00493"></a>00493     
<a name="l00494"></a>00494     <span class="comment">// preempt this method with a check on our error threshold and stop if we shouldn&#39;t continue</span>
<a name="l00495"></a>00495     <span class="keywordflow">try</span> {
<a name="l00496"></a>00496 
<a name="l00497"></a>00497       <span class="comment">// check it once before we start anything and once after</span>
<a name="l00498"></a>00498       $this-&gt;eh-&gt;checkErrThreshold();
<a name="l00499"></a>00499 
<a name="l00500"></a>00500       <span class="comment">// load up a batch into the helper</span>
<a name="l00501"></a>00501       $this-&gt;<a class="code" href="classagImportNormalization.html#a323b938984dbd259b082e15347d540e3" title="Method to fetch the next batch of raw data records from the PDO object.">fetchNextBatch</a>();
<a name="l00502"></a>00502 
<a name="l00503"></a>00503       <span class="comment">// normalize and insert our data</span>
<a name="l00504"></a>00504       $normalizeSuccess = $this-&gt;<a class="code" href="classagImportNormalization.html#adcea060c1bfe560e72663f6987211a45" title="Method to normalize and insert raw data.">normalizeData</a>();
<a name="l00505"></a>00505 
<a name="l00506"></a>00506       <span class="comment">// update our temp table</span>
<a name="l00507"></a>00507       $this-&gt;<a class="code" href="classagImportNormalization.html#a84af94028c5b366067148773d6775874" title="Method to update the temp table and mark this batch as successful or failed print(&amp;quot;Import...">updateTempSuccess</a>($normalizeSuccess);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509       <span class="comment">// probably best to check this one more time</span>
<a name="l00510"></a>00510       $this-&gt;eh-&gt;checkErrThreshold();
<a name="l00511"></a>00511     } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00512"></a>00512       <span class="keywordflow">return</span> -1;
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     <span class="comment">// since everything&#39;s hunky-dory, let&#39;s count what&#39;s left and return that</span>
<a name="l00516"></a>00516     $remaining = ($this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>] - $this-&gt;iterData[<span class="stringliteral">&#39;fetchPosition&#39;</span>]);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="comment">// Get memory usage</span>
<a name="l00519"></a>00519     $memoryUsage = $this-&gt;<a class="code" href="classagImportHelper.html#a472e879aed0f57b0307cc69e20fa78fd" title="Returns the peak memory.">getPeakMemoryUsage</a>();
<a name="l00520"></a>00520     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&quot;Memory: $memoryUsage&quot;</span>);
<a name="l00521"></a>00521     
<a name="l00522"></a>00522     <span class="keywordflow">return</span> $remaining;
<a name="l00523"></a>00523   }
<a name="l00524"></a>00524 
<a name="l00528"></a><a class="code" href="classagImportNormalization.html#a323b938984dbd259b082e15347d540e3">00528</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a323b938984dbd259b082e15347d540e3" title="Method to fetch the next batch of raw data records from the PDO object.">fetchNextBatch</a>()
<a name="l00529"></a>00529   {
<a name="l00530"></a>00530     <span class="comment">// first, blow out the existing rawData</span>
<a name="l00531"></a>00531     $this-&gt;<a class="code" href="classagImportNormalization.html#a6a017630e87cf11b49a051c7b769a151" title="Method to reset the import data array.">resetImportData</a>();
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="comment">// these aren&#39;t required but make the code more readable</span>
<a name="l00534"></a>00534     $batchSize = $this-&gt;iterData[<span class="stringliteral">&#39;batchSize&#39;</span>];
<a name="l00535"></a>00535     $fetchPosition = &amp; $this-&gt;iterData[<span class="stringliteral">&#39;fetchPosition&#39;</span>];
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="comment">// increment our fetch counter</span>
<a name="l00538"></a>00538     $batchPosition = &amp; $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>];
<a name="l00539"></a>00539     $batchPosition++;
<a name="l00540"></a>00540     $batchStart = $fetchPosition + 1;
<a name="l00541"></a>00541     $this-&gt;iterData[<span class="stringliteral">&#39;batchStart&#39;</span>] = $batchStart;
<a name="l00542"></a>00542     $batchEnd = ($fetchPosition + $batchSize);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">// get our PDO object</span>
<a name="l00545"></a>00545     $pdo = $this-&gt;_PDO[$this-&gt;tempToRawQueryName];
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="comment">// log this event</span>
<a name="l00548"></a>00548     $eventMsg = <span class="stringliteral">&#39;Loading batch starting at &#39;</span> . $batchStart . <span class="stringliteral">&#39; from the temp table&#39;</span>;
<a name="l00549"></a>00549     $this-&gt;eh-&gt;logDebug($eventMsg);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">// fetch the data up until it ends or we hit our batchsize limit</span>
<a name="l00552"></a>00552     <span class="keywordflow">while</span> (($fetchPosition &lt; $batchEnd) &amp;&amp; ($row = $pdo-&gt;fetch())) {
<a name="l00553"></a>00553       <span class="comment">// increment our fetch counter</span>
<a name="l00554"></a>00554       $fetchPosition++;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556       <span class="comment">// modify the record just a little</span>
<a name="l00557"></a>00557       $rowId = $row-&gt;id;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559       <span class="comment">// add it to import data array and iterate our counter</span>
<a name="l00560"></a>00560       $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Fetching row &#39;</span> . $rowId . <span class="stringliteral">&#39; from temp table into import data.&#39;</span>);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562       <span class="comment">// use the import spec as our definitive columns list and add the obj properties magically</span>
<a name="l00563"></a>00563       <span class="keywordflow">foreach</span> ($this-&gt;importSpec as $columnName =&gt; $columnSpec) {
<a name="l00564"></a>00564         <span class="comment">// checking for empty negates the neebasenamed for an explicit removal step</span>
<a name="l00565"></a>00565         <span class="keywordflow">if</span> (isset($row-&gt;$columnName)) {
<a name="l00566"></a>00566           $this-&gt;importData[$rowId][<span class="stringliteral">&#39;_rawData&#39;</span>][$columnName] = $row-&gt;$columnName;
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568       }
<a name="l00569"></a>00569       $this-&gt;importData[$rowId][<span class="stringliteral">&#39;primaryKeys&#39;</span>] = array();
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     $eventMsg = <span class="stringliteral">&#39;Successfully fetched batch &#39;</span> . $batchPosition . <span class="stringliteral">&#39; (Records &#39;</span> . $batchStart .
<a name="l00573"></a>00573       <span class="stringliteral">&#39; to &#39;</span> . $fetchPosition . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00574"></a>00574     $this-&gt;eh-&gt;logInfo($eventMsg);
<a name="l00575"></a>00575   }
<a name="l00580"></a><a class="code" href="classagImportNormalization.html#a1fadece8d6d0a002a469d6bfdc6dacdc">00580</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a1fadece8d6d0a002a469d6bfdc6dacdc" title="Method to initiate the import query from temp.">tempToRaw</a>($query)
<a name="l00581"></a>00581   {
<a name="l00582"></a>00582     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_TEMP_READ);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="comment">// first get a count of what we need from temp</span>
<a name="l00585"></a>00585     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Fetching the total number of records and establishing batch size.&#39;</span>);
<a name="l00586"></a>00586     $ctQuery = sprintf(<span class="stringliteral">&#39;SELECT COUNT(*) FROM (%s) AS t;&#39;</span>, $query);
<a name="l00587"></a>00587     $ctResults = $this-&gt;<a class="code" href="classagPdoHelper.html#a6096b5f6d180e4d13e1547755dffea81" title="Method to execute a PDO query and optionally bind it to the class parameter.">executePdoQuery</a>($conn, $ctQuery);
<a name="l00588"></a>00588     $this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>] = $ctResults-&gt;fetchColumn();
<a name="l00589"></a>00589     $this-&gt;iterData[<span class="stringliteral">&#39;unprocessed&#39;</span>] = $this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>];
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     <span class="comment">// now caclulate the number of batches we&#39;ll need to process it all</span>
<a name="l00592"></a>00592     $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>] = intval(ceil(($this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>] / $this-&gt;iterData[<span class="stringliteral">&#39;batchSize&#39;</span>])));
<a name="l00593"></a>00593     $this-&gt;eh-&gt;logNotice(<span class="stringliteral">&#39;Dataset comprised of &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;fetchCount&#39;</span>] . <span class="stringliteral">&#39; records divided &#39;</span> .
<a name="l00594"></a>00594         <span class="stringliteral">&#39;into &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>] . <span class="stringliteral">&#39; batches of &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchSize&#39;</span>] .
<a name="l00595"></a>00595         <span class="stringliteral">&#39; records per batch.&#39;</span>);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="comment">// now we can legitimately execute our real search</span>
<a name="l00598"></a>00598     $this-&gt;eh-&gt;logDebug(<span class="stringliteral">&#39;Starting initial fetch from temp.&#39;</span>);
<a name="l00599"></a>00599     $this-&gt;<a class="code" href="classagPdoHelper.html#a6096b5f6d180e4d13e1547755dffea81" title="Method to execute a PDO query and optionally bind it to the class parameter.">executePdoQuery</a>($conn, $query, array(), Doctrine_Core::FETCH_OBJ,
<a name="l00600"></a>00600                            $this-&gt;tempToRawQueryName);
<a name="l00601"></a>00601     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&quot;Successfully established the PDO fetch iterator.&quot;</span>);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     $this-&gt;eh-&gt;logNotice(<span class="stringliteral">&#39;Beginning insertion of import data from temporary table.&#39;</span>);
<a name="l00604"></a>00604   }
<a name="l00605"></a>00605 
<a name="l00610"></a><a class="code" href="classagImportNormalization.html#adcea060c1bfe560e72663f6987211a45">00610</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#adcea060c1bfe560e72663f6987211a45" title="Method to normalize and insert raw data.">normalizeData</a>()
<a name="l00611"></a>00611   {
<a name="l00612"></a>00612     $err = NULL;
<a name="l00613"></a>00613     $eventMsg = <span class="stringliteral">&#39;Normalizing and inserting batch data into database. (Batch &#39;</span> .
<a name="l00614"></a>00614       $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>] . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00615"></a>00615     $this-&gt;eh-&gt;logInfo($eventMsg);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     $conn = $this-&gt;<a class="code" href="classagImportNormalization.html#aabed5a715c8916fb6607df9cb1347d36" title="Method to return the import normalize write connection.">getImportWrite</a>(TRUE);
<a name="l00618"></a>00618     $conn-&gt;beginTransaction();
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="keywordflow">foreach</span> ($this-&gt;importComponents as $index =&gt; $componentData) {
<a name="l00621"></a>00621       <span class="comment">// load any helper objects we might need</span>
<a name="l00622"></a>00622       <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;helperClass&#39;</span>, $componentData)) {
<a name="l00623"></a>00623         $this-&gt;<a class="code" href="classagImportNormalization.html#a78f259342c190eab8141771a4f086e6d" title="Method to lazily load helper objects used during data normalization.">loadHelperObject</a>($componentData[<span class="stringliteral">&#39;helperClass&#39;</span>]);
<a name="l00624"></a>00624       }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626       <span class="comment">// need this as a var so we can use it in a variable call</span>
<a name="l00627"></a>00627       $method = $componentData[<span class="stringliteral">&#39;method&#39;</span>];
<a name="l00628"></a>00628       $savepoint = __FUNCTION__ . <span class="charliteral">&#39;_&#39;</span> . $componentData[<span class="stringliteral">&#39;component&#39;</span>];
<a name="l00629"></a>00629 
<a name="l00630"></a>00630       <span class="comment">// log an event so we can follow what portion of the insert was begun</span>
<a name="l00631"></a>00631       $eventMsg = $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&quot;Calling batch processing method {$method}&quot;</span>);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633       <span class="comment">// start an inner transaction / savepoint per component</span>
<a name="l00634"></a>00634       $conn-&gt;beginTransaction($savepoint);
<a name="l00635"></a>00635       <span class="keywordflow">try</span> {
<a name="l00636"></a>00636         <span class="comment">// Calling method to set data.</span>
<a name="l00637"></a>00637         $this-&gt;$method($componentData[<span class="stringliteral">&#39;throwOnError&#39;</span>], $conn);
<a name="l00638"></a>00638         $conn-&gt;commit($savepoint);
<a name="l00639"></a>00639       } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00640"></a>00640         $errMsg = <span class="stringliteral">&#39;Import batch processing for batch &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>] .
<a name="l00641"></a>00641           <span class="stringliteral">&#39; failed during method: &#39;</span> . $componentData[<span class="stringliteral">&#39;method&#39;</span>] . <span class="stringliteral">&#39; with message: &#39;</span> .
<a name="l00642"></a>00642           $e-&gt;getMessage();
<a name="l00643"></a>00643 
<a name="l00644"></a>00644         <span class="comment">// let&#39;s capture this error, regardless of whether we&#39;ll throw</span>
<a name="l00645"></a>00645         $this-&gt;eh-&gt;logErr($errMsg, 0);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         $conn-&gt;rollback($savepoint);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         <span class="comment">// if it&#39;s not an optional component, we do a bit more and stop execution entirely</span>
<a name="l00650"></a>00650         <span class="keywordflow">if</span> ($componentData[<span class="stringliteral">&#39;throwOnError&#39;</span>]) {
<a name="l00651"></a>00651           $err = $e;
<a name="l00652"></a>00652           <span class="keywordflow">break</span>;
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654       }
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="comment">// attempt our final commit</span>
<a name="l00658"></a>00658     <span class="comment">// because doctrine&#39;s savepoints are broken, we must also wrap this since earlier failures</span>
<a name="l00659"></a>00659     <span class="comment">// may not have been detected</span>
<a name="l00660"></a>00660     <span class="keywordflow">if</span> (is_null($err)) {
<a name="l00661"></a>00661       <span class="keywordflow">try</span> {
<a name="l00662"></a>00662         $conn-&gt;commit();
<a name="l00663"></a>00663       } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00664"></a>00664         <span class="comment">// set our err variables</span>
<a name="l00665"></a>00665         $err = $e;
<a name="l00666"></a>00666         $errMsg = sprintf(<span class="stringliteral">&#39;Failed to execute final commit for batch #%d of %d (batch_size: %d)&#39;</span>,
<a name="l00667"></a>00667                           $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>], $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>],
<a name="l00668"></a>00668                           $this-&gt;iterData[<span class="stringliteral">&#39;batchSize&#39;</span>]);
<a name="l00669"></a>00669       }
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (is_null($err)) {
<a name="l00673"></a>00673       $this-&gt;eh-&gt;logNotice(<span class="stringliteral">&#39;Successfully processed batch &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>] .
<a name="l00674"></a>00674         <span class="stringliteral">&#39; of &#39;</span> .  $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>] . <span class="stringliteral">&#39;. (Records &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchStart&#39;</span>] .
<a name="l00675"></a>00675         <span class="stringliteral">&#39; through &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;fetchPosition&#39;</span>] . <span class="charliteral">&#39;)&#39;</span>);
<a name="l00676"></a>00676 
<a name="l00677"></a>00677       <span class="comment">// you&#39;ll want to do your record keeping here (eg, counts or similar)</span>
<a name="l00678"></a>00678       <span class="comment">// be sure to use class properties to store that info so additional loops can</span>
<a name="l00679"></a>00679       <span class="comment">// reference it</span>
<a name="l00680"></a>00680 
<a name="l00681"></a>00681       $this-&gt;importCount += count($this-&gt;importData);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683       <span class="keywordflow">return</span> TRUE;
<a name="l00684"></a>00684     } <span class="keywordflow">else</span> {
<a name="l00685"></a>00685       <span class="comment">// our rollback and error logging happen regardless of whether this is an optional component</span>
<a name="l00686"></a>00686       $errMsg = <span class="stringliteral">&#39;Batch &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchPosition&#39;</span>] . <span class="stringliteral">&#39; of &#39;</span> . 
<a name="l00687"></a>00687         $this-&gt;iterData[<span class="stringliteral">&#39;batchCount&#39;</span>] . <span class="stringliteral">&#39; (Records &#39;</span> . $this-&gt;iterData[<span class="stringliteral">&#39;batchStart&#39;</span>] . <span class="stringliteral">&#39; through &#39;</span> .
<a name="l00688"></a>00688         $this-&gt;iterData[<span class="stringliteral">&#39;fetchPosition&#39;</span>] . <span class="stringliteral">&#39;) encountered a fatal error and could not continue.&#39;</span>;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690       $conn-&gt;rollback();
<a name="l00691"></a>00691 
<a name="l00692"></a>00692       <span class="comment">// log our err count but postpone the threshold check until the end of the processBatch</span>
<a name="l00693"></a>00693       $this-&gt;eh-&gt;logErr($errMsg, count($this-&gt;importData), FALSE);
<a name="l00694"></a>00694 
<a name="l00695"></a>00695       <span class="comment">// return false if not</span>
<a name="l00696"></a>00696       <span class="keywordflow">return</span> FALSE;
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698   }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 
<a name="l00701"></a>00701   <span class="keyword">public</span> <span class="keyword">static</span> function resetImportStatus($moduleName)
<a name="l00702"></a>00702   {
<a name="l00703"></a>00703     <span class="comment">//TODO: get import data directory root info from global param</span>
<a name="l00704"></a>00704     $importDataRoot = sfConfig::get(<span class="stringliteral">&#39;sf_upload_dir&#39;</span>);
<a name="l00705"></a>00705     $importDir = $importDataRoot . DIRECTORY_SEPARATOR . $moduleName;
<a name="l00706"></a>00706     $statusFile = $importDir . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;status.yml&#39;</span>;
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (is_writable($statusFile)) {
<a name="l00708"></a>00708       $status = <a class="code" href="classsfYaml.html#adc58a6b2520f3e7a8349b72b9153b779" title="Loads YAML into a PHP array.">sfYaml::load</a>($statusFile);
<a name="l00709"></a>00709       $status[<span class="stringliteral">&#39;batchesLeft&#39;</span>] = 0;
<a name="l00710"></a>00710       $status[<span class="stringliteral">&#39;totalBatchCount&#39;</span>] = 0;
<a name="l00711"></a>00711       $status[<span class="stringliteral">&#39;startTime&#39;</span>] = 0;
<a name="l00712"></a>00712       file_put_contents($statusFile, <a class="code" href="classsfYaml.html#ad910b7e301c2c836449107560cc165ec" title="Dumps a PHP array to a YAML string.">sfYaml::dump</a>($status), LOCK_EX);
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714   }
<a name="l00715"></a>00715 
<a name="l00723"></a><a class="code" href="classagImportNormalization.html#a9a1db1cc49b454211893691f03cdb646">00723</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#a9a1db1cc49b454211893691f03cdb646" title="Simple method for instantiating what are effectively blank records.">createNewRec</a>(<a class="code" href="classDoctrine__Table.html">Doctrine_Table</a> $tableObject, array $foreignKeys)
<a name="l00724"></a>00724   {
<a name="l00725"></a>00725     <span class="comment">// get our connection object</span>
<a name="l00726"></a>00726     $conn = $this-&gt;<a class="code" href="classagPdoHelper.html#a273cd9da1f87159785362ddf7d44f481" title="Method to get (and lazy load) a doctrine connection object.">getConnection</a>(self::CONN_NORMALIZE_WRITE);
<a name="l00727"></a>00727     $recordName = $tableObject-&gt;<a class="code" href="classDoctrine__Table.html#aba287f95aa834e178099704f9a7d6ddf" title="Gets the subclass of Doctrine_Record that belongs to this table.">getComponentName</a>();
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="comment">// instantiate the new record object</span>
<a name="l00730"></a>00730     $newRec = <span class="keyword">new</span> $recordName($tableObject, TRUE, FALSE);
<a name="l00731"></a>00731     $newRec-&gt;synchronizeWithArray($foreignKeys);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="comment">// save and return our new id</span>
<a name="l00734"></a>00734     $newRec-&gt;save($conn);
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">return</span> $newRec[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00737"></a>00737   }
<a name="l00738"></a>00738 
<a name="l00744"></a><a class="code" href="classagImportNormalization.html#ac81eed35937ea0e56c1af14840ecaa76">00744</a>   <span class="keyword">protected</span> function <a class="code" href="classagImportNormalization.html#ac81eed35937ea0e56c1af14840ecaa76" title="Method to remove null values from _rawData.">clearNullRawData</a>()
<a name="l00745"></a>00745   {
<a name="l00746"></a>00746     $this-&gt;eh-&gt;logInfo(<span class="stringliteral">&quot;Removing null data from batch.&quot;</span>);
<a name="l00747"></a>00747     <span class="keywordflow">foreach</span> ($this-&gt;importData as $rowId =&gt; &amp;$rowData) {
<a name="l00748"></a>00748       <span class="keywordflow">foreach</span> ($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>] as $key =&gt; $val) {
<a name="l00749"></a>00749         <span class="keywordflow">if</span> (empty($val)) {
<a name="l00750"></a>00750           unset($rowData[<span class="stringliteral">&#39;_rawData&#39;</span>][$key]);
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752       }
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754     unset($rowData);
<a name="l00755"></a>00755   }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
