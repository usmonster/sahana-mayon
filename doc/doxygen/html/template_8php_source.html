<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: web/wiki/inc/template.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>web/wiki/inc/template.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00009"></a>00009 <span class="keywordflow">if</span>(!defined(<span class="stringliteral">&#39;DOKU_INC&#39;</span>)) die(<span class="stringliteral">&#39;meh.&#39;</span>);
<a name="l00010"></a>00010 
<a name="l00017"></a>00017 function <span class="keyword">template</span>($tpl){
<a name="l00018"></a>00018     global $conf;
<a name="l00019"></a>00019 
<a name="l00020"></a>00020     <span class="keywordflow">if</span>(@is_readable(DOKU_INC.<span class="stringliteral">&#39;lib/tpl/&#39;</span>.$conf[<span class="stringliteral">&#39;template&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$tpl))
<a name="l00021"></a>00021         <span class="keywordflow">return</span> DOKU_INC.<span class="stringliteral">&#39;lib/tpl/&#39;</span>.$conf[<span class="stringliteral">&#39;template&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$tpl;
<a name="l00022"></a>00022 
<a name="l00023"></a>00023     <span class="keywordflow">return</span> DOKU_INC.<span class="stringliteral">&#39;lib/tpl/default/&#39;</span>.$tpl;
<a name="l00024"></a>00024 }
<a name="l00025"></a>00025 
<a name="l00038"></a>00038 function tpl_content($prependTOC=<span class="keyword">true</span>) {
<a name="l00039"></a>00039     global $ACT;
<a name="l00040"></a>00040     global $INFO;
<a name="l00041"></a>00041     $INFO[<span class="stringliteral">&#39;prependTOC&#39;</span>] = $prependTOC;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043     ob_start();
<a name="l00044"></a>00044     trigger_event(<span class="stringliteral">&#39;TPL_ACT_RENDER&#39;</span>,$ACT,<span class="stringliteral">&#39;tpl_content_core&#39;</span>);
<a name="l00045"></a>00045     $html_output = ob_get_clean();
<a name="l00046"></a>00046     trigger_event(<span class="stringliteral">&#39;TPL_CONTENT_DISPLAY&#39;</span>,$html_output,<span class="stringliteral">&#39;ptln&#39;</span>);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048     <span class="keywordflow">return</span> !empty($html_output);
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 function tpl_content_core(){
<a name="l00052"></a>00052     global $ACT;
<a name="l00053"></a>00053     global $TEXT;
<a name="l00054"></a>00054     global $PRE;
<a name="l00055"></a>00055     global $SUF;
<a name="l00056"></a>00056     global $SUM;
<a name="l00057"></a>00057     global $IDX;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <span class="keywordflow">switch</span>($ACT){
<a name="l00060"></a>00060         <span class="keywordflow">case</span> <span class="stringliteral">&#39;show&#39;</span>:
<a name="l00061"></a>00061             html_show();
<a name="l00062"></a>00062             <span class="keywordflow">break</span>;
<a name="l00063"></a>00063         <span class="keywordflow">case</span> <span class="stringliteral">&#39;locked&#39;</span>:
<a name="l00064"></a>00064             html_locked();
<a name="l00065"></a>00065         <span class="keywordflow">case</span> <span class="stringliteral">&#39;edit&#39;</span>:
<a name="l00066"></a>00066         <span class="keywordflow">case</span> <span class="stringliteral">&#39;recover&#39;</span>:
<a name="l00067"></a>00067             html_edit();
<a name="l00068"></a>00068             <span class="keywordflow">break</span>;
<a name="l00069"></a>00069         <span class="keywordflow">case</span> <span class="stringliteral">&#39;preview&#39;</span>:
<a name="l00070"></a>00070             html_edit();
<a name="l00071"></a>00071             html_show($TEXT);
<a name="l00072"></a>00072             <span class="keywordflow">break</span>;
<a name="l00073"></a>00073         <span class="keywordflow">case</span> <span class="stringliteral">&#39;draft&#39;</span>:
<a name="l00074"></a>00074             html_draft();
<a name="l00075"></a>00075             <span class="keywordflow">break</span>;
<a name="l00076"></a>00076         <span class="keywordflow">case</span> <span class="stringliteral">&#39;search&#39;</span>:
<a name="l00077"></a>00077             html_search();
<a name="l00078"></a>00078             <span class="keywordflow">break</span>;
<a name="l00079"></a>00079         <span class="keywordflow">case</span> <span class="stringliteral">&#39;revisions&#39;</span>:
<a name="l00080"></a>00080             $first = isset($_REQUEST[<span class="stringliteral">&#39;first&#39;</span>]) ? intval($_REQUEST[<span class="stringliteral">&#39;first&#39;</span>]) : 0;
<a name="l00081"></a>00081             html_revisions($first);
<a name="l00082"></a>00082             <span class="keywordflow">break</span>;
<a name="l00083"></a>00083         <span class="keywordflow">case</span> <span class="stringliteral">&#39;diff&#39;</span>:
<a name="l00084"></a>00084             html_diff();
<a name="l00085"></a>00085             <span class="keywordflow">break</span>;
<a name="l00086"></a>00086         <span class="keywordflow">case</span> <span class="stringliteral">&#39;recent&#39;</span>:
<a name="l00087"></a>00087             <span class="keywordflow">if</span> (is_array($_REQUEST[<span class="stringliteral">&#39;first&#39;</span>])) {
<a name="l00088"></a>00088                 $_REQUEST[<span class="stringliteral">&#39;first&#39;</span>] = array_keys($_REQUEST[<span class="stringliteral">&#39;first&#39;</span>]);
<a name="l00089"></a>00089                 $_REQUEST[<span class="stringliteral">&#39;first&#39;</span>] = $_REQUEST[<span class="stringliteral">&#39;first&#39;</span>][0];
<a name="l00090"></a>00090             }
<a name="l00091"></a>00091             $first = is_numeric($_REQUEST[<span class="stringliteral">&#39;first&#39;</span>]) ? intval($_REQUEST[<span class="stringliteral">&#39;first&#39;</span>]) : 0;
<a name="l00092"></a>00092             $show_changes = $_REQUEST[<span class="stringliteral">&#39;show_changes&#39;</span>];
<a name="l00093"></a>00093             html_recent($first, $show_changes);
<a name="l00094"></a>00094             <span class="keywordflow">break</span>;
<a name="l00095"></a>00095         <span class="keywordflow">case</span> <span class="stringliteral">&#39;index&#39;</span>:
<a name="l00096"></a>00096             html_index($IDX); #FIXME can <span class="keyword">this</span> be pulled from globals? is it sanitized correctly?
<a name="l00097"></a>00097             <span class="keywordflow">break</span>;
<a name="l00098"></a>00098         <span class="keywordflow">case</span> <span class="stringliteral">&#39;backlink&#39;</span>:
<a name="l00099"></a>00099             html_backlinks();
<a name="l00100"></a>00100             <span class="keywordflow">break</span>;
<a name="l00101"></a>00101         <span class="keywordflow">case</span> <span class="stringliteral">&#39;conflict&#39;</span>:
<a name="l00102"></a>00102             html_conflict(con($PRE,$TEXT,$SUF),$SUM);
<a name="l00103"></a>00103             html_diff(con($PRE,$TEXT,$SUF),<span class="keyword">false</span>);
<a name="l00104"></a>00104             <span class="keywordflow">break</span>;
<a name="l00105"></a>00105         <span class="keywordflow">case</span> <span class="stringliteral">&#39;login&#39;</span>:
<a name="l00106"></a>00106             html_login();
<a name="l00107"></a>00107             <span class="keywordflow">break</span>;
<a name="l00108"></a>00108         <span class="keywordflow">case</span> <span class="stringliteral">&#39;register&#39;</span>:
<a name="l00109"></a>00109             html_register();
<a name="l00110"></a>00110             <span class="keywordflow">break</span>;
<a name="l00111"></a>00111         <span class="keywordflow">case</span> <span class="stringliteral">&#39;resendpwd&#39;</span>:
<a name="l00112"></a>00112             html_resendpwd();
<a name="l00113"></a>00113             <span class="keywordflow">break</span>;
<a name="l00114"></a>00114         <span class="keywordflow">case</span> <span class="stringliteral">&#39;denied&#39;</span>:
<a name="l00115"></a>00115             print p_locale_xhtml(<span class="stringliteral">&#39;denied&#39;</span>);
<a name="l00116"></a>00116             <span class="keywordflow">break</span>;
<a name="l00117"></a>00117         <span class="keywordflow">case</span> <span class="stringliteral">&#39;profile&#39;</span> :
<a name="l00118"></a>00118             html_updateprofile();
<a name="l00119"></a>00119             <span class="keywordflow">break</span>;
<a name="l00120"></a>00120         <span class="keywordflow">case</span> <span class="stringliteral">&#39;admin&#39;</span>:
<a name="l00121"></a>00121             tpl_admin();
<a name="l00122"></a>00122             <span class="keywordflow">break</span>;
<a name="l00123"></a>00123         <span class="keywordflow">case</span> <span class="stringliteral">&#39;subscribe&#39;</span>:
<a name="l00124"></a>00124             tpl_subscribe();
<a name="l00125"></a>00125             <span class="keywordflow">break</span>;
<a name="l00126"></a>00126         <span class="keywordflow">case</span> <span class="stringliteral">&#39;media&#39;</span>:
<a name="l00127"></a>00127             tpl_media();
<a name="l00128"></a>00128             <span class="keywordflow">break</span>;
<a name="l00129"></a>00129         <span class="keywordflow">default</span>:
<a name="l00130"></a>00130             $evt = <span class="keyword">new</span> <a class="code" href="classDoku__Event.html">Doku_Event</a>(<span class="stringliteral">&#39;TPL_ACT_UNKNOWN&#39;</span>,$ACT);
<a name="l00131"></a>00131             <span class="keywordflow">if</span> ($evt-&gt;advise_before())
<a name="l00132"></a>00132                 msg(<span class="stringliteral">&quot;Failed to handle command: &quot;</span>.hsc($ACT),-1);
<a name="l00133"></a>00133             $evt-&gt;advise_after();
<a name="l00134"></a>00134             unset($evt);
<a name="l00135"></a>00135             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00148"></a>00148 function tpl_toc($return=<span class="keyword">false</span>){
<a name="l00149"></a>00149     global $TOC;
<a name="l00150"></a>00150     global $ACT;
<a name="l00151"></a>00151     global $ID;
<a name="l00152"></a>00152     global $REV;
<a name="l00153"></a>00153     global $INFO;
<a name="l00154"></a>00154     global $conf;
<a name="l00155"></a>00155     $toc = array();
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="keywordflow">if</span>(is_array($TOC)){
<a name="l00158"></a>00158         <span class="comment">// if a TOC was prepared in global scope, always use it</span>
<a name="l00159"></a>00159         $toc = $TOC;
<a name="l00160"></a>00160     }elseif(($ACT == <span class="stringliteral">&#39;show&#39;</span> || substr($ACT,0,6) == <span class="stringliteral">&#39;export&#39;</span>) &amp;&amp; !$REV &amp;&amp; $INFO[<span class="stringliteral">&#39;exists&#39;</span>]){
<a name="l00161"></a>00161         <span class="comment">// get TOC from metadata, render if neccessary</span>
<a name="l00162"></a>00162         $meta = p_get_metadata($ID, <span class="keyword">false</span>, METADATA_RENDER_USING_CACHE);
<a name="l00163"></a>00163         <span class="keywordflow">if</span>(isset($meta[<span class="stringliteral">&#39;internal&#39;</span>][<span class="stringliteral">&#39;toc&#39;</span>])){
<a name="l00164"></a>00164             $tocok = $meta[<span class="stringliteral">&#39;internal&#39;</span>][<span class="stringliteral">&#39;toc&#39;</span>];
<a name="l00165"></a>00165         }<span class="keywordflow">else</span>{
<a name="l00166"></a>00166             $tocok = <span class="keyword">true</span>;
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168         $toc   = $meta[<span class="stringliteral">&#39;description&#39;</span>][<span class="stringliteral">&#39;tableofcontents&#39;</span>];
<a name="l00169"></a>00169         <span class="keywordflow">if</span>(!$tocok || !is_array($toc) || !$conf[<span class="stringliteral">&#39;tocminheads&#39;</span>] || count($toc) &lt; $conf[<span class="stringliteral">&#39;tocminheads&#39;</span>]){
<a name="l00170"></a>00170             $toc = array();
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172     }elseif($ACT == <span class="stringliteral">&#39;admin&#39;</span>){
<a name="l00173"></a>00173         <span class="comment">// try to load admin plugin TOC FIXME: duplicates code from tpl_admin</span>
<a name="l00174"></a>00174         $plugin = null;
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (!empty($_REQUEST[<span class="stringliteral">&#39;page&#39;</span>])) {
<a name="l00176"></a>00176             $pluginlist = plugin_list(<span class="stringliteral">&#39;admin&#39;</span>);
<a name="l00177"></a>00177             <span class="keywordflow">if</span> (in_array($_REQUEST[<span class="stringliteral">&#39;page&#39;</span>], $pluginlist)) {
<a name="l00178"></a>00178                 <span class="comment">// attempt to load the plugin</span>
<a name="l00179"></a>00179                 $plugin =&amp; plugin_load(<span class="stringliteral">&#39;admin&#39;</span>,$_REQUEST[<span class="stringliteral">&#39;page&#39;</span>]);
<a name="l00180"></a>00180             }
<a name="l00181"></a>00181         }
<a name="l00182"></a>00182         <span class="keywordflow">if</span> ( ($plugin !== null) &amp;&amp;
<a name="l00183"></a>00183                 (!$plugin-&gt;forAdminOnly() || $INFO[<span class="stringliteral">&#39;isadmin&#39;</span>]) ){
<a name="l00184"></a>00184             $toc = $plugin-&gt;getTOC();
<a name="l00185"></a>00185             $TOC = $toc; <span class="comment">// avoid later rebuild</span>
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     trigger_event(<span class="stringliteral">&#39;TPL_TOC_RENDER&#39;</span>, $toc, null, <span class="keyword">false</span>);
<a name="l00190"></a>00190     $html = html_TOC($toc);
<a name="l00191"></a>00191     <span class="keywordflow">if</span>($return) <span class="keywordflow">return</span> $html;
<a name="l00192"></a>00192     echo $html;
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00200"></a>00200 function tpl_admin(){
<a name="l00201"></a>00201     global $INFO;
<a name="l00202"></a>00202     global $TOC;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     $plugin = null;
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (!empty($_REQUEST[<span class="stringliteral">&#39;page&#39;</span>])) {
<a name="l00206"></a>00206         $pluginlist = plugin_list(<span class="stringliteral">&#39;admin&#39;</span>);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (in_array($_REQUEST[<span class="stringliteral">&#39;page&#39;</span>], $pluginlist)) {
<a name="l00209"></a>00209 
<a name="l00210"></a>00210             <span class="comment">// attempt to load the plugin</span>
<a name="l00211"></a>00211             $plugin =&amp; plugin_load(<span class="stringliteral">&#39;admin&#39;</span>,$_REQUEST[<span class="stringliteral">&#39;page&#39;</span>]);
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="keywordflow">if</span> ($plugin !== null){
<a name="l00216"></a>00216         <span class="keywordflow">if</span>(!is_array($TOC)) $TOC = $plugin-&gt;getTOC(); <span class="comment">//if TOC wasn&#39;t requested yet</span>
<a name="l00217"></a>00217         <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;prependTOC&#39;</span>]) tpl_toc();
<a name="l00218"></a>00218         $plugin-&gt;html();
<a name="l00219"></a>00219     }<span class="keywordflow">else</span>{
<a name="l00220"></a>00220         html_admin();
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00234"></a>00234 function tpl_metaheaders($alt=<span class="keyword">true</span>){
<a name="l00235"></a>00235     global $ID;
<a name="l00236"></a>00236     global $REV;
<a name="l00237"></a>00237     global $INFO;
<a name="l00238"></a>00238     global $JSINFO;
<a name="l00239"></a>00239     global $ACT;
<a name="l00240"></a>00240     global $QUERY;
<a name="l00241"></a>00241     global $lang;
<a name="l00242"></a>00242     global $conf;
<a name="l00243"></a>00243     $it=2;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="comment">// prepare the head array</span>
<a name="l00246"></a>00246     $head = array();
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="comment">// prepare seed for js and css</span>
<a name="l00249"></a>00249     $tseed = 0;
<a name="l00250"></a>00250     $depends = getConfigFiles(<span class="stringliteral">&#39;main&#39;</span>);
<a name="l00251"></a>00251     <span class="keywordflow">foreach</span>($depends as $f) {
<a name="l00252"></a>00252         $time = @filemtime($f);
<a name="l00253"></a>00253         <span class="keywordflow">if</span>($time &gt; $tseed) $tseed = $time;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="comment">// the usual stuff</span>
<a name="l00257"></a>00257     $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;generator&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;<span class="stringliteral">&#39;DokuWiki&#39;</span>);
<a name="l00258"></a>00258     $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;search&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;application/opensearchdescription+xml&#39;</span>,
<a name="l00259"></a>00259             <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;lib/exe/opensearch.php&#39;</span>, <span class="stringliteral">&#39;title&#39;</span>=&gt;$conf[<span class="stringliteral">&#39;title&#39;</span>] );
<a name="l00260"></a>00260     $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;start&#39;</span>, <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE );
<a name="l00261"></a>00261     <span class="keywordflow">if</span>(actionOK(<span class="stringliteral">&#39;index&#39;</span>)){
<a name="l00262"></a>00262         $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;contents&#39;</span>, <span class="stringliteral">&#39;href&#39;</span>=&gt; wl($ID,<span class="stringliteral">&#39;do=index&#39;</span>,<span class="keyword">false</span>,<span class="charliteral">&#39;&amp;&#39;</span>),
<a name="l00263"></a>00263                 <span class="stringliteral">&#39;title&#39;</span>=&gt;$lang[<span class="stringliteral">&#39;btn_index&#39;</span>] );
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">if</span>($alt){
<a name="l00267"></a>00267         $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;alternate&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;application/rss+xml&#39;</span>,
<a name="l00268"></a>00268                 <span class="stringliteral">&#39;title&#39;</span>=&gt;<span class="stringliteral">&#39;Recent Changes&#39;</span>, <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;feed.php&#39;</span>);
<a name="l00269"></a>00269         $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;alternate&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;application/rss+xml&#39;</span>,
<a name="l00270"></a>00270                 <span class="stringliteral">&#39;title&#39;</span>=&gt;<span class="stringliteral">&#39;Current Namespace&#39;</span>,
<a name="l00271"></a>00271                 <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;feed.php?mode=list&amp;ns=&#39;</span>.$INFO[<span class="stringliteral">&#39;namespace&#39;</span>]);
<a name="l00272"></a>00272         <span class="keywordflow">if</span>(($ACT == <span class="stringliteral">&#39;show&#39;</span> || $ACT == <span class="stringliteral">&#39;search&#39;</span>) &amp;&amp; $INFO[<span class="stringliteral">&#39;writable&#39;</span>]){
<a name="l00273"></a>00273             $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;edit&#39;</span>,
<a name="l00274"></a>00274                     <span class="stringliteral">&#39;title&#39;</span>=&gt;$lang[<span class="stringliteral">&#39;btn_edit&#39;</span>],
<a name="l00275"></a>00275                     <span class="stringliteral">&#39;href&#39;</span>=&gt; wl($ID,<span class="stringliteral">&#39;do=edit&#39;</span>,<span class="keyword">false</span>,<span class="charliteral">&#39;&amp;&#39;</span>));
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordflow">if</span>($ACT == <span class="stringliteral">&#39;search&#39;</span>){
<a name="l00279"></a>00279             $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;alternate&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;application/rss+xml&#39;</span>,
<a name="l00280"></a>00280                     <span class="stringliteral">&#39;title&#39;</span>=&gt;<span class="stringliteral">&#39;Search Result&#39;</span>,
<a name="l00281"></a>00281                     <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;feed.php?mode=search&amp;q=&#39;</span>.$QUERY);
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">if</span>(actionOK(<span class="stringliteral">&#39;export_xhtml&#39;</span>)){
<a name="l00285"></a>00285             $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;alternate&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/html&#39;</span>, <span class="stringliteral">&#39;title&#39;</span>=&gt;<span class="stringliteral">&#39;Plain HTML&#39;</span>,
<a name="l00286"></a>00286                     <span class="stringliteral">&#39;href&#39;</span>=&gt;exportlink($ID, <span class="stringliteral">&#39;xhtml&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="charliteral">&#39;&amp;&#39;</span>));
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span>(actionOK(<span class="stringliteral">&#39;export_raw&#39;</span>)){
<a name="l00290"></a>00290             $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;alternate&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/plain&#39;</span>, <span class="stringliteral">&#39;title&#39;</span>=&gt;<span class="stringliteral">&#39;Wiki Markup&#39;</span>,
<a name="l00291"></a>00291                     <span class="stringliteral">&#39;href&#39;</span>=&gt;exportlink($ID, <span class="stringliteral">&#39;raw&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="charliteral">&#39;&amp;&#39;</span>));
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="comment">// setup robot tags apropriate for different modes</span>
<a name="l00296"></a>00296     <span class="keywordflow">if</span>( ($ACT==<span class="stringliteral">&#39;show&#39;</span> || $ACT==<span class="stringliteral">&#39;export_xhtml&#39;</span>) &amp;&amp; !$REV){
<a name="l00297"></a>00297         <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;exists&#39;</span>]){
<a name="l00298"></a>00298             <span class="comment">//delay indexing:</span>
<a name="l00299"></a>00299             <span class="keywordflow">if</span>((time() - $INFO[<span class="stringliteral">&#39;lastmod&#39;</span>]) &gt;= $conf[<span class="stringliteral">&#39;indexdelay&#39;</span>]){
<a name="l00300"></a>00300                 $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;robots&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;<span class="stringliteral">&#39;index,follow&#39;</span>);
<a name="l00301"></a>00301             }<span class="keywordflow">else</span>{
<a name="l00302"></a>00302                 $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;robots&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;<span class="stringliteral">&#39;noindex,nofollow&#39;</span>);
<a name="l00303"></a>00303             }
<a name="l00304"></a>00304             $head[<span class="stringliteral">&#39;link&#39;</span>][] = array( <span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;canonical&#39;</span>, <span class="stringliteral">&#39;href&#39;</span>=&gt;wl($ID,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">true</span>,<span class="charliteral">&#39;&amp;&#39;</span>) );
<a name="l00305"></a>00305         }<span class="keywordflow">else</span>{
<a name="l00306"></a>00306             $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;robots&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;<span class="stringliteral">&#39;noindex,follow&#39;</span>);
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308     }elseif(defined(<span class="stringliteral">&#39;DOKU_MEDIADETAIL&#39;</span>)){
<a name="l00309"></a>00309         $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;robots&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;<span class="stringliteral">&#39;index,follow&#39;</span>);
<a name="l00310"></a>00310     }<span class="keywordflow">else</span>{
<a name="l00311"></a>00311         $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;robots&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;<span class="stringliteral">&#39;noindex,nofollow&#39;</span>);
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="comment">// set metadata</span>
<a name="l00315"></a>00315     <span class="keywordflow">if</span>($ACT == <span class="stringliteral">&#39;show&#39;</span> || $ACT==<span class="stringliteral">&#39;export_xhtml&#39;</span>){
<a name="l00316"></a>00316         <span class="comment">// date of modification</span>
<a name="l00317"></a>00317         <span class="keywordflow">if</span>($REV){
<a name="l00318"></a>00318             $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;date(<span class="stringliteral">&#39;Y-m-d\TH:i:sO&#39;</span>,$REV));
<a name="l00319"></a>00319         }<span class="keywordflow">else</span>{
<a name="l00320"></a>00320             $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;date(<span class="stringliteral">&#39;Y-m-d\TH:i:sO&#39;</span>,$INFO[<span class="stringliteral">&#39;lastmod&#39;</span>]));
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <span class="comment">// keywords (explicit or implicit)</span>
<a name="l00324"></a>00324         <span class="keywordflow">if</span>(!empty($INFO[<span class="stringliteral">&#39;meta&#39;</span>][<span class="stringliteral">&#39;subject&#39;</span>])){
<a name="l00325"></a>00325             $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;keywords&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;join(<span class="charliteral">&#39;,&#39;</span>,$INFO[<span class="stringliteral">&#39;meta&#39;</span>][<span class="stringliteral">&#39;subject&#39;</span>]));
<a name="l00326"></a>00326         }<span class="keywordflow">else</span>{
<a name="l00327"></a>00327             $head[<span class="stringliteral">&#39;meta&#39;</span>][] = array( <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;keywords&#39;</span>, <span class="stringliteral">&#39;content&#39;</span>=&gt;str_replace(<span class="charliteral">&#39;:&#39;</span>,<span class="charliteral">&#39;,&#39;</span>,$ID));
<a name="l00328"></a>00328         }
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">// load stylesheets</span>
<a name="l00332"></a>00332     $head[<span class="stringliteral">&#39;link&#39;</span>][] = array(<span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;stylesheet&#39;</span>, <span class="stringliteral">&#39;media&#39;</span>=&gt;<span class="stringliteral">&#39;screen&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/css&#39;</span>,
<a name="l00333"></a>00333             <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;lib/exe/css.php?t=&#39;</span>.$conf[<span class="stringliteral">&#39;template&#39;</span>].<span class="stringliteral">&#39;&amp;tseed=&#39;</span>.$tseed);
<a name="l00334"></a>00334     $head[<span class="stringliteral">&#39;link&#39;</span>][] = array(<span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;stylesheet&#39;</span>, <span class="stringliteral">&#39;media&#39;</span>=&gt;<span class="stringliteral">&#39;all&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/css&#39;</span>,
<a name="l00335"></a>00335             <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;lib/exe/css.php?s=all&amp;t=&#39;</span>.$conf[<span class="stringliteral">&#39;template&#39;</span>].<span class="stringliteral">&#39;&amp;tseed=&#39;</span>.$tseed);
<a name="l00336"></a>00336     $head[<span class="stringliteral">&#39;link&#39;</span>][] = array(<span class="stringliteral">&#39;rel&#39;</span>=&gt;<span class="stringliteral">&#39;stylesheet&#39;</span>, <span class="stringliteral">&#39;media&#39;</span>=&gt;<span class="stringliteral">&#39;print&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/css&#39;</span>,
<a name="l00337"></a>00337             <span class="stringliteral">&#39;href&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;lib/exe/css.php?s=print&amp;t=&#39;</span>.$conf[<span class="stringliteral">&#39;template&#39;</span>].<span class="stringliteral">&#39;&amp;tseed=&#39;</span>.$tseed);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="comment">// make $INFO and other vars available to JavaScripts</span>
<a name="l00340"></a>00340     $json = <span class="keyword">new</span> <a class="code" href="classJSON.html">JSON</a>();
<a name="l00341"></a>00341     $script = <span class="stringliteral">&quot;var NS=&#39;&quot;</span>.$INFO[<span class="stringliteral">&#39;namespace&#39;</span>].<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00342"></a>00342     <span class="keywordflow">if</span>($conf[<span class="stringliteral">&#39;useacl&#39;</span>] &amp;&amp; $_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>]){
<a name="l00343"></a>00343         $script .= <span class="stringliteral">&quot;var SIG=&#39;&quot;</span>.toolbar_signature().<span class="stringliteral">&quot;&#39;;&quot;</span>;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345     $script .= <span class="stringliteral">&#39;var JSINFO = &#39;</span>.$json-&gt;encode($JSINFO).<span class="charliteral">&#39;;&#39;</span>;
<a name="l00346"></a>00346     $head[<span class="stringliteral">&#39;script&#39;</span>][] = array( <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/javascript&#39;</span>, <span class="stringliteral">&#39;_data&#39;</span>=&gt; $script);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="comment">// load external javascript</span>
<a name="l00349"></a>00349     $head[<span class="stringliteral">&#39;script&#39;</span>][] = array( <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text/javascript&#39;</span>, <span class="stringliteral">&#39;charset&#39;</span>=&gt;<span class="stringliteral">&#39;utf-8&#39;</span>, <span class="stringliteral">&#39;_data&#39;</span>=&gt;<span class="stringliteral">&#39;&#39;</span>,
<a name="l00350"></a>00350             <span class="stringliteral">&#39;src&#39;</span>=&gt;DOKU_BASE.<span class="stringliteral">&#39;lib/exe/js.php&#39;</span>.<span class="stringliteral">&#39;?tseed=&#39;</span>.$tseed);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="comment">// trigger event here</span>
<a name="l00353"></a>00353     trigger_event(<span class="stringliteral">&#39;TPL_METAHEADER_OUTPUT&#39;</span>,$head,<span class="stringliteral">&#39;_tpl_metaheaders_action&#39;</span>,<span class="keyword">true</span>);
<a name="l00354"></a>00354     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00355"></a>00355 }
<a name="l00356"></a>00356 
<a name="l00369"></a>00369 function _tpl_metaheaders_action($data){
<a name="l00370"></a>00370     <span class="keywordflow">foreach</span>($data as $tag =&gt; $inst){
<a name="l00371"></a>00371         <span class="keywordflow">foreach</span>($inst as $attr){
<a name="l00372"></a>00372             echo <span class="charliteral">&#39;&lt;&#39;</span>,$tag,<span class="charliteral">&#39; &#39;</span>,buildAttributes($attr);
<a name="l00373"></a>00373             <span class="keywordflow">if</span>(isset($attr[<span class="stringliteral">&#39;_data&#39;</span>]) || $tag == <span class="stringliteral">&#39;script&#39;</span>){
<a name="l00374"></a>00374                 <span class="keywordflow">if</span>($tag == <span class="stringliteral">&#39;script&#39;</span> &amp;&amp; $attr[<span class="stringliteral">&#39;_data&#39;</span>])
<a name="l00375"></a>00375                     $attr[<span class="stringliteral">&#39;_data&#39;</span>] = <span class="stringliteral">&quot;&lt;!--//--&gt;&lt;![CDATA[//&gt;&lt;!--\n&quot;</span>.
<a name="l00376"></a>00376                         $attr[<span class="stringliteral">&#39;_data&#39;</span>].
<a name="l00377"></a>00377                         <span class="stringliteral">&quot;\n//--&gt;&lt;!]]&gt;&quot;</span>;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379                 echo <span class="charliteral">&#39;&gt;&#39;</span>,$attr[<span class="stringliteral">&#39;_data&#39;</span>],<span class="stringliteral">&#39;&lt;/&#39;</span>,$tag,<span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l00380"></a>00380             }<span class="keywordflow">else</span>{
<a name="l00381"></a>00381                 echo <span class="stringliteral">&#39;/&gt;&#39;</span>;
<a name="l00382"></a>00382             }
<a name="l00383"></a>00383             echo <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00395"></a>00395 function tpl_link($url,$name,$more=<span class="stringliteral">&#39;&#39;</span>,$return=<span class="keyword">false</span>){
<a name="l00396"></a>00396     $out = <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span>.$url.<span class="stringliteral">&#39;&quot; &#39;</span>;
<a name="l00397"></a>00397     <span class="keywordflow">if</span> ($more) $out .= <span class="charliteral">&#39; &#39;</span>.$more;
<a name="l00398"></a>00398     $out .= <span class="stringliteral">&quot;&gt;$name&lt;/a&gt;&quot;</span>;
<a name="l00399"></a>00399     <span class="keywordflow">if</span> ($return) <span class="keywordflow">return</span> $out;
<a name="l00400"></a>00400     print $out;
<a name="l00401"></a>00401     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00411"></a>00411 function tpl_pagelink($id,$name=null){
<a name="l00412"></a>00412     print html_wikilink($id,$name);
<a name="l00413"></a>00413     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00424"></a>00424 function tpl_getparent($id){
<a name="l00425"></a>00425     global $conf;
<a name="l00426"></a>00426     $parent = getNS($id).<span class="charliteral">&#39;:&#39;</span>;
<a name="l00427"></a>00427     resolve_pageid(<span class="stringliteral">&#39;&#39;</span>,$parent,$exists);
<a name="l00428"></a>00428     <span class="keywordflow">if</span>($parent == $id) {
<a name="l00429"></a>00429         $pos = strrpos (getNS($id),<span class="charliteral">&#39;:&#39;</span>);
<a name="l00430"></a>00430         $parent = substr($parent,0,$pos).<span class="charliteral">&#39;:&#39;</span>;
<a name="l00431"></a>00431         resolve_pageid(<span class="stringliteral">&#39;&#39;</span>,$parent,$exists);
<a name="l00432"></a>00432         <span class="keywordflow">if</span>($parent == $id) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     <span class="keywordflow">return</span> $parent;
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00443"></a>00443 function tpl_button($type,$return=<span class="keyword">false</span>){
<a name="l00444"></a>00444     $data = tpl_get_action($type);
<a name="l00445"></a>00445     <span class="keywordflow">if</span> ($data === <span class="keyword">false</span>) {
<a name="l00446"></a>00446         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00447"></a>00447     } elseif (!is_array($data)) {
<a name="l00448"></a>00448         $out = sprintf($data, <span class="stringliteral">&#39;button&#39;</span>);
<a name="l00449"></a>00449     } <span class="keywordflow">else</span> {
<a name="l00450"></a>00450         extract($data);
<a name="l00451"></a>00451         <span class="keywordflow">if</span> ($id === <span class="stringliteral">&#39;#dokuwiki__top&#39;</span>) {
<a name="l00452"></a>00452             $out = html_topbtn();
<a name="l00453"></a>00453         } <span class="keywordflow">else</span> {
<a name="l00454"></a>00454             $out = html_btn($type, $id, $accesskey, $params, $method);
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     <span class="keywordflow">if</span> ($return) <span class="keywordflow">return</span> $out;
<a name="l00458"></a>00458     echo $out;
<a name="l00459"></a>00459     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00468"></a>00468 function tpl_actionlink($type,$pre=<span class="stringliteral">&#39;&#39;</span>,$suf=<span class="stringliteral">&#39;&#39;</span>,$inner=<span class="stringliteral">&#39;&#39;</span>,$return=<span class="keyword">false</span>){
<a name="l00469"></a>00469     global $lang;
<a name="l00470"></a>00470     $data = tpl_get_action($type);
<a name="l00471"></a>00471     <span class="keywordflow">if</span> ($data === <span class="keyword">false</span>) {
<a name="l00472"></a>00472         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00473"></a>00473     } elseif (!is_array($data)) {
<a name="l00474"></a>00474         $out = sprintf($data, <span class="stringliteral">&#39;link&#39;</span>);
<a name="l00475"></a>00475     } <span class="keywordflow">else</span> {
<a name="l00476"></a>00476         extract($data);
<a name="l00477"></a>00477         <span class="keywordflow">if</span> (strpos($id, <span class="charliteral">&#39;#&#39;</span>) === 0) {
<a name="l00478"></a>00478             $linktarget = $id;
<a name="l00479"></a>00479         } <span class="keywordflow">else</span> {
<a name="l00480"></a>00480             $linktarget = wl($id, $params);
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482         $caption = $lang[<span class="stringliteral">&#39;btn_&#39;</span> . $type];
<a name="l00483"></a>00483         $akey = $addTitle = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00484"></a>00484         <span class="keywordflow">if</span>($accesskey){
<a name="l00485"></a>00485             $akey = <span class="stringliteral">&#39;accesskey=&quot;&#39;</span>.$accesskey.<span class="stringliteral">&#39;&quot; &#39;</span>;
<a name="l00486"></a>00486             $addTitle = <span class="stringliteral">&#39; [&#39;</span>.strtoupper($accesskey).<span class="charliteral">&#39;]&#39;</span>;
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488         $out = tpl_link($linktarget, $pre.(($inner)?$inner:$caption).$suf,
<a name="l00489"></a>00489                         <span class="stringliteral">&#39;class=&quot;action &#39;</span> . $type . <span class="stringliteral">&#39;&quot; &#39;</span> .
<a name="l00490"></a>00490                         $akey . <span class="stringliteral">&#39;rel=&quot;nofollow&quot; &#39;</span> .
<a name="l00491"></a>00491                         <span class="stringliteral">&#39;title=&quot;&#39;</span> . hsc($caption).$addTitle . <span class="charliteral">&#39;&quot;&#39;</span>, 1);
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     <span class="keywordflow">if</span> ($return) <span class="keywordflow">return</span> $out;
<a name="l00494"></a>00494     echo $out;
<a name="l00495"></a>00495     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00519"></a>00519 function tpl_get_action($type) {
<a name="l00520"></a>00520     global $ID;
<a name="l00521"></a>00521     global $INFO;
<a name="l00522"></a>00522     global $REV;
<a name="l00523"></a>00523     global $ACT;
<a name="l00524"></a>00524     global $conf;
<a name="l00525"></a>00525     global $auth;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">// check disabled actions and fix the badly named ones</span>
<a name="l00528"></a>00528     <span class="keywordflow">if</span>($type == <span class="stringliteral">&#39;history&#39;</span>) $type=<span class="stringliteral">&#39;revisions&#39;</span>;
<a name="l00529"></a>00529     <span class="keywordflow">if</span>(!actionOK($type)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     $accesskey = null;
<a name="l00532"></a>00532     $id        = $ID;
<a name="l00533"></a>00533     $method    = <span class="stringliteral">&#39;get&#39;</span>;
<a name="l00534"></a>00534     $params    = array(<span class="stringliteral">&#39;do&#39;</span> =&gt; $type);
<a name="l00535"></a>00535     <span class="keywordflow">switch</span>($type){
<a name="l00536"></a>00536         <span class="keywordflow">case</span> <span class="stringliteral">&#39;edit&#39;</span>:
<a name="l00537"></a>00537             <span class="comment">// most complicated type - we need to decide on current action</span>
<a name="l00538"></a>00538             <span class="keywordflow">if</span>($ACT == <span class="stringliteral">&#39;show&#39;</span> || $ACT == <span class="stringliteral">&#39;search&#39;</span>){
<a name="l00539"></a>00539                 $method = <span class="stringliteral">&#39;post&#39;</span>;
<a name="l00540"></a>00540                 <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;writable&#39;</span>]){
<a name="l00541"></a>00541                     $accesskey = <span class="charliteral">&#39;e&#39;</span>;
<a name="l00542"></a>00542                     <span class="keywordflow">if</span>(!empty($INFO[<span class="stringliteral">&#39;draft&#39;</span>])) {
<a name="l00543"></a>00543                         $type = <span class="stringliteral">&#39;draft&#39;</span>;
<a name="l00544"></a>00544                         $params[<span class="stringliteral">&#39;do&#39;</span>] = <span class="stringliteral">&#39;draft&#39;</span>;
<a name="l00545"></a>00545                     } <span class="keywordflow">else</span> {
<a name="l00546"></a>00546                         $params[<span class="stringliteral">&#39;rev&#39;</span>] = $REV;
<a name="l00547"></a>00547                         <span class="keywordflow">if</span>(!$INFO[<span class="stringliteral">&#39;exists&#39;</span>]){
<a name="l00548"></a>00548                             $type   = <span class="stringliteral">&#39;create&#39;</span>;
<a name="l00549"></a>00549                         }
<a name="l00550"></a>00550                     }
<a name="l00551"></a>00551                 }<span class="keywordflow">else</span>{
<a name="l00552"></a>00552                     <span class="keywordflow">if</span>(!actionOK(<span class="stringliteral">&#39;source&#39;</span>)) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//pseudo action</span>
<a name="l00553"></a>00553                     $params[<span class="stringliteral">&#39;rev&#39;</span>] = $REV;
<a name="l00554"></a>00554                     $type = <span class="stringliteral">&#39;source&#39;</span>;
<a name="l00555"></a>00555                     $accesskey = <span class="charliteral">&#39;v&#39;</span>;
<a name="l00556"></a>00556                 }
<a name="l00557"></a>00557             }<span class="keywordflow">else</span>{
<a name="l00558"></a>00558                 $params = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00559"></a>00559                 $type = <span class="stringliteral">&#39;show&#39;</span>;
<a name="l00560"></a>00560                 $accesskey = <span class="charliteral">&#39;v&#39;</span>;
<a name="l00561"></a>00561             }
<a name="l00562"></a>00562             <span class="keywordflow">break</span>;
<a name="l00563"></a>00563         <span class="keywordflow">case</span> <span class="stringliteral">&#39;revisions&#39;</span>:
<a name="l00564"></a>00564             $type = <span class="stringliteral">&#39;revs&#39;</span>;
<a name="l00565"></a>00565             $accesskey = <span class="charliteral">&#39;o&#39;</span>;
<a name="l00566"></a>00566             <span class="keywordflow">break</span>;
<a name="l00567"></a>00567         <span class="keywordflow">case</span> <span class="stringliteral">&#39;recent&#39;</span>:
<a name="l00568"></a>00568             $accesskey = <span class="charliteral">&#39;r&#39;</span>;
<a name="l00569"></a>00569             <span class="keywordflow">break</span>;
<a name="l00570"></a>00570         <span class="keywordflow">case</span> <span class="stringliteral">&#39;index&#39;</span>:
<a name="l00571"></a>00571             $accesskey = <span class="charliteral">&#39;x&#39;</span>;
<a name="l00572"></a>00572             <span class="keywordflow">break</span>;
<a name="l00573"></a>00573         <span class="keywordflow">case</span> <span class="stringliteral">&#39;top&#39;</span>:
<a name="l00574"></a>00574             $accesskey = <span class="charliteral">&#39;x&#39;</span>;
<a name="l00575"></a>00575             $params = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00576"></a>00576             $id = <span class="stringliteral">&#39;#dokuwiki__top&#39;</span>;
<a name="l00577"></a>00577             <span class="keywordflow">break</span>;
<a name="l00578"></a>00578         <span class="keywordflow">case</span> <span class="stringliteral">&#39;back&#39;</span>:
<a name="l00579"></a>00579             $parent = tpl_getparent($ID);
<a name="l00580"></a>00580             <span class="keywordflow">if</span> (!$parent) {
<a name="l00581"></a>00581                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00582"></a>00582             }
<a name="l00583"></a>00583             $id = $parent;
<a name="l00584"></a>00584             $params = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00585"></a>00585             $accesskey = <span class="charliteral">&#39;b&#39;</span>;
<a name="l00586"></a>00586             <span class="keywordflow">break</span>;
<a name="l00587"></a>00587         <span class="keywordflow">case</span> <span class="stringliteral">&#39;login&#39;</span>:
<a name="l00588"></a>00588             $params[<span class="stringliteral">&#39;sectok&#39;</span>] = getSecurityToken();
<a name="l00589"></a>00589             <span class="keywordflow">if</span>(isset($_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>])){
<a name="l00590"></a>00590                 <span class="keywordflow">if</span> (!actionOK(<span class="stringliteral">&#39;logout&#39;</span>)) {
<a name="l00591"></a>00591                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00592"></a>00592                 }
<a name="l00593"></a>00593                 $params[<span class="stringliteral">&#39;do&#39;</span>] = <span class="stringliteral">&#39;logout&#39;</span>;
<a name="l00594"></a>00594                 $type = <span class="stringliteral">&#39;logout&#39;</span>;
<a name="l00595"></a>00595             }
<a name="l00596"></a>00596             <span class="keywordflow">break</span>;
<a name="l00597"></a>00597         <span class="keywordflow">case</span> <span class="stringliteral">&#39;register&#39;</span>:
<a name="l00598"></a>00598             <span class="keywordflow">if</span>($_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>]){
<a name="l00599"></a>00599                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00600"></a>00600             }
<a name="l00601"></a>00601             <span class="keywordflow">break</span>;
<a name="l00602"></a>00602         <span class="keywordflow">case</span> <span class="stringliteral">&#39;resendpwd&#39;</span>:
<a name="l00603"></a>00603             <span class="keywordflow">if</span>($_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>]){
<a name="l00604"></a>00604                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606             <span class="keywordflow">break</span>;
<a name="l00607"></a>00607         <span class="keywordflow">case</span> <span class="stringliteral">&#39;admin&#39;</span>:
<a name="l00608"></a>00608             <span class="keywordflow">if</span>(!$INFO[<span class="stringliteral">&#39;ismanager&#39;</span>]){
<a name="l00609"></a>00609                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00610"></a>00610             }
<a name="l00611"></a>00611             <span class="keywordflow">break</span>;
<a name="l00612"></a>00612         <span class="keywordflow">case</span> <span class="stringliteral">&#39;revert&#39;</span>:
<a name="l00613"></a>00613             <span class="keywordflow">if</span>(!$INFO[<span class="stringliteral">&#39;ismanager&#39;</span>] || !$REV || !$INFO[<span class="stringliteral">&#39;writable&#39;</span>]) {
<a name="l00614"></a>00614                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00615"></a>00615             }
<a name="l00616"></a>00616             $params[<span class="stringliteral">&#39;rev&#39;</span>] = $REV;
<a name="l00617"></a>00617             $params[<span class="stringliteral">&#39;sectok&#39;</span>] = getSecurityToken();
<a name="l00618"></a>00618             <span class="keywordflow">break</span>;
<a name="l00619"></a>00619         <span class="keywordflow">case</span> <span class="stringliteral">&#39;subscription&#39;</span>:
<a name="l00620"></a>00620             $type = <span class="stringliteral">&#39;subscribe&#39;</span>;
<a name="l00621"></a>00621             $params[<span class="stringliteral">&#39;do&#39;</span>] = <span class="stringliteral">&#39;subscribe&#39;</span>;
<a name="l00622"></a>00622         <span class="keywordflow">case</span> <span class="stringliteral">&#39;subscribe&#39;</span>:
<a name="l00623"></a>00623             <span class="keywordflow">if</span>(!$_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>]){
<a name="l00624"></a>00624                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00625"></a>00625             }
<a name="l00626"></a>00626             <span class="keywordflow">break</span>;
<a name="l00627"></a>00627         <span class="keywordflow">case</span> <span class="stringliteral">&#39;backlink&#39;</span>:
<a name="l00628"></a>00628             <span class="keywordflow">break</span>;
<a name="l00629"></a>00629         <span class="keywordflow">case</span> <span class="stringliteral">&#39;profile&#39;</span>:
<a name="l00630"></a>00630             <span class="keywordflow">if</span>(!isset($_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>])){
<a name="l00631"></a>00631                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00632"></a>00632             }
<a name="l00633"></a>00633             <span class="keywordflow">break</span>;
<a name="l00634"></a>00634         <span class="keywordflow">case</span> <span class="stringliteral">&#39;media&#39;</span>:
<a name="l00635"></a>00635             <span class="keywordflow">break</span>;
<a name="l00636"></a>00636         <span class="keywordflow">default</span>:
<a name="l00637"></a>00637             <span class="keywordflow">return</span> <span class="stringliteral">&#39;[unknown %s type]&#39;</span>;
<a name="l00638"></a>00638             <span class="keywordflow">break</span>;
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640     <span class="keywordflow">return</span> compact(<span class="stringliteral">&#39;accesskey&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;id&#39;</span>, <span class="stringliteral">&#39;method&#39;</span>, <span class="stringliteral">&#39;params&#39;</span>);
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00648"></a>00648 function tpl_action($type,$link=0,$wrapper=<span class="keyword">false</span>,$return=<span class="keyword">false</span>,$pre=<span class="stringliteral">&#39;&#39;</span>,$suf=<span class="stringliteral">&#39;&#39;</span>,$inner=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l00649"></a>00649     $out = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00650"></a>00650     <span class="keywordflow">if</span> ($link) $out .= tpl_actionlink($type,$pre,$suf,$inner,1);
<a name="l00651"></a>00651     <span class="keywordflow">else</span> $out .= tpl_button($type,1);
<a name="l00652"></a>00652     <span class="keywordflow">if</span> ($out &amp;&amp; $wrapper) $out = <span class="stringliteral">&quot;&lt;$wrapper&gt;$out&lt;/$wrapper&gt;&quot;</span>;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <span class="keywordflow">if</span> ($return) <span class="keywordflow">return</span> $out;
<a name="l00655"></a>00655     print $out;
<a name="l00656"></a>00656     <span class="keywordflow">return</span> $out ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 
<a name="l00671"></a>00671 function tpl_searchform($ajax=<span class="keyword">true</span>,$autocomplete=<span class="keyword">true</span>){
<a name="l00672"></a>00672     global $lang;
<a name="l00673"></a>00673     global $ACT;
<a name="l00674"></a>00674     global $QUERY;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="comment">// don&#39;t print the search form if search action has been disabled</span>
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (!actionOk(<span class="stringliteral">&#39;search&#39;</span>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     print <span class="stringliteral">&#39;&lt;form action=&quot;&#39;</span>.wl().<span class="stringliteral">&#39;&quot; accept-charset=&quot;utf-8&quot; class=&quot;search&quot; id=&quot;dw__search&quot; method=&quot;get&quot;&gt;&lt;div class=&quot;no&quot;&gt;&#39;</span>;
<a name="l00680"></a>00680     print <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;do&quot; value=&quot;search&quot; /&gt;&#39;</span>;
<a name="l00681"></a>00681     print <span class="stringliteral">&#39;&lt;input type=&quot;text&quot; &#39;</span>;
<a name="l00682"></a>00682     <span class="keywordflow">if</span>($ACT == <span class="stringliteral">&#39;search&#39;</span>) print <span class="stringliteral">&#39;value=&quot;&#39;</span>.htmlspecialchars($QUERY).<span class="stringliteral">&#39;&quot; &#39;</span>;
<a name="l00683"></a>00683     <span class="keywordflow">if</span>(!$autocomplete) print <span class="stringliteral">&#39;autocomplete=&quot;off&quot; &#39;</span>;
<a name="l00684"></a>00684     print <span class="stringliteral">&#39;id=&quot;qsearch__in&quot; accesskey=&quot;f&quot; name=&quot;id&quot; class=&quot;edit&quot; title=&quot;[F]&quot; /&gt;&#39;</span>;
<a name="l00685"></a>00685     print <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; value=&quot;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_search&#39;</span>].<span class="stringliteral">&#39;&quot; class=&quot;button&quot; title=&quot;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_search&#39;</span>].<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l00686"></a>00686     <span class="keywordflow">if</span>($ajax) print <span class="stringliteral">&#39;&lt;div id=&quot;qsearch__out&quot; class=&quot;ajax_qsearch JSpopup&quot;&gt;&lt;/div&gt;&#39;</span>;
<a name="l00687"></a>00687     print <span class="stringliteral">&#39;&lt;/div&gt;&lt;/form&gt;&#39;</span>;
<a name="l00688"></a>00688     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00696"></a>00696 function tpl_breadcrumbs($sep=<span class="stringliteral">&#39;&amp;bull;&#39;</span>){
<a name="l00697"></a>00697     global $lang;
<a name="l00698"></a>00698     global $conf;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">//check if enabled</span>
<a name="l00701"></a>00701     <span class="keywordflow">if</span>(!$conf[<span class="stringliteral">&#39;breadcrumbs&#39;</span>]) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00702"></a>00702 
<a name="l00703"></a>00703     $crumbs = breadcrumbs(); <span class="comment">//setup crumb trace</span>
<a name="l00704"></a>00704 
<a name="l00705"></a>00705     <span class="comment">//reverse crumborder in right-to-left mode, add RLM character to fix heb/eng display mixups</span>
<a name="l00706"></a>00706     <span class="keywordflow">if</span>($lang[<span class="stringliteral">&#39;direction&#39;</span>] == <span class="stringliteral">&#39;rtl&#39;</span>) {
<a name="l00707"></a>00707         $crumbs = array_reverse($crumbs,<span class="keyword">true</span>);
<a name="l00708"></a>00708         $crumbs_sep = <span class="stringliteral">&#39; &amp;#8207;&lt;span class=&quot;bcsep&quot;&gt;&#39;</span>.$sep.<span class="stringliteral">&#39;&lt;/span&gt;&amp;#8207; &#39;</span>;
<a name="l00709"></a>00709     } <span class="keywordflow">else</span> {
<a name="l00710"></a>00710         $crumbs_sep = <span class="stringliteral">&#39; &lt;span class=&quot;bcsep&quot;&gt;&#39;</span>.$sep.<span class="stringliteral">&#39;&lt;/span&gt; &#39;</span>;
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <span class="comment">//render crumbs, highlight the last one</span>
<a name="l00714"></a>00714     print <span class="stringliteral">&#39;&lt;span class=&quot;bchead&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;breadcrumb&#39;</span>].<span class="stringliteral">&#39;:&lt;/span&gt;&#39;</span>;
<a name="l00715"></a>00715     $last = count($crumbs);
<a name="l00716"></a>00716     $i = 0;
<a name="l00717"></a>00717     <span class="keywordflow">foreach</span> ($crumbs as $id =&gt; $name){
<a name="l00718"></a>00718         $i++;
<a name="l00719"></a>00719         echo $crumbs_sep;
<a name="l00720"></a>00720         <span class="keywordflow">if</span> ($i == $last) print <span class="stringliteral">&#39;&lt;span class=&quot;curid&quot;&gt;&#39;</span>;
<a name="l00721"></a>00721         tpl_link(wl($id),hsc($name),<span class="stringliteral">&#39;class=&quot;breadcrumbs&quot; title=&quot;&#39;</span>.$id.<span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l00722"></a>00722         <span class="keywordflow">if</span> ($i == $last) print <span class="stringliteral">&#39;&lt;/span&gt;&#39;</span>;
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00739"></a>00739 function tpl_youarehere($sep=<span class="stringliteral">&#39; &amp;raquo; &#39;</span>){
<a name="l00740"></a>00740     global $conf;
<a name="l00741"></a>00741     global $ID;
<a name="l00742"></a>00742     global $lang;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">// check if enabled</span>
<a name="l00745"></a>00745     <span class="keywordflow">if</span>(!$conf[<span class="stringliteral">&#39;youarehere&#39;</span>]) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     $parts = explode(<span class="charliteral">&#39;:&#39;</span>, $ID);
<a name="l00748"></a>00748     $count = count($parts);
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     echo <span class="stringliteral">&#39;&lt;span class=&quot;bchead&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;youarehere&#39;</span>].<span class="stringliteral">&#39;: &lt;/span&gt;&#39;</span>;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="comment">// always print the startpage</span>
<a name="l00753"></a>00753     tpl_pagelink(<span class="charliteral">&#39;:&#39;</span>.$conf[<span class="stringliteral">&#39;start&#39;</span>]);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="comment">// print intermediate namespace links</span>
<a name="l00756"></a>00756     $part = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00757"></a>00757     <span class="keywordflow">for</span>($i=0; $i&lt;$count - 1; $i++){
<a name="l00758"></a>00758         $part .= $parts[$i].<span class="charliteral">&#39;:&#39;</span>;
<a name="l00759"></a>00759         $page = $part;
<a name="l00760"></a>00760         <span class="keywordflow">if</span> ($page == $conf[<span class="stringliteral">&#39;start&#39;</span>]) <span class="keywordflow">continue</span>; <span class="comment">// Skip startpage</span>
<a name="l00761"></a>00761 
<a name="l00762"></a>00762         <span class="comment">// output</span>
<a name="l00763"></a>00763         echo $sep;
<a name="l00764"></a>00764         tpl_pagelink($page);
<a name="l00765"></a>00765     }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     <span class="comment">// print current page, skipping start page, skipping for namespace index</span>
<a name="l00768"></a>00768     resolve_pageid(<span class="stringliteral">&#39;&#39;</span>,$page,$exists);
<a name="l00769"></a>00769     <span class="keywordflow">if</span>(isset($page) &amp;&amp; $page==$part.$parts[$i]) <span class="keywordflow">return</span>;
<a name="l00770"></a>00770     $page = $part.$parts[$i];
<a name="l00771"></a>00771     <span class="keywordflow">if</span>($page == $conf[<span class="stringliteral">&#39;start&#39;</span>]) <span class="keywordflow">return</span>;
<a name="l00772"></a>00772     echo $sep;
<a name="l00773"></a>00773     tpl_pagelink($page);
<a name="l00774"></a>00774     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 
<a name="l00785"></a>00785 function tpl_userinfo(){
<a name="l00786"></a>00786     global $lang;
<a name="l00787"></a>00787     global $INFO;
<a name="l00788"></a>00788     <span class="keywordflow">if</span>(isset($_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>])){
<a name="l00789"></a>00789         print $lang[<span class="stringliteral">&#39;loggedinas&#39;</span>].<span class="stringliteral">&#39;: &#39;</span>.hsc($INFO[<span class="stringliteral">&#39;userinfo&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>]).<span class="stringliteral">&#39; (&#39;</span>.hsc($_SERVER[<span class="stringliteral">&#39;REMOTE_USER&#39;</span>]).<span class="charliteral">&#39;)&#39;</span>;
<a name="l00790"></a>00790         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00800"></a>00800 function tpl_pageinfo($ret=<span class="keyword">false</span>){
<a name="l00801"></a>00801     global $conf;
<a name="l00802"></a>00802     global $lang;
<a name="l00803"></a>00803     global $INFO;
<a name="l00804"></a>00804     global $ID;
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <span class="comment">// return if we are not allowed to view the page</span>
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (!auth_quickaclcheck($ID)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="comment">// prepare date and path</span>
<a name="l00810"></a>00810     $fn = $INFO[<span class="stringliteral">&#39;filepath&#39;</span>];
<a name="l00811"></a>00811     <span class="keywordflow">if</span>(!$conf[<span class="stringliteral">&#39;fullpath&#39;</span>]){
<a name="l00812"></a>00812         <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;rev&#39;</span>]){
<a name="l00813"></a>00813             $fn = str_replace(fullpath($conf[<span class="stringliteral">&#39;olddir&#39;</span>]).<span class="charliteral">&#39;/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$fn);
<a name="l00814"></a>00814         }<span class="keywordflow">else</span>{
<a name="l00815"></a>00815             $fn = str_replace(fullpath($conf[<span class="stringliteral">&#39;datadir&#39;</span>]).<span class="charliteral">&#39;/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$fn);
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818     $fn = utf8_decodeFN($fn);
<a name="l00819"></a>00819     $date = dformat($INFO[<span class="stringliteral">&#39;lastmod&#39;</span>]);
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <span class="comment">// print it</span>
<a name="l00822"></a>00822     <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;exists&#39;</span>]){
<a name="l00823"></a>00823         $out = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00824"></a>00824         $out .= $fn;
<a name="l00825"></a>00825         $out .= <span class="stringliteral">&#39; &amp;middot; &#39;</span>;
<a name="l00826"></a>00826         $out .= $lang[<span class="stringliteral">&#39;lastmod&#39;</span>];
<a name="l00827"></a>00827         $out .= <span class="stringliteral">&#39;: &#39;</span>;
<a name="l00828"></a>00828         $out .= $date;
<a name="l00829"></a>00829         <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;editor&#39;</span>]){
<a name="l00830"></a>00830             $out .= <span class="charliteral">&#39; &#39;</span>.$lang[<span class="stringliteral">&#39;by&#39;</span>].<span class="charliteral">&#39; &#39;</span>;
<a name="l00831"></a>00831             $out .= editorinfo($INFO[<span class="stringliteral">&#39;editor&#39;</span>]);
<a name="l00832"></a>00832         }<span class="keywordflow">else</span>{
<a name="l00833"></a>00833             $out .= <span class="stringliteral">&#39; (&#39;</span>.$lang[<span class="stringliteral">&#39;external_edit&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835         <span class="keywordflow">if</span>($INFO[<span class="stringliteral">&#39;locked&#39;</span>]){
<a name="l00836"></a>00836             $out .= <span class="stringliteral">&#39; &amp;middot; &#39;</span>;
<a name="l00837"></a>00837             $out .= $lang[<span class="stringliteral">&#39;lockedby&#39;</span>];
<a name="l00838"></a>00838             $out .= <span class="stringliteral">&#39;: &#39;</span>;
<a name="l00839"></a>00839             $out .= editorinfo($INFO[<span class="stringliteral">&#39;locked&#39;</span>]);
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841         <span class="keywordflow">if</span>($ret){
<a name="l00842"></a>00842             <span class="keywordflow">return</span> $out;
<a name="l00843"></a>00843         }<span class="keywordflow">else</span>{
<a name="l00844"></a>00844             echo $out;
<a name="l00845"></a>00845             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847     }
<a name="l00848"></a>00848     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00859"></a>00859 function tpl_pagetitle($id=null, $ret=<span class="keyword">false</span>){
<a name="l00860"></a>00860     global $conf;
<a name="l00861"></a>00861     <span class="keywordflow">if</span>(is_null($id)){
<a name="l00862"></a>00862         global $ID;
<a name="l00863"></a>00863         $id = $ID;
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     $name = $id;
<a name="l00867"></a>00867     <span class="keywordflow">if</span> (useHeading(<span class="stringliteral">&#39;navigation&#39;</span>)) {
<a name="l00868"></a>00868         $title = p_get_first_heading($id);
<a name="l00869"></a>00869         <span class="keywordflow">if</span> ($title) $name = $title;
<a name="l00870"></a>00870     }
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     <span class="keywordflow">if</span> ($ret) {
<a name="l00873"></a>00873         <span class="keywordflow">return</span> hsc($name);
<a name="l00874"></a>00874     } <span class="keywordflow">else</span> {
<a name="l00875"></a>00875         print hsc($name);
<a name="l00876"></a>00876         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00877"></a>00877     }
<a name="l00878"></a>00878 }
<a name="l00879"></a>00879 
<a name="l00894"></a>00894 function tpl_img_getTag($tags,$alt=<span class="stringliteral">&#39;&#39;</span>,$src=null){
<a name="l00895"></a>00895     <span class="comment">// Init Exif Reader</span>
<a name="l00896"></a>00896     global $SRC;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <span class="keywordflow">if</span>(is_null($src)) $src = $SRC;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <span class="keyword">static</span> $meta = null;
<a name="l00901"></a>00901     <span class="keywordflow">if</span>(is_null($meta)) $meta = <span class="keyword">new</span> <a class="code" href="classJpegMeta.html" title="JPEG metadata reader/writer.">JpegMeta</a>($src);
<a name="l00902"></a>00902     <span class="keywordflow">if</span>($meta === <span class="keyword">false</span>) <span class="keywordflow">return</span> $alt;
<a name="l00903"></a>00903     $info = $meta-&gt;getField($tags);
<a name="l00904"></a>00904     <span class="keywordflow">if</span>($info == <span class="keyword">false</span>) <span class="keywordflow">return</span> $alt;
<a name="l00905"></a>00905     <span class="keywordflow">return</span> $info;
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00918"></a>00918 function tpl_img($maxwidth=0,$maxheight=0,$link=<span class="keyword">true</span>,$params=null){
<a name="l00919"></a>00919     global $IMG;
<a name="l00920"></a>00920     $w = tpl_img_getTag(<span class="stringliteral">&#39;File.Width&#39;</span>);
<a name="l00921"></a>00921     $h = tpl_img_getTag(<span class="stringliteral">&#39;File.Height&#39;</span>);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <span class="comment">//resize to given max values</span>
<a name="l00924"></a>00924     $ratio = 1;
<a name="l00925"></a>00925     <span class="keywordflow">if</span>($w &gt;= $h){
<a name="l00926"></a>00926         <span class="keywordflow">if</span>($maxwidth &amp;&amp; $w &gt;= $maxwidth){
<a name="l00927"></a>00927             $ratio = $maxwidth/$w;
<a name="l00928"></a>00928         }elseif($maxheight &amp;&amp; $h &gt; $maxheight){
<a name="l00929"></a>00929             $ratio = $maxheight/$h;
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931     }<span class="keywordflow">else</span>{
<a name="l00932"></a>00932         <span class="keywordflow">if</span>($maxheight &amp;&amp; $h &gt;= $maxheight){
<a name="l00933"></a>00933             $ratio = $maxheight/$h;
<a name="l00934"></a>00934         }elseif($maxwidth &amp;&amp; $w &gt; $maxwidth){
<a name="l00935"></a>00935             $ratio = $maxwidth/$w;
<a name="l00936"></a>00936         }
<a name="l00937"></a>00937     }
<a name="l00938"></a>00938     <span class="keywordflow">if</span>($ratio){
<a name="l00939"></a>00939         $w = floor($ratio*$w);
<a name="l00940"></a>00940         $h = floor($ratio*$h);
<a name="l00941"></a>00941     }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="comment">//prepare URLs</span>
<a name="l00944"></a>00944     $url=ml($IMG,array(<span class="stringliteral">&#39;cache&#39;</span>=&gt;$_REQUEST[<span class="stringliteral">&#39;cache&#39;</span>]),<span class="keyword">true</span>,<span class="charliteral">&#39;&amp;&#39;</span>);
<a name="l00945"></a>00945     $src=ml($IMG,array(<span class="stringliteral">&#39;cache&#39;</span>=&gt;$_REQUEST[<span class="stringliteral">&#39;cache&#39;</span>],<span class="charliteral">&#39;w&#39;</span>=&gt;$w,<span class="charliteral">&#39;h&#39;</span>=&gt;$h),<span class="keyword">true</span>,<span class="charliteral">&#39;&amp;&#39;</span>);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="comment">//prepare attributes</span>
<a name="l00948"></a>00948     $alt=tpl_img_getTag(<span class="stringliteral">&#39;Simple.Title&#39;</span>);
<a name="l00949"></a>00949     <span class="keywordflow">if</span>(is_null($params)){
<a name="l00950"></a>00950         $p = array();
<a name="l00951"></a>00951     }<span class="keywordflow">else</span>{
<a name="l00952"></a>00952         $p = $params;
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954     <span class="keywordflow">if</span>($w) $p[<span class="stringliteral">&#39;width&#39;</span>]  = $w;
<a name="l00955"></a>00955     <span class="keywordflow">if</span>($h) $p[<span class="stringliteral">&#39;height&#39;</span>] = $h;
<a name="l00956"></a>00956     $p[<span class="stringliteral">&#39;class&#39;</span>]  = <span class="stringliteral">&#39;img_detail&#39;</span>;
<a name="l00957"></a>00957     <span class="keywordflow">if</span>($alt){
<a name="l00958"></a>00958         $p[<span class="stringliteral">&#39;alt&#39;</span>]   = $alt;
<a name="l00959"></a>00959         $p[<span class="stringliteral">&#39;title&#39;</span>] = $alt;
<a name="l00960"></a>00960     }<span class="keywordflow">else</span>{
<a name="l00961"></a>00961         $p[<span class="stringliteral">&#39;alt&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963     $p[<span class="stringliteral">&#39;src&#39;</span>] = $src;
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     $data = array(<span class="stringliteral">&#39;url&#39;</span>=&gt;($link?$url:null), <span class="stringliteral">&#39;params&#39;</span>=&gt;$p);
<a name="l00966"></a>00966     <span class="keywordflow">return</span> trigger_event(<span class="stringliteral">&#39;TPL_IMG_DISPLAY&#39;</span>,$data,<span class="stringliteral">&#39;_tpl_img_action&#39;</span>,<span class="keyword">true</span>);
<a name="l00967"></a>00967 }
<a name="l00968"></a>00968 
<a name="l00972"></a>00972 function _tpl_img_action($data, $param=NULL) {
<a name="l00973"></a>00973     global $lang;
<a name="l00974"></a>00974     $p = buildAttributes($data[<span class="stringliteral">&#39;params&#39;</span>]);
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     <span class="keywordflow">if</span>($data[<span class="stringliteral">&#39;url&#39;</span>]) print <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span>.hsc($data[<span class="stringliteral">&#39;url&#39;</span>]).<span class="stringliteral">&#39;&quot; title=&quot;&#39;</span>.$lang[<span class="stringliteral">&#39;mediaview&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>;
<a name="l00977"></a>00977     print <span class="stringliteral">&#39;&lt;img &#39;</span>.$p.<span class="stringliteral">&#39;/&gt;&#39;</span>;
<a name="l00978"></a>00978     <span class="keywordflow">if</span>($data[<span class="stringliteral">&#39;url&#39;</span>]) print <span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;
<a name="l00979"></a>00979     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00988"></a>00988 function tpl_indexerWebBug(){
<a name="l00989"></a>00989     global $ID;
<a name="l00990"></a>00990     global $INFO;
<a name="l00991"></a>00991     <span class="keywordflow">if</span>(!$INFO[<span class="stringliteral">&#39;exists&#39;</span>]) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     $p = array();
<a name="l00994"></a>00994     $p[<span class="stringliteral">&#39;src&#39;</span>]    = DOKU_BASE.<span class="stringliteral">&#39;lib/exe/indexer.php?id=&#39;</span>.rawurlencode($ID).
<a name="l00995"></a>00995         <span class="charliteral">&#39;&amp;&#39;</span>.time();
<a name="l00996"></a>00996     $p[<span class="stringliteral">&#39;width&#39;</span>]  = 2; <span class="comment">//no more 1x1 px image because we live in times of ad blockers...</span>
<a name="l00997"></a>00997     $p[<span class="stringliteral">&#39;height&#39;</span>] = 1;
<a name="l00998"></a>00998     $p[<span class="stringliteral">&#39;alt&#39;</span>]    = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00999"></a>00999     $att = buildAttributes($p);
<a name="l01000"></a>01000     print <span class="stringliteral">&quot;&lt;img $att /&gt;&quot;</span>;
<a name="l01001"></a>01001     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="comment">// configuration methods</span>
<a name="l01010"></a>01010 <span class="comment"></span>function tpl_getConf($id){
<a name="l01011"></a>01011     global $conf;
<a name="l01012"></a>01012     <span class="keyword">static</span> $tpl_configloaded = <span class="keyword">false</span>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     $tpl = $conf[<span class="stringliteral">&#39;template&#39;</span>];
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (!$tpl_configloaded){
<a name="l01017"></a>01017         $tconf = tpl_loadConfig();
<a name="l01018"></a>01018         <span class="keywordflow">if</span> ($tconf !== <span class="keyword">false</span>){
<a name="l01019"></a>01019             <span class="keywordflow">foreach</span> ($tconf as $key =&gt; $value){
<a name="l01020"></a>01020                 <span class="keywordflow">if</span> (isset($conf[<span class="stringliteral">&#39;tpl&#39;</span>][$tpl][$key])) <span class="keywordflow">continue</span>;
<a name="l01021"></a>01021                 $conf[<span class="stringliteral">&#39;tpl&#39;</span>][$tpl][$key] = $value;
<a name="l01022"></a>01022             }
<a name="l01023"></a>01023             $tpl_configloaded = <span class="keyword">true</span>;
<a name="l01024"></a>01024         }
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027     <span class="keywordflow">return</span> $conf[<span class="stringliteral">&#39;tpl&#39;</span>][$tpl][$id];
<a name="l01028"></a>01028 }
<a name="l01029"></a>01029 
<a name="l01035"></a>01035 function tpl_loadConfig(){
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     $file = DOKU_TPLINC.<span class="stringliteral">&#39;/conf/default.php&#39;</span>;
<a name="l01038"></a>01038     $conf = array();
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <span class="keywordflow">if</span> (!@file_exists($file)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="comment">// load default config file</span>
<a name="l01043"></a>01043     include($file);
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="keywordflow">return</span> $conf;
<a name="l01046"></a>01046 }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048 <span class="comment">// language methods</span>
<a name="l01054"></a>01054 <span class="comment"></span>function tpl_getLang($id){
<a name="l01055"></a>01055     <span class="keyword">static</span> $lang = array();
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     <span class="keywordflow">if</span> (count($lang) === 0){
<a name="l01058"></a>01058         $path = DOKU_TPLINC.<span class="stringliteral">&#39;lang/&#39;</span>;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060         $lang = array();
<a name="l01061"></a>01061 
<a name="l01062"></a>01062         global $conf;            <span class="comment">// definitely don&#39;t invoke &quot;global $lang&quot;</span>
<a name="l01063"></a>01063         <span class="comment">// don&#39;t include once</span>
<a name="l01064"></a>01064         @include($path.<span class="stringliteral">&#39;en/lang.php&#39;</span>);
<a name="l01065"></a>01065         <span class="keywordflow">if</span> ($conf[<span class="stringliteral">&#39;lang&#39;</span>] != <span class="stringliteral">&#39;en&#39;</span>) @include($path.$conf[<span class="stringliteral">&#39;lang&#39;</span>].<span class="stringliteral">&#39;/lang.php&#39;</span>);
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="keywordflow">return</span> $lang[$id];
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01084"></a>01084 function tpl_mediaContent($fromajax=<span class="keyword">false</span>){
<a name="l01085"></a>01085     global $IMG;
<a name="l01086"></a>01086     global $AUTH;
<a name="l01087"></a>01087     global $INUSE;
<a name="l01088"></a>01088     global $NS;
<a name="l01089"></a>01089     global $JUMPTO;
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <span class="keywordflow">if</span>(is_array($_REQUEST[<span class="stringliteral">&#39;do&#39;</span>])){
<a name="l01092"></a>01092         $do = array_shift(array_keys($_REQUEST[<span class="stringliteral">&#39;do&#39;</span>]));
<a name="l01093"></a>01093     }<span class="keywordflow">else</span>{
<a name="l01094"></a>01094         $do = $_REQUEST[<span class="stringliteral">&#39;do&#39;</span>];
<a name="l01095"></a>01095     }
<a name="l01096"></a>01096     <span class="keywordflow">if</span>(in_array($do,array(<span class="stringliteral">&#39;save&#39;</span>,<span class="stringliteral">&#39;cancel&#39;</span>))) $do = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="keywordflow">if</span>(!$do){
<a name="l01099"></a>01099         <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">&#39;edit&#39;</span>]){
<a name="l01100"></a>01100             $do = <span class="stringliteral">&#39;metaform&#39;</span>;
<a name="l01101"></a>01101         }elseif(is_array($INUSE)){
<a name="l01102"></a>01102             $do = <span class="stringliteral">&#39;filesinuse&#39;</span>;
<a name="l01103"></a>01103         }<span class="keywordflow">else</span>{
<a name="l01104"></a>01104             $do = <span class="stringliteral">&#39;filelist&#39;</span>;
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="comment">// output the content pane, wrapped in an event.</span>
<a name="l01109"></a>01109     <span class="keywordflow">if</span>(!$fromajax) ptln(<span class="stringliteral">&#39;&lt;div id=&quot;media__content&quot;&gt;&#39;</span>);
<a name="l01110"></a>01110     $data = array( <span class="stringliteral">&#39;do&#39;</span> =&gt; $do);
<a name="l01111"></a>01111     $evt = <span class="keyword">new</span> <a class="code" href="classDoku__Event.html">Doku_Event</a>(<span class="stringliteral">&#39;MEDIAMANAGER_CONTENT_OUTPUT&#39;</span>, $data);
<a name="l01112"></a>01112     <span class="keywordflow">if</span> ($evt-&gt;advise_before()) {
<a name="l01113"></a>01113         $do = $data[<span class="stringliteral">&#39;do&#39;</span>];
<a name="l01114"></a>01114         <span class="keywordflow">if</span>($do == <span class="stringliteral">&#39;filesinuse&#39;</span>){
<a name="l01115"></a>01115             media_filesinuse($INUSE,$IMG);
<a name="l01116"></a>01116         }elseif($do == <span class="stringliteral">&#39;filelist&#39;</span>){
<a name="l01117"></a>01117             media_filelist($NS,$AUTH,$JUMPTO);
<a name="l01118"></a>01118         }elseif($do == <span class="stringliteral">&#39;searchlist&#39;</span>){
<a name="l01119"></a>01119             media_searchlist($_REQUEST[<span class="charliteral">&#39;q&#39;</span>],$NS,$AUTH);
<a name="l01120"></a>01120         }<span class="keywordflow">else</span>{
<a name="l01121"></a>01121             msg(<span class="stringliteral">&#39;Unknown action &#39;</span>.hsc($do),-1);
<a name="l01122"></a>01122         }
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124     $evt-&gt;advise_after();
<a name="l01125"></a>01125     unset($evt);
<a name="l01126"></a>01126     <span class="keywordflow">if</span>(!$fromajax) ptln(<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01137"></a>01137 function tpl_mediaFileList(){
<a name="l01138"></a>01138     global $AUTH;
<a name="l01139"></a>01139     global $NS;
<a name="l01140"></a>01140     global $JUMPTO;
<a name="l01141"></a>01141     global $lang;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143     $opened_tab = $_REQUEST[<span class="stringliteral">&#39;tab_files&#39;</span>];
<a name="l01144"></a>01144     <span class="keywordflow">if</span> (!$opened_tab || !in_array($opened_tab, array(<span class="stringliteral">&#39;files&#39;</span>, <span class="stringliteral">&#39;upload&#39;</span>, <span class="stringliteral">&#39;search&#39;</span>))) $opened_tab = <span class="stringliteral">&#39;files&#39;</span>;
<a name="l01145"></a>01145     <span class="keywordflow">if</span> ($_REQUEST[<span class="stringliteral">&#39;mediado&#39;</span>] == <span class="stringliteral">&#39;update&#39;</span>) $opened_tab = <span class="stringliteral">&#39;upload&#39;</span>;
<a name="l01146"></a>01146 
<a name="l01147"></a>01147     echo <span class="stringliteral">&#39;&lt;h2 class=&quot;a11y&quot;&gt;&#39;</span> . $lang[<span class="stringliteral">&#39;mediaselect&#39;</span>] . <span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>.NL;
<a name="l01148"></a>01148 
<a name="l01149"></a>01149     media_tabs_files($opened_tab);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151     echo <span class="stringliteral">&#39;&lt;div class=&quot;panelHeader&quot;&gt;&#39;</span>.NL;
<a name="l01152"></a>01152     echo <span class="stringliteral">&#39;&lt;h3&gt;&#39;</span>;
<a name="l01153"></a>01153     $tabTitle = ($NS) ? $NS : <span class="charliteral">&#39;[&#39;</span>.$lang[<span class="stringliteral">&#39;mediaroot&#39;</span>].<span class="charliteral">&#39;]&#39;</span>;
<a name="l01154"></a>01154     printf($lang[<span class="stringliteral">&#39;media_&#39;</span> . $opened_tab], <span class="stringliteral">&#39;&lt;strong&gt;&#39;</span>.$tabTitle.<span class="stringliteral">&#39;&lt;/strong&gt;&#39;</span>);
<a name="l01155"></a>01155     echo <span class="stringliteral">&#39;&lt;/h3&gt;&#39;</span>.NL;
<a name="l01156"></a>01156     <span class="keywordflow">if</span> ($opened_tab === <span class="stringliteral">&#39;search&#39;</span> || $opened_tab === <span class="stringliteral">&#39;files&#39;</span>) {
<a name="l01157"></a>01157         media_tab_files_options();
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     echo <span class="stringliteral">&#39;&lt;div class=&quot;panelContent&quot;&gt;&#39;</span>.NL;
<a name="l01162"></a>01162     <span class="keywordflow">if</span> ($opened_tab == <span class="stringliteral">&#39;files&#39;</span>) {
<a name="l01163"></a>01163         media_tab_files($NS,$AUTH,$JUMPTO);
<a name="l01164"></a>01164     } elseif ($opened_tab == <span class="stringliteral">&#39;upload&#39;</span>) {
<a name="l01165"></a>01165         media_tab_upload($NS,$AUTH,$JUMPTO);
<a name="l01166"></a>01166     } elseif ($opened_tab == <span class="stringliteral">&#39;search&#39;</span>) {
<a name="l01167"></a>01167         media_tab_search($NS,$AUTH);
<a name="l01168"></a>01168     }
<a name="l01169"></a>01169     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01170"></a>01170 }
<a name="l01171"></a>01171 
<a name="l01180"></a>01180 function tpl_mediaFileDetails($image, $rev){
<a name="l01181"></a>01181     global $AUTH, $NS, $conf, $DEL, $lang;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183     $removed = (!file_exists(mediaFN($image)) &amp;&amp; file_exists(mediaMetaFN($image, <span class="stringliteral">&#39;.changes&#39;</span>)) &amp;&amp; $conf[<span class="stringliteral">&#39;mediarevisions&#39;</span>]);
<a name="l01184"></a>01184     <span class="keywordflow">if</span> (!$image || (!file_exists(mediaFN($image)) &amp;&amp; !$removed) || $DEL) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01185"></a>01185     <span class="keywordflow">if</span> ($rev &amp;&amp; !file_exists(mediaFN($image, $rev))) $rev = <span class="keyword">false</span>;
<a name="l01186"></a>01186     <span class="keywordflow">if</span> (isset($NS) &amp;&amp; getNS($image) != $NS) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01187"></a>01187     $do = $_REQUEST[<span class="stringliteral">&#39;mediado&#39;</span>];
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     $opened_tab = $_REQUEST[<span class="stringliteral">&#39;tab_details&#39;</span>];
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     $tab_array = array(<span class="stringliteral">&#39;view&#39;</span>);
<a name="l01192"></a>01192     list($ext, $mime) = mimetype($image);
<a name="l01193"></a>01193     <span class="keywordflow">if</span> ($mime == <span class="stringliteral">&#39;image/jpeg&#39;</span>) {
<a name="l01194"></a>01194         $tab_array[] = <span class="stringliteral">&#39;edit&#39;</span>;
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196     <span class="keywordflow">if</span> ($conf[<span class="stringliteral">&#39;mediarevisions&#39;</span>]) {
<a name="l01197"></a>01197         $tab_array[] = <span class="stringliteral">&#39;history&#39;</span>;
<a name="l01198"></a>01198     }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200     <span class="keywordflow">if</span> (!$opened_tab || !in_array($opened_tab, $tab_array)) $opened_tab = <span class="stringliteral">&#39;view&#39;</span>;
<a name="l01201"></a>01201     <span class="keywordflow">if</span> ($_REQUEST[<span class="stringliteral">&#39;edit&#39;</span>]) $opened_tab = <span class="stringliteral">&#39;edit&#39;</span>;
<a name="l01202"></a>01202     <span class="keywordflow">if</span> ($do == <span class="stringliteral">&#39;restore&#39;</span>) $opened_tab = <span class="stringliteral">&#39;view&#39;</span>;
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     media_tabs_details($image, $opened_tab);
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     echo <span class="stringliteral">&#39;&lt;div class=&quot;panelHeader&quot;&gt;&lt;h3&gt;&#39;</span>;
<a name="l01207"></a>01207     list($ext,$mime,$dl) = mimetype($image,<span class="keyword">false</span>);
<a name="l01208"></a>01208     $class = preg_replace(<span class="stringliteral">&#39;/[^_\-a-z0-9]+/i&#39;</span>,<span class="charliteral">&#39;_&#39;</span>,$ext);
<a name="l01209"></a>01209     $class = <span class="stringliteral">&#39;select mediafile mf_&#39;</span>.$class;
<a name="l01210"></a>01210     $tabTitle = <span class="stringliteral">&#39;&lt;strong class=&quot;&#39;</span>.$class.<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$image.<span class="stringliteral">&#39;&lt;/strong&gt;&#39;</span>;
<a name="l01211"></a>01211     <span class="keywordflow">if</span> ($opened_tab === <span class="stringliteral">&#39;view&#39;</span> &amp;&amp; $rev) {
<a name="l01212"></a>01212         printf($lang[<span class="stringliteral">&#39;media_viewold&#39;</span>], $tabTitle, dformat($rev));
<a name="l01213"></a>01213     } <span class="keywordflow">else</span> {
<a name="l01214"></a>01214         printf($lang[<span class="stringliteral">&#39;media_&#39;</span> . $opened_tab], $tabTitle);
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217     echo <span class="stringliteral">&#39;&lt;/h3&gt;&lt;/div&gt;&#39;</span>.NL;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     echo <span class="stringliteral">&#39;&lt;div class=&quot;panelContent&quot;&gt;&#39;</span>.NL;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221     <span class="keywordflow">if</span> ($opened_tab == <span class="stringliteral">&#39;view&#39;</span>) {
<a name="l01222"></a>01222         media_tab_view($image, $NS, $AUTH, $rev);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     } elseif ($opened_tab == <span class="stringliteral">&#39;edit&#39;</span> &amp;&amp; !$removed) {
<a name="l01225"></a>01225         media_tab_edit($image, $NS, $AUTH);
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     } elseif ($opened_tab == <span class="stringliteral">&#39;history&#39;</span> &amp;&amp; $conf[<span class="stringliteral">&#39;mediarevisions&#39;</span>]) {
<a name="l01228"></a>01228         media_tab_history($image,$NS,$AUTH);
<a name="l01229"></a>01229     }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01232"></a>01232 }
<a name="l01233"></a>01233 
<a name="l01241"></a>01241 function tpl_mediaTree(){
<a name="l01242"></a>01242     global $NS;
<a name="l01243"></a>01243     ptln(<span class="stringliteral">&#39;&lt;div id=&quot;media__tree&quot;&gt;&#39;</span>);
<a name="l01244"></a>01244     media_nstree($NS);
<a name="l01245"></a>01245     ptln(<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>);
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 
<a name="l01256"></a>01256 function tpl_actiondropdown($empty=<span class="stringliteral">&#39;&#39;</span>,$button=<span class="stringliteral">&#39;&amp;gt;&#39;</span>){
<a name="l01257"></a>01257     global $ID;
<a name="l01258"></a>01258     global $INFO;
<a name="l01259"></a>01259     global $REV;
<a name="l01260"></a>01260     global $ACT;
<a name="l01261"></a>01261     global $conf;
<a name="l01262"></a>01262     global $lang;
<a name="l01263"></a>01263     global $auth;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     echo <span class="stringliteral">&#39;&lt;form action=&quot;&#39;</span> . DOKU_SCRIPT . <span class="stringliteral">&#39;&quot; method=&quot;post&quot; accept-charset=&quot;utf-8&quot;&gt;&#39;</span>;
<a name="l01266"></a>01266     echo <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;&#39;</span>.$ID.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l01267"></a>01267     <span class="keywordflow">if</span>($REV) echo <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;rev&quot; value=&quot;&#39;</span>.$REV.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l01268"></a>01268     echo <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;sectok&quot; value=&quot;&#39;</span>.getSecurityToken().<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270     echo <span class="stringliteral">&#39;&lt;select name=&quot;do&quot; class=&quot;edit quickselect&quot;&gt;&#39;</span>;
<a name="l01271"></a>01271     echo <span class="stringliteral">&#39;&lt;option value=&quot;&quot;&gt;&#39;</span>.$empty.<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     echo <span class="stringliteral">&#39;&lt;optgroup label=&quot; &amp;mdash; &quot;&gt;&#39;</span>;
<a name="l01274"></a>01274         $act = tpl_get_action(<span class="stringliteral">&#39;edit&#39;</span>);
<a name="l01275"></a>01275         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277         $act = tpl_get_action(<span class="stringliteral">&#39;revisions&#39;</span>);
<a name="l01278"></a>01278         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01279"></a>01279 
<a name="l01280"></a>01280         $act = tpl_get_action(<span class="stringliteral">&#39;revert&#39;</span>);
<a name="l01281"></a>01281         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01282"></a>01282 
<a name="l01283"></a>01283         $act = tpl_get_action(<span class="stringliteral">&#39;backlink&#39;</span>);
<a name="l01284"></a>01284         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01285"></a>01285     echo <span class="stringliteral">&#39;&lt;/optgroup&gt;&#39;</span>;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287     echo <span class="stringliteral">&#39;&lt;optgroup label=&quot; &amp;mdash; &quot;&gt;&#39;</span>;
<a name="l01288"></a>01288         $act = tpl_get_action(<span class="stringliteral">&#39;recent&#39;</span>);
<a name="l01289"></a>01289         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01290"></a>01290 
<a name="l01291"></a>01291         $act = tpl_get_action(<span class="stringliteral">&#39;index&#39;</span>);
<a name="l01292"></a>01292         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01293"></a>01293     echo <span class="stringliteral">&#39;&lt;/optgroup&gt;&#39;</span>;
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     echo <span class="stringliteral">&#39;&lt;optgroup label=&quot; &amp;mdash; &quot;&gt;&#39;</span>;
<a name="l01296"></a>01296         $act = tpl_get_action(<span class="stringliteral">&#39;login&#39;</span>);
<a name="l01297"></a>01297         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01298"></a>01298 
<a name="l01299"></a>01299         $act = tpl_get_action(<span class="stringliteral">&#39;profile&#39;</span>);
<a name="l01300"></a>01300         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302         $act = tpl_get_action(<span class="stringliteral">&#39;subscribe&#39;</span>);
<a name="l01303"></a>01303         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305         $act = tpl_get_action(<span class="stringliteral">&#39;admin&#39;</span>);
<a name="l01306"></a>01306         <span class="keywordflow">if</span>($act) echo <span class="stringliteral">&#39;&lt;option value=&quot;&#39;</span>.$act[<span class="stringliteral">&#39;params&#39;</span>][<span class="stringliteral">&#39;do&#39;</span>].<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_&#39;</span>.$act[<span class="stringliteral">&#39;type&#39;</span>]].<span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>;
<a name="l01307"></a>01307     echo <span class="stringliteral">&#39;&lt;/optgroup&gt;&#39;</span>;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     echo <span class="stringliteral">&#39;&lt;/select&gt;&#39;</span>;
<a name="l01310"></a>01310     echo <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; value=&quot;&#39;</span>.$button.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;
<a name="l01311"></a>01311     echo <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l01312"></a>01312 }
<a name="l01313"></a>01313 
<a name="l01321"></a>01321 function tpl_license($img=<span class="stringliteral">&#39;badge&#39;</span>,$imgonly=<span class="keyword">false</span>,$return=<span class="keyword">false</span>){
<a name="l01322"></a>01322     global $license;
<a name="l01323"></a>01323     global $conf;
<a name="l01324"></a>01324     global $lang;
<a name="l01325"></a>01325     <span class="keywordflow">if</span>(!$conf[<span class="stringliteral">&#39;license&#39;</span>]) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01326"></a>01326     <span class="keywordflow">if</span>(!is_array($license[$conf[<span class="stringliteral">&#39;license&#39;</span>]])) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01327"></a>01327     $lic = $license[$conf[<span class="stringliteral">&#39;license&#39;</span>]];
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     $out  = <span class="stringliteral">&#39;&lt;div class=&quot;license&quot;&gt;&#39;</span>;
<a name="l01330"></a>01330     <span class="keywordflow">if</span>($img){
<a name="l01331"></a>01331         $src = license_img($img);
<a name="l01332"></a>01332         <span class="keywordflow">if</span>($src){
<a name="l01333"></a>01333             $out .= <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span>.$lic[<span class="stringliteral">&#39;url&#39;</span>].<span class="stringliteral">&#39;&quot; rel=&quot;license&quot;&#39;</span>;
<a name="l01334"></a>01334             <span class="keywordflow">if</span>($conf[<span class="stringliteral">&#39;target&#39;</span>][<span class="stringliteral">&#39;extern&#39;</span>]) $out .= <span class="stringliteral">&#39; target=&quot;&#39;</span>.$conf[<span class="stringliteral">&#39;target&#39;</span>][<span class="stringliteral">&#39;extern&#39;</span>].<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01335"></a>01335             $out .= <span class="stringliteral">&#39;&gt;&lt;img src=&quot;&#39;</span>.DOKU_BASE.$src.<span class="stringliteral">&#39;&quot; class=&quot;medialeft lic&#39;</span>.$img.<span class="stringliteral">&#39;&quot; alt=&quot;&#39;</span>.$lic[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39;&quot; /&gt;&lt;/a&gt; &#39;</span>;
<a name="l01336"></a>01336         }
<a name="l01337"></a>01337     }
<a name="l01338"></a>01338     <span class="keywordflow">if</span>(!$imgonly) {
<a name="l01339"></a>01339         $out .= $lang[<span class="stringliteral">&#39;license&#39;</span>];
<a name="l01340"></a>01340         $out .= <span class="stringliteral">&#39; &lt;a href=&quot;&#39;</span>.$lic[<span class="stringliteral">&#39;url&#39;</span>].<span class="stringliteral">&#39;&quot; rel=&quot;license&quot; class=&quot;urlextern&quot;&#39;</span>;
<a name="l01341"></a>01341         <span class="keywordflow">if</span>($conf[<span class="stringliteral">&#39;target&#39;</span>][<span class="stringliteral">&#39;extern&#39;</span>]) $out .= <span class="stringliteral">&#39; target=&quot;&#39;</span>.$conf[<span class="stringliteral">&#39;target&#39;</span>][<span class="stringliteral">&#39;extern&#39;</span>].<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l01342"></a>01342         $out .= <span class="charliteral">&#39;&gt;&#39;</span>.$lic[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;
<a name="l01343"></a>01343     }
<a name="l01344"></a>01344     $out .= <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346     <span class="keywordflow">if</span>($return) <span class="keywordflow">return</span> $out;
<a name="l01347"></a>01347     echo $out;
<a name="l01348"></a>01348 }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350 
<a name="l01357"></a>01357 function tpl_include_page($pageid,$print=<span class="keyword">true</span>){
<a name="l01358"></a>01358     global $ID;
<a name="l01359"></a>01359     global $TOC;
<a name="l01360"></a>01360     $oldid  = $ID;
<a name="l01361"></a>01361     $oldtoc = $TOC;
<a name="l01362"></a>01362     $html = p_wiki_xhtml($pageid,<span class="stringliteral">&#39;&#39;</span>,<span class="keyword">false</span>);
<a name="l01363"></a>01363     $ID  = $oldid;
<a name="l01364"></a>01364     $TOC = $oldtoc;
<a name="l01365"></a>01365 
<a name="l01366"></a>01366     <span class="keywordflow">if</span>(!$print) <span class="keywordflow">return</span> $html;
<a name="l01367"></a>01367     echo $html;
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01375"></a>01375 function tpl_subscribe() {
<a name="l01376"></a>01376     global $INFO;
<a name="l01377"></a>01377     global $ID;
<a name="l01378"></a>01378     global $lang;
<a name="l01379"></a>01379     global $conf;
<a name="l01380"></a>01380     $stime_days = $conf[<span class="stringliteral">&#39;subscribe_time&#39;</span>]/60/60/24;
<a name="l01381"></a>01381 
<a name="l01382"></a>01382     echo p_locale_xhtml(<span class="stringliteral">&#39;subscr_form&#39;</span>);
<a name="l01383"></a>01383     echo <span class="stringliteral">&#39;&lt;h2&gt;&#39;</span> . $lang[<span class="stringliteral">&#39;subscr_m_current_header&#39;</span>] . <span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>;
<a name="l01384"></a>01384     echo <span class="stringliteral">&#39;&lt;div class=&quot;level2&quot;&gt;&#39;</span>;
<a name="l01385"></a>01385     <span class="keywordflow">if</span> ($INFO[<span class="stringliteral">&#39;subscribed&#39;</span>] === <span class="keyword">false</span>) {
<a name="l01386"></a>01386         echo <span class="stringliteral">&#39;&lt;p&gt;&#39;</span> . $lang[<span class="stringliteral">&#39;subscr_m_not_subscribed&#39;</span>] . <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span>;
<a name="l01387"></a>01387     } <span class="keywordflow">else</span> {
<a name="l01388"></a>01388         echo <span class="stringliteral">&#39;&lt;ul&gt;&#39;</span>;
<a name="l01389"></a>01389         <span class="keywordflow">foreach</span>($INFO[<span class="stringliteral">&#39;subscribed&#39;</span>] as $sub) {
<a name="l01390"></a>01390             echo <span class="stringliteral">&#39;&lt;li&gt;&lt;div class=&quot;li&quot;&gt;&#39;</span>;
<a name="l01391"></a>01391             <span class="keywordflow">if</span> ($sub[<span class="stringliteral">&#39;target&#39;</span>] !== $ID) {
<a name="l01392"></a>01392                 echo <span class="stringliteral">&#39;&lt;code class=&quot;ns&quot;&gt;&#39;</span>.hsc(prettyprint_id($sub[<span class="stringliteral">&#39;target&#39;</span>])).<span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>;
<a name="l01393"></a>01393             } <span class="keywordflow">else</span> {
<a name="l01394"></a>01394                 echo <span class="stringliteral">&#39;&lt;code class=&quot;page&quot;&gt;&#39;</span>.hsc(prettyprint_id($sub[<span class="stringliteral">&#39;target&#39;</span>])).<span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>;
<a name="l01395"></a>01395             }
<a name="l01396"></a>01396             $sstl = sprintf($lang[<span class="stringliteral">&#39;subscr_style_&#39;</span>.$sub[<span class="stringliteral">&#39;style&#39;</span>]], $stime_days);
<a name="l01397"></a>01397             <span class="keywordflow">if</span>(!$sstl) $sstl = hsc($sub[<span class="stringliteral">&#39;style&#39;</span>]);
<a name="l01398"></a>01398             echo <span class="stringliteral">&#39; (&#39;</span>.$sstl.<span class="stringliteral">&#39;) &#39;</span>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400             echo <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span> . wl($ID,
<a name="l01401"></a>01401                                   array(<span class="stringliteral">&#39;do&#39;</span>=&gt;<span class="stringliteral">&#39;subscribe&#39;</span>,
<a name="l01402"></a>01402                                         <span class="stringliteral">&#39;sub_target&#39;</span>=&gt;$sub[<span class="stringliteral">&#39;target&#39;</span>],
<a name="l01403"></a>01403                                         <span class="stringliteral">&#39;sub_style&#39;</span>=&gt;$sub[<span class="stringliteral">&#39;style&#39;</span>],
<a name="l01404"></a>01404                                         <span class="stringliteral">&#39;sub_action&#39;</span>=&gt;<span class="stringliteral">&#39;unsubscribe&#39;</span>,
<a name="l01405"></a>01405                                         <span class="stringliteral">&#39;sectok&#39;</span> =&gt; getSecurityToken())) .
<a name="l01406"></a>01406                  <span class="stringliteral">&#39;&quot; class=&quot;unsubscribe&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;subscr_m_unsubscribe&#39;</span>] .
<a name="l01407"></a>01407                  <span class="stringliteral">&#39;&lt;/a&gt;&lt;/div&gt;&lt;/li&gt;&#39;</span>;
<a name="l01408"></a>01408         }
<a name="l01409"></a>01409         echo <span class="stringliteral">&#39;&lt;/ul&gt;&#39;</span>;
<a name="l01410"></a>01410     }
<a name="l01411"></a>01411     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l01412"></a>01412 
<a name="l01413"></a>01413     <span class="comment">// Add new subscription form</span>
<a name="l01414"></a>01414     echo <span class="stringliteral">&#39;&lt;h2&gt;&#39;</span> . $lang[<span class="stringliteral">&#39;subscr_m_new_header&#39;</span>] . <span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>;
<a name="l01415"></a>01415     echo <span class="stringliteral">&#39;&lt;div class=&quot;level2&quot;&gt;&#39;</span>;
<a name="l01416"></a>01416     $ns = getNS($ID).<span class="charliteral">&#39;:&#39;</span>;
<a name="l01417"></a>01417     $targets = array(
<a name="l01418"></a>01418             $ID =&gt; <span class="stringliteral">&#39;&lt;code class=&quot;page&quot;&gt;&#39;</span>.prettyprint_id($ID).<span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>,
<a name="l01419"></a>01419             $ns =&gt; <span class="stringliteral">&#39;&lt;code class=&quot;ns&quot;&gt;&#39;</span>.prettyprint_id($ns).<span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>,
<a name="l01420"></a>01420             );
<a name="l01421"></a>01421     $styles = array(
<a name="l01422"></a>01422             <span class="stringliteral">&#39;every&#39;</span>  =&gt; $lang[<span class="stringliteral">&#39;subscr_style_every&#39;</span>],
<a name="l01423"></a>01423             <span class="stringliteral">&#39;digest&#39;</span> =&gt; sprintf($lang[<span class="stringliteral">&#39;subscr_style_digest&#39;</span>], $stime_days),
<a name="l01424"></a>01424             <span class="stringliteral">&#39;list&#39;</span> =&gt; sprintf($lang[<span class="stringliteral">&#39;subscr_style_list&#39;</span>], $stime_days),
<a name="l01425"></a>01425             );
<a name="l01426"></a>01426 
<a name="l01427"></a>01427     $form = <span class="keyword">new</span> <a class="code" href="classDoku__Form.html" title="Class for creating simple HTML forms.">Doku_Form</a>(array(<span class="stringliteral">&#39;id&#39;</span> =&gt; <span class="stringliteral">&#39;subscribe__form&#39;</span>));
<a name="l01428"></a>01428     $form-&gt;startFieldset($lang[<span class="stringliteral">&#39;subscr_m_subscribe&#39;</span>]);
<a name="l01429"></a>01429     $form-&gt;addRadioSet(<span class="stringliteral">&#39;sub_target&#39;</span>, $targets);
<a name="l01430"></a>01430     $form-&gt;startFieldset($lang[<span class="stringliteral">&#39;subscr_m_receive&#39;</span>]);
<a name="l01431"></a>01431     $form-&gt;addRadioSet(<span class="stringliteral">&#39;sub_style&#39;</span>, $styles);
<a name="l01432"></a>01432     $form-&gt;addHidden(<span class="stringliteral">&#39;sub_action&#39;</span>, <span class="stringliteral">&#39;subscribe&#39;</span>);
<a name="l01433"></a>01433     $form-&gt;addHidden(<span class="stringliteral">&#39;do&#39;</span>, <span class="stringliteral">&#39;subscribe&#39;</span>);
<a name="l01434"></a>01434     $form-&gt;addHidden(<span class="stringliteral">&#39;id&#39;</span>, $ID);
<a name="l01435"></a>01435     $form-&gt;endFieldset();
<a name="l01436"></a>01436     $form-&gt;addElement(form_makeButton(<span class="stringliteral">&#39;submit&#39;</span>, <span class="stringliteral">&#39;subscribe&#39;</span>, $lang[<span class="stringliteral">&#39;subscr_m_subscribe&#39;</span>]));
<a name="l01437"></a>01437     html_form(<span class="stringliteral">&#39;SUBSCRIBE&#39;</span>, $form);
<a name="l01438"></a>01438     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l01439"></a>01439 }
<a name="l01440"></a>01440 
<a name="l01448"></a>01448 function tpl_flush(){
<a name="l01449"></a>01449     ob_flush();
<a name="l01450"></a>01450     flush();
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453 
<a name="l01462"></a>01462 function tpl_getFavicon($abs=<span class="keyword">false</span>, $fileName=<span class="stringliteral">&#39;favicon.ico&#39;</span>) {
<a name="l01463"></a>01463     <span class="keywordflow">if</span> (file_exists(mediaFN($fileName))) {
<a name="l01464"></a>01464         <span class="keywordflow">return</span> ml($fileName, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">true</span>, <span class="stringliteral">&#39;&#39;</span>, $abs);
<a name="l01465"></a>01465     }
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="keywordflow">if</span>($abs) {
<a name="l01468"></a>01468         <span class="keywordflow">return</span> DOKU_URL.substr(DOKU_TPL.<span class="stringliteral">&#39;images/&#39;</span>.$fileName, strlen(DOKU_REL));
<a name="l01469"></a>01469     }
<a name="l01470"></a>01470     <span class="keywordflow">return</span> DOKU_TPL.<span class="stringliteral">&#39;images/&#39;</span>.$fileName;
<a name="l01471"></a>01471 }
<a name="l01472"></a>01472 
<a name="l01479"></a>01479 function tpl_favicon($types=array(<span class="stringliteral">&#39;favicon&#39;</span>)) {
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     $return = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01482"></a>01482 
<a name="l01483"></a>01483     <span class="keywordflow">foreach</span> ($types as $type) {
<a name="l01484"></a>01484         <span class="keywordflow">switch</span>($type) {
<a name="l01485"></a>01485             <span class="keywordflow">case</span> <span class="stringliteral">&#39;favicon&#39;</span>:
<a name="l01486"></a>01486                 $return .= <span class="stringliteral">&#39;&lt;link rel=&quot;shortcut icon&quot; href=&quot;&#39;</span>.tpl_getFavicon().<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>.NL;
<a name="l01487"></a>01487                 <span class="keywordflow">break</span>;
<a name="l01488"></a>01488             <span class="keywordflow">case</span> <span class="stringliteral">&#39;mobile&#39;</span>:
<a name="l01489"></a>01489                 $return .= <span class="stringliteral">&#39;&lt;link rel=&quot;apple-touch-icon&quot; href=&quot;&#39;</span>.tpl_getFavicon(<span class="keyword">false</span>, <span class="stringliteral">&#39;apple-touch-icon.png&#39;</span>).<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>.NL;
<a name="l01490"></a>01490                 <span class="keywordflow">break</span>;
<a name="l01491"></a>01491             <span class="keywordflow">case</span> <span class="stringliteral">&#39;generic&#39;</span>:
<a name="l01492"></a>01492                 <span class="comment">// ideal world solution, which doesn&#39;t work in any browser yet</span>
<a name="l01493"></a>01493                 $return .= <span class="stringliteral">&#39;&lt;link rel=&quot;icon&quot; href=&quot;&#39;</span>.tpl_getFavicon(<span class="keyword">false</span>, <span class="stringliteral">&#39;icon.svg&#39;</span>).<span class="stringliteral">&#39;&quot; type=&quot;image/svg+xml&quot; /&gt;&#39;</span>.NL;
<a name="l01494"></a>01494                 <span class="keywordflow">break</span>;
<a name="l01495"></a>01495         }
<a name="l01496"></a>01496     }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498     <span class="keywordflow">return</span> $return;
<a name="l01499"></a>01499 }
<a name="l01500"></a>01500 
<a name="l01506"></a>01506 function tpl_media() {
<a name="l01507"></a>01507     global $DEL, $NS, $IMG, $AUTH, $JUMPTO, $REV, $lang, $fullscreen, $conf;
<a name="l01508"></a>01508     $fullscreen = <span class="keyword">true</span>;
<a name="l01509"></a>01509     require_once DOKU_INC.<span class="stringliteral">&#39;lib/exe/mediamanager.php&#39;</span>;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="keywordflow">if</span> ($_REQUEST[<span class="stringliteral">&#39;image&#39;</span>]) $image = cleanID($_REQUEST[<span class="stringliteral">&#39;image&#39;</span>]);
<a name="l01512"></a>01512     <span class="keywordflow">if</span> (isset($IMG)) $image = $IMG;
<a name="l01513"></a>01513     <span class="keywordflow">if</span> (isset($JUMPTO)) $image = $JUMPTO;
<a name="l01514"></a>01514     <span class="keywordflow">if</span> (isset($REV) &amp;&amp; !$JUMPTO) $rev = $REV;
<a name="l01515"></a>01515 
<a name="l01516"></a>01516     echo <span class="stringliteral">&#39;&lt;div id=&quot;mediamanager__page&quot;&gt;&#39;</span>.NL;
<a name="l01517"></a>01517     echo <span class="stringliteral">&#39;&lt;h1&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;btn_media&#39;</span>].<span class="stringliteral">&#39;&lt;/h1&gt;&#39;</span>.NL;
<a name="l01518"></a>01518     html_msgarea();
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     echo <span class="stringliteral">&#39;&lt;div class=&quot;panel namespaces&quot;&gt;&#39;</span>.NL;
<a name="l01521"></a>01521     echo <span class="stringliteral">&#39;&lt;h2&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;namespaces&#39;</span>].<span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>.NL;
<a name="l01522"></a>01522     echo <span class="stringliteral">&#39;&lt;div class=&quot;panelHeader&quot;&gt;&#39;</span>;
<a name="l01523"></a>01523     echo $lang[<span class="stringliteral">&#39;media_namespaces&#39;</span>];
<a name="l01524"></a>01524     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     echo <span class="stringliteral">&#39;&lt;div class=&quot;panelContent&quot; id=&quot;media__tree&quot;&gt;&#39;</span>.NL;
<a name="l01527"></a>01527     media_nstree($NS);
<a name="l01528"></a>01528     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01529"></a>01529     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     echo <span class="stringliteral">&#39;&lt;div class=&quot;panel filelist&quot;&gt;&#39;</span>.NL;
<a name="l01532"></a>01532     tpl_mediaFileList();
<a name="l01533"></a>01533     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     echo <span class="stringliteral">&#39;&lt;div class=&quot;panel file&quot;&gt;&#39;</span>.NL;
<a name="l01536"></a>01536     echo <span class="stringliteral">&#39;&lt;h2 class=&quot;a11y&quot;&gt;&#39;</span>.$lang[<span class="stringliteral">&#39;media_file&#39;</span>].<span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>.NL;
<a name="l01537"></a>01537     tpl_mediaFileDetails($image, $rev);
<a name="l01538"></a>01538     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     echo <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.NL;
<a name="l01541"></a>01541 }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543 <span class="comment">//Setup VIM: ex: et ts=4 :</span>
<a name="l01544"></a>01544 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
