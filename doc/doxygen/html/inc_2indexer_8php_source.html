<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: web/wiki/inc/indexer.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>web/wiki/inc/indexer.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00010"></a>00010 <span class="keywordflow">if</span>(!defined(<span class="stringliteral">&#39;DOKU_INC&#39;</span>)) die(<span class="stringliteral">&#39;meh.&#39;</span>);
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">// Version tag used to force rebuild on upgrade</span>
<a name="l00013"></a>00013 define(<span class="stringliteral">&#39;INDEXER_VERSION&#39;</span>, 5);
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">// set the minimum token length to use in the index (note, this doesn&#39;t apply to numeric tokens)</span>
<a name="l00016"></a>00016 <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;IDX_MINWORDLENGTH&#39;</span>)) define(<span class="stringliteral">&#39;IDX_MINWORDLENGTH&#39;</span>,2);
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">// Asian characters are handled as words. The following regexp defines the</span>
<a name="l00019"></a>00019 <span class="comment">// Unicode-Ranges for Asian characters</span>
<a name="l00020"></a>00020 <span class="comment">// Ranges taken from http://en.wikipedia.org/wiki/Unicode_block</span>
<a name="l00021"></a>00021 <span class="comment">// I&#39;m no language expert. If you think some ranges are wrongly chosen or</span>
<a name="l00022"></a>00022 <span class="comment">// a range is missing, please contact me</span>
<a name="l00023"></a>00023 define(<span class="stringliteral">&#39;IDX_ASIAN1&#39;</span>,<span class="stringliteral">&#39;[\x{0E00}-\x{0E7F}]&#39;</span>); <span class="comment">// Thai</span>
<a name="l00024"></a>00024 define(<span class="stringliteral">&#39;IDX_ASIAN2&#39;</span>,<span class="charliteral">&#39;[&#39;</span>.
<a name="l00025"></a>00025                    <span class="stringliteral">&#39;\x{2E80}-\x{3040}&#39;</span>.  <span class="comment">// CJK -&gt; Hangul</span>
<a name="l00026"></a>00026                    <span class="stringliteral">&#39;\x{309D}-\x{30A0}&#39;</span>.
<a name="l00027"></a>00027                    <span class="stringliteral">&#39;\x{30FD}-\x{31EF}\x{3200}-\x{D7AF}&#39;</span>.
<a name="l00028"></a>00028                    <span class="stringliteral">&#39;\x{F900}-\x{FAFF}&#39;</span>.  <span class="comment">// CJK Compatibility Ideographs</span>
<a name="l00029"></a>00029                    <span class="stringliteral">&#39;\x{FE30}-\x{FE4F}&#39;</span>.  <span class="comment">// CJK Compatibility Forms</span>
<a name="l00030"></a>00030                    <span class="stringliteral">&quot;\xF0\xA0\x80\x80-\xF0\xAA\x9B\x9F&quot;</span>. <span class="comment">// CJK Extension B</span>
<a name="l00031"></a>00031                    <span class="stringliteral">&quot;\xF0\xAA\x9C\x80-\xF0\xAB\x9C\xBF&quot;</span>. <span class="comment">// CJK Extension C</span>
<a name="l00032"></a>00032                    <span class="stringliteral">&quot;\xF0\xAB\x9D\x80-\xF0\xAB\xA0\x9F&quot;</span>. <span class="comment">// CJK Extension D</span>
<a name="l00033"></a>00033                    <span class="stringliteral">&quot;\xF0\xAF\xA0\x80-\xF0\xAF\xAB\xBF&quot;</span>. <span class="comment">// CJK Compatibility Supplement</span>
<a name="l00034"></a>00034                    <span class="charliteral">&#39;]&#39;</span>);
<a name="l00035"></a>00035 define(<span class="stringliteral">&#39;IDX_ASIAN3&#39;</span>,<span class="charliteral">&#39;[&#39;</span>.                <span class="comment">// Hiragana/Katakana (can be two characters)</span>
<a name="l00036"></a>00036                    <span class="stringliteral">&#39;\x{3042}\x{3044}\x{3046}\x{3048}&#39;</span>.
<a name="l00037"></a>00037                    <span class="stringliteral">&#39;\x{304A}-\x{3062}\x{3064}-\x{3082}&#39;</span>.
<a name="l00038"></a>00038                    <span class="stringliteral">&#39;\x{3084}\x{3086}\x{3088}-\x{308D}&#39;</span>.
<a name="l00039"></a>00039                    <span class="stringliteral">&#39;\x{308F}-\x{3094}&#39;</span>.
<a name="l00040"></a>00040                    <span class="stringliteral">&#39;\x{30A2}\x{30A4}\x{30A6}\x{30A8}&#39;</span>.
<a name="l00041"></a>00041                    <span class="stringliteral">&#39;\x{30AA}-\x{30C2}\x{30C4}-\x{30E2}&#39;</span>.
<a name="l00042"></a>00042                    <span class="stringliteral">&#39;\x{30E4}\x{30E6}\x{30E8}-\x{30ED}&#39;</span>.
<a name="l00043"></a>00043                    <span class="stringliteral">&#39;\x{30EF}-\x{30F4}\x{30F7}-\x{30FA}&#39;</span>.
<a name="l00044"></a>00044                    <span class="stringliteral">&#39;][&#39;</span>.
<a name="l00045"></a>00045                    <span class="stringliteral">&#39;\x{3041}\x{3043}\x{3045}\x{3047}\x{3049}&#39;</span>.
<a name="l00046"></a>00046                    <span class="stringliteral">&#39;\x{3063}\x{3083}\x{3085}\x{3087}\x{308E}\x{3095}-\x{309C}&#39;</span>.
<a name="l00047"></a>00047                    <span class="stringliteral">&#39;\x{30A1}\x{30A3}\x{30A5}\x{30A7}\x{30A9}&#39;</span>.
<a name="l00048"></a>00048                    <span class="stringliteral">&#39;\x{30C3}\x{30E3}\x{30E5}\x{30E7}\x{30EE}\x{30F5}\x{30F6}\x{30FB}\x{30FC}&#39;</span>.
<a name="l00049"></a>00049                    <span class="stringliteral">&#39;\x{31F0}-\x{31FF}&#39;</span>.
<a name="l00050"></a>00050                    <span class="stringliteral">&#39;]?&#39;</span>);
<a name="l00051"></a>00051 define(<span class="stringliteral">&#39;IDX_ASIAN&#39;</span>, <span class="stringliteral">&#39;(?:&#39;</span>.IDX_ASIAN1.<span class="charliteral">&#39;|&#39;</span>.IDX_ASIAN2.<span class="charliteral">&#39;|&#39;</span>.IDX_ASIAN3.<span class="charliteral">&#39;)&#39;</span>);
<a name="l00052"></a>00052 
<a name="l00065"></a>00065 function idx_get_version(){
<a name="l00066"></a>00066     <span class="keyword">static</span> $indexer_version = null;
<a name="l00067"></a>00067     <span class="keywordflow">if</span> ($indexer_version == null) {
<a name="l00068"></a>00068         global $conf;
<a name="l00069"></a>00069         $version = INDEXER_VERSION;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071         <span class="comment">// DokuWiki version is included for the convenience of plugins</span>
<a name="l00072"></a>00072         $data = array(<span class="stringliteral">&#39;dokuwiki&#39;</span>=&gt;$version);
<a name="l00073"></a>00073         trigger_event(<span class="stringliteral">&#39;INDEXER_VERSION_GET&#39;</span>, $data, null, <span class="keyword">false</span>);
<a name="l00074"></a>00074         unset($data[<span class="stringliteral">&#39;dokuwiki&#39;</span>]); <span class="comment">// this needs to be first</span>
<a name="l00075"></a>00075         ksort($data);
<a name="l00076"></a>00076         <span class="keywordflow">foreach</span> ($data as $plugin=&gt;$vers)
<a name="l00077"></a>00077             $version .= <span class="charliteral">&#39;+&#39;</span>.$plugin.<span class="charliteral">&#39;=&#39;</span>.$vers;
<a name="l00078"></a>00078         $indexer_version = $version;
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080     <span class="keywordflow">return</span> $indexer_version;
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00089"></a>00089 function wordlen($w){
<a name="l00090"></a>00090     $l = strlen($w);
<a name="l00091"></a>00091     <span class="comment">// If left alone, all chinese &quot;words&quot; will get put into w3.idx</span>
<a name="l00092"></a>00092     <span class="comment">// So the &quot;length&quot; of a &quot;word&quot; is faked</span>
<a name="l00093"></a>00093     <span class="keywordflow">if</span>(preg_match_all(<span class="stringliteral">&#39;/[\xE2-\xEF]/&#39;</span>,$w,$leadbytes)) {
<a name="l00094"></a>00094         <span class="keywordflow">foreach</span>($leadbytes[0] as $b)
<a name="l00095"></a>00095             $l += ord($b) - 0xE1;
<a name="l00096"></a>00096     }
<a name="l00097"></a>00097     <span class="keywordflow">return</span> $l;
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00105"></a><a class="code" href="classDoku__Indexer.html">00105</a> <span class="keyword">class </span><a class="code" href="classDoku__Indexer.html" title="Class that encapsulates operations on the indexer database.">Doku_Indexer</a> {
<a name="l00106"></a>00106 
<a name="l00119"></a><a class="code" href="classDoku__Indexer.html#ad2af47c375e68246fb06d70eac41220c">00119</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#ad2af47c375e68246fb06d70eac41220c" title="Adds the contents of a page to the fulltext index.">addPageWords</a>($page, $text) {
<a name="l00120"></a>00120         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a6313bd4e862ceea65808aa3479e2c235" title="Lock the indexer.">lock</a>())
<a name="l00121"></a>00121             <span class="keywordflow">return</span> <span class="stringliteral">&quot;locked&quot;</span>;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="comment">// load known documents</span>
<a name="l00124"></a>00124         $pid = $this-&gt;<a class="code" href="classDoku__Indexer.html#a1d6dd4af8d594078fc99b203ea4580ec" title="Retrieve or insert a value in the index.">addIndexKey</a>(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $page);
<a name="l00125"></a>00125         <span class="keywordflow">if</span> ($pid === <span class="keyword">false</span>) {
<a name="l00126"></a>00126             $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00127"></a>00127             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         $pagewords = array();
<a name="l00131"></a>00131         <span class="comment">// get word usage in page</span>
<a name="l00132"></a>00132         $words = $this-&gt;<a class="code" href="classDoku__Indexer.html#a61ebf2f8bfa400d796ee30e258e88278" title="Split the words in a page and add them to the index.">getPageWords</a>($text);
<a name="l00133"></a>00133         <span class="keywordflow">if</span> ($words === <span class="keyword">false</span>) {
<a name="l00134"></a>00134             $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00135"></a>00135             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         <span class="keywordflow">if</span> (!empty($words)) {
<a name="l00139"></a>00139             <span class="keywordflow">foreach</span> (array_keys($words) as $wlen) {
<a name="l00140"></a>00140                 $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen);
<a name="l00141"></a>00141                 <span class="keywordflow">foreach</span> ($words[$wlen] as $wid =&gt; $freq) {
<a name="l00142"></a>00142                     $idx = ($wid&lt;count($index)) ? $index[$wid] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00143"></a>00143                     $index[$wid] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($idx, $pid, $freq);
<a name="l00144"></a>00144                     $pagewords[] = <span class="stringliteral">&quot;$wlen*$wid&quot;</span>;
<a name="l00145"></a>00145                 }
<a name="l00146"></a>00146                 <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen, $index)) {
<a name="l00147"></a>00147                     $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00148"></a>00148                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00149"></a>00149                 }
<a name="l00150"></a>00150             }
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="comment">// Remove obsolete index entries</span>
<a name="l00154"></a>00154         $pageword_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea" title="Retrieve a line from the index.">getIndexKey</a>(<span class="stringliteral">&#39;pageword&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid);
<a name="l00155"></a>00155         <span class="keywordflow">if</span> ($pageword_idx !== <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00156"></a>00156             $oldwords = explode(<span class="charliteral">&#39;:&#39;</span>,$pageword_idx);
<a name="l00157"></a>00157             $delwords = array_diff($oldwords, $pagewords);
<a name="l00158"></a>00158             $upwords = array();
<a name="l00159"></a>00159             <span class="keywordflow">foreach</span> ($delwords as $word) {
<a name="l00160"></a>00160                 <span class="keywordflow">if</span> ($word != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00161"></a>00161                     list($wlen,$wid) = explode(<span class="charliteral">&#39;*&#39;</span>, $word);
<a name="l00162"></a>00162                     $wid = (int)$wid;
<a name="l00163"></a>00163                     $upwords[$wlen][] = $wid;
<a name="l00164"></a>00164                 }
<a name="l00165"></a>00165             }
<a name="l00166"></a>00166             <span class="keywordflow">foreach</span> ($upwords as $wlen =&gt; $widx) {
<a name="l00167"></a>00167                 $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen);
<a name="l00168"></a>00168                 <span class="keywordflow">foreach</span> ($widx as $wid) {
<a name="l00169"></a>00169                     $index[$wid] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($index[$wid], $pid, 0);
<a name="l00170"></a>00170                 }
<a name="l00171"></a>00171                 $this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen, $index);
<a name="l00172"></a>00172             }
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174         <span class="comment">// Save the reverse index</span>
<a name="l00175"></a>00175         $pageword_idx = join(<span class="charliteral">&#39;:&#39;</span>, $pagewords);
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>(<span class="stringliteral">&#39;pageword&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid, $pageword_idx)) {
<a name="l00177"></a>00177             $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00178"></a>00178             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00182"></a>00182         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 
<a name="l00194"></a><a class="code" href="classDoku__Indexer.html#a61ebf2f8bfa400d796ee30e258e88278">00194</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a61ebf2f8bfa400d796ee30e258e88278" title="Split the words in a page and add them to the index.">getPageWords</a>($text) {
<a name="l00195"></a>00195         global $conf;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197         $tokens = $this-&gt;<a class="code" href="classDoku__Indexer.html#afa73e2a6c31acb56c1cc30b46cf59c7f" title="Split the text into words for fulltext search.">tokenizer</a>($text);
<a name="l00198"></a>00198         $tokens = array_count_values($tokens);  <span class="comment">// count the frequency of each token</span>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         $words = array();
<a name="l00201"></a>00201         <span class="keywordflow">foreach</span> ($tokens as $w=&gt;$c) {
<a name="l00202"></a>00202             $l = wordlen($w);
<a name="l00203"></a>00203             <span class="keywordflow">if</span> (isset($words[$l])){
<a name="l00204"></a>00204                 $words[$l][$w] = $c + (isset($words[$l][$w]) ? $words[$l][$w] : 0);
<a name="l00205"></a>00205             }<span class="keywordflow">else</span>{
<a name="l00206"></a>00206                 $words[$l] = array($w =&gt; $c);
<a name="l00207"></a>00207             }
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">// arrive here with $words = array(wordlen =&gt; array(word =&gt; frequency))</span>
<a name="l00211"></a>00211         $word_idx_modified = <span class="keyword">false</span>;
<a name="l00212"></a>00212         $index = array();   <span class="comment">//resulting index</span>
<a name="l00213"></a>00213         <span class="keywordflow">foreach</span> (array_keys($words) as $wlen) {
<a name="l00214"></a>00214             $word_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;w&#39;</span>, $wlen);
<a name="l00215"></a>00215             <span class="keywordflow">foreach</span> ($words[$wlen] as $word =&gt; $freq) {
<a name="l00216"></a>00216                 $wid = array_search($word, $word_idx);
<a name="l00217"></a>00217                 <span class="keywordflow">if</span> ($wid === <span class="keyword">false</span>) {
<a name="l00218"></a>00218                     $wid = count($word_idx);
<a name="l00219"></a>00219                     $word_idx[] = $word;
<a name="l00220"></a>00220                     $word_idx_modified = <span class="keyword">true</span>;
<a name="l00221"></a>00221                 }
<a name="l00222"></a>00222                 <span class="keywordflow">if</span> (!isset($index[$wlen]))
<a name="l00223"></a>00223                     $index[$wlen] = array();
<a name="l00224"></a>00224                 $index[$wlen][$wid] = $freq;
<a name="l00225"></a>00225             }
<a name="l00226"></a>00226             <span class="comment">// save back the word index</span>
<a name="l00227"></a>00227             <span class="keywordflow">if</span> ($word_idx_modified &amp;&amp; !$this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>(<span class="charliteral">&#39;w&#39;</span>, $wlen, $word_idx))
<a name="l00228"></a>00228                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00229"></a>00229         }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">return</span> $index;
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 
<a name="l00249"></a><a class="code" href="classDoku__Indexer.html#a53bd1abe36882e27968f00713cde9e5d">00249</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#a53bd1abe36882e27968f00713cde9e5d" title="Add/update keys to/of the metadata index.">addMetaKeys</a>($page, $key, $value=null) {
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (!is_array($key)) {
<a name="l00251"></a>00251             $key = array($key =&gt; $value);
<a name="l00252"></a>00252         } elseif (!is_null($value)) {
<a name="l00253"></a>00253             <span class="comment">// $key is array, but $value is not null</span>
<a name="l00254"></a>00254             trigger_error(<span class="stringliteral">&quot;array passed to addMetaKeys but value is not null&quot;</span>, E_USER_WARNING);
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a6313bd4e862ceea65808aa3479e2c235" title="Lock the indexer.">lock</a>())
<a name="l00258"></a>00258             <span class="keywordflow">return</span> <span class="stringliteral">&quot;locked&quot;</span>;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <span class="comment">// load known documents</span>
<a name="l00261"></a>00261         $pid = $this-&gt;<a class="code" href="classDoku__Indexer.html#a1d6dd4af8d594078fc99b203ea4580ec" title="Retrieve or insert a value in the index.">addIndexKey</a>(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $page);
<a name="l00262"></a>00262         <span class="keywordflow">if</span> ($pid === <span class="keyword">false</span>) {
<a name="l00263"></a>00263             $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00264"></a>00264             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         <span class="comment">// Special handling for titles so the index file is simpler</span>
<a name="l00268"></a>00268         <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;title&#39;</span>, $key)) {
<a name="l00269"></a>00269             $value = $key[<span class="stringliteral">&#39;title&#39;</span>];
<a name="l00270"></a>00270             <span class="keywordflow">if</span> (is_array($value))
<a name="l00271"></a>00271                 $value = $value[0];
<a name="l00272"></a>00272             $this-&gt;<a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>(<span class="stringliteral">&#39;title&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid, $value);
<a name="l00273"></a>00273             unset($key[<span class="stringliteral">&#39;title&#39;</span>]);
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <span class="keywordflow">foreach</span> ($key as $name =&gt; $values) {
<a name="l00277"></a>00277             $metaname = idx_cleanName($name);
<a name="l00278"></a>00278             $this-&gt;<a class="code" href="classDoku__Indexer.html#a1d6dd4af8d594078fc99b203ea4580ec" title="Retrieve or insert a value in the index.">addIndexKey</a>(<span class="stringliteral">&#39;metadata&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $metaname);
<a name="l00279"></a>00279             $metaidx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00280"></a>00280             $metawords = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_w&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00281"></a>00281             $addwords = <span class="keyword">false</span>;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283             <span class="keywordflow">if</span> (!is_array($values)) $values = array($values);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285             $val_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea" title="Retrieve a line from the index.">getIndexKey</a>($metaname.<span class="stringliteral">&#39;_p&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid);
<a name="l00286"></a>00286             <span class="keywordflow">if</span> ($val_idx != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00287"></a>00287                 $val_idx = explode(<span class="charliteral">&#39;:&#39;</span>, $val_idx);
<a name="l00288"></a>00288                 <span class="comment">// -1 means remove, 0 keep, 1 add</span>
<a name="l00289"></a>00289                 $val_idx = array_combine($val_idx, array_fill(0, count($val_idx), -1));
<a name="l00290"></a>00290             } <span class="keywordflow">else</span> {
<a name="l00291"></a>00291                 $val_idx = array();
<a name="l00292"></a>00292             }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 
<a name="l00295"></a>00295             <span class="keywordflow">foreach</span> ($values as $val) {
<a name="l00296"></a>00296                 $val = (string)$val;
<a name="l00297"></a>00297                 <span class="keywordflow">if</span> ($val !== <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00298"></a>00298                     $id = array_search($val, $metawords);
<a name="l00299"></a>00299                     <span class="keywordflow">if</span> ($id === <span class="keyword">false</span>) {
<a name="l00300"></a>00300                         $id = count($metawords);
<a name="l00301"></a>00301                         $metawords[$id] = $val;
<a name="l00302"></a>00302                         $addwords = <span class="keyword">true</span>;
<a name="l00303"></a>00303                     }
<a name="l00304"></a>00304                     <span class="comment">// test if value is already in the index</span>
<a name="l00305"></a>00305                     <span class="keywordflow">if</span> (isset($val_idx[$id]) &amp;&amp; $val_idx[$id] &lt;= 0)
<a name="l00306"></a>00306                         $val_idx[$id] = 0;
<a name="l00307"></a>00307                     <span class="keywordflow">else</span> <span class="comment">// else add it</span>
<a name="l00308"></a>00308                         $val_idx[$id] = 1;
<a name="l00309"></a>00309                 }
<a name="l00310"></a>00310             }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312             <span class="keywordflow">if</span> ($addwords)
<a name="l00313"></a>00313                 $this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>($metaname.<span class="stringliteral">&#39;_w&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $metawords);
<a name="l00314"></a>00314             $vals_changed = <span class="keyword">false</span>;
<a name="l00315"></a>00315             <span class="keywordflow">foreach</span> ($val_idx as $id =&gt; $action) {
<a name="l00316"></a>00316                 <span class="keywordflow">if</span> ($action == -1) {
<a name="l00317"></a>00317                     $metaidx[$id] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($metaidx[$id], $pid, 0);
<a name="l00318"></a>00318                     $vals_changed = <span class="keyword">true</span>;
<a name="l00319"></a>00319                     unset($val_idx[$id]);
<a name="l00320"></a>00320                 } elseif ($action == 1) {
<a name="l00321"></a>00321                     $metaidx[$id] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($metaidx[$id], $pid, 1);
<a name="l00322"></a>00322                     $vals_changed = <span class="keyword">true</span>;
<a name="l00323"></a>00323                 }
<a name="l00324"></a>00324             }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326             <span class="keywordflow">if</span> ($vals_changed) {
<a name="l00327"></a>00327                 $this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $metaidx);
<a name="l00328"></a>00328                 $val_idx = implode(<span class="charliteral">&#39;:&#39;</span>, array_keys($val_idx));
<a name="l00329"></a>00329                 $this-&gt;<a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>($metaname.<span class="stringliteral">&#39;_p&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid, $val_idx);
<a name="l00330"></a>00330             }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332             unset($metaidx);
<a name="l00333"></a>00333             unset($metawords);
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336         $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00337"></a>00337         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339 
<a name="l00349"></a><a class="code" href="classDoku__Indexer.html#af99e41453b1c4eee190c24ad0de32618">00349</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#af99e41453b1c4eee190c24ad0de32618" title="Remove a page from the index.">deletePage</a>($page) {
<a name="l00350"></a>00350         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a6313bd4e862ceea65808aa3479e2c235" title="Lock the indexer.">lock</a>())
<a name="l00351"></a>00351             <span class="keywordflow">return</span> <span class="stringliteral">&quot;locked&quot;</span>;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="comment">// load known documents</span>
<a name="l00354"></a>00354         $pid = $this-&gt;<a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea" title="Retrieve a line from the index.">getIndexKey</a>(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $page);
<a name="l00355"></a>00355         <span class="keywordflow">if</span> ($pid === <span class="keyword">false</span>) {
<a name="l00356"></a>00356             $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00357"></a>00357             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00358"></a>00358         }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         <span class="comment">// Remove obsolete index entries</span>
<a name="l00361"></a>00361         $pageword_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea" title="Retrieve a line from the index.">getIndexKey</a>(<span class="stringliteral">&#39;pageword&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid);
<a name="l00362"></a>00362         <span class="keywordflow">if</span> ($pageword_idx !== <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00363"></a>00363             $delwords = explode(<span class="charliteral">&#39;:&#39;</span>,$pageword_idx);
<a name="l00364"></a>00364             $upwords = array();
<a name="l00365"></a>00365             <span class="keywordflow">foreach</span> ($delwords as $word) {
<a name="l00366"></a>00366                 <span class="keywordflow">if</span> ($word != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00367"></a>00367                     list($wlen,$wid) = explode(<span class="charliteral">&#39;*&#39;</span>, $word);
<a name="l00368"></a>00368                     $wid = (int)$wid;
<a name="l00369"></a>00369                     $upwords[$wlen][] = $wid;
<a name="l00370"></a>00370                 }
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372             <span class="keywordflow">foreach</span> ($upwords as $wlen =&gt; $widx) {
<a name="l00373"></a>00373                 $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen);
<a name="l00374"></a>00374                 <span class="keywordflow">foreach</span> ($widx as $wid) {
<a name="l00375"></a>00375                     $index[$wid] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($index[$wid], $pid, 0);
<a name="l00376"></a>00376                 }
<a name="l00377"></a>00377                 $this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen, $index);
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         <span class="comment">// Save the reverse index</span>
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>(<span class="stringliteral">&#39;pageword&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00382"></a>00382             $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00383"></a>00383             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         $this-&gt;<a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>(<span class="stringliteral">&#39;title&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00387"></a>00387         $keyidx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;metadata&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00388"></a>00388         <span class="keywordflow">foreach</span> ($keyidx as $metaname) {
<a name="l00389"></a>00389             $val_idx = explode(<span class="charliteral">&#39;:&#39;</span>, $this-&gt;<a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea" title="Retrieve a line from the index.">getIndexKey</a>($metaname.<span class="stringliteral">&#39;_p&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid));
<a name="l00390"></a>00390             $meta_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00391"></a>00391             <span class="keywordflow">foreach</span> ($val_idx as $id) {
<a name="l00392"></a>00392                 $meta_idx[$id] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($meta_idx[$id], $pid, 0);
<a name="l00393"></a>00393             }
<a name="l00394"></a>00394             $this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $meta_idx);
<a name="l00395"></a>00395             $this-&gt;<a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>($metaname.<span class="stringliteral">&#39;_p&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pid, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00396"></a>00396         }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398         $this-&gt;<a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>();
<a name="l00399"></a>00399         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401 
<a name="l00417"></a><a class="code" href="classDoku__Indexer.html#afa73e2a6c31acb56c1cc30b46cf59c7f">00417</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#afa73e2a6c31acb56c1cc30b46cf59c7f" title="Split the text into words for fulltext search.">tokenizer</a>($text, $wc=<span class="keyword">false</span>) {
<a name="l00418"></a>00418         global $conf;
<a name="l00419"></a>00419         $words = array();
<a name="l00420"></a>00420         $wc = ($wc) ? <span class="stringliteral">&#39;&#39;</span> : <span class="charliteral">&#39;\*&#39;</span>;
<a name="l00421"></a>00421         $stopwords =&amp; idx_get_stopwords();
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="comment">// prepare the text to be tokenized</span>
<a name="l00424"></a>00424         $evt = <span class="keyword">new</span> <a class="code" href="classDoku__Event.html">Doku_Event</a>(<span class="stringliteral">&#39;INDEXER_TEXT_PREPARE&#39;</span>, $text);
<a name="l00425"></a>00425         <span class="keywordflow">if</span> ($evt-&gt;advise_before(<span class="keyword">true</span>)) {
<a name="l00426"></a>00426             <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/[^0-9A-Za-z ]/u&#39;</span>, $text)) {
<a name="l00427"></a>00427                 <span class="comment">// handle asian chars as single words (may fail on older PHP version)</span>
<a name="l00428"></a>00428                 $asia = @preg_replace(<span class="stringliteral">&#39;/(&#39;</span>.IDX_ASIAN.<span class="stringliteral">&#39;)/u&#39;</span>, <span class="stringliteral">&#39; \1 &#39;</span>, $text);
<a name="l00429"></a>00429                 <span class="keywordflow">if</span> (!is_null($asia)) $text = $asia; <span class="comment">// recover from regexp falure</span>
<a name="l00430"></a>00430             }
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432         $evt-&gt;advise_after();
<a name="l00433"></a>00433         unset($evt);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435         $text = strtr($text,
<a name="l00436"></a>00436                        array(
<a name="l00437"></a>00437                            <span class="stringliteral">&quot;\r&quot;</span> =&gt; <span class="charliteral">&#39; &#39;</span>,
<a name="l00438"></a>00438                            <span class="stringliteral">&quot;\n&quot;</span> =&gt; <span class="charliteral">&#39; &#39;</span>,
<a name="l00439"></a>00439                            <span class="stringliteral">&quot;\t&quot;</span> =&gt; <span class="charliteral">&#39; &#39;</span>,
<a name="l00440"></a>00440                            <span class="stringliteral">&quot;\xC2\xAD&quot;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>, <span class="comment">//soft-hyphen</span>
<a name="l00441"></a>00441                        )
<a name="l00442"></a>00442                      );
<a name="l00443"></a>00443         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/[^0-9A-Za-z ]/u&#39;</span>, $text))
<a name="l00444"></a>00444             $text = utf8_stripspecials($text, <span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;\._\-:&#39;</span>.$wc);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446         $wordlist = explode(<span class="charliteral">&#39; &#39;</span>, $text);
<a name="l00447"></a>00447         <span class="keywordflow">foreach</span> ($wordlist as $i =&gt; $word) {
<a name="l00448"></a>00448             $wordlist[$i] = (preg_match(<span class="stringliteral">&#39;/[^0-9A-Za-z]/u&#39;</span>, $word)) ?
<a name="l00449"></a>00449                 utf8_strtolower($word) : strtolower($word);
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452         <span class="keywordflow">foreach</span> ($wordlist as $i =&gt; $word) {
<a name="l00453"></a>00453             <span class="keywordflow">if</span> ((!is_numeric($word) &amp;&amp; strlen($word) &lt; IDX_MINWORDLENGTH)
<a name="l00454"></a>00454               || array_search($word, $stopwords) !== <span class="keyword">false</span>)
<a name="l00455"></a>00455                 unset($wordlist[$i]);
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457         <span class="keywordflow">return</span> array_values($wordlist);
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459 
<a name="l00475"></a><a class="code" href="classDoku__Indexer.html#a1148856175284ebdd7265687be234d7b">00475</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#a1148856175284ebdd7265687be234d7b" title="Find pages in the fulltext index containing the words,.">lookup</a>(&amp;$tokens) {
<a name="l00476"></a>00476         $result = array();
<a name="l00477"></a>00477         $wids = $this-&gt;<a class="code" href="classDoku__Indexer.html#aa332fc4197660db71a57031103b8bdad" title="Find the index ID of each search term.">getIndexWords</a>($tokens, $result);
<a name="l00478"></a>00478         <span class="keywordflow">if</span> (empty($wids)) <span class="keywordflow">return</span> array();
<a name="l00479"></a>00479         <span class="comment">// load known words and documents</span>
<a name="l00480"></a>00480         $page_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00481"></a>00481         $docs = array();
<a name="l00482"></a>00482         <span class="keywordflow">foreach</span> (array_keys($wids) as $wlen) {
<a name="l00483"></a>00483             $wids[$wlen] = array_unique($wids[$wlen]);
<a name="l00484"></a>00484             $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $wlen);
<a name="l00485"></a>00485             <span class="keywordflow">foreach</span>($wids[$wlen] as $ixid) {
<a name="l00486"></a>00486                 <span class="keywordflow">if</span> ($ixid &lt; count($index))
<a name="l00487"></a>00487                     $docs[<span class="stringliteral">&quot;$wlen*$ixid&quot;</span>] = $this-&gt;<a class="code" href="classDoku__Indexer.html#a09ac1a21cab26d42769442097d95792a" title="Split a line into an array of tuples.">parseTuples</a>($page_idx, $index[$ixid]);
<a name="l00488"></a>00488             }
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490         <span class="comment">// merge found pages into final result array</span>
<a name="l00491"></a>00491         $final = array();
<a name="l00492"></a>00492         <span class="keywordflow">foreach</span> ($result as $word =&gt; $res) {
<a name="l00493"></a>00493             $final[$word] = array();
<a name="l00494"></a>00494             <span class="keywordflow">foreach</span> ($res as $wid) {
<a name="l00495"></a>00495                 <span class="comment">// handle the case when ($ixid &lt; count($index)) has been false</span>
<a name="l00496"></a>00496                 <span class="comment">// and thus $docs[$wid] hasn&#39;t been set.</span>
<a name="l00497"></a>00497                 <span class="keywordflow">if</span> (!isset($docs[$wid])) <span class="keywordflow">continue</span>;
<a name="l00498"></a>00498                 $hits = &amp;$docs[$wid];
<a name="l00499"></a>00499                 <span class="keywordflow">foreach</span> ($hits as $hitkey =&gt; $hitcnt) {
<a name="l00500"></a>00500                     <span class="comment">// make sure the document still exists</span>
<a name="l00501"></a>00501                     <span class="keywordflow">if</span> (!page_exists($hitkey, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>)) <span class="keywordflow">continue</span>;
<a name="l00502"></a>00502                     <span class="keywordflow">if</span> (!isset($final[$word][$hitkey]))
<a name="l00503"></a>00503                         $final[$word][$hitkey] = $hitcnt;
<a name="l00504"></a>00504                     <span class="keywordflow">else</span>
<a name="l00505"></a>00505                         $final[$word][$hitkey] += $hitcnt;
<a name="l00506"></a>00506                 }
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509         <span class="keywordflow">return</span> $final;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00529"></a><a class="code" href="classDoku__Indexer.html#aeef6f3a308576a0674677fde77e82340">00529</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#aeef6f3a308576a0674677fde77e82340" title="Find pages containing a metadata key.">lookupKey</a>($key, &amp;$value, $func=null) {
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (!is_array($value))
<a name="l00531"></a>00531             $value_array = array($value);
<a name="l00532"></a>00532         <span class="keywordflow">else</span>
<a name="l00533"></a>00533             $value_array =&amp; $value;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="comment">// the matching ids for the provided value(s)</span>
<a name="l00536"></a>00536         $value_ids = array();
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         $metaname = idx_cleanName($key);
<a name="l00539"></a>00539 
<a name="l00540"></a>00540         <span class="comment">// get all words in order to search the matching ids</span>
<a name="l00541"></a>00541         <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;title&#39;</span>) {
<a name="l00542"></a>00542             $words = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;title&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00543"></a>00543         } <span class="keywordflow">else</span> {
<a name="l00544"></a>00544             $words = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_w&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00545"></a>00545         }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (!is_null($func)) {
<a name="l00548"></a>00548             <span class="keywordflow">foreach</span> ($value_array as $val) {
<a name="l00549"></a>00549                 <span class="keywordflow">foreach</span> ($words as $i =&gt; $word) {
<a name="l00550"></a>00550                     <span class="keywordflow">if</span> (call_user_func_array($func, array($val, $word)))
<a name="l00551"></a>00551                         $value_ids[$i][] = $val;
<a name="l00552"></a>00552                 }
<a name="l00553"></a>00553             }
<a name="l00554"></a>00554         } <span class="keywordflow">else</span> {
<a name="l00555"></a>00555             <span class="keywordflow">foreach</span> ($value_array as $val) {
<a name="l00556"></a>00556                 $xval = $val;
<a name="l00557"></a>00557                 $caret = <span class="charliteral">&#39;^&#39;</span>;
<a name="l00558"></a>00558                 $dollar = <span class="charliteral">&#39;$&#39;</span>;
<a name="l00559"></a>00559                 <span class="comment">// check for wildcards</span>
<a name="l00560"></a>00560                 <span class="keywordflow">if</span> (substr($xval, 0, 1) == <span class="charliteral">&#39;*&#39;</span>) {
<a name="l00561"></a>00561                     $xval = substr($xval, 1);
<a name="l00562"></a>00562                     $caret = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00563"></a>00563                 }
<a name="l00564"></a>00564                 <span class="keywordflow">if</span> (substr($xval, -1, 1) == <span class="charliteral">&#39;*&#39;</span>) {
<a name="l00565"></a>00565                     $xval = substr($xval, 0, -1);
<a name="l00566"></a>00566                     $dollar = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00567"></a>00567                 }
<a name="l00568"></a>00568                 <span class="keywordflow">if</span> (!$caret || !$dollar) {
<a name="l00569"></a>00569                     $re = $caret.preg_quote($xval, <span class="charliteral">&#39;/&#39;</span>).$dollar;
<a name="l00570"></a>00570                     <span class="keywordflow">foreach</span>(array_keys(preg_grep(<span class="charliteral">&#39;/&#39;</span>.$re.<span class="charliteral">&#39;/&#39;</span>, $words)) as $i)
<a name="l00571"></a>00571                         $value_ids[$i][] = $val;
<a name="l00572"></a>00572                 } <span class="keywordflow">else</span> {
<a name="l00573"></a>00573                     <span class="keywordflow">if</span> (($i = array_search($val, $words)) !== <span class="keyword">false</span>)
<a name="l00574"></a>00574                         $value_ids[$i][] = $val;
<a name="l00575"></a>00575                 }
<a name="l00576"></a>00576             }
<a name="l00577"></a>00577         }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579         unset($words); <span class="comment">// free the used memory</span>
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <span class="comment">// initialize the result so it won&#39;t be null</span>
<a name="l00582"></a>00582         $result = array();
<a name="l00583"></a>00583         <span class="keywordflow">foreach</span> ($value_array as $val) {
<a name="l00584"></a>00584             $result[$val] = array();
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         $page_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         <span class="comment">// Special handling for titles</span>
<a name="l00590"></a>00590         <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;title&#39;</span>) {
<a name="l00591"></a>00591             <span class="keywordflow">foreach</span> ($value_ids as $pid =&gt; $val_list) {
<a name="l00592"></a>00592                 $page = $page_idx[$pid];
<a name="l00593"></a>00593                 <span class="keywordflow">foreach</span> ($val_list as $val) {
<a name="l00594"></a>00594                     $result[$val][] = $page;
<a name="l00595"></a>00595                 }
<a name="l00596"></a>00596             }
<a name="l00597"></a>00597         } <span class="keywordflow">else</span> {
<a name="l00598"></a>00598             <span class="comment">// load all lines and pages so the used lines can be taken and matched with the pages</span>
<a name="l00599"></a>00599             $lines = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601             <span class="keywordflow">foreach</span> ($value_ids as $value_id =&gt; $val_list) {
<a name="l00602"></a>00602                 <span class="comment">// parse the tuples of the form page_id*1:page2_id*1 and so on, return value</span>
<a name="l00603"></a>00603                 <span class="comment">// is an array with page_id =&gt; 1, page2_id =&gt; 1 etc. so take the keys only</span>
<a name="l00604"></a>00604                 $pages = array_keys($this-&gt;<a class="code" href="classDoku__Indexer.html#a09ac1a21cab26d42769442097d95792a" title="Split a line into an array of tuples.">parseTuples</a>($page_idx, $lines[$value_id]));
<a name="l00605"></a>00605                 <span class="keywordflow">foreach</span> ($val_list as $val) {
<a name="l00606"></a>00606                     $result[$val] = array_merge($result[$val], $pages);
<a name="l00607"></a>00607                 }
<a name="l00608"></a>00608             }
<a name="l00609"></a>00609         }
<a name="l00610"></a>00610         <span class="keywordflow">if</span> (!is_array($value)) $result = $result[$value];
<a name="l00611"></a>00611         <span class="keywordflow">return</span> $result;
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00627"></a><a class="code" href="classDoku__Indexer.html#aa332fc4197660db71a57031103b8bdad">00627</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#aa332fc4197660db71a57031103b8bdad" title="Find the index ID of each search term.">getIndexWords</a>(&amp;$words, &amp;$result) {
<a name="l00628"></a>00628         $tokens = array();
<a name="l00629"></a>00629         $tokenlength = array();
<a name="l00630"></a>00630         $tokenwild = array();
<a name="l00631"></a>00631         <span class="keywordflow">foreach</span> ($words as $word) {
<a name="l00632"></a>00632             $result[$word] = array();
<a name="l00633"></a>00633             $caret = <span class="charliteral">&#39;^&#39;</span>;
<a name="l00634"></a>00634             $dollar = <span class="charliteral">&#39;$&#39;</span>;
<a name="l00635"></a>00635             $xword = $word;
<a name="l00636"></a>00636             $wlen = wordlen($word);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638             <span class="comment">// check for wildcards</span>
<a name="l00639"></a>00639             <span class="keywordflow">if</span> (substr($xword, 0, 1) == <span class="charliteral">&#39;*&#39;</span>) {
<a name="l00640"></a>00640                 $xword = substr($xword, 1);
<a name="l00641"></a>00641                 $caret = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00642"></a>00642                 $wlen -= 1;
<a name="l00643"></a>00643             }
<a name="l00644"></a>00644             <span class="keywordflow">if</span> (substr($xword, -1, 1) == <span class="charliteral">&#39;*&#39;</span>) {
<a name="l00645"></a>00645                 $xword = substr($xword, 0, -1);
<a name="l00646"></a>00646                 $dollar = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00647"></a>00647                 $wlen -= 1;
<a name="l00648"></a>00648             }
<a name="l00649"></a>00649             <span class="keywordflow">if</span> ($wlen &lt; IDX_MINWORDLENGTH &amp;&amp; $caret &amp;&amp; $dollar &amp;&amp; !is_numeric($xword))
<a name="l00650"></a>00650                 <span class="keywordflow">continue</span>;
<a name="l00651"></a>00651             <span class="keywordflow">if</span> (!isset($tokens[$xword]))
<a name="l00652"></a>00652                 $tokenlength[$wlen][] = $xword;
<a name="l00653"></a>00653             <span class="keywordflow">if</span> (!$caret || !$dollar) {
<a name="l00654"></a>00654                 $re = $caret.preg_quote($xword, <span class="charliteral">&#39;/&#39;</span>).$dollar;
<a name="l00655"></a>00655                 $tokens[$xword][] = array($word, <span class="charliteral">&#39;/&#39;</span>.$re.<span class="charliteral">&#39;/&#39;</span>);
<a name="l00656"></a>00656                 <span class="keywordflow">if</span> (!isset($tokenwild[$xword]))
<a name="l00657"></a>00657                     $tokenwild[$xword] = $wlen;
<a name="l00658"></a>00658             } <span class="keywordflow">else</span> {
<a name="l00659"></a>00659                 $tokens[$xword][] = array($word, null);
<a name="l00660"></a>00660             }
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662         asort($tokenwild);
<a name="l00663"></a>00663         <span class="comment">// $tokens = array( base word =&gt; array( [ query term , regexp ] ... ) ... )</span>
<a name="l00664"></a>00664         <span class="comment">// $tokenlength = array( base word length =&gt; base word ... )</span>
<a name="l00665"></a>00665         <span class="comment">// $tokenwild = array( base word =&gt; base word length ... )</span>
<a name="l00666"></a>00666         $length_filter = empty($tokenwild) ? $tokenlength : min(array_keys($tokenlength));
<a name="l00667"></a>00667         $indexes_known = $this-&gt;<a class="code" href="classDoku__Indexer.html#a1e4420e84053c62e94d43471546f875c" title="Get the word lengths that have been indexed.">indexLengths</a>($length_filter);
<a name="l00668"></a>00668         <span class="keywordflow">if</span> (!empty($tokenwild)) sort($indexes_known);
<a name="l00669"></a>00669         <span class="comment">// get word IDs</span>
<a name="l00670"></a>00670         $wids = array();
<a name="l00671"></a>00671         <span class="keywordflow">foreach</span> ($indexes_known as $ixlen) {
<a name="l00672"></a>00672             $word_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;w&#39;</span>, $ixlen);
<a name="l00673"></a>00673             <span class="comment">// handle exact search</span>
<a name="l00674"></a>00674             <span class="keywordflow">if</span> (isset($tokenlength[$ixlen])) {
<a name="l00675"></a>00675                 <span class="keywordflow">foreach</span> ($tokenlength[$ixlen] as $xword) {
<a name="l00676"></a>00676                     $wid = array_search($xword, $word_idx);
<a name="l00677"></a>00677                     <span class="keywordflow">if</span> ($wid !== <span class="keyword">false</span>) {
<a name="l00678"></a>00678                         $wids[$ixlen][] = $wid;
<a name="l00679"></a>00679                         <span class="keywordflow">foreach</span> ($tokens[$xword] as $w)
<a name="l00680"></a>00680                             $result[$w[0]][] = <span class="stringliteral">&quot;$ixlen*$wid&quot;</span>;
<a name="l00681"></a>00681                     }
<a name="l00682"></a>00682                 }
<a name="l00683"></a>00683             }
<a name="l00684"></a>00684             <span class="comment">// handle wildcard search</span>
<a name="l00685"></a>00685             <span class="keywordflow">foreach</span> ($tokenwild as $xword =&gt; $wlen) {
<a name="l00686"></a>00686                 <span class="keywordflow">if</span> ($wlen &gt;= $ixlen) <span class="keywordflow">break</span>;
<a name="l00687"></a>00687                 <span class="keywordflow">foreach</span> ($tokens[$xword] as $w) {
<a name="l00688"></a>00688                     <span class="keywordflow">if</span> (is_null($w[1])) <span class="keywordflow">continue</span>;
<a name="l00689"></a>00689                     <span class="keywordflow">foreach</span>(array_keys(preg_grep($w[1], $word_idx)) as $wid) {
<a name="l00690"></a>00690                         $wids[$ixlen][] = $wid;
<a name="l00691"></a>00691                         $result[$w[0]][] = <span class="stringliteral">&quot;$ixlen*$wid&quot;</span>;
<a name="l00692"></a>00692                     }
<a name="l00693"></a>00693                 }
<a name="l00694"></a>00694             }
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696         <span class="keywordflow">return</span> $wids;
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 
<a name="l00707"></a><a class="code" href="classDoku__Indexer.html#a5e42c3a193d749754e7c398b63f09118">00707</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#a5e42c3a193d749754e7c398b63f09118" title="Return a list of all pages Warning: pages may not exist!">getPages</a>($key=null) {
<a name="l00708"></a>00708         $page_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00709"></a>00709         <span class="keywordflow">if</span> (is_null($key)) <span class="keywordflow">return</span> $page_idx;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         $metaname = idx_cleanName($key);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713         <span class="comment">// Special handling for titles</span>
<a name="l00714"></a>00714         <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;title&#39;</span>) {
<a name="l00715"></a>00715             $title_idx = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;title&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00716"></a>00716             array_splice($page_idx, count($title_idx));
<a name="l00717"></a>00717             <span class="keywordflow">foreach</span> ($title_idx as $i =&gt; $title)
<a name="l00718"></a>00718                 <span class="keywordflow">if</span> ($title === <span class="stringliteral">&quot;&quot;</span>) unset($page_idx[$i]);
<a name="l00719"></a>00719             <span class="keywordflow">return</span> array_values($page_idx);
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         $pages = array();
<a name="l00723"></a>00723         $lines = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00724"></a>00724         <span class="keywordflow">foreach</span> ($lines as $line) {
<a name="l00725"></a>00725             $pages = array_merge($pages, $this-&gt;<a class="code" href="classDoku__Indexer.html#a09ac1a21cab26d42769442097d95792a" title="Split a line into an array of tuples.">parseTuples</a>($page_idx, $line));
<a name="l00726"></a>00726         }
<a name="l00727"></a>00727         <span class="keywordflow">return</span> array_keys($pages);
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729 
<a name="l00740"></a><a class="code" href="classDoku__Indexer.html#aad3a5800f7f07ab1b2a9f009910b3f7a">00740</a>     <span class="keyword">public</span> function <a class="code" href="classDoku__Indexer.html#aad3a5800f7f07ab1b2a9f009910b3f7a" title="Return a list of words sorted by number of times used.">histogram</a>($min=1, $max=0, $minlen=3, $key=null) {
<a name="l00741"></a>00741         <span class="keywordflow">if</span> ($min &lt; 1)
<a name="l00742"></a>00742             $min = 1;
<a name="l00743"></a>00743         <span class="keywordflow">if</span> ($max &lt; $min)
<a name="l00744"></a>00744             $max = 0;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         $result = array();
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;title&#39;</span>) {
<a name="l00749"></a>00749             $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="stringliteral">&#39;title&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00750"></a>00750             $index = array_count_values($index);
<a name="l00751"></a>00751             <span class="keywordflow">foreach</span> ($index as $val =&gt; $cnt) {
<a name="l00752"></a>00752                 <span class="keywordflow">if</span> ($cnt &gt;= $min &amp;&amp; (!$max || $cnt &lt;= $max) &amp;&amp; strlen($val) &gt;= $minlen)
<a name="l00753"></a>00753                     $result[$val] = $cnt;
<a name="l00754"></a>00754             }
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756         elseif (!is_null($key)) {
<a name="l00757"></a>00757             $metaname = idx_cleanName($key);
<a name="l00758"></a>00758             $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00759"></a>00759             $val_idx = array();
<a name="l00760"></a>00760             <span class="keywordflow">foreach</span> ($index as $wid =&gt; $line) {
<a name="l00761"></a>00761                 $freq = $this-&gt;<a class="code" href="classDoku__Indexer.html#ab66ae06ceefc10b8681270ac5b734188" title="Sum the counts in a list of tuples.">countTuples</a>($line);
<a name="l00762"></a>00762                 <span class="keywordflow">if</span> ($freq &gt;= $min &amp;&amp; (!$max || $freq &lt;= $max) &amp;&amp; strlen($val) &gt;= $minlen)
<a name="l00763"></a>00763                     $val_idx[$wid] = $freq;
<a name="l00764"></a>00764             }
<a name="l00765"></a>00765             <span class="keywordflow">if</span> (!empty($val_idx)) {
<a name="l00766"></a>00766                 $words = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($metaname.<span class="stringliteral">&#39;_w&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00767"></a>00767                 <span class="keywordflow">foreach</span> ($val_idx as $wid =&gt; $freq)
<a name="l00768"></a>00768                     $result[$words[$wid]] = $freq;
<a name="l00769"></a>00769             }
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771         <span class="keywordflow">else</span> {
<a name="l00772"></a>00772             $lengths = idx_listIndexLengths();
<a name="l00773"></a>00773             <span class="keywordflow">foreach</span> ($lengths as $length) {
<a name="l00774"></a>00774                 <span class="keywordflow">if</span> ($length &lt; $minlen) <span class="keywordflow">continue</span>;
<a name="l00775"></a>00775                 $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;i&#39;</span>, $length);
<a name="l00776"></a>00776                 $words = null;
<a name="l00777"></a>00777                 <span class="keywordflow">foreach</span> ($index as $wid =&gt; $line) {
<a name="l00778"></a>00778                     $freq = $this-&gt;<a class="code" href="classDoku__Indexer.html#ab66ae06ceefc10b8681270ac5b734188" title="Sum the counts in a list of tuples.">countTuples</a>($line);
<a name="l00779"></a>00779                     <span class="keywordflow">if</span> ($freq &gt;= $min &amp;&amp; (!$max || $freq &lt;= $max)) {
<a name="l00780"></a>00780                         <span class="keywordflow">if</span> ($words === null)
<a name="l00781"></a>00781                             $words = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>(<span class="charliteral">&#39;w&#39;</span>, $length);
<a name="l00782"></a>00782                         $result[$words[$wid]] = $freq;
<a name="l00783"></a>00783                     }
<a name="l00784"></a>00784                 }
<a name="l00785"></a>00785             }
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         arsort($result);
<a name="l00789"></a>00789         <span class="keywordflow">return</span> $result;
<a name="l00790"></a>00790     }
<a name="l00791"></a>00791 
<a name="l00797"></a><a class="code" href="classDoku__Indexer.html#a6313bd4e862ceea65808aa3479e2c235">00797</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a6313bd4e862ceea65808aa3479e2c235" title="Lock the indexer.">lock</a>() {
<a name="l00798"></a>00798         global $conf;
<a name="l00799"></a>00799         $status = <span class="keyword">true</span>;
<a name="l00800"></a>00800         $run = 0;
<a name="l00801"></a>00801         $lock = $conf[<span class="stringliteral">&#39;lockdir&#39;</span>].<span class="stringliteral">&#39;/_indexer.lock&#39;</span>;
<a name="l00802"></a>00802         <span class="keywordflow">while</span> (!@mkdir($lock, $conf[<span class="stringliteral">&#39;dmode&#39;</span>])) {
<a name="l00803"></a>00803             usleep(50);
<a name="l00804"></a>00804             <span class="keywordflow">if</span>(is_dir($lock) &amp;&amp; time()-@filemtime($lock) &gt; 60*5){
<a name="l00805"></a>00805                 <span class="comment">// looks like a stale lock - remove it</span>
<a name="l00806"></a>00806                 <span class="keywordflow">if</span> (!@rmdir($lock)) {
<a name="l00807"></a>00807                     $status = <span class="stringliteral">&quot;removing the stale lock failed&quot;</span>;
<a name="l00808"></a>00808                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00809"></a>00809                 } <span class="keywordflow">else</span> {
<a name="l00810"></a>00810                     $status = <span class="stringliteral">&quot;stale lock removed&quot;</span>;
<a name="l00811"></a>00811                 }
<a name="l00812"></a>00812             }elseif($run++ == 1000){
<a name="l00813"></a>00813                 <span class="comment">// we waited 5 seconds for that lock</span>
<a name="l00814"></a>00814                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00815"></a>00815             }
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817         <span class="keywordflow">if</span> ($conf[<span class="stringliteral">&#39;dperm&#39;</span>])
<a name="l00818"></a>00818             chmod($lock, $conf[<span class="stringliteral">&#39;dperm&#39;</span>]);
<a name="l00819"></a>00819         <span class="keywordflow">return</span> $status;
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821 
<a name="l00827"></a><a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7">00827</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a83671ef6c925fcb50e86d2bc509e56c7" title="Release the indexer lock.">unlock</a>() {
<a name="l00828"></a>00828         global $conf;
<a name="l00829"></a>00829         @rmdir($conf[<span class="stringliteral">&#39;lockdir&#39;</span>].<span class="stringliteral">&#39;/_indexer.lock&#39;</span>);
<a name="l00830"></a>00830         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00831"></a>00831     }
<a name="l00832"></a>00832 
<a name="l00845"></a><a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef">00845</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($idx, $suffix) {
<a name="l00846"></a>00846         global $conf;
<a name="l00847"></a>00847         $fn = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$idx.$suffix.<span class="stringliteral">&#39;.idx&#39;</span>;
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (!@file_exists($fn)) <span class="keywordflow">return</span> array();
<a name="l00849"></a>00849         <span class="keywordflow">return</span> file($fn, FILE_IGNORE_NEW_LINES);
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851 
<a name="l00860"></a><a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e">00860</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>($idx, $suffix, &amp;$lines) {
<a name="l00861"></a>00861         global $conf;
<a name="l00862"></a>00862         $fn = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$idx.$suffix;
<a name="l00863"></a>00863         $fh = @fopen($fn.<span class="stringliteral">&#39;.tmp&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);
<a name="l00864"></a>00864         <span class="keywordflow">if</span> (!$fh) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00865"></a>00865         fwrite($fh, join(<span class="stringliteral">&quot;\n&quot;</span>, $lines));
<a name="l00866"></a>00866         <span class="keywordflow">if</span> (!empty($lines))
<a name="l00867"></a>00867             fwrite($fh, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00868"></a>00868         fclose($fh);
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (isset($conf[<span class="stringliteral">&#39;fperm&#39;</span>]))
<a name="l00870"></a>00870             chmod($fn.<span class="stringliteral">&#39;.tmp&#39;</span>, $conf[<span class="stringliteral">&#39;fperm&#39;</span>]);
<a name="l00871"></a>00871         io_rename($fn.<span class="stringliteral">&#39;.tmp&#39;</span>, $fn.<span class="stringliteral">&#39;.idx&#39;</span>);
<a name="l00872"></a>00872         <span class="keywordflow">if</span> ($suffix !== <span class="stringliteral">&#39;&#39;</span>)
<a name="l00873"></a>00873             $this-&gt;cacheIndexDir($idx, $suffix, empty($lines));
<a name="l00874"></a>00874         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876 
<a name="l00886"></a><a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea">00886</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#aa955b503ac84be7ac361210f7502dfea" title="Retrieve a line from the index.">getIndexKey</a>($idx, $suffix, $id) {
<a name="l00887"></a>00887         global $conf;
<a name="l00888"></a>00888         $fn = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$idx.$suffix.<span class="stringliteral">&#39;.idx&#39;</span>;
<a name="l00889"></a>00889         <span class="keywordflow">if</span> (!@file_exists($fn)) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00890"></a>00890         $fh = @fopen($fn, <span class="charliteral">&#39;r&#39;</span>);
<a name="l00891"></a>00891         <span class="keywordflow">if</span> (!$fh) <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00892"></a>00892         $ln = -1;
<a name="l00893"></a>00893         <span class="keywordflow">while</span> (($line = fgets($fh)) !== <span class="keyword">false</span>) {
<a name="l00894"></a>00894             <span class="keywordflow">if</span> (++$ln == $id) <span class="keywordflow">break</span>;
<a name="l00895"></a>00895         }
<a name="l00896"></a>00896         fclose($fh);
<a name="l00897"></a>00897         <span class="keywordflow">return</span> rtrim((<span class="keywordtype">string</span>)$line);
<a name="l00898"></a>00898     }
<a name="l00899"></a>00899 
<a name="l00909"></a><a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814">00909</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a95438960cb2f81a526fda5c9b62ca814" title="Write a line into the index.">saveIndexKey</a>($idx, $suffix, $id, $line) {
<a name="l00910"></a>00910         global $conf;
<a name="l00911"></a>00911         <span class="keywordflow">if</span> (substr($line, -1) != <span class="stringliteral">&quot;\n&quot;</span>)
<a name="l00912"></a>00912             $line .= <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00913"></a>00913         $fn = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$idx.$suffix;
<a name="l00914"></a>00914         $fh = @fopen($fn.<span class="stringliteral">&#39;.tmp&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);
<a name="l00915"></a>00915         <span class="keywordflow">if</span> (!$fh) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00916"></a>00916         $ih = @fopen($fn.<span class="stringliteral">&#39;.idx&#39;</span>, <span class="charliteral">&#39;r&#39;</span>);
<a name="l00917"></a>00917         <span class="keywordflow">if</span> ($ih) {
<a name="l00918"></a>00918             $ln = -1;
<a name="l00919"></a>00919             <span class="keywordflow">while</span> (($curline = fgets($ih)) !== <span class="keyword">false</span>) {
<a name="l00920"></a>00920                 fwrite($fh, (++$ln == $id) ? $line : $curline);
<a name="l00921"></a>00921             }
<a name="l00922"></a>00922             <span class="keywordflow">if</span> ($id &gt; $ln) {
<a name="l00923"></a>00923                 <span class="keywordflow">while</span> ($id &gt; ++$ln)
<a name="l00924"></a>00924                     fwrite($fh, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00925"></a>00925                 fwrite($fh, $line);
<a name="l00926"></a>00926             }
<a name="l00927"></a>00927             fclose($ih);
<a name="l00928"></a>00928         } <span class="keywordflow">else</span> {
<a name="l00929"></a>00929             $ln = -1;
<a name="l00930"></a>00930             <span class="keywordflow">while</span> ($id &gt; ++$ln)
<a name="l00931"></a>00931                 fwrite($fh, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00932"></a>00932             fwrite($fh, $line);
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934         fclose($fh);
<a name="l00935"></a>00935         <span class="keywordflow">if</span> (isset($conf[<span class="stringliteral">&#39;fperm&#39;</span>]))
<a name="l00936"></a>00936             chmod($fn.<span class="stringliteral">&#39;.tmp&#39;</span>, $conf[<span class="stringliteral">&#39;fperm&#39;</span>]);
<a name="l00937"></a>00937         io_rename($fn.<span class="stringliteral">&#39;.tmp&#39;</span>, $fn.<span class="stringliteral">&#39;.idx&#39;</span>);
<a name="l00938"></a>00938         <span class="keywordflow">if</span> ($suffix !== <span class="stringliteral">&#39;&#39;</span>)
<a name="l00939"></a>00939             $this-&gt;cacheIndexDir($idx, $suffix);
<a name="l00940"></a>00940         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00941"></a>00941     }
<a name="l00942"></a>00942 
<a name="l00952"></a><a class="code" href="classDoku__Indexer.html#a1d6dd4af8d594078fc99b203ea4580ec">00952</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a1d6dd4af8d594078fc99b203ea4580ec" title="Retrieve or insert a value in the index.">addIndexKey</a>($idx, $suffix, $value) {
<a name="l00953"></a>00953         $index = $this-&gt;<a class="code" href="classDoku__Indexer.html#a5bbe5919b77de3ac82a9a7697c2131ef" title="Retrieve the entire index.">getIndex</a>($idx, $suffix);
<a name="l00954"></a>00954         $id = array_search($value, $index);
<a name="l00955"></a>00955         <span class="keywordflow">if</span> ($id === <span class="keyword">false</span>) {
<a name="l00956"></a>00956             $id = count($index);
<a name="l00957"></a>00957             $index[$id] = $value;
<a name="l00958"></a>00958             <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="classDoku__Indexer.html#a03df89634a29aca8aeab18adb114a48e" title="Replace the contents of the index with an array.">saveIndex</a>($idx, $suffix, $index)) {
<a name="l00959"></a>00959                 trigger_error(<span class="stringliteral">&quot;Failed to write $idx index&quot;</span>, E_USER_ERROR);
<a name="l00960"></a>00960                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00961"></a>00961             }
<a name="l00962"></a>00962         }
<a name="l00963"></a>00963         <span class="keywordflow">return</span> $id;
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <span class="keyword">protected</span> function cacheIndexDir($idx, $suffix, $delete=<span class="keyword">false</span>) {
<a name="l00967"></a>00967         global $conf;
<a name="l00968"></a>00968         <span class="keywordflow">if</span> ($idx == <span class="charliteral">&#39;i&#39;</span>)
<a name="l00969"></a>00969             $cachename = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&#39;/lengths&#39;</span>;
<a name="l00970"></a>00970         <span class="keywordflow">else</span>
<a name="l00971"></a>00971             $cachename = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$idx.<span class="stringliteral">&#39;lengths&#39;</span>;
<a name="l00972"></a>00972         $lengths = @file($cachename.<span class="stringliteral">&#39;.idx&#39;</span>, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
<a name="l00973"></a>00973         <span class="keywordflow">if</span> ($lengths === <span class="keyword">false</span>) $lengths = array();
<a name="l00974"></a>00974         $old = array_search((<span class="keywordtype">string</span>)$suffix, $lengths);
<a name="l00975"></a>00975         <span class="keywordflow">if</span> (empty($lines)) {
<a name="l00976"></a>00976             <span class="keywordflow">if</span> ($old === <span class="keyword">false</span>) <span class="keywordflow">return</span>;
<a name="l00977"></a>00977             unset($lengths[$old]);
<a name="l00978"></a>00978         } <span class="keywordflow">else</span> {
<a name="l00979"></a>00979             <span class="keywordflow">if</span> ($old !== <span class="keyword">false</span>) <span class="keywordflow">return</span>;
<a name="l00980"></a>00980             $lengths[] = $suffix;
<a name="l00981"></a>00981             sort($lengths);
<a name="l00982"></a>00982         }
<a name="l00983"></a>00983         $fh = @fopen($cachename.<span class="stringliteral">&#39;.tmp&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);
<a name="l00984"></a>00984         <span class="keywordflow">if</span> (!$fh) {
<a name="l00985"></a>00985             trigger_error(<span class="stringliteral">&quot;Failed to write index cache&quot;</span>, E_USER_ERROR);
<a name="l00986"></a>00986             <span class="keywordflow">return</span>;
<a name="l00987"></a>00987         }
<a name="l00988"></a>00988         @fwrite($fh, implode(<span class="stringliteral">&quot;\n&quot;</span>, $lengths));
<a name="l00989"></a>00989         @fclose($fh);
<a name="l00990"></a>00990         <span class="keywordflow">if</span> (isset($conf[<span class="stringliteral">&#39;fperm&#39;</span>]))
<a name="l00991"></a>00991             chmod($cachename.<span class="stringliteral">&#39;.tmp&#39;</span>, $conf[<span class="stringliteral">&#39;fperm&#39;</span>]);
<a name="l00992"></a>00992         io_rename($cachename.<span class="stringliteral">&#39;.tmp&#39;</span>, $cachename.<span class="stringliteral">&#39;.idx&#39;</span>);
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994 
<a name="l01003"></a><a class="code" href="classDoku__Indexer.html#af479acbcc60f6712f8538c87d739a67a">01003</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#af479acbcc60f6712f8538c87d739a67a" title="Get the list of lengths indexed in the wiki.">listIndexLengths</a>() {
<a name="l01004"></a>01004         global $conf;
<a name="l01005"></a>01005         $cachename = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&#39;/lengths&#39;</span>;
<a name="l01006"></a>01006         clearstatcache();
<a name="l01007"></a>01007         <span class="keywordflow">if</span> (@file_exists($cachename.<span class="stringliteral">&#39;.idx&#39;</span>)) {
<a name="l01008"></a>01008             $lengths = @file($cachename.<span class="stringliteral">&#39;.idx&#39;</span>, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
<a name="l01009"></a>01009             <span class="keywordflow">if</span> ($lengths !== <span class="keyword">false</span>) {
<a name="l01010"></a>01010                 $idx = array();
<a name="l01011"></a>01011                 <span class="keywordflow">foreach</span> ($lengths as $length)
<a name="l01012"></a>01012                     $idx[] = (int)$length;
<a name="l01013"></a>01013                 <span class="keywordflow">return</span> $idx;
<a name="l01014"></a>01014             }
<a name="l01015"></a>01015         }
<a name="l01016"></a>01016 
<a name="l01017"></a>01017         $dir = @opendir($conf[<span class="stringliteral">&#39;indexdir&#39;</span>]);
<a name="l01018"></a>01018         <span class="keywordflow">if</span> ($dir === <span class="keyword">false</span>)
<a name="l01019"></a>01019             <span class="keywordflow">return</span> array();
<a name="l01020"></a>01020         $lengths[] = array();
<a name="l01021"></a>01021         <span class="keywordflow">while</span> (($f = readdir($dir)) !== <span class="keyword">false</span>) {
<a name="l01022"></a>01022             <span class="keywordflow">if</span> (substr($f, 0, 1) == <span class="charliteral">&#39;i&#39;</span> &amp;&amp; substr($f, -4) == <span class="stringliteral">&#39;.idx&#39;</span>) {
<a name="l01023"></a>01023                 $i = substr($f, 1, -4);
<a name="l01024"></a>01024                 <span class="keywordflow">if</span> (is_numeric($i))
<a name="l01025"></a>01025                     $lengths[] = (int)$i;
<a name="l01026"></a>01026             }
<a name="l01027"></a>01027         }
<a name="l01028"></a>01028         closedir($dir);
<a name="l01029"></a>01029         sort($lengths);
<a name="l01030"></a>01030         <span class="comment">// save this in a file</span>
<a name="l01031"></a>01031         $fh = @fopen($cachename.<span class="stringliteral">&#39;.tmp&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);
<a name="l01032"></a>01032         <span class="keywordflow">if</span> (!$fh) {
<a name="l01033"></a>01033             trigger_error(<span class="stringliteral">&quot;Failed to write index cache&quot;</span>, E_USER_ERROR);
<a name="l01034"></a>01034             <span class="keywordflow">return</span>;
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036         @fwrite($fh, implode(<span class="stringliteral">&quot;\n&quot;</span>, $lengths));
<a name="l01037"></a>01037         @fclose($fh);
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (isset($conf[<span class="stringliteral">&#39;fperm&#39;</span>]))
<a name="l01039"></a>01039             chmod($cachename.<span class="stringliteral">&#39;.tmp&#39;</span>, $conf[<span class="stringliteral">&#39;fperm&#39;</span>]);
<a name="l01040"></a>01040         io_rename($cachename.<span class="stringliteral">&#39;.tmp&#39;</span>, $cachename.<span class="stringliteral">&#39;.idx&#39;</span>);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="keywordflow">return</span> $lengths;
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 
<a name="l01053"></a><a class="code" href="classDoku__Indexer.html#a1e4420e84053c62e94d43471546f875c">01053</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a1e4420e84053c62e94d43471546f875c" title="Get the word lengths that have been indexed.">indexLengths</a>($filter) {
<a name="l01054"></a>01054         global $conf;
<a name="l01055"></a>01055         $idx = array();
<a name="l01056"></a>01056         <span class="keywordflow">if</span> (is_array($filter)) {
<a name="l01057"></a>01057             <span class="comment">// testing if index files exist only</span>
<a name="l01058"></a>01058             $path = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&quot;/i&quot;</span>;
<a name="l01059"></a>01059             <span class="keywordflow">foreach</span> ($filter as $key =&gt; $value) {
<a name="l01060"></a>01060                 <span class="keywordflow">if</span> (@file_exists($path.$key.<span class="stringliteral">&#39;.idx&#39;</span>))
<a name="l01061"></a>01061                     $idx[] = $key;
<a name="l01062"></a>01062             }
<a name="l01063"></a>01063         } <span class="keywordflow">else</span> {
<a name="l01064"></a>01064             $lengths = idx_listIndexLengths();
<a name="l01065"></a>01065             <span class="keywordflow">foreach</span> ($lengths as $key =&gt; $length) {
<a name="l01066"></a>01066                 <span class="comment">// keep all the values equal or superior</span>
<a name="l01067"></a>01067                 <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)$length &gt;= (<span class="keywordtype">int</span>)$filter)
<a name="l01068"></a>01068                     $idx[] = $length;
<a name="l01069"></a>01069             }
<a name="l01070"></a>01070         }
<a name="l01071"></a>01071         <span class="keywordflow">return</span> $idx;
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 
<a name="l01079"></a><a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251">01079</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a8da6249ecf9673377bc14b757ba58251" title="Insert or replace a tuple in a line.">updateTuple</a>($line, $id, $count) {
<a name="l01080"></a>01080         $newLine = $line;
<a name="l01081"></a>01081         <span class="keywordflow">if</span> ($newLine !== <span class="stringliteral">&#39;&#39;</span>)
<a name="l01082"></a>01082             $newLine = preg_replace(<span class="stringliteral">&#39;/(^|:)&#39;</span>.preg_quote($id,<span class="charliteral">&#39;/&#39;</span>).<span class="stringliteral">&#39;\*\d*/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $newLine);
<a name="l01083"></a>01083         $newLine = trim($newLine, <span class="charliteral">&#39;:&#39;</span>);
<a name="l01084"></a>01084         <span class="keywordflow">if</span> ($count) {
<a name="l01085"></a>01085             <span class="keywordflow">if</span> (strlen($newLine) &gt; 0)
<a name="l01086"></a>01086                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;$id*$count:&quot;</span>.$newLine;
<a name="l01087"></a>01087             <span class="keywordflow">else</span>
<a name="l01088"></a>01088                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;$id*$count&quot;</span>.$newLine;
<a name="l01089"></a>01089         }
<a name="l01090"></a>01090         <span class="keywordflow">return</span> $newLine;
<a name="l01091"></a>01091     }
<a name="l01092"></a>01092 
<a name="l01099"></a><a class="code" href="classDoku__Indexer.html#a09ac1a21cab26d42769442097d95792a">01099</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#a09ac1a21cab26d42769442097d95792a" title="Split a line into an array of tuples.">parseTuples</a>(&amp;$keys, $line) {
<a name="l01100"></a>01100         $result = array();
<a name="l01101"></a>01101         <span class="keywordflow">if</span> ($line == <span class="stringliteral">&#39;&#39;</span>) <span class="keywordflow">return</span> $result;
<a name="l01102"></a>01102         $parts = explode(<span class="charliteral">&#39;:&#39;</span>, $line);
<a name="l01103"></a>01103         <span class="keywordflow">foreach</span> ($parts as $tuple) {
<a name="l01104"></a>01104             <span class="keywordflow">if</span> ($tuple === <span class="stringliteral">&#39;&#39;</span>) <span class="keywordflow">continue</span>;
<a name="l01105"></a>01105             list($key, $cnt) = explode(<span class="charliteral">&#39;*&#39;</span>, $tuple);
<a name="l01106"></a>01106             <span class="keywordflow">if</span> (!$cnt) <span class="keywordflow">continue</span>;
<a name="l01107"></a>01107             $key = $keys[$key];
<a name="l01108"></a>01108             <span class="keywordflow">if</span> (!$key) <span class="keywordflow">continue</span>;
<a name="l01109"></a>01109             $result[$key] = $cnt;
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111         <span class="keywordflow">return</span> $result;
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113 
<a name="l01119"></a><a class="code" href="classDoku__Indexer.html#ab66ae06ceefc10b8681270ac5b734188">01119</a>     <span class="keyword">protected</span> function <a class="code" href="classDoku__Indexer.html#ab66ae06ceefc10b8681270ac5b734188" title="Sum the counts in a list of tuples.">countTuples</a>($line) {
<a name="l01120"></a>01120         $freq = 0;
<a name="l01121"></a>01121         $parts = explode(<span class="charliteral">&#39;:&#39;</span>, $line);
<a name="l01122"></a>01122         <span class="keywordflow">foreach</span> ($parts as $tuple) {
<a name="l01123"></a>01123             <span class="keywordflow">if</span> ($tuple === <span class="stringliteral">&#39;&#39;</span>) <span class="keywordflow">continue</span>;
<a name="l01124"></a>01124             list($pid, $cnt) = explode(<span class="charliteral">&#39;*&#39;</span>, $tuple);
<a name="l01125"></a>01125             $freq += (int)$cnt;
<a name="l01126"></a>01126         }
<a name="l01127"></a>01127         <span class="keywordflow">return</span> $freq;
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129 }
<a name="l01130"></a>01130 
<a name="l01137"></a>01137 function idx_get_indexer() {
<a name="l01138"></a>01138     <span class="keyword">static</span> $Indexer = null;
<a name="l01139"></a>01139     <span class="keywordflow">if</span> (is_null($Indexer)) {
<a name="l01140"></a>01140         $Indexer = <span class="keyword">new</span> <a class="code" href="classDoku__Indexer.html" title="Class that encapsulates operations on the indexer database.">Doku_Indexer</a>();
<a name="l01141"></a>01141     }
<a name="l01142"></a>01142     <span class="keywordflow">return</span> $Indexer;
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 
<a name="l01151"></a>01151 function &amp; idx_get_stopwords() {
<a name="l01152"></a>01152     <span class="keyword">static</span> $stopwords = null;
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (is_null($stopwords)) {
<a name="l01154"></a>01154         global $conf;
<a name="l01155"></a>01155         $swfile = DOKU_INC.<span class="stringliteral">&#39;inc/lang/&#39;</span>.$conf[<span class="stringliteral">&#39;lang&#39;</span>].<span class="stringliteral">&#39;/stopwords.txt&#39;</span>;
<a name="l01156"></a>01156         <span class="keywordflow">if</span>(@file_exists($swfile)){
<a name="l01157"></a>01157             $stopwords = file($swfile, FILE_IGNORE_NEW_LINES);
<a name="l01158"></a>01158         }<span class="keywordflow">else</span>{
<a name="l01159"></a>01159             $stopwords = array();
<a name="l01160"></a>01160         }
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162     <span class="keywordflow">return</span> $stopwords;
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 
<a name="l01176"></a>01176 function idx_addPage($page, $verbose=<span class="keyword">false</span>, $force=<span class="keyword">false</span>) {
<a name="l01177"></a>01177     <span class="comment">// check if indexing needed</span>
<a name="l01178"></a>01178     $idxtag = metaFN($page,<span class="stringliteral">&#39;.indexed&#39;</span>);
<a name="l01179"></a>01179     <span class="keywordflow">if</span>(!$force &amp;&amp; @file_exists($idxtag)){
<a name="l01180"></a>01180         <span class="keywordflow">if</span>(trim(io_readFile($idxtag)) == idx_get_version()){
<a name="l01181"></a>01181             $last = @filemtime($idxtag);
<a name="l01182"></a>01182             <span class="keywordflow">if</span>($last &gt; @filemtime(wikiFN($page))){
<a name="l01183"></a>01183                 <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: index for $page up to date&quot;</span>.DOKU_LF);
<a name="l01184"></a>01184                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01185"></a>01185             }
<a name="l01186"></a>01186         }
<a name="l01187"></a>01187     }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     <span class="keywordflow">if</span> (!page_exists($page)) {
<a name="l01190"></a>01190         <span class="keywordflow">if</span> (!@file_exists($idxtag)) {
<a name="l01191"></a>01191             <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: $page does not exist, ignoring&quot;</span>.DOKU_LF);
<a name="l01192"></a>01192             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01193"></a>01193         }
<a name="l01194"></a>01194         $Indexer = idx_get_indexer();
<a name="l01195"></a>01195         $result = $Indexer-&gt;deletePage($page);
<a name="l01196"></a>01196         <span class="keywordflow">if</span> ($result === <span class="stringliteral">&quot;locked&quot;</span>) {
<a name="l01197"></a>01197             <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: locked&quot;</span>.DOKU_LF);
<a name="l01198"></a>01198             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01199"></a>01199         }
<a name="l01200"></a>01200         @unlink($idxtag);
<a name="l01201"></a>01201         <span class="keywordflow">return</span> $result;
<a name="l01202"></a>01202     }
<a name="l01203"></a>01203     $indexenabled = p_get_metadata($page, <span class="stringliteral">&#39;internal index&#39;</span>, METADATA_RENDER_UNLIMITED);
<a name="l01204"></a>01204     <span class="keywordflow">if</span> ($indexenabled === <span class="keyword">false</span>) {
<a name="l01205"></a>01205         $result = <span class="keyword">false</span>;
<a name="l01206"></a>01206         <span class="keywordflow">if</span> (@file_exists($idxtag)) {
<a name="l01207"></a>01207             $Indexer = idx_get_indexer();
<a name="l01208"></a>01208             $result = $Indexer-&gt;deletePage($page);
<a name="l01209"></a>01209             <span class="keywordflow">if</span> ($result === <span class="stringliteral">&quot;locked&quot;</span>) {
<a name="l01210"></a>01210                 <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: locked&quot;</span>.DOKU_LF);
<a name="l01211"></a>01211                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01212"></a>01212             }
<a name="l01213"></a>01213             @unlink($idxtag);
<a name="l01214"></a>01214         }
<a name="l01215"></a>01215         <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: index disabled for $page&quot;</span>.DOKU_LF);
<a name="l01216"></a>01216         <span class="keywordflow">return</span> $result;
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     $body = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01220"></a>01220     $metadata = array();
<a name="l01221"></a>01221     $metadata[<span class="stringliteral">&#39;title&#39;</span>] = p_get_metadata($page, <span class="stringliteral">&#39;title&#39;</span>, METADATA_RENDER_UNLIMITED);
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (($references = p_get_metadata($page, <span class="stringliteral">&#39;relation references&#39;</span>, METADATA_RENDER_UNLIMITED)) !== null)
<a name="l01223"></a>01223         $metadata[<span class="stringliteral">&#39;relation_references&#39;</span>] = array_keys($references);
<a name="l01224"></a>01224     <span class="keywordflow">else</span>
<a name="l01225"></a>01225         $metadata[<span class="stringliteral">&#39;relation_references&#39;</span>] = array();
<a name="l01226"></a>01226     $data = compact(<span class="stringliteral">&#39;page&#39;</span>, <span class="stringliteral">&#39;body&#39;</span>, <span class="stringliteral">&#39;metadata&#39;</span>);
<a name="l01227"></a>01227     $evt = <span class="keyword">new</span> <a class="code" href="classDoku__Event.html">Doku_Event</a>(<span class="stringliteral">&#39;INDEXER_PAGE_ADD&#39;</span>, $data);
<a name="l01228"></a>01228     <span class="keywordflow">if</span> ($evt-&gt;advise_before()) $data[<span class="stringliteral">&#39;body&#39;</span>] = $data[<span class="stringliteral">&#39;body&#39;</span>] . <span class="stringliteral">&quot; &quot;</span> . rawWiki($page);
<a name="l01229"></a>01229     $evt-&gt;advise_after();
<a name="l01230"></a>01230     unset($evt);
<a name="l01231"></a>01231     extract($data);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233     $Indexer = idx_get_indexer();
<a name="l01234"></a>01234     $result = $Indexer-&gt;addPageWords($page, $body);
<a name="l01235"></a>01235     <span class="keywordflow">if</span> ($result === <span class="stringliteral">&quot;locked&quot;</span>) {
<a name="l01236"></a>01236         <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: locked&quot;</span>.DOKU_LF);
<a name="l01237"></a>01237         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01238"></a>01238     }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     <span class="keywordflow">if</span> ($result) {
<a name="l01241"></a>01241         $result = $Indexer-&gt;addMetaKeys($page, $metadata);
<a name="l01242"></a>01242         <span class="keywordflow">if</span> ($result === <span class="stringliteral">&quot;locked&quot;</span>) {
<a name="l01243"></a>01243             <span class="keywordflow">if</span> ($verbose) print(<span class="stringliteral">&quot;Indexer: locked&quot;</span>.DOKU_LF);
<a name="l01244"></a>01244             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01245"></a>01245         }
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     <span class="keywordflow">if</span> ($result)
<a name="l01249"></a>01249         io_saveFile(metaFN($page,<span class="stringliteral">&#39;.indexed&#39;</span>), idx_get_version());
<a name="l01250"></a>01250     <span class="keywordflow">if</span> ($verbose) {
<a name="l01251"></a>01251         print(<span class="stringliteral">&quot;Indexer: finished&quot;</span>.DOKU_LF);
<a name="l01252"></a>01252         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01253"></a>01253     }
<a name="l01254"></a>01254     <span class="keywordflow">return</span> $result;
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01269"></a>01269 function idx_lookup(&amp;$words) {
<a name="l01270"></a>01270     $Indexer = idx_get_indexer();
<a name="l01271"></a>01271     <span class="keywordflow">return</span> $Indexer-&gt;lookup($words);
<a name="l01272"></a>01272 }
<a name="l01273"></a>01273 
<a name="l01278"></a>01278 function idx_tokenizer($string, $wc=<span class="keyword">false</span>) {
<a name="l01279"></a>01279     $Indexer = idx_get_indexer();
<a name="l01280"></a>01280     <span class="keywordflow">return</span> $Indexer-&gt;tokenizer($string, $wc);
<a name="l01281"></a>01281 }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="comment">/* For compatibility */</span>
<a name="l01284"></a>01284 
<a name="l01290"></a>01290 function idx_getIndex($idx, $suffix) {
<a name="l01291"></a>01291     global $conf;
<a name="l01292"></a>01292     $fn = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="charliteral">&#39;/&#39;</span>.$idx.$suffix.<span class="stringliteral">&#39;.idx&#39;</span>;
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (!@file_exists($fn)) <span class="keywordflow">return</span> array();
<a name="l01294"></a>01294     <span class="keywordflow">return</span> file($fn);
<a name="l01295"></a>01295 }
<a name="l01296"></a>01296 
<a name="l01305"></a>01305 function idx_listIndexLengths() {
<a name="l01306"></a>01306     global $conf;
<a name="l01307"></a>01307     <span class="comment">// testing what we have to do, create a cache file or not.</span>
<a name="l01308"></a>01308     <span class="keywordflow">if</span> ($conf[<span class="stringliteral">&#39;readdircache&#39;</span>] == 0) {
<a name="l01309"></a>01309         $docache = <span class="keyword">false</span>;
<a name="l01310"></a>01310     } <span class="keywordflow">else</span> {
<a name="l01311"></a>01311         clearstatcache();
<a name="l01312"></a>01312         <span class="keywordflow">if</span> (@file_exists($conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&#39;/lengths.idx&#39;</span>)
<a name="l01313"></a>01313         &amp;&amp; (time() &lt; @filemtime($conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&#39;/lengths.idx&#39;</span>) + $conf[<span class="stringliteral">&#39;readdircache&#39;</span>])) {
<a name="l01314"></a>01314             <span class="keywordflow">if</span> (($lengths = @file($conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&#39;/lengths.idx&#39;</span>, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES)) !== <span class="keyword">false</span>) {
<a name="l01315"></a>01315                 $idx = array();
<a name="l01316"></a>01316                 <span class="keywordflow">foreach</span> ($lengths as $length) {
<a name="l01317"></a>01317                     $idx[] = (int)$length;
<a name="l01318"></a>01318                 }
<a name="l01319"></a>01319                 <span class="keywordflow">return</span> $idx;
<a name="l01320"></a>01320             }
<a name="l01321"></a>01321         }
<a name="l01322"></a>01322         $docache = <span class="keyword">true</span>;
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325     <span class="keywordflow">if</span> ($conf[<span class="stringliteral">&#39;readdircache&#39;</span>] == 0 || $docache) {
<a name="l01326"></a>01326         $dir = @opendir($conf[<span class="stringliteral">&#39;indexdir&#39;</span>]);
<a name="l01327"></a>01327         <span class="keywordflow">if</span> ($dir === <span class="keyword">false</span>)
<a name="l01328"></a>01328             <span class="keywordflow">return</span> array();
<a name="l01329"></a>01329         $idx = array();
<a name="l01330"></a>01330         <span class="keywordflow">while</span> (($f = readdir($dir)) !== <span class="keyword">false</span>) {
<a name="l01331"></a>01331             <span class="keywordflow">if</span> (substr($f, 0, 1) == <span class="charliteral">&#39;i&#39;</span> &amp;&amp; substr($f, -4) == <span class="stringliteral">&#39;.idx&#39;</span>) {
<a name="l01332"></a>01332                 $i = substr($f, 1, -4);
<a name="l01333"></a>01333                 <span class="keywordflow">if</span> (is_numeric($i))
<a name="l01334"></a>01334                     $idx[] = (int)$i;
<a name="l01335"></a>01335             }
<a name="l01336"></a>01336         }
<a name="l01337"></a>01337         closedir($dir);
<a name="l01338"></a>01338         sort($idx);
<a name="l01339"></a>01339         <span class="comment">// save this in a file</span>
<a name="l01340"></a>01340         <span class="keywordflow">if</span> ($docache) {
<a name="l01341"></a>01341             $handle = @fopen($conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&#39;/lengths.idx&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);
<a name="l01342"></a>01342             @fwrite($handle, implode(<span class="stringliteral">&quot;\n&quot;</span>, $idx));
<a name="l01343"></a>01343             @fclose($handle);
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345         <span class="keywordflow">return</span> $idx;
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="keywordflow">return</span> array();
<a name="l01349"></a>01349 }
<a name="l01350"></a>01350 
<a name="l01359"></a>01359 function idx_indexLengths($filter) {
<a name="l01360"></a>01360     global $conf;
<a name="l01361"></a>01361     $idx = array();
<a name="l01362"></a>01362     <span class="keywordflow">if</span> (is_array($filter)) {
<a name="l01363"></a>01363         <span class="comment">// testing if index files exist only</span>
<a name="l01364"></a>01364         $path = $conf[<span class="stringliteral">&#39;indexdir&#39;</span>].<span class="stringliteral">&quot;/i&quot;</span>;
<a name="l01365"></a>01365         <span class="keywordflow">foreach</span> ($filter as $key =&gt; $value) {
<a name="l01366"></a>01366             <span class="keywordflow">if</span> (@file_exists($path.$key.<span class="stringliteral">&#39;.idx&#39;</span>))
<a name="l01367"></a>01367                 $idx[] = $key;
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369     } <span class="keywordflow">else</span> {
<a name="l01370"></a>01370         $lengths = idx_listIndexLengths();
<a name="l01371"></a>01371         <span class="keywordflow">foreach</span> ($lengths as $key =&gt; $length) {
<a name="l01372"></a>01372             <span class="comment">// keep all the values equal or superior</span>
<a name="l01373"></a>01373             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)$length &gt;= (<span class="keywordtype">int</span>)$filter)
<a name="l01374"></a>01374                 $idx[] = $length;
<a name="l01375"></a>01375         }
<a name="l01376"></a>01376     }
<a name="l01377"></a>01377     <span class="keywordflow">return</span> $idx;
<a name="l01378"></a>01378 }
<a name="l01379"></a>01379 
<a name="l01388"></a>01388 function idx_cleanName($name) {
<a name="l01389"></a>01389     $name = utf8_romanize(trim((<span class="keywordtype">string</span>)$name));
<a name="l01390"></a>01390     $name = preg_replace(<span class="stringliteral">&#39;#[ \./\\:-]+#&#39;</span>, <span class="charliteral">&#39;_&#39;</span>, $name);
<a name="l01391"></a>01391     $name = preg_replace(<span class="stringliteral">&#39;/[^A-Za-z0-9_]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $name);
<a name="l01392"></a>01392     <span class="keywordflow">return</span> strtolower($name);
<a name="l01393"></a>01393 }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 <span class="comment">//Setup VIM: ex: et ts=4 :</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
