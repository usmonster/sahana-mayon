<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: plugins/sfPhpExcelPlugin/lib/PHPExcel/PHPExcel/Shared/PDF/tcpdf.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>plugins/sfPhpExcelPlugin/lib/PHPExcel/PHPExcel/Shared/PDF/tcpdf.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">//============================================================+</span>
<a name="l00003"></a>00003 <span class="comment">// File name   : tcpdf.php</span>
<a name="l00004"></a>00004 <span class="comment">// Begin       : 2002-08-03</span>
<a name="l00005"></a>00005 <span class="comment">// Last Update : 2009-09-30</span>
<a name="l00006"></a>00006 <span class="comment">// Author      : Nicola Asuni - info@tecnick.com - http://www.tcpdf.org</span>
<a name="l00007"></a>00007 <span class="comment">// Version     : 4.8.009</span>
<a name="l00008"></a>00008 <span class="comment">// License     : GNU LGPL (http://www.gnu.org/copyleft/lesser.html)</span>
<a name="l00009"></a>00009 <span class="comment">//  ----------------------------------------------------------------------------</span>
<a name="l00010"></a>00010 <span class="comment">//  Copyright (C) 2002-2009  Nicola Asuni - Tecnick.com S.r.l.</span>
<a name="l00011"></a>00011 <span class="comment">//  </span>
<a name="l00012"></a>00012 <span class="comment">//  This program is free software: you can redistribute it and/or modify</span>
<a name="l00013"></a>00013 <span class="comment">//  it under the terms of the GNU Lesser General Public License as published by</span>
<a name="l00014"></a>00014 <span class="comment">//  the Free Software Foundation, either version 2.1 of the License, or</span>
<a name="l00015"></a>00015 <span class="comment">//  (at your option) any later version.</span>
<a name="l00016"></a>00016 <span class="comment">//  </span>
<a name="l00017"></a>00017 <span class="comment">//  This program is distributed in the hope that it will be useful,</span>
<a name="l00018"></a>00018 <span class="comment">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00019"></a>00019 <span class="comment">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00020"></a>00020 <span class="comment">//  GNU Lesser General Public License for more details.</span>
<a name="l00021"></a>00021 <span class="comment">//  </span>
<a name="l00022"></a>00022 <span class="comment">//  You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00023"></a>00023 <span class="comment">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00024"></a>00024 <span class="comment">//  </span>
<a name="l00025"></a>00025 <span class="comment">//  See LICENSE.TXT file for more information.</span>
<a name="l00026"></a>00026 <span class="comment">//  ----------------------------------------------------------------------------</span>
<a name="l00027"></a>00027 <span class="comment">//</span>
<a name="l00028"></a>00028 <span class="comment">// Description : This is a PHP class for generating PDF documents without </span>
<a name="l00029"></a>00029 <span class="comment">//               requiring external extensions.</span>
<a name="l00030"></a>00030 <span class="comment">//</span>
<a name="l00031"></a>00031 <span class="comment">// NOTE:</span>
<a name="l00032"></a>00032 <span class="comment">// This class was originally derived in 2002 from the Public </span>
<a name="l00033"></a>00033 <span class="comment">// Domain FPDF class by Olivier Plathey (http://www.fpdf.org), </span>
<a name="l00034"></a>00034 <span class="comment">// but now is almost entirely rewritten.</span>
<a name="l00035"></a>00035 <span class="comment">//</span>
<a name="l00036"></a>00036 <span class="comment">// Main features:</span>
<a name="l00037"></a>00037 <span class="comment">//  * no external libraries are required for the basic functions;</span>
<a name="l00038"></a>00038 <span class="comment">//  * supports all ISO page formats;</span>
<a name="l00039"></a>00039 <span class="comment">//  * supports custom page formats, margins and units of measure;</span>
<a name="l00040"></a>00040 <span class="comment">//  * supports UTF-8 Unicode and Right-To-Left languages;</span>
<a name="l00041"></a>00041 <span class="comment">//  * supports TrueTypeUnicode, OpenTypeUnicode, TrueType, OpenType, Type1 and CID-0 fonts;</span>
<a name="l00042"></a>00042 <span class="comment">//  * supports document encryption;</span>
<a name="l00043"></a>00043 <span class="comment">//  * includes methods to publish some XHTML code, including forms;</span>
<a name="l00044"></a>00044 <span class="comment">//  * includes graphic (geometric) and transformation methods;</span>
<a name="l00045"></a>00045 <span class="comment">//  * includes Javascript and Forms support;</span>
<a name="l00046"></a>00046 <span class="comment">//  * includes a method to print various barcode formats: CODE 39, ANSI MH10.8M-1983, USD-3, 3 of 9, CODE 93, USS-93, Standard 2 of 5, Interleaved 2 of 5, CODE 128 A/B/C, 2 and 5 Digits UPC-Based Extention, EAN 8, EAN 13, UPC-A, UPC-E, MSI, POSTNET, PLANET, RMS4CC (Royal Mail 4-state Customer Code), CBC (Customer Bar Code), KIX (Klant index - Customer index), Intelligent Mail Barcode, Onecode, USPS-B-3200, CODABAR, CODE 11, PHARMACODE, PHARMACODE TWO-TRACKS;</span>
<a name="l00047"></a>00047 <span class="comment">//  * includes methods to set Bookmarks and print a Table of Content;</span>
<a name="l00048"></a>00048 <span class="comment">//  * includes methods to move and delete pages;</span>
<a name="l00049"></a>00049 <span class="comment">//  * includes methods for automatic page header and footer management;</span>
<a name="l00050"></a>00050 <span class="comment">//  * supports automatic page break;</span>
<a name="l00051"></a>00051 <span class="comment">//  * supports automatic page numbering and page groups;</span>
<a name="l00052"></a>00052 <span class="comment">//  * supports automatic line break and text justification;</span>
<a name="l00053"></a>00053 <span class="comment">//  * supports JPEG and PNG images natively, all images supported by GD (GD, GD2, GD2PART, GIF, JPEG, PNG, BMP, XBM, XPM) and all images supported via ImagMagick (http://www.imagemagick.org/www/formats.html)</span>
<a name="l00054"></a>00054 <span class="comment">//  * supports stroke and clipping mode for text;</span>
<a name="l00055"></a>00055 <span class="comment">//  * supports clipping masks;</span>
<a name="l00056"></a>00056 <span class="comment">//  * supports Grayscale, RGB, CMYK, Spot Colors and Transparencies;</span>
<a name="l00057"></a>00057 <span class="comment">//  * supports several annotations, including links, text and file attachments;</span>
<a name="l00058"></a>00058 <span class="comment">//  * supports page compression (requires zlib extension);</span>
<a name="l00059"></a>00059 <span class="comment">//  * supports text hyphenation.</span>
<a name="l00060"></a>00060 <span class="comment">//  * supports transactions to UNDO commands.</span>
<a name="l00061"></a>00061 <span class="comment">//  * supports signature certifications.</span>
<a name="l00062"></a>00062 <span class="comment">//</span>
<a name="l00063"></a>00063 <span class="comment">// -----------------------------------------------------------</span>
<a name="l00064"></a>00064 <span class="comment">// THANKS TO:</span>
<a name="l00065"></a>00065 <span class="comment">// </span>
<a name="l00066"></a>00066 <span class="comment">// Olivier Plathey (http://www.fpdf.org) for original FPDF.</span>
<a name="l00067"></a>00067 <span class="comment">// Efthimios Mavrogeorgiadis (emavro@yahoo.com) for suggestions on RTL language support.</span>
<a name="l00068"></a>00068 <span class="comment">// Klemen Vodopivec (http://www.fpdf.de/downloads/addons/37/) for Encryption algorithm.</span>
<a name="l00069"></a>00069 <span class="comment">// Warren Sherliker (wsherliker@gmail.com) for better image handling.</span>
<a name="l00070"></a>00070 <span class="comment">// dullus for text Justification.</span>
<a name="l00071"></a>00071 <span class="comment">// Bob Vincent (pillarsdotnet@users.sourceforge.net) for &lt;li&gt; value attribute.</span>
<a name="l00072"></a>00072 <span class="comment">// Patrick Benny for text stretch suggestion on Cell().</span>
<a name="l00073"></a>00073 <span class="comment">// Johannes Güntert for JavaScript support.</span>
<a name="l00074"></a>00074 <span class="comment">// Denis Van Nuffelen for Dynamic Form.</span>
<a name="l00075"></a>00075 <span class="comment">// Jacek Czekaj for multibyte justification</span>
<a name="l00076"></a>00076 <span class="comment">// Anthony Ferrara for the reintroduction of legacy image methods.</span>
<a name="l00077"></a>00077 <span class="comment">// Sourceforge user 1707880 (hucste) for line-trough mode.</span>
<a name="l00078"></a>00078 <span class="comment">// Larry Stanbery for page groups.</span>
<a name="l00079"></a>00079 <span class="comment">// Martin Hall-May for transparency.</span>
<a name="l00080"></a>00080 <span class="comment">// Aaron C. Spike for Polycurve method.</span>
<a name="l00081"></a>00081 <span class="comment">// Mohamad Ali Golkar, Saleh AlMatrafe, Charles Abbott for Arabic and Persian support.</span>
<a name="l00082"></a>00082 <span class="comment">// Moritz Wagner and Andreas Wurmser for graphic functions.</span>
<a name="l00083"></a>00083 <span class="comment">// Andrew Whitehead for core fonts support.</span>
<a name="l00084"></a>00084 <span class="comment">// Esteban Joël Marín for OpenType font conversion.</span>
<a name="l00085"></a>00085 <span class="comment">// Teus Hagen for several suggestions and fixes.</span>
<a name="l00086"></a>00086 <span class="comment">// Yukihiro Nakadaira for CID-0 CJK fonts fixes.</span>
<a name="l00087"></a>00087 <span class="comment">// Kosmas Papachristos for some CSS improvements.</span>
<a name="l00088"></a>00088 <span class="comment">// Marcel Partap for some fixes.</span>
<a name="l00089"></a>00089 <span class="comment">// Won Kyu Park for several suggestions, fixes and patches.</span>
<a name="l00090"></a>00090 <span class="comment">// Anyone that has reported a bug or sent a suggestion.</span>
<a name="l00091"></a>00091 <span class="comment">//============================================================+</span>
<a name="l00092"></a>00092 
<a name="l00137"></a>00137 require_once(dirname(__FILE__).<span class="stringliteral">&#39;/config/tcpdf_config.php&#39;</span>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="comment">// includes some support files</span>
<a name="l00140"></a>00140 
<a name="l00144"></a>00144 require_once(dirname(__FILE__).<span class="stringliteral">&#39;/unicode_data.php&#39;</span>);
<a name="l00145"></a>00145 
<a name="l00149"></a>00149 require_once(dirname(__FILE__).<span class="stringliteral">&#39;/htmlcolors.php&#39;</span>);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="keywordflow">if</span> (!class_exists(<span class="stringliteral">&#39;TCPDF&#39;</span>, <span class="keyword">false</span>)) {
<a name="l00155"></a>00155   define(<span class="stringliteral">&#39;PDF_PRODUCER&#39;</span>, <span class="stringliteral">&#39;TCPDF 4.8.009 (http://www.tcpdf.org)&#39;</span>);
<a name="l00156"></a>00156   
<a name="l00167"></a>00167   <span class="keyword">class </span>TCPDF {
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <span class="comment">// protected or Protected properties</span>
<a name="l00170"></a>00170 
<a name="l00175"></a>00175     <span class="keyword">protected</span> $page;
<a name="l00176"></a>00176     
<a name="l00181"></a>00181     <span class="keyword">protected</span> $n;
<a name="l00182"></a>00182 
<a name="l00187"></a>00187     <span class="keyword">protected</span> $offsets;
<a name="l00188"></a>00188 
<a name="l00193"></a>00193     <span class="keyword">protected</span> $buffer;
<a name="l00194"></a>00194 
<a name="l00199"></a>00199     <span class="keyword">protected</span> $pages = array();
<a name="l00200"></a>00200 
<a name="l00205"></a>00205     <span class="keyword">protected</span> $state;
<a name="l00206"></a>00206 
<a name="l00211"></a>00211     <span class="keyword">protected</span> $compress;
<a name="l00212"></a>00212     
<a name="l00217"></a>00217     <span class="keyword">protected</span> $CurOrientation;
<a name="l00218"></a>00218 
<a name="l00223"></a>00223     <span class="keyword">protected</span> $pagedim = array();
<a name="l00224"></a>00224 
<a name="l00229"></a>00229     <span class="keyword">protected</span> $k;
<a name="l00230"></a>00230 
<a name="l00235"></a>00235     <span class="keyword">protected</span> $fwPt;
<a name="l00236"></a>00236 
<a name="l00241"></a>00241     <span class="keyword">protected</span> $fhPt;
<a name="l00242"></a>00242 
<a name="l00247"></a>00247     <span class="keyword">protected</span> $wPt;
<a name="l00248"></a>00248 
<a name="l00253"></a>00253     <span class="keyword">protected</span> $hPt;
<a name="l00254"></a>00254 
<a name="l00259"></a>00259     <span class="keyword">protected</span> $w;
<a name="l00260"></a>00260 
<a name="l00265"></a>00265     <span class="keyword">protected</span> $h;
<a name="l00266"></a>00266 
<a name="l00271"></a>00271     <span class="keyword">protected</span> $lMargin;
<a name="l00272"></a>00272 
<a name="l00277"></a>00277     <span class="keyword">protected</span> $tMargin;
<a name="l00278"></a>00278 
<a name="l00283"></a>00283     <span class="keyword">protected</span> $rMargin;
<a name="l00284"></a>00284 
<a name="l00289"></a>00289     <span class="keyword">protected</span> $bMargin;
<a name="l00290"></a>00290 
<a name="l00295"></a>00295     <span class="comment">//protected</span>
<a name="l00296"></a>00296     <span class="keyword">public</span> $cMargin;
<a name="l00297"></a>00297     
<a name="l00302"></a>00302     <span class="keyword">protected</span> $oldcMargin;
<a name="l00303"></a>00303 
<a name="l00308"></a>00308     <span class="keyword">protected</span> $x;
<a name="l00309"></a>00309 
<a name="l00314"></a>00314     <span class="keyword">protected</span> $y;
<a name="l00315"></a>00315 
<a name="l00320"></a>00320     <span class="keyword">protected</span> $lasth;
<a name="l00321"></a>00321 
<a name="l00326"></a>00326     <span class="keyword">protected</span> $LineWidth;
<a name="l00327"></a>00327 
<a name="l00332"></a>00332     <span class="keyword">protected</span> $CoreFonts;
<a name="l00333"></a>00333 
<a name="l00338"></a>00338     <span class="keyword">protected</span> $fonts = array();
<a name="l00339"></a>00339 
<a name="l00344"></a>00344     <span class="keyword">protected</span> $FontFiles = array();
<a name="l00345"></a>00345 
<a name="l00350"></a>00350     <span class="keyword">protected</span> $diffs = array();
<a name="l00351"></a>00351 
<a name="l00356"></a>00356     <span class="keyword">protected</span> $images = array();
<a name="l00357"></a>00357 
<a name="l00362"></a>00362     <span class="keyword">protected</span> $PageAnnots = array();
<a name="l00363"></a>00363 
<a name="l00368"></a>00368     <span class="keyword">protected</span> $links = array();
<a name="l00369"></a>00369 
<a name="l00374"></a>00374     <span class="keyword">protected</span> $FontFamily;
<a name="l00375"></a>00375 
<a name="l00380"></a>00380     <span class="keyword">protected</span> $FontStyle;
<a name="l00381"></a>00381     
<a name="l00387"></a>00387     <span class="keyword">protected</span> $FontAscent;
<a name="l00388"></a>00388     
<a name="l00394"></a>00394     <span class="keyword">protected</span> $FontDescent;
<a name="l00395"></a>00395 
<a name="l00400"></a>00400     <span class="keyword">protected</span> $underline;
<a name="l00401"></a>00401 
<a name="l00406"></a>00406     <span class="keyword">protected</span> $CurrentFont;
<a name="l00407"></a>00407 
<a name="l00412"></a>00412     <span class="keyword">protected</span> $FontSizePt;
<a name="l00413"></a>00413 
<a name="l00418"></a>00418     <span class="keyword">protected</span> $FontSize;
<a name="l00419"></a>00419 
<a name="l00424"></a>00424     <span class="keyword">protected</span> $DrawColor;
<a name="l00425"></a>00425 
<a name="l00430"></a>00430     <span class="keyword">protected</span> $FillColor;
<a name="l00431"></a>00431 
<a name="l00436"></a>00436     <span class="keyword">protected</span> $TextColor;
<a name="l00437"></a>00437 
<a name="l00442"></a>00442     <span class="keyword">protected</span> $ColorFlag;
<a name="l00443"></a>00443 
<a name="l00448"></a>00448     <span class="keyword">protected</span> $AutoPageBreak;
<a name="l00449"></a>00449 
<a name="l00454"></a>00454     <span class="keyword">protected</span> $PageBreakTrigger;
<a name="l00455"></a>00455 
<a name="l00460"></a>00460     <span class="keyword">protected</span> $InFooter = <span class="keyword">false</span>;
<a name="l00461"></a>00461 
<a name="l00466"></a>00466     <span class="keyword">protected</span> $ZoomMode;
<a name="l00467"></a>00467 
<a name="l00472"></a>00472     <span class="keyword">protected</span> $LayoutMode;
<a name="l00473"></a>00473 
<a name="l00478"></a>00478     <span class="keyword">protected</span> $title = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00479"></a>00479 
<a name="l00484"></a>00484     <span class="keyword">protected</span> $subject = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00485"></a>00485 
<a name="l00490"></a>00490     <span class="keyword">protected</span> $author = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00491"></a>00491 
<a name="l00496"></a>00496     <span class="keyword">protected</span> $keywords = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00497"></a>00497 
<a name="l00502"></a>00502     <span class="keyword">protected</span> $creator = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00503"></a>00503 
<a name="l00508"></a>00508     <span class="keyword">protected</span> $AliasNbPages = <span class="stringliteral">&#39;{nb}&#39;</span>;
<a name="l00509"></a>00509     
<a name="l00514"></a>00514     <span class="keyword">protected</span> $AliasNumPage = <span class="stringliteral">&#39;{pnb}&#39;</span>;
<a name="l00515"></a>00515     
<a name="l00522"></a>00522     <span class="keyword">protected</span> $img_rb_x;
<a name="l00523"></a>00523 
<a name="l00530"></a>00530     <span class="keyword">protected</span> $img_rb_y;
<a name="l00531"></a>00531 
<a name="l00538"></a>00538     <span class="keyword">protected</span> $imgscale = 1;
<a name="l00539"></a>00539 
<a name="l00546"></a>00546     <span class="keyword">protected</span> $isunicode = <span class="keyword">false</span>;
<a name="l00547"></a>00547 
<a name="l00553"></a>00553     <span class="keyword">protected</span> $PDFVersion = <span class="stringliteral">&#39;1.7&#39;</span>;
<a name="l00554"></a>00554     
<a name="l00555"></a>00555     
<a name="l00556"></a>00556     <span class="comment">// ----------------------</span>
<a name="l00557"></a>00557     
<a name="l00562"></a>00562     <span class="keyword">protected</span> $header_margin;
<a name="l00563"></a>00563     
<a name="l00568"></a>00568     <span class="keyword">protected</span> $footer_margin;
<a name="l00569"></a>00569     
<a name="l00575"></a>00575     <span class="keyword">protected</span> $original_lMargin;
<a name="l00576"></a>00576     
<a name="l00582"></a>00582     <span class="keyword">protected</span> $original_rMargin;
<a name="l00583"></a>00583       
<a name="l00588"></a>00588     <span class="keyword">protected</span> $header_font;
<a name="l00589"></a>00589     
<a name="l00594"></a>00594     <span class="keyword">protected</span> $footer_font;
<a name="l00595"></a>00595     
<a name="l00600"></a>00600     <span class="keyword">protected</span> $l;
<a name="l00601"></a>00601     
<a name="l00606"></a>00606     <span class="keyword">protected</span> $barcode = <span class="keyword">false</span>;
<a name="l00607"></a>00607     
<a name="l00612"></a>00612     <span class="keyword">protected</span> $print_header = <span class="keyword">true</span>;
<a name="l00613"></a>00613     
<a name="l00618"></a>00618     <span class="keyword">protected</span> $print_footer = <span class="keyword">true</span>;
<a name="l00619"></a>00619       
<a name="l00624"></a>00624     <span class="keyword">protected</span> $header_logo = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00625"></a>00625     
<a name="l00630"></a>00630     <span class="keyword">protected</span> $header_logo_width = 30;
<a name="l00631"></a>00631     
<a name="l00636"></a>00636     <span class="keyword">protected</span> $header_title = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00637"></a>00637     
<a name="l00642"></a>00642     <span class="keyword">protected</span> $header_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00643"></a>00643     
<a name="l00648"></a>00648     <span class="keyword">protected</span> $default_table_columns = 4;
<a name="l00649"></a>00649     
<a name="l00650"></a>00650     
<a name="l00651"></a>00651     <span class="comment">// variables for html parser</span>
<a name="l00652"></a>00652     
<a name="l00657"></a>00657     <span class="keyword">protected</span> $HREF = array();
<a name="l00658"></a>00658     
<a name="l00663"></a>00663     <span class="keyword">protected</span> $fontlist = array();
<a name="l00664"></a>00664     
<a name="l00669"></a>00669     <span class="keyword">protected</span> $fgcolor;
<a name="l00670"></a>00670             
<a name="l00675"></a>00675     <span class="keyword">protected</span> $listordered = array();
<a name="l00676"></a>00676     
<a name="l00681"></a>00681     <span class="keyword">protected</span> $listcount = array();
<a name="l00682"></a>00682     
<a name="l00687"></a>00687     <span class="keyword">protected</span> $listnum = 0;
<a name="l00688"></a>00688     
<a name="l00693"></a>00693     <span class="keyword">protected</span> $listindent;
<a name="l00694"></a>00694     
<a name="l00699"></a>00699     <span class="keyword">protected</span> $bgcolor;
<a name="l00700"></a>00700     
<a name="l00705"></a>00705     <span class="keyword">protected</span> $tempfontsize = 10;
<a name="l00706"></a>00706     
<a name="l00711"></a>00711     <span class="keyword">protected</span> $lispacer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00712"></a>00712     
<a name="l00718"></a>00718     <span class="keyword">protected</span> $encoding = <span class="stringliteral">&#39;UTF-8&#39;</span>;
<a name="l00719"></a>00719     
<a name="l00725"></a>00725     <span class="keyword">protected</span> $internal_encoding;
<a name="l00726"></a>00726     
<a name="l00732"></a>00732     <span class="keyword">protected</span> $rtl = <span class="keyword">false</span>;
<a name="l00733"></a>00733     
<a name="l00739"></a>00739     <span class="keyword">protected</span> $tmprtl = <span class="keyword">false</span>;
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     <span class="comment">// --- Variables used for document encryption:</span>
<a name="l00742"></a>00742     
<a name="l00748"></a>00748     <span class="keyword">protected</span> $encrypted;
<a name="l00749"></a>00749     
<a name="l00755"></a>00755     <span class="keyword">protected</span> $Uvalue;
<a name="l00756"></a>00756     
<a name="l00762"></a>00762     <span class="keyword">protected</span> $Ovalue;
<a name="l00763"></a>00763     
<a name="l00769"></a>00769     <span class="keyword">protected</span> $Pvalue;
<a name="l00770"></a>00770     
<a name="l00776"></a>00776     <span class="keyword">protected</span> $enc_obj_id;
<a name="l00777"></a>00777     
<a name="l00783"></a>00783     <span class="keyword">protected</span> $last_rc4_key;
<a name="l00784"></a>00784     
<a name="l00790"></a>00790     <span class="keyword">protected</span> $last_rc4_key_c;
<a name="l00791"></a>00791     
<a name="l00796"></a>00796     <span class="keyword">protected</span> $padding = <span class="stringliteral">&quot;\x28\xBF\x4E\x5E\x4E\x75\x8A\x41\x64\x00\x4E\x56\xFF\xFA\x01\x08\x2E\x2E\x00\xB6\xD0\x68\x3E\x80\x2F\x0C\xA9\xFE\x64\x53\x69\x7A&quot;</span>;
<a name="l00797"></a>00797     
<a name="l00802"></a>00802     <span class="keyword">protected</span> $encryption_key;
<a name="l00803"></a>00803     
<a name="l00804"></a>00804     <span class="comment">// --- bookmark ---</span>
<a name="l00805"></a>00805     
<a name="l00811"></a>00811     <span class="keyword">protected</span> $outlines = array();
<a name="l00812"></a>00812     
<a name="l00818"></a>00818     <span class="keyword">protected</span> $OutlineRoot;
<a name="l00819"></a>00819     
<a name="l00820"></a>00820     
<a name="l00821"></a>00821     <span class="comment">// --- javascript and form ---</span>
<a name="l00822"></a>00822     
<a name="l00828"></a>00828     <span class="keyword">protected</span> $javascript = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00829"></a>00829     
<a name="l00835"></a>00835     <span class="keyword">protected</span> $n_js;
<a name="l00836"></a>00836 
<a name="l00842"></a>00842     <span class="keyword">protected</span> $linethrough;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="comment">// --- Variables used for User&#39;s Rights ---</span>
<a name="l00845"></a>00845     <span class="comment">// See PDF reference chapter 8.7 Digital Signatures</span>
<a name="l00846"></a>00846 
<a name="l00852"></a>00852     <span class="keyword">protected</span> $ur;
<a name="l00853"></a>00853 
<a name="l00859"></a>00859     <span class="keyword">protected</span> $ur_document;
<a name="l00860"></a>00860 
<a name="l00866"></a>00866     <span class="keyword">protected</span> $ur_annots;
<a name="l00867"></a>00867 
<a name="l00873"></a>00873     <span class="keyword">protected</span> $ur_form;
<a name="l00874"></a>00874 
<a name="l00880"></a>00880     <span class="keyword">protected</span> $ur_signature;
<a name="l00881"></a>00881 
<a name="l00887"></a>00887     <span class="keyword">protected</span> $dpi = 72;
<a name="l00888"></a>00888     
<a name="l00894"></a>00894     <span class="keyword">protected</span> $newpagegroup = array();
<a name="l00895"></a>00895     
<a name="l00901"></a>00901     <span class="keyword">protected</span> $pagegroups;
<a name="l00902"></a>00902     
<a name="l00908"></a>00908     <span class="keyword">protected</span> $currpagegroup; 
<a name="l00909"></a>00909     
<a name="l00915"></a>00915     <span class="keyword">protected</span> $visibility = <span class="stringliteral">&#39;all&#39;</span>;
<a name="l00916"></a>00916     
<a name="l00922"></a>00922     <span class="keyword">protected</span> $n_ocg_print;
<a name="l00923"></a>00923     
<a name="l00929"></a>00929     <span class="keyword">protected</span> $n_ocg_view;
<a name="l00930"></a>00930     
<a name="l00936"></a>00936     <span class="keyword">protected</span> $extgstates;
<a name="l00937"></a>00937     
<a name="l00943"></a>00943     <span class="keyword">protected</span> $jpeg_quality;
<a name="l00944"></a>00944     
<a name="l00950"></a>00950     <span class="keyword">protected</span> $cell_height_ratio = K_CELL_HEIGHT_RATIO;
<a name="l00951"></a>00951     
<a name="l00957"></a>00957     <span class="keyword">protected</span> $viewer_preferences;
<a name="l00958"></a>00958     
<a name="l00964"></a>00964     <span class="keyword">protected</span> $PageMode;
<a name="l00965"></a>00965     
<a name="l00971"></a>00971     <span class="keyword">protected</span> $gradients = array();
<a name="l00972"></a>00972     
<a name="l00979"></a>00979     <span class="keyword">protected</span> $intmrk = array();
<a name="l00980"></a>00980     
<a name="l00987"></a>00987     <span class="keyword">protected</span> $cntmrk = array();
<a name="l00988"></a>00988     
<a name="l00994"></a>00994     <span class="keyword">protected</span> $footerpos = array();
<a name="l00995"></a>00995     
<a name="l00996"></a>00996     
<a name="l01002"></a>01002     <span class="keyword">protected</span> $footerlen = array();
<a name="l01003"></a>01003     
<a name="l01009"></a>01009     <span class="keyword">protected</span> $newline = <span class="keyword">true</span>;
<a name="l01010"></a>01010     
<a name="l01016"></a>01016     <span class="keyword">protected</span> $endlinex = 0;
<a name="l01017"></a>01017     
<a name="l01023"></a>01023     <span class="keyword">protected</span> $linestyleWidth = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01024"></a>01024     
<a name="l01030"></a>01030     <span class="keyword">protected</span> $linestyleCap = <span class="stringliteral">&#39;0 J&#39;</span>;
<a name="l01031"></a>01031     
<a name="l01037"></a>01037     <span class="keyword">protected</span> $linestyleJoin = <span class="stringliteral">&#39;0 j&#39;</span>;
<a name="l01038"></a>01038     
<a name="l01044"></a>01044     <span class="keyword">protected</span> $linestyleDash = <span class="stringliteral">&#39;[] 0 d&#39;</span>;
<a name="l01045"></a>01045     
<a name="l01051"></a>01051     <span class="keyword">protected</span> $openMarkedContent = <span class="keyword">false</span>;
<a name="l01052"></a>01052     
<a name="l01058"></a>01058     <span class="keyword">protected</span> $htmlvspace = 0;
<a name="l01059"></a>01059     
<a name="l01065"></a>01065     <span class="keyword">protected</span> $spot_colors = array();
<a name="l01066"></a>01066     
<a name="l01072"></a>01072     <span class="keyword">protected</span> $lisymbol = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01073"></a>01073     
<a name="l01079"></a>01079     <span class="keyword">protected</span> $epsmarker = <span class="stringliteral">&#39;x#!#EPS#!#x&#39;</span>;
<a name="l01080"></a>01080     
<a name="l01086"></a>01086     <span class="keyword">protected</span> $transfmatrix = array();
<a name="l01087"></a>01087 
<a name="l01093"></a>01093     <span class="keyword">protected</span> $transfmatrix_key = 0;
<a name="l01094"></a>01094 
<a name="l01100"></a>01100     <span class="keyword">protected</span> $booklet = <span class="keyword">false</span>;
<a name="l01101"></a>01101     
<a name="l01107"></a>01107     <span class="keyword">protected</span> $feps = 0.005;
<a name="l01108"></a>01108     
<a name="l01114"></a>01114     <span class="keyword">protected</span> $tagvspaces = array();
<a name="l01115"></a>01115     
<a name="l01122"></a>01122     <span class="keyword">protected</span> $customlistindent = -1;
<a name="l01123"></a>01123     
<a name="l01129"></a>01129     <span class="keyword">protected</span> $opencell = <span class="keyword">true</span>;
<a name="l01130"></a>01130 
<a name="l01136"></a>01136     <span class="keyword">protected</span> $embeddedfiles = array();
<a name="l01137"></a>01137 
<a name="l01143"></a>01143     <span class="keyword">protected</span> $premode = <span class="keyword">false</span>;
<a name="l01144"></a>01144 
<a name="l01151"></a>01151     <span class="keyword">protected</span> $transfmrk = array();
<a name="l01152"></a>01152 
<a name="l01158"></a>01158     <span class="keyword">protected</span> $htmlLinkColorArray = array(0, 0, 255);
<a name="l01159"></a>01159 
<a name="l01165"></a>01165     <span class="keyword">protected</span> $htmlLinkFontStyle = <span class="charliteral">&#39;U&#39;</span>;
<a name="l01166"></a>01166 
<a name="l01172"></a>01172     <span class="keyword">protected</span> $numpages = 0;
<a name="l01173"></a>01173 
<a name="l01179"></a>01179     <span class="keyword">protected</span> $pagelen = array();
<a name="l01180"></a>01180 
<a name="l01186"></a>01186     <span class="keyword">protected</span> $numimages = 0;
<a name="l01187"></a>01187 
<a name="l01193"></a>01193     <span class="keyword">protected</span> $imagekeys = array();
<a name="l01194"></a>01194 
<a name="l01200"></a>01200     <span class="keyword">protected</span> $bufferlen = 0;
<a name="l01201"></a>01201 
<a name="l01207"></a>01207     <span class="keyword">protected</span> $diskcache = <span class="keyword">false</span>;
<a name="l01208"></a>01208 
<a name="l01214"></a>01214     <span class="keyword">protected</span> $numfonts = 0;
<a name="l01215"></a>01215 
<a name="l01221"></a>01221     <span class="keyword">protected</span> $fontkeys = array();
<a name="l01222"></a>01222     
<a name="l01228"></a>01228     <span class="keyword">protected</span> $font_obj_ids = array();
<a name="l01229"></a>01229 
<a name="l01235"></a>01235     <span class="keyword">protected</span> $pageopen = array();
<a name="l01236"></a>01236     
<a name="l01242"></a>01242     <span class="keyword">protected</span> $default_monospaced_font = <span class="stringliteral">&#39;courier&#39;</span>;
<a name="l01243"></a>01243 
<a name="l01249"></a>01249     <span class="keyword">protected</span> $objcopy;
<a name="l01250"></a>01250 
<a name="l01256"></a>01256     <span class="keyword">protected</span> $cache_file_lenght = array();
<a name="l01257"></a>01257 
<a name="l01263"></a>01263     <span class="keyword">protected</span> $thead = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01264"></a>01264 
<a name="l01270"></a>01270     <span class="keyword">protected</span> $theadMargins = array();
<a name="l01271"></a>01271 
<a name="l01277"></a>01277     <span class="keyword">protected</span> $cache_UTF8StringToArray = array();
<a name="l01278"></a>01278 
<a name="l01284"></a>01284     <span class="keyword">protected</span> $cache_maxsize_UTF8StringToArray = 8;
<a name="l01285"></a>01285 
<a name="l01291"></a>01291     <span class="keyword">protected</span> $cache_size_UTF8StringToArray = 0;
<a name="l01292"></a>01292 
<a name="l01298"></a>01298     <span class="keyword">protected</span> $sign = <span class="keyword">false</span>;
<a name="l01299"></a>01299 
<a name="l01305"></a>01305     <span class="keyword">protected</span> $signature_data = array();
<a name="l01306"></a>01306 
<a name="l01312"></a>01312     <span class="keyword">protected</span> $signature_max_lenght = 11742;
<a name="l01313"></a>01313 
<a name="l01319"></a>01319     <span class="keyword">protected</span> $re_spaces = <span class="stringliteral">&#39;/[\s]/&#39;</span>;
<a name="l01320"></a>01320 
<a name="l01326"></a>01326     <span class="keyword">protected</span> $sig_obj_id = 0;
<a name="l01327"></a>01327 
<a name="l01333"></a>01333     <span class="keyword">protected</span> $byterange_string = <span class="stringliteral">&#39;/ByteRange[0 ********** ********** **********]&#39;</span>;
<a name="l01334"></a>01334 
<a name="l01340"></a>01340     <span class="keyword">protected</span> $sig_annot_ref = <span class="stringliteral">&#39;***SIGANNREF*** 0 R&#39;</span>;
<a name="l01341"></a>01341 
<a name="l01347"></a>01347     <span class="keyword">protected</span> $page_obj_id = array();
<a name="l01348"></a>01348 
<a name="l01354"></a>01354     <span class="keyword">protected</span> $embedded_start_obj_id = 100000;
<a name="l01355"></a>01355 
<a name="l01361"></a>01361     <span class="keyword">protected</span> $annots_start_obj_id = 200000;
<a name="l01362"></a>01362     
<a name="l01368"></a>01368     <span class="keyword">protected</span> $annot_obj_id = 200000;
<a name="l01369"></a>01369     
<a name="l01375"></a>01375     <span class="keyword">protected</span> $curr_annot_obj_id = 200000;
<a name="l01376"></a>01376     
<a name="l01382"></a>01382     <span class="keyword">protected</span> $form_obj_id = array();
<a name="l01383"></a>01383     
<a name="l01384"></a>01384     <span class="comment">/*</span>
<a name="l01385"></a>01385 <span class="comment">     * Deafult Javascript field properties. Possible values are described on official Javascript for Acrobat API reference. Annotation options can be directly specified using the &#39;aopt&#39; entry.</span>
<a name="l01386"></a>01386 <span class="comment">     * @access protected</span>
<a name="l01387"></a>01387 <span class="comment">     * @since 4.8.000 (2009-09-07)</span>
<a name="l01388"></a>01388 <span class="comment">     */</span>
<a name="l01389"></a>01389     <span class="keyword">protected</span> $default_form_prop = array(<span class="stringliteral">&#39;lineWidth&#39;</span>=&gt;1, <span class="stringliteral">&#39;borderStyle&#39;</span>=&gt;<span class="stringliteral">&#39;solid&#39;</span>, <span class="stringliteral">&#39;fillColor&#39;</span>=&gt;array(255, 255, 255), <span class="stringliteral">&#39;strokeColor&#39;</span>=&gt;array(128, 128, 128));
<a name="l01390"></a>01390 
<a name="l01396"></a>01396     <span class="keyword">protected</span> $js_objects = array();
<a name="l01397"></a>01397 
<a name="l01403"></a>01403     <span class="keyword">protected</span> $js_start_obj_id = 300000;
<a name="l01404"></a>01404     
<a name="l01410"></a>01410     <span class="keyword">protected</span> $js_obj_id = 300000;
<a name="l01411"></a>01411     
<a name="l01417"></a>01417     <span class="keyword">protected</span> $form_action = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01418"></a>01418 
<a name="l01424"></a>01424     <span class="keyword">protected</span> $form_enctype = <span class="stringliteral">&#39;application/x-www-form-urlencoded&#39;</span>;
<a name="l01425"></a>01425 
<a name="l01431"></a>01431     <span class="keyword">protected</span> $form_mode = <span class="stringliteral">&#39;post&#39;</span>;
<a name="l01432"></a>01432 
<a name="l01438"></a>01438     <span class="keyword">protected</span> $apxo_start_obj_id = 400000;
<a name="l01439"></a>01439     
<a name="l01445"></a>01445     <span class="keyword">protected</span> $apxo_obj_id = 400000;
<a name="l01446"></a>01446     
<a name="l01452"></a>01452     <span class="keyword">protected</span> $annotation_fonts = array();
<a name="l01453"></a>01453     
<a name="l01459"></a>01459     <span class="keyword">protected</span> $radiobutton_groups = array();
<a name="l01460"></a>01460     
<a name="l01466"></a>01466     <span class="keyword">protected</span> $radio_groups = array();
<a name="l01467"></a>01467     
<a name="l01473"></a>01473     <span class="keyword">protected</span> $textindent = 0;
<a name="l01474"></a>01474     
<a name="l01480"></a>01480     <span class="keyword">protected</span> $start_transaction_page = 0;
<a name="l01481"></a>01481     
<a name="l01482"></a>01482     <span class="comment">//------------------------------------------------------------</span>
<a name="l01483"></a>01483     <span class="comment">// METHODS</span>
<a name="l01484"></a>01484     <span class="comment">//------------------------------------------------------------</span>
<a name="l01485"></a>01485 
<a name="l01499"></a>01499     <span class="keyword">public</span> function __construct($orientation=<span class="charliteral">&#39;P&#39;</span>, $unit=<span class="stringliteral">&#39;mm&#39;</span>, $format=<span class="stringliteral">&#39;A4&#39;</span>, $unicode=<span class="keyword">true</span>, $encoding=<span class="stringliteral">&#39;UTF-8&#39;</span>, $diskcache=<span class="keyword">false</span>) {
<a name="l01500"></a>01500       <span class="comment">/* Set internal character encoding to ASCII */</span>
<a name="l01501"></a>01501       <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;mb_internal_encoding&#39;</span>) AND mb_internal_encoding()) {
<a name="l01502"></a>01502         $this-&gt;internal_encoding = mb_internal_encoding();
<a name="l01503"></a>01503         mb_internal_encoding(<span class="stringliteral">&#39;ASCII&#39;</span>);
<a name="l01504"></a>01504       }
<a name="l01505"></a>01505       <span class="comment">// set disk caching</span>
<a name="l01506"></a>01506       $this-&gt;diskcache = $diskcache ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01507"></a>01507       <span class="comment">// set language direction</span>
<a name="l01508"></a>01508       $this-&gt;rtl = <span class="keyword">false</span>;
<a name="l01509"></a>01509       $this-&gt;tmprtl = <span class="keyword">false</span>;
<a name="l01510"></a>01510       <span class="comment">//Some checks</span>
<a name="l01511"></a>01511       $this-&gt;_dochecks();
<a name="l01512"></a>01512       <span class="comment">//Initialization of properties</span>
<a name="l01513"></a>01513       $this-&gt;isunicode = $unicode;
<a name="l01514"></a>01514       $this-&gt;page = 0;
<a name="l01515"></a>01515       $this-&gt;transfmrk[0] = array();
<a name="l01516"></a>01516       $this-&gt;pagedim = array();
<a name="l01517"></a>01517       $this-&gt;n = 2;
<a name="l01518"></a>01518       $this-&gt;buffer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01519"></a>01519       $this-&gt;pages = array();
<a name="l01520"></a>01520       $this-&gt;state = 0;
<a name="l01521"></a>01521       $this-&gt;fonts = array();
<a name="l01522"></a>01522       $this-&gt;FontFiles = array();
<a name="l01523"></a>01523       $this-&gt;diffs = array();
<a name="l01524"></a>01524       $this-&gt;images = array();
<a name="l01525"></a>01525       $this-&gt;links = array();
<a name="l01526"></a>01526       $this-&gt;gradients = array();
<a name="l01527"></a>01527       $this-&gt;InFooter = <span class="keyword">false</span>;
<a name="l01528"></a>01528       $this-&gt;lasth = 0;
<a name="l01529"></a>01529       $this-&gt;FontFamily = <span class="stringliteral">&#39;helvetica&#39;</span>;
<a name="l01530"></a>01530       $this-&gt;FontStyle = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01531"></a>01531       $this-&gt;FontSizePt = 12;
<a name="l01532"></a>01532       $this-&gt;underline = <span class="keyword">false</span>;
<a name="l01533"></a>01533       $this-&gt;linethrough = <span class="keyword">false</span>;
<a name="l01534"></a>01534       $this-&gt;DrawColor = <span class="stringliteral">&#39;0 G&#39;</span>;
<a name="l01535"></a>01535       $this-&gt;FillColor = <span class="stringliteral">&#39;0 g&#39;</span>;
<a name="l01536"></a>01536       $this-&gt;TextColor = <span class="stringliteral">&#39;0 g&#39;</span>;
<a name="l01537"></a>01537       $this-&gt;ColorFlag = <span class="keyword">false</span>;
<a name="l01538"></a>01538       <span class="comment">// encryption values</span>
<a name="l01539"></a>01539       $this-&gt;encrypted = <span class="keyword">false</span>;
<a name="l01540"></a>01540       $this-&gt;last_rc4_key = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01541"></a>01541       $this-&gt;padding = <span class="stringliteral">&quot;\x28\xBF\x4E\x5E\x4E\x75\x8A\x41\x64\x00\x4E\x56\xFF\xFA\x01\x08\x2E\x2E\x00\xB6\xD0\x68\x3E\x80\x2F\x0C\xA9\xFE\x64\x53\x69\x7A&quot;</span>;
<a name="l01542"></a>01542       <span class="comment">//Standard Unicode fonts</span>
<a name="l01543"></a>01543       $this-&gt;CoreFonts = array(
<a name="l01544"></a>01544         <span class="stringliteral">&#39;courier&#39;</span>=&gt;<span class="stringliteral">&#39;Courier&#39;</span>,
<a name="l01545"></a>01545         <span class="stringliteral">&#39;courierB&#39;</span>=&gt;<span class="stringliteral">&#39;Courier-Bold&#39;</span>,
<a name="l01546"></a>01546         <span class="stringliteral">&#39;courierI&#39;</span>=&gt;<span class="stringliteral">&#39;Courier-Oblique&#39;</span>,
<a name="l01547"></a>01547         <span class="stringliteral">&#39;courierBI&#39;</span>=&gt;<span class="stringliteral">&#39;Courier-BoldOblique&#39;</span>,
<a name="l01548"></a>01548         <span class="stringliteral">&#39;helvetica&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica&#39;</span>,
<a name="l01549"></a>01549         <span class="stringliteral">&#39;helveticaB&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica-Bold&#39;</span>,
<a name="l01550"></a>01550         <span class="stringliteral">&#39;helveticaI&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica-Oblique&#39;</span>,
<a name="l01551"></a>01551         <span class="stringliteral">&#39;helveticaBI&#39;</span>=&gt;<span class="stringliteral">&#39;Helvetica-BoldOblique&#39;</span>,
<a name="l01552"></a>01552         <span class="stringliteral">&#39;times&#39;</span>=&gt;<span class="stringliteral">&#39;Times-Roman&#39;</span>,
<a name="l01553"></a>01553         <span class="stringliteral">&#39;timesB&#39;</span>=&gt;<span class="stringliteral">&#39;Times-Bold&#39;</span>,
<a name="l01554"></a>01554         <span class="stringliteral">&#39;timesI&#39;</span>=&gt;<span class="stringliteral">&#39;Times-Italic&#39;</span>,
<a name="l01555"></a>01555         <span class="stringliteral">&#39;timesBI&#39;</span>=&gt;<span class="stringliteral">&#39;Times-BoldItalic&#39;</span>,
<a name="l01556"></a>01556         <span class="stringliteral">&#39;symbol&#39;</span>=&gt;<span class="stringliteral">&#39;Symbol&#39;</span>,
<a name="l01557"></a>01557         <span class="stringliteral">&#39;zapfdingbats&#39;</span>=&gt;<span class="stringliteral">&#39;ZapfDingbats&#39;</span>
<a name="l01558"></a>01558       );
<a name="l01559"></a>01559       <span class="comment">//Set scale factor</span>
<a name="l01560"></a>01560       $this-&gt;setPageUnit($unit);
<a name="l01561"></a>01561       <span class="comment">// set page format and orientation</span>
<a name="l01562"></a>01562       $this-&gt;setPageFormat($format, $orientation);
<a name="l01563"></a>01563       <span class="comment">//Page margins (1 cm)</span>
<a name="l01564"></a>01564       $margin = 28.35 / $this-&gt;k;
<a name="l01565"></a>01565       $this-&gt;SetMargins($margin, $margin);
<a name="l01566"></a>01566       <span class="comment">//Interior cell margin</span>
<a name="l01567"></a>01567       $this-&gt;cMargin = $margin / 10;
<a name="l01568"></a>01568       <span class="comment">//Line width (0.2 mm)</span>
<a name="l01569"></a>01569       $this-&gt;LineWidth = 0.57 / $this-&gt;k;
<a name="l01570"></a>01570       $this-&gt;linestyleWidth = sprintf(<span class="stringliteral">&#39;%.2F w&#39;</span>, ($this-&gt;LineWidth * $this-&gt;k));
<a name="l01571"></a>01571       $this-&gt;linestyleCap = <span class="stringliteral">&#39;0 J&#39;</span>;
<a name="l01572"></a>01572       $this-&gt;linestyleJoin = <span class="stringliteral">&#39;0 j&#39;</span>;
<a name="l01573"></a>01573       $this-&gt;linestyleDash = <span class="stringliteral">&#39;[] 0 d&#39;</span>;
<a name="l01574"></a>01574       <span class="comment">//Automatic page break</span>
<a name="l01575"></a>01575       $this-&gt;SetAutoPageBreak(<span class="keyword">true</span>, (2 * $margin));
<a name="l01576"></a>01576       <span class="comment">//Full width display mode</span>
<a name="l01577"></a>01577       $this-&gt;SetDisplayMode(<span class="stringliteral">&#39;fullwidth&#39;</span>);
<a name="l01578"></a>01578       <span class="comment">//Compression</span>
<a name="l01579"></a>01579       $this-&gt;SetCompression(<span class="keyword">true</span>);
<a name="l01580"></a>01580       <span class="comment">//Set default PDF version number</span>
<a name="l01581"></a>01581       $this-&gt;PDFVersion = <span class="stringliteral">&#39;1.7&#39;</span>;
<a name="l01582"></a>01582       $this-&gt;encoding = $encoding;
<a name="l01583"></a>01583       $this-&gt;HREF = array();
<a name="l01584"></a>01584       $this-&gt;getFontsList();
<a name="l01585"></a>01585       $this-&gt;fgcolor = array(<span class="charliteral">&#39;R&#39;</span> =&gt; 0, <span class="charliteral">&#39;G&#39;</span> =&gt; 0, <span class="charliteral">&#39;B&#39;</span> =&gt; 0);
<a name="l01586"></a>01586       $this-&gt;bgcolor = array(<span class="charliteral">&#39;R&#39;</span> =&gt; 255, <span class="charliteral">&#39;G&#39;</span> =&gt; 255, <span class="charliteral">&#39;B&#39;</span> =&gt; 255);
<a name="l01587"></a>01587       $this-&gt;extgstates = array();
<a name="l01588"></a>01588       <span class="comment">// user&#39;s rights</span>
<a name="l01589"></a>01589       $this-&gt;sign = <span class="keyword">false</span>;
<a name="l01590"></a>01590       $this-&gt;ur = <span class="keyword">false</span>;
<a name="l01591"></a>01591       $this-&gt;ur_document = <span class="stringliteral">&#39;/FullSave&#39;</span>;
<a name="l01592"></a>01592       $this-&gt;ur_annots = <span class="stringliteral">&#39;/Create/Delete/Modify/Copy/Import/Export&#39;</span>;
<a name="l01593"></a>01593       $this-&gt;ur_form = <span class="stringliteral">&#39;/Add/Delete/FillIn/Import/Export/SubmitStandalone/SpawnTemplate&#39;</span>;
<a name="l01594"></a>01594       $this-&gt;ur_signature = <span class="stringliteral">&#39;/Modify&#39;</span>;      
<a name="l01595"></a>01595       <span class="comment">// set default JPEG quality</span>
<a name="l01596"></a>01596       $this-&gt;jpeg_quality = 75;
<a name="l01597"></a>01597       <span class="comment">// initialize some settings</span>
<a name="l01598"></a>01598       $this-&gt;utf8Bidi(array(<span class="stringliteral">&#39;&#39;</span>), <span class="stringliteral">&#39;&#39;</span>);
<a name="l01599"></a>01599       <span class="comment">// set default font</span>
<a name="l01600"></a>01600       $this-&gt;SetFont($this-&gt;FontFamily, $this-&gt;FontStyle, $this-&gt;FontSizePt);
<a name="l01601"></a>01601       <span class="comment">// check if PCRE Unicode support is enabled</span>
<a name="l01602"></a>01602       <span class="keywordflow">if</span> ($this-&gt;isunicode AND (@preg_match(<span class="stringliteral">&#39;/\pL/u&#39;</span>, <span class="charliteral">&#39;a&#39;</span>) == 1)) {
<a name="l01603"></a>01603         <span class="comment">// PCRE unicode support is turned ON</span>
<a name="l01604"></a>01604         <span class="comment">// \p{Z} or \p{Separator}: any kind of Unicode whitespace or invisible separator.</span>
<a name="l01605"></a>01605         <span class="comment">// \p{Lo} or \p{Other_Letter}: a Unicode letter or ideograph that does not have lowercase and uppercase variants.</span>
<a name="l01606"></a>01606         <span class="comment">// \p{Lo} is needed because Chinese characters are packed next to each other without spaces in between.</span>
<a name="l01607"></a>01607         <span class="comment">//$this-&gt;re_spaces = &#39;/[\s\p{Z}\p{Lo}]/u&#39;;</span>
<a name="l01608"></a>01608         $this-&gt;re_spaces = <span class="stringliteral">&#39;/[\s\p{Z}]/u&#39;</span>;
<a name="l01609"></a>01609       } <span class="keywordflow">else</span> {
<a name="l01610"></a>01610         <span class="comment">// PCRE unicode support is turned OFF</span>
<a name="l01611"></a>01611         $this-&gt;re_spaces = <span class="stringliteral">&#39;/[\s]/&#39;</span>;
<a name="l01612"></a>01612       }
<a name="l01613"></a>01613       $this-&gt;annot_obj_id = $this-&gt;annots_start_obj_id;
<a name="l01614"></a>01614       $this-&gt;curr_annot_obj_id = $this-&gt;annots_start_obj_id;
<a name="l01615"></a>01615       $this-&gt;apxo_obj_id = $this-&gt;apxo_start_obj_id;
<a name="l01616"></a>01616       $this-&gt;js_obj_id = $this-&gt;js_start_obj_id;
<a name="l01617"></a>01617       $this-&gt;default_form_prop = array(<span class="stringliteral">&#39;lineWidth&#39;</span>=&gt;1, <span class="stringliteral">&#39;borderStyle&#39;</span>=&gt;<span class="stringliteral">&#39;solid&#39;</span>, <span class="stringliteral">&#39;fillColor&#39;</span>=&gt;array(255, 255, 255), <span class="stringliteral">&#39;strokeColor&#39;</span>=&gt;array(128, 128, 128));
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619     
<a name="l01625"></a>01625     <span class="keyword">public</span> function __destruct() {
<a name="l01626"></a>01626       <span class="comment">// restore internal encoding</span>
<a name="l01627"></a>01627       <span class="keywordflow">if</span> (isset($this-&gt;internal_encoding) AND !empty($this-&gt;internal_encoding)) {
<a name="l01628"></a>01628         mb_internal_encoding($this-&gt;internal_encoding);
<a name="l01629"></a>01629       }
<a name="l01630"></a>01630       <span class="comment">// unset all class variables</span>
<a name="l01631"></a>01631       $this-&gt;_destroy(<span class="keyword">true</span>);
<a name="l01632"></a>01632     }
<a name="l01633"></a>01633     
<a name="l01640"></a>01640     <span class="keyword">public</span> function setPageUnit($unit) {
<a name="l01641"></a>01641     <span class="comment">//Set scale factor</span>
<a name="l01642"></a>01642       <span class="keywordflow">switch</span> (strtolower($unit)) {
<a name="l01643"></a>01643         <span class="comment">// points</span>
<a name="l01644"></a>01644         <span class="keywordflow">case</span> <span class="stringliteral">&#39;px&#39;</span>:
<a name="l01645"></a>01645         <span class="keywordflow">case</span> <span class="stringliteral">&#39;pt&#39;</span>: {
<a name="l01646"></a>01646           $this-&gt;k = 1;
<a name="l01647"></a>01647           <span class="keywordflow">break</span>;
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649         <span class="comment">// millimeters</span>
<a name="l01650"></a>01650         <span class="keywordflow">case</span> <span class="stringliteral">&#39;mm&#39;</span>: {
<a name="l01651"></a>01651           $this-&gt;k = $this-&gt;dpi / 25.4;
<a name="l01652"></a>01652           <span class="keywordflow">break</span>;
<a name="l01653"></a>01653         }
<a name="l01654"></a>01654         <span class="comment">// centimeters</span>
<a name="l01655"></a>01655         <span class="keywordflow">case</span> <span class="stringliteral">&#39;cm&#39;</span>: {
<a name="l01656"></a>01656           $this-&gt;k = $this-&gt;dpi / 2.54;
<a name="l01657"></a>01657           <span class="keywordflow">break</span>;
<a name="l01658"></a>01658         }
<a name="l01659"></a>01659         <span class="comment">// inches</span>
<a name="l01660"></a>01660         <span class="keywordflow">case</span> <span class="stringliteral">&#39;in&#39;</span>: {
<a name="l01661"></a>01661           $this-&gt;k = $this-&gt;dpi;
<a name="l01662"></a>01662           <span class="keywordflow">break</span>;
<a name="l01663"></a>01663         }
<a name="l01664"></a>01664         <span class="comment">// unsupported unit</span>
<a name="l01665"></a>01665         <span class="keywordflow">default</span> : {
<a name="l01666"></a>01666           $this-&gt;Error(<span class="stringliteral">&#39;Incorrect unit: &#39;</span>.$unit);
<a name="l01667"></a>01667           <span class="keywordflow">break</span>;
<a name="l01668"></a>01668         }
<a name="l01669"></a>01669       }
<a name="l01670"></a>01670       <span class="keywordflow">if</span> (isset($this-&gt;CurOrientation)) {
<a name="l01671"></a>01671           $this-&gt;setPageOrientation($this-&gt;CurOrientation);
<a name="l01672"></a>01672       }
<a name="l01673"></a>01673     }
<a name="l01674"></a>01674     
<a name="l01682"></a>01682     <span class="keyword">public</span> function setPageFormat($format, $orientation=<span class="charliteral">&#39;P&#39;</span>) {
<a name="l01683"></a>01683       <span class="comment">//Page format</span>
<a name="l01684"></a>01684       <span class="keywordflow">if</span> (is_string($format)) {
<a name="l01685"></a>01685         <span class="comment">// Page formats (45 standard ISO paper formats and 4 american common formats).</span>
<a name="l01686"></a>01686         <span class="comment">// Paper cordinates are calculated in this way: (inches * 72) where (1 inch = 2.54 cm)</span>
<a name="l01687"></a>01687         <span class="keywordflow">switch</span> (strtoupper($format)) {
<a name="l01688"></a>01688           <span class="keywordflow">case</span> <span class="stringliteral">&#39;4A0&#39;</span>: {$format = array(4767.87,6740.79); <span class="keywordflow">break</span>;}
<a name="l01689"></a>01689           <span class="keywordflow">case</span> <span class="stringliteral">&#39;2A0&#39;</span>: {$format = array(3370.39,4767.87); <span class="keywordflow">break</span>;}
<a name="l01690"></a>01690           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A0&#39;</span>: {$format = array(2383.94,3370.39); <span class="keywordflow">break</span>;}
<a name="l01691"></a>01691           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A1&#39;</span>: {$format = array(1683.78,2383.94); <span class="keywordflow">break</span>;}
<a name="l01692"></a>01692           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A2&#39;</span>: {$format = array(1190.55,1683.78); <span class="keywordflow">break</span>;}
<a name="l01693"></a>01693           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A3&#39;</span>: {$format = array(841.89,1190.55); <span class="keywordflow">break</span>;}
<a name="l01694"></a>01694           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A4&#39;</span>: <span class="keywordflow">default</span>: {$format = array(595.28,841.89); <span class="keywordflow">break</span>;}
<a name="l01695"></a>01695           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A5&#39;</span>: {$format = array(419.53,595.28); <span class="keywordflow">break</span>;}
<a name="l01696"></a>01696           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A6&#39;</span>: {$format = array(297.64,419.53); <span class="keywordflow">break</span>;}
<a name="l01697"></a>01697           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A7&#39;</span>: {$format = array(209.76,297.64); <span class="keywordflow">break</span>;}
<a name="l01698"></a>01698           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A8&#39;</span>: {$format = array(147.40,209.76); <span class="keywordflow">break</span>;}
<a name="l01699"></a>01699           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A9&#39;</span>: {$format = array(104.88,147.40); <span class="keywordflow">break</span>;}
<a name="l01700"></a>01700           <span class="keywordflow">case</span> <span class="stringliteral">&#39;A10&#39;</span>: {$format = array(73.70,104.88); <span class="keywordflow">break</span>;}
<a name="l01701"></a>01701           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B0&#39;</span>: {$format = array(2834.65,4008.19); <span class="keywordflow">break</span>;}
<a name="l01702"></a>01702           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B1&#39;</span>: {$format = array(2004.09,2834.65); <span class="keywordflow">break</span>;}
<a name="l01703"></a>01703           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B2&#39;</span>: {$format = array(1417.32,2004.09); <span class="keywordflow">break</span>;}
<a name="l01704"></a>01704           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B3&#39;</span>: {$format = array(1000.63,1417.32); <span class="keywordflow">break</span>;}
<a name="l01705"></a>01705           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B4&#39;</span>: {$format = array(708.66,1000.63); <span class="keywordflow">break</span>;}
<a name="l01706"></a>01706           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B5&#39;</span>: {$format = array(498.90,708.66); <span class="keywordflow">break</span>;}
<a name="l01707"></a>01707           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B6&#39;</span>: {$format = array(354.33,498.90); <span class="keywordflow">break</span>;}
<a name="l01708"></a>01708           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B7&#39;</span>: {$format = array(249.45,354.33); <span class="keywordflow">break</span>;}
<a name="l01709"></a>01709           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B8&#39;</span>: {$format = array(175.75,249.45); <span class="keywordflow">break</span>;}
<a name="l01710"></a>01710           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B9&#39;</span>: {$format = array(124.72,175.75); <span class="keywordflow">break</span>;}
<a name="l01711"></a>01711           <span class="keywordflow">case</span> <span class="stringliteral">&#39;B10&#39;</span>: {$format = array(87.87,124.72); <span class="keywordflow">break</span>;}
<a name="l01712"></a>01712           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C0&#39;</span>: {$format = array(2599.37,3676.54); <span class="keywordflow">break</span>;}
<a name="l01713"></a>01713           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C1&#39;</span>: {$format = array(1836.85,2599.37); <span class="keywordflow">break</span>;}
<a name="l01714"></a>01714           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C2&#39;</span>: {$format = array(1298.27,1836.85); <span class="keywordflow">break</span>;}
<a name="l01715"></a>01715           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C3&#39;</span>: {$format = array(918.43,1298.27); <span class="keywordflow">break</span>;}
<a name="l01716"></a>01716           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C4&#39;</span>: {$format = array(649.13,918.43); <span class="keywordflow">break</span>;}
<a name="l01717"></a>01717           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C5&#39;</span>: {$format = array(459.21,649.13); <span class="keywordflow">break</span>;}
<a name="l01718"></a>01718           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C6&#39;</span>: {$format = array(323.15,459.21); <span class="keywordflow">break</span>;}
<a name="l01719"></a>01719           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C7&#39;</span>: {$format = array(229.61,323.15); <span class="keywordflow">break</span>;}
<a name="l01720"></a>01720           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C8&#39;</span>: {$format = array(161.57,229.61); <span class="keywordflow">break</span>;}
<a name="l01721"></a>01721           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C9&#39;</span>: {$format = array(113.39,161.57); <span class="keywordflow">break</span>;}
<a name="l01722"></a>01722           <span class="keywordflow">case</span> <span class="stringliteral">&#39;C10&#39;</span>: {$format = array(79.37,113.39); <span class="keywordflow">break</span>;}
<a name="l01723"></a>01723           <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA0&#39;</span>: {$format = array(2437.80,3458.27); <span class="keywordflow">break</span>;}
<a name="l01724"></a>01724           <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA1&#39;</span>: {$format = array(1729.13,2437.80); <span class="keywordflow">break</span>;}
<a name="l01725"></a>01725           <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA2&#39;</span>: {$format = array(1218.90,1729.13); <span class="keywordflow">break</span>;}
<a name="l01726"></a>01726           <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA3&#39;</span>: {$format = array(864.57,1218.90); <span class="keywordflow">break</span>;}
<a name="l01727"></a>01727           <span class="keywordflow">case</span> <span class="stringliteral">&#39;RA4&#39;</span>: {$format = array(609.45,864.57); <span class="keywordflow">break</span>;}
<a name="l01728"></a>01728           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA0&#39;</span>: {$format = array(2551.18,3628.35); <span class="keywordflow">break</span>;}
<a name="l01729"></a>01729           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA1&#39;</span>: {$format = array(1814.17,2551.18); <span class="keywordflow">break</span>;}
<a name="l01730"></a>01730           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA2&#39;</span>: {$format = array(1275.59,1814.17); <span class="keywordflow">break</span>;}
<a name="l01731"></a>01731           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA3&#39;</span>: {$format = array(907.09,1275.59); <span class="keywordflow">break</span>;}
<a name="l01732"></a>01732           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SRA4&#39;</span>: {$format = array(637.80,907.09); <span class="keywordflow">break</span>;}
<a name="l01733"></a>01733           <span class="keywordflow">case</span> <span class="stringliteral">&#39;LETTER&#39;</span>: {$format = array(612.00,792.00); <span class="keywordflow">break</span>;}
<a name="l01734"></a>01734           <span class="keywordflow">case</span> <span class="stringliteral">&#39;LEGAL&#39;</span>: {$format = array(612.00,1008.00); <span class="keywordflow">break</span>;}
<a name="l01735"></a>01735           <span class="keywordflow">case</span> <span class="stringliteral">&#39;EXECUTIVE&#39;</span>: {$format = array(521.86,756.00); <span class="keywordflow">break</span>;}
<a name="l01736"></a>01736           <span class="keywordflow">case</span> <span class="stringliteral">&#39;FOLIO&#39;</span>: {$format = array(612.00,936.00); <span class="keywordflow">break</span>;}
<a name="l01737"></a>01737         }
<a name="l01738"></a>01738         $this-&gt;fwPt = $format[0];
<a name="l01739"></a>01739         $this-&gt;fhPt = $format[1];
<a name="l01740"></a>01740       } <span class="keywordflow">else</span> {
<a name="l01741"></a>01741         $this-&gt;fwPt = $format[0] * $this-&gt;k;
<a name="l01742"></a>01742         $this-&gt;fhPt = $format[1] * $this-&gt;k;
<a name="l01743"></a>01743       }
<a name="l01744"></a>01744       $this-&gt;setPageOrientation($orientation);
<a name="l01745"></a>01745     }
<a name="l01746"></a>01746     
<a name="l01755"></a>01755     <span class="keyword">public</span> function setPageOrientation($orientation, $autopagebreak=<span class="stringliteral">&#39;&#39;</span>, $bottommargin=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l01756"></a>01756       $orientation = strtoupper($orientation);
<a name="l01757"></a>01757       <span class="keywordflow">if</span> (($orientation == <span class="charliteral">&#39;P&#39;</span>) OR ($orientation == <span class="stringliteral">&#39;PORTRAIT&#39;</span>)) {
<a name="l01758"></a>01758         $this-&gt;CurOrientation = <span class="charliteral">&#39;P&#39;</span>;
<a name="l01759"></a>01759         $this-&gt;wPt = $this-&gt;fwPt;
<a name="l01760"></a>01760         $this-&gt;hPt = $this-&gt;fhPt;
<a name="l01761"></a>01761       } elseif (($orientation == <span class="charliteral">&#39;L&#39;</span>) OR ($orientation == <span class="stringliteral">&#39;LANDSCAPE&#39;</span>)) {
<a name="l01762"></a>01762         $this-&gt;CurOrientation = <span class="charliteral">&#39;L&#39;</span>;
<a name="l01763"></a>01763         $this-&gt;wPt = $this-&gt;fhPt;
<a name="l01764"></a>01764         $this-&gt;hPt = $this-&gt;fwPt;
<a name="l01765"></a>01765       } <span class="keywordflow">else</span> {
<a name="l01766"></a>01766         $this-&gt;Error(<span class="stringliteral">&#39;Incorrect orientation: &#39;</span>.$orientation);
<a name="l01767"></a>01767       }
<a name="l01768"></a>01768       $this-&gt;w = $this-&gt;wPt / $this-&gt;k;
<a name="l01769"></a>01769       $this-&gt;h = $this-&gt;hPt / $this-&gt;k;
<a name="l01770"></a>01770       <span class="keywordflow">if</span> ($this-&gt;empty_string($autopagebreak)) {
<a name="l01771"></a>01771         <span class="keywordflow">if</span> (isset($this-&gt;AutoPageBreak)) {
<a name="l01772"></a>01772           $autopagebreak = $this-&gt;AutoPageBreak;
<a name="l01773"></a>01773         } <span class="keywordflow">else</span> {
<a name="l01774"></a>01774           $autopagebreak = <span class="keyword">true</span>;
<a name="l01775"></a>01775         }
<a name="l01776"></a>01776       }
<a name="l01777"></a>01777       <span class="keywordflow">if</span> ($this-&gt;empty_string($bottommargin)) {
<a name="l01778"></a>01778         <span class="keywordflow">if</span> (isset($this-&gt;bMargin)) {
<a name="l01779"></a>01779           $bottommargin = $this-&gt;bMargin;
<a name="l01780"></a>01780         } <span class="keywordflow">else</span> {
<a name="l01781"></a>01781           <span class="comment">// default value = 2 cm</span>
<a name="l01782"></a>01782           $bottommargin = 2 * 28.35 / $this-&gt;k;
<a name="l01783"></a>01783         }
<a name="l01784"></a>01784       }
<a name="l01785"></a>01785       $this-&gt;SetAutoPageBreak($autopagebreak, $bottommargin);
<a name="l01786"></a>01786       <span class="comment">// store page dimensions</span>
<a name="l01787"></a>01787       $this-&gt;pagedim[$this-&gt;page] = array(<span class="charliteral">&#39;w&#39;</span> =&gt; $this-&gt;wPt, <span class="charliteral">&#39;h&#39;</span> =&gt; $this-&gt;hPt, <span class="stringliteral">&#39;wk&#39;</span> =&gt; $this-&gt;w, <span class="stringliteral">&#39;hk&#39;</span> =&gt; $this-&gt;h, <span class="stringliteral">&#39;tm&#39;</span> =&gt; $this-&gt;tMargin, <span class="stringliteral">&#39;bm&#39;</span> =&gt; $bottommargin, <span class="stringliteral">&#39;lm&#39;</span> =&gt; $this-&gt;lMargin, <span class="stringliteral">&#39;rm&#39;</span> =&gt; $this-&gt;rMargin, <span class="stringliteral">&#39;pb&#39;</span> =&gt; $autopagebreak, <span class="stringliteral">&#39;or&#39;</span> =&gt; $this-&gt;CurOrientation, <span class="stringliteral">&#39;olm&#39;</span> =&gt; $this-&gt;original_lMargin, <span class="stringliteral">&#39;orm&#39;</span> =&gt; $this-&gt;original_rMargin);
<a name="l01788"></a>01788     }
<a name="l01789"></a>01789     
<a name="l01796"></a>01796     <span class="keyword">public</span> function setSpacesRE($re=<span class="stringliteral">&#39;/[\s]/&#39;</span>) {
<a name="l01797"></a>01797       <span class="comment">// if PCRE unicode support is turned ON:</span>
<a name="l01798"></a>01798       <span class="comment">//  \p{Z} or \p{Separator}: any kind of Unicode whitespace or invisible separator.</span>
<a name="l01799"></a>01799       <span class="comment">//  \p{Lo} or \p{Other_Letter}: a Unicode letter or ideograph that does not have lowercase and uppercase variants.</span>
<a name="l01800"></a>01800       <span class="comment">//  \p{Lo} is needed because Chinese characters are packed next to each other without spaces in between.</span>
<a name="l01801"></a>01801       $this-&gt;re_spaces = $re;
<a name="l01802"></a>01802     }
<a name="l01803"></a>01803       
<a name="l01811"></a>01811     <span class="keyword">public</span> function setRTL($enable, $resetx=<span class="keyword">true</span>) {
<a name="l01812"></a>01812       $enable = $enable ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01813"></a>01813       $resetx = ($resetx AND ($enable != $this-&gt;rtl));
<a name="l01814"></a>01814       $this-&gt;rtl = $enable;
<a name="l01815"></a>01815       $this-&gt;tmprtl = <span class="keyword">false</span>;
<a name="l01816"></a>01816       <span class="keywordflow">if</span> ($resetx) {
<a name="l01817"></a>01817         $this-&gt;Ln(0);
<a name="l01818"></a>01818       }
<a name="l01819"></a>01819     }
<a name="l01820"></a>01820     
<a name="l01827"></a>01827     <span class="keyword">public</span> function getRTL() {
<a name="l01828"></a>01828       <span class="keywordflow">return</span> $this-&gt;rtl;
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830     
<a name="l01837"></a>01837     <span class="keyword">public</span> function setTempRTL($mode) {
<a name="l01838"></a>01838       <span class="keywordflow">switch</span> ($mode) {
<a name="l01839"></a>01839         <span class="keywordflow">case</span> <span class="keyword">false</span>:
<a name="l01840"></a>01840         <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:
<a name="l01841"></a>01841         <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>: {
<a name="l01842"></a>01842           $this-&gt;tmprtl = $mode;
<a name="l01843"></a>01843         }
<a name="l01844"></a>01844       }
<a name="l01845"></a>01845     }
<a name="l01846"></a>01846     
<a name="l01854"></a>01854     <span class="keyword">public</span> function setLastH($h) {
<a name="l01855"></a>01855       $this-&gt;lasth = $h;
<a name="l01856"></a>01856     }
<a name="l01857"></a>01857     
<a name="l01864"></a>01864     <span class="keyword">public</span> function getLastH() {
<a name="l01865"></a>01865       <span class="keywordflow">return</span> $this-&gt;lasth;
<a name="l01866"></a>01866     }
<a name="l01867"></a>01867     
<a name="l01875"></a>01875     <span class="keyword">public</span> function setImageScale($scale) {
<a name="l01876"></a>01876       $this-&gt;imgscale = $scale;
<a name="l01877"></a>01877     }
<a name="l01878"></a>01878 
<a name="l01886"></a>01886     <span class="keyword">public</span> function getImageScale() {
<a name="l01887"></a>01887       <span class="keywordflow">return</span> $this-&gt;imgscale;
<a name="l01888"></a>01888     }
<a name="l01889"></a>01889         
<a name="l01899"></a>01899     <span class="keyword">public</span> function getPageDimensions($pagenum=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l01900"></a>01900       <span class="keywordflow">if</span> (empty($pagenum)) {
<a name="l01901"></a>01901         $pagenum = $this-&gt;page;
<a name="l01902"></a>01902       }
<a name="l01903"></a>01903       <span class="keywordflow">return</span> $this-&gt;pagedim[$pagenum];
<a name="l01904"></a>01904     }
<a name="l01905"></a>01905     
<a name="l01915"></a>01915     <span class="keyword">public</span> function getPageWidth($pagenum=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l01916"></a>01916       <span class="keywordflow">if</span> (empty($pagenum)) {
<a name="l01917"></a>01917         <span class="keywordflow">return</span> $this-&gt;w;
<a name="l01918"></a>01918       }
<a name="l01919"></a>01919       <span class="keywordflow">return</span> $this-&gt;pagedim[$pagenum][<span class="charliteral">&#39;w&#39;</span>];
<a name="l01920"></a>01920     }
<a name="l01921"></a>01921 
<a name="l01931"></a>01931     <span class="keyword">public</span> function getPageHeight($pagenum=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l01932"></a>01932       <span class="keywordflow">if</span> (empty($pagenum)) {
<a name="l01933"></a>01933         <span class="keywordflow">return</span> $this-&gt;h;
<a name="l01934"></a>01934       }
<a name="l01935"></a>01935       <span class="keywordflow">return</span> $this-&gt;pagedim[$pagenum][<span class="charliteral">&#39;h&#39;</span>];
<a name="l01936"></a>01936     }
<a name="l01937"></a>01937 
<a name="l01947"></a>01947     <span class="keyword">public</span> function getBreakMargin($pagenum=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l01948"></a>01948       <span class="keywordflow">if</span> (empty($pagenum)) {
<a name="l01949"></a>01949         <span class="keywordflow">return</span> $this-&gt;bMargin;
<a name="l01950"></a>01950       }
<a name="l01951"></a>01951       <span class="keywordflow">return</span> $this-&gt;pagedim[$pagenum][<span class="stringliteral">&#39;bm&#39;</span>];
<a name="l01952"></a>01952     }
<a name="l01953"></a>01953 
<a name="l01961"></a>01961     <span class="keyword">public</span> function getScaleFactor() {
<a name="l01962"></a>01962       <span class="keywordflow">return</span> $this-&gt;k;
<a name="l01963"></a>01963     }
<a name="l01964"></a>01964 
<a name="l01974"></a>01974     <span class="keyword">public</span> function SetMargins($left, $top, $right=-1) {
<a name="l01975"></a>01975       <span class="comment">//Set left, top and right margins</span>
<a name="l01976"></a>01976       $this-&gt;lMargin = $left;
<a name="l01977"></a>01977       $this-&gt;tMargin = $top;
<a name="l01978"></a>01978       <span class="keywordflow">if</span> ($right == -1) {
<a name="l01979"></a>01979         $right = $left;
<a name="l01980"></a>01980       }
<a name="l01981"></a>01981       $this-&gt;rMargin = $right;
<a name="l01982"></a>01982     }
<a name="l01983"></a>01983 
<a name="l01991"></a>01991     <span class="keyword">public</span> function SetLeftMargin($margin) {
<a name="l01992"></a>01992       <span class="comment">//Set left margin</span>
<a name="l01993"></a>01993       $this-&gt;lMargin=$margin;
<a name="l01994"></a>01994       <span class="keywordflow">if</span> (($this-&gt;page &gt; 0) AND ($this-&gt;x &lt; $margin)) {
<a name="l01995"></a>01995         $this-&gt;x = $margin;
<a name="l01996"></a>01996       }
<a name="l01997"></a>01997     }
<a name="l01998"></a>01998 
<a name="l02006"></a>02006     <span class="keyword">public</span> function SetTopMargin($margin) {
<a name="l02007"></a>02007       <span class="comment">//Set top margin</span>
<a name="l02008"></a>02008       $this-&gt;tMargin=$margin;
<a name="l02009"></a>02009       <span class="keywordflow">if</span> (($this-&gt;page &gt; 0) AND ($this-&gt;y &lt; $margin)) {
<a name="l02010"></a>02010         $this-&gt;y = $margin;
<a name="l02011"></a>02011       }
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013 
<a name="l02021"></a>02021     <span class="keyword">public</span> function SetRightMargin($margin) {
<a name="l02022"></a>02022       $this-&gt;rMargin=$margin;
<a name="l02023"></a>02023       <span class="keywordflow">if</span> (($this-&gt;page &gt; 0) AND ($this-&gt;x &gt; ($this-&gt;w - $margin))) {
<a name="l02024"></a>02024         $this-&gt;x = $this-&gt;w - $margin;
<a name="l02025"></a>02025       }
<a name="l02026"></a>02026     }
<a name="l02027"></a>02027 
<a name="l02035"></a>02035     <span class="keyword">public</span> function SetCellPadding($pad) {
<a name="l02036"></a>02036       $this-&gt;cMargin = $pad;
<a name="l02037"></a>02037     }
<a name="l02038"></a>02038 
<a name="l02047"></a>02047     <span class="keyword">public</span> function SetAutoPageBreak($auto, $margin=0) {
<a name="l02048"></a>02048       <span class="comment">//Set auto page break mode and triggering margin</span>
<a name="l02049"></a>02049       $this-&gt;AutoPageBreak = $auto;
<a name="l02050"></a>02050       $this-&gt;bMargin = $margin;
<a name="l02051"></a>02051       $this-&gt;PageBreakTrigger = $this-&gt;h - $margin;
<a name="l02052"></a>02052     }
<a name="l02053"></a>02053 
<a name="l02062"></a>02062     <span class="keyword">public</span> function SetDisplayMode($zoom, $layout=<span class="stringliteral">&#39;SinglePage&#39;</span>, $mode=<span class="stringliteral">&#39;UseNone&#39;</span>) {
<a name="l02063"></a>02063       <span class="comment">//Set display mode in viewer</span>
<a name="l02064"></a>02064       <span class="keywordflow">if</span> (($zoom == <span class="stringliteral">&#39;fullpage&#39;</span>) OR ($zoom == <span class="stringliteral">&#39;fullwidth&#39;</span>) OR ($zoom == <span class="stringliteral">&#39;real&#39;</span>) OR ($zoom == <span class="stringliteral">&#39;default&#39;</span>) OR (!is_string($zoom))) {
<a name="l02065"></a>02065         $this-&gt;ZoomMode = $zoom;
<a name="l02066"></a>02066       } <span class="keywordflow">else</span> {
<a name="l02067"></a>02067         $this-&gt;Error(<span class="stringliteral">&#39;Incorrect zoom display mode: &#39;</span>.$zoom);
<a name="l02068"></a>02068       }
<a name="l02069"></a>02069       <span class="keywordflow">switch</span> ($layout) {
<a name="l02070"></a>02070         <span class="keywordflow">case</span> <span class="stringliteral">&#39;default&#39;</span>:
<a name="l02071"></a>02071         <span class="keywordflow">case</span> <span class="stringliteral">&#39;single&#39;</span>:
<a name="l02072"></a>02072         <span class="keywordflow">case</span> <span class="stringliteral">&#39;SinglePage&#39;</span>: {
<a name="l02073"></a>02073           $this-&gt;LayoutMode = <span class="stringliteral">&#39;SinglePage&#39;</span>;
<a name="l02074"></a>02074           <span class="keywordflow">break</span>;
<a name="l02075"></a>02075         }
<a name="l02076"></a>02076         <span class="keywordflow">case</span> <span class="stringliteral">&#39;continuous&#39;</span>:
<a name="l02077"></a>02077         <span class="keywordflow">case</span> <span class="stringliteral">&#39;OneColumn&#39;</span>: {
<a name="l02078"></a>02078           $this-&gt;LayoutMode = <span class="stringliteral">&#39;OneColumn&#39;</span>;
<a name="l02079"></a>02079           <span class="keywordflow">break</span>;
<a name="l02080"></a>02080         }
<a name="l02081"></a>02081         <span class="keywordflow">case</span> <span class="stringliteral">&#39;two&#39;</span>:
<a name="l02082"></a>02082         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TwoColumnLeft&#39;</span>: {
<a name="l02083"></a>02083           $this-&gt;LayoutMode = <span class="stringliteral">&#39;TwoColumnLeft&#39;</span>;
<a name="l02084"></a>02084           <span class="keywordflow">break</span>;
<a name="l02085"></a>02085         }
<a name="l02086"></a>02086         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TwoColumnRight&#39;</span>: {
<a name="l02087"></a>02087           $this-&gt;LayoutMode = <span class="stringliteral">&#39;TwoColumnRight&#39;</span>;
<a name="l02088"></a>02088           <span class="keywordflow">break</span>;
<a name="l02089"></a>02089         }
<a name="l02090"></a>02090         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TwoPageLeft&#39;</span>: {
<a name="l02091"></a>02091           $this-&gt;LayoutMode = <span class="stringliteral">&#39;TwoPageLeft&#39;</span>;
<a name="l02092"></a>02092           <span class="keywordflow">break</span>;
<a name="l02093"></a>02093         }
<a name="l02094"></a>02094         <span class="keywordflow">case</span> <span class="stringliteral">&#39;TwoPageRight&#39;</span>: {
<a name="l02095"></a>02095           $this-&gt;LayoutMode = <span class="stringliteral">&#39;TwoPageRight&#39;</span>;
<a name="l02096"></a>02096           <span class="keywordflow">break</span>;
<a name="l02097"></a>02097         }
<a name="l02098"></a>02098         <span class="keywordflow">default</span>: {
<a name="l02099"></a>02099           $this-&gt;LayoutMode = <span class="stringliteral">&#39;SinglePage&#39;</span>;
<a name="l02100"></a>02100         }
<a name="l02101"></a>02101       }
<a name="l02102"></a>02102       <span class="keywordflow">switch</span> ($mode) {
<a name="l02103"></a>02103         <span class="keywordflow">case</span> <span class="stringliteral">&#39;UseNone&#39;</span>: {
<a name="l02104"></a>02104           $this-&gt;PageMode = <span class="stringliteral">&#39;UseNone&#39;</span>;
<a name="l02105"></a>02105           <span class="keywordflow">break</span>;
<a name="l02106"></a>02106         }
<a name="l02107"></a>02107         <span class="keywordflow">case</span> <span class="stringliteral">&#39;UseOutlines&#39;</span>: {
<a name="l02108"></a>02108           $this-&gt;PageMode = <span class="stringliteral">&#39;UseOutlines&#39;</span>;
<a name="l02109"></a>02109           <span class="keywordflow">break</span>;
<a name="l02110"></a>02110         }
<a name="l02111"></a>02111         <span class="keywordflow">case</span> <span class="stringliteral">&#39;UseThumbs&#39;</span>: {
<a name="l02112"></a>02112           $this-&gt;PageMode = <span class="stringliteral">&#39;UseThumbs&#39;</span>;
<a name="l02113"></a>02113           <span class="keywordflow">break</span>;
<a name="l02114"></a>02114         }
<a name="l02115"></a>02115         <span class="keywordflow">case</span> <span class="stringliteral">&#39;FullScreen&#39;</span>: {
<a name="l02116"></a>02116           $this-&gt;PageMode = <span class="stringliteral">&#39;FullScreen&#39;</span>;
<a name="l02117"></a>02117           <span class="keywordflow">break</span>;
<a name="l02118"></a>02118         }
<a name="l02119"></a>02119         <span class="keywordflow">case</span> <span class="stringliteral">&#39;UseOC&#39;</span>: {
<a name="l02120"></a>02120           $this-&gt;PageMode = <span class="stringliteral">&#39;UseOC&#39;</span>;
<a name="l02121"></a>02121           <span class="keywordflow">break</span>;
<a name="l02122"></a>02122         }
<a name="l02123"></a>02123         <span class="keywordflow">case</span> <span class="stringliteral">&#39;&#39;</span>: {
<a name="l02124"></a>02124           $this-&gt;PageMode = <span class="stringliteral">&#39;UseAttachments&#39;</span>;
<a name="l02125"></a>02125           <span class="keywordflow">break</span>;
<a name="l02126"></a>02126         }
<a name="l02127"></a>02127         <span class="keywordflow">default</span>: {
<a name="l02128"></a>02128           $this-&gt;PageMode = <span class="stringliteral">&#39;UseNone&#39;</span>;
<a name="l02129"></a>02129         }
<a name="l02130"></a>02130       }
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132 
<a name="l02140"></a>02140     <span class="keyword">public</span> function SetCompression($compress) {
<a name="l02141"></a>02141       <span class="comment">//Set page compression</span>
<a name="l02142"></a>02142       <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;gzcompress&#39;</span>)) {
<a name="l02143"></a>02143         $this-&gt;compress = $compress;
<a name="l02144"></a>02144       } <span class="keywordflow">else</span> {
<a name="l02145"></a>02145         $this-&gt;compress = <span class="keyword">false</span>;
<a name="l02146"></a>02146       }
<a name="l02147"></a>02147     }
<a name="l02148"></a>02148 
<a name="l02156"></a>02156     <span class="keyword">public</span> function SetTitle($title) {
<a name="l02157"></a>02157       <span class="comment">//Title of document</span>
<a name="l02158"></a>02158       $this-&gt;title = $title;
<a name="l02159"></a>02159     }
<a name="l02160"></a>02160 
<a name="l02168"></a>02168     <span class="keyword">public</span> function SetSubject($subject) {
<a name="l02169"></a>02169       <span class="comment">//Subject of document</span>
<a name="l02170"></a>02170       $this-&gt;subject = $subject;
<a name="l02171"></a>02171     }
<a name="l02172"></a>02172 
<a name="l02180"></a>02180     <span class="keyword">public</span> function SetAuthor($author) {
<a name="l02181"></a>02181       <span class="comment">//Author of document</span>
<a name="l02182"></a>02182       $this-&gt;author = $author;
<a name="l02183"></a>02183     }
<a name="l02184"></a>02184 
<a name="l02192"></a>02192     <span class="keyword">public</span> function SetKeywords($keywords) {
<a name="l02193"></a>02193       <span class="comment">//Keywords of document</span>
<a name="l02194"></a>02194       $this-&gt;keywords = $keywords;
<a name="l02195"></a>02195     }
<a name="l02196"></a>02196 
<a name="l02204"></a>02204     <span class="keyword">public</span> function SetCreator($creator) {
<a name="l02205"></a>02205       <span class="comment">//Creator of document</span>
<a name="l02206"></a>02206       $this-&gt;creator = $creator;
<a name="l02207"></a>02207     }
<a name="l02208"></a>02208     
<a name="l02216"></a>02216     <span class="keyword">public</span> function Error($msg) {
<a name="l02217"></a>02217       <span class="comment">// unset all class variables</span>
<a name="l02218"></a>02218       $this-&gt;_destroy(<span class="keyword">true</span>);
<a name="l02219"></a>02219       <span class="comment">// exit program and print error</span>
<a name="l02220"></a>02220       die(<span class="stringliteral">&#39;&lt;strong&gt;TCPDF ERROR: &lt;/strong&gt;&#39;</span>.$msg);
<a name="l02221"></a>02221     }
<a name="l02222"></a>02222 
<a name="l02231"></a>02231     <span class="keyword">public</span> function Open() {
<a name="l02232"></a>02232       <span class="comment">//Begin document</span>
<a name="l02233"></a>02233       $this-&gt;state = 1;
<a name="l02234"></a>02234     }
<a name="l02235"></a>02235 
<a name="l02244"></a>02244     <span class="keyword">public</span> function Close() {
<a name="l02245"></a>02245       <span class="keywordflow">if</span> ($this-&gt;state == 3) {
<a name="l02246"></a>02246         <span class="keywordflow">return</span>;
<a name="l02247"></a>02247       }
<a name="l02248"></a>02248       <span class="keywordflow">if</span> ($this-&gt;page == 0) {
<a name="l02249"></a>02249         $this-&gt;AddPage();
<a name="l02250"></a>02250       }
<a name="l02251"></a>02251       <span class="comment">// close page</span>
<a name="l02252"></a>02252       $this-&gt;endPage();
<a name="l02253"></a>02253       <span class="comment">// close document</span>
<a name="l02254"></a>02254       $this-&gt;_enddoc();
<a name="l02255"></a>02255       <span class="comment">// unset all class variables (except critical ones)</span>
<a name="l02256"></a>02256       $this-&gt;_destroy(<span class="keyword">false</span>);
<a name="l02257"></a>02257     }
<a name="l02258"></a>02258     
<a name="l02267"></a>02267     <span class="keyword">public</span> function setPage($pnum, $resetmargins=<span class="keyword">false</span>) {
<a name="l02268"></a>02268       <span class="keywordflow">if</span> ($pnum == $this-&gt;page) {
<a name="l02269"></a>02269         <span class="keywordflow">return</span>;
<a name="l02270"></a>02270       }
<a name="l02271"></a>02271       <span class="keywordflow">if</span> (($pnum &gt; 0) AND ($pnum &lt;= $this-&gt;numpages)) {
<a name="l02272"></a>02272         $this-&gt;state = 2;
<a name="l02273"></a>02273         <span class="comment">// save current graphic settings</span>
<a name="l02274"></a>02274         <span class="comment">//$gvars = $this-&gt;getGraphicVars();</span>
<a name="l02275"></a>02275         $oldpage = $this-&gt;page;
<a name="l02276"></a>02276         $this-&gt;page = $pnum;
<a name="l02277"></a>02277         $this-&gt;wPt = $this-&gt;pagedim[$this-&gt;page][<span class="charliteral">&#39;w&#39;</span>];
<a name="l02278"></a>02278         $this-&gt;hPt = $this-&gt;pagedim[$this-&gt;page][<span class="charliteral">&#39;h&#39;</span>];
<a name="l02279"></a>02279         $this-&gt;w = $this-&gt;wPt / $this-&gt;k;
<a name="l02280"></a>02280         $this-&gt;h = $this-&gt;hPt / $this-&gt;k;
<a name="l02281"></a>02281         $this-&gt;tMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;tm&#39;</span>];
<a name="l02282"></a>02282         $this-&gt;bMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;bm&#39;</span>];
<a name="l02283"></a>02283         $this-&gt;original_lMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>];
<a name="l02284"></a>02284         $this-&gt;original_rMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>];
<a name="l02285"></a>02285         $this-&gt;AutoPageBreak = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;pb&#39;</span>];
<a name="l02286"></a>02286         $this-&gt;CurOrientation = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;or&#39;</span>];
<a name="l02287"></a>02287         $this-&gt;SetAutoPageBreak($this-&gt;AutoPageBreak, $this-&gt;bMargin);
<a name="l02288"></a>02288         <span class="comment">// restore graphic settings</span>
<a name="l02289"></a>02289         <span class="comment">//$this-&gt;setGraphicVars($gvars);</span>
<a name="l02290"></a>02290         <span class="keywordflow">if</span> ($resetmargins) {
<a name="l02291"></a>02291           $this-&gt;lMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>];
<a name="l02292"></a>02292           $this-&gt;rMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>];
<a name="l02293"></a>02293           $this-&gt;SetY($this-&gt;tMargin);
<a name="l02294"></a>02294         } <span class="keywordflow">else</span> {
<a name="l02295"></a>02295           <span class="comment">// account for booklet mode</span>
<a name="l02296"></a>02296           <span class="keywordflow">if</span> ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>] != $this-&gt;pagedim[$oldpage][<span class="stringliteral">&#39;olm&#39;</span>]) {
<a name="l02297"></a>02297             $deltam = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>] - $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>];
<a name="l02298"></a>02298             $this-&gt;lMargin += $deltam;
<a name="l02299"></a>02299             $this-&gt;rMargin -= $deltam;
<a name="l02300"></a>02300           }
<a name="l02301"></a>02301         }
<a name="l02302"></a>02302       } <span class="keywordflow">else</span> {
<a name="l02303"></a>02303         $this-&gt;Error(<span class="stringliteral">&#39;Wrong page number on setPage() function.&#39;</span>);
<a name="l02304"></a>02304       }
<a name="l02305"></a>02305     }
<a name="l02306"></a>02306     
<a name="l02314"></a>02314     <span class="keyword">public</span> function lastPage($resetmargins=<span class="keyword">false</span>) {
<a name="l02315"></a>02315       $this-&gt;setPage($this-&gt;getNumPages(), $resetmargins);
<a name="l02316"></a>02316     }
<a name="l02317"></a>02317     
<a name="l02325"></a>02325     <span class="keyword">public</span> function getPage() {
<a name="l02326"></a>02326       <span class="keywordflow">return</span> $this-&gt;page;
<a name="l02327"></a>02327     }
<a name="l02328"></a>02328     
<a name="l02329"></a>02329     
<a name="l02337"></a>02337     <span class="keyword">public</span> function getNumPages() {
<a name="l02338"></a>02338       <span class="keywordflow">return</span> $this-&gt;numpages;
<a name="l02339"></a>02339     }
<a name="l02340"></a>02340 
<a name="l02350"></a>02350     <span class="keyword">public</span> function AddPage($orientation=<span class="stringliteral">&#39;&#39;</span>, $format=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02351"></a>02351       <span class="keywordflow">if</span> (!isset($this-&gt;original_lMargin)) {
<a name="l02352"></a>02352         $this-&gt;original_lMargin = $this-&gt;lMargin;
<a name="l02353"></a>02353       }
<a name="l02354"></a>02354       <span class="keywordflow">if</span> (!isset($this-&gt;original_rMargin)) {
<a name="l02355"></a>02355         $this-&gt;original_rMargin = $this-&gt;rMargin;
<a name="l02356"></a>02356       }
<a name="l02357"></a>02357       <span class="comment">// terminate previous page</span>
<a name="l02358"></a>02358       $this-&gt;endPage();
<a name="l02359"></a>02359       <span class="comment">// start new page</span>
<a name="l02360"></a>02360       $this-&gt;startPage($orientation, $format);
<a name="l02361"></a>02361     }
<a name="l02362"></a>02362 
<a name="l02369"></a>02369     <span class="keyword">protected</span> function endPage() {
<a name="l02370"></a>02370       <span class="comment">// check if page is already closed</span>
<a name="l02371"></a>02371       <span class="keywordflow">if</span> (($this-&gt;page == 0) OR ($this-&gt;numpages &gt; $this-&gt;page) OR (!$this-&gt;pageopen[$this-&gt;page])) {
<a name="l02372"></a>02372         <span class="keywordflow">return</span>;
<a name="l02373"></a>02373       }
<a name="l02374"></a>02374       $this-&gt;InFooter = <span class="keyword">true</span>;
<a name="l02375"></a>02375       <span class="comment">// print page footer</span>
<a name="l02376"></a>02376       $this-&gt;setFooter();
<a name="l02377"></a>02377       <span class="comment">// close page</span>
<a name="l02378"></a>02378       $this-&gt;_endpage();
<a name="l02379"></a>02379       <span class="comment">// mark page as closed</span>
<a name="l02380"></a>02380       $this-&gt;pageopen[$this-&gt;page] = <span class="keyword">false</span>;
<a name="l02381"></a>02381       $this-&gt;InFooter = <span class="keyword">false</span>;
<a name="l02382"></a>02382     }
<a name="l02383"></a>02383 
<a name="l02393"></a>02393     <span class="keyword">protected</span> function startPage($orientation=<span class="stringliteral">&#39;&#39;</span>, $format=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02394"></a>02394       <span class="keywordflow">if</span> ($this-&gt;numpages &gt; $this-&gt;page) {
<a name="l02395"></a>02395         <span class="comment">// this page has been already added</span>
<a name="l02396"></a>02396         $this-&gt;setPage($this-&gt;page + 1);
<a name="l02397"></a>02397         $this-&gt;SetY($this-&gt;tMargin);
<a name="l02398"></a>02398         <span class="keywordflow">return</span>;
<a name="l02399"></a>02399       }
<a name="l02400"></a>02400       <span class="comment">// start a new page</span>
<a name="l02401"></a>02401       <span class="keywordflow">if</span> ($this-&gt;state == 0) {
<a name="l02402"></a>02402         $this-&gt;Open();
<a name="l02403"></a>02403       }
<a name="l02404"></a>02404       ++$this-&gt;numpages;
<a name="l02405"></a>02405       $this-&gt;swapMargins($this-&gt;booklet);
<a name="l02406"></a>02406       <span class="comment">// save current graphic settings</span>
<a name="l02407"></a>02407       $gvars = $this-&gt;getGraphicVars();
<a name="l02408"></a>02408       <span class="comment">// start new page</span>
<a name="l02409"></a>02409       $this-&gt;_beginpage($orientation, $format);
<a name="l02410"></a>02410       <span class="comment">// mark page as open</span>
<a name="l02411"></a>02411       $this-&gt;pageopen[$this-&gt;page] = <span class="keyword">true</span>;
<a name="l02412"></a>02412       <span class="comment">// restore graphic settings</span>
<a name="l02413"></a>02413       $this-&gt;setGraphicVars($gvars);
<a name="l02414"></a>02414       <span class="comment">// mark this point</span>
<a name="l02415"></a>02415       $this-&gt;setPageMark();
<a name="l02416"></a>02416       <span class="comment">// print page header</span>
<a name="l02417"></a>02417       $this-&gt;setHeader();
<a name="l02418"></a>02418       <span class="comment">// restore graphic settings</span>
<a name="l02419"></a>02419       $this-&gt;setGraphicVars($gvars);
<a name="l02420"></a>02420       <span class="comment">// mark this point</span>
<a name="l02421"></a>02421       $this-&gt;setPageMark();
<a name="l02422"></a>02422       <span class="comment">// print table header (if any)</span>
<a name="l02423"></a>02423       $this-&gt;setTableHeader();
<a name="l02424"></a>02424     }
<a name="l02425"></a>02425       
<a name="l02433"></a>02433     <span class="keyword">public</span> function setPageMark() {
<a name="l02434"></a>02434       $this-&gt;intmrk[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page];
<a name="l02435"></a>02435       $this-&gt;setContentMark();
<a name="l02436"></a>02436     }
<a name="l02437"></a>02437     
<a name="l02444"></a>02444     <span class="keyword">protected</span> function setContentMark($page=0) {
<a name="l02445"></a>02445       <span class="keywordflow">if</span> ($page &lt;= 0) {
<a name="l02446"></a>02446         $page = $this-&gt;page;
<a name="l02447"></a>02447       }
<a name="l02448"></a>02448       <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$page])) {
<a name="l02449"></a>02449         $this-&gt;cntmrk[$page] = $this-&gt;pagelen[$page] - $this-&gt;footerlen[$page];
<a name="l02450"></a>02450       } <span class="keywordflow">else</span> {
<a name="l02451"></a>02451         $this-&gt;cntmrk[$page] = $this-&gt;pagelen[$page];
<a name="l02452"></a>02452       }
<a name="l02453"></a>02453     }
<a name="l02454"></a>02454     
<a name="l02463"></a>02463     <span class="keyword">public</span> function setHeaderData($ln=<span class="stringliteral">&#39;&#39;</span>, $lw=0, $ht=<span class="stringliteral">&#39;&#39;</span>, $hs=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l02464"></a>02464       $this-&gt;header_logo = $ln;
<a name="l02465"></a>02465       $this-&gt;header_logo_width = $lw;
<a name="l02466"></a>02466       $this-&gt;header_title = $ht;
<a name="l02467"></a>02467       $this-&gt;header_string = $hs;
<a name="l02468"></a>02468     }
<a name="l02469"></a>02469     
<a name="l02477"></a>02477     <span class="keyword">public</span> function getHeaderData() {
<a name="l02478"></a>02478       $ret = array();
<a name="l02479"></a>02479       $ret[<span class="stringliteral">&#39;logo&#39;</span>] = $this-&gt;header_logo;
<a name="l02480"></a>02480       $ret[<span class="stringliteral">&#39;logo_width&#39;</span>] = $this-&gt;header_logo_width;
<a name="l02481"></a>02481       $ret[<span class="stringliteral">&#39;title&#39;</span>] = $this-&gt;header_title;
<a name="l02482"></a>02482       $ret[<span class="stringliteral">&#39;string&#39;</span>] = $this-&gt;header_string;
<a name="l02483"></a>02483       <span class="keywordflow">return</span> $ret;
<a name="l02484"></a>02484     }
<a name="l02485"></a>02485     
<a name="l02492"></a>02492     <span class="keyword">public</span> function setHeaderMargin($hm=10) {
<a name="l02493"></a>02493       $this-&gt;header_margin = $hm;
<a name="l02494"></a>02494     }
<a name="l02495"></a>02495     
<a name="l02502"></a>02502     <span class="keyword">public</span> function getHeaderMargin() {
<a name="l02503"></a>02503       <span class="keywordflow">return</span> $this-&gt;header_margin;
<a name="l02504"></a>02504     }
<a name="l02505"></a>02505     
<a name="l02512"></a>02512     <span class="keyword">public</span> function setFooterMargin($fm=10) {
<a name="l02513"></a>02513       $this-&gt;footer_margin = $fm;
<a name="l02514"></a>02514     }
<a name="l02515"></a>02515     
<a name="l02522"></a>02522     <span class="keyword">public</span> function getFooterMargin() {
<a name="l02523"></a>02523       <span class="keywordflow">return</span> $this-&gt;footer_margin;
<a name="l02524"></a>02524     }
<a name="l02530"></a>02530     <span class="keyword">public</span> function setPrintHeader($val=<span class="keyword">true</span>) {
<a name="l02531"></a>02531       $this-&gt;print_header = $val;
<a name="l02532"></a>02532     }
<a name="l02533"></a>02533     
<a name="l02539"></a>02539     <span class="keyword">public</span> function setPrintFooter($val=<span class="keyword">true</span>) {
<a name="l02540"></a>02540       $this-&gt;print_footer = $val;
<a name="l02541"></a>02541     }
<a name="l02542"></a>02542     
<a name="l02548"></a>02548     <span class="keyword">public</span> function getImageRBX() {
<a name="l02549"></a>02549       <span class="keywordflow">return</span> $this-&gt;img_rb_x;
<a name="l02550"></a>02550     }
<a name="l02551"></a>02551     
<a name="l02557"></a>02557     <span class="keyword">public</span> function getImageRBY() {
<a name="l02558"></a>02558       <span class="keywordflow">return</span> $this-&gt;img_rb_y;
<a name="l02559"></a>02559     }
<a name="l02560"></a>02560     
<a name="l02566"></a>02566     <span class="keyword">public</span> function Header() {
<a name="l02567"></a>02567       $ormargins = $this-&gt;getOriginalMargins();
<a name="l02568"></a>02568       $headerfont = $this-&gt;getHeaderFont();
<a name="l02569"></a>02569       $headerdata = $this-&gt;getHeaderData();
<a name="l02570"></a>02570       <span class="keywordflow">if</span> (($headerdata[<span class="stringliteral">&#39;logo&#39;</span>]) AND ($headerdata[<span class="stringliteral">&#39;logo&#39;</span>] != K_BLANK_IMAGE)) {
<a name="l02571"></a>02571         $this-&gt;Image(K_PATH_IMAGES.$headerdata[<span class="stringliteral">&#39;logo&#39;</span>], $this-&gt;GetX(), $this-&gt;getHeaderMargin(), $headerdata[<span class="stringliteral">&#39;logo_width&#39;</span>]);
<a name="l02572"></a>02572         $imgy = $this-&gt;getImageRBY();
<a name="l02573"></a>02573       } <span class="keywordflow">else</span> {
<a name="l02574"></a>02574         $imgy = $this-&gt;GetY();
<a name="l02575"></a>02575       }
<a name="l02576"></a>02576       $cell_height = round(($this-&gt;getCellHeightRatio() * $headerfont[2]) / $this-&gt;getScaleFactor(), 2);
<a name="l02577"></a>02577       <span class="comment">// set starting margin for text data cell</span>
<a name="l02578"></a>02578       <span class="keywordflow">if</span> ($this-&gt;getRTL()) {
<a name="l02579"></a>02579         $header_x = $ormargins[<span class="stringliteral">&#39;right&#39;</span>] + ($headerdata[<span class="stringliteral">&#39;logo_width&#39;</span>] * 1.1);
<a name="l02580"></a>02580       } <span class="keywordflow">else</span> {
<a name="l02581"></a>02581         $header_x = $ormargins[<span class="stringliteral">&#39;left&#39;</span>] + ($headerdata[<span class="stringliteral">&#39;logo_width&#39;</span>] * 1.1);
<a name="l02582"></a>02582       }
<a name="l02583"></a>02583       $this-&gt;SetTextColor(0, 0, 0);
<a name="l02584"></a>02584       <span class="comment">// header title</span>
<a name="l02585"></a>02585       $this-&gt;SetFont($headerfont[0], <span class="charliteral">&#39;B&#39;</span>, $headerfont[2] + 1);
<a name="l02586"></a>02586       $this-&gt;SetX($header_x);     
<a name="l02587"></a>02587       $this-&gt;Cell(0, $cell_height, $headerdata[<span class="stringliteral">&#39;title&#39;</span>], 0, 1, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, 0);
<a name="l02588"></a>02588       <span class="comment">// header string</span>
<a name="l02589"></a>02589       $this-&gt;SetFont($headerfont[0], $headerfont[1], $headerfont[2]);
<a name="l02590"></a>02590       $this-&gt;SetX($header_x);
<a name="l02591"></a>02591       $this-&gt;MultiCell(0, $cell_height, $headerdata[<span class="stringliteral">&#39;string&#39;</span>], 0, <span class="stringliteral">&#39;&#39;</span>, 0, 1, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">true</span>, 0, <span class="keyword">false</span>);
<a name="l02592"></a>02592       <span class="comment">// print an ending header line</span>
<a name="l02593"></a>02593       $this-&gt;SetLineStyle(array(<span class="stringliteral">&#39;width&#39;</span> =&gt; 0.85 / $this-&gt;getScaleFactor(), <span class="stringliteral">&#39;cap&#39;</span> =&gt; <span class="stringliteral">&#39;butt&#39;</span>, <span class="stringliteral">&#39;join&#39;</span> =&gt; <span class="stringliteral">&#39;miter&#39;</span>, <span class="stringliteral">&#39;dash&#39;</span> =&gt; 0, <span class="stringliteral">&#39;color&#39;</span> =&gt; array(0, 0, 0)));
<a name="l02594"></a>02594       $this-&gt;SetY((2.835 / $this-&gt;getScaleFactor()) + max($imgy, $this-&gt;GetY()));
<a name="l02595"></a>02595       <span class="keywordflow">if</span> ($this-&gt;getRTL()) {
<a name="l02596"></a>02596         $this-&gt;SetX($ormargins[<span class="stringliteral">&#39;right&#39;</span>]);
<a name="l02597"></a>02597       } <span class="keywordflow">else</span> {
<a name="l02598"></a>02598         $this-&gt;SetX($ormargins[<span class="stringliteral">&#39;left&#39;</span>]);
<a name="l02599"></a>02599       }
<a name="l02600"></a>02600       $this-&gt;Cell(0, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="charliteral">&#39;T&#39;</span>, 0, <span class="charliteral">&#39;C&#39;</span>);
<a name="l02601"></a>02601     }
<a name="l02602"></a>02602     
<a name="l02608"></a>02608     <span class="keyword">public</span> function Footer() {        
<a name="l02609"></a>02609       $cur_y = $this-&gt;GetY();
<a name="l02610"></a>02610       $ormargins = $this-&gt;getOriginalMargins();
<a name="l02611"></a>02611       $this-&gt;SetTextColor(0, 0, 0);     
<a name="l02612"></a>02612       <span class="comment">//set style for cell border</span>
<a name="l02613"></a>02613       $line_width = 0.85 / $this-&gt;getScaleFactor();
<a name="l02614"></a>02614       $this-&gt;SetLineStyle(array(<span class="stringliteral">&#39;width&#39;</span> =&gt; $line_width, <span class="stringliteral">&#39;cap&#39;</span> =&gt; <span class="stringliteral">&#39;butt&#39;</span>, <span class="stringliteral">&#39;join&#39;</span> =&gt; <span class="stringliteral">&#39;miter&#39;</span>, <span class="stringliteral">&#39;dash&#39;</span> =&gt; 0, <span class="stringliteral">&#39;color&#39;</span> =&gt; array(0, 0, 0)));
<a name="l02615"></a>02615       <span class="comment">//print document barcode</span>
<a name="l02616"></a>02616       $barcode = $this-&gt;getBarcode();
<a name="l02617"></a>02617       <span class="keywordflow">if</span> (!empty($barcode)) {
<a name="l02618"></a>02618         $this-&gt;Ln($line_width);
<a name="l02619"></a>02619         $barcode_width = round(($this-&gt;getPageWidth() - $ormargins[<span class="stringliteral">&#39;left&#39;</span>] - $ormargins[<span class="stringliteral">&#39;right&#39;</span>])/3);
<a name="l02620"></a>02620         $this-&gt;write1DBarcode($barcode, <span class="stringliteral">&#39;C128B&#39;</span>, $this-&gt;GetX(), $cur_y + $line_width, $barcode_width, (($this-&gt;getFooterMargin() / 3) - $line_width), 0.3, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>); 
<a name="l02621"></a>02621       }
<a name="l02622"></a>02622       <span class="keywordflow">if</span> (empty($this-&gt;pagegroups)) {
<a name="l02623"></a>02623         $pagenumtxt = $this-&gt;l[<span class="stringliteral">&#39;w_page&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$this-&gt;getAliasNumPage().<span class="stringliteral">&#39; / &#39;</span>.$this-&gt;getAliasNbPages();
<a name="l02624"></a>02624       } <span class="keywordflow">else</span> {
<a name="l02625"></a>02625         $pagenumtxt = $this-&gt;l[<span class="stringliteral">&#39;w_page&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$this-&gt;getPageNumGroupAlias().<span class="stringliteral">&#39; / &#39;</span>.$this-&gt;getPageGroupAlias();
<a name="l02626"></a>02626       }   
<a name="l02627"></a>02627       $this-&gt;SetY($cur_y);
<a name="l02628"></a>02628       <span class="comment">//Print page number</span>
<a name="l02629"></a>02629       <span class="keywordflow">if</span> ($this-&gt;getRTL()) {
<a name="l02630"></a>02630         $this-&gt;SetX($ormargins[<span class="stringliteral">&#39;right&#39;</span>]);
<a name="l02631"></a>02631         $this-&gt;Cell(0, 0, $pagenumtxt, <span class="charliteral">&#39;T&#39;</span>, 0, <span class="charliteral">&#39;L&#39;</span>);
<a name="l02632"></a>02632       } <span class="keywordflow">else</span> {
<a name="l02633"></a>02633         $this-&gt;SetX($ormargins[<span class="stringliteral">&#39;left&#39;</span>]);
<a name="l02634"></a>02634         $this-&gt;Cell(0, 0, $pagenumtxt, <span class="charliteral">&#39;T&#39;</span>, 0, <span class="charliteral">&#39;R&#39;</span>);
<a name="l02635"></a>02635       }
<a name="l02636"></a>02636     }
<a name="l02637"></a>02637     
<a name="l02643"></a>02643     <span class="keyword">protected</span> function setHeader() {
<a name="l02644"></a>02644       <span class="keywordflow">if</span> ($this-&gt;print_header) {
<a name="l02645"></a>02645         $lasth = $this-&gt;lasth;
<a name="l02646"></a>02646         $this-&gt;_out(<span class="charliteral">&#39;q&#39;</span>);
<a name="l02647"></a>02647         $this-&gt;rMargin = $this-&gt;original_rMargin;
<a name="l02648"></a>02648         $this-&gt;lMargin = $this-&gt;original_lMargin;
<a name="l02649"></a>02649         $this-&gt;cMargin = 0;
<a name="l02650"></a>02650         <span class="comment">//set current position</span>
<a name="l02651"></a>02651         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l02652"></a>02652           $this-&gt;SetXY($this-&gt;original_rMargin, $this-&gt;header_margin);
<a name="l02653"></a>02653         } <span class="keywordflow">else</span> {
<a name="l02654"></a>02654           $this-&gt;SetXY($this-&gt;original_lMargin, $this-&gt;header_margin);
<a name="l02655"></a>02655         }
<a name="l02656"></a>02656         $this-&gt;SetFont($this-&gt;header_font[0], $this-&gt;header_font[1], $this-&gt;header_font[2]);
<a name="l02657"></a>02657         $this-&gt;Header();
<a name="l02658"></a>02658         <span class="comment">//restore position</span>
<a name="l02659"></a>02659         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l02660"></a>02660           $this-&gt;SetXY($this-&gt;original_rMargin, $this-&gt;tMargin);
<a name="l02661"></a>02661         } <span class="keywordflow">else</span> {
<a name="l02662"></a>02662           $this-&gt;SetXY($this-&gt;original_lMargin, $this-&gt;tMargin);
<a name="l02663"></a>02663         }
<a name="l02664"></a>02664         $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l02665"></a>02665         $this-&gt;lasth = $lasth;
<a name="l02666"></a>02666       }
<a name="l02667"></a>02667     }
<a name="l02668"></a>02668     
<a name="l02674"></a>02674     <span class="keyword">protected</span> function setFooter() {
<a name="l02675"></a>02675       <span class="comment">//Page footer</span>
<a name="l02676"></a>02676       <span class="comment">// save current graphic settings</span>
<a name="l02677"></a>02677       $gvars = $this-&gt;getGraphicVars();
<a name="l02678"></a>02678       <span class="comment">// mark this point</span>
<a name="l02679"></a>02679       $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page];
<a name="l02680"></a>02680       $this-&gt;_out(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02681"></a>02681       <span class="keywordflow">if</span> ($this-&gt;print_footer) {
<a name="l02682"></a>02682         $lasth = $this-&gt;lasth;
<a name="l02683"></a>02683         $this-&gt;_out(<span class="charliteral">&#39;q&#39;</span>);
<a name="l02684"></a>02684         $this-&gt;rMargin = $this-&gt;original_rMargin;
<a name="l02685"></a>02685         $this-&gt;lMargin = $this-&gt;original_lMargin;
<a name="l02686"></a>02686         $this-&gt;cMargin = 0;
<a name="l02687"></a>02687         <span class="comment">//set current position</span>
<a name="l02688"></a>02688         $footer_y = $this-&gt;h - $this-&gt;footer_margin;
<a name="l02689"></a>02689         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l02690"></a>02690           $this-&gt;SetXY($this-&gt;original_rMargin, $footer_y);
<a name="l02691"></a>02691         } <span class="keywordflow">else</span> {
<a name="l02692"></a>02692           $this-&gt;SetXY($this-&gt;original_lMargin, $footer_y);
<a name="l02693"></a>02693         }
<a name="l02694"></a>02694         $this-&gt;SetFont($this-&gt;footer_font[0], $this-&gt;footer_font[1], $this-&gt;footer_font[2]);
<a name="l02695"></a>02695         $this-&gt;Footer();
<a name="l02696"></a>02696         <span class="comment">//restore position</span>
<a name="l02697"></a>02697         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l02698"></a>02698           $this-&gt;SetXY($this-&gt;original_rMargin, $this-&gt;tMargin);
<a name="l02699"></a>02699         } <span class="keywordflow">else</span> {
<a name="l02700"></a>02700           $this-&gt;SetXY($this-&gt;original_lMargin, $this-&gt;tMargin);
<a name="l02701"></a>02701         }
<a name="l02702"></a>02702         $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l02703"></a>02703         $this-&gt;lasth = $lasth;
<a name="l02704"></a>02704       }
<a name="l02705"></a>02705       <span class="comment">// restore graphic settings</span>
<a name="l02706"></a>02706       $this-&gt;setGraphicVars($gvars);
<a name="l02707"></a>02707       <span class="comment">// calculate footer lenght</span>
<a name="l02708"></a>02708       $this-&gt;footerlen[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page] - $this-&gt;footerpos[$this-&gt;page] + 1;
<a name="l02709"></a>02709     }
<a name="l02710"></a>02710 
<a name="l02716"></a>02716     <span class="keyword">protected</span> function setTableHeader() {
<a name="l02717"></a>02717       <span class="keywordflow">if</span> (isset($this-&gt;theadMargins[<span class="stringliteral">&#39;top&#39;</span>])) {
<a name="l02718"></a>02718         <span class="comment">// restore the original top-margin</span>
<a name="l02719"></a>02719         $this-&gt;tMargin = $this-&gt;theadMargins[<span class="stringliteral">&#39;top&#39;</span>];
<a name="l02720"></a>02720         $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;tm&#39;</span>] = $this-&gt;tMargin;
<a name="l02721"></a>02721         $this-&gt;y = $this-&gt;tMargin;
<a name="l02722"></a>02722       }
<a name="l02723"></a>02723       <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;thead)) {
<a name="l02724"></a>02724         <span class="comment">// set margins</span>
<a name="l02725"></a>02725         $prev_lMargin = $this-&gt;lMargin;
<a name="l02726"></a>02726         $prev_rMargin = $this-&gt;rMargin;
<a name="l02727"></a>02727         $this-&gt;lMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>];
<a name="l02728"></a>02728         $this-&gt;rMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>];
<a name="l02729"></a>02729         $this-&gt;cMargin = $this-&gt;theadMargins[<span class="stringliteral">&#39;cmargin&#39;</span>];
<a name="l02730"></a>02730         <span class="comment">// print table header</span>
<a name="l02731"></a>02731         $this-&gt;writeHTML($this-&gt;thead, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l02732"></a>02732         <span class="comment">// set new top margin to skip the table headers</span>
<a name="l02733"></a>02733         <span class="keywordflow">if</span> (!isset($this-&gt;theadMargins[<span class="stringliteral">&#39;top&#39;</span>])) {
<a name="l02734"></a>02734           $this-&gt;theadMargins[<span class="stringliteral">&#39;top&#39;</span>] = $this-&gt;tMargin;
<a name="l02735"></a>02735         }
<a name="l02736"></a>02736         $this-&gt;tMargin = $this-&gt;y;
<a name="l02737"></a>02737         $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;tm&#39;</span>] = $this-&gt;tMargin;
<a name="l02738"></a>02738         $this-&gt;lasth = 0;
<a name="l02739"></a>02739         $this-&gt;lMargin = $prev_lMargin;
<a name="l02740"></a>02740         $this-&gt;rMargin = $prev_rMargin;
<a name="l02741"></a>02741       }
<a name="l02742"></a>02742     }
<a name="l02743"></a>02743     
<a name="l02751"></a>02751     <span class="keyword">public</span> function PageNo() {
<a name="l02752"></a>02752       <span class="keywordflow">return</span> $this-&gt;page;
<a name="l02753"></a>02753     }
<a name="l02754"></a>02754 
<a name="l02767"></a>02767     <span class="keyword">public</span> function AddSpotColor($name, $c, $m, $y, $k) {
<a name="l02768"></a>02768       <span class="keywordflow">if</span> (!isset($this-&gt;spot_colors[$name])) {
<a name="l02769"></a>02769         $i = 1 + count($this-&gt;spot_colors);
<a name="l02770"></a>02770         $this-&gt;spot_colors[$name] = array(<span class="charliteral">&#39;i&#39;</span> =&gt; $i, <span class="charliteral">&#39;c&#39;</span> =&gt; $c, <span class="charliteral">&#39;m&#39;</span> =&gt; $m, <span class="charliteral">&#39;y&#39;</span> =&gt; $y, <span class="charliteral">&#39;k&#39;</span> =&gt; $k);
<a name="l02771"></a>02771       }
<a name="l02772"></a>02772     }
<a name="l02773"></a>02773 
<a name="l02783"></a>02783     <span class="keyword">public</span> function SetDrawColorArray($color) {
<a name="l02784"></a>02784       <span class="keywordflow">if</span> (isset($color)) {
<a name="l02785"></a>02785         $color = array_values($color);
<a name="l02786"></a>02786         $r = isset($color[0]) ? $color[0] : -1;
<a name="l02787"></a>02787         $g = isset($color[1]) ? $color[1] : -1;
<a name="l02788"></a>02788         $b = isset($color[2]) ? $color[2] : -1;
<a name="l02789"></a>02789         $k = isset($color[3]) ? $color[3] : -1;
<a name="l02790"></a>02790         <span class="keywordflow">if</span> ($r &gt;= 0) {
<a name="l02791"></a>02791           $this-&gt;SetDrawColor($r, $g, $b, $k);
<a name="l02792"></a>02792         }
<a name="l02793"></a>02793       }
<a name="l02794"></a>02794     }
<a name="l02795"></a>02795 
<a name="l02806"></a>02806     <span class="keyword">public</span> function SetDrawColor($col1=0, $col2=-1, $col3=-1, $col4=-1) {
<a name="l02807"></a>02807       <span class="comment">// set default values</span>
<a name="l02808"></a>02808       <span class="keywordflow">if</span> (!is_numeric($col1)) {
<a name="l02809"></a>02809         $col1 = 0;
<a name="l02810"></a>02810       }
<a name="l02811"></a>02811       <span class="keywordflow">if</span> (!is_numeric($col2)) {
<a name="l02812"></a>02812         $col2 = -1;
<a name="l02813"></a>02813       }
<a name="l02814"></a>02814       <span class="keywordflow">if</span> (!is_numeric($col3)) {
<a name="l02815"></a>02815         $col3 = -1;
<a name="l02816"></a>02816       }
<a name="l02817"></a>02817       <span class="keywordflow">if</span> (!is_numeric($col4)) {
<a name="l02818"></a>02818         $col4 = -1;
<a name="l02819"></a>02819       }
<a name="l02820"></a>02820       <span class="comment">//Set color for all stroking operations</span>
<a name="l02821"></a>02821       <span class="keywordflow">if</span> (($col2 == -1) AND ($col3 == -1) AND ($col4 == -1)) {
<a name="l02822"></a>02822         <span class="comment">// Grey scale</span>
<a name="l02823"></a>02823         $this-&gt;DrawColor = sprintf(<span class="stringliteral">&#39;%.3F G&#39;</span>, $col1/255);
<a name="l02824"></a>02824       } elseif ($col4 == -1) {
<a name="l02825"></a>02825         <span class="comment">// RGB</span>
<a name="l02826"></a>02826         $this-&gt;DrawColor = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F RG&#39;</span>, $col1/255, $col2/255, $col3/255);
<a name="l02827"></a>02827       } <span class="keywordflow">else</span> {
<a name="l02828"></a>02828         <span class="comment">// CMYK</span>
<a name="l02829"></a>02829         $this-&gt;DrawColor = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F %.3F K&#39;</span>, $col1/100, $col2/100, $col3/100, $col4/100);
<a name="l02830"></a>02830       }
<a name="l02831"></a>02831       <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l02832"></a>02832         $this-&gt;_out($this-&gt;DrawColor);
<a name="l02833"></a>02833       }
<a name="l02834"></a>02834     }
<a name="l02835"></a>02835     
<a name="l02844"></a>02844     <span class="keyword">public</span> function SetDrawSpotColor($name, $tint=100) {
<a name="l02845"></a>02845       <span class="keywordflow">if</span> (!isset($this-&gt;spot_colors[$name])) {
<a name="l02846"></a>02846         $this-&gt;Error(<span class="stringliteral">&#39;Undefined spot color: &#39;</span>.$name);
<a name="l02847"></a>02847       }
<a name="l02848"></a>02848       $this-&gt;DrawColor = sprintf(<span class="stringliteral">&#39;/CS%d CS %.3F SCN&#39;</span>, $this-&gt;spot_colors[$name][<span class="charliteral">&#39;i&#39;</span>], $tint/100);
<a name="l02849"></a>02849       <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l02850"></a>02850         $this-&gt;_out($this-&gt;DrawColor);
<a name="l02851"></a>02851       }
<a name="l02852"></a>02852     }
<a name="l02853"></a>02853     
<a name="l02863"></a>02863     <span class="keyword">public</span> function SetFillColorArray($color) {
<a name="l02864"></a>02864       <span class="keywordflow">if</span> (isset($color)) {
<a name="l02865"></a>02865         $color = array_values($color);
<a name="l02866"></a>02866         $r = isset($color[0]) ? $color[0] : -1;
<a name="l02867"></a>02867         $g = isset($color[1]) ? $color[1] : -1;
<a name="l02868"></a>02868         $b = isset($color[2]) ? $color[2] : -1;
<a name="l02869"></a>02869         $k = isset($color[3]) ? $color[3] : -1;
<a name="l02870"></a>02870         <span class="keywordflow">if</span> ($r &gt;= 0) {
<a name="l02871"></a>02871           $this-&gt;SetFillColor($r, $g, $b, $k);
<a name="l02872"></a>02872         }
<a name="l02873"></a>02873       }
<a name="l02874"></a>02874     }
<a name="l02875"></a>02875     
<a name="l02886"></a>02886     <span class="keyword">public</span> function SetFillColor($col1=0, $col2=-1, $col3=-1, $col4=-1) {
<a name="l02887"></a>02887       <span class="comment">// set default values</span>
<a name="l02888"></a>02888       <span class="keywordflow">if</span> (!is_numeric($col1)) {
<a name="l02889"></a>02889         $col1 = 0;
<a name="l02890"></a>02890       }
<a name="l02891"></a>02891       <span class="keywordflow">if</span> (!is_numeric($col2)) {
<a name="l02892"></a>02892         $col2 = -1;
<a name="l02893"></a>02893       }
<a name="l02894"></a>02894       <span class="keywordflow">if</span> (!is_numeric($col3)) {
<a name="l02895"></a>02895         $col3 = -1;
<a name="l02896"></a>02896       }
<a name="l02897"></a>02897       <span class="keywordflow">if</span> (!is_numeric($col4)) {
<a name="l02898"></a>02898         $col4 = -1;
<a name="l02899"></a>02899       }
<a name="l02900"></a>02900       <span class="comment">//Set color for all filling operations</span>
<a name="l02901"></a>02901       <span class="keywordflow">if</span> (($col2 == -1) AND ($col3 == -1) AND ($col4 == -1)) {
<a name="l02902"></a>02902         <span class="comment">// Grey scale</span>
<a name="l02903"></a>02903         $this-&gt;FillColor = sprintf(<span class="stringliteral">&#39;%.3F g&#39;</span>, $col1/255);
<a name="l02904"></a>02904         $this-&gt;bgcolor = array(<span class="charliteral">&#39;G&#39;</span> =&gt; $col1);
<a name="l02905"></a>02905       } elseif ($col4 == -1) {
<a name="l02906"></a>02906         <span class="comment">// RGB</span>
<a name="l02907"></a>02907         $this-&gt;FillColor = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F rg&#39;</span>, $col1/255, $col2/255, $col3/255);
<a name="l02908"></a>02908         $this-&gt;bgcolor = array(<span class="charliteral">&#39;R&#39;</span> =&gt; $col1, <span class="charliteral">&#39;G&#39;</span> =&gt; $col2, <span class="charliteral">&#39;B&#39;</span> =&gt; $col3);
<a name="l02909"></a>02909       } <span class="keywordflow">else</span> {
<a name="l02910"></a>02910         <span class="comment">// CMYK</span>
<a name="l02911"></a>02911         $this-&gt;FillColor = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F %.3F k&#39;</span>, $col1/100, $col2/100, $col3/100, $col4/100);
<a name="l02912"></a>02912         $this-&gt;bgcolor = array(<span class="charliteral">&#39;C&#39;</span> =&gt; $col1, <span class="charliteral">&#39;M&#39;</span> =&gt; $col2, <span class="charliteral">&#39;Y&#39;</span> =&gt; $col3, <span class="charliteral">&#39;K&#39;</span> =&gt; $col4);
<a name="l02913"></a>02913       }
<a name="l02914"></a>02914       $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor);
<a name="l02915"></a>02915       <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l02916"></a>02916         $this-&gt;_out($this-&gt;FillColor);
<a name="l02917"></a>02917       }
<a name="l02918"></a>02918     }
<a name="l02919"></a>02919     
<a name="l02928"></a>02928     <span class="keyword">public</span> function SetFillSpotColor($name, $tint=100) {
<a name="l02929"></a>02929       <span class="keywordflow">if</span> (!isset($this-&gt;spot_colors[$name])) {
<a name="l02930"></a>02930         $this-&gt;Error(<span class="stringliteral">&#39;Undefined spot color: &#39;</span>.$name);
<a name="l02931"></a>02931       }
<a name="l02932"></a>02932       $this-&gt;FillColor = sprintf(<span class="stringliteral">&#39;/CS%d cs %.3F scn&#39;</span>, $this-&gt;spot_colors[$name][<span class="charliteral">&#39;i&#39;</span>], $tint/100);
<a name="l02933"></a>02933       $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor);
<a name="l02934"></a>02934       <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l02935"></a>02935         $this-&gt;_out($this-&gt;FillColor);
<a name="l02936"></a>02936       }
<a name="l02937"></a>02937     }
<a name="l02938"></a>02938     
<a name="l02947"></a>02947     <span class="keyword">public</span> function SetTextColorArray($color) {
<a name="l02948"></a>02948       <span class="keywordflow">if</span> (isset($color)) {
<a name="l02949"></a>02949         $color = array_values($color);
<a name="l02950"></a>02950         $r = isset($color[0]) ? $color[0] : -1;
<a name="l02951"></a>02951         $g = isset($color[1]) ? $color[1] : -1;
<a name="l02952"></a>02952         $b = isset($color[2]) ? $color[2] : -1;
<a name="l02953"></a>02953         $k = isset($color[3]) ? $color[3] : -1;
<a name="l02954"></a>02954         <span class="keywordflow">if</span> ($r &gt;= 0) {
<a name="l02955"></a>02955           $this-&gt;SetTextColor($r, $g, $b, $k);
<a name="l02956"></a>02956         }
<a name="l02957"></a>02957       }
<a name="l02958"></a>02958     }
<a name="l02959"></a>02959 
<a name="l02970"></a>02970     <span class="keyword">public</span> function SetTextColor($col1=0, $col2=-1, $col3=-1, $col4=-1) {
<a name="l02971"></a>02971       <span class="comment">// set default values</span>
<a name="l02972"></a>02972       <span class="keywordflow">if</span> (!is_numeric($col1)) {
<a name="l02973"></a>02973         $col1 = 0;
<a name="l02974"></a>02974       }
<a name="l02975"></a>02975       <span class="keywordflow">if</span> (!is_numeric($col2)) {
<a name="l02976"></a>02976         $col2 = -1;
<a name="l02977"></a>02977       }
<a name="l02978"></a>02978       <span class="keywordflow">if</span> (!is_numeric($col3)) {
<a name="l02979"></a>02979         $col3 = -1;
<a name="l02980"></a>02980       }
<a name="l02981"></a>02981       <span class="keywordflow">if</span> (!is_numeric($col4)) {
<a name="l02982"></a>02982         $col4 = -1;
<a name="l02983"></a>02983       }
<a name="l02984"></a>02984       <span class="comment">//Set color for text</span>
<a name="l02985"></a>02985       <span class="keywordflow">if</span> (($col2 == -1) AND ($col3 == -1) AND ($col4 == -1)) {
<a name="l02986"></a>02986         <span class="comment">// Grey scale</span>
<a name="l02987"></a>02987         $this-&gt;TextColor = sprintf(<span class="stringliteral">&#39;%.3F g&#39;</span>, $col1/255);
<a name="l02988"></a>02988         $this-&gt;fgcolor = array(<span class="charliteral">&#39;G&#39;</span> =&gt; $col1);
<a name="l02989"></a>02989       } elseif ($col4 == -1) {
<a name="l02990"></a>02990         <span class="comment">// RGB</span>
<a name="l02991"></a>02991         $this-&gt;TextColor = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F rg&#39;</span>, $col1/255, $col2/255, $col3/255);
<a name="l02992"></a>02992         $this-&gt;fgcolor = array(<span class="charliteral">&#39;R&#39;</span> =&gt; $col1, <span class="charliteral">&#39;G&#39;</span> =&gt; $col2, <span class="charliteral">&#39;B&#39;</span> =&gt; $col3);
<a name="l02993"></a>02993       } <span class="keywordflow">else</span> {
<a name="l02994"></a>02994         <span class="comment">// CMYK</span>
<a name="l02995"></a>02995         $this-&gt;TextColor = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F %.3F k&#39;</span>, $col1/100, $col2/100, $col3/100, $col4/100);
<a name="l02996"></a>02996         $this-&gt;fgcolor = array(<span class="charliteral">&#39;C&#39;</span> =&gt; $col1, <span class="charliteral">&#39;M&#39;</span> =&gt; $col2, <span class="charliteral">&#39;Y&#39;</span> =&gt; $col3, <span class="charliteral">&#39;K&#39;</span> =&gt; $col4);
<a name="l02997"></a>02997       }
<a name="l02998"></a>02998       $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor);
<a name="l02999"></a>02999     }
<a name="l03000"></a>03000     
<a name="l03009"></a>03009     <span class="keyword">public</span> function SetTextSpotColor($name, $tint=100) {
<a name="l03010"></a>03010       <span class="keywordflow">if</span> (!isset($this-&gt;spot_colors[$name])) {
<a name="l03011"></a>03011         $this-&gt;Error(<span class="stringliteral">&#39;Undefined spot color: &#39;</span>.$name);
<a name="l03012"></a>03012       }
<a name="l03013"></a>03013       $this-&gt;TextColor = sprintf(<span class="stringliteral">&#39;/CS%d cs %.3F scn&#39;</span>, $this-&gt;spot_colors[$name][<span class="charliteral">&#39;i&#39;</span>], $tint/100);
<a name="l03014"></a>03014       $this-&gt;ColorFlag = ($this-&gt;FillColor != $this-&gt;TextColor);
<a name="l03015"></a>03015       <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l03016"></a>03016         $this-&gt;_out($this-&gt;TextColor);
<a name="l03017"></a>03017       }
<a name="l03018"></a>03018     }
<a name="l03019"></a>03019 
<a name="l03031"></a>03031     <span class="keyword">public</span> function GetStringWidth($s, $fontname=<span class="stringliteral">&#39;&#39;</span>, $fontstyle=<span class="stringliteral">&#39;&#39;</span>, $fontsize=0) {
<a name="l03032"></a>03032       <span class="keywordflow">return</span> $this-&gt;GetArrStringWidth($this-&gt;utf8Bidi($this-&gt;UTF8StringToArray($s), $s, $this-&gt;tmprtl), $fontname, $fontstyle, $fontsize);
<a name="l03033"></a>03033     }
<a name="l03034"></a>03034     
<a name="l03046"></a>03046     <span class="keyword">public</span> function GetArrStringWidth($sa, $fontname=<span class="stringliteral">&#39;&#39;</span>, $fontstyle=<span class="stringliteral">&#39;&#39;</span>, $fontsize=0) {
<a name="l03047"></a>03047       <span class="comment">// store current values</span>
<a name="l03048"></a>03048       <span class="keywordflow">if</span> (!$this-&gt;empty_string($fontname)) {
<a name="l03049"></a>03049         $prev_FontFamily = $this-&gt;FontFamily;
<a name="l03050"></a>03050         $prev_FontStyle = $this-&gt;FontStyle;
<a name="l03051"></a>03051         $prev_FontSizePt = $this-&gt;FontSizePt;
<a name="l03052"></a>03052         $this-&gt;SetFont($fontname, $fontstyle, $fontsize);
<a name="l03053"></a>03053       }
<a name="l03054"></a>03054       $w = 0;
<a name="l03055"></a>03055       <span class="keywordflow">foreach</span> ($sa as $char) {
<a name="l03056"></a>03056         $w += $this-&gt;GetCharWidth($char);
<a name="l03057"></a>03057       }
<a name="l03058"></a>03058       <span class="comment">// restore previous values</span>
<a name="l03059"></a>03059       <span class="keywordflow">if</span> (!$this-&gt;empty_string($fontname)) {
<a name="l03060"></a>03060         $this-&gt;SetFont($prev_FontFamily, $prev_FontStyle, $prev_FontSizePt);
<a name="l03061"></a>03061       }
<a name="l03062"></a>03062       <span class="keywordflow">return</span> $w;
<a name="l03063"></a>03063     }
<a name="l03064"></a>03064     
<a name="l03073"></a>03073     <span class="keyword">public</span> function GetCharWidth($char) {
<a name="l03074"></a>03074       <span class="keywordflow">if</span> ($char == 173) {
<a name="l03075"></a>03075         <span class="comment">// SHY character will not be printed</span>
<a name="l03076"></a>03076         <span class="keywordflow">return</span> (0);
<a name="l03077"></a>03077       }
<a name="l03078"></a>03078       $cw = &amp;$this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l03079"></a>03079       <span class="keywordflow">if</span> (isset($cw[$char])) {
<a name="l03080"></a>03080         $w = $cw[$char];
<a name="l03081"></a>03081       } elseif (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;dw&#39;</span>])) {
<a name="l03082"></a>03082         <span class="comment">// default width</span>
<a name="l03083"></a>03083         $w = $this-&gt;CurrentFont[<span class="stringliteral">&#39;dw&#39;</span>];
<a name="l03084"></a>03084       } elseif (isset($cw[32])) {
<a name="l03085"></a>03085         <span class="comment">// default width</span>
<a name="l03086"></a>03086         $dw = $cw[32];
<a name="l03087"></a>03087       } <span class="keywordflow">else</span> {
<a name="l03088"></a>03088         $w = 600;
<a name="l03089"></a>03089       }
<a name="l03090"></a>03090       <span class="keywordflow">return</span> ($w * $this-&gt;FontSize / 1000);
<a name="l03091"></a>03091     }
<a name="l03092"></a>03092     
<a name="l03100"></a>03100     <span class="keyword">public</span> function GetNumChars($s) {
<a name="l03101"></a>03101       <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l03102"></a>03102         <span class="keywordflow">return</span> count($this-&gt;UTF8StringToArray($s));
<a name="l03103"></a>03103       } 
<a name="l03104"></a>03104       <span class="keywordflow">return</span> strlen($s);
<a name="l03105"></a>03105     }
<a name="l03106"></a>03106       
<a name="l03112"></a>03112     <span class="keyword">protected</span> function getFontsList() {
<a name="l03113"></a>03113       $fontsdir = opendir($this-&gt;_getfontpath());
<a name="l03114"></a>03114       <span class="keywordflow">while</span> (($file = readdir($fontsdir)) !== <span class="keyword">false</span>) {
<a name="l03115"></a>03115         <span class="keywordflow">if</span> (substr($file, -4) == <span class="stringliteral">&#39;.php&#39;</span>) {
<a name="l03116"></a>03116           array_push($this-&gt;fontlist, strtolower(basename($file, <span class="stringliteral">&#39;.php&#39;</span>)));
<a name="l03117"></a>03117         }
<a name="l03118"></a>03118       }
<a name="l03119"></a>03119       closedir($fontsdir);
<a name="l03120"></a>03120     }
<a name="l03121"></a>03121     
<a name="l03134"></a>03134     <span class="keyword">public</span> function AddFont($family, $style=<span class="stringliteral">&#39;&#39;</span>, $fontfile=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l03135"></a>03135       <span class="keywordflow">if</span> ($this-&gt;empty_string($family)) {
<a name="l03136"></a>03136         <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;FontFamily)) {
<a name="l03137"></a>03137           $family = $this-&gt;FontFamily;
<a name="l03138"></a>03138         } <span class="keywordflow">else</span> {
<a name="l03139"></a>03139           $this-&gt;Error(<span class="stringliteral">&#39;Empty font family&#39;</span>);
<a name="l03140"></a>03140         }
<a name="l03141"></a>03141       }
<a name="l03142"></a>03142       $family = strtolower($family);
<a name="l03143"></a>03143       <span class="keywordflow">if</span> ((!$this-&gt;isunicode) AND ($family == <span class="stringliteral">&#39;arial&#39;</span>)) {
<a name="l03144"></a>03144         $family = <span class="stringliteral">&#39;helvetica&#39;</span>;
<a name="l03145"></a>03145       }
<a name="l03146"></a>03146       <span class="keywordflow">if</span> (($family == <span class="stringliteral">&#39;symbol&#39;</span>) OR ($family == <span class="stringliteral">&#39;zapfdingbats&#39;</span>)) {
<a name="l03147"></a>03147         $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03148"></a>03148       }
<a name="l03149"></a>03149       $tempstyle = strtoupper($style);
<a name="l03150"></a>03150       $style = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03151"></a>03151       <span class="comment">// underline</span>
<a name="l03152"></a>03152       <span class="keywordflow">if</span> (strpos($tempstyle, <span class="charliteral">&#39;U&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03153"></a>03153         $this-&gt;underline = <span class="keyword">true</span>;
<a name="l03154"></a>03154       } <span class="keywordflow">else</span> {
<a name="l03155"></a>03155         $this-&gt;underline = <span class="keyword">false</span>;
<a name="l03156"></a>03156       }
<a name="l03157"></a>03157       <span class="comment">// line through (deleted)</span>
<a name="l03158"></a>03158       <span class="keywordflow">if</span> (strpos($tempstyle, <span class="charliteral">&#39;D&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03159"></a>03159         $this-&gt;linethrough = <span class="keyword">true</span>;
<a name="l03160"></a>03160       } <span class="keywordflow">else</span> {
<a name="l03161"></a>03161         $this-&gt;linethrough = <span class="keyword">false</span>;
<a name="l03162"></a>03162       }
<a name="l03163"></a>03163       <span class="comment">// bold</span>
<a name="l03164"></a>03164       <span class="keywordflow">if</span> (strpos($tempstyle, <span class="charliteral">&#39;B&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03165"></a>03165         $style .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l03166"></a>03166       }
<a name="l03167"></a>03167       <span class="comment">// oblique</span>
<a name="l03168"></a>03168       <span class="keywordflow">if</span> (strpos($tempstyle, <span class="charliteral">&#39;I&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03169"></a>03169         $style .= <span class="charliteral">&#39;I&#39;</span>;
<a name="l03170"></a>03170       }
<a name="l03171"></a>03171       $bistyle = $style;
<a name="l03172"></a>03172       $fontkey = $family.$style;
<a name="l03173"></a>03173       $font_style = $style.($this-&gt;underline ? <span class="charliteral">&#39;U&#39;</span> : <span class="stringliteral">&#39;&#39;</span>).($this-&gt;linethrough ? <span class="charliteral">&#39;D&#39;</span> : <span class="stringliteral">&#39;&#39;</span>);
<a name="l03174"></a>03174       $fontdata = array(<span class="stringliteral">&#39;fontkey&#39;</span> =&gt; $fontkey, <span class="stringliteral">&#39;family&#39;</span> =&gt; $family, <span class="stringliteral">&#39;style&#39;</span> =&gt; $font_style);
<a name="l03175"></a>03175       <span class="comment">// check if the font has been already added</span>
<a name="l03176"></a>03176       <span class="keywordflow">if</span> ($this-&gt;getFontBuffer($fontkey) !== <span class="keyword">false</span>) {
<a name="l03177"></a>03177         <span class="keywordflow">return</span> $fontdata;
<a name="l03178"></a>03178       }
<a name="l03179"></a>03179       <span class="keywordflow">if</span> (isset($type)) {
<a name="l03180"></a>03180         unset($type); 
<a name="l03181"></a>03181       }
<a name="l03182"></a>03182       <span class="keywordflow">if</span> (isset($cw)) {
<a name="l03183"></a>03183         unset($cw); 
<a name="l03184"></a>03184       }
<a name="l03185"></a>03185       <span class="comment">// get specified font directory (if any)</span>
<a name="l03186"></a>03186       $fontdir = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03187"></a>03187       <span class="keywordflow">if</span> (!$this-&gt;empty_string($fontfile)) {
<a name="l03188"></a>03188         $fontdir = dirname($fontfile);
<a name="l03189"></a>03189         <span class="keywordflow">if</span> ($this-&gt;empty_string($fontdir) OR ($fontdir == <span class="charliteral">&#39;.&#39;</span>)) {
<a name="l03190"></a>03190           $fontdir = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03191"></a>03191         } <span class="keywordflow">else</span> {
<a name="l03192"></a>03192           $fontdir .= <span class="charliteral">&#39;/&#39;</span>;
<a name="l03193"></a>03193         }
<a name="l03194"></a>03194       }
<a name="l03195"></a>03195       <span class="comment">// search and include font file</span>
<a name="l03196"></a>03196       <span class="keywordflow">if</span> ($this-&gt;empty_string($fontfile) OR (!file_exists($fontfile))) {
<a name="l03197"></a>03197         <span class="comment">// build a standard filenames for specified font</span>
<a name="l03198"></a>03198         $fontfile1 = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $family).strtolower($style).<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l03199"></a>03199         $fontfile2 = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $family).<span class="stringliteral">&#39;.php&#39;</span>;
<a name="l03200"></a>03200         <span class="comment">// search files on various directories</span>
<a name="l03201"></a>03201         <span class="keywordflow">if</span> (file_exists($fontdir.$fontfile1)) {
<a name="l03202"></a>03202           $fontfile = $fontdir.$fontfile1;
<a name="l03203"></a>03203         } elseif (file_exists($this-&gt;_getfontpath().$fontfile1)) {
<a name="l03204"></a>03204           $fontfile = $this-&gt;_getfontpath().$fontfile1;
<a name="l03205"></a>03205         } elseif (file_exists($fontfile1)) {
<a name="l03206"></a>03206           $fontfile = $fontfile1;
<a name="l03207"></a>03207         } elseif (file_exists($fontdir.$fontfile2)) {
<a name="l03208"></a>03208           $fontfile = $fontdir.$fontfile2;
<a name="l03209"></a>03209         } elseif (file_exists($this-&gt;_getfontpath().$fontfile2)) {
<a name="l03210"></a>03210           $fontfile = $this-&gt;_getfontpath().$fontfile2;
<a name="l03211"></a>03211         } <span class="keywordflow">else</span> {
<a name="l03212"></a>03212           $fontfile = $fontfile2;
<a name="l03213"></a>03213         }
<a name="l03214"></a>03214       }
<a name="l03215"></a>03215       <span class="comment">// include font file</span>
<a name="l03216"></a>03216       <span class="keywordflow">if</span> (file_exists($fontfile)) {
<a name="l03217"></a>03217         include($fontfile);
<a name="l03218"></a>03218       } <span class="keywordflow">else</span> {
<a name="l03219"></a>03219         $this-&gt;Error(<span class="stringliteral">&#39;Could not include font definition file: &#39;</span>.$family.<span class="stringliteral">&#39;&#39;</span>);
<a name="l03220"></a>03220       }
<a name="l03221"></a>03221       <span class="comment">// check font parameters</span>
<a name="l03222"></a>03222       <span class="keywordflow">if</span> ((!isset($type)) OR (!isset($cw))) {
<a name="l03223"></a>03223         $this-&gt;Error(<span class="stringliteral">&#39;The font definition file has a bad format: &#39;</span>.$fontfile.<span class="stringliteral">&#39;&#39;</span>);
<a name="l03224"></a>03224       }
<a name="l03225"></a>03225       <span class="comment">// SET default parameters</span>
<a name="l03226"></a>03226       <span class="keywordflow">if</span> (!isset($file) OR $this-&gt;empty_string($file)) {
<a name="l03227"></a>03227         $file = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03228"></a>03228       }
<a name="l03229"></a>03229       <span class="keywordflow">if</span> (!isset($enc) OR $this-&gt;empty_string($enc)) {
<a name="l03230"></a>03230         $enc = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03231"></a>03231       }
<a name="l03232"></a>03232       <span class="keywordflow">if</span> (!isset($cidinfo) OR $this-&gt;empty_string($cidinfo)) {
<a name="l03233"></a>03233         $cidinfo = array(<span class="stringliteral">&#39;Registry&#39;</span>=&gt;<span class="stringliteral">&#39;Adobe&#39;</span>,<span class="stringliteral">&#39;Ordering&#39;</span>=&gt;<span class="stringliteral">&#39;Identity&#39;</span>,<span class="stringliteral">&#39;Supplement&#39;</span>=&gt;0);
<a name="l03234"></a>03234         $cidinfo[<span class="stringliteral">&#39;uni2cid&#39;</span>] = array();
<a name="l03235"></a>03235       }
<a name="l03236"></a>03236       <span class="keywordflow">if</span> (!isset($ctg) OR $this-&gt;empty_string($ctg)) {
<a name="l03237"></a>03237         $ctg = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03238"></a>03238       }
<a name="l03239"></a>03239       <span class="keywordflow">if</span> (!isset($desc) OR $this-&gt;empty_string($desc)) {
<a name="l03240"></a>03240         $desc = array();
<a name="l03241"></a>03241       }
<a name="l03242"></a>03242       <span class="keywordflow">if</span> (!isset($up) OR $this-&gt;empty_string($up)) {
<a name="l03243"></a>03243         $up = -100;
<a name="l03244"></a>03244       }
<a name="l03245"></a>03245       <span class="keywordflow">if</span> (!isset($ut) OR $this-&gt;empty_string($ut)) {
<a name="l03246"></a>03246         $ut = 50;
<a name="l03247"></a>03247       }
<a name="l03248"></a>03248       <span class="keywordflow">if</span> (!isset($cw) OR $this-&gt;empty_string($cw)) {
<a name="l03249"></a>03249         $cw = array();
<a name="l03250"></a>03250       }
<a name="l03251"></a>03251       <span class="keywordflow">if</span> (!isset($dw) OR $this-&gt;empty_string($dw)) {
<a name="l03252"></a>03252         <span class="comment">// set default width</span>
<a name="l03253"></a>03253         <span class="keywordflow">if</span> (isset($desc[<span class="stringliteral">&#39;MissingWidth&#39;</span>]) AND ($desc[<span class="stringliteral">&#39;MissingWidth&#39;</span>] &gt; 0)) {
<a name="l03254"></a>03254           $dw = $desc[<span class="stringliteral">&#39;MissingWidth&#39;</span>];
<a name="l03255"></a>03255         } elseif (isset($cw[32])) {
<a name="l03256"></a>03256           $dw = $cw[32];
<a name="l03257"></a>03257         } <span class="keywordflow">else</span> {
<a name="l03258"></a>03258           $dw = 600;
<a name="l03259"></a>03259         }
<a name="l03260"></a>03260       }
<a name="l03261"></a>03261       ++$this-&gt;numfonts;      
<a name="l03262"></a>03262       <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;cidfont0&#39;</span>) {
<a name="l03263"></a>03263         <span class="comment">// register CID font (all styles at once)</span>
<a name="l03264"></a>03264         $styles = array(<span class="stringliteral">&#39;&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>, <span class="charliteral">&#39;B&#39;</span> =&gt; <span class="stringliteral">&#39;,Bold&#39;</span>, <span class="charliteral">&#39;I&#39;</span> =&gt; <span class="stringliteral">&#39;,Italic&#39;</span>, <span class="stringliteral">&#39;BI&#39;</span> =&gt; <span class="stringliteral">&#39;,BoldItalic&#39;</span>);
<a name="l03265"></a>03265         $sname = $name.$styles[$bistyle];
<a name="l03266"></a>03266         <span class="keywordflow">if</span> ((strpos($bistyle, <span class="charliteral">&#39;B&#39;</span>) !== <span class="keyword">false</span>) AND (isset($desc[<span class="stringliteral">&#39;StemV&#39;</span>])) AND ($desc[<span class="stringliteral">&#39;StemV&#39;</span>] == 70)) {
<a name="l03267"></a>03267           $desc[<span class="stringliteral">&#39;StemV&#39;</span>] = 120;
<a name="l03268"></a>03268         }
<a name="l03269"></a>03269       } elseif ($type == <span class="stringliteral">&#39;core&#39;</span>) {
<a name="l03270"></a>03270         $name = $this-&gt;CoreFonts[$fontkey];
<a name="l03271"></a>03271       } elseif (($type == <span class="stringliteral">&#39;TrueType&#39;</span>) OR ($type == <span class="stringliteral">&#39;Type1&#39;</span>)) {
<a name="l03272"></a>03272         <span class="comment">// ...</span>
<a name="l03273"></a>03273       } elseif ($type == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) {
<a name="l03274"></a>03274         $enc = <span class="stringliteral">&#39;Identity-H&#39;</span>;
<a name="l03275"></a>03275       } <span class="keywordflow">else</span> {
<a name="l03276"></a>03276         $this-&gt;Error(<span class="stringliteral">&#39;Unknow font type: &#39;</span>.$type.<span class="stringliteral">&#39;&#39;</span>);
<a name="l03277"></a>03277       }
<a name="l03278"></a>03278       $this-&gt;setFontBuffer($fontkey, array(<span class="charliteral">&#39;i&#39;</span> =&gt; $this-&gt;numfonts, <span class="stringliteral">&#39;type&#39;</span> =&gt; $type, <span class="stringliteral">&#39;name&#39;</span> =&gt; $name, <span class="stringliteral">&#39;desc&#39;</span> =&gt; $desc, <span class="stringliteral">&#39;up&#39;</span> =&gt; $up, <span class="stringliteral">&#39;ut&#39;</span> =&gt; $ut, <span class="stringliteral">&#39;cw&#39;</span> =&gt; $cw, <span class="stringliteral">&#39;dw&#39;</span> =&gt; $dw, <span class="stringliteral">&#39;enc&#39;</span> =&gt; $enc, <span class="stringliteral">&#39;cidinfo&#39;</span> =&gt; $cidinfo, <span class="stringliteral">&#39;file&#39;</span> =&gt; $file, <span class="stringliteral">&#39;ctg&#39;</span> =&gt; $ctg));
<a name="l03279"></a>03279       <span class="keywordflow">if</span> (isset($diff) AND (!empty($diff))) {
<a name="l03280"></a>03280         <span class="comment">//Search existing encodings</span>
<a name="l03281"></a>03281         $d = 0;
<a name="l03282"></a>03282         $nb = count($this-&gt;diffs);
<a name="l03283"></a>03283         <span class="keywordflow">for</span> ($i=1; $i &lt;= $nb; ++$i) {
<a name="l03284"></a>03284           <span class="keywordflow">if</span> ($this-&gt;diffs[$i] == $diff) {
<a name="l03285"></a>03285             $d = $i;
<a name="l03286"></a>03286             <span class="keywordflow">break</span>;
<a name="l03287"></a>03287           }
<a name="l03288"></a>03288         }
<a name="l03289"></a>03289         <span class="keywordflow">if</span> ($d == 0) {
<a name="l03290"></a>03290           $d = $nb + 1;
<a name="l03291"></a>03291           $this-&gt;diffs[$d] = $diff;
<a name="l03292"></a>03292         }
<a name="l03293"></a>03293         $this-&gt;setFontSubBuffer($fontkey, <span class="stringliteral">&#39;diff&#39;</span>, $d);
<a name="l03294"></a>03294       }
<a name="l03295"></a>03295       <span class="keywordflow">if</span> (!$this-&gt;empty_string($file)) {
<a name="l03296"></a>03296         <span class="keywordflow">if</span> ((strcasecmp($type,<span class="stringliteral">&#39;TrueType&#39;</span>) == 0) OR (strcasecmp($type, <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) == 0)) {
<a name="l03297"></a>03297           $this-&gt;FontFiles[$file] = array(<span class="stringliteral">&#39;length1&#39;</span> =&gt; $originalsize, <span class="stringliteral">&#39;fontdir&#39;</span> =&gt; $fontdir);
<a name="l03298"></a>03298         } elseif ($type != <span class="stringliteral">&#39;core&#39;</span>) {
<a name="l03299"></a>03299           $this-&gt;FontFiles[$file] = array(<span class="stringliteral">&#39;length1&#39;</span> =&gt; $size1, <span class="stringliteral">&#39;length2&#39;</span> =&gt; $size2, <span class="stringliteral">&#39;fontdir&#39;</span> =&gt; $fontdir);
<a name="l03300"></a>03300         }
<a name="l03301"></a>03301       }
<a name="l03302"></a>03302       <span class="keywordflow">return</span> $fontdata;
<a name="l03303"></a>03303     }
<a name="l03304"></a>03304 
<a name="l03319"></a>03319     <span class="keyword">public</span> function SetFont($family, $style=<span class="stringliteral">&#39;&#39;</span>, $size=0, $fontfile=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l03320"></a>03320       <span class="comment">//Select a font; size given in points</span>
<a name="l03321"></a>03321       <span class="keywordflow">if</span> ($size == 0) {
<a name="l03322"></a>03322         $size = $this-&gt;FontSizePt;
<a name="l03323"></a>03323       }
<a name="l03324"></a>03324       <span class="comment">// try to add font (if not already added)</span>
<a name="l03325"></a>03325       $fontdata = $this-&gt;AddFont($family, $style, $fontfile);
<a name="l03326"></a>03326       $this-&gt;FontFamily = $fontdata[<span class="stringliteral">&#39;family&#39;</span>];
<a name="l03327"></a>03327       $this-&gt;FontStyle = $fontdata[<span class="stringliteral">&#39;style&#39;</span>];
<a name="l03328"></a>03328       $this-&gt;CurrentFont = $this-&gt;getFontBuffer($fontdata[<span class="stringliteral">&#39;fontkey&#39;</span>]);
<a name="l03329"></a>03329       $this-&gt;SetFontSize($size);
<a name="l03330"></a>03330     }
<a name="l03331"></a>03331 
<a name="l03339"></a>03339     <span class="keyword">public</span> function SetFontSize($size) {
<a name="l03340"></a>03340       <span class="comment">//Set font size in points</span>
<a name="l03341"></a>03341       $this-&gt;FontSizePt = $size;
<a name="l03342"></a>03342       $this-&gt;FontSize = $size / $this-&gt;k;
<a name="l03343"></a>03343       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;Ascent&#39;</span>]) AND ($this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;Ascent&#39;</span>] &gt; 0)) {
<a name="l03344"></a>03344         $this-&gt;FontAscent = $this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;Ascent&#39;</span>] * $this-&gt;FontSize / 1000;
<a name="l03345"></a>03345       } <span class="keywordflow">else</span> {
<a name="l03346"></a>03346         $this-&gt;FontAscent = 0.8 * $this-&gt;FontSize;
<a name="l03347"></a>03347       }
<a name="l03348"></a>03348       <span class="keywordflow">if</span> (isset($this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;Descent&#39;</span>]) AND ($this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;Descent&#39;</span>] &gt; 0)) {
<a name="l03349"></a>03349         $this-&gt;FontDescent = - $this-&gt;CurrentFont[<span class="stringliteral">&#39;desc&#39;</span>][<span class="stringliteral">&#39;Descent&#39;</span>] * $this-&gt;FontSize / 1000;
<a name="l03350"></a>03350       } <span class="keywordflow">else</span> {
<a name="l03351"></a>03351         $this-&gt;FontDescent = 0.2 * $this-&gt;FontSize;
<a name="l03352"></a>03352       }
<a name="l03353"></a>03353       <span class="keywordflow">if</span> (($this-&gt;page &gt; 0) AND (isset($this-&gt;CurrentFont[<span class="charliteral">&#39;i&#39;</span>]))) {
<a name="l03354"></a>03354         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;BT /F%d %.2F Tf ET&#39;</span>, $this-&gt;CurrentFont[<span class="charliteral">&#39;i&#39;</span>], $this-&gt;FontSizePt));
<a name="l03355"></a>03355       }
<a name="l03356"></a>03356     }
<a name="l03357"></a>03357 
<a name="l03364"></a>03364     <span class="keyword">public</span> function SetDefaultMonospacedFont($font) {
<a name="l03365"></a>03365       $this-&gt;default_monospaced_font = $font;
<a name="l03366"></a>03366     }
<a name="l03367"></a>03367     
<a name="l03375"></a>03375     <span class="keyword">public</span> function AddLink() {
<a name="l03376"></a>03376       <span class="comment">//Create a new internal link</span>
<a name="l03377"></a>03377       $n = count($this-&gt;links) + 1;
<a name="l03378"></a>03378       $this-&gt;links[$n] = array(0, 0);
<a name="l03379"></a>03379       <span class="keywordflow">return</span> $n;
<a name="l03380"></a>03380     }
<a name="l03381"></a>03381 
<a name="l03391"></a>03391     <span class="keyword">public</span> function SetLink($link, $y=0, $page=-1) {
<a name="l03392"></a>03392       <span class="keywordflow">if</span> ($y == -1) {
<a name="l03393"></a>03393         $y = $this-&gt;y;
<a name="l03394"></a>03394       }
<a name="l03395"></a>03395       <span class="keywordflow">if</span> ($page == -1) {
<a name="l03396"></a>03396         $page = $this-&gt;page;
<a name="l03397"></a>03397       }
<a name="l03398"></a>03398       $this-&gt;links[$link] = array($page, $y);
<a name="l03399"></a>03399     }
<a name="l03400"></a>03400 
<a name="l03414"></a>03414     <span class="keyword">public</span> function Link($x, $y, $w, $h, $link, $spaces=0) {
<a name="l03415"></a>03415       $this-&gt;Annotation($x, $y, $w, $h, $link, array(<span class="stringliteral">&#39;Subtype&#39;</span>=&gt;<span class="stringliteral">&#39;Link&#39;</span>), $spaces);
<a name="l03416"></a>03416     }
<a name="l03417"></a>03417     
<a name="l03431"></a>03431     <span class="keyword">public</span> function Annotation($x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $w, $h, $text, $opt=array(<span class="stringliteral">&#39;Subtype&#39;</span>=&gt;<span class="stringliteral">&#39;Text&#39;</span>), $spaces=0) {
<a name="l03432"></a>03432       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l03433"></a>03433         $x = $this-&gt;x;
<a name="l03434"></a>03434       }
<a name="l03435"></a>03435       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l03436"></a>03436         $y = $this-&gt;y;
<a name="l03437"></a>03437       }
<a name="l03438"></a>03438       <span class="comment">// recalculate coordinates to account for graphic transformations</span>
<a name="l03439"></a>03439       <span class="keywordflow">if</span> (isset($this-&gt;transfmatrix)) {
<a name="l03440"></a>03440         <span class="keywordflow">for</span> ($i=$this-&gt;transfmatrix_key; $i &gt; 0; --$i) {
<a name="l03441"></a>03441           $maxid = count($this-&gt;transfmatrix[$i]) - 1;
<a name="l03442"></a>03442           <span class="keywordflow">for</span> ($j=$maxid; $j &gt;= 0; --$j) {
<a name="l03443"></a>03443             $ctm = $this-&gt;transfmatrix[$i][$j];
<a name="l03444"></a>03444             <span class="keywordflow">if</span> (isset($ctm[<span class="charliteral">&#39;a&#39;</span>])) {
<a name="l03445"></a>03445               $x = $x * $this-&gt;k;
<a name="l03446"></a>03446               $y = ($this-&gt;h - $y) * $this-&gt;k;
<a name="l03447"></a>03447               $w = $w * $this-&gt;k;
<a name="l03448"></a>03448               $h = $h * $this-&gt;k;
<a name="l03449"></a>03449               <span class="comment">// top left</span>
<a name="l03450"></a>03450               $xt = $x;
<a name="l03451"></a>03451               $yt = $y;
<a name="l03452"></a>03452               $x1 = ($ctm[<span class="charliteral">&#39;a&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;c&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;e&#39;</span>];
<a name="l03453"></a>03453               $y1 = ($ctm[<span class="charliteral">&#39;b&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;d&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;f&#39;</span>];
<a name="l03454"></a>03454               <span class="comment">// top right</span>
<a name="l03455"></a>03455               $xt = $x + $w;
<a name="l03456"></a>03456               $yt = $y;
<a name="l03457"></a>03457               $x2 = ($ctm[<span class="charliteral">&#39;a&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;c&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;e&#39;</span>];
<a name="l03458"></a>03458               $y2 = ($ctm[<span class="charliteral">&#39;b&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;d&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;f&#39;</span>];
<a name="l03459"></a>03459               <span class="comment">// bottom left</span>
<a name="l03460"></a>03460               $xt = $x;
<a name="l03461"></a>03461               $yt = $y - $h;
<a name="l03462"></a>03462               $x3 = ($ctm[<span class="charliteral">&#39;a&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;c&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;e&#39;</span>];
<a name="l03463"></a>03463               $y3 = ($ctm[<span class="charliteral">&#39;b&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;d&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;f&#39;</span>];
<a name="l03464"></a>03464               <span class="comment">// bottom right</span>
<a name="l03465"></a>03465               $xt = $x + $w;
<a name="l03466"></a>03466               $yt = $y - $h;
<a name="l03467"></a>03467               $x4 = ($ctm[<span class="charliteral">&#39;a&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;c&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;e&#39;</span>];
<a name="l03468"></a>03468               $y4 = ($ctm[<span class="charliteral">&#39;b&#39;</span>] * $xt) + ($ctm[<span class="charliteral">&#39;d&#39;</span>] * $yt) + $ctm[<span class="charliteral">&#39;f&#39;</span>];
<a name="l03469"></a>03469               <span class="comment">// new coordinates (rectangle area)</span>
<a name="l03470"></a>03470               $x = min($x1, $x2, $x3, $x4);
<a name="l03471"></a>03471               $y = max($y1, $y2, $y3, $y4);
<a name="l03472"></a>03472               $w = (max($x1, $x2, $x3, $x4) - $x) / $this-&gt;k;
<a name="l03473"></a>03473               $h = ($y - min($y1, $y2, $y3, $y4)) / $this-&gt;k;
<a name="l03474"></a>03474               $x = $x / $this-&gt;k;
<a name="l03475"></a>03475               $y = $this-&gt;h - ($y / $this-&gt;k);
<a name="l03476"></a>03476             }
<a name="l03477"></a>03477           }
<a name="l03478"></a>03478         }
<a name="l03479"></a>03479       }
<a name="l03480"></a>03480       <span class="keywordflow">if</span> ($this-&gt;page &lt;= 0) {
<a name="l03481"></a>03481         $page = 1;
<a name="l03482"></a>03482       } <span class="keywordflow">else</span> {
<a name="l03483"></a>03483         $page = $this-&gt;page;
<a name="l03484"></a>03484       }
<a name="l03485"></a>03485       <span class="keywordflow">if</span> (!isset($this-&gt;PageAnnots[$page])) {
<a name="l03486"></a>03486         $this-&gt;PageAnnots[$page] = array();
<a name="l03487"></a>03487       }
<a name="l03488"></a>03488       $this-&gt;PageAnnots[$page][] = array(<span class="charliteral">&#39;x&#39;</span> =&gt; $x, <span class="charliteral">&#39;y&#39;</span> =&gt; $y, <span class="charliteral">&#39;w&#39;</span> =&gt; $w, <span class="charliteral">&#39;h&#39;</span> =&gt; $h, <span class="stringliteral">&#39;txt&#39;</span> =&gt; $text, <span class="stringliteral">&#39;opt&#39;</span> =&gt; $opt, <span class="stringliteral">&#39;numspaces&#39;</span> =&gt; $spaces);
<a name="l03489"></a>03489       <span class="keywordflow">if</span> (($opt[<span class="stringliteral">&#39;Subtype&#39;</span>] == <span class="stringliteral">&#39;FileAttachment&#39;</span>) AND (!$this-&gt;empty_string($opt[<span class="stringliteral">&#39;FS&#39;</span>])) AND file_exists($opt[<span class="stringliteral">&#39;FS&#39;</span>]) AND (!isset($this-&gt;embeddedfiles[basename($opt[<span class="stringliteral">&#39;FS&#39;</span>])]))) {
<a name="l03490"></a>03490         $this-&gt;embeddedfiles[basename($opt[<span class="stringliteral">&#39;FS&#39;</span>])] = array(<span class="stringliteral">&#39;file&#39;</span> =&gt; $opt[<span class="stringliteral">&#39;FS&#39;</span>], <span class="charliteral">&#39;n&#39;</span> =&gt; (count($this-&gt;embeddedfiles) + $this-&gt;embedded_start_obj_id));
<a name="l03491"></a>03491       }
<a name="l03492"></a>03492       <span class="comment">// Add widgets annotation&#39;s icons</span>
<a name="l03493"></a>03493       <span class="keywordflow">if</span> (isset($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;i&#39;</span>]) AND file_exists($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;i&#39;</span>])) {
<a name="l03494"></a>03494         $this-&gt;Image($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;i&#39;</span>], <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 10, 10, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, 300, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, 0, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l03495"></a>03495       }
<a name="l03496"></a>03496       <span class="keywordflow">if</span> (isset($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ri&#39;</span>]) AND file_exists($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ri&#39;</span>])) {
<a name="l03497"></a>03497         $this-&gt;Image($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ri&#39;</span>], <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 0, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, 300, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, 0, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l03498"></a>03498       }
<a name="l03499"></a>03499       <span class="keywordflow">if</span> (isset($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ix&#39;</span>]) AND file_exists($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ix&#39;</span>])) {
<a name="l03500"></a>03500         $this-&gt;Image($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ix&#39;</span>], <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 0, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, 300, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, 0, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l03501"></a>03501       }
<a name="l03502"></a>03502       ++$this-&gt;annot_obj_id;
<a name="l03503"></a>03503     }
<a name="l03504"></a>03504 
<a name="l03511"></a>03511     <span class="keyword">protected</span> function _putEmbeddedFiles() {
<a name="l03512"></a>03512       reset($this-&gt;embeddedfiles);
<a name="l03513"></a>03513       <span class="keywordflow">foreach</span> ($this-&gt;embeddedfiles as $filename =&gt; $filedata) {
<a name="l03514"></a>03514         $data = file_get_contents($filedata[<span class="stringliteral">&#39;file&#39;</span>]);
<a name="l03515"></a>03515         $filter = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03516"></a>03516         <span class="keywordflow">if</span> ($this-&gt;compress) {
<a name="l03517"></a>03517           $data = gzcompress($data);
<a name="l03518"></a>03518           $filter = <span class="stringliteral">&#39; /Filter /FlateDecode&#39;</span>;
<a name="l03519"></a>03519         }
<a name="l03520"></a>03520         $this-&gt;offsets[$filedata[<span class="charliteral">&#39;n&#39;</span>]] = $this-&gt;bufferlen;
<a name="l03521"></a>03521         $this-&gt;_out($filedata[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l03522"></a>03522         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /EmbeddedFile&#39;</span>.$filter.<span class="stringliteral">&#39; /Length &#39;</span>.strlen($data).<span class="stringliteral">&#39; &gt;&gt;&#39;</span>);
<a name="l03523"></a>03523         $this-&gt;_putstream($data);
<a name="l03524"></a>03524         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l03525"></a>03525       }
<a name="l03526"></a>03526     }
<a name="l03527"></a>03527     
<a name="l03542"></a>03542     <span class="keyword">public</span> function Text($x, $y, $txt, $stroke=0, $clip=<span class="keyword">false</span>) {
<a name="l03543"></a>03543       <span class="comment">//Output a string</span>
<a name="l03544"></a>03544       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03545"></a>03545         <span class="comment">// bidirectional algorithm (some chars may be changed affecting the line length)</span>
<a name="l03546"></a>03546         $s = $this-&gt;utf8Bidi($this-&gt;UTF8StringToArray($txt), $txt, $this-&gt;tmprtl);
<a name="l03547"></a>03547         $l = $this-&gt;GetArrStringWidth($s);
<a name="l03548"></a>03548         $xr = $this-&gt;w - $x - $l;
<a name="l03549"></a>03549       } <span class="keywordflow">else</span> {
<a name="l03550"></a>03550         $xr = $x;
<a name="l03551"></a>03551       }
<a name="l03552"></a>03552       $opt = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03553"></a>03553       <span class="keywordflow">if</span> (($stroke &gt; 0) AND (!$clip)) {
<a name="l03554"></a>03554         $opt .= <span class="stringliteral">&#39;1 Tr &#39;</span>.intval($stroke).<span class="stringliteral">&#39; w &#39;</span>;
<a name="l03555"></a>03555       } elseif (($stroke &gt; 0) AND $clip) {
<a name="l03556"></a>03556         $opt .= <span class="stringliteral">&#39;5 Tr &#39;</span>.intval($stroke).<span class="stringliteral">&#39; w &#39;</span>;
<a name="l03557"></a>03557       } elseif ($clip) {
<a name="l03558"></a>03558         $opt .= <span class="stringliteral">&#39;7 Tr &#39;</span>;
<a name="l03559"></a>03559       }
<a name="l03560"></a>03560       $s = sprintf(<span class="stringliteral">&#39;BT %.2F %.2F Td %s(%s) Tj ET 0 Tr&#39;</span>, $xr * $this-&gt;k, ($this-&gt;h-$y) * $this-&gt;k, $opt, $this-&gt;_escapetext($txt));
<a name="l03561"></a>03561       <span class="keywordflow">if</span> ($this-&gt;underline AND ($txt!=<span class="stringliteral">&#39;&#39;</span>)) {
<a name="l03562"></a>03562         $s .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_dounderline($xr, $y, $txt);
<a name="l03563"></a>03563       }
<a name="l03564"></a>03564       <span class="keywordflow">if</span> ($this-&gt;linethrough AND ($txt!=<span class="stringliteral">&#39;&#39;</span>)) { 
<a name="l03565"></a>03565         $s .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_dolinethrough($xr, $y, $txt); 
<a name="l03566"></a>03566       }
<a name="l03567"></a>03567       <span class="keywordflow">if</span> ($this-&gt;ColorFlag AND (!$clip)) {
<a name="l03568"></a>03568         $s=<span class="stringliteral">&#39;q &#39;</span>.$this-&gt;TextColor.<span class="charliteral">&#39; &#39;</span>.$s.<span class="stringliteral">&#39; Q&#39;</span>;
<a name="l03569"></a>03569       }
<a name="l03570"></a>03570       $this-&gt;_out($s);
<a name="l03571"></a>03571     }
<a name="l03572"></a>03572 
<a name="l03582"></a>03582     <span class="keyword">public</span> function AcceptPageBreak() {
<a name="l03583"></a>03583       <span class="keywordflow">return</span> $this-&gt;AutoPageBreak;
<a name="l03584"></a>03584     }
<a name="l03585"></a>03585     
<a name="l03595"></a>03595     <span class="keyword">protected</span> function checkPageBreak($h=0, $y=<span class="stringliteral">&#39;&#39;</span>, $addpage=<span class="keyword">true</span>) {
<a name="l03596"></a>03596       <span class="keywordflow">if</span> ($this-&gt;empty_string($y)) {
<a name="l03597"></a>03597         $y = $this-&gt;y;
<a name="l03598"></a>03598       }
<a name="l03599"></a>03599       <span class="keywordflow">if</span> ((($y + $h) &gt; $this-&gt;PageBreakTrigger) AND (!$this-&gt;InFooter) AND ($this-&gt;AcceptPageBreak())) {
<a name="l03600"></a>03600         <span class="keywordflow">if</span> ($addpage) {
<a name="l03601"></a>03601           <span class="comment">//Automatic page break</span>
<a name="l03602"></a>03602           $x = $this-&gt;x;
<a name="l03603"></a>03603           $this-&gt;AddPage($this-&gt;CurOrientation);
<a name="l03604"></a>03604           $this-&gt;y = $this-&gt;tMargin;
<a name="l03605"></a>03605           $oldpage = $this-&gt;page - 1;
<a name="l03606"></a>03606           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03607"></a>03607             <span class="keywordflow">if</span> ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>] != $this-&gt;pagedim[$oldpage][<span class="stringliteral">&#39;orm&#39;</span>]) {
<a name="l03608"></a>03608               $this-&gt;x = $x - ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>] - $this-&gt;pagedim[$oldpage][<span class="stringliteral">&#39;orm&#39;</span>]);
<a name="l03609"></a>03609             } <span class="keywordflow">else</span> {
<a name="l03610"></a>03610               $this-&gt;x = $x;
<a name="l03611"></a>03611             }
<a name="l03612"></a>03612           } <span class="keywordflow">else</span> {
<a name="l03613"></a>03613             <span class="keywordflow">if</span> ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>] != $this-&gt;pagedim[$oldpage][<span class="stringliteral">&#39;olm&#39;</span>]) {
<a name="l03614"></a>03614               $this-&gt;x = $x + ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>] - $this-&gt;pagedim[$oldpage][<span class="stringliteral">&#39;olm&#39;</span>]);
<a name="l03615"></a>03615             } <span class="keywordflow">else</span> {
<a name="l03616"></a>03616               $this-&gt;x = $x;
<a name="l03617"></a>03617             }
<a name="l03618"></a>03618           }
<a name="l03619"></a>03619         }
<a name="l03620"></a>03620         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03621"></a>03621       }
<a name="l03622"></a>03622       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03623"></a>03623     }
<a name="l03624"></a>03624 
<a name="l03643"></a>03643     <span class="keyword">public</span> function Cell($w, $h=0, $txt=<span class="stringliteral">&#39;&#39;</span>, $border=0, $ln=0, $align=<span class="stringliteral">&#39;&#39;</span>, $fill=0, $link=<span class="stringliteral">&#39;&#39;</span>, $stretch=0, $ignore_min_height=<span class="keyword">false</span>) {
<a name="l03644"></a>03644       <span class="comment">//$min_cell_height = $this-&gt;FontAscent + $this-&gt;FontDescent;</span>
<a name="l03645"></a>03645       $min_cell_height = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l03646"></a>03646       <span class="keywordflow">if</span> ($h &lt; $min_cell_height) {
<a name="l03647"></a>03647         $h = $min_cell_height;
<a name="l03648"></a>03648       }
<a name="l03649"></a>03649       $this-&gt;checkPageBreak($h);
<a name="l03650"></a>03650       $this-&gt;_out($this-&gt;getCellCode($w, $h, $txt, $border, $ln, $align, $fill, $link, $stretch, $ignore_min_height));
<a name="l03651"></a>03651     }
<a name="l03652"></a>03652 
<a name="l03660"></a>03660     <span class="keyword">public</span> function removeSHY($txt=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l03661"></a>03661       <span class="comment">/*</span>
<a name="l03662"></a>03662 <span class="comment">      * Unicode Data</span>
<a name="l03663"></a>03663 <span class="comment">      * Name : SOFT HYPHEN, commonly abbreviated as SHY</span>
<a name="l03664"></a>03664 <span class="comment">      * HTML Entity (decimal): &amp;#173;</span>
<a name="l03665"></a>03665 <span class="comment">      * HTML Entity (hex): &amp;#xad;</span>
<a name="l03666"></a>03666 <span class="comment">      * HTML Entity (named): &amp;shy;</span>
<a name="l03667"></a>03667 <span class="comment">      * How to type in Microsoft Windows: [Alt +00AD] or [Alt 0173]</span>
<a name="l03668"></a>03668 <span class="comment">      * UTF-8 (hex): 0xC2 0xAD (c2ad)</span>
<a name="l03669"></a>03669 <span class="comment">      * UTF-8 character: chr(194).chr(173)</span>
<a name="l03670"></a>03670 <span class="comment">      */</span>
<a name="l03671"></a>03671       $txt = preg_replace(<span class="stringliteral">&#39;/([\\xc2]{1}[\\xad]{1})/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $txt);
<a name="l03672"></a>03672       <span class="keywordflow">if</span> (!$this-&gt;isunicode) {
<a name="l03673"></a>03673         $txt = preg_replace(<span class="stringliteral">&#39;/([\\xad]{1})/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $txt);
<a name="l03674"></a>03674       }
<a name="l03675"></a>03675       <span class="keywordflow">return</span> $txt;
<a name="l03676"></a>03676     }
<a name="l03677"></a>03677     
<a name="l03695"></a>03695     <span class="keyword">protected</span> function getCellCode($w, $h=0, $txt=<span class="stringliteral">&#39;&#39;</span>, $border=0, $ln=0, $align=<span class="stringliteral">&#39;&#39;</span>, $fill=0, $link=<span class="stringliteral">&#39;&#39;</span>, $stretch=0, $ignore_min_height=<span class="keyword">false</span>) {
<a name="l03696"></a>03696       $txt = $this-&gt;removeSHY($txt);
<a name="l03697"></a>03697       $rs = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">//string to be returned</span>
<a name="l03698"></a>03698       <span class="keywordflow">if</span> (!$ignore_min_height) {
<a name="l03699"></a>03699         $min_cell_height = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l03700"></a>03700         <span class="keywordflow">if</span> ($h &lt; $min_cell_height) {
<a name="l03701"></a>03701           $h = $min_cell_height;
<a name="l03702"></a>03702         }
<a name="l03703"></a>03703       }
<a name="l03704"></a>03704       $k = $this-&gt;k;
<a name="l03705"></a>03705       <span class="keywordflow">if</span> ($this-&gt;empty_string($w) OR ($w &lt;= 0)) {
<a name="l03706"></a>03706         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03707"></a>03707           $w = $this-&gt;x - $this-&gt;lMargin;
<a name="l03708"></a>03708         } <span class="keywordflow">else</span> {
<a name="l03709"></a>03709           $w = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l03710"></a>03710         }
<a name="l03711"></a>03711       }
<a name="l03712"></a>03712       $s = <span class="stringliteral">&#39;&#39;</span>;      
<a name="l03713"></a>03713       <span class="keywordflow">if</span> (($fill == 1) OR ($border == 1)) {
<a name="l03714"></a>03714         <span class="keywordflow">if</span> ($fill == 1) {
<a name="l03715"></a>03715           $op = ($border == 1) ? <span class="charliteral">&#39;B&#39;</span> : <span class="charliteral">&#39;f&#39;</span>;
<a name="l03716"></a>03716         } <span class="keywordflow">else</span> {
<a name="l03717"></a>03717           $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l03718"></a>03718         }
<a name="l03719"></a>03719         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03720"></a>03720           $xk = (($this-&gt;x  - $w) * $k);
<a name="l03721"></a>03721         } <span class="keywordflow">else</span> {
<a name="l03722"></a>03722           $xk = ($this-&gt;x * $k);
<a name="l03723"></a>03723         }
<a name="l03724"></a>03724         $s .= sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F re %s &#39;</span>, $xk, (($this-&gt;h - $this-&gt;y) * $k), ($w * $k), (-$h * $k), $op);
<a name="l03725"></a>03725       }
<a name="l03726"></a>03726       <span class="keywordflow">if</span> (is_string($border)) {
<a name="l03727"></a>03727         $lm = ($this-&gt;LineWidth / 2);
<a name="l03728"></a>03728         $x = $this-&gt;x;
<a name="l03729"></a>03729         $y = $this-&gt;y;
<a name="l03730"></a>03730         <span class="keywordflow">if</span> (strpos($border,<span class="charliteral">&#39;L&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03731"></a>03731           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03732"></a>03732             $xk = ($x - $w) * $k;
<a name="l03733"></a>03733           } <span class="keywordflow">else</span> {
<a name="l03734"></a>03734             $xk = $x * $k;
<a name="l03735"></a>03735           }
<a name="l03736"></a>03736           $s .= sprintf(<span class="stringliteral">&#39;%.2F %.2F m %.2F %.2F l S &#39;</span>, $xk, (($this-&gt;h - $y + $lm) * $k), $xk, (($this-&gt;h - ($y + $h + $lm)) * $k));
<a name="l03737"></a>03737         }
<a name="l03738"></a>03738         <span class="keywordflow">if</span> (strpos($border,<span class="charliteral">&#39;T&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03739"></a>03739           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03740"></a>03740             $xk = ($x - $w + $lm) * $k;
<a name="l03741"></a>03741             $xwk = ($x - $lm) * $k;
<a name="l03742"></a>03742           } <span class="keywordflow">else</span> {
<a name="l03743"></a>03743             $xk = ($x - $lm) * $k;
<a name="l03744"></a>03744             $xwk = ($x + $w + $lm) * $k;
<a name="l03745"></a>03745           }
<a name="l03746"></a>03746           $s .= sprintf(<span class="stringliteral">&#39;%.2F %.2F m %.2F %.2F l S &#39;</span>, $xk, (($this-&gt;h - $y) * $k), $xwk, (($this-&gt;h - $y) * $k));
<a name="l03747"></a>03747         }
<a name="l03748"></a>03748         <span class="keywordflow">if</span> (strpos($border,<span class="charliteral">&#39;R&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03749"></a>03749           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03750"></a>03750             $xk = $x * $k;
<a name="l03751"></a>03751           } <span class="keywordflow">else</span> {
<a name="l03752"></a>03752             $xk = ($x + $w) * $k;
<a name="l03753"></a>03753           }
<a name="l03754"></a>03754           $s .= sprintf(<span class="stringliteral">&#39;%.2F %.2F m %.2F %.2F l S &#39;</span>, $xk, (($this-&gt;h - $y + $lm) * $k), $xk, (($this-&gt;h - ($y + $h + $lm))* $k));
<a name="l03755"></a>03755         }
<a name="l03756"></a>03756         <span class="keywordflow">if</span> (strpos($border,<span class="charliteral">&#39;B&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l03757"></a>03757           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03758"></a>03758             $xk = ($x - $w + $lm) * $k;
<a name="l03759"></a>03759             $xwk = ($x - $lm) * $k;
<a name="l03760"></a>03760           } <span class="keywordflow">else</span> {
<a name="l03761"></a>03761             $xk = ($x - $lm) * $k;
<a name="l03762"></a>03762             $xwk = ($x + $w + $lm) * $k;
<a name="l03763"></a>03763           }
<a name="l03764"></a>03764           $s .= sprintf(<span class="stringliteral">&#39;%.2F %.2F m %.2F %.2F l S &#39;</span>, $xk, (($this-&gt;h - ($y + $h)) * $k), $xwk, (($this-&gt;h - ($y + $h)) * $k));
<a name="l03765"></a>03765         }
<a name="l03766"></a>03766       }
<a name="l03767"></a>03767       <span class="keywordflow">if</span> ($txt != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l03768"></a>03768         <span class="comment">// text lenght</span>
<a name="l03769"></a>03769         $width = $this-&gt;GetStringWidth($txt);
<a name="l03770"></a>03770         <span class="comment">// ratio between cell lenght and text lenght</span>
<a name="l03771"></a>03771         <span class="keywordflow">if</span> ($width &lt;= 0) {
<a name="l03772"></a>03772           $ratio = 1;
<a name="l03773"></a>03773         } <span class="keywordflow">else</span> {
<a name="l03774"></a>03774           $ratio = ($w - (2 * $this-&gt;cMargin)) / $width;
<a name="l03775"></a>03775         }
<a name="l03776"></a>03776         <span class="comment">// stretch text if required</span>
<a name="l03777"></a>03777         <span class="keywordflow">if</span> (($stretch &gt; 0) AND (($ratio &lt; 1) OR (($ratio &gt; 1) AND (($stretch % 2) == 0)))) {
<a name="l03778"></a>03778           <span class="keywordflow">if</span> ($stretch &gt; 2) {
<a name="l03779"></a>03779             <span class="comment">// spacing</span>
<a name="l03780"></a>03780             <span class="comment">//Calculate character spacing in points</span>
<a name="l03781"></a>03781             $char_space = (($w - $width - (2 * $this-&gt;cMargin)) * $this-&gt;k) / max($this-&gt;GetNumChars($txt)-1,1);
<a name="l03782"></a>03782             <span class="comment">//Set character spacing</span>
<a name="l03783"></a>03783             $rs .= sprintf(<span class="stringliteral">&#39;BT %.2F Tc ET &#39;</span>, $char_space);
<a name="l03784"></a>03784           } <span class="keywordflow">else</span> {
<a name="l03785"></a>03785             <span class="comment">// scaling</span>
<a name="l03786"></a>03786             <span class="comment">//Calculate horizontal scaling</span>
<a name="l03787"></a>03787             $horiz_scale = $ratio * 100.0;
<a name="l03788"></a>03788             <span class="comment">//Set horizontal scaling</span>
<a name="l03789"></a>03789             $rs .= sprintf(<span class="stringliteral">&#39;BT %.2F Tz ET &#39;</span>, $horiz_scale);
<a name="l03790"></a>03790           }
<a name="l03791"></a>03791           $align = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03792"></a>03792           $width = $w - (2 * $this-&gt;cMargin);
<a name="l03793"></a>03793         } <span class="keywordflow">else</span> {
<a name="l03794"></a>03794           $stretch == 0;
<a name="l03795"></a>03795         }
<a name="l03796"></a>03796         <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l03797"></a>03797           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03798"></a>03798             $dx = $w - $width - $this-&gt;cMargin;
<a name="l03799"></a>03799           } <span class="keywordflow">else</span> {
<a name="l03800"></a>03800             $dx = $this-&gt;cMargin;
<a name="l03801"></a>03801           }
<a name="l03802"></a>03802         } elseif ($align == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l03803"></a>03803           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03804"></a>03804             $dx = $this-&gt;cMargin;
<a name="l03805"></a>03805           } <span class="keywordflow">else</span> {
<a name="l03806"></a>03806             $dx = $w - $width - $this-&gt;cMargin;
<a name="l03807"></a>03807           }
<a name="l03808"></a>03808         } elseif ($align == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l03809"></a>03809           $dx = ($w - $width) / 2;
<a name="l03810"></a>03810         } elseif ($align == <span class="charliteral">&#39;J&#39;</span>) {
<a name="l03811"></a>03811           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03812"></a>03812             $dx = $w - $width - $this-&gt;cMargin;
<a name="l03813"></a>03813           } <span class="keywordflow">else</span> {
<a name="l03814"></a>03814             $dx = $this-&gt;cMargin;
<a name="l03815"></a>03815           }
<a name="l03816"></a>03816         } <span class="keywordflow">else</span> {
<a name="l03817"></a>03817           $dx = $this-&gt;cMargin;
<a name="l03818"></a>03818         }
<a name="l03819"></a>03819         <span class="keywordflow">if</span> ($this-&gt;ColorFlag) {
<a name="l03820"></a>03820           $s .= <span class="stringliteral">&#39;q &#39;</span>.$this-&gt;TextColor.<span class="charliteral">&#39; &#39;</span>;
<a name="l03821"></a>03821         }
<a name="l03822"></a>03822         $txt2 = $this-&gt;_escapetext($txt);
<a name="l03823"></a>03823         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03824"></a>03824           $xdk = ($this-&gt;x - $dx - $width) * $k;
<a name="l03825"></a>03825         } <span class="keywordflow">else</span> {
<a name="l03826"></a>03826           $xdk = ($this-&gt;x + $dx) * $k;
<a name="l03827"></a>03827         }
<a name="l03828"></a>03828         <span class="comment">// Justification</span>
<a name="l03829"></a>03829         <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;J&#39;</span>) {
<a name="l03830"></a>03830           <span class="comment">// count number of spaces</span>
<a name="l03831"></a>03831           $ns = substr_count($txt, <span class="charliteral">&#39; &#39;</span>);
<a name="l03832"></a>03832           <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l03833"></a>03833             <span class="comment">// get string width without spaces</span>
<a name="l03834"></a>03834             $width = $this-&gt;GetStringWidth(str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $txt));
<a name="l03835"></a>03835             <span class="comment">// calculate average space width</span>
<a name="l03836"></a>03836             $spacewidth = -1000 * ($w - $width - (2 * $this-&gt;cMargin)) / ($ns?$ns:1) / $this-&gt;FontSize;
<a name="l03837"></a>03837             <span class="comment">// set word position to be used with TJ operator</span>
<a name="l03838"></a>03838             $txt2 = str_replace(chr(0).<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;) &#39;</span>.($spacewidth).<span class="stringliteral">&#39; (&#39;</span>, $txt2);
<a name="l03839"></a>03839           } <span class="keywordflow">else</span> {
<a name="l03840"></a>03840             <span class="comment">// get string width</span>
<a name="l03841"></a>03841             $width = $this-&gt;GetStringWidth($txt);
<a name="l03842"></a>03842             $spacewidth = (($w - $width - (2 * $this-&gt;cMargin)) / ($ns?$ns:1)) * $this-&gt;k;
<a name="l03843"></a>03843             $rs .= sprintf(<span class="stringliteral">&#39;BT %.3F Tw ET &#39;</span>, $spacewidth);
<a name="l03844"></a>03844           }
<a name="l03845"></a>03845         }
<a name="l03846"></a>03846         <span class="comment">// calculate approximate position of the font base line</span>
<a name="l03847"></a>03847         <span class="comment">//$basefonty = $this-&gt;y + (($h + $this-&gt;FontAscent - $this-&gt;FontDescent)/2);</span>
<a name="l03848"></a>03848         $basefonty = $this-&gt;y + ($h/2) + ($this-&gt;FontSize/3);
<a name="l03849"></a>03849         <span class="comment">// print text</span>
<a name="l03850"></a>03850         $s .= sprintf(<span class="stringliteral">&#39;BT %.2F %.2F Td [(%s)] TJ ET&#39;</span>, $xdk, (($this-&gt;h - $basefonty) * $k), $txt2);
<a name="l03851"></a>03851         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03852"></a>03852           $xdx = $this-&gt;x - $dx - $width;
<a name="l03853"></a>03853         } <span class="keywordflow">else</span> {
<a name="l03854"></a>03854           $xdx = $this-&gt;x + $dx;
<a name="l03855"></a>03855         }
<a name="l03856"></a>03856         <span class="keywordflow">if</span> ($this-&gt;underline)  {
<a name="l03857"></a>03857           $s .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_dounderlinew($xdx, $basefonty, $width);
<a name="l03858"></a>03858         }
<a name="l03859"></a>03859         <span class="keywordflow">if</span> ($this-&gt;linethrough) { 
<a name="l03860"></a>03860           $s .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_dolinethroughw($xdx, $basefonty, $width);
<a name="l03861"></a>03861         }
<a name="l03862"></a>03862         <span class="keywordflow">if</span> ($this-&gt;ColorFlag) {
<a name="l03863"></a>03863           $s .= <span class="stringliteral">&#39; Q&#39;</span>;
<a name="l03864"></a>03864         }
<a name="l03865"></a>03865         <span class="keywordflow">if</span> ($link) {
<a name="l03866"></a>03866           $this-&gt;Link($xdx, $this-&gt;y + (($h - $this-&gt;FontSize)/2), $width, $this-&gt;FontSize, $link, substr_count($txt, chr(32)));
<a name="l03867"></a>03867         }
<a name="l03868"></a>03868       }
<a name="l03869"></a>03869       <span class="comment">// output cell</span>
<a name="l03870"></a>03870       <span class="keywordflow">if</span> ($s) {
<a name="l03871"></a>03871         <span class="comment">// output cell</span>
<a name="l03872"></a>03872         $rs .= $s;
<a name="l03873"></a>03873         <span class="comment">// reset text stretching</span>
<a name="l03874"></a>03874         <span class="keywordflow">if</span> ($stretch &gt; 2) {
<a name="l03875"></a>03875           <span class="comment">//Reset character horizontal spacing</span>
<a name="l03876"></a>03876           $rs .= <span class="stringliteral">&#39; BT 0 Tc ET&#39;</span>;
<a name="l03877"></a>03877         } elseif ($stretch &gt; 0) {
<a name="l03878"></a>03878           <span class="comment">//Reset character horizontal scaling</span>
<a name="l03879"></a>03879           $rs .= <span class="stringliteral">&#39; BT 100 Tz ET&#39;</span>;
<a name="l03880"></a>03880         }
<a name="l03881"></a>03881       }
<a name="l03882"></a>03882       <span class="comment">// reset word spacing</span>
<a name="l03883"></a>03883       <span class="keywordflow">if</span> (!(($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) AND ($align == <span class="charliteral">&#39;J&#39;</span>)) {
<a name="l03884"></a>03884         $rs .= <span class="stringliteral">&#39; BT 0 Tw ET&#39;</span>;
<a name="l03885"></a>03885       }
<a name="l03886"></a>03886       $this-&gt;lasth = $h;
<a name="l03887"></a>03887       <span class="keywordflow">if</span> ($ln &gt; 0) {
<a name="l03888"></a>03888         <span class="comment">//Go to the beginning of the next line</span>
<a name="l03889"></a>03889         $this-&gt;y += $h;
<a name="l03890"></a>03890         <span class="keywordflow">if</span> ($ln == 1) {
<a name="l03891"></a>03891           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03892"></a>03892             $this-&gt;x = $this-&gt;w - $this-&gt;rMargin;
<a name="l03893"></a>03893           } <span class="keywordflow">else</span> {
<a name="l03894"></a>03894             $this-&gt;x = $this-&gt;lMargin;
<a name="l03895"></a>03895           }
<a name="l03896"></a>03896         }
<a name="l03897"></a>03897       } <span class="keywordflow">else</span> {
<a name="l03898"></a>03898         <span class="comment">// go left or right by case</span>
<a name="l03899"></a>03899         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03900"></a>03900           $this-&gt;x -= $w;
<a name="l03901"></a>03901         } <span class="keywordflow">else</span> {
<a name="l03902"></a>03902           $this-&gt;x += $w;
<a name="l03903"></a>03903         }
<a name="l03904"></a>03904       }
<a name="l03905"></a>03905       $gstyles = <span class="stringliteral">&#39;&#39;</span>.$this-&gt;linestyleWidth.<span class="charliteral">&#39; &#39;</span>.$this-&gt;linestyleCap.<span class="charliteral">&#39; &#39;</span>.$this-&gt;linestyleJoin.<span class="charliteral">&#39; &#39;</span>.$this-&gt;linestyleDash.<span class="charliteral">&#39; &#39;</span>.$this-&gt;DrawColor.<span class="charliteral">&#39; &#39;</span>.$this-&gt;FillColor.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l03906"></a>03906       $rs = $gstyles.$rs;
<a name="l03907"></a>03907       <span class="keywordflow">return</span> $rs;
<a name="l03908"></a>03908     }
<a name="l03909"></a>03909 
<a name="l03933"></a>03933     <span class="keyword">public</span> function MultiCell($w, $h, $txt, $border=0, $align=<span class="charliteral">&#39;J&#39;</span>, $fill=0, $ln=1, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $reseth=<span class="keyword">true</span>, $stretch=0, $ishtml=<span class="keyword">false</span>, $autopadding=<span class="keyword">true</span>, $maxh=0) { 
<a name="l03934"></a>03934       <span class="keywordflow">if</span> ($this-&gt;empty_string($this-&gt;lasth) OR $reseth) {
<a name="l03935"></a>03935         <span class="comment">//set row height</span>
<a name="l03936"></a>03936         $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l03937"></a>03937       }
<a name="l03938"></a>03938       <span class="keywordflow">if</span> (!$this-&gt;empty_string($y)) {
<a name="l03939"></a>03939         $this-&gt;SetY($y);
<a name="l03940"></a>03940       } <span class="keywordflow">else</span> {
<a name="l03941"></a>03941         $y = $this-&gt;GetY();
<a name="l03942"></a>03942       }
<a name="l03943"></a>03943       <span class="comment">// check for page break</span>
<a name="l03944"></a>03944       $this-&gt;checkPageBreak($h);
<a name="l03945"></a>03945       $y = $this-&gt;GetY();
<a name="l03946"></a>03946       <span class="comment">// get current page number</span>
<a name="l03947"></a>03947       $startpage = $this-&gt;page;
<a name="l03948"></a>03948       <span class="keywordflow">if</span> (!$this-&gt;empty_string($x)) {
<a name="l03949"></a>03949         $this-&gt;SetX($x);
<a name="l03950"></a>03950       } <span class="keywordflow">else</span> {
<a name="l03951"></a>03951         $x = $this-&gt;GetX();
<a name="l03952"></a>03952       }
<a name="l03953"></a>03953       <span class="keywordflow">if</span> ($this-&gt;empty_string($w) OR ($w &lt;= 0)) {
<a name="l03954"></a>03954         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03955"></a>03955           $w = $this-&gt;x - $this-&gt;lMargin;
<a name="l03956"></a>03956         } <span class="keywordflow">else</span> {
<a name="l03957"></a>03957           $w = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l03958"></a>03958         }
<a name="l03959"></a>03959       }
<a name="l03960"></a>03960       <span class="comment">// store original margin values</span>
<a name="l03961"></a>03961       $lMargin = $this-&gt;lMargin;
<a name="l03962"></a>03962       $rMargin = $this-&gt;rMargin;
<a name="l03963"></a>03963       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l03964"></a>03964         $this-&gt;SetRightMargin($this-&gt;w - $this-&gt;x);
<a name="l03965"></a>03965         $this-&gt;SetLeftMargin($this-&gt;x - $w);
<a name="l03966"></a>03966       } <span class="keywordflow">else</span> {
<a name="l03967"></a>03967         $this-&gt;SetLeftMargin($this-&gt;x);
<a name="l03968"></a>03968         $this-&gt;SetRightMargin($this-&gt;w - $this-&gt;x - $w);
<a name="l03969"></a>03969       }
<a name="l03970"></a>03970       $starty = $this-&gt;y;
<a name="l03971"></a>03971       <span class="keywordflow">if</span> ($autopadding) {
<a name="l03972"></a>03972         <span class="comment">// Adjust internal padding</span>
<a name="l03973"></a>03973         <span class="keywordflow">if</span> ($this-&gt;cMargin &lt; ($this-&gt;LineWidth / 2)) {
<a name="l03974"></a>03974           $this-&gt;cMargin = ($this-&gt;LineWidth / 2);
<a name="l03975"></a>03975         }
<a name="l03976"></a>03976         <span class="comment">// Add top space if needed</span>
<a name="l03977"></a>03977         <span class="keywordflow">if</span> (($this-&gt;lasth - $this-&gt;FontSize) &lt; $this-&gt;LineWidth) {
<a name="l03978"></a>03978           $this-&gt;y += $this-&gt;LineWidth / 2;
<a name="l03979"></a>03979         }
<a name="l03980"></a>03980         <span class="comment">// add top padding</span>
<a name="l03981"></a>03981         $this-&gt;y += $this-&gt;cMargin;
<a name="l03982"></a>03982       }
<a name="l03983"></a>03983       <span class="keywordflow">if</span> ($ishtml) {
<a name="l03984"></a>03984         <span class="comment">// ******* Write HTML text</span>
<a name="l03985"></a>03985         $this-&gt;writeHTML($txt, <span class="keyword">true</span>, 0, $reseth, <span class="keyword">true</span>, $align);
<a name="l03986"></a>03986         $nl = 1;
<a name="l03987"></a>03987       } <span class="keywordflow">else</span> {
<a name="l03988"></a>03988         <span class="comment">// ******* Write text</span>
<a name="l03989"></a>03989         $nl = $this-&gt;Write($this-&gt;lasth, $txt, <span class="stringliteral">&#39;&#39;</span>, 0, $align, <span class="keyword">true</span>, $stretch, <span class="keyword">false</span>, <span class="keyword">false</span>, $maxh);
<a name="l03990"></a>03990       }
<a name="l03991"></a>03991       <span class="keywordflow">if</span> ($autopadding) {
<a name="l03992"></a>03992         <span class="comment">// add bottom padding</span>
<a name="l03993"></a>03993         $this-&gt;y += $this-&gt;cMargin;
<a name="l03994"></a>03994         <span class="comment">// Add bottom space if needed</span>
<a name="l03995"></a>03995         <span class="keywordflow">if</span> (($this-&gt;lasth - $this-&gt;FontSize) &lt; $this-&gt;LineWidth) {
<a name="l03996"></a>03996           $this-&gt;y += $this-&gt;LineWidth / 2;
<a name="l03997"></a>03997         }
<a name="l03998"></a>03998       }
<a name="l03999"></a>03999       <span class="comment">// Get end-of-text Y position</span>
<a name="l04000"></a>04000       $currentY = $this-&gt;y;
<a name="l04001"></a>04001       <span class="comment">// get latest page number</span>
<a name="l04002"></a>04002       $endpage = $this-&gt;page;
<a name="l04003"></a>04003       <span class="comment">// check if a new page has been created</span>
<a name="l04004"></a>04004       <span class="keywordflow">if</span> ($endpage &gt; $startpage) {
<a name="l04005"></a>04005         <span class="comment">// design borders around HTML cells.</span>
<a name="l04006"></a>04006         <span class="keywordflow">for</span> ($page=$startpage; $page &lt;= $endpage; ++$page) {
<a name="l04007"></a>04007           $this-&gt;setPage($page);
<a name="l04008"></a>04008           <span class="keywordflow">if</span> ($page == $startpage) {
<a name="l04009"></a>04009             $this-&gt;y = $starty; <span class="comment">// put cursor at the beginning of cell on the first page</span>
<a name="l04010"></a>04010             $h = $this-&gt;getPageHeight() - $starty - $this-&gt;getBreakMargin();
<a name="l04011"></a>04011             $cborder = $this-&gt;getBorderMode($border, $position=<span class="stringliteral">&#39;start&#39;</span>);
<a name="l04012"></a>04012           } elseif ($page == $endpage) {
<a name="l04013"></a>04013             $this-&gt;y = $this-&gt;tMargin; <span class="comment">// put cursor at the beginning of last page</span>
<a name="l04014"></a>04014             $h = $currentY - $this-&gt;tMargin;
<a name="l04015"></a>04015             $cborder = $this-&gt;getBorderMode($border, $position=<span class="stringliteral">&#39;end&#39;</span>);
<a name="l04016"></a>04016           } <span class="keywordflow">else</span> {
<a name="l04017"></a>04017             $this-&gt;y = $this-&gt;tMargin; <span class="comment">// put cursor at the beginning of the current page</span>
<a name="l04018"></a>04018             $h = $this-&gt;getPageHeight() - $this-&gt;tMargin - $this-&gt;getBreakMargin();
<a name="l04019"></a>04019             $cborder = $this-&gt;getBorderMode($border, $position=<span class="stringliteral">&#39;middle&#39;</span>);
<a name="l04020"></a>04020           }
<a name="l04021"></a>04021           $nx = $x;
<a name="l04022"></a>04022           <span class="comment">// account for margin changes</span>
<a name="l04023"></a>04023           <span class="keywordflow">if</span> ($page &gt; $startpage) {
<a name="l04024"></a>04024             <span class="keywordflow">if</span> (($this-&gt;rtl) AND ($this-&gt;pagedim[$page][<span class="stringliteral">&#39;orm&#39;</span>] != $this-&gt;pagedim[$startpage][<span class="stringliteral">&#39;orm&#39;</span>])) {
<a name="l04025"></a>04025               $nx = $x + ($this-&gt;pagedim[$page][<span class="stringliteral">&#39;orm&#39;</span>] - $this-&gt;pagedim[$startpage][<span class="stringliteral">&#39;orm&#39;</span>]);
<a name="l04026"></a>04026             } elseif ((!$this-&gt;rtl) AND ($this-&gt;pagedim[$page][<span class="stringliteral">&#39;olm&#39;</span>] != $this-&gt;pagedim[$startpage][<span class="stringliteral">&#39;olm&#39;</span>])) {
<a name="l04027"></a>04027               $nx = $x + ($this-&gt;pagedim[$page][<span class="stringliteral">&#39;olm&#39;</span>] - $this-&gt;pagedim[$startpage][<span class="stringliteral">&#39;olm&#39;</span>]);
<a name="l04028"></a>04028             }
<a name="l04029"></a>04029           }
<a name="l04030"></a>04030           $this-&gt;SetX($nx);
<a name="l04031"></a>04031           $ccode = $this-&gt;getCellCode($w, $h, <span class="stringliteral">&#39;&#39;</span>, $cborder, 1, <span class="stringliteral">&#39;&#39;</span>, $fill, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="keyword">false</span>);
<a name="l04032"></a>04032           <span class="keywordflow">if</span> ($cborder OR $fill) {
<a name="l04033"></a>04033             $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);
<a name="l04034"></a>04034             $pstart = substr($pagebuff, 0, $this-&gt;intmrk[$this-&gt;page]);
<a name="l04035"></a>04035             $pend = substr($pagebuff, $this-&gt;intmrk[$this-&gt;page]);
<a name="l04036"></a>04036             $this-&gt;setPageBuffer($this-&gt;page, $pstart.$ccode.<span class="stringliteral">&quot;\n&quot;</span>.$pend);
<a name="l04037"></a>04037             $this-&gt;intmrk[$this-&gt;page] += strlen($ccode.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l04038"></a>04038           }
<a name="l04039"></a>04039         }
<a name="l04040"></a>04040       } <span class="keywordflow">else</span> {
<a name="l04041"></a>04041         $h = max($h, ($currentY - $y));
<a name="l04042"></a>04042         <span class="comment">// put cursor at the beginning of text</span>
<a name="l04043"></a>04043         $this-&gt;SetY($y); 
<a name="l04044"></a>04044         $this-&gt;SetX($x);
<a name="l04045"></a>04045         <span class="comment">// design a cell around the text</span>
<a name="l04046"></a>04046         $ccode = $this-&gt;getCellCode($w, $h, <span class="stringliteral">&#39;&#39;</span>, $border, 1, <span class="stringliteral">&#39;&#39;</span>, $fill, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="keyword">true</span>);
<a name="l04047"></a>04047         <span class="keywordflow">if</span> ($border OR $fill) {
<a name="l04048"></a>04048           <span class="keywordflow">if</span> (end($this-&gt;transfmrk[$this-&gt;page]) !== <span class="keyword">false</span>) {
<a name="l04049"></a>04049             $pagemarkkey = key($this-&gt;transfmrk[$this-&gt;page]);
<a name="l04050"></a>04050             $pagemark = &amp;$this-&gt;transfmrk[$this-&gt;page][$pagemarkkey];
<a name="l04051"></a>04051           } elseif ($this-&gt;InFooter) {
<a name="l04052"></a>04052             $pagemark = &amp;$this-&gt;footerpos[$this-&gt;page];
<a name="l04053"></a>04053           } <span class="keywordflow">else</span> {
<a name="l04054"></a>04054             $pagemark = &amp;$this-&gt;intmrk[$this-&gt;page];
<a name="l04055"></a>04055           }
<a name="l04056"></a>04056           $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);
<a name="l04057"></a>04057           $pstart = substr($pagebuff, 0, $pagemark);
<a name="l04058"></a>04058           $pend = substr($pagebuff, $pagemark);
<a name="l04059"></a>04059           $this-&gt;setPageBuffer($this-&gt;page, $pstart.$ccode.<span class="stringliteral">&quot;\n&quot;</span>.$pend);
<a name="l04060"></a>04060           $pagemark += strlen($ccode.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l04061"></a>04061         }
<a name="l04062"></a>04062       }
<a name="l04063"></a>04063       <span class="comment">// Get end-of-cell Y position</span>
<a name="l04064"></a>04064       $currentY = $this-&gt;GetY();
<a name="l04065"></a>04065       <span class="comment">// restore original margin values</span>
<a name="l04066"></a>04066       $this-&gt;SetLeftMargin($lMargin);
<a name="l04067"></a>04067       $this-&gt;SetRightMargin($rMargin);
<a name="l04068"></a>04068       <span class="keywordflow">if</span> ($ln &gt; 0) {
<a name="l04069"></a>04069         <span class="comment">//Go to the beginning of the next line</span>
<a name="l04070"></a>04070         $this-&gt;SetY($currentY);
<a name="l04071"></a>04071         <span class="keywordflow">if</span> ($ln == 2) {
<a name="l04072"></a>04072           $this-&gt;SetX($x + $w);
<a name="l04073"></a>04073         }
<a name="l04074"></a>04074       } <span class="keywordflow">else</span> {
<a name="l04075"></a>04075         <span class="comment">// go left or right by case</span>
<a name="l04076"></a>04076         $this-&gt;setPage($startpage);
<a name="l04077"></a>04077         $this-&gt;y = $y;
<a name="l04078"></a>04078         $this-&gt;SetX($x + $w);
<a name="l04079"></a>04079       }
<a name="l04080"></a>04080       $this-&gt;setContentMark();
<a name="l04081"></a>04081       <span class="keywordflow">return</span> $nl;
<a name="l04082"></a>04082     }
<a name="l04083"></a>04083 
<a name="l04092"></a>04092     <span class="keyword">protected</span> function getBorderMode($border, $position=<span class="stringliteral">&#39;start&#39;</span>) {
<a name="l04093"></a>04093       <span class="keywordflow">if</span> ((!$this-&gt;opencell) AND ($border == 1)) {
<a name="l04094"></a>04094         <span class="keywordflow">return</span> 1;
<a name="l04095"></a>04095       }
<a name="l04096"></a>04096       $cborder = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04097"></a>04097       <span class="keywordflow">switch</span> ($position) {
<a name="l04098"></a>04098         <span class="keywordflow">case</span> <span class="stringliteral">&#39;start&#39;</span>: {
<a name="l04099"></a>04099           <span class="keywordflow">if</span> ($border == 1) {
<a name="l04100"></a>04100             $cborder = <span class="stringliteral">&#39;LTR&#39;</span>;
<a name="l04101"></a>04101           } <span class="keywordflow">else</span> {
<a name="l04102"></a>04102             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;L&#39;</span>))) {
<a name="l04103"></a>04103               $cborder .= <span class="charliteral">&#39;L&#39;</span>;
<a name="l04104"></a>04104             }
<a name="l04105"></a>04105             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;T&#39;</span>))) {
<a name="l04106"></a>04106               $cborder .= <span class="charliteral">&#39;T&#39;</span>;
<a name="l04107"></a>04107             }
<a name="l04108"></a>04108             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;R&#39;</span>))) {
<a name="l04109"></a>04109               $cborder .= <span class="charliteral">&#39;R&#39;</span>;
<a name="l04110"></a>04110             }
<a name="l04111"></a>04111             <span class="keywordflow">if</span> ((!$this-&gt;opencell) AND (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;B&#39;</span>)))) {
<a name="l04112"></a>04112               $cborder .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l04113"></a>04113             }
<a name="l04114"></a>04114           }
<a name="l04115"></a>04115           <span class="keywordflow">break</span>;
<a name="l04116"></a>04116         }
<a name="l04117"></a>04117         <span class="keywordflow">case</span> <span class="stringliteral">&#39;middle&#39;</span>: {
<a name="l04118"></a>04118           <span class="keywordflow">if</span> ($border == 1) {
<a name="l04119"></a>04119             $cborder = <span class="stringliteral">&#39;LR&#39;</span>;
<a name="l04120"></a>04120           } <span class="keywordflow">else</span> {
<a name="l04121"></a>04121             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;L&#39;</span>))) {
<a name="l04122"></a>04122               $cborder .= <span class="charliteral">&#39;L&#39;</span>;
<a name="l04123"></a>04123             }
<a name="l04124"></a>04124             <span class="keywordflow">if</span> ((!$this-&gt;opencell) AND (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;T&#39;</span>)))) {
<a name="l04125"></a>04125               $cborder .= <span class="charliteral">&#39;T&#39;</span>;
<a name="l04126"></a>04126             }
<a name="l04127"></a>04127             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;R&#39;</span>))) {
<a name="l04128"></a>04128               $cborder .= <span class="charliteral">&#39;R&#39;</span>;
<a name="l04129"></a>04129             }
<a name="l04130"></a>04130             <span class="keywordflow">if</span> ((!$this-&gt;opencell) AND (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;B&#39;</span>)))) {
<a name="l04131"></a>04131               $cborder .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l04132"></a>04132             }
<a name="l04133"></a>04133           }
<a name="l04134"></a>04134           <span class="keywordflow">break</span>;
<a name="l04135"></a>04135         }
<a name="l04136"></a>04136         <span class="keywordflow">case</span> <span class="stringliteral">&#39;end&#39;</span>: {
<a name="l04137"></a>04137           <span class="keywordflow">if</span> ($border == 1) {
<a name="l04138"></a>04138             $cborder = <span class="stringliteral">&#39;LRB&#39;</span>;
<a name="l04139"></a>04139           } <span class="keywordflow">else</span> {
<a name="l04140"></a>04140             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;L&#39;</span>))) {
<a name="l04141"></a>04141               $cborder .= <span class="charliteral">&#39;L&#39;</span>;
<a name="l04142"></a>04142             }
<a name="l04143"></a>04143             <span class="keywordflow">if</span> ((!$this-&gt;opencell) AND (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;T&#39;</span>)))) {
<a name="l04144"></a>04144               $cborder .= <span class="charliteral">&#39;T&#39;</span>;
<a name="l04145"></a>04145             }
<a name="l04146"></a>04146             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;R&#39;</span>))) {
<a name="l04147"></a>04147               $cborder .= <span class="charliteral">&#39;R&#39;</span>;
<a name="l04148"></a>04148             }
<a name="l04149"></a>04149             <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($border, <span class="charliteral">&#39;B&#39;</span>))) {
<a name="l04150"></a>04150               $cborder .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l04151"></a>04151             }
<a name="l04152"></a>04152           }
<a name="l04153"></a>04153           <span class="keywordflow">break</span>;
<a name="l04154"></a>04154         }
<a name="l04155"></a>04155         <span class="keywordflow">default</span>: {
<a name="l04156"></a>04156           $cborder = $border;
<a name="l04157"></a>04157           <span class="keywordflow">break</span>;
<a name="l04158"></a>04158         }
<a name="l04159"></a>04159       }
<a name="l04160"></a>04160       <span class="keywordflow">return</span> $cborder;
<a name="l04161"></a>04161     }
<a name="l04162"></a>04162 
<a name="l04171"></a>04171     <span class="keyword">public</span> function getNumLines($txt, $w=0) {
<a name="l04172"></a>04172       $lines = 0;
<a name="l04173"></a>04173       <span class="keywordflow">if</span> ($this-&gt;empty_string($w) OR ($w &lt;= 0)) {
<a name="l04174"></a>04174         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04175"></a>04175           $w = $this-&gt;x - $this-&gt;lMargin;
<a name="l04176"></a>04176         } <span class="keywordflow">else</span> {
<a name="l04177"></a>04177           $w = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l04178"></a>04178         }
<a name="l04179"></a>04179       }
<a name="l04180"></a>04180       <span class="comment">// max column width</span>
<a name="l04181"></a>04181       $wmax = $w - (2 * $this-&gt;cMargin);
<a name="l04182"></a>04182       <span class="comment">// remove carriage returns</span>
<a name="l04183"></a>04183       $txt = str_replace(<span class="stringliteral">&quot;\r&quot;</span>, <span class="stringliteral">&#39;&#39;</span>, $txt);
<a name="l04184"></a>04184       <span class="comment">// remove last newline (if any)</span>
<a name="l04185"></a>04185       <span class="keywordflow">if</span> (substr($txt,-1) == <span class="stringliteral">&quot;\n&quot;</span>) {
<a name="l04186"></a>04186         $txt = substr($txt, 0, -1);
<a name="l04187"></a>04187       }
<a name="l04188"></a>04188       <span class="comment">// divide text in blocks</span>
<a name="l04189"></a>04189       $txtblocks = explode(<span class="stringliteral">&quot;\n&quot;</span>, $txt);
<a name="l04190"></a>04190       <span class="comment">// for each block;</span>
<a name="l04191"></a>04191       <span class="keywordflow">foreach</span> ($txtblocks as $block) {
<a name="l04192"></a>04192         <span class="comment">// estimate the number of lines</span>
<a name="l04193"></a>04193         $lines += $this-&gt;empty_string($block) ? 1 : (ceil($this-&gt;GetStringWidth($block) / $wmax));
<a name="l04194"></a>04194       }
<a name="l04195"></a>04195       <span class="keywordflow">return</span> $lines;
<a name="l04196"></a>04196     }
<a name="l04197"></a>04197       
<a name="l04214"></a>04214     <span class="keyword">public</span> function Write($h, $txt, $link=<span class="stringliteral">&#39;&#39;</span>, $fill=0, $align=<span class="stringliteral">&#39;&#39;</span>, $ln=<span class="keyword">false</span>, $stretch=0, $firstline=<span class="keyword">false</span>, $firstblock=<span class="keyword">false</span>, $maxh=0) {
<a name="l04215"></a>04215       <span class="keywordflow">if</span> (strlen($txt) == 0) {
<a name="l04216"></a>04216         $txt = <span class="charliteral">&#39; &#39;</span>;
<a name="l04217"></a>04217       }
<a name="l04218"></a>04218       <span class="comment">// remove carriage returns</span>
<a name="l04219"></a>04219       $s = str_replace(<span class="stringliteral">&quot;\r&quot;</span>, <span class="stringliteral">&#39;&#39;</span>, $txt);
<a name="l04220"></a>04220       <span class="comment">// check if string contains arabic text</span>
<a name="l04221"></a>04221       <span class="keywordflow">if</span> (preg_match(K_RE_PATTERN_ARABIC, $s)) {
<a name="l04222"></a>04222         $arabic = <span class="keyword">true</span>;
<a name="l04223"></a>04223       } <span class="keywordflow">else</span> {
<a name="l04224"></a>04224         $arabic = <span class="keyword">false</span>;
<a name="l04225"></a>04225       }
<a name="l04226"></a>04226       <span class="comment">// check if string contains RTL text</span>
<a name="l04227"></a>04227       <span class="keywordflow">if</span> ($arabic OR $this-&gt;tmprtl OR preg_match(K_RE_PATTERN_RTL, $txt)) {
<a name="l04228"></a>04228         $rtlmode = <span class="keyword">true</span>;
<a name="l04229"></a>04229       } <span class="keywordflow">else</span> {
<a name="l04230"></a>04230         $rtlmode = <span class="keyword">false</span>;
<a name="l04231"></a>04231       }
<a name="l04232"></a>04232       <span class="comment">// get a char width</span>
<a name="l04233"></a>04233       $chrwidth = $this-&gt;GetCharWidth(<span class="charliteral">&#39;.&#39;</span>);
<a name="l04234"></a>04234       <span class="comment">// get array of unicode values</span>
<a name="l04235"></a>04235       $chars = $this-&gt;UTF8StringToArray($s);
<a name="l04236"></a>04236       <span class="comment">// get array of chars</span>
<a name="l04237"></a>04237       $uchars = $this-&gt;UTF8ArrayToUniArray($chars);
<a name="l04238"></a>04238       <span class="comment">// get the number of characters</span>
<a name="l04239"></a>04239       $nb = count($chars);
<a name="l04240"></a>04240       <span class="comment">// replacement for SHY character (minus symbol)</span>
<a name="l04241"></a>04241       $shy_replacement = 45;
<a name="l04242"></a>04242       $shy_replacement_char = $this-&gt;unichr($shy_replacement);
<a name="l04243"></a>04243       <span class="comment">// widht for SHY replacement</span>
<a name="l04244"></a>04244       $shy_replacement_width = $this-&gt;GetCharWidth($shy_replacement);
<a name="l04245"></a>04245       <span class="comment">// store current position</span>
<a name="l04246"></a>04246       $prevx = $this-&gt;x;
<a name="l04247"></a>04247       $prevy = $this-&gt;y;
<a name="l04248"></a>04248       <span class="comment">// max Y</span>
<a name="l04249"></a>04249       $maxy = $this-&gt;y + $maxh - $h - (2 * $this-&gt;cMargin);
<a name="l04250"></a>04250       <span class="comment">// calculate remaining line width ($w)</span>
<a name="l04251"></a>04251       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04252"></a>04252         $w = $this-&gt;x - $this-&gt;lMargin;
<a name="l04253"></a>04253       } <span class="keywordflow">else</span> {
<a name="l04254"></a>04254         $w = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l04255"></a>04255       }
<a name="l04256"></a>04256       <span class="comment">// max column width</span>
<a name="l04257"></a>04257       $wmax = $w - (2 * $this-&gt;cMargin);
<a name="l04258"></a>04258       <span class="keywordflow">if</span> ((!$firstline) AND (($chrwidth &gt; $wmax) OR ($this-&gt;GetCharWidth($chars[0]) &gt; $wmax))) {
<a name="l04259"></a>04259         <span class="comment">// a single character do not fit on column</span>
<a name="l04260"></a>04260         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l04261"></a>04261       }
<a name="l04262"></a>04262       $i = 0; <span class="comment">// character position</span>
<a name="l04263"></a>04263       $j = 0; <span class="comment">// current starting position</span>
<a name="l04264"></a>04264       $sep = -1; <span class="comment">// position of the last blank space</span>
<a name="l04265"></a>04265       $shy = <span class="keyword">false</span>; <span class="comment">// true if the last blank is a soft hypen (SHY)</span>
<a name="l04266"></a>04266       $l = 0; <span class="comment">// current string lenght</span>
<a name="l04267"></a>04267       $nl = 0; <span class="comment">//number of lines</span>
<a name="l04268"></a>04268       $linebreak = <span class="keyword">false</span>;
<a name="l04269"></a>04269       <span class="comment">// for each character</span>
<a name="l04270"></a>04270       <span class="keywordflow">while</span> ($i &lt; $nb) {
<a name="l04271"></a>04271         <span class="keywordflow">if</span> (($maxh &gt; 0) AND ($this-&gt;y &gt;= $maxy) ) {
<a name="l04272"></a>04272           $firstline = <span class="keyword">true</span>;
<a name="l04273"></a>04273         }
<a name="l04274"></a>04274         <span class="comment">//Get the current character</span>
<a name="l04275"></a>04275         $c = $chars[$i];
<a name="l04276"></a>04276         <span class="keywordflow">if</span> ($c == 10) { <span class="comment">// 10 = &quot;\n&quot; = new line</span>
<a name="l04277"></a>04277           <span class="comment">//Explicit line break</span>
<a name="l04278"></a>04278           <span class="keywordflow">if</span> ($align == <span class="charliteral">&#39;J&#39;</span>) {
<a name="l04279"></a>04279             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04280"></a>04280               $talign = <span class="charliteral">&#39;R&#39;</span>;
<a name="l04281"></a>04281             } <span class="keywordflow">else</span> {
<a name="l04282"></a>04282               $talign = <span class="charliteral">&#39;L&#39;</span>;
<a name="l04283"></a>04283             }
<a name="l04284"></a>04284           } <span class="keywordflow">else</span> {
<a name="l04285"></a>04285             $talign = $align;
<a name="l04286"></a>04286           }
<a name="l04287"></a>04287           $tmpstr = $this-&gt;UniArrSubString($uchars, $j, $i);
<a name="l04288"></a>04288           <span class="keywordflow">if</span> ($firstline) {
<a name="l04289"></a>04289             $startx = $this-&gt;x;
<a name="l04290"></a>04290             $tmparr = array_slice($chars, $j, $i);
<a name="l04291"></a>04291             <span class="keywordflow">if</span> ($rtlmode) {
<a name="l04292"></a>04292               $tmparr = $this-&gt;utf8Bidi($tmparr, $tmpstr, $this-&gt;tmprtl);
<a name="l04293"></a>04293             }
<a name="l04294"></a>04294             $linew = $this-&gt;GetArrStringWidth($tmparr);
<a name="l04295"></a>04295             unset($tmparr);
<a name="l04296"></a>04296             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04297"></a>04297               $this-&gt;endlinex = $startx - $linew;
<a name="l04298"></a>04298             } <span class="keywordflow">else</span> {
<a name="l04299"></a>04299               $this-&gt;endlinex = $startx + $linew;
<a name="l04300"></a>04300             }
<a name="l04301"></a>04301             $w = $linew;
<a name="l04302"></a>04302             $tmpcmargin = $this-&gt;cMargin;
<a name="l04303"></a>04303             <span class="keywordflow">if</span> ($maxh == 0) {
<a name="l04304"></a>04304               $this-&gt;cMargin = 0;
<a name="l04305"></a>04305             }
<a name="l04306"></a>04306           }
<a name="l04307"></a>04307           $this-&gt;Cell($w, $h, $tmpstr, 0, 1, $talign, $fill, $link, $stretch);
<a name="l04308"></a>04308           unset($tmpstr);
<a name="l04309"></a>04309           <span class="keywordflow">if</span> ($firstline) {
<a name="l04310"></a>04310             $this-&gt;cMargin = $tmpcmargin;
<a name="l04311"></a>04311             <span class="keywordflow">return</span> ($this-&gt;UniArrSubString($uchars, $i));
<a name="l04312"></a>04312           }
<a name="l04313"></a>04313           ++$nl;
<a name="l04314"></a>04314           $j = $i + 1;
<a name="l04315"></a>04315           $l = 0;
<a name="l04316"></a>04316           $sep = -1;
<a name="l04317"></a>04317           $shy = <span class="keyword">false</span>;
<a name="l04318"></a>04318           <span class="comment">// account for margin changes</span>
<a name="l04319"></a>04319           <span class="keywordflow">if</span> ((($this-&gt;y + $this-&gt;lasth) &gt; $this-&gt;PageBreakTrigger) AND (!$this-&gt;InFooter)) {
<a name="l04320"></a>04320             <span class="comment">// AcceptPageBreak() may be overriden on extended classed to include margin changes</span>
<a name="l04321"></a>04321             $this-&gt;AcceptPageBreak();
<a name="l04322"></a>04322           }
<a name="l04323"></a>04323           $w = $this-&gt;getRemainingWidth();
<a name="l04324"></a>04324           $wmax = $w - (2 * $this-&gt;cMargin);
<a name="l04325"></a>04325         } <span class="keywordflow">else</span> {
<a name="l04326"></a>04326           <span class="comment">// 160 is the non-breaking space.</span>
<a name="l04327"></a>04327           <span class="comment">// 173 is SHY (Soft Hypen).</span>
<a name="l04328"></a>04328           <span class="comment">// \p{Z} or \p{Separator}: any kind of Unicode whitespace or invisible separator.</span>
<a name="l04329"></a>04329           <span class="comment">// \p{Lo} or \p{Other_Letter}: a Unicode letter or ideograph that does not have lowercase and uppercase variants.</span>
<a name="l04330"></a>04330           <span class="comment">// \p{Lo} is needed because Chinese characters are packed next to each other without spaces in between.</span>
<a name="l04331"></a>04331           <span class="keywordflow">if</span> (($c != 160) AND (($c == 173) OR preg_match($this-&gt;re_spaces, $this-&gt;unichr($c)))) {
<a name="l04332"></a>04332             <span class="comment">// update last blank space position</span>
<a name="l04333"></a>04333             $sep = $i;
<a name="l04334"></a>04334             <span class="comment">// check if is a SHY</span>
<a name="l04335"></a>04335             <span class="keywordflow">if</span> ($c == 173) {
<a name="l04336"></a>04336               $shy = <span class="keyword">true</span>;
<a name="l04337"></a>04337             } <span class="keywordflow">else</span> {
<a name="l04338"></a>04338               $shy = <span class="keyword">false</span>;
<a name="l04339"></a>04339             }
<a name="l04340"></a>04340           }
<a name="l04341"></a>04341           <span class="comment">// update string length</span>
<a name="l04342"></a>04342           <span class="keywordflow">if</span> ((($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) AND ($arabic)) {
<a name="l04343"></a>04343             <span class="comment">// with bidirectional algorithm some chars may be changed affecting the line length</span>
<a name="l04344"></a>04344             <span class="comment">// *** very slow ***</span>
<a name="l04345"></a>04345             $l = $this-&gt;GetArrStringWidth($this-&gt;utf8Bidi(array_slice($chars, $j, $i-$j+1), <span class="stringliteral">&#39;&#39;</span>, $this-&gt;tmprtl));
<a name="l04346"></a>04346           } <span class="keywordflow">else</span> {
<a name="l04347"></a>04347             $l += $this-&gt;GetCharWidth($c);
<a name="l04348"></a>04348           }
<a name="l04349"></a>04349           <span class="keywordflow">if</span> (($l &gt; $wmax) OR ($shy AND (($l + $shy_replacement_width) &gt; $wmax)) ) {
<a name="l04350"></a>04350             <span class="comment">// we have reached the end of column</span>
<a name="l04351"></a>04351             <span class="keywordflow">if</span> ($sep == -1) {
<a name="l04352"></a>04352               <span class="comment">// check if the line was already started</span>
<a name="l04353"></a>04353               <span class="keywordflow">if</span> (($this-&gt;rtl AND ($this-&gt;x &lt;= ($this-&gt;w - $this-&gt;rMargin - $chrwidth)))
<a name="l04354"></a>04354                 OR ((!$this-&gt;rtl) AND ($this-&gt;x &gt;= ($this-&gt;lMargin + $chrwidth)))) {
<a name="l04355"></a>04355                 <span class="comment">// print a void cell and go to next line</span>
<a name="l04356"></a>04356                 $this-&gt;Cell($w, $h, <span class="stringliteral">&#39;&#39;</span>, 0, 1);
<a name="l04357"></a>04357                 $linebreak = <span class="keyword">true</span>;
<a name="l04358"></a>04358                 <span class="keywordflow">if</span> ($firstline) {
<a name="l04359"></a>04359                   <span class="keywordflow">return</span> ($this-&gt;UniArrSubString($uchars, $j));
<a name="l04360"></a>04360                 }
<a name="l04361"></a>04361               } <span class="keywordflow">else</span> {
<a name="l04362"></a>04362                 <span class="comment">// truncate the word because do not fit on column</span>
<a name="l04363"></a>04363                 $tmpstr = $this-&gt;UniArrSubString($uchars, $j, $i);
<a name="l04364"></a>04364                 <span class="keywordflow">if</span> ($firstline) {
<a name="l04365"></a>04365                   $startx = $this-&gt;x;
<a name="l04366"></a>04366                   $tmparr = array_slice($chars, $j, $i);
<a name="l04367"></a>04367                   <span class="keywordflow">if</span> ($rtlmode) {
<a name="l04368"></a>04368                     $tmparr = $this-&gt;utf8Bidi($tmparr, $tmpstr, $this-&gt;tmprtl);
<a name="l04369"></a>04369                   }
<a name="l04370"></a>04370                   $linew = $this-&gt;GetArrStringWidth($tmparr);
<a name="l04371"></a>04371                   unset($tmparr);
<a name="l04372"></a>04372                   <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04373"></a>04373                     $this-&gt;endlinex = $startx - $linew;
<a name="l04374"></a>04374                   } <span class="keywordflow">else</span> {
<a name="l04375"></a>04375                     $this-&gt;endlinex = $startx + $linew;
<a name="l04376"></a>04376                   }
<a name="l04377"></a>04377                   $w = $linew;
<a name="l04378"></a>04378                   $tmpcmargin = $this-&gt;cMargin;
<a name="l04379"></a>04379                   <span class="keywordflow">if</span> ($maxh == 0) {
<a name="l04380"></a>04380                     $this-&gt;cMargin = 0;
<a name="l04381"></a>04381                   }
<a name="l04382"></a>04382                 }
<a name="l04383"></a>04383                 $this-&gt;Cell($w, $h, $tmpstr, 0, 1, $align, $fill, $link, $stretch);
<a name="l04384"></a>04384                 unset($tmpstr);
<a name="l04385"></a>04385                 <span class="keywordflow">if</span> ($firstline) {
<a name="l04386"></a>04386                   $this-&gt;cMargin = $tmpcmargin;
<a name="l04387"></a>04387                   <span class="keywordflow">return</span> ($this-&gt;UniArrSubString($uchars, $i));
<a name="l04388"></a>04388                 }
<a name="l04389"></a>04389                 $j = $i;
<a name="l04390"></a>04390                 --$i;
<a name="l04391"></a>04391               } 
<a name="l04392"></a>04392             } <span class="keywordflow">else</span> {
<a name="l04393"></a>04393               <span class="comment">// word wrapping</span>
<a name="l04394"></a>04394               <span class="keywordflow">if</span> ($this-&gt;rtl AND (!$firstblock)) {
<a name="l04395"></a>04395                 $endspace = 1;
<a name="l04396"></a>04396               } <span class="keywordflow">else</span> {
<a name="l04397"></a>04397                 $endspace = 0;
<a name="l04398"></a>04398               }
<a name="l04399"></a>04399               <span class="keywordflow">if</span> ($shy) {
<a name="l04400"></a>04400                 <span class="comment">// add hypen (minus symbol) at the end of the line</span>
<a name="l04401"></a>04401                 $shy_width = $shy_replacement_width;
<a name="l04402"></a>04402                 <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04403"></a>04403                   $shy_char_left = $shy_replacement_char;
<a name="l04404"></a>04404                   $shy_char_right = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04405"></a>04405                 } <span class="keywordflow">else</span> {
<a name="l04406"></a>04406                   $shy_char_left = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04407"></a>04407                   $shy_char_right = $shy_replacement_char;
<a name="l04408"></a>04408                 }
<a name="l04409"></a>04409               } <span class="keywordflow">else</span> {
<a name="l04410"></a>04410                 $shy_width = 0;
<a name="l04411"></a>04411                 $shy_char_left = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04412"></a>04412                 $shy_char_right = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04413"></a>04413               }
<a name="l04414"></a>04414               $tmpstr = $this-&gt;UniArrSubString($uchars, $j, ($sep + $endspace));
<a name="l04415"></a>04415               <span class="keywordflow">if</span> ($firstline) {
<a name="l04416"></a>04416                 $startx = $this-&gt;x;
<a name="l04417"></a>04417                 $tmparr = array_slice($chars, $j, ($sep + $endspace));
<a name="l04418"></a>04418                 <span class="keywordflow">if</span> ($rtlmode) {
<a name="l04419"></a>04419                   $tmparr = $this-&gt;utf8Bidi($tmparr, $tmpstr, $this-&gt;tmprtl);
<a name="l04420"></a>04420                 }
<a name="l04421"></a>04421                 $linew = $this-&gt;GetArrStringWidth($tmparr);
<a name="l04422"></a>04422                 unset($tmparr);
<a name="l04423"></a>04423                 <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04424"></a>04424                   $this-&gt;endlinex = $startx - $linew - $shy_width;
<a name="l04425"></a>04425                 } <span class="keywordflow">else</span> {
<a name="l04426"></a>04426                   $this-&gt;endlinex = $startx + $linew + $shy_width;
<a name="l04427"></a>04427                 }
<a name="l04428"></a>04428                 $w = $linew;
<a name="l04429"></a>04429                 $tmpcmargin = $this-&gt;cMargin;
<a name="l04430"></a>04430                 <span class="keywordflow">if</span> ($maxh == 0) {
<a name="l04431"></a>04431                   $this-&gt;cMargin = 0;
<a name="l04432"></a>04432                 }
<a name="l04433"></a>04433               }
<a name="l04434"></a>04434               <span class="comment">// print the line</span>
<a name="l04435"></a>04435               $this-&gt;Cell($w, $h, $shy_char_left.$tmpstr.$shy_char_right, 0, 1, $align, $fill, $link, $stretch);
<a name="l04436"></a>04436               unset($tmpstr);
<a name="l04437"></a>04437               <span class="keywordflow">if</span> ($firstline) {
<a name="l04438"></a>04438                 <span class="comment">// return the remaining text</span>
<a name="l04439"></a>04439                 $this-&gt;cMargin = $tmpcmargin;
<a name="l04440"></a>04440                 <span class="keywordflow">return</span> ($this-&gt;UniArrSubString($uchars, ($sep + $endspace)));
<a name="l04441"></a>04441               }
<a name="l04442"></a>04442               $i = $sep;
<a name="l04443"></a>04443               $sep = -1;
<a name="l04444"></a>04444               $shy = <span class="keyword">false</span>;
<a name="l04445"></a>04445               $j = ($i+1);
<a name="l04446"></a>04446             }
<a name="l04447"></a>04447             <span class="comment">// account for margin changes</span>
<a name="l04448"></a>04448             <span class="keywordflow">if</span> ((($this-&gt;y + $this-&gt;lasth) &gt; $this-&gt;PageBreakTrigger) AND (!$this-&gt;InFooter)) {
<a name="l04449"></a>04449               <span class="comment">// AcceptPageBreak() may be overriden on extended classed to include margin changes</span>
<a name="l04450"></a>04450               $this-&gt;AcceptPageBreak();
<a name="l04451"></a>04451             }
<a name="l04452"></a>04452             $w = $this-&gt;getRemainingWidth();
<a name="l04453"></a>04453             $wmax = $w - (2 * $this-&gt;cMargin);
<a name="l04454"></a>04454             <span class="keywordflow">if</span> ($linebreak) {
<a name="l04455"></a>04455               $linebreak = <span class="keyword">false</span>;
<a name="l04456"></a>04456             } <span class="keywordflow">else</span> {
<a name="l04457"></a>04457               ++$nl;
<a name="l04458"></a>04458               $l = 0;
<a name="l04459"></a>04459             }
<a name="l04460"></a>04460           }
<a name="l04461"></a>04461         }
<a name="l04462"></a>04462         ++$i;
<a name="l04463"></a>04463       } <span class="comment">// end while i &lt; nb</span>
<a name="l04464"></a>04464       <span class="comment">// print last substring (if any)</span>
<a name="l04465"></a>04465       <span class="keywordflow">if</span> ($l &gt; 0) {
<a name="l04466"></a>04466         <span class="keywordflow">switch</span> ($align) {
<a name="l04467"></a>04467           <span class="keywordflow">case</span> <span class="charliteral">&#39;J&#39;</span>:
<a name="l04468"></a>04468           <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>: {
<a name="l04469"></a>04469             $w = $w;
<a name="l04470"></a>04470             <span class="keywordflow">break</span>;
<a name="l04471"></a>04471           }
<a name="l04472"></a>04472           <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>: {
<a name="l04473"></a>04473             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04474"></a>04474               $w = $w;
<a name="l04475"></a>04475             } <span class="keywordflow">else</span> {
<a name="l04476"></a>04476               $w = $l;
<a name="l04477"></a>04477             }
<a name="l04478"></a>04478             <span class="keywordflow">break</span>;
<a name="l04479"></a>04479           }
<a name="l04480"></a>04480           <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>: {
<a name="l04481"></a>04481             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04482"></a>04482               $w = $l;
<a name="l04483"></a>04483             } <span class="keywordflow">else</span> {
<a name="l04484"></a>04484               $w = $w;
<a name="l04485"></a>04485             }
<a name="l04486"></a>04486             <span class="keywordflow">break</span>;
<a name="l04487"></a>04487           }
<a name="l04488"></a>04488           <span class="keywordflow">default</span>: {
<a name="l04489"></a>04489             $w = $l;
<a name="l04490"></a>04490             <span class="keywordflow">break</span>;
<a name="l04491"></a>04491           }
<a name="l04492"></a>04492         }
<a name="l04493"></a>04493         $tmpstr = $this-&gt;UniArrSubString($uchars, $j, $nb);
<a name="l04494"></a>04494         <span class="keywordflow">if</span> ($firstline) {
<a name="l04495"></a>04495           $startx = $this-&gt;x;
<a name="l04496"></a>04496           $tmparr = array_slice($chars, $j, $nb);
<a name="l04497"></a>04497           <span class="keywordflow">if</span> ($rtlmode) {
<a name="l04498"></a>04498             $tmparr = $this-&gt;utf8Bidi($tmparr, $tmpstr, $this-&gt;tmprtl);
<a name="l04499"></a>04499           }
<a name="l04500"></a>04500           $linew = $this-&gt;GetArrStringWidth($tmparr);
<a name="l04501"></a>04501           unset($tmparr);
<a name="l04502"></a>04502           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04503"></a>04503             $this-&gt;endlinex = $startx - $linew;
<a name="l04504"></a>04504           } <span class="keywordflow">else</span> {
<a name="l04505"></a>04505             $this-&gt;endlinex = $startx + $linew;
<a name="l04506"></a>04506           }
<a name="l04507"></a>04507           $w = $linew;
<a name="l04508"></a>04508           $tmpcmargin = $this-&gt;cMargin;
<a name="l04509"></a>04509           <span class="keywordflow">if</span> ($maxh == 0) {
<a name="l04510"></a>04510             $this-&gt;cMargin = 0;
<a name="l04511"></a>04511           }
<a name="l04512"></a>04512         }
<a name="l04513"></a>04513         $this-&gt;Cell($w, $h, $tmpstr, 0, $ln, $align, $fill, $link, $stretch);
<a name="l04514"></a>04514         unset($tmpstr);
<a name="l04515"></a>04515         <span class="keywordflow">if</span> ($firstline) {
<a name="l04516"></a>04516           $this-&gt;cMargin = $tmpcmargin;
<a name="l04517"></a>04517           <span class="keywordflow">return</span> ($this-&gt;UniArrSubString($uchars, $nb));
<a name="l04518"></a>04518         }
<a name="l04519"></a>04519         ++$nl;
<a name="l04520"></a>04520       }
<a name="l04521"></a>04521       <span class="keywordflow">if</span> ($firstline) {
<a name="l04522"></a>04522         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l04523"></a>04523       }
<a name="l04524"></a>04524       <span class="keywordflow">return</span> $nl;
<a name="l04525"></a>04525     }
<a name="l04526"></a>04526         
<a name="l04532"></a>04532     <span class="keyword">protected</span> function getRemainingWidth() {
<a name="l04533"></a>04533       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04534"></a>04534         <span class="keywordflow">return</span> ($this-&gt;x - $this-&gt;lMargin);
<a name="l04535"></a>04535       } <span class="keywordflow">else</span> {
<a name="l04536"></a>04536         <span class="keywordflow">return</span> ($this-&gt;w - $this-&gt;rMargin - $this-&gt;x);
<a name="l04537"></a>04537       }
<a name="l04538"></a>04538     }
<a name="l04539"></a>04539 
<a name="l04548"></a>04548     <span class="keyword">public</span> function UTF8ArrSubString($strarr, $start=<span class="stringliteral">&#39;&#39;</span>, $end=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l04549"></a>04549       <span class="keywordflow">if</span> (strlen($start) == 0) {
<a name="l04550"></a>04550         $start = 0;
<a name="l04551"></a>04551       }
<a name="l04552"></a>04552       <span class="keywordflow">if</span> (strlen($end) == 0) {
<a name="l04553"></a>04553         $end = count($strarr);
<a name="l04554"></a>04554       }
<a name="l04555"></a>04555       $string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04556"></a>04556       <span class="keywordflow">for</span> ($i=$start; $i &lt; $end; ++$i) {
<a name="l04557"></a>04557         $string .= $this-&gt;unichr($strarr[$i]);
<a name="l04558"></a>04558       }
<a name="l04559"></a>04559       <span class="keywordflow">return</span> $string;
<a name="l04560"></a>04560     }
<a name="l04561"></a>04561 
<a name="l04571"></a>04571     <span class="keyword">public</span> function UniArrSubString($uniarr, $start=<span class="stringliteral">&#39;&#39;</span>, $end=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l04572"></a>04572       <span class="keywordflow">if</span> (strlen($start) == 0) {
<a name="l04573"></a>04573         $start = 0;
<a name="l04574"></a>04574       }
<a name="l04575"></a>04575       <span class="keywordflow">if</span> (strlen($end) == 0) {
<a name="l04576"></a>04576         $end = count($uniarr);
<a name="l04577"></a>04577       }
<a name="l04578"></a>04578       $string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04579"></a>04579       <span class="keywordflow">for</span> ($i=$start; $i &lt; $end; ++$i) {
<a name="l04580"></a>04580         $string .= $uniarr[$i];
<a name="l04581"></a>04581       }
<a name="l04582"></a>04582       <span class="keywordflow">return</span> $string;
<a name="l04583"></a>04583     }
<a name="l04584"></a>04584 
<a name="l04592"></a>04592     <span class="keyword">public</span> function UTF8ArrayToUniArray($ta) {
<a name="l04593"></a>04593       <span class="keywordflow">return</span> array_map(array($this, <span class="stringliteral">&#39;unichr&#39;</span>), $ta);
<a name="l04594"></a>04594     }
<a name="l04595"></a>04595     
<a name="l04604"></a>04604     <span class="keyword">public</span> function unichr($c) {
<a name="l04605"></a>04605       <span class="keywordflow">if</span> (!$this-&gt;isunicode) {
<a name="l04606"></a>04606         <span class="keywordflow">return</span> chr($c);
<a name="l04607"></a>04607       } elseif ($c &lt;= 0x7F) {
<a name="l04608"></a>04608         <span class="comment">// one byte</span>
<a name="l04609"></a>04609         <span class="keywordflow">return</span> chr($c);
<a name="l04610"></a>04610       } elseif ($c &lt;= 0x7FF) {
<a name="l04611"></a>04611         <span class="comment">// two bytes</span>
<a name="l04612"></a>04612         <span class="keywordflow">return</span> chr(0xC0 | $c &gt;&gt; 6).chr(0x80 | $c &amp; 0x3F);
<a name="l04613"></a>04613       } elseif ($c &lt;= 0xFFFF) {
<a name="l04614"></a>04614         <span class="comment">// three bytes</span>
<a name="l04615"></a>04615         <span class="keywordflow">return</span> chr(0xE0 | $c &gt;&gt; 12).chr(0x80 | $c &gt;&gt; 6 &amp; 0x3F).chr(0x80 | $c &amp; 0x3F);
<a name="l04616"></a>04616       } elseif ($c &lt;= 0x10FFFF) {
<a name="l04617"></a>04617         <span class="comment">// four bytes</span>
<a name="l04618"></a>04618         <span class="keywordflow">return</span> chr(0xF0 | $c &gt;&gt; 18).chr(0x80 | $c &gt;&gt; 12 &amp; 0x3F).chr(0x80 | $c &gt;&gt; 6 &amp; 0x3F).chr(0x80 | $c &amp; 0x3F);
<a name="l04619"></a>04619       } <span class="keywordflow">else</span> {
<a name="l04620"></a>04620         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l04621"></a>04621       }
<a name="l04622"></a>04622     }
<a name="l04623"></a>04623     
<a name="l04655"></a>04655     <span class="keyword">public</span> function Image($file, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $w=0, $h=0, $type=<span class="stringliteral">&#39;&#39;</span>, $link=<span class="stringliteral">&#39;&#39;</span>, $align=<span class="stringliteral">&#39;&#39;</span>, $resize=<span class="keyword">false</span>, $dpi=300, $palign=<span class="stringliteral">&#39;&#39;</span>, $ismask=<span class="keyword">false</span>, $imgmask=<span class="keyword">false</span>, $border=0, $fitbox=<span class="keyword">false</span>, $hidden=<span class="keyword">false</span>) {
<a name="l04656"></a>04656       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04657"></a>04657         $x = $this-&gt;x;
<a name="l04658"></a>04658       }
<a name="l04659"></a>04659       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04660"></a>04660         $y = $this-&gt;y;
<a name="l04661"></a>04661       }
<a name="l04662"></a>04662       <span class="comment">// get image dimensions</span>
<a name="l04663"></a>04663       $imsize = @getimagesize($file);
<a name="l04664"></a>04664       <span class="keywordflow">if</span> ($imsize === FALSE) {
<a name="l04665"></a>04665         <span class="comment">// encode spaces on filename</span>
<a name="l04666"></a>04666         $file = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;%20&#39;</span>, $file);
<a name="l04667"></a>04667         $imsize = @getimagesize($file);
<a name="l04668"></a>04668         <span class="keywordflow">if</span> ($imsize === FALSE) {
<a name="l04669"></a>04669           $this-&gt;Error(<span class="stringliteral">&#39;[Image] No such file or directory in &#39;</span>.$file);
<a name="l04670"></a>04670         }
<a name="l04671"></a>04671       }
<a name="l04672"></a>04672       <span class="comment">// get original image width and height in pixels</span>
<a name="l04673"></a>04673       list($pixw, $pixh) = $imsize;
<a name="l04674"></a>04674       <span class="comment">// calculate image width and height on document</span>
<a name="l04675"></a>04675       <span class="keywordflow">if</span> (($w &lt;= 0) AND ($h &lt;= 0)) {
<a name="l04676"></a>04676         <span class="comment">// convert image size to document unit</span>
<a name="l04677"></a>04677         $w = $this-&gt;pixelsToUnits($pixw);
<a name="l04678"></a>04678         $h = $this-&gt;pixelsToUnits($pixh);
<a name="l04679"></a>04679       } elseif ($w &lt;= 0) {
<a name="l04680"></a>04680         $w = $h * $pixw / $pixh;
<a name="l04681"></a>04681       } elseif ($h &lt;= 0) {
<a name="l04682"></a>04682         $h = $w * $pixh / $pixw;
<a name="l04683"></a>04683       } elseif ($fitbox AND ($w &gt; 0) AND ($h &gt; 0)) {
<a name="l04684"></a>04684         <span class="comment">// scale image dimensions proportionally to fit within the ($w, $h) box</span>
<a name="l04685"></a>04685         <span class="keywordflow">if</span> ((($w * $pixh) / ($h * $pixw)) &lt; 1) {
<a name="l04686"></a>04686           $h = $w * $pixh / $pixw;
<a name="l04687"></a>04687         } <span class="keywordflow">else</span> {
<a name="l04688"></a>04688           $w = $h * $pixw / $pixh;
<a name="l04689"></a>04689         }
<a name="l04690"></a>04690       }
<a name="l04691"></a>04691       <span class="comment">// calculate new minimum dimensions in pixels</span>
<a name="l04692"></a>04692       $neww = round($w * $this-&gt;k * $dpi / $this-&gt;dpi);
<a name="l04693"></a>04693       $newh = round($h * $this-&gt;k * $dpi / $this-&gt;dpi);
<a name="l04694"></a>04694       <span class="comment">// check if resize is necessary (resize is used only to reduce the image)</span>
<a name="l04695"></a>04695       <span class="keywordflow">if</span> (($neww * $newh) &gt;= ($pixw * $pixh)) {
<a name="l04696"></a>04696         $resize = <span class="keyword">false</span>;
<a name="l04697"></a>04697       }
<a name="l04698"></a>04698       <span class="comment">// check if image has been already added on document</span>
<a name="l04699"></a>04699       <span class="keywordflow">if</span> (!in_array($file, $this-&gt;imagekeys)) {
<a name="l04700"></a>04700         <span class="comment">//First use of image, get info</span>
<a name="l04701"></a>04701         <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04702"></a>04702           $fileinfo = pathinfo($file);
<a name="l04703"></a>04703           <span class="keywordflow">if</span> (isset($fileinfo[<span class="stringliteral">&#39;extension&#39;</span>]) AND (!$this-&gt;empty_string($fileinfo[<span class="stringliteral">&#39;extension&#39;</span>]))) {
<a name="l04704"></a>04704             $type = $fileinfo[<span class="stringliteral">&#39;extension&#39;</span>];
<a name="l04705"></a>04705           } <span class="keywordflow">else</span> {
<a name="l04706"></a>04706             $this-&gt;Error(<span class="stringliteral">&#39;Image file has no extension and no type was specified: &#39;</span>.$file);
<a name="l04707"></a>04707           }
<a name="l04708"></a>04708         }
<a name="l04709"></a>04709         $type = strtolower($type);
<a name="l04710"></a>04710         <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;jpg&#39;</span>) {
<a name="l04711"></a>04711           $type = <span class="stringliteral">&#39;jpeg&#39;</span>;
<a name="l04712"></a>04712         }
<a name="l04713"></a>04713         $mqr = $this-&gt;get_mqr();
<a name="l04714"></a>04714         $this-&gt;set_mqr(<span class="keyword">false</span>);
<a name="l04715"></a>04715         <span class="comment">// Specific image handlers</span>
<a name="l04716"></a>04716         $mtd = <span class="stringliteral">&#39;_parse&#39;</span>.$type;
<a name="l04717"></a>04717         <span class="comment">// GD image handler function</span>
<a name="l04718"></a>04718         $gdfunction = <span class="stringliteral">&#39;imagecreatefrom&#39;</span>.$type;
<a name="l04719"></a>04719         $info = <span class="keyword">false</span>;
<a name="l04720"></a>04720         <span class="keywordflow">if</span> ((method_exists($this, $mtd)) AND (!($resize AND function_exists($gdfunction)))) {
<a name="l04721"></a>04721           <span class="comment">// TCPDF image functions</span>
<a name="l04722"></a>04722           $info = $this-&gt;$mtd($file);
<a name="l04723"></a>04723           <span class="keywordflow">if</span> ($info == <span class="stringliteral">&#39;pngalpha&#39;</span>) {
<a name="l04724"></a>04724             <span class="keywordflow">return</span> $this-&gt;ImagePngAlpha($file, $x, $y, $w, $h, <span class="stringliteral">&#39;PNG&#39;</span>, $link, $align, $resize, $dpi, $palign);
<a name="l04725"></a>04725           }
<a name="l04726"></a>04726         } 
<a name="l04727"></a>04727         <span class="keywordflow">if</span> (!$info) {
<a name="l04728"></a>04728           <span class="keywordflow">if</span> (function_exists($gdfunction)) {
<a name="l04729"></a>04729             <span class="comment">// GD library</span>
<a name="l04730"></a>04730             $img = $gdfunction($file);
<a name="l04731"></a>04731             <span class="keywordflow">if</span> ($resize) {
<a name="l04732"></a>04732               $imgr = imagecreatetruecolor($neww, $newh);
<a name="l04733"></a>04733               imagecopyresampled($imgr, $img, 0, 0, 0, 0, $neww, $newh, $pixw, $pixh); 
<a name="l04734"></a>04734               $info = $this-&gt;_toJPEG($imgr);
<a name="l04735"></a>04735             } <span class="keywordflow">else</span> {
<a name="l04736"></a>04736               $info = $this-&gt;_toJPEG($img);
<a name="l04737"></a>04737             }
<a name="l04738"></a>04738           } elseif (extension_loaded(<span class="stringliteral">&#39;imagick&#39;</span>)) {
<a name="l04739"></a>04739             <span class="comment">// ImageMagick library</span>
<a name="l04740"></a>04740             $img = <span class="keyword">new</span> Imagick();
<a name="l04741"></a>04741             $img-&gt;readImage($file);
<a name="l04742"></a>04742             <span class="keywordflow">if</span> ($resize) {
<a name="l04743"></a>04743               $img-&gt;resizeImage($neww, $newh, 10, 1, <span class="keyword">false</span>);
<a name="l04744"></a>04744             }
<a name="l04745"></a>04745             $img-&gt;setCompressionQuality($this-&gt;jpeg_quality);
<a name="l04746"></a>04746             $img-&gt;setImageFormat(<span class="stringliteral">&#39;jpeg&#39;</span>);
<a name="l04747"></a>04747             $tempname = tempnam(K_PATH_CACHE, <span class="stringliteral">&#39;jpg_&#39;</span>);
<a name="l04748"></a>04748             $img-&gt;writeImage($tempname);
<a name="l04749"></a>04749             $info = $this-&gt;_parsejpeg($tempname);
<a name="l04750"></a>04750             unlink($tempname);
<a name="l04751"></a>04751             $img-&gt;destroy();
<a name="l04752"></a>04752           } <span class="keywordflow">else</span> {
<a name="l04753"></a>04753             <span class="keywordflow">return</span>;
<a name="l04754"></a>04754           }
<a name="l04755"></a>04755         }
<a name="l04756"></a>04756         <span class="keywordflow">if</span> ($info === <span class="keyword">false</span>) {
<a name="l04757"></a>04757           <span class="comment">//If false, we cannot process image</span>
<a name="l04758"></a>04758           <span class="keywordflow">return</span>;
<a name="l04759"></a>04759         }
<a name="l04760"></a>04760         $this-&gt;set_mqr($mqr);
<a name="l04761"></a>04761         <span class="keywordflow">if</span> ($ismask) {
<a name="l04762"></a>04762           <span class="comment">// force grayscale</span>
<a name="l04763"></a>04763           $info[<span class="stringliteral">&#39;cs&#39;</span>] = <span class="stringliteral">&#39;DeviceGray&#39;</span>;
<a name="l04764"></a>04764         }
<a name="l04765"></a>04765         $info[<span class="charliteral">&#39;i&#39;</span>] = $this-&gt;numimages + 1;
<a name="l04766"></a>04766         <span class="keywordflow">if</span> ($imgmask !== <span class="keyword">false</span>) {
<a name="l04767"></a>04767           $info[<span class="stringliteral">&#39;masked&#39;</span>] = $imgmask;
<a name="l04768"></a>04768         }
<a name="l04769"></a>04769         <span class="comment">// add image to document</span>
<a name="l04770"></a>04770         $this-&gt;setImageBuffer($file, $info);
<a name="l04771"></a>04771       } <span class="keywordflow">else</span> {
<a name="l04772"></a>04772         $info = $this-&gt;getImageBuffer($file);
<a name="l04773"></a>04773       }
<a name="l04774"></a>04774       <span class="comment">// Check whether we need a new page first as this does not fit</span>
<a name="l04775"></a>04775       <span class="keywordflow">if</span> ($this-&gt;checkPageBreak($h, $y)) {
<a name="l04776"></a>04776         $y = $this-&gt;GetY() + $this-&gt;cMargin;
<a name="l04777"></a>04777       }
<a name="l04778"></a>04778       <span class="comment">// set bottomcoordinates</span>
<a name="l04779"></a>04779       $this-&gt;img_rb_y = $y + $h;
<a name="l04780"></a>04780       <span class="comment">// set alignment</span>
<a name="l04781"></a>04781       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l04782"></a>04782         <span class="keywordflow">if</span> ($palign == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l04783"></a>04783           $ximg = $this-&gt;lMargin;
<a name="l04784"></a>04784           <span class="comment">// set right side coordinate</span>
<a name="l04785"></a>04785           $this-&gt;img_rb_x = $ximg + $w;
<a name="l04786"></a>04786         } elseif ($palign == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l04787"></a>04787           $ximg = ($this-&gt;w - $x - $w) / 2;
<a name="l04788"></a>04788           <span class="comment">// set right side coordinate</span>
<a name="l04789"></a>04789           $this-&gt;img_rb_x = $ximg + $w;
<a name="l04790"></a>04790         } <span class="keywordflow">else</span> {
<a name="l04791"></a>04791           $ximg = $this-&gt;w - $x - $w;
<a name="l04792"></a>04792           <span class="comment">// set left side coordinate</span>
<a name="l04793"></a>04793           $this-&gt;img_rb_x = $ximg;
<a name="l04794"></a>04794         }
<a name="l04795"></a>04795       } <span class="keywordflow">else</span> {
<a name="l04796"></a>04796         <span class="keywordflow">if</span> ($palign == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l04797"></a>04797           $ximg = $this-&gt;w - $this-&gt;rMargin - $w;
<a name="l04798"></a>04798           <span class="comment">// set left side coordinate</span>
<a name="l04799"></a>04799           $this-&gt;img_rb_x = $ximg;
<a name="l04800"></a>04800         } elseif ($palign == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l04801"></a>04801           $ximg = ($this-&gt;w - $x - $w) / 2;
<a name="l04802"></a>04802           <span class="comment">// set right side coordinate</span>
<a name="l04803"></a>04803           $this-&gt;img_rb_x = $ximg + $w;
<a name="l04804"></a>04804         } <span class="keywordflow">else</span> {
<a name="l04805"></a>04805           $ximg = $x;
<a name="l04806"></a>04806           <span class="comment">// set right side coordinate</span>
<a name="l04807"></a>04807           $this-&gt;img_rb_x = $ximg + $w;
<a name="l04808"></a>04808         }
<a name="l04809"></a>04809       }
<a name="l04810"></a>04810       <span class="keywordflow">if</span> ($ismask OR $hidden) {
<a name="l04811"></a>04811         <span class="comment">// image is not displayed</span>
<a name="l04812"></a>04812         <span class="keywordflow">return</span> $info[<span class="charliteral">&#39;i&#39;</span>];
<a name="l04813"></a>04813       }
<a name="l04814"></a>04814       $xkimg = $ximg * $this-&gt;k;
<a name="l04815"></a>04815       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;q %.2F 0 0 %.2F %.2F %.2F cm /I%d Do Q&#39;</span>, ($w * $this-&gt;k), ($h * $this-&gt;k), $xkimg, (($this-&gt;h - ($y + $h)) * $this-&gt;k), $info[<span class="charliteral">&#39;i&#39;</span>]));
<a name="l04816"></a>04816       <span class="keywordflow">if</span> (!empty($border)) {
<a name="l04817"></a>04817         $bx = $x;
<a name="l04818"></a>04818         $by = $y;
<a name="l04819"></a>04819         $this-&gt;x = $ximg;
<a name="l04820"></a>04820         $this-&gt;y = $y;
<a name="l04821"></a>04821         $this-&gt;Cell($w, $h, <span class="stringliteral">&#39;&#39;</span>, $border, 0, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, 0);
<a name="l04822"></a>04822         $this-&gt;x = $bx;
<a name="l04823"></a>04823         $this-&gt;y = $by;
<a name="l04824"></a>04824       }
<a name="l04825"></a>04825       <span class="keywordflow">if</span> ($link) {
<a name="l04826"></a>04826         $this-&gt;Link($ximg, $y, $w, $h, $link, 0);
<a name="l04827"></a>04827       }
<a name="l04828"></a>04828       <span class="comment">// set pointer to align the successive text/objects</span>
<a name="l04829"></a>04829       <span class="keywordflow">switch</span>($align) {
<a name="l04830"></a>04830         <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>: {
<a name="l04831"></a>04831           $this-&gt;y = $y;
<a name="l04832"></a>04832           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l04833"></a>04833           <span class="keywordflow">break</span>;
<a name="l04834"></a>04834         }
<a name="l04835"></a>04835         <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>: {
<a name="l04836"></a>04836           $this-&gt;y = $y + round($h/2);
<a name="l04837"></a>04837           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l04838"></a>04838           <span class="keywordflow">break</span>;
<a name="l04839"></a>04839         }
<a name="l04840"></a>04840         <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>: {
<a name="l04841"></a>04841           $this-&gt;y = $this-&gt;img_rb_y;
<a name="l04842"></a>04842           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l04843"></a>04843           <span class="keywordflow">break</span>;
<a name="l04844"></a>04844         }
<a name="l04845"></a>04845         <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>: {
<a name="l04846"></a>04846           $this-&gt;SetY($this-&gt;img_rb_y);
<a name="l04847"></a>04847           <span class="keywordflow">break</span>;
<a name="l04848"></a>04848         }
<a name="l04849"></a>04849         <span class="keywordflow">default</span>:{
<a name="l04850"></a>04850           <span class="keywordflow">break</span>;
<a name="l04851"></a>04851         }
<a name="l04852"></a>04852       }
<a name="l04853"></a>04853       $this-&gt;endlinex = $this-&gt;img_rb_x;
<a name="l04854"></a>04854       <span class="keywordflow">return</span> $info[<span class="charliteral">&#39;i&#39;</span>];
<a name="l04855"></a>04855     }
<a name="l04856"></a>04856     
<a name="l04862"></a>04862     <span class="keyword">public</span> function set_mqr($mqr) {
<a name="l04863"></a>04863       <span class="keywordflow">if</span>(!defined(<span class="stringliteral">&#39;PHP_VERSION_ID&#39;</span>)) {
<a name="l04864"></a>04864         $version = PHP_VERSION;
<a name="l04865"></a>04865         define(<span class="stringliteral">&#39;PHP_VERSION_ID&#39;</span>, (($version{0} * 10000) + ($version{2} * 100) + $version{4}));
<a name="l04866"></a>04866       }
<a name="l04867"></a>04867       <span class="keywordflow">if</span> (PHP_VERSION_ID &lt; 50300) {
<a name="l04868"></a>04868         @set_magic_quotes_runtime($mqr);
<a name="l04869"></a>04869       }
<a name="l04870"></a>04870     }
<a name="l04871"></a>04871     
<a name="l04877"></a>04877     <span class="keyword">public</span> function get_mqr() {
<a name="l04878"></a>04878       <span class="keywordflow">if</span>(!defined(<span class="stringliteral">&#39;PHP_VERSION_ID&#39;</span>)) {
<a name="l04879"></a>04879         $version = PHP_VERSION;
<a name="l04880"></a>04880         define(<span class="stringliteral">&#39;PHP_VERSION_ID&#39;</span>, (($version{0} * 10000) + ($version{2} * 100) + $version{4}));
<a name="l04881"></a>04881       }
<a name="l04882"></a>04882       <span class="keywordflow">if</span> (PHP_VERSION_ID &lt; 50300) {
<a name="l04883"></a>04883         <span class="keywordflow">return</span> @get_magic_quotes_runtime();
<a name="l04884"></a>04884       }
<a name="l04885"></a>04885       <span class="keywordflow">return</span> 0;
<a name="l04886"></a>04886     }
<a name="l04887"></a>04887             
<a name="l04896"></a>04896     <span class="keyword">protected</span> function _toJPEG($image) {
<a name="l04897"></a>04897       $tempname = tempnam(K_PATH_CACHE, <span class="stringliteral">&#39;jpg_&#39;</span>);
<a name="l04898"></a>04898       imagejpeg($image, $tempname, $this-&gt;jpeg_quality);
<a name="l04899"></a>04899       imagedestroy($image);
<a name="l04900"></a>04900       $retvars = $this-&gt;_parsejpeg($tempname);
<a name="l04901"></a>04901       <span class="comment">// tidy up by removing temporary image</span>
<a name="l04902"></a>04902       unlink($tempname);
<a name="l04903"></a>04903       <span class="keywordflow">return</span> $retvars;
<a name="l04904"></a>04904     }
<a name="l04905"></a>04905     
<a name="l04912"></a>04912     <span class="keyword">protected</span> function _parsejpeg($file) {
<a name="l04913"></a>04913       $a = getimagesize($file);
<a name="l04914"></a>04914       <span class="keywordflow">if</span> (empty($a)) {
<a name="l04915"></a>04915         $this-&gt;Error(<span class="stringliteral">&#39;Missing or incorrect image file: &#39;</span>.$file);
<a name="l04916"></a>04916       }
<a name="l04917"></a>04917       <span class="keywordflow">if</span> ($a[2] != 2) {
<a name="l04918"></a>04918         $this-&gt;Error(<span class="stringliteral">&#39;Not a JPEG file: &#39;</span>.$file);
<a name="l04919"></a>04919       }
<a name="l04920"></a>04920       <span class="keywordflow">if</span> ((!isset($a[<span class="stringliteral">&#39;channels&#39;</span>])) OR ($a[<span class="stringliteral">&#39;channels&#39;</span>] == 3)) {
<a name="l04921"></a>04921         $colspace = <span class="stringliteral">&#39;DeviceRGB&#39;</span>;
<a name="l04922"></a>04922       } elseif ($a[<span class="stringliteral">&#39;channels&#39;</span>] == 4) {
<a name="l04923"></a>04923         $colspace = <span class="stringliteral">&#39;DeviceCMYK&#39;</span>;
<a name="l04924"></a>04924       } <span class="keywordflow">else</span> {
<a name="l04925"></a>04925         $colspace = <span class="stringliteral">&#39;DeviceGray&#39;</span>;
<a name="l04926"></a>04926       }
<a name="l04927"></a>04927       $bpc = isset($a[<span class="stringliteral">&#39;bits&#39;</span>]) ? $a[<span class="stringliteral">&#39;bits&#39;</span>] : 8;
<a name="l04928"></a>04928       $data = file_get_contents($file);
<a name="l04929"></a>04929       <span class="keywordflow">return</span> array(<span class="charliteral">&#39;w&#39;</span> =&gt; $a[0], <span class="charliteral">&#39;h&#39;</span> =&gt; $a[1], <span class="stringliteral">&#39;cs&#39;</span> =&gt; $colspace, <span class="stringliteral">&#39;bpc&#39;</span> =&gt; $bpc, <span class="charliteral">&#39;f&#39;</span> =&gt; <span class="stringliteral">&#39;DCTDecode&#39;</span>, <span class="stringliteral">&#39;data&#39;</span> =&gt; $data);
<a name="l04930"></a>04930     }
<a name="l04931"></a>04931 
<a name="l04938"></a>04938     <span class="keyword">protected</span> function _parsepng($file) {
<a name="l04939"></a>04939       $f = fopen($file, <span class="stringliteral">&#39;rb&#39;</span>);
<a name="l04940"></a>04940       <span class="keywordflow">if</span> ($f === <span class="keyword">false</span>) {
<a name="l04941"></a>04941         $this-&gt;Error(<span class="stringliteral">&#39;Can\&#39;t open image file: &#39;</span>.$file);
<a name="l04942"></a>04942       }
<a name="l04943"></a>04943       <span class="comment">//Check signature</span>
<a name="l04944"></a>04944       <span class="keywordflow">if</span> (fread($f, 8) != chr(137).<span class="stringliteral">&#39;PNG&#39;</span>.chr(13).chr(10).chr(26).chr(10)) {
<a name="l04945"></a>04945         $this-&gt;Error(<span class="stringliteral">&#39;Not a PNG file: &#39;</span>.$file);
<a name="l04946"></a>04946       }
<a name="l04947"></a>04947       <span class="comment">//Read header chunk</span>
<a name="l04948"></a>04948       fread($f, 4);
<a name="l04949"></a>04949       <span class="keywordflow">if</span> (fread($f, 4) != <span class="stringliteral">&#39;IHDR&#39;</span>) {
<a name="l04950"></a>04950         $this-&gt;Error(<span class="stringliteral">&#39;Incorrect PNG file: &#39;</span>.$file);
<a name="l04951"></a>04951       }
<a name="l04952"></a>04952       $w = $this-&gt;_freadint($f);
<a name="l04953"></a>04953       $h = $this-&gt;_freadint($f);
<a name="l04954"></a>04954       $bpc = ord(fread($f, 1));
<a name="l04955"></a>04955       <span class="keywordflow">if</span> ($bpc &gt; 8) {
<a name="l04956"></a>04956         <span class="comment">//$this-&gt;Error(&#39;16-bit depth not supported: &#39;.$file);</span>
<a name="l04957"></a>04957         fclose($f);
<a name="l04958"></a>04958         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04959"></a>04959       }
<a name="l04960"></a>04960       $ct = ord(fread($f, 1));
<a name="l04961"></a>04961       <span class="keywordflow">if</span> ($ct == 0) {
<a name="l04962"></a>04962         $colspace = <span class="stringliteral">&#39;DeviceGray&#39;</span>;
<a name="l04963"></a>04963       } elseif ($ct == 2) {
<a name="l04964"></a>04964         $colspace = <span class="stringliteral">&#39;DeviceRGB&#39;</span>;
<a name="l04965"></a>04965       } elseif ($ct == 3) {
<a name="l04966"></a>04966         $colspace = <span class="stringliteral">&#39;Indexed&#39;</span>;
<a name="l04967"></a>04967       } <span class="keywordflow">else</span> {
<a name="l04968"></a>04968         <span class="comment">// alpha channel</span>
<a name="l04969"></a>04969         fclose($f);
<a name="l04970"></a>04970         <span class="keywordflow">return</span> <span class="stringliteral">&#39;pngalpha&#39;</span>;
<a name="l04971"></a>04971       }
<a name="l04972"></a>04972       <span class="keywordflow">if</span> (ord(fread($f, 1)) != 0) {
<a name="l04973"></a>04973         <span class="comment">//$this-&gt;Error(&#39;Unknown compression method: &#39;.$file);</span>
<a name="l04974"></a>04974         fclose($f);
<a name="l04975"></a>04975         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04976"></a>04976       }
<a name="l04977"></a>04977       <span class="keywordflow">if</span> (ord(fread($f, 1)) != 0) {
<a name="l04978"></a>04978         <span class="comment">//$this-&gt;Error(&#39;Unknown filter method: &#39;.$file);</span>
<a name="l04979"></a>04979         fclose($f);
<a name="l04980"></a>04980         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04981"></a>04981       }
<a name="l04982"></a>04982       <span class="keywordflow">if</span> (ord(fread($f, 1)) != 0) {
<a name="l04983"></a>04983         <span class="comment">//$this-&gt;Error(&#39;Interlacing not supported: &#39;.$file);</span>
<a name="l04984"></a>04984         fclose($f);
<a name="l04985"></a>04985         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04986"></a>04986       }
<a name="l04987"></a>04987       fread($f, 4);
<a name="l04988"></a>04988       $parms = <span class="stringliteral">&#39;/DecodeParms &lt;&lt;/Predictor 15 /Colors &#39;</span>.($ct==2 ? 3 : 1).<span class="stringliteral">&#39; /BitsPerComponent &#39;</span>.$bpc.<span class="stringliteral">&#39; /Columns &#39;</span>.$w.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l04989"></a>04989       <span class="comment">//Scan chunks looking for palette, transparency and image data</span>
<a name="l04990"></a>04990       $pal = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04991"></a>04991       $trns = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04992"></a>04992       $data = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04993"></a>04993       <span class="keywordflow">do</span> {
<a name="l04994"></a>04994         $n = $this-&gt;_freadint($f);
<a name="l04995"></a>04995         $type = fread($f, 4);
<a name="l04996"></a>04996         <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;PLTE&#39;</span>) {
<a name="l04997"></a>04997           <span class="comment">//Read palette</span>
<a name="l04998"></a>04998           $pal = $this-&gt;rfread($f, $n);
<a name="l04999"></a>04999           fread($f, 4);
<a name="l05000"></a>05000         } elseif ($type == <span class="stringliteral">&#39;tRNS&#39;</span>) {
<a name="l05001"></a>05001           <span class="comment">//Read transparency info</span>
<a name="l05002"></a>05002           $t = $this-&gt;rfread($f, $n);
<a name="l05003"></a>05003           <span class="keywordflow">if</span> ($ct == 0) {
<a name="l05004"></a>05004             $trns = array(ord(substr($t, 1, 1)));
<a name="l05005"></a>05005           } elseif ($ct == 2) {
<a name="l05006"></a>05006             $trns = array(ord(substr($t, 1, 1)), ord(substr($t, 3, 1)), ord(substr($t, 5, 1)));
<a name="l05007"></a>05007           } <span class="keywordflow">else</span> {
<a name="l05008"></a>05008             $pos = strpos($t, chr(0));
<a name="l05009"></a>05009             <span class="keywordflow">if</span> ($pos !== <span class="keyword">false</span>) {
<a name="l05010"></a>05010               $trns = array($pos);
<a name="l05011"></a>05011             }
<a name="l05012"></a>05012           }
<a name="l05013"></a>05013           fread($f, 4);
<a name="l05014"></a>05014         } elseif ($type == <span class="stringliteral">&#39;IDAT&#39;</span>) {
<a name="l05015"></a>05015           <span class="comment">//Read image data block</span>
<a name="l05016"></a>05016           $data .= $this-&gt;rfread($f, $n);
<a name="l05017"></a>05017           fread($f, 4);
<a name="l05018"></a>05018         } elseif ($type == <span class="stringliteral">&#39;IEND&#39;</span>) {
<a name="l05019"></a>05019           <span class="keywordflow">break</span>;
<a name="l05020"></a>05020         } <span class="keywordflow">else</span> {
<a name="l05021"></a>05021           $this-&gt;rfread($f, $n + 4);
<a name="l05022"></a>05022         }
<a name="l05023"></a>05023       } <span class="keywordflow">while</span> ($n);
<a name="l05024"></a>05024       <span class="keywordflow">if</span> (($colspace == <span class="stringliteral">&#39;Indexed&#39;</span>) AND (empty($pal))) {
<a name="l05025"></a>05025         <span class="comment">//$this-&gt;Error(&#39;Missing palette in &#39;.$file);</span>
<a name="l05026"></a>05026         fclose($f);
<a name="l05027"></a>05027         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05028"></a>05028       }
<a name="l05029"></a>05029       fclose($f);
<a name="l05030"></a>05030       <span class="keywordflow">return</span> array(<span class="charliteral">&#39;w&#39;</span> =&gt; $w, <span class="charliteral">&#39;h&#39;</span> =&gt; $h, <span class="stringliteral">&#39;cs&#39;</span> =&gt; $colspace, <span class="stringliteral">&#39;bpc&#39;</span> =&gt; $bpc, <span class="charliteral">&#39;f&#39;</span> =&gt; <span class="stringliteral">&#39;FlateDecode&#39;</span>, <span class="stringliteral">&#39;parms&#39;</span> =&gt; $parms, <span class="stringliteral">&#39;pal&#39;</span> =&gt; $pal, <span class="stringliteral">&#39;trns&#39;</span> =&gt; $trns, <span class="stringliteral">&#39;data&#39;</span> =&gt; $data);
<a name="l05031"></a>05031     }
<a name="l05032"></a>05032 
<a name="l05043"></a>05043     <span class="keyword">protected</span> function rfread($handle, $length) {
<a name="l05044"></a>05044       $data = fread($handle, $length);
<a name="l05045"></a>05045       <span class="keywordflow">if</span> ($data === <span class="keyword">false</span>) {
<a name="l05046"></a>05046         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05047"></a>05047       }
<a name="l05048"></a>05048       $rest = $length - strlen($data);
<a name="l05049"></a>05049       <span class="keywordflow">if</span> ($rest &gt; 0) {
<a name="l05050"></a>05050         $data .= $this-&gt;rfread($handle, $rest);
<a name="l05051"></a>05051       }
<a name="l05052"></a>05052       <span class="keywordflow">return</span> $data;
<a name="l05053"></a>05053     }
<a name="l05054"></a>05054 
<a name="l05073"></a>05073     <span class="keyword">protected</span> function ImagePngAlpha($file, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $w=0, $h=0, $type=<span class="stringliteral">&#39;&#39;</span>, $link=<span class="stringliteral">&#39;&#39;</span>, $align=<span class="stringliteral">&#39;&#39;</span>, $resize=<span class="keyword">false</span>, $dpi=300, $palign=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l05074"></a>05074       <span class="comment">// get image size</span>
<a name="l05075"></a>05075       list($wpx, $hpx) = getimagesize($file);
<a name="l05076"></a>05076       <span class="comment">// generate images</span>
<a name="l05077"></a>05077       $img = imagecreatefrompng($file);
<a name="l05078"></a>05078       $imgalpha = imagecreate($wpx, $hpx);
<a name="l05079"></a>05079       <span class="comment">// generate gray scale pallete</span>
<a name="l05080"></a>05080       <span class="keywordflow">for</span> ($c = 0; $c &lt; 256; ++$c) {
<a name="l05081"></a>05081         ImageColorAllocate($imgalpha, $c, $c, $c);
<a name="l05082"></a>05082       }
<a name="l05083"></a>05083       <span class="comment">// extract alpha channel</span>
<a name="l05084"></a>05084       <span class="keywordflow">for</span> ($xpx = 0; $xpx &lt; $wpx; ++$xpx) {
<a name="l05085"></a>05085         <span class="keywordflow">for</span> ($ypx = 0; $ypx &lt; $hpx; ++$ypx) {
<a name="l05086"></a>05086           $colorindex = imagecolorat($img, $xpx, $ypx);
<a name="l05087"></a>05087           $col = imagecolorsforindex($img, $colorindex);
<a name="l05088"></a>05088           imagesetpixel($imgalpha, $xpx, $ypx, $this-&gt;getGDgamma((127 - $col[<span class="stringliteral">&#39;alpha&#39;</span>]) * 255 / 127));
<a name="l05089"></a>05089         }
<a name="l05090"></a>05090       }
<a name="l05091"></a>05091       <span class="comment">// create temp alpha file</span>
<a name="l05092"></a>05092       $tempfile_alpha = tempnam(K_PATH_CACHE, <span class="stringliteral">&#39;mska_&#39;</span>);
<a name="l05093"></a>05093       imagepng($imgalpha, $tempfile_alpha);
<a name="l05094"></a>05094       imagedestroy($imgalpha);
<a name="l05095"></a>05095       <span class="comment">// extract image without alpha channel</span>
<a name="l05096"></a>05096       $imgplain = imagecreatetruecolor($wpx, $hpx);
<a name="l05097"></a>05097       imagecopy($imgplain, $img, 0, 0, 0, 0, $wpx, $hpx);
<a name="l05098"></a>05098       <span class="comment">// create temp image file</span>
<a name="l05099"></a>05099       $tempfile_plain = tempnam(K_PATH_CACHE, <span class="stringliteral">&#39;mskp_&#39;</span>);
<a name="l05100"></a>05100       imagepng($imgplain, $tempfile_plain);
<a name="l05101"></a>05101       imagedestroy($imgplain);
<a name="l05102"></a>05102       <span class="comment">// embed mask image</span>
<a name="l05103"></a>05103       $imgmask = $this-&gt;Image($tempfile_alpha, $x, $y, $w, $h, <span class="stringliteral">&#39;PNG&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $resize, $dpi, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l05104"></a>05104       <span class="comment">// embed image, masked with previously embedded mask</span>
<a name="l05105"></a>05105       $this-&gt;Image($tempfile_plain, $x, $y, $w, $h, $type, $link, $align, $resize, $dpi, $palign, <span class="keyword">false</span>, $imgmask);
<a name="l05106"></a>05106       <span class="comment">// remove temp files</span>
<a name="l05107"></a>05107       unlink($tempfile_alpha);
<a name="l05108"></a>05108       unlink($tempfile_plain);
<a name="l05109"></a>05109     }
<a name="l05110"></a>05110 
<a name="l05117"></a>05117     <span class="keyword">protected</span> function getGDgamma($v) {
<a name="l05118"></a>05118       <span class="keywordflow">return</span> (pow(($v / 255), 2.2) * 255);
<a name="l05119"></a>05119     } 
<a name="l05120"></a>05120     
<a name="l05130"></a>05130     <span class="keyword">public</span> function Ln($h=<span class="stringliteral">&#39;&#39;</span>, $cell=<span class="keyword">false</span>) {
<a name="l05131"></a>05131       <span class="comment">//Line feed; default value is last cell height</span>
<a name="l05132"></a>05132       <span class="keywordflow">if</span> ($cell) {
<a name="l05133"></a>05133         $cellmargin = $this-&gt;cMargin;
<a name="l05134"></a>05134       } <span class="keywordflow">else</span> {
<a name="l05135"></a>05135         $cellmargin = 0;
<a name="l05136"></a>05136       }
<a name="l05137"></a>05137       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l05138"></a>05138         $this-&gt;x = $this-&gt;w - $this-&gt;rMargin - $cellmargin;
<a name="l05139"></a>05139       } <span class="keywordflow">else</span> {
<a name="l05140"></a>05140         $this-&gt;x = $this-&gt;lMargin + $cellmargin;
<a name="l05141"></a>05141       }
<a name="l05142"></a>05142       <span class="keywordflow">if</span> (is_string($h)) {
<a name="l05143"></a>05143         $this-&gt;y += $this-&gt;lasth;
<a name="l05144"></a>05144       } <span class="keywordflow">else</span> {
<a name="l05145"></a>05145         $this-&gt;y += $h;
<a name="l05146"></a>05146       }
<a name="l05147"></a>05147       $this-&gt;newline = <span class="keyword">true</span>;
<a name="l05148"></a>05148     }
<a name="l05149"></a>05149 
<a name="l05158"></a>05158     <span class="keyword">public</span> function GetX() {
<a name="l05159"></a>05159       <span class="comment">//Get x position</span>
<a name="l05160"></a>05160       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l05161"></a>05161         <span class="keywordflow">return</span> ($this-&gt;w - $this-&gt;x);
<a name="l05162"></a>05162       } <span class="keywordflow">else</span> {
<a name="l05163"></a>05163         <span class="keywordflow">return</span> $this-&gt;x;
<a name="l05164"></a>05164       }
<a name="l05165"></a>05165     }
<a name="l05166"></a>05166     
<a name="l05174"></a>05174     <span class="keyword">public</span> function GetAbsX() {
<a name="l05175"></a>05175       <span class="keywordflow">return</span> $this-&gt;x;
<a name="l05176"></a>05176     }
<a name="l05177"></a>05177     
<a name="l05185"></a>05185     <span class="keyword">public</span> function GetY() {
<a name="l05186"></a>05186       <span class="comment">//Get y position</span>
<a name="l05187"></a>05187       <span class="keywordflow">return</span> $this-&gt;y;
<a name="l05188"></a>05188     }
<a name="l05189"></a>05189     
<a name="l05198"></a>05198     <span class="keyword">public</span> function SetX($x) {
<a name="l05199"></a>05199       <span class="comment">//Set x position</span>
<a name="l05200"></a>05200       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l05201"></a>05201         <span class="keywordflow">if</span> ($x &gt;= 0) {
<a name="l05202"></a>05202           $this-&gt;x = $this-&gt;w - $x;
<a name="l05203"></a>05203         } <span class="keywordflow">else</span> {
<a name="l05204"></a>05204           $this-&gt;x = abs($x);
<a name="l05205"></a>05205         }
<a name="l05206"></a>05206       } <span class="keywordflow">else</span> {
<a name="l05207"></a>05207         <span class="keywordflow">if</span> ($x &gt;= 0) {
<a name="l05208"></a>05208           $this-&gt;x = $x;
<a name="l05209"></a>05209         } <span class="keywordflow">else</span> {
<a name="l05210"></a>05210           $this-&gt;x = $this-&gt;w + $x;
<a name="l05211"></a>05211         }
<a name="l05212"></a>05212       }
<a name="l05213"></a>05213       <span class="keywordflow">if</span> ($this-&gt;x &lt; 0) {
<a name="l05214"></a>05214         $this-&gt;x = 0;
<a name="l05215"></a>05215       }
<a name="l05216"></a>05216       <span class="keywordflow">if</span> ($this-&gt;x &gt; $this-&gt;w) {
<a name="l05217"></a>05217         $this-&gt;x = $this-&gt;w;
<a name="l05218"></a>05218       }
<a name="l05219"></a>05219     }
<a name="l05220"></a>05220     
<a name="l05230"></a>05230     <span class="keyword">public</span> function SetY($y, $resetx=<span class="keyword">true</span>) {
<a name="l05231"></a>05231       <span class="keywordflow">if</span> ($resetx) {
<a name="l05232"></a>05232         <span class="comment">//reset x</span>
<a name="l05233"></a>05233         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l05234"></a>05234           $this-&gt;x = $this-&gt;w - $this-&gt;rMargin;
<a name="l05235"></a>05235         } <span class="keywordflow">else</span> {
<a name="l05236"></a>05236           $this-&gt;x = $this-&gt;lMargin;
<a name="l05237"></a>05237         }
<a name="l05238"></a>05238       }
<a name="l05239"></a>05239       <span class="keywordflow">if</span> ($y &gt;= 0) {
<a name="l05240"></a>05240         $this-&gt;y = $y;
<a name="l05241"></a>05241       } <span class="keywordflow">else</span> {
<a name="l05242"></a>05242         $this-&gt;y = $this-&gt;h + $y;
<a name="l05243"></a>05243       }
<a name="l05244"></a>05244       <span class="keywordflow">if</span> ($this-&gt;y &lt; 0) {
<a name="l05245"></a>05245         $this-&gt;y = 0;
<a name="l05246"></a>05246       }
<a name="l05247"></a>05247       <span class="keywordflow">if</span> ($this-&gt;y &gt; $this-&gt;h) {
<a name="l05248"></a>05248         $this-&gt;y = $this-&gt;h;
<a name="l05249"></a>05249       }
<a name="l05250"></a>05250     }
<a name="l05251"></a>05251     
<a name="l05261"></a>05261     <span class="keyword">public</span> function SetXY($x, $y) {
<a name="l05262"></a>05262       <span class="comment">//Set x and y positions</span>
<a name="l05263"></a>05263       $this-&gt;SetY($y);
<a name="l05264"></a>05264       $this-&gt;SetX($x);
<a name="l05265"></a>05265     }
<a name="l05266"></a>05266 
<a name="l05277"></a>05277     <span class="keyword">public</span> function Output($name=<span class="stringliteral">&#39;doc.pdf&#39;</span>, $dest=<span class="charliteral">&#39;I&#39;</span>) {
<a name="l05278"></a>05278       <span class="comment">//Output PDF to some destination</span>
<a name="l05279"></a>05279       <span class="comment">//Finish document if necessary</span>
<a name="l05280"></a>05280       <span class="keywordflow">if</span> ($this-&gt;state &lt; 3) {
<a name="l05281"></a>05281         $this-&gt;Close();
<a name="l05282"></a>05282       }
<a name="l05283"></a>05283       <span class="comment">//Normalize parameters</span>
<a name="l05284"></a>05284       <span class="keywordflow">if</span> (is_bool($dest)) {
<a name="l05285"></a>05285         $dest = $dest ? <span class="charliteral">&#39;D&#39;</span> : <span class="charliteral">&#39;F&#39;</span>;
<a name="l05286"></a>05286       }
<a name="l05287"></a>05287       $dest = strtoupper($dest);
<a name="l05288"></a>05288       <span class="keywordflow">if</span> ($dest != <span class="charliteral">&#39;F&#39;</span>) {
<a name="l05289"></a>05289         $name = preg_replace(<span class="stringliteral">&#39;/[\s]+/&#39;</span>, <span class="charliteral">&#39;_&#39;</span>, $name);
<a name="l05290"></a>05290         $name = preg_replace(<span class="stringliteral">&#39;/[^a-zA-Z0-9_\.-]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $name);
<a name="l05291"></a>05291       }
<a name="l05292"></a>05292       <span class="keywordflow">if</span> ($this-&gt;sign) {
<a name="l05293"></a>05293         <span class="comment">// *** apply digital signature to the document ***</span>
<a name="l05294"></a>05294         <span class="comment">// get the document content</span>
<a name="l05295"></a>05295         $pdfdoc = $this-&gt;getBuffer();
<a name="l05296"></a>05296         <span class="comment">// remove last newline</span>
<a name="l05297"></a>05297         $pdfdoc = substr($pdfdoc, 0, -1);
<a name="l05298"></a>05298         <span class="comment">// Remove the original buffer</span>
<a name="l05299"></a>05299         <span class="keywordflow">if</span> (isset($this-&gt;diskcache) AND $this-&gt;diskcache) {
<a name="l05300"></a>05300           <span class="comment">// remove buffer file from cache</span>
<a name="l05301"></a>05301           unlink($this-&gt;buffer);
<a name="l05302"></a>05302         }
<a name="l05303"></a>05303         unset($this-&gt;buffer);
<a name="l05304"></a>05304         <span class="comment">// remove filler space</span>
<a name="l05305"></a>05305         $byterange_string_len = strlen($this-&gt;byterange_string);
<a name="l05306"></a>05306         <span class="comment">// define the ByteRange</span>
<a name="l05307"></a>05307         $byte_range = array();
<a name="l05308"></a>05308         $byte_range[0] = 0;
<a name="l05309"></a>05309         $byte_range[1] = strpos($pdfdoc, $this-&gt;byterange_string) + $byterange_string_len + 10;
<a name="l05310"></a>05310         $byte_range[2] = $byte_range[1] + $this-&gt;signature_max_lenght + 2;
<a name="l05311"></a>05311         $byte_range[3] = strlen($pdfdoc) - $byte_range[2];
<a name="l05312"></a>05312         $pdfdoc = substr($pdfdoc, 0, $byte_range[1]).substr($pdfdoc, $byte_range[2]);
<a name="l05313"></a>05313         <span class="comment">// replace the ByteRange</span>
<a name="l05314"></a>05314         $byterange = sprintf(<span class="stringliteral">&#39;/ByteRange[0 %u %u %u]&#39;</span>, $byte_range[1], $byte_range[2], $byte_range[3]);
<a name="l05315"></a>05315         $byterange .= str_repeat(<span class="charliteral">&#39; &#39;</span>, ($byterange_string_len - strlen($byterange)));
<a name="l05316"></a>05316         $pdfdoc = str_replace($this-&gt;byterange_string, $byterange, $pdfdoc);
<a name="l05317"></a>05317         <span class="comment">// write the document to a temporary folder</span>
<a name="l05318"></a>05318         $tempdoc = tempnam(K_PATH_CACHE, <span class="stringliteral">&#39;tmppdf_&#39;</span>);
<a name="l05319"></a>05319         $f = fopen($tempdoc, <span class="stringliteral">&#39;wb&#39;</span>);
<a name="l05320"></a>05320         <span class="keywordflow">if</span> (!$f) {
<a name="l05321"></a>05321           $this-&gt;Error(<span class="stringliteral">&#39;Unable to create temporary file: &#39;</span>.$tempdoc);
<a name="l05322"></a>05322         }
<a name="l05323"></a>05323         $pdfdoc_lenght = strlen($pdfdoc);
<a name="l05324"></a>05324         fwrite($f, $pdfdoc, $pdfdoc_lenght);
<a name="l05325"></a>05325         fclose($f);
<a name="l05326"></a>05326         <span class="comment">// get digital signature via openssl library</span>
<a name="l05327"></a>05327         $tempsign = tempnam(K_PATH_CACHE, <span class="stringliteral">&#39;tmpsig_&#39;</span>);
<a name="l05328"></a>05328         <span class="keywordflow">if</span> (empty($this-&gt;signature_data[<span class="stringliteral">&#39;extracerts&#39;</span>])) {
<a name="l05329"></a>05329           openssl_pkcs7_sign($tempdoc, $tempsign, $this-&gt;signature_data[<span class="stringliteral">&#39;signcert&#39;</span>], array($this-&gt;signature_data[<span class="stringliteral">&#39;privkey&#39;</span>], $this-&gt;signature_data[<span class="stringliteral">&#39;password&#39;</span>]), array(), PKCS7_BINARY | PKCS7_DETACHED);
<a name="l05330"></a>05330         } <span class="keywordflow">else</span> {
<a name="l05331"></a>05331           openssl_pkcs7_sign($tempdoc, $tempsign, $this-&gt;signature_data[<span class="stringliteral">&#39;signcert&#39;</span>], array($this-&gt;signature_data[<span class="stringliteral">&#39;privkey&#39;</span>], $this-&gt;signature_data[<span class="stringliteral">&#39;password&#39;</span>]), array(), PKCS7_BINARY | PKCS7_DETACHED, $this-&gt;signature_data[<span class="stringliteral">&#39;extracerts&#39;</span>]);
<a name="l05332"></a>05332         } 
<a name="l05333"></a>05333         unlink($tempdoc);
<a name="l05334"></a>05334         <span class="comment">// read signature</span>
<a name="l05335"></a>05335         $signature = file_get_contents($tempsign, <span class="keyword">false</span>, null, $pdfdoc_lenght);
<a name="l05336"></a>05336         unlink($tempsign);
<a name="l05337"></a>05337         <span class="comment">// extract signature</span>
<a name="l05338"></a>05338         $signature = substr($signature, (strpos($signature, <span class="stringliteral">&quot;%%EOF\n\n------&quot;</span>) + 13));
<a name="l05339"></a>05339         $tmparr = explode(<span class="stringliteral">&quot;\n\n&quot;</span>, $signature);
<a name="l05340"></a>05340         $signature = $tmparr[1];
<a name="l05341"></a>05341         unset($tmparr);
<a name="l05342"></a>05342         <span class="comment">// decode signature</span>
<a name="l05343"></a>05343         $signature = base64_decode(trim($signature));
<a name="l05344"></a>05344         <span class="comment">// convert signature to hex</span>
<a name="l05345"></a>05345         $signature = current(unpack(<span class="stringliteral">&#39;H*&#39;</span>, $signature));
<a name="l05346"></a>05346         $signature = str_pad($signature, $this-&gt;signature_max_lenght, <span class="charliteral">&#39;0&#39;</span>);
<a name="l05347"></a>05347         <span class="comment">// Add signature to the document</span>
<a name="l05348"></a>05348         $pdfdoc = substr($pdfdoc, 0, $byte_range[1]).<span class="charliteral">&#39;&lt;&#39;</span>.$signature.<span class="charliteral">&#39;&gt;&#39;</span>.substr($pdfdoc, ($byte_range[1]));
<a name="l05349"></a>05349         $this-&gt;diskcache = <span class="keyword">false</span>;
<a name="l05350"></a>05350         $this-&gt;buffer = &amp;$pdfdoc;
<a name="l05351"></a>05351         $this-&gt;bufferlen = strlen($pdfdoc);
<a name="l05352"></a>05352       }
<a name="l05353"></a>05353       <span class="keywordflow">switch</span>($dest) {
<a name="l05354"></a>05354         <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>: {
<a name="l05355"></a>05355           <span class="comment">// Send PDF to the standard output</span>
<a name="l05356"></a>05356           <span class="keywordflow">if</span> (ob_get_contents()) {
<a name="l05357"></a>05357             $this-&gt;Error(<span class="stringliteral">&#39;Some data has already been output, can\&#39;t send PDF file&#39;</span>);
<a name="l05358"></a>05358           }
<a name="l05359"></a>05359           <span class="keywordflow">if</span> (php_sapi_name() != <span class="stringliteral">&#39;cli&#39;</span>) {
<a name="l05360"></a>05360             <span class="comment">//We send to a browser</span>
<a name="l05361"></a>05361             header(<span class="stringliteral">&#39;Content-Type: application/pdf&#39;</span>);
<a name="l05362"></a>05362             <span class="keywordflow">if</span> (headers_sent()) {
<a name="l05363"></a>05363               $this-&gt;Error(<span class="stringliteral">&#39;Some data has already been output to browser, can\&#39;t send PDF file&#39;</span>);
<a name="l05364"></a>05364             }
<a name="l05365"></a>05365             header(<span class="stringliteral">&#39;Cache-Control: public, must-revalidate, max-age=0&#39;</span>); <span class="comment">// HTTP/1.1</span>
<a name="l05366"></a>05366             header(<span class="stringliteral">&#39;Pragma: public&#39;</span>);
<a name="l05367"></a>05367             header(<span class="stringliteral">&#39;Expires: Sat, 26 Jul 1997 05:00:00 GMT&#39;</span>); <span class="comment">// Date in the past</span>
<a name="l05368"></a>05368             header(<span class="stringliteral">&#39;Last-Modified: &#39;</span>.gmdate(<span class="stringliteral">&#39;D, d M Y H:i:s&#39;</span>).<span class="stringliteral">&#39; GMT&#39;</span>);  
<a name="l05369"></a>05369             header(<span class="stringliteral">&#39;Content-Length: &#39;</span>.$this-&gt;bufferlen);
<a name="l05370"></a>05370             header(<span class="stringliteral">&#39;Content-Disposition: inline; filename=&quot;&#39;</span>.basename($name).<span class="stringliteral">&#39;&quot;;&#39;</span>);
<a name="l05371"></a>05371           }
<a name="l05372"></a>05372           echo $this-&gt;getBuffer();
<a name="l05373"></a>05373           <span class="keywordflow">break</span>;
<a name="l05374"></a>05374         }
<a name="l05375"></a>05375         <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>: {
<a name="l05376"></a>05376           <span class="comment">// Download PDF as file</span>
<a name="l05377"></a>05377           <span class="keywordflow">if</span> (ob_get_contents()) {
<a name="l05378"></a>05378             $this-&gt;Error(<span class="stringliteral">&#39;Some data has already been output, can\&#39;t send PDF file&#39;</span>);
<a name="l05379"></a>05379           }
<a name="l05380"></a>05380           header(<span class="stringliteral">&#39;Content-Description: File Transfer&#39;</span>);
<a name="l05381"></a>05381           <span class="keywordflow">if</span> (headers_sent()) {
<a name="l05382"></a>05382             $this-&gt;Error(<span class="stringliteral">&#39;Some data has already been output to browser, can\&#39;t send PDF file&#39;</span>);
<a name="l05383"></a>05383           }
<a name="l05384"></a>05384           header(<span class="stringliteral">&#39;Cache-Control: public, must-revalidate, max-age=0&#39;</span>); <span class="comment">// HTTP/1.1</span>
<a name="l05385"></a>05385           header(<span class="stringliteral">&#39;Pragma: public&#39;</span>);
<a name="l05386"></a>05386           header(<span class="stringliteral">&#39;Expires: Sat, 26 Jul 1997 05:00:00 GMT&#39;</span>); <span class="comment">// Date in the past</span>
<a name="l05387"></a>05387           header(<span class="stringliteral">&#39;Last-Modified: &#39;</span>.gmdate(<span class="stringliteral">&#39;D, d M Y H:i:s&#39;</span>).<span class="stringliteral">&#39; GMT&#39;</span>);
<a name="l05388"></a>05388           <span class="comment">// force download dialog</span>
<a name="l05389"></a>05389           header(<span class="stringliteral">&#39;Content-Type: application/force-download&#39;</span>);
<a name="l05390"></a>05390           header(<span class="stringliteral">&#39;Content-Type: application/octet-stream&#39;</span>, <span class="keyword">false</span>);
<a name="l05391"></a>05391           header(<span class="stringliteral">&#39;Content-Type: application/download&#39;</span>, <span class="keyword">false</span>);
<a name="l05392"></a>05392           header(<span class="stringliteral">&#39;Content-Type: application/pdf&#39;</span>, <span class="keyword">false</span>);
<a name="l05393"></a>05393           <span class="comment">// use the Content-Disposition header to supply a recommended filename</span>
<a name="l05394"></a>05394           header(<span class="stringliteral">&#39;Content-Disposition: attachment; filename=&quot;&#39;</span>.basename($name).<span class="stringliteral">&#39;&quot;;&#39;</span>);
<a name="l05395"></a>05395           header(<span class="stringliteral">&#39;Content-Transfer-Encoding: binary&#39;</span>);
<a name="l05396"></a>05396           header(<span class="stringliteral">&#39;Content-Length: &#39;</span>.$this-&gt;bufferlen);
<a name="l05397"></a>05397           echo $this-&gt;getBuffer();
<a name="l05398"></a>05398           <span class="keywordflow">break</span>;
<a name="l05399"></a>05399         }
<a name="l05400"></a>05400         <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l05401"></a>05401           <span class="comment">// Save PDF to a local file</span>
<a name="l05402"></a>05402           <span class="keywordflow">if</span> ($this-&gt;diskcache) {
<a name="l05403"></a>05403             copy($this-&gt;buffer, $name);
<a name="l05404"></a>05404           } <span class="keywordflow">else</span> {
<a name="l05405"></a>05405             $f = fopen($name, <span class="stringliteral">&#39;wb&#39;</span>);
<a name="l05406"></a>05406             <span class="keywordflow">if</span> (!$f) {
<a name="l05407"></a>05407               $this-&gt;Error(<span class="stringliteral">&#39;Unable to create output file: &#39;</span>.$name);
<a name="l05408"></a>05408             }
<a name="l05409"></a>05409             fwrite($f, $this-&gt;getBuffer(), $this-&gt;bufferlen);
<a name="l05410"></a>05410             fclose($f);
<a name="l05411"></a>05411           }
<a name="l05412"></a>05412           <span class="keywordflow">break</span>;
<a name="l05413"></a>05413         }
<a name="l05414"></a>05414         <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>: {
<a name="l05415"></a>05415           <span class="comment">// Returns PDF as a string</span>
<a name="l05416"></a>05416           <span class="keywordflow">return</span> $this-&gt;getBuffer();
<a name="l05417"></a>05417         }
<a name="l05418"></a>05418         <span class="keywordflow">default</span>: {
<a name="l05419"></a>05419           $this-&gt;Error(<span class="stringliteral">&#39;Incorrect output destination: &#39;</span>.$dest);
<a name="l05420"></a>05420         }
<a name="l05421"></a>05421       }
<a name="l05422"></a>05422       <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l05423"></a>05423     }
<a name="l05424"></a>05424 
<a name="l05432"></a>05432     <span class="keyword">public</span> function _destroy($destroyall=<span class="keyword">false</span>, $preserve_objcopy=<span class="keyword">false</span>) {
<a name="l05433"></a>05433       <span class="keywordflow">if</span> ($destroyall AND isset($this-&gt;diskcache) AND $this-&gt;diskcache AND (!$preserve_objcopy) AND (!$this-&gt;empty_string($this-&gt;buffer))) {
<a name="l05434"></a>05434         <span class="comment">// remove buffer file from cache</span>
<a name="l05435"></a>05435         unlink($this-&gt;buffer);
<a name="l05436"></a>05436       }
<a name="l05437"></a>05437       <span class="keywordflow">foreach</span> (array_keys(get_object_vars($this)) as $val) {
<a name="l05438"></a>05438         <span class="keywordflow">if</span> ($destroyall OR (
<a name="l05439"></a>05439           ($val != <span class="stringliteral">&#39;internal_encoding&#39;</span>) 
<a name="l05440"></a>05440           AND ($val != <span class="stringliteral">&#39;state&#39;</span>) 
<a name="l05441"></a>05441           AND ($val != <span class="stringliteral">&#39;bufferlen&#39;</span>) 
<a name="l05442"></a>05442           AND ($val != <span class="stringliteral">&#39;buffer&#39;</span>) 
<a name="l05443"></a>05443           AND ($val != <span class="stringliteral">&#39;diskcache&#39;</span>)
<a name="l05444"></a>05444           AND ($val != <span class="stringliteral">&#39;sign&#39;</span>)
<a name="l05445"></a>05445           AND ($val != <span class="stringliteral">&#39;signature_data&#39;</span>)
<a name="l05446"></a>05446           AND ($val != <span class="stringliteral">&#39;signature_max_lenght&#39;</span>)
<a name="l05447"></a>05447           AND ($val != <span class="stringliteral">&#39;byterange_string&#39;</span>)
<a name="l05448"></a>05448           )) {
<a name="l05449"></a>05449           <span class="keywordflow">if</span> (!$preserve_objcopy OR ($val != <span class="stringliteral">&#39;objcopy&#39;</span>)) {
<a name="l05450"></a>05450             unset($this-&gt;$val);
<a name="l05451"></a>05451           }
<a name="l05452"></a>05452         }
<a name="l05453"></a>05453       }
<a name="l05454"></a>05454     }
<a name="l05455"></a>05455     
<a name="l05460"></a>05460     <span class="keyword">protected</span> function _dochecks() {
<a name="l05461"></a>05461       <span class="comment">//Check for locale-related bug</span>
<a name="l05462"></a>05462       <span class="keywordflow">if</span> (1.1 == 1) {
<a name="l05463"></a>05463         $this-&gt;Error(<span class="stringliteral">&#39;Don\&#39;t alter the locale before including class file&#39;</span>);
<a name="l05464"></a>05464       }
<a name="l05465"></a>05465       <span class="comment">//Check for decimal separator</span>
<a name="l05466"></a>05466       <span class="keywordflow">if</span> (sprintf(<span class="stringliteral">&#39;%.1F&#39;</span>, 1.0) != <span class="stringliteral">&#39;1.0&#39;</span>) {
<a name="l05467"></a>05467         setlocale(LC_NUMERIC, <span class="charliteral">&#39;C&#39;</span>);
<a name="l05468"></a>05468       }
<a name="l05469"></a>05469     }
<a name="l05470"></a>05470 
<a name="l05476"></a>05476     <span class="keyword">protected</span> function _getfontpath() {
<a name="l05477"></a>05477       <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;K_PATH_FONTS&#39;</span>) AND is_dir(dirname(__FILE__).<span class="stringliteral">&#39;/fonts&#39;</span>)) {
<a name="l05478"></a>05478         define(<span class="stringliteral">&#39;K_PATH_FONTS&#39;</span>, dirname(__FILE__).<span class="stringliteral">&#39;/fonts/&#39;</span>);
<a name="l05479"></a>05479       }
<a name="l05480"></a>05480       <span class="keywordflow">return</span> defined(<span class="stringliteral">&#39;K_PATH_FONTS&#39;</span>) ? K_PATH_FONTS : <span class="stringliteral">&#39;&#39;</span>;
<a name="l05481"></a>05481     }
<a name="l05482"></a>05482     
<a name="l05487"></a>05487     <span class="keyword">protected</span> function _putpages() {
<a name="l05488"></a>05488       $nb = $this-&gt;numpages;
<a name="l05489"></a>05489       <span class="keywordflow">if</span> (!empty($this-&gt;AliasNbPages)) {
<a name="l05490"></a>05490         $nbs = $this-&gt;formatPageNumber($nb);
<a name="l05491"></a>05491         $nbu = $this-&gt;UTF8ToUTF16BE($nbs, <span class="keyword">false</span>); <span class="comment">// replacement for unicode font</span>
<a name="l05492"></a>05492         $alias_a = $this-&gt;_escape($this-&gt;AliasNbPages);
<a name="l05493"></a>05493         $alias_au = $this-&gt;_escape(<span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNbPages.<span class="charliteral">&#39;}&#39;</span>);
<a name="l05494"></a>05494         <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05495"></a>05495           $alias_b = $this-&gt;_escape($this-&gt;UTF8ToLatin1($this-&gt;AliasNbPages));
<a name="l05496"></a>05496           $alias_bu = $this-&gt;_escape($this-&gt;UTF8ToLatin1(<span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNbPages.<span class="charliteral">&#39;}&#39;</span>));
<a name="l05497"></a>05497           $alias_c = $this-&gt;_escape($this-&gt;utf8StrRev($this-&gt;AliasNbPages, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05498"></a>05498           $alias_cu = $this-&gt;_escape($this-&gt;utf8StrRev(<span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNbPages.<span class="charliteral">&#39;}&#39;</span>, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05499"></a>05499         }
<a name="l05500"></a>05500       }
<a name="l05501"></a>05501       <span class="keywordflow">if</span> (!empty($this-&gt;AliasNumPage)) {
<a name="l05502"></a>05502         $alias_pa = $this-&gt;_escape($this-&gt;AliasNumPage);
<a name="l05503"></a>05503         $alias_pau = $this-&gt;_escape(<span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNumPage.<span class="charliteral">&#39;}&#39;</span>);
<a name="l05504"></a>05504         <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05505"></a>05505           $alias_pb = $this-&gt;_escape($this-&gt;UTF8ToLatin1($this-&gt;AliasNumPage));
<a name="l05506"></a>05506           $alias_pbu = $this-&gt;_escape($this-&gt;UTF8ToLatin1(<span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNumPage.<span class="charliteral">&#39;}&#39;</span>));
<a name="l05507"></a>05507           $alias_pc = $this-&gt;_escape($this-&gt;utf8StrRev($this-&gt;AliasNumPage, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05508"></a>05508           $alias_pcu = $this-&gt;_escape($this-&gt;utf8StrRev(<span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNumPage.<span class="charliteral">&#39;}&#39;</span>, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05509"></a>05509         }
<a name="l05510"></a>05510       }
<a name="l05511"></a>05511       $pagegroupnum = 0;
<a name="l05512"></a>05512       $filter = ($this-&gt;compress) ? <span class="stringliteral">&#39;/Filter /FlateDecode &#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l05513"></a>05513       <span class="keywordflow">for</span> ($n=1; $n &lt;= $nb; ++$n) {
<a name="l05514"></a>05514         $temppage = $this-&gt;getPageBuffer($n);
<a name="l05515"></a>05515         <span class="keywordflow">if</span> (!empty($this-&gt;pagegroups)) {
<a name="l05516"></a>05516           <span class="keywordflow">if</span>(isset($this-&gt;newpagegroup[$n])) {
<a name="l05517"></a>05517             $pagegroupnum = 0;
<a name="l05518"></a>05518           }
<a name="l05519"></a>05519           ++$pagegroupnum;
<a name="l05520"></a>05520           <span class="keywordflow">foreach</span> ($this-&gt;pagegroups as $k =&gt; $v) {
<a name="l05521"></a>05521             <span class="comment">// replace total pages group numbers</span>
<a name="l05522"></a>05522             $vs = $this-&gt;formatPageNumber($v);
<a name="l05523"></a>05523             $vu = $this-&gt;UTF8ToUTF16BE($vs, <span class="keyword">false</span>);
<a name="l05524"></a>05524             $alias_ga = $this-&gt;_escape($k);
<a name="l05525"></a>05525             $alias_gau = $this-&gt;_escape(<span class="charliteral">&#39;{&#39;</span>.$k.<span class="charliteral">&#39;}&#39;</span>);
<a name="l05526"></a>05526             <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05527"></a>05527               $alias_gb = $this-&gt;_escape($this-&gt;UTF8ToLatin1($k));
<a name="l05528"></a>05528               $alias_gbu = $this-&gt;_escape($this-&gt;UTF8ToLatin1(<span class="charliteral">&#39;{&#39;</span>.$k.<span class="charliteral">&#39;}&#39;</span>));
<a name="l05529"></a>05529               $alias_gc = $this-&gt;_escape($this-&gt;utf8StrRev($k, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05530"></a>05530               $alias_gcu = $this-&gt;_escape($this-&gt;utf8StrRev(<span class="charliteral">&#39;{&#39;</span>.$k.<span class="charliteral">&#39;}&#39;</span>, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05531"></a>05531             }
<a name="l05532"></a>05532             $temppage = str_replace($alias_gau, $vu, $temppage);
<a name="l05533"></a>05533             <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05534"></a>05534               $temppage = str_replace($alias_gbu, $vu, $temppage);
<a name="l05535"></a>05535               $temppage = str_replace($alias_gcu, $vu, $temppage);
<a name="l05536"></a>05536               $temppage = str_replace($alias_gb, $vs, $temppage);
<a name="l05537"></a>05537               $temppage = str_replace($alias_gc, $vs, $temppage);
<a name="l05538"></a>05538             }
<a name="l05539"></a>05539             $temppage = str_replace($alias_ga, $vs, $temppage);
<a name="l05540"></a>05540             <span class="comment">// replace page group numbers</span>
<a name="l05541"></a>05541             $pvs = $this-&gt;formatPageNumber($pagegroupnum);
<a name="l05542"></a>05542             $pvu = $this-&gt;UTF8ToUTF16BE($pvs, <span class="keyword">false</span>);
<a name="l05543"></a>05543             $pk = str_replace(<span class="stringliteral">&#39;{nb&#39;</span>, <span class="stringliteral">&#39;{pnb&#39;</span>, $k);
<a name="l05544"></a>05544             $alias_pga = $this-&gt;_escape($pk);
<a name="l05545"></a>05545             $alias_pgau = $this-&gt;_escape(<span class="charliteral">&#39;{&#39;</span>.$pk.<span class="charliteral">&#39;}&#39;</span>);
<a name="l05546"></a>05546             <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05547"></a>05547               $alias_pgb = $this-&gt;_escape($this-&gt;UTF8ToLatin1($pk));
<a name="l05548"></a>05548               $alias_pgbu = $this-&gt;_escape($this-&gt;UTF8ToLatin1(<span class="charliteral">&#39;{&#39;</span>.$pk.<span class="charliteral">&#39;}&#39;</span>));
<a name="l05549"></a>05549               $alias_pgc = $this-&gt;_escape($this-&gt;utf8StrRev($pk, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05550"></a>05550               $alias_pgcu = $this-&gt;_escape($this-&gt;utf8StrRev(<span class="charliteral">&#39;{&#39;</span>.$pk.<span class="charliteral">&#39;}&#39;</span>, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l05551"></a>05551             }
<a name="l05552"></a>05552             $temppage = str_replace($alias_pgau, $pvu, $temppage);
<a name="l05553"></a>05553             <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05554"></a>05554               $temppage = str_replace($alias_pgbu, $pvu, $temppage);
<a name="l05555"></a>05555               $temppage = str_replace($alias_pgcu, $pvu, $temppage);
<a name="l05556"></a>05556               $temppage = str_replace($alias_pgb, $pvs, $temppage);
<a name="l05557"></a>05557               $temppage = str_replace($alias_pgc, $pvs, $temppage);
<a name="l05558"></a>05558             }
<a name="l05559"></a>05559             $temppage = str_replace($alias_pga, $pvs, $temppage);
<a name="l05560"></a>05560           }
<a name="l05561"></a>05561         }
<a name="l05562"></a>05562         <span class="keywordflow">if</span> (!empty($this-&gt;AliasNbPages)) {
<a name="l05563"></a>05563           <span class="comment">// replace total pages number</span>
<a name="l05564"></a>05564           $temppage = str_replace($alias_au, $nbu, $temppage);
<a name="l05565"></a>05565           <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05566"></a>05566             $temppage = str_replace($alias_bu, $nbu, $temppage);
<a name="l05567"></a>05567             $temppage = str_replace($alias_cu, $nbu, $temppage);
<a name="l05568"></a>05568             $temppage = str_replace($alias_b, $nbs, $temppage);
<a name="l05569"></a>05569             $temppage = str_replace($alias_c, $nbs, $temppage);
<a name="l05570"></a>05570           }
<a name="l05571"></a>05571           $temppage = str_replace($alias_a, $nbs, $temppage);
<a name="l05572"></a>05572         }
<a name="l05573"></a>05573         <span class="keywordflow">if</span> (!empty($this-&gt;AliasNumPage)) {
<a name="l05574"></a>05574           <span class="comment">// replace page number</span>
<a name="l05575"></a>05575           $pnbs = $this-&gt;formatPageNumber($n);
<a name="l05576"></a>05576           $pnbu = $this-&gt;UTF8ToUTF16BE($pnbs, <span class="keyword">false</span>); <span class="comment">// replacement for unicode font</span>
<a name="l05577"></a>05577           $temppage = str_replace($alias_pau, $pnbu, $temppage);
<a name="l05578"></a>05578           <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l05579"></a>05579             $temppage = str_replace($alias_pbu, $pnbu, $temppage);
<a name="l05580"></a>05580             $temppage = str_replace($alias_pcu, $pnbu, $temppage);
<a name="l05581"></a>05581             $temppage = str_replace($alias_pb, $pnbs, $temppage);
<a name="l05582"></a>05582             $temppage = str_replace($alias_pc, $pnbs, $temppage);
<a name="l05583"></a>05583           }
<a name="l05584"></a>05584           $temppage = str_replace($alias_pa, $pnbs, $temppage);
<a name="l05585"></a>05585         }
<a name="l05586"></a>05586         $temppage = str_replace($this-&gt;epsmarker, <span class="stringliteral">&#39;&#39;</span>, $temppage);
<a name="l05587"></a>05587         <span class="comment">//Page</span>
<a name="l05588"></a>05588         $this-&gt;page_obj_id[$n] = $this-&gt;_newobj();
<a name="l05589"></a>05589         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Page&#39;</span>);
<a name="l05590"></a>05590         $this-&gt;_out(<span class="stringliteral">&#39;/Parent 1 0 R&#39;</span>);
<a name="l05591"></a>05591         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/MediaBox [0 0 %.2F %.2F]&#39;</span>, $this-&gt;pagedim[$n][<span class="charliteral">&#39;w&#39;</span>], $this-&gt;pagedim[$n][<span class="charliteral">&#39;h&#39;</span>]));
<a name="l05592"></a>05592         $this-&gt;_out(<span class="stringliteral">&#39;/Resources 2 0 R&#39;</span>);
<a name="l05593"></a>05593         $this-&gt;_putannotsrefs($n);
<a name="l05594"></a>05594         $this-&gt;_out(<span class="stringliteral">&#39;/Contents &#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l05595"></a>05595         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05596"></a>05596         <span class="comment">//Page content</span>
<a name="l05597"></a>05597         $p = ($this-&gt;compress) ? gzcompress($temppage) : $temppage;
<a name="l05598"></a>05598         $this-&gt;_newobj();
<a name="l05599"></a>05599         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>.$filter.<span class="stringliteral">&#39;/Length &#39;</span>.strlen($p).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l05600"></a>05600         $this-&gt;_putstream($p);
<a name="l05601"></a>05601         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05602"></a>05602         <span class="keywordflow">if</span> ($this-&gt;diskcache) {
<a name="l05603"></a>05603           <span class="comment">// remove temporary files</span>
<a name="l05604"></a>05604           unlink($this-&gt;pages[$n]);
<a name="l05605"></a>05605         }
<a name="l05606"></a>05606       }
<a name="l05607"></a>05607       <span class="comment">//Pages root</span>
<a name="l05608"></a>05608       $this-&gt;offsets[1] = $this-&gt;bufferlen;
<a name="l05609"></a>05609       $this-&gt;_out(<span class="stringliteral">&#39;1 0 obj&#39;</span>);
<a name="l05610"></a>05610       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Pages&#39;</span>);
<a name="l05611"></a>05611       $this-&gt;_out(<span class="stringliteral">&#39;/Kids [&#39;</span>);
<a name="l05612"></a>05612       <span class="keywordflow">foreach</span>($this-&gt;page_obj_id as $page_obj) {
<a name="l05613"></a>05613         $this-&gt;_out($page_obj.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l05614"></a>05614       }
<a name="l05615"></a>05615       $this-&gt;_out(<span class="charliteral">&#39;]&#39;</span>);
<a name="l05616"></a>05616       $this-&gt;_out(<span class="stringliteral">&#39;/Count &#39;</span>.$nb);
<a name="l05617"></a>05617       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l05618"></a>05618       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05619"></a>05619     }
<a name="l05620"></a>05620 
<a name="l05628"></a>05628     <span class="keyword">protected</span> function _putannotsrefs($n) {
<a name="l05629"></a>05629       <span class="keywordflow">if</span> (!(isset($this-&gt;PageAnnots[$n]) OR ($this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>])))) {
<a name="l05630"></a>05630         <span class="keywordflow">return</span>;
<a name="l05631"></a>05631       }
<a name="l05632"></a>05632       $this-&gt;_out(<span class="stringliteral">&#39;/Annots [&#39;</span>);
<a name="l05633"></a>05633       <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$n])) {
<a name="l05634"></a>05634         $num_annots = count($this-&gt;PageAnnots[$n]);
<a name="l05635"></a>05635         <span class="keywordflow">for</span> ($i = 0; $i &lt; $num_annots; ++$i) {
<a name="l05636"></a>05636           ++$this-&gt;curr_annot_obj_id;
<a name="l05637"></a>05637           <span class="keywordflow">if</span> (!in_array($this-&gt;curr_annot_obj_id, $this-&gt;radio_groups)) {
<a name="l05638"></a>05638             $this-&gt;_out($this-&gt;curr_annot_obj_id.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l05639"></a>05639           } <span class="keywordflow">else</span> {
<a name="l05640"></a>05640             ++$num_annots;
<a name="l05641"></a>05641           }
<a name="l05642"></a>05642         }
<a name="l05643"></a>05643       }
<a name="l05644"></a>05644       <span class="keywordflow">if</span> (($n==1) AND $this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>])) {
<a name="l05645"></a>05645         <span class="comment">// set reference for signature object</span>
<a name="l05646"></a>05646         $this-&gt;_out($this-&gt;sig_annot_ref);
<a name="l05647"></a>05647       }
<a name="l05648"></a>05648       $this-&gt;_out(<span class="charliteral">&#39;]&#39;</span>);
<a name="l05649"></a>05649     }
<a name="l05650"></a>05650 
<a name="l05659"></a>05659     <span class="keyword">protected</span> function _putannotsobjs() {
<a name="l05660"></a>05660       <span class="comment">// reset object counter</span>
<a name="l05661"></a>05661       $this-&gt;annot_obj_id = $this-&gt;annots_start_obj_id;
<a name="l05662"></a>05662       <span class="keywordflow">for</span> ($n=1; $n &lt;= $this-&gt;numpages; ++$n) {
<a name="l05663"></a>05663         <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$n])) {
<a name="l05664"></a>05664           <span class="comment">// set page annotations</span>
<a name="l05665"></a>05665           <span class="keywordflow">foreach</span> ($this-&gt;PageAnnots[$n] as $key =&gt; $pl) {
<a name="l05666"></a>05666             <span class="comment">// create annotation object for grouping radiobuttons</span>
<a name="l05667"></a>05667             <span class="keywordflow">if</span> (isset($this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]]) AND is_array($this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]])) {
<a name="l05668"></a>05668               $annots = <span class="stringliteral">&#39;&lt;&lt;&#39;</span>;
<a name="l05669"></a>05669               $annots .= <span class="stringliteral">&#39; /Type /Annot&#39;</span>;
<a name="l05670"></a>05670               $annots .= <span class="stringliteral">&#39; /Subtype /Widget&#39;</span>;
<a name="l05671"></a>05671               $annots .= <span class="stringliteral">&#39; /T &#39;</span>.$this-&gt;_datastring($pl[<span class="stringliteral">&#39;txt&#39;</span>]);
<a name="l05672"></a>05672               $annots .= <span class="stringliteral">&#39; /FT /Btn&#39;</span>;
<a name="l05673"></a>05673               $annots .= <span class="stringliteral">&#39; /Ff 49152&#39;</span>;
<a name="l05674"></a>05674               $annots .= <span class="stringliteral">&#39; /Kids [&#39;</span>;
<a name="l05675"></a>05675               <span class="keywordflow">foreach</span> ($this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]] as $data) {
<a name="l05676"></a>05676                 $annots .= <span class="charliteral">&#39; &#39;</span>.$data[<span class="stringliteral">&#39;kid&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l05677"></a>05677                 <span class="keywordflow">if</span> ($data[<span class="stringliteral">&#39;def&#39;</span>] !== <span class="stringliteral">&#39;Off&#39;</span>) {
<a name="l05678"></a>05678                   $defval = $data[<span class="stringliteral">&#39;def&#39;</span>];
<a name="l05679"></a>05679                 }
<a name="l05680"></a>05680               }
<a name="l05681"></a>05681               $annots .= <span class="stringliteral">&#39; ]&#39;</span>;
<a name="l05682"></a>05682               <span class="keywordflow">if</span> (isset($defval)) {
<a name="l05683"></a>05683                 $annots .= <span class="stringliteral">&#39; /V /&#39;</span>.$defval;
<a name="l05684"></a>05684               }
<a name="l05685"></a>05685               $annots .= <span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l05686"></a>05686               ++$this-&gt;annot_obj_id;
<a name="l05687"></a>05687               $this-&gt;offsets[$this-&gt;annot_obj_id] = $this-&gt;bufferlen;
<a name="l05688"></a>05688               $this-&gt;_out($this-&gt;annot_obj_id.<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l05689"></a>05689               $this-&gt;_out($annots);
<a name="l05690"></a>05690               $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l05691"></a>05691               $this-&gt;form_obj_id[] = $this-&gt;annot_obj_id;
<a name="l05692"></a>05692               <span class="comment">// store object id to be used on Parent entry of Kids</span>
<a name="l05693"></a>05693               $this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]] = $this-&gt;annot_obj_id;
<a name="l05694"></a>05694             }
<a name="l05695"></a>05695             $formfield = <span class="keyword">false</span>;
<a name="l05696"></a>05696             $pl[<span class="stringliteral">&#39;opt&#39;</span>] = array_change_key_case($pl[<span class="stringliteral">&#39;opt&#39;</span>], CASE_LOWER);
<a name="l05697"></a>05697             $a = $pl[<span class="charliteral">&#39;x&#39;</span>] * $this-&gt;k;
<a name="l05698"></a>05698             $b = $this-&gt;pagedim[$n][<span class="charliteral">&#39;h&#39;</span>] - (($pl[<span class="charliteral">&#39;y&#39;</span>] + $pl[<span class="charliteral">&#39;h&#39;</span>])  * $this-&gt;k);
<a name="l05699"></a>05699             $c = $pl[<span class="charliteral">&#39;w&#39;</span>] * $this-&gt;k;
<a name="l05700"></a>05700             $d = $pl[<span class="charliteral">&#39;h&#39;</span>] * $this-&gt;k;
<a name="l05701"></a>05701             $rect = sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F&#39;</span>, $a, $b, $a+$c, $b+$d);
<a name="l05702"></a>05702             <span class="comment">// create new annotation object</span>
<a name="l05703"></a>05703             $annots = <span class="stringliteral">&#39;&lt;&lt;/Type /Annot&#39;</span>;
<a name="l05704"></a>05704             $annots .= <span class="stringliteral">&#39; /Subtype /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;subtype&#39;</span>];
<a name="l05705"></a>05705             $annots .= <span class="stringliteral">&#39; /Rect [&#39;</span>.$rect.<span class="charliteral">&#39;]&#39;</span>;
<a name="l05706"></a>05706             $ft = array(<span class="stringliteral">&#39;Btn&#39;</span>, <span class="stringliteral">&#39;Tx&#39;</span>, <span class="stringliteral">&#39;Ch&#39;</span>, <span class="stringliteral">&#39;Sig&#39;</span>);
<a name="l05707"></a>05707             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ft&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ft&#39;</span>], $ft)) {
<a name="l05708"></a>05708               $annots .= <span class="stringliteral">&#39; /FT /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ft&#39;</span>];
<a name="l05709"></a>05709               $formfield = <span class="keyword">true</span>;
<a name="l05710"></a>05710             }
<a name="l05711"></a>05711             $annots .= <span class="stringliteral">&#39; /Contents &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;txt&#39;</span>]);
<a name="l05712"></a>05712             $annots .= <span class="stringliteral">&#39; /P &#39;</span>.$this-&gt;page_obj_id[$n].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l05713"></a>05713             $annots .= <span class="stringliteral">&#39; /NM &#39;</span>.$this-&gt;_datastring(sprintf(<span class="stringliteral">&#39;%04u-%04u&#39;</span>, $n, $key));
<a name="l05714"></a>05714             $annots .= <span class="stringliteral">&#39; /M &#39;</span>.$this-&gt;_datestring();
<a name="l05715"></a>05715             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;f&#39;</span>])) {
<a name="l05716"></a>05716               $val = 0;
<a name="l05717"></a>05717               <span class="keywordflow">if</span> (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;f&#39;</span>])) {
<a name="l05718"></a>05718                 <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;f&#39;</span>] as $f) {
<a name="l05719"></a>05719                   <span class="keywordflow">switch</span> (strtolower($f)) {
<a name="l05720"></a>05720                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;invisible&#39;</span>: {
<a name="l05721"></a>05721                       $val += 1 &lt;&lt; 0;
<a name="l05722"></a>05722                       <span class="keywordflow">break</span>;
<a name="l05723"></a>05723                     }
<a name="l05724"></a>05724                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;hidden&#39;</span>: {
<a name="l05725"></a>05725                       $val += 1 &lt;&lt; 1;
<a name="l05726"></a>05726                       <span class="keywordflow">break</span>;
<a name="l05727"></a>05727                     }
<a name="l05728"></a>05728                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;print&#39;</span>: {
<a name="l05729"></a>05729                       $val += 1 &lt;&lt; 2;
<a name="l05730"></a>05730                       <span class="keywordflow">break</span>;
<a name="l05731"></a>05731                     }
<a name="l05732"></a>05732                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;nozoom&#39;</span>: {
<a name="l05733"></a>05733                       $val += 1 &lt;&lt; 3;
<a name="l05734"></a>05734                       <span class="keywordflow">break</span>;
<a name="l05735"></a>05735                     }
<a name="l05736"></a>05736                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;norotate&#39;</span>: {
<a name="l05737"></a>05737                       $val += 1 &lt;&lt; 4;
<a name="l05738"></a>05738                       <span class="keywordflow">break</span>;
<a name="l05739"></a>05739                     }
<a name="l05740"></a>05740                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;noview&#39;</span>: {
<a name="l05741"></a>05741                       $val += 1 &lt;&lt; 5;
<a name="l05742"></a>05742                       <span class="keywordflow">break</span>;
<a name="l05743"></a>05743                     }
<a name="l05744"></a>05744                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;readonly&#39;</span>: {
<a name="l05745"></a>05745                       $val += 1 &lt;&lt; 6;
<a name="l05746"></a>05746                       <span class="keywordflow">break</span>;
<a name="l05747"></a>05747                     }
<a name="l05748"></a>05748                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;locked&#39;</span>: {
<a name="l05749"></a>05749                       $val += 1 &lt;&lt; 8;
<a name="l05750"></a>05750                       <span class="keywordflow">break</span>;
<a name="l05751"></a>05751                     }
<a name="l05752"></a>05752                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;togglenoview&#39;</span>: {
<a name="l05753"></a>05753                       $val += 1 &lt;&lt; 9;
<a name="l05754"></a>05754                       <span class="keywordflow">break</span>;
<a name="l05755"></a>05755                     }
<a name="l05756"></a>05756                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;lockedcontents&#39;</span>: {
<a name="l05757"></a>05757                       $val += 1 &lt;&lt; 10;
<a name="l05758"></a>05758                       <span class="keywordflow">break</span>;
<a name="l05759"></a>05759                     }
<a name="l05760"></a>05760                     <span class="keywordflow">default</span>: {
<a name="l05761"></a>05761                       <span class="keywordflow">break</span>;
<a name="l05762"></a>05762                     }
<a name="l05763"></a>05763                   }
<a name="l05764"></a>05764                 }
<a name="l05765"></a>05765               } <span class="keywordflow">else</span> {
<a name="l05766"></a>05766                 $val = intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;f&#39;</span>]);
<a name="l05767"></a>05767               }
<a name="l05768"></a>05768               $annots .= <span class="stringliteral">&#39; /F &#39;</span>.intval($val);
<a name="l05769"></a>05769             }
<a name="l05770"></a>05770             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;as&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;as&#39;</span>])) {
<a name="l05771"></a>05771               $annots .= <span class="stringliteral">&#39; /AS /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;as&#39;</span>];
<a name="l05772"></a>05772             }
<a name="l05773"></a>05773             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ap&#39;</span>])) {
<a name="l05774"></a>05774               <span class="comment">// appearance stream</span>
<a name="l05775"></a>05775               $annots .= <span class="stringliteral">&#39; /AP &lt;&lt;&#39;</span>;
<a name="l05776"></a>05776               <span class="keywordflow">if</span> (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ap&#39;</span>])) {
<a name="l05777"></a>05777                 <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ap&#39;</span>] as $apmode =&gt; $apdef) {
<a name="l05778"></a>05778                   <span class="comment">// $apmode can be: n = normal; r = rollover; d = down;</span>
<a name="l05779"></a>05779                   $annots .= <span class="stringliteral">&#39; /&#39;</span>.strtoupper($apmode);
<a name="l05780"></a>05780                   <span class="keywordflow">if</span> (is_array($apdef)) {
<a name="l05781"></a>05781                     $annots .= <span class="stringliteral">&#39; &lt;&lt;&#39;</span>;
<a name="l05782"></a>05782                     <span class="keywordflow">foreach</span> ($apdef as $apstate =&gt; $stream) {
<a name="l05783"></a>05783                       <span class="comment">// reference to XObject that define the appearance for this mode-state</span>
<a name="l05784"></a>05784                       $apsobjid = $this-&gt;_putAPXObject($c, $d, $stream);
<a name="l05785"></a>05785                       $annots .= <span class="stringliteral">&#39; /&#39;</span>.$apstate.<span class="charliteral">&#39; &#39;</span>.$apsobjid.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l05786"></a>05786                     }
<a name="l05787"></a>05787                     $annots .= <span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l05788"></a>05788                   } <span class="keywordflow">else</span> {
<a name="l05789"></a>05789                     <span class="comment">// reference to XObject that define the appearance for this mode</span>
<a name="l05790"></a>05790                     $apsobjid = $this-&gt;_putAPXObject($c, $d, $apdef);
<a name="l05791"></a>05791                     $annots .= <span class="charliteral">&#39; &#39;</span>.$apsobjid.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l05792"></a>05792                   }
<a name="l05793"></a>05793                 }
<a name="l05794"></a>05794               } <span class="keywordflow">else</span> {
<a name="l05795"></a>05795                 $annots .= $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ap&#39;</span>];
<a name="l05796"></a>05796               }
<a name="l05797"></a>05797               $annots .= <span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l05798"></a>05798             }
<a name="l05799"></a>05799             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>]))) {
<a name="l05800"></a>05800               $annots .= <span class="stringliteral">&#39; /BS &lt;&lt;&#39;</span>;
<a name="l05801"></a>05801               $annots .= <span class="stringliteral">&#39; /Type /Border&#39;</span>;
<a name="l05802"></a>05802               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;w&#39;</span>])) {
<a name="l05803"></a>05803                 $annots .= <span class="stringliteral">&#39; /W &#39;</span>.intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;w&#39;</span>]);
<a name="l05804"></a>05804               }
<a name="l05805"></a>05805               $bstyles = array(<span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;I&#39;</span>, <span class="charliteral">&#39;U&#39;</span>);
<a name="l05806"></a>05806               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;s&#39;</span>], $bstyles)) {
<a name="l05807"></a>05807                 $annots .= <span class="stringliteral">&#39; /S /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;s&#39;</span>];
<a name="l05808"></a>05808               }
<a name="l05809"></a>05809               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;d&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;d&#39;</span>]))) {
<a name="l05810"></a>05810                 $annots .= <span class="stringliteral">&#39; /D [&#39;</span>;
<a name="l05811"></a>05811                 <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;d&#39;</span>] as $cord) {
<a name="l05812"></a>05812                   $annots .= <span class="charliteral">&#39; &#39;</span>.intval($cord);
<a name="l05813"></a>05813                 }
<a name="l05814"></a>05814                 $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l05815"></a>05815               }
<a name="l05816"></a>05816               $annots .= <span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l05817"></a>05817             } <span class="keywordflow">else</span> {
<a name="l05818"></a>05818               $annots .= <span class="stringliteral">&#39; /Border [&#39;</span>;
<a name="l05819"></a>05819               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>]) AND (count($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>]) &gt;= 3)) {
<a name="l05820"></a>05820                 $annots .= intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>][0]).<span class="charliteral">&#39; &#39;</span>;
<a name="l05821"></a>05821                 $annots .= intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>][1]).<span class="charliteral">&#39; &#39;</span>;
<a name="l05822"></a>05822                 $annots .= intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>][2]);
<a name="l05823"></a>05823                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>][3]) AND is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>][3])) {
<a name="l05824"></a>05824                   $annots .= <span class="stringliteral">&#39; [&#39;</span>;
<a name="l05825"></a>05825                   <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>][3] as $dash) {
<a name="l05826"></a>05826                     $annots .= intval($dash).<span class="charliteral">&#39; &#39;</span>;
<a name="l05827"></a>05827                   }
<a name="l05828"></a>05828                   $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l05829"></a>05829                 }
<a name="l05830"></a>05830               } <span class="keywordflow">else</span> {
<a name="l05831"></a>05831                 $annots .= <span class="stringliteral">&#39;0 0 0&#39;</span>;
<a name="l05832"></a>05832               }
<a name="l05833"></a>05833               $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l05834"></a>05834             }
<a name="l05835"></a>05835             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>]))) {
<a name="l05836"></a>05836               $annots .= <span class="stringliteral">&#39; /BE &lt;&lt;&#39;</span>;
<a name="l05837"></a>05837               $bstyles = array(<span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39;C&#39;</span>);
<a name="l05838"></a>05838               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>][<span class="charliteral">&#39;s&#39;</span>], $markups)) {
<a name="l05839"></a>05839                 $annots .= <span class="stringliteral">&#39; /S /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;bs&#39;</span>][<span class="charliteral">&#39;s&#39;</span>];
<a name="l05840"></a>05840               } <span class="keywordflow">else</span> {
<a name="l05841"></a>05841                 $annots .= <span class="stringliteral">&#39; /S /S&#39;</span>;
<a name="l05842"></a>05842               }
<a name="l05843"></a>05843               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>][<span class="charliteral">&#39;i&#39;</span>]) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>][<span class="charliteral">&#39;i&#39;</span>] &gt;= 0) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>][<span class="charliteral">&#39;i&#39;</span>] &lt;= 2)) {
<a name="l05844"></a>05844                 $annots .= <span class="stringliteral">&#39; /I &#39;</span>.sprintf(<span class="stringliteral">&quot; %.4F&quot;</span>, $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;be&#39;</span>][<span class="charliteral">&#39;i&#39;</span>]);
<a name="l05845"></a>05845               }
<a name="l05846"></a>05846               $annots .= <span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l05847"></a>05847             }
<a name="l05848"></a>05848             <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;c&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;c&#39;</span>])) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;c&#39;</span>])) {
<a name="l05849"></a>05849               $annots .= <span class="stringliteral">&#39; /C [&#39;</span>;
<a name="l05850"></a>05850               <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;c&#39;</span>] as $col) {
<a name="l05851"></a>05851                 $col = intval($col);
<a name="l05852"></a>05852                 $color = $col &lt;= 0 ? 0 : ($col &gt;= 255 ? 1 : $col / 255);
<a name="l05853"></a>05853                 $annots .= sprintf(<span class="stringliteral">&quot; %.4F&quot;</span>, $color);
<a name="l05854"></a>05854               }
<a name="l05855"></a>05855               $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l05856"></a>05856             }
<a name="l05857"></a>05857             <span class="comment">//$annots .= &#39; /StructParent &#39;;</span>
<a name="l05858"></a>05858             <span class="comment">//$annots .= &#39; /OC &#39;;</span>
<a name="l05859"></a>05859             $markups = array(<span class="stringliteral">&#39;text&#39;</span>, <span class="stringliteral">&#39;freetext&#39;</span>, <span class="stringliteral">&#39;line&#39;</span>, <span class="stringliteral">&#39;square&#39;</span>, <span class="stringliteral">&#39;circle&#39;</span>, <span class="stringliteral">&#39;polygon&#39;</span>, <span class="stringliteral">&#39;polyline&#39;</span>, <span class="stringliteral">&#39;highlight&#39;</span>,  <span class="stringliteral">&#39;underline&#39;</span>, <span class="stringliteral">&#39;squiggly&#39;</span>, <span class="stringliteral">&#39;strikeout&#39;</span>, <span class="stringliteral">&#39;stamp&#39;</span>, <span class="stringliteral">&#39;caret&#39;</span>, <span class="stringliteral">&#39;ink&#39;</span>, <span class="stringliteral">&#39;fileattachment&#39;</span>, <span class="stringliteral">&#39;sound&#39;</span>);
<a name="l05860"></a>05860             <span class="keywordflow">if</span> (in_array(strtolower($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;subtype&#39;</span>]), $markups)) {
<a name="l05861"></a>05861               <span class="comment">// this is a markup type</span>
<a name="l05862"></a>05862               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;t&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;t&#39;</span>])) {
<a name="l05863"></a>05863                 $annots .= <span class="stringliteral">&#39; /T &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;t&#39;</span>]);
<a name="l05864"></a>05864               }
<a name="l05865"></a>05865               <span class="comment">//$annots .= &#39; /Popup &#39;;</span>
<a name="l05866"></a>05866               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>])) {
<a name="l05867"></a>05867                 $annots .= <span class="stringliteral">&#39; /CA &#39;</span>.sprintf(<span class="stringliteral">&quot;%.4F&quot;</span>, floatval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>]));
<a name="l05868"></a>05868               }
<a name="l05869"></a>05869               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rc&#39;</span>])) {
<a name="l05870"></a>05870                 $annots .= <span class="stringliteral">&#39; /RC &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rc&#39;</span>]);
<a name="l05871"></a>05871               }
<a name="l05872"></a>05872               $annots .= <span class="stringliteral">&#39; /CreationDate &#39;</span>.$this-&gt;_datestring();
<a name="l05873"></a>05873               <span class="comment">//$annots .= &#39; /IRT &#39;;</span>
<a name="l05874"></a>05874               <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;subj&#39;</span>])) {
<a name="l05875"></a>05875                 $annots .= <span class="stringliteral">&#39; /Subj &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;subj&#39;</span>]);
<a name="l05876"></a>05876               }
<a name="l05877"></a>05877               <span class="comment">//$annots .= &#39; /RT &#39;;</span>
<a name="l05878"></a>05878               <span class="comment">//$annots .= &#39; /IT &#39;;</span>
<a name="l05879"></a>05879               <span class="comment">//$annots .= &#39; /ExData &#39;;</span>
<a name="l05880"></a>05880             }
<a name="l05881"></a>05881             $lineendings = array(<span class="stringliteral">&#39;Square&#39;</span>, <span class="stringliteral">&#39;Circle&#39;</span>, <span class="stringliteral">&#39;Diamond&#39;</span>, <span class="stringliteral">&#39;OpenArrow&#39;</span>, <span class="stringliteral">&#39;ClosedArrow&#39;</span>, <span class="stringliteral">&#39;None&#39;</span>, <span class="stringliteral">&#39;Butt&#39;</span>, <span class="stringliteral">&#39;ROpenArrow&#39;</span>, <span class="stringliteral">&#39;RClosedArrow&#39;</span>, <span class="stringliteral">&#39;Slash&#39;</span>);
<a name="l05882"></a>05882             <span class="keywordflow">switch</span> (strtolower($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;subtype&#39;</span>])) {
<a name="l05883"></a>05883               <span class="keywordflow">case</span> <span class="stringliteral">&#39;text&#39;</span>: {
<a name="l05884"></a>05884                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;open&#39;</span>])) {
<a name="l05885"></a>05885                   $annots .= <span class="stringliteral">&#39; /Open &#39;</span>. (strtolower($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;open&#39;</span>]) == <span class="stringliteral">&#39;true&#39;</span> ? <span class="stringliteral">&#39;true&#39;</span> : <span class="stringliteral">&#39;false&#39;</span>);
<a name="l05886"></a>05886                 }
<a name="l05887"></a>05887                 $iconsapp = array(<span class="stringliteral">&#39;Comment&#39;</span>, <span class="stringliteral">&#39;Help&#39;</span>, <span class="stringliteral">&#39;Insert&#39;</span>, <span class="stringliteral">&#39;Key&#39;</span>, <span class="stringliteral">&#39;NewParagraph&#39;</span>, <span class="stringliteral">&#39;Note&#39;</span>, <span class="stringliteral">&#39;Paragraph&#39;</span>);
<a name="l05888"></a>05888                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>], $iconsapp)) {
<a name="l05889"></a>05889                   $annots .= <span class="stringliteral">&#39; /Name /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>];
<a name="l05890"></a>05890                 } <span class="keywordflow">else</span> {
<a name="l05891"></a>05891                   $annots .= <span class="stringliteral">&#39; /Name /Note&#39;</span>;
<a name="l05892"></a>05892                 }
<a name="l05893"></a>05893                 $statemodels = array(<span class="stringliteral">&#39;Marked&#39;</span>, <span class="stringliteral">&#39;Review&#39;</span>);
<a name="l05894"></a>05894                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>], $statemodels)) {
<a name="l05895"></a>05895                   $annots .= <span class="stringliteral">&#39; /StateModel /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>];
<a name="l05896"></a>05896                 } <span class="keywordflow">else</span> {
<a name="l05897"></a>05897                   $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>] = <span class="stringliteral">&#39;Marked&#39;</span>;
<a name="l05898"></a>05898                   $annots .= <span class="stringliteral">&#39; /StateModel /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>];
<a name="l05899"></a>05899                 }
<a name="l05900"></a>05900                 <span class="keywordflow">if</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>] == <span class="stringliteral">&#39;Marked&#39;</span>) {
<a name="l05901"></a>05901                   $states = array(<span class="stringliteral">&#39;Accepted&#39;</span>, <span class="stringliteral">&#39;Unmarked&#39;</span>);
<a name="l05902"></a>05902                 } <span class="keywordflow">else</span> {
<a name="l05903"></a>05903                   $states = array(<span class="stringliteral">&#39;Accepted&#39;</span>, <span class="stringliteral">&#39;Rejected&#39;</span>, <span class="stringliteral">&#39;Cancelled&#39;</span>, <span class="stringliteral">&#39;Completed&#39;</span>, <span class="stringliteral">&#39;None&#39;</span>);
<a name="l05904"></a>05904                 }
<a name="l05905"></a>05905                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;state&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;state&#39;</span>], $states)) {
<a name="l05906"></a>05906                   $annots .= <span class="stringliteral">&#39; /State /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;state&#39;</span>];
<a name="l05907"></a>05907                 } <span class="keywordflow">else</span> {
<a name="l05908"></a>05908                   <span class="keywordflow">if</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;statemodel&#39;</span>] == <span class="stringliteral">&#39;Marked&#39;</span>) {
<a name="l05909"></a>05909                     $annots .= <span class="stringliteral">&#39; /State /Unmarked&#39;</span>;
<a name="l05910"></a>05910                   } <span class="keywordflow">else</span> {
<a name="l05911"></a>05911                     $annots .= <span class="stringliteral">&#39; /State /None&#39;</span>;
<a name="l05912"></a>05912                   }
<a name="l05913"></a>05913                 }
<a name="l05914"></a>05914                 <span class="keywordflow">break</span>;
<a name="l05915"></a>05915               }
<a name="l05916"></a>05916               <span class="keywordflow">case</span> <span class="stringliteral">&#39;link&#39;</span>: {
<a name="l05917"></a>05917                 <span class="keywordflow">if</span>(is_string($pl[<span class="stringliteral">&#39;txt&#39;</span>])) {
<a name="l05918"></a>05918                   <span class="comment">// external URI link</span>
<a name="l05919"></a>05919                   $annots .= <span class="stringliteral">&#39; /A &lt;&lt;/S /URI /URI &#39;</span>.$this-&gt;_datastring($this-&gt;unhtmlentities($pl[<span class="stringliteral">&#39;txt&#39;</span>])).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l05920"></a>05920                 } <span class="keywordflow">else</span> {
<a name="l05921"></a>05921                   <span class="comment">// internal link</span>
<a name="l05922"></a>05922                   $l = $this-&gt;links[$pl[<span class="stringliteral">&#39;txt&#39;</span>]];
<a name="l05923"></a>05923                   $annots .= sprintf(<span class="stringliteral">&#39; /Dest [%d 0 R /XYZ 0 %.2F null]&#39;</span>, (1 + (2 * $l[0])), ($this-&gt;pagedim[$l[0]][<span class="charliteral">&#39;h&#39;</span>] - ($l[1] * $this-&gt;k)));
<a name="l05924"></a>05924                 }
<a name="l05925"></a>05925                 $hmodes = array(<span class="charliteral">&#39;N&#39;</span>, <span class="charliteral">&#39;I&#39;</span>, <span class="charliteral">&#39;O&#39;</span>, <span class="charliteral">&#39;P&#39;</span>);
<a name="l05926"></a>05926                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;h&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;h&#39;</span>], $hmodes)) {
<a name="l05927"></a>05927                   $annots .= <span class="stringliteral">&#39; /H /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;h&#39;</span>];
<a name="l05928"></a>05928                 } <span class="keywordflow">else</span> {
<a name="l05929"></a>05929                   $annots .= <span class="stringliteral">&#39; /H /I&#39;</span>;
<a name="l05930"></a>05930                 }
<a name="l05931"></a>05931                 <span class="comment">//$annots .= &#39; /PA &#39;;</span>
<a name="l05932"></a>05932                 <span class="comment">//$annots .= &#39; /Quadpoints &#39;;</span>
<a name="l05933"></a>05933                 <span class="keywordflow">break</span>;
<a name="l05934"></a>05934               }
<a name="l05935"></a>05935               <span class="keywordflow">case</span> <span class="stringliteral">&#39;freetext&#39;</span>: {
<a name="l05936"></a>05936                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;da&#39;</span>]) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;da&#39;</span>])) {
<a name="l05937"></a>05937                   $annots .= <span class="stringliteral">&#39; /DA (&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;da&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l05938"></a>05938                 }
<a name="l05939"></a>05939                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>]) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>] &gt;= 0) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>] &lt;= 2)) {
<a name="l05940"></a>05940                   $annots .= <span class="stringliteral">&#39; /Q &#39;</span>.intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>]);
<a name="l05941"></a>05941                 }
<a name="l05942"></a>05942                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rc&#39;</span>])) {
<a name="l05943"></a>05943                   $annots .= <span class="stringliteral">&#39; /RC &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rc&#39;</span>]);
<a name="l05944"></a>05944                 }
<a name="l05945"></a>05945                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ds&#39;</span>])) {
<a name="l05946"></a>05946                   $annots .= <span class="stringliteral">&#39; /DS &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ds&#39;</span>]);
<a name="l05947"></a>05947                 }
<a name="l05948"></a>05948                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;cl&#39;</span>]) AND is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;cl&#39;</span>])) {
<a name="l05949"></a>05949                   $annots .= <span class="stringliteral">&#39; /CL [&#39;</span>;
<a name="l05950"></a>05950                   <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;cl&#39;</span>] as $cl) {
<a name="l05951"></a>05951                     $annots .= sprintf(<span class="stringliteral">&quot;%.4F &quot;</span>, $cl * $this-&gt;k);
<a name="l05952"></a>05952                   }
<a name="l05953"></a>05953                   $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l05954"></a>05954                 }
<a name="l05955"></a>05955                 $tfit = array(<span class="stringliteral">&#39;FreeText&#39;</span>, <span class="stringliteral">&#39;FreeTextCallout&#39;</span>, <span class="stringliteral">&#39;FreeTextTypeWriter&#39;</span>);
<a name="l05956"></a>05956                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;it&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;it&#39;</span>], $tfit)) {
<a name="l05957"></a>05957                   $annots .= <span class="stringliteral">&#39; /IT &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;it&#39;</span>];
<a name="l05958"></a>05958                 }
<a name="l05959"></a>05959                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rd&#39;</span>]) AND is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rd&#39;</span>])) {
<a name="l05960"></a>05960                   $l = $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rd&#39;</span>][0] * $this-&gt;k;
<a name="l05961"></a>05961                   $r = $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rd&#39;</span>][1] * $this-&gt;k;
<a name="l05962"></a>05962                   $t = $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rd&#39;</span>][2] * $this-&gt;k;
<a name="l05963"></a>05963                   $b = $pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rd&#39;</span>][3] * $this-&gt;k;
<a name="l05964"></a>05964                   $annots .= <span class="stringliteral">&#39; /RD [&#39;</span>.sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F&#39;</span>, $l, $r, $t, $b).<span class="charliteral">&#39;]&#39;</span>;
<a name="l05965"></a>05965                 }
<a name="l05966"></a>05966                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;le&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;le&#39;</span>], $lineendings)) {
<a name="l05967"></a>05967                   $annots .= <span class="stringliteral">&#39; /LE /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;le&#39;</span>];
<a name="l05968"></a>05968                 }
<a name="l05969"></a>05969                 <span class="keywordflow">break</span>;
<a name="l05970"></a>05970               }
<a name="l05971"></a>05971               <span class="keywordflow">case</span> <span class="stringliteral">&#39;line&#39;</span>: {
<a name="l05972"></a>05972                 <span class="keywordflow">break</span>;
<a name="l05973"></a>05973               }
<a name="l05974"></a>05974               <span class="keywordflow">case</span> <span class="stringliteral">&#39;square&#39;</span>: {
<a name="l05975"></a>05975                 <span class="keywordflow">break</span>;
<a name="l05976"></a>05976               }
<a name="l05977"></a>05977               <span class="keywordflow">case</span> <span class="stringliteral">&#39;circle&#39;</span>: {
<a name="l05978"></a>05978                 <span class="keywordflow">break</span>;
<a name="l05979"></a>05979               }
<a name="l05980"></a>05980               <span class="keywordflow">case</span> <span class="stringliteral">&#39;polygon&#39;</span>: {
<a name="l05981"></a>05981                 <span class="keywordflow">break</span>;
<a name="l05982"></a>05982               }
<a name="l05983"></a>05983               <span class="keywordflow">case</span> <span class="stringliteral">&#39;polyline&#39;</span>: {
<a name="l05984"></a>05984                 <span class="keywordflow">break</span>;
<a name="l05985"></a>05985               }
<a name="l05986"></a>05986               <span class="keywordflow">case</span> <span class="stringliteral">&#39;highlight&#39;</span>: {
<a name="l05987"></a>05987                 <span class="keywordflow">break</span>;
<a name="l05988"></a>05988               }
<a name="l05989"></a>05989               <span class="keywordflow">case</span> <span class="stringliteral">&#39;underline&#39;</span>: {
<a name="l05990"></a>05990                 <span class="keywordflow">break</span>;
<a name="l05991"></a>05991               }
<a name="l05992"></a>05992               <span class="keywordflow">case</span> <span class="stringliteral">&#39;squiggly&#39;</span>: {
<a name="l05993"></a>05993                 <span class="keywordflow">break</span>;
<a name="l05994"></a>05994               }
<a name="l05995"></a>05995               <span class="keywordflow">case</span> <span class="stringliteral">&#39;strikeout&#39;</span>: {
<a name="l05996"></a>05996                 <span class="keywordflow">break</span>;
<a name="l05997"></a>05997               }
<a name="l05998"></a>05998               <span class="keywordflow">case</span> <span class="stringliteral">&#39;stamp&#39;</span>: {
<a name="l05999"></a>05999                 <span class="keywordflow">break</span>;
<a name="l06000"></a>06000               }
<a name="l06001"></a>06001               <span class="keywordflow">case</span> <span class="stringliteral">&#39;caret&#39;</span>: {
<a name="l06002"></a>06002                 <span class="keywordflow">break</span>;
<a name="l06003"></a>06003               }
<a name="l06004"></a>06004               <span class="keywordflow">case</span> <span class="stringliteral">&#39;ink&#39;</span>: {
<a name="l06005"></a>06005                 <span class="keywordflow">break</span>;
<a name="l06006"></a>06006               }
<a name="l06007"></a>06007               <span class="keywordflow">case</span> <span class="stringliteral">&#39;popup&#39;</span>: {
<a name="l06008"></a>06008                 <span class="keywordflow">break</span>;
<a name="l06009"></a>06009               }
<a name="l06010"></a>06010               <span class="keywordflow">case</span> <span class="stringliteral">&#39;fileattachment&#39;</span>: {
<a name="l06011"></a>06011                 <span class="keywordflow">if</span> (!isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;fs&#39;</span>])) {
<a name="l06012"></a>06012                   <span class="keywordflow">break</span>;
<a name="l06013"></a>06013                 }
<a name="l06014"></a>06014                 $filename = basename($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;fs&#39;</span>]);
<a name="l06015"></a>06015                 <span class="keywordflow">if</span> (isset($this-&gt;embeddedfiles[$filename][<span class="charliteral">&#39;n&#39;</span>])) {
<a name="l06016"></a>06016                   $annots .= <span class="stringliteral">&#39; /FS &lt;&lt;/Type /Filespec /F &#39;</span>.$this-&gt;_datastring($filename).<span class="stringliteral">&#39; /EF &lt;&lt;/F &#39;</span>.$this-&gt;embeddedfiles[$filename][<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&gt;&gt; &gt;&gt;&#39;</span>;
<a name="l06017"></a>06017                   $iconsapp = array(<span class="stringliteral">&#39;Graph&#39;</span>, <span class="stringliteral">&#39;Paperclip&#39;</span>, <span class="stringliteral">&#39;PushPin&#39;</span>, <span class="stringliteral">&#39;Tag&#39;</span>);
<a name="l06018"></a>06018                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>], $iconsapp)) {
<a name="l06019"></a>06019                     $annots .= <span class="stringliteral">&#39; /Name /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>];
<a name="l06020"></a>06020                   } <span class="keywordflow">else</span> {
<a name="l06021"></a>06021                     $annots .= <span class="stringliteral">&#39; /Name /PushPin&#39;</span>;
<a name="l06022"></a>06022                   }
<a name="l06023"></a>06023                 }
<a name="l06024"></a>06024                 <span class="keywordflow">break</span>;
<a name="l06025"></a>06025               }
<a name="l06026"></a>06026               <span class="keywordflow">case</span> <span class="stringliteral">&#39;sound&#39;</span>: {
<a name="l06027"></a>06027                 <span class="keywordflow">if</span> (!isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;sound&#39;</span>])) {
<a name="l06028"></a>06028                   <span class="keywordflow">break</span>;
<a name="l06029"></a>06029                 }
<a name="l06030"></a>06030                 $filename = basename($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;sound&#39;</span>]);
<a name="l06031"></a>06031                 <span class="keywordflow">if</span> (isset($this-&gt;embeddedfiles[$filename][<span class="charliteral">&#39;n&#39;</span>])) {
<a name="l06032"></a>06032                   $annots .= <span class="stringliteral">&#39; /Sound &lt;&lt;/Type /Sound&#39;</span>;
<a name="l06033"></a>06033                   <span class="comment">// ... TO BE COMPLETED ...</span>
<a name="l06034"></a>06034                   <span class="comment">// /R /C /B /E /CO /CP</span>
<a name="l06035"></a>06035                   <span class="comment">// $annots .= &#39; /F &#39;.$this-&gt;_datastring($filename).&#39; /EF &lt;&lt;/F &#39;.$this-&gt;embeddedfiles[$filename][&#39;n&#39;].&#39; 0 R&gt;&gt; &gt;&gt;&#39;;</span>
<a name="l06036"></a>06036                   $iconsapp = array(<span class="stringliteral">&#39;Speaker&#39;</span>, <span class="stringliteral">&#39;Mic&#39;</span>);
<a name="l06037"></a>06037                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>], $iconsapp)) {
<a name="l06038"></a>06038                     $annots .= <span class="stringliteral">&#39; /Name /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>];
<a name="l06039"></a>06039                   } <span class="keywordflow">else</span> {
<a name="l06040"></a>06040                     $annots .= <span class="stringliteral">&#39; /Name /Speaker&#39;</span>;
<a name="l06041"></a>06041                   }
<a name="l06042"></a>06042                 }
<a name="l06043"></a>06043                 <span class="keywordflow">break</span>;
<a name="l06044"></a>06044               }
<a name="l06045"></a>06045               <span class="keywordflow">case</span> <span class="stringliteral">&#39;movie&#39;</span>: {
<a name="l06046"></a>06046                 <span class="keywordflow">break</span>;
<a name="l06047"></a>06047               }
<a name="l06048"></a>06048               <span class="keywordflow">case</span> <span class="stringliteral">&#39;widget&#39;</span>: {
<a name="l06049"></a>06049                 $hmode = array(<span class="charliteral">&#39;N&#39;</span>, <span class="charliteral">&#39;I&#39;</span>, <span class="charliteral">&#39;O&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;T&#39;</span>);
<a name="l06050"></a>06050                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;h&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;h&#39;</span>], $hmode)) {
<a name="l06051"></a>06051                   $annots .= <span class="stringliteral">&#39; /H /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;h&#39;</span>];
<a name="l06052"></a>06052                 }
<a name="l06053"></a>06053                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>])) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>])) {
<a name="l06054"></a>06054                   $annots .= <span class="stringliteral">&#39; /MK &lt;&lt;&#39;</span>;
<a name="l06055"></a>06055                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;r&#39;</span>])) {
<a name="l06056"></a>06056                     $annots .= <span class="stringliteral">&#39; /R &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;r&#39;</span>];
<a name="l06057"></a>06057                   }
<a name="l06058"></a>06058                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bc&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bc&#39;</span>]))) {
<a name="l06059"></a>06059                     $annots .= <span class="stringliteral">&#39; /BC [&#39;</span>;
<a name="l06060"></a>06060                     <span class="keywordflow">foreach</span>($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bc&#39;</span>] AS $col) {
<a name="l06061"></a>06061                       $col = intval($col);
<a name="l06062"></a>06062                       $color = $col &lt;= 0 ? 0 : ($col &gt;= 255 ? 1 : $col / 255);
<a name="l06063"></a>06063                       $annots .= <span class="charliteral">&#39; &#39;</span>.$color;
<a name="l06064"></a>06064                     }
<a name="l06065"></a>06065                     $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l06066"></a>06066                   }
<a name="l06067"></a>06067                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bg&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bg&#39;</span>]))) {
<a name="l06068"></a>06068                     $annots .= <span class="stringliteral">&#39; /BG [&#39;</span>;
<a name="l06069"></a>06069                     <span class="keywordflow">foreach</span>($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bg&#39;</span>] AS $col) {
<a name="l06070"></a>06070                       $col = intval($col);
<a name="l06071"></a>06071                       $color = $col &lt;= 0 ? 0 : ($col &gt;= 255 ? 1 : $col / 255);
<a name="l06072"></a>06072                       $annots .= <span class="charliteral">&#39; &#39;</span>.$color;
<a name="l06073"></a>06073                     }
<a name="l06074"></a>06074                     $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l06075"></a>06075                   }
<a name="l06076"></a>06076                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>])) {
<a name="l06077"></a>06077                     $annots .= <span class="stringliteral">&#39; /CA &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>].<span class="stringliteral">&#39;&#39;</span>;
<a name="l06078"></a>06078                   }
<a name="l06079"></a>06079                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;rc&#39;</span>])) {
<a name="l06080"></a>06080                     $annots .= <span class="stringliteral">&#39; /RC &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>].<span class="stringliteral">&#39;&#39;</span>;
<a name="l06081"></a>06081                   }
<a name="l06082"></a>06082                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ac&#39;</span>])) {
<a name="l06083"></a>06083                     $annots .= <span class="stringliteral">&#39; /AC &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>].<span class="stringliteral">&#39;&#39;</span>;
<a name="l06084"></a>06084                   }                                 
<a name="l06085"></a>06085                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;i&#39;</span>])) {
<a name="l06086"></a>06086                     $info = $this-&gt;getImageBuffer($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;i&#39;</span>]);
<a name="l06087"></a>06087                     <span class="keywordflow">if</span> ($info !== <span class="keyword">false</span>) {
<a name="l06088"></a>06088                       $annots .= <span class="stringliteral">&#39; /I &#39;</span>.$info[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06089"></a>06089                     }
<a name="l06090"></a>06090                   }
<a name="l06091"></a>06091                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ri&#39;</span>])) {
<a name="l06092"></a>06092                     $info = $this-&gt;getImageBuffer($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ri&#39;</span>]);
<a name="l06093"></a>06093                     <span class="keywordflow">if</span> ($info !== <span class="keyword">false</span>) {
<a name="l06094"></a>06094                       $annots .= <span class="stringliteral">&#39; /RI &#39;</span>.$info[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06095"></a>06095                     }
<a name="l06096"></a>06096                   }
<a name="l06097"></a>06097                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ix&#39;</span>])) {
<a name="l06098"></a>06098                     $info = $this-&gt;getImageBuffer($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ix&#39;</span>]);
<a name="l06099"></a>06099                     <span class="keywordflow">if</span> ($info !== <span class="keyword">false</span>) {
<a name="l06100"></a>06100                       $annots .= <span class="stringliteral">&#39; /IX &#39;</span>.$info[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06101"></a>06101                     }
<a name="l06102"></a>06102                   }                 
<a name="l06103"></a>06103                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>])) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>])) {
<a name="l06104"></a>06104                     $annots .= <span class="stringliteral">&#39; /IF &lt;&lt;&#39;</span>;
<a name="l06105"></a>06105                     $if_sw = array(<span class="charliteral">&#39;A&#39;</span>, <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39;N&#39;</span>);
<a name="l06106"></a>06106                     <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>], $if_sw)) {
<a name="l06107"></a>06107                       $annots .= <span class="stringliteral">&#39; /SW /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>];
<a name="l06108"></a>06108                     }
<a name="l06109"></a>06109                     $if_s = array(<span class="charliteral">&#39;A&#39;</span>, <span class="charliteral">&#39;P&#39;</span>);
<a name="l06110"></a>06110                     <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;s&#39;</span>]) AND in_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;s&#39;</span>], $if_s)) {
<a name="l06111"></a>06111                       $annots .= <span class="stringliteral">&#39; /S /&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;s&#39;</span>];
<a name="l06112"></a>06112                     }
<a name="l06113"></a>06113                     <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>])) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>])) {
<a name="l06114"></a>06114                       $annots .= <span class="stringliteral">&#39; /A [&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>][0].<span class="charliteral">&#39; &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>][1].<span class="charliteral">&#39;]&#39;</span>;
<a name="l06115"></a>06115                     }
<a name="l06116"></a>06116                     <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;fb&#39;</span>]) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;fb&#39;</span>])) {
<a name="l06117"></a>06117                       $annots .= <span class="stringliteral">&#39; /FB true&#39;</span>;
<a name="l06118"></a>06118                     }
<a name="l06119"></a>06119                     $annots .= <span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l06120"></a>06120                   }
<a name="l06121"></a>06121                   <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>]) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] &gt;= 0) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] &lt;= 6)) {
<a name="l06122"></a>06122                     $annots .= <span class="stringliteral">&#39; /TP &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>];
<a name="l06123"></a>06123                   } <span class="keywordflow">else</span> {
<a name="l06124"></a>06124                     $annots .= <span class="stringliteral">&#39; /TP 0&#39;</span>;
<a name="l06125"></a>06125                   }
<a name="l06126"></a>06126                   $annots .= <span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l06127"></a>06127                 } <span class="comment">// end MK</span>
<a name="l06128"></a>06128                 <span class="comment">// --- Entries for field dictionaries ---</span>
<a name="l06129"></a>06129                 <span class="keywordflow">if</span> (isset($this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]])) {
<a name="l06130"></a>06130                   <span class="comment">// set parent</span>
<a name="l06131"></a>06131                   $annots .= <span class="stringliteral">&#39; /Parent &#39;</span>.$this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06132"></a>06132                 }
<a name="l06133"></a>06133                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;t&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;t&#39;</span>])) {
<a name="l06134"></a>06134                   $annots .= <span class="stringliteral">&#39; /T &#39;</span>.$this-&gt;_datastring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;t&#39;</span>]);
<a name="l06135"></a>06135                 }
<a name="l06136"></a>06136                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;tu&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;tu&#39;</span>])) {
<a name="l06137"></a>06137                   $annots .= <span class="stringliteral">&#39; /TU &#39;</span>.$this-&gt;_datastring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;tu&#39;</span>]);
<a name="l06138"></a>06138                 }
<a name="l06139"></a>06139                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;tm&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;tm&#39;</span>])) {
<a name="l06140"></a>06140                   $annots .= <span class="stringliteral">&#39; /TM &#39;</span>.$this-&gt;_datastring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;tm&#39;</span>]);
<a name="l06141"></a>06141                 }
<a name="l06142"></a>06142                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ff&#39;</span>])) {
<a name="l06143"></a>06143                   <span class="keywordflow">if</span> (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ff&#39;</span>])) {
<a name="l06144"></a>06144                     <span class="comment">// array of bit settings</span>
<a name="l06145"></a>06145                     $flag = 0;
<a name="l06146"></a>06146                     <span class="keywordflow">foreach</span>($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ff&#39;</span>] as $val) {
<a name="l06147"></a>06147                       $flag += 1 &lt;&lt; ($val - 1);
<a name="l06148"></a>06148                     }
<a name="l06149"></a>06149                   } <span class="keywordflow">else</span> {
<a name="l06150"></a>06150                     $flag = intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ff&#39;</span>]);
<a name="l06151"></a>06151                   }
<a name="l06152"></a>06152                   $annots .= <span class="stringliteral">&#39; /Ff &#39;</span>.$flag;
<a name="l06153"></a>06153                 }
<a name="l06154"></a>06154                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;maxlen&#39;</span>])) {
<a name="l06155"></a>06155                   $annots .= <span class="stringliteral">&#39; /MaxLen &#39;</span>.intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;maxlen&#39;</span>]);
<a name="l06156"></a>06156                 }
<a name="l06157"></a>06157                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;v&#39;</span>])) {
<a name="l06158"></a>06158                   $annots .= <span class="stringliteral">&#39; /V&#39;</span>;
<a name="l06159"></a>06159                   <span class="keywordflow">if</span> (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;v&#39;</span>])) {
<a name="l06160"></a>06160                     <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;v&#39;</span>] AS $optval) {
<a name="l06161"></a>06161                       $annots .= <span class="charliteral">&#39; &#39;</span>.$optval;
<a name="l06162"></a>06162                     }
<a name="l06163"></a>06163                   } <span class="keywordflow">else</span> {
<a name="l06164"></a>06164                     $annots .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;v&#39;</span>]);
<a name="l06165"></a>06165                   }
<a name="l06166"></a>06166                 }
<a name="l06167"></a>06167                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;dv&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;dv&#39;</span>])) {
<a name="l06168"></a>06168                   $annots .= <span class="stringliteral">&#39; /DV&#39;</span>;
<a name="l06169"></a>06169                   <span class="keywordflow">if</span> (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;dv&#39;</span>])) {
<a name="l06170"></a>06170                     <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;dv&#39;</span>] AS $optval) {
<a name="l06171"></a>06171                       $annots .= <span class="charliteral">&#39; &#39;</span>.$optval;
<a name="l06172"></a>06172                     }
<a name="l06173"></a>06173                   } <span class="keywordflow">else</span> {
<a name="l06174"></a>06174                     $annots .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;dv&#39;</span>]);
<a name="l06175"></a>06175                   }
<a name="l06176"></a>06176                 }
<a name="l06177"></a>06177                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rv&#39;</span>]) AND is_string($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rv&#39;</span>])) {
<a name="l06178"></a>06178                   $annots .= <span class="stringliteral">&#39; /RV&#39;</span>;
<a name="l06179"></a>06179                   <span class="keywordflow">if</span> (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rv&#39;</span>])) {
<a name="l06180"></a>06180                     <span class="keywordflow">foreach</span> ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rv&#39;</span>] AS $optval) {
<a name="l06181"></a>06181                       $annots .= <span class="charliteral">&#39; &#39;</span>.$optval;
<a name="l06182"></a>06182                     }
<a name="l06183"></a>06183                   } <span class="keywordflow">else</span> {
<a name="l06184"></a>06184                     $annots .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_textstring($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;rv&#39;</span>]);
<a name="l06185"></a>06185                   }
<a name="l06186"></a>06186                 }
<a name="l06187"></a>06187                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;a&#39;</span>]) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;a&#39;</span>])) {
<a name="l06188"></a>06188                   $annots .= <span class="stringliteral">&#39; /A &lt;&lt; &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;a&#39;</span>].<span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l06189"></a>06189                 }
<a name="l06190"></a>06190                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;aa&#39;</span>]) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;aa&#39;</span>])) {
<a name="l06191"></a>06191                   $annots .= <span class="stringliteral">&#39; /AA &lt;&lt; &#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;aa&#39;</span>].<span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l06192"></a>06192                 }
<a name="l06193"></a>06193                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;da&#39;</span>]) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;da&#39;</span>])) {
<a name="l06194"></a>06194                   $annots .= <span class="stringliteral">&#39; /DA (&#39;</span>.$pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;da&#39;</span>].<span class="charliteral">&#39;)&#39;</span>;
<a name="l06195"></a>06195                 }
<a name="l06196"></a>06196                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>]) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>] &gt;= 0) AND ($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>] &lt;= 2)) {
<a name="l06197"></a>06197                   $annots .= <span class="stringliteral">&#39; /Q &#39;</span>.intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;q&#39;</span>]);
<a name="l06198"></a>06198                 }
<a name="l06199"></a>06199                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;opt&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;opt&#39;</span>])) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;opt&#39;</span>])) {
<a name="l06200"></a>06200                   $annots .= <span class="stringliteral">&#39; /Opt [&#39;</span>;
<a name="l06201"></a>06201                   <span class="keywordflow">foreach</span>($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;opt&#39;</span>] AS $copt) {
<a name="l06202"></a>06202                     <span class="keywordflow">if</span> (is_array($copt)) {
<a name="l06203"></a>06203                       $annots .= <span class="stringliteral">&#39; [&#39;</span>.$this-&gt;_textstring($copt[0]).<span class="charliteral">&#39; &#39;</span>.$this-&gt;_textstring($copt[1]).<span class="charliteral">&#39;]&#39;</span>;
<a name="l06204"></a>06204                     } <span class="keywordflow">else</span> {
<a name="l06205"></a>06205                       $annots .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_textstring($copt);
<a name="l06206"></a>06206                     }
<a name="l06207"></a>06207                   }
<a name="l06208"></a>06208                   $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l06209"></a>06209                 }
<a name="l06210"></a>06210                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ti&#39;</span>])) {
<a name="l06211"></a>06211                   $annots .= <span class="stringliteral">&#39; /TI &#39;</span>.intval($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="stringliteral">&#39;ti&#39;</span>]);
<a name="l06212"></a>06212                 }
<a name="l06213"></a>06213                 <span class="keywordflow">if</span> (isset($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;i&#39;</span>]) AND (is_array($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;i&#39;</span>])) AND !empty($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;i&#39;</span>])) {
<a name="l06214"></a>06214                   $annots .= <span class="stringliteral">&#39; /I [&#39;</span>;
<a name="l06215"></a>06215                   <span class="keywordflow">foreach</span>($pl[<span class="stringliteral">&#39;opt&#39;</span>][<span class="charliteral">&#39;i&#39;</span>] AS $copt) {
<a name="l06216"></a>06216                     $annots .= intval($copt).<span class="charliteral">&#39; &#39;</span>;
<a name="l06217"></a>06217                   }
<a name="l06218"></a>06218                   $annots .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l06219"></a>06219                 }
<a name="l06220"></a>06220                 <span class="keywordflow">break</span>;
<a name="l06221"></a>06221               }
<a name="l06222"></a>06222               <span class="keywordflow">case</span> <span class="stringliteral">&#39;screen&#39;</span>: {
<a name="l06223"></a>06223                 <span class="keywordflow">break</span>;
<a name="l06224"></a>06224               }
<a name="l06225"></a>06225               <span class="keywordflow">case</span> <span class="stringliteral">&#39;printermark&#39;</span>: {
<a name="l06226"></a>06226                 <span class="keywordflow">break</span>;
<a name="l06227"></a>06227               }
<a name="l06228"></a>06228               <span class="keywordflow">case</span> <span class="stringliteral">&#39;trapnet&#39;</span>: {
<a name="l06229"></a>06229                 <span class="keywordflow">break</span>;
<a name="l06230"></a>06230               }
<a name="l06231"></a>06231               <span class="keywordflow">case</span> <span class="stringliteral">&#39;watermark&#39;</span>: {
<a name="l06232"></a>06232                 <span class="keywordflow">break</span>;
<a name="l06233"></a>06233               }
<a name="l06234"></a>06234               <span class="keywordflow">case</span> <span class="stringliteral">&#39;3d&#39;</span>: {
<a name="l06235"></a>06235                 <span class="keywordflow">break</span>;
<a name="l06236"></a>06236               }
<a name="l06237"></a>06237               <span class="keywordflow">default</span>: {
<a name="l06238"></a>06238                 <span class="keywordflow">break</span>;
<a name="l06239"></a>06239               }
<a name="l06240"></a>06240             }
<a name="l06241"></a>06241             $annots .= <span class="stringliteral">&#39;&gt;&gt;&#39;</span>;
<a name="l06242"></a>06242             <span class="comment">// create new annotation object</span>
<a name="l06243"></a>06243             ++$this-&gt;annot_obj_id;
<a name="l06244"></a>06244             $this-&gt;offsets[$this-&gt;annot_obj_id] = $this-&gt;bufferlen;
<a name="l06245"></a>06245             $this-&gt;_out($this-&gt;annot_obj_id.<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l06246"></a>06246             $this-&gt;_out($annots);
<a name="l06247"></a>06247             $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06248"></a>06248             <span class="keywordflow">if</span> ($formfield AND ! isset($this-&gt;radiobutton_groups[$n][$pl[<span class="stringliteral">&#39;txt&#39;</span>]])) {
<a name="l06249"></a>06249               <span class="comment">// store reference of form object</span>
<a name="l06250"></a>06250               $this-&gt;form_obj_id[] = $this-&gt;annot_obj_id;
<a name="l06251"></a>06251             }
<a name="l06252"></a>06252           }
<a name="l06253"></a>06253         }
<a name="l06254"></a>06254       } <span class="comment">// end for each page</span>
<a name="l06255"></a>06255     }
<a name="l06256"></a>06256 
<a name="l06266"></a>06266     <span class="keyword">protected</span> function _putAPXObject($w=0, $h=0, $stream=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l06267"></a>06267       $stream = trim($stream);
<a name="l06268"></a>06268       ++$this-&gt;apxo_obj_id;
<a name="l06269"></a>06269       $this-&gt;offsets[$this-&gt;apxo_obj_id] = $this-&gt;bufferlen;
<a name="l06270"></a>06270       $this-&gt;_out($this-&gt;apxo_obj_id.<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l06271"></a>06271       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l06272"></a>06272       $this-&gt;_out(<span class="stringliteral">&#39;/Type /XObject&#39;</span>);
<a name="l06273"></a>06273       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Form&#39;</span>);
<a name="l06274"></a>06274       $this-&gt;_out(<span class="stringliteral">&#39;/FormType 1&#39;</span>);
<a name="l06275"></a>06275       <span class="keywordflow">if</span> ($this-&gt;compress) {
<a name="l06276"></a>06276         $stream = gzcompress($stream);
<a name="l06277"></a>06277         $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l06278"></a>06278       }
<a name="l06279"></a>06279       $rect = sprintf(<span class="stringliteral">&#39;%.2F %.2F&#39;</span>, $w, $h);
<a name="l06280"></a>06280       $this-&gt;_out(<span class="stringliteral">&#39;/BBox [0 0 &#39;</span>.$rect.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06281"></a>06281       $this-&gt;_out(<span class="stringliteral">&#39;/Matrix [1 0 0 1 0 0]&#39;</span>);
<a name="l06282"></a>06282       $this-&gt;_out(<span class="stringliteral">&#39;/Resources &lt;&lt;/ProcSet [/PDF]&gt;&gt;&#39;</span>);
<a name="l06283"></a>06283       $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($stream));
<a name="l06284"></a>06284       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06285"></a>06285       $this-&gt;_putstream($stream);
<a name="l06286"></a>06286       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06287"></a>06287       <span class="keywordflow">return</span> $this-&gt;apxo_obj_id;
<a name="l06288"></a>06288     }
<a name="l06289"></a>06289 
<a name="l06294"></a>06294     <span class="keyword">protected</span> function _putfonts() {
<a name="l06295"></a>06295       $nf = $this-&gt;n;
<a name="l06296"></a>06296       <span class="keywordflow">foreach</span> ($this-&gt;diffs as $diff) {
<a name="l06297"></a>06297         <span class="comment">//Encodings</span>
<a name="l06298"></a>06298         $this-&gt;_newobj();
<a name="l06299"></a>06299         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Encoding /BaseEncoding /WinAnsiEncoding /Differences [&#39;</span>.$diff.<span class="stringliteral">&#39;]&gt;&gt;&#39;</span>);
<a name="l06300"></a>06300         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06301"></a>06301       }
<a name="l06302"></a>06302       $mqr = $this-&gt;get_mqr();
<a name="l06303"></a>06303       $this-&gt;set_mqr(<span class="keyword">false</span>);
<a name="l06304"></a>06304       <span class="keywordflow">foreach</span> ($this-&gt;FontFiles as $file =&gt; $info) {
<a name="l06305"></a>06305         <span class="comment">// search and get font file to embedd</span>
<a name="l06306"></a>06306         $fontdir = $info[<span class="stringliteral">&#39;fontdir&#39;</span>];
<a name="l06307"></a>06307         $file = strtolower($file);
<a name="l06308"></a>06308         $fontfile = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06309"></a>06309         <span class="comment">// search files on various directories</span>
<a name="l06310"></a>06310         <span class="keywordflow">if</span> (file_exists($fontdir.$file)) {
<a name="l06311"></a>06311           $fontfile = $fontdir.$file;
<a name="l06312"></a>06312         } elseif (file_exists($this-&gt;_getfontpath().$file)) {
<a name="l06313"></a>06313           $fontfile = $this-&gt;_getfontpath().$file;
<a name="l06314"></a>06314         } elseif (file_exists($file)) {
<a name="l06315"></a>06315           $fontfile = $file;
<a name="l06316"></a>06316         }
<a name="l06317"></a>06317         <span class="keywordflow">if</span> (!$this-&gt;empty_string($fontfile)) {
<a name="l06318"></a>06318           $font = file_get_contents($fontfile);
<a name="l06319"></a>06319           $compressed = (substr($file, -2) == <span class="stringliteral">&#39;.z&#39;</span>);
<a name="l06320"></a>06320           <span class="keywordflow">if</span> ((!$compressed) AND (isset($info[<span class="stringliteral">&#39;length2&#39;</span>]))) {
<a name="l06321"></a>06321             $header = (ord($font{0}) == 128);
<a name="l06322"></a>06322             <span class="keywordflow">if</span> ($header) {
<a name="l06323"></a>06323               <span class="comment">//Strip first binary header</span>
<a name="l06324"></a>06324               $font = substr($font, 6);
<a name="l06325"></a>06325             }
<a name="l06326"></a>06326             <span class="keywordflow">if</span> ($header AND (ord($font{$info[<span class="stringliteral">&#39;length1&#39;</span>]}) == 128)) {
<a name="l06327"></a>06327               <span class="comment">//Strip second binary header</span>
<a name="l06328"></a>06328               $font = substr($font, 0, $info[<span class="stringliteral">&#39;length1&#39;</span>]).substr($font, ($info[<span class="stringliteral">&#39;length1&#39;</span>] + 6));
<a name="l06329"></a>06329             }
<a name="l06330"></a>06330           }
<a name="l06331"></a>06331           $this-&gt;_newobj();
<a name="l06332"></a>06332           $this-&gt;FontFiles[$file][<span class="charliteral">&#39;n&#39;</span>] = $this-&gt;n;
<a name="l06333"></a>06333           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.strlen($font));
<a name="l06334"></a>06334           <span class="keywordflow">if</span> ($compressed) {
<a name="l06335"></a>06335             $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l06336"></a>06336           }
<a name="l06337"></a>06337           $this-&gt;_out(<span class="stringliteral">&#39;/Length1 &#39;</span>.$info[<span class="stringliteral">&#39;length1&#39;</span>]);
<a name="l06338"></a>06338           <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;length2&#39;</span>])) {
<a name="l06339"></a>06339             $this-&gt;_out(<span class="stringliteral">&#39;/Length2 &#39;</span>.$info[<span class="stringliteral">&#39;length2&#39;</span>].<span class="stringliteral">&#39; /Length3 0&#39;</span>);
<a name="l06340"></a>06340           }
<a name="l06341"></a>06341           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06342"></a>06342           $this-&gt;_putstream($font);
<a name="l06343"></a>06343           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06344"></a>06344         }
<a name="l06345"></a>06345       }
<a name="l06346"></a>06346       $this-&gt;set_mqr($mqr);
<a name="l06347"></a>06347       <span class="keywordflow">foreach</span> ($this-&gt;fontkeys as $k) {
<a name="l06348"></a>06348         <span class="comment">//Font objects</span>
<a name="l06349"></a>06349         $this-&gt;setFontSubBuffer($k, <span class="charliteral">&#39;n&#39;</span>, $this-&gt;n + 1);
<a name="l06350"></a>06350         $font = $this-&gt;getFontBuffer($k);
<a name="l06351"></a>06351         $type = $font[<span class="stringliteral">&#39;type&#39;</span>];
<a name="l06352"></a>06352         $name = $font[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l06353"></a>06353         <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;core&#39;</span>) {
<a name="l06354"></a>06354           <span class="comment">//Standard font</span>
<a name="l06355"></a>06355           $obj_id = $this-&gt;_newobj();
<a name="l06356"></a>06356           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06357"></a>06357           $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type1&#39;</span>);
<a name="l06358"></a>06358           $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$name);
<a name="l06359"></a>06359           $this-&gt;_out(<span class="stringliteral">&#39;/Name /F&#39;</span>.$font[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l06360"></a>06360           <span class="keywordflow">if</span> ((strtolower($name) != <span class="stringliteral">&#39;symbol&#39;</span>) AND (strtolower($name) != <span class="stringliteral">&#39;zapfdingbats&#39;</span>)) {
<a name="l06361"></a>06361             $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /WinAnsiEncoding&#39;</span>);
<a name="l06362"></a>06362           }
<a name="l06363"></a>06363           <span class="keywordflow">if</span> (strtolower($name) == <span class="stringliteral">&#39;helvetica&#39;</span>) {
<a name="l06364"></a>06364             <span class="comment">// add default font for annotations</span>
<a name="l06365"></a>06365             $this-&gt;annotation_fonts[<span class="stringliteral">&#39;helvetica&#39;</span>] = $k;
<a name="l06366"></a>06366           }
<a name="l06367"></a>06367           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06368"></a>06368           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06369"></a>06369         } elseif (($type == <span class="stringliteral">&#39;Type1&#39;</span>) OR ($type == <span class="stringliteral">&#39;TrueType&#39;</span>)) {
<a name="l06370"></a>06370           <span class="comment">//Additional Type1 or TrueType font</span>
<a name="l06371"></a>06371           $obj_id = $this-&gt;_newobj();
<a name="l06372"></a>06372           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06373"></a>06373           $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /&#39;</span>.$type);
<a name="l06374"></a>06374           $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$name);
<a name="l06375"></a>06375           $this-&gt;_out(<span class="stringliteral">&#39;/Name /F&#39;</span>.$font[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l06376"></a>06376           $this-&gt;_out(<span class="stringliteral">&#39;/FirstChar 32 /LastChar 255&#39;</span>);
<a name="l06377"></a>06377           $this-&gt;_out(<span class="stringliteral">&#39;/Widths &#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06378"></a>06378           $this-&gt;_out(<span class="stringliteral">&#39;/FontDescriptor &#39;</span>.($this-&gt;n + 2).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06379"></a>06379           <span class="keywordflow">if</span> ($font[<span class="stringliteral">&#39;enc&#39;</span>]) {
<a name="l06380"></a>06380             <span class="keywordflow">if</span> (isset($font[<span class="stringliteral">&#39;diff&#39;</span>])) {
<a name="l06381"></a>06381               $this-&gt;_out(<span class="stringliteral">&#39;/Encoding &#39;</span>.($nf + $font[<span class="stringliteral">&#39;diff&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06382"></a>06382             } <span class="keywordflow">else</span> {
<a name="l06383"></a>06383               $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /WinAnsiEncoding&#39;</span>);
<a name="l06384"></a>06384             }
<a name="l06385"></a>06385           }
<a name="l06386"></a>06386           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06387"></a>06387           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06388"></a>06388           <span class="comment">// Widths</span>
<a name="l06389"></a>06389           $this-&gt;_newobj();
<a name="l06390"></a>06390           $cw = &amp;$font[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l06391"></a>06391           $s = <span class="charliteral">&#39;[&#39;</span>;
<a name="l06392"></a>06392           <span class="keywordflow">for</span> ($i = 32; $i &lt; 256; ++$i) {
<a name="l06393"></a>06393             $s .= $cw[$i].<span class="charliteral">&#39; &#39;</span>;
<a name="l06394"></a>06394           }
<a name="l06395"></a>06395           $this-&gt;_out($s.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06396"></a>06396           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06397"></a>06397           <span class="comment">//Descriptor</span>
<a name="l06398"></a>06398           $this-&gt;_newobj();
<a name="l06399"></a>06399           $s = <span class="stringliteral">&#39;&lt;&lt;/Type /FontDescriptor /FontName /&#39;</span>.$name;
<a name="l06400"></a>06400           <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;desc&#39;</span>] as $fdk =&gt; $fdv) {
<a name="l06401"></a>06401             $s .= <span class="stringliteral">&#39; /&#39;</span>.$fdk.<span class="charliteral">&#39; &#39;</span>.$fdv.<span class="stringliteral">&#39;&#39;</span>;
<a name="l06402"></a>06402           }
<a name="l06403"></a>06403           <span class="keywordflow">if</span> (!$this-&gt;empty_string($font[<span class="stringliteral">&#39;file&#39;</span>])) {
<a name="l06404"></a>06404             $s .= <span class="stringliteral">&#39; /FontFile&#39;</span>.($type == <span class="stringliteral">&#39;Type1&#39;</span> ? <span class="stringliteral">&#39;&#39;</span> : <span class="charliteral">&#39;2&#39;</span>).<span class="charliteral">&#39; &#39;</span>.$this-&gt;FontFiles[$font[<span class="stringliteral">&#39;file&#39;</span>]][<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06405"></a>06405           }
<a name="l06406"></a>06406           $this-&gt;_out($s.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06407"></a>06407           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06408"></a>06408         } <span class="keywordflow">else</span> {
<a name="l06409"></a>06409           <span class="comment">//Allow for additional types</span>
<a name="l06410"></a>06410           $mtd = <span class="stringliteral">&#39;_put&#39;</span>.strtolower($type);
<a name="l06411"></a>06411           <span class="keywordflow">if</span> (!method_exists($this, $mtd)) {
<a name="l06412"></a>06412             $this-&gt;Error(<span class="stringliteral">&#39;Unsupported font type: &#39;</span>.$type);
<a name="l06413"></a>06413           }
<a name="l06414"></a>06414           $obj_id = $this-&gt;$mtd($font);
<a name="l06415"></a>06415         }
<a name="l06416"></a>06416         <span class="comment">// store object ID for current font</span>
<a name="l06417"></a>06417         $this-&gt;font_obj_ids[$k] = $obj_id;
<a name="l06418"></a>06418       }
<a name="l06419"></a>06419     }
<a name="l06420"></a>06420     
<a name="l06429"></a>06429     <span class="keyword">protected</span> function _putfontwidths($font, $cidoffset=0) {
<a name="l06430"></a>06430       ksort($font[<span class="stringliteral">&#39;cw&#39;</span>]);
<a name="l06431"></a>06431       $rangeid = 0;
<a name="l06432"></a>06432       $range = array();
<a name="l06433"></a>06433       $prevcid = -2;
<a name="l06434"></a>06434       $prevwidth = -1;
<a name="l06435"></a>06435       $interval = <span class="keyword">false</span>;
<a name="l06436"></a>06436       <span class="comment">// for each character</span>
<a name="l06437"></a>06437       <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;cw&#39;</span>] as $cid =&gt; $width) {
<a name="l06438"></a>06438         $cid -= $cidoffset;
<a name="l06439"></a>06439         <span class="keywordflow">if</span> ($width != $font[<span class="stringliteral">&#39;dw&#39;</span>]) {
<a name="l06440"></a>06440           <span class="keywordflow">if</span> ($cid == ($prevcid + 1)) {
<a name="l06441"></a>06441             <span class="comment">// consecutive CID</span>
<a name="l06442"></a>06442             <span class="keywordflow">if</span> ($width == $prevwidth) {
<a name="l06443"></a>06443               <span class="keywordflow">if</span> ($width == $range[$rangeid][0]) {
<a name="l06444"></a>06444                 $range[$rangeid][] = $width;
<a name="l06445"></a>06445               } <span class="keywordflow">else</span> {
<a name="l06446"></a>06446                 array_pop($range[$rangeid]);
<a name="l06447"></a>06447                 <span class="comment">// new range</span>
<a name="l06448"></a>06448                 $rangeid = $prevcid;
<a name="l06449"></a>06449                 $range[$rangeid] = array();
<a name="l06450"></a>06450                 $range[$rangeid][] = $prevwidth;
<a name="l06451"></a>06451                 $range[$rangeid][] = $width;
<a name="l06452"></a>06452               }
<a name="l06453"></a>06453               $interval = <span class="keyword">true</span>;
<a name="l06454"></a>06454               $range[$rangeid][<span class="stringliteral">&#39;interval&#39;</span>] = <span class="keyword">true</span>;
<a name="l06455"></a>06455             } <span class="keywordflow">else</span> {
<a name="l06456"></a>06456               <span class="keywordflow">if</span> ($interval) {
<a name="l06457"></a>06457                 <span class="comment">// new range</span>
<a name="l06458"></a>06458                 $rangeid = $cid;
<a name="l06459"></a>06459                 $range[$rangeid] = array();
<a name="l06460"></a>06460                 $range[$rangeid][] = $width;
<a name="l06461"></a>06461               } <span class="keywordflow">else</span> {
<a name="l06462"></a>06462                 $range[$rangeid][] = $width;
<a name="l06463"></a>06463               }
<a name="l06464"></a>06464               $interval = <span class="keyword">false</span>;
<a name="l06465"></a>06465             }
<a name="l06466"></a>06466           } <span class="keywordflow">else</span> {
<a name="l06467"></a>06467             <span class="comment">// new range</span>
<a name="l06468"></a>06468             $rangeid = $cid;
<a name="l06469"></a>06469             $range[$rangeid] = array();
<a name="l06470"></a>06470             $range[$rangeid][] = $width;
<a name="l06471"></a>06471             $interval = <span class="keyword">false</span>;
<a name="l06472"></a>06472           }
<a name="l06473"></a>06473           $prevcid = $cid;
<a name="l06474"></a>06474           $prevwidth = $width;
<a name="l06475"></a>06475         }
<a name="l06476"></a>06476       }
<a name="l06477"></a>06477       <span class="comment">// optimize ranges</span>
<a name="l06478"></a>06478       $prevk = -1;
<a name="l06479"></a>06479       $nextk = -1;
<a name="l06480"></a>06480       $prevint = <span class="keyword">false</span>;
<a name="l06481"></a>06481       <span class="keywordflow">foreach</span> ($range as $k =&gt; $ws) {
<a name="l06482"></a>06482         $cws = count($ws);
<a name="l06483"></a>06483         <span class="keywordflow">if</span> (($k == $nextk) AND (!$prevint) AND ((!isset($ws[<span class="stringliteral">&#39;interval&#39;</span>])) OR ($cws &lt; 4))) {
<a name="l06484"></a>06484           <span class="keywordflow">if</span> (isset($range[$k][<span class="stringliteral">&#39;interval&#39;</span>])) {
<a name="l06485"></a>06485             unset($range[$k][<span class="stringliteral">&#39;interval&#39;</span>]);
<a name="l06486"></a>06486           }
<a name="l06487"></a>06487           $range[$prevk] = array_merge($range[$prevk], $range[$k]);
<a name="l06488"></a>06488           unset($range[$k]);
<a name="l06489"></a>06489         } <span class="keywordflow">else</span> {
<a name="l06490"></a>06490           $prevk = $k;
<a name="l06491"></a>06491         }
<a name="l06492"></a>06492         $nextk = $k + $cws;
<a name="l06493"></a>06493         <span class="keywordflow">if</span> (isset($ws[<span class="stringliteral">&#39;interval&#39;</span>])) {
<a name="l06494"></a>06494           <span class="keywordflow">if</span> ($cws &gt; 3) {
<a name="l06495"></a>06495             $prevint = <span class="keyword">true</span>;
<a name="l06496"></a>06496           } <span class="keywordflow">else</span> {
<a name="l06497"></a>06497             $prevint = <span class="keyword">false</span>;
<a name="l06498"></a>06498           }
<a name="l06499"></a>06499           unset($range[$k][<span class="stringliteral">&#39;interval&#39;</span>]);
<a name="l06500"></a>06500           --$nextk;
<a name="l06501"></a>06501         } <span class="keywordflow">else</span> {
<a name="l06502"></a>06502           $prevint = <span class="keyword">false</span>;
<a name="l06503"></a>06503         }
<a name="l06504"></a>06504       }
<a name="l06505"></a>06505       <span class="comment">// output data</span>
<a name="l06506"></a>06506       $w = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06507"></a>06507       <span class="keywordflow">foreach</span> ($range as $k =&gt; $ws) {
<a name="l06508"></a>06508         <span class="keywordflow">if</span> (count(array_count_values($ws)) == 1) {
<a name="l06509"></a>06509           <span class="comment">// interval mode is more compact</span>
<a name="l06510"></a>06510           $w .= <span class="charliteral">&#39; &#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.($k + count($ws) - 1).<span class="charliteral">&#39; &#39;</span>.$ws[0];
<a name="l06511"></a>06511         } <span class="keywordflow">else</span> {
<a name="l06512"></a>06512           <span class="comment">// range mode</span>
<a name="l06513"></a>06513           $w .= <span class="charliteral">&#39; &#39;</span>.$k.<span class="stringliteral">&#39; [ &#39;</span>.implode(<span class="charliteral">&#39; &#39;</span>, $ws).<span class="stringliteral">&#39; ]&#39;</span>;
<a name="l06514"></a>06514         }
<a name="l06515"></a>06515       }
<a name="l06516"></a>06516       $this-&gt;_out(<span class="stringliteral">&#39;/W [&#39;</span>.$w.<span class="stringliteral">&#39; ]&#39;</span>);
<a name="l06517"></a>06517     }
<a name="l06518"></a>06518     
<a name="l06528"></a>06528     <span class="keyword">protected</span> function _puttruetypeunicode($font) {
<a name="l06529"></a>06529       <span class="comment">// Type0 Font</span>
<a name="l06530"></a>06530       <span class="comment">// A composite font composed of other fonts, organized hierarchically</span>
<a name="l06531"></a>06531       $obj_id = $this-&gt;_newobj();
<a name="l06532"></a>06532       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06533"></a>06533       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type0&#39;</span>);
<a name="l06534"></a>06534       $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$font[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39;&#39;</span>);
<a name="l06535"></a>06535       $this-&gt;_out(<span class="stringliteral">&#39;/Name /F&#39;</span>.$font[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l06536"></a>06536       $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /&#39;</span>.$font[<span class="stringliteral">&#39;enc&#39;</span>]);
<a name="l06537"></a>06537       $this-&gt;_out(<span class="stringliteral">&#39;/ToUnicode /Identity-H&#39;</span>);
<a name="l06538"></a>06538       $this-&gt;_out(<span class="stringliteral">&#39;/DescendantFonts [&#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R]&#39;</span>);
<a name="l06539"></a>06539       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06540"></a>06540       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06541"></a>06541       <span class="comment">// CIDFontType2</span>
<a name="l06542"></a>06542       <span class="comment">// A CIDFont whose glyph descriptions are based on TrueType font technology</span>
<a name="l06543"></a>06543       $this-&gt;_newobj();
<a name="l06544"></a>06544       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06545"></a>06545       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /CIDFontType2&#39;</span>);
<a name="l06546"></a>06546       $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$font[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39;&#39;</span>);
<a name="l06547"></a>06547       <span class="comment">// A dictionary containing entries that define the character collection of the CIDFont.</span>
<a name="l06548"></a>06548       $cidinfo = <span class="stringliteral">&#39;/Registry &#39;</span>.$this-&gt;_datastring($font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;Registry&#39;</span>]);
<a name="l06549"></a>06549       $cidinfo .= <span class="stringliteral">&#39; /Ordering &#39;</span>.$this-&gt;_datastring($font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;Ordering&#39;</span>]);
<a name="l06550"></a>06550       $cidinfo .= <span class="stringliteral">&#39; /Supplement &#39;</span>.$font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;Supplement&#39;</span>];
<a name="l06551"></a>06551       $this-&gt;_out(<span class="stringliteral">&#39;/CIDSystemInfo &lt;&lt;&#39;</span>.$cidinfo.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06552"></a>06552       $this-&gt;_out(<span class="stringliteral">&#39;/FontDescriptor &#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06553"></a>06553       $this-&gt;_out(<span class="stringliteral">&#39;/DW &#39;</span>.$font[<span class="stringliteral">&#39;dw&#39;</span>].<span class="stringliteral">&#39;&#39;</span>); <span class="comment">// default width</span>
<a name="l06554"></a>06554       $this-&gt;_putfontwidths($font, 0);
<a name="l06555"></a>06555       $this-&gt;_out(<span class="stringliteral">&#39;/CIDToGIDMap &#39;</span>.($this-&gt;n + 2).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06556"></a>06556       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06557"></a>06557       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);      
<a name="l06558"></a>06558       <span class="comment">// Font descriptor</span>
<a name="l06559"></a>06559       <span class="comment">// A font descriptor describing the CIDFont default metrics other than its glyph widths</span>
<a name="l06560"></a>06560       $this-&gt;_newobj();
<a name="l06561"></a>06561       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /FontDescriptor&#39;</span>);
<a name="l06562"></a>06562       $this-&gt;_out(<span class="stringliteral">&#39;/FontName /&#39;</span>.$font[<span class="stringliteral">&#39;name&#39;</span>]);
<a name="l06563"></a>06563       <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;desc&#39;</span>] as $key =&gt; $value) {
<a name="l06564"></a>06564         $this-&gt;_out(<span class="charliteral">&#39;/&#39;</span>.$key.<span class="charliteral">&#39; &#39;</span>.$value);
<a name="l06565"></a>06565       }
<a name="l06566"></a>06566       $fontdir = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06567"></a>06567       <span class="keywordflow">if</span> (!$this-&gt;empty_string($font[<span class="stringliteral">&#39;file&#39;</span>])) {
<a name="l06568"></a>06568         <span class="comment">// A stream containing a TrueType font</span>
<a name="l06569"></a>06569         $this-&gt;_out(<span class="stringliteral">&#39;/FontFile2 &#39;</span>.$this-&gt;FontFiles[$font[<span class="stringliteral">&#39;file&#39;</span>]][<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06570"></a>06570         $fontdir = $this-&gt;FontFiles[$font[<span class="stringliteral">&#39;file&#39;</span>]][<span class="stringliteral">&#39;fontdir&#39;</span>];
<a name="l06571"></a>06571       }
<a name="l06572"></a>06572       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06573"></a>06573       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06574"></a>06574       $this-&gt;_newobj();
<a name="l06575"></a>06575       <span class="keywordflow">if</span> (isset($font[<span class="stringliteral">&#39;ctg&#39;</span>]) AND (!$this-&gt;empty_string($font[<span class="stringliteral">&#39;ctg&#39;</span>]))) {
<a name="l06576"></a>06576         <span class="comment">// Embed CIDToGIDMap</span>
<a name="l06577"></a>06577         <span class="comment">// A specification of the mapping from CIDs to glyph indices</span>
<a name="l06578"></a>06578         <span class="comment">// search and get CTG font file to embedd</span>
<a name="l06579"></a>06579         $ctgfile = strtolower($font[<span class="stringliteral">&#39;ctg&#39;</span>]);
<a name="l06580"></a>06580         <span class="comment">// search and get ctg font file to embedd</span>
<a name="l06581"></a>06581         $fontfile = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06582"></a>06582         <span class="comment">// search files on various directories</span>
<a name="l06583"></a>06583         <span class="keywordflow">if</span> (file_exists($fontdir.$ctgfile)) {
<a name="l06584"></a>06584           $fontfile = $fontdir.$ctgfile;
<a name="l06585"></a>06585         } elseif (file_exists($this-&gt;_getfontpath().$ctgfile)) {
<a name="l06586"></a>06586           $fontfile = $this-&gt;_getfontpath().$ctgfile;
<a name="l06587"></a>06587         } elseif (file_exists($ctgfile)) {
<a name="l06588"></a>06588           $fontfile = $ctgfile;
<a name="l06589"></a>06589         }
<a name="l06590"></a>06590         <span class="keywordflow">if</span> ($this-&gt;empty_string($fontfile)) {
<a name="l06591"></a>06591           $this-&gt;Error(<span class="stringliteral">&#39;Font file not found: &#39;</span>.$ctgfile);
<a name="l06592"></a>06592         }
<a name="l06593"></a>06593         $size = filesize($fontfile);
<a name="l06594"></a>06594         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Length &#39;</span>.$size.<span class="stringliteral">&#39;&#39;</span>);
<a name="l06595"></a>06595         <span class="keywordflow">if</span> (substr($fontfile, -2) == <span class="stringliteral">&#39;.z&#39;</span>) { <span class="comment">// check file extension</span>
<a name="l06596"></a>06596           <span class="comment">// Decompresses data encoded using the public-domain </span>
<a name="l06597"></a>06597           <span class="comment">// zlib/deflate compression method, reproducing the </span>
<a name="l06598"></a>06598           <span class="comment">// original text or binary data</span>
<a name="l06599"></a>06599           $this-&gt;_out(<span class="stringliteral">&#39;/Filter /FlateDecode&#39;</span>);
<a name="l06600"></a>06600         }
<a name="l06601"></a>06601         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06602"></a>06602         $this-&gt;_putstream(file_get_contents($fontfile));
<a name="l06603"></a>06603       }
<a name="l06604"></a>06604       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06605"></a>06605       <span class="keywordflow">return</span> $obj_id;
<a name="l06606"></a>06606     }
<a name="l06607"></a>06607     
<a name="l06617"></a>06617     <span class="keyword">protected</span> function _putcidfont0($font) {
<a name="l06618"></a>06618       $cidoffset = 0;
<a name="l06619"></a>06619       <span class="keywordflow">if</span> (!isset($font[<span class="stringliteral">&#39;cw&#39;</span>][1])) {
<a name="l06620"></a>06620         $cidoffset = 31;
<a name="l06621"></a>06621       }
<a name="l06622"></a>06622       <span class="keywordflow">if</span> (isset($font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;uni2cid&#39;</span>])) {
<a name="l06623"></a>06623         <span class="comment">// convert unicode to cid.</span>
<a name="l06624"></a>06624         $uni2cid = $font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;uni2cid&#39;</span>];
<a name="l06625"></a>06625         $cw = array();
<a name="l06626"></a>06626         <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;cw&#39;</span>] as $uni =&gt; $width) {
<a name="l06627"></a>06627           <span class="keywordflow">if</span> (isset($uni2cid[$uni])) {
<a name="l06628"></a>06628             $cw[($uni2cid[$uni] + $cidoffset)] = $width;
<a name="l06629"></a>06629           } elseif ($uni &lt; 256) {
<a name="l06630"></a>06630             $cw[$uni] = $width;
<a name="l06631"></a>06631           } <span class="comment">// else unknown character</span>
<a name="l06632"></a>06632         }
<a name="l06633"></a>06633         $font = array_merge($font, array(<span class="stringliteral">&#39;cw&#39;</span> =&gt; $cw));
<a name="l06634"></a>06634       }
<a name="l06635"></a>06635       $name = $font[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l06636"></a>06636       $enc = $font[<span class="stringliteral">&#39;enc&#39;</span>];
<a name="l06637"></a>06637       <span class="keywordflow">if</span> ($enc) {
<a name="l06638"></a>06638         $longname = $name.<span class="charliteral">&#39;-&#39;</span>.$enc;
<a name="l06639"></a>06639       } <span class="keywordflow">else</span> {
<a name="l06640"></a>06640         $longname = $name;
<a name="l06641"></a>06641       }
<a name="l06642"></a>06642       $obj_id = $this-&gt;_newobj();
<a name="l06643"></a>06643       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06644"></a>06644       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Type0&#39;</span>);
<a name="l06645"></a>06645       $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$longname);
<a name="l06646"></a>06646       $this-&gt;_out(<span class="stringliteral">&#39;/Name /F&#39;</span>.$font[<span class="charliteral">&#39;i&#39;</span>]);
<a name="l06647"></a>06647       <span class="keywordflow">if</span> ($enc) {
<a name="l06648"></a>06648         $this-&gt;_out(<span class="stringliteral">&#39;/Encoding /&#39;</span>.$enc);
<a name="l06649"></a>06649       }
<a name="l06650"></a>06650       $this-&gt;_out(<span class="stringliteral">&#39;/DescendantFonts [&#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R]&#39;</span>);
<a name="l06651"></a>06651       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06652"></a>06652       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06653"></a>06653       $this-&gt;_newobj();
<a name="l06654"></a>06654       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Font&#39;</span>);
<a name="l06655"></a>06655       $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /CIDFontType0&#39;</span>);
<a name="l06656"></a>06656       $this-&gt;_out(<span class="stringliteral">&#39;/BaseFont /&#39;</span>.$name);
<a name="l06657"></a>06657       $cidinfo = <span class="stringliteral">&#39;/Registry &#39;</span>.$this-&gt;_datastring($font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;Registry&#39;</span>]);
<a name="l06658"></a>06658       $cidinfo .= <span class="stringliteral">&#39; /Ordering &#39;</span>.$this-&gt;_datastring($font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;Ordering&#39;</span>]);
<a name="l06659"></a>06659       $cidinfo .= <span class="stringliteral">&#39; /Supplement &#39;</span>.$font[<span class="stringliteral">&#39;cidinfo&#39;</span>][<span class="stringliteral">&#39;Supplement&#39;</span>];
<a name="l06660"></a>06660       $this-&gt;_out(<span class="stringliteral">&#39;/CIDSystemInfo &lt;&lt;&#39;</span>.$cidinfo.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06661"></a>06661       $this-&gt;_out(<span class="stringliteral">&#39;/FontDescriptor &#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06662"></a>06662       $this-&gt;_out(<span class="stringliteral">&#39;/DW &#39;</span>.$font[<span class="stringliteral">&#39;dw&#39;</span>]);
<a name="l06663"></a>06663       $this-&gt;_putfontwidths($font, $cidoffset);
<a name="l06664"></a>06664       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06665"></a>06665       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06666"></a>06666       $this-&gt;_newobj();
<a name="l06667"></a>06667       $s = <span class="stringliteral">&#39;&lt;&lt;/Type /FontDescriptor /FontName /&#39;</span>.$name;
<a name="l06668"></a>06668       <span class="keywordflow">foreach</span> ($font[<span class="stringliteral">&#39;desc&#39;</span>] as $k =&gt; $v) {
<a name="l06669"></a>06669         <span class="keywordflow">if</span> ($k != <span class="stringliteral">&#39;Style&#39;</span>) {
<a name="l06670"></a>06670           $s .= <span class="stringliteral">&#39; /&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$v.<span class="stringliteral">&#39;&#39;</span>;
<a name="l06671"></a>06671         }
<a name="l06672"></a>06672       }
<a name="l06673"></a>06673       $this-&gt;_out($s.<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06674"></a>06674       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06675"></a>06675       <span class="keywordflow">return</span> $obj_id;
<a name="l06676"></a>06676     }
<a name="l06677"></a>06677 
<a name="l06682"></a>06682     <span class="keyword">protected</span> function _putimages() {
<a name="l06683"></a>06683       $filter = ($this-&gt;compress) ? <span class="stringliteral">&#39;/Filter /FlateDecode &#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l06684"></a>06684       <span class="keywordflow">foreach</span> ($this-&gt;imagekeys as $file) {
<a name="l06685"></a>06685         $info = $this-&gt;getImageBuffer($file);
<a name="l06686"></a>06686         $this-&gt;_newobj();
<a name="l06687"></a>06687         $this-&gt;setImageSubBuffer($file, <span class="charliteral">&#39;n&#39;</span>, $this-&gt;n);
<a name="l06688"></a>06688         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /XObject&#39;</span>);
<a name="l06689"></a>06689         $this-&gt;_out(<span class="stringliteral">&#39;/Subtype /Image&#39;</span>);
<a name="l06690"></a>06690         $this-&gt;_out(<span class="stringliteral">&#39;/Width &#39;</span>.$info[<span class="charliteral">&#39;w&#39;</span>]);
<a name="l06691"></a>06691         $this-&gt;_out(<span class="stringliteral">&#39;/Height &#39;</span>.$info[<span class="charliteral">&#39;h&#39;</span>]);
<a name="l06692"></a>06692         <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;masked&#39;</span>])) {
<a name="l06693"></a>06693           $this-&gt;_out(<span class="stringliteral">&#39;/SMask &#39;</span>.($this-&gt;n - 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06694"></a>06694         }
<a name="l06695"></a>06695         <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;cs&#39;</span>] == <span class="stringliteral">&#39;Indexed&#39;</span>) {
<a name="l06696"></a>06696           $this-&gt;_out(<span class="stringliteral">&#39;/ColorSpace [/Indexed /DeviceRGB &#39;</span>.((strlen($info[<span class="stringliteral">&#39;pal&#39;</span>]) / 3) - 1).<span class="charliteral">&#39; &#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R]&#39;</span>);
<a name="l06697"></a>06697         } <span class="keywordflow">else</span> {
<a name="l06698"></a>06698           $this-&gt;_out(<span class="stringliteral">&#39;/ColorSpace /&#39;</span>.$info[<span class="stringliteral">&#39;cs&#39;</span>]);
<a name="l06699"></a>06699           <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;cs&#39;</span>] == <span class="stringliteral">&#39;DeviceCMYK&#39;</span>) {
<a name="l06700"></a>06700             $this-&gt;_out(<span class="stringliteral">&#39;/Decode [1 0 1 0 1 0 1 0]&#39;</span>);
<a name="l06701"></a>06701           }
<a name="l06702"></a>06702         }
<a name="l06703"></a>06703         $this-&gt;_out(<span class="stringliteral">&#39;/BitsPerComponent &#39;</span>.$info[<span class="stringliteral">&#39;bpc&#39;</span>]);
<a name="l06704"></a>06704         <span class="keywordflow">if</span> (isset($info[<span class="charliteral">&#39;f&#39;</span>])) {
<a name="l06705"></a>06705           $this-&gt;_out(<span class="stringliteral">&#39;/Filter /&#39;</span>.$info[<span class="charliteral">&#39;f&#39;</span>]);
<a name="l06706"></a>06706         }
<a name="l06707"></a>06707         <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;parms&#39;</span>])) {
<a name="l06708"></a>06708           $this-&gt;_out($info[<span class="stringliteral">&#39;parms&#39;</span>]);
<a name="l06709"></a>06709         }
<a name="l06710"></a>06710         <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;trns&#39;</span>]) AND is_array($info[<span class="stringliteral">&#39;trns&#39;</span>])) {
<a name="l06711"></a>06711           $trns=<span class="stringliteral">&#39;&#39;</span>;
<a name="l06712"></a>06712           $count_info = count($info[<span class="stringliteral">&#39;trns&#39;</span>]);
<a name="l06713"></a>06713           <span class="keywordflow">for</span> ($i=0; $i &lt; $count_info; ++$i) {
<a name="l06714"></a>06714             $trns .= $info[<span class="stringliteral">&#39;trns&#39;</span>][$i].<span class="charliteral">&#39; &#39;</span>.$info[<span class="stringliteral">&#39;trns&#39;</span>][$i].<span class="charliteral">&#39; &#39;</span>;
<a name="l06715"></a>06715           }
<a name="l06716"></a>06716           $this-&gt;_out(<span class="stringliteral">&#39;/Mask [&#39;</span>.$trns.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06717"></a>06717         }
<a name="l06718"></a>06718         $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($info[<span class="stringliteral">&#39;data&#39;</span>]).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06719"></a>06719         $this-&gt;_putstream($info[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l06720"></a>06720         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06721"></a>06721         <span class="comment">//Palette</span>
<a name="l06722"></a>06722         <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;cs&#39;</span>] == <span class="stringliteral">&#39;Indexed&#39;</span>) {
<a name="l06723"></a>06723           $this-&gt;_newobj();
<a name="l06724"></a>06724           $pal = ($this-&gt;compress) ? gzcompress($info[<span class="stringliteral">&#39;pal&#39;</span>]) : $info[<span class="stringliteral">&#39;pal&#39;</span>];
<a name="l06725"></a>06725           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>.$filter.<span class="stringliteral">&#39;/Length &#39;</span>.strlen($pal).<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06726"></a>06726           $this-&gt;_putstream($pal);
<a name="l06727"></a>06727           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06728"></a>06728         }
<a name="l06729"></a>06729       }
<a name="l06730"></a>06730     }
<a name="l06731"></a>06731 
<a name="l06737"></a>06737     <span class="keyword">protected</span> function _putspotcolors() {
<a name="l06738"></a>06738       <span class="keywordflow">foreach</span> ($this-&gt;spot_colors as $name =&gt; $color) {
<a name="l06739"></a>06739         $this-&gt;_newobj();
<a name="l06740"></a>06740         $this-&gt;spot_colors[$name][<span class="charliteral">&#39;n&#39;</span>] = $this-&gt;n;
<a name="l06741"></a>06741         $this-&gt;_out(<span class="stringliteral">&#39;[/Separation /&#39;</span>.str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;#20&#39;</span>, $name));
<a name="l06742"></a>06742         $this-&gt;_out(<span class="stringliteral">&#39;/DeviceCMYK &lt;&lt;&#39;</span>);
<a name="l06743"></a>06743         $this-&gt;_out(<span class="stringliteral">&#39;/Range [0 1 0 1 0 1 0 1] /C0 [0 0 0 0] &#39;</span>);
<a name="l06744"></a>06744         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/C1 [%.4F %.4F %.4F %.4F] &#39;</span>, $color[<span class="charliteral">&#39;c&#39;</span>]/100, $color[<span class="charliteral">&#39;m&#39;</span>]/100, $color[<span class="charliteral">&#39;y&#39;</span>]/100, $color[<span class="charliteral">&#39;k&#39;</span>]/100));
<a name="l06745"></a>06745         $this-&gt;_out(<span class="stringliteral">&#39;/FunctionType 2 /Domain [0 1] /N 1&gt;&gt;]&#39;</span>);
<a name="l06746"></a>06746         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06747"></a>06747       }
<a name="l06748"></a>06748     }
<a name="l06749"></a>06749 
<a name="l06754"></a>06754     <span class="keyword">protected</span> function _putxobjectdict() {
<a name="l06755"></a>06755       <span class="keywordflow">foreach</span> ($this-&gt;imagekeys as $file) {
<a name="l06756"></a>06756         $info = $this-&gt;getImageBuffer($file);
<a name="l06757"></a>06757         $this-&gt;_out(<span class="stringliteral">&#39;/I&#39;</span>.$info[<span class="charliteral">&#39;i&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$info[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06758"></a>06758       }
<a name="l06759"></a>06759     }
<a name="l06760"></a>06760 
<a name="l06765"></a>06765     <span class="keyword">protected</span> function _putresourcedict() {
<a name="l06766"></a>06766       $this-&gt;_out(<span class="stringliteral">&#39;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&#39;</span>);
<a name="l06767"></a>06767       $this-&gt;_out(<span class="stringliteral">&#39;/Font &lt;&lt;&#39;</span>);
<a name="l06768"></a>06768       <span class="keywordflow">foreach</span> ($this-&gt;fontkeys as $fontkey) {
<a name="l06769"></a>06769         $font = $this-&gt;getFontBuffer($fontkey);
<a name="l06770"></a>06770         $this-&gt;_out(<span class="stringliteral">&#39;/F&#39;</span>.$font[<span class="charliteral">&#39;i&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$font[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06771"></a>06771       }
<a name="l06772"></a>06772       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06773"></a>06773       $this-&gt;_out(<span class="stringliteral">&#39;/XObject &lt;&lt;&#39;</span>);
<a name="l06774"></a>06774       $this-&gt;_putxobjectdict();
<a name="l06775"></a>06775       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06776"></a>06776       <span class="comment">// visibility</span>
<a name="l06777"></a>06777       $this-&gt;_out(<span class="stringliteral">&#39;/Properties &lt;&lt;/OC1 &#39;</span>.$this-&gt;n_ocg_print.<span class="stringliteral">&#39; 0 R /OC2 &#39;</span>.$this-&gt;n_ocg_view.<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l06778"></a>06778       <span class="comment">// transparency</span>
<a name="l06779"></a>06779       $this-&gt;_out(<span class="stringliteral">&#39;/ExtGState &lt;&lt;&#39;</span>);
<a name="l06780"></a>06780       <span class="keywordflow">foreach</span> ($this-&gt;extgstates as $k =&gt; $extgstate) {
<a name="l06781"></a>06781         $this-&gt;_out(<span class="stringliteral">&#39;/GS&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$extgstate[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06782"></a>06782       }
<a name="l06783"></a>06783       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06784"></a>06784       <span class="comment">// gradients</span>
<a name="l06785"></a>06785       <span class="keywordflow">if</span> (isset($this-&gt;gradients) AND (count($this-&gt;gradients) &gt; 0)) {
<a name="l06786"></a>06786         $this-&gt;_out(<span class="stringliteral">&#39;/Shading &lt;&lt;&#39;</span>);
<a name="l06787"></a>06787         <span class="keywordflow">foreach</span> ($this-&gt;gradients as $id =&gt; $grad) {
<a name="l06788"></a>06788           $this-&gt;_out(<span class="stringliteral">&#39;/Sh&#39;</span>.$id.<span class="charliteral">&#39; &#39;</span>.$grad[<span class="stringliteral">&#39;id&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06789"></a>06789         }
<a name="l06790"></a>06790         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06791"></a>06791       }
<a name="l06792"></a>06792       <span class="comment">// spot colors</span>
<a name="l06793"></a>06793       <span class="keywordflow">if</span> (isset($this-&gt;spot_colors) AND (count($this-&gt;spot_colors) &gt; 0)) {
<a name="l06794"></a>06794         $this-&gt;_out(<span class="stringliteral">&#39;/ColorSpace &lt;&lt;&#39;</span>);
<a name="l06795"></a>06795         <span class="keywordflow">foreach</span> ($this-&gt;spot_colors as $color) {
<a name="l06796"></a>06796           $this-&gt;_out(<span class="stringliteral">&#39;/CS&#39;</span>.$color[<span class="charliteral">&#39;i&#39;</span>].<span class="charliteral">&#39; &#39;</span>.$color[<span class="charliteral">&#39;n&#39;</span>].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06797"></a>06797         }
<a name="l06798"></a>06798         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06799"></a>06799       }
<a name="l06800"></a>06800     }
<a name="l06801"></a>06801     
<a name="l06806"></a>06806     <span class="keyword">protected</span> function _putresources() {
<a name="l06807"></a>06807       $this-&gt;_putextgstates();
<a name="l06808"></a>06808       $this-&gt;_putocg();
<a name="l06809"></a>06809       $this-&gt;_putfonts();
<a name="l06810"></a>06810       $this-&gt;_putimages();
<a name="l06811"></a>06811       $this-&gt;_putspotcolors();
<a name="l06812"></a>06812       $this-&gt;_putshaders();
<a name="l06813"></a>06813       <span class="comment">//Resource dictionary</span>
<a name="l06814"></a>06814       $this-&gt;offsets[2] = $this-&gt;bufferlen;
<a name="l06815"></a>06815       $this-&gt;_out(<span class="stringliteral">&#39;2 0 obj&#39;</span>);
<a name="l06816"></a>06816       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l06817"></a>06817       $this-&gt;_putresourcedict();
<a name="l06818"></a>06818       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06819"></a>06819       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06820"></a>06820       $this-&gt;_putbookmarks();
<a name="l06821"></a>06821       $this-&gt;_putEmbeddedFiles();
<a name="l06822"></a>06822       $this-&gt;_putannotsobjs();
<a name="l06823"></a>06823       $this-&gt;_putjavascript();
<a name="l06824"></a>06824       <span class="comment">// encryption</span>
<a name="l06825"></a>06825       <span class="keywordflow">if</span> ($this-&gt;encrypted) {
<a name="l06826"></a>06826         $this-&gt;_newobj();
<a name="l06827"></a>06827         $this-&gt;enc_obj_id = $this-&gt;n;
<a name="l06828"></a>06828         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l06829"></a>06829         $this-&gt;_putencryption();
<a name="l06830"></a>06830         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06831"></a>06831         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l06832"></a>06832       }
<a name="l06833"></a>06833     }
<a name="l06834"></a>06834     
<a name="l06840"></a>06840     <span class="keyword">protected</span> function _putinfo() {
<a name="l06841"></a>06841       <span class="keywordflow">if</span> ($this-&gt;empty_string($this-&gt;title)) {
<a name="l06842"></a>06842         $this-&gt;title = <span class="charliteral">&#39;?&#39;</span>;
<a name="l06843"></a>06843       }
<a name="l06844"></a>06844       $this-&gt;_out(<span class="stringliteral">&#39;/Title &#39;</span>.$this-&gt;_textstring($this-&gt;title));
<a name="l06845"></a>06845       <span class="keywordflow">if</span> ($this-&gt;empty_string($this-&gt;author)) {
<a name="l06846"></a>06846         $this-&gt;author = <span class="charliteral">&#39;?&#39;</span>;
<a name="l06847"></a>06847       }
<a name="l06848"></a>06848       $this-&gt;_out(<span class="stringliteral">&#39;/Author &#39;</span>.$this-&gt;_textstring($this-&gt;author));
<a name="l06849"></a>06849       <span class="keywordflow">if</span> ($this-&gt;empty_string($this-&gt;subject)) {
<a name="l06850"></a>06850         $this-&gt;subject = <span class="charliteral">&#39;?&#39;</span>;
<a name="l06851"></a>06851       }
<a name="l06852"></a>06852       $this-&gt;_out(<span class="stringliteral">&#39;/Subject &#39;</span>.$this-&gt;_textstring($this-&gt;subject));
<a name="l06853"></a>06853       <span class="keywordflow">if</span> ($this-&gt;empty_string($this-&gt;keywords)) {
<a name="l06854"></a>06854         $this-&gt;keywords = <span class="charliteral">&#39;?&#39;</span>;
<a name="l06855"></a>06855       }
<a name="l06856"></a>06856       $this-&gt;_out(<span class="stringliteral">&#39;/Keywords &#39;</span>.$this-&gt;_textstring($this-&gt;keywords));
<a name="l06857"></a>06857       <span class="keywordflow">if</span> ($this-&gt;empty_string($this-&gt;creator)) {
<a name="l06858"></a>06858         $this-&gt;creator = <span class="charliteral">&#39;?&#39;</span>;
<a name="l06859"></a>06859       }
<a name="l06860"></a>06860       $this-&gt;_out(<span class="stringliteral">&#39;/Creator &#39;</span>.$this-&gt;_textstring($this-&gt;creator));
<a name="l06861"></a>06861       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;PDF_PRODUCER&#39;</span>)) {
<a name="l06862"></a>06862         $this-&gt;_out(<span class="stringliteral">&#39;/Producer &#39;</span>.$this-&gt;_textstring(PDF_PRODUCER));
<a name="l06863"></a>06863       } <span class="keywordflow">else</span> {
<a name="l06864"></a>06864         $this-&gt;_out(<span class="stringliteral">&#39;/Producer &#39;</span>.$this-&gt;_textstring(<span class="stringliteral">&#39;TCPDF&#39;</span>));
<a name="l06865"></a>06865       }
<a name="l06866"></a>06866       $this-&gt;_out(<span class="stringliteral">&#39;/CreationDate &#39;</span>.$this-&gt;_datestring());
<a name="l06867"></a>06867       $this-&gt;_out(<span class="stringliteral">&#39;/ModDate &#39;</span>.$this-&gt;_datestring());  
<a name="l06868"></a>06868     }
<a name="l06869"></a>06869     
<a name="l06874"></a>06874     <span class="keyword">protected</span> function _putcatalog() {
<a name="l06875"></a>06875       $this-&gt;_out(<span class="stringliteral">&#39;/Type /Catalog&#39;</span>);
<a name="l06876"></a>06876       $this-&gt;_out(<span class="stringliteral">&#39;/Pages 1 0 R&#39;</span>);
<a name="l06877"></a>06877       <span class="keywordflow">if</span> ($this-&gt;ZoomMode == <span class="stringliteral">&#39;fullpage&#39;</span>) {
<a name="l06878"></a>06878         $this-&gt;_out(<span class="stringliteral">&#39;/OpenAction [3 0 R /Fit]&#39;</span>);
<a name="l06879"></a>06879       } elseif ($this-&gt;ZoomMode == <span class="stringliteral">&#39;fullwidth&#39;</span>) {
<a name="l06880"></a>06880         $this-&gt;_out(<span class="stringliteral">&#39;/OpenAction [3 0 R /FitH null]&#39;</span>);
<a name="l06881"></a>06881       } elseif ($this-&gt;ZoomMode == <span class="stringliteral">&#39;real&#39;</span>) {
<a name="l06882"></a>06882         $this-&gt;_out(<span class="stringliteral">&#39;/OpenAction [3 0 R /XYZ null null 1]&#39;</span>);
<a name="l06883"></a>06883       } elseif (!is_string($this-&gt;ZoomMode)) {
<a name="l06884"></a>06884         $this-&gt;_out(<span class="stringliteral">&#39;/OpenAction [3 0 R /XYZ null null &#39;</span>.($this-&gt;ZoomMode / 100).<span class="charliteral">&#39;]&#39;</span>);
<a name="l06885"></a>06885       }     
<a name="l06886"></a>06886       <span class="keywordflow">if</span> (isset($this-&gt;LayoutMode) AND (!$this-&gt;empty_string($this-&gt;LayoutMode))) {
<a name="l06887"></a>06887         $this-&gt;_out(<span class="stringliteral">&#39;/PageLayout /&#39;</span>.$this-&gt;LayoutMode.<span class="stringliteral">&#39;&#39;</span>);
<a name="l06888"></a>06888       }
<a name="l06889"></a>06889       <span class="keywordflow">if</span> (isset($this-&gt;PageMode) AND (!$this-&gt;empty_string($this-&gt;PageMode))) {
<a name="l06890"></a>06890         $this-&gt;_out(<span class="stringliteral">&#39;/PageMode /&#39;</span>.$this-&gt;PageMode);
<a name="l06891"></a>06891       }
<a name="l06892"></a>06892       <span class="keywordflow">if</span> (isset($this-&gt;l[<span class="stringliteral">&#39;a_meta_language&#39;</span>])) {
<a name="l06893"></a>06893         $this-&gt;_out(<span class="stringliteral">&#39;/Lang /&#39;</span>.$this-&gt;l[<span class="stringliteral">&#39;a_meta_language&#39;</span>]);
<a name="l06894"></a>06894       }
<a name="l06895"></a>06895       $this-&gt;_out(<span class="stringliteral">&#39;/Names &lt;&lt;&#39;</span>);
<a name="l06896"></a>06896       <span class="keywordflow">if</span> ((!empty($this-&gt;javascript)) OR (!empty($this-&gt;js_objects))) {
<a name="l06897"></a>06897         $this-&gt;_out(<span class="stringliteral">&#39;/JavaScript &#39;</span>.($this-&gt;n_js).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06898"></a>06898       }
<a name="l06899"></a>06899       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);      
<a name="l06900"></a>06900       <span class="keywordflow">if</span> (count($this-&gt;outlines) &gt; 0) {
<a name="l06901"></a>06901         $this-&gt;_out(<span class="stringliteral">&#39;/Outlines &#39;</span>.$this-&gt;OutlineRoot.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06902"></a>06902         $this-&gt;_out(<span class="stringliteral">&#39;/PageMode /UseOutlines&#39;</span>);
<a name="l06903"></a>06903       }
<a name="l06904"></a>06904       $this-&gt;_putviewerpreferences();
<a name="l06905"></a>06905       $p = $this-&gt;n_ocg_print.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06906"></a>06906       $v = $this-&gt;n_ocg_view.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06907"></a>06907       $as = <span class="stringliteral">&#39;&lt;&lt;/Event /Print /OCGs [&#39;</span>.$p.<span class="charliteral">&#39; &#39;</span>.$v.<span class="stringliteral">&#39;] /Category [/Print]&gt;&gt; &lt;&lt;/Event /View /OCGs [&#39;</span>.$p.<span class="charliteral">&#39; &#39;</span>.$v.<span class="stringliteral">&#39;] /Category [/View]&gt;&gt;&#39;</span>;
<a name="l06908"></a>06908       $this-&gt;_out(<span class="stringliteral">&#39;/OCProperties &lt;&lt;/OCGs [&#39;</span>.$p.<span class="charliteral">&#39; &#39;</span>.$v.<span class="stringliteral">&#39;] /D &lt;&lt;/ON [&#39;</span>.$p.<span class="stringliteral">&#39;] /OFF [&#39;</span>.$v.<span class="stringliteral">&#39;] /AS [&#39;</span>.$as.<span class="stringliteral">&#39;]&gt;&gt;&gt;&gt;&#39;</span>);
<a name="l06909"></a>06909       <span class="comment">// AcroForm</span>
<a name="l06910"></a>06910       <span class="keywordflow">if</span> (!empty($this-&gt;form_obj_id) OR ($this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>]))) {
<a name="l06911"></a>06911         $this-&gt;_out(<span class="stringliteral">&#39;/AcroForm&lt;&lt;&#39;</span>);
<a name="l06912"></a>06912         $objrefs = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06913"></a>06913         <span class="keywordflow">if</span> ($this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>])) {
<a name="l06914"></a>06914           $objrefs .= $this-&gt;sig_obj_id.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06915"></a>06915         }
<a name="l06916"></a>06916         <span class="keywordflow">if</span> (!empty($this-&gt;form_obj_id)) {
<a name="l06917"></a>06917           <span class="keywordflow">foreach</span>($this-&gt;form_obj_id as $objid) {
<a name="l06918"></a>06918             $objrefs .= <span class="charliteral">&#39; &#39;</span>.$objid.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l06919"></a>06919           }
<a name="l06920"></a>06920         }
<a name="l06921"></a>06921         $this-&gt;_out(<span class="stringliteral">&#39;/Fields [&#39;</span>.$objrefs.<span class="charliteral">&#39;]&#39;</span>);
<a name="l06922"></a>06922         $this-&gt;_out(<span class="stringliteral">&#39;/NeedAppearances &#39;</span>.(empty($this-&gt;form_obj_id)?<span class="stringliteral">&#39;false&#39;</span>:<span class="stringliteral">&#39;true&#39;</span>));
<a name="l06923"></a>06923         <span class="keywordflow">if</span> ($this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>])) {
<a name="l06924"></a>06924           $this-&gt;_out(<span class="stringliteral">&#39;/SigFlags 3&#39;</span>);
<a name="l06925"></a>06925         }
<a name="l06926"></a>06926         <span class="comment">//$this-&gt;_out(&#39;/CO &#39;);</span>
<a name="l06927"></a>06927         <span class="keywordflow">if</span> (isset($this-&gt;annotation_fonts) AND !empty($this-&gt;annotation_fonts)) {
<a name="l06928"></a>06928           $this-&gt;_out(<span class="stringliteral">&#39;/DR &lt;&lt;&#39;</span>);
<a name="l06929"></a>06929           $this-&gt;_out(<span class="stringliteral">&#39;/Font &lt;&lt;&#39;</span>);
<a name="l06930"></a>06930           <span class="keywordflow">foreach</span> ($this-&gt;annotation_fonts as $font =&gt; $fontkey) {
<a name="l06931"></a>06931             $this-&gt;_out(<span class="stringliteral">&#39;/F&#39;</span>.($fontkey + 1).<span class="charliteral">&#39; &#39;</span>.$this-&gt;font_obj_ids[$font].<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l06932"></a>06932           }
<a name="l06933"></a>06933           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06934"></a>06934           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06935"></a>06935         }
<a name="l06936"></a>06936         $this-&gt;_out(<span class="stringliteral">&#39;/DA (/F&#39;</span>.(array_search(<span class="stringliteral">&#39;helvetica&#39;</span>, $this-&gt;fontkeys) + 1).<span class="stringliteral">&#39; 0 Tf 0 g)&#39;</span>);
<a name="l06937"></a>06937         $this-&gt;_out(<span class="stringliteral">&#39;/Q &#39;</span>.(($this-&gt;rtl)?<span class="charliteral">&#39;2&#39;</span>:<span class="charliteral">&#39;0&#39;</span>));
<a name="l06938"></a>06938         <span class="comment">//$this-&gt;_out(&#39;/XFA &#39;);</span>
<a name="l06939"></a>06939         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l06940"></a>06940         <span class="comment">// signatures</span>
<a name="l06941"></a>06941         <span class="keywordflow">if</span> ($this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>])) {
<a name="l06942"></a>06942           <span class="keywordflow">if</span> ($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>] &gt; 0) {
<a name="l06943"></a>06943             $this-&gt;_out(<span class="stringliteral">&#39;/Perms&lt;&lt;/DocMDP &#39;</span>.($this-&gt;sig_obj_id + 1).<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l06944"></a>06944           } <span class="keywordflow">else</span> {
<a name="l06945"></a>06945             $this-&gt;_out(<span class="stringliteral">&#39;/Perms&lt;&lt;/UR3 &#39;</span>.($this-&gt;sig_obj_id + 1).<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l06946"></a>06946           }
<a name="l06947"></a>06947         }
<a name="l06948"></a>06948       }
<a name="l06949"></a>06949     }
<a name="l06950"></a>06950     
<a name="l06957"></a>06957     <span class="keyword">protected</span> function _putviewerpreferences() {
<a name="l06958"></a>06958       $this-&gt;_out(<span class="stringliteral">&#39;/ViewerPreferences&lt;&lt;&#39;</span>);
<a name="l06959"></a>06959       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l06960"></a>06960         $this-&gt;_out(<span class="stringliteral">&#39;/Direction /R2L&#39;</span>);
<a name="l06961"></a>06961       } <span class="keywordflow">else</span> {
<a name="l06962"></a>06962         $this-&gt;_out(<span class="stringliteral">&#39;/Direction /L2R&#39;</span>);
<a name="l06963"></a>06963       }
<a name="l06964"></a>06964       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;HideToolbar&#39;</span>]) AND ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;HideToolbar&#39;</span>])) {
<a name="l06965"></a>06965         $this-&gt;_out(<span class="stringliteral">&#39;/HideToolbar true&#39;</span>);
<a name="l06966"></a>06966       }
<a name="l06967"></a>06967       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;HideMenubar&#39;</span>]) AND ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;HideMenubar&#39;</span>])) {
<a name="l06968"></a>06968         $this-&gt;_out(<span class="stringliteral">&#39;/HideMenubar true&#39;</span>);
<a name="l06969"></a>06969       }
<a name="l06970"></a>06970       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;HideWindowUI&#39;</span>]) AND ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;HideWindowUI&#39;</span>])) {
<a name="l06971"></a>06971         $this-&gt;_out(<span class="stringliteral">&#39;/HideWindowUI true&#39;</span>);
<a name="l06972"></a>06972       }
<a name="l06973"></a>06973       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;FitWindow&#39;</span>]) AND ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;FitWindow&#39;</span>])) {
<a name="l06974"></a>06974         $this-&gt;_out(<span class="stringliteral">&#39;/FitWindow true&#39;</span>);
<a name="l06975"></a>06975       }
<a name="l06976"></a>06976       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;CenterWindow&#39;</span>]) AND ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;CenterWindow&#39;</span>])) {
<a name="l06977"></a>06977         $this-&gt;_out(<span class="stringliteral">&#39;/CenterWindow true&#39;</span>);
<a name="l06978"></a>06978       }
<a name="l06979"></a>06979       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;DisplayDocTitle&#39;</span>]) AND ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;DisplayDocTitle&#39;</span>])) {
<a name="l06980"></a>06980         $this-&gt;_out(<span class="stringliteral">&#39;/DisplayDocTitle true&#39;</span>);
<a name="l06981"></a>06981       }
<a name="l06982"></a>06982       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;NonFullScreenPageMode&#39;</span>])) {
<a name="l06983"></a>06983         $this-&gt;_out(<span class="stringliteral">&#39;/NonFullScreenPageMode /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;NonFullScreenPageMode&#39;</span>].<span class="stringliteral">&#39;&#39;</span>);
<a name="l06984"></a>06984       }
<a name="l06985"></a>06985       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;ViewArea&#39;</span>])) {
<a name="l06986"></a>06986         $this-&gt;_out(<span class="stringliteral">&#39;/ViewArea /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;ViewArea&#39;</span>]);
<a name="l06987"></a>06987       }
<a name="l06988"></a>06988       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;ViewClip&#39;</span>])) {
<a name="l06989"></a>06989         $this-&gt;_out(<span class="stringliteral">&#39;/ViewClip /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;ViewClip&#39;</span>]);
<a name="l06990"></a>06990       }
<a name="l06991"></a>06991       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintArea&#39;</span>])) {
<a name="l06992"></a>06992         $this-&gt;_out(<span class="stringliteral">&#39;/PrintArea /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintArea&#39;</span>]);
<a name="l06993"></a>06993       }
<a name="l06994"></a>06994       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintClip&#39;</span>])) {
<a name="l06995"></a>06995         $this-&gt;_out(<span class="stringliteral">&#39;/PrintClip /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintClip&#39;</span>]);
<a name="l06996"></a>06996       }
<a name="l06997"></a>06997       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintScaling&#39;</span>])) {
<a name="l06998"></a>06998         $this-&gt;_out(<span class="stringliteral">&#39;/PrintScaling /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintScaling&#39;</span>]);
<a name="l06999"></a>06999       }
<a name="l07000"></a>07000       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;Duplex&#39;</span>]) AND (!$this-&gt;empty_string($this-&gt;viewer_preferences[<span class="stringliteral">&#39;Duplex&#39;</span>]))) {
<a name="l07001"></a>07001         $this-&gt;_out(<span class="stringliteral">&#39;/Duplex /&#39;</span>.$this-&gt;viewer_preferences[<span class="stringliteral">&#39;Duplex&#39;</span>]);
<a name="l07002"></a>07002       }
<a name="l07003"></a>07003       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PickTrayByPDFSize&#39;</span>])) {
<a name="l07004"></a>07004         <span class="keywordflow">if</span> ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PickTrayByPDFSize&#39;</span>]) {
<a name="l07005"></a>07005           $this-&gt;_out(<span class="stringliteral">&#39;/PickTrayByPDFSize true&#39;</span>);
<a name="l07006"></a>07006         } <span class="keywordflow">else</span> {
<a name="l07007"></a>07007           $this-&gt;_out(<span class="stringliteral">&#39;/PickTrayByPDFSize false&#39;</span>);
<a name="l07008"></a>07008         }
<a name="l07009"></a>07009       }
<a name="l07010"></a>07010       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintPageRange&#39;</span>])) {
<a name="l07011"></a>07011         $PrintPageRangeNum = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07012"></a>07012         <span class="keywordflow">foreach</span> ($this-&gt;viewer_preferences[<span class="stringliteral">&#39;PrintPageRange&#39;</span>] as $k =&gt; $v) {
<a name="l07013"></a>07013           $PrintPageRangeNum .= <span class="charliteral">&#39; &#39;</span>.($v - 1).<span class="stringliteral">&#39;&#39;</span>;
<a name="l07014"></a>07014         }
<a name="l07015"></a>07015         $this-&gt;_out(<span class="stringliteral">&#39;/PrintPageRange [&#39;</span>.substr($PrintPageRangeNum,1).<span class="charliteral">&#39;]&#39;</span>);
<a name="l07016"></a>07016       }
<a name="l07017"></a>07017       <span class="keywordflow">if</span> (isset($this-&gt;viewer_preferences[<span class="stringliteral">&#39;NumCopies&#39;</span>])) {
<a name="l07018"></a>07018         $this-&gt;_out(<span class="stringliteral">&#39;/NumCopies &#39;</span>.intval($this-&gt;viewer_preferences[<span class="stringliteral">&#39;NumCopies&#39;</span>]));
<a name="l07019"></a>07019       }
<a name="l07020"></a>07020       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07021"></a>07021     }
<a name="l07022"></a>07022     
<a name="l07027"></a>07027     <span class="keyword">protected</span> function _puttrailer() {
<a name="l07028"></a>07028       $this-&gt;_out(<span class="stringliteral">&#39;/Size &#39;</span>.($this-&gt;n + 1));
<a name="l07029"></a>07029       $this-&gt;_out(<span class="stringliteral">&#39;/Root &#39;</span>.$this-&gt;n.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l07030"></a>07030       $this-&gt;_out(<span class="stringliteral">&#39;/Info &#39;</span>.($this-&gt;n - 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l07031"></a>07031       <span class="keywordflow">if</span> ($this-&gt;encrypted) {
<a name="l07032"></a>07032         $this-&gt;_out(<span class="stringliteral">&#39;/Encrypt &#39;</span>.$this-&gt;enc_obj_id.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l07033"></a>07033         $this-&gt;_out(<span class="stringliteral">&#39;/ID [()()]&#39;</span>);
<a name="l07034"></a>07034       }
<a name="l07035"></a>07035     }
<a name="l07036"></a>07036 
<a name="l07041"></a>07041     <span class="keyword">protected</span> function _putheader() {
<a name="l07042"></a>07042       $this-&gt;_out(<span class="stringliteral">&#39;%PDF-&#39;</span>.$this-&gt;PDFVersion);
<a name="l07043"></a>07043     }
<a name="l07044"></a>07044 
<a name="l07049"></a>07049     <span class="keyword">protected</span> function _enddoc() {
<a name="l07050"></a>07050       $this-&gt;state = 1;
<a name="l07051"></a>07051       $this-&gt;_putheader();      
<a name="l07052"></a>07052       $this-&gt;_putpages();
<a name="l07053"></a>07053       $this-&gt;_putresources();
<a name="l07054"></a>07054       <span class="comment">// Signature</span>
<a name="l07055"></a>07055       <span class="keywordflow">if</span> ($this-&gt;sign AND isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>])) {
<a name="l07056"></a>07056         <span class="comment">// widget annotation for signature</span>
<a name="l07057"></a>07057         $this-&gt;sig_obj_id = $this-&gt;_newobj();
<a name="l07058"></a>07058         <span class="comment">// --- replace signature ID on the first page ---</span>
<a name="l07059"></a>07059         <span class="comment">// get the document content</span>
<a name="l07060"></a>07060         $pdfdoc = $this-&gt;getBuffer();
<a name="l07061"></a>07061         <span class="comment">// Remove the original buffer</span>
<a name="l07062"></a>07062         <span class="keywordflow">if</span> (isset($this-&gt;diskcache) AND $this-&gt;diskcache) {
<a name="l07063"></a>07063           <span class="comment">// remove buffer file from cache</span>
<a name="l07064"></a>07064           unlink($this-&gt;buffer);
<a name="l07065"></a>07065         }
<a name="l07066"></a>07066         unset($this-&gt;buffer);
<a name="l07067"></a>07067         $signature_widget_ref = sprintf(<span class="stringliteral">&#39;%u 0 R&#39;</span>, $this-&gt;sig_obj_id);
<a name="l07068"></a>07068         $signature_widget_ref .= str_repeat(<span class="charliteral">&#39; &#39;</span>, (strlen($this-&gt;sig_annot_ref) - strlen($signature_widget_ref)));
<a name="l07069"></a>07069         $pdfdoc = str_replace($this-&gt;sig_annot_ref, $signature_widget_ref, $pdfdoc);
<a name="l07070"></a>07070         $this-&gt;diskcache = <span class="keyword">false</span>;
<a name="l07071"></a>07071         $this-&gt;buffer = &amp;$pdfdoc;
<a name="l07072"></a>07072         $this-&gt;bufferlen = strlen($pdfdoc);
<a name="l07073"></a>07073         <span class="comment">// ---</span>
<a name="l07074"></a>07074         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l07075"></a>07075         $this-&gt;_out(<span class="stringliteral">&#39;/Type /Annot /Subtype /Widget /Rect [0 0 0 0]&#39;</span>);
<a name="l07076"></a>07076         $this-&gt;_out(<span class="stringliteral">&#39;/P 3 0 R&#39;</span>); <span class="comment">// link to first page object</span>
<a name="l07077"></a>07077         $this-&gt;_out(<span class="stringliteral">&#39;/FT /Sig&#39;</span>);
<a name="l07078"></a>07078         $this-&gt;_out(<span class="stringliteral">&#39;/T &#39;</span>.$this-&gt;_textstring(<span class="stringliteral">&#39;Signature&#39;</span>));
<a name="l07079"></a>07079         $this-&gt;_out(<span class="stringliteral">&#39;/Ff 0&#39;</span>);
<a name="l07080"></a>07080         $this-&gt;_out(<span class="stringliteral">&#39;/V &#39;</span>.($this-&gt;sig_obj_id + 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l07081"></a>07081         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07082"></a>07082         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l07083"></a>07083         <span class="comment">// signature    </span>
<a name="l07084"></a>07084         $this-&gt;_newobj();
<a name="l07085"></a>07085         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l07086"></a>07086         $this-&gt;_putsignature();
<a name="l07087"></a>07087         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07088"></a>07088         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l07089"></a>07089       }
<a name="l07090"></a>07090       <span class="comment">// Info</span>
<a name="l07091"></a>07091       $this-&gt;_newobj();
<a name="l07092"></a>07092       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l07093"></a>07093       $this-&gt;_putinfo();
<a name="l07094"></a>07094       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07095"></a>07095       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l07096"></a>07096       <span class="comment">// Catalog</span>
<a name="l07097"></a>07097       $this-&gt;_newobj();
<a name="l07098"></a>07098       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l07099"></a>07099       $this-&gt;_putcatalog();
<a name="l07100"></a>07100       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07101"></a>07101       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l07102"></a>07102       <span class="comment">// Cross-ref</span>
<a name="l07103"></a>07103       $o = $this-&gt;bufferlen;
<a name="l07104"></a>07104       $this-&gt;_out(<span class="stringliteral">&#39;xref&#39;</span>);
<a name="l07105"></a>07105       $this-&gt;_out(<span class="stringliteral">&#39;0 &#39;</span>.($this-&gt;n + 1));
<a name="l07106"></a>07106       $this-&gt;_out(<span class="stringliteral">&#39;0000000000 65535 f &#39;</span>);
<a name="l07107"></a>07107       <span class="keywordflow">for</span> ($i=1; $i &lt;= $this-&gt;n; ++$i) {
<a name="l07108"></a>07108         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%010d 00000 n &#39;</span>, $this-&gt;offsets[$i]));
<a name="l07109"></a>07109       }
<a name="l07110"></a>07110       <span class="comment">// Embedded Files</span>
<a name="l07111"></a>07111       <span class="keywordflow">if</span> (isset($this-&gt;embeddedfiles) AND count($this-&gt;embeddedfiles) &gt; 0) {
<a name="l07112"></a>07112         $this-&gt;_out($this-&gt;embedded_start_obj_id.<span class="charliteral">&#39; &#39;</span>.count($this-&gt;embeddedfiles));
<a name="l07113"></a>07113         <span class="keywordflow">foreach</span> ($this-&gt;embeddedfiles as $filename =&gt; $filedata) {
<a name="l07114"></a>07114           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%010d 00000 n &#39;</span>, $this-&gt;offsets[$filedata[<span class="charliteral">&#39;n&#39;</span>]]));
<a name="l07115"></a>07115         }
<a name="l07116"></a>07116       }
<a name="l07117"></a>07117       <span class="comment">// Annotation Objects</span>
<a name="l07118"></a>07118       <span class="keywordflow">if</span> ($this-&gt;annot_obj_id &gt; $this-&gt;annots_start_obj_id) {
<a name="l07119"></a>07119         $this-&gt;_out(($this-&gt;annots_start_obj_id + 1).<span class="charliteral">&#39; &#39;</span>.($this-&gt;annot_obj_id - $this-&gt;annots_start_obj_id));
<a name="l07120"></a>07120         <span class="keywordflow">for</span> ($i = ($this-&gt;annots_start_obj_id + 1); $i &lt;= $this-&gt;annot_obj_id; ++$i) {
<a name="l07121"></a>07121           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%010d 00000 n &#39;</span>, $this-&gt;offsets[$i]));
<a name="l07122"></a>07122         }
<a name="l07123"></a>07123       }
<a name="l07124"></a>07124       <span class="comment">// Javascript Objects</span>
<a name="l07125"></a>07125       <span class="keywordflow">if</span> ($this-&gt;js_obj_id &gt; $this-&gt;js_start_obj_id) {
<a name="l07126"></a>07126         $this-&gt;_out(($this-&gt;js_start_obj_id + 1).<span class="charliteral">&#39; &#39;</span>.($this-&gt;js_obj_id - $this-&gt;js_start_obj_id));
<a name="l07127"></a>07127         <span class="keywordflow">for</span> ($i = ($this-&gt;js_start_obj_id + 1); $i &lt;= $this-&gt;js_obj_id; ++$i) {
<a name="l07128"></a>07128           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%010d 00000 n &#39;</span>, $this-&gt;offsets[$i]));
<a name="l07129"></a>07129         }
<a name="l07130"></a>07130       }
<a name="l07131"></a>07131       <span class="comment">// Appearance streams XObjects</span>
<a name="l07132"></a>07132       <span class="keywordflow">if</span> ($this-&gt;apxo_obj_id &gt; $this-&gt;apxo_start_obj_id) {
<a name="l07133"></a>07133         $this-&gt;_out(($this-&gt;apxo_start_obj_id + 1).<span class="charliteral">&#39; &#39;</span>.($this-&gt;apxo_obj_id - $this-&gt;apxo_start_obj_id));
<a name="l07134"></a>07134         <span class="keywordflow">for</span> ($i = ($this-&gt;apxo_start_obj_id + 1); $i &lt;= $this-&gt;apxo_obj_id; ++$i) {
<a name="l07135"></a>07135           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%010d 00000 n &#39;</span>, $this-&gt;offsets[$i]));
<a name="l07136"></a>07136         }
<a name="l07137"></a>07137       }
<a name="l07138"></a>07138       <span class="comment">//Trailer</span>
<a name="l07139"></a>07139       $this-&gt;_out(<span class="stringliteral">&#39;trailer&#39;</span>);
<a name="l07140"></a>07140       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l07141"></a>07141       $this-&gt;_puttrailer();
<a name="l07142"></a>07142       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l07143"></a>07143       $this-&gt;_out(<span class="stringliteral">&#39;startxref&#39;</span>);
<a name="l07144"></a>07144       $this-&gt;_out($o);
<a name="l07145"></a>07145       $this-&gt;_out(<span class="stringliteral">&#39;%%EOF&#39;</span>);
<a name="l07146"></a>07146       $this-&gt;state = 3; <span class="comment">// end-of-doc</span>
<a name="l07147"></a>07147       <span class="keywordflow">if</span> ($this-&gt;diskcache) {
<a name="l07148"></a>07148         <span class="comment">// remove temporary files used for images</span>
<a name="l07149"></a>07149         <span class="keywordflow">foreach</span> ($this-&gt;imagekeys as $key) {
<a name="l07150"></a>07150           <span class="comment">// remove temporary files</span>
<a name="l07151"></a>07151           unlink($this-&gt;images[$key]);
<a name="l07152"></a>07152         }
<a name="l07153"></a>07153         <span class="keywordflow">foreach</span> ($this-&gt;fontkeys as $key) {
<a name="l07154"></a>07154           <span class="comment">// remove temporary files</span>
<a name="l07155"></a>07155           unlink($this-&gt;fonts[$key]);
<a name="l07156"></a>07156         }
<a name="l07157"></a>07157       }
<a name="l07158"></a>07158     }
<a name="l07159"></a>07159 
<a name="l07166"></a>07166     <span class="keyword">protected</span> function _beginpage($orientation=<span class="stringliteral">&#39;&#39;</span>, $format=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l07167"></a>07167       ++$this-&gt;page;
<a name="l07168"></a>07168       $this-&gt;setPageBuffer($this-&gt;page, <span class="stringliteral">&#39;&#39;</span>);
<a name="l07169"></a>07169       <span class="comment">// initialize array for graphics tranformation positions inside a page buffer</span>
<a name="l07170"></a>07170       $this-&gt;transfmrk[$this-&gt;page] = array();
<a name="l07171"></a>07171       $this-&gt;state = 2;
<a name="l07172"></a>07172       <span class="keywordflow">if</span> ($this-&gt;empty_string($orientation)) {
<a name="l07173"></a>07173         <span class="keywordflow">if</span> (isset($this-&gt;CurOrientation)) {
<a name="l07174"></a>07174           $orientation = $this-&gt;CurOrientation;
<a name="l07175"></a>07175         } <span class="keywordflow">else</span> {
<a name="l07176"></a>07176           $orientation = <span class="charliteral">&#39;P&#39;</span>;
<a name="l07177"></a>07177         }
<a name="l07178"></a>07178       }
<a name="l07179"></a>07179       <span class="keywordflow">if</span> ($this-&gt;empty_string($format)) {
<a name="l07180"></a>07180         $this-&gt;setPageOrientation($orientation);
<a name="l07181"></a>07181       } <span class="keywordflow">else</span> {
<a name="l07182"></a>07182         $this-&gt;setPageFormat($format, $orientation);
<a name="l07183"></a>07183       }
<a name="l07184"></a>07184       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l07185"></a>07185         $this-&gt;x = $this-&gt;w - $this-&gt;rMargin;
<a name="l07186"></a>07186       } <span class="keywordflow">else</span> {
<a name="l07187"></a>07187         $this-&gt;x = $this-&gt;lMargin;
<a name="l07188"></a>07188       }
<a name="l07189"></a>07189       $this-&gt;y = $this-&gt;tMargin;
<a name="l07190"></a>07190       <span class="keywordflow">if</span> (isset($this-&gt;newpagegroup[$this-&gt;page])) {
<a name="l07191"></a>07191         <span class="comment">// start a new group</span>
<a name="l07192"></a>07192         $n = <span class="keyword">sizeof</span>($this-&gt;pagegroups) + 1;
<a name="l07193"></a>07193         $alias = <span class="stringliteral">&#39;{nb&#39;</span>.$n.<span class="charliteral">&#39;}&#39;</span>;
<a name="l07194"></a>07194         $this-&gt;pagegroups[$alias] = 1;
<a name="l07195"></a>07195         $this-&gt;currpagegroup = $alias;
<a name="l07196"></a>07196       } elseif ($this-&gt;currpagegroup) {
<a name="l07197"></a>07197         ++$this-&gt;pagegroups[$this-&gt;currpagegroup];
<a name="l07198"></a>07198       }
<a name="l07199"></a>07199     }
<a name="l07200"></a>07200 
<a name="l07205"></a>07205     <span class="keyword">protected</span> function _endpage() {
<a name="l07206"></a>07206       $this-&gt;setVisibility(<span class="stringliteral">&#39;all&#39;</span>);
<a name="l07207"></a>07207       $this-&gt;state = 1;
<a name="l07208"></a>07208     }
<a name="l07209"></a>07209 
<a name="l07215"></a>07215     <span class="keyword">protected</span> function _newobj() {
<a name="l07216"></a>07216       ++$this-&gt;n;
<a name="l07217"></a>07217       $this-&gt;offsets[$this-&gt;n] = $this-&gt;bufferlen;
<a name="l07218"></a>07218       $this-&gt;_out($this-&gt;n.<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l07219"></a>07219       <span class="keywordflow">return</span> $this-&gt;n;
<a name="l07220"></a>07220     }
<a name="l07221"></a>07221 
<a name="l07229"></a>07229     <span class="keyword">protected</span> function _dounderline($x, $y, $txt) {
<a name="l07230"></a>07230       $w = $this-&gt;GetStringWidth($txt);
<a name="l07231"></a>07231       <span class="keywordflow">return</span> $this-&gt;_dounderlinew($x, $y, $w);
<a name="l07232"></a>07232     }
<a name="l07233"></a>07233     
<a name="l07241"></a>07241     <span class="keyword">protected</span> function _dolinethrough($x, $y, $txt) {
<a name="l07242"></a>07242       $w = $this-&gt;GetStringWidth($txt);
<a name="l07243"></a>07243       <span class="keywordflow">return</span> $this-&gt;_dolinethroughw($x, $y, $w);
<a name="l07244"></a>07244     }
<a name="l07245"></a>07245 
<a name="l07254"></a>07254     <span class="keyword">protected</span> function _dounderlinew($x, $y, $w) {
<a name="l07255"></a>07255       $up = $this-&gt;CurrentFont[<span class="stringliteral">&#39;up&#39;</span>];
<a name="l07256"></a>07256       $ut = $this-&gt;CurrentFont[<span class="stringliteral">&#39;ut&#39;</span>];
<a name="l07257"></a>07257       <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F re f&#39;</span>, $x * $this-&gt;k, ($this-&gt;h - ($y - $up / 1000 * $this-&gt;FontSize)) * $this-&gt;k, $w * $this-&gt;k, -$ut / 1000 * $this-&gt;FontSizePt);
<a name="l07258"></a>07258     }
<a name="l07259"></a>07259     
<a name="l07268"></a>07268     <span class="keyword">protected</span> function _dolinethroughw($x, $y, $w) {
<a name="l07269"></a>07269       $up = $this-&gt;CurrentFont[<span class="stringliteral">&#39;up&#39;</span>];
<a name="l07270"></a>07270       $ut = $this-&gt;CurrentFont[<span class="stringliteral">&#39;ut&#39;</span>];
<a name="l07271"></a>07271       <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F re f&#39;</span>, $x * $this-&gt;k, ($this-&gt;h - ($y - ($this-&gt;FontSize/2) - $up / 1000 * $this-&gt;FontSize)) * $this-&gt;k, $w * $this-&gt;k, -$ut / 1000 * $this-&gt;FontSizePt);
<a name="l07272"></a>07272     }
<a name="l07273"></a>07273     
<a name="l07280"></a>07280     <span class="keyword">protected</span> function _freadint($f) {
<a name="l07281"></a>07281       $a = unpack(<span class="stringliteral">&#39;Ni&#39;</span>, fread($f, 4));
<a name="l07282"></a>07282       <span class="keywordflow">return</span> $a[<span class="charliteral">&#39;i&#39;</span>];
<a name="l07283"></a>07283     }
<a name="l07284"></a>07284     
<a name="l07291"></a>07291     <span class="keyword">protected</span> function _escape($s) {
<a name="l07292"></a>07292       <span class="comment">// the chr(13) substitution fixes the Bugs item #1421290.</span>
<a name="l07293"></a>07293       <span class="keywordflow">return</span> strtr($s, array(<span class="charliteral">&#39;)&#39;</span> =&gt; <span class="stringliteral">&#39;\\)&#39;</span>, <span class="charliteral">&#39;(&#39;</span> =&gt; <span class="stringliteral">&#39;\\(&#39;</span>, <span class="charliteral">&#39;\\&#39;</span> =&gt; <span class="stringliteral">&#39;\\\\&#39;</span>, chr(13) =&gt; <span class="charliteral">&#39;\r&#39;</span>));
<a name="l07294"></a>07294     }
<a name="l07295"></a>07295     
<a name="l07302"></a>07302     <span class="keyword">protected</span> function _datastring($s) {
<a name="l07303"></a>07303       <span class="keywordflow">if</span> ($this-&gt;encrypted) {
<a name="l07304"></a>07304         $s = $this-&gt;_RC4($this-&gt;_objectkey($this-&gt;n), $s);
<a name="l07305"></a>07305       }
<a name="l07306"></a>07306       <span class="keywordflow">return</span> <span class="charliteral">&#39;(&#39;</span>. $this-&gt;_escape($s).<span class="charliteral">&#39;)&#39;</span>;
<a name="l07307"></a>07307     }
<a name="l07308"></a>07308 
<a name="l07315"></a>07315     <span class="keyword">protected</span> function _datestring() {
<a name="l07316"></a>07316       $current_time = substr_replace(date(<span class="stringliteral">&#39;YmdHisO&#39;</span>), <span class="charliteral">&#39;\&#39;&#39;</span>, (0 - 2), 0).<span class="charliteral">&#39;\&#39;&#39;</span>;
<a name="l07317"></a>07317       <span class="keywordflow">return</span> $this-&gt;_datastring(<span class="stringliteral">&#39;D:&#39;</span>.$current_time);
<a name="l07318"></a>07318     }
<a name="l07319"></a>07319 
<a name="l07326"></a>07326     <span class="keyword">protected</span> function _textstring($s) {
<a name="l07327"></a>07327       <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l07328"></a>07328         <span class="comment">//Convert string to UTF-16BE</span>
<a name="l07329"></a>07329         $s = $this-&gt;UTF8ToUTF16BE($s, <span class="keyword">true</span>);
<a name="l07330"></a>07330       }
<a name="l07331"></a>07331       <span class="keywordflow">return</span> $this-&gt;_datastring($s);
<a name="l07332"></a>07332     }
<a name="l07333"></a>07333         
<a name="l07340"></a>07340     <span class="keyword">protected</span> function _escapetext($s) {
<a name="l07341"></a>07341       <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l07342"></a>07342         <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;core&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueType&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;Type1&#39;</span>)) {
<a name="l07343"></a>07343           $s = $this-&gt;UTF8ToLatin1($s);
<a name="l07344"></a>07344         } <span class="keywordflow">else</span> {
<a name="l07345"></a>07345           <span class="comment">//Convert string to UTF-16BE and reverse RTL language</span>
<a name="l07346"></a>07346           $s = $this-&gt;utf8StrRev($s, <span class="keyword">false</span>, $this-&gt;tmprtl);
<a name="l07347"></a>07347         }
<a name="l07348"></a>07348       }
<a name="l07349"></a>07349       <span class="keywordflow">return</span> $this-&gt;_escape($s);
<a name="l07350"></a>07350     }
<a name="l07351"></a>07351     
<a name="l07357"></a>07357     <span class="keyword">protected</span> function _putstream($s) {
<a name="l07358"></a>07358       <span class="keywordflow">if</span> ($this-&gt;encrypted) {
<a name="l07359"></a>07359         $s = $this-&gt;_RC4($this-&gt;_objectkey($this-&gt;n), $s);
<a name="l07360"></a>07360       }
<a name="l07361"></a>07361       $this-&gt;_out(<span class="stringliteral">&#39;stream&#39;</span>);
<a name="l07362"></a>07362       $this-&gt;_out($s);
<a name="l07363"></a>07363       $this-&gt;_out(<span class="stringliteral">&#39;endstream&#39;</span>);
<a name="l07364"></a>07364     }
<a name="l07365"></a>07365     
<a name="l07371"></a>07371     <span class="keyword">protected</span> function _out($s) {
<a name="l07372"></a>07372       <span class="keywordflow">if</span> ($this-&gt;state == 2) {
<a name="l07373"></a>07373         <span class="keywordflow">if</span> ((!$this-&gt;InFooter) AND isset($this-&gt;footerlen[$this-&gt;page]) AND ($this-&gt;footerlen[$this-&gt;page] &gt; 0)) {
<a name="l07374"></a>07374           <span class="comment">// puts data before page footer</span>
<a name="l07375"></a>07375           $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);
<a name="l07376"></a>07376           $page = substr($pagebuff, 0, -$this-&gt;footerlen[$this-&gt;page]);
<a name="l07377"></a>07377           $footer = substr($pagebuff, -$this-&gt;footerlen[$this-&gt;page]);
<a name="l07378"></a>07378           $this-&gt;setPageBuffer($this-&gt;page, $page.$s.<span class="stringliteral">&quot;\n&quot;</span>.$footer);
<a name="l07379"></a>07379           <span class="comment">// update footer position</span>
<a name="l07380"></a>07380           $this-&gt;footerpos[$this-&gt;page] += strlen($s.<span class="stringliteral">&quot;\n&quot;</span>); 
<a name="l07381"></a>07381         } <span class="keywordflow">else</span> {
<a name="l07382"></a>07382           $this-&gt;setPageBuffer($this-&gt;page, $s.<span class="stringliteral">&quot;\n&quot;</span>, <span class="keyword">true</span>);
<a name="l07383"></a>07383         }
<a name="l07384"></a>07384       } <span class="keywordflow">else</span> {
<a name="l07385"></a>07385         $this-&gt;setBuffer($s.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l07386"></a>07386       }
<a name="l07387"></a>07387     }
<a name="l07388"></a>07388     
<a name="l07423"></a>07423     <span class="keyword">protected</span> function UTF8StringToArray($str) {
<a name="l07424"></a>07424       <span class="keywordflow">if</span> (isset($this-&gt;cache_UTF8StringToArray[<span class="charliteral">&#39;_&#39;</span>.$str])) {
<a name="l07425"></a>07425         <span class="comment">// return cached value</span>
<a name="l07426"></a>07426         <span class="keywordflow">return</span>($this-&gt;cache_UTF8StringToArray[<span class="charliteral">&#39;_&#39;</span>.$str]);
<a name="l07427"></a>07427       }
<a name="l07428"></a>07428       <span class="comment">// check cache size</span>
<a name="l07429"></a>07429       <span class="keywordflow">if</span> ($this-&gt;cache_size_UTF8StringToArray &gt;= $this-&gt;cache_maxsize_UTF8StringToArray) {
<a name="l07430"></a>07430         <span class="comment">// remove first element</span>
<a name="l07431"></a>07431         array_shift($this-&gt;cache_UTF8StringToArray);
<a name="l07432"></a>07432       }
<a name="l07433"></a>07433       ++$this-&gt;cache_size_UTF8StringToArray;
<a name="l07434"></a>07434       <span class="keywordflow">if</span> (!$this-&gt;isunicode) {
<a name="l07435"></a>07435         <span class="comment">// split string into array of equivalent codes</span>
<a name="l07436"></a>07436         $strarr = array();
<a name="l07437"></a>07437         $strlen = strlen($str);
<a name="l07438"></a>07438         <span class="keywordflow">for</span> ($i=0; $i &lt; $strlen; ++$i) {
<a name="l07439"></a>07439           $strarr[] = ord($str{$i});
<a name="l07440"></a>07440         }
<a name="l07441"></a>07441         <span class="comment">// insert new value on cache</span>
<a name="l07442"></a>07442         $this-&gt;cache_UTF8StringToArray[<span class="charliteral">&#39;_&#39;</span>.$str] = $strarr;
<a name="l07443"></a>07443         <span class="keywordflow">return</span> $strarr;
<a name="l07444"></a>07444       }
<a name="l07445"></a>07445       $unicode = array(); <span class="comment">// array containing unicode values</span>
<a name="l07446"></a>07446       $bytes  = array(); <span class="comment">// array containing single character byte sequences</span>
<a name="l07447"></a>07447       $numbytes  = 1; <span class="comment">// number of octetc needed to represent the UTF-8 character</span>
<a name="l07448"></a>07448       $str .= <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// force $str to be a string</span>
<a name="l07449"></a>07449       $length = strlen($str);
<a name="l07450"></a>07450       <span class="keywordflow">for</span> ($i = 0; $i &lt; $length; ++$i) {
<a name="l07451"></a>07451         $char = ord($str{$i}); <span class="comment">// get one string character at time</span>
<a name="l07452"></a>07452         <span class="keywordflow">if</span> (count($bytes) == 0) { <span class="comment">// get starting octect</span>
<a name="l07453"></a>07453           <span class="keywordflow">if</span> ($char &lt;= 0x7F) {
<a name="l07454"></a>07454             $unicode[] = $char; <span class="comment">// use the character &quot;as is&quot; because is ASCII</span>
<a name="l07455"></a>07455             $numbytes = 1;
<a name="l07456"></a>07456           } elseif (($char &gt;&gt; 0x05) == 0x06) { <span class="comment">// 2 bytes character (0x06 = 110 BIN)</span>
<a name="l07457"></a>07457             $bytes[] = ($char - 0xC0) &lt;&lt; 0x06; 
<a name="l07458"></a>07458             $numbytes = 2;
<a name="l07459"></a>07459           } elseif (($char &gt;&gt; 0x04) == 0x0E) { <span class="comment">// 3 bytes character (0x0E = 1110 BIN)</span>
<a name="l07460"></a>07460             $bytes[] = ($char - 0xE0) &lt;&lt; 0x0C; 
<a name="l07461"></a>07461             $numbytes = 3;
<a name="l07462"></a>07462           } elseif (($char &gt;&gt; 0x03) == 0x1E) { <span class="comment">// 4 bytes character (0x1E = 11110 BIN)</span>
<a name="l07463"></a>07463             $bytes[] = ($char - 0xF0) &lt;&lt; 0x12; 
<a name="l07464"></a>07464             $numbytes = 4;
<a name="l07465"></a>07465           } <span class="keywordflow">else</span> {
<a name="l07466"></a>07466             <span class="comment">// use replacement character for other invalid sequences</span>
<a name="l07467"></a>07467             $unicode[] = 0xFFFD;
<a name="l07468"></a>07468             $bytes = array();
<a name="l07469"></a>07469             $numbytes = 1;
<a name="l07470"></a>07470           }
<a name="l07471"></a>07471         } elseif (($char &gt;&gt; 0x06) == 0x02) { <span class="comment">// bytes 2, 3 and 4 must start with 0x02 = 10 BIN</span>
<a name="l07472"></a>07472           $bytes[] = $char - 0x80;
<a name="l07473"></a>07473           <span class="keywordflow">if</span> (count($bytes) == $numbytes) {
<a name="l07474"></a>07474             <span class="comment">// compose UTF-8 bytes to a single unicode value</span>
<a name="l07475"></a>07475             $char = $bytes[0];
<a name="l07476"></a>07476             <span class="keywordflow">for</span> ($j = 1; $j &lt; $numbytes; ++$j) {
<a name="l07477"></a>07477               $char += ($bytes[$j] &lt;&lt; (($numbytes - $j - 1) * 0x06));
<a name="l07478"></a>07478             }
<a name="l07479"></a>07479             <span class="keywordflow">if</span> ((($char &gt;= 0xD800) AND ($char &lt;= 0xDFFF)) OR ($char &gt;= 0x10FFFF)) {
<a name="l07480"></a>07480               <span class="comment">/* The definition of UTF-8 prohibits encoding character numbers between</span>
<a name="l07481"></a>07481 <span class="comment">              U+D800 and U+DFFF, which are reserved for use with the UTF-16</span>
<a name="l07482"></a>07482 <span class="comment">              encoding form (as surrogate pairs) and do not directly represent</span>
<a name="l07483"></a>07483 <span class="comment">              characters. */</span>
<a name="l07484"></a>07484               $unicode[] = 0xFFFD; <span class="comment">// use replacement character</span>
<a name="l07485"></a>07485             } <span class="keywordflow">else</span> {
<a name="l07486"></a>07486               $unicode[] = $char; <span class="comment">// add char to array</span>
<a name="l07487"></a>07487             }
<a name="l07488"></a>07488             <span class="comment">// reset data for next char</span>
<a name="l07489"></a>07489             $bytes = array(); 
<a name="l07490"></a>07490             $numbytes = 1;
<a name="l07491"></a>07491           }
<a name="l07492"></a>07492         } <span class="keywordflow">else</span> {
<a name="l07493"></a>07493           <span class="comment">// use replacement character for other invalid sequences</span>
<a name="l07494"></a>07494           $unicode[] = 0xFFFD;
<a name="l07495"></a>07495           $bytes = array();
<a name="l07496"></a>07496           $numbytes = 1;
<a name="l07497"></a>07497         }
<a name="l07498"></a>07498       }
<a name="l07499"></a>07499       <span class="comment">// insert new value on cache</span>
<a name="l07500"></a>07500       $this-&gt;cache_UTF8StringToArray[<span class="charliteral">&#39;_&#39;</span>.$str] = $unicode;
<a name="l07501"></a>07501       <span class="keywordflow">return</span> $unicode;
<a name="l07502"></a>07502     }
<a name="l07503"></a>07503     
<a name="l07514"></a>07514     <span class="keyword">protected</span> function UTF8ToUTF16BE($str, $setbom=<span class="keyword">true</span>) {
<a name="l07515"></a>07515       <span class="keywordflow">if</span> (!$this-&gt;isunicode) {
<a name="l07516"></a>07516         <span class="keywordflow">return</span> $str; <span class="comment">// string is not in unicode</span>
<a name="l07517"></a>07517       }
<a name="l07518"></a>07518       $unicode = $this-&gt;UTF8StringToArray($str); <span class="comment">// array containing UTF-8 unicode values</span>
<a name="l07519"></a>07519       <span class="keywordflow">return</span> $this-&gt;arrUTF8ToUTF16BE($unicode, $setbom);
<a name="l07520"></a>07520     }
<a name="l07521"></a>07521     
<a name="l07530"></a>07530     <span class="keyword">protected</span> function UTF8ToLatin1($str) {
<a name="l07531"></a>07531       global $utf8tolatin;
<a name="l07532"></a>07532       <span class="keywordflow">if</span> (!$this-&gt;isunicode) {
<a name="l07533"></a>07533         <span class="keywordflow">return</span> $str; <span class="comment">// string is not in unicode</span>
<a name="l07534"></a>07534       }
<a name="l07535"></a>07535       $outstr = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// string to be returned</span>
<a name="l07536"></a>07536       $unicode = $this-&gt;UTF8StringToArray($str); <span class="comment">// array containing UTF-8 unicode values</span>
<a name="l07537"></a>07537       <span class="keywordflow">foreach</span> ($unicode as $char) {
<a name="l07538"></a>07538         <span class="keywordflow">if</span> ($char &lt; 256) {
<a name="l07539"></a>07539           $outstr .= chr($char);
<a name="l07540"></a>07540         } elseif (array_key_exists($char, $utf8tolatin)) {
<a name="l07541"></a>07541           <span class="comment">// map from UTF-8</span>
<a name="l07542"></a>07542           $outstr .= chr($utf8tolatin[$char]);
<a name="l07543"></a>07543         } elseif ($char == 0xFFFD) {
<a name="l07544"></a>07544           <span class="comment">// skip</span>
<a name="l07545"></a>07545         } <span class="keywordflow">else</span> {
<a name="l07546"></a>07546           $outstr .= <span class="charliteral">&#39;?&#39;</span>;
<a name="l07547"></a>07547         }
<a name="l07548"></a>07548       }
<a name="l07549"></a>07549       <span class="keywordflow">return</span> $outstr;
<a name="l07550"></a>07550     }
<a name="l07551"></a>07551 
<a name="l07590"></a>07590     <span class="keyword">protected</span> function arrUTF8ToUTF16BE($unicode, $setbom=<span class="keyword">true</span>) {
<a name="l07591"></a>07591       $outstr = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// string to be returned</span>
<a name="l07592"></a>07592       <span class="keywordflow">if</span> ($setbom) {
<a name="l07593"></a>07593         $outstr .= <span class="stringliteral">&quot;\xFE\xFF&quot;</span>; <span class="comment">// Byte Order Mark (BOM)</span>
<a name="l07594"></a>07594       }
<a name="l07595"></a>07595       <span class="keywordflow">foreach</span> ($unicode as $char) {
<a name="l07596"></a>07596         <span class="keywordflow">if</span> ($char == 0xFFFD) {
<a name="l07597"></a>07597           $outstr .= <span class="stringliteral">&quot;\xFF\xFD&quot;</span>; <span class="comment">// replacement character</span>
<a name="l07598"></a>07598         } elseif ($char &lt; 0x10000) {
<a name="l07599"></a>07599           $outstr .= chr($char &gt;&gt; 0x08);
<a name="l07600"></a>07600           $outstr .= chr($char &amp; 0xFF);
<a name="l07601"></a>07601         } <span class="keywordflow">else</span> {
<a name="l07602"></a>07602           $char -= 0x10000;
<a name="l07603"></a>07603           $w1 = 0xD800 | ($char &gt;&gt; 0x10);
<a name="l07604"></a>07604           $w2 = 0xDC00 | ($char &amp; 0x3FF); 
<a name="l07605"></a>07605           $outstr .= chr($w1 &gt;&gt; 0x08);
<a name="l07606"></a>07606           $outstr .= chr($w1 &amp; 0xFF);
<a name="l07607"></a>07607           $outstr .= chr($w2 &gt;&gt; 0x08);
<a name="l07608"></a>07608           $outstr .= chr($w2 &amp; 0xFF);
<a name="l07609"></a>07609         }
<a name="l07610"></a>07610       }
<a name="l07611"></a>07611       <span class="keywordflow">return</span> $outstr;
<a name="l07612"></a>07612     }
<a name="l07613"></a>07613     <span class="comment">// ====================================================</span>
<a name="l07614"></a>07614     
<a name="l07621"></a>07621     <span class="keyword">public</span> function setHeaderFont($font) {
<a name="l07622"></a>07622       $this-&gt;header_font = $font;
<a name="l07623"></a>07623     }
<a name="l07624"></a>07624     
<a name="l07631"></a>07631     <span class="keyword">public</span> function getHeaderFont() {
<a name="l07632"></a>07632       <span class="keywordflow">return</span> $this-&gt;header_font;
<a name="l07633"></a>07633     }
<a name="l07634"></a>07634     
<a name="l07641"></a>07641     <span class="keyword">public</span> function setFooterFont($font) {
<a name="l07642"></a>07642       $this-&gt;footer_font = $font;
<a name="l07643"></a>07643     }
<a name="l07644"></a>07644     
<a name="l07651"></a>07651     <span class="keyword">public</span> function getFooterFont() {
<a name="l07652"></a>07652       <span class="keywordflow">return</span> $this-&gt;footer_font;
<a name="l07653"></a>07653     }
<a name="l07654"></a>07654     
<a name="l07661"></a>07661     <span class="keyword">public</span> function setLanguageArray($language) {
<a name="l07662"></a>07662       $this-&gt;l = $language;
<a name="l07663"></a>07663       <span class="keywordflow">if</span> (isset($this-&gt;l[<span class="stringliteral">&#39;a_meta_dir&#39;</span>])) {
<a name="l07664"></a>07664         $this-&gt;rtl = $this-&gt;l[<span class="stringliteral">&#39;a_meta_dir&#39;</span>]==<span class="stringliteral">&#39;rtl&#39;</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l07665"></a>07665       } <span class="keywordflow">else</span> {
<a name="l07666"></a>07666         $this-&gt;rtl = <span class="keyword">false</span>;
<a name="l07667"></a>07667       }
<a name="l07668"></a>07668     }
<a name="l07669"></a>07669     
<a name="l07674"></a>07674     <span class="keyword">public</span> function getPDFData() {
<a name="l07675"></a>07675       <span class="keywordflow">if</span> ($this-&gt;state &lt; 3) {
<a name="l07676"></a>07676         $this-&gt;Close();
<a name="l07677"></a>07677       }
<a name="l07678"></a>07678       <span class="keywordflow">return</span> $this-&gt;buffer;
<a name="l07679"></a>07679     }
<a name="l07680"></a>07680         
<a name="l07692"></a>07692     <span class="keyword">public</span> function addHtmlLink($url, $name, $fill=0, $firstline=<span class="keyword">false</span>, $color=<span class="stringliteral">&#39;&#39;</span>, $style=-1) {
<a name="l07693"></a>07693       <span class="keywordflow">if</span> (!$this-&gt;empty_string($url) AND ($url{0} == <span class="charliteral">&#39;#&#39;</span>)) {
<a name="l07694"></a>07694         <span class="comment">// convert url to internal link</span>
<a name="l07695"></a>07695         $page = intval(substr($url, 1));
<a name="l07696"></a>07696         $url = $this-&gt;AddLink();
<a name="l07697"></a>07697         $this-&gt;SetLink($url, 0, $page);
<a name="l07698"></a>07698       }
<a name="l07699"></a>07699       <span class="comment">// store current settings</span>
<a name="l07700"></a>07700       $prevcolor = $this-&gt;fgcolor;
<a name="l07701"></a>07701       $prevstyle = $this-&gt;FontStyle;
<a name="l07702"></a>07702       <span class="keywordflow">if</span> (empty($color)) {
<a name="l07703"></a>07703         $this-&gt;SetTextColorArray($this-&gt;htmlLinkColorArray);
<a name="l07704"></a>07704       } <span class="keywordflow">else</span> {
<a name="l07705"></a>07705         $this-&gt;SetTextColorArray($color);
<a name="l07706"></a>07706       }
<a name="l07707"></a>07707       <span class="keywordflow">if</span> ($style == -1) {
<a name="l07708"></a>07708         $this-&gt;SetFont(<span class="stringliteral">&#39;&#39;</span>, $this-&gt;FontStyle.$this-&gt;htmlLinkFontStyle);
<a name="l07709"></a>07709       } <span class="keywordflow">else</span> {
<a name="l07710"></a>07710         $this-&gt;SetFont(<span class="stringliteral">&#39;&#39;</span>, $this-&gt;FontStyle.$style);
<a name="l07711"></a>07711       }
<a name="l07712"></a>07712       $ret = $this-&gt;Write($this-&gt;lasth, $name, $url, $fill, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, 0, $firstline);
<a name="l07713"></a>07713       <span class="comment">// restore settings</span>
<a name="l07714"></a>07714       $this-&gt;SetFont(<span class="stringliteral">&#39;&#39;</span>, $prevstyle);
<a name="l07715"></a>07715       $this-&gt;SetTextColorArray($prevcolor);
<a name="l07716"></a>07716       <span class="keywordflow">return</span> $ret;
<a name="l07717"></a>07717     }
<a name="l07718"></a>07718     
<a name="l07725"></a>07725     <span class="keyword">public</span> function convertHTMLColorToDec($color=<span class="stringliteral">&#39;#FFFFFF&#39;</span>) {
<a name="l07726"></a>07726       global $webcolor;
<a name="l07727"></a>07727       $returncolor = <span class="keyword">false</span>;
<a name="l07728"></a>07728       $color = preg_replace(<span class="stringliteral">&#39;/[\s]*/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $color); <span class="comment">// remove extra spaces</span>
<a name="l07729"></a>07729       $color = strtolower($color);
<a name="l07730"></a>07730       <span class="keywordflow">if</span> (($dotpos = strpos($color, <span class="charliteral">&#39;.&#39;</span>)) !== <span class="keyword">false</span>) {
<a name="l07731"></a>07731         <span class="comment">// remove class parent (i.e.: color.red)</span>
<a name="l07732"></a>07732         $color = substr($color, ($dotpos + 1));
<a name="l07733"></a>07733       }
<a name="l07734"></a>07734       <span class="keywordflow">if</span> (strlen($color) == 0) {
<a name="l07735"></a>07735         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07736"></a>07736       }
<a name="l07737"></a>07737       <span class="keywordflow">if</span> (substr($color, 0, 3) == <span class="stringliteral">&#39;rgb&#39;</span>) {
<a name="l07738"></a>07738         $codes = substr($color, 4);
<a name="l07739"></a>07739         $codes = str_replace(<span class="charliteral">&#39;)&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $codes);
<a name="l07740"></a>07740         $returncolor = explode(<span class="charliteral">&#39;,&#39;</span>, $codes, 3);
<a name="l07741"></a>07741         <span class="keywordflow">return</span> $returncolor;
<a name="l07742"></a>07742       }
<a name="l07743"></a>07743       <span class="keywordflow">if</span> (substr($color, 0, 1) != <span class="charliteral">&#39;#&#39;</span>) {
<a name="l07744"></a>07744         <span class="comment">// decode color name</span>
<a name="l07745"></a>07745         <span class="keywordflow">if</span> (isset($webcolor[$color])) {
<a name="l07746"></a>07746           $color_code = $webcolor[$color];
<a name="l07747"></a>07747         } <span class="keywordflow">else</span> {
<a name="l07748"></a>07748           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07749"></a>07749         }
<a name="l07750"></a>07750       } <span class="keywordflow">else</span> {
<a name="l07751"></a>07751         $color_code = substr($color, 1);
<a name="l07752"></a>07752       }
<a name="l07753"></a>07753       <span class="keywordflow">switch</span> (strlen($color_code)) {
<a name="l07754"></a>07754         <span class="keywordflow">case</span> 3: {
<a name="l07755"></a>07755           <span class="comment">// three-digit hexadecimal representation</span>
<a name="l07756"></a>07756           $r = substr($color_code, 0, 1);
<a name="l07757"></a>07757           $g = substr($color_code, 1, 1);
<a name="l07758"></a>07758           $b = substr($color_code, 2, 1);
<a name="l07759"></a>07759           $returncolor[<span class="charliteral">&#39;R&#39;</span>] = hexdec($r.$r);
<a name="l07760"></a>07760           $returncolor[<span class="charliteral">&#39;G&#39;</span>] = hexdec($g.$g);
<a name="l07761"></a>07761           $returncolor[<span class="charliteral">&#39;B&#39;</span>] = hexdec($b.$b);
<a name="l07762"></a>07762           <span class="keywordflow">break</span>;
<a name="l07763"></a>07763         }
<a name="l07764"></a>07764         <span class="keywordflow">case</span> 6: {
<a name="l07765"></a>07765           <span class="comment">// six-digit hexadecimal representation</span>
<a name="l07766"></a>07766           $returncolor[<span class="charliteral">&#39;R&#39;</span>] = hexdec(substr($color_code, 0, 2));
<a name="l07767"></a>07767           $returncolor[<span class="charliteral">&#39;G&#39;</span>] = hexdec(substr($color_code, 2, 2));
<a name="l07768"></a>07768           $returncolor[<span class="charliteral">&#39;B&#39;</span>] = hexdec(substr($color_code, 4, 2));
<a name="l07769"></a>07769           <span class="keywordflow">break</span>;
<a name="l07770"></a>07770         }
<a name="l07771"></a>07771       }
<a name="l07772"></a>07772       <span class="keywordflow">return</span> $returncolor;
<a name="l07773"></a>07773     }
<a name="l07774"></a>07774     
<a name="l07782"></a>07782     <span class="keyword">public</span> function pixelsToUnits($px) {
<a name="l07783"></a>07783       <span class="keywordflow">return</span> ($px / ($this-&gt;imgscale * $this-&gt;k));
<a name="l07784"></a>07784     }
<a name="l07785"></a>07785       
<a name="l07793"></a>07793     <span class="keyword">public</span> function unhtmlentities($text_to_convert) {
<a name="l07794"></a>07794       <span class="keywordflow">return</span> html_entity_decode($text_to_convert, ENT_QUOTES, $this-&gt;encoding);
<a name="l07795"></a>07795     }
<a name="l07796"></a>07796     
<a name="l07797"></a>07797     <span class="comment">// ENCRYPTION METHODS ----------------------------------</span>
<a name="l07798"></a>07798     <span class="comment">// SINCE 2.0.000 (2008-01-02)</span>
<a name="l07799"></a>07799     
<a name="l07806"></a>07806     <span class="keyword">protected</span> function _objectkey($n) {
<a name="l07807"></a>07807       <span class="keywordflow">return</span> substr($this-&gt;_md5_16($this-&gt;encryption_key.pack(<span class="stringliteral">&#39;VXxx&#39;</span>, $n)), 0, 10);
<a name="l07808"></a>07808     }
<a name="l07809"></a>07809     
<a name="l07815"></a>07815     <span class="keyword">protected</span> function _putencryption() {
<a name="l07816"></a>07816       $this-&gt;_out(<span class="stringliteral">&#39;/Filter /Standard&#39;</span>);
<a name="l07817"></a>07817       $this-&gt;_out(<span class="stringliteral">&#39;/V 1&#39;</span>);
<a name="l07818"></a>07818       $this-&gt;_out(<span class="stringliteral">&#39;/R 2&#39;</span>);
<a name="l07819"></a>07819       $this-&gt;_out(<span class="stringliteral">&#39;/O (&#39;</span>.$this-&gt;_escape($this-&gt;Ovalue).<span class="charliteral">&#39;)&#39;</span>);
<a name="l07820"></a>07820       $this-&gt;_out(<span class="stringliteral">&#39;/U (&#39;</span>.$this-&gt;_escape($this-&gt;Uvalue).<span class="charliteral">&#39;)&#39;</span>);
<a name="l07821"></a>07821       $this-&gt;_out(<span class="stringliteral">&#39;/P &#39;</span>.$this-&gt;Pvalue);
<a name="l07822"></a>07822     }
<a name="l07823"></a>07823     
<a name="l07834"></a>07834     <span class="keyword">protected</span> function _RC4($key, $text) {
<a name="l07835"></a>07835       <span class="keywordflow">if</span> ($this-&gt;last_rc4_key != $key) {
<a name="l07836"></a>07836         $k = str_repeat($key, ((256 / strlen($key)) + 1));
<a name="l07837"></a>07837         $rc4 = range(0, 255);
<a name="l07838"></a>07838         $j = 0;
<a name="l07839"></a>07839         <span class="keywordflow">for</span> ($i = 0; $i &lt; 256; ++$i) {
<a name="l07840"></a>07840           $t = $rc4[$i];
<a name="l07841"></a>07841           $j = ($j + $t + ord($k{$i})) % 256;
<a name="l07842"></a>07842           $rc4[$i] = $rc4[$j];
<a name="l07843"></a>07843           $rc4[$j] = $t;
<a name="l07844"></a>07844         }
<a name="l07845"></a>07845         $this-&gt;last_rc4_key = $key;
<a name="l07846"></a>07846         $this-&gt;last_rc4_key_c = $rc4;
<a name="l07847"></a>07847       } <span class="keywordflow">else</span> {
<a name="l07848"></a>07848         $rc4 = $this-&gt;last_rc4_key_c;
<a name="l07849"></a>07849       }
<a name="l07850"></a>07850       $len = strlen($text);
<a name="l07851"></a>07851       $a = 0;
<a name="l07852"></a>07852       $b = 0;
<a name="l07853"></a>07853       $out = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07854"></a>07854       <span class="keywordflow">for</span> ($i = 0; $i &lt; $len; ++$i) {
<a name="l07855"></a>07855         $a = ($a + 1) % 256;
<a name="l07856"></a>07856         $t = $rc4[$a];
<a name="l07857"></a>07857         $b = ($b + $t) % 256;
<a name="l07858"></a>07858         $rc4[$a] = $rc4[$b];
<a name="l07859"></a>07859         $rc4[$b] = $t;
<a name="l07860"></a>07860         $k = $rc4[($rc4[$a] + $rc4[$b]) % 256];
<a name="l07861"></a>07861         $out .= chr(ord($text{$i}) ^ $k);
<a name="l07862"></a>07862       }
<a name="l07863"></a>07863       <span class="keywordflow">return</span> $out;
<a name="l07864"></a>07864     }
<a name="l07865"></a>07865     
<a name="l07874"></a>07874     <span class="keyword">protected</span> function _md5_16($str) {
<a name="l07875"></a>07875       <span class="keywordflow">return</span> pack(<span class="stringliteral">&#39;H*&#39;</span>, md5($str));
<a name="l07876"></a>07876     }
<a name="l07877"></a>07877     
<a name="l07887"></a>07887     <span class="keyword">protected</span> function _Ovalue($user_pass, $owner_pass) {
<a name="l07888"></a>07888       $tmp = $this-&gt;_md5_16($owner_pass);
<a name="l07889"></a>07889       $owner_RC4_key = substr($tmp, 0, 5);
<a name="l07890"></a>07890       <span class="keywordflow">return</span> $this-&gt;_RC4($owner_RC4_key, $user_pass);
<a name="l07891"></a>07891     }
<a name="l07892"></a>07892     
<a name="l07900"></a>07900     <span class="keyword">protected</span> function _Uvalue() {
<a name="l07901"></a>07901       <span class="keywordflow">return</span> $this-&gt;_RC4($this-&gt;encryption_key, $this-&gt;padding);
<a name="l07902"></a>07902     }
<a name="l07903"></a>07903     
<a name="l07913"></a>07913     <span class="keyword">protected</span> function _generateencryptionkey($user_pass, $owner_pass, $protection) {
<a name="l07914"></a>07914       <span class="comment">// Pad passwords</span>
<a name="l07915"></a>07915       $user_pass = substr($user_pass.$this-&gt;padding, 0, 32);
<a name="l07916"></a>07916       $owner_pass = substr($owner_pass.$this-&gt;padding, 0, 32);
<a name="l07917"></a>07917       <span class="comment">// Compute O value</span>
<a name="l07918"></a>07918       $this-&gt;Ovalue = $this-&gt;_Ovalue($user_pass, $owner_pass);
<a name="l07919"></a>07919       <span class="comment">// Compute encyption key</span>
<a name="l07920"></a>07920       $tmp = $this-&gt;_md5_16($user_pass.$this-&gt;Ovalue.chr($protection).<span class="stringliteral">&quot;\xFF\xFF\xFF&quot;</span>);
<a name="l07921"></a>07921       $this-&gt;encryption_key = substr($tmp, 0, 5);
<a name="l07922"></a>07922       <span class="comment">// Compute U value</span>
<a name="l07923"></a>07923       $this-&gt;Uvalue = $this-&gt;_Uvalue();
<a name="l07924"></a>07924       <span class="comment">// Compute P value</span>
<a name="l07925"></a>07925       $this-&gt;Pvalue = -(($protection^255) + 1);
<a name="l07926"></a>07926     }
<a name="l07927"></a>07927     
<a name="l07945"></a>07945     <span class="keyword">public</span> function SetProtection($permissions=array(), $user_pass=<span class="stringliteral">&#39;&#39;</span>, $owner_pass=null) {
<a name="l07946"></a>07946       $options = array(<span class="stringliteral">&#39;print&#39;</span> =&gt; 4, <span class="stringliteral">&#39;modify&#39;</span> =&gt; 8, <span class="stringliteral">&#39;copy&#39;</span> =&gt; 16, <span class="stringliteral">&#39;annot-forms&#39;</span> =&gt; 32);
<a name="l07947"></a>07947       $protection = 192;
<a name="l07948"></a>07948       <span class="keywordflow">foreach</span> ($permissions as $permission) {
<a name="l07949"></a>07949         <span class="keywordflow">if</span> (!isset($options[$permission])) {
<a name="l07950"></a>07950           $this-&gt;Error(<span class="stringliteral">&#39;Incorrect permission: &#39;</span>.$permission);
<a name="l07951"></a>07951         }
<a name="l07952"></a>07952         $protection += $options[$permission];
<a name="l07953"></a>07953       }
<a name="l07954"></a>07954       <span class="keywordflow">if</span> ($owner_pass === null) {
<a name="l07955"></a>07955         $owner_pass = uniqid(rand());
<a name="l07956"></a>07956       }
<a name="l07957"></a>07957       $this-&gt;encrypted = <span class="keyword">true</span>;
<a name="l07958"></a>07958       $this-&gt;_generateencryptionkey($user_pass, $owner_pass, $protection);
<a name="l07959"></a>07959     }
<a name="l07960"></a>07960     
<a name="l07961"></a>07961     <span class="comment">// END OF ENCRYPTION FUNCTIONS -------------------------</span>
<a name="l07962"></a>07962     
<a name="l07963"></a>07963     <span class="comment">// START TRANSFORMATIONS SECTION -----------------------</span>
<a name="l07964"></a>07964     
<a name="l07973"></a>07973     <span class="keyword">public</span> function StartTransform() {
<a name="l07974"></a>07974       $this-&gt;_out(<span class="charliteral">&#39;q&#39;</span>);
<a name="l07975"></a>07975       $this-&gt;transfmrk[$this-&gt;page][] = $this-&gt;pagelen[$this-&gt;page];
<a name="l07976"></a>07976       ++$this-&gt;transfmatrix_key;
<a name="l07977"></a>07977       $this-&gt;transfmatrix[$this-&gt;transfmatrix_key] = array();
<a name="l07978"></a>07978     }
<a name="l07979"></a>07979     
<a name="l07988"></a>07988     <span class="keyword">public</span> function StopTransform() {
<a name="l07989"></a>07989       $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l07990"></a>07990       <span class="keywordflow">if</span> (isset($this-&gt;transfmatrix[$this-&gt;transfmatrix_key])) {
<a name="l07991"></a>07991         array_pop($this-&gt;transfmatrix[$this-&gt;transfmatrix_key]);
<a name="l07992"></a>07992         --$this-&gt;transfmatrix_key;
<a name="l07993"></a>07993       }
<a name="l07994"></a>07994       array_pop($this-&gt;transfmrk[$this-&gt;page]);
<a name="l07995"></a>07995     }
<a name="l08005"></a>08005     <span class="keyword">public</span> function ScaleX($s_x, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08006"></a>08006       $this-&gt;Scale($s_x, 100, $x, $y);
<a name="l08007"></a>08007     }
<a name="l08008"></a>08008     
<a name="l08018"></a>08018     <span class="keyword">public</span> function ScaleY($s_y, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08019"></a>08019       $this-&gt;Scale(100, $s_y, $x, $y);
<a name="l08020"></a>08020     }
<a name="l08021"></a>08021     
<a name="l08031"></a>08031     <span class="keyword">public</span> function ScaleXY($s, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08032"></a>08032       $this-&gt;Scale($s, $s, $x, $y);
<a name="l08033"></a>08033     }
<a name="l08034"></a>08034     
<a name="l08045"></a>08045     <span class="keyword">public</span> function Scale($s_x, $s_y, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08046"></a>08046       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08047"></a>08047         $x = $this-&gt;x;
<a name="l08048"></a>08048       }
<a name="l08049"></a>08049       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08050"></a>08050         $y = $this-&gt;y;
<a name="l08051"></a>08051       }
<a name="l08052"></a>08052       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08053"></a>08053         $x = $this-&gt;w - $x;
<a name="l08054"></a>08054       }
<a name="l08055"></a>08055       <span class="keywordflow">if</span> (($s_x == 0) OR ($s_y == 0)) {
<a name="l08056"></a>08056         $this-&gt;Error(<span class="stringliteral">&#39;Please do not use values equal to zero for scaling&#39;</span>);
<a name="l08057"></a>08057       }
<a name="l08058"></a>08058       $y = ($this-&gt;h - $y) * $this-&gt;k;
<a name="l08059"></a>08059       $x *= $this-&gt;k;
<a name="l08060"></a>08060       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l08061"></a>08061       $s_x /= 100;
<a name="l08062"></a>08062       $s_y /= 100;
<a name="l08063"></a>08063       $tm[0] = $s_x;
<a name="l08064"></a>08064       $tm[1] = 0;
<a name="l08065"></a>08065       $tm[2] = 0;
<a name="l08066"></a>08066       $tm[3] = $s_y;
<a name="l08067"></a>08067       $tm[4] = $x * (1 - $s_x);
<a name="l08068"></a>08068       $tm[5] = $y * (1 - $s_y);
<a name="l08069"></a>08069       <span class="comment">//scale the coordinate system</span>
<a name="l08070"></a>08070       $this-&gt;Transform($tm);
<a name="l08071"></a>08071     }
<a name="l08072"></a>08072     
<a name="l08080"></a>08080     <span class="keyword">public</span> function MirrorH($x=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08081"></a>08081       $this-&gt;Scale(-100, 100, $x);
<a name="l08082"></a>08082     }
<a name="l08083"></a>08083     
<a name="l08091"></a>08091     <span class="keyword">public</span> function MirrorV($y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08092"></a>08092       $this-&gt;Scale(100, -100, <span class="stringliteral">&#39;&#39;</span>, $y);
<a name="l08093"></a>08093     }
<a name="l08094"></a>08094     
<a name="l08103"></a>08103     <span class="keyword">public</span> function MirrorP($x=<span class="stringliteral">&#39;&#39;</span>,$y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08104"></a>08104       $this-&gt;Scale(-100, -100, $x, $y);
<a name="l08105"></a>08105     }
<a name="l08106"></a>08106     
<a name="l08116"></a>08116     <span class="keyword">public</span> function MirrorL($angle=0, $x=<span class="stringliteral">&#39;&#39;</span>,$y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08117"></a>08117       $this-&gt;Scale(-100, 100, $x, $y);
<a name="l08118"></a>08118       $this-&gt;Rotate(-2*($angle-90), $x, $y);
<a name="l08119"></a>08119     }
<a name="l08120"></a>08120     
<a name="l08128"></a>08128     <span class="keyword">public</span> function TranslateX($t_x) {
<a name="l08129"></a>08129       $this-&gt;Translate($t_x, 0);
<a name="l08130"></a>08130     }
<a name="l08131"></a>08131     
<a name="l08139"></a>08139     <span class="keyword">public</span> function TranslateY($t_y) {
<a name="l08140"></a>08140       $this-&gt;Translate(0, $t_y);
<a name="l08141"></a>08141     }
<a name="l08142"></a>08142     
<a name="l08151"></a>08151     <span class="keyword">public</span> function Translate($t_x, $t_y) {
<a name="l08152"></a>08152       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08153"></a>08153         $t_x = -$t_x;
<a name="l08154"></a>08154       }
<a name="l08155"></a>08155       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l08156"></a>08156       $tm[0] = 1;
<a name="l08157"></a>08157       $tm[1] = 0;
<a name="l08158"></a>08158       $tm[2] = 0;
<a name="l08159"></a>08159       $tm[3] = 1;
<a name="l08160"></a>08160       $tm[4] = $t_x * $this-&gt;k;
<a name="l08161"></a>08161       $tm[5] = -$t_y * $this-&gt;k;
<a name="l08162"></a>08162       <span class="comment">//translate the coordinate system</span>
<a name="l08163"></a>08163       $this-&gt;Transform($tm);
<a name="l08164"></a>08164     }
<a name="l08165"></a>08165     
<a name="l08175"></a>08175     <span class="keyword">public</span> function Rotate($angle, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08176"></a>08176       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08177"></a>08177         $x = $this-&gt;x;
<a name="l08178"></a>08178       }
<a name="l08179"></a>08179       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08180"></a>08180         $y = $this-&gt;y;
<a name="l08181"></a>08181       }
<a name="l08182"></a>08182       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08183"></a>08183         $x = $this-&gt;w - $x;
<a name="l08184"></a>08184         $angle = -$angle;
<a name="l08185"></a>08185       }
<a name="l08186"></a>08186       $y = ($this-&gt;h - $y) * $this-&gt;k;
<a name="l08187"></a>08187       $x *= $this-&gt;k;
<a name="l08188"></a>08188       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l08189"></a>08189       $tm[0] = cos(deg2rad($angle));
<a name="l08190"></a>08190       $tm[1] = sin(deg2rad($angle));
<a name="l08191"></a>08191       $tm[2] = -$tm[1];
<a name="l08192"></a>08192       $tm[3] = $tm[0];
<a name="l08193"></a>08193       $tm[4] = $x + ($tm[1] * $y) - ($tm[0] * $x);
<a name="l08194"></a>08194       $tm[5] = $y - ($tm[0] * $y) - ($tm[1] * $x);
<a name="l08195"></a>08195       <span class="comment">//rotate the coordinate system around ($x,$y)</span>
<a name="l08196"></a>08196       $this-&gt;Transform($tm);
<a name="l08197"></a>08197     }
<a name="l08198"></a>08198     
<a name="l08208"></a>08208     <span class="keyword">public</span> function SkewX($angle_x, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08209"></a>08209       $this-&gt;Skew($angle_x, 0, $x, $y);
<a name="l08210"></a>08210     }
<a name="l08211"></a>08211     
<a name="l08221"></a>08221     <span class="keyword">public</span> function SkewY($angle_y, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08222"></a>08222       $this-&gt;Skew(0, $angle_y, $x, $y);
<a name="l08223"></a>08223     }
<a name="l08224"></a>08224     
<a name="l08235"></a>08235     <span class="keyword">public</span> function Skew($angle_x, $angle_y, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l08236"></a>08236       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08237"></a>08237         $x = $this-&gt;x;
<a name="l08238"></a>08238       }
<a name="l08239"></a>08239       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l08240"></a>08240         $y = $this-&gt;y;
<a name="l08241"></a>08241       }
<a name="l08242"></a>08242       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08243"></a>08243         $x = $this-&gt;w - $x;
<a name="l08244"></a>08244         $angle_x = -$angle_x;
<a name="l08245"></a>08245       }
<a name="l08246"></a>08246       <span class="keywordflow">if</span> (($angle_x &lt;= -90) OR ($angle_x &gt;= 90) OR ($angle_y &lt;= -90) OR ($angle_y &gt;= 90)) {
<a name="l08247"></a>08247         $this-&gt;Error(<span class="stringliteral">&#39;Please use values between -90 and +90 degrees for Skewing.&#39;</span>);
<a name="l08248"></a>08248       }
<a name="l08249"></a>08249       $x *= $this-&gt;k;
<a name="l08250"></a>08250       $y = ($this-&gt;h - $y) * $this-&gt;k;
<a name="l08251"></a>08251       <span class="comment">//calculate elements of transformation matrix</span>
<a name="l08252"></a>08252       $tm[0] = 1;
<a name="l08253"></a>08253       $tm[1] = tan(deg2rad($angle_y));
<a name="l08254"></a>08254       $tm[2] = tan(deg2rad($angle_x));
<a name="l08255"></a>08255       $tm[3] = 1;
<a name="l08256"></a>08256       $tm[4] = -$tm[2] * $y;
<a name="l08257"></a>08257       $tm[5] = -$tm[1] * $x;
<a name="l08258"></a>08258       <span class="comment">//skew the coordinate system</span>
<a name="l08259"></a>08259       $this-&gt;Transform($tm);
<a name="l08260"></a>08260     }
<a name="l08261"></a>08261     
<a name="l08268"></a>08268     <span class="keyword">protected</span> function Transform($tm) {
<a name="l08269"></a>08269       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F %.3F %.3F %.3F cm&#39;</span>, $tm[0], $tm[1], $tm[2], $tm[3], $tm[4], $tm[5]));
<a name="l08270"></a>08270       <span class="comment">// add tranformation matrix</span>
<a name="l08271"></a>08271       $this-&gt;transfmatrix[$this-&gt;transfmatrix_key][] = array(<span class="charliteral">&#39;a&#39;</span> =&gt; $tm[0], <span class="charliteral">&#39;b&#39;</span> =&gt; $tm[1], <span class="charliteral">&#39;c&#39;</span> =&gt; $tm[2], <span class="charliteral">&#39;d&#39;</span> =&gt; $tm[3], <span class="charliteral">&#39;e&#39;</span> =&gt; $tm[4], <span class="charliteral">&#39;f&#39;</span> =&gt; $tm[5]);
<a name="l08272"></a>08272       <span class="comment">// update tranformation mark</span>
<a name="l08273"></a>08273       <span class="keywordflow">if</span> (end($this-&gt;transfmrk[$this-&gt;page]) !== <span class="keyword">false</span>) {
<a name="l08274"></a>08274         $key = key($this-&gt;transfmrk[$this-&gt;page]);
<a name="l08275"></a>08275         $this-&gt;transfmrk[$this-&gt;page][$key] = $this-&gt;pagelen[$this-&gt;page];
<a name="l08276"></a>08276       }
<a name="l08277"></a>08277     }
<a name="l08278"></a>08278     
<a name="l08279"></a>08279     <span class="comment">// END TRANSFORMATIONS SECTION -------------------------</span>
<a name="l08280"></a>08280     
<a name="l08281"></a>08281     
<a name="l08282"></a>08282     <span class="comment">// START GRAPHIC FUNCTIONS SECTION ---------------------</span>
<a name="l08283"></a>08283     <span class="comment">// The following section is based on the code provided by David Hernandez Sanz</span>
<a name="l08284"></a>08284     
<a name="l08292"></a>08292     <span class="keyword">public</span> function SetLineWidth($width) {
<a name="l08293"></a>08293       <span class="comment">//Set line width</span>
<a name="l08294"></a>08294       $this-&gt;LineWidth = $width;
<a name="l08295"></a>08295       $this-&gt;linestyleWidth = sprintf(<span class="stringliteral">&#39;%.2F w&#39;</span>, ($width * $this-&gt;k));
<a name="l08296"></a>08296       <span class="keywordflow">if</span> ($this-&gt;page &gt; 0) {
<a name="l08297"></a>08297         $this-&gt;_out($this-&gt;linestyleWidth);
<a name="l08298"></a>08298       }
<a name="l08299"></a>08299     }
<a name="l08300"></a>08300     
<a name="l08308"></a>08308     <span class="keyword">public</span> function GetLineWidth() {
<a name="l08309"></a>08309       <span class="keywordflow">return</span> $this-&gt;LineWidth;
<a name="l08310"></a>08310     }
<a name="l08311"></a>08311     
<a name="l08333"></a>08333     <span class="keyword">public</span> function SetLineStyle($style) {
<a name="l08334"></a>08334       <span class="keywordflow">if</span> (!is_array($style)) {
<a name="l08335"></a>08335         <span class="keywordflow">return</span>;
<a name="l08336"></a>08336       }
<a name="l08337"></a>08337       extract($style);
<a name="l08338"></a>08338       <span class="keywordflow">if</span> (isset($width)) {
<a name="l08339"></a>08339         $width_prev = $this-&gt;LineWidth;
<a name="l08340"></a>08340         $this-&gt;SetLineWidth($width);
<a name="l08341"></a>08341         $this-&gt;LineWidth = $width_prev;
<a name="l08342"></a>08342       }
<a name="l08343"></a>08343       <span class="keywordflow">if</span> (isset($cap)) {
<a name="l08344"></a>08344         $ca = array(<span class="stringliteral">&#39;butt&#39;</span> =&gt; 0, <span class="stringliteral">&#39;round&#39;</span>=&gt; 1, <span class="stringliteral">&#39;square&#39;</span> =&gt; 2);
<a name="l08345"></a>08345         <span class="keywordflow">if</span> (isset($ca[$cap])) {
<a name="l08346"></a>08346           $this-&gt;linestyleCap = $ca[$cap].<span class="stringliteral">&#39; J&#39;</span>;
<a name="l08347"></a>08347           $this-&gt;_out($this-&gt;linestyleCap);
<a name="l08348"></a>08348         }
<a name="l08349"></a>08349       }
<a name="l08350"></a>08350       <span class="keywordflow">if</span> (isset($join)) {
<a name="l08351"></a>08351         $ja = array(<span class="stringliteral">&#39;miter&#39;</span> =&gt; 0, <span class="stringliteral">&#39;round&#39;</span> =&gt; 1, <span class="stringliteral">&#39;bevel&#39;</span> =&gt; 2);
<a name="l08352"></a>08352         <span class="keywordflow">if</span> (isset($ja[$join])) {
<a name="l08353"></a>08353           $this-&gt;linestyleJoin = $ja[$join].<span class="stringliteral">&#39; j&#39;</span>;
<a name="l08354"></a>08354           $this-&gt;_out($this-&gt;linestyleJoin);
<a name="l08355"></a>08355         }
<a name="l08356"></a>08356       }
<a name="l08357"></a>08357       <span class="keywordflow">if</span> (isset($dash)) {
<a name="l08358"></a>08358         $dash_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08359"></a>08359         <span class="keywordflow">if</span> ($dash) {
<a name="l08360"></a>08360           <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^.+,/&#39;</span>, $dash) &gt; 0) {
<a name="l08361"></a>08361             $tab = explode(<span class="charliteral">&#39;,&#39;</span>, $dash);
<a name="l08362"></a>08362           } <span class="keywordflow">else</span> {
<a name="l08363"></a>08363             $tab = array($dash);
<a name="l08364"></a>08364           }
<a name="l08365"></a>08365           $dash_string = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08366"></a>08366           <span class="keywordflow">foreach</span> ($tab as $i =&gt; $v) {
<a name="l08367"></a>08367             <span class="keywordflow">if</span> ($i) {
<a name="l08368"></a>08368               $dash_string .= <span class="charliteral">&#39; &#39;</span>;
<a name="l08369"></a>08369             }
<a name="l08370"></a>08370             $dash_string .= sprintf(<span class="stringliteral">&quot;%.2F&quot;</span>, $v);
<a name="l08371"></a>08371           }
<a name="l08372"></a>08372         }
<a name="l08373"></a>08373         <span class="keywordflow">if</span> (!isset($phase) OR !$dash) {
<a name="l08374"></a>08374           $phase = 0;
<a name="l08375"></a>08375         }
<a name="l08376"></a>08376         $this-&gt;linestyleDash = sprintf(<span class="stringliteral">&quot;[%s] %.2F d&quot;</span>, $dash_string, $phase);
<a name="l08377"></a>08377         $this-&gt;_out($this-&gt;linestyleDash);
<a name="l08378"></a>08378       }
<a name="l08379"></a>08379       <span class="keywordflow">if</span> (isset($color)) {
<a name="l08380"></a>08380         $this-&gt;SetDrawColorArray($color);
<a name="l08381"></a>08381       }
<a name="l08382"></a>08382     }
<a name="l08383"></a>08383     
<a name="l08384"></a>08384     <span class="comment">/*</span>
<a name="l08385"></a>08385 <span class="comment">    * Set a draw point.</span>
<a name="l08386"></a>08386 <span class="comment">    * @param float $x Abscissa of point.</span>
<a name="l08387"></a>08387 <span class="comment">    * @param float $y Ordinate of point.</span>
<a name="l08388"></a>08388 <span class="comment">    * @access protected</span>
<a name="l08389"></a>08389 <span class="comment">    * @since 2.1.000 (2008-01-08)</span>
<a name="l08390"></a>08390 <span class="comment">    */</span>
<a name="l08391"></a>08391     <span class="keyword">protected</span> function _outPoint($x, $y) {
<a name="l08392"></a>08392       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08393"></a>08393         $x = $this-&gt;w - $x;
<a name="l08394"></a>08394       }
<a name="l08395"></a>08395       $this-&gt;_out(sprintf(<span class="stringliteral">&quot;%.2F %.2F m&quot;</span>, $x * $this-&gt;k, ($this-&gt;h - $y) * $this-&gt;k));
<a name="l08396"></a>08396     }
<a name="l08397"></a>08397     
<a name="l08398"></a>08398     <span class="comment">/*</span>
<a name="l08399"></a>08399 <span class="comment">    * Draws a line from last draw point.</span>
<a name="l08400"></a>08400 <span class="comment">    * @param float $x Abscissa of end point.</span>
<a name="l08401"></a>08401 <span class="comment">    * @param float $y Ordinate of end point.</span>
<a name="l08402"></a>08402 <span class="comment">    * @access protected</span>
<a name="l08403"></a>08403 <span class="comment">    * @since 2.1.000 (2008-01-08)</span>
<a name="l08404"></a>08404 <span class="comment">    */</span>
<a name="l08405"></a>08405     <span class="keyword">protected</span> function _outLine($x, $y) {
<a name="l08406"></a>08406       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08407"></a>08407         $x = $this-&gt;w - $x;
<a name="l08408"></a>08408       }
<a name="l08409"></a>08409       $this-&gt;_out(sprintf(<span class="stringliteral">&quot;%.2F %.2F l&quot;</span>, $x * $this-&gt;k, ($this-&gt;h - $y) * $this-&gt;k));
<a name="l08410"></a>08410     }
<a name="l08411"></a>08411     
<a name="l08422"></a>08422     <span class="keyword">protected</span> function _outRect($x, $y, $w, $h, $op) {
<a name="l08423"></a>08423       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08424"></a>08424         $x = $this-&gt;w - $x - $w;
<a name="l08425"></a>08425       }
<a name="l08426"></a>08426       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F re %s&#39;</span>, $x*$this-&gt;k, ($this-&gt;h-$y)*$this-&gt;k, $w*$this-&gt;k, -$h*$this-&gt;k, $op));
<a name="l08427"></a>08427     }
<a name="l08428"></a>08428     
<a name="l08429"></a>08429     <span class="comment">/*</span>
<a name="l08430"></a>08430 <span class="comment">    * Draws a Bezier curve from last draw point.</span>
<a name="l08431"></a>08431 <span class="comment">    * The Bezier curve is a tangent to the line between the control points at either end of the curve.</span>
<a name="l08432"></a>08432 <span class="comment">    * @param float $x1 Abscissa of control point 1.</span>
<a name="l08433"></a>08433 <span class="comment">    * @param float $y1 Ordinate of control point 1.</span>
<a name="l08434"></a>08434 <span class="comment">    * @param float $x2 Abscissa of control point 2.</span>
<a name="l08435"></a>08435 <span class="comment">    * @param float $y2 Ordinate of control point 2.</span>
<a name="l08436"></a>08436 <span class="comment">    * @param float $x3 Abscissa of end point.</span>
<a name="l08437"></a>08437 <span class="comment">    * @param float $y3 Ordinate of end point.</span>
<a name="l08438"></a>08438 <span class="comment">    * @access protected</span>
<a name="l08439"></a>08439 <span class="comment">    * @since 2.1.000 (2008-01-08)</span>
<a name="l08440"></a>08440 <span class="comment">    */</span>
<a name="l08441"></a>08441     <span class="keyword">protected</span> function _outCurve($x1, $y1, $x2, $y2, $x3, $y3) {
<a name="l08442"></a>08442       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l08443"></a>08443         $x1 = $this-&gt;w - $x1;
<a name="l08444"></a>08444         $x2 = $this-&gt;w - $x2;
<a name="l08445"></a>08445         $x3 = $this-&gt;w - $x3;
<a name="l08446"></a>08446       }
<a name="l08447"></a>08447       $this-&gt;_out(sprintf(<span class="stringliteral">&quot;%.2F %.2F %.2F %.2F %.2F %.2F c&quot;</span>, $x1 * $this-&gt;k, ($this-&gt;h - $y1) * $this-&gt;k, $x2 * $this-&gt;k, ($this-&gt;h - $y2) * $this-&gt;k, $x3 * $this-&gt;k, ($this-&gt;h - $y3) * $this-&gt;k));
<a name="l08448"></a>08448     }
<a name="l08449"></a>08449     
<a name="l08461"></a>08461     <span class="keyword">public</span> function Line($x1, $y1, $x2, $y2, $style=array()) {
<a name="l08462"></a>08462       <span class="keywordflow">if</span> (is_array($style)) {
<a name="l08463"></a>08463         $this-&gt;SetLineStyle($style);
<a name="l08464"></a>08464       }
<a name="l08465"></a>08465       $this-&gt;_outPoint($x1, $y1);
<a name="l08466"></a>08466       $this-&gt;_outLine($x2, $y2);
<a name="l08467"></a>08467       $this-&gt;_out(<span class="stringliteral">&#39; S&#39;</span>);
<a name="l08468"></a>08468     }
<a name="l08469"></a>08469     
<a name="l08496"></a>08496     <span class="keyword">public</span> function Rect($x, $y, $w, $h, $style=<span class="stringliteral">&#39;&#39;</span>, $border_style=array(), $fill_color=array()) {
<a name="l08497"></a>08497       <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($style, <span class="charliteral">&#39;F&#39;</span>)) AND isset($fill_color)) {
<a name="l08498"></a>08498         $this-&gt;SetFillColorArray($fill_color);
<a name="l08499"></a>08499       }
<a name="l08500"></a>08500       <span class="keywordflow">switch</span> ($style) {
<a name="l08501"></a>08501         <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l08502"></a>08502           $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08503"></a>08503           $border_style = array();
<a name="l08504"></a>08504           $this-&gt;_outRect($x, $y, $w, $h, $op);
<a name="l08505"></a>08505           <span class="keywordflow">break</span>;
<a name="l08506"></a>08506         }
<a name="l08507"></a>08507         <span class="keywordflow">case</span> <span class="stringliteral">&#39;DF&#39;</span>:
<a name="l08508"></a>08508         <span class="keywordflow">case</span> <span class="stringliteral">&#39;FD&#39;</span>: {
<a name="l08509"></a>08509           <span class="keywordflow">if</span> ((!$border_style) OR (isset($border_style[<span class="stringliteral">&#39;all&#39;</span>]))) {
<a name="l08510"></a>08510             $op = <span class="charliteral">&#39;B&#39;</span>;
<a name="l08511"></a>08511             <span class="keywordflow">if</span> (isset($border_style[<span class="stringliteral">&#39;all&#39;</span>])) {
<a name="l08512"></a>08512               $this-&gt;SetLineStyle($border_style[<span class="stringliteral">&#39;all&#39;</span>]);
<a name="l08513"></a>08513               $border_style = array();
<a name="l08514"></a>08514             }
<a name="l08515"></a>08515           } <span class="keywordflow">else</span> {
<a name="l08516"></a>08516             $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08517"></a>08517           }
<a name="l08518"></a>08518           $this-&gt;_outRect($x, $y, $w, $h, $op);
<a name="l08519"></a>08519           <span class="keywordflow">break</span>;
<a name="l08520"></a>08520         }
<a name="l08521"></a>08521         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CNZ&#39;</span>: {
<a name="l08522"></a>08522           $op = <span class="stringliteral">&#39;W n&#39;</span>;
<a name="l08523"></a>08523           $this-&gt;_outRect($x, $y, $w, $h, $op);
<a name="l08524"></a>08524           <span class="keywordflow">break</span>;
<a name="l08525"></a>08525         }
<a name="l08526"></a>08526         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CEO&#39;</span>: {
<a name="l08527"></a>08527           $op = <span class="stringliteral">&#39;W* n&#39;</span>;
<a name="l08528"></a>08528           $this-&gt;_outRect($x, $y, $w, $h, $op);
<a name="l08529"></a>08529           <span class="keywordflow">break</span>;
<a name="l08530"></a>08530         }
<a name="l08531"></a>08531         <span class="keywordflow">default</span>: {
<a name="l08532"></a>08532           $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l08533"></a>08533           <span class="keywordflow">if</span> ((!$border_style) OR (isset($border_style[<span class="stringliteral">&#39;all&#39;</span>]))) {
<a name="l08534"></a>08534             <span class="keywordflow">if</span> (isset($border_style[<span class="stringliteral">&#39;all&#39;</span>]) AND $border_style[<span class="stringliteral">&#39;all&#39;</span>]) {
<a name="l08535"></a>08535               $this-&gt;SetLineStyle($border_style[<span class="stringliteral">&#39;all&#39;</span>]);
<a name="l08536"></a>08536               $border_style = array();
<a name="l08537"></a>08537             }
<a name="l08538"></a>08538             $this-&gt;_outRect($x, $y, $w, $h, $op);
<a name="l08539"></a>08539           }
<a name="l08540"></a>08540           <span class="keywordflow">break</span>;
<a name="l08541"></a>08541         }
<a name="l08542"></a>08542       }
<a name="l08543"></a>08543       <span class="keywordflow">if</span> ($border_style) {
<a name="l08544"></a>08544         $border_style2 = array();
<a name="l08545"></a>08545         <span class="keywordflow">foreach</span> ($border_style as $line =&gt; $value) {
<a name="l08546"></a>08546           $lenght = strlen($line);
<a name="l08547"></a>08547           <span class="keywordflow">for</span> ($i = 0; $i &lt; $lenght; ++$i) {
<a name="l08548"></a>08548             $border_style2[$line[$i]] = $value;
<a name="l08549"></a>08549           }
<a name="l08550"></a>08550         }
<a name="l08551"></a>08551         $border_style = $border_style2;
<a name="l08552"></a>08552         <span class="keywordflow">if</span> (isset($border_style[<span class="charliteral">&#39;L&#39;</span>]) AND $border_style[<span class="charliteral">&#39;L&#39;</span>]) {
<a name="l08553"></a>08553           $this-&gt;Line($x, $y, $x, $y + $h, $border_style[<span class="charliteral">&#39;L&#39;</span>]);
<a name="l08554"></a>08554         }
<a name="l08555"></a>08555         <span class="keywordflow">if</span> (isset($border_style[<span class="charliteral">&#39;T&#39;</span>]) AND $border_style[<span class="charliteral">&#39;T&#39;</span>]) {
<a name="l08556"></a>08556           $this-&gt;Line($x, $y, $x + $w, $y, $border_style[<span class="charliteral">&#39;T&#39;</span>]);
<a name="l08557"></a>08557         }
<a name="l08558"></a>08558         <span class="keywordflow">if</span> (isset($border_style[<span class="charliteral">&#39;R&#39;</span>]) AND $border_style[<span class="charliteral">&#39;R&#39;</span>]) {
<a name="l08559"></a>08559           $this-&gt;Line($x + $w, $y, $x + $w, $y + $h, $border_style[<span class="charliteral">&#39;R&#39;</span>]);
<a name="l08560"></a>08560         }
<a name="l08561"></a>08561         <span class="keywordflow">if</span> (isset($border_style[<span class="charliteral">&#39;B&#39;</span>]) AND $border_style[<span class="charliteral">&#39;B&#39;</span>]) {
<a name="l08562"></a>08562           $this-&gt;Line($x, $y + $h, $x + $w, $y + $h, $border_style[<span class="charliteral">&#39;B&#39;</span>]);
<a name="l08563"></a>08563         }
<a name="l08564"></a>08564       }
<a name="l08565"></a>08565     }
<a name="l08566"></a>08566     
<a name="l08567"></a>08567     
<a name="l08594"></a>08594     <span class="keyword">public</span> function Curve($x0, $y0, $x1, $y1, $x2, $y2, $x3, $y3, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array()) {
<a name="l08595"></a>08595       <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($style, <span class="charliteral">&#39;F&#39;</span>)) AND isset($fill_color)) {
<a name="l08596"></a>08596         $this-&gt;SetFillColorArray($fill_color);
<a name="l08597"></a>08597       }
<a name="l08598"></a>08598       <span class="keywordflow">switch</span> ($style) {
<a name="l08599"></a>08599         <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l08600"></a>08600           $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08601"></a>08601           $line_style = array();
<a name="l08602"></a>08602           <span class="keywordflow">break</span>;
<a name="l08603"></a>08603         }
<a name="l08604"></a>08604         <span class="keywordflow">case</span> <span class="stringliteral">&#39;FD&#39;</span>: 
<a name="l08605"></a>08605         <span class="keywordflow">case</span> <span class="stringliteral">&#39;DF&#39;</span>: {
<a name="l08606"></a>08606           $op = <span class="charliteral">&#39;B&#39;</span>;
<a name="l08607"></a>08607           <span class="keywordflow">break</span>;
<a name="l08608"></a>08608         }
<a name="l08609"></a>08609         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CNZ&#39;</span>: {
<a name="l08610"></a>08610           $op = <span class="stringliteral">&#39;W n&#39;</span>;
<a name="l08611"></a>08611           <span class="keywordflow">break</span>;
<a name="l08612"></a>08612         }
<a name="l08613"></a>08613         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CEO&#39;</span>: {
<a name="l08614"></a>08614           $op = <span class="stringliteral">&#39;W* n&#39;</span>;
<a name="l08615"></a>08615           <span class="keywordflow">break</span>;
<a name="l08616"></a>08616         }
<a name="l08617"></a>08617         <span class="keywordflow">default</span>: {
<a name="l08618"></a>08618           $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l08619"></a>08619           <span class="keywordflow">break</span>;
<a name="l08620"></a>08620         }
<a name="l08621"></a>08621       }
<a name="l08622"></a>08622       <span class="keywordflow">if</span> ($line_style) {
<a name="l08623"></a>08623         $this-&gt;SetLineStyle($line_style);
<a name="l08624"></a>08624       }
<a name="l08625"></a>08625       $this-&gt;_outPoint($x0, $y0);
<a name="l08626"></a>08626       $this-&gt;_outCurve($x1, $y1, $x2, $y2, $x3, $y3);
<a name="l08627"></a>08627       $this-&gt;_out($op);
<a name="l08628"></a>08628     }
<a name="l08629"></a>08629     
<a name="l08651"></a>08651     <span class="keyword">public</span> function Polycurve($x0, $y0, $segments, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array()) {
<a name="l08652"></a>08652       <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($style, <span class="charliteral">&#39;F&#39;</span>)) AND isset($fill_color)) {
<a name="l08653"></a>08653         $this-&gt;SetFillColorArray($fill_color);
<a name="l08654"></a>08654       }
<a name="l08655"></a>08655       <span class="keywordflow">switch</span> ($style) {
<a name="l08656"></a>08656         <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l08657"></a>08657           $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08658"></a>08658           $line_style = array();
<a name="l08659"></a>08659           <span class="keywordflow">break</span>;
<a name="l08660"></a>08660         }
<a name="l08661"></a>08661         <span class="keywordflow">case</span> <span class="stringliteral">&#39;FD&#39;</span>:
<a name="l08662"></a>08662         <span class="keywordflow">case</span> <span class="stringliteral">&#39;DF&#39;</span>: {
<a name="l08663"></a>08663           $op = <span class="charliteral">&#39;B&#39;</span>;
<a name="l08664"></a>08664           <span class="keywordflow">break</span>;
<a name="l08665"></a>08665         }
<a name="l08666"></a>08666         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CNZ&#39;</span>: {
<a name="l08667"></a>08667           $op = <span class="stringliteral">&#39;W n&#39;</span>;
<a name="l08668"></a>08668           <span class="keywordflow">break</span>;
<a name="l08669"></a>08669         }
<a name="l08670"></a>08670         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CEO&#39;</span>: {
<a name="l08671"></a>08671           $op = <span class="stringliteral">&#39;W* n&#39;</span>;
<a name="l08672"></a>08672           <span class="keywordflow">break</span>;
<a name="l08673"></a>08673         }
<a name="l08674"></a>08674         <span class="keywordflow">default</span>: {
<a name="l08675"></a>08675           $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l08676"></a>08676           <span class="keywordflow">break</span>;
<a name="l08677"></a>08677         }
<a name="l08678"></a>08678       }
<a name="l08679"></a>08679       <span class="keywordflow">if</span> ($line_style) {
<a name="l08680"></a>08680         $this-&gt;SetLineStyle($line_style);
<a name="l08681"></a>08681       }
<a name="l08682"></a>08682       $this-&gt;_outPoint($x0, $y0);
<a name="l08683"></a>08683       <span class="keywordflow">foreach</span> ($segments as $segment) {
<a name="l08684"></a>08684         list($x1, $y1, $x2, $y2, $x3, $y3) = $segment;
<a name="l08685"></a>08685         $this-&gt;_outCurve($x1, $y1, $x2, $y2, $x3, $y3);
<a name="l08686"></a>08686       } 
<a name="l08687"></a>08687       $this-&gt;_out($op);
<a name="l08688"></a>08688     }
<a name="l08689"></a>08689     
<a name="l08715"></a>08715     <span class="keyword">public</span> function Ellipse($x0, $y0, $rx, $ry=0, $angle=0, $astart=0, $afinish=360, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array(), $nc=8) {
<a name="l08716"></a>08716       <span class="keywordflow">if</span> ($angle) {
<a name="l08717"></a>08717         $this-&gt;StartTransform();
<a name="l08718"></a>08718         $this-&gt;Rotate($angle, $x0, $y0);
<a name="l08719"></a>08719         $this-&gt;Ellipse($x0, $y0, $rx, $ry, 0, $astart, $afinish, $style, $line_style, $fill_color, $nc);
<a name="l08720"></a>08720         $this-&gt;StopTransform();
<a name="l08721"></a>08721         <span class="keywordflow">return</span>;
<a name="l08722"></a>08722       }
<a name="l08723"></a>08723       <span class="keywordflow">if</span> ($rx) {
<a name="l08724"></a>08724         <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($style, <span class="charliteral">&#39;F&#39;</span>)) AND isset($fill_color)) {
<a name="l08725"></a>08725           $this-&gt;SetFillColorArray($fill_color);
<a name="l08726"></a>08726         }
<a name="l08727"></a>08727         <span class="keywordflow">switch</span> ($style) {
<a name="l08728"></a>08728           <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l08729"></a>08729             $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08730"></a>08730             $line_style = array();
<a name="l08731"></a>08731             <span class="keywordflow">break</span>;
<a name="l08732"></a>08732           }
<a name="l08733"></a>08733           <span class="keywordflow">case</span> <span class="stringliteral">&#39;FD&#39;</span>: 
<a name="l08734"></a>08734           <span class="keywordflow">case</span> <span class="stringliteral">&#39;DF&#39;</span>: {
<a name="l08735"></a>08735             $op = <span class="charliteral">&#39;B&#39;</span>;
<a name="l08736"></a>08736             <span class="keywordflow">break</span>;
<a name="l08737"></a>08737           }
<a name="l08738"></a>08738           <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>: {
<a name="l08739"></a>08739             $op = <span class="charliteral">&#39;s&#39;</span>; <span class="comment">// Small &#39;s&#39; signifies closing the path as well</span>
<a name="l08740"></a>08740             <span class="keywordflow">break</span>;
<a name="l08741"></a>08741           }
<a name="l08742"></a>08742           <span class="keywordflow">case</span> <span class="stringliteral">&#39;CNZ&#39;</span>: {
<a name="l08743"></a>08743             $op = <span class="stringliteral">&#39;W n&#39;</span>;
<a name="l08744"></a>08744             <span class="keywordflow">break</span>;
<a name="l08745"></a>08745           }
<a name="l08746"></a>08746           <span class="keywordflow">case</span> <span class="stringliteral">&#39;CEO&#39;</span>: {
<a name="l08747"></a>08747             $op = <span class="stringliteral">&#39;W* n&#39;</span>;
<a name="l08748"></a>08748             <span class="keywordflow">break</span>;
<a name="l08749"></a>08749           }
<a name="l08750"></a>08750           <span class="keywordflow">default</span>: {
<a name="l08751"></a>08751             $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l08752"></a>08752             <span class="keywordflow">break</span>;
<a name="l08753"></a>08753           }
<a name="l08754"></a>08754         }
<a name="l08755"></a>08755         <span class="keywordflow">if</span> ($line_style) {
<a name="l08756"></a>08756           $this-&gt;SetLineStyle($line_style);
<a name="l08757"></a>08757         }
<a name="l08758"></a>08758         <span class="keywordflow">if</span> (!$ry) {
<a name="l08759"></a>08759           $ry = $rx;
<a name="l08760"></a>08760         }
<a name="l08761"></a>08761         $rx *= $this-&gt;k;
<a name="l08762"></a>08762         $ry *= $this-&gt;k;
<a name="l08763"></a>08763         <span class="keywordflow">if</span> ($nc &lt; 2) {
<a name="l08764"></a>08764           $nc = 2;
<a name="l08765"></a>08765         }
<a name="l08766"></a>08766         $astart = deg2rad((<span class="keywordtype">float</span>) $astart);
<a name="l08767"></a>08767         $afinish = deg2rad((<span class="keywordtype">float</span>) $afinish);
<a name="l08768"></a>08768         $total_angle = $afinish - $astart;
<a name="l08769"></a>08769         $dt = $total_angle / $nc;
<a name="l08770"></a>08770         $dtm = $dt / 3;
<a name="l08771"></a>08771         $x0 *= $this-&gt;k;
<a name="l08772"></a>08772         $y0 = ($this-&gt;h - $y0) * $this-&gt;k;
<a name="l08773"></a>08773         $t1 = $astart;
<a name="l08774"></a>08774         $a0 = $x0 + ($rx * cos($t1));
<a name="l08775"></a>08775         $b0 = $y0 + ($ry * sin($t1));
<a name="l08776"></a>08776         $c0 = -$rx * sin($t1);
<a name="l08777"></a>08777         $d0 = $ry * cos($t1);
<a name="l08778"></a>08778         $this-&gt;_outPoint($a0 / $this-&gt;k, $this-&gt;h - ($b0 / $this-&gt;k));
<a name="l08779"></a>08779         <span class="keywordflow">for</span> ($i = 1; $i &lt;= $nc; ++$i) {
<a name="l08780"></a>08780           <span class="comment">// Draw this bit of the total curve</span>
<a name="l08781"></a>08781           $t1 = ($i * $dt) + $astart;
<a name="l08782"></a>08782           $a1 = $x0 + ($rx * cos($t1));
<a name="l08783"></a>08783           $b1 = $y0 + ($ry * sin($t1));
<a name="l08784"></a>08784           $c1 = -$rx * sin($t1);
<a name="l08785"></a>08785           $d1 = $ry * cos($t1);
<a name="l08786"></a>08786           $this-&gt;_outCurve(($a0 + ($c0 * $dtm)) / $this-&gt;k, $this-&gt;h - (($b0 + ($d0 * $dtm)) / $this-&gt;k), ($a1 - ($c1 * $dtm)) / $this-&gt;k, $this-&gt;h - (($b1 - ($d1 * $dtm)) / $this-&gt;k), $a1 / $this-&gt;k, $this-&gt;h - ($b1 / $this-&gt;k));
<a name="l08787"></a>08787           $a0 = $a1;
<a name="l08788"></a>08788           $b0 = $b1;
<a name="l08789"></a>08789           $c0 = $c1;
<a name="l08790"></a>08790           $d0 = $d1;
<a name="l08791"></a>08791         }
<a name="l08792"></a>08792         $this-&gt;_out($op);
<a name="l08793"></a>08793       }
<a name="l08794"></a>08794     }
<a name="l08795"></a>08795     
<a name="l08819"></a>08819     <span class="keyword">public</span> function Circle($x0, $y0, $r, $astart=0, $afinish=360, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array(), $nc=8) {
<a name="l08820"></a>08820       $this-&gt;Ellipse($x0, $y0, $r, 0, 0, $astart, $afinish, $style, $line_style, $fill_color, $nc);
<a name="l08821"></a>08821     }
<a name="l08822"></a>08822 
<a name="l08845"></a>08845     <span class="keyword">public</span> function PolyLine($p, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array()) {
<a name="l08846"></a>08846       $this-&gt;<a class="code" href="classPolygon.html">Polygon</a>($p, $style, $line_style, $fill_color, <span class="keyword">false</span>);
<a name="l08847"></a>08847     }
<a name="l08848"></a>08848 
<a name="l08871"></a>08871     <span class="keyword">public</span> function <a class="code" href="classPolygon.html">Polygon</a>($p, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array(), $closed=<span class="keyword">true</span>) {
<a name="l08872"></a>08872       $nc = count($p); <span class="comment">// number of coordinates</span>
<a name="l08873"></a>08873       $np = $nc / 2; <span class="comment">// number of points</span>
<a name="l08874"></a>08874       <span class="keywordflow">if</span> ($closed) {
<a name="l08875"></a>08875         <span class="comment">// close polygon by adding the first 2 points at the end (one line)</span>
<a name="l08876"></a>08876         <span class="keywordflow">for</span> ($i = 0; $i &lt; 4; ++$i) {
<a name="l08877"></a>08877           $p[$nc + $i] = $p[$i];
<a name="l08878"></a>08878         }
<a name="l08879"></a>08879         <span class="comment">// copy style for the last added line</span>
<a name="l08880"></a>08880         <span class="keywordflow">if</span> (isset($line_style[0])) {
<a name="l08881"></a>08881           $line_style[$np] = $line_style[0];
<a name="l08882"></a>08882         }     
<a name="l08883"></a>08883         $nc += 4;
<a name="l08884"></a>08884       }
<a name="l08885"></a>08885       <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($style, <span class="charliteral">&#39;F&#39;</span>)) AND isset($fill_color)) {
<a name="l08886"></a>08886         $this-&gt;SetFillColorArray($fill_color);
<a name="l08887"></a>08887       }
<a name="l08888"></a>08888       <span class="keywordflow">switch</span> ($style) {
<a name="l08889"></a>08889         <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l08890"></a>08890           $line_style = array();
<a name="l08891"></a>08891           $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08892"></a>08892           <span class="keywordflow">break</span>;
<a name="l08893"></a>08893         }
<a name="l08894"></a>08894         <span class="keywordflow">case</span> <span class="stringliteral">&#39;FD&#39;</span>: 
<a name="l08895"></a>08895         <span class="keywordflow">case</span> <span class="stringliteral">&#39;DF&#39;</span>: {
<a name="l08896"></a>08896           $op = <span class="charliteral">&#39;B&#39;</span>;
<a name="l08897"></a>08897           <span class="keywordflow">break</span>;
<a name="l08898"></a>08898         }
<a name="l08899"></a>08899         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CNZ&#39;</span>: {
<a name="l08900"></a>08900           $op = <span class="stringliteral">&#39;W n&#39;</span>;
<a name="l08901"></a>08901           <span class="keywordflow">break</span>;
<a name="l08902"></a>08902         }
<a name="l08903"></a>08903         <span class="keywordflow">case</span> <span class="stringliteral">&#39;CEO&#39;</span>: {
<a name="l08904"></a>08904           $op = <span class="stringliteral">&#39;W* n&#39;</span>;
<a name="l08905"></a>08905           <span class="keywordflow">break</span>;
<a name="l08906"></a>08906         }       
<a name="l08907"></a>08907         <span class="keywordflow">default</span>: {
<a name="l08908"></a>08908           $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l08909"></a>08909           <span class="keywordflow">break</span>;
<a name="l08910"></a>08910         }
<a name="l08911"></a>08911       }
<a name="l08912"></a>08912       $draw = <span class="keyword">true</span>;
<a name="l08913"></a>08913       <span class="keywordflow">if</span> ($line_style) {
<a name="l08914"></a>08914         <span class="keywordflow">if</span> (isset($line_style[<span class="stringliteral">&#39;all&#39;</span>])) {
<a name="l08915"></a>08915           $this-&gt;SetLineStyle($line_style[<span class="stringliteral">&#39;all&#39;</span>]);
<a name="l08916"></a>08916         } <span class="keywordflow">else</span> {
<a name="l08917"></a>08917           $draw = <span class="keyword">false</span>;
<a name="l08918"></a>08918           <span class="keywordflow">if</span> ($op == <span class="charliteral">&#39;B&#39;</span>) {
<a name="l08919"></a>08919             <span class="comment">// draw fill</span>
<a name="l08920"></a>08920             $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l08921"></a>08921             $this-&gt;_outPoint($p[0], $p[1]);
<a name="l08922"></a>08922             <span class="keywordflow">for</span> ($i = 2; $i &lt; $nc; $i = $i + 2) {
<a name="l08923"></a>08923               $this-&gt;_outLine($p[$i], $p[$i + 1]);
<a name="l08924"></a>08924             }
<a name="l08925"></a>08925             $this-&gt;_out($op);
<a name="l08926"></a>08926           }
<a name="l08927"></a>08927           <span class="comment">// draw outline</span>
<a name="l08928"></a>08928           $this-&gt;_outPoint($p[0], $p[1]);
<a name="l08929"></a>08929           <span class="keywordflow">for</span> ($i = 2; $i &lt; $nc; $i = $i + 2) {
<a name="l08930"></a>08930             $line_num = ($i / 2) - 1;
<a name="l08931"></a>08931             <span class="keywordflow">if</span> (isset($line_style[$line_num])) {
<a name="l08932"></a>08932               <span class="keywordflow">if</span> ($line_style[$line_num] != 0) {
<a name="l08933"></a>08933                 <span class="keywordflow">if</span> (is_array($line_style[$line_num])) {
<a name="l08934"></a>08934                   $this-&gt;_out(<span class="charliteral">&#39;S&#39;</span>);
<a name="l08935"></a>08935                   $this-&gt;SetLineStyle($line_style[$line_num]);
<a name="l08936"></a>08936                   $this-&gt;_outPoint($p[$i - 2], $p[$i - 1]);
<a name="l08937"></a>08937                   $this-&gt;_outLine($p[$i], $p[$i + 1]);
<a name="l08938"></a>08938                   $this-&gt;_out(<span class="charliteral">&#39;S&#39;</span>);
<a name="l08939"></a>08939                   $this-&gt;_outPoint($p[$i], $p[$i + 1]);
<a name="l08940"></a>08940                 } <span class="keywordflow">else</span> {
<a name="l08941"></a>08941                   $this-&gt;_outLine($p[$i], $p[$i + 1]);
<a name="l08942"></a>08942                 }
<a name="l08943"></a>08943               }
<a name="l08944"></a>08944             } <span class="keywordflow">else</span> {
<a name="l08945"></a>08945               $this-&gt;_outLine($p[$i], $p[$i + 1]);
<a name="l08946"></a>08946             }
<a name="l08947"></a>08947           }
<a name="l08948"></a>08948           $this-&gt;_out($op);
<a name="l08949"></a>08949         }
<a name="l08950"></a>08950       }
<a name="l08951"></a>08951       <span class="keywordflow">if</span> ($draw) {
<a name="l08952"></a>08952         $this-&gt;_outPoint($p[0], $p[1]);
<a name="l08953"></a>08953         <span class="keywordflow">for</span> ($i = 2; $i &lt; $nc; $i = $i + 2) {
<a name="l08954"></a>08954           $this-&gt;_outLine($p[$i], $p[$i + 1]);
<a name="l08955"></a>08955         }
<a name="l08956"></a>08956         $this-&gt;_out($op);
<a name="l08957"></a>08957       }
<a name="l08958"></a>08958     }
<a name="l08959"></a>08959     
<a name="l08996"></a>08996     <span class="keyword">public</span> function RegularPolygon($x0, $y0, $r, $ns, $angle=0, $draw_circle=<span class="keyword">false</span>, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array(), $circle_style=<span class="stringliteral">&#39;&#39;</span>, $circle_outLine_style=array(), $circle_fill_color=array()) {
<a name="l08997"></a>08997       <span class="keywordflow">if</span> (3 &gt; $ns) {
<a name="l08998"></a>08998         $ns = 3;
<a name="l08999"></a>08999       }
<a name="l09000"></a>09000       <span class="keywordflow">if</span> ($draw_circle) {
<a name="l09001"></a>09001         $this-&gt;Circle($x0, $y0, $r, 0, 360, $circle_style, $circle_outLine_style, $circle_fill_color);
<a name="l09002"></a>09002       }
<a name="l09003"></a>09003       $p = array();
<a name="l09004"></a>09004       <span class="keywordflow">for</span> ($i = 0; $i &lt; $ns; ++$i) {
<a name="l09005"></a>09005         $a = $angle + ($i * 360 / $ns);
<a name="l09006"></a>09006         $a_rad = deg2rad((<span class="keywordtype">float</span>) $a);
<a name="l09007"></a>09007         $p[] = $x0 + ($r * sin($a_rad));
<a name="l09008"></a>09008         $p[] = $y0 + ($r * cos($a_rad));
<a name="l09009"></a>09009       }
<a name="l09010"></a>09010       $this-&gt;<a class="code" href="classPolygon.html">Polygon</a>($p, $style, $line_style, $fill_color);
<a name="l09011"></a>09011     }
<a name="l09012"></a>09012     
<a name="l09051"></a>09051     <span class="keyword">public</span> function StarPolygon($x0, $y0, $r, $nv, $ng, $angle=0, $draw_circle=<span class="keyword">false</span>, $style=<span class="stringliteral">&#39;&#39;</span>, $line_style=array(), $fill_color=array(), $circle_style=<span class="stringliteral">&#39;&#39;</span>, $circle_outLine_style=array(), $circle_fill_color=array()) {
<a name="l09052"></a>09052       <span class="keywordflow">if</span> ($nv &lt; 2) {
<a name="l09053"></a>09053         $nv = 2;
<a name="l09054"></a>09054       }
<a name="l09055"></a>09055       <span class="keywordflow">if</span> ($draw_circle) {
<a name="l09056"></a>09056         $this-&gt;Circle($x0, $y0, $r, 0, 360, $circle_style, $circle_outLine_style, $circle_fill_color);
<a name="l09057"></a>09057       }
<a name="l09058"></a>09058       $p2 = array();
<a name="l09059"></a>09059       $visited = array();
<a name="l09060"></a>09060       <span class="keywordflow">for</span> ($i = 0; $i &lt; $nv; ++$i) {
<a name="l09061"></a>09061         $a = $angle + ($i * 360 / $nv);
<a name="l09062"></a>09062         $a_rad = deg2rad((<span class="keywordtype">float</span>) $a);
<a name="l09063"></a>09063         $p2[] = $x0 + ($r * sin($a_rad));
<a name="l09064"></a>09064         $p2[] = $y0 + ($r * cos($a_rad));
<a name="l09065"></a>09065         $visited[] = <span class="keyword">false</span>;
<a name="l09066"></a>09066       }
<a name="l09067"></a>09067       $p = array();
<a name="l09068"></a>09068       $i = 0;
<a name="l09069"></a>09069       <span class="keywordflow">do</span> {
<a name="l09070"></a>09070         $p[] = $p2[$i * 2];
<a name="l09071"></a>09071         $p[] = $p2[($i * 2) + 1];
<a name="l09072"></a>09072         $visited[$i] = <span class="keyword">true</span>;
<a name="l09073"></a>09073         $i += $ng;
<a name="l09074"></a>09074         $i %= $nv;
<a name="l09075"></a>09075       } <span class="keywordflow">while</span> (!$visited[$i]);
<a name="l09076"></a>09076       $this-&gt;<a class="code" href="classPolygon.html">Polygon</a>($p, $style, $line_style, $fill_color);
<a name="l09077"></a>09077     }
<a name="l09078"></a>09078     
<a name="l09100"></a>09100     <span class="keyword">public</span> function RoundedRect($x, $y, $w, $h, $r, $round_corner=<span class="stringliteral">&#39;1111&#39;</span>, $style=<span class="stringliteral">&#39;&#39;</span>, $border_style=array(), $fill_color=array()) {
<a name="l09101"></a>09101       <span class="keywordflow">if</span> (<span class="stringliteral">&#39;0000&#39;</span> == $round_corner) { <span class="comment">// Not rounded</span>
<a name="l09102"></a>09102         $this-&gt;Rect($x, $y, $w, $h, $style, $border_style, $fill_color);
<a name="l09103"></a>09103       } <span class="keywordflow">else</span> { <span class="comment">// Rounded</span>
<a name="l09104"></a>09104         <span class="keywordflow">if</span> (!(<span class="keyword">false</span> === strpos($style, <span class="charliteral">&#39;F&#39;</span>)) AND isset($fill_color)) {
<a name="l09105"></a>09105           $this-&gt;SetFillColorArray($fill_color);
<a name="l09106"></a>09106         }
<a name="l09107"></a>09107         <span class="keywordflow">switch</span> ($style) {
<a name="l09108"></a>09108           <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l09109"></a>09109             $border_style = array();
<a name="l09110"></a>09110             $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l09111"></a>09111             <span class="keywordflow">break</span>;
<a name="l09112"></a>09112           }
<a name="l09113"></a>09113           <span class="keywordflow">case</span> <span class="stringliteral">&#39;FD&#39;</span>: 
<a name="l09114"></a>09114           <span class="keywordflow">case</span> <span class="stringliteral">&#39;DF&#39;</span>: {
<a name="l09115"></a>09115             $op = <span class="charliteral">&#39;B&#39;</span>;
<a name="l09116"></a>09116             <span class="keywordflow">break</span>;
<a name="l09117"></a>09117           }
<a name="l09118"></a>09118           <span class="keywordflow">case</span> <span class="stringliteral">&#39;CNZ&#39;</span>: {
<a name="l09119"></a>09119             $op = <span class="stringliteral">&#39;W n&#39;</span>;
<a name="l09120"></a>09120             <span class="keywordflow">break</span>;
<a name="l09121"></a>09121           }
<a name="l09122"></a>09122           <span class="keywordflow">case</span> <span class="stringliteral">&#39;CEO&#39;</span>: {
<a name="l09123"></a>09123             $op = <span class="stringliteral">&#39;W* n&#39;</span>;
<a name="l09124"></a>09124             <span class="keywordflow">break</span>;
<a name="l09125"></a>09125           }
<a name="l09126"></a>09126           <span class="keywordflow">default</span>: {
<a name="l09127"></a>09127             $op = <span class="charliteral">&#39;S&#39;</span>;
<a name="l09128"></a>09128             <span class="keywordflow">break</span>;
<a name="l09129"></a>09129           }
<a name="l09130"></a>09130         }
<a name="l09131"></a>09131         <span class="keywordflow">if</span> ($border_style) {
<a name="l09132"></a>09132           $this-&gt;SetLineStyle($border_style);
<a name="l09133"></a>09133         }
<a name="l09134"></a>09134         $MyArc = 4 / 3 * (sqrt(2) - 1);
<a name="l09135"></a>09135         $this-&gt;_outPoint($x + $r, $y);
<a name="l09136"></a>09136         $xc = $x + $w - $r;
<a name="l09137"></a>09137         $yc = $y + $r;
<a name="l09138"></a>09138         $this-&gt;_outLine($xc, $y);
<a name="l09139"></a>09139         <span class="keywordflow">if</span> ($round_corner[0]) {
<a name="l09140"></a>09140           $this-&gt;_outCurve($xc + ($r * $MyArc), $yc - $r, $xc + $r, $yc - ($r * $MyArc), $xc + $r, $yc);
<a name="l09141"></a>09141         } <span class="keywordflow">else</span> {
<a name="l09142"></a>09142           $this-&gt;_outLine($x + $w, $y);
<a name="l09143"></a>09143         }
<a name="l09144"></a>09144         $xc = $x + $w - $r;
<a name="l09145"></a>09145         $yc = $y + $h - $r;
<a name="l09146"></a>09146         $this-&gt;_outLine($x + $w, $yc);
<a name="l09147"></a>09147         <span class="keywordflow">if</span> ($round_corner[1]) {
<a name="l09148"></a>09148           $this-&gt;_outCurve($xc + $r, $yc + ($r * $MyArc), $xc + ($r * $MyArc), $yc + $r, $xc, $yc + $r);
<a name="l09149"></a>09149         } <span class="keywordflow">else</span> {
<a name="l09150"></a>09150           $this-&gt;_outLine($x + $w, $y + $h);
<a name="l09151"></a>09151         }
<a name="l09152"></a>09152         $xc = $x + $r;
<a name="l09153"></a>09153         $yc = $y + $h - $r;
<a name="l09154"></a>09154         $this-&gt;_outLine($xc, $y + $h);
<a name="l09155"></a>09155         <span class="keywordflow">if</span> ($round_corner[2]) {
<a name="l09156"></a>09156           $this-&gt;_outCurve($xc - ($r * $MyArc), $yc + $r, $xc - $r, $yc + ($r * $MyArc), $xc - $r, $yc);
<a name="l09157"></a>09157         } <span class="keywordflow">else</span> {
<a name="l09158"></a>09158           $this-&gt;_outLine($x, $y + $h);
<a name="l09159"></a>09159         }
<a name="l09160"></a>09160         $xc = $x + $r;
<a name="l09161"></a>09161         $yc = $y + $r;
<a name="l09162"></a>09162         $this-&gt;_outLine($x, $yc);
<a name="l09163"></a>09163         <span class="keywordflow">if</span> ($round_corner[3]) {
<a name="l09164"></a>09164           $this-&gt;_outCurve($xc - $r, $yc - ($r * $MyArc), $xc - ($r * $MyArc), $yc - $r, $xc, $yc - $r);
<a name="l09165"></a>09165         } <span class="keywordflow">else</span> {
<a name="l09166"></a>09166           $this-&gt;_outLine($x, $y);
<a name="l09167"></a>09167           $this-&gt;_outLine($x + $r, $y);
<a name="l09168"></a>09168         }
<a name="l09169"></a>09169         $this-&gt;_out($op);
<a name="l09170"></a>09170       }
<a name="l09171"></a>09171     }
<a name="l09172"></a>09172     
<a name="l09185"></a>09185     <span class="keyword">public</span> function Arrow($x0, $y0, $x1, $y1, $head_style=0, $arm_size=5, $arm_angle=15) {
<a name="l09186"></a>09186       <span class="comment">// getting arrow direction angle</span>
<a name="l09187"></a>09187       <span class="comment">// 0 deg angle is when both arms go along X axis. angle grows clockwise.</span>
<a name="l09188"></a>09188       $dir_angle = rad2deg(atan2(($y0 - $y1), ($x0 - $x1)));
<a name="l09189"></a>09189       $sx1 = $x1;
<a name="l09190"></a>09190       $sy1 = $y1;
<a name="l09191"></a>09191       <span class="keywordflow">if</span> ($head_style &gt; 0) {
<a name="l09192"></a>09192         <span class="comment">// calculate the stopping point for the arrow shaft</span>
<a name="l09193"></a>09193         $sx1 = $x1 + (($arm_size - $this-&gt;LineWidth) * cos(deg2rad($dir_angle)));
<a name="l09194"></a>09194         $sy1 = $y1 + (($arm_size - $this-&gt;LineWidth) * sin(deg2rad($dir_angle)));
<a name="l09195"></a>09195       } 
<a name="l09196"></a>09196       <span class="comment">// main arrow line / shaft</span>
<a name="l09197"></a>09197       $this-&gt;Line($x0, $y0, $sx1, $sy1);
<a name="l09198"></a>09198       <span class="comment">// left arrowhead arm tip</span>
<a name="l09199"></a>09199       $x2L = $x1 + ($arm_size * cos(deg2rad($dir_angle + $arm_angle)));
<a name="l09200"></a>09200       $y2L = $y1 + ($arm_size * sin(deg2rad($dir_angle + $arm_angle)));
<a name="l09201"></a>09201       <span class="comment">// right arrowhead arm tip</span>
<a name="l09202"></a>09202       $x2R = $x1 + ($arm_size * cos(deg2rad($dir_angle - $arm_angle)));
<a name="l09203"></a>09203       $y2R = $y1 + ($arm_size * sin(deg2rad($dir_angle - $arm_angle)));
<a name="l09204"></a>09204       $mode = <span class="charliteral">&#39;D&#39;</span>;
<a name="l09205"></a>09205       $style = array();
<a name="l09206"></a>09206       <span class="keywordflow">switch</span> ($head_style) {
<a name="l09207"></a>09207         <span class="keywordflow">case</span> 0: {
<a name="l09208"></a>09208           <span class="comment">// draw only arrowhead arms</span>
<a name="l09209"></a>09209           $mode = <span class="charliteral">&#39;D&#39;</span>;
<a name="l09210"></a>09210           $style = array(1, 1, 0);
<a name="l09211"></a>09211           <span class="keywordflow">break</span>;
<a name="l09212"></a>09212         }
<a name="l09213"></a>09213         <span class="keywordflow">case</span> 1: {
<a name="l09214"></a>09214           <span class="comment">// draw closed arrowhead, but no fill</span>
<a name="l09215"></a>09215           $mode = <span class="charliteral">&#39;D&#39;</span>;
<a name="l09216"></a>09216           <span class="keywordflow">break</span>;
<a name="l09217"></a>09217         }
<a name="l09218"></a>09218         <span class="keywordflow">case</span> 2: {
<a name="l09219"></a>09219           <span class="comment">// closed and filled arrowhead</span>
<a name="l09220"></a>09220           $mode = <span class="stringliteral">&#39;DF&#39;</span>;
<a name="l09221"></a>09221           <span class="keywordflow">break</span>;
<a name="l09222"></a>09222         }
<a name="l09223"></a>09223         <span class="keywordflow">case</span> 3: {
<a name="l09224"></a>09224           <span class="comment">// filled arrowhead</span>
<a name="l09225"></a>09225           $mode = <span class="charliteral">&#39;F&#39;</span>;
<a name="l09226"></a>09226           <span class="keywordflow">break</span>;
<a name="l09227"></a>09227         }
<a name="l09228"></a>09228       }
<a name="l09229"></a>09229       $this-&gt;<a class="code" href="classPolygon.html">Polygon</a>(array($x2L, $y2L, $x1, $y1, $x2R, $y2R), $mode, $style, array());
<a name="l09230"></a>09230     }
<a name="l09231"></a>09231     
<a name="l09232"></a>09232     <span class="comment">// END GRAPHIC FUNCTIONS SECTION -----------------------</span>
<a name="l09233"></a>09233     
<a name="l09234"></a>09234     <span class="comment">// BIDIRECTIONAL TEXT SECTION --------------------------</span>
<a name="l09244"></a>09244 <span class="comment"></span>    <span class="keyword">protected</span> function utf8StrRev($str, $setbom=<span class="keyword">false</span>, $forcertl=<span class="keyword">false</span>) {
<a name="l09245"></a>09245       <span class="keywordflow">return</span> $this-&gt;arrUTF8ToUTF16BE($this-&gt;utf8Bidi($this-&gt;UTF8StringToArray($str), $str, $forcertl), $setbom);
<a name="l09246"></a>09246     }
<a name="l09247"></a>09247     
<a name="l09258"></a>09258     <span class="keyword">protected</span> function utf8Bidi($ta, $str=<span class="stringliteral">&#39;&#39;</span>, $forcertl=<span class="keyword">false</span>) {
<a name="l09259"></a>09259       global $unicode, $unicode_mirror, $unicode_arlet, $laa_array, $diacritics;
<a name="l09260"></a>09260       <span class="comment">// paragraph embedding level</span>
<a name="l09261"></a>09261       $pel = 0;
<a name="l09262"></a>09262       <span class="comment">// max level</span>
<a name="l09263"></a>09263       $maxlevel = 0;
<a name="l09264"></a>09264       <span class="keywordflow">if</span> ($this-&gt;empty_string($str)) {
<a name="l09265"></a>09265         <span class="comment">// create string from array</span>
<a name="l09266"></a>09266         $str = $this-&gt;UTF8ArrSubString($ta);
<a name="l09267"></a>09267       }
<a name="l09268"></a>09268       <span class="comment">// check if string contains arabic text</span>
<a name="l09269"></a>09269       <span class="keywordflow">if</span> (preg_match(K_RE_PATTERN_ARABIC, $str)) {
<a name="l09270"></a>09270         $arabic = <span class="keyword">true</span>;
<a name="l09271"></a>09271       } <span class="keywordflow">else</span> {
<a name="l09272"></a>09272         $arabic = <span class="keyword">false</span>;
<a name="l09273"></a>09273       }
<a name="l09274"></a>09274       <span class="comment">// check if string contains RTL text</span>
<a name="l09275"></a>09275       <span class="keywordflow">if</span> (!($forcertl OR $arabic OR preg_match(K_RE_PATTERN_RTL, $str))) {
<a name="l09276"></a>09276         <span class="keywordflow">return</span> $ta;
<a name="l09277"></a>09277       }
<a name="l09278"></a>09278       
<a name="l09279"></a>09279       <span class="comment">// get number of chars</span>
<a name="l09280"></a>09280       $numchars = count($ta);
<a name="l09281"></a>09281       
<a name="l09282"></a>09282       <span class="keywordflow">if</span> ($forcertl == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l09283"></a>09283           $pel = 1;
<a name="l09284"></a>09284       } elseif ($forcertl == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l09285"></a>09285           $pel = 0;
<a name="l09286"></a>09286       } <span class="keywordflow">else</span> {
<a name="l09287"></a>09287         <span class="comment">// P2. In each paragraph, find the first character of type L, AL, or R.</span>
<a name="l09288"></a>09288         <span class="comment">// P3. If a character is found in P2 and it is of type AL or R, then set the paragraph embedding level to one; otherwise, set it to zero.</span>
<a name="l09289"></a>09289         <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09290"></a>09290           $type = $unicode[$ta[$i]];
<a name="l09291"></a>09291           <span class="keywordflow">if</span> ($type == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l09292"></a>09292             $pel = 0;
<a name="l09293"></a>09293             <span class="keywordflow">break</span>;
<a name="l09294"></a>09294           } elseif (($type == <span class="stringliteral">&#39;AL&#39;</span>) OR ($type == <span class="charliteral">&#39;R&#39;</span>)) {
<a name="l09295"></a>09295             $pel = 1;
<a name="l09296"></a>09296             <span class="keywordflow">break</span>;
<a name="l09297"></a>09297           }
<a name="l09298"></a>09298         }
<a name="l09299"></a>09299       }
<a name="l09300"></a>09300       
<a name="l09301"></a>09301       <span class="comment">// Current Embedding Level</span>
<a name="l09302"></a>09302       $cel = $pel;
<a name="l09303"></a>09303       <span class="comment">// directional override status</span>
<a name="l09304"></a>09304       $dos = <span class="charliteral">&#39;N&#39;</span>;
<a name="l09305"></a>09305       $remember = array();
<a name="l09306"></a>09306       <span class="comment">// start-of-level-run</span>
<a name="l09307"></a>09307       $sor = $pel % 2 ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l09308"></a>09308       $eor = $sor;
<a name="l09309"></a>09309       
<a name="l09310"></a>09310       <span class="comment">// Array of characters data</span>
<a name="l09311"></a>09311       $chardata = Array();
<a name="l09312"></a>09312       
<a name="l09313"></a>09313       <span class="comment">// X1. Begin by setting the current embedding level to the paragraph embedding level. Set the directional override status to neutral. Process each character iteratively, applying rules X2 through X9. Only embedding levels from 0 to 61 are valid in this phase.</span>
<a name="l09314"></a>09314       <span class="comment">//  In the resolution of levels in rules I1 and I2, the maximum embedding level of 62 can be reached.</span>
<a name="l09315"></a>09315       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09316"></a>09316         <span class="keywordflow">if</span> ($ta[$i] == K_RLE) {
<a name="l09317"></a>09317           <span class="comment">// X2. With each RLE, compute the least greater odd embedding level.</span>
<a name="l09318"></a>09318           <span class="comment">//  a. If this new level would be valid, then this embedding code is valid. Remember (push) the current embedding level and override status. Reset the current level to this new level, and reset the override status to neutral.</span>
<a name="l09319"></a>09319           <span class="comment">//  b. If the new level would not be valid, then this code is invalid. Do not change the current level or override status.</span>
<a name="l09320"></a>09320           $next_level = $cel + ($cel % 2) + 1;
<a name="l09321"></a>09321           <span class="keywordflow">if</span> ($next_level &lt; 62) {
<a name="l09322"></a>09322             $remember[] = array(<span class="stringliteral">&#39;num&#39;</span> =&gt; K_RLE, <span class="stringliteral">&#39;cel&#39;</span> =&gt; $cel, <span class="stringliteral">&#39;dos&#39;</span> =&gt; $dos);
<a name="l09323"></a>09323             $cel = $next_level;
<a name="l09324"></a>09324             $dos = <span class="charliteral">&#39;N&#39;</span>;
<a name="l09325"></a>09325             $sor = $eor;
<a name="l09326"></a>09326             $eor = $cel % 2 ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l09327"></a>09327           }
<a name="l09328"></a>09328         } elseif ($ta[$i] == K_LRE) {
<a name="l09329"></a>09329           <span class="comment">// X3. With each LRE, compute the least greater even embedding level.</span>
<a name="l09330"></a>09330           <span class="comment">//  a. If this new level would be valid, then this embedding code is valid. Remember (push) the current embedding level and override status. Reset the current level to this new level, and reset the override status to neutral.</span>
<a name="l09331"></a>09331           <span class="comment">//  b. If the new level would not be valid, then this code is invalid. Do not change the current level or override status.</span>
<a name="l09332"></a>09332           $next_level = $cel + 2 - ($cel % 2);
<a name="l09333"></a>09333           <span class="keywordflow">if</span> ( $next_level &lt; 62 ) {
<a name="l09334"></a>09334             $remember[] = array(<span class="stringliteral">&#39;num&#39;</span> =&gt; K_LRE, <span class="stringliteral">&#39;cel&#39;</span> =&gt; $cel, <span class="stringliteral">&#39;dos&#39;</span> =&gt; $dos);
<a name="l09335"></a>09335             $cel = $next_level;
<a name="l09336"></a>09336             $dos = <span class="charliteral">&#39;N&#39;</span>;
<a name="l09337"></a>09337             $sor = $eor;
<a name="l09338"></a>09338             $eor = $cel % 2 ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l09339"></a>09339           }
<a name="l09340"></a>09340         } elseif ($ta[$i] == K_RLO) {
<a name="l09341"></a>09341           <span class="comment">// X4. With each RLO, compute the least greater odd embedding level.</span>
<a name="l09342"></a>09342           <span class="comment">//  a. If this new level would be valid, then this embedding code is valid. Remember (push) the current embedding level and override status. Reset the current level to this new level, and reset the override status to right-to-left.</span>
<a name="l09343"></a>09343           <span class="comment">//  b. If the new level would not be valid, then this code is invalid. Do not change the current level or override status.</span>
<a name="l09344"></a>09344           $next_level = $cel + ($cel % 2) + 1;
<a name="l09345"></a>09345           <span class="keywordflow">if</span> ($next_level &lt; 62) {
<a name="l09346"></a>09346             $remember[] = array(<span class="stringliteral">&#39;num&#39;</span> =&gt; K_RLO, <span class="stringliteral">&#39;cel&#39;</span> =&gt; $cel, <span class="stringliteral">&#39;dos&#39;</span> =&gt; $dos);
<a name="l09347"></a>09347             $cel = $next_level;
<a name="l09348"></a>09348             $dos = <span class="charliteral">&#39;R&#39;</span>;
<a name="l09349"></a>09349             $sor = $eor;
<a name="l09350"></a>09350             $eor = $cel % 2 ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l09351"></a>09351           }
<a name="l09352"></a>09352         } elseif ($ta[$i] == K_LRO) {
<a name="l09353"></a>09353           <span class="comment">// X5. With each LRO, compute the least greater even embedding level.</span>
<a name="l09354"></a>09354           <span class="comment">//  a. If this new level would be valid, then this embedding code is valid. Remember (push) the current embedding level and override status. Reset the current level to this new level, and reset the override status to left-to-right.</span>
<a name="l09355"></a>09355           <span class="comment">//  b. If the new level would not be valid, then this code is invalid. Do not change the current level or override status.</span>
<a name="l09356"></a>09356           $next_level = $cel + 2 - ($cel % 2);
<a name="l09357"></a>09357           <span class="keywordflow">if</span> ( $next_level &lt; 62 ) {
<a name="l09358"></a>09358             $remember[] = array(<span class="stringliteral">&#39;num&#39;</span> =&gt; K_LRO, <span class="stringliteral">&#39;cel&#39;</span> =&gt; $cel, <span class="stringliteral">&#39;dos&#39;</span> =&gt; $dos);
<a name="l09359"></a>09359             $cel = $next_level;
<a name="l09360"></a>09360             $dos = <span class="charliteral">&#39;L&#39;</span>;
<a name="l09361"></a>09361             $sor = $eor;
<a name="l09362"></a>09362             $eor = $cel % 2 ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l09363"></a>09363           }
<a name="l09364"></a>09364         } elseif ($ta[$i] == K_PDF) {
<a name="l09365"></a>09365           <span class="comment">// X7. With each PDF, determine the matching embedding or override code. If there was a valid matching code, restore (pop) the last remembered (pushed) embedding level and directional override.</span>
<a name="l09366"></a>09366           <span class="keywordflow">if</span> (count($remember)) {
<a name="l09367"></a>09367             $last = count($remember ) - 1;
<a name="l09368"></a>09368             <span class="keywordflow">if</span> (($remember[$last][<span class="stringliteral">&#39;num&#39;</span>] == K_RLE) OR 
<a name="l09369"></a>09369                 ($remember[$last][<span class="stringliteral">&#39;num&#39;</span>] == K_LRE) OR 
<a name="l09370"></a>09370                 ($remember[$last][<span class="stringliteral">&#39;num&#39;</span>] == K_RLO) OR 
<a name="l09371"></a>09371                 ($remember[$last][<span class="stringliteral">&#39;num&#39;</span>] == K_LRO)) {
<a name="l09372"></a>09372               $match = array_pop($remember);
<a name="l09373"></a>09373               $cel = $match[<span class="stringliteral">&#39;cel&#39;</span>];
<a name="l09374"></a>09374               $dos = $match[<span class="stringliteral">&#39;dos&#39;</span>];
<a name="l09375"></a>09375               $sor = $eor;
<a name="l09376"></a>09376               $eor = ($cel &gt; $match[<span class="stringliteral">&#39;cel&#39;</span>] ? $cel : $match[<span class="stringliteral">&#39;cel&#39;</span>]) % 2 ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l09377"></a>09377             }
<a name="l09378"></a>09378           }
<a name="l09379"></a>09379         } elseif (($ta[$i] != K_RLE) AND
<a name="l09380"></a>09380                  ($ta[$i] != K_LRE) AND
<a name="l09381"></a>09381                  ($ta[$i] != K_RLO) AND
<a name="l09382"></a>09382                  ($ta[$i] != K_LRO) AND
<a name="l09383"></a>09383                  ($ta[$i] != K_PDF)) {
<a name="l09384"></a>09384           <span class="comment">// X6. For all types besides RLE, LRE, RLO, LRO, and PDF:</span>
<a name="l09385"></a>09385           <span class="comment">//  a. Set the level of the current character to the current embedding level.</span>
<a name="l09386"></a>09386           <span class="comment">//  b. Whenever the directional override status is not neutral, reset the current character type to the directional override status.</span>
<a name="l09387"></a>09387           <span class="keywordflow">if</span> ($dos != <span class="charliteral">&#39;N&#39;</span>) {
<a name="l09388"></a>09388             $chardir = $dos;
<a name="l09389"></a>09389           } <span class="keywordflow">else</span> {
<a name="l09390"></a>09390             <span class="keywordflow">if</span> (isset($unicode[$ta[$i]])) {
<a name="l09391"></a>09391               $chardir = $unicode[$ta[$i]];
<a name="l09392"></a>09392             } <span class="keywordflow">else</span> {
<a name="l09393"></a>09393               $chardir = <span class="charliteral">&#39;L&#39;</span>;
<a name="l09394"></a>09394             }
<a name="l09395"></a>09395           }
<a name="l09396"></a>09396           <span class="comment">// stores string characters and other information</span>
<a name="l09397"></a>09397           $chardata[] = array(<span class="stringliteral">&#39;char&#39;</span> =&gt; $ta[$i], <span class="stringliteral">&#39;level&#39;</span> =&gt; $cel, <span class="stringliteral">&#39;type&#39;</span> =&gt; $chardir, <span class="stringliteral">&#39;sor&#39;</span> =&gt; $sor, <span class="stringliteral">&#39;eor&#39;</span> =&gt; $eor);
<a name="l09398"></a>09398         }
<a name="l09399"></a>09399       } <span class="comment">// end for each char</span>
<a name="l09400"></a>09400       
<a name="l09401"></a>09401       <span class="comment">// X8. All explicit directional embeddings and overrides are completely terminated at the end of each paragraph. Paragraph separators are not included in the embedding.</span>
<a name="l09402"></a>09402       <span class="comment">// X9. Remove all RLE, LRE, RLO, LRO, PDF, and BN codes.</span>
<a name="l09403"></a>09403       <span class="comment">// X10. The remaining rules are applied to each run of characters at the same level. For each run, determine the start-of-level-run (sor) and end-of-level-run (eor) type, either L or R. This depends on the higher of the two levels on either side of the boundary (at the start or end of the paragraph, the level of the &#39;other&#39; run is the base embedding level). If the higher level is odd, the type is R; otherwise, it is L.</span>
<a name="l09404"></a>09404       
<a name="l09405"></a>09405       <span class="comment">// 3.3.3 Resolving Weak Types</span>
<a name="l09406"></a>09406       <span class="comment">// Weak types are now resolved one level run at a time. At level run boundaries where the type of the character on the other side of the boundary is required, the type assigned to sor or eor is used.</span>
<a name="l09407"></a>09407       <span class="comment">// Nonspacing marks are now resolved based on the previous characters.</span>
<a name="l09408"></a>09408       $numchars = count($chardata);
<a name="l09409"></a>09409       
<a name="l09410"></a>09410       <span class="comment">// W1. Examine each nonspacing mark (NSM) in the level run, and change the type of the NSM to the type of the previous character. If the NSM is at the start of the level run, it will get the type of sor.</span>
<a name="l09411"></a>09411       $prevlevel = -1; <span class="comment">// track level changes</span>
<a name="l09412"></a>09412       $levcount = 0; <span class="comment">// counts consecutive chars at the same level</span>
<a name="l09413"></a>09413       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09414"></a>09414         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;NSM&#39;</span>) {
<a name="l09415"></a>09415           <span class="keywordflow">if</span> ($levcount) {
<a name="l09416"></a>09416             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = $chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>];
<a name="l09417"></a>09417           } elseif ($i &gt; 0) {
<a name="l09418"></a>09418             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = $chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>];
<a name="l09419"></a>09419           }
<a name="l09420"></a>09420         }
<a name="l09421"></a>09421         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09422"></a>09422           $levcount = 0;
<a name="l09423"></a>09423         } <span class="keywordflow">else</span> {
<a name="l09424"></a>09424           ++$levcount;
<a name="l09425"></a>09425         }
<a name="l09426"></a>09426         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09427"></a>09427       }
<a name="l09428"></a>09428       
<a name="l09429"></a>09429       <span class="comment">// W2. Search backward from each instance of a European number until the first strong type (R, L, AL, or sor) is found. If an AL is found, change the type of the European number to Arabic number.</span>
<a name="l09430"></a>09430       $prevlevel = -1;
<a name="l09431"></a>09431       $levcount = 0;
<a name="l09432"></a>09432       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09433"></a>09433         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;char&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) {
<a name="l09434"></a>09434           <span class="keywordflow">for</span> ($j=$levcount; $j &gt;= 0; $j--) {
<a name="l09435"></a>09435             <span class="keywordflow">if</span> ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AL&#39;</span>) {
<a name="l09436"></a>09436               $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;AN&#39;</span>;
<a name="l09437"></a>09437             } elseif (($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) OR ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>)) {
<a name="l09438"></a>09438               <span class="keywordflow">break</span>;
<a name="l09439"></a>09439             }
<a name="l09440"></a>09440           }
<a name="l09441"></a>09441         }
<a name="l09442"></a>09442         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09443"></a>09443           $levcount = 0;
<a name="l09444"></a>09444         } <span class="keywordflow">else</span> {
<a name="l09445"></a>09445           ++$levcount;
<a name="l09446"></a>09446         }
<a name="l09447"></a>09447         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09448"></a>09448       }
<a name="l09449"></a>09449       
<a name="l09450"></a>09450       <span class="comment">// W3. Change all ALs to R.</span>
<a name="l09451"></a>09451       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09452"></a>09452         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AL&#39;</span>) {
<a name="l09453"></a>09453           $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l09454"></a>09454         } 
<a name="l09455"></a>09455       }
<a name="l09456"></a>09456       
<a name="l09457"></a>09457       <span class="comment">// W4. A single European separator between two European numbers changes to a European number. A single common separator between two numbers of the same type changes to that type.</span>
<a name="l09458"></a>09458       $prevlevel = -1;
<a name="l09459"></a>09459       $levcount = 0;
<a name="l09460"></a>09460       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09461"></a>09461         <span class="keywordflow">if</span> (($levcount &gt; 0) AND (($i+1) &lt; $numchars) AND ($chardata[($i+1)][<span class="stringliteral">&#39;level&#39;</span>] == $prevlevel)) {
<a name="l09462"></a>09462           <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;ES&#39;</span>) AND ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) AND ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>)) {
<a name="l09463"></a>09463             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;EN&#39;</span>;
<a name="l09464"></a>09464           } elseif (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;CS&#39;</span>) AND ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) AND ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>)) {
<a name="l09465"></a>09465             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;EN&#39;</span>;
<a name="l09466"></a>09466           } elseif (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;CS&#39;</span>) AND ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>) AND ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>)) {
<a name="l09467"></a>09467             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;AN&#39;</span>;
<a name="l09468"></a>09468           }
<a name="l09469"></a>09469         }
<a name="l09470"></a>09470         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09471"></a>09471           $levcount = 0;
<a name="l09472"></a>09472         } <span class="keywordflow">else</span> {
<a name="l09473"></a>09473           ++$levcount;
<a name="l09474"></a>09474         }
<a name="l09475"></a>09475         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09476"></a>09476       }
<a name="l09477"></a>09477       
<a name="l09478"></a>09478       <span class="comment">// W5. A sequence of European terminators adjacent to European numbers changes to all European numbers.</span>
<a name="l09479"></a>09479       $prevlevel = -1;
<a name="l09480"></a>09480       $levcount = 0;
<a name="l09481"></a>09481       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09482"></a>09482         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;ET&#39;</span>) {
<a name="l09483"></a>09483           <span class="keywordflow">if</span> (($levcount &gt; 0) AND ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>)) {
<a name="l09484"></a>09484             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;EN&#39;</span>;
<a name="l09485"></a>09485           } <span class="keywordflow">else</span> {
<a name="l09486"></a>09486             $j = $i+1;
<a name="l09487"></a>09487             <span class="keywordflow">while</span> (($j &lt; $numchars) AND ($chardata[$j][<span class="stringliteral">&#39;level&#39;</span>] == $prevlevel)) {
<a name="l09488"></a>09488               <span class="keywordflow">if</span> ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) {
<a name="l09489"></a>09489                 $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;EN&#39;</span>;
<a name="l09490"></a>09490                 <span class="keywordflow">break</span>;
<a name="l09491"></a>09491               } elseif ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] != <span class="stringliteral">&#39;ET&#39;</span>) {
<a name="l09492"></a>09492                 <span class="keywordflow">break</span>;
<a name="l09493"></a>09493               }
<a name="l09494"></a>09494               ++$j;
<a name="l09495"></a>09495             }
<a name="l09496"></a>09496           }
<a name="l09497"></a>09497         }
<a name="l09498"></a>09498         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09499"></a>09499           $levcount = 0;
<a name="l09500"></a>09500         } <span class="keywordflow">else</span> {
<a name="l09501"></a>09501           ++$levcount;
<a name="l09502"></a>09502         }
<a name="l09503"></a>09503         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09504"></a>09504       }
<a name="l09505"></a>09505       
<a name="l09506"></a>09506       <span class="comment">// W6. Otherwise, separators and terminators change to Other Neutral.</span>
<a name="l09507"></a>09507       $prevlevel = -1;
<a name="l09508"></a>09508       $levcount = 0;
<a name="l09509"></a>09509       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09510"></a>09510         <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;ET&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;ES&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;CS&#39;</span>)) {
<a name="l09511"></a>09511           $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;ON&#39;</span>;
<a name="l09512"></a>09512         }
<a name="l09513"></a>09513         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09514"></a>09514           $levcount = 0;
<a name="l09515"></a>09515         } <span class="keywordflow">else</span> {
<a name="l09516"></a>09516           ++$levcount;
<a name="l09517"></a>09517         }
<a name="l09518"></a>09518         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09519"></a>09519       }
<a name="l09520"></a>09520       
<a name="l09521"></a>09521       <span class="comment">//W7. Search backward from each instance of a European number until the first strong type (R, L, or sor) is found. If an L is found, then change the type of the European number to L.</span>
<a name="l09522"></a>09522       $prevlevel = -1;
<a name="l09523"></a>09523       $levcount = 0;
<a name="l09524"></a>09524       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09525"></a>09525         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;char&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) {
<a name="l09526"></a>09526           <span class="keywordflow">for</span> ($j=$levcount; $j &gt;= 0; $j--) {
<a name="l09527"></a>09527             <span class="keywordflow">if</span> ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l09528"></a>09528               $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l09529"></a>09529             } elseif ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l09530"></a>09530               <span class="keywordflow">break</span>;
<a name="l09531"></a>09531             }
<a name="l09532"></a>09532           }
<a name="l09533"></a>09533         }
<a name="l09534"></a>09534         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09535"></a>09535           $levcount = 0;
<a name="l09536"></a>09536         } <span class="keywordflow">else</span> {
<a name="l09537"></a>09537           ++$levcount;
<a name="l09538"></a>09538         }
<a name="l09539"></a>09539         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09540"></a>09540       }
<a name="l09541"></a>09541       
<a name="l09542"></a>09542       <span class="comment">// N1. A sequence of neutrals takes the direction of the surrounding strong text if the text on both sides has the same direction. European and Arabic numbers act as if they were R in terms of their influence on neutrals. Start-of-level-run (sor) and end-of-level-run (eor) are used at level run boundaries.</span>
<a name="l09543"></a>09543       $prevlevel = -1;
<a name="l09544"></a>09544       $levcount = 0;
<a name="l09545"></a>09545       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09546"></a>09546         <span class="keywordflow">if</span> (($levcount &gt; 0) AND (($i+1) &lt; $numchars) AND ($chardata[($i+1)][<span class="stringliteral">&#39;level&#39;</span>] == $prevlevel)) {
<a name="l09547"></a>09547           <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) AND ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) AND ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>)) {
<a name="l09548"></a>09548             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l09549"></a>09549           } elseif (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) AND
<a name="l09550"></a>09550            (($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) OR ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) OR ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>)) AND
<a name="l09551"></a>09551            (($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) OR ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) OR ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>))) {
<a name="l09552"></a>09552             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l09553"></a>09553           } elseif ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) {
<a name="l09554"></a>09554             <span class="comment">// N2. Any remaining neutrals take the embedding direction</span>
<a name="l09555"></a>09555             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = $chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>];
<a name="l09556"></a>09556           }
<a name="l09557"></a>09557         } elseif (($levcount == 0) AND (($i+1) &lt; $numchars) AND ($chardata[($i+1)][<span class="stringliteral">&#39;level&#39;</span>] == $prevlevel)) {
<a name="l09558"></a>09558           <span class="comment">// first char</span>
<a name="l09559"></a>09559           <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) AND ($chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) AND ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>)) {
<a name="l09560"></a>09560             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l09561"></a>09561           } elseif (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) AND
<a name="l09562"></a>09562            (($chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>)) AND
<a name="l09563"></a>09563            (($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) OR ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) OR ($chardata[($i+1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>))) {
<a name="l09564"></a>09564             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l09565"></a>09565           } elseif ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) {
<a name="l09566"></a>09566             <span class="comment">// N2. Any remaining neutrals take the embedding direction</span>
<a name="l09567"></a>09567             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = $chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>];
<a name="l09568"></a>09568           }
<a name="l09569"></a>09569         } elseif (($levcount &gt; 0) AND ((($i+1) == $numchars) OR (($i+1) &lt; $numchars) AND ($chardata[($i+1)][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel))) {
<a name="l09570"></a>09570           <span class="comment">//last char</span>
<a name="l09571"></a>09571           <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) AND ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) AND ($chardata[$i][<span class="stringliteral">&#39;eor&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>)) {
<a name="l09572"></a>09572             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l09573"></a>09573           } elseif (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) AND
<a name="l09574"></a>09574            (($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) OR ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) OR ($chardata[($i-1)][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>)) AND
<a name="l09575"></a>09575            (($chardata[$i][<span class="stringliteral">&#39;eor&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;eor&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;eor&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>))) {
<a name="l09576"></a>09576             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l09577"></a>09577           } elseif ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) {
<a name="l09578"></a>09578             <span class="comment">// N2. Any remaining neutrals take the embedding direction</span>
<a name="l09579"></a>09579             $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = $chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>];
<a name="l09580"></a>09580           }
<a name="l09581"></a>09581         } elseif ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;N&#39;</span>) {
<a name="l09582"></a>09582           <span class="comment">// N2. Any remaining neutrals take the embedding direction</span>
<a name="l09583"></a>09583           $chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] = $chardata[$i][<span class="stringliteral">&#39;sor&#39;</span>];
<a name="l09584"></a>09584         }
<a name="l09585"></a>09585         <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] != $prevlevel) {
<a name="l09586"></a>09586           $levcount = 0;
<a name="l09587"></a>09587         } <span class="keywordflow">else</span> {
<a name="l09588"></a>09588           ++$levcount;
<a name="l09589"></a>09589         }
<a name="l09590"></a>09590         $prevlevel = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>];
<a name="l09591"></a>09591       }
<a name="l09592"></a>09592       
<a name="l09593"></a>09593       <span class="comment">// I1. For all characters with an even (left-to-right) embedding direction, those of type R go up one level and those of type AN or EN go up two levels.</span>
<a name="l09594"></a>09594       <span class="comment">// I2. For all characters with an odd (right-to-left) embedding direction, those of type L, EN or AN go up one level.</span>
<a name="l09595"></a>09595       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09596"></a>09596         $odd = $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] % 2;
<a name="l09597"></a>09597         <span class="keywordflow">if</span> ($odd) {
<a name="l09598"></a>09598           <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;L&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>)) {
<a name="l09599"></a>09599             $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] += 1;
<a name="l09600"></a>09600           }
<a name="l09601"></a>09601         } <span class="keywordflow">else</span> {
<a name="l09602"></a>09602           <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l09603"></a>09603             $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] += 1;
<a name="l09604"></a>09604           } elseif (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;AN&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;EN&#39;</span>)) {
<a name="l09605"></a>09605             $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] += 2;
<a name="l09606"></a>09606           }
<a name="l09607"></a>09607         }
<a name="l09608"></a>09608         $maxlevel = max($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>],$maxlevel);
<a name="l09609"></a>09609       }
<a name="l09610"></a>09610       
<a name="l09611"></a>09611       <span class="comment">// L1. On each line, reset the embedding level of the following characters to the paragraph embedding level:</span>
<a name="l09612"></a>09612       <span class="comment">//  1. Segment separators,</span>
<a name="l09613"></a>09613       <span class="comment">//  2. Paragraph separators,</span>
<a name="l09614"></a>09614       <span class="comment">//  3. Any sequence of whitespace characters preceding a segment separator or paragraph separator, and</span>
<a name="l09615"></a>09615       <span class="comment">//  4. Any sequence of white space characters at the end of the line.</span>
<a name="l09616"></a>09616       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09617"></a>09617         <span class="keywordflow">if</span> (($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;B&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;S&#39;</span>)) {
<a name="l09618"></a>09618           $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] = $pel;
<a name="l09619"></a>09619         } elseif ($chardata[$i][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;WS&#39;</span>) {
<a name="l09620"></a>09620           $j = $i+1;
<a name="l09621"></a>09621           <span class="keywordflow">while</span> ($j &lt; $numchars) {
<a name="l09622"></a>09622             <span class="keywordflow">if</span> ((($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;B&#39;</span>) OR ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="charliteral">&#39;S&#39;</span>)) OR
<a name="l09623"></a>09623               (($j == ($numchars-1)) AND ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;WS&#39;</span>))) {
<a name="l09624"></a>09624               $chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] = $pel;
<a name="l09625"></a>09625               <span class="keywordflow">break</span>;
<a name="l09626"></a>09626             } elseif ($chardata[$j][<span class="stringliteral">&#39;type&#39;</span>] != <span class="stringliteral">&#39;WS&#39;</span>) {
<a name="l09627"></a>09627               <span class="keywordflow">break</span>;
<a name="l09628"></a>09628             }
<a name="l09629"></a>09629             ++$j;
<a name="l09630"></a>09630           }
<a name="l09631"></a>09631         }
<a name="l09632"></a>09632       }
<a name="l09633"></a>09633       
<a name="l09634"></a>09634       <span class="comment">// Arabic Shaping</span>
<a name="l09635"></a>09635       <span class="comment">// Cursively connected scripts, such as Arabic or Syriac, require the selection of positional character shapes that depend on adjacent characters. Shaping is logically applied after the Bidirectional Algorithm is used and is limited to characters within the same directional run. </span>
<a name="l09636"></a>09636       <span class="keywordflow">if</span> ($arabic) {
<a name="l09637"></a>09637         $endedletter = array(1569,1570,1571,1572,1573,1575,1577,1583,1584,1585,1586,1608,1688);
<a name="l09638"></a>09638         $alfletter = array(1570,1571,1573,1575);
<a name="l09639"></a>09639         $chardata2 = $chardata;
<a name="l09640"></a>09640         $laaletter = <span class="keyword">false</span>;
<a name="l09641"></a>09641         $charAL = array();
<a name="l09642"></a>09642         $x = 0;
<a name="l09643"></a>09643         <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09644"></a>09644           <span class="keywordflow">if</span> (($unicode[$chardata[$i][<span class="stringliteral">&#39;char&#39;</span>]] == <span class="stringliteral">&#39;AL&#39;</span>) OR ($chardata[$i][<span class="stringliteral">&#39;char&#39;</span>] == 32) OR ($chardata[$i][<span class="stringliteral">&#39;char&#39;</span>] == 8204)) {
<a name="l09645"></a>09645             $charAL[$x] = $chardata[$i];
<a name="l09646"></a>09646             $charAL[$x][<span class="charliteral">&#39;i&#39;</span>] = $i;
<a name="l09647"></a>09647             $chardata[$i][<span class="charliteral">&#39;x&#39;</span>] = $x;
<a name="l09648"></a>09648             ++$x;
<a name="l09649"></a>09649           }
<a name="l09650"></a>09650         }
<a name="l09651"></a>09651         $numAL = $x;
<a name="l09652"></a>09652         <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09653"></a>09653           $thischar = $chardata[$i];
<a name="l09654"></a>09654           <span class="keywordflow">if</span> ($i &gt; 0) {
<a name="l09655"></a>09655             $prevchar = $chardata[($i-1)];
<a name="l09656"></a>09656           } <span class="keywordflow">else</span> {
<a name="l09657"></a>09657             $prevchar = <span class="keyword">false</span>;
<a name="l09658"></a>09658           }
<a name="l09659"></a>09659           <span class="keywordflow">if</span> (($i+1) &lt; $numchars) {
<a name="l09660"></a>09660             $nextchar = $chardata[($i+1)];
<a name="l09661"></a>09661           } <span class="keywordflow">else</span> {
<a name="l09662"></a>09662             $nextchar = <span class="keyword">false</span>;
<a name="l09663"></a>09663           }
<a name="l09664"></a>09664           <span class="keywordflow">if</span> ($unicode[$thischar[<span class="stringliteral">&#39;char&#39;</span>]] == <span class="stringliteral">&#39;AL&#39;</span>) {
<a name="l09665"></a>09665             $x = $thischar[<span class="charliteral">&#39;x&#39;</span>];
<a name="l09666"></a>09666             <span class="keywordflow">if</span> ($x &gt; 0) {
<a name="l09667"></a>09667               $prevchar = $charAL[($x-1)];
<a name="l09668"></a>09668             } <span class="keywordflow">else</span> {
<a name="l09669"></a>09669               $prevchar = <span class="keyword">false</span>;
<a name="l09670"></a>09670             }
<a name="l09671"></a>09671             <span class="keywordflow">if</span> (($x+1) &lt; $numAL) {
<a name="l09672"></a>09672               $nextchar = $charAL[($x+1)];
<a name="l09673"></a>09673             } <span class="keywordflow">else</span> {
<a name="l09674"></a>09674               $nextchar = <span class="keyword">false</span>;
<a name="l09675"></a>09675             }
<a name="l09676"></a>09676             <span class="comment">// if laa letter</span>
<a name="l09677"></a>09677             <span class="keywordflow">if</span> (($prevchar !== <span class="keyword">false</span>) AND ($prevchar[<span class="stringliteral">&#39;char&#39;</span>] == 1604) AND (in_array($thischar[&#39;<span class="keywordtype">char</span>&#39;], $alfletter))) {
<a name="l09678"></a>09678               $arabicarr = $laa_array;
<a name="l09679"></a>09679               $laaletter = <span class="keyword">true</span>;
<a name="l09680"></a>09680               <span class="keywordflow">if</span> ($x &gt; 1) {
<a name="l09681"></a>09681                 $prevchar = $charAL[($x-2)];
<a name="l09682"></a>09682               } <span class="keywordflow">else</span> {
<a name="l09683"></a>09683                 $prevchar = <span class="keyword">false</span>;
<a name="l09684"></a>09684               }
<a name="l09685"></a>09685             } <span class="keywordflow">else</span> {
<a name="l09686"></a>09686               $arabicarr = $unicode_arlet;
<a name="l09687"></a>09687               $laaletter = <span class="keyword">false</span>;
<a name="l09688"></a>09688             }
<a name="l09689"></a>09689             <span class="keywordflow">if</span> (($prevchar !== <span class="keyword">false</span>) AND ($nextchar !== <span class="keyword">false</span>) AND
<a name="l09690"></a>09690               (($unicode[$prevchar[&#39;<span class="keywordtype">char</span>&#39;]] == &#39;AL&#39;) OR ($unicode[$prevchar[&#39;<span class="keywordtype">char</span>&#39;]] == &#39;NSM&#39;)) AND
<a name="l09691"></a>09691               (($unicode[$nextchar[&#39;<span class="keywordtype">char</span>&#39;]] == &#39;AL&#39;) OR ($unicode[$nextchar[&#39;<span class="keywordtype">char</span>&#39;]] == &#39;NSM&#39;)) AND
<a name="l09692"></a>09692               ($prevchar[&#39;type&#39;] == $thischar[&#39;type&#39;]) AND
<a name="l09693"></a>09693               ($nextchar[&#39;type&#39;] == $thischar[&#39;type&#39;]) AND
<a name="l09694"></a>09694               ($nextchar[&#39;<span class="keywordtype">char</span>&#39;] != 1567)) {
<a name="l09695"></a>09695               <span class="keywordflow">if</span> (in_array($prevchar[<span class="stringliteral">&#39;char&#39;</span>], $endedletter)) {
<a name="l09696"></a>09696                 <span class="keywordflow">if</span> (isset($arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][2])) {
<a name="l09697"></a>09697                   <span class="comment">// initial</span>
<a name="l09698"></a>09698                   $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = $arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][2];
<a name="l09699"></a>09699                 }
<a name="l09700"></a>09700               } <span class="keywordflow">else</span> {
<a name="l09701"></a>09701                 <span class="keywordflow">if</span> (isset($arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][3])) {
<a name="l09702"></a>09702                   <span class="comment">// medial</span>
<a name="l09703"></a>09703                   $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = $arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][3];
<a name="l09704"></a>09704                 }
<a name="l09705"></a>09705               }
<a name="l09706"></a>09706             } elseif (($nextchar !== <span class="keyword">false</span>) AND
<a name="l09707"></a>09707               (($unicode[$nextchar[<span class="stringliteral">&#39;char&#39;</span>]] == <span class="stringliteral">&#39;AL&#39;</span>) OR ($unicode[$nextchar[<span class="stringliteral">&#39;char&#39;</span>]] == <span class="stringliteral">&#39;NSM&#39;</span>)) AND
<a name="l09708"></a>09708               ($nextchar[<span class="stringliteral">&#39;type&#39;</span>] == $thischar[<span class="stringliteral">&#39;type&#39;</span>]) AND
<a name="l09709"></a>09709               ($nextchar[<span class="stringliteral">&#39;char&#39;</span>] != 1567)) {
<a name="l09710"></a>09710               <span class="keywordflow">if</span> (isset($arabicarr[$chardata[$i][<span class="stringliteral">&#39;char&#39;</span>]][2])) {
<a name="l09711"></a>09711                 <span class="comment">// initial</span>
<a name="l09712"></a>09712                 $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = $arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][2];
<a name="l09713"></a>09713               }
<a name="l09714"></a>09714             } elseif ((($prevchar !== <span class="keyword">false</span>) AND
<a name="l09715"></a>09715               (($unicode[$prevchar[<span class="stringliteral">&#39;char&#39;</span>]] == <span class="stringliteral">&#39;AL&#39;</span>) OR ($unicode[$prevchar[<span class="stringliteral">&#39;char&#39;</span>]] == <span class="stringliteral">&#39;NSM&#39;</span>)) AND
<a name="l09716"></a>09716               ($prevchar[<span class="stringliteral">&#39;type&#39;</span>] == $thischar[<span class="stringliteral">&#39;type&#39;</span>])) OR
<a name="l09717"></a>09717               (($nextchar !== <span class="keyword">false</span>) AND ($nextchar[<span class="stringliteral">&#39;char&#39;</span>] == 1567))) {
<a name="l09718"></a>09718               <span class="comment">// final</span>
<a name="l09719"></a>09719               <span class="keywordflow">if</span> (($i &gt; 1) AND ($thischar[<span class="stringliteral">&#39;char&#39;</span>] == 1607) AND
<a name="l09720"></a>09720                 ($chardata[$i-1][<span class="stringliteral">&#39;char&#39;</span>] == 1604) AND
<a name="l09721"></a>09721                 ($chardata[$i-2][<span class="stringliteral">&#39;char&#39;</span>] == 1604)) {
<a name="l09722"></a>09722                 <span class="comment">//Allah Word</span>
<a name="l09723"></a>09723                 <span class="comment">// mark characters to delete with false</span>
<a name="l09724"></a>09724                 $chardata2[$i-2][<span class="stringliteral">&#39;char&#39;</span>] = <span class="keyword">false</span>;
<a name="l09725"></a>09725                 $chardata2[$i-1][<span class="stringliteral">&#39;char&#39;</span>] = <span class="keyword">false</span>; 
<a name="l09726"></a>09726                 $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = 65010;
<a name="l09727"></a>09727               } <span class="keywordflow">else</span> {
<a name="l09728"></a>09728                 <span class="keywordflow">if</span> (($prevchar !== <span class="keyword">false</span>) AND in_array($prevchar[<span class="stringliteral">&#39;char&#39;</span>], $endedletter)) {
<a name="l09729"></a>09729                   <span class="keywordflow">if</span> (isset($arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][0])) {
<a name="l09730"></a>09730                     <span class="comment">// isolated</span>
<a name="l09731"></a>09731                     $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = $arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][0];
<a name="l09732"></a>09732                   }
<a name="l09733"></a>09733                 } <span class="keywordflow">else</span> {
<a name="l09734"></a>09734                   <span class="keywordflow">if</span> (isset($arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][1])) {
<a name="l09735"></a>09735                     <span class="comment">// final</span>
<a name="l09736"></a>09736                     $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = $arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][1];
<a name="l09737"></a>09737                   }
<a name="l09738"></a>09738                 }
<a name="l09739"></a>09739               }
<a name="l09740"></a>09740             } elseif (isset($arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][0])) {
<a name="l09741"></a>09741               <span class="comment">// isolated</span>
<a name="l09742"></a>09742               $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = $arabicarr[$thischar[<span class="stringliteral">&#39;char&#39;</span>]][0];
<a name="l09743"></a>09743             }
<a name="l09744"></a>09744             <span class="comment">// if laa letter</span>
<a name="l09745"></a>09745             <span class="keywordflow">if</span> ($laaletter) {
<a name="l09746"></a>09746               <span class="comment">// mark characters to delete with false</span>
<a name="l09747"></a>09747               $chardata2[($charAL[($x-1)][<span class="charliteral">&#39;i&#39;</span>])][<span class="stringliteral">&#39;char&#39;</span>] = <span class="keyword">false</span>;
<a name="l09748"></a>09748             }
<a name="l09749"></a>09749           } <span class="comment">// end if AL (Arabic Letter)</span>
<a name="l09750"></a>09750         } <span class="comment">// end for each char</span>
<a name="l09751"></a>09751         <span class="comment">/* </span>
<a name="l09752"></a>09752 <span class="comment">         * Combining characters that can occur with Shadda (0651 HEX, 1617 DEC) are placed in UE586-UE594. </span>
<a name="l09753"></a>09753 <span class="comment">         * Putting the combining mark and shadda in the same glyph allows us to avoid the two marks overlapping each other in an illegible manner.</span>
<a name="l09754"></a>09754 <span class="comment">         */</span>
<a name="l09755"></a>09755         $cw = &amp;$this-&gt;CurrentFont[<span class="stringliteral">&#39;cw&#39;</span>];
<a name="l09756"></a>09756         <span class="keywordflow">for</span> ($i = 0; $i &lt; ($numchars-1); ++$i) {
<a name="l09757"></a>09757           <span class="keywordflow">if</span> (($chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] == 1617) AND (isset($diacritics[($chardata2[$i+1][<span class="stringliteral">&#39;char&#39;</span>])]))) {
<a name="l09758"></a>09758             <span class="comment">// check if the subtitution font is defined on current font</span>
<a name="l09759"></a>09759             <span class="keywordflow">if</span> (isset($cw[($diacritics[($chardata2[$i+1][<span class="stringliteral">&#39;char&#39;</span>])])])) {
<a name="l09760"></a>09760               $chardata2[$i][<span class="stringliteral">&#39;char&#39;</span>] = <span class="keyword">false</span>;
<a name="l09761"></a>09761               $chardata2[$i+1][<span class="stringliteral">&#39;char&#39;</span>] = $diacritics[($chardata2[$i+1][<span class="stringliteral">&#39;char&#39;</span>])];
<a name="l09762"></a>09762             }
<a name="l09763"></a>09763           }
<a name="l09764"></a>09764         }
<a name="l09765"></a>09765         <span class="comment">// remove marked characters</span>
<a name="l09766"></a>09766         <span class="keywordflow">foreach</span> ($chardata2 as $key =&gt; $value) {
<a name="l09767"></a>09767           <span class="keywordflow">if</span> ($value[<span class="stringliteral">&#39;char&#39;</span>] === <span class="keyword">false</span>) {
<a name="l09768"></a>09768             unset($chardata2[$key]);
<a name="l09769"></a>09769           }
<a name="l09770"></a>09770         }
<a name="l09771"></a>09771         $chardata = array_values($chardata2);
<a name="l09772"></a>09772         $numchars = count($chardata);
<a name="l09773"></a>09773         unset($chardata2);
<a name="l09774"></a>09774         unset($arabicarr);
<a name="l09775"></a>09775         unset($laaletter);
<a name="l09776"></a>09776         unset($charAL);
<a name="l09777"></a>09777       }
<a name="l09778"></a>09778       
<a name="l09779"></a>09779       <span class="comment">// L2. From the highest level found in the text to the lowest odd level on each line, including intermediate levels not actually present in the text, reverse any contiguous sequence of characters that are at that level or higher.</span>
<a name="l09780"></a>09780       <span class="keywordflow">for</span> ($j=$maxlevel; $j &gt; 0; $j--) {
<a name="l09781"></a>09781         $ordarray = Array();
<a name="l09782"></a>09782         $revarr = Array();
<a name="l09783"></a>09783         $onlevel = <span class="keyword">false</span>;
<a name="l09784"></a>09784         <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09785"></a>09785           <span class="keywordflow">if</span> ($chardata[$i][<span class="stringliteral">&#39;level&#39;</span>] &gt;= $j) {
<a name="l09786"></a>09786             $onlevel = <span class="keyword">true</span>;
<a name="l09787"></a>09787             <span class="keywordflow">if</span> (isset($unicode_mirror[$chardata[$i][<span class="stringliteral">&#39;char&#39;</span>]])) {
<a name="l09788"></a>09788               <span class="comment">// L4. A character is depicted by a mirrored glyph if and only if (a) the resolved directionality of that character is R, and (b) the Bidi_Mirrored property value of that character is true.</span>
<a name="l09789"></a>09789               $chardata[$i][<span class="stringliteral">&#39;char&#39;</span>] = $unicode_mirror[$chardata[$i][<span class="stringliteral">&#39;char&#39;</span>]];
<a name="l09790"></a>09790             }
<a name="l09791"></a>09791             $revarr[] = $chardata[$i];
<a name="l09792"></a>09792           } <span class="keywordflow">else</span> {
<a name="l09793"></a>09793             <span class="keywordflow">if</span> ($onlevel) {
<a name="l09794"></a>09794               $revarr = array_reverse($revarr);
<a name="l09795"></a>09795               $ordarray = array_merge($ordarray, $revarr);
<a name="l09796"></a>09796               $revarr = Array();
<a name="l09797"></a>09797               $onlevel = <span class="keyword">false</span>;
<a name="l09798"></a>09798             }
<a name="l09799"></a>09799             $ordarray[] = $chardata[$i];
<a name="l09800"></a>09800           }
<a name="l09801"></a>09801         }
<a name="l09802"></a>09802         <span class="keywordflow">if</span> ($onlevel) {
<a name="l09803"></a>09803           $revarr = array_reverse($revarr);
<a name="l09804"></a>09804           $ordarray = array_merge($ordarray, $revarr);
<a name="l09805"></a>09805         }
<a name="l09806"></a>09806         $chardata = $ordarray;
<a name="l09807"></a>09807       }
<a name="l09808"></a>09808       
<a name="l09809"></a>09809       $ordarray = array();
<a name="l09810"></a>09810       <span class="keywordflow">for</span> ($i=0; $i &lt; $numchars; ++$i) {
<a name="l09811"></a>09811         $ordarray[] = $chardata[$i][<span class="stringliteral">&#39;char&#39;</span>];
<a name="l09812"></a>09812       }
<a name="l09813"></a>09813       
<a name="l09814"></a>09814       <span class="keywordflow">return</span> $ordarray;
<a name="l09815"></a>09815     }
<a name="l09816"></a>09816     
<a name="l09817"></a>09817     <span class="comment">// END OF BIDIRECTIONAL TEXT SECTION -------------------</span>
<a name="l09818"></a>09818     
<a name="l09819"></a>09819     <span class="comment">/*</span>
<a name="l09820"></a>09820 <span class="comment">    * Adds a bookmark.</span>
<a name="l09821"></a>09821 <span class="comment">    * @param string $txt bookmark description.</span>
<a name="l09822"></a>09822 <span class="comment">    * @param int $level bookmark level (minimum value is 0).</span>
<a name="l09823"></a>09823 <span class="comment">    * @param float $y Ordinate of the boorkmark position (default = -1 = current position).</span>
<a name="l09824"></a>09824 <span class="comment">    * @param int $page target page number (leave empty for current page).</span>
<a name="l09825"></a>09825 <span class="comment">    * @access public</span>
<a name="l09826"></a>09826 <span class="comment">    * @author Olivier Plathey, Nicola Asuni</span>
<a name="l09827"></a>09827 <span class="comment">    * @since 2.1.002 (2008-02-12)</span>
<a name="l09828"></a>09828 <span class="comment">    */</span>
<a name="l09829"></a>09829     <span class="keyword">public</span> function Bookmark($txt, $level=0, $y=-1, $page=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l09830"></a>09830       <span class="keywordflow">if</span> ($level &lt; 0) {
<a name="l09831"></a>09831         $level = 0;
<a name="l09832"></a>09832       }
<a name="l09833"></a>09833       <span class="keywordflow">if</span> (isset($this-&gt;outlines[0])) {
<a name="l09834"></a>09834         $lastoutline = end($this-&gt;outlines);
<a name="l09835"></a>09835         $maxlevel = $lastoutline[<span class="charliteral">&#39;l&#39;</span>] + 1;
<a name="l09836"></a>09836       } <span class="keywordflow">else</span> {
<a name="l09837"></a>09837         $maxlevel = 0;
<a name="l09838"></a>09838       }
<a name="l09839"></a>09839       <span class="keywordflow">if</span> ($level &gt; $maxlevel) {
<a name="l09840"></a>09840         $level = $maxlevel;
<a name="l09841"></a>09841       }
<a name="l09842"></a>09842       <span class="keywordflow">if</span> ($y == -1) {
<a name="l09843"></a>09843         $y = $this-&gt;GetY();
<a name="l09844"></a>09844       }
<a name="l09845"></a>09845       <span class="keywordflow">if</span> (empty($page)) {
<a name="l09846"></a>09846         $page = $this-&gt;PageNo();
<a name="l09847"></a>09847       }
<a name="l09848"></a>09848       $this-&gt;outlines[] = array(<span class="charliteral">&#39;t&#39;</span> =&gt; $txt, <span class="charliteral">&#39;l&#39;</span> =&gt; $level, <span class="charliteral">&#39;y&#39;</span> =&gt; $y, <span class="charliteral">&#39;p&#39;</span> =&gt; $page);
<a name="l09849"></a>09849     }
<a name="l09850"></a>09850     
<a name="l09851"></a>09851     <span class="comment">/*</span>
<a name="l09852"></a>09852 <span class="comment">    * Create a bookmark PDF string.</span>
<a name="l09853"></a>09853 <span class="comment">    * @access protected</span>
<a name="l09854"></a>09854 <span class="comment">    * @author Olivier Plathey, Nicola Asuni</span>
<a name="l09855"></a>09855 <span class="comment">    * @since 2.1.002 (2008-02-12)</span>
<a name="l09856"></a>09856 <span class="comment">    */</span>
<a name="l09857"></a>09857     <span class="keyword">protected</span> function _putbookmarks() {
<a name="l09858"></a>09858       $nb = count($this-&gt;outlines);
<a name="l09859"></a>09859       <span class="keywordflow">if</span> ($nb == 0) {
<a name="l09860"></a>09860         <span class="keywordflow">return</span>;
<a name="l09861"></a>09861       }
<a name="l09862"></a>09862       $lru = array();
<a name="l09863"></a>09863       $level = 0;
<a name="l09864"></a>09864       <span class="keywordflow">foreach</span> ($this-&gt;outlines as $i =&gt; $o) {
<a name="l09865"></a>09865         <span class="keywordflow">if</span> ($o[<span class="charliteral">&#39;l&#39;</span>] &gt; 0) {
<a name="l09866"></a>09866           $parent = $lru[($o[<span class="charliteral">&#39;l&#39;</span>] - 1)];
<a name="l09867"></a>09867           <span class="comment">//Set parent and last pointers</span>
<a name="l09868"></a>09868           $this-&gt;outlines[$i][<span class="stringliteral">&#39;parent&#39;</span>] = $parent;
<a name="l09869"></a>09869           $this-&gt;outlines[$parent][<span class="stringliteral">&#39;last&#39;</span>] = $i;
<a name="l09870"></a>09870           <span class="keywordflow">if</span> ($o[<span class="charliteral">&#39;l&#39;</span>] &gt; $level) {
<a name="l09871"></a>09871             <span class="comment">//Level increasing: set first pointer</span>
<a name="l09872"></a>09872             $this-&gt;outlines[$parent][<span class="stringliteral">&#39;first&#39;</span>] = $i;
<a name="l09873"></a>09873           }
<a name="l09874"></a>09874         } <span class="keywordflow">else</span> {
<a name="l09875"></a>09875           $this-&gt;outlines[$i][<span class="stringliteral">&#39;parent&#39;</span>] = $nb;
<a name="l09876"></a>09876         }
<a name="l09877"></a>09877         <span class="keywordflow">if</span> (($o[<span class="charliteral">&#39;l&#39;</span>] &lt;= $level) AND ($i &gt; 0)) {
<a name="l09878"></a>09878           <span class="comment">//Set prev and next pointers</span>
<a name="l09879"></a>09879           $prev = $lru[$o[<span class="charliteral">&#39;l&#39;</span>]];
<a name="l09880"></a>09880           $this-&gt;outlines[$prev][<span class="stringliteral">&#39;next&#39;</span>] = $i;
<a name="l09881"></a>09881           $this-&gt;outlines[$i][<span class="stringliteral">&#39;prev&#39;</span>] = $prev;
<a name="l09882"></a>09882         }
<a name="l09883"></a>09883         $lru[$o[<span class="charliteral">&#39;l&#39;</span>]] = $i;
<a name="l09884"></a>09884         $level = $o[<span class="charliteral">&#39;l&#39;</span>];
<a name="l09885"></a>09885       }
<a name="l09886"></a>09886       <span class="comment">//Outline items</span>
<a name="l09887"></a>09887       $n = $this-&gt;n + 1;
<a name="l09888"></a>09888       <span class="keywordflow">foreach</span> ($this-&gt;outlines as $i =&gt; $o) {
<a name="l09889"></a>09889         $this-&gt;_newobj();
<a name="l09890"></a>09890         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Title &#39;</span>.$this-&gt;_textstring($o[<span class="charliteral">&#39;t&#39;</span>]));
<a name="l09891"></a>09891         $this-&gt;_out(<span class="stringliteral">&#39;/Parent &#39;</span>.($n + $o[<span class="stringliteral">&#39;parent&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09892"></a>09892         <span class="keywordflow">if</span> (isset($o[<span class="stringliteral">&#39;prev&#39;</span>]))
<a name="l09893"></a>09893         $this-&gt;_out(<span class="stringliteral">&#39;/Prev &#39;</span>.($n + $o[<span class="stringliteral">&#39;prev&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09894"></a>09894         <span class="keywordflow">if</span> (isset($o[<span class="stringliteral">&#39;next&#39;</span>]))
<a name="l09895"></a>09895         $this-&gt;_out(<span class="stringliteral">&#39;/Next &#39;</span>.($n + $o[<span class="stringliteral">&#39;next&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09896"></a>09896         <span class="keywordflow">if</span> (isset($o[<span class="stringliteral">&#39;first&#39;</span>]))
<a name="l09897"></a>09897         $this-&gt;_out(<span class="stringliteral">&#39;/First &#39;</span>.($n + $o[<span class="stringliteral">&#39;first&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09898"></a>09898         <span class="keywordflow">if</span> (isset($o[<span class="stringliteral">&#39;last&#39;</span>]))
<a name="l09899"></a>09899         $this-&gt;_out(<span class="stringliteral">&#39;/Last &#39;</span>.($n + $o[<span class="stringliteral">&#39;last&#39;</span>]).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09900"></a>09900         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/Dest [%d 0 R /XYZ 0 %.2F null]&#39;</span>, (1 + (2 * $o[<span class="charliteral">&#39;p&#39;</span>])), ($this-&gt;pagedim[$o[<span class="charliteral">&#39;p&#39;</span>]][<span class="charliteral">&#39;h&#39;</span>] - ($o[<span class="charliteral">&#39;y&#39;</span>] * $this-&gt;k))));
<a name="l09901"></a>09901         $this-&gt;_out(<span class="stringliteral">&#39;/Count 0&gt;&gt;&#39;</span>);
<a name="l09902"></a>09902         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l09903"></a>09903       }
<a name="l09904"></a>09904       <span class="comment">//Outline root</span>
<a name="l09905"></a>09905       $this-&gt;_newobj();
<a name="l09906"></a>09906       $this-&gt;OutlineRoot = $this-&gt;n;
<a name="l09907"></a>09907       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /Outlines /First &#39;</span>.$n.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09908"></a>09908       $this-&gt;_out(<span class="stringliteral">&#39;/Last &#39;</span>.($n + $lru[0]).<span class="stringliteral">&#39; 0 R&gt;&gt;&#39;</span>);
<a name="l09909"></a>09909       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l09910"></a>09910     }
<a name="l09911"></a>09911     
<a name="l09912"></a>09912     
<a name="l09913"></a>09913     <span class="comment">// --- JAVASCRIPT ------------------------------------------------------</span>
<a name="l09914"></a>09914     
<a name="l09915"></a>09915     <span class="comment">/*</span>
<a name="l09916"></a>09916 <span class="comment">    * Adds a javascript</span>
<a name="l09917"></a>09917 <span class="comment">    * @param string $script Javascript code</span>
<a name="l09918"></a>09918 <span class="comment">    * @access public</span>
<a name="l09919"></a>09919 <span class="comment">    * @author Johannes Güntert, Nicola Asuni</span>
<a name="l09920"></a>09920 <span class="comment">    * @since 2.1.002 (2008-02-12)</span>
<a name="l09921"></a>09921 <span class="comment">    */</span>
<a name="l09922"></a>09922     <span class="keyword">public</span> function IncludeJS($script) {
<a name="l09923"></a>09923       $this-&gt;javascript .= $script;
<a name="l09924"></a>09924     }
<a name="l09925"></a>09925 
<a name="l09926"></a>09926     <span class="comment">/*</span>
<a name="l09927"></a>09927 <span class="comment">    * Adds a javascript object and return object ID</span>
<a name="l09928"></a>09928 <span class="comment">    * @param string $script Javascript code</span>
<a name="l09929"></a>09929 <span class="comment">    * @param boolean $onload if true executes this object when opening the document</span>
<a name="l09930"></a>09930 <span class="comment">    * @return int internal object ID</span>
<a name="l09931"></a>09931 <span class="comment">    * @access public</span>
<a name="l09932"></a>09932 <span class="comment">    * @author Nicola Asuni</span>
<a name="l09933"></a>09933 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l09934"></a>09934 <span class="comment">    */</span>
<a name="l09935"></a>09935     <span class="keyword">public</span> function addJavascriptObject($script, $onload=<span class="keyword">false</span>) {
<a name="l09936"></a>09936       ++$this-&gt;js_obj_id;
<a name="l09937"></a>09937       $this-&gt;js_objects[$this-&gt;js_obj_id] = array(<span class="stringliteral">&#39;js&#39;</span> =&gt; $script, <span class="stringliteral">&#39;onload&#39;</span> =&gt; $onload);
<a name="l09938"></a>09938       <span class="keywordflow">return</span> $this-&gt;js_obj_id;
<a name="l09939"></a>09939     }
<a name="l09940"></a>09940 
<a name="l09941"></a>09941     <span class="comment">/*</span>
<a name="l09942"></a>09942 <span class="comment">    * Create a javascript PDF string.</span>
<a name="l09943"></a>09943 <span class="comment">    * @access protected</span>
<a name="l09944"></a>09944 <span class="comment">    * @author Johannes Güntert, Nicola Asuni</span>
<a name="l09945"></a>09945 <span class="comment">    * @since 2.1.002 (2008-02-12)</span>
<a name="l09946"></a>09946 <span class="comment">    */</span>
<a name="l09947"></a>09947     <span class="keyword">protected</span> function _putjavascript() {
<a name="l09948"></a>09948       <span class="keywordflow">if</span> (empty($this-&gt;javascript) AND empty($this-&gt;js_objects)) {
<a name="l09949"></a>09949         <span class="keywordflow">return</span>;
<a name="l09950"></a>09950       }
<a name="l09951"></a>09951       <span class="keywordflow">if</span> (strpos($this-&gt;javascript, <span class="stringliteral">&#39;this.addField&#39;</span>) &gt; 0) {
<a name="l09952"></a>09952         <span class="keywordflow">if</span> (!$this-&gt;ur) {
<a name="l09953"></a>09953           <span class="comment">//$this-&gt;setUserRights();</span>
<a name="l09954"></a>09954         }
<a name="l09955"></a>09955         <span class="comment">// the following two lines are used to avoid form fields duplication after saving</span>
<a name="l09956"></a>09956         <span class="comment">// The addField method only works on Acrobat Writer, unless the document is signed with Adobe private key (UR3)</span>
<a name="l09957"></a>09957         $jsa = sprintf(<span class="stringliteral">&quot;ftcpdfdocsaved=this.addField(&#39;%s&#39;,&#39;%s&#39;,%d,[%.2F,%.2F,%.2F,%.2F]);&quot;</span>, <span class="stringliteral">&#39;tcpdfdocsaved&#39;</span>, <span class="stringliteral">&#39;text&#39;</span>, 0, 0, 1, 0, 1);
<a name="l09958"></a>09958         $jsb = <span class="stringliteral">&quot;getField(&#39;tcpdfdocsaved&#39;).value=&#39;saved&#39;;&quot;</span>;
<a name="l09959"></a>09959         $this-&gt;javascript = $jsa.<span class="stringliteral">&quot;\n&quot;</span>.$this-&gt;javascript.<span class="stringliteral">&quot;\n&quot;</span>.$jsb;
<a name="l09960"></a>09960       }
<a name="l09961"></a>09961       $this-&gt;n_js = $this-&gt;_newobj();
<a name="l09962"></a>09962       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l09963"></a>09963       $this-&gt;_out(<span class="stringliteral">&#39;/Names [&#39;</span>);
<a name="l09964"></a>09964       <span class="keywordflow">if</span> (!empty($this-&gt;javascript)) {
<a name="l09965"></a>09965         $this-&gt;_out(<span class="stringliteral">&#39;(EmbeddedJS) &#39;</span>.($this-&gt;n + 1).<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09966"></a>09966       }
<a name="l09967"></a>09967       <span class="keywordflow">if</span> (!empty($this-&gt;js_objects)) {
<a name="l09968"></a>09968         <span class="keywordflow">foreach</span> ($this-&gt;js_objects as $key =&gt; $val) {
<a name="l09969"></a>09969           <span class="keywordflow">if</span> ($val[<span class="stringliteral">&#39;onload&#39;</span>]) {
<a name="l09970"></a>09970             $this-&gt;_out(<span class="stringliteral">&#39;(JS&#39;</span>.$key.<span class="stringliteral">&#39;) &#39;</span>.$key.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l09971"></a>09971           }
<a name="l09972"></a>09972         }
<a name="l09973"></a>09973       }
<a name="l09974"></a>09974       $this-&gt;_out(<span class="charliteral">&#39;]&#39;</span>);
<a name="l09975"></a>09975       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l09976"></a>09976       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l09977"></a>09977       <span class="comment">// default Javascript object</span>
<a name="l09978"></a>09978       <span class="keywordflow">if</span> (!empty($this-&gt;javascript)) {
<a name="l09979"></a>09979         $this-&gt;_newobj();
<a name="l09980"></a>09980         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l09981"></a>09981         $this-&gt;_out(<span class="stringliteral">&#39;/S /JavaScript&#39;</span>);
<a name="l09982"></a>09982         $this-&gt;_out(<span class="stringliteral">&#39;/JS &#39;</span>.$this-&gt;_textstring($this-&gt;javascript));
<a name="l09983"></a>09983         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l09984"></a>09984         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l09985"></a>09985       }
<a name="l09986"></a>09986       <span class="comment">// additional Javascript objects</span>
<a name="l09987"></a>09987       <span class="keywordflow">if</span> (!empty($this-&gt;js_objects)) {
<a name="l09988"></a>09988         <span class="keywordflow">foreach</span> ($this-&gt;js_objects as $key =&gt; $val) {
<a name="l09989"></a>09989           $this-&gt;offsets[$key] = $this-&gt;bufferlen;
<a name="l09990"></a>09990           $this-&gt;_out($key.<span class="stringliteral">&#39; 0 obj&#39;</span>);
<a name="l09991"></a>09991           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l09992"></a>09992           $this-&gt;_out(<span class="stringliteral">&#39;/S /JavaScript&#39;</span>);
<a name="l09993"></a>09993           $this-&gt;_out(<span class="stringliteral">&#39;/JS &#39;</span>.$this-&gt;_textstring($val[<span class="stringliteral">&#39;js&#39;</span>]));
<a name="l09994"></a>09994           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l09995"></a>09995           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l09996"></a>09996         }
<a name="l09997"></a>09997       }     
<a name="l09998"></a>09998     }
<a name="l09999"></a>09999     
<a name="l10000"></a>10000     <span class="comment">/*</span>
<a name="l10001"></a>10001 <span class="comment">    * Convert color to javascript color.</span>
<a name="l10002"></a>10002 <span class="comment">    * @param string $color color name or #RRGGBB</span>
<a name="l10003"></a>10003 <span class="comment">    * @access protected</span>
<a name="l10004"></a>10004 <span class="comment">    * @author Denis Van Nuffelen, Nicola Asuni</span>
<a name="l10005"></a>10005 <span class="comment">    * @since 2.1.002 (2008-02-12)</span>
<a name="l10006"></a>10006 <span class="comment">    */</span>
<a name="l10007"></a>10007     <span class="keyword">protected</span> function _JScolor($color) {
<a name="l10008"></a>10008       <span class="keyword">static</span> $aColors = array(<span class="stringliteral">&#39;transparent&#39;</span>, <span class="stringliteral">&#39;black&#39;</span>, <span class="stringliteral">&#39;white&#39;</span>, <span class="stringliteral">&#39;red&#39;</span>, <span class="stringliteral">&#39;green&#39;</span>, <span class="stringliteral">&#39;blue&#39;</span>, <span class="stringliteral">&#39;cyan&#39;</span>, <span class="stringliteral">&#39;magenta&#39;</span>, <span class="stringliteral">&#39;yellow&#39;</span>, <span class="stringliteral">&#39;dkGray&#39;</span>, <span class="stringliteral">&#39;gray&#39;</span>, <span class="stringliteral">&#39;ltGray&#39;</span>);
<a name="l10009"></a>10009       <span class="keywordflow">if</span> (substr($color,0,1) == <span class="charliteral">&#39;#&#39;</span>) {
<a name="l10010"></a>10010         <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&quot;[&#39;RGB&#39;,%.3F,%.3F,%.3F]&quot;</span>, hexdec(substr($color,1,2))/255, hexdec(substr($color,3,2))/255, hexdec(substr($color,5,2))/255);
<a name="l10011"></a>10011       }
<a name="l10012"></a>10012       <span class="keywordflow">if</span> (!in_array($color,$aColors)) {
<a name="l10013"></a>10013         $this-&gt;Error(<span class="stringliteral">&#39;Invalid color: &#39;</span>.$color);
<a name="l10014"></a>10014       }
<a name="l10015"></a>10015       <span class="keywordflow">return</span> <span class="stringliteral">&#39;color.&#39;</span>.$color;
<a name="l10016"></a>10016     }
<a name="l10017"></a>10017     
<a name="l10018"></a>10018     <span class="comment">/*</span>
<a name="l10019"></a>10019 <span class="comment">    * Adds a javascript form field.</span>
<a name="l10020"></a>10020 <span class="comment">    * @param string $type field type</span>
<a name="l10021"></a>10021 <span class="comment">    * @param string $name field name</span>
<a name="l10022"></a>10022 <span class="comment">    * @param int $x horizontal position</span>
<a name="l10023"></a>10023 <span class="comment">    * @param int $y vertical position</span>
<a name="l10024"></a>10024 <span class="comment">    * @param int $w width</span>
<a name="l10025"></a>10025 <span class="comment">    * @param int $h height</span>
<a name="l10026"></a>10026 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10027"></a>10027 <span class="comment">    * @access protected</span>
<a name="l10028"></a>10028 <span class="comment">    * @author Denis Van Nuffelen, Nicola Asuni</span>
<a name="l10029"></a>10029 <span class="comment">    * @since 2.1.002 (2008-02-12)</span>
<a name="l10030"></a>10030 <span class="comment">    */</span>
<a name="l10031"></a>10031     <span class="keyword">protected</span> function _addfield($type, $name, $x, $y, $w, $h, $prop) {
<a name="l10032"></a>10032       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10033"></a>10033         $x = $x - $w;
<a name="l10034"></a>10034       }
<a name="l10035"></a>10035       <span class="comment">// the followind avoid fields duplication after saving the document</span>
<a name="l10036"></a>10036       $this-&gt;javascript .= <span class="stringliteral">&quot;if(getField(&#39;tcpdfdocsaved&#39;).value != &#39;saved&#39;) {&quot;</span>;
<a name="l10037"></a>10037       $k = $this-&gt;k;
<a name="l10038"></a>10038       $this-&gt;javascript .= sprintf(<span class="stringliteral">&quot;f&quot;</span>.$name.<span class="stringliteral">&quot;=this.addField(&#39;%s&#39;,&#39;%s&#39;,%d,[%.2F,%.2F,%.2F,%.2F]);&quot;</span>, $name, $type, $this-&gt;PageNo()-1, $x*$k, ($this-&gt;h-$y)*$k+1, ($x+$w)*$k, ($this-&gt;h-$y-$h)*$k+1).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l10039"></a>10039       $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&#39;.textSize=&#39;</span>.$this-&gt;FontSizePt.<span class="stringliteral">&quot;;\n&quot;</span>;
<a name="l10040"></a>10040       <span class="keywordflow">while</span> (list($key, $val) = each($prop)) {
<a name="l10041"></a>10041         <span class="keywordflow">if</span> (strcmp(substr($key, -5), <span class="stringliteral">&#39;Color&#39;</span>) == 0) {
<a name="l10042"></a>10042           $val = $this-&gt;_JScolor($val);
<a name="l10043"></a>10043         } <span class="keywordflow">else</span> {
<a name="l10044"></a>10044           $val = <span class="stringliteral">&quot;&#39;&quot;</span>.$val.<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l10045"></a>10045         }
<a name="l10046"></a>10046         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="charliteral">&#39;.&#39;</span>.$key.<span class="charliteral">&#39;=&#39;</span>.$val.<span class="stringliteral">&quot;;\n&quot;</span>;
<a name="l10047"></a>10047       }
<a name="l10048"></a>10048       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10049"></a>10049         $this-&gt;x -= $w;
<a name="l10050"></a>10050       } <span class="keywordflow">else</span> {
<a name="l10051"></a>10051         $this-&gt;x += $w;
<a name="l10052"></a>10052       }
<a name="l10053"></a>10053       $this-&gt;javascript .= <span class="charliteral">&#39;}&#39;</span>;
<a name="l10054"></a>10054     }
<a name="l10055"></a>10055 
<a name="l10056"></a>10056     <span class="comment">// --- FORM FIELDS -----------------------------------------------------</span>
<a name="l10057"></a>10057 
<a name="l10058"></a>10058     <span class="comment">/*</span>
<a name="l10059"></a>10059 <span class="comment">    * Convert JavaScript form fields properties array to Annotation Properties array.</span>
<a name="l10060"></a>10060 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10061"></a>10061 <span class="comment">    * @return array of annotation properties</span>
<a name="l10062"></a>10062 <span class="comment">    * @access protected</span>
<a name="l10063"></a>10063 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10064"></a>10064 <span class="comment">    * @since 4.8.000 (2009-09-06)</span>
<a name="l10065"></a>10065 <span class="comment">    */</span>
<a name="l10066"></a>10066     <span class="keyword">protected</span> function getAnnotOptFromJSProp($prop) {
<a name="l10067"></a>10067       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;aopt&#39;</span>]) AND is_array($prop[<span class="stringliteral">&#39;aopt&#39;</span>])) {
<a name="l10068"></a>10068         <span class="comment">// the annotation options area lready defined</span>
<a name="l10069"></a>10069         <span class="keywordflow">return</span> $prop[<span class="stringliteral">&#39;aopt&#39;</span>];
<a name="l10070"></a>10070       }
<a name="l10071"></a>10071       $opt = array(); <span class="comment">// value to be returned</span>
<a name="l10072"></a>10072       <span class="comment">// alignment: Controls how the text is laid out within the text field.</span>
<a name="l10073"></a>10073       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;alignment&#39;</span>])) {
<a name="l10074"></a>10074         <span class="keywordflow">switch</span> ($prop[<span class="stringliteral">&#39;alignment&#39;</span>]) {
<a name="l10075"></a>10075           <span class="keywordflow">case</span> <span class="stringliteral">&#39;left&#39;</span>: {
<a name="l10076"></a>10076             $opt[<span class="charliteral">&#39;q&#39;</span>] = 0;
<a name="l10077"></a>10077             <span class="keywordflow">break</span>;
<a name="l10078"></a>10078           }
<a name="l10079"></a>10079           <span class="keywordflow">case</span> <span class="stringliteral">&#39;center&#39;</span>: {
<a name="l10080"></a>10080             $opt[<span class="charliteral">&#39;q&#39;</span>] = 1;
<a name="l10081"></a>10081             <span class="keywordflow">break</span>;
<a name="l10082"></a>10082           }
<a name="l10083"></a>10083           <span class="keywordflow">case</span> <span class="stringliteral">&#39;right&#39;</span>: {
<a name="l10084"></a>10084             $opt[<span class="charliteral">&#39;q&#39;</span>] = 2;
<a name="l10085"></a>10085             <span class="keywordflow">break</span>;
<a name="l10086"></a>10086           }
<a name="l10087"></a>10087           <span class="keywordflow">default</span>: {
<a name="l10088"></a>10088             $opt[<span class="charliteral">&#39;q&#39;</span>] = ($this-&gt;rtl)?2:0;
<a name="l10089"></a>10089             <span class="keywordflow">break</span>;
<a name="l10090"></a>10090           }
<a name="l10091"></a>10091         }
<a name="l10092"></a>10092       }
<a name="l10093"></a>10093       <span class="comment">// lineWidth: Specifies the thickness of the border when stroking the perimeter of a field&#39;s rectangle.</span>
<a name="l10094"></a>10094       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;lineWidth&#39;</span>])) {
<a name="l10095"></a>10095         $linewidth = intval($prop[<span class="stringliteral">&#39;lineWidth&#39;</span>]);
<a name="l10096"></a>10096       } <span class="keywordflow">else</span> {
<a name="l10097"></a>10097         $linewidth = 1;
<a name="l10098"></a>10098       }
<a name="l10099"></a>10099       <span class="comment">// borderStyle: The border style for a field.</span>
<a name="l10100"></a>10100       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;borderStyle&#39;</span>])) {
<a name="l10101"></a>10101         <span class="keywordflow">switch</span> ($prop[<span class="stringliteral">&#39;borderStyle&#39;</span>]) {
<a name="l10102"></a>10102           <span class="keywordflow">case</span> <span class="stringliteral">&#39;border.d&#39;</span>:
<a name="l10103"></a>10103           <span class="keywordflow">case</span> <span class="stringliteral">&#39;dashed&#39;</span>: {
<a name="l10104"></a>10104             $opt[<span class="stringliteral">&#39;border&#39;</span>] = array(0, 0, $linewidth, array(3, 2));
<a name="l10105"></a>10105             $opt[<span class="stringliteral">&#39;bs&#39;</span>] = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$linewidth, <span class="charliteral">&#39;s&#39;</span>=&gt;<span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;d&#39;</span>=&gt;array(3, 2));
<a name="l10106"></a>10106             <span class="keywordflow">break</span>;
<a name="l10107"></a>10107           }
<a name="l10108"></a>10108           <span class="keywordflow">case</span> <span class="stringliteral">&#39;border.b&#39;</span>:
<a name="l10109"></a>10109           <span class="keywordflow">case</span> <span class="stringliteral">&#39;beveled&#39;</span>: {
<a name="l10110"></a>10110             $opt[<span class="stringliteral">&#39;border&#39;</span>] = array(0, 0, $linewidth);
<a name="l10111"></a>10111             $opt[<span class="stringliteral">&#39;bs&#39;</span>] = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$linewidth, <span class="charliteral">&#39;s&#39;</span>=&gt;<span class="charliteral">&#39;B&#39;</span>);
<a name="l10112"></a>10112             <span class="keywordflow">break</span>;
<a name="l10113"></a>10113           }
<a name="l10114"></a>10114           <span class="keywordflow">case</span> <span class="stringliteral">&#39;border.i&#39;</span>:
<a name="l10115"></a>10115           <span class="keywordflow">case</span> <span class="stringliteral">&#39;inset&#39;</span>: {
<a name="l10116"></a>10116             $opt[<span class="stringliteral">&#39;border&#39;</span>] = array(0, 0, $linewidth);
<a name="l10117"></a>10117             $opt[<span class="stringliteral">&#39;bs&#39;</span>] = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$linewidth, <span class="charliteral">&#39;s&#39;</span>=&gt;<span class="charliteral">&#39;I&#39;</span>);
<a name="l10118"></a>10118             <span class="keywordflow">break</span>;
<a name="l10119"></a>10119           }
<a name="l10120"></a>10120           <span class="keywordflow">case</span> <span class="stringliteral">&#39;border.u&#39;</span>:
<a name="l10121"></a>10121           <span class="keywordflow">case</span> <span class="stringliteral">&#39;underline&#39;</span>: {
<a name="l10122"></a>10122             $opt[<span class="stringliteral">&#39;border&#39;</span>] = array(0, 0, $linewidth);
<a name="l10123"></a>10123             $opt[<span class="stringliteral">&#39;bs&#39;</span>] = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$linewidth, <span class="charliteral">&#39;s&#39;</span>=&gt;<span class="charliteral">&#39;U&#39;</span>);
<a name="l10124"></a>10124             <span class="keywordflow">break</span>;
<a name="l10125"></a>10125           }
<a name="l10126"></a>10126           <span class="keywordflow">default</span>:
<a name="l10127"></a>10127           <span class="keywordflow">case</span> <span class="stringliteral">&#39;border.s&#39;</span>:
<a name="l10128"></a>10128           <span class="keywordflow">case</span> <span class="stringliteral">&#39;solid&#39;</span>: {
<a name="l10129"></a>10129             $opt[<span class="stringliteral">&#39;border&#39;</span>] = array(0, 0, $linewidth);
<a name="l10130"></a>10130             $opt[<span class="stringliteral">&#39;bs&#39;</span>] = array(<span class="charliteral">&#39;w&#39;</span>=&gt;$linewidth, <span class="charliteral">&#39;s&#39;</span>=&gt;<span class="charliteral">&#39;S&#39;</span>);
<a name="l10131"></a>10131             <span class="keywordflow">break</span>;
<a name="l10132"></a>10132           }
<a name="l10133"></a>10133         }
<a name="l10134"></a>10134       }
<a name="l10135"></a>10135       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;border&#39;</span>]) AND is_array($prop[<span class="stringliteral">&#39;border&#39;</span>])) {
<a name="l10136"></a>10136         $opt[<span class="stringliteral">&#39;border&#39;</span>] = $prop[<span class="stringliteral">&#39;border&#39;</span>];
<a name="l10137"></a>10137       }
<a name="l10138"></a>10138       <span class="keywordflow">if</span> (!isset($opt[<span class="stringliteral">&#39;mk&#39;</span>])) {
<a name="l10139"></a>10139         $opt[<span class="stringliteral">&#39;mk&#39;</span>] = array();
<a name="l10140"></a>10140       }
<a name="l10141"></a>10141       <span class="keywordflow">if</span> (!isset($opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>])) {
<a name="l10142"></a>10142         $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>] = array();
<a name="l10143"></a>10143       }
<a name="l10144"></a>10144       $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>] = array(0.5, 0.5);
<a name="l10145"></a>10145       <span class="comment">// buttonAlignX: Controls how space is distributed from the left of the button face with respect to the icon.</span>
<a name="l10146"></a>10146       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;buttonAlignX&#39;</span>])) {
<a name="l10147"></a>10147         $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>][0] = $prop[<span class="stringliteral">&#39;buttonAlignX&#39;</span>];
<a name="l10148"></a>10148       }
<a name="l10149"></a>10149       <span class="comment">// buttonAlignY: Controls how unused space is distributed from the bottom of the button face with respect to the icon.</span>
<a name="l10150"></a>10150       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;buttonAlignY&#39;</span>])) {
<a name="l10151"></a>10151         $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;a&#39;</span>][1] = $prop[<span class="stringliteral">&#39;buttonAlignY&#39;</span>];
<a name="l10152"></a>10152       }
<a name="l10153"></a>10153       <span class="comment">// buttonFitBounds: If true, the extent to which the icon may be scaled is set to the bounds of the button field.</span>
<a name="l10154"></a>10154       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;buttonFitBounds&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;buttonFitBounds&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10155"></a>10155         $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;fb&#39;</span>] = <span class="keyword">true</span>;
<a name="l10156"></a>10156       }     
<a name="l10157"></a>10157       <span class="comment">// buttonScaleHow: Controls how the icon is scaled (if necessary) to fit inside the button face.</span>
<a name="l10158"></a>10158       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;buttonScaleHow&#39;</span>])) {
<a name="l10159"></a>10159         <span class="keywordflow">switch</span> ($prop[<span class="stringliteral">&#39;buttonScaleHow&#39;</span>]) {
<a name="l10160"></a>10160           <span class="keywordflow">case</span> <span class="stringliteral">&#39;scaleHow.proportional&#39;</span>: {
<a name="l10161"></a>10161             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = <span class="charliteral">&#39;P&#39;</span>;
<a name="l10162"></a>10162             <span class="keywordflow">break</span>;
<a name="l10163"></a>10163           }
<a name="l10164"></a>10164           <span class="keywordflow">case</span> <span class="stringliteral">&#39;scaleHow.anamorphic&#39;</span>: {
<a name="l10165"></a>10165             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="charliteral">&#39;s&#39;</span>] = <span class="charliteral">&#39;A&#39;</span>;
<a name="l10166"></a>10166             <span class="keywordflow">break</span>;
<a name="l10167"></a>10167           }
<a name="l10168"></a>10168         }
<a name="l10169"></a>10169       }
<a name="l10170"></a>10170       <span class="comment">// buttonScaleWhen: Controls when an icon is scaled to fit inside the button face.</span>
<a name="l10171"></a>10171       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;buttonScaleWhen&#39;</span>])) {
<a name="l10172"></a>10172         <span class="keywordflow">switch</span> ($prop[<span class="stringliteral">&#39;buttonScaleWhen&#39;</span>]) {
<a name="l10173"></a>10173           <span class="keywordflow">case</span> <span class="stringliteral">&#39;scaleWhen.always&#39;</span>: {
<a name="l10174"></a>10174             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>] = <span class="charliteral">&#39;A&#39;</span>;
<a name="l10175"></a>10175             <span class="keywordflow">break</span>;
<a name="l10176"></a>10176           }
<a name="l10177"></a>10177           <span class="keywordflow">case</span> <span class="stringliteral">&#39;scaleWhen.never&#39;</span>: {
<a name="l10178"></a>10178             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>] = <span class="charliteral">&#39;N&#39;</span>;
<a name="l10179"></a>10179             <span class="keywordflow">break</span>;
<a name="l10180"></a>10180           }
<a name="l10181"></a>10181           <span class="keywordflow">case</span> <span class="stringliteral">&#39;scaleWhen.tooBig&#39;</span>: {
<a name="l10182"></a>10182             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>] = <span class="charliteral">&#39;B&#39;</span>;
<a name="l10183"></a>10183             <span class="keywordflow">break</span>;
<a name="l10184"></a>10184           }
<a name="l10185"></a>10185           <span class="keywordflow">case</span> <span class="stringliteral">&#39;scaleWhen.tooSmall&#39;</span>: {
<a name="l10186"></a>10186             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>][<span class="stringliteral">&#39;sw&#39;</span>] = <span class="charliteral">&#39;S&#39;</span>;
<a name="l10187"></a>10187             <span class="keywordflow">break</span>;
<a name="l10188"></a>10188           }
<a name="l10189"></a>10189         }
<a name="l10190"></a>10190       }
<a name="l10191"></a>10191       <span class="comment">// buttonPosition: Controls how the text and the icon of the button are positioned with respect to each other within the button face.</span>
<a name="l10192"></a>10192       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;buttonPosition&#39;</span>])) {
<a name="l10193"></a>10193         <span class="keywordflow">switch</span> ($prop[<span class="stringliteral">&#39;buttonPosition&#39;</span>]) {
<a name="l10194"></a>10194           <span class="keywordflow">case</span> 0:
<a name="l10195"></a>10195           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.textOnly&#39;</span>: {
<a name="l10196"></a>10196             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 0;
<a name="l10197"></a>10197             <span class="keywordflow">break</span>;
<a name="l10198"></a>10198           }
<a name="l10199"></a>10199           <span class="keywordflow">case</span> 1:
<a name="l10200"></a>10200           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.iconOnly&#39;</span>: {
<a name="l10201"></a>10201             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 1;
<a name="l10202"></a>10202             <span class="keywordflow">break</span>;
<a name="l10203"></a>10203           }
<a name="l10204"></a>10204           <span class="keywordflow">case</span> 2:
<a name="l10205"></a>10205           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.iconTextV&#39;</span>: {
<a name="l10206"></a>10206             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 2;
<a name="l10207"></a>10207             <span class="keywordflow">break</span>;
<a name="l10208"></a>10208           }
<a name="l10209"></a>10209           <span class="keywordflow">case</span> 3:
<a name="l10210"></a>10210           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.textIconV&#39;</span>: {
<a name="l10211"></a>10211             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 3;
<a name="l10212"></a>10212             <span class="keywordflow">break</span>;
<a name="l10213"></a>10213           }
<a name="l10214"></a>10214           <span class="keywordflow">case</span> 4:
<a name="l10215"></a>10215           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.iconTextH&#39;</span>: {
<a name="l10216"></a>10216             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 4;
<a name="l10217"></a>10217             <span class="keywordflow">break</span>;
<a name="l10218"></a>10218           }
<a name="l10219"></a>10219           <span class="keywordflow">case</span> 5:
<a name="l10220"></a>10220           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.textIconH&#39;</span>: {
<a name="l10221"></a>10221             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 5;
<a name="l10222"></a>10222             <span class="keywordflow">break</span>;
<a name="l10223"></a>10223           }
<a name="l10224"></a>10224           <span class="keywordflow">case</span> 6:
<a name="l10225"></a>10225           <span class="keywordflow">case</span> <span class="stringliteral">&#39;position.overlay&#39;</span>: {
<a name="l10226"></a>10226             $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;tp&#39;</span>] = 6;
<a name="l10227"></a>10227             <span class="keywordflow">break</span>;
<a name="l10228"></a>10228           }
<a name="l10229"></a>10229         }       
<a name="l10230"></a>10230       }
<a name="l10231"></a>10231       <span class="comment">// fillColor: Specifies the background color for a field.</span>
<a name="l10232"></a>10232       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;fillColor&#39;</span>])) {
<a name="l10233"></a>10233         <span class="keywordflow">if</span> (is_array($prop[<span class="stringliteral">&#39;fillColor&#39;</span>])) {
<a name="l10234"></a>10234           $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bg&#39;</span>] = $prop[<span class="stringliteral">&#39;fillColor&#39;</span>];
<a name="l10235"></a>10235         } <span class="keywordflow">else</span> {
<a name="l10236"></a>10236           $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bg&#39;</span>] = $this-&gt;convertHTMLColorToDec($prop[<span class="stringliteral">&#39;fillColor&#39;</span>]);
<a name="l10237"></a>10237         }
<a name="l10238"></a>10238       }
<a name="l10239"></a>10239       <span class="comment">// strokeColor: Specifies the stroke color for a field that is used to stroke the rectangle of the field with a line as large as the line width.</span>
<a name="l10240"></a>10240       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;strokeColor&#39;</span>])) {
<a name="l10241"></a>10241         <span class="keywordflow">if</span> (is_array($prop[<span class="stringliteral">&#39;strokeColor&#39;</span>])) {
<a name="l10242"></a>10242           $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bc&#39;</span>] = $prop[<span class="stringliteral">&#39;strokeColor&#39;</span>];
<a name="l10243"></a>10243         } <span class="keywordflow">else</span> {
<a name="l10244"></a>10244           $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;bc&#39;</span>] = $this-&gt;convertHTMLColorToDec($prop[<span class="stringliteral">&#39;strokeColor&#39;</span>]);
<a name="l10245"></a>10245         }
<a name="l10246"></a>10246       }
<a name="l10247"></a>10247       <span class="comment">// rotation: The rotation of a widget in counterclockwise increments.</span>
<a name="l10248"></a>10248       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;rotation&#39;</span>])) {
<a name="l10249"></a>10249         $opt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="charliteral">&#39;r&#39;</span>] = $prop[<span class="stringliteral">&#39;rotation&#39;</span>];
<a name="l10250"></a>10250       }
<a name="l10251"></a>10251       <span class="comment">// charLimit: Limits the number of characters that a user can type into a text field.</span>
<a name="l10252"></a>10252       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;charLimit&#39;</span>])) {
<a name="l10253"></a>10253         $opt[<span class="stringliteral">&#39;maxlen&#39;</span>] = intval($prop[<span class="stringliteral">&#39;charLimit&#39;</span>]);
<a name="l10254"></a>10254       }
<a name="l10255"></a>10255       <span class="keywordflow">if</span> (!isset($ff)) {
<a name="l10256"></a>10256         $ff = 0;
<a name="l10257"></a>10257       }
<a name="l10258"></a>10258       <span class="comment">// readonly: The read-only characteristic of a field. If a field is read-only, the user can see the field but cannot change it.</span>
<a name="l10259"></a>10259       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;readonly&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;readonly&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10260"></a>10260         $ff += 1 &lt;&lt; 0;
<a name="l10261"></a>10261       }
<a name="l10262"></a>10262       <span class="comment">// required: Specifies whether a field requires a value.</span>
<a name="l10263"></a>10263       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;required&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;required&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10264"></a>10264         $ff += 1 &lt;&lt; 1;
<a name="l10265"></a>10265       }
<a name="l10266"></a>10266       <span class="comment">// multiline: Controls how text is wrapped within the field.</span>
<a name="l10267"></a>10267       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;multiline&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;multiline&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10268"></a>10268         $ff += 1 &lt;&lt; 12;
<a name="l10269"></a>10269       }
<a name="l10270"></a>10270       <span class="comment">// password: Specifies whether the field should display asterisks when data is entered in the field.</span>
<a name="l10271"></a>10271       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;password&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;password&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10272"></a>10272         $ff += 1 &lt;&lt; 13;
<a name="l10273"></a>10273       }
<a name="l10274"></a>10274       <span class="comment">// NoToggleToOff: If set, exactly one radio button shall be selected at all times; selecting the currently selected button has no effect.</span>
<a name="l10275"></a>10275       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;NoToggleToOff&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;NoToggleToOff&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10276"></a>10276         $ff += 1 &lt;&lt; 14;
<a name="l10277"></a>10277       }
<a name="l10278"></a>10278       <span class="comment">// Radio: If set, the field is a set of radio buttons.</span>
<a name="l10279"></a>10279       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;Radio&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;Radio&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10280"></a>10280         $ff += 1 &lt;&lt; 15;
<a name="l10281"></a>10281       }
<a name="l10282"></a>10282       <span class="comment">// Pushbutton: If set, the field is a pushbutton that does not retain a permanent value.</span>
<a name="l10283"></a>10283       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;Pushbutton&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;Pushbutton&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10284"></a>10284         $ff += 1 &lt;&lt; 16;
<a name="l10285"></a>10285       }
<a name="l10286"></a>10286       <span class="comment">// Combo: If set, the field is a combo box; if clear, the field is a list box.</span>
<a name="l10287"></a>10287       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;Combo&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;Combo&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10288"></a>10288         $ff += 1 &lt;&lt; 17;
<a name="l10289"></a>10289       }
<a name="l10290"></a>10290       <span class="comment">// editable: Controls whether a combo box is editable.</span>
<a name="l10291"></a>10291       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;editable&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;editable&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10292"></a>10292         $ff += 1 &lt;&lt; 18;
<a name="l10293"></a>10293       }
<a name="l10294"></a>10294       <span class="comment">// Sort: If set, the field&#39;s option items shall be sorted alphabetically.</span>
<a name="l10295"></a>10295       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;Sort&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;Sort&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10296"></a>10296         $ff += 1 &lt;&lt; 19;
<a name="l10297"></a>10297       }
<a name="l10298"></a>10298       <span class="comment">// fileSelect: If true, sets the file-select flag in the Options tab of the text field (Field is Used for File Selection).</span>
<a name="l10299"></a>10299       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;fileSelect&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;fileSelect&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10300"></a>10300         $ff += 1 &lt;&lt; 20;
<a name="l10301"></a>10301       }
<a name="l10302"></a>10302       <span class="comment">// multipleSelection: If true, indicates that a list box allows a multiple selection of items.</span>
<a name="l10303"></a>10303       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;multipleSelection&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;multipleSelection&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10304"></a>10304         $ff += 1 &lt;&lt; 21;
<a name="l10305"></a>10305       }
<a name="l10306"></a>10306       <span class="comment">// doNotSpellCheck: If true, spell checking is not performed on this editable text field.</span>
<a name="l10307"></a>10307       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;doNotSpellCheck&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;doNotSpellCheck&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10308"></a>10308         $ff += 1 &lt;&lt; 22;
<a name="l10309"></a>10309       }
<a name="l10310"></a>10310       <span class="comment">// doNotScroll: If true, the text field does not scroll and the user, therefore, is limited by the rectangular region designed for the field.</span>
<a name="l10311"></a>10311       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;doNotScroll&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;doNotScroll&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10312"></a>10312         $ff += 1 &lt;&lt; 23;
<a name="l10313"></a>10313       }
<a name="l10314"></a>10314       <span class="comment">// comb: If set to true, the field background is drawn as series of boxes (one for each character in the value of the field) and each character of the content is drawn within those boxes. The number of boxes drawn is determined from the charLimit property. It applies only to text fields. The setter will also raise if any of the following field properties are also set multiline, password, and fileSelect. A side-effect of setting this property is that the doNotScroll property is also set.</span>
<a name="l10315"></a>10315       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;comb&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;comb&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10316"></a>10316         $ff += 1 &lt;&lt; 24;
<a name="l10317"></a>10317       }
<a name="l10318"></a>10318       <span class="comment">// radiosInUnison: If false, even if a group of radio buttons have the same name and export value, they behave in a mutually exclusive fashion, like HTML radio buttons.</span>
<a name="l10319"></a>10319       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;radiosInUnison&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;radiosInUnison&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10320"></a>10320         $ff += 1 &lt;&lt; 25;
<a name="l10321"></a>10321       }
<a name="l10322"></a>10322       <span class="comment">// richText: If true, the field allows rich text formatting.</span>
<a name="l10323"></a>10323       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;richText&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;richText&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10324"></a>10324         $ff += 1 &lt;&lt; 25;
<a name="l10325"></a>10325       }
<a name="l10326"></a>10326       <span class="comment">// commitOnSelChange: Controls whether a field value is committed after a selection change.</span>
<a name="l10327"></a>10327       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;commitOnSelChange&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;commitOnSelChange&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10328"></a>10328         $ff += 1 &lt;&lt; 26;
<a name="l10329"></a>10329       }
<a name="l10330"></a>10330       $opt[<span class="stringliteral">&#39;ff&#39;</span>] = $ff;
<a name="l10331"></a>10331       <span class="comment">// defaultValue: The default value of a field - that is, the value that the field is set to when the form is reset.</span>
<a name="l10332"></a>10332       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;defaultValue&#39;</span>])) {
<a name="l10333"></a>10333         $opt[<span class="stringliteral">&#39;dv&#39;</span>] = $prop[<span class="stringliteral">&#39;defaultValue&#39;</span>];
<a name="l10334"></a>10334       }
<a name="l10335"></a>10335       $f = 4; <span class="comment">// default value for annotation flags</span>
<a name="l10336"></a>10336       <span class="comment">// readonly: The read-only characteristic of a field. If a field is read-only, the user can see the field but cannot change it.</span>
<a name="l10337"></a>10337       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;readonly&#39;</span>]) AND ($prop[<span class="stringliteral">&#39;readonly&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l10338"></a>10338         $f += 1 &lt;&lt; 6;
<a name="l10339"></a>10339       }
<a name="l10340"></a>10340       <span class="comment">// display: Controls whether the field is hidden or visible on screen and in print.</span>
<a name="l10341"></a>10341       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;display&#39;</span>])) {
<a name="l10342"></a>10342         <span class="keywordflow">if</span> ($prop[<span class="stringliteral">&#39;display&#39;</span>] == <span class="stringliteral">&#39;display.visible&#39;</span>) {
<a name="l10343"></a>10343           <span class="comment">//</span>
<a name="l10344"></a>10344         } elseif ($prop[<span class="stringliteral">&#39;display&#39;</span>] == <span class="stringliteral">&#39;display.hidden&#39;</span>) {
<a name="l10345"></a>10345           $f += 1 &lt;&lt; 1;
<a name="l10346"></a>10346         } elseif ($prop[<span class="stringliteral">&#39;display&#39;</span>] == <span class="stringliteral">&#39;display.noPrint&#39;</span>) {
<a name="l10347"></a>10347           $f -= 1 &lt;&lt; 2;
<a name="l10348"></a>10348         } elseif ($prop[<span class="stringliteral">&#39;display&#39;</span>] == <span class="stringliteral">&#39;display.noView&#39;</span>) {
<a name="l10349"></a>10349           $f += 1 &lt;&lt; 5;
<a name="l10350"></a>10350         }
<a name="l10351"></a>10351       }
<a name="l10352"></a>10352       $opt[<span class="charliteral">&#39;f&#39;</span>] = $f;
<a name="l10353"></a>10353       <span class="comment">// currentValueIndices: Reads and writes single or multiple values of a list box or combo box.</span>
<a name="l10354"></a>10354       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;currentValueIndices&#39;</span>]) AND is_array($prop[<span class="stringliteral">&#39;currentValueIndices&#39;</span>])) {
<a name="l10355"></a>10355         $opt[<span class="charliteral">&#39;i&#39;</span>] = $prop[<span class="stringliteral">&#39;currentValueIndices&#39;</span>];
<a name="l10356"></a>10356       }
<a name="l10357"></a>10357       <span class="comment">// value: The value of the field data that the user has entered.</span>
<a name="l10358"></a>10358       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;value&#39;</span>])) {
<a name="l10359"></a>10359         <span class="keywordflow">if</span> (is_array($prop[<span class="stringliteral">&#39;value&#39;</span>])) {
<a name="l10360"></a>10360           $opt[<span class="stringliteral">&#39;opt&#39;</span>] = array();
<a name="l10361"></a>10361           <span class="keywordflow">foreach</span> ($prop[<span class="stringliteral">&#39;value&#39;</span>] AS $key =&gt; $optval) {
<a name="l10362"></a>10362             <span class="comment">// exportValues: An array of strings representing the export values for the field.</span>
<a name="l10363"></a>10363             <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;exportValues&#39;</span>][$key])) {
<a name="l10364"></a>10364               $opt[<span class="stringliteral">&#39;opt&#39;</span>][$key] = array($prop[<span class="stringliteral">&#39;exportValues&#39;</span>][$key], $prop[<span class="stringliteral">&#39;value&#39;</span>][$key]);
<a name="l10365"></a>10365             } <span class="keywordflow">else</span> {
<a name="l10366"></a>10366               $opt[<span class="stringliteral">&#39;opt&#39;</span>][$key] = $prop[<span class="stringliteral">&#39;value&#39;</span>][$key];
<a name="l10367"></a>10367             }
<a name="l10368"></a>10368           }
<a name="l10369"></a>10369         } <span class="keywordflow">else</span> {
<a name="l10370"></a>10370           $opt[<span class="charliteral">&#39;v&#39;</span>] = $prop[<span class="stringliteral">&#39;value&#39;</span>];
<a name="l10371"></a>10371         }
<a name="l10372"></a>10372       }
<a name="l10373"></a>10373       <span class="comment">// richValue: This property specifies the text contents and formatting of a rich text field.</span>
<a name="l10374"></a>10374       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;richValue&#39;</span>])) {
<a name="l10375"></a>10375         $opt[<span class="stringliteral">&#39;rv&#39;</span>] = $prop[<span class="stringliteral">&#39;richValue&#39;</span>];
<a name="l10376"></a>10376       }
<a name="l10377"></a>10377       <span class="comment">// submitName: If nonempty, used during form submission instead of name. Only applicable if submitting in HTML format (that is, URL-encoded).</span>
<a name="l10378"></a>10378       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;submitName&#39;</span>])) {
<a name="l10379"></a>10379         $opt[<span class="stringliteral">&#39;tm&#39;</span>] = $prop[<span class="stringliteral">&#39;submitName&#39;</span>];
<a name="l10380"></a>10380       }
<a name="l10381"></a>10381       <span class="comment">// name: Fully qualified field name.</span>
<a name="l10382"></a>10382       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;name&#39;</span>])) {
<a name="l10383"></a>10383         $opt[<span class="charliteral">&#39;t&#39;</span>] = $prop[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l10384"></a>10384       }
<a name="l10385"></a>10385       <span class="comment">// userName: The user name (short description string) of the field.</span>
<a name="l10386"></a>10386       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;userName&#39;</span>])) {
<a name="l10387"></a>10387         $opt[<span class="stringliteral">&#39;tu&#39;</span>] = $prop[<span class="stringliteral">&#39;userName&#39;</span>];
<a name="l10388"></a>10388       }
<a name="l10389"></a>10389       <span class="comment">// highlight: Defines how a button reacts when a user clicks it.</span>
<a name="l10390"></a>10390       <span class="keywordflow">if</span> (isset($prop[<span class="stringliteral">&#39;highlight&#39;</span>])) {
<a name="l10391"></a>10391         <span class="keywordflow">switch</span> ($prop[<span class="stringliteral">&#39;highlight&#39;</span>]) {
<a name="l10392"></a>10392           <span class="keywordflow">case</span> <span class="stringliteral">&#39;none&#39;</span>:
<a name="l10393"></a>10393           <span class="keywordflow">case</span> <span class="stringliteral">&#39;highlight.n&#39;</span>: {
<a name="l10394"></a>10394             $opt[<span class="charliteral">&#39;h&#39;</span>] = <span class="charliteral">&#39;N&#39;</span>;
<a name="l10395"></a>10395             <span class="keywordflow">break</span>;
<a name="l10396"></a>10396           }
<a name="l10397"></a>10397           <span class="keywordflow">case</span> <span class="stringliteral">&#39;invert&#39;</span>:
<a name="l10398"></a>10398           <span class="keywordflow">case</span> <span class="stringliteral">&#39;highlight.i&#39;</span>: {
<a name="l10399"></a>10399             $opt[<span class="charliteral">&#39;h&#39;</span>] = <span class="charliteral">&#39;i&#39;</span>;
<a name="l10400"></a>10400             <span class="keywordflow">break</span>;
<a name="l10401"></a>10401           }
<a name="l10402"></a>10402           <span class="keywordflow">case</span> <span class="stringliteral">&#39;push&#39;</span>:
<a name="l10403"></a>10403           <span class="keywordflow">case</span> <span class="stringliteral">&#39;highlight.p&#39;</span>: {
<a name="l10404"></a>10404             $opt[<span class="charliteral">&#39;h&#39;</span>] = <span class="charliteral">&#39;P&#39;</span>;
<a name="l10405"></a>10405             <span class="keywordflow">break</span>;
<a name="l10406"></a>10406           }
<a name="l10407"></a>10407           <span class="keywordflow">case</span> <span class="stringliteral">&#39;outline&#39;</span>:
<a name="l10408"></a>10408           <span class="keywordflow">case</span> <span class="stringliteral">&#39;highlight.o&#39;</span>: {
<a name="l10409"></a>10409             $opt[<span class="charliteral">&#39;h&#39;</span>] = <span class="charliteral">&#39;O&#39;</span>;
<a name="l10410"></a>10410             <span class="keywordflow">break</span>;
<a name="l10411"></a>10411           }
<a name="l10412"></a>10412         }       
<a name="l10413"></a>10413       }
<a name="l10414"></a>10414       <span class="comment">// Unsupported options:</span>
<a name="l10415"></a>10415       <span class="comment">// - calcOrderIndex: Changes the calculation order of fields in the document.</span>
<a name="l10416"></a>10416       <span class="comment">// - delay: Delays the redrawing of a field&#39;s appearance.</span>
<a name="l10417"></a>10417       <span class="comment">// - defaultStyle: This property defines the default style attributes for the form field.</span>
<a name="l10418"></a>10418       <span class="comment">// - style: Allows the user to set the glyph style of a check box or radio button.</span>
<a name="l10419"></a>10419       <span class="comment">// - textColor, textFont, textSize</span>
<a name="l10420"></a>10420       <span class="keywordflow">return</span> $opt;
<a name="l10421"></a>10421     }
<a name="l10422"></a>10422     
<a name="l10423"></a>10423     <span class="comment">/*</span>
<a name="l10424"></a>10424 <span class="comment">    * Set default properties for form fields.</span>
<a name="l10425"></a>10425 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10426"></a>10426 <span class="comment">    * @access public</span>
<a name="l10427"></a>10427 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10428"></a>10428 <span class="comment">    * @since 4.8.000 (2009-09-06)</span>
<a name="l10429"></a>10429 <span class="comment">    */</span>
<a name="l10430"></a>10430     <span class="keyword">public</span> function setFormDefaultProp($prop=array()) {
<a name="l10431"></a>10431       $this-&gt;default_form_prop = $prop;
<a name="l10432"></a>10432     }
<a name="l10433"></a>10433     
<a name="l10434"></a>10434     <span class="comment">/*</span>
<a name="l10435"></a>10435 <span class="comment">    * Return the default properties for form fields.</span>
<a name="l10436"></a>10436 <span class="comment">    * @return array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10437"></a>10437 <span class="comment">    * @access public</span>
<a name="l10438"></a>10438 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10439"></a>10439 <span class="comment">    * @since 4.8.000 (2009-09-06)</span>
<a name="l10440"></a>10440 <span class="comment">    */</span>
<a name="l10441"></a>10441     <span class="keyword">public</span> function getFormDefaultProp() {
<a name="l10442"></a>10442       <span class="keywordflow">return</span> $this-&gt;default_form_prop;
<a name="l10443"></a>10443     }
<a name="l10444"></a>10444     
<a name="l10445"></a>10445     <span class="comment">/*</span>
<a name="l10446"></a>10446 <span class="comment">    * Creates a text field</span>
<a name="l10447"></a>10447 <span class="comment">    * @param string $name field name</span>
<a name="l10448"></a>10448 <span class="comment">    * @param float $w Width of the rectangle</span>
<a name="l10449"></a>10449 <span class="comment">    * @param float $h Height of the rectangle</span>
<a name="l10450"></a>10450 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10451"></a>10451 <span class="comment">    * @param array $opt annotation parameters. Possible values are described on official PDF32000_2008 reference.</span>
<a name="l10452"></a>10452 <span class="comment">    * @param float $x Abscissa of the upper-left corner of the rectangle</span>
<a name="l10453"></a>10453 <span class="comment">    * @param float $y Ordinate of the upper-left corner of the rectangle</span>
<a name="l10454"></a>10454 <span class="comment">    * @param boolean $js if true put the field using JavaScript (requires Acrobat Writer to be rendered).</span>
<a name="l10455"></a>10455 <span class="comment">    * @access public</span>
<a name="l10456"></a>10456 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10457"></a>10457 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l10458"></a>10458 <span class="comment">    */</span>
<a name="l10459"></a>10459     <span class="keyword">public</span> function TextField($name, $w, $h, $prop=array(), $opt=array(), $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $js=<span class="keyword">false</span>) {
<a name="l10460"></a>10460       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10461"></a>10461         $x = $this-&gt;x;
<a name="l10462"></a>10462       }
<a name="l10463"></a>10463       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10464"></a>10464         $y = $this-&gt;y;
<a name="l10465"></a>10465       }
<a name="l10466"></a>10466       <span class="keywordflow">if</span> ($js) {
<a name="l10467"></a>10467         $this-&gt;_addfield(<span class="stringliteral">&#39;text&#39;</span>, $name, $x, $y, $w, $h, $prop);
<a name="l10468"></a>10468         <span class="keywordflow">return</span>;
<a name="l10469"></a>10469       }
<a name="l10470"></a>10470       <span class="comment">// get default style</span>
<a name="l10471"></a>10471       $prop = array_merge($this-&gt;getFormDefaultProp(), $prop);
<a name="l10472"></a>10472       <span class="comment">// get annotation data</span>
<a name="l10473"></a>10473       $popt = $this-&gt;getAnnotOptFromJSProp($prop);
<a name="l10474"></a>10474       <span class="comment">// set default appearance stream</span>
<a name="l10475"></a>10475       $font = $this-&gt;FontFamily;
<a name="l10476"></a>10476       $fontkey = array_search($font, $this-&gt;fontkeys);
<a name="l10477"></a>10477       <span class="keywordflow">if</span> (!in_array($fontkey, $this-&gt;annotation_fonts)) {
<a name="l10478"></a>10478         $this-&gt;annotation_fonts[$font] = $fontkey;
<a name="l10479"></a>10479       }
<a name="l10480"></a>10480       $fontstyle = sprintf(<span class="stringliteral">&#39;/F%d %.2F Tf %s&#39;</span>, ($fontkey + 1), $this-&gt;FontSizePt, $this-&gt;TextColor);
<a name="l10481"></a>10481       $popt[<span class="stringliteral">&#39;da&#39;</span>] = $fontstyle;
<a name="l10482"></a>10482       $popt[<span class="stringliteral">&#39;ap&#39;</span>] = array();
<a name="l10483"></a>10483       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; ET Q&#39;</span>;
<a name="l10484"></a>10484       <span class="comment">// merge options</span>
<a name="l10485"></a>10485       $opt = array_merge($popt, $opt);
<a name="l10486"></a>10486       <span class="comment">// remove some conflicting options</span>
<a name="l10487"></a>10487       unset($opt[<span class="stringliteral">&#39;bs&#39;</span>]);
<a name="l10488"></a>10488       <span class="comment">// set remaining annotation data</span>
<a name="l10489"></a>10489       $opt[<span class="stringliteral">&#39;Subtype&#39;</span>] = <span class="stringliteral">&#39;Widget&#39;</span>;
<a name="l10490"></a>10490       $opt[<span class="stringliteral">&#39;ft&#39;</span>] = <span class="stringliteral">&#39;Tx&#39;</span>;
<a name="l10491"></a>10491       $opt[<span class="charliteral">&#39;t&#39;</span>] = $name;
<a name="l10492"></a>10492       <span class="comment">/*</span>
<a name="l10493"></a>10493 <span class="comment">      Additional annotation&#39;s parameters (check _putannotsobj() method):</span>
<a name="l10494"></a>10494 <span class="comment">      //$opt[&#39;f&#39;]</span>
<a name="l10495"></a>10495 <span class="comment">      //$opt[&#39;ap&#39;]</span>
<a name="l10496"></a>10496 <span class="comment">      //$opt[&#39;as&#39;]</span>
<a name="l10497"></a>10497 <span class="comment">      //$opt[&#39;bs&#39;]</span>
<a name="l10498"></a>10498 <span class="comment">      //$opt[&#39;be&#39;]</span>
<a name="l10499"></a>10499 <span class="comment">      //$opt[&#39;c&#39;]</span>
<a name="l10500"></a>10500 <span class="comment">      //$opt[&#39;border&#39;]</span>
<a name="l10501"></a>10501 <span class="comment">      //$opt[&#39;h&#39;]</span>
<a name="l10502"></a>10502 <span class="comment">      //$opt[&#39;mk&#39;]</span>
<a name="l10503"></a>10503 <span class="comment">      //$opt[&#39;mk&#39;][&#39;r&#39;]</span>
<a name="l10504"></a>10504 <span class="comment">      //$opt[&#39;mk&#39;][&#39;bc&#39;]</span>
<a name="l10505"></a>10505 <span class="comment">      //$opt[&#39;mk&#39;][&#39;bg&#39;]</span>
<a name="l10506"></a>10506 <span class="comment">      //$opt[&#39;mk&#39;][&#39;ca&#39;]</span>
<a name="l10507"></a>10507 <span class="comment">      //$opt[&#39;mk&#39;][&#39;rc&#39;]</span>
<a name="l10508"></a>10508 <span class="comment">      //$opt[&#39;mk&#39;][&#39;ac&#39;]</span>
<a name="l10509"></a>10509 <span class="comment">      //$opt[&#39;mk&#39;][&#39;i&#39;]</span>
<a name="l10510"></a>10510 <span class="comment">      //$opt[&#39;mk&#39;][&#39;ri&#39;]</span>
<a name="l10511"></a>10511 <span class="comment">      //$opt[&#39;mk&#39;][&#39;ix&#39;]</span>
<a name="l10512"></a>10512 <span class="comment">      //$opt[&#39;mk&#39;][&#39;if&#39;]</span>
<a name="l10513"></a>10513 <span class="comment">      //$opt[&#39;mk&#39;][&#39;if&#39;][&#39;sw&#39;]</span>
<a name="l10514"></a>10514 <span class="comment">      //$opt[&#39;mk&#39;][&#39;if&#39;][&#39;s&#39;]</span>
<a name="l10515"></a>10515 <span class="comment">      //$opt[&#39;mk&#39;][&#39;if&#39;][&#39;a&#39;]</span>
<a name="l10516"></a>10516 <span class="comment">      //$opt[&#39;mk&#39;][&#39;if&#39;][&#39;fb&#39;]</span>
<a name="l10517"></a>10517 <span class="comment">      //$opt[&#39;mk&#39;][&#39;tp&#39;]</span>
<a name="l10518"></a>10518 <span class="comment">      //$opt[&#39;tu&#39;]</span>
<a name="l10519"></a>10519 <span class="comment">      //$opt[&#39;tm&#39;]</span>
<a name="l10520"></a>10520 <span class="comment">      //$opt[&#39;ff&#39;]</span>
<a name="l10521"></a>10521 <span class="comment">      //$opt[&#39;v&#39;]</span>
<a name="l10522"></a>10522 <span class="comment">      //$opt[&#39;dv&#39;]</span>
<a name="l10523"></a>10523 <span class="comment">      //$opt[&#39;a&#39;]</span>
<a name="l10524"></a>10524 <span class="comment">      //$opt[&#39;aa&#39;]</span>
<a name="l10525"></a>10525 <span class="comment">      //$opt[&#39;q&#39;]</span>
<a name="l10526"></a>10526 <span class="comment">      */</span>
<a name="l10527"></a>10527       $this-&gt;Annotation($x, $y, $w, $h, $name, $opt, 0);
<a name="l10528"></a>10528       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10529"></a>10529         $this-&gt;x -= $w;
<a name="l10530"></a>10530       } <span class="keywordflow">else</span> {
<a name="l10531"></a>10531         $this-&gt;x += $w;
<a name="l10532"></a>10532       }
<a name="l10533"></a>10533     }
<a name="l10534"></a>10534 
<a name="l10535"></a>10535     <span class="comment">/*</span>
<a name="l10536"></a>10536 <span class="comment">    * Creates a RadioButton field</span>
<a name="l10537"></a>10537 <span class="comment">    * @param string $name field name</span>
<a name="l10538"></a>10538 <span class="comment">    * @param int $w width</span>
<a name="l10539"></a>10539 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10540"></a>10540 <span class="comment">    * @param array $opt annotation parameters. Possible values are described on official PDF32000_2008 reference.</span>
<a name="l10541"></a>10541 <span class="comment">    * @param string $onvalue value to be returned if selected.</span>
<a name="l10542"></a>10542 <span class="comment">    * @param boolean $checked define the initial state.</span>
<a name="l10543"></a>10543 <span class="comment">    * @param float $x Abscissa of the upper-left corner of the rectangle</span>
<a name="l10544"></a>10544 <span class="comment">    * @param float $y Ordinate of the upper-left corner of the rectangle</span>
<a name="l10545"></a>10545 <span class="comment">    * @param boolean $js if true put the field using JavaScript (requires Acrobat Writer to be rendered).</span>
<a name="l10546"></a>10546 <span class="comment">    * @access public</span>
<a name="l10547"></a>10547 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10548"></a>10548 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l10549"></a>10549 <span class="comment">    */</span>
<a name="l10550"></a>10550     <span class="keyword">public</span> function RadioButton($name, $w, $prop=array(), $opt=array(), $onvalue=<span class="stringliteral">&#39;On&#39;</span>, $checked=<span class="keyword">false</span>, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $js=<span class="keyword">false</span>) {
<a name="l10551"></a>10551       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10552"></a>10552         $x = $this-&gt;x;
<a name="l10553"></a>10553       }
<a name="l10554"></a>10554       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10555"></a>10555         $y = $this-&gt;y;
<a name="l10556"></a>10556       }
<a name="l10557"></a>10557       <span class="keywordflow">if</span> ($js) {
<a name="l10558"></a>10558         $this-&gt;_addfield(<span class="stringliteral">&#39;radiobutton&#39;</span>, $name, $x, $y, $w, $w, $prop);
<a name="l10559"></a>10559         <span class="keywordflow">return</span>;
<a name="l10560"></a>10560       }
<a name="l10561"></a>10561       <span class="keywordflow">if</span> ($this-&gt;empty_string($onvalue)) {
<a name="l10562"></a>10562         $onvalue = <span class="stringliteral">&#39;On&#39;</span>;
<a name="l10563"></a>10563       }
<a name="l10564"></a>10564       <span class="keywordflow">if</span> ($checked) {
<a name="l10565"></a>10565         $defval = $onvalue;
<a name="l10566"></a>10566       } <span class="keywordflow">else</span> {
<a name="l10567"></a>10567         $defval = <span class="stringliteral">&#39;Off&#39;</span>;
<a name="l10568"></a>10568       }
<a name="l10569"></a>10569       <span class="comment">// set data for parent group</span>
<a name="l10570"></a>10570       <span class="keywordflow">if</span> (!isset($this-&gt;radiobutton_groups[$this-&gt;page])) {
<a name="l10571"></a>10571         $this-&gt;radiobutton_groups[$this-&gt;page] = array();
<a name="l10572"></a>10572       }
<a name="l10573"></a>10573       <span class="keywordflow">if</span> (!isset($this-&gt;radiobutton_groups[$this-&gt;page][$name])) {
<a name="l10574"></a>10574         $this-&gt;radiobutton_groups[$this-&gt;page][$name] = array();
<a name="l10575"></a>10575         ++$this-&gt;annot_obj_id;
<a name="l10576"></a>10576         $this-&gt;radio_groups[] = $this-&gt;annot_obj_id;
<a name="l10577"></a>10577       }
<a name="l10578"></a>10578       <span class="comment">// save object ID to be added on Kids entry on parent object</span>
<a name="l10579"></a>10579       $this-&gt;radiobutton_groups[$this-&gt;page][$name][] = array(<span class="stringliteral">&#39;kid&#39;</span> =&gt; ($this-&gt;annot_obj_id + 1), <span class="stringliteral">&#39;def&#39;</span> =&gt; $defval);
<a name="l10580"></a>10580       <span class="comment">// get default style</span>
<a name="l10581"></a>10581       $prop = array_merge($this-&gt;getFormDefaultProp(), $prop);
<a name="l10582"></a>10582       $prop[<span class="stringliteral">&#39;NoToggleToOff&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l10583"></a>10583       $prop[<span class="stringliteral">&#39;Radio&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l10584"></a>10584       $prop[<span class="stringliteral">&#39;borderStyle&#39;</span>] = <span class="stringliteral">&#39;inset&#39;</span>;
<a name="l10585"></a>10585       <span class="comment">// get annotation data</span>
<a name="l10586"></a>10586       $popt = $this-&gt;getAnnotOptFromJSProp($prop);
<a name="l10587"></a>10587       <span class="comment">// set additional default values</span>
<a name="l10588"></a>10588       $font = <span class="stringliteral">&#39;zapfdingbats&#39;</span>;
<a name="l10589"></a>10589       $this-&gt;AddFont($font);
<a name="l10590"></a>10590       $fontkey = array_search($font, $this-&gt;fontkeys);
<a name="l10591"></a>10591       <span class="keywordflow">if</span> (!in_array($fontkey, $this-&gt;annotation_fonts)) {
<a name="l10592"></a>10592         $this-&gt;annotation_fonts[$font] = $fontkey;
<a name="l10593"></a>10593       }
<a name="l10594"></a>10594       $fontstyle = sprintf(<span class="stringliteral">&#39;/F%d %.2F Tf %s&#39;</span>, ($fontkey + 1), $this-&gt;FontSizePt, $this-&gt;TextColor);
<a name="l10595"></a>10595       $popt[<span class="stringliteral">&#39;da&#39;</span>] = $fontstyle;
<a name="l10596"></a>10596       $popt[<span class="stringliteral">&#39;ap&#39;</span>] = array();
<a name="l10597"></a>10597       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>] = array();
<a name="l10598"></a>10598       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>][$onvalue] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; 0 0 Td (8) Tj ET Q&#39;</span>;
<a name="l10599"></a>10599       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>][<span class="stringliteral">&#39;Off&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; 0 0 Td (8) Tj ET Q&#39;</span>;
<a name="l10600"></a>10600       <span class="keywordflow">if</span> (!isset($popt[<span class="stringliteral">&#39;mk&#39;</span>])) {
<a name="l10601"></a>10601         $popt[<span class="stringliteral">&#39;mk&#39;</span>] = array();
<a name="l10602"></a>10602       }
<a name="l10603"></a>10603       $popt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>] = <span class="stringliteral">&#39;(l)&#39;</span>;
<a name="l10604"></a>10604       <span class="comment">// merge options</span>
<a name="l10605"></a>10605       $opt = array_merge($popt, $opt);
<a name="l10606"></a>10606       <span class="comment">// set remaining annotation data</span>
<a name="l10607"></a>10607       $opt[<span class="stringliteral">&#39;Subtype&#39;</span>] = <span class="stringliteral">&#39;Widget&#39;</span>;
<a name="l10608"></a>10608       $opt[<span class="stringliteral">&#39;ft&#39;</span>] = <span class="stringliteral">&#39;Btn&#39;</span>;
<a name="l10609"></a>10609       <span class="keywordflow">if</span> ($checked) {
<a name="l10610"></a>10610         $opt[<span class="charliteral">&#39;v&#39;</span>] = array(<span class="charliteral">&#39;/&#39;</span>.$onvalue);
<a name="l10611"></a>10611         $opt[<span class="stringliteral">&#39;as&#39;</span>] = $onvalue;
<a name="l10612"></a>10612       } <span class="keywordflow">else</span> {
<a name="l10613"></a>10613         $opt[<span class="stringliteral">&#39;as&#39;</span>] = <span class="stringliteral">&#39;Off&#39;</span>;
<a name="l10614"></a>10614       }
<a name="l10615"></a>10615       $this-&gt;Annotation($x, $y, $w, $w, $name, $opt, 0);
<a name="l10616"></a>10616       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10617"></a>10617         $this-&gt;x -= $w;
<a name="l10618"></a>10618       } <span class="keywordflow">else</span> {
<a name="l10619"></a>10619         $this-&gt;x += $w;
<a name="l10620"></a>10620       }
<a name="l10621"></a>10621     }
<a name="l10622"></a>10622     
<a name="l10623"></a>10623     <span class="comment">/*</span>
<a name="l10624"></a>10624 <span class="comment">    * Creates a List-box field</span>
<a name="l10625"></a>10625 <span class="comment">    * @param string $name field name</span>
<a name="l10626"></a>10626 <span class="comment">    * @param int $w width</span>
<a name="l10627"></a>10627 <span class="comment">    * @param int $h height</span>
<a name="l10628"></a>10628 <span class="comment">    * @param array $values array containing the list of values.</span>
<a name="l10629"></a>10629 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10630"></a>10630 <span class="comment">    * @param array $opt annotation parameters. Possible values are described on official PDF32000_2008 reference.</span>
<a name="l10631"></a>10631 <span class="comment">    * @param float $x Abscissa of the upper-left corner of the rectangle</span>
<a name="l10632"></a>10632 <span class="comment">    * @param float $y Ordinate of the upper-left corner of the rectangle</span>
<a name="l10633"></a>10633 <span class="comment">    * @param boolean $js if true put the field using JavaScript (requires Acrobat Writer to be rendered).</span>
<a name="l10634"></a>10634 <span class="comment">    * @access public</span>
<a name="l10635"></a>10635 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10636"></a>10636 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l10637"></a>10637 <span class="comment">    */</span>
<a name="l10638"></a>10638     <span class="keyword">public</span> function ListBox($name, $w, $h, $values, $prop=array(), $opt=array(), $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $js=<span class="keyword">false</span>) {
<a name="l10639"></a>10639       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10640"></a>10640         $x = $this-&gt;x;
<a name="l10641"></a>10641       }
<a name="l10642"></a>10642       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10643"></a>10643         $y = $this-&gt;y;
<a name="l10644"></a>10644       }
<a name="l10645"></a>10645       <span class="keywordflow">if</span> ($js) {
<a name="l10646"></a>10646         $this-&gt;_addfield(<span class="stringliteral">&#39;listbox&#39;</span>, $name, $x, $y, $w, $h, $prop);
<a name="l10647"></a>10647         $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l10648"></a>10648         <span class="keywordflow">foreach</span> ($values as $value) {
<a name="l10649"></a>10649           $s .= <span class="stringliteral">&quot;&#39;&quot;</span>.addslashes($value).<span class="stringliteral">&quot;&#39;,&quot;</span>;
<a name="l10650"></a>10650         }
<a name="l10651"></a>10651         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&#39;.setItems([&#39;</span>.substr($s, 0, -1).<span class="stringliteral">&quot;]);\n&quot;</span>;
<a name="l10652"></a>10652         <span class="keywordflow">return</span>;
<a name="l10653"></a>10653       }
<a name="l10654"></a>10654       <span class="comment">// get default style</span>
<a name="l10655"></a>10655       $prop = array_merge($this-&gt;getFormDefaultProp(), $prop);
<a name="l10656"></a>10656       <span class="comment">// get annotation data</span>
<a name="l10657"></a>10657       $popt = $this-&gt;getAnnotOptFromJSProp($prop);
<a name="l10658"></a>10658       <span class="comment">// set additional default values</span>
<a name="l10659"></a>10659       $font = $this-&gt;FontFamily;
<a name="l10660"></a>10660       $fontkey = array_search($font, $this-&gt;fontkeys);
<a name="l10661"></a>10661       <span class="keywordflow">if</span> (!in_array($fontkey, $this-&gt;annotation_fonts)) {
<a name="l10662"></a>10662         $this-&gt;annotation_fonts[$font] = $fontkey;
<a name="l10663"></a>10663       }
<a name="l10664"></a>10664       $fontstyle = sprintf(<span class="stringliteral">&#39;/F%d %.2F Tf %s&#39;</span>, ($fontkey + 1), $this-&gt;FontSizePt, $this-&gt;TextColor);
<a name="l10665"></a>10665       $popt[<span class="stringliteral">&#39;da&#39;</span>] = $fontstyle;
<a name="l10666"></a>10666       $popt[<span class="stringliteral">&#39;ap&#39;</span>] = array();
<a name="l10667"></a>10667       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; ET Q&#39;</span>;
<a name="l10668"></a>10668       <span class="comment">// merge options</span>
<a name="l10669"></a>10669       $opt = array_merge($popt, $opt);
<a name="l10670"></a>10670       <span class="comment">// set remaining annotation data</span>
<a name="l10671"></a>10671       $opt[<span class="stringliteral">&#39;Subtype&#39;</span>] = <span class="stringliteral">&#39;Widget&#39;</span>;
<a name="l10672"></a>10672       $opt[<span class="stringliteral">&#39;ft&#39;</span>] = <span class="stringliteral">&#39;Ch&#39;</span>;
<a name="l10673"></a>10673       $opt[<span class="charliteral">&#39;t&#39;</span>] = $name;
<a name="l10674"></a>10674       $opt[<span class="stringliteral">&#39;opt&#39;</span>] = $values;
<a name="l10675"></a>10675       $this-&gt;Annotation($x, $y, $w, $h, $name, $opt, 0);
<a name="l10676"></a>10676       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10677"></a>10677         $this-&gt;x -= $w;
<a name="l10678"></a>10678       } <span class="keywordflow">else</span> {
<a name="l10679"></a>10679         $this-&gt;x += $w;
<a name="l10680"></a>10680       }
<a name="l10681"></a>10681     }
<a name="l10682"></a>10682     
<a name="l10683"></a>10683     <span class="comment">/*</span>
<a name="l10684"></a>10684 <span class="comment">    * Creates a Combo-box field</span>
<a name="l10685"></a>10685 <span class="comment">    * @param string $name field name</span>
<a name="l10686"></a>10686 <span class="comment">    * @param int $w width</span>
<a name="l10687"></a>10687 <span class="comment">    * @param int $h height</span>
<a name="l10688"></a>10688 <span class="comment">    * @param array $values array containing the list of values.</span>
<a name="l10689"></a>10689 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10690"></a>10690 <span class="comment">    * @param array $opt annotation parameters. Possible values are described on official PDF32000_2008 reference.</span>
<a name="l10691"></a>10691 <span class="comment">    * @param float $x Abscissa of the upper-left corner of the rectangle</span>
<a name="l10692"></a>10692 <span class="comment">    * @param float $y Ordinate of the upper-left corner of the rectangle</span>
<a name="l10693"></a>10693 <span class="comment">    * @param boolean $js if true put the field using JavaScript (requires Acrobat Writer to be rendered).</span>
<a name="l10694"></a>10694 <span class="comment">    * @access public</span>
<a name="l10695"></a>10695 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10696"></a>10696 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l10697"></a>10697 <span class="comment">    */</span>
<a name="l10698"></a>10698     <span class="keyword">public</span> function ComboBox($name, $w, $h, $values, $prop=array(), $opt=array(), $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $js=<span class="keyword">false</span>) {
<a name="l10699"></a>10699       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10700"></a>10700         $x = $this-&gt;x;
<a name="l10701"></a>10701       }
<a name="l10702"></a>10702       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10703"></a>10703         $y = $this-&gt;y;
<a name="l10704"></a>10704       }
<a name="l10705"></a>10705       <span class="keywordflow">if</span> ($js) {
<a name="l10706"></a>10706         $this-&gt;_addfield(<span class="stringliteral">&#39;combobox&#39;</span>, $name, $x, $y, $w, $h, $prop);
<a name="l10707"></a>10707         $s = <span class="stringliteral">&#39;&#39;</span>;
<a name="l10708"></a>10708         <span class="keywordflow">foreach</span> ($values as $value) {
<a name="l10709"></a>10709           $s .= <span class="stringliteral">&quot;&#39;&quot;</span>.addslashes($value).<span class="stringliteral">&quot;&#39;,&quot;</span>;
<a name="l10710"></a>10710         }
<a name="l10711"></a>10711         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&#39;.setItems([&#39;</span>.substr($s, 0, -1).<span class="stringliteral">&quot;]);\n&quot;</span>;
<a name="l10712"></a>10712         <span class="keywordflow">return</span>;
<a name="l10713"></a>10713       }
<a name="l10714"></a>10714       <span class="comment">// get default style</span>
<a name="l10715"></a>10715       $prop = array_merge($this-&gt;getFormDefaultProp(), $prop);
<a name="l10716"></a>10716       $prop[<span class="stringliteral">&#39;Combo&#39;</span>] = <span class="keyword">true</span>;
<a name="l10717"></a>10717       <span class="comment">// get annotation data</span>
<a name="l10718"></a>10718       $popt = $this-&gt;getAnnotOptFromJSProp($prop);
<a name="l10719"></a>10719       <span class="comment">// set additional default options</span>
<a name="l10720"></a>10720       $font = $this-&gt;FontFamily;
<a name="l10721"></a>10721       $fontkey = array_search($font, $this-&gt;fontkeys);
<a name="l10722"></a>10722       <span class="keywordflow">if</span> (!in_array($fontkey, $this-&gt;annotation_fonts)) {
<a name="l10723"></a>10723         $this-&gt;annotation_fonts[$font] = $fontkey;
<a name="l10724"></a>10724       }
<a name="l10725"></a>10725       $fontstyle = sprintf(<span class="stringliteral">&#39;/F%d %.2F Tf %s&#39;</span>, ($fontkey + 1), $this-&gt;FontSizePt, $this-&gt;TextColor);
<a name="l10726"></a>10726       $popt[<span class="stringliteral">&#39;da&#39;</span>] = $fontstyle;
<a name="l10727"></a>10727       $popt[<span class="stringliteral">&#39;ap&#39;</span>] = array();
<a name="l10728"></a>10728       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; ET Q&#39;</span>;
<a name="l10729"></a>10729       <span class="comment">// merge options</span>
<a name="l10730"></a>10730       $opt = array_merge($popt, $opt);
<a name="l10731"></a>10731       <span class="comment">// set remaining annotation data</span>
<a name="l10732"></a>10732       $opt[<span class="stringliteral">&#39;Subtype&#39;</span>] = <span class="stringliteral">&#39;Widget&#39;</span>;
<a name="l10733"></a>10733       $opt[<span class="stringliteral">&#39;ft&#39;</span>] = <span class="stringliteral">&#39;Ch&#39;</span>;
<a name="l10734"></a>10734       $opt[<span class="charliteral">&#39;t&#39;</span>] = $name;
<a name="l10735"></a>10735       $opt[<span class="stringliteral">&#39;opt&#39;</span>] = $values;
<a name="l10736"></a>10736       $this-&gt;Annotation($x, $y, $w, $h, $name, $opt, 0);
<a name="l10737"></a>10737       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10738"></a>10738         $this-&gt;x -= $w;
<a name="l10739"></a>10739       } <span class="keywordflow">else</span> {
<a name="l10740"></a>10740         $this-&gt;x += $w;
<a name="l10741"></a>10741       }
<a name="l10742"></a>10742     }
<a name="l10743"></a>10743     
<a name="l10744"></a>10744     <span class="comment">/*</span>
<a name="l10745"></a>10745 <span class="comment">    * Creates a CheckBox field</span>
<a name="l10746"></a>10746 <span class="comment">    * @param string $name field name</span>
<a name="l10747"></a>10747 <span class="comment">    * @param int $w width</span>
<a name="l10748"></a>10748 <span class="comment">    * @param boolean $checked define the initial state.</span>
<a name="l10749"></a>10749 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10750"></a>10750 <span class="comment">    * @param array $opt annotation parameters. Possible values are described on official PDF32000_2008 reference.</span>
<a name="l10751"></a>10751 <span class="comment">    * @param string $onvalue value to be returned if selected.</span>
<a name="l10752"></a>10752 <span class="comment">    * @param float $x Abscissa of the upper-left corner of the rectangle</span>
<a name="l10753"></a>10753 <span class="comment">    * @param float $y Ordinate of the upper-left corner of the rectangle</span>
<a name="l10754"></a>10754 <span class="comment">    * @param boolean $js if true put the field using JavaScript (requires Acrobat Writer to be rendered).</span>
<a name="l10755"></a>10755 <span class="comment">    * @access public</span>
<a name="l10756"></a>10756 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10757"></a>10757 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l10758"></a>10758 <span class="comment">    */</span>
<a name="l10759"></a>10759     <span class="keyword">public</span> function CheckBox($name, $w, $checked=<span class="keyword">false</span>, $prop=array(), $opt=array(), $onvalue=<span class="stringliteral">&#39;Yes&#39;</span>, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $js=<span class="keyword">false</span>) {
<a name="l10760"></a>10760       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10761"></a>10761         $x = $this-&gt;x;
<a name="l10762"></a>10762       }
<a name="l10763"></a>10763       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10764"></a>10764         $y = $this-&gt;y;
<a name="l10765"></a>10765       }
<a name="l10766"></a>10766       <span class="keywordflow">if</span> ($js) {
<a name="l10767"></a>10767         $this-&gt;_addfield(<span class="stringliteral">&#39;checkbox&#39;</span>, $name, $x, $y, $w, $w, $prop);
<a name="l10768"></a>10768         <span class="keywordflow">return</span>;
<a name="l10769"></a>10769       }
<a name="l10770"></a>10770       <span class="keywordflow">if</span> (!isset($prop[<span class="stringliteral">&#39;value&#39;</span>])) {
<a name="l10771"></a>10771         $prop[<span class="stringliteral">&#39;value&#39;</span>] = array(<span class="stringliteral">&#39;Yes&#39;</span>);
<a name="l10772"></a>10772       }
<a name="l10773"></a>10773       <span class="comment">// get default style</span>
<a name="l10774"></a>10774       $prop = array_merge($this-&gt;getFormDefaultProp(), $prop);
<a name="l10775"></a>10775       $prop[<span class="stringliteral">&#39;borderStyle&#39;</span>] = <span class="stringliteral">&#39;inset&#39;</span>;
<a name="l10776"></a>10776       <span class="comment">// get annotation data</span>
<a name="l10777"></a>10777       $popt = $this-&gt;getAnnotOptFromJSProp($prop);
<a name="l10778"></a>10778       <span class="comment">// set additional default options</span>
<a name="l10779"></a>10779       $font = <span class="stringliteral">&#39;zapfdingbats&#39;</span>;
<a name="l10780"></a>10780       $this-&gt;AddFont($font);
<a name="l10781"></a>10781       $fontkey = array_search($font, $this-&gt;fontkeys);
<a name="l10782"></a>10782       <span class="keywordflow">if</span> (!in_array($fontkey, $this-&gt;annotation_fonts)) {
<a name="l10783"></a>10783         $this-&gt;annotation_fonts[$font] = $fontkey;
<a name="l10784"></a>10784       }
<a name="l10785"></a>10785       $fontstyle = sprintf(<span class="stringliteral">&#39;/F%d %.2F Tf %s&#39;</span>, ($fontkey + 1), $this-&gt;FontSizePt, $this-&gt;TextColor);
<a name="l10786"></a>10786       $popt[<span class="stringliteral">&#39;da&#39;</span>] = $fontstyle;
<a name="l10787"></a>10787       $popt[<span class="stringliteral">&#39;ap&#39;</span>] = array();
<a name="l10788"></a>10788       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>] = array();
<a name="l10789"></a>10789       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>][<span class="stringliteral">&#39;Yes&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; 0 0 Td (8) Tj ET Q&#39;</span>;
<a name="l10790"></a>10790       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>][<span class="stringliteral">&#39;Off&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; 0 0 Td (8) Tj ET Q&#39;</span>;
<a name="l10791"></a>10791       <span class="comment">// merge options</span>
<a name="l10792"></a>10792       $opt = array_merge($popt, $opt);
<a name="l10793"></a>10793       <span class="comment">// set remaining annotation data</span>
<a name="l10794"></a>10794       $opt[<span class="stringliteral">&#39;Subtype&#39;</span>] = <span class="stringliteral">&#39;Widget&#39;</span>;
<a name="l10795"></a>10795       $opt[<span class="stringliteral">&#39;ft&#39;</span>] = <span class="stringliteral">&#39;Btn&#39;</span>;
<a name="l10796"></a>10796       $opt[<span class="charliteral">&#39;t&#39;</span>] = $name;
<a name="l10797"></a>10797       $opt[<span class="stringliteral">&#39;opt&#39;</span>] = array($onvalue);
<a name="l10798"></a>10798       <span class="keywordflow">if</span> ($checked) {
<a name="l10799"></a>10799         $opt[<span class="charliteral">&#39;v&#39;</span>] = array(<span class="stringliteral">&#39;/0&#39;</span>);
<a name="l10800"></a>10800         $opt[<span class="stringliteral">&#39;as&#39;</span>] = <span class="stringliteral">&#39;Yes&#39;</span>;
<a name="l10801"></a>10801       } <span class="keywordflow">else</span> {
<a name="l10802"></a>10802         $opt[<span class="charliteral">&#39;v&#39;</span>] = array(<span class="stringliteral">&#39;/Off&#39;</span>);
<a name="l10803"></a>10803         $opt[<span class="stringliteral">&#39;as&#39;</span>] = <span class="stringliteral">&#39;Off&#39;</span>;
<a name="l10804"></a>10804       }
<a name="l10805"></a>10805       $this-&gt;Annotation($x, $y, $w, $w, $name, $opt, 0);
<a name="l10806"></a>10806       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10807"></a>10807         $this-&gt;x -= $w;
<a name="l10808"></a>10808       } <span class="keywordflow">else</span> {
<a name="l10809"></a>10809         $this-&gt;x += $w;
<a name="l10810"></a>10810       }
<a name="l10811"></a>10811     }
<a name="l10812"></a>10812     
<a name="l10813"></a>10813     <span class="comment">/*</span>
<a name="l10814"></a>10814 <span class="comment">    * Creates a button field</span>
<a name="l10815"></a>10815 <span class="comment">    * @param string $name field name</span>
<a name="l10816"></a>10816 <span class="comment">    * @param int $w width</span>
<a name="l10817"></a>10817 <span class="comment">    * @param int $h height</span>
<a name="l10818"></a>10818 <span class="comment">    * @param string $caption caption.</span>
<a name="l10819"></a>10819 <span class="comment">    * @param mixed $action action triggered by pressing the button. Use a string to specify a javascript action. Use an array to specify a form action options as on section 12.7.5 of PDF32000_2008.</span>
<a name="l10820"></a>10820 <span class="comment">    * @param array $prop javascript field properties. Possible values are described on official Javascript for Acrobat API reference.</span>
<a name="l10821"></a>10821 <span class="comment">    * @param array $opt annotation parameters. Possible values are described on official PDF32000_2008 reference.</span>
<a name="l10822"></a>10822 <span class="comment">    * @param float $x Abscissa of the upper-left corner of the rectangle</span>
<a name="l10823"></a>10823 <span class="comment">    * @param float $y Ordinate of the upper-left corner of the rectangle</span>
<a name="l10824"></a>10824 <span class="comment">    * @param boolean $js if true put the field using JavaScript (requires Acrobat Writer to be rendered).</span>
<a name="l10825"></a>10825 <span class="comment">    * @access public</span>
<a name="l10826"></a>10826 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10827"></a>10827 <span class="comment">    * @since 4.8.000 (2009-09-07)</span>
<a name="l10828"></a>10828 <span class="comment">    */</span>
<a name="l10829"></a>10829     <span class="keyword">public</span> function Button($name, $w, $h, $caption, $action, $prop=array(), $opt=array(), $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $js=<span class="keyword">false</span>) {
<a name="l10830"></a>10830       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10831"></a>10831         $x = $this-&gt;x;
<a name="l10832"></a>10832       }
<a name="l10833"></a>10833       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l10834"></a>10834         $y = $this-&gt;y;
<a name="l10835"></a>10835       }
<a name="l10836"></a>10836       <span class="keywordflow">if</span> ($js) {
<a name="l10837"></a>10837         $this-&gt;_addfield(<span class="stringliteral">&#39;button&#39;</span>, $name, $this-&gt;x, $this-&gt;y, $w, $h, $prop);
<a name="l10838"></a>10838         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&quot;.buttonSetCaption(&#39;&quot;</span>.addslashes($caption).<span class="stringliteral">&quot;&#39;);\n&quot;</span>;
<a name="l10839"></a>10839         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&quot;.setAction(&#39;MouseUp&#39;,&#39;&quot;</span>.addslashes($action).<span class="stringliteral">&quot;&#39;);\n&quot;</span>;
<a name="l10840"></a>10840         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&quot;.highlight=&#39;push&#39;;\n&quot;</span>;
<a name="l10841"></a>10841         $this-&gt;javascript .= <span class="charliteral">&#39;f&#39;</span>.$name.<span class="stringliteral">&quot;.print=false;\n&quot;</span>;
<a name="l10842"></a>10842         <span class="keywordflow">return</span>;
<a name="l10843"></a>10843       }
<a name="l10844"></a>10844       <span class="comment">// get default style</span>
<a name="l10845"></a>10845       $prop = array_merge($this-&gt;getFormDefaultProp(), $prop);
<a name="l10846"></a>10846       $prop[<span class="stringliteral">&#39;Pushbutton&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l10847"></a>10847       $prop[<span class="stringliteral">&#39;highlight&#39;</span>] = <span class="stringliteral">&#39;push&#39;</span>;
<a name="l10848"></a>10848       $prop[<span class="stringliteral">&#39;display&#39;</span>] = <span class="stringliteral">&#39;display.noPrint&#39;</span>;
<a name="l10849"></a>10849       <span class="comment">// get annotation data</span>
<a name="l10850"></a>10850       $popt = $this-&gt;getAnnotOptFromJSProp($prop);
<a name="l10851"></a>10851       <span class="comment">// set additional default options</span>
<a name="l10852"></a>10852       <span class="keywordflow">if</span> (!isset($popt[<span class="stringliteral">&#39;mk&#39;</span>])) {
<a name="l10853"></a>10853         $popt[<span class="stringliteral">&#39;mk&#39;</span>] = array();
<a name="l10854"></a>10854       }
<a name="l10855"></a>10855       $popt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ca&#39;</span>] = $this-&gt;_textstring($caption);
<a name="l10856"></a>10856       $popt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;rc&#39;</span>] = $this-&gt;_textstring($caption);
<a name="l10857"></a>10857       $popt[<span class="stringliteral">&#39;mk&#39;</span>][<span class="stringliteral">&#39;ac&#39;</span>] = $this-&gt;_textstring($caption);
<a name="l10858"></a>10858       $font = $this-&gt;FontFamily;
<a name="l10859"></a>10859       $fontkey = array_search($font, $this-&gt;fontkeys);
<a name="l10860"></a>10860       <span class="keywordflow">if</span> (!in_array($fontkey, $this-&gt;annotation_fonts)) {
<a name="l10861"></a>10861         $this-&gt;annotation_fonts[$font] = $fontkey;
<a name="l10862"></a>10862       }
<a name="l10863"></a>10863       $fontstyle = sprintf(<span class="stringliteral">&#39;/F%d %.2F Tf %s&#39;</span>, ($fontkey + 1), $this-&gt;FontSizePt, $this-&gt;TextColor);
<a name="l10864"></a>10864       $popt[<span class="stringliteral">&#39;da&#39;</span>] = $fontstyle;
<a name="l10865"></a>10865       $popt[<span class="stringliteral">&#39;ap&#39;</span>] = array();
<a name="l10866"></a>10866       $popt[<span class="stringliteral">&#39;ap&#39;</span>][<span class="charliteral">&#39;n&#39;</span>] = <span class="stringliteral">&#39;q BT &#39;</span>.$fontstyle.<span class="stringliteral">&#39; ET Q&#39;</span>;
<a name="l10867"></a>10867       <span class="comment">// merge options</span>
<a name="l10868"></a>10868       $opt = array_merge($popt, $opt);
<a name="l10869"></a>10869       <span class="comment">// set remaining annotation data</span>
<a name="l10870"></a>10870       $opt[<span class="stringliteral">&#39;Subtype&#39;</span>] = <span class="stringliteral">&#39;Widget&#39;</span>;
<a name="l10871"></a>10871       $opt[<span class="stringliteral">&#39;ft&#39;</span>] = <span class="stringliteral">&#39;Btn&#39;</span>;
<a name="l10872"></a>10872       $opt[<span class="charliteral">&#39;t&#39;</span>] = $caption;
<a name="l10873"></a>10873       $opt[<span class="charliteral">&#39;v&#39;</span>] = $name;
<a name="l10874"></a>10874       <span class="keywordflow">if</span> (!empty($action)) {
<a name="l10875"></a>10875         <span class="keywordflow">if</span> (is_array($action)) {
<a name="l10876"></a>10876           <span class="comment">// form action options as on section 12.7.5 of PDF32000_2008.</span>
<a name="l10877"></a>10877           $opt[<span class="stringliteral">&#39;aa&#39;</span>] = <span class="stringliteral">&#39;/D &lt;&lt;&#39;</span>;
<a name="l10878"></a>10878           $bmode = array(<span class="stringliteral">&#39;SubmitForm&#39;</span>, <span class="stringliteral">&#39;ResetForm&#39;</span>, <span class="stringliteral">&#39;ImportData&#39;</span>);
<a name="l10879"></a>10879           <span class="keywordflow">foreach</span> ($action AS $key =&gt; $val) {
<a name="l10880"></a>10880             <span class="keywordflow">if</span> (($key == <span class="charliteral">&#39;S&#39;</span>) AND in_array($val, $bmode)) {
<a name="l10881"></a>10881               $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="stringliteral">&#39; /S /&#39;</span>.$val;
<a name="l10882"></a>10882             } elseif (($key == <span class="charliteral">&#39;F&#39;</span>) AND (!empty($val))) {
<a name="l10883"></a>10883               $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="stringliteral">&#39; /F &#39;</span>.$this-&gt;_datastring($val);
<a name="l10884"></a>10884             } elseif (($key == <span class="stringliteral">&#39;Fields&#39;</span>) AND is_array($val) AND !empty($val)) {
<a name="l10885"></a>10885               $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="stringliteral">&#39; /Fields [&#39;</span>;
<a name="l10886"></a>10886               <span class="keywordflow">foreach</span> ($val AS $field) {
<a name="l10887"></a>10887                 $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="charliteral">&#39; &#39;</span>.$this-&gt;_textstring($field);
<a name="l10888"></a>10888               }
<a name="l10889"></a>10889               $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="charliteral">&#39;]&#39;</span>;
<a name="l10890"></a>10890             } elseif (($key == <span class="stringliteral">&#39;Flags&#39;</span>)) {
<a name="l10891"></a>10891               $ff = 0;
<a name="l10892"></a>10892               <span class="keywordflow">if</span> (is_array($val)) {
<a name="l10893"></a>10893                 <span class="keywordflow">foreach</span> ($val AS $flag) {
<a name="l10894"></a>10894                   <span class="keywordflow">switch</span> ($flag) {
<a name="l10895"></a>10895                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;Include/Exclude&#39;</span>: {
<a name="l10896"></a>10896                       $ff += 1 &lt;&lt; 0;
<a name="l10897"></a>10897                       <span class="keywordflow">break</span>;
<a name="l10898"></a>10898                     }
<a name="l10899"></a>10899                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;IncludeNoValueFields&#39;</span>: {
<a name="l10900"></a>10900                       $ff += 1 &lt;&lt; 1;
<a name="l10901"></a>10901                       <span class="keywordflow">break</span>;
<a name="l10902"></a>10902                     }
<a name="l10903"></a>10903                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;ExportFormat&#39;</span>: {
<a name="l10904"></a>10904                       $ff += 1 &lt;&lt; 2;
<a name="l10905"></a>10905                       <span class="keywordflow">break</span>;
<a name="l10906"></a>10906                     }
<a name="l10907"></a>10907                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;GetMethod&#39;</span>: {
<a name="l10908"></a>10908                       $ff += 1 &lt;&lt; 3;
<a name="l10909"></a>10909                       <span class="keywordflow">break</span>;
<a name="l10910"></a>10910                     }
<a name="l10911"></a>10911                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SubmitCoordinates&#39;</span>: {
<a name="l10912"></a>10912                       $ff += 1 &lt;&lt; 4;
<a name="l10913"></a>10913                       <span class="keywordflow">break</span>;
<a name="l10914"></a>10914                     }
<a name="l10915"></a>10915                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;XFDF&#39;</span>: {
<a name="l10916"></a>10916                       $ff += 1 &lt;&lt; 5;
<a name="l10917"></a>10917                       <span class="keywordflow">break</span>;
<a name="l10918"></a>10918                     }
<a name="l10919"></a>10919                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;IncludeAppendSaves&#39;</span>: {
<a name="l10920"></a>10920                       $ff += 1 &lt;&lt; 6;
<a name="l10921"></a>10921                       <span class="keywordflow">break</span>;
<a name="l10922"></a>10922                     }
<a name="l10923"></a>10923                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;IncludeAnnotations&#39;</span>: {
<a name="l10924"></a>10924                       $ff += 1 &lt;&lt; 7;
<a name="l10925"></a>10925                       <span class="keywordflow">break</span>;
<a name="l10926"></a>10926                     }
<a name="l10927"></a>10927                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;SubmitPDF&#39;</span>: {
<a name="l10928"></a>10928                       $ff += 1 &lt;&lt; 8;
<a name="l10929"></a>10929                       <span class="keywordflow">break</span>;
<a name="l10930"></a>10930                     }
<a name="l10931"></a>10931                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;CanonicalFormat&#39;</span>: {
<a name="l10932"></a>10932                       $ff += 1 &lt;&lt; 9;
<a name="l10933"></a>10933                       <span class="keywordflow">break</span>;
<a name="l10934"></a>10934                     }
<a name="l10935"></a>10935                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;ExclNonUserAnnots&#39;</span>: {
<a name="l10936"></a>10936                       $ff += 1 &lt;&lt; 10;
<a name="l10937"></a>10937                       <span class="keywordflow">break</span>;
<a name="l10938"></a>10938                     }
<a name="l10939"></a>10939                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;ExclFKey&#39;</span>: {
<a name="l10940"></a>10940                       $ff += 1 &lt;&lt; 11;
<a name="l10941"></a>10941                       <span class="keywordflow">break</span>;
<a name="l10942"></a>10942                     }
<a name="l10943"></a>10943                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;EmbedForm&#39;</span>: {
<a name="l10944"></a>10944                       $ff += 1 &lt;&lt; 13;
<a name="l10945"></a>10945                       <span class="keywordflow">break</span>;
<a name="l10946"></a>10946                     }
<a name="l10947"></a>10947                   }
<a name="l10948"></a>10948                 }
<a name="l10949"></a>10949               } <span class="keywordflow">else</span> {
<a name="l10950"></a>10950                 $ff = intval($val);
<a name="l10951"></a>10951               }
<a name="l10952"></a>10952               $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="stringliteral">&#39; /Flags &#39;</span>.$ff;
<a name="l10953"></a>10953             }
<a name="l10954"></a>10954           }
<a name="l10955"></a>10955           $opt[<span class="stringliteral">&#39;aa&#39;</span>] .= <span class="stringliteral">&#39; &gt;&gt;&#39;</span>;
<a name="l10956"></a>10956         } <span class="keywordflow">else</span> {
<a name="l10957"></a>10957           <span class="comment">// Javascript action or raw action command</span>
<a name="l10958"></a>10958           $js_obj_id = $this-&gt;addJavascriptObject($action);
<a name="l10959"></a>10959           $opt[<span class="stringliteral">&#39;aa&#39;</span>] = <span class="stringliteral">&#39;/D &#39;</span>.$js_obj_id.<span class="stringliteral">&#39; 0 R&#39;</span>;
<a name="l10960"></a>10960         }
<a name="l10961"></a>10961       }
<a name="l10962"></a>10962       $this-&gt;Annotation($x, $y, $w, $h, $name, $opt, 0);
<a name="l10963"></a>10963       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l10964"></a>10964         $this-&gt;x -= $w;
<a name="l10965"></a>10965       } <span class="keywordflow">else</span> {
<a name="l10966"></a>10966         $this-&gt;x += $w;
<a name="l10967"></a>10967       }
<a name="l10968"></a>10968     }
<a name="l10969"></a>10969     
<a name="l10970"></a>10970     <span class="comment">// --- END FORMS FIELDS ------------------------------------------------</span>
<a name="l10971"></a>10971     
<a name="l10972"></a>10972     <span class="comment">/*</span>
<a name="l10973"></a>10973 <span class="comment">    * Add certification signature (DocMDP or UR3)</span>
<a name="l10974"></a>10974 <span class="comment">    * You can set only one signature type</span>
<a name="l10975"></a>10975 <span class="comment">    * @access protected</span>
<a name="l10976"></a>10976 <span class="comment">    * @author Nicola Asuni</span>
<a name="l10977"></a>10977 <span class="comment">    * @since 4.6.008 (2009-05-07)</span>
<a name="l10978"></a>10978 <span class="comment">    */</span>
<a name="l10979"></a>10979     <span class="keyword">protected</span> function _putsignature() {
<a name="l10980"></a>10980       <span class="keywordflow">if</span> ((!$this-&gt;sign) OR (!isset($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>]))) {
<a name="l10981"></a>10981         <span class="keywordflow">return</span>;
<a name="l10982"></a>10982       }
<a name="l10983"></a>10983       $this-&gt;_out(<span class="stringliteral">&#39;/Type /Sig&#39;</span>);
<a name="l10984"></a>10984       $this-&gt;_out(<span class="stringliteral">&#39;/Filter /Adobe.PPKLite&#39;</span>);
<a name="l10985"></a>10985       $this-&gt;_out(<span class="stringliteral">&#39;/SubFilter /adbe.pkcs7.detached&#39;</span>);
<a name="l10986"></a>10986       $this-&gt;_out($this-&gt;byterange_string);
<a name="l10987"></a>10987       $this-&gt;_out(<span class="stringliteral">&#39;/Contents&lt;&gt;&#39;</span>.str_repeat(<span class="charliteral">&#39; &#39;</span>, $this-&gt;signature_max_lenght));
<a name="l10988"></a>10988       $this-&gt;_out(<span class="stringliteral">&#39;/Reference&#39;</span>);
<a name="l10989"></a>10989       $this-&gt;_out(<span class="charliteral">&#39;[&#39;</span>);
<a name="l10990"></a>10990       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l10991"></a>10991       $this-&gt;_out(<span class="stringliteral">&#39;/Type /SigRef&#39;</span>);
<a name="l10992"></a>10992       <span class="keywordflow">if</span> ($this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>] &gt; 0) {
<a name="l10993"></a>10993         $this-&gt;_out(<span class="stringliteral">&#39;/TransformMethod /DocMDP&#39;</span>);
<a name="l10994"></a>10994         $this-&gt;_out(<span class="stringliteral">&#39;/TransformParams&#39;</span>);
<a name="l10995"></a>10995         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l10996"></a>10996         $this-&gt;_out(<span class="stringliteral">&#39;/Type /TransformParams&#39;</span>);
<a name="l10997"></a>10997         $this-&gt;_out(<span class="stringliteral">&#39;/V /1.2&#39;</span>);
<a name="l10998"></a>10998         $this-&gt;_out(<span class="stringliteral">&#39;/P &#39;</span>.$this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>].<span class="stringliteral">&#39;&#39;</span>);
<a name="l10999"></a>10999       } <span class="keywordflow">else</span> {
<a name="l11000"></a>11000         $this-&gt;_out(<span class="stringliteral">&#39;/TransformMethod /UR3&#39;</span>);
<a name="l11001"></a>11001         $this-&gt;_out(<span class="stringliteral">&#39;/TransformParams&#39;</span>);
<a name="l11002"></a>11002         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l11003"></a>11003         $this-&gt;_out(<span class="stringliteral">&#39;/Type /TransformParams&#39;</span>);
<a name="l11004"></a>11004         $this-&gt;_out(<span class="stringliteral">&#39;/V /2.2&#39;</span>);
<a name="l11005"></a>11005         <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;ur_document)) {
<a name="l11006"></a>11006           $this-&gt;_out(<span class="stringliteral">&#39;/Document[&#39;</span>.$this-&gt;ur_document.<span class="charliteral">&#39;]&#39;</span>);
<a name="l11007"></a>11007         }
<a name="l11008"></a>11008         <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;ur_annots)) {
<a name="l11009"></a>11009           $this-&gt;_out(<span class="stringliteral">&#39;/Annots[&#39;</span>.$this-&gt;ur_annots.<span class="charliteral">&#39;]&#39;</span>);
<a name="l11010"></a>11010         }
<a name="l11011"></a>11011         <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;ur_form)) {
<a name="l11012"></a>11012           $this-&gt;_out(<span class="stringliteral">&#39;/Form[&#39;</span>.$this-&gt;ur_form.<span class="charliteral">&#39;]&#39;</span>);
<a name="l11013"></a>11013         }
<a name="l11014"></a>11014         <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;ur_signature)) {
<a name="l11015"></a>11015           $this-&gt;_out(<span class="stringliteral">&#39;/Signature[&#39;</span>.$this-&gt;ur_signature.<span class="charliteral">&#39;]&#39;</span>);
<a name="l11016"></a>11016         }
<a name="l11017"></a>11017       }
<a name="l11018"></a>11018       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11019"></a>11019       $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11020"></a>11020       $this-&gt;_out(<span class="charliteral">&#39;]&#39;</span>);
<a name="l11021"></a>11021       <span class="keywordflow">if</span> (isset($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Name&#39;</span>]) AND !$this-&gt;empty_string($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Name&#39;</span>])) {
<a name="l11022"></a>11022         $this-&gt;_out(<span class="stringliteral">&#39;/Name &#39;</span>.$this-&gt;_textstring($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Name&#39;</span>]).<span class="stringliteral">&#39;&#39;</span>);
<a name="l11023"></a>11023       }
<a name="l11024"></a>11024       <span class="keywordflow">if</span> (isset($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Location&#39;</span>]) AND !$this-&gt;empty_string($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Location&#39;</span>])) {
<a name="l11025"></a>11025         $this-&gt;_out(<span class="stringliteral">&#39;/Location &#39;</span>.$this-&gt;_textstring($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Location&#39;</span>]).<span class="stringliteral">&#39;&#39;</span>);
<a name="l11026"></a>11026       }
<a name="l11027"></a>11027       <span class="keywordflow">if</span> (isset($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Reason&#39;</span>]) AND !$this-&gt;empty_string($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Reason&#39;</span>])) {
<a name="l11028"></a>11028         $this-&gt;_out(<span class="stringliteral">&#39;/Reason &#39;</span>.$this-&gt;_textstring($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;Reason&#39;</span>]).<span class="stringliteral">&#39;&#39;</span>);
<a name="l11029"></a>11029       }
<a name="l11030"></a>11030       <span class="keywordflow">if</span> (isset($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;ContactInfo&#39;</span>]) AND !$this-&gt;empty_string($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;ContactInfo&#39;</span>])) {
<a name="l11031"></a>11031         $this-&gt;_out(<span class="stringliteral">&#39;/ContactInfo &#39;</span>.$this-&gt;_textstring($this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>][<span class="stringliteral">&#39;ContactInfo&#39;</span>]).<span class="stringliteral">&#39;&#39;</span>);
<a name="l11032"></a>11032       }
<a name="l11033"></a>11033       $this-&gt;_out(<span class="stringliteral">&#39;/M &#39;</span>.$this-&gt;_datestring());
<a name="l11034"></a>11034     }
<a name="l11035"></a>11035     
<a name="l11036"></a>11036     <span class="comment">/*</span>
<a name="l11037"></a>11037 <span class="comment">    * Set User&#39;s Rights for PDF Reader</span>
<a name="l11038"></a>11038 <span class="comment">    * WARNING: This works only using the Adobe private key with the setSignature() method!.</span>
<a name="l11039"></a>11039 <span class="comment">    * Check the PDF Reference 8.7.1 Transform Methods, </span>
<a name="l11040"></a>11040 <span class="comment">    * Table 8.105 Entries in the UR transform parameters dictionary</span>
<a name="l11041"></a>11041 <span class="comment">    * @param boolean $enable if true enable user&#39;s rights on PDF reader</span>
<a name="l11042"></a>11042 <span class="comment">    * @param string $document Names specifying additional document-wide usage rights for the document. The only defined value is &quot;/FullSave&quot;, which permits a user to save the document along with modified form and/or annotation data.</span>
<a name="l11043"></a>11043 <span class="comment">    * @param string $annots Names specifying additional annotation-related usage rights for the document. Valid names in PDF 1.5 and later are /Create/Delete/Modify/Copy/Import/Export, which permit the user to perform the named operation on annotations.</span>
<a name="l11044"></a>11044 <span class="comment">    * @param string $form Names specifying additional form-field-related usage rights for the document. Valid names are: /Add/Delete/FillIn/Import/Export/SubmitStandalone/SpawnTemplate </span>
<a name="l11045"></a>11045 <span class="comment">    * @param string $signature Names specifying additional signature-related usage rights for the document. The only defined value is /Modify, which permits a user to apply a digital signature to an existing signature form field or clear a signed signature form field.</span>
<a name="l11046"></a>11046 <span class="comment">    * @access public</span>
<a name="l11047"></a>11047 <span class="comment">    * @author Nicola Asuni</span>
<a name="l11048"></a>11048 <span class="comment">    * @since 2.9.000 (2008-03-26)</span>
<a name="l11049"></a>11049 <span class="comment">    */</span>
<a name="l11050"></a>11050     <span class="keyword">public</span> function setUserRights(
<a name="l11051"></a>11051         $enable=<span class="keyword">true</span>, 
<a name="l11052"></a>11052         $document=<span class="stringliteral">&#39;/FullSave&#39;</span>,
<a name="l11053"></a>11053         $annots=<span class="stringliteral">&#39;/Create/Delete/Modify/Copy/Import/Export&#39;</span>,
<a name="l11054"></a>11054         $form=<span class="stringliteral">&#39;/Add/Delete/FillIn/Import/Export/SubmitStandalone/SpawnTemplate&#39;</span>,
<a name="l11055"></a>11055         $signature=<span class="stringliteral">&#39;/Modify&#39;</span>) {
<a name="l11056"></a>11056       $this-&gt;ur = $enable;
<a name="l11057"></a>11057       $this-&gt;ur_document = $document;
<a name="l11058"></a>11058       $this-&gt;ur_annots = $annots;
<a name="l11059"></a>11059       $this-&gt;ur_form = $form;
<a name="l11060"></a>11060       $this-&gt;ur_signature = $signature;
<a name="l11061"></a>11061       <span class="keywordflow">if</span> (!$this-&gt;sign) {
<a name="l11062"></a>11062         <span class="comment">// This signature only works using the Adobe Private key that is unavailable!</span>
<a name="l11063"></a>11063         $this-&gt;setSignature(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 0, array());
<a name="l11064"></a>11064       }
<a name="l11065"></a>11065     }
<a name="l11066"></a>11066     
<a name="l11067"></a>11067     <span class="comment">/*</span>
<a name="l11068"></a>11068 <span class="comment">    * Enable document signature (requires the OpenSSL Library).</span>
<a name="l11069"></a>11069 <span class="comment">    * The digital signature improve document authenticity and integrity and allows o enable extra features on Acrobat Reader.</span>
<a name="l11070"></a>11070 <span class="comment">    * @param mixed $signing_cert signing certificate (string or filename prefixed with &#39;file://&#39;)</span>
<a name="l11071"></a>11071 <span class="comment">    * @param mixed $private_key private key (string or filename prefixed with &#39;file://&#39;)</span>
<a name="l11072"></a>11072 <span class="comment">    * @param string $private_key_password password</span>
<a name="l11073"></a>11073 <span class="comment">    * @param string $extracerts specifies the name of a file containing a bunch of extra certificates to include in the signature which can for example be used to help the recipient to verify the certificate that you used.</span>
<a name="l11074"></a>11074 <span class="comment">    * @param int $cert_type The access permissions granted for this document. Valid values shall be: 1 = No changes to the document shall be permitted; any change to the document shall invalidate the signature; 2 = Permitted changes shall be filling in forms, instantiating page templates, and signing; other changes shall invalidate the signature; 3 = Permitted changes shall be the same as for 2, as well as annotation creation, deletion, and modification; other changes shall invalidate the signature.</span>
<a name="l11075"></a>11075 <span class="comment">    * @parm array $info array of option information: Name, Location, Reason, ContactInfo.</span>
<a name="l11076"></a>11076 <span class="comment">    * @access public</span>
<a name="l11077"></a>11077 <span class="comment">    * @author Nicola Asuni</span>
<a name="l11078"></a>11078 <span class="comment">    * @since 4.6.005 (2009-04-24)</span>
<a name="l11079"></a>11079 <span class="comment">    */</span>
<a name="l11080"></a>11080     <span class="keyword">public</span> function setSignature($signing_cert=<span class="stringliteral">&#39;&#39;</span>, $private_key=<span class="stringliteral">&#39;&#39;</span>, $private_key_password=<span class="stringliteral">&#39;&#39;</span>, $extracerts=<span class="stringliteral">&#39;&#39;</span>, $cert_type=2, $info=array()) {
<a name="l11081"></a>11081       <span class="comment">// to create self-signed signature: openssl req -x509 -nodes -days 365000 -newkey rsa:1024 -keyout tcpdf.crt -out tcpdf.crt</span>
<a name="l11082"></a>11082       <span class="comment">// to convert pfx certificate to pem: openssl</span>
<a name="l11083"></a>11083       <span class="comment">//     OpenSSL&gt; pkcs12 -in &lt;cert.pfx&gt; -out &lt;cert.crt&gt; -nodes</span>
<a name="l11084"></a>11084       $this-&gt;sign = <span class="keyword">true</span>;
<a name="l11085"></a>11085       $this-&gt;signature_data = array();
<a name="l11086"></a>11086       <span class="keywordflow">if</span> (strlen($signing_cert) == 0) {
<a name="l11087"></a>11087         $signing_cert = <span class="stringliteral">&#39;file://&#39;</span>.dirname(__FILE__).<span class="stringliteral">&#39;/tcpdf.crt&#39;</span>;
<a name="l11088"></a>11088         $private_key_password = <span class="stringliteral">&#39;tcpdfdemo&#39;</span>;
<a name="l11089"></a>11089       }
<a name="l11090"></a>11090       <span class="keywordflow">if</span> (strlen($private_key) == 0) {
<a name="l11091"></a>11091         $private_key = $signing_cert;
<a name="l11092"></a>11092       }
<a name="l11093"></a>11093       $this-&gt;signature_data[<span class="stringliteral">&#39;signcert&#39;</span>] = $signing_cert;
<a name="l11094"></a>11094       $this-&gt;signature_data[<span class="stringliteral">&#39;privkey&#39;</span>] = $private_key;
<a name="l11095"></a>11095       $this-&gt;signature_data[<span class="stringliteral">&#39;password&#39;</span>] = $private_key_password;
<a name="l11096"></a>11096       $this-&gt;signature_data[<span class="stringliteral">&#39;extracerts&#39;</span>] = $extracerts;
<a name="l11097"></a>11097       $this-&gt;signature_data[<span class="stringliteral">&#39;cert_type&#39;</span>] = $cert_type;
<a name="l11098"></a>11098       $this-&gt;signature_data[<span class="stringliteral">&#39;info&#39;</span>] = $info;
<a name="l11099"></a>11099     }
<a name="l11100"></a>11100     
<a name="l11101"></a>11101     <span class="comment">/*</span>
<a name="l11102"></a>11102 <span class="comment">    * Create a new page group.</span>
<a name="l11103"></a>11103 <span class="comment">    * NOTE: call this function before calling AddPage()</span>
<a name="l11104"></a>11104 <span class="comment">    * @param int $page starting group page (leave empty for next page).</span>
<a name="l11105"></a>11105 <span class="comment">    * @access public</span>
<a name="l11106"></a>11106 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11107"></a>11107 <span class="comment">    */</span>
<a name="l11108"></a>11108     <span class="keyword">public</span> function startPageGroup($page=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l11109"></a>11109       <span class="keywordflow">if</span> (empty($page)) {
<a name="l11110"></a>11110         $page = $this-&gt;page + 1;
<a name="l11111"></a>11111       }
<a name="l11112"></a>11112       $this-&gt;newpagegroup[$page] = <span class="keyword">true</span>;
<a name="l11113"></a>11113     }
<a name="l11114"></a>11114 
<a name="l11123"></a>11123     <span class="keyword">public</span> function AliasNbPages($alias=<span class="stringliteral">&#39;{nb}&#39;</span>) {
<a name="l11124"></a>11124       $this-&gt;AliasNbPages = $alias;
<a name="l11125"></a>11125     }
<a name="l11126"></a>11126     
<a name="l11135"></a>11135     <span class="keyword">public</span> function getAliasNbPages() {
<a name="l11136"></a>11136       <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l11137"></a>11137         <span class="keywordflow">return</span> <span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNbPages.<span class="charliteral">&#39;}&#39;</span>;
<a name="l11138"></a>11138             }
<a name="l11139"></a>11139       <span class="keywordflow">return</span> $this-&gt;AliasNbPages;
<a name="l11140"></a>11140     }
<a name="l11141"></a>11141 
<a name="l11150"></a>11150     <span class="keyword">public</span> function AliasNumPage($alias=<span class="stringliteral">&#39;{pnb}&#39;</span>) {
<a name="l11151"></a>11151       <span class="comment">//Define an alias for total number of pages</span>
<a name="l11152"></a>11152       $this-&gt;AliasNumPage = $alias;
<a name="l11153"></a>11153     }
<a name="l11154"></a>11154     
<a name="l11163"></a>11163     <span class="keyword">public</span> function getAliasNumPage() {
<a name="l11164"></a>11164       <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l11165"></a>11165         <span class="keywordflow">return</span> <span class="charliteral">&#39;{&#39;</span>.$this-&gt;AliasNumPage.<span class="charliteral">&#39;}&#39;</span>;
<a name="l11166"></a>11166             }
<a name="l11167"></a>11167       <span class="keywordflow">return</span> $this-&gt;AliasNumPage;
<a name="l11168"></a>11168     }
<a name="l11169"></a>11169     
<a name="l11170"></a>11170     <span class="comment">/*</span>
<a name="l11171"></a>11171 <span class="comment">    * Return the current page in the group.</span>
<a name="l11172"></a>11172 <span class="comment">    * @return current page in the group</span>
<a name="l11173"></a>11173 <span class="comment">    * @access public</span>
<a name="l11174"></a>11174 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11175"></a>11175 <span class="comment">    */</span>
<a name="l11176"></a>11176     <span class="keyword">public</span> function getGroupPageNo() {
<a name="l11177"></a>11177       <span class="keywordflow">return</span> $this-&gt;pagegroups[$this-&gt;currpagegroup];
<a name="l11178"></a>11178     }
<a name="l11179"></a>11179 
<a name="l11186"></a>11186     <span class="keyword">public</span> function getGroupPageNoFormatted() {
<a name="l11187"></a>11187       <span class="keywordflow">return</span> $this-&gt;formatPageNumber($this-&gt;getGroupPageNo());
<a name="l11188"></a>11188         }
<a name="l11189"></a>11189     
<a name="l11190"></a>11190     <span class="comment">/*</span>
<a name="l11191"></a>11191 <span class="comment">     * Return the alias of the current page group</span>
<a name="l11192"></a>11192 <span class="comment">         * If the current font is unicode type, the returned string is surrounded by additional curly braces.</span>
<a name="l11193"></a>11193 <span class="comment">     * (will be replaced by the total number of pages in this group).</span>
<a name="l11194"></a>11194 <span class="comment">     * @return alias of the current page group</span>
<a name="l11195"></a>11195 <span class="comment">     * @access public</span>
<a name="l11196"></a>11196 <span class="comment">     * @since 3.0.000 (2008-03-27)</span>
<a name="l11197"></a>11197 <span class="comment">    */</span>
<a name="l11198"></a>11198     <span class="keyword">public</span> function getPageGroupAlias() {
<a name="l11199"></a>11199       <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l11200"></a>11200         <span class="keywordflow">return</span> <span class="charliteral">&#39;{&#39;</span>.$this-&gt;currpagegroup.<span class="charliteral">&#39;}&#39;</span>;
<a name="l11201"></a>11201             }
<a name="l11202"></a>11202       <span class="keywordflow">return</span> $this-&gt;currpagegroup;
<a name="l11203"></a>11203     }
<a name="l11204"></a>11204     
<a name="l11205"></a>11205     <span class="comment">/*</span>
<a name="l11206"></a>11206 <span class="comment">     * Return the alias for the page number on the current page group</span>
<a name="l11207"></a>11207 <span class="comment">         * If the current font is unicode type, the returned string is surrounded by additional curly braces.</span>
<a name="l11208"></a>11208 <span class="comment">     * (will be replaced by the total number of pages in this group).</span>
<a name="l11209"></a>11209 <span class="comment">     * @return alias of the current page group</span>
<a name="l11210"></a>11210 <span class="comment">     * @access public</span>
<a name="l11211"></a>11211 <span class="comment">     * @since 4.5.000 (2009-01-02)</span>
<a name="l11212"></a>11212 <span class="comment">    */</span>
<a name="l11213"></a>11213     <span class="keyword">public</span> function getPageNumGroupAlias() {
<a name="l11214"></a>11214       <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l11215"></a>11215         <span class="keywordflow">return</span> <span class="charliteral">&#39;{&#39;</span>.str_replace(<span class="stringliteral">&#39;{nb&#39;</span>, <span class="stringliteral">&#39;{pnb&#39;</span>, $this-&gt;currpagegroup).<span class="charliteral">&#39;}&#39;</span>;
<a name="l11216"></a>11216             }
<a name="l11217"></a>11217       <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&#39;{nb&#39;</span>, <span class="stringliteral">&#39;{pnb&#39;</span>, $this-&gt;currpagegroup);
<a name="l11218"></a>11218     }
<a name="l11219"></a>11219 
<a name="l11227"></a>11227     <span class="keyword">protected</span> function formatPageNumber($num) {
<a name="l11228"></a>11228       <span class="keywordflow">return</span> number_format((<span class="keywordtype">float</span>)$num, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="charliteral">&#39;.&#39;</span>);
<a name="l11229"></a>11229     }
<a name="l11230"></a>11230 
<a name="l11239"></a>11239     <span class="keyword">protected</span> function formatTOCPageNumber($num) {
<a name="l11240"></a>11240       <span class="keywordflow">return</span> number_format((<span class="keywordtype">float</span>)$num, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="charliteral">&#39;.&#39;</span>);
<a name="l11241"></a>11241     }
<a name="l11242"></a>11242 
<a name="l11249"></a>11249     <span class="keyword">public</span> function PageNoFormatted() {
<a name="l11250"></a>11250       <span class="keywordflow">return</span> $this-&gt;formatPageNumber($this-&gt;PageNo());
<a name="l11251"></a>11251         }
<a name="l11252"></a>11252 
<a name="l11253"></a>11253         <span class="comment">/*</span>
<a name="l11254"></a>11254 <span class="comment">    * Put visibility settings.</span>
<a name="l11255"></a>11255 <span class="comment">    * @access protected</span>
<a name="l11256"></a>11256 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11257"></a>11257 <span class="comment">    */</span>
<a name="l11258"></a>11258     <span class="keyword">protected</span> function _putocg() {
<a name="l11259"></a>11259       $this-&gt;_newobj();
<a name="l11260"></a>11260       $this-&gt;n_ocg_print = $this-&gt;n;
<a name="l11261"></a>11261       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /OCG /Name &#39;</span>.$this-&gt;_textstring(<span class="stringliteral">&#39;print&#39;</span>));
<a name="l11262"></a>11262       $this-&gt;_out(<span class="stringliteral">&#39;/Usage &lt;&lt;/Print &lt;&lt;/PrintState /ON&gt;&gt; /View &lt;&lt;/ViewState /OFF&gt;&gt;&gt;&gt;&gt;&gt;&#39;</span>);
<a name="l11263"></a>11263       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l11264"></a>11264       $this-&gt;_newobj();
<a name="l11265"></a>11265       $this-&gt;n_ocg_view = $this-&gt;n;
<a name="l11266"></a>11266       $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /OCG /Name &#39;</span>.$this-&gt;_textstring(<span class="stringliteral">&#39;view&#39;</span>));
<a name="l11267"></a>11267       $this-&gt;_out(<span class="stringliteral">&#39;/Usage &lt;&lt;/Print &lt;&lt;/PrintState /OFF&gt;&gt; /View &lt;&lt;/ViewState /ON&gt;&gt;&gt;&gt;&gt;&gt;&#39;</span>);
<a name="l11268"></a>11268       $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l11269"></a>11269     }
<a name="l11270"></a>11270     
<a name="l11271"></a>11271     <span class="comment">/*</span>
<a name="l11272"></a>11272 <span class="comment">    * Set the visibility of the successive elements.</span>
<a name="l11273"></a>11273 <span class="comment">    * This can be useful, for instance, to put a background </span>
<a name="l11274"></a>11274 <span class="comment">    * image or color that will show on screen but won&#39;t print.</span>
<a name="l11275"></a>11275 <span class="comment">    * @param string $v visibility mode. Legal values are: all, print, screen.</span>
<a name="l11276"></a>11276 <span class="comment">    * @access public</span>
<a name="l11277"></a>11277 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11278"></a>11278 <span class="comment">    */</span>
<a name="l11279"></a>11279     <span class="keyword">public</span> function setVisibility($v) {
<a name="l11280"></a>11280       <span class="keywordflow">if</span> ($this-&gt;openMarkedContent) {
<a name="l11281"></a>11281         <span class="comment">// close existing open marked-content</span>
<a name="l11282"></a>11282         $this-&gt;_out(<span class="stringliteral">&#39;EMC&#39;</span>);
<a name="l11283"></a>11283         $this-&gt;openMarkedContent = <span class="keyword">false</span>;
<a name="l11284"></a>11284       }
<a name="l11285"></a>11285       <span class="keywordflow">switch</span>($v) {
<a name="l11286"></a>11286         <span class="keywordflow">case</span> <span class="stringliteral">&#39;print&#39;</span>: {
<a name="l11287"></a>11287           $this-&gt;_out(<span class="stringliteral">&#39;/OC /OC1 BDC&#39;</span>);
<a name="l11288"></a>11288           $this-&gt;openMarkedContent = <span class="keyword">true</span>;
<a name="l11289"></a>11289           <span class="keywordflow">break</span>;
<a name="l11290"></a>11290         }
<a name="l11291"></a>11291         <span class="keywordflow">case</span> <span class="stringliteral">&#39;screen&#39;</span>: {
<a name="l11292"></a>11292           $this-&gt;_out(<span class="stringliteral">&#39;/OC /OC2 BDC&#39;</span>);
<a name="l11293"></a>11293           $this-&gt;openMarkedContent = <span class="keyword">true</span>;
<a name="l11294"></a>11294           <span class="keywordflow">break</span>;
<a name="l11295"></a>11295         }
<a name="l11296"></a>11296         <span class="keywordflow">case</span> <span class="stringliteral">&#39;all&#39;</span>: {
<a name="l11297"></a>11297           $this-&gt;_out(<span class="stringliteral">&#39;&#39;</span>);
<a name="l11298"></a>11298           <span class="keywordflow">break</span>;
<a name="l11299"></a>11299         }
<a name="l11300"></a>11300         <span class="keywordflow">default</span>: {
<a name="l11301"></a>11301           $this-&gt;Error(<span class="stringliteral">&#39;Incorrect visibility: &#39;</span>.$v);
<a name="l11302"></a>11302           <span class="keywordflow">break</span>;
<a name="l11303"></a>11303         }
<a name="l11304"></a>11304       }
<a name="l11305"></a>11305       $this-&gt;visibility = $v;
<a name="l11306"></a>11306     }
<a name="l11307"></a>11307     
<a name="l11308"></a>11308     <span class="comment">/*</span>
<a name="l11309"></a>11309 <span class="comment">    * Add transparency parameters to the current extgstate</span>
<a name="l11310"></a>11310 <span class="comment">    * @param array $params parameters</span>
<a name="l11311"></a>11311 <span class="comment">    * @return the number of extgstates</span>
<a name="l11312"></a>11312 <span class="comment">    * @access protected</span>
<a name="l11313"></a>11313 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11314"></a>11314 <span class="comment">    */</span>
<a name="l11315"></a>11315     <span class="keyword">protected</span> function addExtGState($parms) {
<a name="l11316"></a>11316       $n = count($this-&gt;extgstates) + 1;
<a name="l11317"></a>11317       $this-&gt;extgstates[$n][<span class="stringliteral">&#39;parms&#39;</span>] = $parms;
<a name="l11318"></a>11318       <span class="keywordflow">return</span> $n;
<a name="l11319"></a>11319     }
<a name="l11320"></a>11320     
<a name="l11321"></a>11321     <span class="comment">/*</span>
<a name="l11322"></a>11322 <span class="comment">    * Add an extgstate</span>
<a name="l11323"></a>11323 <span class="comment">    * @param array $gs extgstate</span>
<a name="l11324"></a>11324 <span class="comment">    * @access protected</span>
<a name="l11325"></a>11325 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11326"></a>11326 <span class="comment">    */</span>
<a name="l11327"></a>11327     <span class="keyword">protected</span> function setExtGState($gs) {
<a name="l11328"></a>11328       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/GS%d gs&#39;</span>, $gs));
<a name="l11329"></a>11329     }
<a name="l11330"></a>11330     
<a name="l11331"></a>11331     <span class="comment">/*</span>
<a name="l11332"></a>11332 <span class="comment">    * Put extgstates for object transparency</span>
<a name="l11333"></a>11333 <span class="comment">    * @param array $gs extgstate</span>
<a name="l11334"></a>11334 <span class="comment">    * @access protected</span>
<a name="l11335"></a>11335 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11336"></a>11336 <span class="comment">    */</span>
<a name="l11337"></a>11337     <span class="keyword">protected</span> function _putextgstates() {
<a name="l11338"></a>11338       $ne = count($this-&gt;extgstates);
<a name="l11339"></a>11339       <span class="keywordflow">for</span> ($i = 1; $i &lt;= $ne; ++$i) {
<a name="l11340"></a>11340         $this-&gt;_newobj();
<a name="l11341"></a>11341         $this-&gt;extgstates[$i][<span class="charliteral">&#39;n&#39;</span>] = $this-&gt;n;
<a name="l11342"></a>11342         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;/Type /ExtGState&#39;</span>);
<a name="l11343"></a>11343         <span class="keywordflow">foreach</span> ($this-&gt;extgstates[$i][<span class="stringliteral">&#39;parms&#39;</span>] as $k =&gt; $v) {
<a name="l11344"></a>11344           $this-&gt;_out(<span class="charliteral">&#39;/&#39;</span>.$k.<span class="charliteral">&#39; &#39;</span>.$v);
<a name="l11345"></a>11345         }
<a name="l11346"></a>11346         $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11347"></a>11347         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l11348"></a>11348       }
<a name="l11349"></a>11349     }
<a name="l11350"></a>11350     
<a name="l11351"></a>11351     <span class="comment">/*</span>
<a name="l11352"></a>11352 <span class="comment">    * Set alpha for stroking (CA) and non-stroking (ca) operations.</span>
<a name="l11353"></a>11353 <span class="comment">    * @param float $alpha real value from 0 (transparent) to 1 (opaque)</span>
<a name="l11354"></a>11354 <span class="comment">    * @param string $bm blend mode, one of the following: Normal, Multiply, Screen, Overlay, Darken, Lighten, ColorDodge, ColorBurn, HardLight, SoftLight, Difference, Exclusion, Hue, Saturation, Color, Luminosity</span>
<a name="l11355"></a>11355 <span class="comment">    * @access public</span>
<a name="l11356"></a>11356 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11357"></a>11357 <span class="comment">    */</span>
<a name="l11358"></a>11358     <span class="keyword">public</span> function setAlpha($alpha, $bm=<span class="stringliteral">&#39;Normal&#39;</span>) {
<a name="l11359"></a>11359       $gs = $this-&gt;addExtGState(array(<span class="stringliteral">&#39;ca&#39;</span> =&gt; $alpha, <span class="stringliteral">&#39;CA&#39;</span> =&gt; $alpha, <span class="stringliteral">&#39;BM&#39;</span> =&gt; <span class="charliteral">&#39;/&#39;</span>.$bm));
<a name="l11360"></a>11360       $this-&gt;setExtGState($gs);
<a name="l11361"></a>11361     }
<a name="l11362"></a>11362 
<a name="l11363"></a>11363     <span class="comment">/*</span>
<a name="l11364"></a>11364 <span class="comment">    * Set the default JPEG compression quality (1-100)</span>
<a name="l11365"></a>11365 <span class="comment">    * @param int $quality JPEG quality, integer between 1 and 100</span>
<a name="l11366"></a>11366 <span class="comment">    * @access public</span>
<a name="l11367"></a>11367 <span class="comment">    * @since 3.0.000 (2008-03-27)</span>
<a name="l11368"></a>11368 <span class="comment">    */</span>
<a name="l11369"></a>11369     <span class="keyword">public</span> function setJPEGQuality($quality) {
<a name="l11370"></a>11370       <span class="keywordflow">if</span> (($quality &lt; 1) OR ($quality &gt; 100)) {
<a name="l11371"></a>11371         $quality = 75;
<a name="l11372"></a>11372       }
<a name="l11373"></a>11373       $this-&gt;jpeg_quality = intval($quality);
<a name="l11374"></a>11374     }
<a name="l11375"></a>11375     
<a name="l11376"></a>11376     <span class="comment">/*</span>
<a name="l11377"></a>11377 <span class="comment">    * Set the default number of columns in a row for HTML tables.</span>
<a name="l11378"></a>11378 <span class="comment">    * @param int $cols number of columns</span>
<a name="l11379"></a>11379 <span class="comment">    * @access public</span>
<a name="l11380"></a>11380 <span class="comment">    * @since 3.0.014 (2008-06-04)</span>
<a name="l11381"></a>11381 <span class="comment">    */</span>
<a name="l11382"></a>11382     <span class="keyword">public</span> function setDefaultTableColumns($cols=4) { 
<a name="l11383"></a>11383       $this-&gt;default_table_columns = intval($cols); 
<a name="l11384"></a>11384     }
<a name="l11385"></a>11385     
<a name="l11386"></a>11386     <span class="comment">/*</span>
<a name="l11387"></a>11387 <span class="comment">    * Set the height of the cell (line height) respect the font height.</span>
<a name="l11388"></a>11388 <span class="comment">    * @param int $h cell proportion respect font height (typical value = 1.25).</span>
<a name="l11389"></a>11389 <span class="comment">    * @access public</span>
<a name="l11390"></a>11390 <span class="comment">    * @since 3.0.014 (2008-06-04)</span>
<a name="l11391"></a>11391 <span class="comment">    */</span>
<a name="l11392"></a>11392     <span class="keyword">public</span> function setCellHeightRatio($h) { 
<a name="l11393"></a>11393       $this-&gt;cell_height_ratio = $h; 
<a name="l11394"></a>11394     }
<a name="l11395"></a>11395     
<a name="l11396"></a>11396     <span class="comment">/*</span>
<a name="l11397"></a>11397 <span class="comment">    * return the height of cell repect font height.</span>
<a name="l11398"></a>11398 <span class="comment">    * @access public</span>
<a name="l11399"></a>11399 <span class="comment">    * @since 4.0.012 (2008-07-24)</span>
<a name="l11400"></a>11400 <span class="comment">    */</span>
<a name="l11401"></a>11401     <span class="keyword">public</span> function getCellHeightRatio() { 
<a name="l11402"></a>11402       <span class="keywordflow">return</span> $this-&gt;cell_height_ratio; 
<a name="l11403"></a>11403     }
<a name="l11404"></a>11404     
<a name="l11405"></a>11405     <span class="comment">/*</span>
<a name="l11406"></a>11406 <span class="comment">    * Set the PDF version (check PDF reference for valid values).</span>
<a name="l11407"></a>11407 <span class="comment">    * Default value is 1.t</span>
<a name="l11408"></a>11408 <span class="comment">    * @access public</span>
<a name="l11409"></a>11409 <span class="comment">    * @since 3.1.000 (2008-06-09)</span>
<a name="l11410"></a>11410 <span class="comment">    */</span>
<a name="l11411"></a>11411     <span class="keyword">public</span> function setPDFVersion($version=<span class="stringliteral">&#39;1.7&#39;</span>) { 
<a name="l11412"></a>11412       $this-&gt;PDFVersion = $version;
<a name="l11413"></a>11413     }
<a name="l11414"></a>11414     
<a name="l11415"></a>11415     <span class="comment">/*</span>
<a name="l11416"></a>11416 <span class="comment">    * Set the viewer preferences dictionary controlling the way the document is to be presented on the screen or in print.</span>
<a name="l11417"></a>11417 <span class="comment">    * (see Section 8.1 of PDF reference, &quot;Viewer Preferences&quot;).</span>
<a name="l11418"></a>11418 <span class="comment">    * &lt;ul&gt;</span>
<a name="l11419"></a>11419 <span class="comment">    * &lt;li&gt;HideToolbar boolean (Optional) A flag specifying whether to hide the viewer application&#39;s tool bars when the document is active. Default value: false.&lt;/li&gt;</span>
<a name="l11420"></a>11420 <span class="comment">    * &lt;li&gt;HideMenubar boolean (Optional) A flag specifying whether to hide the viewer application&#39;s menu bar when the document is active. Default value: false.&lt;/li&gt;</span>
<a name="l11421"></a>11421 <span class="comment">    * &lt;li&gt;HideWindowUI boolean (Optional) A flag specifying whether to hide user interface elements in the document&#39;s window (such as scroll bars and navigation controls), leaving only the document&#39;s contents displayed. Default value: false.&lt;/li&gt;</span>
<a name="l11422"></a>11422 <span class="comment">    * &lt;li&gt;FitWindow boolean (Optional) A flag specifying whether to resize the document&#39;s window to fit the size of the first displayed page. Default value: false.&lt;/li&gt;</span>
<a name="l11423"></a>11423 <span class="comment">    * &lt;li&gt;CenterWindow boolean (Optional) A flag specifying whether to position the document&#39;s window in the center of the screen. Default value: false.&lt;/li&gt;</span>
<a name="l11424"></a>11424 <span class="comment">    * &lt;li&gt;DisplayDocTitle boolean (Optional; PDF 1.4) A flag specifying whether the window&#39;s title bar should display the document title taken from the Title entry of the document information dictionary (see Section 10.2.1, &quot;Document Information Dictionary&quot;). If false, the title bar should instead display the name of the PDF file containing the document. Default value: false.&lt;/li&gt;</span>
<a name="l11425"></a>11425 <span class="comment">    * &lt;li&gt;NonFullScreenPageMode name (Optional) The document&#39;s page mode, specifying how to display the document on exiting full-screen mode:&lt;ul&gt;&lt;li&gt;UseNone Neither document outline nor thumbnail images visible&lt;/li&gt;&lt;li&gt;UseOutlines Document outline visible&lt;/li&gt;&lt;li&gt;UseThumbs Thumbnail images visible&lt;/li&gt;&lt;li&gt;UseOC Optional content group panel visible&lt;/li&gt;&lt;ul&gt;This entry is meaningful only if the value of the PageMode entry in the catalog dictionary (see Section 3.6.1, &quot;Document Catalog&quot;) is FullScreen; it is ignored otherwise. Default value: UseNone.&lt;/li&gt;</span>
<a name="l11426"></a>11426 <span class="comment">    * &lt;li&gt;ViewArea name (Optional; PDF 1.4) The name of the page boundary representing the area of a page to be displayed when viewing the document on the screen. Valid values are (see Section 10.10.1, &quot;Page Boundaries&quot;).:&lt;ul&gt;&lt;li&gt;MediaBox&lt;/li&gt;&lt;li&gt;CropBox (default)&lt;/li&gt;&lt;li&gt;BleedBox&lt;/li&gt;&lt;li&gt;TrimBox&lt;/li&gt;&lt;li&gt;ArtBox&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;</span>
<a name="l11427"></a>11427 <span class="comment">    * &lt;li&gt;ViewClip name (Optional; PDF 1.4) The name of the page boundary to which the contents of a page are to be clipped when viewing the document on the screen. Valid values are (see Section 10.10.1, &quot;Page Boundaries&quot;).:&lt;ul&gt;&lt;li&gt;MediaBox&lt;/li&gt;&lt;li&gt;CropBox (default)&lt;/li&gt;&lt;li&gt;BleedBox&lt;/li&gt;&lt;li&gt;TrimBox&lt;/li&gt;&lt;li&gt;ArtBox&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;</span>
<a name="l11428"></a>11428 <span class="comment">    * &lt;li&gt;PrintArea name (Optional; PDF 1.4) The name of the page boundary representing the area of a page to be rendered when printing the document. Valid values are (see Section 10.10.1, &quot;Page Boundaries&quot;).:&lt;ul&gt;&lt;li&gt;MediaBox&lt;/li&gt;&lt;li&gt;CropBox (default)&lt;/li&gt;&lt;li&gt;BleedBox&lt;/li&gt;&lt;li&gt;TrimBox&lt;/li&gt;&lt;li&gt;ArtBox&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;</span>
<a name="l11429"></a>11429 <span class="comment">    * &lt;li&gt;PrintClip name (Optional; PDF 1.4) The name of the page boundary to which the contents of a page are to be clipped when printing the document. Valid values are (see Section 10.10.1, &quot;Page Boundaries&quot;).:&lt;ul&gt;&lt;li&gt;MediaBox&lt;/li&gt;&lt;li&gt;CropBox (default)&lt;/li&gt;&lt;li&gt;BleedBox&lt;/li&gt;&lt;li&gt;TrimBox&lt;/li&gt;&lt;li&gt;ArtBox&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;</span>
<a name="l11430"></a>11430 <span class="comment">    * &lt;li&gt;PrintScaling name (Optional; PDF 1.6) The page scaling option to be selected when a print dialog is displayed for this document. Valid values are: &lt;ul&gt;&lt;li&gt;None, which indicates that the print dialog should reflect no page scaling&lt;/li&gt;&lt;li&gt;AppDefault (default), which indicates that applications should use the current print scaling&lt;/li&gt;&lt;ul&gt;&lt;/li&gt;</span>
<a name="l11431"></a>11431 <span class="comment">    * &lt;li&gt;Duplex name (Optional; PDF 1.7) The paper handling option to use when printing the file from the print dialog. The following values are valid:&lt;ul&gt;&lt;li&gt;Simplex - Print single-sided&lt;/li&gt;&lt;li&gt;DuplexFlipShortEdge - Duplex and flip on the short edge of the sheet&lt;/li&gt;&lt;li&gt;DuplexFlipLongEdge - Duplex and flip on the long edge of the sheet&lt;/li&gt;&lt;/ul&gt;Default value: none&lt;/li&gt;</span>
<a name="l11432"></a>11432 <span class="comment">    * &lt;li&gt;PickTrayByPDFSize boolean (Optional; PDF 1.7) A flag specifying whether the PDF page size is used to select the input paper tray. This setting influences only the preset values used to populate the print dialog presented by a PDF viewer application. If PickTrayByPDFSize is true, the check box in the print dialog associated with input paper tray is checked. Note: This setting has no effect on Mac OS systems, which do not provide the ability to pick the input tray by size.&lt;/li&gt;</span>
<a name="l11433"></a>11433 <span class="comment">    * &lt;li&gt;PrintPageRange array (Optional; PDF 1.7) The page numbers used to initialize the print dialog box when the file is printed. The first page of the PDF file is denoted by 1. Each pair consists of the first and last pages in the sub-range. An odd number of integers causes this entry to be ignored. Negative numbers cause the entire array to be ignored. Default value: as defined by PDF viewer application&lt;/li&gt;</span>
<a name="l11434"></a>11434 <span class="comment">    * &lt;li&gt;NumCopies integer (Optional; PDF 1.7) The number of copies to be printed when the print dialog is opened for this file. Supported values are the integers 2 through 5. Values outside this range are ignored. Default value: as defined by PDF viewer application, but typically 1&lt;/li&gt;</span>
<a name="l11435"></a>11435 <span class="comment">    * &lt;/ul&gt;</span>
<a name="l11436"></a>11436 <span class="comment">    * @param array $preferences array of options.</span>
<a name="l11437"></a>11437 <span class="comment">    * @author Nicola Asuni</span>
<a name="l11438"></a>11438 <span class="comment">    * @access public</span>
<a name="l11439"></a>11439 <span class="comment">    * @since 3.1.000 (2008-06-09)</span>
<a name="l11440"></a>11440 <span class="comment">    */</span>
<a name="l11441"></a>11441     <span class="keyword">public</span> function setViewerPreferences($preferences) { 
<a name="l11442"></a>11442       $this-&gt;viewer_preferences = $preferences;
<a name="l11443"></a>11443     }
<a name="l11444"></a>11444     
<a name="l11458"></a>11458     <span class="keyword">public</span> function LinearGradient($x, $y, $w, $h, $col1=array(), $col2=array(), $coords=array(0,0,1,0)) {
<a name="l11459"></a>11459       $this-&gt;Clip($x, $y, $w, $h);
<a name="l11460"></a>11460       $this-&gt;Gradient(2, $col1, $col2, $coords);
<a name="l11461"></a>11461     }
<a name="l11462"></a>11462     
<a name="l11476"></a>11476     <span class="keyword">public</span> function RadialGradient($x, $y, $w, $h, $col1=array(), $col2=array(), $coords=array(0.5,0.5,0.5,0.5,1)) {
<a name="l11477"></a>11477       $this-&gt;Clip($x, $y, $w, $h);
<a name="l11478"></a>11478       $this-&gt;Gradient(3, $col1, $col2, $coords);
<a name="l11479"></a>11479     }
<a name="l11480"></a>11480     
<a name="l11498"></a>11498     <span class="keyword">public</span> function CoonsPatchMesh($x, $y, $w, $h, $col1=array(), $col2=array(), $col3=array(), $col4=array(), $coords=array(0.00,0.0,0.33,0.00,0.67,0.00,1.00,0.00,1.00,0.33,1.00,0.67,1.00,1.00,0.67,1.00,0.33,1.00,0.00,1.00,0.00,0.67,0.00,0.33), $coords_min=0, $coords_max=1) {
<a name="l11499"></a>11499       $this-&gt;Clip($x, $y, $w, $h);        
<a name="l11500"></a>11500       $n = count($this-&gt;gradients) + 1;
<a name="l11501"></a>11501       $this-&gt;gradients[$n][<span class="stringliteral">&#39;type&#39;</span>] = 6; <span class="comment">//coons patch mesh</span>
<a name="l11502"></a>11502       <span class="comment">//check the coords array if it is the simple array or the multi patch array</span>
<a name="l11503"></a>11503       <span class="keywordflow">if</span> (!isset($coords[0][<span class="charliteral">&#39;f&#39;</span>])) {
<a name="l11504"></a>11504         <span class="comment">//simple array -&gt; convert to multi patch array</span>
<a name="l11505"></a>11505         <span class="keywordflow">if</span> (!isset($col1[1])) {
<a name="l11506"></a>11506           $col1[1] = $col1[2] = $col1[0];
<a name="l11507"></a>11507         }
<a name="l11508"></a>11508         <span class="keywordflow">if</span> (!isset($col2[1])) {
<a name="l11509"></a>11509           $col2[1] = $col2[2] = $col2[0];
<a name="l11510"></a>11510         }
<a name="l11511"></a>11511         <span class="keywordflow">if</span> (!isset($col3[1])) {
<a name="l11512"></a>11512           $col3[1] = $col3[2] = $col3[0];
<a name="l11513"></a>11513         }
<a name="l11514"></a>11514         <span class="keywordflow">if</span> (!isset($col4[1])) {
<a name="l11515"></a>11515           $col4[1] = $col4[2] = $col4[0];
<a name="l11516"></a>11516         }
<a name="l11517"></a>11517         $patch_array[0][<span class="charliteral">&#39;f&#39;</span>] = 0;
<a name="l11518"></a>11518         $patch_array[0][<span class="stringliteral">&#39;points&#39;</span>] = $coords;
<a name="l11519"></a>11519         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][0][<span class="charliteral">&#39;r&#39;</span>] = $col1[0];
<a name="l11520"></a>11520         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][0][<span class="charliteral">&#39;g&#39;</span>] = $col1[1];
<a name="l11521"></a>11521         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][0][<span class="charliteral">&#39;b&#39;</span>] = $col1[2];
<a name="l11522"></a>11522         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][1][<span class="charliteral">&#39;r&#39;</span>] = $col2[0];
<a name="l11523"></a>11523         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][1][<span class="charliteral">&#39;g&#39;</span>] = $col2[1];
<a name="l11524"></a>11524         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][1][<span class="charliteral">&#39;b&#39;</span>] = $col2[2];
<a name="l11525"></a>11525         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][2][<span class="charliteral">&#39;r&#39;</span>] = $col3[0];
<a name="l11526"></a>11526         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][2][<span class="charliteral">&#39;g&#39;</span>] = $col3[1];
<a name="l11527"></a>11527         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][2][<span class="charliteral">&#39;b&#39;</span>] = $col3[2];
<a name="l11528"></a>11528         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][3][<span class="charliteral">&#39;r&#39;</span>] = $col4[0];
<a name="l11529"></a>11529         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][3][<span class="charliteral">&#39;g&#39;</span>] = $col4[1];
<a name="l11530"></a>11530         $patch_array[0][<span class="stringliteral">&#39;colors&#39;</span>][3][<span class="charliteral">&#39;b&#39;</span>] = $col4[2];
<a name="l11531"></a>11531       } <span class="keywordflow">else</span> {
<a name="l11532"></a>11532         <span class="comment">//multi patch array</span>
<a name="l11533"></a>11533         $patch_array = $coords;
<a name="l11534"></a>11534       }
<a name="l11535"></a>11535       $bpcd = 65535; <span class="comment">//16 BitsPerCoordinate</span>
<a name="l11536"></a>11536       <span class="comment">//build the data stream</span>
<a name="l11537"></a>11537       $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l11538"></a>11538       $count_patch = count($patch_array);
<a name="l11539"></a>11539       <span class="keywordflow">for</span> ($i=0; $i &lt; $count_patch; ++$i) {
<a name="l11540"></a>11540         $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] .= chr($patch_array[$i][<span class="charliteral">&#39;f&#39;</span>]); <span class="comment">//start with the edge flag as 8 bit</span>
<a name="l11541"></a>11541         $count_points = count($patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>]);
<a name="l11542"></a>11542         <span class="keywordflow">for</span> ($j=0; $j &lt; $count_points; ++$j) {
<a name="l11543"></a>11543           <span class="comment">//each point as 16 bit</span>
<a name="l11544"></a>11544           $patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] = (($patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] - $coords_min) / ($coords_max - $coords_min)) * $bpcd;
<a name="l11545"></a>11545           <span class="keywordflow">if</span> ($patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] &lt; 0) {
<a name="l11546"></a>11546             $patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] = 0;
<a name="l11547"></a>11547           }
<a name="l11548"></a>11548           <span class="keywordflow">if</span> ($patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] &gt; $bpcd) {
<a name="l11549"></a>11549             $patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] = $bpcd;
<a name="l11550"></a>11550           }
<a name="l11551"></a>11551           $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] .= chr(floor($patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] / 256));
<a name="l11552"></a>11552           $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] .= chr(floor($patch_array[$i][<span class="stringliteral">&#39;points&#39;</span>][$j] % 256));
<a name="l11553"></a>11553         }
<a name="l11554"></a>11554         $count_cols = count($patch_array[$i][<span class="stringliteral">&#39;colors&#39;</span>]);
<a name="l11555"></a>11555         <span class="keywordflow">for</span> ($j=0; $j &lt; $count_cols; ++$j) {
<a name="l11556"></a>11556           <span class="comment">//each color component as 8 bit</span>
<a name="l11557"></a>11557           $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] .= chr($patch_array[$i][<span class="stringliteral">&#39;colors&#39;</span>][$j][<span class="charliteral">&#39;r&#39;</span>]);
<a name="l11558"></a>11558           $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] .= chr($patch_array[$i][<span class="stringliteral">&#39;colors&#39;</span>][$j][<span class="charliteral">&#39;g&#39;</span>]);
<a name="l11559"></a>11559           $this-&gt;gradients[$n][<span class="stringliteral">&#39;stream&#39;</span>] .= chr($patch_array[$i][<span class="stringliteral">&#39;colors&#39;</span>][$j][<span class="charliteral">&#39;b&#39;</span>]);
<a name="l11560"></a>11560         }
<a name="l11561"></a>11561       }
<a name="l11562"></a>11562       <span class="comment">//paint the gradient</span>
<a name="l11563"></a>11563       $this-&gt;_out(<span class="stringliteral">&#39;/Sh&#39;</span>.$n.<span class="stringliteral">&#39; sh&#39;</span>);
<a name="l11564"></a>11564       <span class="comment">//restore previous Graphic State</span>
<a name="l11565"></a>11565       $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l11566"></a>11566     }
<a name="l11567"></a>11567     
<a name="l11578"></a>11578     <span class="keyword">protected</span> function Clip($x, $y, $w, $h) {
<a name="l11579"></a>11579       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l11580"></a>11580         $x = $this-&gt;w - $x - $w;
<a name="l11581"></a>11581       }
<a name="l11582"></a>11582       <span class="comment">//save current Graphic State</span>
<a name="l11583"></a>11583       $s = <span class="charliteral">&#39;q&#39;</span>;
<a name="l11584"></a>11584       <span class="comment">//set clipping area</span>
<a name="l11585"></a>11585       $s .= sprintf(<span class="stringliteral">&#39; %.2F %.2F %.2F %.2F re W n&#39;</span>, $x*$this-&gt;k, ($this-&gt;h-$y)*$this-&gt;k, $w*$this-&gt;k, -$h*$this-&gt;k);
<a name="l11586"></a>11586       <span class="comment">//set up transformation matrix for gradient</span>
<a name="l11587"></a>11587       $s .= sprintf(<span class="stringliteral">&#39; %.3F 0 0 %.3F %.3F %.3F cm&#39;</span>, $w*$this-&gt;k, $h*$this-&gt;k, $x*$this-&gt;k, ($this-&gt;h-($y+$h))*$this-&gt;k);
<a name="l11588"></a>11588       $this-&gt;_out($s);
<a name="l11589"></a>11589     }
<a name="l11590"></a>11590         
<a name="l11601"></a>11601     <span class="keyword">protected</span> function Gradient($type, $col1, $col2, $coords) {
<a name="l11602"></a>11602       $n = count($this-&gt;gradients) + 1;
<a name="l11603"></a>11603       $this-&gt;gradients[$n][<span class="stringliteral">&#39;type&#39;</span>] = $type;
<a name="l11604"></a>11604       <span class="keywordflow">if</span> (!isset($col1[1])) {
<a name="l11605"></a>11605         $col1[1]=$col1[2]=$col1[0];
<a name="l11606"></a>11606       }
<a name="l11607"></a>11607       $this-&gt;gradients[$n][<span class="stringliteral">&#39;col1&#39;</span>] = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F&#39;</span>, ($col1[0]/255), ($col1[1]/255), ($col1[2]/255));
<a name="l11608"></a>11608       <span class="keywordflow">if</span> (!isset($col2[1])) {
<a name="l11609"></a>11609         $col2[1] = $col2[2] = $col2[0];
<a name="l11610"></a>11610       }
<a name="l11611"></a>11611       $this-&gt;gradients[$n][<span class="stringliteral">&#39;col2&#39;</span>] = sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F&#39;</span>, ($col2[0]/255), ($col2[1]/255), ($col2[2]/255));
<a name="l11612"></a>11612       $this-&gt;gradients[$n][<span class="stringliteral">&#39;coords&#39;</span>] = $coords;
<a name="l11613"></a>11613       <span class="comment">//paint the gradient</span>
<a name="l11614"></a>11614       $this-&gt;_out(<span class="stringliteral">&#39;/Sh&#39;</span>.$n.<span class="stringliteral">&#39; sh&#39;</span>);
<a name="l11615"></a>11615       <span class="comment">//restore previous Graphic State</span>
<a name="l11616"></a>11616       $this-&gt;_out(<span class="charliteral">&#39;Q&#39;</span>);
<a name="l11617"></a>11617     }
<a name="l11618"></a>11618     
<a name="l11625"></a>11625     function _putshaders() {
<a name="l11626"></a>11626       <span class="keywordflow">foreach</span> ($this-&gt;gradients as $id =&gt; $grad) {  
<a name="l11627"></a>11627         <span class="keywordflow">if</span> (($grad[<span class="stringliteral">&#39;type&#39;</span>] == 2) OR ($grad[<span class="stringliteral">&#39;type&#39;</span>] == 3)) {
<a name="l11628"></a>11628           $this-&gt;_newobj();
<a name="l11629"></a>11629           $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l11630"></a>11630           $this-&gt;_out(<span class="stringliteral">&#39;/FunctionType 2&#39;</span>);
<a name="l11631"></a>11631           $this-&gt;_out(<span class="stringliteral">&#39;/Domain [0.0 1.0]&#39;</span>);
<a name="l11632"></a>11632           $this-&gt;_out(<span class="stringliteral">&#39;/C0 [&#39;</span>.$grad[<span class="stringliteral">&#39;col1&#39;</span>].<span class="charliteral">&#39;]&#39;</span>);
<a name="l11633"></a>11633           $this-&gt;_out(<span class="stringliteral">&#39;/C1 [&#39;</span>.$grad[<span class="stringliteral">&#39;col2&#39;</span>].<span class="charliteral">&#39;]&#39;</span>);
<a name="l11634"></a>11634           $this-&gt;_out(<span class="stringliteral">&#39;/N 1&#39;</span>);
<a name="l11635"></a>11635           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11636"></a>11636           $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l11637"></a>11637           $f1 = $this-&gt;n;
<a name="l11638"></a>11638         }
<a name="l11639"></a>11639         $this-&gt;_newobj();
<a name="l11640"></a>11640         $this-&gt;_out(<span class="stringliteral">&#39;&lt;&lt;&#39;</span>);
<a name="l11641"></a>11641         $this-&gt;_out(<span class="stringliteral">&#39;/ShadingType &#39;</span>.$grad[<span class="stringliteral">&#39;type&#39;</span>]);
<a name="l11642"></a>11642         $this-&gt;_out(<span class="stringliteral">&#39;/ColorSpace /DeviceRGB&#39;</span>);
<a name="l11643"></a>11643         <span class="keywordflow">if</span> ($grad[<span class="stringliteral">&#39;type&#39;</span>] == 2) {
<a name="l11644"></a>11644           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/Coords [%.3F %.3F %.3F %.3F]&#39;</span>, $grad[<span class="stringliteral">&#39;coords&#39;</span>][0], $grad[<span class="stringliteral">&#39;coords&#39;</span>][1], $grad[<span class="stringliteral">&#39;coords&#39;</span>][2], $grad[<span class="stringliteral">&#39;coords&#39;</span>][3]));
<a name="l11645"></a>11645           $this-&gt;_out(<span class="stringliteral">&#39;/Function &#39;</span>.$f1.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l11646"></a>11646           $this-&gt;_out(<span class="stringliteral">&#39;/Extend [true true] &#39;</span>);
<a name="l11647"></a>11647           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11648"></a>11648         } elseif ($grad[<span class="stringliteral">&#39;type&#39;</span>] == 3) {
<a name="l11649"></a>11649           <span class="comment">//x0, y0, r0, x1, y1, r1</span>
<a name="l11650"></a>11650           <span class="comment">//at this this time radius of inner circle is 0</span>
<a name="l11651"></a>11651           $this-&gt;_out(sprintf(<span class="stringliteral">&#39;/Coords [%.3F %.3F 0 %.3F %.3F %.3F]&#39;</span>, $grad[<span class="stringliteral">&#39;coords&#39;</span>][0], $grad[<span class="stringliteral">&#39;coords&#39;</span>][1], $grad[<span class="stringliteral">&#39;coords&#39;</span>][2], $grad[<span class="stringliteral">&#39;coords&#39;</span>][3], $grad[<span class="stringliteral">&#39;coords&#39;</span>][4]));
<a name="l11652"></a>11652           $this-&gt;_out(<span class="stringliteral">&#39;/Function &#39;</span>.$f1.<span class="stringliteral">&#39; 0 R&#39;</span>);
<a name="l11653"></a>11653           $this-&gt;_out(<span class="stringliteral">&#39;/Extend [true true] &#39;</span>);
<a name="l11654"></a>11654           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11655"></a>11655         } elseif ($grad[<span class="stringliteral">&#39;type&#39;</span>] == 6) {
<a name="l11656"></a>11656           $this-&gt;_out(<span class="stringliteral">&#39;/BitsPerCoordinate 16&#39;</span>);
<a name="l11657"></a>11657           $this-&gt;_out(<span class="stringliteral">&#39;/BitsPerComponent 8&#39;</span>);
<a name="l11658"></a>11658           $this-&gt;_out(<span class="stringliteral">&#39;/Decode[0 1 0 1 0 1 0 1 0 1]&#39;</span>);
<a name="l11659"></a>11659           $this-&gt;_out(<span class="stringliteral">&#39;/BitsPerFlag 8&#39;</span>);
<a name="l11660"></a>11660           $this-&gt;_out(<span class="stringliteral">&#39;/Length &#39;</span>.strlen($grad[<span class="stringliteral">&#39;stream&#39;</span>]));
<a name="l11661"></a>11661           $this-&gt;_out(<span class="stringliteral">&#39;&gt;&gt;&#39;</span>);
<a name="l11662"></a>11662           $this-&gt;_putstream($grad[<span class="stringliteral">&#39;stream&#39;</span>]);
<a name="l11663"></a>11663         }
<a name="l11664"></a>11664         $this-&gt;_out(<span class="stringliteral">&#39;endobj&#39;</span>);
<a name="l11665"></a>11665         $this-&gt;gradients[$id][<span class="stringliteral">&#39;id&#39;</span>] = $this-&gt;n;
<a name="l11666"></a>11666       }
<a name="l11667"></a>11667     }
<a name="l11668"></a>11668 
<a name="l11675"></a>11675     <span class="keyword">protected</span> function _outarc($x1, $y1, $x2, $y2, $x3, $y3 ) {
<a name="l11676"></a>11676       $h = $this-&gt;h;
<a name="l11677"></a>11677       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.2F %.2F %.2F %.2F %.2F %.2F c&#39;</span>, $x1*$this-&gt;k, ($h-$y1)*$this-&gt;k, $x2*$this-&gt;k, ($h-$y2)*$this-&gt;k, $x3*$this-&gt;k, ($h-$y3)*$this-&gt;k));
<a name="l11678"></a>11678     }
<a name="l11679"></a>11679     
<a name="l11695"></a>11695     <span class="keyword">public</span> function PieSector($xc, $yc, $r, $a, $b, $style=<span class="stringliteral">&#39;FD&#39;</span>, $cw=<span class="keyword">true</span>, $o=90) {
<a name="l11696"></a>11696       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l11697"></a>11697         $xc = $this-&gt;w - $xc;
<a name="l11698"></a>11698       }
<a name="l11699"></a>11699       <span class="keywordflow">if</span> ($cw) {
<a name="l11700"></a>11700         $d = $b;
<a name="l11701"></a>11701         $b = $o - $a;
<a name="l11702"></a>11702         $a = $o - $d;
<a name="l11703"></a>11703       } <span class="keywordflow">else</span> {
<a name="l11704"></a>11704         $b += $o;
<a name="l11705"></a>11705         $a += $o;
<a name="l11706"></a>11706       }
<a name="l11707"></a>11707       $a = ($a % 360) + 360;
<a name="l11708"></a>11708       $b = ($b % 360) + 360;
<a name="l11709"></a>11709       <span class="keywordflow">if</span> ($a &gt; $b) {
<a name="l11710"></a>11710         $b +=360;
<a name="l11711"></a>11711       }
<a name="l11712"></a>11712       $b = $b / 360 * 2 * M_PI;
<a name="l11713"></a>11713       $a = $a / 360 * 2 * M_PI;
<a name="l11714"></a>11714       $d = $b - $a;
<a name="l11715"></a>11715       <span class="keywordflow">if</span> ($d == 0 ) {
<a name="l11716"></a>11716         $d = 2 * M_PI;
<a name="l11717"></a>11717       }
<a name="l11718"></a>11718       $k = $this-&gt;k;
<a name="l11719"></a>11719       $hp = $this-&gt;h;
<a name="l11720"></a>11720       <span class="keywordflow">if</span> ($style==<span class="charliteral">&#39;F&#39;</span>) {
<a name="l11721"></a>11721         $op = <span class="charliteral">&#39;f&#39;</span>;
<a name="l11722"></a>11722       } elseif ($style==<span class="stringliteral">&#39;FD&#39;</span> or $style==<span class="stringliteral">&#39;DF&#39;</span>) {
<a name="l11723"></a>11723         $op = <span class="charliteral">&#39;b&#39;</span>;
<a name="l11724"></a>11724       } <span class="keywordflow">else</span> {
<a name="l11725"></a>11725         $op = <span class="charliteral">&#39;s&#39;</span>;
<a name="l11726"></a>11726       }
<a name="l11727"></a>11727       <span class="keywordflow">if</span> (sin($d/2)) {
<a name="l11728"></a>11728         $MyArc = 4/3 * (1 - cos($d/2)) / sin($d/2) * $r;
<a name="l11729"></a>11729       }
<a name="l11730"></a>11730       <span class="comment">//first put the center</span>
<a name="l11731"></a>11731       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.2F %.2F m&#39;</span>, ($xc)*$k, ($hp-$yc)*$k));
<a name="l11732"></a>11732       <span class="comment">//put the first point</span>
<a name="l11733"></a>11733       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.2F %.2F l&#39;</span>, ($xc+$r*cos($a))*$k, (($hp-($yc-$r*sin($a)))*$k)));
<a name="l11734"></a>11734       <span class="comment">//draw the arc</span>
<a name="l11735"></a>11735       <span class="keywordflow">if</span> ($d &lt; (M_PI/2)) {
<a name="l11736"></a>11736         $this-&gt;_outarc($xc+$r*cos($a)+$MyArc*cos(M_PI/2+$a), $yc-$r*sin($a)-$MyArc*sin(M_PI/2+$a), $xc+$r*cos($b)+$MyArc*cos($b-M_PI/2), $yc-$r*sin($b)-$MyArc*sin($b-M_PI/2), $xc+$r*cos($b), $yc-$r*sin($b));
<a name="l11737"></a>11737       } <span class="keywordflow">else</span> {
<a name="l11738"></a>11738         $b = $a + $d/4;
<a name="l11739"></a>11739         $MyArc = 4/3*(1-cos($d/8))/sin($d/8)*$r;
<a name="l11740"></a>11740         $this-&gt;_outarc($xc+$r*cos($a)+$MyArc*cos(M_PI/2+$a), $yc-$r*sin($a)-$MyArc*sin(M_PI/2+$a), $xc+$r*cos($b)+$MyArc*cos($b-M_PI/2), $yc-$r*sin($b)-$MyArc*sin($b-M_PI/2), $xc+$r*cos($b), $yc-$r*sin($b));
<a name="l11741"></a>11741         $a = $b;
<a name="l11742"></a>11742         $b = $a + $d/4;
<a name="l11743"></a>11743         $this-&gt;_outarc($xc+$r*cos($a)+$MyArc*cos(M_PI/2+$a), $yc-$r*sin($a)-$MyArc*sin(M_PI/2+$a), $xc+$r*cos($b)+$MyArc*cos($b-M_PI/2), $yc-$r*sin($b)-$MyArc*sin($b-M_PI/2), $xc+$r*cos($b), $yc-$r*sin($b));
<a name="l11744"></a>11744         $a = $b;
<a name="l11745"></a>11745         $b = $a + $d/4;
<a name="l11746"></a>11746         $this-&gt;_outarc($xc+$r*cos($a)+$MyArc*cos(M_PI/2+$a), $yc-$r*sin($a)-$MyArc*sin(M_PI/2+$a), $xc+$r*cos($b)+$MyArc*cos($b-M_PI/2), $yc-$r*sin($b)-$MyArc*sin($b-M_PI/2), $xc+$r*cos($b), $yc-$r*sin($b) );
<a name="l11747"></a>11747         $a = $b;
<a name="l11748"></a>11748         $b = $a + $d/4;
<a name="l11749"></a>11749         $this-&gt;_outarc($xc+$r*cos($a)+$MyArc*cos(M_PI/2+$a), $yc-$r*sin($a)-$MyArc*sin(M_PI/2+$a), $xc+$r*cos($b)+$MyArc*cos($b-M_PI/2), $yc-$r*sin($b)-$MyArc*sin($b-M_PI/2), $xc+$r*cos($b), $yc-$r*sin($b));
<a name="l11750"></a>11750       }
<a name="l11751"></a>11751       <span class="comment">//terminate drawing</span>
<a name="l11752"></a>11752       $this-&gt;_out($op);
<a name="l11753"></a>11753     }
<a name="l11754"></a>11754     
<a name="l11773"></a>11773     <span class="keyword">public</span> function ImageEps($file, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $w=0, $h=0, $link=<span class="stringliteral">&#39;&#39;</span>, $useBoundingBox=<span class="keyword">true</span>, $align=<span class="stringliteral">&#39;&#39;</span>, $palign=<span class="stringliteral">&#39;&#39;</span>, $border=0) {
<a name="l11774"></a>11774       <span class="keywordflow">if</span> ($x === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l11775"></a>11775         $x = $this-&gt;x;
<a name="l11776"></a>11776       }
<a name="l11777"></a>11777       <span class="keywordflow">if</span> ($y === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l11778"></a>11778         $y = $this-&gt;y;
<a name="l11779"></a>11779       }
<a name="l11780"></a>11780       $k = $this-&gt;k;
<a name="l11781"></a>11781       $data = file_get_contents($file);
<a name="l11782"></a>11782       <span class="keywordflow">if</span> ($data === <span class="keyword">false</span>) {
<a name="l11783"></a>11783         $this-&gt;Error(<span class="stringliteral">&#39;EPS file not found: &#39;</span>.$file);
<a name="l11784"></a>11784       }
<a name="l11785"></a>11785       $regs = array();
<a name="l11786"></a>11786       <span class="comment">// EPS/AI compatibility check (only checks files created by Adobe Illustrator!)</span>
<a name="l11787"></a>11787       preg_match(<span class="stringliteral">&quot;/%%Creator:([^\r\n]+)/&quot;</span>, $data, $regs); # find Creator
<a name="l11788"></a>11788       <span class="keywordflow">if</span> (count($regs) &gt; 1) {
<a name="l11789"></a>11789         $version_str = trim($regs[1]); # e.g. <span class="stringliteral">&quot;Adobe Illustrator(R) 8.0&quot;</span>
<a name="l11790"></a>11790         <span class="keywordflow">if</span> (strpos($version_str, <span class="stringliteral">&#39;Adobe Illustrator&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l11791"></a>11791           $versexp = explode(<span class="charliteral">&#39; &#39;</span>, $version_str);
<a name="l11792"></a>11792           $version = (float)array_pop($versexp);
<a name="l11793"></a>11793           <span class="keywordflow">if</span> ($version &gt;= 9) {
<a name="l11794"></a>11794             $this-&gt;Error(<span class="stringliteral">&#39;This version of Adobe Illustrator file is not supported: &#39;</span>.$file);
<a name="l11795"></a>11795           }
<a name="l11796"></a>11796         }
<a name="l11797"></a>11797       }
<a name="l11798"></a>11798       <span class="comment">// strip binary bytes in front of PS-header</span>
<a name="l11799"></a>11799       $start = strpos($data, <span class="stringliteral">&#39;%!PS-Adobe&#39;</span>);
<a name="l11800"></a>11800       <span class="keywordflow">if</span> ($start &gt; 0) {
<a name="l11801"></a>11801         $data = substr($data, $start);
<a name="l11802"></a>11802       }
<a name="l11803"></a>11803       <span class="comment">// find BoundingBox params</span>
<a name="l11804"></a>11804       preg_match(<span class="stringliteral">&quot;/%%BoundingBox:([^\r\n]+)/&quot;</span>, $data, $regs);
<a name="l11805"></a>11805       <span class="keywordflow">if</span> (count($regs) &gt; 1) {
<a name="l11806"></a>11806         list($x1, $y1, $x2, $y2) = explode(<span class="charliteral">&#39; &#39;</span>, trim($regs[1]));
<a name="l11807"></a>11807       } <span class="keywordflow">else</span> {
<a name="l11808"></a>11808         $this-&gt;Error(<span class="stringliteral">&#39;No BoundingBox found in EPS file: &#39;</span>.$file);
<a name="l11809"></a>11809       }
<a name="l11810"></a>11810       $start = strpos($data, <span class="stringliteral">&#39;%%EndSetup&#39;</span>);
<a name="l11811"></a>11811       <span class="keywordflow">if</span> ($start === <span class="keyword">false</span>) {
<a name="l11812"></a>11812         $start = strpos($data, <span class="stringliteral">&#39;%%EndProlog&#39;</span>);
<a name="l11813"></a>11813       }
<a name="l11814"></a>11814       <span class="keywordflow">if</span> ($start === <span class="keyword">false</span>) {
<a name="l11815"></a>11815         $start = strpos($data, <span class="stringliteral">&#39;%%BoundingBox&#39;</span>);
<a name="l11816"></a>11816       }
<a name="l11817"></a>11817       $data = substr($data, $start);
<a name="l11818"></a>11818       $end = strpos($data, <span class="stringliteral">&#39;%%PageTrailer&#39;</span>);
<a name="l11819"></a>11819       <span class="keywordflow">if</span> ($end===<span class="keyword">false</span>) {
<a name="l11820"></a>11820         $end = strpos($data, <span class="stringliteral">&#39;showpage&#39;</span>);
<a name="l11821"></a>11821       }
<a name="l11822"></a>11822       <span class="keywordflow">if</span> ($end) {
<a name="l11823"></a>11823         $data = substr($data, 0, $end);
<a name="l11824"></a>11824       }
<a name="l11825"></a>11825       <span class="keywordflow">if</span> ($w &gt; 0) {
<a name="l11826"></a>11826         $scale_x = $w / (($x2 - $x1) / $k);
<a name="l11827"></a>11827         <span class="keywordflow">if</span> ($h &gt; 0) {
<a name="l11828"></a>11828           $scale_y = $h / (($y2 - $y1) / $k);
<a name="l11829"></a>11829         } <span class="keywordflow">else</span> {
<a name="l11830"></a>11830           $scale_y = $scale_x;
<a name="l11831"></a>11831           $h = ($y2 - $y1) / $k * $scale_y;
<a name="l11832"></a>11832         }
<a name="l11833"></a>11833       } <span class="keywordflow">else</span> {
<a name="l11834"></a>11834         <span class="keywordflow">if</span> ($h &gt; 0) {
<a name="l11835"></a>11835           $scale_y = $h / (($y2 - $y1) / $k);
<a name="l11836"></a>11836           $scale_x = $scale_y;
<a name="l11837"></a>11837           $w = ($x2-$x1) / $k * $scale_x;
<a name="l11838"></a>11838         } <span class="keywordflow">else</span> {
<a name="l11839"></a>11839           $w = ($x2 - $x1) / $k;
<a name="l11840"></a>11840           $h = ($y2 - $y1) / $k;
<a name="l11841"></a>11841         }
<a name="l11842"></a>11842       }
<a name="l11843"></a>11843       <span class="comment">// Check whether we need a new page first as this does not fit</span>
<a name="l11844"></a>11844       <span class="keywordflow">if</span> ($this-&gt;checkPageBreak($h, $y)) {
<a name="l11845"></a>11845         $y = $this-&gt;GetY() + $this-&gt;cMargin;
<a name="l11846"></a>11846       }
<a name="l11847"></a>11847       <span class="comment">// set bottomcoordinates</span>
<a name="l11848"></a>11848       $this-&gt;img_rb_y = $y + $h;
<a name="l11849"></a>11849       <span class="comment">// set alignment</span>
<a name="l11850"></a>11850       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l11851"></a>11851         <span class="keywordflow">if</span> ($palign == <span class="charliteral">&#39;L&#39;</span>) {
<a name="l11852"></a>11852           $ximg = $this-&gt;lMargin;
<a name="l11853"></a>11853           <span class="comment">// set right side coordinate</span>
<a name="l11854"></a>11854           $this-&gt;img_rb_x = $ximg + $w;
<a name="l11855"></a>11855         } elseif ($palign == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l11856"></a>11856           $ximg = ($this-&gt;w - $x - $w) / 2;
<a name="l11857"></a>11857           <span class="comment">// set right side coordinate</span>
<a name="l11858"></a>11858           $this-&gt;img_rb_x = $ximg + $w;
<a name="l11859"></a>11859         } <span class="keywordflow">else</span> {
<a name="l11860"></a>11860           $ximg = $this-&gt;w - $x - $w;
<a name="l11861"></a>11861           <span class="comment">// set left side coordinate</span>
<a name="l11862"></a>11862           $this-&gt;img_rb_x = $ximg;
<a name="l11863"></a>11863         }
<a name="l11864"></a>11864       } <span class="keywordflow">else</span> {
<a name="l11865"></a>11865         <span class="keywordflow">if</span> ($palign == <span class="charliteral">&#39;R&#39;</span>) {
<a name="l11866"></a>11866           $ximg = $this-&gt;w - $this-&gt;rMargin - $w;
<a name="l11867"></a>11867           <span class="comment">// set left side coordinate</span>
<a name="l11868"></a>11868           $this-&gt;img_rb_x = $ximg;
<a name="l11869"></a>11869         } elseif ($palign == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l11870"></a>11870           $ximg = ($this-&gt;w - $x - $w) / 2;
<a name="l11871"></a>11871           <span class="comment">// set right side coordinate</span>
<a name="l11872"></a>11872           $this-&gt;img_rb_x = $ximg + $w;
<a name="l11873"></a>11873         } <span class="keywordflow">else</span> {
<a name="l11874"></a>11874           $ximg = $x;
<a name="l11875"></a>11875           <span class="comment">// set right side coordinate</span>
<a name="l11876"></a>11876           $this-&gt;img_rb_x = $ximg + $w;
<a name="l11877"></a>11877         }
<a name="l11878"></a>11878       }
<a name="l11879"></a>11879       <span class="keywordflow">if</span> ($useBoundingBox) {
<a name="l11880"></a>11880         $dx = $ximg * $k - $x1;
<a name="l11881"></a>11881         $dy = $y * $k - $y1;
<a name="l11882"></a>11882       } <span class="keywordflow">else</span> {
<a name="l11883"></a>11883         $dx = $ximg * $k;
<a name="l11884"></a>11884         $dy = $y * $k;
<a name="l11885"></a>11885       }
<a name="l11886"></a>11886       <span class="comment">// save the current graphic state</span>
<a name="l11887"></a>11887       $this-&gt;_out(<span class="charliteral">&#39;q&#39;</span>.$this-&gt;epsmarker);
<a name="l11888"></a>11888       <span class="comment">// translate</span>
<a name="l11889"></a>11889       $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F %.3F %.3F %.3F cm&#39;</span>, 1, 0, 0, 1, $dx, $dy + ($this-&gt;hPt - (2 * $y * $k) - ($y2 - $y1))));
<a name="l11890"></a>11890       <span class="comment">// scale</span>
<a name="l11891"></a>11891       <span class="keywordflow">if</span> (isset($scale_x)) {
<a name="l11892"></a>11892         $this-&gt;_out(sprintf(<span class="stringliteral">&#39;%.3F %.3F %.3F %.3F %.3F %.3F cm&#39;</span>, $scale_x, 0, 0, $scale_y, $x1 * (1 - $scale_x), $y2 * (1 - $scale_y)));
<a name="l11893"></a>11893       }
<a name="l11894"></a>11894       <span class="comment">// handle pc/unix/mac line endings</span>
<a name="l11895"></a>11895       preg_match(<span class="stringliteral">&#39;/[\r\n]+/s&#39;</span>, $data, $regs);
<a name="l11896"></a>11896       $lines = explode($regs[0], $data);
<a name="l11897"></a>11897       $u=0;
<a name="l11898"></a>11898       $cnt = count($lines);
<a name="l11899"></a>11899       <span class="keywordflow">for</span> ($i=0; $i &lt; $cnt; ++$i) {
<a name="l11900"></a>11900         $line = $lines[$i];
<a name="l11901"></a>11901         <span class="keywordflow">if</span> (($line == <span class="stringliteral">&#39;&#39;</span>) OR ($line{0} == <span class="charliteral">&#39;%&#39;</span>)) {
<a name="l11902"></a>11902           <span class="keywordflow">continue</span>;
<a name="l11903"></a>11903         }
<a name="l11904"></a>11904         $len = strlen($line);
<a name="l11905"></a>11905         $chunks = explode(<span class="charliteral">&#39; &#39;</span>, $line);
<a name="l11906"></a>11906         $cmd = array_pop($chunks);
<a name="l11907"></a>11907         <span class="comment">// RGB</span>
<a name="l11908"></a>11908         <span class="keywordflow">if</span> (($cmd == <span class="stringliteral">&#39;Xa&#39;</span>) OR ($cmd == <span class="stringliteral">&#39;XA&#39;</span>)) {
<a name="l11909"></a>11909           $b = array_pop($chunks); 
<a name="l11910"></a>11910           $g = array_pop($chunks); 
<a name="l11911"></a>11911           $r = array_pop($chunks);
<a name="l11912"></a>11912           $this-&gt;_out(<span class="stringliteral">&#39;&#39;</span>.$r.<span class="charliteral">&#39; &#39;</span>.$g.<span class="charliteral">&#39; &#39;</span>.$b.<span class="charliteral">&#39; &#39;</span>.($cmd==<span class="stringliteral">&#39;Xa&#39;</span>?<span class="stringliteral">&#39;rg&#39;</span>:<span class="stringliteral">&#39;RG&#39;</span>)); <span class="comment">//substr($line, 0, -2).&#39;rg&#39; -&gt; in EPS (AI8): c m y k r g b rg!</span>
<a name="l11913"></a>11913           <span class="keywordflow">continue</span>;
<a name="l11914"></a>11914         }
<a name="l11915"></a>11915         <span class="keywordflow">switch</span> ($cmd) {
<a name="l11916"></a>11916           <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:
<a name="l11917"></a>11917           <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:
<a name="l11918"></a>11918           <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:
<a name="l11919"></a>11919           <span class="keywordflow">case</span> <span class="charliteral">&#39;y&#39;</span>:
<a name="l11920"></a>11920           <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:
<a name="l11921"></a>11921           <span class="keywordflow">case</span> <span class="charliteral">&#39;k&#39;</span>:
<a name="l11922"></a>11922           <span class="keywordflow">case</span> <span class="charliteral">&#39;K&#39;</span>:
<a name="l11923"></a>11923           <span class="keywordflow">case</span> <span class="charliteral">&#39;g&#39;</span>:
<a name="l11924"></a>11924           <span class="keywordflow">case</span> <span class="charliteral">&#39;G&#39;</span>:
<a name="l11925"></a>11925           <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
<a name="l11926"></a>11926           <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:
<a name="l11927"></a>11927           <span class="keywordflow">case</span> <span class="charliteral">&#39;J&#39;</span>:
<a name="l11928"></a>11928           <span class="keywordflow">case</span> <span class="charliteral">&#39;j&#39;</span>:
<a name="l11929"></a>11929           <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span>:
<a name="l11930"></a>11930           <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:
<a name="l11931"></a>11931           <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:
<a name="l11932"></a>11932           <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:
<a name="l11933"></a>11933           <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>: {
<a name="l11934"></a>11934             $this-&gt;_out($line);
<a name="l11935"></a>11935             <span class="keywordflow">break</span>;
<a name="l11936"></a>11936           }
<a name="l11937"></a>11937           <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>: {<span class="comment">// custom fill color</span>
<a name="l11938"></a>11938             list($c,$m,$y,$k) = $chunks;
<a name="l11939"></a>11939             $this-&gt;_out(<span class="stringliteral">&#39;&#39;</span>.$c.<span class="charliteral">&#39; &#39;</span>.$m.<span class="charliteral">&#39; &#39;</span>.$y.<span class="charliteral">&#39; &#39;</span>.$k.<span class="stringliteral">&#39; k&#39;</span>);
<a name="l11940"></a>11940             <span class="keywordflow">break</span>;
<a name="l11941"></a>11941           }
<a name="l11942"></a>11942           <span class="keywordflow">case</span> <span class="charliteral">&#39;X&#39;</span>: { <span class="comment">// custom stroke color</span>
<a name="l11943"></a>11943             list($c,$m,$y,$k) = $chunks;
<a name="l11944"></a>11944             $this-&gt;_out(<span class="stringliteral">&#39;&#39;</span>.$c.<span class="charliteral">&#39; &#39;</span>.$m.<span class="charliteral">&#39; &#39;</span>.$y.<span class="charliteral">&#39; &#39;</span>.$k.<span class="stringliteral">&#39; K&#39;</span>);
<a name="l11945"></a>11945             <span class="keywordflow">break</span>;
<a name="l11946"></a>11946           }
<a name="l11947"></a>11947           <span class="keywordflow">case</span> <span class="charliteral">&#39;Y&#39;</span>:
<a name="l11948"></a>11948           <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:
<a name="l11949"></a>11949           <span class="keywordflow">case</span> <span class="charliteral">&#39;V&#39;</span>:
<a name="l11950"></a>11950           <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:
<a name="l11951"></a>11951           <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>: {
<a name="l11952"></a>11952             $line{$len-1} = strtolower($cmd);
<a name="l11953"></a>11953             $this-&gt;_out($line);
<a name="l11954"></a>11954             <span class="keywordflow">break</span>;
<a name="l11955"></a>11955           }
<a name="l11956"></a>11956           <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:
<a name="l11957"></a>11957           <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>: {
<a name="l11958"></a>11958             $this-&gt;_out($cmd . <span class="charliteral">&#39;*&#39;</span>);
<a name="l11959"></a>11959             <span class="keywordflow">break</span>;
<a name="l11960"></a>11960           }
<a name="l11961"></a>11961           <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:
<a name="l11962"></a>11962           <span class="keywordflow">case</span> <span class="charliteral">&#39;F&#39;</span>: {
<a name="l11963"></a>11963             <span class="keywordflow">if</span> ($u &gt; 0) {
<a name="l11964"></a>11964               $isU = <span class="keyword">false</span>;
<a name="l11965"></a>11965               $max = min($i+5, $cnt);
<a name="l11966"></a>11966               <span class="keywordflow">for</span> ($j=$i+1; $j &lt; $max; ++$j)
<a name="l11967"></a>11967                 $isU = ($isU OR (($lines[$j] == <span class="charliteral">&#39;U&#39;</span>) OR ($lines[$j] == <span class="stringliteral">&#39;*U&#39;</span>)));
<a name="l11968"></a>11968               <span class="keywordflow">if</span> ($isU) {
<a name="l11969"></a>11969                 $this-&gt;_out(<span class="stringliteral">&#39;f*&#39;</span>);
<a name="l11970"></a>11970               }
<a name="l11971"></a>11971             } <span class="keywordflow">else</span> {
<a name="l11972"></a>11972               $this-&gt;_out(<span class="stringliteral">&#39;f*&#39;</span>);
<a name="l11973"></a>11973             }
<a name="l11974"></a>11974             <span class="keywordflow">break</span>;
<a name="l11975"></a>11975           }
<a name="l11976"></a>11976           <span class="keywordflow">case</span> <span class="stringliteral">&#39;*u&#39;</span>: {
<a name="l11977"></a>11977             ++$u;
<a name="l11978"></a>11978             <span class="keywordflow">break</span>;
<a name="l11979"></a>11979           }
<a name="l11980"></a>11980           <span class="keywordflow">case</span> <span class="stringliteral">&#39;*U&#39;</span>: {
<a name="l11981"></a>11981             --$u;
<a name="l11982"></a>11982             <span class="keywordflow">break</span>;
<a name="l11983"></a>11983           }
<a name="l11984"></a>11984         }
<a name="l11985"></a>11985       }
<a name="l11986"></a>11986       <span class="comment">// restore previous graphic state</span>
<a name="l11987"></a>11987       $this-&gt;_out($this-&gt;epsmarker.<span class="charliteral">&#39;Q&#39;</span>);
<a name="l11988"></a>11988       <span class="keywordflow">if</span> (!empty($border)) {
<a name="l11989"></a>11989         $bx = $x;
<a name="l11990"></a>11990         $by = $y;
<a name="l11991"></a>11991         $this-&gt;x = $x;
<a name="l11992"></a>11992         $this-&gt;y = $y;
<a name="l11993"></a>11993         $this-&gt;Cell($w, $h, <span class="stringliteral">&#39;&#39;</span>, $border, 0, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, 0);
<a name="l11994"></a>11994         $this-&gt;x = $bx;
<a name="l11995"></a>11995         $this-&gt;y = $by;
<a name="l11996"></a>11996       }
<a name="l11997"></a>11997       <span class="keywordflow">if</span> ($link) {
<a name="l11998"></a>11998         $this-&gt;Link($ximg, $y, $w, $h, $link, 0);
<a name="l11999"></a>11999       }
<a name="l12000"></a>12000       <span class="comment">// set pointer to align the successive text/objects</span>
<a name="l12001"></a>12001       <span class="keywordflow">switch</span>($align) {
<a name="l12002"></a>12002         <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:{
<a name="l12003"></a>12003           $this-&gt;y = $y;
<a name="l12004"></a>12004           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12005"></a>12005           <span class="keywordflow">break</span>;
<a name="l12006"></a>12006         }
<a name="l12007"></a>12007         <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:{
<a name="l12008"></a>12008           $this-&gt;y = $y + round($h/2);
<a name="l12009"></a>12009           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12010"></a>12010           <span class="keywordflow">break</span>;
<a name="l12011"></a>12011         }
<a name="l12012"></a>12012         <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:{
<a name="l12013"></a>12013           $this-&gt;y = $this-&gt;img_rb_y;
<a name="l12014"></a>12014           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12015"></a>12015           <span class="keywordflow">break</span>;
<a name="l12016"></a>12016         }
<a name="l12017"></a>12017         <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:{
<a name="l12018"></a>12018           $this-&gt;SetY($this-&gt;img_rb_y);
<a name="l12019"></a>12019           <span class="keywordflow">break</span>;
<a name="l12020"></a>12020         }
<a name="l12021"></a>12021         <span class="keywordflow">default</span>:{
<a name="l12022"></a>12022           <span class="keywordflow">break</span>;
<a name="l12023"></a>12023         }
<a name="l12024"></a>12024       }
<a name="l12025"></a>12025       $this-&gt;endlinex = $this-&gt;img_rb_x;
<a name="l12026"></a>12026     }
<a name="l12027"></a>12027     
<a name="l12033"></a>12033     <span class="keyword">public</span> function setBarcode($bc=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l12034"></a>12034       $this-&gt;barcode = $bc;
<a name="l12035"></a>12035     }
<a name="l12036"></a>12036     
<a name="l12043"></a>12043     <span class="keyword">public</span> function getBarcode() {
<a name="l12044"></a>12044       <span class="keywordflow">return</span> $this-&gt;barcode;
<a name="l12045"></a>12045     }
<a name="l12046"></a>12046     
<a name="l12062"></a>12062     <span class="keyword">public</span> function write1DBarcode($code, $type, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $w=<span class="stringliteral">&#39;&#39;</span>, $h=<span class="stringliteral">&#39;&#39;</span>, $xres=0.4, $style=<span class="stringliteral">&#39;&#39;</span>, $align=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l12063"></a>12063       <span class="keywordflow">if</span> ($this-&gt;empty_string($code)) {
<a name="l12064"></a>12064         <span class="keywordflow">return</span>;
<a name="l12065"></a>12065       }
<a name="l12066"></a>12066       require_once(dirname(__FILE__).<span class="stringliteral">&#39;/barcodes.php&#39;</span>);
<a name="l12067"></a>12067       <span class="comment">// save current graphic settings</span>
<a name="l12068"></a>12068       $gvars = $this-&gt;getGraphicVars();
<a name="l12069"></a>12069       <span class="comment">// create new barcode object</span>
<a name="l12070"></a>12070       $barcodeobj = <span class="keyword">new</span> <a class="code" href="classTCPDFBarcode.html">TCPDFBarcode</a>($code, $type);
<a name="l12071"></a>12071       $arrcode = $barcodeobj-&gt;getBarcodeArray();
<a name="l12072"></a>12072       <span class="keywordflow">if</span> ($arrcode === <span class="keyword">false</span>) {
<a name="l12073"></a>12073         $this-&gt;Error(<span class="stringliteral">&#39;Error in 1D barcode string&#39;</span>);
<a name="l12074"></a>12074       }
<a name="l12075"></a>12075       <span class="comment">// set default values</span>
<a name="l12076"></a>12076       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;position&#39;</span>])) {
<a name="l12077"></a>12077         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12078"></a>12078           $style[<span class="stringliteral">&#39;position&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l12079"></a>12079         } <span class="keywordflow">else</span> {
<a name="l12080"></a>12080           $style[<span class="stringliteral">&#39;position&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l12081"></a>12081         }
<a name="l12082"></a>12082       }
<a name="l12083"></a>12083       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;padding&#39;</span>])) {
<a name="l12084"></a>12084         $style[<span class="stringliteral">&#39;padding&#39;</span>] = 0;
<a name="l12085"></a>12085       }
<a name="l12086"></a>12086       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;fgcolor&#39;</span>])) {
<a name="l12087"></a>12087         $style[<span class="stringliteral">&#39;fgcolor&#39;</span>] = array(0,0,0); <span class="comment">// default black</span>
<a name="l12088"></a>12088       }
<a name="l12089"></a>12089       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;bgcolor&#39;</span>])) {
<a name="l12090"></a>12090         $style[<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>; <span class="comment">// default transparent</span>
<a name="l12091"></a>12091       }
<a name="l12092"></a>12092       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;border&#39;</span>])) {
<a name="l12093"></a>12093         $style[<span class="stringliteral">&#39;border&#39;</span>] = <span class="keyword">false</span>;
<a name="l12094"></a>12094       }
<a name="l12095"></a>12095       $fontsize = 0;
<a name="l12096"></a>12096       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;text&#39;</span>])) {
<a name="l12097"></a>12097         $style[<span class="stringliteral">&#39;text&#39;</span>] = <span class="keyword">false</span>;
<a name="l12098"></a>12098       }
<a name="l12099"></a>12099       <span class="keywordflow">if</span> ($style[<span class="stringliteral">&#39;text&#39;</span>] AND isset($style[<span class="stringliteral">&#39;font&#39;</span>])) {
<a name="l12100"></a>12100         <span class="keywordflow">if</span> (isset($style[<span class="stringliteral">&#39;fontsize&#39;</span>])) {
<a name="l12101"></a>12101           $fontsize = $style[<span class="stringliteral">&#39;fontsize&#39;</span>];
<a name="l12102"></a>12102         }
<a name="l12103"></a>12103         $this-&gt;SetFont($style[<span class="stringliteral">&#39;font&#39;</span>], <span class="stringliteral">&#39;&#39;</span>, $fontsize);
<a name="l12104"></a>12104       }
<a name="l12105"></a>12105       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;stretchtext&#39;</span>])) {
<a name="l12106"></a>12106         $style[<span class="stringliteral">&#39;stretchtext&#39;</span>] = 4;
<a name="l12107"></a>12107       }
<a name="l12108"></a>12108       <span class="comment">// set foreground color</span>
<a name="l12109"></a>12109       $this-&gt;SetDrawColorArray($style[<span class="stringliteral">&#39;fgcolor&#39;</span>]);
<a name="l12110"></a>12110       $this-&gt;SetTextColorArray($style[<span class="stringliteral">&#39;fgcolor&#39;</span>]);
<a name="l12111"></a>12111       <span class="keywordflow">if</span> ($this-&gt;empty_string($w) OR ($w &lt;= 0)) {
<a name="l12112"></a>12112         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12113"></a>12113           $w = $this-&gt;x - $this-&gt;lMargin;
<a name="l12114"></a>12114         } <span class="keywordflow">else</span> {
<a name="l12115"></a>12115           $w = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l12116"></a>12116         }
<a name="l12117"></a>12117       }
<a name="l12118"></a>12118       <span class="keywordflow">if</span> ($this-&gt;empty_string($x)) {
<a name="l12119"></a>12119         $x = $this-&gt;GetX();
<a name="l12120"></a>12120       }
<a name="l12121"></a>12121       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12122"></a>12122         $x = $this-&gt;w - $x;
<a name="l12123"></a>12123       }
<a name="l12124"></a>12124       <span class="keywordflow">if</span> ($this-&gt;empty_string($y)) {
<a name="l12125"></a>12125         $y = $this-&gt;GetY();
<a name="l12126"></a>12126       }
<a name="l12127"></a>12127       <span class="keywordflow">if</span> ($this-&gt;empty_string($xres)) {
<a name="l12128"></a>12128         $xres = 0.4;
<a name="l12129"></a>12129       }
<a name="l12130"></a>12130       $fbw = ($arrcode[<span class="stringliteral">&#39;maxw&#39;</span>] * $xres) + (2 * $style[<span class="stringliteral">&#39;padding&#39;</span>]);
<a name="l12131"></a>12131       $extraspace = ($this-&gt;cell_height_ratio * $fontsize / $this-&gt;k) + (2 * $style[<span class="stringliteral">&#39;padding&#39;</span>]);
<a name="l12132"></a>12132       <span class="keywordflow">if</span> ($this-&gt;empty_string($h) OR ($h &lt;= 0)) {
<a name="l12133"></a>12133         $h = 10 + $extraspace;
<a name="l12134"></a>12134       }
<a name="l12135"></a>12135       <span class="keywordflow">if</span> ($this-&gt;checkPageBreak($h)) {
<a name="l12136"></a>12136         $y = $this-&gt;y;
<a name="l12137"></a>12137       }
<a name="l12138"></a>12138       <span class="comment">// maximum bar heigth</span>
<a name="l12139"></a>12139       $barh = $h - $extraspace;
<a name="l12140"></a>12140       <span class="keywordflow">switch</span> ($style[<span class="stringliteral">&#39;position&#39;</span>]) {
<a name="l12141"></a>12141         <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>: { <span class="comment">// left</span>
<a name="l12142"></a>12142           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12143"></a>12143             $xpos = $x - $w;
<a name="l12144"></a>12144           } <span class="keywordflow">else</span> {
<a name="l12145"></a>12145             $xpos = $x;
<a name="l12146"></a>12146           }
<a name="l12147"></a>12147           <span class="keywordflow">break</span>;
<a name="l12148"></a>12148         }
<a name="l12149"></a>12149         <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>: { <span class="comment">// center</span>
<a name="l12150"></a>12150           $xdiff = (($w - $fbw) / 2);
<a name="l12151"></a>12151           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12152"></a>12152             $xpos = $x - $w + $xdiff;
<a name="l12153"></a>12153           } <span class="keywordflow">else</span> {
<a name="l12154"></a>12154             $xpos = $x + $xdiff;
<a name="l12155"></a>12155           }
<a name="l12156"></a>12156           <span class="keywordflow">break</span>;
<a name="l12157"></a>12157         }
<a name="l12158"></a>12158         <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>: { <span class="comment">// right</span>
<a name="l12159"></a>12159           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12160"></a>12160             $xpos = $x - $fbw;
<a name="l12161"></a>12161           } <span class="keywordflow">else</span> {
<a name="l12162"></a>12162             $xpos = $x + $w - $fbw;
<a name="l12163"></a>12163           }
<a name="l12164"></a>12164           <span class="keywordflow">break</span>;
<a name="l12165"></a>12165         }
<a name="l12166"></a>12166         <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>: { <span class="comment">// stretch</span>
<a name="l12167"></a>12167           $fbw = $w;
<a name="l12168"></a>12168           $xres = ($w - (2 * $style[<span class="stringliteral">&#39;padding&#39;</span>])) / $arrcode[<span class="stringliteral">&#39;maxw&#39;</span>];
<a name="l12169"></a>12169           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12170"></a>12170             $xpos = $x - $w;
<a name="l12171"></a>12171           } <span class="keywordflow">else</span> {
<a name="l12172"></a>12172             $xpos = $x;
<a name="l12173"></a>12173           }
<a name="l12174"></a>12174           <span class="keywordflow">break</span>;
<a name="l12175"></a>12175         }
<a name="l12176"></a>12176       }
<a name="l12177"></a>12177       $xpos_rect = $xpos;
<a name="l12178"></a>12178       $xpos = $xpos_rect + $style[<span class="stringliteral">&#39;padding&#39;</span>];
<a name="l12179"></a>12179       $xpos_text = $xpos;
<a name="l12180"></a>12180       <span class="comment">// barcode is always printed in LTR direction</span>
<a name="l12181"></a>12181       $tempRTL = $this-&gt;rtl;
<a name="l12182"></a>12182       $this-&gt;rtl = <span class="keyword">false</span>;
<a name="l12183"></a>12183       <span class="comment">// print background color</span>
<a name="l12184"></a>12184       <span class="keywordflow">if</span> ($style[<span class="stringliteral">&#39;bgcolor&#39;</span>]) {
<a name="l12185"></a>12185         $this-&gt;Rect($xpos_rect, $y, $fbw, $h, $style[<span class="stringliteral">&#39;border&#39;</span>] ? <span class="stringliteral">&#39;DF&#39;</span> : <span class="charliteral">&#39;F&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $style[<span class="stringliteral">&#39;bgcolor&#39;</span>]);
<a name="l12186"></a>12186       } elseif ($style[<span class="stringliteral">&#39;border&#39;</span>]) {
<a name="l12187"></a>12187         $this-&gt;Rect($xpos_rect, $y, $fbw, $h, <span class="charliteral">&#39;D&#39;</span>);
<a name="l12188"></a>12188       }
<a name="l12189"></a>12189       <span class="comment">// print bars</span>
<a name="l12190"></a>12190       <span class="keywordflow">if</span> ($arrcode !== <span class="keyword">false</span>) {
<a name="l12191"></a>12191         <span class="keywordflow">foreach</span> ($arrcode[<span class="stringliteral">&#39;bcode&#39;</span>] as $k =&gt; $v) {
<a name="l12192"></a>12192           $bw = ($v[<span class="charliteral">&#39;w&#39;</span>] * $xres);
<a name="l12193"></a>12193           <span class="keywordflow">if</span> ($v[<span class="charliteral">&#39;t&#39;</span>]) {
<a name="l12194"></a>12194             <span class="comment">// draw a vertical bar</span>
<a name="l12195"></a>12195             $ypos = $y + $style[<span class="stringliteral">&#39;padding&#39;</span>] + ($v[<span class="charliteral">&#39;p&#39;</span>] * $barh / $arrcode[<span class="stringliteral">&#39;maxh&#39;</span>]);
<a name="l12196"></a>12196             $this-&gt;Rect($xpos, $ypos, $bw, ($v[<span class="charliteral">&#39;h&#39;</span>] * $barh  / $arrcode[<span class="stringliteral">&#39;maxh&#39;</span>]), <span class="charliteral">&#39;F&#39;</span>, array(), $style[<span class="stringliteral">&#39;fgcolor&#39;</span>]);
<a name="l12197"></a>12197           }
<a name="l12198"></a>12198           $xpos += $bw;
<a name="l12199"></a>12199         }
<a name="l12200"></a>12200       }
<a name="l12201"></a>12201       <span class="comment">// print text</span>
<a name="l12202"></a>12202       <span class="keywordflow">if</span> ($style[<span class="stringliteral">&#39;text&#39;</span>]) {
<a name="l12203"></a>12203         <span class="comment">// print text</span>
<a name="l12204"></a>12204         $this-&gt;x = $xpos_text;
<a name="l12205"></a>12205         $this-&gt;y = $y + $style[<span class="stringliteral">&#39;padding&#39;</span>] + $barh; 
<a name="l12206"></a>12206         $this-&gt;Cell(($arrcode[<span class="stringliteral">&#39;maxw&#39;</span>] * $xres), ($this-&gt;cell_height_ratio * $fontsize / $this-&gt;k), $code, 0, 0, <span class="charliteral">&#39;C&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, $style[<span class="stringliteral">&#39;stretchtext&#39;</span>]);
<a name="l12207"></a>12207       }
<a name="l12208"></a>12208       <span class="comment">// restore original direction</span>
<a name="l12209"></a>12209       $this-&gt;rtl = $tempRTL;
<a name="l12210"></a>12210       <span class="comment">// restore previous settings</span>
<a name="l12211"></a>12211       $this-&gt;setGraphicVars($gvars);
<a name="l12212"></a>12212       <span class="comment">// set bottomcoordinates</span>
<a name="l12213"></a>12213       $this-&gt;img_rb_y = $y + $h;
<a name="l12214"></a>12214       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12215"></a>12215         <span class="comment">// set left side coordinate</span>
<a name="l12216"></a>12216         $this-&gt;img_rb_x = ($this-&gt;w - $x - $w);
<a name="l12217"></a>12217       } <span class="keywordflow">else</span> {
<a name="l12218"></a>12218         <span class="comment">// set right side coordinate</span>
<a name="l12219"></a>12219         $this-&gt;img_rb_x = $x + $w;
<a name="l12220"></a>12220       }
<a name="l12221"></a>12221       <span class="comment">// set pointer to align the successive text/objects</span>
<a name="l12222"></a>12222       <span class="keywordflow">switch</span>($align) {
<a name="l12223"></a>12223         <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:{
<a name="l12224"></a>12224           $this-&gt;y = $y;
<a name="l12225"></a>12225           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12226"></a>12226           <span class="keywordflow">break</span>;
<a name="l12227"></a>12227         }
<a name="l12228"></a>12228         <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:{
<a name="l12229"></a>12229           $this-&gt;y = $y + round($h/2);
<a name="l12230"></a>12230           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12231"></a>12231           <span class="keywordflow">break</span>;
<a name="l12232"></a>12232         }
<a name="l12233"></a>12233         <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:{
<a name="l12234"></a>12234           $this-&gt;y = $this-&gt;img_rb_y;
<a name="l12235"></a>12235           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12236"></a>12236           <span class="keywordflow">break</span>;
<a name="l12237"></a>12237         }
<a name="l12238"></a>12238         <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:{
<a name="l12239"></a>12239           $this-&gt;SetY($this-&gt;img_rb_y);
<a name="l12240"></a>12240           <span class="keywordflow">break</span>;
<a name="l12241"></a>12241         }
<a name="l12242"></a>12242         <span class="keywordflow">default</span>:{
<a name="l12243"></a>12243           <span class="keywordflow">break</span>;
<a name="l12244"></a>12244         }
<a name="l12245"></a>12245       }
<a name="l12246"></a>12246     }
<a name="l12247"></a>12247     
<a name="l12263"></a>12263     <span class="keyword">public</span> function writeBarcode($x, $y, $w, $h, $type, $style, $font, $xres, $code) {
<a name="l12264"></a>12264       <span class="comment">// convert old settings for the new write1DBarcode() function.</span>
<a name="l12265"></a>12265       $xres = 1 / $xres;
<a name="l12266"></a>12266       $newstyle = array(
<a name="l12267"></a>12267         <span class="stringliteral">&#39;position&#39;</span> =&gt; <span class="charliteral">&#39;L&#39;</span>,
<a name="l12268"></a>12268         <span class="stringliteral">&#39;border&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l12269"></a>12269         <span class="stringliteral">&#39;padding&#39;</span> =&gt; 0,
<a name="l12270"></a>12270         <span class="stringliteral">&#39;fgcolor&#39;</span> =&gt; array(0,0,0),
<a name="l12271"></a>12271         <span class="stringliteral">&#39;bgcolor&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l12272"></a>12272         <span class="stringliteral">&#39;text&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l12273"></a>12273         <span class="stringliteral">&#39;font&#39;</span> =&gt; $font,
<a name="l12274"></a>12274         <span class="stringliteral">&#39;fontsize&#39;</span> =&gt; 8,
<a name="l12275"></a>12275         <span class="stringliteral">&#39;stretchtext&#39;</span> =&gt; 4
<a name="l12276"></a>12276       );
<a name="l12277"></a>12277       <span class="keywordflow">if</span> ($style &amp; 1) {
<a name="l12278"></a>12278         $newstyle[<span class="stringliteral">&#39;border&#39;</span>] = <span class="keyword">true</span>;
<a name="l12279"></a>12279       }
<a name="l12280"></a>12280       <span class="keywordflow">if</span> ($style &amp; 2) {
<a name="l12281"></a>12281         $newstyle[<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>;
<a name="l12282"></a>12282       }
<a name="l12283"></a>12283       <span class="keywordflow">if</span> ($style &amp; 4) {
<a name="l12284"></a>12284         $newstyle[<span class="stringliteral">&#39;position&#39;</span>] = <span class="charliteral">&#39;C&#39;</span>;
<a name="l12285"></a>12285       } elseif ($style &amp; 8) {
<a name="l12286"></a>12286         $newstyle[<span class="stringliteral">&#39;position&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l12287"></a>12287       } elseif ($style &amp; 16) {
<a name="l12288"></a>12288         $newstyle[<span class="stringliteral">&#39;position&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l12289"></a>12289       }
<a name="l12290"></a>12290       <span class="keywordflow">if</span> ($style &amp; 128) {
<a name="l12291"></a>12291         $newstyle[<span class="stringliteral">&#39;text&#39;</span>] = <span class="keyword">true</span>;
<a name="l12292"></a>12292       }
<a name="l12293"></a>12293       <span class="keywordflow">if</span> ($style &amp; 256) {
<a name="l12294"></a>12294         $newstyle[<span class="stringliteral">&#39;stretchtext&#39;</span>] = 4;
<a name="l12295"></a>12295       }
<a name="l12296"></a>12296       $this-&gt;write1DBarcode($code, $type, $x, $y, $w, $h, $xres, $newstyle, <span class="stringliteral">&#39;&#39;</span>);
<a name="l12297"></a>12297     }
<a name="l12298"></a>12298     
<a name="l12313"></a>12313     <span class="keyword">public</span> function write2DBarcode($code, $type, $x=<span class="stringliteral">&#39;&#39;</span>, $y=<span class="stringliteral">&#39;&#39;</span>, $w=<span class="stringliteral">&#39;&#39;</span>, $h=<span class="stringliteral">&#39;&#39;</span>, $style=<span class="stringliteral">&#39;&#39;</span>, $align=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l12314"></a>12314       <span class="keywordflow">if</span> ($this-&gt;empty_string($code)) {
<a name="l12315"></a>12315         <span class="keywordflow">return</span>;
<a name="l12316"></a>12316       }
<a name="l12317"></a>12317       require_once(dirname(__FILE__).<span class="stringliteral">&#39;/2dbarcodes.php&#39;</span>);
<a name="l12318"></a>12318       <span class="comment">// save current graphic settings</span>
<a name="l12319"></a>12319       $gvars = $this-&gt;getGraphicVars();
<a name="l12320"></a>12320       <span class="comment">// create new barcode object</span>
<a name="l12321"></a>12321       $barcodeobj = <span class="keyword">new</span> <a class="code" href="classTCPDF2DBarcode.html">TCPDF2DBarcode</a>($code, $type);
<a name="l12322"></a>12322       $arrcode = $barcodeobj-&gt;getBarcodeArray();
<a name="l12323"></a>12323       <span class="keywordflow">if</span> ($arrcode === <span class="keyword">false</span>) {
<a name="l12324"></a>12324         $this-&gt;Error(<span class="stringliteral">&#39;Error in 2D barcode string&#39;</span>);
<a name="l12325"></a>12325       }
<a name="l12326"></a>12326       <span class="comment">// set default values</span>
<a name="l12327"></a>12327       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;padding&#39;</span>])) {
<a name="l12328"></a>12328         $style[<span class="stringliteral">&#39;padding&#39;</span>] = 0;
<a name="l12329"></a>12329       }
<a name="l12330"></a>12330       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;fgcolor&#39;</span>])) {
<a name="l12331"></a>12331         $style[<span class="stringliteral">&#39;fgcolor&#39;</span>] = array(0,0,0); <span class="comment">// default black</span>
<a name="l12332"></a>12332       }
<a name="l12333"></a>12333       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;bgcolor&#39;</span>])) {
<a name="l12334"></a>12334         $style[<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>; <span class="comment">// default transparent</span>
<a name="l12335"></a>12335       }
<a name="l12336"></a>12336       <span class="keywordflow">if</span> (!isset($style[<span class="stringliteral">&#39;border&#39;</span>])) {
<a name="l12337"></a>12337         $style[<span class="stringliteral">&#39;border&#39;</span>] = <span class="keyword">false</span>;
<a name="l12338"></a>12338       }
<a name="l12339"></a>12339       <span class="comment">// set foreground color</span>
<a name="l12340"></a>12340       $this-&gt;SetDrawColorArray($style[<span class="stringliteral">&#39;fgcolor&#39;</span>]);
<a name="l12341"></a>12341       <span class="keywordflow">if</span> ($this-&gt;empty_string($x)) {
<a name="l12342"></a>12342         $x = $this-&gt;GetX();
<a name="l12343"></a>12343       }
<a name="l12344"></a>12344       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12345"></a>12345         $x = $this-&gt;w - $x;
<a name="l12346"></a>12346       }
<a name="l12347"></a>12347       <span class="keywordflow">if</span> ($this-&gt;empty_string($y)) {
<a name="l12348"></a>12348         $y = $this-&gt;GetY();
<a name="l12349"></a>12349       }
<a name="l12350"></a>12350       <span class="keywordflow">if</span> ($this-&gt;empty_string($w) OR ($w &lt;= 0)) {
<a name="l12351"></a>12351         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12352"></a>12352           $w = $x - $this-&gt;lMargin;
<a name="l12353"></a>12353         } <span class="keywordflow">else</span> {
<a name="l12354"></a>12354           $w = $this-&gt;w - $this-&gt;rMargin - $x;
<a name="l12355"></a>12355         }
<a name="l12356"></a>12356       }
<a name="l12357"></a>12357       <span class="keywordflow">if</span> ($this-&gt;empty_string($h) OR ($h &lt;= 0)) {
<a name="l12358"></a>12358         <span class="comment">// 2d barcodes are square by default</span>
<a name="l12359"></a>12359         $h = $w;
<a name="l12360"></a>12360       }
<a name="l12361"></a>12361       <span class="keywordflow">if</span> ($this-&gt;checkPageBreak($h)) {
<a name="l12362"></a>12362         $y = $this-&gt;y;
<a name="l12363"></a>12363       }
<a name="l12364"></a>12364       <span class="comment">// calculate barcode size (excluding padding)</span>
<a name="l12365"></a>12365       $bw = $w - (2 * $style[<span class="stringliteral">&#39;padding&#39;</span>]);
<a name="l12366"></a>12366       $bh = $h - (2 * $style[<span class="stringliteral">&#39;padding&#39;</span>]);
<a name="l12367"></a>12367       <span class="comment">// calculate starting coordinates</span>
<a name="l12368"></a>12368       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12369"></a>12369         $xpos = $x - $w;
<a name="l12370"></a>12370       } <span class="keywordflow">else</span> {
<a name="l12371"></a>12371         $xpos = $x;
<a name="l12372"></a>12372       }
<a name="l12373"></a>12373       $xpos += $style[<span class="stringliteral">&#39;padding&#39;</span>];
<a name="l12374"></a>12374       $ypos = $y + $style[<span class="stringliteral">&#39;padding&#39;</span>];
<a name="l12375"></a>12375       <span class="comment">// barcode is always printed in LTR direction</span>
<a name="l12376"></a>12376       $tempRTL = $this-&gt;rtl;
<a name="l12377"></a>12377       $this-&gt;rtl = <span class="keyword">false</span>;
<a name="l12378"></a>12378       <span class="comment">// print background color</span>
<a name="l12379"></a>12379       <span class="keywordflow">if</span> ($style[<span class="stringliteral">&#39;bgcolor&#39;</span>]) {
<a name="l12380"></a>12380         $this-&gt;Rect($x, $y, $w, $h, $style[<span class="stringliteral">&#39;border&#39;</span>] ? <span class="stringliteral">&#39;DF&#39;</span> : <span class="charliteral">&#39;F&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $style[<span class="stringliteral">&#39;bgcolor&#39;</span>]);
<a name="l12381"></a>12381       } elseif ($style[<span class="stringliteral">&#39;border&#39;</span>]) {
<a name="l12382"></a>12382         $this-&gt;Rect($x, $y, $w, $h, <span class="charliteral">&#39;D&#39;</span>);
<a name="l12383"></a>12383       }
<a name="l12384"></a>12384       <span class="comment">// print barcode cells</span>
<a name="l12385"></a>12385       <span class="keywordflow">if</span> ($arrcode !== <span class="keyword">false</span>) {
<a name="l12386"></a>12386         $rows = $arrcode[<span class="stringliteral">&#39;num_rows&#39;</span>];
<a name="l12387"></a>12387         $cols = $arrcode[<span class="stringliteral">&#39;num_cols&#39;</span>];
<a name="l12388"></a>12388         <span class="comment">// calculate dimension of single barcode cell</span>
<a name="l12389"></a>12389         $cw = $bw / $cols;
<a name="l12390"></a>12390         $ch = $bh / $rows;
<a name="l12391"></a>12391         <span class="comment">// for each row</span>
<a name="l12392"></a>12392         <span class="keywordflow">for</span> ($r = 0; $r &lt; $rows; ++$r) {
<a name="l12393"></a>12393           $xr = $xpos;
<a name="l12394"></a>12394           <span class="comment">// for each column</span>
<a name="l12395"></a>12395           <span class="keywordflow">for</span> ($c = 0; $c &lt; $cols; ++$c) {
<a name="l12396"></a>12396             <span class="keywordflow">if</span> ($arrcode[<span class="stringliteral">&#39;bcode&#39;</span>][$r][$c] == 1) {
<a name="l12397"></a>12397               <span class="comment">// draw a single barcode cell</span>
<a name="l12398"></a>12398               $this-&gt;Rect($xr, $ypos, $cw, $ch, <span class="charliteral">&#39;F&#39;</span>, array(), $style[<span class="stringliteral">&#39;fgcolor&#39;</span>]);
<a name="l12399"></a>12399             }
<a name="l12400"></a>12400             $xr += $cw;
<a name="l12401"></a>12401           }
<a name="l12402"></a>12402           $ypos += $ch;
<a name="l12403"></a>12403         }
<a name="l12404"></a>12404       }
<a name="l12405"></a>12405       <span class="comment">// restore original direction</span>
<a name="l12406"></a>12406       $this-&gt;rtl = $tempRTL;
<a name="l12407"></a>12407       <span class="comment">// restore previous settings</span>
<a name="l12408"></a>12408       $this-&gt;setGraphicVars($gvars);
<a name="l12409"></a>12409       <span class="comment">// set bottomcoordinates</span>
<a name="l12410"></a>12410       $this-&gt;img_rb_y = $y + $h;
<a name="l12411"></a>12411       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12412"></a>12412         <span class="comment">// set left side coordinate</span>
<a name="l12413"></a>12413         $this-&gt;img_rb_x = ($this-&gt;w - $x - $w);
<a name="l12414"></a>12414       } <span class="keywordflow">else</span> {
<a name="l12415"></a>12415         <span class="comment">// set right side coordinate</span>
<a name="l12416"></a>12416         $this-&gt;img_rb_x = $x + $w;
<a name="l12417"></a>12417       }
<a name="l12418"></a>12418       <span class="comment">// set pointer to align the successive text/objects</span>
<a name="l12419"></a>12419       <span class="keywordflow">switch</span>($align) {
<a name="l12420"></a>12420         <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:{
<a name="l12421"></a>12421           $this-&gt;y = $y;
<a name="l12422"></a>12422           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12423"></a>12423           <span class="keywordflow">break</span>;
<a name="l12424"></a>12424         }
<a name="l12425"></a>12425         <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:{
<a name="l12426"></a>12426           $this-&gt;y = $y + round($h/2);
<a name="l12427"></a>12427           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12428"></a>12428           <span class="keywordflow">break</span>;
<a name="l12429"></a>12429         }
<a name="l12430"></a>12430         <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:{
<a name="l12431"></a>12431           $this-&gt;y = $this-&gt;img_rb_y;
<a name="l12432"></a>12432           $this-&gt;x = $this-&gt;img_rb_x;
<a name="l12433"></a>12433           <span class="keywordflow">break</span>;
<a name="l12434"></a>12434         }
<a name="l12435"></a>12435         <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:{
<a name="l12436"></a>12436           $this-&gt;SetY($this-&gt;img_rb_y);
<a name="l12437"></a>12437           <span class="keywordflow">break</span>;
<a name="l12438"></a>12438         }
<a name="l12439"></a>12439         <span class="keywordflow">default</span>:{
<a name="l12440"></a>12440           <span class="keywordflow">break</span>;
<a name="l12441"></a>12441         }
<a name="l12442"></a>12442       }
<a name="l12443"></a>12443     }
<a name="l12444"></a>12444     
<a name="l12460"></a>12460     <span class="keyword">public</span> function getMargins() {
<a name="l12461"></a>12461       $ret = array(
<a name="l12462"></a>12462         <span class="stringliteral">&#39;left&#39;</span> =&gt; $this-&gt;lMargin,
<a name="l12463"></a>12463         <span class="stringliteral">&#39;right&#39;</span> =&gt; $this-&gt;rMargin,
<a name="l12464"></a>12464         <span class="stringliteral">&#39;top&#39;</span> =&gt; $this-&gt;tMargin,
<a name="l12465"></a>12465         <span class="stringliteral">&#39;bottom&#39;</span> =&gt; $this-&gt;bMargin,
<a name="l12466"></a>12466         <span class="stringliteral">&#39;header&#39;</span> =&gt; $this-&gt;header_margin,
<a name="l12467"></a>12467         <span class="stringliteral">&#39;footer&#39;</span> =&gt; $this-&gt;footer_margin,
<a name="l12468"></a>12468         <span class="stringliteral">&#39;cell&#39;</span> =&gt; $this-&gt;cMargin,
<a name="l12469"></a>12469       );
<a name="l12470"></a>12470       <span class="keywordflow">return</span> $ret;
<a name="l12471"></a>12471     }
<a name="l12472"></a>12472     
<a name="l12483"></a>12483     <span class="keyword">public</span> function getOriginalMargins() {
<a name="l12484"></a>12484       $ret = array(
<a name="l12485"></a>12485         <span class="stringliteral">&#39;left&#39;</span> =&gt; $this-&gt;original_lMargin,
<a name="l12486"></a>12486         <span class="stringliteral">&#39;right&#39;</span> =&gt; $this-&gt;original_rMargin
<a name="l12487"></a>12487       );
<a name="l12488"></a>12488       <span class="keywordflow">return</span> $ret;
<a name="l12489"></a>12489     }
<a name="l12490"></a>12490     
<a name="l12497"></a>12497     <span class="keyword">public</span> function getFontSize() {
<a name="l12498"></a>12498       <span class="keywordflow">return</span> $this-&gt;FontSize;
<a name="l12499"></a>12499     }
<a name="l12500"></a>12500     
<a name="l12507"></a>12507     <span class="keyword">public</span> function getFontSizePt() {
<a name="l12508"></a>12508       <span class="keywordflow">return</span> $this-&gt;FontSizePt;
<a name="l12509"></a>12509     }
<a name="l12510"></a>12510 
<a name="l12517"></a>12517     <span class="keyword">public</span> function getFontFamily() {
<a name="l12518"></a>12518       <span class="keywordflow">return</span> $this-&gt;FontFamily;
<a name="l12519"></a>12519     }
<a name="l12520"></a>12520 
<a name="l12527"></a>12527     <span class="keyword">public</span> function getFontStyle() {
<a name="l12528"></a>12528       <span class="keywordflow">return</span> $this-&gt;FontStyle;
<a name="l12529"></a>12529     }
<a name="l12530"></a>12530     
<a name="l12551"></a>12551     <span class="keyword">public</span> function writeHTMLCell($w, $h, $x, $y, $html=<span class="stringliteral">&#39;&#39;</span>, $border=0, $ln=0, $fill=0, $reseth=<span class="keyword">true</span>, $align=<span class="stringliteral">&#39;&#39;</span>, $autopadding=<span class="keyword">true</span>) {
<a name="l12552"></a>12552       <span class="keywordflow">return</span> $this-&gt;MultiCell($w, $h, $html, $border, $align, $fill, $ln, $x, $y, $reseth, 0, <span class="keyword">true</span>, $autopadding, 0);
<a name="l12553"></a>12553     }
<a name="l12554"></a>12554     
<a name="l12563"></a>12563     <span class="keyword">protected</span> function getHtmlDomArray($html) {
<a name="l12564"></a>12564       <span class="comment">// remove all unsupported tags (the line below lists all supported tags)</span>
<a name="l12565"></a>12565       $html = strip_tags($html, <span class="stringliteral">&#39;&lt;marker/&gt;&lt;a&gt;&lt;b&gt;&lt;blockquote&gt;&lt;br&gt;&lt;br/&gt;&lt;dd&gt;&lt;del&gt;&lt;div&gt;&lt;dl&gt;&lt;dt&gt;&lt;em&gt;&lt;font&gt;&lt;form&gt;&lt;h1&gt;&lt;h2&gt;&lt;h3&gt;&lt;h4&gt;&lt;h5&gt;&lt;h6&gt;&lt;hr&gt;&lt;i&gt;&lt;img&gt;&lt;input&gt;&lt;label&gt;&lt;li&gt;&lt;ol&gt;&lt;option&gt;&lt;p&gt;&lt;pre&gt;&lt;select&gt;&lt;small&gt;&lt;span&gt;&lt;strong&gt;&lt;sub&gt;&lt;sup&gt;&lt;table&gt;&lt;tablehead&gt;&lt;tcpdf&gt;&lt;td&gt;&lt;textarea&gt;&lt;th&gt;&lt;thead&gt;&lt;tr&gt;&lt;tt&gt;&lt;u&gt;&lt;ul&gt;&#39;</span>);
<a name="l12566"></a>12566       <span class="comment">//replace some blank characters</span>
<a name="l12567"></a>12567       $html = preg_replace(<span class="stringliteral">&#39;/&lt;pre/&#39;</span>, <span class="stringliteral">&#39;&lt;xre&#39;</span>, $html); <span class="comment">// preserve pre tag</span>
<a name="l12568"></a>12568       $html = preg_replace(<span class="stringliteral">&#39;/&lt;(table|tr|td|th|tcpdf|blockquote|dd|div|dt|form|h1|h2|h3|h4|h5|h6|br|hr|li|ol|ul|p)([^&gt;]*)&gt;[\n\r\t]+/&#39;</span>, <span class="stringliteral">&#39;&lt;\\1\\2&gt;&#39;</span>, $html);
<a name="l12569"></a>12569       $html = preg_replace(<span class="stringliteral">&#39;@(\r\n|\r)@&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $html);
<a name="l12570"></a>12570       $repTable = array(<span class="stringliteral">&quot;\t&quot;</span> =&gt; <span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&quot;\0&quot;</span> =&gt; <span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&quot;\x0B&quot;</span> =&gt; <span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&quot;\\&quot;</span> =&gt; <span class="stringliteral">&quot;\\\\&quot;</span>);
<a name="l12571"></a>12571       $html = strtr($html, $repTable);
<a name="l12572"></a>12572       $offset = 0;
<a name="l12573"></a>12573       <span class="keywordflow">while</span> (($offset &lt; strlen($html)) AND ($pos = strpos($html, <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>, $offset)) !== <span class="keyword">false</span>) {
<a name="l12574"></a>12574         $html_a = substr($html, 0, $offset);
<a name="l12575"></a>12575         $html_b = substr($html, $offset, ($pos - $offset + 6));
<a name="l12576"></a>12576         <span class="keywordflow">while</span> (preg_match(<span class="stringliteral">&quot;&#39;&lt;xre([^&gt;]*)&gt;(.*?)\n(.*?)&lt;/pre&gt;&#39;si&quot;</span>, $html_b)) {
<a name="l12577"></a>12577           <span class="comment">// preserve newlines on &lt;pre&gt; tag</span>
<a name="l12578"></a>12578           $html_b = preg_replace(<span class="stringliteral">&quot;&#39;&lt;xre([^&gt;]*)&gt;(.*?)\n(.*?)&lt;/pre&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;&lt;xre\\1&gt;\\2&lt;br /&gt;\\3&lt;/pre&gt;&quot;</span>, $html_b);
<a name="l12579"></a>12579         }
<a name="l12580"></a>12580         $html = $html_a.$html_b.substr($html, $pos + 6);
<a name="l12581"></a>12581         $offset = strlen($html_a.$html_b);
<a name="l12582"></a>12582       }
<a name="l12583"></a>12583       $offset = 0;
<a name="l12584"></a>12584       <span class="keywordflow">while</span> (($offset &lt; strlen($html)) AND ($pos = strpos($html, <span class="stringliteral">&#39;&lt;/textarea&gt;&#39;</span>, $offset)) !== <span class="keyword">false</span>) {
<a name="l12585"></a>12585         $html_a = substr($html, 0, $offset);
<a name="l12586"></a>12586         $html_b = substr($html, $offset, ($pos - $offset + 11));
<a name="l12587"></a>12587         <span class="keywordflow">while</span> (preg_match(<span class="stringliteral">&quot;&#39;&lt;textarea([^&gt;]*)&gt;(.*?)\n(.*?)&lt;/textarea&gt;&#39;si&quot;</span>, $html_b)) {
<a name="l12588"></a>12588           <span class="comment">// preserve newlines on &lt;textarea&gt; tag</span>
<a name="l12589"></a>12589           $html_b = preg_replace(<span class="stringliteral">&quot;&#39;&lt;textarea([^&gt;]*)&gt;(.*?)\n(.*?)&lt;/textarea&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;&lt;textarea\\1&gt;\\2&lt;TBR&gt;\\3&lt;/textarea&gt;&quot;</span>, $html_b);
<a name="l12590"></a>12590           $html_b = preg_replace(<span class="stringliteral">&quot;&#39;&lt;textarea([^&gt;]*)&gt;(.*?)[\&quot;](.*?)&lt;/textarea&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;&lt;textarea\\1&gt;\\2&#39;&#39;\\3&lt;/textarea&gt;&quot;</span>, $html_b);
<a name="l12591"></a>12591         }
<a name="l12592"></a>12592         $html = $html_a.$html_b.substr($html, $pos + 11);
<a name="l12593"></a>12593         $offset = strlen($html_a.$html_b);
<a name="l12594"></a>12594       }
<a name="l12595"></a>12595       $html = preg_replace(<span class="stringliteral">&quot;&#39;([\s]*)&lt;option&#39;si&quot;</span>, <span class="stringliteral">&quot;&lt;option&quot;</span>, $html);
<a name="l12596"></a>12596       $html = preg_replace(<span class="stringliteral">&quot;&#39;&lt;/option&gt;([\s]*)&#39;si&quot;</span>, <span class="stringliteral">&quot;&lt;/option&gt;&quot;</span>, $html);
<a name="l12597"></a>12597       $offset = 0;
<a name="l12598"></a>12598       <span class="keywordflow">while</span> (($offset &lt; strlen($html)) AND ($pos = strpos($html, <span class="stringliteral">&#39;&lt;/option&gt;&#39;</span>, $offset)) !== <span class="keyword">false</span>) {
<a name="l12599"></a>12599         $html_a = substr($html, 0, $offset);
<a name="l12600"></a>12600         $html_b = substr($html, $offset, ($pos - $offset + 9));
<a name="l12601"></a>12601         <span class="keywordflow">while</span> (preg_match(<span class="stringliteral">&quot;&#39;&lt;option([^&gt;]*)&gt;(.*?)&lt;/option&gt;&#39;si&quot;</span>, $html_b)) {
<a name="l12602"></a>12602           $html_b = preg_replace(<span class="stringliteral">&quot;&#39;&lt;option([\s]+)value=\&quot;([^\&quot;]*)\&quot;([^&gt;]*)&gt;(.*?)&lt;/option&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;\\2\t\\4\r&quot;</span>, $html_b);
<a name="l12603"></a>12603           $html_b = preg_replace(<span class="stringliteral">&quot;&#39;&lt;option([^&gt;]*)&gt;(.*?)&lt;/option&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;\\2\r&quot;</span>, $html_b);
<a name="l12604"></a>12604         }
<a name="l12605"></a>12605         $html = $html_a.$html_b.substr($html, $pos + 9);
<a name="l12606"></a>12606         $offset = strlen($html_a.$html_b);
<a name="l12607"></a>12607       }
<a name="l12608"></a>12608       $html = preg_replace(<span class="stringliteral">&quot;&#39;&lt;select([^&gt;]*)&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;&lt;select\\1 opt=\&quot;&quot;</span>, $html);
<a name="l12609"></a>12609       $html = preg_replace(<span class="stringliteral">&quot;&#39;([\s]+)&lt;/select&gt;&#39;si&quot;</span>, <span class="stringliteral">&quot;\&quot; /&gt;&quot;</span>, $html);
<a name="l12610"></a>12610       $html = str_replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="charliteral">&#39; &#39;</span>, $html);
<a name="l12611"></a>12611       <span class="comment">// restore textarea newlines</span>
<a name="l12612"></a>12612       $html = str_replace(<span class="stringliteral">&#39;&lt;TBR&gt;&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $html);
<a name="l12613"></a>12613       <span class="comment">// remove extra spaces from code</span>
<a name="l12614"></a>12614       $html = preg_replace(<span class="stringliteral">&#39;/[\s]+&lt;\/(table|tr|td|th|ul|ol|li)&gt;/&#39;</span>, <span class="stringliteral">&#39;&lt;/\\1&gt;&#39;</span>, $html);
<a name="l12615"></a>12615       $html = preg_replace(<span class="stringliteral">&#39;/[\s]+&lt;(tr|td|th|ul|ol|li|br)/&#39;</span>, <span class="stringliteral">&#39;&lt;\\1&#39;</span>, $html);
<a name="l12616"></a>12616       $html = preg_replace(<span class="stringliteral">&#39;/&lt;\/(table|tr|td|th|blockquote|dd|div|dt|h1|h2|h3|h4|h5|h6|hr|li|ol|ul|p)&gt;[\s]+&lt;/&#39;</span>, <span class="stringliteral">&#39;&lt;/\\1&gt;&lt;&#39;</span>, $html);
<a name="l12617"></a>12617       $html = preg_replace(<span class="stringliteral">&#39;/&lt;\/(td|th)&gt;/&#39;</span>, <span class="stringliteral">&#39;&lt;marker style=&quot;font-size:0&quot;/&gt;&lt;/\\1&gt;&#39;</span>, $html);
<a name="l12618"></a>12618       $html = preg_replace(<span class="stringliteral">&#39;/&lt;\/table&gt;([\s]*)&lt;marker style=&quot;font-size:0&quot;\/&gt;/&#39;</span>, <span class="stringliteral">&#39;&lt;/table&gt;&#39;</span>, $html);
<a name="l12619"></a>12619       $html = preg_replace(<span class="stringliteral">&#39;/&lt;img/&#39;</span>, <span class="stringliteral">&#39; &lt;img&#39;</span>, $html);
<a name="l12620"></a>12620       $html = preg_replace(<span class="stringliteral">&#39;/&lt;img([^&gt;]*)&gt;/xi&#39;</span>, <span class="stringliteral">&#39;&lt;img\\1&gt;&lt;span&gt;&lt;/span&gt;&#39;</span>, $html);
<a name="l12621"></a>12621       $html = preg_replace(<span class="stringliteral">&#39;/&lt;xre/&#39;</span>, <span class="stringliteral">&#39;&lt;pre&#39;</span>, $html); <span class="comment">// restore pre tag</span>
<a name="l12622"></a>12622       $html = preg_replace(<span class="stringliteral">&#39;/&lt;textarea([^&gt;]*)&gt;/xi&#39;</span>, <span class="stringliteral">&#39;&lt;textarea\\1 value=&quot;&#39;</span>, $html);
<a name="l12623"></a>12623       $html = preg_replace(<span class="stringliteral">&#39;/&lt;\/textarea&gt;/&#39;</span>, <span class="stringliteral">&#39;&quot; /&gt;&#39;</span>, $html);
<a name="l12624"></a>12624       <span class="comment">// trim string</span>
<a name="l12625"></a>12625       $html = preg_replace(<span class="stringliteral">&#39;/^[\s]+/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $html);
<a name="l12626"></a>12626       $html = preg_replace(<span class="stringliteral">&#39;/[\s]+$/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $html);
<a name="l12627"></a>12627       <span class="comment">// pattern for generic tag</span>
<a name="l12628"></a>12628       $tagpattern = <span class="stringliteral">&#39;/(&lt;[^&gt;]+&gt;)/&#39;</span>;
<a name="l12629"></a>12629       <span class="comment">// explodes the string</span>
<a name="l12630"></a>12630       $a = preg_split($tagpattern, $html, -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
<a name="l12631"></a>12631       <span class="comment">// count elements</span>
<a name="l12632"></a>12632       $maxel = count($a);
<a name="l12633"></a>12633       $elkey = 0;
<a name="l12634"></a>12634       $key = 0;
<a name="l12635"></a>12635       <span class="comment">// create an array of elements</span>
<a name="l12636"></a>12636       $dom = array();
<a name="l12637"></a>12637       $dom[$key] = array();
<a name="l12638"></a>12638       <span class="comment">// set first void element</span>
<a name="l12639"></a>12639       $dom[$key][<span class="stringliteral">&#39;tag&#39;</span>] = <span class="keyword">false</span>;
<a name="l12640"></a>12640       $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12641"></a>12641       $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>] = 0;
<a name="l12642"></a>12642       $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] = $this-&gt;FontFamily;
<a name="l12643"></a>12643       $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] = $this-&gt;FontStyle;
<a name="l12644"></a>12644       $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $this-&gt;FontSizePt;
<a name="l12645"></a>12645       $dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>] = <span class="keyword">false</span>;
<a name="l12646"></a>12646       $dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>] = $this-&gt;fgcolor;
<a name="l12647"></a>12647       $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12648"></a>12648       $dom[$key][<span class="stringliteral">&#39;listtype&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12649"></a>12649       $dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>] = 0;
<a name="l12650"></a>12650       $thead = <span class="keyword">false</span>; <span class="comment">// true when we are inside the THEAD tag</span>
<a name="l12651"></a>12651       ++$key;
<a name="l12652"></a>12652       $level = array();
<a name="l12653"></a>12653       array_push($level, 0); <span class="comment">// root</span>
<a name="l12654"></a>12654       <span class="keywordflow">while</span> ($elkey &lt; $maxel) {
<a name="l12655"></a>12655         $dom[$key] = array();
<a name="l12656"></a>12656         $element = $a[$elkey];
<a name="l12657"></a>12657         $dom[$key][<span class="stringliteral">&#39;elkey&#39;</span>] = $elkey;
<a name="l12658"></a>12658         <span class="keywordflow">if</span> (preg_match($tagpattern, $element)) {
<a name="l12659"></a>12659           <span class="comment">// html tag</span>
<a name="l12660"></a>12660           $element = substr($element, 1, -1);
<a name="l12661"></a>12661           <span class="comment">// get tag name</span>
<a name="l12662"></a>12662           preg_match(<span class="stringliteral">&#39;/[\/]?([a-zA-Z0-9]*)/&#39;</span>, $element, $tag);
<a name="l12663"></a>12663           $tagname = strtolower($tag[1]);
<a name="l12664"></a>12664           <span class="comment">// check if we are inside a table header</span>
<a name="l12665"></a>12665           <span class="keywordflow">if</span> ($tagname == <span class="stringliteral">&#39;thead&#39;</span>) {
<a name="l12666"></a>12666             <span class="keywordflow">if</span> ($element{0} == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l12667"></a>12667               $thead = <span class="keyword">false</span>;
<a name="l12668"></a>12668             } <span class="keywordflow">else</span> {
<a name="l12669"></a>12669               $thead = <span class="keyword">true</span>;
<a name="l12670"></a>12670             }
<a name="l12671"></a>12671             ++$elkey;
<a name="l12672"></a>12672             <span class="keywordflow">continue</span>;
<a name="l12673"></a>12673           }
<a name="l12674"></a>12674           $dom[$key][<span class="stringliteral">&#39;tag&#39;</span>] = <span class="keyword">true</span>;
<a name="l12675"></a>12675           $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = $tagname;
<a name="l12676"></a>12676           <span class="keywordflow">if</span> ($element{0} == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l12677"></a>12677             <span class="comment">// closing html tag</span>
<a name="l12678"></a>12678             $dom[$key][<span class="stringliteral">&#39;opening&#39;</span>] = <span class="keyword">false</span>;
<a name="l12679"></a>12679             $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>] = end($level);
<a name="l12680"></a>12680             array_pop($level);
<a name="l12681"></a>12681             $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;fontname&#39;</span>];
<a name="l12682"></a>12682             $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;fontstyle&#39;</span>];
<a name="l12683"></a>12683             $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;fontsize&#39;</span>];
<a name="l12684"></a>12684             $dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;bgcolor&#39;</span>];
<a name="l12685"></a>12685             $dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;fgcolor&#39;</span>];
<a name="l12686"></a>12686             $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;align&#39;</span>];
<a name="l12687"></a>12687             <span class="keywordflow">if</span> (isset($dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;listtype&#39;</span>])) {
<a name="l12688"></a>12688               $dom[$key][<span class="stringliteral">&#39;listtype&#39;</span>] = $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;listtype&#39;</span>];
<a name="l12689"></a>12689             }
<a name="l12690"></a>12690             <span class="comment">// set the number of columns in table tag</span>
<a name="l12691"></a>12691             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;tr&#39;</span>) AND (!isset($dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;cols&#39;</span>]))) {
<a name="l12692"></a>12692               $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;cols&#39;</span>] = $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;cols&#39;</span>];
<a name="l12693"></a>12693             }
<a name="l12694"></a>12694             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;td&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;th&#39;</span>)) {
<a name="l12695"></a>12695               $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;content&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12696"></a>12696               <span class="keywordflow">for</span> ($i = ($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>] + 1); $i &lt; $key; ++$i) {
<a name="l12697"></a>12697                 $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;content&#39;</span>] .= $a[$dom[$i][<span class="stringliteral">&#39;elkey&#39;</span>]];
<a name="l12698"></a>12698               }
<a name="l12699"></a>12699               $key = $i;
<a name="l12700"></a>12700             }
<a name="l12701"></a>12701             <span class="comment">// store header rows on a new table</span>
<a name="l12702"></a>12702             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;tr&#39;</span>) AND ($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;thead&#39;</span>] === <span class="keyword">true</span>)) {
<a name="l12703"></a>12703               <span class="keywordflow">if</span> ($this-&gt;empty_string($dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;thead&#39;</span>])) {
<a name="l12704"></a>12704                 $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;thead&#39;</span>] = $a[$dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;elkey&#39;</span>]];
<a name="l12705"></a>12705               }
<a name="l12706"></a>12706               <span class="keywordflow">for</span> ($i = $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>]; $i &lt;= $key; ++$i) {
<a name="l12707"></a>12707                 $dom[($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;thead&#39;</span>] .= $a[$dom[$i][<span class="stringliteral">&#39;elkey&#39;</span>]];
<a name="l12708"></a>12708               }
<a name="l12709"></a>12709             }
<a name="l12710"></a>12710             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;table&#39;</span>) AND (!$this-&gt;empty_string($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;thead&#39;</span>]))) {
<a name="l12711"></a>12711               $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;thead&#39;</span>] .= <span class="stringliteral">&#39;&lt;/tablehead&gt;&#39;</span>;
<a name="l12712"></a>12712             }
<a name="l12713"></a>12713           } <span class="keywordflow">else</span> {
<a name="l12714"></a>12714             <span class="comment">// opening html tag</span>
<a name="l12715"></a>12715             $dom[$key][<span class="stringliteral">&#39;opening&#39;</span>] = <span class="keyword">true</span>;
<a name="l12716"></a>12716             $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>] = end($level);
<a name="l12717"></a>12717             <span class="keywordflow">if</span> (substr($element, -1, 1) != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l12718"></a>12718               <span class="comment">// not self-closing tag</span>
<a name="l12719"></a>12719               array_push($level, $key);
<a name="l12720"></a>12720               $dom[$key][<span class="stringliteral">&#39;self&#39;</span>] = <span class="keyword">false</span>;
<a name="l12721"></a>12721             } <span class="keywordflow">else</span> {
<a name="l12722"></a>12722               $dom[$key][<span class="stringliteral">&#39;self&#39;</span>] = <span class="keyword">true</span>;
<a name="l12723"></a>12723             }
<a name="l12724"></a>12724             <span class="comment">// copy some values from parent</span>
<a name="l12725"></a>12725             $parentkey = 0;
<a name="l12726"></a>12726             <span class="keywordflow">if</span> ($key &gt; 0) {
<a name="l12727"></a>12727               $parentkey = $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>];
<a name="l12728"></a>12728               $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;fontname&#39;</span>];
<a name="l12729"></a>12729               $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;fontstyle&#39;</span>];
<a name="l12730"></a>12730               $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;fontsize&#39;</span>];
<a name="l12731"></a>12731               $dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;bgcolor&#39;</span>];
<a name="l12732"></a>12732               $dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;fgcolor&#39;</span>];
<a name="l12733"></a>12733               $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;align&#39;</span>];
<a name="l12734"></a>12734               $dom[$key][<span class="stringliteral">&#39;listtype&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;listtype&#39;</span>];
<a name="l12735"></a>12735               $dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;text-indent&#39;</span>];
<a name="l12736"></a>12736             }
<a name="l12737"></a>12737             <span class="comment">// get attributes</span>
<a name="l12738"></a>12738             preg_match_all(<span class="stringliteral">&#39;/([^=\s]*)=[&quot;]?([^&quot;]*)[&quot;]?/&#39;</span>, $element, $attr_array, PREG_PATTERN_ORDER);
<a name="l12739"></a>12739             $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>] = array(); <span class="comment">// reset attribute array</span>
<a name="l12740"></a>12740             <span class="keywordflow">while</span> (list($id, $name) = each($attr_array[1])) {
<a name="l12741"></a>12741               $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][strtolower($name)] = $attr_array[2][$id];
<a name="l12742"></a>12742             }
<a name="l12743"></a>12743             <span class="comment">// split style attributes</span>
<a name="l12744"></a>12744             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>])) {
<a name="l12745"></a>12745               <span class="comment">// get style attributes</span>
<a name="l12746"></a>12746               preg_match_all(<span class="stringliteral">&#39;/([^;:\s]*):([^;]*)/&#39;</span>, $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>], $style_array, PREG_PATTERN_ORDER);
<a name="l12747"></a>12747               $dom[$key][<span class="stringliteral">&#39;style&#39;</span>] = array(); <span class="comment">// reset style attribute array</span>
<a name="l12748"></a>12748               <span class="keywordflow">while</span> (list($id, $name) = each($style_array[1])) {
<a name="l12749"></a>12749                 $dom[$key][<span class="stringliteral">&#39;style&#39;</span>][strtolower($name)] = trim($style_array[2][$id]);
<a name="l12750"></a>12750               }
<a name="l12751"></a>12751               <span class="comment">// --- get some style attributes ---</span>
<a name="l12752"></a>12752               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>])) {
<a name="l12753"></a>12753                 <span class="comment">// font family</span>
<a name="l12754"></a>12754                 <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>])) {
<a name="l12755"></a>12755                   $fontslist = preg_split(<span class="stringliteral">&#39;/[,]/&#39;</span>, strtolower($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-family&#39;</span>]));
<a name="l12756"></a>12756                   <span class="keywordflow">foreach</span> ($fontslist as $font) {
<a name="l12757"></a>12757                     $font = trim(strtolower($font));
<a name="l12758"></a>12758                     <span class="keywordflow">if</span> (in_array($font, $this-&gt;fontlist) OR in_array($font, $this-&gt;fontkeys)) {
<a name="l12759"></a>12759                       $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] = $font;
<a name="l12760"></a>12760                       <span class="keywordflow">break</span>;
<a name="l12761"></a>12761                     }
<a name="l12762"></a>12762                   }
<a name="l12763"></a>12763                 }
<a name="l12764"></a>12764               }
<a name="l12765"></a>12765               <span class="comment">// list-style-type</span>
<a name="l12766"></a>12766               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;list-style-type&#39;</span>])) {
<a name="l12767"></a>12767                 $dom[$key][<span class="stringliteral">&#39;listtype&#39;</span>] = trim(strtolower($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;list-style-type&#39;</span>]));
<a name="l12768"></a>12768                 <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;listtype&#39;</span>] == <span class="stringliteral">&#39;inherit&#39;</span>) {
<a name="l12769"></a>12769                   $dom[$key][<span class="stringliteral">&#39;listtype&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;listtype&#39;</span>];
<a name="l12770"></a>12770                 }
<a name="l12771"></a>12771               }
<a name="l12772"></a>12772               <span class="comment">// text-indent</span>
<a name="l12773"></a>12773               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;text-indent&#39;</span>])) {
<a name="l12774"></a>12774                 $dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>] = $this-&gt;getHTMLUnitToUnits($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;text-indent&#39;</span>]);
<a name="l12775"></a>12775                 <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>] == <span class="stringliteral">&#39;inherit&#39;</span>) {
<a name="l12776"></a>12776                   $dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;text-indent&#39;</span>];
<a name="l12777"></a>12777                 }
<a name="l12778"></a>12778               }
<a name="l12779"></a>12779               <span class="comment">// font size</span>
<a name="l12780"></a>12780               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>])) {
<a name="l12781"></a>12781                 $fsize = trim($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-size&#39;</span>]);
<a name="l12782"></a>12782                 <span class="keywordflow">switch</span> ($fsize) {
<a name="l12783"></a>12783                   <span class="comment">// absolute-size</span>
<a name="l12784"></a>12784                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;xx-small&#39;</span>: {
<a name="l12785"></a>12785                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] - 4;
<a name="l12786"></a>12786                     <span class="keywordflow">break</span>;
<a name="l12787"></a>12787                   }
<a name="l12788"></a>12788                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;x-small&#39;</span>: {
<a name="l12789"></a>12789                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] - 3;
<a name="l12790"></a>12790                     <span class="keywordflow">break</span>;
<a name="l12791"></a>12791                   }
<a name="l12792"></a>12792                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;small&#39;</span>: {
<a name="l12793"></a>12793                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] - 2;
<a name="l12794"></a>12794                     <span class="keywordflow">break</span>;
<a name="l12795"></a>12795                   }
<a name="l12796"></a>12796                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;medium&#39;</span>: {
<a name="l12797"></a>12797                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>];
<a name="l12798"></a>12798                     <span class="keywordflow">break</span>;
<a name="l12799"></a>12799                   }
<a name="l12800"></a>12800                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;large&#39;</span>: {
<a name="l12801"></a>12801                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] + 2;
<a name="l12802"></a>12802                     <span class="keywordflow">break</span>;
<a name="l12803"></a>12803                   }
<a name="l12804"></a>12804                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;x-large&#39;</span>: {
<a name="l12805"></a>12805                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] + 4;
<a name="l12806"></a>12806                     <span class="keywordflow">break</span>;
<a name="l12807"></a>12807                   }
<a name="l12808"></a>12808                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;xx-large&#39;</span>: {
<a name="l12809"></a>12809                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] + 6;
<a name="l12810"></a>12810                     <span class="keywordflow">break</span>;
<a name="l12811"></a>12811                   }
<a name="l12812"></a>12812                   <span class="comment">// relative-size</span>
<a name="l12813"></a>12813                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;smaller&#39;</span>: {
<a name="l12814"></a>12814                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;fontsize&#39;</span>] - 3;
<a name="l12815"></a>12815                     <span class="keywordflow">break</span>;
<a name="l12816"></a>12816                   }
<a name="l12817"></a>12817                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;larger&#39;</span>: {
<a name="l12818"></a>12818                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[$parentkey][<span class="stringliteral">&#39;fontsize&#39;</span>] + 3;
<a name="l12819"></a>12819                     <span class="keywordflow">break</span>;
<a name="l12820"></a>12820                   }
<a name="l12821"></a>12821                   <span class="keywordflow">default</span>: {
<a name="l12822"></a>12822                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $this-&gt;getHTMLUnitToUnits($fsize, $dom[$parentkey][<span class="stringliteral">&#39;fontsize&#39;</span>], <span class="stringliteral">&#39;pt&#39;</span>, <span class="keyword">true</span>);
<a name="l12823"></a>12823                   }
<a name="l12824"></a>12824                 }
<a name="l12825"></a>12825               }
<a name="l12826"></a>12826               <span class="comment">// font style</span>
<a name="l12827"></a>12827               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-weight&#39;</span>]) AND (strtolower($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-weight&#39;</span>]{0}) == <span class="charliteral">&#39;b&#39;</span>)) {
<a name="l12828"></a>12828                 $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l12829"></a>12829               }
<a name="l12830"></a>12830               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>]) AND (strtolower($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;font-style&#39;</span>]{0}) == <span class="charliteral">&#39;i&#39;</span>)) {
<a name="l12831"></a>12831                 $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="stringliteral">&#39;&quot;I&#39;</span>;
<a name="l12832"></a>12832               }
<a name="l12833"></a>12833               <span class="comment">// font color</span>
<a name="l12834"></a>12834               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>]) AND (!$this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>]))) {
<a name="l12835"></a>12835                 $dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>] = $this-&gt;convertHTMLColorToDec($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>]);
<a name="l12836"></a>12836               }
<a name="l12837"></a>12837               <span class="comment">// background color</span>
<a name="l12838"></a>12838               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;background-color&#39;</span>]) AND (!$this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;background-color&#39;</span>]))) {
<a name="l12839"></a>12839                 $dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $this-&gt;convertHTMLColorToDec($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;background-color&#39;</span>]);
<a name="l12840"></a>12840               }
<a name="l12841"></a>12841               <span class="comment">// text-decoration</span>
<a name="l12842"></a>12842               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;text-decoration&#39;</span>])) {
<a name="l12843"></a>12843                 $decors = explode(<span class="charliteral">&#39; &#39;</span>, strtolower($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;text-decoration&#39;</span>]));
<a name="l12844"></a>12844                 <span class="keywordflow">foreach</span> ($decors as $dec) {
<a name="l12845"></a>12845                   $dec = trim($dec);
<a name="l12846"></a>12846                   <span class="keywordflow">if</span> (!$this-&gt;empty_string($dec)) {
<a name="l12847"></a>12847                     <span class="keywordflow">if</span> ($dec{0} == <span class="charliteral">&#39;u&#39;</span>) {
<a name="l12848"></a>12848                       $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;U&#39;</span>;
<a name="l12849"></a>12849                     } elseif ($dec{0} == <span class="charliteral">&#39;l&#39;</span>) {
<a name="l12850"></a>12850                       $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;D&#39;</span>;
<a name="l12851"></a>12851                     }
<a name="l12852"></a>12852                   }
<a name="l12853"></a>12853                 }
<a name="l12854"></a>12854               }
<a name="l12855"></a>12855               <span class="comment">// check for width attribute</span>
<a name="l12856"></a>12856               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>])) {
<a name="l12857"></a>12857                 $dom[$key][<span class="stringliteral">&#39;width&#39;</span>] = $dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l12858"></a>12858               }
<a name="l12859"></a>12859               <span class="comment">// check for height attribute</span>
<a name="l12860"></a>12860               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>])) {
<a name="l12861"></a>12861                 $dom[$key][<span class="stringliteral">&#39;height&#39;</span>] = $dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>];
<a name="l12862"></a>12862               }
<a name="l12863"></a>12863               <span class="comment">// check for text alignment</span>
<a name="l12864"></a>12864               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;text-align&#39;</span>])) {
<a name="l12865"></a>12865                 $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = strtoupper($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;text-align&#39;</span>]{0});
<a name="l12866"></a>12866               }
<a name="l12867"></a>12867               <span class="comment">// check for border attribute</span>
<a name="l12868"></a>12868               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>])) {
<a name="l12869"></a>12869                 $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>] = $dom[$key][<span class="stringliteral">&#39;style&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>];
<a name="l12870"></a>12870               }
<a name="l12871"></a>12871             }
<a name="l12872"></a>12872             <span class="comment">// check for font tag</span>
<a name="l12873"></a>12873             <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;font&#39;</span>) {
<a name="l12874"></a>12874               <span class="comment">// font family</span>
<a name="l12875"></a>12875               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;face&#39;</span>])) {
<a name="l12876"></a>12876                 $fontslist = preg_split(<span class="stringliteral">&#39;/[,]/&#39;</span>, strtolower($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;face&#39;</span>]));
<a name="l12877"></a>12877                 <span class="keywordflow">foreach</span> ($fontslist as $font) {
<a name="l12878"></a>12878                   $font = trim(strtolower($font));
<a name="l12879"></a>12879                   <span class="keywordflow">if</span> (in_array($font, $this-&gt;fontlist) OR in_array($font, $this-&gt;fontkeys)) {
<a name="l12880"></a>12880                     $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] = $font;
<a name="l12881"></a>12881                     <span class="keywordflow">break</span>;
<a name="l12882"></a>12882                   }
<a name="l12883"></a>12883                 }
<a name="l12884"></a>12884               }
<a name="l12885"></a>12885               <span class="comment">// font size</span>
<a name="l12886"></a>12886               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>])) {
<a name="l12887"></a>12887                 <span class="keywordflow">if</span> ($key &gt; 0) {
<a name="l12888"></a>12888                   <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>]{0} == <span class="charliteral">&#39;+&#39;</span>) {
<a name="l12889"></a>12889                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;fontsize&#39;</span>] + intval(substr($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>], 1));
<a name="l12890"></a>12890                   } elseif ($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>]{0} == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l12891"></a>12891                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;fontsize&#39;</span>] - intval(substr($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>], 1));
<a name="l12892"></a>12892                   } <span class="keywordflow">else</span> {
<a name="l12893"></a>12893                     $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = intval($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>]);
<a name="l12894"></a>12894                   }
<a name="l12895"></a>12895                 } <span class="keywordflow">else</span> {
<a name="l12896"></a>12896                   $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = intval($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>]);
<a name="l12897"></a>12897                 }
<a name="l12898"></a>12898               }
<a name="l12899"></a>12899             }
<a name="l12900"></a>12900             <span class="comment">// force natural alignment for lists</span>
<a name="l12901"></a>12901             <span class="keywordflow">if</span> ((($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;ul&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;ol&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;dl&#39;</span>))
<a name="l12902"></a>12902               AND (!isset($dom[$key][<span class="stringliteral">&#39;align&#39;</span>]) OR $this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;align&#39;</span>]) OR ($dom[$key][<span class="stringliteral">&#39;align&#39;</span>] != <span class="charliteral">&#39;J&#39;</span>))) {
<a name="l12903"></a>12903               <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l12904"></a>12904                 $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = <span class="charliteral">&#39;R&#39;</span>;
<a name="l12905"></a>12905               } <span class="keywordflow">else</span> {
<a name="l12906"></a>12906                 $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;
<a name="l12907"></a>12907               }
<a name="l12908"></a>12908             }
<a name="l12909"></a>12909             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;small&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;sup&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;sub&#39;</span>)) {
<a name="l12910"></a>12910               $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] * K_SMALL_RATIO;
<a name="l12911"></a>12911             }
<a name="l12912"></a>12912             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;strong&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="charliteral">&#39;b&#39;</span>)) {
<a name="l12913"></a>12913               $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l12914"></a>12914             }
<a name="l12915"></a>12915             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;em&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="charliteral">&#39;i&#39;</span>)) {
<a name="l12916"></a>12916               $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;I&#39;</span>;
<a name="l12917"></a>12917             }
<a name="l12918"></a>12918             <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="charliteral">&#39;u&#39;</span>) {
<a name="l12919"></a>12919               $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;U&#39;</span>;
<a name="l12920"></a>12920             }
<a name="l12921"></a>12921             <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;del&#39;</span>) {
<a name="l12922"></a>12922               $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;D&#39;</span>;
<a name="l12923"></a>12923             }
<a name="l12924"></a>12924             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;pre&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;tt&#39;</span>)) {
<a name="l12925"></a>12925               $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] = $this-&gt;default_monospaced_font;
<a name="l12926"></a>12926             }
<a name="l12927"></a>12927             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]{0} == <span class="charliteral">&#39;h&#39;</span>) AND (intval($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]{1}) &gt; 0) AND (intval($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]{1}) &lt; 7)) {
<a name="l12928"></a>12928               $headsize = (4 - intval($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]{1})) * 2;
<a name="l12929"></a>12929               $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] = $dom[0][<span class="stringliteral">&#39;fontsize&#39;</span>] + $headsize;
<a name="l12930"></a>12930               $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] .= <span class="charliteral">&#39;B&#39;</span>;
<a name="l12931"></a>12931             }
<a name="l12932"></a>12932             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;table&#39;</span>)) {
<a name="l12933"></a>12933               $dom[$key][<span class="stringliteral">&#39;rows&#39;</span>] = 0; <span class="comment">// number of rows</span>
<a name="l12934"></a>12934               $dom[$key][<span class="stringliteral">&#39;trids&#39;</span>] = array(); <span class="comment">// IDs of TR elements</span>
<a name="l12935"></a>12935               $dom[$key][<span class="stringliteral">&#39;thead&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// table header rows</span>
<a name="l12936"></a>12936             }
<a name="l12937"></a>12937             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;tr&#39;</span>)) {
<a name="l12938"></a>12938               $dom[$key][<span class="stringliteral">&#39;cols&#39;</span>] = 0;
<a name="l12939"></a>12939               <span class="comment">// store the number of rows on table element</span>
<a name="l12940"></a>12940               ++$dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;rows&#39;</span>];
<a name="l12941"></a>12941               <span class="comment">// store the TR elements IDs on table element</span>
<a name="l12942"></a>12942               array_push($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;trids&#39;</span>], $key);
<a name="l12943"></a>12943               <span class="keywordflow">if</span> ($thead) {
<a name="l12944"></a>12944                 $dom[$key][<span class="stringliteral">&#39;thead&#39;</span>] = <span class="keyword">true</span>;
<a name="l12945"></a>12945               } <span class="keywordflow">else</span> {
<a name="l12946"></a>12946                 $dom[$key][<span class="stringliteral">&#39;thead&#39;</span>] = <span class="keyword">false</span>;
<a name="l12947"></a>12947               }
<a name="l12948"></a>12948             }
<a name="l12949"></a>12949             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;th&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;td&#39;</span>)) {
<a name="l12950"></a>12950               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;colspan&#39;</span>])) {
<a name="l12951"></a>12951                 $colspan = intval($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;colspan&#39;</span>]);
<a name="l12952"></a>12952               } <span class="keywordflow">else</span> {
<a name="l12953"></a>12953                 $colspan = 1;
<a name="l12954"></a>12954               }
<a name="l12955"></a>12955               $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;colspan&#39;</span>] = $colspan;
<a name="l12956"></a>12956               $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;cols&#39;</span>] += $colspan;
<a name="l12957"></a>12957             }
<a name="l12958"></a>12958             <span class="comment">// set foreground color attribute</span>
<a name="l12959"></a>12959             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>]) AND (!$this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>]))) {
<a name="l12960"></a>12960               $dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>] = $this-&gt;convertHTMLColorToDec($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;color&#39;</span>]);
<a name="l12961"></a>12961             }
<a name="l12962"></a>12962             <span class="comment">// set background color attribute</span>
<a name="l12963"></a>12963             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;bgcolor&#39;</span>]) AND (!$this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;bgcolor&#39;</span>]))) {
<a name="l12964"></a>12964               $dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $this-&gt;convertHTMLColorToDec($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;bgcolor&#39;</span>]);
<a name="l12965"></a>12965             }
<a name="l12966"></a>12966             <span class="comment">// check for width attribute</span>
<a name="l12967"></a>12967             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>])) {
<a name="l12968"></a>12968               $dom[$key][<span class="stringliteral">&#39;width&#39;</span>] = $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>];
<a name="l12969"></a>12969             }
<a name="l12970"></a>12970             <span class="comment">// check for height attribute</span>
<a name="l12971"></a>12971             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>])) {
<a name="l12972"></a>12972               $dom[$key][<span class="stringliteral">&#39;height&#39;</span>] = $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>];
<a name="l12973"></a>12973             }
<a name="l12974"></a>12974             <span class="comment">// check for text alignment</span>
<a name="l12975"></a>12975             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;align&#39;</span>]) AND (!$this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;align&#39;</span>])) AND ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] !== <span class="stringliteral">&#39;img&#39;</span>)) {
<a name="l12976"></a>12976               $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = strtoupper($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;align&#39;</span>]{0});
<a name="l12977"></a>12977             }
<a name="l12978"></a>12978           } <span class="comment">// end opening tag</span>
<a name="l12979"></a>12979         } <span class="keywordflow">else</span> {
<a name="l12980"></a>12980           <span class="comment">// text</span>
<a name="l12981"></a>12981           $dom[$key][<span class="stringliteral">&#39;tag&#39;</span>] = <span class="keyword">false</span>;
<a name="l12982"></a>12982           $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = stripslashes($this-&gt;unhtmlentities($element));
<a name="l12983"></a>12983           $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>] = end($level);
<a name="l12984"></a>12984         }
<a name="l12985"></a>12985         ++$elkey;
<a name="l12986"></a>12986         ++$key;
<a name="l12987"></a>12987       }
<a name="l12988"></a>12988       <span class="keywordflow">return</span> $dom;
<a name="l12989"></a>12989     }
<a name="l12990"></a>12990     
<a name="l13003"></a>13003     <span class="keyword">public</span> function writeHTML($html, $ln=<span class="keyword">true</span>, $fill=<span class="keyword">false</span>, $reseth=<span class="keyword">false</span>, $cell=<span class="keyword">false</span>, $align=<span class="stringliteral">&#39;&#39;</span>) {
<a name="l13004"></a>13004       $gvars = $this-&gt;getGraphicVars();
<a name="l13005"></a>13005       <span class="comment">// store current values</span>
<a name="l13006"></a>13006       $prevPage = $this-&gt;page;
<a name="l13007"></a>13007       $prevlMargin = $this-&gt;lMargin;
<a name="l13008"></a>13008       $prevrMargin = $this-&gt;rMargin;
<a name="l13009"></a>13009       $curfontname = $this-&gt;FontFamily;
<a name="l13010"></a>13010       $curfontstyle = $this-&gt;FontStyle;
<a name="l13011"></a>13011       $curfontsize = $this-&gt;FontSizePt; 
<a name="l13012"></a>13012       $this-&gt;newline = <span class="keyword">true</span>;
<a name="l13013"></a>13013       $startlinepage = $this-&gt;page;
<a name="l13014"></a>13014       $minstartliney = $this-&gt;y;
<a name="l13015"></a>13015       $startlinex = $this-&gt;x;
<a name="l13016"></a>13016       $startliney = $this-&gt;y;
<a name="l13017"></a>13017       $yshift = 0;
<a name="l13018"></a>13018       $newline = <span class="keyword">true</span>;
<a name="l13019"></a>13019       $loop = 0;
<a name="l13020"></a>13020       $curpos = 0;
<a name="l13021"></a>13021       $this_method_vars = array();
<a name="l13022"></a>13022       $undo = <span class="keyword">false</span>;
<a name="l13023"></a>13023       $blocktags = array(<span class="stringliteral">&#39;blockquote&#39;</span>,<span class="stringliteral">&#39;br&#39;</span>,<span class="stringliteral">&#39;dd&#39;</span>,<span class="stringliteral">&#39;div&#39;</span>,<span class="stringliteral">&#39;dt&#39;</span>,<span class="stringliteral">&#39;h1&#39;</span>,<span class="stringliteral">&#39;h2&#39;</span>,<span class="stringliteral">&#39;h3&#39;</span>,<span class="stringliteral">&#39;h4&#39;</span>,<span class="stringliteral">&#39;h5&#39;</span>,<span class="stringliteral">&#39;h6&#39;</span>,<span class="stringliteral">&#39;hr&#39;</span>,<span class="stringliteral">&#39;li&#39;</span>,<span class="stringliteral">&#39;ol&#39;</span>,<span class="charliteral">&#39;p&#39;</span>,<span class="stringliteral">&#39;ul&#39;</span>,<span class="stringliteral">&#39;tcpdf&#39;</span>);
<a name="l13024"></a>13024       $this-&gt;premode = <span class="keyword">false</span>;
<a name="l13025"></a>13025       <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13026"></a>13026         $pask = count($this-&gt;PageAnnots[$this-&gt;page]);
<a name="l13027"></a>13027       } <span class="keywordflow">else</span> {
<a name="l13028"></a>13028         $pask = 0;
<a name="l13029"></a>13029       }
<a name="l13030"></a>13030       <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$this-&gt;page])) {
<a name="l13031"></a>13031         $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page] - $this-&gt;footerlen[$this-&gt;page];
<a name="l13032"></a>13032       } <span class="keywordflow">else</span> {
<a name="l13033"></a>13033         $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page];
<a name="l13034"></a>13034       }
<a name="l13035"></a>13035       $startlinepos = $this-&gt;footerpos[$this-&gt;page];
<a name="l13036"></a>13036       $lalign = $align;
<a name="l13037"></a>13037       $plalign = $align;
<a name="l13038"></a>13038       <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13039"></a>13039         $w = $this-&gt;x - $this-&gt;lMargin;
<a name="l13040"></a>13040       } <span class="keywordflow">else</span> {
<a name="l13041"></a>13041         $w = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l13042"></a>13042       }
<a name="l13043"></a>13043       $w -= (2 * $this-&gt;cMargin);
<a name="l13044"></a>13044       <span class="keywordflow">if</span> ($cell) {
<a name="l13045"></a>13045         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13046"></a>13046           $this-&gt;x -= $this-&gt;cMargin;
<a name="l13047"></a>13047         } <span class="keywordflow">else</span> {
<a name="l13048"></a>13048           $this-&gt;x += $this-&gt;cMargin;
<a name="l13049"></a>13049         }
<a name="l13050"></a>13050       }
<a name="l13051"></a>13051       <span class="keywordflow">if</span> ($this-&gt;customlistindent &gt;= 0) {
<a name="l13052"></a>13052         $this-&gt;listindent = $this-&gt;customlistindent;
<a name="l13053"></a>13053       } <span class="keywordflow">else</span> {
<a name="l13054"></a>13054         $this-&gt;listindent = $this-&gt;GetStringWidth(<span class="stringliteral">&#39;0000&#39;</span>);
<a name="l13055"></a>13055       }
<a name="l13056"></a>13056       <span class="comment">// save previous states</span>
<a name="l13057"></a>13057       $prev_listnum = $this-&gt;listnum;
<a name="l13058"></a>13058       $prev_listordered = $this-&gt;listordered;
<a name="l13059"></a>13059       $prev_listcount = $this-&gt;listcount;
<a name="l13060"></a>13060       $prev_lispacer = $this-&gt;lispacer;
<a name="l13061"></a>13061       $this-&gt;listnum = 0;
<a name="l13062"></a>13062       $this-&gt;listordered = array();
<a name="l13063"></a>13063       $this-&gt;listcount = array();
<a name="l13064"></a>13064       $this-&gt;lispacer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13065"></a>13065       <span class="keywordflow">if</span> (($this-&gt;empty_string($this-&gt;lasth)) OR ($reseth)) {
<a name="l13066"></a>13066         <span class="comment">//set row height</span>
<a name="l13067"></a>13067         $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio; 
<a name="l13068"></a>13068       }
<a name="l13069"></a>13069       $dom = $this-&gt;getHtmlDomArray($html);
<a name="l13070"></a>13070       $maxel = count($dom);
<a name="l13071"></a>13071       $key = 0;
<a name="l13072"></a>13072       <span class="keywordflow">while</span> ($key &lt; $maxel) {
<a name="l13073"></a>13073         <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;tag&#39;</span>] AND $dom[$key][<span class="stringliteral">&#39;opening&#39;</span>] AND isset($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>]) AND ($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l13074"></a>13074           <span class="keywordflow">if</span> (isset($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>]) AND ($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l13075"></a>13075             $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>] = <span class="keyword">false</span>;
<a name="l13076"></a>13076           } <span class="keywordflow">else</span> {
<a name="l13077"></a>13077             <span class="comment">// store current object</span>
<a name="l13078"></a>13078             $this-&gt;startTransaction();
<a name="l13079"></a>13079             <span class="comment">// save this method vars</span>
<a name="l13080"></a>13080             $this_method_vars[<span class="stringliteral">&#39;html&#39;</span>] = $html;
<a name="l13081"></a>13081             $this_method_vars[<span class="stringliteral">&#39;ln&#39;</span>] = $ln;
<a name="l13082"></a>13082             $this_method_vars[<span class="stringliteral">&#39;fill&#39;</span>] = $fill;
<a name="l13083"></a>13083             $this_method_vars[<span class="stringliteral">&#39;reseth&#39;</span>] = $reseth;
<a name="l13084"></a>13084             $this_method_vars[<span class="stringliteral">&#39;cell&#39;</span>] = $cell;
<a name="l13085"></a>13085             $this_method_vars[<span class="stringliteral">&#39;align&#39;</span>] = $align;
<a name="l13086"></a>13086             $this_method_vars[<span class="stringliteral">&#39;gvars&#39;</span>] = $gvars;
<a name="l13087"></a>13087             $this_method_vars[<span class="stringliteral">&#39;prevPage&#39;</span>] = $prevPage;
<a name="l13088"></a>13088             $this_method_vars[<span class="stringliteral">&#39;prevlMargin&#39;</span>] = $prevlMargin;
<a name="l13089"></a>13089             $this_method_vars[<span class="stringliteral">&#39;prevrMargin&#39;</span>] = $prevrMargin;
<a name="l13090"></a>13090             $this_method_vars[<span class="stringliteral">&#39;curfontname&#39;</span>] = $curfontname;
<a name="l13091"></a>13091             $this_method_vars[<span class="stringliteral">&#39;curfontstyle&#39;</span>] = $curfontstyle;
<a name="l13092"></a>13092             $this_method_vars[<span class="stringliteral">&#39;curfontsize&#39;</span>] = $curfontsize;
<a name="l13093"></a>13093             $this_method_vars[<span class="stringliteral">&#39;minstartliney&#39;</span>] = $minstartliney;
<a name="l13094"></a>13094             $this_method_vars[<span class="stringliteral">&#39;yshift&#39;</span>] = $yshift;
<a name="l13095"></a>13095             $this_method_vars[<span class="stringliteral">&#39;startlinepage&#39;</span>] = $startlinepage;
<a name="l13096"></a>13096             $this_method_vars[<span class="stringliteral">&#39;startlinepos&#39;</span>] = $startlinepos;
<a name="l13097"></a>13097             $this_method_vars[<span class="stringliteral">&#39;startlinex&#39;</span>] = $startlinex;
<a name="l13098"></a>13098             $this_method_vars[<span class="stringliteral">&#39;startliney&#39;</span>] = $startliney;
<a name="l13099"></a>13099             $this_method_vars[<span class="stringliteral">&#39;newline&#39;</span>] = $newline;
<a name="l13100"></a>13100             $this_method_vars[<span class="stringliteral">&#39;loop&#39;</span>] = $loop;
<a name="l13101"></a>13101             $this_method_vars[<span class="stringliteral">&#39;curpos&#39;</span>] = $curpos;
<a name="l13102"></a>13102             $this_method_vars[<span class="stringliteral">&#39;pask&#39;</span>] = $pask;
<a name="l13103"></a>13103             $this_method_vars[<span class="stringliteral">&#39;lalign&#39;</span>] = $lalign;
<a name="l13104"></a>13104             $this_method_vars[<span class="stringliteral">&#39;plalign&#39;</span>] = $plalign;
<a name="l13105"></a>13105             $this_method_vars[<span class="charliteral">&#39;w&#39;</span>] = $w;
<a name="l13106"></a>13106             $this_method_vars[<span class="stringliteral">&#39;prev_listnum&#39;</span>] = $prev_listnum;
<a name="l13107"></a>13107             $this_method_vars[<span class="stringliteral">&#39;prev_listordered&#39;</span>] = $prev_listordered;
<a name="l13108"></a>13108             $this_method_vars[<span class="stringliteral">&#39;prev_listcount&#39;</span>] = $prev_listcount;
<a name="l13109"></a>13109             $this_method_vars[<span class="stringliteral">&#39;prev_lispacer&#39;</span>] = $prev_lispacer;
<a name="l13110"></a>13110             $this_method_vars[<span class="stringliteral">&#39;key&#39;</span>] = $key;
<a name="l13111"></a>13111             $this_method_vars[<span class="stringliteral">&#39;dom&#39;</span>] = $dom;
<a name="l13112"></a>13112           }
<a name="l13113"></a>13113         }
<a name="l13114"></a>13114         <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;tag&#39;</span>] OR ($key == 0)) {
<a name="l13115"></a>13115           <span class="keywordflow">if</span> ((($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;table&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;tr&#39;</span>)) AND (isset($dom[$key][<span class="stringliteral">&#39;align&#39;</span>]))) {
<a name="l13116"></a>13116             $dom[$key][<span class="stringliteral">&#39;align&#39;</span>] = ($this-&gt;rtl) ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l13117"></a>13117           }
<a name="l13118"></a>13118           <span class="comment">// vertically align image in line</span>
<a name="l13119"></a>13119           <span class="keywordflow">if</span> ((!$this-&gt;newline)
<a name="l13120"></a>13120             AND ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;img&#39;</span>)
<a name="l13121"></a>13121             AND (isset($dom[$key][&#39;attribute&#39;][&#39;height&#39;]))
<a name="l13122"></a>13122             AND ($dom[$key][&#39;attribute&#39;][&#39;height&#39;] &gt; 0)) {
<a name="l13123"></a>13123             
<a name="l13124"></a>13124             <span class="comment">// get image height</span>
<a name="l13125"></a>13125             $imgh = $this-&gt;getHTMLUnitToUnits($dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>], $this-&gt;lasth, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13126"></a>13126             <span class="keywordflow">if</span> (!$this-&gt;InFooter) {
<a name="l13127"></a>13127               <span class="comment">// check for page break</span>
<a name="l13128"></a>13128               $this-&gt;checkPageBreak($imgh);
<a name="l13129"></a>13129             }
<a name="l13130"></a>13130             <span class="keywordflow">if</span> ($this-&gt;page &gt; $startlinepage) {
<a name="l13131"></a>13131               <span class="comment">// fix line splitted over two pages</span>
<a name="l13132"></a>13132               <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$startlinepage])) {
<a name="l13133"></a>13133                 $curpos = $this-&gt;pagelen[$startlinepage] - $this-&gt;footerlen[$startlinepage];
<a name="l13134"></a>13134               }
<a name="l13135"></a>13135               <span class="comment">// line to be moved one page forward</span>
<a name="l13136"></a>13136               $pagebuff = $this-&gt;getPageBuffer($startlinepage);
<a name="l13137"></a>13137               $linebeg = substr($pagebuff, $startlinepos, ($curpos - $startlinepos));
<a name="l13138"></a>13138               $tstart = substr($pagebuff, 0, $startlinepos);
<a name="l13139"></a>13139               $tend = substr($this-&gt;getPageBuffer($startlinepage), $curpos);
<a name="l13140"></a>13140               <span class="comment">// remove line from previous page</span>
<a name="l13141"></a>13141               $this-&gt;setPageBuffer($startlinepage, $tstart.<span class="stringliteral">&#39;&#39;</span>.$tend);
<a name="l13142"></a>13142               $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);
<a name="l13143"></a>13143               $tstart = substr($pagebuff, 0, $this-&gt;cntmrk[$this-&gt;page]);
<a name="l13144"></a>13144               $tend = substr($pagebuff, $this-&gt;cntmrk[$this-&gt;page]);
<a name="l13145"></a>13145               <span class="comment">// add line start to current page</span>
<a name="l13146"></a>13146               $yshift = $minstartliney - $this-&gt;y;
<a name="l13147"></a>13147               $try = sprintf(<span class="stringliteral">&#39;1 0 0 1 0 %.3F cm&#39;</span>, ($yshift * $this-&gt;k));
<a name="l13148"></a>13148               $this-&gt;setPageBuffer($this-&gt;page, $tstart.<span class="stringliteral">&quot;\nq\n&quot;</span>.$try.<span class="stringliteral">&quot;\n&quot;</span>.$linebeg.<span class="stringliteral">&quot;\nQ\n&quot;</span>.$tend);
<a name="l13149"></a>13149               <span class="comment">// shift the annotations and links</span>
<a name="l13150"></a>13150               <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13151"></a>13151                 $next_pask = count($this-&gt;PageAnnots[$this-&gt;page]);
<a name="l13152"></a>13152               } <span class="keywordflow">else</span> {
<a name="l13153"></a>13153                 $next_pask = 0;
<a name="l13154"></a>13154               }
<a name="l13155"></a>13155               <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$startlinepage])) {
<a name="l13156"></a>13156                 <span class="keywordflow">foreach</span> ($this-&gt;PageAnnots[$startlinepage] as $pak =&gt; $pac) {
<a name="l13157"></a>13157                   <span class="keywordflow">if</span> ($pak &gt;= $pask) {
<a name="l13158"></a>13158                     $this-&gt;PageAnnots[$this-&gt;page][] = $pac;
<a name="l13159"></a>13159                     unset($this-&gt;PageAnnots[$startlinepage][$pak]);
<a name="l13160"></a>13160                     $npak = count($this-&gt;PageAnnots[$this-&gt;page]) - 1;
<a name="l13161"></a>13161                     $this-&gt;PageAnnots[$this-&gt;page][$npak][<span class="charliteral">&#39;y&#39;</span>] -= $yshift;                    
<a name="l13162"></a>13162                   }
<a name="l13163"></a>13163                 }
<a name="l13164"></a>13164                 
<a name="l13165"></a>13165               }
<a name="l13166"></a>13166               $pask = $next_pask;
<a name="l13167"></a>13167               $startlinepos = $this-&gt;cntmrk[$this-&gt;page];
<a name="l13168"></a>13168               $startlinepage = $this-&gt;page;
<a name="l13169"></a>13169               $startliney = $this-&gt;y;
<a name="l13170"></a>13170             }
<a name="l13171"></a>13171             $this-&gt;y += (($curfontsize / $this-&gt;k) - $imgh);
<a name="l13172"></a>13172             $minstartliney = min($this-&gt;y, $minstartliney); 
<a name="l13173"></a>13173           } elseif (isset($dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>]) OR isset($dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>]) OR isset($dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>])) {
<a name="l13174"></a>13174             <span class="comment">// account for different font size</span>
<a name="l13175"></a>13175             $pfontname = $curfontname;
<a name="l13176"></a>13176             $pfontstyle = $curfontstyle;
<a name="l13177"></a>13177             $pfontsize = $curfontsize;
<a name="l13178"></a>13178             $fontname = isset($dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>]) ? $dom[$key][<span class="stringliteral">&#39;fontname&#39;</span>] : $curfontname;
<a name="l13179"></a>13179             $fontstyle = isset($dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>]) ? $dom[$key][<span class="stringliteral">&#39;fontstyle&#39;</span>] : $curfontstyle;
<a name="l13180"></a>13180             $fontsize = isset($dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>]) ? $dom[$key][<span class="stringliteral">&#39;fontsize&#39;</span>] : $curfontsize;
<a name="l13181"></a>13181             <span class="keywordflow">if</span> (($fontname != $curfontname) OR ($fontstyle != $curfontstyle) OR ($fontsize != $curfontsize)) {
<a name="l13182"></a>13182               $this-&gt;SetFont($fontname, $fontstyle, $fontsize);
<a name="l13183"></a>13183               $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l13184"></a>13184               <span class="keywordflow">if</span> (is_numeric($fontsize) AND ($fontsize &gt; 0)
<a name="l13185"></a>13185                 AND is_numeric($curfontsize) AND ($curfontsize &gt; 0)
<a name="l13186"></a>13186                 AND ($fontsize != $curfontsize) AND (!$this-&gt;newline)
<a name="l13187"></a>13187                 AND ($key &lt; ($maxel - 1))
<a name="l13188"></a>13188                 ) {
<a name="l13189"></a>13189                 <span class="keywordflow">if</span> ((!$this-&gt;newline) AND ($this-&gt;page &gt; $startlinepage)) {
<a name="l13190"></a>13190                   <span class="comment">// fix lines splitted over two pages</span>
<a name="l13191"></a>13191                   <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$startlinepage])) {
<a name="l13192"></a>13192                     $curpos = $this-&gt;pagelen[$startlinepage] - $this-&gt;footerlen[$startlinepage];
<a name="l13193"></a>13193                   }
<a name="l13194"></a>13194                   <span class="comment">// line to be moved one page forward</span>
<a name="l13195"></a>13195                   $pagebuff = $this-&gt;getPageBuffer($startlinepage);
<a name="l13196"></a>13196                   $linebeg = substr($pagebuff, $startlinepos, ($curpos - $startlinepos));
<a name="l13197"></a>13197                   $tstart = substr($pagebuff, 0, $startlinepos);
<a name="l13198"></a>13198                   $tend = substr($this-&gt;getPageBuffer($startlinepage), $curpos);
<a name="l13199"></a>13199                   <span class="comment">// remove line start from previous page</span>
<a name="l13200"></a>13200                   $this-&gt;setPageBuffer($startlinepage, $tstart.<span class="stringliteral">&#39;&#39;</span>.$tend);
<a name="l13201"></a>13201                   $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);
<a name="l13202"></a>13202                   $tstart = substr($pagebuff, 0, $this-&gt;cntmrk[$this-&gt;page]);
<a name="l13203"></a>13203                   $tend = substr($pagebuff, $this-&gt;cntmrk[$this-&gt;page]);
<a name="l13204"></a>13204                   <span class="comment">// add line start to current page</span>
<a name="l13205"></a>13205                   $yshift = $minstartliney - $this-&gt;y;
<a name="l13206"></a>13206                   $try = sprintf(<span class="stringliteral">&#39;1 0 0 1 0 %.3F cm&#39;</span>, ($yshift * $this-&gt;k));
<a name="l13207"></a>13207                   $this-&gt;setPageBuffer($this-&gt;page, $tstart.<span class="stringliteral">&quot;\nq\n&quot;</span>.$try.<span class="stringliteral">&quot;\n&quot;</span>.$linebeg.<span class="stringliteral">&quot;\nQ\n&quot;</span>.$tend);
<a name="l13208"></a>13208                   <span class="comment">// shift the annotations and links</span>
<a name="l13209"></a>13209                   <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13210"></a>13210                     $next_pask = count($this-&gt;PageAnnots[$this-&gt;page]);
<a name="l13211"></a>13211                   } <span class="keywordflow">else</span> {
<a name="l13212"></a>13212                     $next_pask = 0;
<a name="l13213"></a>13213                   }
<a name="l13214"></a>13214                   <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$startlinepage])) {
<a name="l13215"></a>13215                     <span class="keywordflow">foreach</span> ($this-&gt;PageAnnots[$startlinepage] as $pak =&gt; $pac) {
<a name="l13216"></a>13216                       <span class="keywordflow">if</span> ($pak &gt;= $pask) {
<a name="l13217"></a>13217                         $this-&gt;PageAnnots[$this-&gt;page][] = $pac;
<a name="l13218"></a>13218                         unset($this-&gt;PageAnnots[$startlinepage][$pak]);
<a name="l13219"></a>13219                         $npak = count($this-&gt;PageAnnots[$this-&gt;page]) - 1;
<a name="l13220"></a>13220                         $this-&gt;PageAnnots[$this-&gt;page][$npak][<span class="charliteral">&#39;y&#39;</span>] -= $yshift;
<a name="l13221"></a>13221                       }
<a name="l13222"></a>13222                     }
<a name="l13223"></a>13223                   }
<a name="l13224"></a>13224                   $pask = $next_pask;
<a name="l13225"></a>13225                 }
<a name="l13226"></a>13226                 <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] != <span class="stringliteral">&#39;td&#39;</span>) AND ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] != <span class="stringliteral">&#39;th&#39;</span>)) {
<a name="l13227"></a>13227                   $this-&gt;y += (($curfontsize - $fontsize) / $this-&gt;k);
<a name="l13228"></a>13228                 }
<a name="l13229"></a>13229                 $minstartliney = min($this-&gt;y, $minstartliney);
<a name="l13230"></a>13230               }
<a name="l13231"></a>13231               $curfontname = $fontname;
<a name="l13232"></a>13232               $curfontstyle = $fontstyle;
<a name="l13233"></a>13233               $curfontsize = $fontsize;
<a name="l13234"></a>13234             }
<a name="l13235"></a>13235           }
<a name="l13236"></a>13236           <span class="keywordflow">if</span> (($plalign == <span class="charliteral">&#39;J&#39;</span>) AND (in_array($dom[$key][<span class="stringliteral">&#39;value&#39;</span>], $blocktags))) {
<a name="l13237"></a>13237             $plalign = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13238"></a>13238           }
<a name="l13239"></a>13239           <span class="comment">// get current position on page buffer</span>
<a name="l13240"></a>13240           $curpos = $this-&gt;pagelen[$startlinepage];
<a name="l13241"></a>13241           <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>]) AND ($dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>] !== <span class="keyword">false</span>)) {
<a name="l13242"></a>13242             $this-&gt;SetFillColorArray($dom[$key][<span class="stringliteral">&#39;bgcolor&#39;</span>]);
<a name="l13243"></a>13243             $wfill = <span class="keyword">true</span>;
<a name="l13244"></a>13244           } <span class="keywordflow">else</span> {
<a name="l13245"></a>13245             $wfill = $fill | <span class="keyword">false</span>;
<a name="l13246"></a>13246           }
<a name="l13247"></a>13247           <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>]) AND ($dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>] !== <span class="keyword">false</span>)) {
<a name="l13248"></a>13248             $this-&gt;SetTextColorArray($dom[$key][<span class="stringliteral">&#39;fgcolor&#39;</span>]);
<a name="l13249"></a>13249           }
<a name="l13250"></a>13250           <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;align&#39;</span>])) {
<a name="l13251"></a>13251             $lalign = $dom[$key][<span class="stringliteral">&#39;align&#39;</span>];
<a name="l13252"></a>13252           }
<a name="l13253"></a>13253           <span class="keywordflow">if</span> ($this-&gt;empty_string($lalign)) {
<a name="l13254"></a>13254             $lalign = $align;
<a name="l13255"></a>13255           }
<a name="l13256"></a>13256         }
<a name="l13257"></a>13257         <span class="comment">// align lines</span>
<a name="l13258"></a>13258         <span class="keywordflow">if</span> ($this-&gt;newline AND (strlen($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]) &gt; 0) AND ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] != <span class="stringliteral">&#39;td&#39;</span>) AND ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] != <span class="stringliteral">&#39;th&#39;</span>)) {
<a name="l13259"></a>13259           $newline = <span class="keyword">true</span>;
<a name="l13260"></a>13260           <span class="comment">// we are at the beginning of a new line</span>
<a name="l13261"></a>13261           <span class="keywordflow">if</span> (isset($startlinex)) {
<a name="l13262"></a>13262             $yshift = $minstartliney - $startliney;
<a name="l13263"></a>13263             <span class="keywordflow">if</span> (($yshift &gt; 0) OR ($this-&gt;page &gt; $startlinepage)) {
<a name="l13264"></a>13264               $yshift = 0;
<a name="l13265"></a>13265             }
<a name="l13266"></a>13266             <span class="keywordflow">if</span> ((isset($plalign) AND ((($plalign == <span class="charliteral">&#39;C&#39;</span>) OR ($plalign == <span class="charliteral">&#39;J&#39;</span>) OR (($plalign == <span class="charliteral">&#39;R&#39;</span>) AND (!$this-&gt;rtl)) OR (($plalign == <span class="charliteral">&#39;L&#39;</span>) AND ($this-&gt;rtl))))) OR ($yshift &lt; 0)) {
<a name="l13267"></a>13267               <span class="comment">// the last line must be shifted to be aligned as requested</span>
<a name="l13268"></a>13268               $linew = abs($this-&gt;endlinex - $startlinex);
<a name="l13269"></a>13269               $pstart = substr($this-&gt;getPageBuffer($startlinepage), 0, $startlinepos);
<a name="l13270"></a>13270               <span class="keywordflow">if</span> (isset($opentagpos) AND isset($this-&gt;footerlen[$startlinepage]) AND (!$this-&gt;InFooter)) {
<a name="l13271"></a>13271                 $this-&gt;footerpos[$startlinepage] = $this-&gt;pagelen[$startlinepage] - $this-&gt;footerlen[$startlinepage];
<a name="l13272"></a>13272                 $midpos = min($opentagpos, $this-&gt;footerpos[$startlinepage]);
<a name="l13273"></a>13273               } elseif (isset($opentagpos)) {
<a name="l13274"></a>13274                 $midpos = $opentagpos;
<a name="l13275"></a>13275               } elseif (isset($this-&gt;footerlen[$startlinepage]) AND (!$this-&gt;InFooter)) {
<a name="l13276"></a>13276                 $this-&gt;footerpos[$startlinepage] = $this-&gt;pagelen[$startlinepage] - $this-&gt;footerlen[$startlinepage];
<a name="l13277"></a>13277                 $midpos = $this-&gt;footerpos[$startlinepage];
<a name="l13278"></a>13278               } <span class="keywordflow">else</span> {
<a name="l13279"></a>13279                 $midpos = 0;
<a name="l13280"></a>13280               }
<a name="l13281"></a>13281               <span class="keywordflow">if</span> ($midpos &gt; 0) {
<a name="l13282"></a>13282                 $pmid = substr($this-&gt;getPageBuffer($startlinepage), $startlinepos, ($midpos - $startlinepos));
<a name="l13283"></a>13283                 $pend = substr($this-&gt;getPageBuffer($startlinepage), $midpos);
<a name="l13284"></a>13284               } <span class="keywordflow">else</span> {
<a name="l13285"></a>13285                 $pmid = substr($this-&gt;getPageBuffer($startlinepage), $startlinepos);
<a name="l13286"></a>13286                 $pend = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13287"></a>13287               }
<a name="l13288"></a>13288               <span class="comment">// calculate shifting amount</span>
<a name="l13289"></a>13289               $tw = $w;
<a name="l13290"></a>13290               <span class="keywordflow">if</span> ($this-&gt;lMargin != $prevlMargin) {
<a name="l13291"></a>13291                 $tw += ($prevlMargin - $this-&gt;lMargin);
<a name="l13292"></a>13292               }
<a name="l13293"></a>13293               <span class="keywordflow">if</span> ($this-&gt;rMargin != $prevrMargin) {
<a name="l13294"></a>13294                 $tw += ($prevrMargin - $this-&gt;rMargin);
<a name="l13295"></a>13295               }
<a name="l13296"></a>13296               $mdiff = abs($tw - $linew);
<a name="l13297"></a>13297               $t_x = 0;
<a name="l13298"></a>13298               <span class="keywordflow">if</span> ($plalign == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l13299"></a>13299                 <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13300"></a>13300                   $t_x = -($mdiff / 2);
<a name="l13301"></a>13301                 } <span class="keywordflow">else</span> {
<a name="l13302"></a>13302                   $t_x = ($mdiff / 2);
<a name="l13303"></a>13303                 }
<a name="l13304"></a>13304               } elseif (($plalign == <span class="charliteral">&#39;R&#39;</span>) AND (!$this-&gt;rtl)) {
<a name="l13305"></a>13305                 <span class="comment">// right alignment on LTR document</span>
<a name="l13306"></a>13306                 $t_x = $mdiff;  
<a name="l13307"></a>13307               } elseif (($plalign == <span class="charliteral">&#39;L&#39;</span>) AND ($this-&gt;rtl)) {
<a name="l13308"></a>13308                 <span class="comment">// left alignment on RTL document</span>
<a name="l13309"></a>13309                 $t_x = -$mdiff;
<a name="l13310"></a>13310               } elseif (($plalign == <span class="charliteral">&#39;J&#39;</span>) AND ($plalign == $lalign)) {
<a name="l13311"></a>13311                 <span class="comment">// Justification</span>
<a name="l13312"></a>13312                 <span class="keywordflow">if</span> ($this-&gt;rtl OR $this-&gt;tmprtl) {
<a name="l13313"></a>13313                   $t_x = $this-&gt;lMargin - $this-&gt;endlinex;
<a name="l13314"></a>13314                 }
<a name="l13315"></a>13315                 $no = 0;
<a name="l13316"></a>13316                 $ns = 0;
<a name="l13317"></a>13317                 $pmidtemp = $pmid;
<a name="l13318"></a>13318                 <span class="comment">// escape special characters</span>
<a name="l13319"></a>13319                 $pmidtemp = preg_replace(<span class="stringliteral">&#39;/[\\\][\(]/x&#39;</span>, <span class="stringliteral">&#39;\\#!#OP#!#&#39;</span>, $pmidtemp);
<a name="l13320"></a>13320                 $pmidtemp = preg_replace(<span class="stringliteral">&#39;/[\\\][\)]/x&#39;</span>, <span class="stringliteral">&#39;\\#!#CP#!#&#39;</span>, $pmidtemp);
<a name="l13321"></a>13321                 <span class="comment">// search spaces</span>
<a name="l13322"></a>13322                 <span class="keywordflow">if</span> (preg_match_all(<span class="stringliteral">&#39;/\[\(([^\)]*)\)\]/x&#39;</span>, $pmidtemp, $lnstring, PREG_PATTERN_ORDER)) {
<a name="l13323"></a>13323                   $maxkk = count($lnstring[1]) - 1;
<a name="l13324"></a>13324                   <span class="keywordflow">for</span> ($kk=0; $kk &lt;= $maxkk; ++$kk) {
<a name="l13325"></a>13325                     <span class="comment">// restore special characters</span>
<a name="l13326"></a>13326                     $lnstring[1][$kk] = str_replace(<span class="stringliteral">&#39;#!#OP#!#&#39;</span>, <span class="charliteral">&#39;(&#39;</span>, $lnstring[1][$kk]);
<a name="l13327"></a>13327                     $lnstring[1][$kk] = str_replace(<span class="stringliteral">&#39;#!#CP#!#&#39;</span>, <span class="charliteral">&#39;)&#39;</span>, $lnstring[1][$kk]);
<a name="l13328"></a>13328                     <span class="keywordflow">if</span> ($kk == $maxkk) {
<a name="l13329"></a>13329                       <span class="keywordflow">if</span> ($this-&gt;rtl OR $this-&gt;tmprtl) {
<a name="l13330"></a>13330                         $tvalue = ltrim($lnstring[1][$kk]);
<a name="l13331"></a>13331                       } <span class="keywordflow">else</span> {
<a name="l13332"></a>13332                         $tvalue = rtrim($lnstring[1][$kk]);
<a name="l13333"></a>13333                       }
<a name="l13334"></a>13334                     } <span class="keywordflow">else</span> {
<a name="l13335"></a>13335                       $tvalue = $lnstring[1][$kk];
<a name="l13336"></a>13336                     }
<a name="l13337"></a>13337                     <span class="comment">// count spaces on line</span>
<a name="l13338"></a>13338                     $no += substr_count($lnstring[1][$kk], chr(32));
<a name="l13339"></a>13339                     $ns += substr_count($tvalue, chr(32));
<a name="l13340"></a>13340                   }
<a name="l13341"></a>13341                   <span class="keywordflow">if</span> ($this-&gt;rtl OR $this-&gt;tmprtl) {
<a name="l13342"></a>13342                     $t_x = $this-&gt;lMargin - $this-&gt;endlinex - (($no - $ns - 1) * $this-&gt;GetStringWidth(chr(32)));
<a name="l13343"></a>13343                   }
<a name="l13344"></a>13344                   <span class="comment">// calculate additional space to add to each space</span>
<a name="l13345"></a>13345                   $spacelen = $this-&gt;GetStringWidth(chr(32));
<a name="l13346"></a>13346                   $spacewidth = (($tw - $linew + (($no - $ns) * $spacelen)) / ($ns?$ns:1)) * $this-&gt;k;
<a name="l13347"></a>13347                   $spacewidthu = -1000 * ($tw - $linew + ($no * $spacelen)) / ($ns?$ns:1) / $this-&gt;FontSize;
<a name="l13348"></a>13348                   $nsmax = $ns;
<a name="l13349"></a>13349                   $ns = 0;
<a name="l13350"></a>13350                   reset($lnstring);
<a name="l13351"></a>13351                   $offset = 0;
<a name="l13352"></a>13352                   $strcount = 0;
<a name="l13353"></a>13353                   $prev_epsposbeg = 0;
<a name="l13354"></a>13354                   global $spacew;
<a name="l13355"></a>13355                   <span class="keywordflow">while</span> (preg_match(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s](Td|cm|m|l|c|re)[\s]/x&#39;</span>, $pmid, $strpiece, PREG_OFFSET_CAPTURE, $offset) == 1) {
<a name="l13356"></a>13356                     <span class="comment">// check if we are inside a string section &#39;[( ... )]&#39;</span>
<a name="l13357"></a>13357                     $stroffset = strpos($pmid, <span class="stringliteral">&#39;[(&#39;</span>, $offset);
<a name="l13358"></a>13358                     <span class="keywordflow">if</span> (($stroffset !== <span class="keyword">false</span>) AND ($stroffset &lt;= $strpiece[2][1])) {
<a name="l13359"></a>13359                       <span class="comment">// set offset to the end of string section </span>
<a name="l13360"></a>13360                       $offset = strpos($pmid, <span class="stringliteral">&#39;)]&#39;</span>, $stroffset);
<a name="l13361"></a>13361                       <span class="keywordflow">while</span> (($offset !== <span class="keyword">false</span>) AND ($pmid{($offset - 1)} == <span class="charliteral">&#39;\\&#39;</span>)) {
<a name="l13362"></a>13362                         $offset = strpos($pmid, <span class="stringliteral">&#39;)]&#39;</span>, ($offset + 1));
<a name="l13363"></a>13363                       }
<a name="l13364"></a>13364                       <span class="keywordflow">if</span> ($offset === <span class="keyword">false</span>) {
<a name="l13365"></a>13365                         $this-&gt;Error(<span class="stringliteral">&#39;HTML Justification: malformed PDF code.&#39;</span>);
<a name="l13366"></a>13366                       }
<a name="l13367"></a>13367                       <span class="keywordflow">continue</span>;
<a name="l13368"></a>13368                     }
<a name="l13369"></a>13369                     <span class="keywordflow">if</span> ($this-&gt;rtl OR $this-&gt;tmprtl) {
<a name="l13370"></a>13370                       $spacew = ($spacewidth * ($nsmax - $ns));
<a name="l13371"></a>13371                     } <span class="keywordflow">else</span> {
<a name="l13372"></a>13372                       $spacew = ($spacewidth * $ns);
<a name="l13373"></a>13373                     }
<a name="l13374"></a>13374                     $offset = $strpiece[2][1] + strlen($strpiece[2][0]);
<a name="l13375"></a>13375                     $epsposbeg = strpos($pmid, <span class="charliteral">&#39;q&#39;</span>.$this-&gt;epsmarker, $offset);
<a name="l13376"></a>13376                     $epsposend = strpos($pmid, $this-&gt;epsmarker.<span class="charliteral">&#39;Q&#39;</span>, $offset) + strlen($this-&gt;epsmarker.<span class="charliteral">&#39;Q&#39;</span>);
<a name="l13377"></a>13377                     <span class="keywordflow">if</span> ((($epsposbeg &gt; 0) AND ($epsposend &gt; 0) AND ($offset &gt; $epsposbeg) AND ($offset &lt; $epsposend))
<a name="l13378"></a>13378                       OR (($epsposbeg === <span class="keyword">false</span>) AND ($epsposend &gt; 0) AND ($offset &lt; $epsposend))) {
<a name="l13379"></a>13379                       <span class="comment">// shift EPS images</span>
<a name="l13380"></a>13380                       $trx = sprintf(<span class="stringliteral">&#39;1 0 0 1 %.3F 0 cm&#39;</span>, $spacew);
<a name="l13381"></a>13381                       $epsposbeg = strpos($pmid, <span class="charliteral">&#39;q&#39;</span>.$this-&gt;epsmarker, ($prev_epsposbeg - 6));
<a name="l13382"></a>13382                       $pmid_b = substr($pmid, 0, $epsposbeg);
<a name="l13383"></a>13383                       $pmid_m = substr($pmid, $epsposbeg, ($epsposend - $epsposbeg));
<a name="l13384"></a>13384                       $pmid_e = substr($pmid, $epsposend);
<a name="l13385"></a>13385                       $pmid = $pmid_b.<span class="stringliteral">&quot;\nq\n&quot;</span>.$trx.<span class="stringliteral">&quot;\n&quot;</span>.$pmid_m.<span class="stringliteral">&quot;\nQ\n&quot;</span>.$pmid_e;
<a name="l13386"></a>13386                       $offset = $epsposend;
<a name="l13387"></a>13387                       <span class="keywordflow">continue</span>;
<a name="l13388"></a>13388                     }
<a name="l13389"></a>13389                     $prev_epsposbeg = $epsposbeg;
<a name="l13390"></a>13390                     $currentxpos = 0;
<a name="l13391"></a>13391                     <span class="comment">// shift blocks of code</span>
<a name="l13392"></a>13392                     <span class="keywordflow">switch</span> ($strpiece[2][0]) {
<a name="l13393"></a>13393                       <span class="keywordflow">case</span> <span class="stringliteral">&#39;Td&#39;</span>:
<a name="l13394"></a>13394                       <span class="keywordflow">case</span> <span class="stringliteral">&#39;cm&#39;</span>:
<a name="l13395"></a>13395                       <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:
<a name="l13396"></a>13396                       <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>: {
<a name="l13397"></a>13397                         <span class="comment">// get current X position</span>
<a name="l13398"></a>13398                         preg_match(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s](&#39;</span>.$strpiece[1][0].<span class="stringliteral">&#39;)[\s](&#39;</span>.$strpiece[2][0].<span class="stringliteral">&#39;)([\s]*)/x&#39;</span>, $pmid, $xmatches);
<a name="l13399"></a>13399                         $currentxpos = $xmatches[1];
<a name="l13400"></a>13400                         <span class="keywordflow">if</span> (($strcount &lt;= $maxkk) AND ($strpiece[2][0] == <span class="stringliteral">&#39;Td&#39;</span>)) {
<a name="l13401"></a>13401                           <span class="keywordflow">if</span> ($strcount == $maxkk) {
<a name="l13402"></a>13402                             <span class="keywordflow">if</span> ($this-&gt;rtl OR $this-&gt;tmprtl) {
<a name="l13403"></a>13403                               $tvalue = $lnstring[1][$strcount];
<a name="l13404"></a>13404                             } <span class="keywordflow">else</span> {
<a name="l13405"></a>13405                               $tvalue = rtrim($lnstring[1][$strcount]);
<a name="l13406"></a>13406                             }
<a name="l13407"></a>13407                           } <span class="keywordflow">else</span> {
<a name="l13408"></a>13408                             $tvalue = $lnstring[1][$strcount];
<a name="l13409"></a>13409                           }
<a name="l13410"></a>13410                           $ns += substr_count($tvalue, chr(32));
<a name="l13411"></a>13411                           ++$strcount;
<a name="l13412"></a>13412                         }
<a name="l13413"></a>13413                         <span class="keywordflow">if</span> ($this-&gt;rtl OR $this-&gt;tmprtl) {
<a name="l13414"></a>13414                           $spacew = ($spacewidth * ($nsmax - $ns));
<a name="l13415"></a>13415                         }
<a name="l13416"></a>13416                         <span class="comment">// justify block</span>
<a name="l13417"></a>13417                         $pmid = preg_replace_callback(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s](&#39;</span>.$strpiece[1][0].<span class="stringliteral">&#39;)[\s](&#39;</span>.$strpiece[2][0].<span class="stringliteral">&#39;)([\s]*)/x&#39;</span>,
<a name="l13418"></a>13418                           create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;global $spacew;</span>
<a name="l13419"></a>13419 <span class="stringliteral">                          $newx = sprintf(&quot;%.2F&quot;,(floatval($matches[1]) + $spacew));</span>
<a name="l13420"></a>13420 <span class="stringliteral">                          return &quot;&quot;.$newx.&quot; &quot;.$matches[2].&quot; x*#!#*x&quot;.$matches[3].$matches[4];&#39;</span>), $pmid, 1);
<a name="l13421"></a>13421                         <span class="keywordflow">break</span>;
<a name="l13422"></a>13422                       }
<a name="l13423"></a>13423                       <span class="keywordflow">case</span> <span class="stringliteral">&#39;re&#39;</span>: {
<a name="l13424"></a>13424                         <span class="comment">// get current X position</span>
<a name="l13425"></a>13425                         preg_match(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s](&#39;</span>.$strpiece[1][0].<span class="stringliteral">&#39;)[\s](&#39;</span>.$strpiece[2][0].<span class="stringliteral">&#39;)([\s]*)/x&#39;</span>, $pmid, $xmatches);
<a name="l13426"></a>13426                         $currentxpos = $xmatches[1];
<a name="l13427"></a>13427                         <span class="comment">// justify block</span>
<a name="l13428"></a>13428                         $pmid = preg_replace_callback(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s](&#39;</span>.$strpiece[1][0].<span class="stringliteral">&#39;)[\s](&#39;</span>.$strpiece[2][0].<span class="stringliteral">&#39;)([\s]*)/x&#39;</span>,
<a name="l13429"></a>13429                           create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;global $spacew;</span>
<a name="l13430"></a>13430 <span class="stringliteral">                          $newx = sprintf(&quot;%.2F&quot;,(floatval($matches[1]) + $spacew));</span>
<a name="l13431"></a>13431 <span class="stringliteral">                          return &quot;&quot;.$newx.&quot; &quot;.$matches[2].&quot; &quot;.$matches[3].&quot; &quot;.$matches[4].&quot; x*#!#*x&quot;.$matches[5].$matches[6];&#39;</span>), $pmid, 1);
<a name="l13432"></a>13432                         <span class="keywordflow">break</span>;
<a name="l13433"></a>13433                       }
<a name="l13434"></a>13434                       <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>: {
<a name="l13435"></a>13435                         <span class="comment">// get current X position</span>
<a name="l13436"></a>13436                         preg_match(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s](&#39;</span>.$strpiece[1][0].<span class="stringliteral">&#39;)[\s](&#39;</span>.$strpiece[2][0].<span class="stringliteral">&#39;)([\s]*)/x&#39;</span>, $pmid, $xmatches);
<a name="l13437"></a>13437                         $currentxpos = $xmatches[1];
<a name="l13438"></a>13438                         <span class="comment">// justify block</span>
<a name="l13439"></a>13439                         $pmid = preg_replace_callback(<span class="stringliteral">&#39;/([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s]([0-9\.\+\-]*)[\s](&#39;</span>.$strpiece[1][0].<span class="stringliteral">&#39;)[\s](&#39;</span>.$strpiece[2][0].<span class="stringliteral">&#39;)([\s]*)/x&#39;</span>,
<a name="l13440"></a>13440                           create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;global $spacew;</span>
<a name="l13441"></a>13441 <span class="stringliteral">                          $newx1 = sprintf(&quot;%.3F&quot;,(floatval($matches[1]) + $spacew));</span>
<a name="l13442"></a>13442 <span class="stringliteral">                          $newx2 = sprintf(&quot;%.3F&quot;,(floatval($matches[3]) + $spacew));</span>
<a name="l13443"></a>13443 <span class="stringliteral">                          $newx3 = sprintf(&quot;%.3F&quot;,(floatval($matches[5]) + $spacew));</span>
<a name="l13444"></a>13444 <span class="stringliteral">                          return &quot;&quot;.$newx1.&quot; &quot;.$matches[2].&quot; &quot;.$newx2.&quot; &quot;.$matches[4].&quot; &quot;.$newx3.&quot; &quot;.$matches[6].&quot; x*#!#*x&quot;.$matches[7].$matches[8];&#39;</span>), $pmid, 1);
<a name="l13445"></a>13445                         <span class="keywordflow">break</span>;
<a name="l13446"></a>13446                       }
<a name="l13447"></a>13447                     }
<a name="l13448"></a>13448                     <span class="comment">// shift the annotations and links</span>
<a name="l13449"></a>13449                     <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13450"></a>13450                       <span class="keywordflow">foreach</span> ($this-&gt;PageAnnots[$this-&gt;page] as $pak =&gt; $pac) {
<a name="l13451"></a>13451                         <span class="keywordflow">if</span> (($pac[<span class="charliteral">&#39;y&#39;</span>] &gt;= $minstartliney) AND (($pac[<span class="charliteral">&#39;x&#39;</span>] * $this-&gt;k) &gt;= ($currentxpos - $this-&gt;feps)) AND (($pac[<span class="charliteral">&#39;x&#39;</span>] * $this-&gt;k) &lt;= ($currentxpos + $this-&gt;feps))) {
<a name="l13452"></a>13452                           $this-&gt;PageAnnots[$this-&gt;page][$pak][<span class="charliteral">&#39;x&#39;</span>] += ($spacew / $this-&gt;k);
<a name="l13453"></a>13453                           $this-&gt;PageAnnots[$this-&gt;page][$pak][<span class="charliteral">&#39;w&#39;</span>] += (($spacewidth * $pac[<span class="stringliteral">&#39;numspaces&#39;</span>]) / $this-&gt;k);
<a name="l13454"></a>13454                           <span class="keywordflow">break</span>;
<a name="l13455"></a>13455                         }
<a name="l13456"></a>13456                       }
<a name="l13457"></a>13457                     }
<a name="l13458"></a>13458                   } <span class="comment">// end of while</span>
<a name="l13459"></a>13459                   <span class="comment">// remove markers</span>
<a name="l13460"></a>13460                   $pmid = str_replace(<span class="stringliteral">&#39;x*#!#*x&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $pmid);
<a name="l13461"></a>13461                   <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l13462"></a>13462                     <span class="comment">// multibyte characters</span>
<a name="l13463"></a>13463                     $spacew = $spacewidthu;
<a name="l13464"></a>13464                     $pmidtemp = $pmid;
<a name="l13465"></a>13465                     <span class="comment">// escape special characters</span>
<a name="l13466"></a>13466                     $pmidtemp = preg_replace(<span class="stringliteral">&#39;/[\\\][\(]/x&#39;</span>, <span class="stringliteral">&#39;\\#!#OP#!#&#39;</span>, $pmidtemp);
<a name="l13467"></a>13467                     $pmidtemp = preg_replace(<span class="stringliteral">&#39;/[\\\][\)]/x&#39;</span>, <span class="stringliteral">&#39;\\#!#CP#!#&#39;</span>, $pmidtemp);
<a name="l13468"></a>13468                     $pmid = preg_replace_callback(<span class="stringliteral">&quot;/\[\(([^\)]*)\)\]/x&quot;</span>,
<a name="l13469"></a>13469                           create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;global $spacew;</span>
<a name="l13470"></a>13470 <span class="stringliteral">                          $matches[1] = str_replace(&quot;#!#OP#!#&quot;, &quot;(&quot;, $matches[1]);</span>
<a name="l13471"></a>13471 <span class="stringliteral">                          $matches[1] = str_replace(&quot;#!#CP#!#&quot;, &quot;)&quot;, $matches[1]);</span>
<a name="l13472"></a>13472 <span class="stringliteral">                          return &quot;[(&quot;.str_replace(chr(0).chr(32), &quot;) &quot;.($spacew).&quot; (&quot;, $matches[1]).&quot;)]&quot;;&#39;</span>), $pmidtemp);
<a name="l13473"></a>13473                     $this-&gt;setPageBuffer($startlinepage, $pstart.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\n&quot;</span>.$pend);
<a name="l13474"></a>13474                     $endlinepos = strlen($pstart.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l13475"></a>13475                   } <span class="keywordflow">else</span> {
<a name="l13476"></a>13476                     <span class="comment">// non-unicode (single-byte characters)</span>
<a name="l13477"></a>13477                     $rs = sprintf(<span class="stringliteral">&quot;%.3F Tw&quot;</span>, $spacewidth);
<a name="l13478"></a>13478                     $pmid = preg_replace(<span class="stringliteral">&quot;/\[\(/x&quot;</span>, $rs.<span class="stringliteral">&#39; [(&#39;</span>, $pmid);
<a name="l13479"></a>13479                     $this-&gt;setPageBuffer($startlinepage, $pstart.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\nBT 0 Tw ET\n&quot;</span>.$pend);
<a name="l13480"></a>13480                     $endlinepos = strlen($pstart.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\nBT 0 Tw ET\n&quot;</span>);
<a name="l13481"></a>13481                   }
<a name="l13482"></a>13482                 }
<a name="l13483"></a>13483               } <span class="comment">// end of J</span>
<a name="l13484"></a>13484               <span class="keywordflow">if</span> (($t_x != 0) OR ($yshift &lt; 0)) {
<a name="l13485"></a>13485                 <span class="comment">// shift the line</span>
<a name="l13486"></a>13486                 $trx = sprintf(<span class="stringliteral">&#39;1 0 0 1 %.3F %.3F cm&#39;</span>, ($t_x * $this-&gt;k), ($yshift * $this-&gt;k));
<a name="l13487"></a>13487                 $this-&gt;setPageBuffer($startlinepage, $pstart.<span class="stringliteral">&quot;\nq\n&quot;</span>.$trx.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\nQ\n&quot;</span>.$pend);
<a name="l13488"></a>13488                 $endlinepos = strlen($pstart.<span class="stringliteral">&quot;\nq\n&quot;</span>.$trx.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\nQ\n&quot;</span>);
<a name="l13489"></a>13489                 <span class="comment">// shift the annotations and links</span>
<a name="l13490"></a>13490                 <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13491"></a>13491                   <span class="keywordflow">foreach</span> ($this-&gt;PageAnnots[$this-&gt;page] as $pak =&gt; $pac) {
<a name="l13492"></a>13492                     <span class="keywordflow">if</span> ($pak &gt;= $pask) {
<a name="l13493"></a>13493                       $this-&gt;PageAnnots[$this-&gt;page][$pak][<span class="charliteral">&#39;x&#39;</span>] += $t_x;
<a name="l13494"></a>13494                       $this-&gt;PageAnnots[$this-&gt;page][$pak][<span class="charliteral">&#39;y&#39;</span>] -= $yshift;
<a name="l13495"></a>13495                     }
<a name="l13496"></a>13496                   }
<a name="l13497"></a>13497                 }
<a name="l13498"></a>13498                 $this-&gt;y -= $yshift;
<a name="l13499"></a>13499               }
<a name="l13500"></a>13500             }
<a name="l13501"></a>13501           }
<a name="l13502"></a>13502           $this-&gt;newline = <span class="keyword">false</span>;
<a name="l13503"></a>13503           $pbrk = $this-&gt;checkPageBreak($this-&gt;lasth);
<a name="l13504"></a>13504           $this-&gt;SetFont($fontname, $fontstyle, $fontsize);
<a name="l13505"></a>13505           <span class="keywordflow">if</span> ($wfill) {
<a name="l13506"></a>13506             $this-&gt;SetFillColorArray($this-&gt;bgcolor);
<a name="l13507"></a>13507           }
<a name="l13508"></a>13508           $startlinex = $this-&gt;x;
<a name="l13509"></a>13509           $startliney = $this-&gt;y;
<a name="l13510"></a>13510           $minstartliney = $this-&gt;y;
<a name="l13511"></a>13511           $startlinepage = $this-&gt;page;
<a name="l13512"></a>13512           <span class="keywordflow">if</span> (isset($endlinepos) AND (!$pbrk)) {
<a name="l13513"></a>13513             $startlinepos = $endlinepos;
<a name="l13514"></a>13514             unset($endlinepos);
<a name="l13515"></a>13515           } <span class="keywordflow">else</span> {
<a name="l13516"></a>13516             <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$this-&gt;page])) {
<a name="l13517"></a>13517               $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page] - $this-&gt;footerlen[$this-&gt;page];
<a name="l13518"></a>13518             } <span class="keywordflow">else</span> {
<a name="l13519"></a>13519               $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page];
<a name="l13520"></a>13520             }
<a name="l13521"></a>13521             $startlinepos = $this-&gt;footerpos[$this-&gt;page];
<a name="l13522"></a>13522           }
<a name="l13523"></a>13523           $plalign = $lalign;
<a name="l13524"></a>13524           <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13525"></a>13525             $pask = count($this-&gt;PageAnnots[$this-&gt;page]);
<a name="l13526"></a>13526           } <span class="keywordflow">else</span> {
<a name="l13527"></a>13527             $pask = 0;
<a name="l13528"></a>13528           }
<a name="l13529"></a>13529         }
<a name="l13530"></a>13530         <span class="keywordflow">if</span> (isset($opentagpos)) {
<a name="l13531"></a>13531           unset($opentagpos);
<a name="l13532"></a>13532         }
<a name="l13533"></a>13533         <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;tag&#39;</span>]) {
<a name="l13534"></a>13534           <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;opening&#39;</span>]) {
<a name="l13535"></a>13535             <span class="comment">// get text indentation (if any)</span>
<a name="l13536"></a>13536             <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>]) AND in_array($dom[$key][<span class="stringliteral">&#39;value&#39;</span>], array(<span class="stringliteral">&#39;blockquote&#39;</span>,<span class="stringliteral">&#39;dd&#39;</span>,<span class="stringliteral">&#39;div&#39;</span>,<span class="stringliteral">&#39;dt&#39;</span>,<span class="stringliteral">&#39;h1&#39;</span>,<span class="stringliteral">&#39;h2&#39;</span>,<span class="stringliteral">&#39;h3&#39;</span>,<span class="stringliteral">&#39;h4&#39;</span>,<span class="stringliteral">&#39;h5&#39;</span>,<span class="stringliteral">&#39;h6&#39;</span>,<span class="stringliteral">&#39;li&#39;</span>,<span class="stringliteral">&#39;ol&#39;</span>,<span class="charliteral">&#39;p&#39;</span>,<span class="stringliteral">&#39;ul&#39;</span>,<span class="stringliteral">&#39;table&#39;</span>,<span class="stringliteral">&#39;tr&#39;</span>,<span class="stringliteral">&#39;td&#39;</span>))) {
<a name="l13537"></a>13537               $this-&gt;textindent = $dom[$key][<span class="stringliteral">&#39;text-indent&#39;</span>];
<a name="l13538"></a>13538             }
<a name="l13539"></a>13539             <span class="keywordflow">if</span> ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;table&#39;</span>) {
<a name="l13540"></a>13540               <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13541"></a>13541                 $wtmp = $this-&gt;x - $this-&gt;lMargin;
<a name="l13542"></a>13542               } <span class="keywordflow">else</span> {
<a name="l13543"></a>13543                 $wtmp = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l13544"></a>13544               }
<a name="l13545"></a>13545               $wtmp -= (2 * $this-&gt;cMargin);
<a name="l13546"></a>13546               <span class="comment">// calculate cell width</span>
<a name="l13547"></a>13547               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;width&#39;</span>])) {
<a name="l13548"></a>13548                 $table_width = $this-&gt;getHTMLUnitToUnits($dom[$key][<span class="stringliteral">&#39;width&#39;</span>], $wtmp, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13549"></a>13549               } <span class="keywordflow">else</span> {
<a name="l13550"></a>13550                 $table_width = $wtmp;
<a name="l13551"></a>13551               }
<a name="l13552"></a>13552             }
<a name="l13553"></a>13553             <span class="comment">// table content is handled in a special way</span>
<a name="l13554"></a>13554             <span class="keywordflow">if</span> (($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;td&#39;</span>) OR ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;th&#39;</span>)) {
<a name="l13555"></a>13555               $trid = $dom[$key][<span class="stringliteral">&#39;parent&#39;</span>];
<a name="l13556"></a>13556               $table_el = $dom[$trid][<span class="stringliteral">&#39;parent&#39;</span>];
<a name="l13557"></a>13557               <span class="keywordflow">if</span> (!isset($dom[$table_el][<span class="stringliteral">&#39;cols&#39;</span>])) {
<a name="l13558"></a>13558                 $dom[$table_el][<span class="stringliteral">&#39;cols&#39;</span>] = $trid[<span class="stringliteral">&#39;cols&#39;</span>];
<a name="l13559"></a>13559               }
<a name="l13560"></a>13560               $oldmargin = $this-&gt;cMargin;
<a name="l13561"></a>13561               <span class="keywordflow">if</span> (isset($dom[($dom[$trid][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellpadding&#39;</span>])) {
<a name="l13562"></a>13562                 $currentcmargin = $this-&gt;getHTMLUnitToUnits($dom[($dom[$trid][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellpadding&#39;</span>], 1, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13563"></a>13563               } <span class="keywordflow">else</span> {
<a name="l13564"></a>13564                 $currentcmargin = 0;    
<a name="l13565"></a>13565               }
<a name="l13566"></a>13566               $this-&gt;cMargin = $currentcmargin;
<a name="l13567"></a>13567               <span class="keywordflow">if</span> (isset($dom[($dom[$trid][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellspacing&#39;</span>])) {
<a name="l13568"></a>13568                 $cellspacing = $this-&gt;getHTMLUnitToUnits($dom[($dom[$trid][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellspacing&#39;</span>], 1, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13569"></a>13569               } <span class="keywordflow">else</span> {
<a name="l13570"></a>13570                 $cellspacing = 0;
<a name="l13571"></a>13571               }
<a name="l13572"></a>13572               <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13573"></a>13573                 $cellspacingx = -$cellspacing;
<a name="l13574"></a>13574               } <span class="keywordflow">else</span> {
<a name="l13575"></a>13575                 $cellspacingx = $cellspacing;
<a name="l13576"></a>13576               }
<a name="l13577"></a>13577               $colspan = $dom[$key][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;colspan&#39;</span>];
<a name="l13578"></a>13578               $wtmp = ($colspan * ($table_width / $dom[$table_el][<span class="stringliteral">&#39;cols&#39;</span>]));
<a name="l13579"></a>13579               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;width&#39;</span>])) {
<a name="l13580"></a>13580                 $cellw = $this-&gt;getHTMLUnitToUnits($dom[$key][<span class="stringliteral">&#39;width&#39;</span>], $table_width, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13581"></a>13581               } <span class="keywordflow">else</span> {
<a name="l13582"></a>13582                 $cellw = $wtmp;
<a name="l13583"></a>13583               }
<a name="l13584"></a>13584               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;height&#39;</span>])) {
<a name="l13585"></a>13585                 <span class="comment">// minimum cell height</span>
<a name="l13586"></a>13586                 $cellh = $this-&gt;getHTMLUnitToUnits($dom[$key][<span class="stringliteral">&#39;height&#39;</span>], 0, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13587"></a>13587               } <span class="keywordflow">else</span> {
<a name="l13588"></a>13588                 $cellh = 0;
<a name="l13589"></a>13589               }
<a name="l13590"></a>13590               $cellw -= $cellspacing;
<a name="l13591"></a>13591               <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;content&#39;</span>])) {
<a name="l13592"></a>13592                 $cell_content = $dom[$key][<span class="stringliteral">&#39;content&#39;</span>];
<a name="l13593"></a>13593               } <span class="keywordflow">else</span> {
<a name="l13594"></a>13594                 $cell_content = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;
<a name="l13595"></a>13595               }
<a name="l13596"></a>13596               $tagtype = $dom[$key][<span class="stringliteral">&#39;value&#39;</span>];
<a name="l13597"></a>13597               $parentid = $key;
<a name="l13598"></a>13598               <span class="keywordflow">while</span> (($key &lt; $maxel) AND (!(($dom[$key][<span class="stringliteral">&#39;tag&#39;</span>]) AND (!$dom[$key][<span class="stringliteral">&#39;opening&#39;</span>]) AND ($dom[$key][<span class="stringliteral">&#39;value&#39;</span>] == $tagtype) AND ($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>] == $parentid)))) {
<a name="l13599"></a>13599                 <span class="comment">// move $key index forward</span>
<a name="l13600"></a>13600                 ++$key;
<a name="l13601"></a>13601               }
<a name="l13602"></a>13602               <span class="keywordflow">if</span> (!isset($dom[$trid][<span class="stringliteral">&#39;startpage&#39;</span>])) {
<a name="l13603"></a>13603                 $dom[$trid][<span class="stringliteral">&#39;startpage&#39;</span>] = $this-&gt;page;
<a name="l13604"></a>13604               } <span class="keywordflow">else</span> {
<a name="l13605"></a>13605                 $this-&gt;setPage($dom[$trid][<span class="stringliteral">&#39;startpage&#39;</span>]);
<a name="l13606"></a>13606               }
<a name="l13607"></a>13607               <span class="keywordflow">if</span> (!isset($dom[$trid][<span class="stringliteral">&#39;starty&#39;</span>])) {
<a name="l13608"></a>13608                 $dom[$trid][<span class="stringliteral">&#39;starty&#39;</span>] = $this-&gt;y;
<a name="l13609"></a>13609               } <span class="keywordflow">else</span> {
<a name="l13610"></a>13610                 $this-&gt;y = $dom[$trid][<span class="stringliteral">&#39;starty&#39;</span>];
<a name="l13611"></a>13611               }
<a name="l13612"></a>13612               <span class="keywordflow">if</span> (!isset($dom[$trid][<span class="stringliteral">&#39;startx&#39;</span>])) {
<a name="l13613"></a>13613                 $dom[$trid][<span class="stringliteral">&#39;startx&#39;</span>] = $this-&gt;x;
<a name="l13614"></a>13614               }
<a name="l13615"></a>13615               $this-&gt;x += ($cellspacingx / 2);            
<a name="l13616"></a>13616               <span class="keywordflow">if</span> (isset($dom[$parentid][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;rowspan&#39;</span>])) {
<a name="l13617"></a>13617                 $rowspan = intval($dom[$parentid][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;rowspan&#39;</span>]);
<a name="l13618"></a>13618               } <span class="keywordflow">else</span> {
<a name="l13619"></a>13619                 $rowspan = 1;
<a name="l13620"></a>13620               }
<a name="l13621"></a>13621               <span class="comment">// skip row-spanned cells started on the previous rows</span>
<a name="l13622"></a>13622               <span class="keywordflow">if</span> (isset($dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>])) {
<a name="l13623"></a>13623                 $rsk = 0;
<a name="l13624"></a>13624                 $rskmax = count($dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>]);
<a name="l13625"></a>13625                 <span class="keywordflow">while</span> ($rsk &lt; $rskmax) {
<a name="l13626"></a>13626                   $trwsp = $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][$rsk];
<a name="l13627"></a>13627                   $rsstartx = $trwsp[<span class="stringliteral">&#39;startx&#39;</span>];
<a name="l13628"></a>13628                   $rsendx = $trwsp[<span class="stringliteral">&#39;endx&#39;</span>];
<a name="l13629"></a>13629                   <span class="comment">// account for margin changes</span>
<a name="l13630"></a>13630                   <span class="keywordflow">if</span> ($trwsp[<span class="stringliteral">&#39;startpage&#39;</span>] &lt; $this-&gt;page) {
<a name="l13631"></a>13631                     <span class="keywordflow">if</span> (($this-&gt;rtl) AND ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>] != $this-&gt;pagedim[$trwsp[<span class="stringliteral">&#39;startpage&#39;</span>]][<span class="stringliteral">&#39;orm&#39;</span>])) {
<a name="l13632"></a>13632                       $dl = ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>] - $this-&gt;pagedim[$trwsp[<span class="stringliteral">&#39;startpage&#39;</span>]][<span class="stringliteral">&#39;orm&#39;</span>]);
<a name="l13633"></a>13633                       $rsstartx -= $dl;
<a name="l13634"></a>13634                       $rsendx -= $dl;
<a name="l13635"></a>13635                     } elseif ((!$this-&gt;rtl) AND ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>] != $this-&gt;pagedim[$trwsp[<span class="stringliteral">&#39;startpage&#39;</span>]][<span class="stringliteral">&#39;olm&#39;</span>])) {
<a name="l13636"></a>13636                       $dl = ($this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>] - $this-&gt;pagedim[$trwsp[<span class="stringliteral">&#39;startpage&#39;</span>]][<span class="stringliteral">&#39;olm&#39;</span>]);
<a name="l13637"></a>13637                       $rsstartx += $dl;
<a name="l13638"></a>13638                       $rsendx += $dl;
<a name="l13639"></a>13639                     }
<a name="l13640"></a>13640                   }
<a name="l13641"></a>13641                   <span class="keywordflow">if</span>  (($trwsp[<span class="stringliteral">&#39;rowspan&#39;</span>] &gt; 0)
<a name="l13642"></a>13642                     AND ($rsstartx &gt; ($this-&gt;x - $cellspacing - $currentcmargin - $this-&gt;feps))
<a name="l13643"></a>13643                     AND ($rsstartx &lt; ($this-&gt;x + $cellspacing + $currentcmargin + $this-&gt;feps))
<a name="l13644"></a>13644                     AND (($trwsp[&#39;starty&#39;] &lt; ($this-&gt;y - $this-&gt;feps)) OR ($trwsp[&#39;startpage&#39;] &lt; $this-&gt;page))) {
<a name="l13645"></a>13645                     <span class="comment">// set the starting X position of the current cell</span>
<a name="l13646"></a>13646                     $this-&gt;x = $rsendx + $cellspacingx;
<a name="l13647"></a>13647                     <span class="keywordflow">if</span> (($trwsp[<span class="stringliteral">&#39;rowspan&#39;</span>] == 1)
<a name="l13648"></a>13648                       AND (isset($dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>]))
<a name="l13649"></a>13649                       AND (isset($dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]))
<a name="l13650"></a>13650                       AND ($trwsp[<span class="stringliteral">&#39;endpage&#39;</span>] == $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>])) {
<a name="l13651"></a>13651                       <span class="comment">// set ending Y position for row</span>
<a name="l13652"></a>13652                       $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][$rsk][<span class="stringliteral">&#39;endy&#39;</span>] = max($dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>], $trwsp[<span class="stringliteral">&#39;endy&#39;</span>]);
<a name="l13653"></a>13653                       $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>] = $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][$rsk][<span class="stringliteral">&#39;endy&#39;</span>];
<a name="l13654"></a>13654                     }
<a name="l13655"></a>13655                     $rsk = 0;
<a name="l13656"></a>13656                   } <span class="keywordflow">else</span> {
<a name="l13657"></a>13657                     ++$rsk;
<a name="l13658"></a>13658                   }
<a name="l13659"></a>13659                 }
<a name="l13660"></a>13660               }
<a name="l13661"></a>13661               <span class="comment">// add rowspan information to table element</span>
<a name="l13662"></a>13662               <span class="keywordflow">if</span> ($rowspan &gt; 1) {
<a name="l13663"></a>13663                 <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$this-&gt;page])) {
<a name="l13664"></a>13664                   $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page] - $this-&gt;footerlen[$this-&gt;page];
<a name="l13665"></a>13665                 } <span class="keywordflow">else</span> {
<a name="l13666"></a>13666                   $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page];
<a name="l13667"></a>13667                 }
<a name="l13668"></a>13668                 $trintmrkpos = $this-&gt;footerpos[$this-&gt;page];
<a name="l13669"></a>13669                 $trsid = array_push($dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>], array(<span class="stringliteral">&#39;trid&#39;</span> =&gt; $trid, <span class="stringliteral">&#39;rowspan&#39;</span> =&gt; $rowspan, <span class="stringliteral">&#39;mrowspan&#39;</span> =&gt; $rowspan, <span class="stringliteral">&#39;colspan&#39;</span> =&gt; $colspan, <span class="stringliteral">&#39;startpage&#39;</span> =&gt; $this-&gt;page, <span class="stringliteral">&#39;startx&#39;</span> =&gt; $this-&gt;x, <span class="stringliteral">&#39;starty&#39;</span> =&gt; $this-&gt;y, <span class="stringliteral">&#39;intmrkpos&#39;</span> =&gt; $trintmrkpos));
<a name="l13670"></a>13670               }
<a name="l13671"></a>13671               $cellid = array_push($dom[$trid][<span class="stringliteral">&#39;cellpos&#39;</span>], array(<span class="stringliteral">&#39;startx&#39;</span> =&gt; $this-&gt;x));
<a name="l13672"></a>13672               <span class="keywordflow">if</span> ($rowspan &gt; 1) {
<a name="l13673"></a>13673                 $dom[$trid][<span class="stringliteral">&#39;cellpos&#39;</span>][($cellid - 1)][<span class="stringliteral">&#39;rowspanid&#39;</span>] = ($trsid - 1);
<a name="l13674"></a>13674               }
<a name="l13675"></a>13675               <span class="comment">// push background colors</span>
<a name="l13676"></a>13676               <span class="keywordflow">if</span> (isset($dom[$parentid][<span class="stringliteral">&#39;bgcolor&#39;</span>]) AND ($dom[$parentid][<span class="stringliteral">&#39;bgcolor&#39;</span>] !== <span class="keyword">false</span>)) {
<a name="l13677"></a>13677                 $dom[$trid][<span class="stringliteral">&#39;cellpos&#39;</span>][($cellid - 1)][<span class="stringliteral">&#39;bgcolor&#39;</span>] = $dom[$parentid][<span class="stringliteral">&#39;bgcolor&#39;</span>];
<a name="l13678"></a>13678               }
<a name="l13679"></a>13679               $prevLastH = $this-&gt;lasth;
<a name="l13680"></a>13680               <span class="comment">// ****** write the cell content ******</span>
<a name="l13681"></a>13681               $this-&gt;MultiCell($cellw, $cellh, $cell_content, <span class="keyword">false</span>, $lalign, <span class="keyword">false</span>, 2, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">true</span>, 0, <span class="keyword">true</span>);
<a name="l13682"></a>13682               $this-&gt;lasth = $prevLastH;
<a name="l13683"></a>13683               $this-&gt;cMargin = $oldmargin;
<a name="l13684"></a>13684               $dom[$trid][<span class="stringliteral">&#39;cellpos&#39;</span>][($cellid - 1)][<span class="stringliteral">&#39;endx&#39;</span>] = $this-&gt;x;
<a name="l13685"></a>13685               <span class="comment">// update the end of row position</span>
<a name="l13686"></a>13686               <span class="keywordflow">if</span> ($rowspan &lt;= 1) {
<a name="l13687"></a>13687                 <span class="keywordflow">if</span> (isset($dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>])) {
<a name="l13688"></a>13688                   <span class="keywordflow">if</span> ($this-&gt;page == $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]) {
<a name="l13689"></a>13689                     $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>] = max($this-&gt;y, $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>]);
<a name="l13690"></a>13690                   } elseif ($this-&gt;page &gt; $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]) {
<a name="l13691"></a>13691                     $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>] = $this-&gt;y;
<a name="l13692"></a>13692                   }
<a name="l13693"></a>13693                 } <span class="keywordflow">else</span> {
<a name="l13694"></a>13694                   $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>] = $this-&gt;y;
<a name="l13695"></a>13695                 }
<a name="l13696"></a>13696                 <span class="keywordflow">if</span> (isset($dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>])) {
<a name="l13697"></a>13697                   $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>] = max($this-&gt;page, $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]);
<a name="l13698"></a>13698                 } <span class="keywordflow">else</span> {
<a name="l13699"></a>13699                   $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>] = $this-&gt;page;
<a name="l13700"></a>13700                 }               
<a name="l13701"></a>13701               } <span class="keywordflow">else</span> {
<a name="l13702"></a>13702                 <span class="comment">// account for row-spanned cells</span>
<a name="l13703"></a>13703                 $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][($trsid - 1)][<span class="stringliteral">&#39;endx&#39;</span>] = $this-&gt;x;
<a name="l13704"></a>13704                 $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][($trsid - 1)][<span class="stringliteral">&#39;endy&#39;</span>] = $this-&gt;y;
<a name="l13705"></a>13705                 $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][($trsid - 1)][<span class="stringliteral">&#39;endpage&#39;</span>] = $this-&gt;page;
<a name="l13706"></a>13706               }
<a name="l13707"></a>13707               <span class="keywordflow">if</span> (isset($dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>])) {
<a name="l13708"></a>13708                 <span class="comment">// update endy and endpage on rowspanned cells</span>
<a name="l13709"></a>13709                 <span class="keywordflow">foreach</span> ($dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>] as $k =&gt; $trwsp) {
<a name="l13710"></a>13710                   <span class="keywordflow">if</span> ($trwsp[<span class="stringliteral">&#39;rowspan&#39;</span>] &gt; 0) {
<a name="l13711"></a>13711                     <span class="keywordflow">if</span> (isset($dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>])) {
<a name="l13712"></a>13712                       <span class="keywordflow">if</span> ($trwsp[<span class="stringliteral">&#39;endpage&#39;</span>] == $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]) {
<a name="l13713"></a>13713                         $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][$k][<span class="stringliteral">&#39;endy&#39;</span>] = max($dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>], $trwsp[<span class="stringliteral">&#39;endy&#39;</span>]);
<a name="l13714"></a>13714                       } elseif ($trwsp[<span class="stringliteral">&#39;endpage&#39;</span>] &lt; $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]) {
<a name="l13715"></a>13715                         $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][$k][<span class="stringliteral">&#39;endy&#39;</span>] = $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>];
<a name="l13716"></a>13716                         $dom[$table_el][<span class="stringliteral">&#39;rowspans&#39;</span>][$k][<span class="stringliteral">&#39;endpage&#39;</span>] = $dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>];
<a name="l13717"></a>13717                       } <span class="keywordflow">else</span> {
<a name="l13718"></a>13718                         $dom[$trid][<span class="stringliteral">&#39;endy&#39;</span>] = $this-&gt;pagedim[$dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]][<span class="stringliteral">&#39;hk&#39;</span>] - $this-&gt;pagedim[$dom[$trid][<span class="stringliteral">&#39;endpage&#39;</span>]][<span class="stringliteral">&#39;bm&#39;</span>];
<a name="l13719"></a>13719                       }
<a name="l13720"></a>13720                     }
<a name="l13721"></a>13721                   }
<a name="l13722"></a>13722                 }
<a name="l13723"></a>13723               }
<a name="l13724"></a>13724               $this-&gt;x += ($cellspacingx / 2);
<a name="l13725"></a>13725             } <span class="keywordflow">else</span> {
<a name="l13726"></a>13726               <span class="comment">// opening tag (or self-closing tag)</span>
<a name="l13727"></a>13727               <span class="keywordflow">if</span> (!isset($opentagpos)) {
<a name="l13728"></a>13728                 <span class="keywordflow">if</span> (!$this-&gt;InFooter) {
<a name="l13729"></a>13729                   <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$this-&gt;page])) {
<a name="l13730"></a>13730                     $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page] - $this-&gt;footerlen[$this-&gt;page];
<a name="l13731"></a>13731                   } <span class="keywordflow">else</span> {
<a name="l13732"></a>13732                     $this-&gt;footerpos[$this-&gt;page] = $this-&gt;pagelen[$this-&gt;page];
<a name="l13733"></a>13733                   }
<a name="l13734"></a>13734                   $opentagpos = $this-&gt;footerpos[$this-&gt;page];
<a name="l13735"></a>13735                 }
<a name="l13736"></a>13736               }
<a name="l13737"></a>13737               $this-&gt;openHTMLTagHandler($dom, $key, $cell);
<a name="l13738"></a>13738             }
<a name="l13739"></a>13739           } <span class="keywordflow">else</span> {
<a name="l13740"></a>13740             <span class="comment">// closing tag</span>
<a name="l13741"></a>13741             $this-&gt;closeHTMLTagHandler($dom, $key, $cell);
<a name="l13742"></a>13742           }
<a name="l13743"></a>13743         } elseif (strlen($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]) &gt; 0) {
<a name="l13744"></a>13744           <span class="comment">// print list-item</span>
<a name="l13745"></a>13745           <span class="keywordflow">if</span> (!$this-&gt;empty_string($this-&gt;lispacer)) {
<a name="l13746"></a>13746             $this-&gt;SetFont($pfontname, $pfontstyle, $pfontsize);
<a name="l13747"></a>13747             $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l13748"></a>13748             $minstartliney = $this-&gt;y;
<a name="l13749"></a>13749             $this-&gt;putHtmlListBullet($this-&gt;listnum, $this-&gt;lispacer, $pfontsize);
<a name="l13750"></a>13750             $this-&gt;SetFont($curfontname, $curfontstyle, $curfontsize);
<a name="l13751"></a>13751             $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l13752"></a>13752             <span class="keywordflow">if</span> (is_numeric($pfontsize) AND ($pfontsize &gt; 0) AND is_numeric($curfontsize) AND ($curfontsize &gt; 0) AND ($pfontsize != $curfontsize)) {
<a name="l13753"></a>13753               $this-&gt;y += (($pfontsize - $curfontsize) / $this-&gt;k);
<a name="l13754"></a>13754               $minstartliney = min($this-&gt;y, $minstartliney);
<a name="l13755"></a>13755             }
<a name="l13756"></a>13756           }
<a name="l13757"></a>13757           <span class="comment">// text</span>
<a name="l13758"></a>13758           $this-&gt;htmlvspace = 0;
<a name="l13759"></a>13759           <span class="keywordflow">if</span> ((!$this-&gt;premode) AND ($this-&gt;rtl OR $this-&gt;tmprtl)) {
<a name="l13760"></a>13760             <span class="comment">// reverse spaces order</span>
<a name="l13761"></a>13761             $len1 = strlen($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]);
<a name="l13762"></a>13762             $lsp = $len1 - strlen(ltrim($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]));
<a name="l13763"></a>13763             $rsp = $len1 - strlen(rtrim($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]));
<a name="l13764"></a>13764             $tmpstr = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13765"></a>13765             <span class="keywordflow">if</span> ($rsp &gt; 0) {
<a name="l13766"></a>13766               $tmpstr .= substr($dom[$key][<span class="stringliteral">&#39;value&#39;</span>], -$rsp);
<a name="l13767"></a>13767             }
<a name="l13768"></a>13768             $tmpstr .= trim($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]);
<a name="l13769"></a>13769             <span class="keywordflow">if</span> ($lsp &gt; 0) {
<a name="l13770"></a>13770               $tmpstr .= substr($dom[$key][<span class="stringliteral">&#39;value&#39;</span>], 0, $lsp);
<a name="l13771"></a>13771             }
<a name="l13772"></a>13772             $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = $tmpstr;
<a name="l13773"></a>13773           }
<a name="l13774"></a>13774           <span class="keywordflow">if</span> ($newline) {
<a name="l13775"></a>13775             <span class="keywordflow">if</span> (!$this-&gt;premode) {
<a name="l13776"></a>13776               <span class="keywordflow">if</span> (($this-&gt;rtl OR $this-&gt;tmprtl)) {
<a name="l13777"></a>13777                 $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = rtrim($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]);
<a name="l13778"></a>13778               } <span class="keywordflow">else</span> {
<a name="l13779"></a>13779                 $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = ltrim($dom[$key][<span class="stringliteral">&#39;value&#39;</span>]);
<a name="l13780"></a>13780               }
<a name="l13781"></a>13781             }
<a name="l13782"></a>13782             $newline = <span class="keyword">false</span>;
<a name="l13783"></a>13783             $firstblock = <span class="keyword">true</span>;
<a name="l13784"></a>13784           } <span class="keywordflow">else</span> {
<a name="l13785"></a>13785             $firstblock = <span class="keyword">false</span>;
<a name="l13786"></a>13786           }
<a name="l13787"></a>13787           $strrest = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13788"></a>13788           <span class="keywordflow">if</span> (!empty($this-&gt;HREF) AND (isset($this-&gt;HREF[<span class="stringliteral">&#39;url&#39;</span>]))) {
<a name="l13789"></a>13789             <span class="comment">// HTML &lt;a&gt; Link</span>
<a name="l13790"></a>13790             $strrest = $this-&gt;addHtmlLink($this-&gt;HREF[<span class="stringliteral">&#39;url&#39;</span>], $dom[$key][<span class="stringliteral">&#39;value&#39;</span>], $wfill, <span class="keyword">true</span>, $this-&gt;HREF[<span class="stringliteral">&#39;color&#39;</span>], $this-&gt;HREF[<span class="stringliteral">&#39;style&#39;</span>]);
<a name="l13791"></a>13791           } <span class="keywordflow">else</span> {
<a name="l13792"></a>13792             $ctmpmargin = $this-&gt;cMargin;
<a name="l13793"></a>13793             $this-&gt;cMargin = 0;
<a name="l13794"></a>13794             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13795"></a>13795               $this-&gt;x -= $this-&gt;textindent;
<a name="l13796"></a>13796             } <span class="keywordflow">else</span> {
<a name="l13797"></a>13797               $this-&gt;x += $this-&gt;textindent;
<a name="l13798"></a>13798             }
<a name="l13799"></a>13799             <span class="comment">// ****** write only until the end of the line and get the rest ******</span>
<a name="l13800"></a>13800             $strrest = $this-&gt;Write($this-&gt;lasth, $dom[$key][<span class="stringliteral">&#39;value&#39;</span>], <span class="stringliteral">&#39;&#39;</span>, $wfill, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, 0, <span class="keyword">true</span>, $firstblock);
<a name="l13801"></a>13801             $this-&gt;textindent = 0;
<a name="l13802"></a>13802             $this-&gt;cMargin = $ctmpmargin;
<a name="l13803"></a>13803           }
<a name="l13804"></a>13804           <span class="keywordflow">if</span> (strlen($strrest) &gt; 0) {
<a name="l13805"></a>13805             <span class="comment">// store the remaining string on the previous $key position</span>
<a name="l13806"></a>13806             $this-&gt;newline = <span class="keyword">true</span>;
<a name="l13807"></a>13807             <span class="keywordflow">if</span> ($cell) {
<a name="l13808"></a>13808               <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13809"></a>13809                 $this-&gt;x -= $this-&gt;cMargin;
<a name="l13810"></a>13810               } <span class="keywordflow">else</span> {
<a name="l13811"></a>13811                 $this-&gt;x += $this-&gt;cMargin;
<a name="l13812"></a>13812               }
<a name="l13813"></a>13813             }
<a name="l13814"></a>13814             <span class="keywordflow">if</span> ($strrest == $dom[$key][<span class="stringliteral">&#39;value&#39;</span>]) {
<a name="l13815"></a>13815               <span class="comment">// used to avoid infinite loop</span>
<a name="l13816"></a>13816               ++$loop;
<a name="l13817"></a>13817             } <span class="keywordflow">else</span> {
<a name="l13818"></a>13818               $loop = 0;
<a name="l13819"></a>13819             }
<a name="l13820"></a>13820             $dom[$key][<span class="stringliteral">&#39;value&#39;</span>] = ltrim($strrest);
<a name="l13821"></a>13821             <span class="keywordflow">if</span> ($loop &lt; 3) {
<a name="l13822"></a>13822               --$key;
<a name="l13823"></a>13823             }
<a name="l13824"></a>13824           } <span class="keywordflow">else</span> {
<a name="l13825"></a>13825             $loop = 0;
<a name="l13826"></a>13826           }
<a name="l13827"></a>13827         }
<a name="l13828"></a>13828         ++$key;
<a name="l13829"></a>13829         <span class="keywordflow">if</span> (isset($dom[$key][<span class="stringliteral">&#39;tag&#39;</span>]) AND $dom[$key][<span class="stringliteral">&#39;tag&#39;</span>] AND (!isset($dom[$key][<span class="stringliteral">&#39;opening&#39;</span>]) OR !$dom[$key][<span class="stringliteral">&#39;opening&#39;</span>]) AND isset($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>]) AND ($dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])][<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;nobr&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>)) {
<a name="l13830"></a>13830           <span class="keywordflow">if</span> ((!$undo) AND ($this-&gt;start_transaction_page == ($this-&gt;numpages - 1))) {
<a name="l13831"></a>13831             <span class="comment">// restore previous object</span>
<a name="l13832"></a>13832             $this-&gt;rollbackTransaction(<span class="keyword">true</span>);
<a name="l13833"></a>13833             <span class="comment">// restore previous values</span>
<a name="l13834"></a>13834             <span class="keywordflow">foreach</span> ($this_method_vars as $vkey =&gt; $vval) {
<a name="l13835"></a>13835               $$vkey = $vval;
<a name="l13836"></a>13836             }
<a name="l13837"></a>13837             <span class="comment">// add a page</span>
<a name="l13838"></a>13838             $this-&gt;AddPage();
<a name="l13839"></a>13839             $undo = <span class="keyword">true</span>; <span class="comment">// avoid infinite loop</span>
<a name="l13840"></a>13840           } <span class="keywordflow">else</span> {
<a name="l13841"></a>13841             $undo = <span class="keyword">false</span>;
<a name="l13842"></a>13842           }
<a name="l13843"></a>13843         }
<a name="l13844"></a>13844       } <span class="comment">// end for each $key</span>
<a name="l13845"></a>13845       <span class="comment">// align the last line</span>
<a name="l13846"></a>13846       <span class="keywordflow">if</span> (isset($startlinex)) {
<a name="l13847"></a>13847         $yshift = $minstartliney - $startliney;
<a name="l13848"></a>13848         <span class="keywordflow">if</span> (($yshift &gt; 0) OR ($this-&gt;page &gt; $startlinepage)) {
<a name="l13849"></a>13849           $yshift = 0;
<a name="l13850"></a>13850         }
<a name="l13851"></a>13851         <span class="keywordflow">if</span> ((isset($plalign) AND ((($plalign == <span class="charliteral">&#39;C&#39;</span>) OR ($plalign == <span class="charliteral">&#39;J&#39;</span>) OR (($plalign == <span class="charliteral">&#39;R&#39;</span>) AND (!$this-&gt;rtl)) OR (($plalign == <span class="charliteral">&#39;L&#39;</span>) AND ($this-&gt;rtl))))) OR ($yshift &lt; 0)) {
<a name="l13852"></a>13852           <span class="comment">// the last line must be shifted to be aligned as requested</span>
<a name="l13853"></a>13853           $linew = abs($this-&gt;endlinex - $startlinex);
<a name="l13854"></a>13854           $pstart = substr($this-&gt;getPageBuffer($startlinepage), 0, $startlinepos);
<a name="l13855"></a>13855           <span class="keywordflow">if</span> (isset($opentagpos) AND isset($this-&gt;footerlen[$startlinepage]) AND (!$this-&gt;InFooter)) {
<a name="l13856"></a>13856             $this-&gt;footerpos[$startlinepage] = $this-&gt;pagelen[$startlinepage] - $this-&gt;footerlen[$startlinepage];
<a name="l13857"></a>13857             $midpos = min($opentagpos, $this-&gt;footerpos[$startlinepage]);
<a name="l13858"></a>13858           } elseif (isset($opentagpos)) {
<a name="l13859"></a>13859             $midpos = $opentagpos;
<a name="l13860"></a>13860           } elseif (isset($this-&gt;footerlen[$startlinepage]) AND (!$this-&gt;InFooter)) {
<a name="l13861"></a>13861             $this-&gt;footerpos[$startlinepage] = $this-&gt;pagelen[$startlinepage] - $this-&gt;footerlen[$startlinepage];
<a name="l13862"></a>13862             $midpos = $this-&gt;footerpos[$startlinepage];
<a name="l13863"></a>13863           } <span class="keywordflow">else</span> {
<a name="l13864"></a>13864             $midpos = 0;
<a name="l13865"></a>13865           }
<a name="l13866"></a>13866           <span class="keywordflow">if</span> ($midpos &gt; 0) {
<a name="l13867"></a>13867             $pmid = substr($this-&gt;getPageBuffer($startlinepage), $startlinepos, ($midpos - $startlinepos));
<a name="l13868"></a>13868             $pend = substr($this-&gt;getPageBuffer($startlinepage), $midpos);
<a name="l13869"></a>13869           } <span class="keywordflow">else</span> {
<a name="l13870"></a>13870             $pmid = substr($this-&gt;getPageBuffer($startlinepage), $startlinepos);
<a name="l13871"></a>13871             $pend = <span class="stringliteral">&#39;&#39;</span>;
<a name="l13872"></a>13872           } 
<a name="l13873"></a>13873           <span class="comment">// calculate shifting amount</span>
<a name="l13874"></a>13874           $tw = $w;
<a name="l13875"></a>13875           <span class="keywordflow">if</span> ($this-&gt;lMargin != $prevlMargin) {
<a name="l13876"></a>13876             $tw += ($prevlMargin - $this-&gt;lMargin);
<a name="l13877"></a>13877           }
<a name="l13878"></a>13878           <span class="keywordflow">if</span> ($this-&gt;rMargin != $prevrMargin) {
<a name="l13879"></a>13879             $tw += ($prevrMargin - $this-&gt;rMargin);
<a name="l13880"></a>13880           }
<a name="l13881"></a>13881           $mdiff = abs($tw - $linew);
<a name="l13882"></a>13882           <span class="keywordflow">if</span> ($plalign == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l13883"></a>13883             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l13884"></a>13884               $t_x = -($mdiff / 2);
<a name="l13885"></a>13885             } <span class="keywordflow">else</span> {
<a name="l13886"></a>13886               $t_x = ($mdiff / 2);
<a name="l13887"></a>13887             }
<a name="l13888"></a>13888           } elseif (($plalign == <span class="charliteral">&#39;R&#39;</span>) AND (!$this-&gt;rtl)) {
<a name="l13889"></a>13889             <span class="comment">// right alignment on LTR document</span>
<a name="l13890"></a>13890             $t_x = $mdiff;
<a name="l13891"></a>13891           } elseif (($plalign == <span class="charliteral">&#39;L&#39;</span>) AND ($this-&gt;rtl)) {
<a name="l13892"></a>13892             <span class="comment">// left alignment on RTL document</span>
<a name="l13893"></a>13893             $t_x = -$mdiff;
<a name="l13894"></a>13894           } <span class="keywordflow">else</span> {
<a name="l13895"></a>13895             $t_x = 0;
<a name="l13896"></a>13896           }
<a name="l13897"></a>13897           <span class="keywordflow">if</span> (($t_x != 0) OR ($yshift &lt; 0)) {
<a name="l13898"></a>13898             <span class="comment">// shift the line</span>
<a name="l13899"></a>13899             $trx = sprintf(<span class="stringliteral">&#39;1 0 0 1 %.3F %.3F cm&#39;</span>, ($t_x * $this-&gt;k), ($yshift * $this-&gt;k));
<a name="l13900"></a>13900             $this-&gt;setPageBuffer($startlinepage, $pstart.<span class="stringliteral">&quot;\nq\n&quot;</span>.$trx.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\nQ\n&quot;</span>.$pend);
<a name="l13901"></a>13901             $endlinepos = strlen($pstart.<span class="stringliteral">&quot;\nq\n&quot;</span>.$trx.<span class="stringliteral">&quot;\n&quot;</span>.$pmid.<span class="stringliteral">&quot;\nQ\n&quot;</span>);
<a name="l13902"></a>13902             <span class="comment">// shift the annotations and links</span>
<a name="l13903"></a>13903             <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;page])) {
<a name="l13904"></a>13904               <span class="keywordflow">foreach</span> ($this-&gt;PageAnnots[$this-&gt;page] as $pak =&gt; $pac) {
<a name="l13905"></a>13905                 <span class="keywordflow">if</span> ($pak &gt;= $pask) {
<a name="l13906"></a>13906                   $this-&gt;PageAnnots[$this-&gt;page][$pak][<span class="charliteral">&#39;x&#39;</span>] += $t_x;
<a name="l13907"></a>13907                   $this-&gt;PageAnnots[$this-&gt;page][$pak][<span class="charliteral">&#39;y&#39;</span>] -= $yshift;
<a name="l13908"></a>13908                 }
<a name="l13909"></a>13909               }
<a name="l13910"></a>13910             }
<a name="l13911"></a>13911             $this-&gt;y -= $yshift;
<a name="l13912"></a>13912           }
<a name="l13913"></a>13913         }
<a name="l13914"></a>13914       }
<a name="l13915"></a>13915       <span class="keywordflow">if</span> ($ln AND (!($cell AND ($dom[$key-1][<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;table&#39;</span>)))) {
<a name="l13916"></a>13916         $this-&gt;Ln($this-&gt;lasth);
<a name="l13917"></a>13917       }
<a name="l13918"></a>13918       <span class="comment">// restore previous values</span>
<a name="l13919"></a>13919       $this-&gt;setGraphicVars($gvars);
<a name="l13920"></a>13920       <span class="keywordflow">if</span> ($this-&gt;page &gt; $prevPage) {
<a name="l13921"></a>13921         $this-&gt;lMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;olm&#39;</span>];
<a name="l13922"></a>13922         $this-&gt;rMargin = $this-&gt;pagedim[$this-&gt;page][<span class="stringliteral">&#39;orm&#39;</span>];
<a name="l13923"></a>13923       }
<a name="l13924"></a>13924       <span class="comment">// restore previous list state</span>
<a name="l13925"></a>13925       $this-&gt;listnum = $prev_listnum;
<a name="l13926"></a>13926       $this-&gt;listordered = $prev_listordered;
<a name="l13927"></a>13927       $this-&gt;listcount = $prev_listcount;
<a name="l13928"></a>13928       $this-&gt;lispacer = $prev_lispacer;
<a name="l13929"></a>13929       unset($dom);
<a name="l13930"></a>13930     }
<a name="l13931"></a>13931     
<a name="l13939"></a>13939     <span class="keyword">protected</span> function openHTMLTagHandler(&amp;$dom, $key, $cell=<span class="keyword">false</span>) {
<a name="l13940"></a>13940       $tag = $dom[$key];
<a name="l13941"></a>13941       $parent = $dom[($dom[$key][<span class="stringliteral">&#39;parent&#39;</span>])];
<a name="l13942"></a>13942       $firstorlast = ($key == 1);
<a name="l13943"></a>13943       <span class="comment">// check for text direction attribute</span>
<a name="l13944"></a>13944       <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;dir&#39;</span>])) {
<a name="l13945"></a>13945         $this-&gt;tmprtl = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;dir&#39;</span>] == <span class="stringliteral">&#39;rtl&#39;</span> ? <span class="charliteral">&#39;R&#39;</span> : <span class="charliteral">&#39;L&#39;</span>;
<a name="l13946"></a>13946       } <span class="keywordflow">else</span> {
<a name="l13947"></a>13947         $this-&gt;tmprtl = <span class="keyword">false</span>;
<a name="l13948"></a>13948       }
<a name="l13949"></a>13949       <span class="comment">//Opening tag</span>
<a name="l13950"></a>13950       <span class="keywordflow">switch</span>($tag[<span class="stringliteral">&#39;value&#39;</span>]) {
<a name="l13951"></a>13951         <span class="keywordflow">case</span> <span class="stringliteral">&#39;table&#39;</span>: {
<a name="l13952"></a>13952           $cp = 0;
<a name="l13953"></a>13953           $cs = 0;
<a name="l13954"></a>13954           $dom[$key][<span class="stringliteral">&#39;rowspans&#39;</span>] = array();
<a name="l13955"></a>13955           <span class="keywordflow">if</span> (!$this-&gt;empty_string($dom[$key][<span class="stringliteral">&#39;thead&#39;</span>])) {
<a name="l13956"></a>13956             <span class="comment">// set table header</span>
<a name="l13957"></a>13957             $this-&gt;thead = $dom[$key][<span class="stringliteral">&#39;thead&#39;</span>];
<a name="l13958"></a>13958             <span class="keywordflow">if</span> (!isset($this-&gt;theadMargins) OR (empty($this-&gt;theadMargins))) {
<a name="l13959"></a>13959               $this-&gt;theadMargins = array();
<a name="l13960"></a>13960               $this-&gt;theadMargins[<span class="stringliteral">&#39;cmargin&#39;</span>] = $this-&gt;cMargin;
<a name="l13961"></a>13961             }
<a name="l13962"></a>13962           }
<a name="l13963"></a>13963           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellpadding&#39;</span>])) {
<a name="l13964"></a>13964             $cp = $this-&gt;getHTMLUnitToUnits($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellpadding&#39;</span>], 1, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13965"></a>13965             $this-&gt;oldcMargin = $this-&gt;cMargin;
<a name="l13966"></a>13966             $this-&gt;cMargin = $cp;
<a name="l13967"></a>13967           }
<a name="l13968"></a>13968           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellspacing&#39;</span>])) {
<a name="l13969"></a>13969             $cs = $this-&gt;getHTMLUnitToUnits($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;cellspacing&#39;</span>], 1, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13970"></a>13970           }
<a name="l13971"></a>13971           $this-&gt;checkPageBreak((2 * $cp) + (2 * $cs) + $this-&gt;lasth);
<a name="l13972"></a>13972           <span class="keywordflow">break</span>;
<a name="l13973"></a>13973         }
<a name="l13974"></a>13974         <span class="keywordflow">case</span> <span class="stringliteral">&#39;tr&#39;</span>: {
<a name="l13975"></a>13975           <span class="comment">// array of columns positions</span>
<a name="l13976"></a>13976           $dom[$key][<span class="stringliteral">&#39;cellpos&#39;</span>] = array();
<a name="l13977"></a>13977           <span class="keywordflow">break</span>;
<a name="l13978"></a>13978         }
<a name="l13979"></a>13979         <span class="keywordflow">case</span> <span class="stringliteral">&#39;hr&#39;</span>: {
<a name="l13980"></a>13980           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l13981"></a>13981           $this-&gt;htmlvspace = 0;
<a name="l13982"></a>13982           $wtmp = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l13983"></a>13983           <span class="keywordflow">if</span> ((isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>])) AND ($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>)) {
<a name="l13984"></a>13984             $hrWidth = $this-&gt;getHTMLUnitToUnits($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>], $wtmp, <span class="stringliteral">&#39;px&#39;</span>);
<a name="l13985"></a>13985           } <span class="keywordflow">else</span> {
<a name="l13986"></a>13986             $hrWidth = $wtmp;
<a name="l13987"></a>13987           }
<a name="l13988"></a>13988           $x = $this-&gt;GetX();
<a name="l13989"></a>13989           $y = $this-&gt;GetY();
<a name="l13990"></a>13990           $prevlinewidth = $this-&gt;GetLineWidth();
<a name="l13991"></a>13991           $this-&gt;Line($x, $y, $x + $hrWidth, $y);
<a name="l13992"></a>13992           $this-&gt;SetLineWidth($prevlinewidth);
<a name="l13993"></a>13993           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, !isset($dom[($key + 1)]), $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l13994"></a>13994           <span class="keywordflow">break</span>;
<a name="l13995"></a>13995         }
<a name="l13996"></a>13996         <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>: {
<a name="l13997"></a>13997           <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;href&#39;</span>, $tag[<span class="stringliteral">&#39;attribute&#39;</span>])) {
<a name="l13998"></a>13998             $this-&gt;HREF[<span class="stringliteral">&#39;url&#39;</span>] = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;href&#39;</span>];
<a name="l13999"></a>13999           }
<a name="l14000"></a>14000           $this-&gt;HREF[<span class="stringliteral">&#39;color&#39;</span>] = $this-&gt;htmlLinkColorArray;
<a name="l14001"></a>14001           $this-&gt;HREF[<span class="stringliteral">&#39;style&#39;</span>] = $this-&gt;htmlLinkFontStyle;
<a name="l14002"></a>14002           <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;style&#39;</span>, $tag[<span class="stringliteral">&#39;attribute&#39;</span>])) {
<a name="l14003"></a>14003             <span class="comment">// get style attributes</span>
<a name="l14004"></a>14004             preg_match_all(<span class="stringliteral">&#39;/([^;:\s]*):([^;]*)/&#39;</span>, $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>], $style_array, PREG_PATTERN_ORDER);
<a name="l14005"></a>14005             $astyle = array();
<a name="l14006"></a>14006             <span class="keywordflow">while</span> (list($id, $name) = each($style_array[1])) {
<a name="l14007"></a>14007               $name = strtolower($name);
<a name="l14008"></a>14008               $astyle[$name] = trim($style_array[2][$id]);
<a name="l14009"></a>14009             }
<a name="l14010"></a>14010             <span class="keywordflow">if</span> (isset($astyle[<span class="stringliteral">&#39;color&#39;</span>])) {
<a name="l14011"></a>14011               $this-&gt;HREF[<span class="stringliteral">&#39;color&#39;</span>] = $this-&gt;convertHTMLColorToDec($astyle[<span class="stringliteral">&#39;color&#39;</span>]);
<a name="l14012"></a>14012             }
<a name="l14013"></a>14013             <span class="keywordflow">if</span> (isset($astyle[<span class="stringliteral">&#39;text-decoration&#39;</span>])) {
<a name="l14014"></a>14014               $this-&gt;HREF[<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14015"></a>14015               $decors = explode(<span class="charliteral">&#39; &#39;</span>, strtolower($astyle[<span class="stringliteral">&#39;text-decoration&#39;</span>]));
<a name="l14016"></a>14016               <span class="keywordflow">foreach</span> ($decors as $dec) {
<a name="l14017"></a>14017                 $dec = trim($dec);
<a name="l14018"></a>14018                 <span class="keywordflow">if</span> (!$this-&gt;empty_string($dec)) {
<a name="l14019"></a>14019                   <span class="keywordflow">if</span> ($dec{0} == <span class="charliteral">&#39;u&#39;</span>) {
<a name="l14020"></a>14020                     $this-&gt;HREF[<span class="stringliteral">&#39;style&#39;</span>] .= <span class="charliteral">&#39;U&#39;</span>;
<a name="l14021"></a>14021                   } elseif ($dec{0} == <span class="charliteral">&#39;l&#39;</span>) {
<a name="l14022"></a>14022                     $this-&gt;HREF[<span class="stringliteral">&#39;style&#39;</span>] .= <span class="charliteral">&#39;D&#39;</span>;
<a name="l14023"></a>14023                   }
<a name="l14024"></a>14024                 }
<a name="l14025"></a>14025               }
<a name="l14026"></a>14026             }
<a name="l14027"></a>14027           }   
<a name="l14028"></a>14028           <span class="keywordflow">break</span>;
<a name="l14029"></a>14029         }
<a name="l14030"></a>14030         <span class="keywordflow">case</span> <span class="stringliteral">&#39;img&#39;</span>: {
<a name="l14031"></a>14031           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>])) {
<a name="l14032"></a>14032             <span class="comment">// replace relative path with real server path</span>
<a name="l14033"></a>14033             <span class="keywordflow">if</span> (($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>][0] == <span class="charliteral">&#39;/&#39;</span>) AND ($_SERVER[<span class="stringliteral">&#39;DOCUMENT_ROOT&#39;</span>] != <span class="charliteral">&#39;/&#39;</span>)) {
<a name="l14034"></a>14034               $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>] = $_SERVER[<span class="stringliteral">&#39;DOCUMENT_ROOT&#39;</span>].$tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>];
<a name="l14035"></a>14035             }
<a name="l14036"></a>14036             $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>] = urldecode($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>]);
<a name="l14037"></a>14037             $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>] = str_replace(K_PATH_URL, K_PATH_MAIN, $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>]);
<a name="l14038"></a>14038             <span class="keywordflow">if</span> (!isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>])) {
<a name="l14039"></a>14039               $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>] = 0;
<a name="l14040"></a>14040             }
<a name="l14041"></a>14041             <span class="keywordflow">if</span> (!isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>])) {
<a name="l14042"></a>14042               $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>] = 0;
<a name="l14043"></a>14043             }
<a name="l14044"></a>14044             <span class="comment">//if (!isset($tag[&#39;attribute&#39;][&#39;align&#39;])) {</span>
<a name="l14045"></a>14045               <span class="comment">// the only alignment supported is &quot;bottom&quot;</span>
<a name="l14046"></a>14046               <span class="comment">// further development is required for other modes.</span>
<a name="l14047"></a>14047               $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;align&#39;</span>] = <span class="stringliteral">&#39;bottom&#39;</span>;
<a name="l14048"></a>14048             <span class="comment">//} </span>
<a name="l14049"></a>14049             <span class="keywordflow">switch</span>($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;align&#39;</span>]) {
<a name="l14050"></a>14050               <span class="keywordflow">case</span> <span class="stringliteral">&#39;top&#39;</span>: {
<a name="l14051"></a>14051                 $align = <span class="charliteral">&#39;T&#39;</span>;
<a name="l14052"></a>14052                 <span class="keywordflow">break</span>;
<a name="l14053"></a>14053               }
<a name="l14054"></a>14054               <span class="keywordflow">case</span> <span class="stringliteral">&#39;middle&#39;</span>: {
<a name="l14055"></a>14055                 $align = <span class="charliteral">&#39;M&#39;</span>;
<a name="l14056"></a>14056                 <span class="keywordflow">break</span>;
<a name="l14057"></a>14057               }
<a name="l14058"></a>14058               <span class="keywordflow">case</span> <span class="stringliteral">&#39;bottom&#39;</span>: {
<a name="l14059"></a>14059                 $align = <span class="charliteral">&#39;B&#39;</span>;
<a name="l14060"></a>14060                 <span class="keywordflow">break</span>;
<a name="l14061"></a>14061               }
<a name="l14062"></a>14062               <span class="keywordflow">default</span>: {
<a name="l14063"></a>14063                 $align = <span class="charliteral">&#39;B&#39;</span>;
<a name="l14064"></a>14064                 <span class="keywordflow">break</span>;
<a name="l14065"></a>14065               }
<a name="l14066"></a>14066             }
<a name="l14067"></a>14067             $fileinfo = pathinfo($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>]);
<a name="l14068"></a>14068             <span class="keywordflow">if</span> (isset($fileinfo[<span class="stringliteral">&#39;extension&#39;</span>]) AND (!$this-&gt;empty_string($fileinfo[<span class="stringliteral">&#39;extension&#39;</span>]))) {
<a name="l14069"></a>14069               $type = strtolower($fileinfo[<span class="stringliteral">&#39;extension&#39;</span>]);
<a name="l14070"></a>14070             }
<a name="l14071"></a>14071             $prevy = $this-&gt;y;
<a name="l14072"></a>14072             $xpos = $this-&gt;GetX();
<a name="l14073"></a>14073             <span class="keywordflow">if</span> (isset($dom[($key - 1)]) AND ($dom[($key - 1)][<span class="stringliteral">&#39;value&#39;</span>] == <span class="charliteral">&#39; &#39;</span>)) {
<a name="l14074"></a>14074               <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l14075"></a>14075                 $xpos += $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>);
<a name="l14076"></a>14076               } <span class="keywordflow">else</span> {
<a name="l14077"></a>14077                 $xpos -= $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>);
<a name="l14078"></a>14078               }
<a name="l14079"></a>14079             }
<a name="l14080"></a>14080             $imglink = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14081"></a>14081             <span class="keywordflow">if</span> (isset($this-&gt;HREF[<span class="stringliteral">&#39;url&#39;</span>]) AND !$this-&gt;empty_string($this-&gt;HREF[<span class="stringliteral">&#39;url&#39;</span>])) {
<a name="l14082"></a>14082               $imglink = $this-&gt;HREF[<span class="stringliteral">&#39;url&#39;</span>];
<a name="l14083"></a>14083               <span class="keywordflow">if</span> ($imglink{0} == <span class="charliteral">&#39;#&#39;</span>) {
<a name="l14084"></a>14084                 <span class="comment">// convert url to internal link</span>
<a name="l14085"></a>14085                 $page = intval(substr($imglink, 1));
<a name="l14086"></a>14086                 $imglink = $this-&gt;AddLink();
<a name="l14087"></a>14087                 $this-&gt;SetLink($imglink, 0, $page);
<a name="l14088"></a>14088               }
<a name="l14089"></a>14089             }
<a name="l14090"></a>14090             $border = 0;
<a name="l14091"></a>14091             <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>]) AND !empty($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>])) {
<a name="l14092"></a>14092               <span class="comment">// currently only support 1 (frame) or a combination of &#39;LTRB&#39;</span>
<a name="l14093"></a>14093               $border = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;border&#39;</span>];
<a name="l14094"></a>14094             }
<a name="l14095"></a>14095             $iw = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14096"></a>14096             <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>])) {
<a name="l14097"></a>14097               $iw = $this-&gt;getHTMLUnitToUnits($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;width&#39;</span>], 1, <span class="stringliteral">&#39;px&#39;</span>, <span class="keyword">false</span>);
<a name="l14098"></a>14098             }
<a name="l14099"></a>14099             $ih = <span class="stringliteral">&#39;&#39;</span>;
<a name="l14100"></a>14100             <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>])) {
<a name="l14101"></a>14101               $ih = $this-&gt;getHTMLUnitToUnits($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;height&#39;</span>], 1, <span class="stringliteral">&#39;px&#39;</span>, <span class="keyword">false</span>);
<a name="l14102"></a>14102             }
<a name="l14103"></a>14103             <span class="keywordflow">if</span> (($type == <span class="stringliteral">&#39;eps&#39;</span>) OR ($type == <span class="stringliteral">&#39;ai&#39;</span>)) {
<a name="l14104"></a>14104               $this-&gt;ImageEps($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>], $xpos, $this-&gt;GetY(), $iw, $ih, $imglink, <span class="keyword">true</span>, $align, <span class="stringliteral">&#39;&#39;</span>, $border);
<a name="l14105"></a>14105             } <span class="keywordflow">else</span> {
<a name="l14106"></a>14106               $this-&gt;Image($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>], $xpos, $this-&gt;GetY(), $iw, $ih, <span class="stringliteral">&#39;&#39;</span>, $imglink, $align, <span class="keyword">false</span>, 300, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $border);
<a name="l14107"></a>14107             }
<a name="l14108"></a>14108             <span class="keywordflow">switch</span>($align) {
<a name="l14109"></a>14109               <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>: {
<a name="l14110"></a>14110                 $this-&gt;y = $prevy;
<a name="l14111"></a>14111                 <span class="keywordflow">break</span>;
<a name="l14112"></a>14112               }
<a name="l14113"></a>14113               <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>: {
<a name="l14114"></a>14114                 $this-&gt;y = (($this-&gt;img_rb_y + $prevy - ($tag[<span class="stringliteral">&#39;fontsize&#39;</span>] / $this-&gt;k)) / 2) ;
<a name="l14115"></a>14115                 <span class="keywordflow">break</span>;
<a name="l14116"></a>14116               }
<a name="l14117"></a>14117               <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>: {
<a name="l14118"></a>14118                 $this-&gt;y = $this-&gt;img_rb_y - ($tag[<span class="stringliteral">&#39;fontsize&#39;</span>] / $this-&gt;k);
<a name="l14119"></a>14119                 <span class="keywordflow">break</span>;
<a name="l14120"></a>14120               }
<a name="l14121"></a>14121             }
<a name="l14122"></a>14122           }
<a name="l14123"></a>14123           <span class="keywordflow">break</span>;
<a name="l14124"></a>14124         }
<a name="l14125"></a>14125         <span class="keywordflow">case</span> <span class="stringliteral">&#39;dl&#39;</span>: {
<a name="l14126"></a>14126           ++$this-&gt;listnum;
<a name="l14127"></a>14127           $this-&gt;addHTMLVertSpace(0, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14128"></a>14128           <span class="keywordflow">break</span>;
<a name="l14129"></a>14129         }
<a name="l14130"></a>14130         <span class="keywordflow">case</span> <span class="stringliteral">&#39;dt&#39;</span>: {
<a name="l14131"></a>14131           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14132"></a>14132           <span class="keywordflow">break</span>;
<a name="l14133"></a>14133         }
<a name="l14134"></a>14134         <span class="keywordflow">case</span> <span class="stringliteral">&#39;dd&#39;</span>: {
<a name="l14135"></a>14135           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l14136"></a>14136             $this-&gt;rMargin += $this-&gt;listindent;
<a name="l14137"></a>14137           } <span class="keywordflow">else</span> {
<a name="l14138"></a>14138             $this-&gt;lMargin += $this-&gt;listindent;
<a name="l14139"></a>14139           }
<a name="l14140"></a>14140           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14141"></a>14141           <span class="keywordflow">break</span>;
<a name="l14142"></a>14142         }
<a name="l14143"></a>14143         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ul&#39;</span>:
<a name="l14144"></a>14144         <span class="keywordflow">case</span> <span class="stringliteral">&#39;ol&#39;</span>: {
<a name="l14145"></a>14145           $this-&gt;addHTMLVertSpace(0, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14146"></a>14146           $this-&gt;htmlvspace = 0;
<a name="l14147"></a>14147           ++$this-&gt;listnum;
<a name="l14148"></a>14148           <span class="keywordflow">if</span> ($tag[<span class="stringliteral">&#39;value&#39;</span>] == <span class="stringliteral">&#39;ol&#39;</span>) {
<a name="l14149"></a>14149             $this-&gt;listordered[$this-&gt;listnum] = <span class="keyword">true</span>;
<a name="l14150"></a>14150           } <span class="keywordflow">else</span> {
<a name="l14151"></a>14151             $this-&gt;listordered[$this-&gt;listnum] = <span class="keyword">false</span>;
<a name="l14152"></a>14152           }
<a name="l14153"></a>14153           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;start&#39;</span>])) {
<a name="l14154"></a>14154             $this-&gt;listcount[$this-&gt;listnum] = intval($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;start&#39;</span>]) - 1;
<a name="l14155"></a>14155           } <span class="keywordflow">else</span> {
<a name="l14156"></a>14156             $this-&gt;listcount[$this-&gt;listnum] = 0;
<a name="l14157"></a>14157           }
<a name="l14158"></a>14158           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l14159"></a>14159             $this-&gt;rMargin += $this-&gt;listindent;
<a name="l14160"></a>14160           } <span class="keywordflow">else</span> {
<a name="l14161"></a>14161             $this-&gt;lMargin += $this-&gt;listindent;
<a name="l14162"></a>14162           }
<a name="l14163"></a>14163           $this-&gt;addHTMLVertSpace(0, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14164"></a>14164           $this-&gt;htmlvspace = 0;
<a name="l14165"></a>14165           <span class="keywordflow">break</span>;
<a name="l14166"></a>14166         }
<a name="l14167"></a>14167         <span class="keywordflow">case</span> <span class="stringliteral">&#39;li&#39;</span>: {
<a name="l14168"></a>14168           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14169"></a>14169           <span class="keywordflow">if</span> ($this-&gt;listordered[$this-&gt;listnum]) {
<a name="l14170"></a>14170             <span class="comment">// ordered item</span>
<a name="l14171"></a>14171             <span class="keywordflow">if</span> (isset($parent[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>]) AND !$this-&gt;empty_string($parent[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>])) {
<a name="l14172"></a>14172               $this-&gt;lispacer = $parent[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>];
<a name="l14173"></a>14173             } elseif (isset($parent[<span class="stringliteral">&#39;listtype&#39;</span>]) AND !$this-&gt;empty_string($parent[<span class="stringliteral">&#39;listtype&#39;</span>])) {
<a name="l14174"></a>14174               $this-&gt;lispacer = $parent[<span class="stringliteral">&#39;listtype&#39;</span>];
<a name="l14175"></a>14175             } elseif (isset($this-&gt;lisymbol) AND !$this-&gt;empty_string($this-&gt;lisymbol)) {
<a name="l14176"></a>14176               $this-&gt;lispacer = $this-&gt;lisymbol;
<a name="l14177"></a>14177             } <span class="keywordflow">else</span> {
<a name="l14178"></a>14178               $this-&gt;lispacer = <span class="charliteral">&#39;#&#39;</span>;
<a name="l14179"></a>14179             }
<a name="l14180"></a>14180             ++$this-&gt;listcount[$this-&gt;listnum];
<a name="l14181"></a>14181             <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;value&#39;</span>])) {
<a name="l14182"></a>14182               $this-&gt;listcount[$this-&gt;listnum] = intval($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;value&#39;</span>]);
<a name="l14183"></a>14183             }
<a name="l14184"></a>14184           } <span class="keywordflow">else</span> {
<a name="l14185"></a>14185             <span class="comment">// unordered item</span>
<a name="l14186"></a>14186             <span class="keywordflow">if</span> (isset($parent[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>]) AND !$this-&gt;empty_string($parent[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>])) {
<a name="l14187"></a>14187               $this-&gt;lispacer = $parent[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>];
<a name="l14188"></a>14188             } elseif (isset($parent[<span class="stringliteral">&#39;listtype&#39;</span>]) AND !$this-&gt;empty_string($parent[<span class="stringliteral">&#39;listtype&#39;</span>])) {
<a name="l14189"></a>14189               $this-&gt;lispacer = $parent[<span class="stringliteral">&#39;listtype&#39;</span>];
<a name="l14190"></a>14190             } elseif (isset($this-&gt;lisymbol) AND !$this-&gt;empty_string($this-&gt;lisymbol)) {
<a name="l14191"></a>14191               $this-&gt;lispacer = $this-&gt;lisymbol;
<a name="l14192"></a>14192             } <span class="keywordflow">else</span> {
<a name="l14193"></a>14193               $this-&gt;lispacer = <span class="charliteral">&#39;!&#39;</span>;
<a name="l14194"></a>14194             }
<a name="l14195"></a>14195           }
<a name="l14196"></a>14196           <span class="keywordflow">break</span>;
<a name="l14197"></a>14197         }
<a name="l14198"></a>14198         <span class="keywordflow">case</span> <span class="stringliteral">&#39;blockquote&#39;</span>: {
<a name="l14199"></a>14199           <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l14200"></a>14200             $this-&gt;rMargin += $this-&gt;listindent;
<a name="l14201"></a>14201           } <span class="keywordflow">else</span> {
<a name="l14202"></a>14202             $this-&gt;lMargin += $this-&gt;listindent;
<a name="l14203"></a>14203           }
<a name="l14204"></a>14204           $this-&gt;addHTMLVertSpace(2, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14205"></a>14205           <span class="keywordflow">break</span>;
<a name="l14206"></a>14206         }
<a name="l14207"></a>14207         <span class="keywordflow">case</span> <span class="stringliteral">&#39;br&#39;</span>: {
<a name="l14208"></a>14208           $this-&gt;Ln(<span class="stringliteral">&#39;&#39;</span>, $cell);
<a name="l14209"></a>14209           <span class="keywordflow">break</span>;
<a name="l14210"></a>14210         }
<a name="l14211"></a>14211         <span class="keywordflow">case</span> <span class="stringliteral">&#39;div&#39;</span>: {
<a name="l14212"></a>14212           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14213"></a>14213           <span class="keywordflow">break</span>;
<a name="l14214"></a>14214         }
<a name="l14215"></a>14215         <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>: {
<a name="l14216"></a>14216           $this-&gt;addHTMLVertSpace(2, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14217"></a>14217           <span class="keywordflow">break</span>;
<a name="l14218"></a>14218         }
<a name="l14219"></a>14219         <span class="keywordflow">case</span> <span class="stringliteral">&#39;pre&#39;</span>: {
<a name="l14220"></a>14220           $this-&gt;addHTMLVertSpace(1, $cell, <span class="stringliteral">&#39;&#39;</span>, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14221"></a>14221           $this-&gt;premode = <span class="keyword">true</span>;
<a name="l14222"></a>14222           <span class="keywordflow">break</span>;
<a name="l14223"></a>14223         }
<a name="l14224"></a>14224         <span class="keywordflow">case</span> <span class="stringliteral">&#39;sup&#39;</span>: {
<a name="l14225"></a>14225           $this-&gt;SetXY($this-&gt;GetX(), $this-&gt;GetY() - ((0.7 * $this-&gt;FontSizePt) / $this-&gt;k));
<a name="l14226"></a>14226           <span class="keywordflow">break</span>;
<a name="l14227"></a>14227         }
<a name="l14228"></a>14228         <span class="keywordflow">case</span> <span class="stringliteral">&#39;sub&#39;</span>: {
<a name="l14229"></a>14229           $this-&gt;SetXY($this-&gt;GetX(), $this-&gt;GetY() + ((0.3 * $this-&gt;FontSizePt) / $this-&gt;k));
<a name="l14230"></a>14230           <span class="keywordflow">break</span>;
<a name="l14231"></a>14231         }
<a name="l14232"></a>14232         <span class="keywordflow">case</span> <span class="stringliteral">&#39;h1&#39;</span>: 
<a name="l14233"></a>14233         <span class="keywordflow">case</span> <span class="stringliteral">&#39;h2&#39;</span>: 
<a name="l14234"></a>14234         <span class="keywordflow">case</span> <span class="stringliteral">&#39;h3&#39;</span>: 
<a name="l14235"></a>14235         <span class="keywordflow">case</span> <span class="stringliteral">&#39;h4&#39;</span>: 
<a name="l14236"></a>14236         <span class="keywordflow">case</span> <span class="stringliteral">&#39;h5&#39;</span>: 
<a name="l14237"></a>14237         <span class="keywordflow">case</span> <span class="stringliteral">&#39;h6&#39;</span>: {
<a name="l14238"></a>14238           $this-&gt;addHTMLVertSpace(1, $cell, ($tag[<span class="stringliteral">&#39;fontsize&#39;</span>] * 1.5) / $this-&gt;k, $firstorlast, $tag[<span class="stringliteral">&#39;value&#39;</span>], <span class="keyword">false</span>);
<a name="l14239"></a>14239           <span class="keywordflow">break</span>;
<a name="l14240"></a>14240         }
<a name="l14241"></a>14241         <span class="comment">// Form fields (since 4.8.000 - 2009-09-07)</span>
<a name="l14242"></a>14242         <span class="keywordflow">case</span> <span class="stringliteral">&#39;form&#39;</span>: {
<a name="l14243"></a>14243           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;action&#39;</span>])) {
<a name="l14244"></a>14244             $this-&gt;form_action = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;action&#39;</span>];
<a name="l14245"></a>14245           } <span class="keywordflow">else</span> {
<a name="l14246"></a>14246             $this-&gt;form_action = K_PATH_URL.$_SERVER[<span class="stringliteral">&#39;SCRIPT_NAME&#39;</span>];
<a name="l14247"></a>14247           }
<a name="l14248"></a>14248           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;enctype&#39;</span>])) {
<a name="l14249"></a>14249             $this-&gt;form_enctype = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;enctype&#39;</span>];
<a name="l14250"></a>14250           } <span class="keywordflow">else</span> {
<a name="l14251"></a>14251             $this-&gt;form_enctype = <span class="stringliteral">&#39;application/x-www-form-urlencoded&#39;</span>;
<a name="l14252"></a>14252           }
<a name="l14253"></a>14253           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;method&#39;</span>])) {
<a name="l14254"></a>14254             $this-&gt;form_mode = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;method&#39;</span>];
<a name="l14255"></a>14255           } <span class="keywordflow">else</span> {
<a name="l14256"></a>14256             $this-&gt;form_mode = <span class="stringliteral">&#39;post&#39;</span>;
<a name="l14257"></a>14257           }
<a name="l14258"></a>14258           <span class="keywordflow">break</span>;
<a name="l14259"></a>14259         }
<a name="l14260"></a>14260         <span class="keywordflow">case</span> <span class="stringliteral">&#39;input&#39;</span>: {
<a name="l14261"></a>14261           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>]) AND !$this-&gt;empty_string($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>])) {
<a name="l14262"></a>14262             $name = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>];
<a name="l14263"></a>14263           } <span class="keywordflow">else</span> {
<a name="l14264"></a>14264             <span class="keywordflow">break</span>;
<a name="l14265"></a>14265           }
<a name="l14266"></a>14266           $prop = array();
<a name="l14267"></a>14267           $opt = array();
<a name="l14268"></a>14268           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;value&#39;</span>]) AND !$this-&gt;empty_string($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;value&#39;</span>])) {
<a name="l14269"></a>14269             $value = $tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;value&#39;</span>];
<a name="l14270"></a>14270           }
<a name="l14271"></a>14271           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;maxlength&#39;</span>]) AND !$this-&gt;empty_string($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;maxlength&#39;</span>])) {
<a name="l14272"></a>14272             $opt[<span class="stringliteral">&#39;maxlen&#39;</span>] = intval($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;value&#39;</span>]);
<a name="l14273"></a>14273           }
<a name="l14274"></a>14274           $h = $this-&gt;FontSize * $this-&gt;cell_height_ratio;
<a name="l14275"></a>14275           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>]) AND !$this-&gt;empty_string($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>])) {
<a name="l14276"></a>14276             $w = intval($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>]) * $this-&gt;GetStringWidth(chr(32)) * 2;
<a name="l14277"></a>14277           } <span class="keywordflow">else</span> {
<a name="l14278"></a>14278             $w = $h;
<a name="l14279"></a>14279           }
<a name="l14280"></a>14280           <span class="keywordflow">if</span> (isset($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;checked&#39;</span>]) AND (($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;checked&#39;</span>] == <span class="stringliteral">&#39;checked&#39;</span>) OR ($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;checked&#39;</span>] == <span class="stringliteral">&#39;true&#39;</span>))) {
<a name="l14281"></a>14281             $checked = <span class="keyword">true</span>;
<a name="l14282"></a>14282           } <span class="keywordflow">else</span> {
<a name="l14283"></a>14283             $checked = <span class="keyword">false</span>;
<a name="l14284"></a>14284           }
<a name="l14285"></a>14285           <span class="keywordflow">switch</span> ($tag[<span class="stringliteral">&#39;attribute&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l14286"></a>14286             <span class="keywordflow">case</span> <span class="stringliteral">&#39;text&#39;</span>: {
<a name="l14287"></a>14287               <span class="keywordflow">if</span> (isset($value)) {
<a name="l14288"></a>14288                 $opt[<span class="charliteral">&#39;v&#39;</span>] = $value;
<a name="l14289"></a>14289               }
<a name="l14290"></a>14290               $this-&gt;TextField($name, $w, $h, $prop, $opt, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14291"></a>14291               <span class="keywordflow">break</span>;
<a name="l14292"></a>14292             }
<a name="l14293"></a>14293             <span class="keywordflow">case</span> <span class="stringliteral">&#39;password&#39;</span>: {
<a name="l14294"></a>14294               <span class="keywordflow">if</span> (isset($value)) {
<a name="l14295"></a>14295                 $opt[<span class="charliteral">&#39;v&#39;</span>] = $value;
<a name="l14296"></a>14296               }
<a name="l14297"></a>14297               $prop[<span class="stringliteral">&#39;password&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l14298"></a>14298               $this-&gt;TextField($name, $w, $h, $prop, $opt, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14299"></a>14299               <span class="keywordflow">break</span>;
<a name="l14300"></a>14300             }
<a name="l14301"></a>14301             <span class="keywordflow">case</span> <span class="stringliteral">&#39;checkbox&#39;</span>: {
<a name="l14302"></a>14302               $this-&gt;CheckBox($name, $w, $checked, $prop, $opt, $value, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14303"></a>14303               <span class="keywordflow">break</span>;
<a name="l14304"></a>14304             }
<a name="l14305"></a>14305             <span class="keywordflow">case</span> <span class="stringliteral">&#39;radio&#39;</span>: {
<a name="l14306"></a>14306               $this-&gt;RadioButton($name, $w, $prop, $opt, $value, $checked, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14307"></a>14307               <span class="keywordflow">break</span>;
<a name="l14308"></a>14308             }
<a name="l14309"></a>14309             <span class="keywordflow">case</span> <span class="stringliteral">&#39;submit&#39;</span>: {
<a name="l14310"></a>14310               $w = $this-&gt;GetStringWidth($value) * 1.5;
<a name="l14311"></a>14311               $h *= 1.6;
<a name="l14312"></a>14312               $prop = array(<span class="stringliteral">&#39;lineWidth&#39;</span>=&gt;1, <span class="stringliteral">&#39;borderStyle&#39;</span>=&gt;<span class="stringliteral">&#39;beveled&#39;</span>, <span class="stringliteral">&#39;fillColor&#39;</span>=&gt;array(196, 196, 196), <span class="stringliteral">&#39;strokeColor&#39;</span>=&gt;array(255, 255, 255));
<a name="l14313"></a>14313               $action = array();
<a name="l14314"></a>14314               $action[<span class="charliteral">&#39;S&#39;</span>] = <span class="stringliteral">&#39;SubmitForm&#39;</span>;
<a name="l14315"></a>14315               $action[<span class="charliteral">&#39;F&#39;</span>] = $this-&gt;form_action;
<a name="l14316"></a>14316               <span class="keywordflow">if</span> ($this-&gt;form_enctype != <span class="stringliteral">&#39;FDF&#39;</span>) {
<a name="l14317"></a>14317                 $action[<span class="stringliteral">&#39;Flags&#39;</span>] = array(<span class="stringliteral">&#39;ExportFormat&#39;</span>);
<a name="l14318"></a>14318               }
<a name="l14319"></a>14319               <span class="keywordflow">if</span> ($this-&gt;form_mode == <span class="stringliteral">&#39;get&#39;</span>) {
<a name="l14320"></a>14320                 $action[<span class="stringliteral">&#39;Flags&#39;</span>] = array(<span class="stringliteral">&#39;GetMethod&#39;</span>);
<a name="l14321"></a>14321               }
<a name="l14322"></a>14322               $this-&gt;Button($name, $w, $h, $value, $action, $prop, $opt, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14323"></a>14323               <span class="keywordflow">break</span>;
<a name="l14324"></a>14324             }
<a name="l14325"></a>14325             <span class="keywordflow">case</span> <span class="stringliteral">&#39;reset&#39;</span>: {
<a name="l14326"></a>14326               $w = $this-&gt;GetStringWidth($value) * 1.5;
<a name="l14327"></a>14327               $h *= 1.6;
<a name="l14328"></a>14328               $prop = array(<span class="stringliteral">&#39;lineWidth&#39;</span>=&gt;1, <span class="stringliteral">&#39;borderStyle&#39;</span>=&gt;<span class="stringliteral">&#39;beveled&#39;</span>, <span class="stringliteral">&#39;fillColor&#39;</span>=&gt;array(196, 196, 196), <span class="stringliteral">&#39;strokeColor&#39;</span>=&gt;array(255, 255, 255));
<a name="l14329"></a>14329               $this-&gt;Button($name, $w, $h, $value, array(<span class="charliteral">&#39;S&#39;</span>=&gt;<span class="stringliteral">&#39;ResetForm&#39;</span>), $prop, $opt, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14330"></a>14330               <span class="keywordflow">break</span>;
<a name="l14331"></a>14331             }
<a name="l14332"></a>14332             <span class="keywordflow">case</span> <span class="stringliteral">&#39;file&#39;</span>: {
<a name="l14333"></a>14333               $prop[<span class="stringliteral">&#39;fileSelect&#39;</span>] = <span class="stringliteral">&#39;true&#39;</span>;
<a name="l14334"></a>14334               $this-&gt;TextField($name, $w, $h, $prop, $opt, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="keyword">false</span>);
<a name="l14335"></a>14335               <span class="keywordflow">if</span> (!isset($value)) {
<a name="l14336"></a>14336                 $value = <span class="charliteral">&#39;*&#39;</span>;
<a name="l14337"></a>14337               }
<a name="l14338"></a>14338               $w = $this-&gt;GetStringWidth($value) * 2;
<a name="l14339"></a>14339               $h *= 1.2;
<a name="l14340"></a>14340               $prop = array(<span class="stringliteral">&#39;lineWidth&#39;</span>=&gt;1, <span class="stringliteral">&#39;borderStyle&#39;</span>=&gt;<span class="stringliteral">&#39;beveled&#39;</span>, <span class="stringliteral">&#39;fillColor&#39;</span>=&gt;array(196, 196, 196), <span class="stringliteral">&#39;strokeColor&#39;</span>=&gt;array(255, 255, 255));
<a name="l14341"></a>14341               $jsaction = <span class="stringliteral">&#39;var f=this.getField(\&#39;&#39;</span>.$name.<span class="charliteral">&#39;\&#39;</span>); f.browseForFileToSubmit();<span class="stringliteral">&#39;;</span>
<a name="l14342"></a>14342 <span class="stringliteral">              $this-&gt;Button(&#39;</span>FB_<span class="stringliteral">&#39;.$name, $w, $h, $value, $jsaction, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14343"></a>14343 <span class="stringliteral">              break;</span>
<a name="l14344"></a>14344 <span class="stringliteral">            }</span>
<a name="l14345"></a>14345 <span class="stringliteral">            case &#39;</span>hidden<span class="stringliteral">&#39;: {</span>
<a name="l14346"></a>14346 <span class="stringliteral">              if (isset($value)) {</span>
<a name="l14347"></a>14347 <span class="stringliteral">                $opt[&#39;</span>v<span class="stringliteral">&#39;] = $value;</span>
<a name="l14348"></a>14348 <span class="stringliteral">              }</span>
<a name="l14349"></a>14349 <span class="stringliteral">              $opt[&#39;</span>f<span class="stringliteral">&#39;] = array(&#39;</span>invisible<span class="stringliteral">&#39;, &#39;</span>hidden<span class="stringliteral">&#39;);</span>
<a name="l14350"></a>14350 <span class="stringliteral">              $this-&gt;TextField($name, 0, 0, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14351"></a>14351 <span class="stringliteral">              break;</span>
<a name="l14352"></a>14352 <span class="stringliteral">            }</span>
<a name="l14353"></a>14353 <span class="stringliteral">            case &#39;</span>image<span class="stringliteral">&#39;: {</span>
<a name="l14354"></a>14354 <span class="stringliteral">              // THIS TYPE MUST BE FIXED</span>
<a name="l14355"></a>14355 <span class="stringliteral">              if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>src<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>src<span class="stringliteral">&#39;])) {</span>
<a name="l14356"></a>14356 <span class="stringliteral">                $img = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>src<span class="stringliteral">&#39;];</span>
<a name="l14357"></a>14357 <span class="stringliteral">              } else {</span>
<a name="l14358"></a>14358 <span class="stringliteral">                break;</span>
<a name="l14359"></a>14359 <span class="stringliteral">              }</span>
<a name="l14360"></a>14360 <span class="stringliteral">              $value = &#39;</span>img<span class="stringliteral">&#39;;</span>
<a name="l14361"></a>14361 <span class="stringliteral">              //$opt[&#39;</span>mk<span class="stringliteral">&#39;] = array(&#39;</span>i<span class="stringliteral">&#39;=&gt;$img, &#39;</span>tp<span class="stringliteral">&#39;=&gt;1, &#39;</span><span class="keywordflow">if</span><span class="stringliteral">&#39;=&gt;array(&#39;</span>sw<span class="stringliteral">&#39;=&gt;&#39;</span>A<span class="stringliteral">&#39;, &#39;</span>s<span class="stringliteral">&#39;=&gt;&#39;</span>A<span class="stringliteral">&#39;, &#39;</span>fb<span class="stringliteral">&#39;=&gt;false));</span>
<a name="l14362"></a>14362 <span class="stringliteral">              if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>onclick<span class="stringliteral">&#39;]) AND !empty($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>onclick<span class="stringliteral">&#39;])) {</span>
<a name="l14363"></a>14363 <span class="stringliteral">                $jsaction = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>onclick<span class="stringliteral">&#39;];</span>
<a name="l14364"></a>14364 <span class="stringliteral">              } else {</span>
<a name="l14365"></a>14365 <span class="stringliteral">                $jsaction = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14366"></a>14366 <span class="stringliteral">              }</span>
<a name="l14367"></a>14367 <span class="stringliteral">              $this-&gt;Button($name, $w, $h, $value, $jsaction, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14368"></a>14368 <span class="stringliteral">              break;</span>
<a name="l14369"></a>14369 <span class="stringliteral">            }</span>
<a name="l14370"></a>14370 <span class="stringliteral">            case &#39;</span>button<span class="stringliteral">&#39;: {</span>
<a name="l14371"></a>14371 <span class="stringliteral">              $w = $this-&gt;GetStringWidth($value) * 1.5;</span>
<a name="l14372"></a>14372 <span class="stringliteral">              $h *= 1.6;</span>
<a name="l14373"></a>14373 <span class="stringliteral">              $prop = array(&#39;</span>lineWidth<span class="stringliteral">&#39;=&gt;1, &#39;</span>borderStyle<span class="stringliteral">&#39;=&gt;&#39;</span>beveled<span class="stringliteral">&#39;, &#39;</span>fillColor<span class="stringliteral">&#39;=&gt;array(196, 196, 196), &#39;</span>strokeColor<span class="stringliteral">&#39;=&gt;array(255, 255, 255));</span>
<a name="l14374"></a>14374 <span class="stringliteral">              if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>onclick<span class="stringliteral">&#39;]) AND !empty($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>onclick<span class="stringliteral">&#39;])) {</span>
<a name="l14375"></a>14375 <span class="stringliteral">                $jsaction = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>onclick<span class="stringliteral">&#39;];</span>
<a name="l14376"></a>14376 <span class="stringliteral">              } else {</span>
<a name="l14377"></a>14377 <span class="stringliteral">                $jsaction = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14378"></a>14378 <span class="stringliteral">              }</span>
<a name="l14379"></a>14379 <span class="stringliteral">              $this-&gt;Button($name, $w, $h, $value, $jsaction, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14380"></a>14380 <span class="stringliteral">              break;</span>
<a name="l14381"></a>14381 <span class="stringliteral">            }</span>
<a name="l14382"></a>14382 <span class="stringliteral">          }</span>
<a name="l14383"></a>14383 <span class="stringliteral">          break;</span>
<a name="l14384"></a>14384 <span class="stringliteral">        }</span>
<a name="l14385"></a>14385 <span class="stringliteral">        case &#39;</span>textarea<span class="stringliteral">&#39;: {</span>
<a name="l14386"></a>14386 <span class="stringliteral">          $prop = array();</span>
<a name="l14387"></a>14387 <span class="stringliteral">          $opt = array();</span>
<a name="l14388"></a>14388 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>name<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>name<span class="stringliteral">&#39;])) {</span>
<a name="l14389"></a>14389 <span class="stringliteral">            $name = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>name<span class="stringliteral">&#39;];</span>
<a name="l14390"></a>14390 <span class="stringliteral">          } else {</span>
<a name="l14391"></a>14391 <span class="stringliteral">            break;</span>
<a name="l14392"></a>14392 <span class="stringliteral">          }</span>
<a name="l14393"></a>14393 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>value<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>value<span class="stringliteral">&#39;])) {</span>
<a name="l14394"></a>14394 <span class="stringliteral">            $opt[&#39;</span>v<span class="stringliteral">&#39;] = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>value<span class="stringliteral">&#39;];</span>
<a name="l14395"></a>14395 <span class="stringliteral">          }</span>
<a name="l14396"></a>14396 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cols<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cols<span class="stringliteral">&#39;])) {</span>
<a name="l14397"></a>14397 <span class="stringliteral">            $w = intval($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cols<span class="stringliteral">&#39;]) * $this-&gt;GetStringWidth(chr(32)) * 2;</span>
<a name="l14398"></a>14398 <span class="stringliteral">          } else {</span>
<a name="l14399"></a>14399 <span class="stringliteral">            $w = 40;</span>
<a name="l14400"></a>14400 <span class="stringliteral">          }</span>
<a name="l14401"></a>14401 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>rows<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>rows<span class="stringliteral">&#39;])) {</span>
<a name="l14402"></a>14402 <span class="stringliteral">            $h = intval($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>rows<span class="stringliteral">&#39;]) * $this-&gt;FontSize * $this-&gt;cell_height_ratio;</span>
<a name="l14403"></a>14403 <span class="stringliteral">          } else {</span>
<a name="l14404"></a>14404 <span class="stringliteral">            $h = 10;</span>
<a name="l14405"></a>14405 <span class="stringliteral">          }</span>
<a name="l14406"></a>14406 <span class="stringliteral">          $prop[&#39;</span>multiline<span class="stringliteral">&#39;] = &#39;</span><span class="keyword">true</span><span class="stringliteral">&#39;;</span>
<a name="l14407"></a>14407 <span class="stringliteral">          $this-&gt;TextField($name, $w, $h, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14408"></a>14408 <span class="stringliteral">          break;</span>
<a name="l14409"></a>14409 <span class="stringliteral">        }</span>
<a name="l14410"></a>14410 <span class="stringliteral">        case &#39;</span>select<span class="stringliteral">&#39;: {</span>
<a name="l14411"></a>14411 <span class="stringliteral">          $h = $this-&gt;FontSize * $this-&gt;cell_height_ratio;</span>
<a name="l14412"></a>14412 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>size<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>size<span class="stringliteral">&#39;])) {</span>
<a name="l14413"></a>14413 <span class="stringliteral">            $h *= ($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>size<span class="stringliteral">&#39;] + 1);</span>
<a name="l14414"></a>14414 <span class="stringliteral">          }</span>
<a name="l14415"></a>14415 <span class="stringliteral">          $prop = array();</span>
<a name="l14416"></a>14416 <span class="stringliteral">          $opt = array();</span>
<a name="l14417"></a>14417 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>name<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>name<span class="stringliteral">&#39;])) {</span>
<a name="l14418"></a>14418 <span class="stringliteral">            $name = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>name<span class="stringliteral">&#39;];</span>
<a name="l14419"></a>14419 <span class="stringliteral">          } else {</span>
<a name="l14420"></a>14420 <span class="stringliteral">            break;</span>
<a name="l14421"></a>14421 <span class="stringliteral">          }</span>
<a name="l14422"></a>14422 <span class="stringliteral">          $w = 0;</span>
<a name="l14423"></a>14423 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>opt<span class="stringliteral">&#39;]) AND !$this-&gt;empty_string($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>opt<span class="stringliteral">&#39;])) {</span>
<a name="l14424"></a>14424 <span class="stringliteral">            $options = explode (&quot;\r&quot;, $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>opt<span class="stringliteral">&#39;]);</span>
<a name="l14425"></a>14425 <span class="stringliteral">            $values = array();</span>
<a name="l14426"></a>14426 <span class="stringliteral">            foreach ($options as $val) {</span>
<a name="l14427"></a>14427 <span class="stringliteral">              if (strpos($val, &quot;\t&quot;) !== false) {</span>
<a name="l14428"></a>14428 <span class="stringliteral">                $opts = explode(&quot;\t&quot;, $val);</span>
<a name="l14429"></a>14429 <span class="stringliteral">                $values[] = $opts;</span>
<a name="l14430"></a>14430 <span class="stringliteral">                $w = max($w, $this-&gt;GetStringWidth($opts[1]));</span>
<a name="l14431"></a>14431 <span class="stringliteral">              } else {</span>
<a name="l14432"></a>14432 <span class="stringliteral">                $values[] = $val;</span>
<a name="l14433"></a>14433 <span class="stringliteral">                $w = max($w, $this-&gt;GetStringWidth($val));</span>
<a name="l14434"></a>14434 <span class="stringliteral">              }</span>
<a name="l14435"></a>14435 <span class="stringliteral">            }</span>
<a name="l14436"></a>14436 <span class="stringliteral">          } else {</span>
<a name="l14437"></a>14437 <span class="stringliteral">            break;</span>
<a name="l14438"></a>14438 <span class="stringliteral">          }</span>
<a name="l14439"></a>14439 <span class="stringliteral">          $w *= 2;</span>
<a name="l14440"></a>14440 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>multiple<span class="stringliteral">&#39;]) AND ($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>multiple<span class="stringliteral">&#39;]=&#39;</span>multiple<span class="stringliteral">&#39;)) {</span>
<a name="l14441"></a>14441 <span class="stringliteral">            $prop[&#39;</span>multipleSelection<span class="stringliteral">&#39;] = &#39;</span><span class="keyword">true</span><span class="stringliteral">&#39;;</span>
<a name="l14442"></a>14442 <span class="stringliteral">            $this-&gt;ListBox($name, $w, $h, $values, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14443"></a>14443 <span class="stringliteral">          } else {</span>
<a name="l14444"></a>14444 <span class="stringliteral">            $this-&gt;ComboBox($name, $w, $h, $values, $prop, $opt, &#39;</span><span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;, false);</span>
<a name="l14445"></a>14445 <span class="stringliteral">          }</span>
<a name="l14446"></a>14446 <span class="stringliteral">          break;</span>
<a name="l14447"></a>14447 <span class="stringliteral">        }</span>
<a name="l14448"></a>14448 <span class="stringliteral">        case &#39;</span>tcpdf<span class="stringliteral">&#39;: {</span>
<a name="l14449"></a>14449 <span class="stringliteral">          // NOT HTML: used to call TCPDF methods</span>
<a name="l14450"></a>14450 <span class="stringliteral">          if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>method<span class="stringliteral">&#39;])) {</span>
<a name="l14451"></a>14451 <span class="stringliteral">            $tcpdf_method = $tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>method<span class="stringliteral">&#39;];</span>
<a name="l14452"></a>14452 <span class="stringliteral">            if (method_exists($this, $tcpdf_method)) {</span>
<a name="l14453"></a>14453 <span class="stringliteral">              if (isset($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>params<span class="stringliteral">&#39;]) AND (!empty($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>params<span class="stringliteral">&#39;]))) {</span>
<a name="l14454"></a>14454 <span class="stringliteral">                eval(&#39;</span>$params = array(<span class="stringliteral">&#39;.$this-&gt;unhtmlentities($tag[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>params<span class="stringliteral">&#39;]).&#39;</span>);<span class="stringliteral">&#39;);</span>
<a name="l14455"></a>14455 <span class="stringliteral">                call_user_func_array(array($this, $tcpdf_method), $params);</span>
<a name="l14456"></a>14456 <span class="stringliteral">              } else {</span>
<a name="l14457"></a>14457 <span class="stringliteral">                $this-&gt;$tcpdf_method();</span>
<a name="l14458"></a>14458 <span class="stringliteral">              }</span>
<a name="l14459"></a>14459 <span class="stringliteral">              $this-&gt;newline = true;</span>
<a name="l14460"></a>14460 <span class="stringliteral">            }</span>
<a name="l14461"></a>14461 <span class="stringliteral">          }</span>
<a name="l14462"></a>14462 <span class="stringliteral">        }</span>
<a name="l14463"></a>14463 <span class="stringliteral">        default: {</span>
<a name="l14464"></a>14464 <span class="stringliteral">          break;</span>
<a name="l14465"></a>14465 <span class="stringliteral">        }</span>
<a name="l14466"></a>14466 <span class="stringliteral">      }</span>
<a name="l14467"></a>14467 <span class="stringliteral">    }</span>
<a name="l14468"></a>14468 <span class="stringliteral">    </span>
<a name="l14476"></a>14476 <span class="stringliteral">    protected function closeHTMLTagHandler(&amp;$dom, $key, $cell=false) {</span>
<a name="l14477"></a>14477 <span class="stringliteral">      $tag = $dom[$key];</span>
<a name="l14478"></a>14478 <span class="stringliteral">      $parent = $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])];</span>
<a name="l14479"></a>14479 <span class="stringliteral">      $firstorlast = ((!isset($dom[($key + 1)])) OR ((!isset($dom[($key + 2)])) AND ($dom[($key + 1)][&#39;</span>value<span class="stringliteral">&#39;] == &#39;</span>marker<span class="stringliteral">&#39;)));</span>
<a name="l14480"></a>14480 <span class="stringliteral">      $in_table_head = false;</span>
<a name="l14481"></a>14481 <span class="stringliteral">      //Closing tag</span>
<a name="l14482"></a>14482 <span class="stringliteral">      switch($tag[&#39;</span>value<span class="stringliteral">&#39;]) {</span>
<a name="l14483"></a>14483 <span class="stringliteral">        case &#39;</span>tr<span class="stringliteral">&#39;: {</span>
<a name="l14484"></a>14484 <span class="stringliteral">          $table_el = $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>parent<span class="stringliteral">&#39;];</span>
<a name="l14485"></a>14485 <span class="stringliteral">          if(!isset($parent[&#39;</span>endy<span class="stringliteral">&#39;])) {</span>
<a name="l14486"></a>14486 <span class="stringliteral">            $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;] = $this-&gt;y;</span>
<a name="l14487"></a>14487 <span class="stringliteral">            $parent[&#39;</span>endy<span class="stringliteral">&#39;] = $this-&gt;y;</span>
<a name="l14488"></a>14488 <span class="stringliteral">          }</span>
<a name="l14489"></a>14489 <span class="stringliteral">          if(!isset($parent[&#39;</span>endpage<span class="stringliteral">&#39;])) {</span>
<a name="l14490"></a>14490 <span class="stringliteral">            $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;] = $this-&gt;page;</span>
<a name="l14491"></a>14491 <span class="stringliteral">            $parent[&#39;</span>endpage<span class="stringliteral">&#39;] = $this-&gt;page;</span>
<a name="l14492"></a>14492 <span class="stringliteral">          }</span>
<a name="l14493"></a>14493 <span class="stringliteral">          // update row-spanned cells</span>
<a name="l14494"></a>14494 <span class="stringliteral">          if (isset($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;])) {</span>
<a name="l14495"></a>14495 <span class="stringliteral">            foreach ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;] as $k =&gt; $trwsp) {</span>
<a name="l14496"></a>14496 <span class="stringliteral">              $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>rowspan<span class="stringliteral">&#39;] -= 1;</span>
<a name="l14497"></a>14497 <span class="stringliteral">              if ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>rowspan<span class="stringliteral">&#39;] == 0) {</span>
<a name="l14498"></a>14498 <span class="stringliteral">                if ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;] == $parent[&#39;</span>endpage<span class="stringliteral">&#39;]) {</span>
<a name="l14499"></a>14499 <span class="stringliteral">                  $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;] = max($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;], $parent[&#39;</span>endy<span class="stringliteral">&#39;]);</span>
<a name="l14500"></a>14500 <span class="stringliteral">                } elseif ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;] &gt; $parent[&#39;</span>endpage<span class="stringliteral">&#39;]) {</span>
<a name="l14501"></a>14501 <span class="stringliteral">                  $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;] = $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;];</span>
<a name="l14502"></a>14502 <span class="stringliteral">                  $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;] = $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;];</span>
<a name="l14503"></a>14503 <span class="stringliteral">                }</span>
<a name="l14504"></a>14504 <span class="stringliteral">              }</span>
<a name="l14505"></a>14505 <span class="stringliteral">            }</span>
<a name="l14506"></a>14506 <span class="stringliteral">            // report new endy and endpage to the rowspanned cells</span>
<a name="l14507"></a>14507 <span class="stringliteral">            foreach ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;] as $k =&gt; $trwsp) {</span>
<a name="l14508"></a>14508 <span class="stringliteral">              if ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>rowspan<span class="stringliteral">&#39;] == 0) {</span>
<a name="l14509"></a>14509 <span class="stringliteral">                $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;] = max($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;], $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;]);</span>
<a name="l14510"></a>14510 <span class="stringliteral">                $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;] = $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;];</span>
<a name="l14511"></a>14511 <span class="stringliteral">                $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;] = max($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;], $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;]);</span>
<a name="l14512"></a>14512 <span class="stringliteral">                $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;] = $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;];</span>
<a name="l14513"></a>14513 <span class="stringliteral">              }</span>
<a name="l14514"></a>14514 <span class="stringliteral">            }</span>
<a name="l14515"></a>14515 <span class="stringliteral">            // update remaining rowspanned cells</span>
<a name="l14516"></a>14516 <span class="stringliteral">            foreach ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;] as $k =&gt; $trwsp) {</span>
<a name="l14517"></a>14517 <span class="stringliteral">              if ($dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>rowspan<span class="stringliteral">&#39;] == 0) {</span>
<a name="l14518"></a>14518 <span class="stringliteral">                $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endpage<span class="stringliteral">&#39;] = $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;];</span>
<a name="l14519"></a>14519 <span class="stringliteral">                $dom[$table_el][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;] = $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;];</span>
<a name="l14520"></a>14520 <span class="stringliteral">              }</span>
<a name="l14521"></a>14521 <span class="stringliteral">            }</span>
<a name="l14522"></a>14522 <span class="stringliteral">          }</span>
<a name="l14523"></a>14523 <span class="stringliteral">          $this-&gt;setPage($dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;]);</span>
<a name="l14524"></a>14524 <span class="stringliteral">          $this-&gt;y = $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;];</span>
<a name="l14525"></a>14525 <span class="stringliteral">          if (isset($dom[$table_el][&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cellspacing<span class="stringliteral">&#39;])) {</span>
<a name="l14526"></a>14526 <span class="stringliteral">            $cellspacing = $this-&gt;getHTMLUnitToUnits($dom[$table_el][&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cellspacing<span class="stringliteral">&#39;], 1, &#39;</span>px<span class="stringliteral">&#39;);</span>
<a name="l14527"></a>14527 <span class="stringliteral">            $this-&gt;y += $cellspacing;</span>
<a name="l14528"></a>14528 <span class="stringliteral">          }       </span>
<a name="l14529"></a>14529 <span class="stringliteral">          $this-&gt;Ln(0, $cell);</span>
<a name="l14530"></a>14530 <span class="stringliteral">          $this-&gt;x = $parent[&#39;</span>startx<span class="stringliteral">&#39;];</span>
<a name="l14531"></a>14531 <span class="stringliteral">          // account for booklet mode</span>
<a name="l14532"></a>14532 <span class="stringliteral">          if ($this-&gt;page &gt; $parent[&#39;</span>startpage<span class="stringliteral">&#39;]) {</span>
<a name="l14533"></a>14533 <span class="stringliteral">            if (($this-&gt;rtl) AND ($this-&gt;pagedim[$this-&gt;page][&#39;</span>orm<span class="stringliteral">&#39;] != $this-&gt;pagedim[$parent[&#39;</span>startpage<span class="stringliteral">&#39;]][&#39;</span>orm<span class="stringliteral">&#39;])) {</span>
<a name="l14534"></a>14534 <span class="stringliteral">              $this-&gt;x += ($this-&gt;pagedim[$this-&gt;page][&#39;</span>orm<span class="stringliteral">&#39;] - $this-&gt;pagedim[$parent[&#39;</span>startpage<span class="stringliteral">&#39;]][&#39;</span>orm<span class="stringliteral">&#39;]);</span>
<a name="l14535"></a>14535 <span class="stringliteral">            } elseif ((!$this-&gt;rtl) AND ($this-&gt;pagedim[$this-&gt;page][&#39;</span>olm<span class="stringliteral">&#39;] != $this-&gt;pagedim[$parent[&#39;</span>startpage<span class="stringliteral">&#39;]][&#39;</span>olm<span class="stringliteral">&#39;])) {</span>
<a name="l14536"></a>14536 <span class="stringliteral">              $this-&gt;x += ($this-&gt;pagedim[$this-&gt;page][&#39;</span>olm<span class="stringliteral">&#39;] - $this-&gt;pagedim[$parent[&#39;</span>startpage<span class="stringliteral">&#39;]][&#39;</span>olm<span class="stringliteral">&#39;]);</span>
<a name="l14537"></a>14537 <span class="stringliteral">            }</span>
<a name="l14538"></a>14538 <span class="stringliteral">          }</span>
<a name="l14539"></a>14539 <span class="stringliteral">          break;</span>
<a name="l14540"></a>14540 <span class="stringliteral">        }</span>
<a name="l14541"></a>14541 <span class="stringliteral">        case &#39;</span>tablehead<span class="stringliteral">&#39;:</span>
<a name="l14542"></a>14542 <span class="stringliteral">          // closing tag used for the thead part</span>
<a name="l14543"></a>14543 <span class="stringliteral">          $in_table_head = true;</span>
<a name="l14544"></a>14544 <span class="stringliteral">        case &#39;</span>table<span class="stringliteral">&#39;: {</span>
<a name="l14545"></a>14545 <span class="stringliteral">          // draw borders</span>
<a name="l14546"></a>14546 <span class="stringliteral">          $table_el = $parent;</span>
<a name="l14547"></a>14547 <span class="stringliteral">          if ((isset($table_el[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>border<span class="stringliteral">&#39;]) AND ($table_el[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>border<span class="stringliteral">&#39;] &gt; 0)) </span>
<a name="l14548"></a>14548 <span class="stringliteral">            OR (isset($table_el[&#39;</span>style<span class="stringliteral">&#39;][&#39;</span>border<span class="stringliteral">&#39;]) AND ($table_el[&#39;</span>style<span class="stringliteral">&#39;][&#39;</span>border<span class="stringliteral">&#39;] &gt; 0))) {</span>
<a name="l14549"></a>14549 <span class="stringliteral">              $border = 1;</span>
<a name="l14550"></a>14550 <span class="stringliteral">          } else {</span>
<a name="l14551"></a>14551 <span class="stringliteral">            $border = 0;</span>
<a name="l14552"></a>14552 <span class="stringliteral">          }</span>
<a name="l14553"></a>14553 <span class="stringliteral">          // fix bottom line alignment of last line before page break</span>
<a name="l14554"></a>14554 <span class="stringliteral">          foreach ($dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>trids<span class="stringliteral">&#39;] as $j =&gt; $trkey) {</span>
<a name="l14555"></a>14555 <span class="stringliteral">            // update row-spanned cells</span>
<a name="l14556"></a>14556 <span class="stringliteral">            if (isset($dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;])) {</span>
<a name="l14557"></a>14557 <span class="stringliteral">              foreach ($dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;] as $k =&gt; $trwsp) {</span>
<a name="l14558"></a>14558 <span class="stringliteral">                if ($trwsp[&#39;</span>trid<span class="stringliteral">&#39;] == $trkey) {</span>
<a name="l14559"></a>14559 <span class="stringliteral">                  $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>mrowspan<span class="stringliteral">&#39;] -= 1;</span>
<a name="l14560"></a>14560 <span class="stringliteral">                }</span>
<a name="l14561"></a>14561 <span class="stringliteral">                if (isset($prevtrkey) AND ($trwsp[&#39;</span>trid<span class="stringliteral">&#39;] == $prevtrkey) AND ($trwsp[&#39;</span>mrowspan<span class="stringliteral">&#39;] &gt;= 0)) {</span>
<a name="l14562"></a>14562 <span class="stringliteral">                  $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>trid<span class="stringliteral">&#39;] = $trkey;</span>
<a name="l14563"></a>14563 <span class="stringliteral">                }</span>
<a name="l14564"></a>14564 <span class="stringliteral">              }</span>
<a name="l14565"></a>14565 <span class="stringliteral">            }</span>
<a name="l14566"></a>14566 <span class="stringliteral">            if (isset($prevtrkey) AND ($dom[$trkey][&#39;</span>startpage<span class="stringliteral">&#39;] &gt; $dom[$prevtrkey][&#39;</span>endpage<span class="stringliteral">&#39;])) {</span>
<a name="l14567"></a>14567 <span class="stringliteral">              $pgendy = $this-&gt;pagedim[$dom[$prevtrkey][&#39;</span>endpage<span class="stringliteral">&#39;]][&#39;</span>hk<span class="stringliteral">&#39;] - $this-&gt;pagedim[$dom[$prevtrkey][&#39;</span>endpage<span class="stringliteral">&#39;]][&#39;</span>bm<span class="stringliteral">&#39;];</span>
<a name="l14568"></a>14568 <span class="stringliteral">              $dom[$prevtrkey][&#39;</span>endy<span class="stringliteral">&#39;] = $pgendy;</span>
<a name="l14569"></a>14569 <span class="stringliteral">              // update row-spanned cells</span>
<a name="l14570"></a>14570 <span class="stringliteral">              if (isset($dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;])) {</span>
<a name="l14571"></a>14571 <span class="stringliteral">                foreach ($dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;] as $k =&gt; $trwsp) {</span>
<a name="l14572"></a>14572 <span class="stringliteral">                  if (($trwsp[&#39;</span>trid<span class="stringliteral">&#39;] == $trkey) AND ($trwsp[&#39;</span>mrowspan<span class="stringliteral">&#39;] == 1) AND ($trwsp[&#39;</span>endpage<span class="stringliteral">&#39;] == $dom[$prevtrkey][&#39;</span>endpage<span class="stringliteral">&#39;])) {</span>
<a name="l14573"></a>14573 <span class="stringliteral">                    $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>endy<span class="stringliteral">&#39;] = $pgendy;</span>
<a name="l14574"></a>14574 <span class="stringliteral">                    $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])][&#39;</span>rowspans<span class="stringliteral">&#39;][$k][&#39;</span>mrowspan<span class="stringliteral">&#39;] = -1;</span>
<a name="l14575"></a>14575 <span class="stringliteral">                  }</span>
<a name="l14576"></a>14576 <span class="stringliteral">                }</span>
<a name="l14577"></a>14577 <span class="stringliteral">              }</span>
<a name="l14578"></a>14578 <span class="stringliteral">            }</span>
<a name="l14579"></a>14579 <span class="stringliteral">            $prevtrkey = $trkey;</span>
<a name="l14580"></a>14580 <span class="stringliteral">            $table_el = $dom[($dom[$key][&#39;</span>parent<span class="stringliteral">&#39;])];</span>
<a name="l14581"></a>14581 <span class="stringliteral">          }</span>
<a name="l14582"></a>14582 <span class="stringliteral">          // for each row</span>
<a name="l14583"></a>14583 <span class="stringliteral">          foreach ($table_el[&#39;</span>trids<span class="stringliteral">&#39;] as $j =&gt; $trkey) {</span>
<a name="l14584"></a>14584 <span class="stringliteral">            $parent = $dom[$trkey];</span>
<a name="l14585"></a>14585 <span class="stringliteral">            // for each cell on the row</span>
<a name="l14586"></a>14586 <span class="stringliteral">            foreach ($parent[&#39;</span>cellpos<span class="stringliteral">&#39;] as $k =&gt; $cellpos) {</span>
<a name="l14587"></a>14587 <span class="stringliteral">              if (isset($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;]) AND ($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;] &gt;= 0)) {</span>
<a name="l14588"></a>14588 <span class="stringliteral">                $cellpos[&#39;</span>startx<span class="stringliteral">&#39;] = $table_el[&#39;</span>rowspans<span class="stringliteral">&#39;][($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;])][&#39;</span>startx<span class="stringliteral">&#39;];</span>
<a name="l14589"></a>14589 <span class="stringliteral">                $cellpos[&#39;</span>endx<span class="stringliteral">&#39;] = $table_el[&#39;</span>rowspans<span class="stringliteral">&#39;][($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;])][&#39;</span>endx<span class="stringliteral">&#39;];</span>
<a name="l14590"></a>14590 <span class="stringliteral">                $endy = $table_el[&#39;</span>rowspans<span class="stringliteral">&#39;][($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;])][&#39;</span>endy<span class="stringliteral">&#39;];</span>
<a name="l14591"></a>14591 <span class="stringliteral">                $startpage = $table_el[&#39;</span>rowspans<span class="stringliteral">&#39;][($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;])][&#39;</span>startpage<span class="stringliteral">&#39;];</span>
<a name="l14592"></a>14592 <span class="stringliteral">                $endpage = $table_el[&#39;</span>rowspans<span class="stringliteral">&#39;][($cellpos[&#39;</span>rowspanid<span class="stringliteral">&#39;])][&#39;</span>endpage<span class="stringliteral">&#39;];</span>
<a name="l14593"></a>14593 <span class="stringliteral">              } else {</span>
<a name="l14594"></a>14594 <span class="stringliteral">                $endy = $parent[&#39;</span>endy<span class="stringliteral">&#39;];</span>
<a name="l14595"></a>14595 <span class="stringliteral">                $startpage = $parent[&#39;</span>startpage<span class="stringliteral">&#39;];</span>
<a name="l14596"></a>14596 <span class="stringliteral">                $endpage = $parent[&#39;</span>endpage<span class="stringliteral">&#39;];</span>
<a name="l14597"></a>14597 <span class="stringliteral">              }</span>
<a name="l14598"></a>14598 <span class="stringliteral">              if ($endpage &gt; $startpage) {</span>
<a name="l14599"></a>14599 <span class="stringliteral">                // design borders around HTML cells.</span>
<a name="l14600"></a>14600 <span class="stringliteral">                for ($page=$startpage; $page &lt;= $endpage; ++$page) {</span>
<a name="l14601"></a>14601 <span class="stringliteral">                  $this-&gt;setPage($page);</span>
<a name="l14602"></a>14602 <span class="stringliteral">                  if ($page == $startpage) {</span>
<a name="l14603"></a>14603 <span class="stringliteral">                    $this-&gt;y = $parent[&#39;</span>starty<span class="stringliteral">&#39;]; // put cursor at the beginning of row on the first page</span>
<a name="l14604"></a>14604 <span class="stringliteral">                    $ch = $this-&gt;getPageHeight() - $parent[&#39;</span>starty<span class="stringliteral">&#39;] - $this-&gt;getBreakMargin();</span>
<a name="l14605"></a>14605 <span class="stringliteral">                    $cborder = $this-&gt;getBorderMode($border, $position=&#39;</span>start<span class="stringliteral">&#39;);</span>
<a name="l14606"></a>14606 <span class="stringliteral">                  } elseif ($page == $endpage) {</span>
<a name="l14607"></a>14607 <span class="stringliteral">                    $this-&gt;y = $this-&gt;tMargin; // put cursor at the beginning of last page</span>
<a name="l14608"></a>14608 <span class="stringliteral">                    $ch = $endy - $this-&gt;tMargin;</span>
<a name="l14609"></a>14609 <span class="stringliteral">                    $cborder = $this-&gt;getBorderMode($border, $position=&#39;</span>end<span class="stringliteral">&#39;);</span>
<a name="l14610"></a>14610 <span class="stringliteral">                  } else {</span>
<a name="l14611"></a>14611 <span class="stringliteral">                    $this-&gt;y = $this-&gt;tMargin; // put cursor at the beginning of the current page</span>
<a name="l14612"></a>14612 <span class="stringliteral">                    $ch = $this-&gt;getPageHeight() - $this-&gt;tMargin - $this-&gt;getBreakMargin();</span>
<a name="l14613"></a>14613 <span class="stringliteral">                    $cborder = $this-&gt;getBorderMode($border, $position=&#39;</span>middle<span class="stringliteral">&#39;);</span>
<a name="l14614"></a>14614 <span class="stringliteral">                  }</span>
<a name="l14615"></a>14615 <span class="stringliteral">                  if (isset($cellpos[&#39;</span>bgcolor<span class="stringliteral">&#39;]) AND ($cellpos[&#39;</span>bgcolor<span class="stringliteral">&#39;]) !== false) {</span>
<a name="l14616"></a>14616 <span class="stringliteral">                    $this-&gt;SetFillColorArray($cellpos[&#39;</span>bgcolor<span class="stringliteral">&#39;]);</span>
<a name="l14617"></a>14617 <span class="stringliteral">                    $fill = true;</span>
<a name="l14618"></a>14618 <span class="stringliteral">                  } else {</span>
<a name="l14619"></a>14619 <span class="stringliteral">                    $fill = false;</span>
<a name="l14620"></a>14620 <span class="stringliteral">                  }</span>
<a name="l14621"></a>14621 <span class="stringliteral">                  $cw = abs($cellpos[&#39;</span>endx<span class="stringliteral">&#39;] - $cellpos[&#39;</span>startx<span class="stringliteral">&#39;]);</span>
<a name="l14622"></a>14622 <span class="stringliteral">                  $this-&gt;x = $cellpos[&#39;</span>startx<span class="stringliteral">&#39;];</span>
<a name="l14623"></a>14623 <span class="stringliteral">                  // account for margin changes</span>
<a name="l14624"></a>14624 <span class="stringliteral">                  if ($page &gt; $startpage) {</span>
<a name="l14625"></a>14625 <span class="stringliteral">                    if (($this-&gt;rtl) AND ($this-&gt;pagedim[$page][&#39;</span>orm<span class="stringliteral">&#39;] != $this-&gt;pagedim[$startpage][&#39;</span>orm<span class="stringliteral">&#39;])) {</span>
<a name="l14626"></a>14626 <span class="stringliteral">                      $this-&gt;x -= ($this-&gt;pagedim[$page][&#39;</span>orm<span class="stringliteral">&#39;] - $this-&gt;pagedim[$startpage][&#39;</span>orm<span class="stringliteral">&#39;]);</span>
<a name="l14627"></a>14627 <span class="stringliteral">                    } elseif ((!$this-&gt;rtl) AND ($this-&gt;pagedim[$page][&#39;</span>lm<span class="stringliteral">&#39;] != $this-&gt;pagedim[$startpage][&#39;</span>olm<span class="stringliteral">&#39;])) {</span>
<a name="l14628"></a>14628 <span class="stringliteral">                      $this-&gt;x += ($this-&gt;pagedim[$page][&#39;</span>olm<span class="stringliteral">&#39;] - $this-&gt;pagedim[$startpage][&#39;</span>olm<span class="stringliteral">&#39;]);</span>
<a name="l14629"></a>14629 <span class="stringliteral">                    }</span>
<a name="l14630"></a>14630 <span class="stringliteral">                  }</span>
<a name="l14631"></a>14631 <span class="stringliteral">                  // design a cell around the text</span>
<a name="l14632"></a>14632 <span class="stringliteral">                  $ccode = $this-&gt;FillColor.&quot;\n&quot;.$this-&gt;getCellCode($cw, $ch, &#39;</span><span class="stringliteral">&#39;, $cborder, 1, &#39;</span><span class="stringliteral">&#39;, $fill, &#39;</span><span class="stringliteral">&#39;, 0, true);</span>
<a name="l14633"></a>14633 <span class="stringliteral">                  if ($cborder OR $fill) {</span>
<a name="l14634"></a>14634 <span class="stringliteral">                    $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);</span>
<a name="l14635"></a>14635 <span class="stringliteral">                    $pstart = substr($pagebuff, 0, $this-&gt;intmrk[$this-&gt;page]);</span>
<a name="l14636"></a>14636 <span class="stringliteral">                    $pend = substr($pagebuff, $this-&gt;intmrk[$this-&gt;page]);</span>
<a name="l14637"></a>14637 <span class="stringliteral">                    $this-&gt;setPageBuffer($this-&gt;page, $pstart.$ccode.&quot;\n&quot;.$pend);</span>
<a name="l14638"></a>14638 <span class="stringliteral">                    $this-&gt;intmrk[$this-&gt;page] += strlen($ccode.&quot;\n&quot;);</span>
<a name="l14639"></a>14639 <span class="stringliteral">                  }</span>
<a name="l14640"></a>14640 <span class="stringliteral">                }</span>
<a name="l14641"></a>14641 <span class="stringliteral">              } else {</span>
<a name="l14642"></a>14642 <span class="stringliteral">                $this-&gt;setPage($startpage);</span>
<a name="l14643"></a>14643 <span class="stringliteral">                if (isset($cellpos[&#39;</span>bgcolor<span class="stringliteral">&#39;]) AND ($cellpos[&#39;</span>bgcolor<span class="stringliteral">&#39;]) !== false) {</span>
<a name="l14644"></a>14644 <span class="stringliteral">                  $this-&gt;SetFillColorArray($cellpos[&#39;</span>bgcolor<span class="stringliteral">&#39;]);</span>
<a name="l14645"></a>14645 <span class="stringliteral">                  $fill = true;</span>
<a name="l14646"></a>14646 <span class="stringliteral">                } else {</span>
<a name="l14647"></a>14647 <span class="stringliteral">                  $fill = false;</span>
<a name="l14648"></a>14648 <span class="stringliteral">                }</span>
<a name="l14649"></a>14649 <span class="stringliteral">                $this-&gt;x = $cellpos[&#39;</span>startx<span class="stringliteral">&#39;];</span>
<a name="l14650"></a>14650 <span class="stringliteral">                $this-&gt;y = $parent[&#39;</span>starty<span class="stringliteral">&#39;];</span>
<a name="l14651"></a>14651 <span class="stringliteral">                $cw = abs($cellpos[&#39;</span>endx<span class="stringliteral">&#39;] - $cellpos[&#39;</span>startx<span class="stringliteral">&#39;]);</span>
<a name="l14652"></a>14652 <span class="stringliteral">                $ch = $endy - $parent[&#39;</span>starty<span class="stringliteral">&#39;];</span>
<a name="l14653"></a>14653 <span class="stringliteral">                // design a cell around the text</span>
<a name="l14654"></a>14654 <span class="stringliteral">                $ccode = $this-&gt;FillColor.&quot;\n&quot;.$this-&gt;getCellCode($cw, $ch, &#39;</span><span class="stringliteral">&#39;, $border, 1, &#39;</span><span class="stringliteral">&#39;, $fill, &#39;</span><span class="stringliteral">&#39;, 0, true);</span>
<a name="l14655"></a>14655 <span class="stringliteral">                if ($border OR $fill) {</span>
<a name="l14656"></a>14656 <span class="stringliteral">                  if (end($this-&gt;transfmrk[$this-&gt;page]) !== false) {</span>
<a name="l14657"></a>14657 <span class="stringliteral">                    $pagemarkkey = key($this-&gt;transfmrk[$this-&gt;page]);</span>
<a name="l14658"></a>14658 <span class="stringliteral">                    $pagemark = &amp;$this-&gt;transfmrk[$this-&gt;page][$pagemarkkey];</span>
<a name="l14659"></a>14659 <span class="stringliteral">                  } elseif ($this-&gt;InFooter) {</span>
<a name="l14660"></a>14660 <span class="stringliteral">                    $pagemark = &amp;$this-&gt;footerpos[$this-&gt;page];</span>
<a name="l14661"></a>14661 <span class="stringliteral">                  } else {</span>
<a name="l14662"></a>14662 <span class="stringliteral">                    $pagemark = &amp;$this-&gt;intmrk[$this-&gt;page];</span>
<a name="l14663"></a>14663 <span class="stringliteral">                  }</span>
<a name="l14664"></a>14664 <span class="stringliteral">                  $pagebuff = $this-&gt;getPageBuffer($this-&gt;page);</span>
<a name="l14665"></a>14665 <span class="stringliteral">                  $pstart = substr($pagebuff, 0, $pagemark);</span>
<a name="l14666"></a>14666 <span class="stringliteral">                  $pend = substr($pagebuff, $pagemark);</span>
<a name="l14667"></a>14667 <span class="stringliteral">                  $this-&gt;setPageBuffer($this-&gt;page, $pstart.$ccode.&quot;\n&quot;.$pend);</span>
<a name="l14668"></a>14668 <span class="stringliteral">                  $pagemark += strlen($ccode.&quot;\n&quot;);</span>
<a name="l14669"></a>14669 <span class="stringliteral">                }         </span>
<a name="l14670"></a>14670 <span class="stringliteral">              }</span>
<a name="l14671"></a>14671 <span class="stringliteral">            }         </span>
<a name="l14672"></a>14672 <span class="stringliteral">            if (isset($table_el[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cellspacing<span class="stringliteral">&#39;])) {</span>
<a name="l14673"></a>14673 <span class="stringliteral">              $cellspacing = $this-&gt;getHTMLUnitToUnits($table_el[&#39;</span>attribute<span class="stringliteral">&#39;][&#39;</span>cellspacing<span class="stringliteral">&#39;], 1, &#39;</span>px<span class="stringliteral">&#39;);</span>
<a name="l14674"></a>14674 <span class="stringliteral">              $this-&gt;y += $cellspacing;</span>
<a name="l14675"></a>14675 <span class="stringliteral">            }       </span>
<a name="l14676"></a>14676 <span class="stringliteral">            $this-&gt;Ln(0, $cell);</span>
<a name="l14677"></a>14677 <span class="stringliteral">            $this-&gt;x = $parent[&#39;</span>startx<span class="stringliteral">&#39;];</span>
<a name="l14678"></a>14678 <span class="stringliteral">            if ($endpage &gt; $startpage) {</span>
<a name="l14679"></a>14679 <span class="stringliteral">              if (($this-&gt;rtl) AND ($this-&gt;pagedim[$endpage][&#39;</span>orm<span class="stringliteral">&#39;] != $this-&gt;pagedim[$startpage][&#39;</span>orm<span class="stringliteral">&#39;])) {</span>
<a name="l14680"></a>14680 <span class="stringliteral">                $this-&gt;x += ($this-&gt;pagedim[$endpage][&#39;</span>orm<span class="stringliteral">&#39;] - $this-&gt;pagedim[$startpage][&#39;</span>orm<span class="stringliteral">&#39;]);</span>
<a name="l14681"></a>14681 <span class="stringliteral">              } elseif ((!$this-&gt;rtl) AND ($this-&gt;pagedim[$endpage][&#39;</span>olm<span class="stringliteral">&#39;] != $this-&gt;pagedim[$startpage][&#39;</span>olm<span class="stringliteral">&#39;])) {</span>
<a name="l14682"></a>14682 <span class="stringliteral">                $this-&gt;x += ($this-&gt;pagedim[$endpage][&#39;</span>olm<span class="stringliteral">&#39;] - $this-&gt;pagedim[$startpage][&#39;</span>olm<span class="stringliteral">&#39;]);</span>
<a name="l14683"></a>14683 <span class="stringliteral">              }</span>
<a name="l14684"></a>14684 <span class="stringliteral">            }</span>
<a name="l14685"></a>14685 <span class="stringliteral">          }</span>
<a name="l14686"></a>14686 <span class="stringliteral">          if (!$in_table_head) {</span>
<a name="l14687"></a>14687 <span class="stringliteral">            // we are not inside a thead section</span>
<a name="l14688"></a>14688 <span class="stringliteral">            if (isset($parent[&#39;</span>cellpadding<span class="stringliteral">&#39;])) {</span>
<a name="l14689"></a>14689 <span class="stringliteral">              $this-&gt;cMargin = $this-&gt;oldcMargin;</span>
<a name="l14690"></a>14690 <span class="stringliteral">            }</span>
<a name="l14691"></a>14691 <span class="stringliteral">            $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio;</span>
<a name="l14692"></a>14692 <span class="stringliteral">            if (isset($this-&gt;theadMargins[&#39;</span>top<span class="stringliteral">&#39;])) {</span>
<a name="l14693"></a>14693 <span class="stringliteral">              // restore top margin</span>
<a name="l14694"></a>14694 <span class="stringliteral">              $this-&gt;tMargin = $this-&gt;theadMargins[&#39;</span>top<span class="stringliteral">&#39;];</span>
<a name="l14695"></a>14695 <span class="stringliteral">              $this-&gt;pagedim[$this-&gt;page][&#39;</span>tm<span class="stringliteral">&#39;] = $this-&gt;tMargin;</span>
<a name="l14696"></a>14696 <span class="stringliteral">            }</span>
<a name="l14697"></a>14697 <span class="stringliteral">            // reset table header</span>
<a name="l14698"></a>14698 <span class="stringliteral">            $this-&gt;thead = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14699"></a>14699 <span class="stringliteral">            $this-&gt;theadMargins = array();</span>
<a name="l14700"></a>14700 <span class="stringliteral">          }</span>
<a name="l14701"></a>14701 <span class="stringliteral">          break;</span>
<a name="l14702"></a>14702 <span class="stringliteral">        }</span>
<a name="l14703"></a>14703 <span class="stringliteral">        case &#39;</span>a<span class="stringliteral">&#39;: {</span>
<a name="l14704"></a>14704 <span class="stringliteral">          $this-&gt;HREF = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14705"></a>14705 <span class="stringliteral">          break;</span>
<a name="l14706"></a>14706 <span class="stringliteral">        }</span>
<a name="l14707"></a>14707 <span class="stringliteral">        case &#39;</span>sup<span class="stringliteral">&#39;: {</span>
<a name="l14708"></a>14708 <span class="stringliteral">          $this-&gt;SetXY($this-&gt;GetX(), $this-&gt;GetY() + ((0.7 * $parent[&#39;</span>fontsize<span class="stringliteral">&#39;]) / $this-&gt;k));</span>
<a name="l14709"></a>14709 <span class="stringliteral">          break;</span>
<a name="l14710"></a>14710 <span class="stringliteral">        }</span>
<a name="l14711"></a>14711 <span class="stringliteral">        case &#39;</span>sub<span class="stringliteral">&#39;: {</span>
<a name="l14712"></a>14712 <span class="stringliteral">          $this-&gt;SetXY($this-&gt;GetX(), $this-&gt;GetY() - ((0.3 * $parent[&#39;</span>fontsize<span class="stringliteral">&#39;])/$this-&gt;k));</span>
<a name="l14713"></a>14713 <span class="stringliteral">          break;</span>
<a name="l14714"></a>14714 <span class="stringliteral">        }</span>
<a name="l14715"></a>14715 <span class="stringliteral">        case &#39;</span>div<span class="stringliteral">&#39;: {</span>
<a name="l14716"></a>14716 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(1, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14717"></a>14717 <span class="stringliteral">          break;</span>
<a name="l14718"></a>14718 <span class="stringliteral">        }</span>
<a name="l14719"></a>14719 <span class="stringliteral">        case &#39;</span>blockquote<span class="stringliteral">&#39;: {</span>
<a name="l14720"></a>14720 <span class="stringliteral">          if ($this-&gt;rtl) {</span>
<a name="l14721"></a>14721 <span class="stringliteral">            $this-&gt;rMargin -= $this-&gt;listindent;</span>
<a name="l14722"></a>14722 <span class="stringliteral">          } else {</span>
<a name="l14723"></a>14723 <span class="stringliteral">            $this-&gt;lMargin -= $this-&gt;listindent;</span>
<a name="l14724"></a>14724 <span class="stringliteral">          }</span>
<a name="l14725"></a>14725 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(2, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14726"></a>14726 <span class="stringliteral">          break;</span>
<a name="l14727"></a>14727 <span class="stringliteral">        }</span>
<a name="l14728"></a>14728 <span class="stringliteral">        case &#39;</span>p<span class="stringliteral">&#39;: {</span>
<a name="l14729"></a>14729 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(2, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14730"></a>14730 <span class="stringliteral">          break;</span>
<a name="l14731"></a>14731 <span class="stringliteral">        }</span>
<a name="l14732"></a>14732 <span class="stringliteral">        case &#39;</span>pre<span class="stringliteral">&#39;: {</span>
<a name="l14733"></a>14733 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(1, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14734"></a>14734 <span class="stringliteral">          $this-&gt;premode = false;</span>
<a name="l14735"></a>14735 <span class="stringliteral">          break;</span>
<a name="l14736"></a>14736 <span class="stringliteral">        }</span>
<a name="l14737"></a>14737 <span class="stringliteral">        case &#39;</span>dl<span class="stringliteral">&#39;: {</span>
<a name="l14738"></a>14738 <span class="stringliteral">          --$this-&gt;listnum;</span>
<a name="l14739"></a>14739 <span class="stringliteral">          if ($this-&gt;listnum &lt;= 0) {</span>
<a name="l14740"></a>14740 <span class="stringliteral">            $this-&gt;listnum = 0;</span>
<a name="l14741"></a>14741 <span class="stringliteral">            $this-&gt;addHTMLVertSpace(2, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14742"></a>14742 <span class="stringliteral">          }</span>
<a name="l14743"></a>14743 <span class="stringliteral">          break;</span>
<a name="l14744"></a>14744 <span class="stringliteral">        }</span>
<a name="l14745"></a>14745 <span class="stringliteral">        case &#39;</span>dt<span class="stringliteral">&#39;: {</span>
<a name="l14746"></a>14746 <span class="stringliteral">          $this-&gt;lispacer = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14747"></a>14747 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(0, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14748"></a>14748 <span class="stringliteral">          break;</span>
<a name="l14749"></a>14749 <span class="stringliteral">        }</span>
<a name="l14750"></a>14750 <span class="stringliteral">        case &#39;</span>dd<span class="stringliteral">&#39;: {</span>
<a name="l14751"></a>14751 <span class="stringliteral">          $this-&gt;lispacer = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14752"></a>14752 <span class="stringliteral">          if ($this-&gt;rtl) {</span>
<a name="l14753"></a>14753 <span class="stringliteral">            $this-&gt;rMargin -= $this-&gt;listindent;</span>
<a name="l14754"></a>14754 <span class="stringliteral">          } else {</span>
<a name="l14755"></a>14755 <span class="stringliteral">            $this-&gt;lMargin -= $this-&gt;listindent;</span>
<a name="l14756"></a>14756 <span class="stringliteral">          }</span>
<a name="l14757"></a>14757 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(0, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14758"></a>14758 <span class="stringliteral">          break;</span>
<a name="l14759"></a>14759 <span class="stringliteral">        }</span>
<a name="l14760"></a>14760 <span class="stringliteral">        case &#39;</span>ul<span class="stringliteral">&#39;:</span>
<a name="l14761"></a>14761 <span class="stringliteral">        case &#39;</span>ol<span class="stringliteral">&#39;: {</span>
<a name="l14762"></a>14762 <span class="stringliteral">          --$this-&gt;listnum;</span>
<a name="l14763"></a>14763 <span class="stringliteral">          $this-&gt;lispacer = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14764"></a>14764 <span class="stringliteral">          if ($this-&gt;rtl) {</span>
<a name="l14765"></a>14765 <span class="stringliteral">            $this-&gt;rMargin -= $this-&gt;listindent;</span>
<a name="l14766"></a>14766 <span class="stringliteral">          } else {</span>
<a name="l14767"></a>14767 <span class="stringliteral">            $this-&gt;lMargin -= $this-&gt;listindent;</span>
<a name="l14768"></a>14768 <span class="stringliteral">          }</span>
<a name="l14769"></a>14769 <span class="stringliteral">          if ($this-&gt;listnum &lt;= 0) {</span>
<a name="l14770"></a>14770 <span class="stringliteral">            $this-&gt;listnum = 0;</span>
<a name="l14771"></a>14771 <span class="stringliteral">            $this-&gt;addHTMLVertSpace(2, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14772"></a>14772 <span class="stringliteral">          }</span>
<a name="l14773"></a>14773 <span class="stringliteral">          $this-&gt;lasth = $this-&gt;FontSize * $this-&gt;cell_height_ratio;</span>
<a name="l14774"></a>14774 <span class="stringliteral">          break;</span>
<a name="l14775"></a>14775 <span class="stringliteral">        }</span>
<a name="l14776"></a>14776 <span class="stringliteral">        case &#39;</span>li<span class="stringliteral">&#39;: {</span>
<a name="l14777"></a>14777 <span class="stringliteral">          $this-&gt;lispacer = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14778"></a>14778 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(0, $cell, &#39;</span><span class="stringliteral">&#39;, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14779"></a>14779 <span class="stringliteral">          break;</span>
<a name="l14780"></a>14780 <span class="stringliteral">        }</span>
<a name="l14781"></a>14781 <span class="stringliteral">        case &#39;</span>h1<span class="stringliteral">&#39;: </span>
<a name="l14782"></a>14782 <span class="stringliteral">        case &#39;</span>h2<span class="stringliteral">&#39;: </span>
<a name="l14783"></a>14783 <span class="stringliteral">        case &#39;</span>h3<span class="stringliteral">&#39;: </span>
<a name="l14784"></a>14784 <span class="stringliteral">        case &#39;</span>h4<span class="stringliteral">&#39;: </span>
<a name="l14785"></a>14785 <span class="stringliteral">        case &#39;</span>h5<span class="stringliteral">&#39;: </span>
<a name="l14786"></a>14786 <span class="stringliteral">        case &#39;</span>h6<span class="stringliteral">&#39;: {</span>
<a name="l14787"></a>14787 <span class="stringliteral">          $this-&gt;addHTMLVertSpace(1, $cell, ($parent[&#39;</span>fontsize<span class="stringliteral">&#39;] * 1.5) / $this-&gt;k, $firstorlast, $tag[&#39;</span>value<span class="stringliteral">&#39;], true);</span>
<a name="l14788"></a>14788 <span class="stringliteral">          break;</span>
<a name="l14789"></a>14789 <span class="stringliteral">        }</span>
<a name="l14790"></a>14790 <span class="stringliteral">        // Form fields (since 4.8.000 - 2009-09-07)</span>
<a name="l14791"></a>14791 <span class="stringliteral">        case &#39;</span>form<span class="stringliteral">&#39;: {</span>
<a name="l14792"></a>14792 <span class="stringliteral">          $this-&gt;form_action = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14793"></a>14793 <span class="stringliteral">          $this-&gt;form_enctype = &#39;</span>application/x-www-form-urlencoded<span class="stringliteral">&#39;;</span>
<a name="l14794"></a>14794 <span class="stringliteral">          break;</span>
<a name="l14795"></a>14795 <span class="stringliteral">        }</span>
<a name="l14796"></a>14796 <span class="stringliteral">        default : {</span>
<a name="l14797"></a>14797 <span class="stringliteral">          break;</span>
<a name="l14798"></a>14798 <span class="stringliteral">        }</span>
<a name="l14799"></a>14799 <span class="stringliteral">      }</span>
<a name="l14800"></a>14800 <span class="stringliteral">      $this-&gt;tmprtl = false;</span>
<a name="l14801"></a>14801 <span class="stringliteral">    }</span>
<a name="l14802"></a>14802 <span class="stringliteral">    </span>
<a name="l14813"></a>14813 <span class="stringliteral">    protected function addHTMLVertSpace($n, $cell=false, $h=&#39;</span><span class="stringliteral">&#39;, $firstorlast=false, $tag=&#39;</span><span class="stringliteral">&#39;, $closing=false) {</span>
<a name="l14814"></a>14814 <span class="stringliteral">      if ($firstorlast) {</span>
<a name="l14815"></a>14815 <span class="stringliteral">        $this-&gt;Ln(0, $cell);</span>
<a name="l14816"></a>14816 <span class="stringliteral">        $this-&gt;htmlvspace = 0;</span>
<a name="l14817"></a>14817 <span class="stringliteral">        return;</span>
<a name="l14818"></a>14818 <span class="stringliteral">      }</span>
<a name="l14819"></a>14819 <span class="stringliteral">      if (isset($this-&gt;tagvspaces[$tag][intval($closing)][&#39;</span>n<span class="stringliteral">&#39;])) {</span>
<a name="l14820"></a>14820 <span class="stringliteral">        $n = $this-&gt;tagvspaces[$tag][intval($closing)][&#39;</span>n<span class="stringliteral">&#39;];</span>
<a name="l14821"></a>14821 <span class="stringliteral">      }</span>
<a name="l14822"></a>14822 <span class="stringliteral">      if (isset($this-&gt;tagvspaces[$tag][intval($closing)][&#39;</span>h<span class="stringliteral">&#39;])) {</span>
<a name="l14823"></a>14823 <span class="stringliteral">        $h = $this-&gt;tagvspaces[$tag][intval($closing)][&#39;</span>h<span class="stringliteral">&#39;];</span>
<a name="l14824"></a>14824 <span class="stringliteral">      }</span>
<a name="l14825"></a>14825 <span class="stringliteral">      if (is_string($h)) {</span>
<a name="l14826"></a>14826 <span class="stringliteral">        $vsize = $n * $this-&gt;lasth;</span>
<a name="l14827"></a>14827 <span class="stringliteral">      } else {</span>
<a name="l14828"></a>14828 <span class="stringliteral">        $vsize = $n * $h;</span>
<a name="l14829"></a>14829 <span class="stringliteral">      }</span>
<a name="l14830"></a>14830 <span class="stringliteral">      if ($vsize &gt; $this-&gt;htmlvspace) {</span>
<a name="l14831"></a>14831 <span class="stringliteral">        $this-&gt;Ln(($vsize - $this-&gt;htmlvspace), $cell);</span>
<a name="l14832"></a>14832 <span class="stringliteral">        $this-&gt;htmlvspace = $vsize;</span>
<a name="l14833"></a>14833 <span class="stringliteral">      }</span>
<a name="l14834"></a>14834 <span class="stringliteral">    }</span>
<a name="l14835"></a>14835 <span class="stringliteral">    </span>
<a name="l14842"></a>14842 <span class="stringliteral">    public function setLIsymbol($symbol=&#39;</span>!<span class="stringliteral">&#39;) {</span>
<a name="l14843"></a>14843 <span class="stringliteral">      $symbol = strtolower($symbol);</span>
<a name="l14844"></a>14844 <span class="stringliteral">      switch ($symbol) {</span>
<a name="l14845"></a>14845 <span class="stringliteral">        case &#39;</span>!<span class="stringliteral">&#39; :</span>
<a name="l14846"></a>14846 <span class="stringliteral">        case &#39;</span>#<span class="stringliteral">&#39; :</span>
<a name="l14847"></a>14847 <span class="stringliteral">        case &#39;</span>disc<span class="stringliteral">&#39; :</span>
<a name="l14848"></a>14848 <span class="stringliteral">        case &#39;</span>disc<span class="stringliteral">&#39; :</span>
<a name="l14849"></a>14849 <span class="stringliteral">        case &#39;</span>circle<span class="stringliteral">&#39; :</span>
<a name="l14850"></a>14850 <span class="stringliteral">        case &#39;</span>square<span class="stringliteral">&#39; :</span>
<a name="l14851"></a>14851 <span class="stringliteral">        case &#39;</span>1<span class="stringliteral">&#39;:</span>
<a name="l14852"></a>14852 <span class="stringliteral">        case &#39;</span>decimal<span class="stringliteral">&#39;:</span>
<a name="l14853"></a>14853 <span class="stringliteral">        case &#39;</span>decimal-leading-zero<span class="stringliteral">&#39;:</span>
<a name="l14854"></a>14854 <span class="stringliteral">        case &#39;</span>i<span class="stringliteral">&#39;:</span>
<a name="l14855"></a>14855 <span class="stringliteral">        case &#39;</span>lower-roman<span class="stringliteral">&#39;:</span>
<a name="l14856"></a>14856 <span class="stringliteral">        case &#39;</span>I<span class="stringliteral">&#39;:</span>
<a name="l14857"></a>14857 <span class="stringliteral">        case &#39;</span>upper-roman<span class="stringliteral">&#39;:</span>
<a name="l14858"></a>14858 <span class="stringliteral">        case &#39;</span>a<span class="stringliteral">&#39;:</span>
<a name="l14859"></a>14859 <span class="stringliteral">        case &#39;</span>lower-alpha<span class="stringliteral">&#39;:</span>
<a name="l14860"></a>14860 <span class="stringliteral">        case &#39;</span>lower-latin<span class="stringliteral">&#39;:</span>
<a name="l14861"></a>14861 <span class="stringliteral">        case &#39;</span>A<span class="stringliteral">&#39;:</span>
<a name="l14862"></a>14862 <span class="stringliteral">        case &#39;</span>upper-alpha<span class="stringliteral">&#39;:</span>
<a name="l14863"></a>14863 <span class="stringliteral">        case &#39;</span>upper-latin<span class="stringliteral">&#39;:</span>
<a name="l14864"></a>14864 <span class="stringliteral">        case &#39;</span>lower-greek<span class="stringliteral">&#39;: {</span>
<a name="l14865"></a>14865 <span class="stringliteral">          $this-&gt;lisymbol = $symbol;</span>
<a name="l14866"></a>14866 <span class="stringliteral">          break;</span>
<a name="l14867"></a>14867 <span class="stringliteral">        }</span>
<a name="l14868"></a>14868 <span class="stringliteral">        default : {</span>
<a name="l14869"></a>14869 <span class="stringliteral">          $this-&gt;lisymbol = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l14870"></a>14870 <span class="stringliteral">        }</span>
<a name="l14871"></a>14871 <span class="stringliteral">      }</span>
<a name="l14872"></a>14872 <span class="stringliteral">    }</span>
<a name="l14873"></a>14873 <span class="stringliteral">    </span>
<a name="l14882"></a>14882 <span class="stringliteral">    public function SetBooklet($booklet=true, $inner=-1, $outer=-1) {</span>
<a name="l14883"></a>14883 <span class="stringliteral">      $this-&gt;booklet = $booklet;</span>
<a name="l14884"></a>14884 <span class="stringliteral">      if ($inner &gt;= 0) {</span>
<a name="l14885"></a>14885 <span class="stringliteral">        $this-&gt;lMargin = $inner;</span>
<a name="l14886"></a>14886 <span class="stringliteral">      }</span>
<a name="l14887"></a>14887 <span class="stringliteral">      if ($outer &gt;= 0) {</span>
<a name="l14888"></a>14888 <span class="stringliteral">        $this-&gt;rMargin = $outer;</span>
<a name="l14889"></a>14889 <span class="stringliteral">      }</span>
<a name="l14890"></a>14890 <span class="stringliteral">    }</span>
<a name="l14891"></a>14891 <span class="stringliteral">    </span>
<a name="l14898"></a>14898 <span class="stringliteral">    protected function swapMargins($reverse=true) {</span>
<a name="l14899"></a>14899 <span class="stringliteral">      if ($reverse) {</span>
<a name="l14900"></a>14900 <span class="stringliteral">        // swap left and right margins</span>
<a name="l14901"></a>14901 <span class="stringliteral">        $mtemp = $this-&gt;original_lMargin;</span>
<a name="l14902"></a>14902 <span class="stringliteral">        $this-&gt;original_lMargin = $this-&gt;original_rMargin;</span>
<a name="l14903"></a>14903 <span class="stringliteral">        $this-&gt;original_rMargin = $mtemp;</span>
<a name="l14904"></a>14904 <span class="stringliteral">        $deltam = $this-&gt;original_lMargin - $this-&gt;original_rMargin;</span>
<a name="l14905"></a>14905 <span class="stringliteral">        $this-&gt;lMargin += $deltam;</span>
<a name="l14906"></a>14906 <span class="stringliteral">        $this-&gt;rMargin -= $deltam;</span>
<a name="l14907"></a>14907 <span class="stringliteral">      }</span>
<a name="l14908"></a>14908 <span class="stringliteral">    }</span>
<a name="l14909"></a>14909 <span class="stringliteral"></span>
<a name="l14922"></a>14922 <span class="stringliteral">    public function setHtmlVSpace($tagvs) {</span>
<a name="l14923"></a>14923 <span class="stringliteral">      $this-&gt;tagvspaces = $tagvs;</span>
<a name="l14924"></a>14924 <span class="stringliteral">    }</span>
<a name="l14925"></a>14925 <span class="stringliteral"></span>
<a name="l14932"></a>14932 <span class="stringliteral">    public function setListIndentWidth($width) {</span>
<a name="l14933"></a>14933 <span class="stringliteral">      return $this-&gt;customlistindent = floatval($width);</span>
<a name="l14934"></a>14934 <span class="stringliteral">        }</span>
<a name="l14935"></a>14935 <span class="stringliteral"></span>
<a name="l14942"></a>14942 <span class="stringliteral">    public function setOpenCell($isopen) {</span>
<a name="l14943"></a>14943 <span class="stringliteral">      $this-&gt;opencell = $isopen;</span>
<a name="l14944"></a>14944 <span class="stringliteral">        }</span>
<a name="l14945"></a>14945 <span class="stringliteral"></span>
<a name="l14953"></a>14953 <span class="stringliteral">    public function setHtmlLinksStyle($color=array(0,0,255), $fontstyle=&#39;</span>U<span class="stringliteral">&#39;) {</span>
<a name="l14954"></a>14954 <span class="stringliteral">      $this-&gt;htmlLinkColorArray = $color;</span>
<a name="l14955"></a>14955 <span class="stringliteral">      $this-&gt;htmlLinkFontStyle = $fontstyle;</span>
<a name="l14956"></a>14956 <span class="stringliteral">        }</span>
<a name="l14957"></a>14957 <span class="stringliteral"></span>
<a name="l14968"></a>14968 <span class="stringliteral">        public function getHTMLUnitToUnits($htmlval, $refsize=1, $defaultunit=&#39;</span>px<span class="stringliteral">&#39;, $points=false) {</span>
<a name="l14969"></a>14969 <span class="stringliteral">      $supportedunits = array(&#39;</span>%<span class="stringliteral">&#39;, &#39;</span>em<span class="stringliteral">&#39;, &#39;</span>ex<span class="stringliteral">&#39;, &#39;</span>px<span class="stringliteral">&#39;, &#39;</span>in<span class="stringliteral">&#39;, &#39;</span>cm<span class="stringliteral">&#39;, &#39;</span>mm<span class="stringliteral">&#39;, &#39;</span>pc<span class="stringliteral">&#39;, &#39;</span>pt<span class="stringliteral">&#39;);</span>
<a name="l14970"></a>14970 <span class="stringliteral">      $retval = 0;</span>
<a name="l14971"></a>14971 <span class="stringliteral">      $value = 0;</span>
<a name="l14972"></a>14972 <span class="stringliteral">      $unit = &#39;</span>px<span class="stringliteral">&#39;;</span>
<a name="l14973"></a>14973 <span class="stringliteral">      $k = $this-&gt;k;</span>
<a name="l14974"></a>14974 <span class="stringliteral">      if ($points) {</span>
<a name="l14975"></a>14975 <span class="stringliteral">        $k = 1;</span>
<a name="l14976"></a>14976 <span class="stringliteral">      }</span>
<a name="l14977"></a>14977 <span class="stringliteral">      if (in_array($defaultunit, $supportedunits)) {</span>
<a name="l14978"></a>14978 <span class="stringliteral">        $unit = $defaultunit;</span>
<a name="l14979"></a>14979 <span class="stringliteral">      }</span>
<a name="l14980"></a>14980 <span class="stringliteral">      if (is_numeric($htmlval)) {</span>
<a name="l14981"></a>14981 <span class="stringliteral">        $value = floatval($htmlval);</span>
<a name="l14982"></a>14982 <span class="stringliteral">      } elseif (preg_match(&#39;</span>/([0-9\.]+)/<span class="stringliteral">&#39;, $htmlval, $mnum)) {</span>
<a name="l14983"></a>14983 <span class="stringliteral">        $value = floatval($mnum[1]);</span>
<a name="l14984"></a>14984 <span class="stringliteral">        if (preg_match(&#39;</span>/([a-z%]+)/<span class="stringliteral">&#39;, $htmlval, $munit)) {</span>
<a name="l14985"></a>14985 <span class="stringliteral">          if (in_array($munit[1], $supportedunits)) {</span>
<a name="l14986"></a>14986 <span class="stringliteral">            $unit = $munit[1];</span>
<a name="l14987"></a>14987 <span class="stringliteral">          }</span>
<a name="l14988"></a>14988 <span class="stringliteral">        }</span>
<a name="l14989"></a>14989 <span class="stringliteral">      }</span>
<a name="l14990"></a>14990 <span class="stringliteral">      switch ($unit) {</span>
<a name="l14991"></a>14991 <span class="stringliteral">        // percentage</span>
<a name="l14992"></a>14992 <span class="stringliteral">        case &#39;</span>%<span class="stringliteral">&#39;: {</span>
<a name="l14993"></a>14993 <span class="stringliteral">          $retval = (($value * $refsize) / 100);</span>
<a name="l14994"></a>14994 <span class="stringliteral">          break;</span>
<a name="l14995"></a>14995 <span class="stringliteral">        }</span>
<a name="l14996"></a>14996 <span class="stringliteral">        // relative-size</span>
<a name="l14997"></a>14997 <span class="stringliteral">        case &#39;</span>em<span class="stringliteral">&#39;: {</span>
<a name="l14998"></a>14998 <span class="stringliteral">          $retval = ($value * $refsize);</span>
<a name="l14999"></a>14999 <span class="stringliteral">          break;</span>
<a name="l15000"></a>15000 <span class="stringliteral">        }</span>
<a name="l15001"></a>15001 <span class="stringliteral">        case &#39;</span>ex<span class="stringliteral">&#39;: {</span>
<a name="l15002"></a>15002 <span class="stringliteral">          $retval = $value * ($refsize / 2);</span>
<a name="l15003"></a>15003 <span class="stringliteral">          break;</span>
<a name="l15004"></a>15004 <span class="stringliteral">        }</span>
<a name="l15005"></a>15005 <span class="stringliteral">        // absolute-size</span>
<a name="l15006"></a>15006 <span class="stringliteral">        case &#39;</span>in<span class="stringliteral">&#39;: {</span>
<a name="l15007"></a>15007 <span class="stringliteral">          $retval = ($value * $this-&gt;dpi) / $k;</span>
<a name="l15008"></a>15008 <span class="stringliteral">          break;</span>
<a name="l15009"></a>15009 <span class="stringliteral">        }</span>
<a name="l15010"></a>15010 <span class="stringliteral">        case &#39;</span>cm<span class="stringliteral">&#39;: {</span>
<a name="l15011"></a>15011 <span class="stringliteral">          $retval = ($value / 2.54 * $this-&gt;dpi) / $k;</span>
<a name="l15012"></a>15012 <span class="stringliteral">          break;</span>
<a name="l15013"></a>15013 <span class="stringliteral">        }</span>
<a name="l15014"></a>15014 <span class="stringliteral">        case &#39;</span>mm<span class="stringliteral">&#39;: {</span>
<a name="l15015"></a>15015 <span class="stringliteral">          $retval = ($value / 25.4 * $this-&gt;dpi) / $k;</span>
<a name="l15016"></a>15016 <span class="stringliteral">          break;</span>
<a name="l15017"></a>15017 <span class="stringliteral">        }</span>
<a name="l15018"></a>15018 <span class="stringliteral">        case &#39;</span>pc<span class="stringliteral">&#39;: {</span>
<a name="l15019"></a>15019 <span class="stringliteral">          // one pica is 12 points</span>
<a name="l15020"></a>15020 <span class="stringliteral">          $retval = ($value * 12) / $k;</span>
<a name="l15021"></a>15021 <span class="stringliteral">          break;</span>
<a name="l15022"></a>15022 <span class="stringliteral">        }</span>
<a name="l15023"></a>15023 <span class="stringliteral">        case &#39;</span>pt<span class="stringliteral">&#39;: {</span>
<a name="l15024"></a>15024 <span class="stringliteral">          $retval = $value / $k;</span>
<a name="l15025"></a>15025 <span class="stringliteral">          break;</span>
<a name="l15026"></a>15026 <span class="stringliteral">        }</span>
<a name="l15027"></a>15027 <span class="stringliteral">        case &#39;</span>px<span class="stringliteral">&#39;: {</span>
<a name="l15028"></a>15028 <span class="stringliteral">          $retval = $this-&gt;pixelsToUnits($value);</span>
<a name="l15029"></a>15029 <span class="stringliteral">          break;</span>
<a name="l15030"></a>15030 <span class="stringliteral">        }</span>
<a name="l15031"></a>15031 <span class="stringliteral">      }</span>
<a name="l15032"></a>15032 <span class="stringliteral">      return $retval;</span>
<a name="l15033"></a>15033 <span class="stringliteral">    }</span>
<a name="l15034"></a>15034 <span class="stringliteral"></span>
<a name="l15042"></a>15042 <span class="stringliteral">    public function intToRoman($number) {</span>
<a name="l15043"></a>15043 <span class="stringliteral">      $roman = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l15044"></a>15044 <span class="stringliteral">      while ($number &gt;= 1000) {</span>
<a name="l15045"></a>15045 <span class="stringliteral">        $roman .= &#39;</span>M<span class="stringliteral">&#39;;</span>
<a name="l15046"></a>15046 <span class="stringliteral">        $number -= 1000;</span>
<a name="l15047"></a>15047 <span class="stringliteral">      }</span>
<a name="l15048"></a>15048 <span class="stringliteral">      while ($number &gt;= 900) {</span>
<a name="l15049"></a>15049 <span class="stringliteral">        $roman .= &#39;</span>CM<span class="stringliteral">&#39;;</span>
<a name="l15050"></a>15050 <span class="stringliteral">        $number -= 900;</span>
<a name="l15051"></a>15051 <span class="stringliteral">      }</span>
<a name="l15052"></a>15052 <span class="stringliteral">      while ($number &gt;= 500) {</span>
<a name="l15053"></a>15053 <span class="stringliteral">        $roman .= &#39;</span>D<span class="stringliteral">&#39;;</span>
<a name="l15054"></a>15054 <span class="stringliteral">        $number -= 500;</span>
<a name="l15055"></a>15055 <span class="stringliteral">      }</span>
<a name="l15056"></a>15056 <span class="stringliteral">      while ($number &gt;= 400) {</span>
<a name="l15057"></a>15057 <span class="stringliteral">        $roman .= &#39;</span>CD<span class="stringliteral">&#39;;</span>
<a name="l15058"></a>15058 <span class="stringliteral">        $number -= 400;</span>
<a name="l15059"></a>15059 <span class="stringliteral">      }</span>
<a name="l15060"></a>15060 <span class="stringliteral">      while ($number &gt;= 100) {</span>
<a name="l15061"></a>15061 <span class="stringliteral">        $roman .= &#39;</span>C<span class="stringliteral">&#39;;</span>
<a name="l15062"></a>15062 <span class="stringliteral">        $number -= 100;</span>
<a name="l15063"></a>15063 <span class="stringliteral">      }</span>
<a name="l15064"></a>15064 <span class="stringliteral">      while ($number &gt;= 90) {</span>
<a name="l15065"></a>15065 <span class="stringliteral">      $roman .= &#39;</span>XC<span class="stringliteral">&#39;;</span>
<a name="l15066"></a>15066 <span class="stringliteral">      $number -= 90;</span>
<a name="l15067"></a>15067 <span class="stringliteral">      }</span>
<a name="l15068"></a>15068 <span class="stringliteral">      while ($number &gt;= 50) {</span>
<a name="l15069"></a>15069 <span class="stringliteral">        $roman .= &#39;</span>L<span class="stringliteral">&#39;;</span>
<a name="l15070"></a>15070 <span class="stringliteral">        $number -= 50;</span>
<a name="l15071"></a>15071 <span class="stringliteral">      }</span>
<a name="l15072"></a>15072 <span class="stringliteral">      while ($number &gt;= 40) {</span>
<a name="l15073"></a>15073 <span class="stringliteral">        $roman .= &#39;</span>XL<span class="stringliteral">&#39;;</span>
<a name="l15074"></a>15074 <span class="stringliteral">        $number -= 40;</span>
<a name="l15075"></a>15075 <span class="stringliteral">      }</span>
<a name="l15076"></a>15076 <span class="stringliteral">      while ($number &gt;= 10) {</span>
<a name="l15077"></a>15077 <span class="stringliteral">      $roman .= &#39;</span>X<span class="stringliteral">&#39;;</span>
<a name="l15078"></a>15078 <span class="stringliteral">      $number -= 10;</span>
<a name="l15079"></a>15079 <span class="stringliteral">      }</span>
<a name="l15080"></a>15080 <span class="stringliteral">      while ($number &gt;= 9) {</span>
<a name="l15081"></a>15081 <span class="stringliteral">        $roman .= &#39;</span>IX<span class="stringliteral">&#39;;</span>
<a name="l15082"></a>15082 <span class="stringliteral">        $number -= 9;</span>
<a name="l15083"></a>15083 <span class="stringliteral">      }</span>
<a name="l15084"></a>15084 <span class="stringliteral">      while ($number &gt;= 5) {</span>
<a name="l15085"></a>15085 <span class="stringliteral">        $roman .= &#39;</span>V<span class="stringliteral">&#39;;</span>
<a name="l15086"></a>15086 <span class="stringliteral">        $number -= 5;</span>
<a name="l15087"></a>15087 <span class="stringliteral">      }</span>
<a name="l15088"></a>15088 <span class="stringliteral">      while ($number &gt;= 4) {</span>
<a name="l15089"></a>15089 <span class="stringliteral">      $roman .= &#39;</span>IV<span class="stringliteral">&#39;;</span>
<a name="l15090"></a>15090 <span class="stringliteral">      $number -= 4;</span>
<a name="l15091"></a>15091 <span class="stringliteral">      }</span>
<a name="l15092"></a>15092 <span class="stringliteral">      while ($number &gt;= 1) {</span>
<a name="l15093"></a>15093 <span class="stringliteral">        $roman .= &#39;</span>I<span class="stringliteral">&#39;;</span>
<a name="l15094"></a>15094 <span class="stringliteral">        --$number;</span>
<a name="l15095"></a>15095 <span class="stringliteral">      }</span>
<a name="l15096"></a>15096 <span class="stringliteral">      return $roman;</span>
<a name="l15097"></a>15097 <span class="stringliteral">    }</span>
<a name="l15098"></a>15098 <span class="stringliteral"></span>
<a name="l15107"></a>15107 <span class="stringliteral">    protected function putHtmlListBullet($listdepth, $listtype=&#39;</span><span class="stringliteral">&#39;, $size=10) {</span>
<a name="l15108"></a>15108 <span class="stringliteral">        $size /= $this-&gt;k;</span>
<a name="l15109"></a>15109 <span class="stringliteral">        $fill = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l15110"></a>15110 <span class="stringliteral">        $color = $this-&gt;fgcolor;</span>
<a name="l15111"></a>15111 <span class="stringliteral">        $width = 0;</span>
<a name="l15112"></a>15112 <span class="stringliteral">        $textitem = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l15113"></a>15113 <span class="stringliteral">        $tmpx = $this-&gt;x;   </span>
<a name="l15114"></a>15114 <span class="stringliteral">      $lspace = $this-&gt;GetStringWidth(&#39;</span>  <span class="stringliteral">&#39;);</span>
<a name="l15115"></a>15115 <span class="stringliteral">      if ($listtype == &#39;</span>!<span class="stringliteral">&#39;) {</span>
<a name="l15116"></a>15116 <span class="stringliteral">        // set default list type for unordered list</span>
<a name="l15117"></a>15117 <span class="stringliteral">        $deftypes = array(&#39;</span>disc<span class="stringliteral">&#39;, &#39;</span>circle<span class="stringliteral">&#39;, &#39;</span>square<span class="stringliteral">&#39;);</span>
<a name="l15118"></a>15118 <span class="stringliteral">        $listtype = $deftypes[($listdepth - 1) % 3];</span>
<a name="l15119"></a>15119 <span class="stringliteral">      } elseif ($listtype == &#39;</span>#<span class="stringliteral">&#39;) {</span>
<a name="l15120"></a>15120 <span class="stringliteral">        // set default list type for ordered list</span>
<a name="l15121"></a>15121 <span class="stringliteral">        $listtype = &#39;</span>decimal<span class="stringliteral">&#39;;</span>
<a name="l15122"></a>15122 <span class="stringliteral">      }</span>
<a name="l15123"></a>15123 <span class="stringliteral">          switch ($listtype) {</span>
<a name="l15124"></a>15124 <span class="stringliteral">            // unordered types</span>
<a name="l15125"></a>15125 <span class="stringliteral">        case &#39;</span>none<span class="stringliteral">&#39;: {</span>
<a name="l15126"></a>15126 <span class="stringliteral">          break;</span>
<a name="l15127"></a>15127 <span class="stringliteral">        }</span>
<a name="l15128"></a>15128 <span class="stringliteral">        case &#39;</span>disc<span class="stringliteral">&#39;: {</span>
<a name="l15129"></a>15129 <span class="stringliteral">          $fill = &#39;</span>F<span class="stringliteral">&#39;;</span>
<a name="l15130"></a>15130 <span class="stringliteral">        }</span>
<a name="l15131"></a>15131 <span class="stringliteral">        case &#39;</span>circle<span class="stringliteral">&#39;: {</span>
<a name="l15132"></a>15132 <span class="stringliteral">          $fill .= &#39;</span>D<span class="stringliteral">&#39;;</span>
<a name="l15133"></a>15133 <span class="stringliteral">          $r = $size / 6;</span>
<a name="l15134"></a>15134 <span class="stringliteral">          $lspace += (2 * $r);</span>
<a name="l15135"></a>15135 <span class="stringliteral">          if ($this-&gt;rtl) {</span>
<a name="l15136"></a>15136 <span class="stringliteral">            $this-&gt;x = $this-&gt;w - $this-&gt;x - $lspace;</span>
<a name="l15137"></a>15137 <span class="stringliteral">          } else {</span>
<a name="l15138"></a>15138 <span class="stringliteral">            $this-&gt;x -= $lspace;</span>
<a name="l15139"></a>15139 <span class="stringliteral">          }</span>
<a name="l15140"></a>15140 <span class="stringliteral">          $this-&gt;Circle(($this-&gt;x + $r), ($this-&gt;y + ($this-&gt;lasth / 2)), $r, 0, 360, $fill, array(&#39;</span>color<span class="stringliteral">&#39;=&gt;$color), $color, 8);</span>
<a name="l15141"></a>15141 <span class="stringliteral">          break;</span>
<a name="l15142"></a>15142 <span class="stringliteral">        }</span>
<a name="l15143"></a>15143 <span class="stringliteral">        case &#39;</span>square<span class="stringliteral">&#39;: {</span>
<a name="l15144"></a>15144 <span class="stringliteral">          $l = $size / 3;</span>
<a name="l15145"></a>15145 <span class="stringliteral">          $lspace += $l;</span>
<a name="l15146"></a>15146 <span class="stringliteral">          if ($this-&gt;rtl) {</span>
<a name="l15147"></a>15147 <span class="stringliteral">            $this-&gt;x = $this-&gt;w - $this-&gt;x - $lspace;</span>
<a name="l15148"></a>15148 <span class="stringliteral">          } else {</span>
<a name="l15149"></a>15149 <span class="stringliteral">            $this-&gt;x -= $lspace;</span>
<a name="l15150"></a>15150 <span class="stringliteral">          }</span>
<a name="l15151"></a>15151 <span class="stringliteral">          $this-&gt;Rect($this-&gt;x, ($this-&gt;y + (($this-&gt;lasth - $l)/ 2)), $l, $l, &#39;</span>F<span class="stringliteral">&#39;, array(), $color);</span>
<a name="l15152"></a>15152 <span class="stringliteral">          break;</span>
<a name="l15153"></a>15153 <span class="stringliteral">        }</span>
<a name="l15154"></a>15154 <span class="stringliteral">        // ordered types</span>
<a name="l15155"></a>15155 <span class="stringliteral"></span>
<a name="l15156"></a>15156 <span class="stringliteral">        // $this-&gt;listcount[$this-&gt;listnum];</span>
<a name="l15157"></a>15157 <span class="stringliteral">        // $textitem</span>
<a name="l15158"></a>15158 <span class="stringliteral">        case &#39;</span>1<span class="stringliteral">&#39;:</span>
<a name="l15159"></a>15159 <span class="stringliteral">        case &#39;</span>decimal<span class="stringliteral">&#39;: {</span>
<a name="l15160"></a>15160 <span class="stringliteral">          $textitem = $this-&gt;listcount[$this-&gt;listnum];</span>
<a name="l15161"></a>15161 <span class="stringliteral">          break;</span>
<a name="l15162"></a>15162 <span class="stringliteral">        }</span>
<a name="l15163"></a>15163 <span class="stringliteral">        case &#39;</span>decimal-leading-zero<span class="stringliteral">&#39;: {</span>
<a name="l15164"></a>15164 <span class="stringliteral">          $textitem = sprintf(&quot;%02d&quot;, $this-&gt;listcount[$this-&gt;listnum]);</span>
<a name="l15165"></a>15165 <span class="stringliteral">          break;</span>
<a name="l15166"></a>15166 <span class="stringliteral">        }</span>
<a name="l15167"></a>15167 <span class="stringliteral">        case &#39;</span>i<span class="stringliteral">&#39;:</span>
<a name="l15168"></a>15168 <span class="stringliteral">        case &#39;</span>lower-roman<span class="stringliteral">&#39;: {</span>
<a name="l15169"></a>15169 <span class="stringliteral">          $textitem = strtolower($this-&gt;intToRoman($this-&gt;listcount[$this-&gt;listnum]));</span>
<a name="l15170"></a>15170 <span class="stringliteral">          break;</span>
<a name="l15171"></a>15171 <span class="stringliteral">        }</span>
<a name="l15172"></a>15172 <span class="stringliteral">        case &#39;</span>I<span class="stringliteral">&#39;:</span>
<a name="l15173"></a>15173 <span class="stringliteral">        case &#39;</span>upper-roman<span class="stringliteral">&#39;: {</span>
<a name="l15174"></a>15174 <span class="stringliteral">          $textitem = $this-&gt;intToRoman($this-&gt;listcount[$this-&gt;listnum]);</span>
<a name="l15175"></a>15175 <span class="stringliteral">          break;</span>
<a name="l15176"></a>15176 <span class="stringliteral">        }</span>
<a name="l15177"></a>15177 <span class="stringliteral">        case &#39;</span>a<span class="stringliteral">&#39;:</span>
<a name="l15178"></a>15178 <span class="stringliteral">        case &#39;</span>lower-alpha<span class="stringliteral">&#39;:</span>
<a name="l15179"></a>15179 <span class="stringliteral">        case &#39;</span>lower-latin<span class="stringliteral">&#39;: {</span>
<a name="l15180"></a>15180 <span class="stringliteral">          $textitem = chr(97 + $this-&gt;listcount[$this-&gt;listnum] - 1);</span>
<a name="l15181"></a>15181 <span class="stringliteral">          break;</span>
<a name="l15182"></a>15182 <span class="stringliteral">        }</span>
<a name="l15183"></a>15183 <span class="stringliteral">        case &#39;</span>A<span class="stringliteral">&#39;:</span>
<a name="l15184"></a>15184 <span class="stringliteral">        case &#39;</span>upper-alpha<span class="stringliteral">&#39;:</span>
<a name="l15185"></a>15185 <span class="stringliteral">        case &#39;</span>upper-latin<span class="stringliteral">&#39;: {</span>
<a name="l15186"></a>15186 <span class="stringliteral">          $textitem = chr(65 + $this-&gt;listcount[$this-&gt;listnum] - 1);</span>
<a name="l15187"></a>15187 <span class="stringliteral">          break;</span>
<a name="l15188"></a>15188 <span class="stringliteral">        }</span>
<a name="l15189"></a>15189 <span class="stringliteral">        case &#39;</span>lower-greek<span class="stringliteral">&#39;: {</span>
<a name="l15190"></a>15190 <span class="stringliteral">          $textitem = $this-&gt;unichr(945 + $this-&gt;listcount[$this-&gt;listnum] - 1);</span>
<a name="l15191"></a>15191 <span class="stringliteral">          break;</span>
<a name="l15192"></a>15192 <span class="stringliteral">        }</span>
<a name="l15193"></a>15193 <span class="stringliteral">        /*</span>
<a name="l15194"></a>15194 <span class="stringliteral">        // Types to be implemented (special handling)</span>
<a name="l15195"></a>15195 <span class="stringliteral">        case &#39;</span>hebrew<span class="stringliteral">&#39;: {</span>
<a name="l15196"></a>15196 <span class="stringliteral">          break;</span>
<a name="l15197"></a>15197 <span class="stringliteral">        }</span>
<a name="l15198"></a>15198 <span class="stringliteral">        case &#39;</span>armenian<span class="stringliteral">&#39;: {</span>
<a name="l15199"></a>15199 <span class="stringliteral">          break;</span>
<a name="l15200"></a>15200 <span class="stringliteral">        }</span>
<a name="l15201"></a>15201 <span class="stringliteral">        case &#39;</span>georgian<span class="stringliteral">&#39;: {</span>
<a name="l15202"></a>15202 <span class="stringliteral">          break;</span>
<a name="l15203"></a>15203 <span class="stringliteral">        }</span>
<a name="l15204"></a>15204 <span class="stringliteral">        case &#39;</span>cjk-ideographic<span class="stringliteral">&#39;: {</span>
<a name="l15205"></a>15205 <span class="stringliteral">          break;</span>
<a name="l15206"></a>15206 <span class="stringliteral">        }</span>
<a name="l15207"></a>15207 <span class="stringliteral">        case &#39;</span>hiragana<span class="stringliteral">&#39;: {</span>
<a name="l15208"></a>15208 <span class="stringliteral">          break;</span>
<a name="l15209"></a>15209 <span class="stringliteral">        }</span>
<a name="l15210"></a>15210 <span class="stringliteral">        case &#39;</span>katakana<span class="stringliteral">&#39;: {</span>
<a name="l15211"></a>15211 <span class="stringliteral">          break;</span>
<a name="l15212"></a>15212 <span class="stringliteral">        }</span>
<a name="l15213"></a>15213 <span class="stringliteral">        case &#39;</span>hiragana-iroha<span class="stringliteral">&#39;: {</span>
<a name="l15214"></a>15214 <span class="stringliteral">          break;</span>
<a name="l15215"></a>15215 <span class="stringliteral">        }</span>
<a name="l15216"></a>15216 <span class="stringliteral">        case &#39;</span>katakana-iroha<span class="stringliteral">&#39;: {</span>
<a name="l15217"></a>15217 <span class="stringliteral">          break;</span>
<a name="l15218"></a>15218 <span class="stringliteral">        }</span>
<a name="l15219"></a>15219 <span class="stringliteral">        */</span>
<a name="l15220"></a>15220 <span class="stringliteral">        default: {</span>
<a name="l15221"></a>15221 <span class="stringliteral">          $textitem = $this-&gt;listcount[$this-&gt;listnum];</span>
<a name="l15222"></a>15222 <span class="stringliteral">        }</span>
<a name="l15223"></a>15223 <span class="stringliteral">      }</span>
<a name="l15224"></a>15224 <span class="stringliteral">      if (!$this-&gt;empty_string($textitem)) {</span>
<a name="l15225"></a>15225 <span class="stringliteral">        // print ordered item</span>
<a name="l15226"></a>15226 <span class="stringliteral">        if ($this-&gt;rtl) {</span>
<a name="l15227"></a>15227 <span class="stringliteral">          $textitem = &#39;</span>.<span class="stringliteral">&#39;.$textitem;</span>
<a name="l15228"></a>15228 <span class="stringliteral">        } else {</span>
<a name="l15229"></a>15229 <span class="stringliteral">          $textitem = $textitem.&#39;</span>.<span class="stringliteral">&#39;;</span>
<a name="l15230"></a>15230 <span class="stringliteral">        }</span>
<a name="l15231"></a>15231 <span class="stringliteral">        $lspace += $this-&gt;GetStringWidth($textitem);</span>
<a name="l15232"></a>15232 <span class="stringliteral">        if ($this-&gt;rtl) {</span>
<a name="l15233"></a>15233 <span class="stringliteral">          $this-&gt;x += $lspace;</span>
<a name="l15234"></a>15234 <span class="stringliteral">        } else {</span>
<a name="l15235"></a>15235 <span class="stringliteral">          $this-&gt;x -= $lspace;</span>
<a name="l15236"></a>15236 <span class="stringliteral">        }</span>
<a name="l15237"></a>15237 <span class="stringliteral">        $this-&gt;Write($this-&gt;lasth, $textitem, &#39;</span><span class="stringliteral">&#39;, false, &#39;</span><span class="stringliteral">&#39;, false, 0, false);</span>
<a name="l15238"></a>15238 <span class="stringliteral">      }</span>
<a name="l15239"></a>15239 <span class="stringliteral">      $this-&gt;x = $tmpx;</span>
<a name="l15240"></a>15240 <span class="stringliteral">      $this-&gt;lispacer = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l15241"></a>15241 <span class="stringliteral">    }</span>
<a name="l15242"></a>15242 <span class="stringliteral"></span>
<a name="l15249"></a>15249 <span class="stringliteral">    protected function getGraphicVars() {</span>
<a name="l15250"></a>15250 <span class="stringliteral">      $grapvars = array(</span>
<a name="l15251"></a>15251 <span class="stringliteral">        &#39;</span>FontFamily<span class="stringliteral">&#39; =&gt; $this-&gt;FontFamily,</span>
<a name="l15252"></a>15252 <span class="stringliteral">        &#39;</span>FontStyle<span class="stringliteral">&#39; =&gt; $this-&gt;FontStyle,</span>
<a name="l15253"></a>15253 <span class="stringliteral">        &#39;</span>FontSizePt<span class="stringliteral">&#39; =&gt; $this-&gt;FontSizePt,</span>
<a name="l15254"></a>15254 <span class="stringliteral">        &#39;</span>rMargin<span class="stringliteral">&#39; =&gt; $this-&gt;rMargin,</span>
<a name="l15255"></a>15255 <span class="stringliteral">        &#39;</span>lMargin<span class="stringliteral">&#39; =&gt; $this-&gt;lMargin,</span>
<a name="l15256"></a>15256 <span class="stringliteral">        &#39;</span>cMargin<span class="stringliteral">&#39; =&gt; $this-&gt;cMargin,</span>
<a name="l15257"></a>15257 <span class="stringliteral">        &#39;</span>LineWidth<span class="stringliteral">&#39; =&gt; $this-&gt;LineWidth,</span>
<a name="l15258"></a>15258 <span class="stringliteral">        &#39;</span>linestyleWidth<span class="stringliteral">&#39; =&gt; $this-&gt;linestyleWidth,</span>
<a name="l15259"></a>15259 <span class="stringliteral">        &#39;</span>linestyleCap<span class="stringliteral">&#39; =&gt; $this-&gt;linestyleCap,</span>
<a name="l15260"></a>15260 <span class="stringliteral">        &#39;</span>linestyleJoin<span class="stringliteral">&#39; =&gt; $this-&gt;linestyleJoin,</span>
<a name="l15261"></a>15261 <span class="stringliteral">        &#39;</span>linestyleDash<span class="stringliteral">&#39; =&gt; $this-&gt;linestyleDash,</span>
<a name="l15262"></a>15262 <span class="stringliteral">        &#39;</span>DrawColor<span class="stringliteral">&#39; =&gt; $this-&gt;DrawColor,</span>
<a name="l15263"></a>15263 <span class="stringliteral">        &#39;</span>FillColor<span class="stringliteral">&#39; =&gt; $this-&gt;FillColor,</span>
<a name="l15264"></a>15264 <span class="stringliteral">        &#39;</span>TextColor<span class="stringliteral">&#39; =&gt; $this-&gt;TextColor,</span>
<a name="l15265"></a>15265 <span class="stringliteral">        &#39;</span>ColorFlag<span class="stringliteral">&#39; =&gt; $this-&gt;ColorFlag,</span>
<a name="l15266"></a>15266 <span class="stringliteral">        &#39;</span>bgcolor<span class="stringliteral">&#39; =&gt; $this-&gt;bgcolor,</span>
<a name="l15267"></a>15267 <span class="stringliteral">        &#39;</span>fgcolor<span class="stringliteral">&#39; =&gt; $this-&gt;fgcolor,</span>
<a name="l15268"></a>15268 <span class="stringliteral">        &#39;</span>htmlvspace<span class="stringliteral">&#39; =&gt; $this-&gt;htmlvspace,</span>
<a name="l15269"></a>15269 <span class="stringliteral">        &#39;</span>lasth<span class="stringliteral">&#39; =&gt; $this-&gt;lasth</span>
<a name="l15270"></a>15270 <span class="stringliteral">        );</span>
<a name="l15271"></a>15271 <span class="stringliteral">      return $grapvars;</span>
<a name="l15272"></a>15272 <span class="stringliteral">    }</span>
<a name="l15273"></a>15273 <span class="stringliteral"></span>
<a name="l15280"></a>15280 <span class="stringliteral">    protected function setGraphicVars($gvars) {</span>
<a name="l15281"></a>15281 <span class="stringliteral">      $this-&gt;FontFamily = $gvars[&#39;</span>FontFamily<span class="stringliteral">&#39;];</span>
<a name="l15282"></a>15282 <span class="stringliteral">      $this-&gt;FontStyle = $gvars[&#39;</span>FontStyle<span class="stringliteral">&#39;];</span>
<a name="l15283"></a>15283 <span class="stringliteral">      $this-&gt;FontSizePt = $gvars[&#39;</span>FontSizePt<span class="stringliteral">&#39;];</span>
<a name="l15284"></a>15284 <span class="stringliteral">      $this-&gt;rMargin = $gvars[&#39;</span>rMargin<span class="stringliteral">&#39;];</span>
<a name="l15285"></a>15285 <span class="stringliteral">      $this-&gt;lMargin = $gvars[&#39;</span>lMargin<span class="stringliteral">&#39;];</span>
<a name="l15286"></a>15286 <span class="stringliteral">      $this-&gt;cMargin = $gvars[&#39;</span>cMargin<span class="stringliteral">&#39;];</span>
<a name="l15287"></a>15287 <span class="stringliteral">      $this-&gt;LineWidth = $gvars[&#39;</span>LineWidth<span class="stringliteral">&#39;];</span>
<a name="l15288"></a>15288 <span class="stringliteral">      $this-&gt;linestyleWidth = $gvars[&#39;</span>linestyleWidth<span class="stringliteral">&#39;];</span>
<a name="l15289"></a>15289 <span class="stringliteral">      $this-&gt;linestyleCap = $gvars[&#39;</span>linestyleCap<span class="stringliteral">&#39;];</span>
<a name="l15290"></a>15290 <span class="stringliteral">      $this-&gt;linestyleJoin = $gvars[&#39;</span>linestyleJoin<span class="stringliteral">&#39;];</span>
<a name="l15291"></a>15291 <span class="stringliteral">      $this-&gt;linestyleDash = $gvars[&#39;</span>linestyleDash<span class="stringliteral">&#39;];</span>
<a name="l15292"></a>15292 <span class="stringliteral">      $this-&gt;DrawColor = $gvars[&#39;</span>DrawColor<span class="stringliteral">&#39;];</span>
<a name="l15293"></a>15293 <span class="stringliteral">      $this-&gt;FillColor = $gvars[&#39;</span>FillColor<span class="stringliteral">&#39;];</span>
<a name="l15294"></a>15294 <span class="stringliteral">      $this-&gt;TextColor = $gvars[&#39;</span>TextColor<span class="stringliteral">&#39;];</span>
<a name="l15295"></a>15295 <span class="stringliteral">      $this-&gt;ColorFlag = $gvars[&#39;</span>ColorFlag<span class="stringliteral">&#39;];</span>
<a name="l15296"></a>15296 <span class="stringliteral">      $this-&gt;bgcolor = $gvars[&#39;</span>bgcolor<span class="stringliteral">&#39;];</span>
<a name="l15297"></a>15297 <span class="stringliteral">      $this-&gt;fgcolor = $gvars[&#39;</span>fgcolor<span class="stringliteral">&#39;];</span>
<a name="l15298"></a>15298 <span class="stringliteral">      $this-&gt;htmlvspace = $gvars[&#39;</span>htmlvspace<span class="stringliteral">&#39;];</span>
<a name="l15299"></a>15299 <span class="stringliteral">      //$this-&gt;lasth = $gvars[&#39;</span>lasth<span class="stringliteral">&#39;];</span>
<a name="l15300"></a>15300 <span class="stringliteral">      $this-&gt;_out(&#39;</span><span class="stringliteral">&#39;.$this-&gt;linestyleWidth.&#39;</span> <span class="stringliteral">&#39;.$this-&gt;linestyleCap.&#39;</span> <span class="stringliteral">&#39;.$this-&gt;linestyleJoin.&#39;</span> <span class="stringliteral">&#39;.$this-&gt;linestyleDash.&#39;</span> <span class="stringliteral">&#39;.$this-&gt;DrawColor.&#39;</span> <span class="stringliteral">&#39;.$this-&gt;FillColor.&#39;</span><span class="stringliteral">&#39;);</span>
<a name="l15301"></a>15301 <span class="stringliteral">      if (!$this-&gt;empty_string($this-&gt;FontFamily)) {</span>
<a name="l15302"></a>15302 <span class="stringliteral">        $this-&gt;SetFont($this-&gt;FontFamily, $this-&gt;FontStyle, $this-&gt;FontSizePt);</span>
<a name="l15303"></a>15303 <span class="stringliteral">      }</span>
<a name="l15304"></a>15304 <span class="stringliteral">    }</span>
<a name="l15305"></a>15305 <span class="stringliteral"></span>
<a name="l15313"></a>15313 <span class="stringliteral">    protected function getObjFilename($name) {</span>
<a name="l15314"></a>15314 <span class="stringliteral">      return tempnam(K_PATH_CACHE, $name.&#39;</span>_<span class="stringliteral">&#39;);</span>
<a name="l15315"></a>15315 <span class="stringliteral">    }</span>
<a name="l15316"></a>15316 <span class="stringliteral"></span>
<a name="l15325"></a>15325 <span class="stringliteral">    protected function writeDiskCache($filename, $data, $append=false) {</span>
<a name="l15326"></a>15326 <span class="stringliteral">      if ($append) {</span>
<a name="l15327"></a>15327 <span class="stringliteral">        $fmode = &#39;</span>ab+<span class="stringliteral">&#39;;</span>
<a name="l15328"></a>15328 <span class="stringliteral">      } else {</span>
<a name="l15329"></a>15329 <span class="stringliteral">        $fmode = &#39;</span>wb+<span class="stringliteral">&#39;;</span>
<a name="l15330"></a>15330 <span class="stringliteral">      }</span>
<a name="l15331"></a>15331 <span class="stringliteral">      $f = @fopen($filename, $fmode);</span>
<a name="l15332"></a>15332 <span class="stringliteral">      if (!$f) {</span>
<a name="l15333"></a>15333 <span class="stringliteral">        $this-&gt;Error(&#39;</span>Unable to write <a class="code" href="classcache.html">cache</a> file: <span class="stringliteral">&#39;.$filename);</span>
<a name="l15334"></a>15334 <span class="stringliteral">      } else {</span>
<a name="l15335"></a>15335 <span class="stringliteral">        fwrite($f, $data);</span>
<a name="l15336"></a>15336 <span class="stringliteral">        fclose($f);</span>
<a name="l15337"></a>15337 <span class="stringliteral">      }</span>
<a name="l15338"></a>15338 <span class="stringliteral">      // update file lenght (needed for transactions)</span>
<a name="l15339"></a>15339 <span class="stringliteral">      if (!isset($this-&gt;cache_file_lenght[&#39;</span>_<span class="stringliteral">&#39;.$filename])) {</span>
<a name="l15340"></a>15340 <span class="stringliteral">        $this-&gt;cache_file_lenght[&#39;</span>_<span class="stringliteral">&#39;.$filename] = strlen($data);</span>
<a name="l15341"></a>15341 <span class="stringliteral">      } else {</span>
<a name="l15342"></a>15342 <span class="stringliteral">        $this-&gt;cache_file_lenght[&#39;</span>_<span class="stringliteral">&#39;.$filename] += strlen($data);</span>
<a name="l15343"></a>15343 <span class="stringliteral">      }</span>
<a name="l15344"></a>15344 <span class="stringliteral">    }</span>
<a name="l15345"></a>15345 <span class="stringliteral"></span>
<a name="l15353"></a>15353 <span class="stringliteral">    protected function readDiskCache($filename) {</span>
<a name="l15354"></a>15354 <span class="stringliteral">      return file_get_contents($filename);</span>
<a name="l15355"></a>15355 <span class="stringliteral">    }</span>
<a name="l15356"></a>15356 <span class="stringliteral"></span>
<a name="l15363"></a>15363 <span class="stringliteral">    protected function setBuffer($data) {</span>
<a name="l15364"></a>15364 <span class="stringliteral">      $this-&gt;bufferlen += strlen($data);</span>
<a name="l15365"></a>15365 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15366"></a>15366 <span class="stringliteral">        if (!isset($this-&gt;buffer) OR $this-&gt;empty_string($this-&gt;buffer)) {</span>
<a name="l15367"></a>15367 <span class="stringliteral">          $this-&gt;buffer = $this-&gt;getObjFilename(&#39;</span>buffer<span class="stringliteral">&#39;);</span>
<a name="l15368"></a>15368 <span class="stringliteral">        }</span>
<a name="l15369"></a>15369 <span class="stringliteral">        $this-&gt;writeDiskCache($this-&gt;buffer, $data, true);</span>
<a name="l15370"></a>15370 <span class="stringliteral">      } else {</span>
<a name="l15371"></a>15371 <span class="stringliteral">        $this-&gt;buffer .= $data;</span>
<a name="l15372"></a>15372 <span class="stringliteral">      }</span>
<a name="l15373"></a>15373 <span class="stringliteral">    }</span>
<a name="l15374"></a>15374 <span class="stringliteral"></span>
<a name="l15381"></a>15381 <span class="stringliteral">    protected function getBuffer() {</span>
<a name="l15382"></a>15382 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15383"></a>15383 <span class="stringliteral">        return $this-&gt;readDiskCache($this-&gt;buffer);</span>
<a name="l15384"></a>15384 <span class="stringliteral">      } else {</span>
<a name="l15385"></a>15385 <span class="stringliteral">        return $this-&gt;buffer;</span>
<a name="l15386"></a>15386 <span class="stringliteral">      }</span>
<a name="l15387"></a>15387 <span class="stringliteral">    }</span>
<a name="l15388"></a>15388 <span class="stringliteral"></span>
<a name="l15397"></a>15397 <span class="stringliteral">    protected function setPageBuffer($page, $data, $append=false) {</span>
<a name="l15398"></a>15398 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15399"></a>15399 <span class="stringliteral">        if (!isset($this-&gt;pages[$page])) {</span>
<a name="l15400"></a>15400 <span class="stringliteral">          $this-&gt;pages[$page] = $this-&gt;getObjFilename(&#39;</span>page<span class="stringliteral">&#39;.$page);</span>
<a name="l15401"></a>15401 <span class="stringliteral">        }</span>
<a name="l15402"></a>15402 <span class="stringliteral">        $this-&gt;writeDiskCache($this-&gt;pages[$page], $data, $append);</span>
<a name="l15403"></a>15403 <span class="stringliteral">      } else {</span>
<a name="l15404"></a>15404 <span class="stringliteral">        if ($append) {</span>
<a name="l15405"></a>15405 <span class="stringliteral">          $this-&gt;pages[$page] .= $data;</span>
<a name="l15406"></a>15406 <span class="stringliteral">        } else {</span>
<a name="l15407"></a>15407 <span class="stringliteral">          $this-&gt;pages[$page] = $data;</span>
<a name="l15408"></a>15408 <span class="stringliteral">        }</span>
<a name="l15409"></a>15409 <span class="stringliteral">      }</span>
<a name="l15410"></a>15410 <span class="stringliteral">      if ($append AND isset($this-&gt;pagelen[$page])) {</span>
<a name="l15411"></a>15411 <span class="stringliteral">        $this-&gt;pagelen[$page] += strlen($data);</span>
<a name="l15412"></a>15412 <span class="stringliteral">      } else {</span>
<a name="l15413"></a>15413 <span class="stringliteral">        $this-&gt;pagelen[$page] = strlen($data);</span>
<a name="l15414"></a>15414 <span class="stringliteral">      }</span>
<a name="l15415"></a>15415 <span class="stringliteral">    }</span>
<a name="l15416"></a>15416 <span class="stringliteral"></span>
<a name="l15424"></a>15424 <span class="stringliteral">    protected function getPageBuffer($page) {</span>
<a name="l15425"></a>15425 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15426"></a>15426 <span class="stringliteral">        return $this-&gt;readDiskCache($this-&gt;pages[$page]);</span>
<a name="l15427"></a>15427 <span class="stringliteral">      } elseif (isset($this-&gt;pages[$page])) {</span>
<a name="l15428"></a>15428 <span class="stringliteral">        return $this-&gt;pages[$page];</span>
<a name="l15429"></a>15429 <span class="stringliteral">      }</span>
<a name="l15430"></a>15430 <span class="stringliteral">      return false;</span>
<a name="l15431"></a>15431 <span class="stringliteral">    }</span>
<a name="l15432"></a>15432 <span class="stringliteral"></span>
<a name="l15440"></a>15440 <span class="stringliteral">    protected function setImageBuffer($image, $data) {</span>
<a name="l15441"></a>15441 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15442"></a>15442 <span class="stringliteral">        if (!isset($this-&gt;images[$image])) {</span>
<a name="l15443"></a>15443 <span class="stringliteral">          $this-&gt;images[$image] = $this-&gt;getObjFilename(&#39;</span>image<span class="stringliteral">&#39;.$image);</span>
<a name="l15444"></a>15444 <span class="stringliteral">        }</span>
<a name="l15445"></a>15445 <span class="stringliteral">        $this-&gt;writeDiskCache($this-&gt;images[$image], serialize($data));</span>
<a name="l15446"></a>15446 <span class="stringliteral">      } else {</span>
<a name="l15447"></a>15447 <span class="stringliteral">        $this-&gt;images[$image] = $data;</span>
<a name="l15448"></a>15448 <span class="stringliteral">      }</span>
<a name="l15449"></a>15449 <span class="stringliteral">      if (!in_array($image, $this-&gt;imagekeys)) {</span>
<a name="l15450"></a>15450 <span class="stringliteral">        $this-&gt;imagekeys[] = $image;</span>
<a name="l15451"></a>15451 <span class="stringliteral">      }</span>
<a name="l15452"></a>15452 <span class="stringliteral">      ++$this-&gt;numimages;</span>
<a name="l15453"></a>15453 <span class="stringliteral">    }</span>
<a name="l15454"></a>15454 <span class="stringliteral"></span>
<a name="l15463"></a>15463 <span class="stringliteral">    protected function setImageSubBuffer($image, $key, $data) {</span>
<a name="l15464"></a>15464 <span class="stringliteral">      if (!isset($this-&gt;images[$image])) {</span>
<a name="l15465"></a>15465 <span class="stringliteral">        $this-&gt;setImageBuffer($image, array());</span>
<a name="l15466"></a>15466 <span class="stringliteral">      }</span>
<a name="l15467"></a>15467 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15468"></a>15468 <span class="stringliteral">        $tmpimg = $this-&gt;getImageBuffer($image);</span>
<a name="l15469"></a>15469 <span class="stringliteral">        $tmpimg[$key] = $data;</span>
<a name="l15470"></a>15470 <span class="stringliteral">        $this-&gt;writeDiskCache($this-&gt;images[$image], serialize($tmpimg));</span>
<a name="l15471"></a>15471 <span class="stringliteral">      } else {</span>
<a name="l15472"></a>15472 <span class="stringliteral">        $this-&gt;images[$image][$key] = $data;</span>
<a name="l15473"></a>15473 <span class="stringliteral">      }</span>
<a name="l15474"></a>15474 <span class="stringliteral">    }</span>
<a name="l15475"></a>15475 <span class="stringliteral"></span>
<a name="l15483"></a>15483 <span class="stringliteral">    protected function getImageBuffer($image) {</span>
<a name="l15484"></a>15484 <span class="stringliteral">      if ($this-&gt;diskcache AND isset($this-&gt;images[$image])) {</span>
<a name="l15485"></a>15485 <span class="stringliteral">        return unserialize($this-&gt;readDiskCache($this-&gt;images[$image]));</span>
<a name="l15486"></a>15486 <span class="stringliteral">      } elseif (isset($this-&gt;images[$image])) {</span>
<a name="l15487"></a>15487 <span class="stringliteral">        return $this-&gt;images[$image];</span>
<a name="l15488"></a>15488 <span class="stringliteral">      }</span>
<a name="l15489"></a>15489 <span class="stringliteral">      return false;</span>
<a name="l15490"></a>15490 <span class="stringliteral">    }</span>
<a name="l15491"></a>15491 <span class="stringliteral"></span>
<a name="l15499"></a>15499 <span class="stringliteral">    protected function setFontBuffer($font, $data) {</span>
<a name="l15500"></a>15500 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15501"></a>15501 <span class="stringliteral">        if (!isset($this-&gt;fonts[$font])) {</span>
<a name="l15502"></a>15502 <span class="stringliteral">          $this-&gt;fonts[$font] = $this-&gt;getObjFilename(&#39;</span>font<span class="stringliteral">&#39;);</span>
<a name="l15503"></a>15503 <span class="stringliteral">        }</span>
<a name="l15504"></a>15504 <span class="stringliteral">        $this-&gt;writeDiskCache($this-&gt;fonts[$font], serialize($data));</span>
<a name="l15505"></a>15505 <span class="stringliteral">      } else {</span>
<a name="l15506"></a>15506 <span class="stringliteral">        $this-&gt;fonts[$font] = $data;</span>
<a name="l15507"></a>15507 <span class="stringliteral">      }</span>
<a name="l15508"></a>15508 <span class="stringliteral">      if (!in_array($font, $this-&gt;fontkeys)) {</span>
<a name="l15509"></a>15509 <span class="stringliteral">        $this-&gt;fontkeys[] = $font;</span>
<a name="l15510"></a>15510 <span class="stringliteral">      }</span>
<a name="l15511"></a>15511 <span class="stringliteral">    }</span>
<a name="l15512"></a>15512 <span class="stringliteral"></span>
<a name="l15521"></a>15521 <span class="stringliteral">    protected function setFontSubBuffer($font, $key, $data) {</span>
<a name="l15522"></a>15522 <span class="stringliteral">      if (!isset($this-&gt;fonts[$font])) {</span>
<a name="l15523"></a>15523 <span class="stringliteral">        $this-&gt;setFontBuffer($font, array());</span>
<a name="l15524"></a>15524 <span class="stringliteral">      }</span>
<a name="l15525"></a>15525 <span class="stringliteral">      if ($this-&gt;diskcache) {</span>
<a name="l15526"></a>15526 <span class="stringliteral">        $tmpfont = $this-&gt;getFontBuffer($font);</span>
<a name="l15527"></a>15527 <span class="stringliteral">        $tmpfont[$key] = $data;</span>
<a name="l15528"></a>15528 <span class="stringliteral">        $this-&gt;writeDiskCache($this-&gt;fonts[$font], serialize($tmpfont));</span>
<a name="l15529"></a>15529 <span class="stringliteral">      } else {</span>
<a name="l15530"></a>15530 <span class="stringliteral">        $this-&gt;fonts[$font][$key] = $data;</span>
<a name="l15531"></a>15531 <span class="stringliteral">      }</span>
<a name="l15532"></a>15532 <span class="stringliteral">    }</span>
<a name="l15533"></a>15533 <span class="stringliteral"></span>
<a name="l15541"></a>15541 <span class="stringliteral">    protected function getFontBuffer($font) {</span>
<a name="l15542"></a>15542 <span class="stringliteral">      if ($this-&gt;diskcache AND isset($this-&gt;fonts[$font])) {</span>
<a name="l15543"></a>15543 <span class="stringliteral">        return unserialize($this-&gt;readDiskCache($this-&gt;fonts[$font]));</span>
<a name="l15544"></a>15544 <span class="stringliteral">      } elseif (isset($this-&gt;fonts[$font])) {</span>
<a name="l15545"></a>15545 <span class="stringliteral">        return $this-&gt;fonts[$font];</span>
<a name="l15546"></a>15546 <span class="stringliteral">      }</span>
<a name="l15547"></a>15547 <span class="stringliteral">      return false;</span>
<a name="l15548"></a>15548 <span class="stringliteral">    }</span>
<a name="l15549"></a>15549 <span class="stringliteral"></span>
<a name="l15558"></a>15558 <span class="stringliteral">    public function movePage($frompage, $topage) {</span>
<a name="l15559"></a>15559 <span class="stringliteral">      if (($frompage &gt; $this-&gt;numpages) OR ($frompage &lt;= $topage)) {</span>
<a name="l15560"></a>15560 <span class="stringliteral">        return false;</span>
<a name="l15561"></a>15561 <span class="stringliteral">      }</span>
<a name="l15562"></a>15562 <span class="stringliteral">      if ($frompage == $this-&gt;page) {</span>
<a name="l15563"></a>15563 <span class="stringliteral">        // close the page before moving it</span>
<a name="l15564"></a>15564 <span class="stringliteral">        $this-&gt;endPage();</span>
<a name="l15565"></a>15565 <span class="stringliteral">      }</span>
<a name="l15566"></a>15566 <span class="stringliteral">      // move all page-related states</span>
<a name="l15567"></a>15567 <span class="stringliteral">      $tmppage = $this-&gt;pages[$frompage];</span>
<a name="l15568"></a>15568 <span class="stringliteral">      $tmppagedim = $this-&gt;pagedim[$frompage];</span>
<a name="l15569"></a>15569 <span class="stringliteral">      $tmppagelen = $this-&gt;pagelen[$frompage];</span>
<a name="l15570"></a>15570 <span class="stringliteral">      $tmpintmrk = $this-&gt;intmrk[$frompage];</span>
<a name="l15571"></a>15571 <span class="stringliteral">      if (isset($this-&gt;footerpos[$frompage])) {</span>
<a name="l15572"></a>15572 <span class="stringliteral">        $tmpfooterpos = $this-&gt;footerpos[$frompage];</span>
<a name="l15573"></a>15573 <span class="stringliteral">      }</span>
<a name="l15574"></a>15574 <span class="stringliteral">      if (isset($this-&gt;footerlen[$frompage])) {</span>
<a name="l15575"></a>15575 <span class="stringliteral">        $tmpfooterlen = $this-&gt;footerlen[$frompage];</span>
<a name="l15576"></a>15576 <span class="stringliteral">      }</span>
<a name="l15577"></a>15577 <span class="stringliteral">      if (isset($this-&gt;transfmrk[$frompage])) {</span>
<a name="l15578"></a>15578 <span class="stringliteral">        $tmptransfmrk = $this-&gt;transfmrk[$frompage];</span>
<a name="l15579"></a>15579 <span class="stringliteral">      }</span>
<a name="l15580"></a>15580 <span class="stringliteral">      if (isset($this-&gt;PageAnnots[$frompage])) {</span>
<a name="l15581"></a>15581 <span class="stringliteral">        $tmpannots = $this-&gt;PageAnnots[$frompage];</span>
<a name="l15582"></a>15582 <span class="stringliteral">      }</span>
<a name="l15583"></a>15583 <span class="stringliteral">      if (isset($this-&gt;newpagegroup[$frompage])) {</span>
<a name="l15584"></a>15584 <span class="stringliteral">        $tmpnewpagegroup = $this-&gt;newpagegroup[$frompage];</span>
<a name="l15585"></a>15585 <span class="stringliteral">      }</span>
<a name="l15586"></a>15586 <span class="stringliteral">      for ($i = $frompage; $i &gt; $topage; --$i) {</span>
<a name="l15587"></a>15587 <span class="stringliteral">        $j = $i - 1;</span>
<a name="l15588"></a>15588 <span class="stringliteral">        // shift pages down</span>
<a name="l15589"></a>15589 <span class="stringliteral">        $this-&gt;pages[$i] = $this-&gt;pages[$j];</span>
<a name="l15590"></a>15590 <span class="stringliteral">        $this-&gt;pagedim[$i] = $this-&gt;pagedim[$j];</span>
<a name="l15591"></a>15591 <span class="stringliteral">        $this-&gt;pagelen[$i] = $this-&gt;pagelen[$j];</span>
<a name="l15592"></a>15592 <span class="stringliteral">        $this-&gt;intmrk[$i] = $this-&gt;intmrk[$j];</span>
<a name="l15593"></a>15593 <span class="stringliteral">        if (isset($this-&gt;footerpos[$j])) {</span>
<a name="l15594"></a>15594 <span class="stringliteral">          $this-&gt;footerpos[$i] = $this-&gt;footerpos[$j];</span>
<a name="l15595"></a>15595 <span class="stringliteral">        } elseif (isset($this-&gt;footerpos[$i])) {</span>
<a name="l15596"></a>15596 <span class="stringliteral">          unset($this-&gt;footerpos[$i]);</span>
<a name="l15597"></a>15597 <span class="stringliteral">        }</span>
<a name="l15598"></a>15598 <span class="stringliteral">        if (isset($this-&gt;footerlen[$j])) {</span>
<a name="l15599"></a>15599 <span class="stringliteral">          $this-&gt;footerlen[$i] = $this-&gt;footerlen[$j];</span>
<a name="l15600"></a>15600 <span class="stringliteral">        } elseif (isset($this-&gt;footerlen[$i])) {</span>
<a name="l15601"></a>15601 <span class="stringliteral">          unset($this-&gt;footerlen[$i]);</span>
<a name="l15602"></a>15602 <span class="stringliteral">        }</span>
<a name="l15603"></a>15603 <span class="stringliteral">        if (isset($this-&gt;transfmrk[$j])) {</span>
<a name="l15604"></a>15604 <span class="stringliteral">          $this-&gt;transfmrk[$i] = $this-&gt;transfmrk[$j];</span>
<a name="l15605"></a>15605 <span class="stringliteral">        } elseif (isset($this-&gt;transfmrk[$i])) {</span>
<a name="l15606"></a>15606 <span class="stringliteral">          unset($this-&gt;transfmrk[$i]);</span>
<a name="l15607"></a>15607 <span class="stringliteral">        }</span>
<a name="l15608"></a>15608 <span class="stringliteral">        if (isset($this-&gt;PageAnnots[$j])) {</span>
<a name="l15609"></a>15609 <span class="stringliteral">          $this-&gt;PageAnnots[$i] = $this-&gt;PageAnnots[$j];</span>
<a name="l15610"></a>15610 <span class="stringliteral">        } elseif (isset($this-&gt;PageAnnots[$i])) {</span>
<a name="l15611"></a>15611 <span class="stringliteral">          unset($this-&gt;PageAnnots[$i]);</span>
<a name="l15612"></a>15612 <span class="stringliteral">        }</span>
<a name="l15613"></a>15613 <span class="stringliteral">        if (isset($this-&gt;newpagegroup[$j])) {</span>
<a name="l15614"></a>15614 <span class="stringliteral">          $this-&gt;newpagegroup[$i] = $this-&gt;newpagegroup[$j];</span>
<a name="l15615"></a>15615 <span class="stringliteral">        } elseif (isset($this-&gt;newpagegroup[$i])) {</span>
<a name="l15616"></a>15616 <span class="stringliteral">          unset($this-&gt;newpagegroup[$i]);</span>
<a name="l15617"></a>15617 <span class="stringliteral">        }</span>
<a name="l15618"></a>15618 <span class="stringliteral">      }</span>
<a name="l15619"></a>15619 <span class="stringliteral">      $this-&gt;pages[$topage] = $tmppage;</span>
<a name="l15620"></a>15620 <span class="stringliteral">      $this-&gt;pagedim[$topage] = $tmppagedim;</span>
<a name="l15621"></a>15621 <span class="stringliteral">      $this-&gt;pagelen[$topage] = $tmppagelen;</span>
<a name="l15622"></a>15622 <span class="stringliteral">      $this-&gt;intmrk[$topage] = $tmpintmrk;</span>
<a name="l15623"></a>15623 <span class="stringliteral">      if (isset($tmpfooterpos)) {</span>
<a name="l15624"></a>15624 <span class="stringliteral">        $this-&gt;footerpos[$topage] = $tmpfooterpos;</span>
<a name="l15625"></a>15625 <span class="stringliteral">      } elseif (isset($this-&gt;footerpos[$topage])) {</span>
<a name="l15626"></a>15626 <span class="stringliteral">        unset($this-&gt;footerpos[$topage]);</span>
<a name="l15627"></a>15627 <span class="stringliteral">      }</span>
<a name="l15628"></a>15628 <span class="stringliteral">      if (isset($tmpfooterlen)) {</span>
<a name="l15629"></a>15629 <span class="stringliteral">        $this-&gt;footerlen[$topage] = $tmpfooterlen;</span>
<a name="l15630"></a>15630 <span class="stringliteral">      } elseif (isset($this-&gt;footerlen[$topage])) {</span>
<a name="l15631"></a>15631 <span class="stringliteral">        unset($this-&gt;footerlen[$topage]);</span>
<a name="l15632"></a>15632 <span class="stringliteral">      }</span>
<a name="l15633"></a>15633 <span class="stringliteral">      if (isset($tmptransfmrk)) {</span>
<a name="l15634"></a>15634 <span class="stringliteral">        $this-&gt;transfmrk[$topage] = $tmptransfmrk;</span>
<a name="l15635"></a>15635 <span class="stringliteral">      } elseif (isset($this-&gt;transfmrk[$topage])) {</span>
<a name="l15636"></a>15636 <span class="stringliteral">        unset($this-&gt;transfmrk[$topage]);</span>
<a name="l15637"></a>15637 <span class="stringliteral">      }</span>
<a name="l15638"></a>15638 <span class="stringliteral">      if (isset($tmpannots)) {</span>
<a name="l15639"></a>15639 <span class="stringliteral">        $this-&gt;PageAnnots[$topage] = $tmpannots;</span>
<a name="l15640"></a>15640 <span class="stringliteral">      } elseif (isset($this-&gt;PageAnnots[$topage])) {</span>
<a name="l15641"></a>15641 <span class="stringliteral">        unset($this-&gt;PageAnnots[$topage]);</span>
<a name="l15642"></a>15642 <span class="stringliteral">      }</span>
<a name="l15643"></a>15643 <span class="stringliteral">      if (isset($tmpnewpagegroup)) {</span>
<a name="l15644"></a>15644 <span class="stringliteral">        $this-&gt;newpagegroup[$topage] = $tmpnewpagegroup;</span>
<a name="l15645"></a>15645 <span class="stringliteral">      } elseif (isset($this-&gt;newpagegroup[$topage])) {</span>
<a name="l15646"></a>15646 <span class="stringliteral">        unset($this-&gt;newpagegroup[$topage]);</span>
<a name="l15647"></a>15647 <span class="stringliteral">      }</span>
<a name="l15648"></a>15648 <span class="stringliteral">      // adjust outlines</span>
<a name="l15649"></a>15649 <span class="stringliteral">      $tmpoutlines = $this-&gt;outlines;</span>
<a name="l15650"></a>15650 <span class="stringliteral">      foreach ($tmpoutlines as $key =&gt; $outline) {</span>
<a name="l15651"></a>15651 <span class="stringliteral">        if (($outline[&#39;</span>p<span class="stringliteral">&#39;] &gt;= $topage) AND ($outline[&#39;</span>p<span class="stringliteral">&#39;] &lt; $frompage)) {</span>
<a name="l15652"></a>15652 <span class="stringliteral">          $this-&gt;outlines[$key][&#39;</span>p<span class="stringliteral">&#39;] = $outline[&#39;</span>p<span class="stringliteral">&#39;] + 1;</span>
<a name="l15653"></a>15653 <span class="stringliteral">        } elseif ($outline[&#39;</span>p<span class="stringliteral">&#39;] == $frompage) {</span>
<a name="l15654"></a>15654 <span class="stringliteral">          $this-&gt;outlines[$key][&#39;</span>p<span class="stringliteral">&#39;] = $topage;</span>
<a name="l15655"></a>15655 <span class="stringliteral">        }</span>
<a name="l15656"></a>15656 <span class="stringliteral">      }</span>
<a name="l15657"></a>15657 <span class="stringliteral">      // adjust links</span>
<a name="l15658"></a>15658 <span class="stringliteral">      $tmplinks = $this-&gt;links;</span>
<a name="l15659"></a>15659 <span class="stringliteral">      foreach ($tmplinks as $key =&gt; $link) {</span>
<a name="l15660"></a>15660 <span class="stringliteral">        if (($link[0] &gt;= $topage) AND ($link[0] &lt; $frompage)) {</span>
<a name="l15661"></a>15661 <span class="stringliteral">          $this-&gt;links[$key][0] = $link[0] + 1;</span>
<a name="l15662"></a>15662 <span class="stringliteral">        } elseif ($link[0] == $frompage) {</span>
<a name="l15663"></a>15663 <span class="stringliteral">          $this-&gt;links[$key][0] = $topage;</span>
<a name="l15664"></a>15664 <span class="stringliteral">        }</span>
<a name="l15665"></a>15665 <span class="stringliteral">      }</span>
<a name="l15666"></a>15666 <span class="stringliteral">      // adjust javascript</span>
<a name="l15667"></a>15667 <span class="stringliteral">      $tmpjavascript = $this-&gt;javascript;</span>
<a name="l15668"></a>15668 <span class="stringliteral">      global $jfrompage, $jtopage;</span>
<a name="l15669"></a>15669 <span class="stringliteral">      $jfrompage = $frompage;</span>
<a name="l15670"></a>15670 <span class="stringliteral">      $jtopage = $topage;</span>
<a name="l15671"></a>15671 <span class="stringliteral">      $this-&gt;javascript = preg_replace_callback(&#39;</span>/<span class="keyword">this</span>\.addField\(\<span class="stringliteral">&#39;([^\&#39;]*)\&#39;,\&#39;([^\&#39;]*)\&#39;,([0-9]+)/&#39;</span>,
<a name="l15672"></a>15672         create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;global $jfrompage, $jtopage;</span>
<a name="l15673"></a>15673 <span class="stringliteral">        $pagenum = intval($matches[3]) + 1;</span>
<a name="l15674"></a>15674 <span class="stringliteral">        if (($pagenum &gt;= $jtopage) AND ($pagenum &lt; $jfrompage)) {</span>
<a name="l15675"></a>15675 <span class="stringliteral">          $newpage = ($pagenum + 1);</span>
<a name="l15676"></a>15676 <span class="stringliteral">        } elseif ($pagenum == $jfrompage) {</span>
<a name="l15677"></a>15677 <span class="stringliteral">          $newpage = $jtopage;</span>
<a name="l15678"></a>15678 <span class="stringliteral">        } else {</span>
<a name="l15679"></a>15679 <span class="stringliteral">          $newpage = $pagenum;</span>
<a name="l15680"></a>15680 <span class="stringliteral">        }</span>
<a name="l15681"></a>15681 <span class="stringliteral">        --$newpage;</span>
<a name="l15682"></a>15682 <span class="stringliteral">        return &quot;this.addField(\&#39;&quot;.$matches[1].&quot;\&#39;,\&#39;&quot;.$matches[2].&quot;\&#39;,&quot;.$newpage.&quot;&quot;;&#39;</span>), $tmpjavascript);
<a name="l15683"></a>15683       <span class="comment">// return to last page</span>
<a name="l15684"></a>15684       $this-&gt;lastPage(<span class="keyword">true</span>);
<a name="l15685"></a>15685       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l15686"></a>15686     }
<a name="l15687"></a>15687 
<a name="l15695"></a>15695     <span class="keyword">public</span> function deletePage($page) {
<a name="l15696"></a>15696       <span class="keywordflow">if</span> ($page &gt; $this-&gt;numpages) {
<a name="l15697"></a>15697         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l15698"></a>15698       }
<a name="l15699"></a>15699       <span class="comment">// delete current page</span>
<a name="l15700"></a>15700       unset($this-&gt;pages[$page]);
<a name="l15701"></a>15701       unset($this-&gt;pagedim[$page]);
<a name="l15702"></a>15702       unset($this-&gt;pagelen[$page]);
<a name="l15703"></a>15703       unset($this-&gt;intmrk[$page]);
<a name="l15704"></a>15704       <span class="keywordflow">if</span> (isset($this-&gt;footerpos[$page])) {
<a name="l15705"></a>15705         unset($this-&gt;footerpos[$page]);
<a name="l15706"></a>15706       }
<a name="l15707"></a>15707       <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$page])) {
<a name="l15708"></a>15708         unset($this-&gt;footerlen[$page]);
<a name="l15709"></a>15709       }
<a name="l15710"></a>15710       <span class="keywordflow">if</span> (isset($this-&gt;transfmrk[$page])) {
<a name="l15711"></a>15711         unset($this-&gt;transfmrk[$page]);
<a name="l15712"></a>15712       }
<a name="l15713"></a>15713       <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$page])) {
<a name="l15714"></a>15714         unset($this-&gt;PageAnnots[$page]);
<a name="l15715"></a>15715       }
<a name="l15716"></a>15716       <span class="keywordflow">if</span> (isset($this-&gt;newpagegroup[$page])) {
<a name="l15717"></a>15717         unset($this-&gt;newpagegroup[$page]);
<a name="l15718"></a>15718       }
<a name="l15719"></a>15719       <span class="keywordflow">if</span> (isset($this-&gt;pageopen[$page])) {
<a name="l15720"></a>15720         unset($this-&gt;pageopen[$page]);
<a name="l15721"></a>15721       }
<a name="l15722"></a>15722       <span class="comment">// update remaining pages</span>
<a name="l15723"></a>15723       <span class="keywordflow">for</span> ($i = $page; $i &lt; $this-&gt;numpages; ++$i) {
<a name="l15724"></a>15724         $j = $i + 1;
<a name="l15725"></a>15725         <span class="comment">// shift pages</span>
<a name="l15726"></a>15726         $this-&gt;pages[$i] = $this-&gt;pages[$j];
<a name="l15727"></a>15727         $this-&gt;pagedim[$i] = $this-&gt;pagedim[$j];
<a name="l15728"></a>15728         $this-&gt;pagelen[$i] = $this-&gt;pagelen[$j];
<a name="l15729"></a>15729         $this-&gt;intmrk[$i] = $this-&gt;intmrk[$j];
<a name="l15730"></a>15730         <span class="keywordflow">if</span> (isset($this-&gt;footerpos[$j])) {
<a name="l15731"></a>15731           $this-&gt;footerpos[$i] = $this-&gt;footerpos[$j];
<a name="l15732"></a>15732         } elseif (isset($this-&gt;footerpos[$i])) {
<a name="l15733"></a>15733           unset($this-&gt;footerpos[$i]);
<a name="l15734"></a>15734         }
<a name="l15735"></a>15735         <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$j])) {
<a name="l15736"></a>15736           $this-&gt;footerlen[$i] = $this-&gt;footerlen[$j];
<a name="l15737"></a>15737         } elseif (isset($this-&gt;footerlen[$i])) {
<a name="l15738"></a>15738           unset($this-&gt;footerlen[$i]);
<a name="l15739"></a>15739         }
<a name="l15740"></a>15740         <span class="keywordflow">if</span> (isset($this-&gt;transfmrk[$j])) {
<a name="l15741"></a>15741           $this-&gt;transfmrk[$i] = $this-&gt;transfmrk[$j];
<a name="l15742"></a>15742         } elseif (isset($this-&gt;transfmrk[$i])) {
<a name="l15743"></a>15743           unset($this-&gt;transfmrk[$i]);
<a name="l15744"></a>15744         }
<a name="l15745"></a>15745         <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$j])) {
<a name="l15746"></a>15746           $this-&gt;PageAnnots[$i] = $this-&gt;PageAnnots[$j];
<a name="l15747"></a>15747         } elseif (isset($this-&gt;PageAnnots[$i])) {
<a name="l15748"></a>15748           unset($this-&gt;PageAnnots[$i]);
<a name="l15749"></a>15749         }
<a name="l15750"></a>15750         <span class="keywordflow">if</span> (isset($this-&gt;newpagegroup[$j])) {
<a name="l15751"></a>15751           $this-&gt;newpagegroup[$i] = $this-&gt;newpagegroup[$j];
<a name="l15752"></a>15752         } elseif (isset($this-&gt;newpagegroup[$i])) {
<a name="l15753"></a>15753           unset($this-&gt;newpagegroup[$i]);
<a name="l15754"></a>15754         }
<a name="l15755"></a>15755         <span class="keywordflow">if</span> (isset($this-&gt;pageopen[$j])) {
<a name="l15756"></a>15756           $this-&gt;pageopen[$i] = $this-&gt;pageopen[$j];
<a name="l15757"></a>15757         } elseif (isset($this-&gt;pageopen[$i])) {
<a name="l15758"></a>15758           unset($this-&gt;pageopen[$i]);
<a name="l15759"></a>15759         }
<a name="l15760"></a>15760       }
<a name="l15761"></a>15761       <span class="comment">// remove last page</span>
<a name="l15762"></a>15762       unset($this-&gt;pages[$this-&gt;numpages]);
<a name="l15763"></a>15763       unset($this-&gt;pagedim[$this-&gt;numpages]);
<a name="l15764"></a>15764       unset($this-&gt;pagelen[$this-&gt;numpages]);
<a name="l15765"></a>15765       unset($this-&gt;intmrk[$this-&gt;numpages]);
<a name="l15766"></a>15766       <span class="keywordflow">if</span> (isset($this-&gt;footerpos[$this-&gt;numpages])) {
<a name="l15767"></a>15767         unset($this-&gt;footerpos[$this-&gt;numpages]);
<a name="l15768"></a>15768       }
<a name="l15769"></a>15769       <span class="keywordflow">if</span> (isset($this-&gt;footerlen[$this-&gt;numpages])) {
<a name="l15770"></a>15770         unset($this-&gt;footerlen[$this-&gt;numpages]);
<a name="l15771"></a>15771       }
<a name="l15772"></a>15772       <span class="keywordflow">if</span> (isset($this-&gt;transfmrk[$this-&gt;numpages])) {
<a name="l15773"></a>15773         unset($this-&gt;transfmrk[$this-&gt;numpages]);
<a name="l15774"></a>15774       }
<a name="l15775"></a>15775       <span class="keywordflow">if</span> (isset($this-&gt;PageAnnots[$this-&gt;numpages])) {
<a name="l15776"></a>15776         unset($this-&gt;PageAnnots[$this-&gt;numpages]);
<a name="l15777"></a>15777       }
<a name="l15778"></a>15778       <span class="keywordflow">if</span> (isset($this-&gt;newpagegroup[$this-&gt;numpages])) {
<a name="l15779"></a>15779         unset($this-&gt;newpagegroup[$this-&gt;numpages]);
<a name="l15780"></a>15780       }
<a name="l15781"></a>15781       <span class="keywordflow">if</span> (isset($this-&gt;pageopen[$this-&gt;numpages])) {
<a name="l15782"></a>15782         unset($this-&gt;pageopen[$this-&gt;numpages]);
<a name="l15783"></a>15783       }
<a name="l15784"></a>15784       --$this-&gt;numpages;
<a name="l15785"></a>15785       $this-&gt;page = $this-&gt;numpages;
<a name="l15786"></a>15786       <span class="comment">// adjust outlines</span>
<a name="l15787"></a>15787       $tmpoutlines = $this-&gt;outlines;
<a name="l15788"></a>15788       <span class="keywordflow">foreach</span> ($tmpoutlines as $key =&gt; $outline) {
<a name="l15789"></a>15789         <span class="keywordflow">if</span> ($outline[<span class="charliteral">&#39;p&#39;</span>] &gt; $page) {
<a name="l15790"></a>15790           $this-&gt;outlines[$key][<span class="charliteral">&#39;p&#39;</span>] = $outline[<span class="charliteral">&#39;p&#39;</span>] - 1;
<a name="l15791"></a>15791         } elseif ($outline[<span class="charliteral">&#39;p&#39;</span>] == $page) {
<a name="l15792"></a>15792           unset($this-&gt;outlines[$key]);
<a name="l15793"></a>15793         }
<a name="l15794"></a>15794       }
<a name="l15795"></a>15795       <span class="comment">// adjust links</span>
<a name="l15796"></a>15796       $tmplinks = $this-&gt;links;
<a name="l15797"></a>15797       <span class="keywordflow">foreach</span> ($tmplinks as $key =&gt; $link) {
<a name="l15798"></a>15798         <span class="keywordflow">if</span> ($link[0] &gt; $page) {
<a name="l15799"></a>15799           $this-&gt;links[$key][0] = $link[0] - 1;
<a name="l15800"></a>15800         } elseif ($link[0] == $page) {
<a name="l15801"></a>15801           unset($this-&gt;links[$key]);
<a name="l15802"></a>15802         }
<a name="l15803"></a>15803       }
<a name="l15804"></a>15804       <span class="comment">// adjust javascript</span>
<a name="l15805"></a>15805       $tmpjavascript = $this-&gt;javascript;
<a name="l15806"></a>15806       global $jpage;
<a name="l15807"></a>15807       $jpage = $page;
<a name="l15808"></a>15808       $this-&gt;javascript = preg_replace_callback(<span class="stringliteral">&#39;/this\.addField\(\&#39;([^\&#39;]*)\&#39;,\&#39;([^\&#39;]*)\&#39;,([0-9]+)/&#39;</span>,
<a name="l15809"></a>15809         create_function(<span class="stringliteral">&#39;$matches&#39;</span>, <span class="stringliteral">&#39;global $jpage;</span>
<a name="l15810"></a>15810 <span class="stringliteral">        $pagenum = intval($matches[3]) + 1;</span>
<a name="l15811"></a>15811 <span class="stringliteral">        if ($pagenum &gt;= $jpage) {</span>
<a name="l15812"></a>15812 <span class="stringliteral">          $newpage = ($pagenum - 1);</span>
<a name="l15813"></a>15813 <span class="stringliteral">        } elseif ($pagenum == $jpage) {</span>
<a name="l15814"></a>15814 <span class="stringliteral">          $newpage = 1;</span>
<a name="l15815"></a>15815 <span class="stringliteral">        } else {</span>
<a name="l15816"></a>15816 <span class="stringliteral">          $newpage = $pagenum;</span>
<a name="l15817"></a>15817 <span class="stringliteral">        }</span>
<a name="l15818"></a>15818 <span class="stringliteral">        --$newpage;</span>
<a name="l15819"></a>15819 <span class="stringliteral">        return &quot;this.addField(\&#39;&quot;.$matches[1].&quot;\&#39;,\&#39;&quot;.$matches[2].&quot;\&#39;,&quot;.$newpage.&quot;&quot;;&#39;</span>), $tmpjavascript);
<a name="l15820"></a>15820       <span class="comment">// return to last page</span>
<a name="l15821"></a>15821       $this-&gt;lastPage(<span class="keyword">true</span>);
<a name="l15822"></a>15822       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l15823"></a>15823     }
<a name="l15824"></a>15824 
<a name="l15835"></a>15835     <span class="keyword">public</span> function addTOC($page=<span class="stringliteral">&#39;&#39;</span>, $numbersfont=<span class="stringliteral">&#39;&#39;</span>, $filler=<span class="charliteral">&#39;.&#39;</span>) {
<a name="l15836"></a>15836       $fontsize = $this-&gt;FontSizePt;
<a name="l15837"></a>15837       $fontfamily = $this-&gt;FontFamily;
<a name="l15838"></a>15838       $fontstyle = $this-&gt;FontStyle;
<a name="l15839"></a>15839       $w = $this-&gt;w - $this-&gt;lMargin - $this-&gt;rMargin;
<a name="l15840"></a>15840       $spacer = $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>) * 4;
<a name="l15841"></a>15841       $page_first = $this-&gt;getPage();
<a name="l15842"></a>15842       $lmargin = $this-&gt;lMargin;
<a name="l15843"></a>15843       $rmargin = $this-&gt;rMargin;
<a name="l15844"></a>15844       $x_start = $this-&gt;GetX();
<a name="l15845"></a>15845       <span class="keywordflow">if</span> ($this-&gt;empty_string($numbersfont)) {
<a name="l15846"></a>15846         $numbersfont = $this-&gt;default_monospaced_font;
<a name="l15847"></a>15847       }
<a name="l15848"></a>15848       <span class="keywordflow">if</span> ($this-&gt;empty_string($filler)) {
<a name="l15849"></a>15849         $filler = <span class="charliteral">&#39; &#39;</span>;
<a name="l15850"></a>15850       }
<a name="l15851"></a>15851       <span class="keywordflow">if</span> ($this-&gt;empty_string($page)) {
<a name="l15852"></a>15852         $gap = <span class="charliteral">&#39; &#39;</span>;
<a name="l15853"></a>15853       } <span class="keywordflow">else</span> {
<a name="l15854"></a>15854         $gap = <span class="stringliteral">&#39;&#39;</span>;
<a name="l15855"></a>15855       }
<a name="l15856"></a>15856       <span class="keywordflow">foreach</span> ($this-&gt;outlines as $key =&gt; $outline) {
<a name="l15857"></a>15857         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l15858"></a>15858           $aligntext = <span class="charliteral">&#39;R&#39;</span>;
<a name="l15859"></a>15859           $alignnum = <span class="charliteral">&#39;L&#39;</span>;
<a name="l15860"></a>15860         } <span class="keywordflow">else</span> {
<a name="l15861"></a>15861           $aligntext = <span class="charliteral">&#39;L&#39;</span>;
<a name="l15862"></a>15862           $alignnum = <span class="charliteral">&#39;R&#39;</span>;
<a name="l15863"></a>15863         }
<a name="l15864"></a>15864         <span class="keywordflow">if</span> ($outline[<span class="charliteral">&#39;l&#39;</span>] == 0) {
<a name="l15865"></a>15865           $this-&gt;SetFont($fontfamily, $fontstyle.<span class="charliteral">&#39;B&#39;</span>, $fontsize);
<a name="l15866"></a>15866         } <span class="keywordflow">else</span> {
<a name="l15867"></a>15867           $this-&gt;SetFont($fontfamily, $fontstyle, $fontsize - $outline[<span class="charliteral">&#39;l&#39;</span>]);
<a name="l15868"></a>15868         }
<a name="l15869"></a>15869         $indent = ($spacer * $outline[<span class="charliteral">&#39;l&#39;</span>]);
<a name="l15870"></a>15870         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l15871"></a>15871           $this-&gt;rMargin += $indent;
<a name="l15872"></a>15872           $this-&gt;x -= $indent;
<a name="l15873"></a>15873         } <span class="keywordflow">else</span> {
<a name="l15874"></a>15874           $this-&gt;lMargin += $indent;
<a name="l15875"></a>15875           $this-&gt;x += $indent;
<a name="l15876"></a>15876         }
<a name="l15877"></a>15877         $link = $this-&gt;AddLink();
<a name="l15878"></a>15878         $this-&gt;SetLink($link, 0, $outline[<span class="charliteral">&#39;p&#39;</span>]);
<a name="l15879"></a>15879         <span class="comment">// write the text</span>
<a name="l15880"></a>15880         $this-&gt;Write(0, $outline[<span class="charliteral">&#39;t&#39;</span>], $link, 0, $aligntext, <span class="keyword">false</span>, 0, <span class="keyword">false</span>, <span class="keyword">false</span>, 0);
<a name="l15881"></a>15881         $this-&gt;SetFont($numbersfont, $fontstyle, $fontsize);
<a name="l15882"></a>15882         <span class="keywordflow">if</span> ($this-&gt;empty_string($page)) {
<a name="l15883"></a>15883           $pagenum = $outline[<span class="charliteral">&#39;p&#39;</span>];
<a name="l15884"></a>15884         } <span class="keywordflow">else</span> {
<a name="l15885"></a>15885           <span class="comment">// placemark to be replaced with the correct number</span>
<a name="l15886"></a>15886           $pagenum = <span class="stringliteral">&#39;{#&#39;</span>.($outline[<span class="charliteral">&#39;p&#39;</span>]).<span class="charliteral">&#39;}&#39;</span>;
<a name="l15887"></a>15887           <span class="keywordflow">if</span> (($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;TrueTypeUnicode&#39;</span>) OR ($this-&gt;CurrentFont[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;cidfont0&#39;</span>)) {
<a name="l15888"></a>15888             $pagenum = <span class="charliteral">&#39;{&#39;</span>.$pagenum.<span class="charliteral">&#39;}&#39;</span>;
<a name="l15889"></a>15889             }
<a name="l15890"></a>15890         }
<a name="l15891"></a>15891         $numwidth = $this-&gt;GetStringWidth($pagenum);
<a name="l15892"></a>15892         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l15893"></a>15893           $tw = $this-&gt;x - $this-&gt;lMargin;
<a name="l15894"></a>15894         } <span class="keywordflow">else</span> {
<a name="l15895"></a>15895           $tw = $this-&gt;w - $this-&gt;rMargin - $this-&gt;x;
<a name="l15896"></a>15896         }
<a name="l15897"></a>15897         $fw = $tw - $numwidth - $this-&gt;GetStringWidth(<span class="charliteral">&#39; &#39;</span>);
<a name="l15898"></a>15898         $numfills = floor($fw / $this-&gt;GetStringWidth($filler));
<a name="l15899"></a>15899         <span class="keywordflow">if</span> ($numfills &gt; 0) {
<a name="l15900"></a>15900           $rowfill = str_repeat($filler, $numfills);
<a name="l15901"></a>15901         } <span class="keywordflow">else</span> {
<a name="l15902"></a>15902           $rowfill = <span class="stringliteral">&#39;&#39;</span>;
<a name="l15903"></a>15903         }
<a name="l15904"></a>15904         <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l15905"></a>15905           $pagenum = $pagenum.$gap.$rowfill.<span class="charliteral">&#39; &#39;</span>;
<a name="l15906"></a>15906         } <span class="keywordflow">else</span> {
<a name="l15907"></a>15907           $pagenum = <span class="charliteral">&#39; &#39;</span>.$rowfill.$gap.$pagenum;
<a name="l15908"></a>15908         }
<a name="l15909"></a>15909         <span class="comment">// write the number</span>
<a name="l15910"></a>15910         <span class="comment">//$this-&gt;SetX($x_start);</span>
<a name="l15911"></a>15911         $this-&gt;Cell($tw, 0, $pagenum, 0, 1, $alignnum, 0, $link, 0);
<a name="l15912"></a>15912         $this-&gt;SetX($x_start);
<a name="l15913"></a>15913         $this-&gt;lMargin = $lmargin;
<a name="l15914"></a>15914         $this-&gt;rMargin = $rmargin;
<a name="l15915"></a>15915       }
<a name="l15916"></a>15916       $page_last = $this-&gt;getPage();
<a name="l15917"></a>15917       $numpages = $page_last - $page_first + 1;
<a name="l15918"></a>15918       <span class="keywordflow">if</span> (!$this-&gt;empty_string($page)) {
<a name="l15919"></a>15919         <span class="keywordflow">for</span> ($p = $page_first; $p &lt;= $page_last; ++$p) {
<a name="l15920"></a>15920           <span class="comment">// get page data</span>
<a name="l15921"></a>15921           $temppage = $this-&gt;getPageBuffer($p);
<a name="l15922"></a>15922           <span class="keywordflow">for</span> ($n = 1; $n &lt;= $this-&gt;numpages; ++$n) {
<a name="l15923"></a>15923             <span class="comment">// update page numbers</span>
<a name="l15924"></a>15924             $k = <span class="stringliteral">&#39;{#&#39;</span>.$n.<span class="charliteral">&#39;}&#39;</span>;
<a name="l15925"></a>15925             $ku = <span class="charliteral">&#39;{&#39;</span>.$k.<span class="charliteral">&#39;}&#39;</span>;
<a name="l15926"></a>15926             $alias_a = $this-&gt;_escape($k);
<a name="l15927"></a>15927             $alias_au = $this-&gt;_escape(<span class="charliteral">&#39;{&#39;</span>.$k.<span class="charliteral">&#39;}&#39;</span>);
<a name="l15928"></a>15928             <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l15929"></a>15929               $alias_b = $this-&gt;_escape($this-&gt;UTF8ToLatin1($k));
<a name="l15930"></a>15930               $alias_bu = $this-&gt;_escape($this-&gt;UTF8ToLatin1($ku));
<a name="l15931"></a>15931               $alias_c = $this-&gt;_escape($this-&gt;utf8StrRev($k, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l15932"></a>15932               $alias_cu = $this-&gt;_escape($this-&gt;utf8StrRev($ku, <span class="keyword">false</span>, $this-&gt;tmprtl));
<a name="l15933"></a>15933             }
<a name="l15934"></a>15934             <span class="keywordflow">if</span> ($n &gt;= $page) {
<a name="l15935"></a>15935               $np = $n + $numpages;
<a name="l15936"></a>15936             } <span class="keywordflow">else</span> {
<a name="l15937"></a>15937               $np = $n;
<a name="l15938"></a>15938             }
<a name="l15939"></a>15939             $ns = $this-&gt;formatTOCPageNumber($np);
<a name="l15940"></a>15940             $nu = $ns;
<a name="l15941"></a>15941             $sdiff = strlen($k) - strlen($ns) - 1;
<a name="l15942"></a>15942             $sdiffu = strlen($ku) - strlen($ns) - 1;
<a name="l15943"></a>15943             $sfill = str_repeat($filler, $sdiff);
<a name="l15944"></a>15944             $sfillu = str_repeat($filler, $sdiffu);
<a name="l15945"></a>15945             <span class="keywordflow">if</span> ($this-&gt;rtl) {
<a name="l15946"></a>15946               $ns = $ns.<span class="charliteral">&#39; &#39;</span>.$sfill;
<a name="l15947"></a>15947               $nu = $nu.<span class="charliteral">&#39; &#39;</span>.$sfillu;
<a name="l15948"></a>15948             } <span class="keywordflow">else</span> {
<a name="l15949"></a>15949               $ns = $sfill.<span class="charliteral">&#39; &#39;</span>.$ns;
<a name="l15950"></a>15950               $nu = $sfillu.<span class="charliteral">&#39; &#39;</span>.$nu;
<a name="l15951"></a>15951             }
<a name="l15952"></a>15952             $nu = $this-&gt;UTF8ToUTF16BE($nu, <span class="keyword">false</span>);
<a name="l15953"></a>15953             $temppage = str_replace($alias_au, $nu, $temppage);
<a name="l15954"></a>15954             <span class="keywordflow">if</span> ($this-&gt;isunicode) {
<a name="l15955"></a>15955               $temppage = str_replace($alias_bu, $nu, $temppage);
<a name="l15956"></a>15956               $temppage = str_replace($alias_cu, $nu, $temppage);
<a name="l15957"></a>15957               $temppage = str_replace($alias_b, $ns, $temppage);
<a name="l15958"></a>15958               $temppage = str_replace($alias_c, $ns, $temppage);
<a name="l15959"></a>15959             }
<a name="l15960"></a>15960             $temppage = str_replace($alias_a, $ns, $temppage);
<a name="l15961"></a>15961           }
<a name="l15962"></a>15962           <span class="comment">// save changes</span>
<a name="l15963"></a>15963           $this-&gt;setPageBuffer($p, $temppage);
<a name="l15964"></a>15964         }
<a name="l15965"></a>15965         <span class="comment">// move pages</span>
<a name="l15966"></a>15966         <span class="keywordflow">for</span> ($i = 0; $i &lt; $numpages; ++$i) {
<a name="l15967"></a>15967           $this-&gt;movePage($page_last, $page);
<a name="l15968"></a>15968         }
<a name="l15969"></a>15969       }
<a name="l15970"></a>15970       $this-&gt;SetFont($fontfamily, $fontstyle, $fontsize);
<a name="l15971"></a>15971     }
<a name="l15972"></a>15972 
<a name="l15978"></a>15978     <span class="keyword">public</span> function startTransaction() {
<a name="l15979"></a>15979       <span class="keywordflow">if</span> (isset($this-&gt;objcopy)) {
<a name="l15980"></a>15980         <span class="comment">// remove previous copy</span>
<a name="l15981"></a>15981         $this-&gt;commitTransaction();
<a name="l15982"></a>15982       }
<a name="l15983"></a>15983       <span class="comment">// record current page number</span>
<a name="l15984"></a>15984       $this-&gt;start_transaction_page = $this-&gt;page;
<a name="l15985"></a>15985       <span class="comment">// clone current object</span>
<a name="l15986"></a>15986       $this-&gt;objcopy = $this-&gt;objclone($this);
<a name="l15987"></a>15987     }
<a name="l15988"></a>15988 
<a name="l15994"></a>15994     <span class="keyword">public</span> function commitTransaction() {
<a name="l15995"></a>15995       <span class="keywordflow">if</span> (isset($this-&gt;objcopy)) {
<a name="l15996"></a>15996         $this-&gt;objcopy-&gt;_destroy(<span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l15997"></a>15997         unset($this-&gt;objcopy);
<a name="l15998"></a>15998       }
<a name="l15999"></a>15999     }
<a name="l16000"></a>16000 
<a name="l16008"></a>16008     <span class="keyword">public</span> function rollbackTransaction($self=<span class="keyword">false</span>) {
<a name="l16009"></a>16009       <span class="keywordflow">if</span> (isset($this-&gt;objcopy)) {
<a name="l16010"></a>16010         <span class="keywordflow">if</span> (isset($this-&gt;objcopy-&gt;diskcache) AND $this-&gt;objcopy-&gt;diskcache) {
<a name="l16011"></a>16011           <span class="comment">// truncate files to previous values</span>
<a name="l16012"></a>16012           <span class="keywordflow">foreach</span> ($this-&gt;objcopy-&gt;cache_file_lenght as $file =&gt; $lenght) {
<a name="l16013"></a>16013             $file = substr($file, 1);
<a name="l16014"></a>16014             $handle = fopen($file, <span class="stringliteral">&#39;r+&#39;</span>);
<a name="l16015"></a>16015             ftruncate($handle, $lenght);
<a name="l16016"></a>16016           }
<a name="l16017"></a>16017         }
<a name="l16018"></a>16018         $this-&gt;_destroy(<span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l16019"></a>16019         <span class="keywordflow">if</span> ($self) {
<a name="l16020"></a>16020           $objvars = get_object_vars($this-&gt;objcopy);
<a name="l16021"></a>16021           <span class="keywordflow">foreach</span> ($objvars as $key =&gt; $value) {
<a name="l16022"></a>16022             $this-&gt;$key = $value;
<a name="l16023"></a>16023           }
<a name="l16024"></a>16024         }
<a name="l16025"></a>16025         <span class="keywordflow">return</span> $this-&gt;objcopy;
<a name="l16026"></a>16026       }
<a name="l16027"></a>16027       <span class="keywordflow">return</span> $this;
<a name="l16028"></a>16028     }
<a name="l16029"></a>16029 
<a name="l16037"></a>16037     <span class="keyword">public</span> function objclone($object) {
<a name="l16038"></a>16038       <span class="keywordflow">return</span> @clone($object);
<a name="l16039"></a>16039     }
<a name="l16040"></a>16040 
<a name="l16048"></a>16048     <span class="keyword">public</span> function empty_string($str) {
<a name="l16049"></a>16049       <span class="keywordflow">return</span> (is_null($str) OR (is_string($str) AND (strlen($str) == 0)));
<a name="l16050"></a>16050     }
<a name="l16051"></a>16051     
<a name="l16052"></a>16052   } <span class="comment">// END OF TCPDF CLASS</span>
<a name="l16053"></a>16053 }
<a name="l16054"></a>16054 <span class="comment">//============================================================+</span>
<a name="l16055"></a>16055 <span class="comment">// END OF FILE</span>
<a name="l16056"></a>16056 <span class="comment">//============================================================+</span>
<a name="l16057"></a>16057 ?&gt;
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
