<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Sahana Agasti: apps/frontend/lib/util/agPhoneHelper.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>apps/frontend/lib/util/agPhoneHelper.class.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00016"></a><a class="code" href="classagPhoneHelper.html">00016</a> <span class="keyword">class </span><a class="code" href="classagPhoneHelper.html" title="Provides bulk-phone manipulation methods.">agPhoneHelper</a> <span class="keyword">extends</span> <a class="code" href="classagBulkRecordHelper.html" title="Abstract class to provide bulk-address manipulation methods.">agBulkRecordHelper</a>
<a name="l00017"></a>00017 {
<a name="l00018"></a>00018   <span class="comment">// these constants map to the phone get types that are supported in other function calls</span>
<a name="l00019"></a>00019   <span class="keyword">const</span>     PHN_GET_FORMATTED = <span class="stringliteral">&#39;getFormattedPhone&#39;</span>,
<a name="l00020"></a>00020             PHN_GET_COMPONENT_SEGMENTS = <span class="stringliteral">&#39;getPhoneComponentSegments&#39;</span>,
<a name="l00021"></a>00021             PHN_GET_COMPONENT = <span class="stringliteral">&#39;getPhoneComponent&#39;</span>,
<a name="l00022"></a>00022             PHN_AREA_CODE = <span class="stringliteral">&#39;_phn_area_code&#39;</span>,
<a name="l00023"></a>00023             PHN_FIRST_THREE = <span class="stringliteral">&#39;_phn_first_three&#39;</span>,
<a name="l00024"></a>00024             PHN_LAST_FOUR = <span class="stringliteral">&#39;_phn_last_four&#39;</span>,
<a name="l00025"></a>00025             PHN_EXTENSION = <span class="stringliteral">&#39;_phn_extension&#39;</span>,
<a name="l00026"></a>00026             PHN_DEFAULT = <span class="stringliteral">&#39;_phn_default&#39;</span>;
<a name="l00027"></a>00027 
<a name="l00028"></a>00028   <span class="keyword">protected</span> $_globalDefaultPhoneFormatType = <span class="stringliteral">&#39;default_phone_format_type&#39;</span>,
<a name="l00029"></a>00029             $_globalDefaultCountry = <span class="stringliteral">&#39;default_country&#39;</span>,
<a name="l00030"></a>00030             $_phoneFormatComponentsByCountry = array(),
<a name="l00031"></a>00031             $_phoneValidation = array(),
<a name="l00032"></a>00032             $_phoneDisplayFormat = array(),
<a name="l00033"></a>00033             $_returnFormatId,
<a name="l00034"></a>00034             $_returnFormatIdsByCountry,
<a name="l00035"></a>00035             $_startIndex = 0,
<a name="l00036"></a>00036             $_phn_area_code = array(<span class="stringliteral">&#39;startIndex&#39;</span> =&gt; 0, <span class="stringliteral">&#39;length&#39;</span> =&gt; 3),
<a name="l00037"></a>00037             $_phn_first_three = array(<span class="stringliteral">&#39;startIndex&#39;</span> =&gt; 3, <span class="stringliteral">&#39;length&#39;</span> =&gt; 3),
<a name="l00038"></a>00038             $_phn_last_four = array(<span class="stringliteral">&#39;startIndex&#39;</span> =&gt; 6, <span class="stringliteral">&#39;length&#39;</span> =&gt; 4),
<a name="l00039"></a>00039             $_phn_extension = array(<span class="stringliteral">&#39;startIndex&#39;</span> =&gt; 10, <span class="stringliteral">&#39;length&#39;</span> =&gt; NULL),
<a name="l00040"></a>00040             $_phn_default = array(<span class="stringliteral">&#39;startIndex&#39;</span> =&gt; 0, <span class="stringliteral">&#39;length&#39;</span> =&gt; NULL);
<a name="l00041"></a>00041 
<a name="l00048"></a><a class="code" href="classagPhoneHelper.html#a85b7a0ed08243ad65c731982068b3f35">00048</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a85b7a0ed08243ad65c731982068b3f35" title="This is the class&amp;#39;s constructor whic pre-loads the formatting elements according...">__construct</a>(array $phoneIds = NULL)
<a name="l00049"></a>00049   {
<a name="l00050"></a>00050     <span class="comment">// if passed an array of phone id&#39;s, set them as a class property</span>
<a name="l00051"></a>00051     <a class="code" href="classagPhoneHelper.html#a85b7a0ed08243ad65c731982068b3f35" title="This is the class&amp;#39;s constructor whic pre-loads the formatting elements according...">parent::__construct</a>($phoneIds);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     <span class="comment">// set our default phone standard and pick up the formatting components</span>
<a name="l00054"></a>00054     $this-&gt;<a class="code" href="classagPhoneHelper.html#afbc969f93b5f31a9a6792d7431f37021" title="Protected method to set the default phone format used for returning phone.">_setDefaultReturnFormat</a>();
<a name="l00055"></a>00055   }
<a name="l00056"></a>00056 
<a name="l00063"></a><a class="code" href="classagPhoneHelper.html#a200ed194c29e0a7c27bbf544a575a810">00063</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#a200ed194c29e0a7c27bbf544a575a810" title="Method used to construct the base query object used by other objects in this class...">_getPhoneFormatType</a>($phoneFormatType)
<a name="l00064"></a>00064   {
<a name="l00065"></a>00065     <span class="comment">// construct our base query object</span>
<a name="l00066"></a>00066     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00067"></a>00067       -&gt;select(<span class="stringliteral">&#39;pf.id&#39;</span>)
<a name="l00068"></a>00068         -&gt;from(<span class="stringliteral">&#39;agPhoneFormat pf&#39;</span>)
<a name="l00069"></a>00069             -&gt;innerJoin(<span class="stringliteral">&#39;pf.agPhoneFormatType pft&#39;</span>)
<a name="l00070"></a>00070         -&gt;where(<span class="stringliteral">&#39;pft.phone_format_type = ?&#39;</span>, $phoneFormatType);
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="keywordflow">return</span> $q;
<a name="l00073"></a>00073   }
<a name="l00074"></a>00074 
<a name="l00081"></a><a class="code" href="classagPhoneHelper.html#a84b2aa076fcc23757e20c50d87296d6e">00081</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#a84b2aa076fcc23757e20c50d87296d6e" title="Method used to construct the base query object used by other objects in this class...">_getPhoneFormatTypeByCountry</a>($country)
<a name="l00082"></a>00082   {
<a name="l00083"></a>00083     <span class="comment">// construct our base query object</span>
<a name="l00084"></a>00084     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00085"></a>00085       -&gt;select(<span class="stringliteral">&#39;pf.id&#39;</span>)
<a name="l00086"></a>00086         -&gt;from(<span class="stringliteral">&#39;agPhoneFormat pf&#39;</span>)
<a name="l00087"></a>00087             -&gt;innerJoin(<span class="stringliteral">&#39;pf.agPhoneFormatType pft&#39;</span>)
<a name="l00088"></a>00088             -&gt;innerJoin(<span class="stringliteral">&#39;pf.agCountry c&#39;</span>)
<a name="l00089"></a>00089         -&gt;where(<span class="stringliteral">&#39;c.country = ?&#39;</span>, $country);
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     <span class="keywordflow">return</span> $q;
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 
<a name="l00099"></a><a class="code" href="classagPhoneHelper.html#a44cc798c505bb32861abf1468c06d0d2">00099</a>   <span class="keyword">static</span> <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a44cc798c505bb32861abf1468c06d0d2" title="Method to return phone contact type ids from phone contact type values.">getPhoneContactTypeIds</a>(array $phoneTypes)
<a name="l00100"></a>00100   {
<a name="l00101"></a>00101     <span class="keywordflow">return</span> <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00102"></a>00102       -&gt;select(<span class="stringliteral">&#39;ept.phone_contact_type&#39;</span>)
<a name="l00103"></a>00103           -&gt;addSelect(<span class="stringliteral">&#39;ept.id&#39;</span>)
<a name="l00104"></a>00104         -&gt;from(<span class="stringliteral">&#39;agPhoneContactType ept&#39;</span>)
<a name="l00105"></a>00105         -&gt;whereIn(<span class="stringliteral">&#39;ept.phone_contact_type&#39;</span>, $phoneTypes)
<a name="l00106"></a>00106       -&gt;useResultCache(TRUE, 3600)
<a name="l00107"></a>00107       -&gt;execute(array(), agDoctrineQuery::HYDRATE_KEY_VALUE_PAIR);
<a name="l00108"></a>00108   }
<a name="l00109"></a>00109 
<a name="l00118"></a><a class="code" href="classagPhoneHelper.html#adbf172b6fda45f938b7f2ef5959af6fd">00118</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#adbf172b6fda45f938b7f2ef5959af6fd" title="This method queries the database for the required formatting components by country...">_setPhoneFormatComponentByCountry</a>($country = NULL)
<a name="l00119"></a>00119   {
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (is_null($country)) { $country = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>($this-&gt;_globalDefaultCountry); }
<a name="l00121"></a>00121     $q = $this-&gt;<a class="code" href="classagPhoneHelper.html#a84b2aa076fcc23757e20c50d87296d6e" title="Method used to construct the base query object used by other objects in this class...">_getPhoneFormatTypeByCountry</a>($country);
<a name="l00122"></a>00122     $this-&gt;_returnFormatIdsByCountry = $q-&gt;execute(array(), agDoctrineQuery::HYDRATE_SINGLE_VALUE_ARRAY);
<a name="l00123"></a>00123     $q = $this-&gt;_getPhoneFormatComponent($this-&gt;_returnFormatIdsByCountry);
<a name="l00124"></a>00124     <span class="comment">// here we choose a custom hydration method to allow us to manipulate the results data</span>
<a name="l00125"></a>00125     $formatComponents = $q-&gt;execute(array(), DOCTRINE_CORE::HYDRATE_NONE);
<a name="l00126"></a>00126     <span class="keywordflow">foreach</span>($formatComponents as $fc)
<a name="l00127"></a>00127     {
<a name="l00128"></a>00128       <span class="comment">// create a simple phone validation and display format array.</span>
<a name="l00129"></a>00129       $this-&gt;_phoneFormatComponentsByCountry[$fc[0]] = array($fc[1], $fc[2], $fc[3]);
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131   }
<a name="l00132"></a>00132 
<a name="l00136"></a><a class="code" href="classagPhoneHelper.html#afbc969f93b5f31a9a6792d7431f37021">00136</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#afbc969f93b5f31a9a6792d7431f37021" title="Protected method to set the default phone format used for returning phone.">_setDefaultReturnFormat</a>()
<a name="l00137"></a>00137   {
<a name="l00138"></a>00138     $phoneFormatType = <a class="code" href="classagGlobal.html#a3860c5e7f0dcd22c1da77879b51b696a" title="Static method to return the requested parameter.">agGlobal::getParam</a>($this-&gt;_globalDefaultPhoneFormatType);
<a name="l00139"></a>00139     $q = $this-&gt;<a class="code" href="classagPhoneHelper.html#a200ed194c29e0a7c27bbf544a575a810" title="Method used to construct the base query object used by other objects in this class...">_getPhoneFormatType</a>($phoneFormatType);
<a name="l00140"></a>00140     $formatId = $q-&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     $this-&gt;<a class="code" href="classagPhoneHelper.html#a18d7f9a07e1428d1974197c9b5542b35" title="A simple method to set the current return format and force the re-generation of the...">setReturnFormat</a>($formatId);
<a name="l00143"></a>00143   }
<a name="l00144"></a>00144 
<a name="l00150"></a><a class="code" href="classagPhoneHelper.html#a18d7f9a07e1428d1974197c9b5542b35">00150</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a18d7f9a07e1428d1974197c9b5542b35" title="A simple method to set the current return format and force the re-generation of the...">setReturnFormat</a>($formatId)
<a name="l00151"></a>00151   {
<a name="l00152"></a>00152     $this-&gt;_returnFormatId = $formatId;
<a name="l00153"></a>00153     $this-&gt;<a class="code" href="classagPhoneHelper.html#a2c25c0e8e9d22979958dc01d06992f09" title="This method queries the database for the required formatting components and loads...">_setPhoneFormatComponent</a>();
<a name="l00154"></a>00154     $this-&gt;<a class="code" href="classagPhoneHelper.html#adbf172b6fda45f938b7f2ef5959af6fd" title="This method queries the database for the required formatting components by country...">_setPhoneFormatComponentByCountry</a>();
<a name="l00155"></a>00155   }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157   <span class="keyword">protected</span> function _getPhoneFormatComponent($pfid)
<a name="l00158"></a>00158   {
<a name="l00159"></a>00159     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00160"></a>00160       -&gt;select(<span class="stringliteral">&#39;pf.id&#39;</span>)
<a name="l00161"></a>00161           -&gt;addSelect(<span class="stringliteral">&#39;pft.validation&#39;</span>)
<a name="l00162"></a>00162           -&gt;addSelect(<span class="stringliteral">&#39;pft.match_pattern&#39;</span>)
<a name="l00163"></a>00163           -&gt;addSelect(<span class="stringliteral">&#39;pft.replacement_pattern&#39;</span>)
<a name="l00164"></a>00164         -&gt;from(<span class="stringliteral">&#39;agPhoneFormat pf&#39;</span>)
<a name="l00165"></a>00165             -&gt;innerJoin(<span class="stringliteral">&#39;pf.agPhoneFormatType pft&#39;</span>)
<a name="l00166"></a>00166           -&gt;whereIn(<span class="stringliteral">&#39;pf.id&#39;</span>, $pfid);
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="keywordflow">return</span> $q;
<a name="l00169"></a>00169   }
<a name="l00170"></a>00170 
<a name="l00175"></a><a class="code" href="classagPhoneHelper.html#a2c25c0e8e9d22979958dc01d06992f09">00175</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#a2c25c0e8e9d22979958dc01d06992f09" title="This method queries the database for the required formatting components and loads...">_setPhoneFormatComponent</a>()
<a name="l00176"></a>00176   {
<a name="l00177"></a>00177     $q = $this-&gt;_getPhoneFormatComponent($this-&gt;_returnFormatId);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="comment">// here we choose a custom hydration method to allow us to manipulate the results data twice</span>
<a name="l00180"></a>00180     $formatComponents = $q-&gt;execute(array(), DOCTRINE_CORE::HYDRATE_NONE);
<a name="l00181"></a>00181     <span class="keywordflow">foreach</span>($formatComponents as $fc)
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183       <span class="comment">// create a simple phone validation array.</span>
<a name="l00184"></a>00184       $this-&gt;_phoneValidation[$fc[0]] = $fc[1];
<a name="l00185"></a>00185 
<a name="l00186"></a>00186       <span class="comment">// create a simple display format array.</span>
<a name="l00187"></a>00187       $this-&gt;_phoneDisplayFormat[$fc[0]] = array($fc[2], $fc[3]);
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189   }
<a name="l00190"></a>00190 
<a name="l00197"></a><a class="code" href="classagPhoneHelper.html#a5514db9eb2a24cacf8b11d0c33aded53">00197</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#a5514db9eb2a24cacf8b11d0c33aded53" title="Method used to construct the base query object used by other objects in this class...">_getPhone</a>(array $phoneIds = NULL)
<a name="l00198"></a>00198   {
<a name="l00199"></a>00199     <span class="comment">// if no (null) ID&#39;s are passed, get the phoneId&#39;s from the class property</span>
<a name="l00200"></a>00200     $phoneIds = $this-&gt;<a class="code" href="classagBulkRecordHelper.html#ab63cfeadb98c6f9c6dfad1cb7406c41f" title="Helper method to retrieve the $_recordId property in the event that it is passed...">getRecordIds</a>($phoneIds);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment">// construct our base query object</span>
<a name="l00203"></a>00203     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00204"></a>00204       -&gt;select(<span class="stringliteral">&#39;pc.id&#39;</span>)
<a name="l00205"></a>00205           -&gt;addSelect(<span class="stringliteral">&#39;pc.phone_contact&#39;</span>)
<a name="l00206"></a>00206           -&gt;addSelect(<span class="stringliteral">&#39;pft.match_pattern&#39;</span>)
<a name="l00207"></a>00207           -&gt;addSelect(<span class="stringliteral">&#39;pft.replacement_pattern&#39;</span>)
<a name="l00208"></a>00208           -&gt;addSelect(<span class="stringliteral">&#39;pf.id&#39;</span>)
<a name="l00209"></a>00209           -&gt;addSelect(<span class="stringliteral">&#39;pft.id&#39;</span>)
<a name="l00210"></a>00210         -&gt;from(<span class="stringliteral">&#39;agPhoneContact pc&#39;</span>)
<a name="l00211"></a>00211           -&gt;innerJoin(<span class="stringliteral">&#39;pc.agPhoneFormat pf&#39;</span>)
<a name="l00212"></a>00212           -&gt;innerJoin(<span class="stringliteral">&#39;pf.agPhoneFormatType pft&#39;</span>)
<a name="l00213"></a>00213         -&gt;whereIn(<span class="stringliteral">&#39;pc.id&#39;</span>, $phoneIds);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="keywordflow">return</span> $q;
<a name="l00216"></a>00216   }
<a name="l00217"></a>00217 
<a name="l00226"></a><a class="code" href="classagPhoneHelper.html#a1745d1d1a075e54d5fce0b5bf96b203a">00226</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a1745d1d1a075e54d5fce0b5bf96b203a" title="A workhorse method useful for returning phone value and it&amp;#39;s format id.">getPhone</a>(array $phoneIds = NULL)
<a name="l00227"></a>00227   {
<a name="l00228"></a>00228     $phoneIds = $this-&gt;<a class="code" href="classagBulkRecordHelper.html#ab63cfeadb98c6f9c6dfad1cb7406c41f" title="Helper method to retrieve the $_recordId property in the event that it is passed...">getRecordIds</a>($phoneIds);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="comment">// return our base query object</span>
<a name="l00231"></a>00231     $q = $this-&gt;<a class="code" href="classagPhoneHelper.html#a5514db9eb2a24cacf8b11d0c33aded53" title="Method used to construct the base query object used by other objects in this class...">_getPhone</a>($phoneIds);
<a name="l00232"></a>00232 <span class="comment">//    $q = $this-&gt;_getPhone(($phoneIds == null ? array() : $phoneIds));</span>
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     $results = $q-&gt;execute(array(), <span class="stringliteral">&#39;key_value_array&#39;</span>);
<a name="l00235"></a>00235     <span class="keywordflow">return</span> $results;
<a name="l00236"></a>00236   }
<a name="l00237"></a>00237 
<a name="l00246"></a><a class="code" href="classagPhoneHelper.html#af1693d078ca012dd586a3e920d21391d">00246</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#af1693d078ca012dd586a3e920d21391d" title="Method to return a formatted phone as a string.">getFormattedPhone</a>(array $phoneIds = NULL)
<a name="l00247"></a>00247   {
<a name="l00248"></a>00248     <span class="comment">// always a good idea to explicitly declare this</span>
<a name="l00249"></a>00249     $results = array();
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="comment">// now we grab all of our phones.</span>
<a name="l00252"></a>00252     $phones = $this-&gt;<a class="code" href="classagPhoneHelper.html#a1745d1d1a075e54d5fce0b5bf96b203a" title="A workhorse method useful for returning phone value and it&amp;#39;s format id.">getPhone</a>($phoneIds);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="comment">// start by iterating over the individual phones</span>
<a name="l00255"></a>00255     <span class="keywordflow">foreach</span> ($phones as $phoneId =&gt; $phone)
<a name="l00256"></a>00256     {
<a name="l00257"></a>00257       <span class="comment">// format phone</span>
<a name="l00258"></a>00258       $formattedPhone = preg_replace($phone[2],
<a name="l00259"></a>00259                                      $phone[3],
<a name="l00260"></a>00260                                      $phone[0]);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262       <span class="comment">// add formatted phone to our results array</span>
<a name="l00263"></a>00263       $results[$phoneId] = $formattedPhone;
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">return</span> $results;
<a name="l00267"></a>00267   }
<a name="l00268"></a>00268 
<a name="l00281"></a><a class="code" href="classagPhoneHelper.html#a87e8cee805c4c2707d838e2c390cd3ac">00281</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#a87e8cee805c4c2707d838e2c390cd3ac" title="Method to get the explicit part of the phone (either area code, extension, etc.">_getPhoneComponent</a>(array $phones, $keepAsDefault, $startIndex = NULL, $length = NULL )
<a name="l00282"></a>00282   {
<a name="l00283"></a>00283     <span class="comment">// always a good idea to explicitly declare this</span>
<a name="l00284"></a>00284     $results = array();
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// if no (null) start index is passed, get the start index from the class property</span>
<a name="l00287"></a>00287     <span class="keywordflow">if</span> (is_null($startIndex)) {
<a name="l00288"></a>00288       $startIndex = $this-&gt;_startIndex;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">foreach</span>($phones as $phoneId =&gt; $phone) {
<a name="l00292"></a>00292       <span class="keywordflow">if</span> ($keepAsDefault) { $numericPhone = $phone[0]; }
<a name="l00293"></a>00293       <span class="keywordflow">else</span> { $numericPhone = preg_replace(<span class="stringliteral">&#39;/[^0-9]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $phone[0]); }
<a name="l00294"></a>00294       $results[$phoneId] = (is_null($length)) ? substr($numericPhone, $startIndex) :
<a name="l00295"></a>00295                                                 substr($numericPhone, $startIndex, $length);
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     <span class="keywordflow">return</span> $results;
<a name="l00298"></a>00298   }
<a name="l00299"></a>00299 
<a name="l00311"></a><a class="code" href="classagPhoneHelper.html#a9bfa5ac45f4f1a78fa4a40ca9a19faf0">00311</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a9bfa5ac45f4f1a78fa4a40ca9a19faf0" title="Method to call another method to get the explicit part of the phone (either area...">getPhoneComponent</a>(array $phoneIds = NULL, $strSubsetType = NULL)
<a name="l00312"></a>00312   {
<a name="l00313"></a>00313     <span class="comment">// always a good idea to explicitly declare this</span>
<a name="l00314"></a>00314     $results = array();
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">// now we grab all of our phones.</span>
<a name="l00317"></a>00317     $phones = $this-&gt;<a class="code" href="classagPhoneHelper.html#a1745d1d1a075e54d5fce0b5bf96b203a" title="A workhorse method useful for returning phone value and it&amp;#39;s format id.">getPhone</a>($phoneIds);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     $strSubsetInfo = $this-&gt;<a class="code" href="classagPhoneHelper.html#adbef203d6bb6827ff93658a0edeb799f" title="Method to return the appropriate phone component substr array set.">_setPhoneComponent</a>($strSubsetType);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     $strSubset = $strSubsetInfo[1];
<a name="l00322"></a>00322     <span class="keywordflow">if</span> ($strSubsetInfo[0] == self::PHN_DEFAULT) { $keepAsDefault = 1; }
<a name="l00323"></a>00323     <span class="keywordflow">else</span> { $keepAsDefault = 0; }
<a name="l00324"></a>00324     $results = $this-&gt;<a class="code" href="classagPhoneHelper.html#a87e8cee805c4c2707d838e2c390cd3ac" title="Method to get the explicit part of the phone (either area code, extension, etc.">_getPhoneComponent</a>($phones, $keepAsDefault, $strSubset[<span class="stringliteral">&#39;startIndex&#39;</span>], $strSubset[<span class="stringliteral">&#39;length&#39;</span>]);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="keywordflow">return</span> $results;
<a name="l00327"></a>00327   }
<a name="l00328"></a>00328 
<a name="l00337"></a><a class="code" href="classagPhoneHelper.html#adbef203d6bb6827ff93658a0edeb799f">00337</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#adbef203d6bb6827ff93658a0edeb799f" title="Method to return the appropriate phone component substr array set.">_setPhoneComponent</a>( $strSubsetType = NULL )
<a name="l00338"></a>00338   {
<a name="l00339"></a>00339     <span class="keywordflow">switch</span>($strSubsetType) {
<a name="l00340"></a>00340       <span class="keywordflow">case</span> self::PHN_AREA_CODE:
<a name="l00341"></a>00341         <span class="keywordflow">return</span> array(self::PHN_AREA_CODE, $this-&gt;_phn_area_code);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343       <span class="keywordflow">case</span> self::PHN_FIRST_THREE:
<a name="l00344"></a>00344         <span class="keywordflow">return</span> array(self::PHN_FIRST_THREE, $this-&gt;_phn_first_three);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346       <span class="keywordflow">case</span> self::PHN_LAST_FOUR:
<a name="l00347"></a>00347         <span class="keywordflow">return</span> array(self::PHN_LAST_FOUR, $this-&gt;_phn_last_four);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       <span class="keywordflow">case</span> self::PHN_EXTENSION:
<a name="l00350"></a>00350         <span class="keywordflow">return</span> array(self::PHN_EXTENSION, $this-&gt;_phn_extension);
<a name="l00351"></a>00351         
<a name="l00352"></a>00352       <span class="keywordflow">default</span>:
<a name="l00353"></a>00353         <span class="keywordflow">return</span> array(self::PHN_DEFAULT, $this-&gt;_phn_default);
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355   }
<a name="l00356"></a>00356 
<a name="l00367"></a><a class="code" href="classagPhoneHelper.html#af3f2d750a54355941ef07f18e5473b6c">00367</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#af3f2d750a54355941ef07f18e5473b6c" title="Method to return phone in segments.">getPhoneComponentSegments</a>(array $phoneIds = NULL)
<a name="l00368"></a>00368   {
<a name="l00369"></a>00369     <span class="comment">// always a good idea to explicitly declare this</span>
<a name="l00370"></a>00370     $results = array();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">// now we grab all of our phones.</span>
<a name="l00373"></a>00373     $phones = $this-&gt;<a class="code" href="classagPhoneHelper.html#a1745d1d1a075e54d5fce0b5bf96b203a" title="A workhorse method useful for returning phone value and it&amp;#39;s format id.">getPhone</a>($phoneIds);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="keywordflow">foreach</span>($phones as $phoneId =&gt; $phone) {
<a name="l00376"></a>00376       $numericPhone = preg_replace(<span class="stringliteral">&#39;/[^0-9]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $phone[0]);
<a name="l00377"></a>00377       $areaCode = substr($numericPhone, 0, 3);
<a name="l00378"></a>00378       $phoneNum = substr($numericPhone, 3, 10);
<a name="l00379"></a>00379       $extNum = substr($numericPhone, 10);
<a name="l00380"></a>00380       $results[$phoneId] = array(<span class="stringliteral">&#39;area code&#39;</span> =&gt; $areaCode, <span class="stringliteral">&#39;phone&#39;</span> =&gt; $phoneNum, <span class="stringliteral">&#39;extension&#39;</span> =&gt; $extNum);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">return</span> $results;
<a name="l00384"></a>00384   }
<a name="l00385"></a>00385   
<a name="l00391"></a><a class="code" href="classagPhoneHelper.html#a3726068dd5387e35e73f9dd4d5bfb23e">00391</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a3726068dd5387e35e73f9dd4d5bfb23e" title="Simple method to return the current phone format id.">getFormatId</a>()
<a name="l00392"></a>00392   {
<a name="l00393"></a>00393     <span class="keywordflow">return</span> $this-&gt;_returnFormatId;
<a name="l00394"></a>00394   }
<a name="l00395"></a>00395 
<a name="l00401"></a><a class="code" href="classagPhoneHelper.html#a2a0265384af7361b77a78e60e21fe753">00401</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a2a0265384af7361b77a78e60e21fe753" title="A simple getter to return the current phone validation.">getPhoneValidation</a>()
<a name="l00402"></a>00402   {
<a name="l00403"></a>00403     <span class="keywordflow">return</span> $this-&gt;_phoneValidation;
<a name="l00404"></a>00404   }
<a name="l00405"></a>00405 
<a name="l00411"></a><a class="code" href="classagPhoneHelper.html#a085ed0d5786e6d609a540e8744ee4c3c">00411</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a085ed0d5786e6d609a540e8744ee4c3c" title="A simple getter to return the current phone format display.">getPhoneDisplayFormat</a>()
<a name="l00412"></a>00412   {
<a name="l00413"></a>00413     <span class="keywordflow">return</span> $this-&gt;_phoneDisplayFormat;
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <span class="keyword">public</span> function getPhoneFormatComponents()
<a name="l00417"></a>00417   {
<a name="l00418"></a>00418     <span class="keywordflow">return</span> $this-&gt;_phoneFormatComponentsByCountry;
<a name="l00419"></a>00419   }
<a name="l00420"></a>00420 
<a name="l00429"></a><a class="code" href="classagPhoneHelper.html#a371f674a056dff960a73537ed0d78b2e">00429</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#a371f674a056dff960a73537ed0d78b2e" title="A quick helper method to take in an array phones and return an array of phone ids...">getPhoneIds</a>(array $phones)
<a name="l00430"></a>00430   {
<a name="l00431"></a>00431     <span class="comment">// ONLY return the ID, not the value because of casing (for comparison)</span>
<a name="l00432"></a>00432     $q = <a class="code" href="classDoctrine__Query.html#a7420e7e1f1224c195cc56419fd733d14" title="create returns a new Doctrine_Query object">agDoctrineQuery::create</a>()
<a name="l00433"></a>00433       -&gt;select(<span class="stringliteral">&#39;pc.id&#39;</span>)
<a name="l00434"></a>00434         -&gt;from(<span class="stringliteral">&#39;agPhoneContact pc&#39;</span>)
<a name="l00435"></a>00435       -&gt;useResultCache(TRUE, 1800);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     $results = array();
<a name="l00438"></a>00438     $cacheDriver = <a class="code" href="classDoctrine__Manager.html#a0f1f11c9be78468eed7768f4130aac2e" title="Returns an instance of this class (this class uses the singleton pattern).">Doctrine_Manager::getInstance</a>()-&gt;getAttribute(Doctrine_Core::ATTR_RESULT_CACHE);
<a name="l00439"></a>00439     <span class="keywordflow">foreach</span> ($phones as $index =&gt; $phone)
<a name="l00440"></a>00440     {
<a name="l00441"></a>00441       $q-&gt;where(<span class="stringliteral">&#39;pc.phone_contact = ?&#39;</span>,$phone);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       $result = $q-&gt;execute(array(), <a class="code" href="classDoctrine__Core.html#a0064a4a73d01e72757257d48d2817fbb" title="HYDRATE_SINGLE_SCALAR.">Doctrine_Core::HYDRATE_SINGLE_SCALAR</a>);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445       <span class="comment">// clear the cache if we had no result</span>
<a name="l00446"></a>00446       <span class="keywordflow">if</span> (empty($result))
<a name="l00447"></a>00447       {
<a name="l00448"></a>00448         $cacheDriver-&gt;delete($q-&gt;getResultCacheHash());
<a name="l00449"></a>00449       }
<a name="l00450"></a>00450       <span class="keywordflow">else</span>
<a name="l00451"></a>00451       {
<a name="l00452"></a>00452         $results[$phone] = $result;
<a name="l00453"></a>00453       }
<a name="l00454"></a>00454       unset($phones[$index]);
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <span class="keywordflow">return</span> $results;
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459 
<a name="l00488"></a><a class="code" href="classagPhoneHelper.html#a85a8233bb9418640161328170a8447a9">00488</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#a85a8233bb9418640161328170a8447a9" title="Method to create a new phone.">setNewPhones</a>(array $phones, $throwOnError, $conn)
<a name="l00489"></a>00489   {
<a name="l00490"></a>00490     <span class="comment">// declare our results array</span>
<a name="l00491"></a>00491     $results = array();
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="comment">// pick up the default connection and error throw prerogative if one is not passed</span>
<a name="l00494"></a>00494     <span class="keywordflow">if</span> (is_null($conn)) { $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>(); }
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (is_null($throwOnError)) { $throwOnError = $this-&gt;throwOnError; }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     $phoneFormatComponents = $this-&gt;_phoneFormatComponentsByCountry;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">foreach</span> ($phones as $index =&gt; $phone)
<a name="l00500"></a>00500     {
<a name="l00501"></a>00501       <span class="comment">// we do this so we only have to call rollback / unset once, plus it&#39;s nice to have a bool to</span>
<a name="l00502"></a>00502       <span class="comment">// check on our own</span>
<a name="l00503"></a>00503       $err = NULL;
<a name="l00504"></a>00504       $errMsg = <span class="stringliteral">&#39;This is a generic error message for setNewPhones. You should never receive this</span>
<a name="l00505"></a>00505 <span class="stringliteral">        error. If you are recieving this error, there is an ERROR in your error-handling code.&#39;</span>;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507       <span class="comment">// here we check our current transaction scope and create a transaction or savepoint</span>
<a name="l00508"></a>00508       $useSavepoint = ($conn-&gt;getTransactionLevel() &gt; 0) ? TRUE : FALSE;
<a name="l00509"></a>00509       <span class="keywordflow">if</span> ($useSavepoint)
<a name="l00510"></a>00510       {
<a name="l00511"></a>00511         $conn-&gt;beginTransaction(__FUNCTION__);
<a name="l00512"></a>00512       }
<a name="l00513"></a>00513       <span class="keywordflow">else</span>
<a name="l00514"></a>00514       {
<a name="l00515"></a>00515         $conn-&gt;beginTransaction();
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518       <span class="comment">// Check if phone format id is passed in.  If not, assign a phone format id where matches</span>
<a name="l00519"></a>00519       <span class="comment">// the validation regexg.  If no match, assign default phone format id.</span>
<a name="l00520"></a>00520       <span class="keywordflow">if</span> (isset($phone[1]))
<a name="l00521"></a>00521       {
<a name="l00522"></a>00522         $phoneFormatId = $phone[1];
<a name="l00523"></a>00523       }
<a name="l00524"></a>00524       <span class="keywordflow">else</span>
<a name="l00525"></a>00525       {
<a name="l00526"></a>00526         $phoneFormatId = $this-&gt;_returnFormatId;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <span class="keywordflow">foreach</span>($phoneFormatComponents as $pfId =&gt; $pfComp)
<a name="l00529"></a>00529         {
<a name="l00530"></a>00530           <span class="keywordflow">if</span> (preg_match($pfComp[0], $phone[0]))
<a name="l00531"></a>00531           {
<a name="l00532"></a>00532             $phoneFormatId = $pfId;
<a name="l00533"></a>00533             <span class="keywordflow">break</span>;
<a name="l00534"></a>00534           }
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536       }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538       $phoneContactTbl = $conn-&gt;getTable(<span class="stringliteral">&#39;agPhoneContact&#39;</span>);
<a name="l00539"></a>00539       $newPhone = <span class="keyword">new</span> <a class="code" href="classagPhoneContact.html" title="extends the BaseagPhoneContact">agPhoneContact</a>($phoneContactTbl, TRUE);
<a name="l00540"></a>00540       $newPhone[<span class="stringliteral">&#39;phone_contact&#39;</span>] = $phone[0];
<a name="l00541"></a>00541       $newPhone[<span class="stringliteral">&#39;phone_format_id&#39;</span>] = $phoneFormatId;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543       <span class="keywordflow">try</span>
<a name="l00544"></a>00544       {
<a name="l00545"></a>00545         $newPhone-&gt;save($conn);
<a name="l00546"></a>00546         $phoneId = $newPhone-&gt;getId();
<a name="l00547"></a>00547         <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;commit(__FUNCTION__) ; } <span class="keywordflow">else</span> { $conn-&gt;commit(); }
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549       <span class="keywordflow">catch</span> (Exception $e)
<a name="l00550"></a>00550       {
<a name="l00551"></a>00551         <span class="comment">// log our error</span>
<a name="l00552"></a>00552         $errMsg = sprintf(<span class="stringliteral">&#39;Couldn\&#39;t insert phone contact %s!  Rolled back changes!&#39;</span>, $phone[0]);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">// log our error</span>
<a name="l00555"></a>00555         sfContext::getInstance()-&gt;getLogger()-&gt;err($errMsg);
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <span class="comment">// rollback</span>
<a name="l00558"></a>00558         <span class="keywordflow">if</span> ($useSavepoint) { $conn-&gt;rollback(__FUNCTION__); } <span class="keywordflow">else</span> { $conn-&gt;rollback(); }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="comment">// ALWAYS throw an error, it&#39;s like stepping on a crack if you don&#39;t</span>
<a name="l00561"></a>00561         <span class="keywordflow">if</span> ($throwOnError) { <span class="keywordflow">throw</span> $e; }
<a name="l00562"></a>00562         <span class="keywordflow">continue</span>;
<a name="l00563"></a>00563       }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="comment">// commit our results to our final results array</span>
<a name="l00566"></a>00566       $results[$index] = $phoneId;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568       <span class="comment">// release the value on our input array</span>
<a name="l00569"></a>00569       unset($phones[$index]);
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571     <span class="keywordflow">return</span> array($results, array_keys($phones));
<a name="l00572"></a>00572   }
<a name="l00573"></a>00573 
<a name="l00602"></a><a class="code" href="classagPhoneHelper.html#ab3ef6068027ee17d2dba3b850b2f4c30">00602</a>   <span class="keyword">protected</span> function <a class="code" href="classagPhoneHelper.html#ab3ef6068027ee17d2dba3b850b2f4c30" title="Method to set phones and return phone ids, inserting new phones as necessary.">_setPhones</a>(array $phones, $throwOnError = NULL, <a class="code" href="classDoctrine__Connection.html">Doctrine_Connection</a> $conn = NULL)
<a name="l00603"></a>00603   {
<a name="l00604"></a>00604     <span class="comment">// declare our results array</span>
<a name="l00605"></a>00605     $results = array();
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="comment">// Extract only the phone numbers into a simple array for later use to retrieve phone contact</span>
<a name="l00608"></a>00608     <span class="comment">// ids if a match found in db.</span>
<a name="l00609"></a>00609     $phonesOnly = array();
<a name="l00610"></a>00610     <span class="keywordflow">foreach</span> ($phones as &amp;$p)
<a name="l00611"></a>00611     {
<a name="l00612"></a>00612       $p[0] = strtolower(trim($p[0]));
<a name="l00613"></a>00613       $phonesOnly[] = $p[0];
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615     unset($p);
<a name="l00616"></a>00616     
<a name="l00617"></a>00617     <span class="comment">// return any found phones</span>
<a name="l00618"></a>00618     $dbPhones = $this-&gt;<a class="code" href="classagPhoneHelper.html#a371f674a056dff960a73537ed0d78b2e" title="A quick helper method to take in an array phones and return an array of phone ids...">getPhoneIds</a>(array_unique(array_values($phonesOnly)));
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="comment">// loop through the pass-in phones and build a couple of arrays</span>
<a name="l00621"></a>00621     <span class="keywordflow">foreach</span> ($phones as $phoneIndex =&gt; $phone)
<a name="l00622"></a>00622     {
<a name="l00623"></a>00623       <span class="comment">// Check if phone already exists in db.</span>
<a name="l00624"></a>00624       <span class="keywordflow">if</span> (array_key_exists($phone[0], $dbPhones))
<a name="l00625"></a>00625       {
<a name="l00626"></a>00626         <span class="comment">// for each of the phones with that ID, build our results set and</span>
<a name="l00627"></a>00627         <span class="comment">// unset the value from the stuff left to be processed (we&#39;re going to use that later!)</span>
<a name="l00628"></a>00628         $results[$phoneIndex] = $dbPhones[$phone[0]];
<a name="l00629"></a>00629         unset($phones[$phoneIndex]);
<a name="l00630"></a>00630       }
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="comment">// just &#39;cause this is going to be a very memory-hungry method, we&#39;ll unset the dbPhones too</span>
<a name="l00634"></a>00634     unset($dbPhones);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="comment">// pick up the default connection if one is not passed</span>
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (is_null($conn)) { $conn = <a class="code" href="classDoctrine__Manager.html#a4a265fc048ee4080e26779f3ba36681c" title="Open a new connection.">Doctrine_Manager::connection</a>(); }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="comment">// now that we have all of the &#39;existing&#39; phones, let&#39;s build the new ones</span>
<a name="l00640"></a>00640     $newPhones = $this-&gt;<a class="code" href="classagPhoneHelper.html#a85a8233bb9418640161328170a8447a9" title="Method to create a new phone.">setNewPhones</a>($phones, $throwOnError, $conn);
<a name="l00641"></a>00641     $successes = array_shift($newPhones);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="comment">// we don&#39;t need this anymore!</span>
<a name="l00644"></a>00644     unset($newPhones);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <span class="keywordflow">foreach</span> ($successes as $index =&gt; $phoneId)
<a name="l00647"></a>00647     {
<a name="l00648"></a>00648       <span class="comment">// add our successes to the final results set</span>
<a name="l00649"></a>00649       $results[$index] = $phoneId;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651       <span class="comment">// release the phone from our initial input array</span>
<a name="l00652"></a>00652       unset($phones[$index]);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654       <span class="comment">// release it from the successes array while we&#39;re at it</span>
<a name="l00655"></a>00655       unset($successes[$index]);
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="comment">// and finally we return our results, both the successes and the failures</span>
<a name="l00659"></a>00659     <span class="keywordflow">return</span> array($results, array_keys($phones));
<a name="l00660"></a>00660   }
<a name="l00661"></a>00661 
<a name="l00691"></a><a class="code" href="classagPhoneHelper.html#aeec2ac2251040f7e03e2f4680585f1db">00691</a>   <span class="keyword">public</span> function <a class="code" href="classagPhoneHelper.html#aeec2ac2251040f7e03e2f4680585f1db" title="Method to call other method for phone setters to insert new phones as necessary and...">setPhones</a>(array $phones, $throwOnError = NULL, $conn = NULL)
<a name="l00692"></a>00692   {
<a name="l00693"></a>00693     <span class="comment">// either way, we eventually pass the &#39;cleared&#39; phones to our setter</span>
<a name="l00694"></a>00694     $results = $this-&gt;<a class="code" href="classagPhoneHelper.html#ab3ef6068027ee17d2dba3b850b2f4c30" title="Method to set phones and return phone ids, inserting new phones as necessary.">_setPhones</a>($phones, $throwOnError, $conn);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">return</span> $results;
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
